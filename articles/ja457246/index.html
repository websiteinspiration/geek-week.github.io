<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔑 ✍🏾 👨‍🏫 C ++ 17、タプル、そして少しのファンタジーを使用してCortexMで4つのLEDを点滅させる方法 💺 🖇️ 📱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="すべての人に健康を！
 
 大学でマイクロコントローラー用の組み込みソフトウェアを開発する方法を学生に教えるとき、私はC ++を使用し、時々、あらゆる種類のタスクに特に興味のある学生に、特に病気の才能のある学生を特定するように教えます。
 
 もう一度、そのような学生は、C ++ 17言語と標準C ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C ++ 17、タプル、そして少しのファンタジーを使用してCortexMで4つのLEDを点滅させる方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457246/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての人に健康を！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大学でマイクロコントローラー用の組み込みソフトウェアを開発する方法を学生に教えるとき、私はC ++を使用し、時々、あらゆる種類のタスクに特に興味の</font><font style="vertical-align: inherit;">ある学生に、</font><font style="vertical-align: inherit;">特に</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">病気の</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">才能のある学生を</font><font style="vertical-align: inherit;">特定するように</font><font style="vertical-align: inherit;">教えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、そのような学生は、C ++ 17言語と標準C ++ライブラリを使用して4つのLEDを点滅させるタスクを与えられました。CMSISやレジスタ構造の説明などのヘッダーファイルなどの追加のライブラリを接続する必要はありません...コードのあるものが優先されます。 ROMは最小サイズで、RAMの使用量が最も少なくなります。コンパイラーの最適化は中程度より高くないでください。 IARコンパイラ8.40.1。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
勝者</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はカナリアに行き</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、試験のために5を獲得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その前は、私もこの問題を解決していなかったので、生徒がそれを解決した方法と私に何が起こったのかを説明します。</font><font style="vertical-align: inherit;">そのようなコードが実際のアプリケーションで使用される可能性は低いとすぐに警告します。そのため、私は「異常なプログラミング」セクションにこの記事を投稿しました。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の状態</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポートGPIOA.5、GPIOC.5、GPIOC.8、GPIOC.9には4つのLEDがあります。</font><font style="vertical-align: inherit;">彼らは点滅する必要があります。</font><font style="vertical-align: inherit;">比較対象として、Cで記述されたコードを使用しました。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delay</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; ++i){<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{ 
   <span class="hljs-keyword">for</span>(;;)   {<font></font>
     GPIOA-&gt;ODR ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>);<font></font>
     GPIOC-&gt;ODR ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>);<font></font>
     GPIOC-&gt;ODR ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>);<font></font>
     GPIOC-&gt;ODR ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>);     <font></font>
     delay();<font></font>
   }  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><code>delay()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font><font style="vertical-align: inherit;">
の関数</font><font style="vertical-align: inherit;">は純粋に形式的で定期的なサイクルであり、最適化することはできません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポートはすでに出力用に構成されていて、クロッキングが適用されていると想定されています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ビットバンギングはコードを移植可能にするために使用されなかったとすぐに言います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは、中規模の最適化ではスタックで8バイト、ROMで256バイトを使用します。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8 </font><font style="vertical-align: inherit;">バイトの読み取り専用</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリの一部が割り込みベクトルのテーブルの下にあるという事実、浮動小数点ブロックを初期化するためのIAR関数の呼び出し、あらゆる種類のデバッグ関数、およびポート自体が構成されている__low_level_init関数による255バイト。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、完全な要件は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> main（）関数には、できるだけ少ないコードを含める必要があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> マクロは使用できません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C ++ 17をサポートするIAR 8.40.1コンパイラ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 「#include」stm32f411xe.hなどのCMSISヘッダーファイルは使用できません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> インライン関数に__forceinlineディレクティブを使用できます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 中規模コンパイラの最適化</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学生の決定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、いくつかの解決策がありましたが、1つだけ示します...最適ではありませんが、私はそれが好きでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヘッダーファイルは使用できないため、学生はまず、</font></font><code>Gpio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分のアドレスにポートレジスタへのリンクを格納する</font><font style="vertical-align: inherit;">クラス</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">しました。</font><font style="vertical-align: inherit;">これを行うには、構造オーバーレイを使用します。おそらく、ここからアイデアを取り入れました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造オーバーレイ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gpio</span> {</span>
<span class="hljs-keyword">public</span>:
<span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> bitNum)</span> <span class="hljs-keyword">volatile</span> </span>{<font></font>
    Odr ^= bitNum ;<font></font>
  }  <font></font>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Moder;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Otyper;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Ospeedr;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Pupdr;  
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Idr;      
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Odr;       
  <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">static_assert</span>(<span class="hljs-keyword">sizeof</span>(Gpio) == <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>) * <span class="hljs-number">6</span>); <font></font>
} ;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧の</font></font><code>Gpio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように、対応するレジスタのアドレスに配置する必要のある属性を</font><font style="vertical-align: inherit;">持つクラス</font><font style="vertical-align: inherit;">と、レッグの数によって状態を切り替える方法を</font><font style="vertical-align: inherit;">すぐに特定しました</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font><font style="vertical-align: inherit;">、レッグ</font></font><code>GpioPin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へのポインター</font></font><code>Gpio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とレッグの数</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">含む</font><font style="vertical-align: inherit;">構造を決定しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">GpioPin</span>
{</span>
  <span class="hljs-keyword">volatile</span> Gpio* port ;
  <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> pinNum ;<font></font>
} ;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ポートの特定のレッグに位置するLEDの配列を作成し、</font></font><code>Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各LEDの</font><font style="vertical-align: inherit;">メソッドを呼び出してそれを越えました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GpioPin leds[] = {{<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpioaBaseAddr), <span class="hljs-number">5</span>},<font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">5</span>},<font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">9</span>},  <font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">9</span>} <font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">LedsDriver</span> {</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggelAll</span><span class="hljs-params">()</span>  </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; it: leds)    {<font></font>
      it.port-&gt;Toggle(it.pinNum);<font></font>
    }<font></font>
  }<font></font>
} ;</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まあ、実際にはコード全体：</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpioaBaseAddr = <span class="hljs-number">0x4002'0000</span> ;
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpiocBaseAddr = <span class="hljs-number">0x4002'0800</span> ;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gpio</span> {</span>
<span class="hljs-keyword">public</span>:
<span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> bitNum)</span> <span class="hljs-keyword">volatile</span> </span>{<font></font>
    Odr ^= bitNum ;<font></font>
  }  <font></font>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Moder;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Otyper;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Ospeedr;
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Pupdr;  
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Idr;      
  <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> Odr;        <font></font>
} ;<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">static_assert</span>(<span class="hljs-keyword">sizeof</span>(Gpio) == <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>) * <span class="hljs-number">6</span>);<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">GpioPin</span> {</span>
  <span class="hljs-keyword">volatile</span> Gpio* port ;
  <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> pinNum ;<font></font>
} ;<font></font>
<font></font>
<span class="hljs-keyword">const</span> GpioPin leds[] = {{<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpioaBaseAddr), <span class="hljs-number">5</span>},<font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">5</span>},<font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">9</span>},  <font></font>
                      {<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">volatile</span> Gpio*&gt;(GpiocBaseAddr), <span class="hljs-number">9</span>} <font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">LedsDriver</span> {</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggelAll</span><span class="hljs-params">()</span>  </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; it: leds)    {<font></font>
      it.port-&gt;Toggle(it.pinNum);<font></font>
    }<font></font>
  }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{ 
   <span class="hljs-keyword">for</span>(;;)   {<font></font>
     LedsContainer::ToggleAll() ;<font></font>
     delay();<font></font>
   }  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
中最適化に関するコードの統計：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">275バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8 </font><font style="vertical-align: inherit;">バイトの読み取り専用</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
良い解決策ですが、大量のメモリを必要とします:)</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の決定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、私は単純な方法を探すのではなく、真剣に行動することを決心しました:)。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LEDは異なるポートと異なるレッグにあります。</font><font style="vertical-align: inherit;">最初に必要なのはクラスを作成することですが</font></font><code>Port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、RAMを占有するポインタと変数を取り除くには、静的メソッドを使用する必要があります。</font><font style="vertical-align: inherit;">ポートクラスは次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> addr&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Port</span> {</span>  
 <span class="hljs-comment">//  - </span>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートパラメータとして、ポートアドレスがあります。</font><font style="vertical-align: inherit;">ヘッダー</font></font><code> "#include "stm32f411xe.h"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、たとえばポートAの場合、GPIOA_BASEとして定義されます。</font><font style="vertical-align: inherit;">ただし、見出しの使用は禁止されているため、定数を指定するだけで十分です。</font><font style="vertical-align: inherit;">その結果、クラスは次のように使用できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpioaBaseAddr = <span class="hljs-number">0x4002'0000</span> ;
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpiocBaseAddr = <span class="hljs-number">0x4002'0800</span>  ;
<span class="hljs-keyword">using</span> PortA = Port&lt;GpioaBaseAddr&gt; ;
<span class="hljs-keyword">using</span> PortC = Port&lt;GpiocBaseAddr&gt; ;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
点滅させるには、トグルメソッド（const std :: uint8_tビット）が必要です。このメソッドは、排他的OR演算を使用して必要なビットを切り替えます。</font><font style="vertical-align: inherit;">メソッドは静的でなければなりません。クラスに追加してください：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> addr&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Port</span> {</span>  
 <span class="hljs-comment">//   __forceinline,       </span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> bitNum)</span>  </span>{<font></font>
    *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(addr+<span class="hljs-number">20</span>) ^= (<span class="hljs-number">1</span> &lt;&lt; bitNum) ; <span class="hljs-comment">//addr + 20  ODR </span><font></font>
  }<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
するグレート</font></font><code>Port&lt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">食べ、それが足の状態を切り替えることができます。</font><font style="vertical-align: inherit;">LEDは特定のレッグにあるため</font></font><code>Pin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>Port&lt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッグ番号</font><font style="vertical-align: inherit;">をテンプレートパラメータとして</font><font style="vertical-align: inherit;">クラスを作成するのが合理的</font><font style="vertical-align: inherit;">です。</font></font><code>Port&lt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレート</font><font style="vertical-align: inherit;">タイプ</font><font style="vertical-align: inherit;">がある</font><font style="vertical-align: inherit;">ので</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">ポートごとに異なり、送信できるのはユニバーサルタイプTのみです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> pinNum&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pin</span> {</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">()</span>   </span>{<font></font>
    T::Toggle(pinNum) ;<font></font>
  }<font></font>
} ;</code></pre><br><font style="vertical-align: inherit;"></font><code>T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font></font><code>Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のみを渡す必要があると想定されて</font><font style="vertical-align: inherit;">いますが、メソッドを持つ</font><font style="vertical-align: inherit;">
意味のない型</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">渡すことができるのは悪いこと</font></font><code>Port&lt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これから身を守るために</font></font><code>Port&lt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、基本クラスから継承</font><font style="vertical-align: inherit;">するように</font></font><code>PortBase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、テンプレートで、渡された型が実際にに基づいていることを確認します</font></font><code>PortBase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以下を取得します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> OdrAddrShift = <span class="hljs-number">20U</span>;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PortBase</span> {</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> addr&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Port</span>:</span> PortBase {  
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> bit)</span>  </span>{    <font></font>
    *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(addr ) ^= (<span class="hljs-number">1</span> &lt;&lt; bit) ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> pinNum, 
<span class="hljs-class"><span class="hljs-keyword">class</span> = <span class="hljs-title">typename</span> <span class="hljs-title">std</span>:</span>:<span class="hljs-keyword">enable_if_t</span>&lt;<span class="hljs-built_in">std</span>::is_base_of&lt;PortBase, T&gt;::value&gt;&gt; <span class="hljs-comment">//  </span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pin</span> {</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">()</span>  </span>{<font></font>
    T::Toggle(pinNum) ;<font></font>
  }<font></font>
} ;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートがインスタンス化されるのは、クラスに基本クラスがある場合のみです</font></font><code>PortBase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、これらのクラスはすでに使用できます。最適化しないとどうなるか見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">using</span> PortA = Port&lt;GpioaBaseAddr&gt; ;
<span class="hljs-keyword">using</span> PortC = Port&lt;GpiocBaseAddr&gt; ;<font></font>
<font></font>
<span class="hljs-keyword">using</span> Led1 = Pin&lt;PortA, <span class="hljs-number">5</span>&gt; ;
<span class="hljs-keyword">using</span> Led2 = Pin&lt;PortC, <span class="hljs-number">5</span>&gt; ;
<span class="hljs-keyword">using</span> Led3 = Pin&lt;PortC, <span class="hljs-number">8</span>&gt; ;
<span class="hljs-keyword">using</span> Led4 = Pin&lt;PortC, <span class="hljs-number">9</span>&gt; ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{ 
   <span class="hljs-keyword">for</span>(;;)   {<font></font>
     Led1::Toggle();<font></font>
     Led2::Toggle();<font></font>
     Led3::Toggle();<font></font>
     Led4::Toggle();<font></font>
     delay();<font></font>
   }  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<font></font>
}</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">271バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 24 </font><font style="vertical-align: inherit;">バイトの読み取り書き込み</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAMのこれらの余分な16バイトとROMの16バイトはどこから来たのですか？それらは、ビットパラメータをPortクラスのトグル関数（const std :: uint8_tビット）に渡し、コンパイラがメイン関数に入るときに、このパラメータが通過するスタックに4つの追加レジスタを保存し、これらを使用するという事実に由来します。各ピンのピン番号の値が格納されているレジスタ、およびメインの終了時にこれらのレジスタをスタックから復元します。そして、本質的には関数が組み込まれているため、これは完全に役に立たない作業のようなものですが、コンパイラは標準に完全に準拠して動作します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを取り除くには、一般的にポートクラスを削除し、クラスのテンプレートパラメータとしてポートアドレスを渡し</font></font><code>Pin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メソッド内で</font></font><code>Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ODRレジスタのアドレスを計算します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> OdrAddrShift = <span class="hljs-number">20U</span>;
<span class="hljs-keyword">template</span> &lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> addr, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> pinNum, 
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pin</span> {</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">()</span>  </span>{<font></font>
    *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(addr + OdrAddrShift ) ^= (<span class="hljs-number">1</span> &lt;&lt; bit) ;<font></font>
  }<font></font>
} ;<font></font>
<span class="hljs-keyword">using</span> Led1 = Pin&lt;GpioaBaseAddr, <span class="hljs-number">5</span>&gt; ; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは非常に見栄えがよく、ユーザーフレンドリーでもありません。</font><font style="vertical-align: inherit;">したがって、コンパイラがこの不要なレジスタ保持を少しの最適化で削除することを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mediumに最適化を行い、結果を確認します。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">251バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8 </font><font style="vertical-align: inherit;">バイトの読み取り専用</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すごいすごい…4バイト少ない </font></font><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><blockquote> 255 bytes of readonly code memory<br>
 1 byte of readonly data memory<br>
 8 bytes of readwrite data memory</blockquote><br>
</div></div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうすればいいの？デバッガーでC ++コード（左）とCコード（右）のアセンブラーを見てみましょう</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/ym/d9/vhymd9hbcko9luonsasg-xz7w7e.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。最初に、コンパイラーがすべての関数を組み込み、コールがまったくないこと、そして2番目に、レジスターの使用を最適化したことは明らかです。 Cコードの場合、コンパイラはR1またはR2レジスタのいずれかを使用してポートアドレスを格納し、ビットが切り替わるたびに追加の操作を実行します（アドレスをR1またはR2のいずれかにレジスタに保存します）。 2番目のケースでは、R1レジスタのみを使用し、切り替えの最後の3つの呼び出しは常にポートCからのものであるため、同じポートCアドレスをレジスタに保存する必要はありません。その結果、2つの命令と4バイトが保存されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここにそれは現代のコンパイラの奇跡です:)さて、大丈夫です。原則として、そこで停止することもできますが、次に進みましょう。他には何も最適化することはできないと思いますが、おそらく適切ではありません。アイデアがあれば、コメントに書き込んでください。しかし、main（）内のコードの量で作業できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、すべてのLEDをコンテナー内のどこかに配置し、メソッドを呼び出してすべてを切り替えることができます...このようなもの：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{ 
   <span class="hljs-keyword">for</span>(;;)   {<font></font>
     LedsContainer::ToggleAll() ;<font></font>
     delay();<font></font>
   }  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LedsContainer :: ToggleAllに4つのLEDのスイッチングを挿入するのはおもしろくないので、面白くありません:)。</font><font style="vertical-align: inherit;">LEDをコンテナーに入れてから、それらを調べて、それぞれのToggle（）メソッドを呼び出します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生徒は配列を使用して、LEDへのポインタを保存しました。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、たとえば</font></font><code>Pin&lt;PortA, 5&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>Pin&lt;PortC, 5&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな型があり、配列に格納されているさまざまな型へのポインターはできません。</font><font style="vertical-align: inherit;">あなたは、すべてのピンのための仮想基底クラスを作ることができますが、その後、仮想関数のテーブルがあるだろうと</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">udelat</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は成功していない学生を獲得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、タプルを使用します。</font><font style="vertical-align: inherit;">さまざまなタイプのオブジェクトを保存できます。</font><font style="vertical-align: inherit;">このケースは次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LedsContainer</span> {</span>  
 <span class="hljs-keyword">private</span>: 
   <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> records = <span class="hljs-built_in">std</span>::make_tuple (<font></font>
                                                   Pin&lt;PortA, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">8</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">9</span>&gt;{}    <font></font>
    ) ;<font></font>
  <span class="hljs-keyword">using</span> tRecordsTuple = <span class="hljs-keyword">decltype</span>(records) ;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
素晴らしいコンテナがあり、すべてのLEDを格納します。</font><font style="vertical-align: inherit;">次に、それにメソッドを追加します</font></font><code>ToggleAll()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LedsContainer</span> {</span>  
 <span class="hljs-keyword">public</span>:
   <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggleAll</span><span class="hljs-params">()</span>   </span>{
        <span class="hljs-comment">//       </span><font></font>
   }    <font></font>
 <span class="hljs-keyword">private</span>: 
   <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> records = <span class="hljs-built_in">std</span>::make_tuple (<font></font>
                                                   Pin&lt;PortA, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">8</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">9</span>&gt;{}    <font></font>
    ) ;<font></font>
  <span class="hljs-keyword">using</span> tRecordsTuple = <span class="hljs-keyword">decltype</span>(records) ;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タプル要素はコンパイル段階でのみ受け取る必要があるため、タプルの要素を単にウォークスルーすることはできません。タプルの要素にアクセスするために、テンプレートのgetメソッドがあります。ええと我々はこのように書いた場合</font></font><code>std::get&lt;0&gt;(records).Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そのメソッド</font></font><code>Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスオブジェクトのためには、されて</font><font style="vertical-align: inherit;">呼び出され</font></font><code>Pin&lt;PortA, 5&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た場合、</font></font><code>std::get&lt;1&gt;(records).Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その後、メソッド、</font></font><code>Toggle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスオブジェクトのためにされて</font><font style="vertical-align: inherit;">呼ばれる</font></font><code>Pin&lt;Port, 5&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とそうで... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは可能性が</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたの生徒たちの鼻を拭いて</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ちょうどこのように書きます：</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggleAll</span><span class="hljs-params">()</span>   </span>{
   <span class="hljs-built_in">std</span>::get&lt;<span class="hljs-number">0</span>&gt;(records).Toggle();
   <span class="hljs-built_in">std</span>::get&lt;<span class="hljs-number">1</span>&gt;(records).Toggle();
   <span class="hljs-built_in">std</span>::get&lt;<span class="hljs-number">2</span>&gt;(records).Toggle();
   <span class="hljs-built_in">std</span>::get&lt;<span class="hljs-number">3</span>&gt;(records).Toggle();<font></font>
   }    </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このコードをサポートするプログラマに負担をかけ、別のLEDが表示された場合などに、会社のリソースを浪費して追加の作業を行えるようにしたくありません。</font><font style="vertical-align: inherit;">コードをタプルとこのメソッドの2か所に追加する必要があります。これは適切ではなく、会社の所有者はあまり満足しません。</font><font style="vertical-align: inherit;">したがって、ヘルパーメソッドを使用してタプルをバイパスします。</font></font><br>
 <br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">class</span> <span class="hljs-title">LedsContainer</span> {</span>  
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>;
  <span class="hljs-keyword">public</span>:         
   <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggleAll</span><span class="hljs-params">()</span>     </span>{
     <span class="hljs-comment">//    3,2,1,0    ,    </span>
      visit(<span class="hljs-built_in">std</span>::make_index_sequence&lt;<span class="hljs-built_in">std</span>::tuple_size&lt;tRecordsTuple&gt;::value&gt;());<font></font>
    }   <font></font>
    <font></font>
  <span class="hljs-keyword">private</span>:       
    <span class="hljs-function">__forceinline  <span class="hljs-keyword">template</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">size_t</span>... index&gt;    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::index_sequence&lt;index...&gt;)</span>   </span>{ <font></font>
      Pass((<span class="hljs-built_in">std</span>::get&lt;index&gt;(records).Toggle(), <span class="hljs-literal">true</span>)...); <span class="hljs-comment">//    get&lt;3&gt;(records).Toggle(), get&lt;2&gt;(records).Toggle(), get&lt;1&gt;(records).Toggle(), get&lt;0&gt;(records).Toggle()</span><font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function">__forceinline <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt; 
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title">Pass</span><span class="hljs-params">(Args... )</span>  </span>{<span class="hljs-comment">//     </span><font></font>
    }<font></font>
   <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> records = <span class="hljs-built_in">std</span>::make_tuple (<font></font>
                                                   Pin&lt;PortA, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">8</span>&gt;{},<font></font>
                                                   Pin&lt;PortC, <span class="hljs-number">9</span>&gt;{}    <font></font>
    ) ;<font></font>
  <span class="hljs-keyword">using</span> tRecordsTuple = <span class="hljs-keyword">decltype</span>(records) ;<font></font>
}</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
恐ろしいように見えますが、記事の冒頭で、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shizany</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><s><font style="vertical-align: inherit;">は</font></s><font style="vertical-align: inherit;">あまり一般</font><font style="vertical-align: inherit;">的で</font><s><font style="vertical-align: inherit;">は</font></s><font style="vertical-align: inherit;">ない</font><font style="vertical-align: inherit;">ことを警告しました</font><font style="vertical-align: inherit;">... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイル段階でのこのすべての魔法は、文字通り次のことを行います。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span><font></font>
LedsContainer::ToggleAll() ;<font></font>
<span class="hljs-comment">//   4 :</span>
Pin&lt;Port, <span class="hljs-number">9</span>&gt;().Toggle() ;<font></font>
Pin&lt;Port, <span class="hljs-number">8</span>&gt;().Toggle() ;<font></font>
Pin&lt;PortC, <span class="hljs-number">5</span>&gt;().Toggle() ;<font></font>
Pin&lt;PortA, <span class="hljs-number">5</span>&gt;().Toggle() ;
<span class="hljs-comment">//     Toggle() inline,   :</span>
 *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(<span class="hljs-number">0x40020814</span> ) ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>) ;<font></font>
 *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(<span class="hljs-number">0x40020814</span> ) ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>) ;<font></font>
 *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(<span class="hljs-number">0x40020814</span> ) ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>) ;<font></font>
 *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(<span class="hljs-number">0x40020014</span> ) ^= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>) ;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化せずにコードサイズをコンパイルして確認します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイルするコード</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstddef&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tuple&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;utility&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdint&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;type_traits&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">//#include "stm32f411xe.h"</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __forceinline  <span class="hljs-meta-keyword">_Pragma</span>(<span class="hljs-meta-string">"inline=forced"</span>)</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpioaBaseAddr = <span class="hljs-number">0x4002'0000</span> ;
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> GpiocBaseAddr = <span class="hljs-number">0x4002'0800</span> ;
<span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> OdrAddrShift = <span class="hljs-number">20U</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PortBase</span>
{</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> addr&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Port</span>:</span> PortBase<font></font>
{  <font></font>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> bit)</span>
  </span>{    <font></font>
    *<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span>*&gt;(addr + OdrAddrShift) ^= (<span class="hljs-number">1</span> &lt;&lt; bit) ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint8_t</span> pinNum, 
<span class="hljs-class"><span class="hljs-keyword">class</span> = <span class="hljs-title">typename</span> <span class="hljs-title">std</span>:</span>:<span class="hljs-keyword">enable_if_t</span>&lt;<span class="hljs-built_in">std</span>::is_base_of&lt;PortBase, T&gt;::value&gt;&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pin</span>
{</span>
  <span class="hljs-function">__forceinline <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Toggle</span><span class="hljs-params">()</span>
  </span>{<font></font>
    T::Toggle(pinNum) ;<font></font>
  }<font></font>
} ;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">using</span> PortA = Port&lt;GpioaBaseAddr&gt; ;
<span class="hljs-keyword">using</span> PortC = Port&lt;GpiocBaseAddr&gt; ;<font></font>
<font></font>
<span class="hljs-comment">//using Led1 = Pin&lt;PortA, 5&gt; ;</span>
<span class="hljs-comment">//using Led2 = Pin&lt;PortC, 5&gt; ;</span>
<span class="hljs-comment">//using Led3 = Pin&lt;PortC, 8&gt; ;</span>
<span class="hljs-comment">//using Led4 = Pin&lt;PortC, 9&gt; ;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LedsContainer</span> {</span>  
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>;
  <span class="hljs-keyword">public</span>:    <font></font>
     <font></font>
      <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggleAll</span><span class="hljs-params">()</span>     </span>{
     <span class="hljs-comment">//    3,2,1,0    ,    </span>
      visit(<span class="hljs-built_in">std</span>::make_index_sequence&lt;<span class="hljs-built_in">std</span>::tuple_size&lt;tRecordsTuple&gt;::value&gt;());<font></font>
    }   <font></font>
  <span class="hljs-keyword">private</span>:   
    <span class="hljs-function">__forceinline  <span class="hljs-keyword">template</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">size_t</span>... index&gt;    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">visit</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::index_sequence&lt;index...&gt;)</span>         </span>{ <font></font>
      Pass((<span class="hljs-built_in">std</span>::get&lt;index&gt;(records).Toggle(), <span class="hljs-literal">true</span>)...);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function">__forceinline <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt; 
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title">Pass</span><span class="hljs-params">(Args... )</span>     </span>{      <font></font>
    }<font></font>
    <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> records = <span class="hljs-built_in">std</span>::make_tuple (<font></font>
                                                     Pin&lt;PortA, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                     Pin&lt;PortC, <span class="hljs-number">5</span>&gt;{},<font></font>
                                                     Pin&lt;PortC, <span class="hljs-number">8</span>&gt;{},<font></font>
                                                     Pin&lt;PortC, <span class="hljs-number">9</span>&gt;{}    <font></font>
      ) ;<font></font>
    <span class="hljs-keyword">using</span> tRecordsTuple = <span class="hljs-keyword">decltype</span>(records) ;<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delay</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; ++i){<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{ 
   <span class="hljs-keyword">for</span>(;;)   {<font></font>
     LedsContainer::ToggleAll() ;<font></font>
     <span class="hljs-comment">//GPIOA-&gt;ODR ^= 1 &lt;&lt; 5;</span>
     <span class="hljs-comment">//GPIOC-&gt;ODR ^= 1 &lt;&lt; 5;</span>
     <span class="hljs-comment">//GPIOC-&gt;ODR ^= 1 &lt;&lt; 8;</span>
     <span class="hljs-comment">//GPIOC-&gt;ODR ^= 1 &lt;&lt; 9;     </span><font></font>
     <font></font>
     delay();<font></font>
   }  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<font></font>
}</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブラー証明、予定通り開梱：</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/0e/aa/un/0eaaunh1qwmg73s1p-3ev4zcpws.png" alt="image"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリが過剰で、18バイト多いことがわかります。</font><font style="vertical-align: inherit;">問題は同じで、さらに12バイトあります。</font><font style="vertical-align: inherit;">私は彼らがどこから来たのか分かりませんでした...多分誰かが説明するでしょう。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">283バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 24 </font><font style="vertical-align: inherit;">バイトの読み取り専用</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、中程度の最適化と同じことを見ることができます...額のC ++実装と同一で、Cコードよりも最適なコードが得られました。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">251バイトの読み取り専用コードメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1バイトの読み取り専用データメモリ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8 </font><font style="vertical-align: inherit;">バイトの読み取り専用</font><font style="vertical-align: inherit;">データメモリ</font></font></blockquote><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブラ</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/y4/7w/l9/y47wl95frzmeyb2brdekbnvqvr8.png" alt="image"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、私は勝っ</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て、カナリア諸島に行き</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、チェリャビンスクで休むこと</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">できて嬉しい</font><font style="vertical-align: inherit;">です</font><font style="vertical-align: inherit;">:)が、学生も素晴らしく、試験に合格しました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">気にする人は、コードはここ</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
にありますこれをどこで使用でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">か？たとえば、これは、EEPROMメモリにパラメーターがあり、これらのパラメーターを記述するクラスがあります（読み取り、書き込み、初期値に初期化）。クラスは以下のように、テンプレートで</font></font><code>Param&lt;float&lt;&gt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>Param&lt;int&lt;&gt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたは、例えば、デフォルト値にすべてのパラメータをリセットする必要があります。タイプが異なり、各パラメーターのメソッドを呼び出すため、ここでそれらすべてをタプルに配置できます</font></font><code>SetToDefault()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。確かに、そのようなパラメータが100個ある場合、ROMはたくさんありますが、RAMは影響を受けません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS私は最大の最適化でこのコードがCおよび私のソリューションと同じサイズであることを認めなければなりません。</font><font style="vertical-align: inherit;">そして、コードを改善するためのプログラマのすべての努力は、同じアセンブラコードに帰着します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P.S1ありがとう</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xd34df00d</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">良いアドバイスを。</font><font style="vertical-align: inherit;">を使用すると、タプルの解凍を簡略化でき</font></font><code>std::apply()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">次に、関数コード</font></font><code>ToggleAll()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこれを単純化します。</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ToggleAll</span><span class="hljs-params">()</span> 
    </span>{
      <span class="hljs-built_in">std</span>::apply([](<span class="hljs-keyword">auto</span>... args) { (args.Toggle(), ...); }, records);<font></font>
    }   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、IARでは、std :: applyは現在のバージョンではまだ実装されていませんが、同様に機能します</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。std:: applyでの実装を</font></a><font style="vertical-align: inherit;">参照してください</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja457224/index.html">Androidでの競争に対する最新のアプローチ：Kotlinコルーチン</a></li>
<li><a href="../ja457232/index.html">ロボット蜂「バンブル」-ISS内での最初のテスト飛行</a></li>
<li><a href="../ja457234/index.html">製品認知バイアス</a></li>
<li><a href="../ja457236/index.html">IT企業が音楽の販売に苦労した方法</a></li>
<li><a href="../ja457240/index.html">今週のニュース：ニューラルネットワークと写真の画像、Yandexの株式の成長、Huaweiは特許に10億ドルが必要</a></li>
<li><a href="../ja457248/index.html">旋盤用のJavaScriptプログラミング</a></li>
<li><a href="../ja457250/index.html">Vue.jsの暗い日</a></li>
<li><a href="../ja457254/index.html">モバイル開発者向けの興味深い資料のダイジェスト＃303（6月17〜23日）</a></li>
<li><a href="../ja457256/index.html">インターネット履歴：ARPANET-パッケージ</a></li>
<li><a href="../ja457258/index.html">15年間海賊湾と殺すことができませんでした</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>