<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📗 📅 🗺️ نصائح وحيل Kubernetes: ميزات وقت تشغيل إيقاف التشغيل الرائعة في NGINX و PHP-FPM 🙍🏽 🎠 👩‍⚖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="شرط نموذجي لتنفيذ CI / CD في Kubernetes: يجب أن يكون التطبيق قادرًا على التوقف عن قبول طلبات العملاء الجديدة قبل التوقف ، والأهم من ذلك ، إكمال الطلبا...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>نصائح وحيل Kubernetes: ميزات وقت تشغيل إيقاف التشغيل الرائعة في NGINX و PHP-FPM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">شرط نموذجي لتنفيذ CI / CD في Kubernetes: يجب أن يكون التطبيق قادرًا على التوقف عن قبول طلبات العملاء الجديدة قبل التوقف ، والأهم من ذلك ، إكمال الطلبات الحالية بنجاح. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ry/ef/karyefzfd99wtpxne9r_o73wies.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يسمح لك الامتثال لهذا الشرط بعدم تحقيق أي وقت تعطل أثناء النشر. </font><font style="vertical-align: inherit;">ومع ذلك ، حتى عند استخدام الحزم الشائعة جدًا (مثل NGINX و PHP-FPM) ، قد تواجه صعوبات تؤدي إلى زيادة في الأخطاء مع كل عملية نشر ...</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">نظرية. </font><font style="vertical-align: inherit;">كيف يعيش جراب</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لقد نشرنا </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هذه المقالة</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> بالفعل بالتفصيل حول دورة حياة الكبسولة </font><font style="vertical-align: inherit;">. في سياق هذا الموضوع ، نحن مهتمون بما يلي: في اللحظة التي يدخل فيها البود إلى حالة </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الإنهاء</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، يتوقف إرسال الطلبات الجديدة إليه ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تتم إزالة</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الجراب </font><font style="vertical-align: inherit;">من قائمة نقاط النهاية للخدمة). وبالتالي ، لتجنب توقف العمل أثناء النشر ، من جانبنا ، يكفي حل مشكلة إيقاف التطبيق بشكل صحيح. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يجب أن نتذكر أيضًا أن فترة السماح هي </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 ثانية</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> بشكل افتراضي </font><font style="vertical-align: inherit;">: بعد ذلك ، سيتم إنهاء الكود ويجب أن يتمكن التطبيق من معالجة جميع الطلبات قبل هذه الفترة. </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ملحوظة</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: على الرغم من أن أي طلب يتم تشغيله لأكثر من 5-10 ثوانٍ يمثل مشكلة بالفعل ، ولن يساعده الإغلاق الرشيق بعد الآن ...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
لفهم أفضل لما يحدث عندما تنتهي pod من عملها ، يكفي دراسة المخطط التالي: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/pt/ou/zxptou-qe7zxqgab6pszsdo5vlk.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A1 ، B1 - الحصول على تغييرات حول حالة </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الجزء </font><font style="vertical-align: inherit;">الفرعي </font><font style="vertical-align: inherit;">A2: إرسال SIGTERM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B2 - إزالة pod من نقاط النهاية </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B3 - الحصول على التغييرات (تغيرت قائمة نقاط النهاية) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B4 - تحديث قواعد iptables</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ملاحظة: لا يتم إزالة pod endpod وإرسال SIGTERM بالتسلسل ، ولكن بالتوازي. ونظرًا لحقيقة أن Ingress لا تتلقى قائمة محدثة بنقاط النهاية على الفور ، سيتم إرسال الطلبات الجديدة من العملاء إلى pod ، مما سيؤدي إلى حدوث 500 خطأ أثناء إنهاء pod</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ترجمنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> مواد أكثر تفصيلاً حول هذا الموضوع </font><font style="vertical-align: inherit;">)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">أنت بحاجة إلى حل هذه المشكلة بالطرق التالية:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إرسال رؤوس الاتصال: استجابة قريبة (إذا كانت تتعلق بتطبيق HTTP).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إذا لم تكن هناك طريقة لإجراء تغييرات على الرمز ، فإن المقالة تصف حلاً سيسمح لك بمعالجة الطلبات حتى نهاية الفترة الرشيقة.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">نظرية. </font><font style="vertical-align: inherit;">كيف تنهي NGINX و PHP-FPM عملياتهما</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لنبدأ بـ NGINX ، لأن كل شيء أصبح أكثر أو أقل وضوحًا معها. </font><font style="vertical-align: inherit;">منغمسًا في النظرية ، نتعلم أن NGINX لديها عملية رئيسية واحدة والعديد من "العمال" - هذه عمليات تابعة تعالج طلبات العملاء. </font><font style="vertical-align: inherit;">يتم توفير ميزة ملائمة: استخدام الأمر </font></font><code>nginx -s &lt;SIGNAL&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لإنهاء العمليات إما في وضع إيقاف التشغيل السريع أو في إيقاف تشغيل رشيق. </font><font style="vertical-align: inherit;">من الواضح أننا مهتمون بالتحديد بالخيار الأخير. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ثم كل شيء بسيط: تحتاج إلى إضافة </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أمر</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إلى </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;">خطاف preStop</font></a><font style="vertical-align: inherit;"> الذي سيرسل إشارة حول إيقاف التشغيل </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;">الآمن</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">يمكن القيام بذلك في النشر ، في كتلة الحاوية:</font></font><br>
<br>
<pre><code class="plaintext hljs">       lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /usr/sbin/nginx<font></font>
              - -s<font></font>
              - quit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الآن ، في الوقت الذي يكمل فيه البود عمله في سجلات حاويات NGINX ، سنرى ما يلي:</font></font><br>
<br>
<pre><code class="plaintext hljs">2018/01/25 13:58:31 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down<font></font>
2018/01/25 13:58:31 [notice] 11#11: gracefully shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وهذا سيعني ما نحتاجه: تنتظر NGINX إتمام الاستعلامات ، ثم تقتل العملية. </font><font style="vertical-align: inherit;">ومع ذلك ، سيتم مناقشة مشكلة شائعة أدناه ، لأنه ، حتى إذا كان هناك أمر ، لا </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تكتمل العملية بشكل صحيح. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وفي هذه المرحلة انتهينا من NGINX: على الأقل يمكنك أن تفهم من السجلات أن كل شيء يعمل كما ينبغي. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ماذا عن PHP-FPM؟ </font><font style="vertical-align: inherit;">كيف يتعامل مع الاغلاق الرشيق؟ </font><font style="vertical-align: inherit;">دعنا نحصل على حق.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في حالة PHP-FPM ، معلومات أقل قليلاً. </font><font style="vertical-align: inherit;">إذا ركزت على </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الدليل الرسمي لـ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHP-FPM ، فسيخبرك أنه يتم تلقي إشارات POSIX التالية:</font></font><br>
<br>
<ol>
<li> <code>SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- إيقاف التشغيل السريع.</font></font></li>
<li> <code>SIGQUIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - إغلاق رشيق (ما نحتاجه).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بقية الإشارات في هذه المشكلة ليست مطلوبة ، لذلك ، تم حذف تحليلها. </font><font style="vertical-align: inherit;">لإكمال العملية بشكل صحيح ، ستحتاج إلى كتابة خطاف preStop التالي:</font></font><br>
<br>
<pre><code class="plaintext hljs">        lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /bin/kill<font></font>
              - -SIGQUIT<font></font>
              - "1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
للوهلة الأولى ، هذا هو كل ما هو مطلوب لإجراء إغلاق رشيق في كلتا الحاويتين. </font><font style="vertical-align: inherit;">ومع ذلك ، فإن المهمة أكثر تعقيدًا مما تبدو عليه. </font><font style="vertical-align: inherit;">بعد ذلك ، فحصنا حالتين لم ينجح فيه الإغلاق الرشيق وتسبب في عدم إمكانية الوصول إلى المشروع على المدى القصير أثناء النشر.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ممارسة. </font><font style="vertical-align: inherit;">مشاكل محتملة مع إغلاق رشيق</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بادئ ذي بدء ، من المفيد أن نتذكر: بالإضافة إلى تنفيذ الأمر ، </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هناك خطوة أخرى يجب الانتباه إليها. واجهتنا مشكلة عندما أرسلت NGINX بدلاً من إشارة SIGQUIT SIGTERM على أي حال ، والتي لم تكتمل الطلبات بشكل صحيح. يمكن العثور على حالات مماثلة ، على سبيل المثال ، </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . للأسف ، لم نتمكن من تحديد سبب محدد لهذا السلوك: كان هناك شك في إصدار NGINX ، ولكن لم يتم تأكيده. كانت الأعراض أنه في سجلات حاوية NGINX لوحظت الرسائل </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"مأخذ مفتوح رقم 10 اليسار في اتصال 5"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، وبعد ذلك توقف الجراب. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يمكننا ملاحظة مثل هذه المشكلة ، على سبيل المثال ، من خلال الإجابات على Ingress التي نحتاجها: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/sz/ip/umszip1dlpudotn2dstg17qfnzs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مؤشرات رمز الحالة في وقت النشر</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في هذه الحالة ، نحصل فقط على رمز الخطأ 503 من Ingress نفسها: لا يمكنها الوصول إلى حاوية NGINX ، لأنها لم تعد متاحة. </font><font style="vertical-align: inherit;">إذا نظرت إلى سجلات الحاوية باستخدام NGINX ، فستحتوي على ما يلي:</font></font><br>
<br>
<pre><code class="plaintext hljs">[alert] 13939#0: *154 open socket #3 left in connection 16<font></font>
[alert] 13939#0: *168 open socket #6 left in connection 13</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد تغيير إشارة التوقف ، تبدأ الحاوية في التوقف بشكل صحيح: وهذا مؤكد من خلال حقيقة أن خطأ 503 لم يعد ملاحظًا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا واجهت مشكلة مماثلة ، فمن المنطقي معرفة أي إشارة توقف يتم استخدامها في الحاوية وكيف يبدو خطاف preStop بالضبط. </font><font style="vertical-align: inherit;">من الممكن أن السبب يكمن بالضبط في ذلك.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM ... والمزيد</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتم وصف مشكلة PHP-FPM بشكل تافه: فهي لا تنتظر اكتمال العمليات الفرعية ، وتنهيها ، بسبب وجود 502 خطأ أثناء النشر والعمليات الأخرى. ومنذ عام 2005 كانت هناك عدة رسائل خطأ على bugs.php.net (على سبيل المثال، </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> و </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هنا</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) التي تصف هذه المشكلة. ولكن ربما لن ترى أي شيء في السجلات: ستعلن PHP-FPM عن اكتمال عمليتها دون أي أخطاء أو إشعارات من جهات خارجية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تجدر الإشارة إلى أن المشكلة نفسها قد تعتمد ، إلى حد أقل أو أكبر ، على التطبيق نفسه وقد لا تظهر ، على سبيل المثال ، في المراقبة. إذا كنت لا تزال تواجهه ، فحينئذٍ يتبادر إلى الذهن حل بديل بسيط: أضف خطاف preStop باستخدام</font></font><code>sleep(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. سيسمح لك بإكمال جميع الطلبات التي كانت من قبل (نحن لا نقبل طلبات جديدة ، حيث إن الجراب موجود </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بالفعل</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في حالة </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الإنهاء</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ، وبعد 30 ثانية سينتهي الجراب نفسه بإشارة </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
اتضح أنه </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بالنسبة للحاوية ستبدو كما يلي:</font></font><br>
<br>
<pre><code class="plaintext hljs">    lifecycle:<font></font>
      preStop:<font></font>
        exec:<font></font>
          command:<font></font>
          - /bin/sleep<font></font>
          - "30"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومع ذلك ، نظرًا لمؤشر 30 ثانية ، </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سنقوم </font><font style="vertical-align: inherit;">بزيادة وقت النشر </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بشكل ملحوظ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، حيث سيتم إنهاء كل جراب لمدة </font><font style="vertical-align: inherit;">30 ثانية </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">على الأقل</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، وهو أمر سيئ. ما الذي يمكن عمله بهذا؟ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
دعونا ننتقل إلى الطرف المسؤول عن التنفيذ المباشر للتطبيق. في حالتنا ، هذه هي </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، والتي </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لا تراقب بشكل افتراضي تنفيذ العمليات التابعة لها</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : يتم إنهاء العملية الرئيسية على الفور. يمكن تغيير هذا السلوك باستخدام توجيه </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يحدد الحدود الزمنية لانتظار الإشارات من المعلم من خلال العمليات الفرعية. إذا قمت بتعيين القيمة إلى 20 ثانية ، فسوف يغطي هذا معظم الطلبات التي يتم تشغيلها في الحاوية ، وبعد اكتمالها ، سيتم إيقاف العملية الرئيسية.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مع هذه المعرفة ، سنعود إلى مشكلتنا الأخيرة. كما سبق ذكره ، فإن Kubernetes ليست منصة متجانسة: يستغرق بعض الوقت للتفاعل بين مكوناتها المختلفة. هذا صحيح بشكل خاص عندما ننظر في عمل Ingresss والمكونات الأخرى ذات الصلة ، لأنه بسبب هذا التأخير في وقت النشر ، من السهل الحصول على زيادة قدرها 500 خطأ. على سبيل المثال ، قد يحدث خطأ في مرحلة إرسال طلب إلى المنبع ، ولكن "الفجوة الزمنية" للتفاعل بين المكونات قصيرة نوعًا ما - أقل من ثانية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لذلك ، </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بالاقتران</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> مع التوجيه المذكور أعلاه </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، يمكن استخدام البناء التالي من أجل </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">lifecycle:<font></font>
  preStop:<font></font>
    exec:<font></font>
      command: ["/bin/bash","-c","/bin/sleep 1; kill -QUIT 1"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في هذه الحالة ، نحن نعوض التأخير من قبل الفريق </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ولا نزيد من وقت النشر بشكل ملحوظ: هل هناك فرق ملحوظ بين 30 ثانية وواحدة؟ .. في الواقع ، يتم الاعتناء بـ "الوظيفة الرئيسية" </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، ولكن يتم </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">استخدامها فقط كـ "شبكة أمان" في حالة التأخير. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بشكل عام ، فإن </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">السلوك الموصوف والحل البديل المقابل ليس فقط PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">قد تنشأ حالة مماثلة بطريقة أو بأخرى عند استخدام لغات / أطر أخرى. </font><font style="vertical-align: inherit;">إذا لم تتمكن من إصلاح إيقاف التشغيل الآمن بطرق أخرى - على سبيل المثال ، أعد كتابة الشفرة بحيث يعالج التطبيق إشارات الإنهاء بشكل صحيح - يمكنك استخدام الطريقة الموضحة. </font><font style="vertical-align: inherit;">قد لا يكون أجمل ، لكنه يعمل.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ممارسة. </font><font style="vertical-align: inherit;">حمل الاختبار للتحقق من أداء جراب</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
اختبار الحمل هو إحدى الطرق للتحقق من كيفية عمل الحاوية ، لأن هذا الإجراء يجعلك أقرب إلى ظروف القتال الحقيقية عندما يزور المستخدمون الموقع. يمكنك استخدام </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> لاختبار التوصيات أعلاه </font><font style="vertical-align: inherit;">: فهو يغطي جميع احتياجاتنا بشكل مثالي. فيما يلي نصائح وحيل للاختبار بشكل واضح - بفضل الرسوم البيانية لـ Grafana و Yandex.Tank نفسها - مثال من تجربتنا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أهم شيء هنا هو </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">التحقق من التغييرات في المراحل.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. بعد إضافة إصلاح جديد ، قم بتشغيل الاختبار ومعرفة ما إذا كانت النتائج قد تغيرت مقارنة بالإطلاق السابق. خلاف ذلك ، سيكون من الصعب تحديد حلول غير فعالة ، وفي المستقبل يمكنك فقط إلحاق الضرر (على سبيل المثال ، زيادة وقت النشر). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تحذير آخر - انظر إلى سجلات الحاوية أثناء إنهائها. هل يتم تسجيل معلومات إيقاف التشغيل الممتازة هناك؟ هل هناك أي أخطاء في السجلات عند الوصول إلى الموارد الأخرى (على سبيل المثال ، حاوية PHP-FPM المجاورة)؟ أخطاء التطبيق نفسه (كما في حالة NGINX الموصوفة أعلاه)؟ آمل أن تساعد المعلومات التمهيدية الواردة في هذه المقالة على فهم ما يحدث للحاوية بشكل أفضل أثناء إنهائها. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لذلك ، تم إجراء أول اختبار تجريبي بدون </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أو بدون توجيهات إضافية لخادم التطبيق (</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في PHP-FPM). كان الغرض من هذا الاختبار هو تحديد العدد التقريبي للأخطاء (وما إذا كانت موجودة على الإطلاق). أيضًا ، من المعلومات الإضافية ، يجب أن يكون معروفًا أن متوسط ​​وقت النشر لكل موقد كان حوالي 5-10 ثوانٍ لحالة الاستعداد الكامل. النتائج هي كما يلي: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/yw/ap/ceywapg8q2kpztr-zdslhjy8brm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تظهر بقعة من أخطاء 502 على لوحة معلومات Yandex.Tank ، والتي حدثت في وقت النشر واستمرت لمدة تصل إلى 5 ثوانٍ. من المفترض أن هذا أنهى الطلبات الحالية للجراب القديم عندما تم إنهاؤه. بعد ذلك ، ظهرت 503 أخطاء ، والتي نتجت عن حاوية NGINX متوقفة ، والتي تم فصلها أيضًا بسبب الواجهة الخلفية (بسبب عدم تمكن Ingress من الاتصال بها). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
دعونا نرى كيف</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في PHP-FPM ستساعدنا في انتظار اكتمال العمليات الفرعية ، أي </font><font style="vertical-align: inherit;">إصلاح مثل هذه الأخطاء. </font><font style="vertical-align: inherit;">النشر المتكرر باستخدام هذا التوجيه: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/8g/0c/t58g0cs5b6umhjkmvlhjktbkio0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لم يعد هناك المزيد من الأخطاء أثناء نشر 500s! </font><font style="vertical-align: inherit;">النشر ناجح ، يعمل الإغلاق الرشيق. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومع ذلك ، يجدر تذكر اللحظة مع حاويات Ingress ، وهي نسبة صغيرة من الأخطاء التي يمكن أن نقع فيها بسبب الفارق الزمني. </font><font style="vertical-align: inherit;">لتجنبها ، يبقى إضافة البناء مع </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وتكرار النشر. </font><font style="vertical-align: inherit;">ومع ذلك ، في حالتنا الخاصة ، لم تكن هناك تغييرات مرئية (لا توجد أخطاء مرة أخرى).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">استنتاج</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لإكمال العملية بشكل صحيح ، نتوقع السلوك التالي من التطبيق:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> انتظر بضع ثوانٍ ، ثم توقف عن قبول الاتصالات الجديدة.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> انتظر حتى تكتمل جميع الطلبات وتغلق جميع الاتصالات المستمرة التي لا تنفذ الطلبات.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> أكمل عمليتك.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومع ذلك ، لا يمكن لجميع التطبيقات العمل بهذه الطريقة. </font><font style="vertical-align: inherit;">أحد حلول المشكلة في حقائق Kubernetes هو:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إضافة خطاف قبل الإيقاف ينتظر بضع ثوانٍ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> دراسة ملف تكوين الواجهة الخلفية للمعلمات ذات الصلة.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يسمح لنا مثال NGINX بفهم أنه حتى التطبيق الذي يجب عليه في البداية معالجة الإشارات بشكل صحيح للإنجاز قد لا يفعل ذلك ، لذلك من المهم التحقق من وجود 500 خطأ أثناء نشر التطبيق. كما يسمح لك بالنظر إلى المشكلة على نطاق أوسع وعدم التركيز على جراب أو حاوية منفصلة ، ولكن انظر إلى البنية التحتية بأكملها ككل. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يمكن استخدام Yandex.Tank كأداة اختبار بالاقتران مع أي نظام مراقبة (في حالتنا ، تم أخذ البيانات من Grafana مع خلفية في شكل Prometheus للاختبار). تظهر مشاكل الإغلاق الرشيق بوضوح تحت الأحمال الثقيلة التي يمكن أن يولدها المعيار ، وتساعد المراقبة على تحليل الموقف بمزيد من التفاصيل أثناء الاختبار أو بعده.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الرد على التعليقات على المقال: من الجدير بالذكر أن المشكلات والحلول موصوفة هنا فيما يتعلق بـ NGINX Ingress. </font><font style="vertical-align: inherit;">بالنسبة للحالات الأخرى ، هناك حلول أخرى ، ربما ، سنأخذها بعين الاعتبار في المواد التالية من الدورة.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ملاحظة</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أخرى من دورة النصائح والحيل K8s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">صفحات الأخطاء الشخصية في NGINX Ingress</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " ؛</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">حول تخصيص العقد والحمل على تطبيق الويب</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " ؛</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الوصول إلى مواقع ديف</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " ؛</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تسريع تمهيد قواعد البيانات الكبيرة.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar489984/index.html">AMA عن udalenka: اسأل - نجيب</a></li>
<li><a href="../ar489986/index.html">أداة Power Power Designer Utility - أداة تطوير إلكترونيات الطاقة</a></li>
<li><a href="../ar489988/index.html">"ضع يديك في الهواء!": مراجعة أحادية للوحة تحكم Playme TIO S</a></li>
<li><a href="../ar489990/index.html">كيف أنقذ مكتب الخدمة شركة خدمات ، أو ماذا لو نما عملك؟</a></li>
<li><a href="../ar489992/index.html">الإغلاق الصحيح للجراب في كتلة Kubernetes</a></li>
<li><a href="../ar489998/index.html">11. Fortinet الشروع في v6.0. الترخيص</a></li>
<li><a href="../ar490002/index.html">كيفية الرسم البياني على Kotlin و Micronaut وإنشاء نقطة وصول واحدة إلى API للعديد من الخدمات الصغيرة</a></li>
<li><a href="../ar490006/index.html">برنامج تعليمي للمواصفات الفنية</a></li>
<li><a href="../ar490010/index.html">فحص نظام النوع للتحقق من صحة الموسيقى</a></li>
<li><a href="../ar490012/index.html">التنبيهات والخطأ في التخزين ، وكيفية التعامل معها؟</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>