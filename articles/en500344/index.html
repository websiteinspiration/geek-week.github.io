<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèø üîº üõ∏ Smart home on wheels ... Alice. Part 2. ZIGBEE üëßüèª ü§òüèº üêó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of the epic with voice control
 In the previous part, through Alice, the voice was controlled by MiLight controllers. But such controller...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Smart home on wheels ... Alice. Part 2. ZIGBEE</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500344/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuation of the epic with voice control</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous part, through Alice, the voice was controlled by MiLight controllers. But such controllers are not at all in every house, which greatly limits our capabilities. Therefore, I set out to expand the voice control to ordinary lamps, lamps, chandeliers, and so on, but with a minimal alteration of the standard lighting system. All that will be needed for such a system is the replacement of conventional switches with smart switches operating according to the ZigBee protocol and the installation of a USB ZigBee coordinator CC2531. Naturally, from the previous article, we already have a smart Yandex column and a customized mess.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cost of CC2531 cost 250 rubles, the programmer for it CC-Debugger Texas Instrument - 500 rubles. The Livolo VL-C701Z-11 touch smart switches were the most expensive - about 2000 rubles apiece, and a little later the Aqara Wall Switch Zigbee button switch was also added around 2000.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, I planned to control the switches through the proprietary ZigBee gateway router Livolo C700ZW-12, connect it to the open hub and steer using Alice through yandex2mqtt. I connected the glands to electricity, set up the application from Livolo on the phone. I saw the gateway switches, connected, and everything worked perfectly from the phone. But the open hub with the router could not be merged due to the lack of the necessary functionality in the open hub. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I had to abandon the gateway and merge the switches directly with the CC2531 dongle. And here the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><font style="vertical-align: inherit;">from the friend Koenkk </font><font style="vertical-align: inherit;">helped with this </font><font style="vertical-align: inherit;">. As a result, we managed to connect the ZigBee coordinator with smart switches, first check their operation through queries in the mqtt topic for analysis, and then configure the control using Alice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, how did the setup </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
go </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">1. Flash the CC2531 sniffer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coordinator‚Äôs </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">firmware</font></a><font style="vertical-align: inherit;"> and plug it into the usb port. In order to avoid messages about a lack of power, it‚Äôs better to connect at least 2A to a 5V power supply. We check that the stick in the system is correctly defined: ls -l / dev / serial / by-id will show something like usb-Texas_Instruments_TI_CC2531_USB_CDC ___ 0X00124B0458ED3DDF-if00 -&gt; ../../ttyACM0. The presence of the last piece of output "-&gt; ../../ttyACM0" is very important if that. A stick can decide without this part and nothing will work. Flashing the stick helped me with such a problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zigbee2mqtt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but do not start.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. It is important to configure /opt/zigbee2mqtt/data/configuration.yaml correctly. The fact is that Livolo smart switches operate on channel 26, so this channel must be explicitly set in the file. And it is also important to pay attention to the number of spaces at the beginning of the lines of the file. To check the syntax of the configuration file, you can use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YAML validator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. After the configuration file is registered correctly and the dongle is stuck, run zigbee2mqtt. Then we stomp to the switches, start pairing and look at the console output. There will be a line of data exchange, mutual rassharkivaniya between devices and finally something like this: </font></font><code>MQTT publish: topic 'zigbee2mqtt/0x001*********a8c9', payload '{"state_left":"OFF","state_right":"OFF","linkquality":60}'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This means that the switch is connected and sent its status. If you run a couple more consoles, then you can control the light through the mqtt-topic: turn off</font></font><code>- mosquitto_pub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -m OFF -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and turn - </font></font><code>mosquitto_pub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -m ON -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and you can also check the team in Topeka </font></font><code>mosquitto_sub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. By the way, for Livolo and Aqara, topics differ not only in identifiers 0x0 ..., but also in structure. The structure of topics for supported devices can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. After we have verified that we can manage devices through mqtt, we will pair everything with Yandex. Some nuance has appeared here. Commands for controlling devices through zigbee2mqtt came to topics in the form of ON / OFF, and yandex2mqtt as it turned out gives 1/0. The solution to this problem was to edit the /mnt/data/root/yandex2mqtt/device.js file in yandex2mqtt. Do you need to replace int = val in the switch in the ‚Äúon‚Äù case? to 'on': 'off' instead of '1': '0'. Naturally, the switching commands had to be corrected in the open hub in the corresponding topics. Without this, the light on Milight would cease to work. And the most interesting thing was revealed right there - since yandex2mqtt and zigbee2mqtt publish everything on the local mqtt server, it seems that zenbee devices do not need an open hub to manage devices.The bundle works directly - yandex (Alice) -yandex2mqtt-mqtt-zigbee2mqtt-device zigbee. Even unexpectedly somehow. But let's continue. We‚Äôll file the device control topic in the configuration file /mnt/data/root/yandex2mqtt/config.js into a new virtual device, update the list of devices in the Yandex dialog system and you can kick Alice to turn on the light.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. It was also possible to connect a pair of Xiaomi sensors, a leakage sensor and a temperature / humidity / pressure sensor to the system. </font><font style="vertical-align: inherit;">They work on 2032 batteries. Naturally, they are not controlled, but they simply periodically drop information such </font></font><code>#033[32mzigbee2mqtt:info #033[39m 2020-05-04 21:12:21: MQTT publish: topic 'zigbee2mqtt/0x0015************', payload '{"battery":91,"voltage":2985,"temperature":26.2,"humidity":28.65,"pressure":1006.9,"linkquality":52}' -   #  #033[32mzigbee2mqtt:info #033[39m 2020-05-04 21:21:07: MQTT publish: topic 'zigbee2mqtt/0x001************7', payload '{"battery":100,"voltage":3025,"linkquality":0,"water_leak":true}' </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as a leak sensor in a glass of water </font><font style="vertical-align: inherit;">into topics </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">So far, there is no particular benefit, but if all this is otparsit and do something reactive such as sending SMS or digits to some web muzzle, then it will be very good. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And a little video:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Pb8veRpRMTY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/9uNynR_LL-o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500332/index.html">May 4th Java Digest</a></li>
<li><a href="../en500334/index.html">Twisters or Fridge in Pilot Brothers</a></li>
<li><a href="../en500336/index.html">Part 2: Modules and AppStore. ESPboy - a gadget for retro games and experiments with IoT</a></li>
<li><a href="../en500338/index.html">[Translation] Rinse off</a></li>
<li><a href="../en500342/index.html">What podcasts does the ‚ÄúCommittee‚Äù, ‚ÄúHabr‚Äù and Sports.ru have</a></li>
<li><a href="../en500346/index.html">Problems with DNS in Kubernetes. Public post-mortem</a></li>
<li><a href="../en500348/index.html">COVID-19 pandemic through the eyes of a mathematician, or why the classic SEIRD model does not work</a></li>
<li><a href="../en500352/index.html">How to get an internship on Facebook and get an offer in London? Ask a Facebook Engineer a Question</a></li>
<li><a href="../en500354/index.html">A new way to track data in Google Tag Manager - Server-Side Tagging</a></li>
<li><a href="../en500356/index.html">Direct file transfer between devices via WebRTC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>