<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🚒 👧🏻 👩🏼‍🤝‍👨🏾 Spear phishing: experience creating conditionally malicious executable files for phishing emails ▫️ 😐 👩🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 We already wrote about targeted phishing (Spear Phishing) in one of our articles , which covered the general aspects of targeted e-mail ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spear phishing: experience creating conditionally malicious executable files for phishing emails</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/505884/"><img src="https://habrastorage.org/webt/vi/nj/ks/vinjksi1aod6jn4fntuzbt6i5p0.png"><br>
<br>
<b><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We already wrote about targeted phishing (Spear Phishing) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in one of our articles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which covered the general aspects of targeted e-mail distribution. </font><font style="vertical-align: inherit;">In this article, we suggest that you familiarize yourself with our experience in training targeted mailings containing conditionally malicious attachments.</font></font><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typically, targeted mailings include the following steps:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preliminary search for employee accounts in various data sources</font></font></li>
<li>  </li>
<li>       </li>
<li>  </li>
<li>   ,  , , , ,    ( )</li>
<li> ,       </li>
<li>       </li>
<li>    </li>
<li>     </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As part of this article, we will focus on the preparation for the targeted mailing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the distribution is carried out as part of the work related to the Pentest and RedTeam, then the search for employee accounts takes a fairly large amount of time and human resources. </font><font style="vertical-align: inherit;">Next, the resulting list of accounts should be formed into target groups for distribution, after which letter templates for each group are generated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the specifics of the company’s work and the specifics of the target group, it is necessary to draw up the most plausible templates for letters that employees will receive. </font><font style="vertical-align: inherit;">Sometimes we resort to templates with the “update” of some guidance document. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this stage, you also need to choose what types of attachments in the letters we will use. </font><font style="vertical-align: inherit;">In our experience, these are usually the following file types:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.docx, .doc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.xlsx, .xls</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.exe</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pdf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS Office files have the advantage that they are familiar to the user and are likely to be opened to view them (if the spam filter does not cut them as malicious). </font><font style="vertical-align: inherit;">The downsides are that there are not many ways to launch a conditionally malicious load and organize feedback with the management server:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macros</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">known vulnerabilities (DDE, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMB (external files, documents attached to the MS Office file by reference)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With macros, everything is relatively simple, there are automation tools for creating such macros, they can be used with some modifications. The attachment can be ready for distribution in a few hours or in the worst case days, if the antivirus that is supposed to be installed on the victim “swears” at the load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With SMB, everything is also quite easy, there are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tools for automating the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process, but it is necessary that the user comply with the condition that there is no blocking of outgoing SMB traffic to port 445. Some companies and providers block such traffic.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are not so many vulnerabilities that lead to code execution in MS Office, but you need to understand that not all companies and not all workstations have the ability to update office software. </font><font style="vertical-align: inherit;">If we know that a specific employee of the customer has an outdated set of software on the computer, then we can try to use such vectors in the hope that the antivirus software is also not updated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we worked in a market where other office software is distributed, such as the Urdu InPage file viewer common in Asia, then we would choose other file types for such an office application and take advantage of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">well-known vulnerabilities in it</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the PDF format, you can also consider several options for creating a load:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Js</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">known vulnerabilities</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMB (external files, documents attached to the file by reference) </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the PDF viewer engine, it is possible to include JS code inside the document for greater customization. </font><font style="vertical-align: inherit;">This allows you to include JS code in the document and execute it on the user's computer. </font><font style="vertical-align: inherit;">This method is quite well detected by antiviruses and therefore is not very suitable for our tasks, we do not recommend using it. </font><font style="vertical-align: inherit;">Exactly the same situation with known vulnerabilities, antiviruses well detect the code that leads to the vulnerability trigger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With SMB, the situation is less rosy than in MS Office, the leak of NetNTLM hashes in the most common Adobe Reader and FoxitReader is considered a vulnerability and it was fixed, for example, in Adobe Reader in 2018 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(CVE-2018-4993)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, when preparing the load in the form of PDF, you need to rely on other viewers of PDF documents or very outdated versions above indicated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Executable files (.exe, etc.) have the advantage that the methods of communication with the distribution organizer are mainly limited to the protocols allowed in the company for employee computers (tcp, udp, http, icmp, etc.), and that you can collect a lot of information about the user who will open such a file. Cons, of course, are that antivirus software can mark a distributed file as malicious and the entire distribution can be cut even at the stage of mail delivery with an antispam filter with integrated antivirus software. An additional minus is that modern Windows operating systems mark a file downloaded from the Internet, placing additional information in an alternative NTFS stream, and when the file is launched, they offer the user to agree to launch the application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why did you need your own development of a training mailing list program? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All samples of the free mailing list software that we studied (SpearPhisher, King Phisher, Gophish) do not offer the automatic creation of conditionally malicious load in the form of an executable file according to a template built into the software. </font><font style="vertical-align: inherit;">They leave this, so to speak, for the "exercise of the curious reader."</font></font><br>
<br>
<b><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development</font></font></h2></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We approach the development of software with a description of the functions that it should perform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main function of the software will be the identification of the user of the target company who will “swallow the bait” and launch the application, therefore, first of all, you need to decide on the data that the application running on the computer should collect. </font><font style="vertical-align: inherit;">How full is this set, practice will show, if you think that we did not select all the identifiers that allow you to set a user from the target company, write to us in the comments about this. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For ourselves, we defined this data as follows:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Username</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">computer name</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOGONSERVER</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external and internal IP address (if possible)</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then we will determine by which communication channels we will give the collected data. </font><font style="vertical-align: inherit;">We chose two:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTTP was chosen to verify access to the Internet from the network where our software is launched. If access to the Internet does not require the use of a proxy or other conditions, then this increases the risk of infection of the organization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS was chosen as a backup data transmission channel, since it is quite rare for a company to restrict access to DNS servers and traffic that passes through the DNS channel. In DNS, we selected A records as the most likely channel for information leakage.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, do not forget that antivirus software, HIPS, can be installed on the target computer. </font><font style="vertical-align: inherit;">And it also leaves its mark on software development. </font><font style="vertical-align: inherit;">It is necessary to add an item to the software development cycle that is associated with testing software detection by popular antiviruses. </font><font style="vertical-align: inherit;">For ourselves, we determined the minimum testing as one antivirus - Defender, since it is included in the Windows 10 assembly by default. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To collect data received via the DNS channel, we specially configured A-records at the registrar of our domain. </font><font style="vertical-align: inherit;">The essence of the settings is to ensure that all requests for subdomains of our domain are sent to our NS, where we simply install tcpdump on port 53. This is the minimum effort required to register data sent by our application.</font></font><br>
<br>
<b><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting points on the way to release</font></font></h2></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that it is not worthwhile to include non-ASCII characters in packets intended for transferring A-records over the DNS channel. This means that the usernames or computers written in Cyrillic, Farsi, etc., turn into scribbles :) We decided to choose base32 encoded character encoding, since all the characters included in it can be used for DNS transfers in A records. Although, while searching for existing solutions, we came across the fact that using base64 is also acceptable for most modern </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS servers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Also, data longer than 63 characters must be divided into several packages or subdomains. Of course, a situation is quite rare in which the username or computer name will be longer than 63 characters, but if in the future you want to exfiltrate more data than we indicated in the wishes for the program, you will have to take this fact into account.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To determine the external IP address, one has to rely either on uncontrolled resources, which can also affect the quality of the collected results if such a resource is blocked in the target company or region, or rely on its own resources. </font><font style="vertical-align: inherit;">Therefore, by agreement with the Customer, it is necessary to use external hosts for exfiltration of data that are not blocked in the network of the organization under study, or use services from unlikely blocked networks (Azure, Amazon, DO), relying on luck. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since there may be several internal addresses on the target computer, we decided to focus on the first one in the list and collect only it. </font><font style="vertical-align: inherit;">This assumption is made on the basis of the fact that a phishing funnel will most likely pass through an ordinary employee with an ordinary computer with 1 network address.</font></font><br>
<br>
<b><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing</font></font></h2></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After starting the load on the target host, we received requests coming from the ASN, owned by Microsoft in France, however, after that, after some time, information about the launch of our application began to come from the ASN of Asian countries - Korea, China, India. Once again, it was confirmed that modern anti-virus and anti-phishing solutions send files suspicious from their point of view to their cloud and run tests on their own virtual machines to make sure that these files are harmful.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The identifiers of virtual machines from the MS cloud are all typical, an arbitrary computer name, the same username. But computer identifiers from Asia represent more human-readable data (Computer, Admin-PC, USERPC, etc.). On the one hand, this may mean that our files were opened from a location hidden behind a VPN, on the other hand, that anti-virus companies share fresh files with each other.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we created non-personalized application builds, it was not possible to track which specific files were sent to the cloud. </font><font style="vertical-align: inherit;">Maybe all the files from the mailing list, and maybe only those that were sent first. </font><font style="vertical-align: inherit;">With a high probability, in future releases we will think over the patch mechanism for each attachment and send the application with the user ID to which the letter is addressed - it will be easier to track files that are checked on cloud virtual machines. </font><font style="vertical-align: inherit;">This is necessary to eliminate false positive data received by the server collecting information.</font></font><br>
<br>
<b><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The success of phishing attacks is facilitated by a low level of user awareness of the rules of working with mail in the company. </font><font style="vertical-align: inherit;">Spam filters remain the main protection against mass phishing, but this does not save spear phishing (targeted phishing). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my opinion, one should not discount the importance of social engineering in the context of work related to penetration testing. </font><font style="vertical-align: inherit;">The human factor will always be a loophole for cybercriminals in the security system of even the largest company. </font><font style="vertical-align: inherit;">If even a small percentage of employees launch malware on the organization’s network (especially for privileged employees - top management, system administrators), this will mean a compromise of the entire company.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505856/index.html">From Brute-Force to the attempt on privacy - what SaaS providers face</a></li>
<li><a href="../en505860/index.html">Spring Boot, Hibernate and Kotlin for beginners step by step</a></li>
<li><a href="../en505870/index.html">How to promote mobile games and applications in Japan, Korea and China</a></li>
<li><a href="../en505872/index.html">History of unmanned vehicles</a></li>
<li><a href="../en505880/index.html">How to write your index in Tarantool</a></li>
<li><a href="../en505888/index.html">Parsing YouTube, including uploaded data, without the YouTube API</a></li>
<li><a href="../en505896/index.html">Security Week 24: Zoom and Brave browser privacy</a></li>
<li><a href="../en505898/index.html">Claude Shannon: jack of all trades, joker and father of information theory</a></li>
<li><a href="../en505900/index.html">Personal addictions: full-sized 40 mm, without wire, for 72 hours for 8000 rubles</a></li>
<li><a href="../en505904/index.html">JUG Ru Group # 5 Online Stream Week</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>