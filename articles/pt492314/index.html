<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîó üëáüèº ü•ö Casa Inteligente: Crie Cartas de √Ågua e Eletricidade no Assistente Dom√©stico üë´ üë®üèª‚Äçüîß ü•î</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Toda vez que recebo uma fatura de eletricidade e √°gua, imagino - minha fam√≠lia est√° realmente consumindo tanto? Bem, sim, o banheiro tem piso aquecido...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Casa Inteligente: Crie Cartas de √Ågua e Eletricidade no Assistente Dom√©stico</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wj/lf/i3/wjlfi38qar57vvhqgpwuzdalerw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda vez que recebo uma fatura de eletricidade e √°gua, imagino - minha fam√≠lia est√° realmente consumindo tanto? Bem, sim, o banheiro tem piso aquecido e caldeira, mas eles n√£o se excitam constantemente. Tamb√©m parecemos economizar √°gua (embora tamb√©m gostemos de espirrar no banheiro). Alguns anos atr√°s, eu j√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conectei medidores de √°gua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eletricidade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a uma casa inteligente, mas isso estava preso a isso. As m√£os chegaram √† an√°lise do consumo apenas agora, sobre as quais, de fato, trata-se deste artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente, mudei para o Home Assistant como um sistema dom√©stico inteligente. Um dos motivos foi apenas a oportunidade de organizar a coleta de uma grande quantidade de dados com a possibilidade de construir convenientemente v√°rios tipos de gr√°ficos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As informa√ß√µes descritas neste artigo n√£o s√£o novas, todas essas coisas com molhos diferentes j√° foram descritas na Internet. </font><font style="vertical-align: inherit;">Mas cada artigo, como regra, descreve apenas uma abordagem ou aspecto. </font><font style="vertical-align: inherit;">Eu tive que comparar todas essas abordagens e escolher a mais adequada. </font><font style="vertical-align: inherit;">O artigo ainda n√£o fornece informa√ß√µes abrangentes sobre a coleta de dados, mas √© um tipo de sinopse de como eu fiz. </font><font style="vertical-align: inherit;">Portanto, cr√≠ticas construtivas e sugest√µes de melhoria s√£o bem-vindas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formula√ß√£o do problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o objetivo do exerc√≠cio de hoje √© obter belos gr√°ficos do consumo de √°gua e eletricidade:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hora em hora por 2 dias</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diariamente por 2 semanas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(opcional) semanal e mensalmente</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que algumas dificuldades nos esperam:</font></font><br>
<br>
<ul>
<li>  ,  ,  .         . <br>
<br>
  ,     ,     .  home assistant,  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">mini-graph-card</a>,     :<br>
<br>
<ul>
<li>        (     ,         )</li>
<li>       (   ,      )</li>
</ul></li>
<li> ,  home assistant        SQLite <s>( , ,    MySQL  Postgres)</s>,        . , ,               json   <br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"old_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"aafc8ca305ba4e49ad4c97f0eddd8893"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}, <span class="hljs-attr">"new_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"0de64b8af6f14bb9a419dcf3b200ef56"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}}</code></pre><br>
     (    ,    ),         .      SDM220      10-15 ,         8.      ,      . ..         100-200  .      ,      (    home assistant  raspberry PI),            .</li>
<li>  ,      .           <s> </s>   .           (RS232/RS485/Modbus/Zigbee)   .<br>
<br>
         (    ),      X -  .            .         ,        . , ,        home assistant,          ,             (  home assistant).</li>
</ul><br>
<h2> 1</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, vamos ver o que o assistente de casa √© fornecido imediatamente. Medir o consumo durante um per√≠odo √© uma funcionalidade altamente exigida. Obviamente, isso foi realizado h√° muito tempo na forma de um componente especializado - utility_meter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ess√™ncia do componente √© que dentro dele inicia a vari√°vel current_accumulated_value e a redefine ap√≥s um per√≠odo especificado (hora / semana / m√™s). O componente em si monitora a vari√°vel de entrada (o valor de algum tipo de sensor), assina as altera√ß√µes no pr√≥prio valor - voc√™ apenas obt√©m o resultado final. Essa coisa √© descrita em apenas algumas linhas no arquivo de configura√ß√£o.</font></font><br>
<br>
<pre><code class="python hljs">utility_meter:<font></font>
  water_cold_hour_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: hourly<font></font>
  water_cold_day_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: daily<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui sensor.water_meter_cold √© o valor atual do contador em litros, que eu recebo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diretamente do peda√ßo de ferro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por mqtt. O design cria 2 novos sensores water_cold_hour_um e water_cold_day_um, que acumulam leituras hor√°rias e di√°rias, restaurando-as ap√≥s um per√≠odo. Aqui est√° um gr√°fico de bateria de meia hora. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/u3/fk/leu3fkbgddojjis_lmcawt6gcv4.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo do gr√°fico hor√°rio e di√°rio da interface do usu√°rio lovelace √© semelhante a este:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, o problema dessa abordagem est√° nesse algoritmo. Como mencionei, para cada valor de entrada (a leitura atual do medidor para cada litro seguinte), 1kb de registro √© gerado no banco de dados. Cada medidor de utilidade tamb√©m gera um novo valor, que tamb√©m √© adicionado ao banco de dados. Se eu quiser coletar leituras hor√°rias / di√°rias / semanais / mensais, e para v√°rios bebedouros, e at√© adicionar um monte de medidores el√©tricos - ser√£o muitos dados. Bem, mais precisamente, n√£o h√° muitos dados, mas como o assistente de casa grava no banco de dados v√°rias informa√ß√µes desnecess√°rias, o tamanho do banco de dados aumenta aos trancos e barrancos. Receio at√© estimar o tamanho da base para gr√°ficos semanais e mensais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, o medidor de utilidade sozinho n√£o resolve a tarefa. </font><font style="vertical-align: inherit;">O gr√°fico de valores que o medidor de utilidade fornece √© uma fun√ß√£o monotonicamente crescente que redefine para 0 a cada hora. </font><font style="vertical-align: inherit;">Precisamos de um gr√°fico de consumo f√°cil de usar, quantos litros foram consumidos durante o per√≠odo. </font><font style="vertical-align: inherit;">O componente padr√£o do gr√°fico hist√≥rico n√£o sabe como fazer isso, mas o componente externo da placa gr√°fica mini pode nos ajudar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© o c√≥digo do cart√£o para a interface do usu√°rio lovelace:</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_hour_um<font></font>
        group_by: hour<font></font>
        hours_to_show: <span class="hljs-number">48</span>
        name: <span class="hljs-string">"Hourly water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">1</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m das configura√ß√µes padr√£o, como o nome do sensor, tipo de gr√°fico, cor (n√£o gostei da laranja padr√£o), √© importante observar tr√™s configura√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_by: hour - o gr√°fico ser√° gerado com as colunas alinhadas no in√≠cio da hora</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points_per_hour: 1 - uma barra a cada hora</font></font></li>
<li>  , aggregate_func: max ‚Äî       .         </li>
</ul><br>
<img src="https://habrastorage.org/webt/yj/du/c7/yjduc7nhxnq18qvcityd_ul91y0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o preste aten√ß√£o em v√°rias colunas √† esquerda - este √© o comportamento padr√£o de um componente se n√£o houver dados. E n√£o havia dados - apenas ativei a coleta de dados do medidor de utilidade apenas algumas horas atr√°s, apenas para fins deste artigo (em breve, mostrarei minha abordagem atual). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta imagem, eu queria mostrar que, √†s vezes, a exibi√ß√£o de dados funciona e as barras realmente refletem os valores corretos. Mas isso n√£o √© tudo. A coluna selecionada para o intervalo das 11 √†s 12 da manh√£, por algum motivo, exibe 19 litros, embora na tabela de dentes um pouco mais alta para o mesmo per√≠odo vejamos o consumo de 62 litros do mesmo sensor. Um inseto ou as m√£os est√£o tortas. Mas n√£o entendo por que os dados √† direita foram interrompidos - o consumo era normal, o que tamb√©m √© vis√≠vel no cronograma detalhado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, n√£o consegui alcan√ßar a credibilidade dessa abordagem - o gr√°fico quase sempre mostra algum tipo de heresia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo c√≥digo para o sensor diurno.</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_day_um<font></font>
        group_by: interval<font></font>
        hours_to_show: <span class="hljs-number">360</span>
        name: <span class="hljs-string">"Daily water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">0.0416666666</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que o par√¢metro group_by est√° definido como intervalo e o par√¢metro points_per_hour rege tudo. </font><font style="vertical-align: inherit;">E esse √© outro problema desse componente - points_per_hour funciona bem em gr√°ficos em uma hora ou menos, mas nojento a grandes intervalos. </font><font style="vertical-align: inherit;">Portanto, para obter uma coluna em um dia, tive que inserir o valor 1/24 = 0,04166666. </font><font style="vertical-align: inherit;">N√£o estou falando de gr√°ficos semanais e mensais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abordagem 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apenas descobrindo o assistente de casa, me deparei com este v√≠deo aqui:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-0HrYFCRH0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um amigo coleta dados de consumo de v√°rios tipos de tomadas Xiaomi. Sua tarefa √© um pouco mais f√°cil - basta exibir o valor do consumo para hoje, ontem e para o m√™s. Nenhuma programa√ß√£o √© necess√°ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos deixar de lado a discuss√£o sobre a integra√ß√£o manual de valores instant√¢neos de pot√™ncia - eu j√° escrevi sobre a "precis√£o" dessa abordagem. N√£o est√° claro por que ele n√£o usou os valores de consumo acumulado, que j√° s√£o coletados na mesma sa√≠da. Na minha opini√£o, a integra√ß√£o dentro do peda√ßo de ferro funcionar√° melhor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir do v√≠deo, tomamos a ideia de calcular manualmente o consumo para o per√≠odo. O campon√™s conta apenas os valores para hoje e ontem, mas iremos al√©m e tentaremos desenhar um gr√°fico. A ess√™ncia do m√©todo proposto no meu caso √© a seguinte.</font></font><br>
<br>
<ul>
<li>  ___,      </li>
<li>     (   )          .         ‚Äî    ,         . </li>
<li>  ‚Äú‚Äù  ___     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso pode ser feito </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> meio do pr√≥prio assistente de casa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ precisar√° escrever um pouco mais de c√≥digo do que na abordagem anterior. </font><font style="vertical-align: inherit;">Para come√ßar, vamos obter essas "vari√°veis". </font><font style="vertical-align: inherit;">Pronto, n√£o temos a entidade "vari√°vel", mas voc√™ pode usar os servi√ßos do broker mqtt. </font><font style="vertical-align: inherit;">Enviaremos valores com o sinalizador reter = true l√° - isso salvar√° o valor dentro do broker e voc√™ poder√° retir√°-lo a qualquer momento, mesmo quando o assistente de casa for reiniciado. </font><font style="vertical-align: inherit;">Criei contadores de horas e dias imediatamente.</font></font><br>
<br>
<pre><code class="python hljs">- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour"</span><font></font>
  name: water_hour<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
  name: water_hour_begin<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day"</span><font></font>
  name: water_day<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
  name: water_day_begin<font></font>
  unit_of_measurement: l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda m√°gica acontece na automa√ß√£o, que √© executada a cada hora e a cada noite, respectivamente.</font></font><br>
<br>
<pre><code class="python hljs">- id: water_new_hour<font></font>
  alias: water_new_hour<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time_pattern<font></font>
      minutes: <span class="hljs-number">0</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_hour_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true<font></font>
<font></font>
- id: water_new_day<font></font>
  alias: water_new_day<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time<font></font>
      at: <span class="hljs-string">"00:00:00"</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_day_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A automa√ß√£o realiza duas a√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O valor do intervalo √© calculado como a diferen√ßa entre o valor inicial e o final</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualizar valor base para o pr√≥ximo intervalo</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A representa√ß√£o gr√°fica neste caso √© resolvida pelo gr√°fico hist√≥rico usual:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/nn/ah/rpnnahsspezbcydtjmhlu6kb53w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
em princ√≠pio, isso j√° √© o que voc√™ precisa. </font><font style="vertical-align: inherit;">A vantagem desse m√©todo √© que os dados s√£o gerados uma vez por intervalo. </font><font style="vertical-align: inherit;">Essa. </font><font style="vertical-align: inherit;">apenas 24 entradas por dia para o gr√°fico hor√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, isso ainda n√£o resolve o problema geral de uma base crescente. </font><font style="vertical-align: inherit;">Se eu quiser uma programa√ß√£o de consumo mensal, terei que armazenar dados por pelo menos um ano. </font><font style="vertical-align: inherit;">E como o assistente dom√©stico fornece apenas uma configura√ß√£o para a dura√ß√£o do armazenamento de todo o banco de dados, isso significa que TODOS os dados no sistema ter√£o que ser armazenados por um ano inteiro. </font><font style="vertical-align: inherit;">Por exemplo, durante um ano eu consumo 200 metros c√∫bicos de √°gua, o que significa que s√£o 200.000 registros no banco de dados. </font><font style="vertical-align: inherit;">E se voc√™ levar em conta outros sensores, o n√∫mero se tornar√° indecente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abordagem 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, pessoas inteligentes j√° resolveram esse problema escrevendo o banco de dados do InfluxDB. Esse banco de dados √© especialmente otimizado para armazenar dados com base no tempo e √© ideal para armazenar valores de diferentes sensores. O sistema tamb√©m fornece uma linguagem de consulta semelhante ao SQL que permite selecionar valores do banco de dados e depois agreg√°-los de v√°rias maneiras. Finalmente, dados diferentes podem ser armazenados em momentos diferentes. Por exemplo, leituras que mudam frequentemente, como temperatura ou umidade, podem ser armazenadas por apenas algumas semanas, enquanto as leituras di√°rias do consumo de √°gua podem ser armazenadas por um ano inteiro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do InfluxDB, pessoas inteligentes tamb√©m inventaram o Grafana, um sistema de gr√°ficos baseado em dados do InfluxDB. </font><font style="vertical-align: inherit;">O Grafana pode desenhar diferentes tipos de gr√°ficos, personaliz√°-los em detalhes e, o mais importante, esses gr√°ficos podem ser "presos" no assistente dom√©stico da interface do usu√°rio da lovelace-UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inspire-se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Os artigos descrevem em detalhes o processo de instala√ß√£o e conex√£o do InfluxDB e Grafana no assistente de casa. </font><font style="vertical-align: inherit;">Vou me concentrar em resolver meu problema espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, primeiro de tudo, vamos come√ßar a somar o valor do contador no influxDB. </font><font style="vertical-align: inherit;">Uma parte da configura√ß√£o do assistente dom√©stico (neste exemplo, vou me divertir n√£o apenas com √°gua fria, mas tamb√©m com √°gua quente):</font></font><br>
<br>
<pre><code class="python hljs">influxdb:<font></font>
  host: localhost<font></font>
  max_retries: <span class="hljs-number">3</span><font></font>
  default_measurement: state<font></font>
  database: homeassistant<font></font>
  include:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desative o salvamento dos mesmos dados no banco de dados interno do assistente dom√©stico, para n√£o infl√°-lo novamente:</font></font><br>
<br>
<pre><code class="python hljs">recorder:<font></font>
  purge_keep_days: <span class="hljs-number">10</span>
  purge_interval: <span class="hljs-number">1</span><font></font>
  exclude:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos ao console do InfluxDB e configuramos nosso banco de dados. Em particular, voc√™ precisa configurar por quanto tempo esses dados ser√£o armazenados. Isso √© regulado pelo chamado pol√≠tica de reten√ß√£o - √© semelhante aos bancos de dados dentro do banco de dados principal, com cada banco de dados interno tendo suas pr√≥prias configura√ß√µes. Por padr√£o, todos os dados s√£o armazenados em uma pol√≠tica de reten√ß√£o chamada autogen, esses dados ser√£o armazenados por uma semana. Desejo que os dados hor√°rios sejam armazenados por um m√™s, a semanal por um ano e o mensal nunca deve ser exclu√≠do. Crie uma pol√≠tica de reten√ß√£o apropriada</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"month"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">30</span>d <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"year"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">52</span>w <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"infinite"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> INF <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, de fato, o principal truque √© a agrega√ß√£o de dados usando consulta cont√≠nua. </font><font style="vertical-align: inherit;">Este √© um mecanismo que inicia automaticamente uma consulta em intervalos especificados, agrega dados para essa consulta e adiciona o resultado a um novo valor. </font><font style="vertical-align: inherit;">Vejamos um exemplo (escrevo em uma coluna para facilitar a leitura, mas, na verdade, tive que inserir esse comando em uma linha)</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> CONTINUOUS <span class="hljs-keyword">QUERY</span> cq_water_hourly <span class="hljs-keyword">ON</span> homeassistant 
<span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span> 
  <span class="hljs-keyword">INTO</span> homeassistant.month.water_meter_hour 
  <span class="hljs-keyword">FROM</span> homeassistant.autogen.l 
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id fill(previous) 
<span class="hljs-keyword">END</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este comando:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cria uma consulta cont√≠nua denominada cq_water_cold_hourly no banco de dados do homeassistant</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A solicita√ß√£o ser√° executada a cada hora (hora (1h))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A solicita√ß√£o recuperar√° todos os dados da medi√ß√£o - um homeassistant.autogen.l (litros), incluindo as leituras de √°gua fria e quente</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os dados agregados ser√£o agrupados por entity_id, que criar√° valores separados para √°gua fria e quente.</font></font></li>
<li>               ,      max(value) </li>
<li>     homeassistant.month.water_meter_hour,  month   retention policy     .               entity_id     value</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä noite ou quando ningu√©m est√° em casa, n√£o h√° consumo de √°gua e, portanto, tamb√©m n√£o h√° novas entradas no homeassistant.autogen.l. Para evitar valores ausentes em consultas regulares, voc√™ pode usar o preenchimento (anterior). Isso for√ßar√° o InfluxDB a usar o valor da √∫ltima hora. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, a consulta cont√≠nua tem uma peculiaridade: o truque de preenchimento (anterior) n√£o funciona e os registros simplesmente n√£o s√£o criados. Al√©m disso, esse √© um problema intranspon√≠vel que tem sido </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discutido h√° mais de um ano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Lidamos com esse problema mais tarde, e vamos preencher (anterior) na consulta cont√≠nua - isso n√£o interfere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos verificar o que aconteceu (√© claro, voc√™ precisa esperar algumas horas):</font></font><br>
<br>
<pre><code class="python hljs">&gt; select * <span class="hljs-keyword">from</span> homeassistant.month.water_meter_hour group by entity_id<font></font>
...<font></font>
name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 value<font></font>
----                 -----<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370511</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370513</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370527</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370605</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370635</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370699</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370761</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370767</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370810</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370818</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370827</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370849</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370921</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que os valores no banco de dados s√£o armazenados no UTC; portanto, nesta lista, eles diferem em 3 horas - os valores de 7 horas na sa√≠da do InfluxDB correspondem aos valores de 10 horas nos gr√°ficos acima. </font><font style="vertical-align: inherit;">Observe tamb√©m que entre 2 e 5 da manh√£ simplesmente n√£o h√° registros - esse √© o mesmo recurso da consulta cont√≠nua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, o valor agregado tamb√©m √© uma sequ√™ncia monotonamente crescente, apenas os registros s√£o menos frequentes - uma vez por hora. </font><font style="vertical-align: inherit;">Mas isso n√£o √© um problema - podemos escrever outra consulta que produzir√° os dados corretos para o gr√°fico.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">difference</span>(<span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>)) 
<span class="hljs-keyword">FROM</span> homeassistant.month.water_meter_hour 
<span class="hljs-keyword">WHERE</span> entity_id=<span class="hljs-string">'water_meter_cold'</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-keyword">now</span>() <span class="hljs-number">-24</span>h 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id <font></font>
fill(previous)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou descriptografar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No banco de dados homeassistant.month.water_meter_hour, extra√≠mos os dados para entity_id = 'water_meter_cold' do √∫ltimo dia (hora&gt; = now () -24h). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mencionei na sequ√™ncia homeassistant.month.water_meter_hour, algumas entradas podem estar ausentes. </font><font style="vertical-align: inherit;">Regeneraremos esses dados executando uma consulta com o tempo GROUP BY (1h). </font><font style="vertical-align: inherit;">Esse preenchimento de tempo (anterior) funcionar√° conforme necess√°rio, gerando os dados ausentes (a fun√ß√£o assumir√° o valor anterior)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mais importante nesta solicita√ß√£o √© a fun√ß√£o de diferen√ßa, que calcular√° a diferen√ßa entre as marcas hor√°rias. </font><font style="vertical-align: inherit;">Por si s√≥, ele n√£o funciona e requer uma fun√ß√£o agregada. </font><font style="vertical-align: inherit;">Que seja o max () usado antes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado da execu√ß√£o √© semelhante a este</font></font><br>
<br>
<pre><code class="python hljs">name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 difference<font></font>
----                 ----------<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">2</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T03:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T04:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">14</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">78</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">30</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">64</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">62</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">6</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">43</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">8</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">9</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">22</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">72</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das 2 √†s 5 da manh√£ (UTC) n√£o houve consumo. </font><font style="vertical-align: inherit;">No entanto, a consulta retornar√° o mesmo valor de consumo devido ao preenchimento (anterior), e a fun√ß√£o de diferen√ßa subtrair√° esse valor de si e obteremos 0 na sa√≠da, o que √© realmente necess√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫nica coisa que resta √© criar um cronograma. </font><font style="vertical-align: inherit;">Para isso, abra o Grafana, abra um painel existente (ou crie um novo), crie um novo painel. </font><font style="vertical-align: inherit;">As configura√ß√µes do gr√°fico ser√£o assim. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/q0/c8/uxq0c834j1eq4h7ey4qazk4cc7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou exibir dados sobre √°gua fria e quente em um gr√°fico. </font><font style="vertical-align: inherit;">A solicita√ß√£o √© exatamente a mesma que eu descrevi acima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os par√¢metros de exibi√ß√£o s√£o definidos da seguinte maneira. </font><font style="vertical-align: inherit;">Vou ter um gr√°fico com linhas, que passa por escadas. </font><font style="vertical-align: inherit;">Vou explicar o par√¢metro Stack logo abaixo. </font><font style="vertical-align: inherit;">Existem mais algumas op√ß√µes de exibi√ß√£o abaixo, mas elas n√£o s√£o t√£o interessantes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/rd/5x/bird5xpaysckqtigczjerbp5mti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para adicionar a programa√ß√£o recebida ao assistente de casa, voc√™ precisa:</font></font><br>
<br>
<ul>
<li>    . -         </li>
<li>     ,    share</li>
<li>      embed</li>
<li>  current time range ‚Äî       URL </li>
<li>  .     light</li>
<li>  URL    lovelace-UI</li>
</ul><br>
<pre><code class="python hljs">      - type: iframe<font></font>
        id: graf_water_hourly<font></font>
        url: <span class="hljs-string">"http://192.168.10.200:3000/d-solo/rZARemQWk/water?orgId=1&amp;panelId=2&amp;from=now-2d&amp;to=now&amp;theme=light"</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que o per√≠odo (√∫ltimos 2 dias) est√° definido aqui, e n√£o nas configura√ß√µes do painel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gr√°fico fica assim. Como n√£o usei √°gua quente nos √∫ltimos 2 dias, apenas um gr√°fico de √°gua fria √© desenhado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/e7/hk/mse7hkckiwjjm_b5ppli9dakd2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o decidi por mim mesma qual programa√ß√£o eu mais gosto, uma linha de etapa ou barras reais. Portanto, simplesmente darei um exemplo de um gr√°fico de consumo di√°rio, somente desta vez em colunas. As solicita√ß√µes s√£o criadas da mesma maneira descrita acima. Os par√¢metros de exibi√ß√£o s√£o os seguintes: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/se/jt/nssejtoburugxcldedjuj0cvywm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este gr√°fico se parece com o seguinte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zd/yl/hj/zdylhjfnrdonlnkezr3n4dlwdwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, sobre o par√¢metro Stack. Neste gr√°fico, uma coluna de √°gua fria √© desenhada no topo de uma coluna de √°gua quente. A altura total corresponde ao consumo total de √°gua fria e quente do per√≠odo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os gr√°ficos mostrados s√£o din√¢micos. Voc√™ pode passar o mouse sobre um ponto de interesse e ver os detalhes e o valor em um ponto espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, algumas colheres de alcatr√£o n√£o conseguiram. No gr√°fico de barras (em contraste com o gr√°fico com linhas de etapa), o meio da barra n√£o est√° no meio do dia, mas √†s 00:00. Essa. a metade esquerda da coluna √© desenhada no lugar do dia anterior. Portanto, os gr√°ficos para s√°bado e domingo s√£o desenhados um pouco para a esquerda do que a zona azulada. At√© eu descobrir como venc√™-lo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro problema √© a incapacidade de funcionar corretamente em intervalos mensais. </font><font style="vertical-align: inherit;">O fato √© que a dura√ß√£o da hora / dia / semana √© fixa, mas a dura√ß√£o do m√™s √© diferente a cada vez. </font><font style="vertical-align: inherit;">O InfluxDB pode funcionar apenas em intervalos regulares. </font><font style="vertical-align: inherit;">At√© agora, meu c√©rebro era suficiente para definir um intervalo fixo de 30 dias. </font><font style="vertical-align: inherit;">Sim, o gr√°fico flutuar√° um pouco durante o ano e as colunas n√£o corresponder√£o exatamente aos meses. </font><font style="vertical-align: inherit;">Mas como isso √© interessante para mim simplesmente como um dispositivo de exibi√ß√£o, ent√£o eu estou bem com isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejo pelo menos duas solu√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pontua√ß√£o nos hor√°rios mensais e limite para semanal. </font><font style="vertical-align: inherit;">52 bares semanais para o ano parecem muito bons</font></font></li>
<li>     ‚Ññ2,       .     .          ‚Äî    .</li>
</ul><br>
<br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o sei por que, mas estou trabalhando em esse tipo de gr√°fico. Eles mostram que a vida est√° em pleno andamento e tudo est√° mudando. Ontem foi muito, hoje n√£o √© suficiente, amanh√£ ser√° outra coisa. Resta trabalhar com as fam√≠lias sobre o tema do consumo. Mas mesmo com o apetite atual, apenas um n√∫mero grande e incompreens√≠vel no pagamento j√° est√° se transformando em uma imagem bastante clara do consumo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar dos quase 20 anos de carreira como programador, eu praticamente n√£o interceptei os bancos de dados. Portanto, a instala√ß√£o de um banco de dados externo parecia algo t√£o obscuro e incompreens√≠vel. Tudo foi alterado pelo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo mencionado acima</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - resultou que o erro de uma ferramenta adequada √© feito em alguns cliques e, com uma ferramenta especializada, a tarefa de criar gr√°ficos torna-se um pouco mais f√°cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na manchete, mencionei o consumo de eletricidade. </font><font style="vertical-align: inherit;">Infelizmente, no momento n√£o posso dar um √∫nico gr√°fico. </font><font style="vertical-align: inherit;">Um contador SDM120 est√° morto e o outro com erros ao acessar via Modbus. </font><font style="vertical-align: inherit;">No entanto, isso n√£o afeta o t√≥pico deste artigo - os gr√°ficos ser√£o constru√≠dos da mesma maneira que para a √°gua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, citei as abordagens que eu mesmo tentei. </font><font style="vertical-align: inherit;">Certamente, existem outras maneiras de organizar a coleta e a visualiza√ß√£o de dados que eu n√£o conhe√ßo. </font><font style="vertical-align: inherit;">Conte-me sobre isso nos coment√°rios, ser√° muito interessante para mim. </font><font style="vertical-align: inherit;">Ficarei feliz em receber cr√≠ticas construtivas e novas id√©ias. </font><font style="vertical-align: inherit;">Espero que o material apresentado tamb√©m ajude algu√©m.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492298/index.html">Pol√≠gonos em outro mundo: IBM PC</a></li>
<li><a href="../pt492302/index.html">Suporte inteligente com smartphones para testadores - um projeto de inicializa√ß√£o do acelerador da Universidade ITMO</a></li>
<li><a href="../pt492306/index.html">Lidars na CES</a></li>
<li><a href="../pt492308/index.html">Neur√¥nios e sua modelagem</a></li>
<li><a href="../pt492312/index.html">Serializa√ß√£o Avro em Kafka</a></li>
<li><a href="../pt492318/index.html">Como o coronav√≠rus afeta o setor de TI</a></li>
<li><a href="../pt492320/index.html">Covid-19, sua sociedade e voc√™ em termos de ci√™ncia de dados</a></li>
<li><a href="../pt492322/index.html">Raspberry Pi + Fedora (aarch64) = Ponto de acesso Wi-Fi (ou um roteador de framboesa com um chap√©u azul)</a></li>
<li><a href="../pt492326/index.html">An√°lise da popularidade dos v√≠deos do YouTube dos participantes do Eurovision 2020</a></li>
<li><a href="../pt492328/index.html">Integra√ß√£o e implanta√ß√£o cont√≠nuas de aplicativos da √°rea de trabalho com as a√ß√µes do GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>