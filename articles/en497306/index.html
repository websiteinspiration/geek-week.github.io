<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêé ‚öíÔ∏è üç∞ DLL spoofing (DLL hijacking) üëÜüèΩ üï∫üèø üôáüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. Right now, OTUS has opened a set for the April launch of the updated reverse engineering course . In anticipation of the start of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DLL spoofing (DLL hijacking)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/497306/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">Right now, OTUS has opened a set for the April launch of the updated </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reverse engineering</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In anticipation of the start of the course, we traditionally prepared a translation of interesting material.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/hb/vt/zh/hbvtzhxt8n3pklbvenpcr72xxdq.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the Windows operating system, applications and services at startup look for the DLLs necessary for their proper functioning. </font><font style="vertical-align: inherit;">If these DLLs are not found or their loading is implemented in an unsafe way (DLLs are called without using the full path), then you can increase privileges by forcing the application to download and execute a malicious DLL file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be noted that when the application needs to download the DLL, then its search is carried out in the following order:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The directory from which the application is downloaded</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows \ System32</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows \ System</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current working directory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Directories in the user PATH environment variable</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Directories in the PATH system environment variable</font></font></li>
</ul><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 1 - Processes with Missing DLLs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step is to find processes that run on SYSTEM and try to load the missing DLL. </font><font style="vertical-align: inherit;">This can be done using </font><font style="vertical-align: inherit;">Sysinternals </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by applying the filter listed below: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8c/2l/i-/8c2li-1qfj3csw3bfytkej1bzri.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procmon Filters to Search for Processes that Download Missing DLLs </font></font></i><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will identify the missing DLLs that the application is trying to load and show the actual path that this DLL is being searched for. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bk/gl/0_/bkgl0_q1eomsgzemfqprbkcfqfg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A process with a missing DLL</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this example, a process does </font></font><code>Bginfo.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not have several .dll files that can be used to elevate privileges.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 2 - Folder Permissions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the software is installed in the directory </font></font><code>C:\</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead </font></font><code>C:\Program Files</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then by default authenticated users will have write access to this directory. </font><font style="vertical-align: inherit;">In addition, software such as Perl, Python, Ruby, etc. is usually added to the PATH variable. </font><font style="vertical-align: inherit;">This makes it possible to increase privileges, since the user can write a malicious DLL to this directory, which will be loaded the next time the process starts and gain the rights to this process. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8x/am/4k/8xam4k5sv5rcxouitfhoerzqjni.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weak folder permissions</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 3 - Substitute DLL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using Metasploit, you can generate a payload DLL in the form of a session with service privileges. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s3/kk/ap/s3kkapxllhprqdd9mk8fveeywgi.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malicious DLL Generation</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The process is </font></font><code>Bginfo.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">launched under SYSTEM, therefore after restarting the malicious DLL will have the same privileges, since the DLL is loaded and executed by this process. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wq/w7/xz/wqw7xz-pd3l_8r8axlnbt_yitss.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The process is launched under SYSTEM.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As mentioned above, the process cannot be found </font></font><code>Riched32.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so </font></font><code>pentestlab.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you must rename it to </font></font><code>Riched32.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This will confuse the application and it will try to load the DLL because it thinks it is a legitimate DLL. The malicious DLL must be placed in one of the folders in which Windows is looking for DLL files. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/la/ms/snlamsjl0ixkfbzvibb8i3tpcsy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malicious DLL renamed and hosted</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see below, when you restart the service by using the spoofing DLL, a Meterpreter session with SYSTEM privileges opens. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/j_/r9/baj_r9sstyxrajtkimosaxgvwgo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metasploit - Escalation of privileges through spoofing DLL</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Powersploit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The process of replacing DLLs can be done through PowerSploit, in which there are three modules that will help in finding services with missing DLLs, in finding folders with modification rights and in generating DLLs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The module </font></font><code>Find-ProcessDLLHijack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will find all the processes in the system that are trying to load the missing DLL. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gy/hg/dv/gyhgdveyv97iumk-g5h7jgif6w8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerSploit - Detecting Processes with Missing DLLs</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The next step is to identify the folders where the user can modify the contents. </font><font style="vertical-align: inherit;">Folders will be found where malicious DLLs should be thrown. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/ui/3h/j7ui3hwcu2v-syisqovozbz9z4g.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finding folders with rights to modify</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The last step is to create a malicious DLL in one of the folders with Modify (M) permissions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1a/il/s9/1ails9hsqecemlskuuuefzov8ak.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a DLL in a folder with weak permissions</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be able to elevate privileges through a spoofing DLL, the following conditions must be met:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permissions to write to the system folder</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installing software in a directory other than the default directory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A service that runs under SYSTEM and tries to load a missing DLL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service restart</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finding applications that are not installed in </font></font><code>Program Files</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is not difficult, because apart from third-party applications that are not forced to install along this path, there are various custom software programs located outside these protected folders. </font><font style="vertical-align: inherit;">In addition, there are a number of Windows services, such as IKEEXT (IKE and AuthIP IPsec Keying Modules) with missing DLLs ( </font></font><code>wlbsctrl.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which can be used either manually or automatically. </font><font style="vertical-align: inherit;">There is a special Metasploit module for IKEEXT:</font></font><br>
<br>
<pre><code class="plaintext hljs">exploit/windows/local/ikeext_service</code></pre><br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   .</a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497290/index.html">Improving performance using uop cache on Sandy Bridge +</a></li>
<li><a href="../en497292/index.html">Technology Stack Shiro Games</a></li>
<li><a href="../en497296/index.html">Popular errors in English among IT professionals. Part 2: Pronunciation</a></li>
<li><a href="../en497302/index.html">Autonomous navigation of a mobile robot</a></li>
<li><a href="../en497304/index.html">Intercepter-NG 2.5 released for Android</a></li>
<li><a href="../en497308/index.html">Can artificial intelligence do art?</a></li>
<li><a href="../en497310/index.html">Bipolar morphological networks: a neuron without multiplication</a></li>
<li><a href="../en497312/index.html">Question about CAN FD</a></li>
<li><a href="../en497314/index.html">How deep the Challenger Abyss is: measuring depth</a></li>
<li><a href="../en497316/index.html">Own server or public cloud?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>