<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëô üëÉüèø üò∫ Apache Kafka para Dummies üë®üèº‚Äçüîß ‚öñÔ∏è üéê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo ser√° √∫til para aquellos que acaban de comenzar a familiarizarse con la arquitectura de microservicios y con el servicio Apache Kafka. El...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apache Kafka para Dummies</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este art√≠culo ser√° √∫til para aquellos que acaban de comenzar a familiarizarse con la arquitectura de microservicios y con el servicio Apache Kafka. </font><font style="vertical-align: inherit;">El material no pretende ser un tutorial detallado, pero lo ayudar√° a comenzar r√°pidamente con esta tecnolog√≠a. </font><font style="vertical-align: inherit;">Hablar√© sobre c√≥mo instalar y configurar Kafka en Windows 10. Tambi√©n crearemos un proyecto usando Intellij IDEA y Spring Boot.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPara qu√©?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las dificultades para comprender varias herramientas a menudo se asocian con el hecho de que el desarrollador nunca ha encontrado situaciones en las que estas herramientas puedan ser necesarias. Con Kafka, esto es exactamente lo mismo. Describimos la situaci√≥n en la que esta tecnolog√≠a ser√° √∫til. Si tiene una arquitectura de aplicaci√≥n monol√≠tica, entonces, por supuesto, no necesita Kafka. Todo cambia con la transici√≥n a microservicios. De hecho, cada microservicio es un programa separado que realiza una u otra funci√≥n, y que se puede iniciar independientemente de otros microservicios. Los microservicios se pueden comparar con los empleados de la oficina, que se sientan en escritorios separados y resuelven su problema de forma independiente. El trabajo de un equipo tan distribuido es impensable sin una coordinaci√≥n central.Los empleados deben poder intercambiar mensajes y resultados de su trabajo entre ellos. Apache Kafka para microservicios est√° dise√±ado para resolver este problema.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka es un agente de mensajes. Con √©l, los microservicios pueden interactuar entre s√≠, enviando y recibiendo informaci√≥n importante. Surge la pregunta, ¬øpor qu√© no utilizar la POST - solicitud regular para estos fines, en cuyo cuerpo puede transferir los datos necesarios y obtener la respuesta de la misma manera? Este enfoque tiene una serie de desventajas obvias. Por ejemplo, un productor (un servicio que env√≠a un mensaje) puede enviar datos solo en forma de respuesta en respuesta a una solicitud de un consumidor (un servicio que recibe datos). Supongamos que un consumidor env√≠a una solicitud POST y el productor la responde. En este momento, por alguna raz√≥n, el consumidor no puede aceptar la respuesta. ¬øQu√© pasar√° con los datos? Estar√°n perdidos. El consumidor nuevamente tendr√° que enviar una solicitud y esperar que los datos que desea recibir no hayan cambiado durante este tiempo,y el productor todav√≠a est√° listo para aceptar la solicitud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka resuelve este y muchos otros problemas que surgen al intercambiar mensajes entre microservicios. </font><font style="vertical-align: inherit;">No ser√° un error recordar que el intercambio de datos conveniente e ininterrumpido es uno de los problemas clave que deben resolverse para garantizar el funcionamiento estable de la arquitectura de microservicios.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalar y configurar ZooKeeper y Apache Kafka en Windows 10</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que debe saber para comenzar es que Apache Kafka se ejecuta sobre el servicio ZooKeeper. ZooKeeper es un servicio distribuido de configuraci√≥n y sincronizaci√≥n, y eso es todo lo que necesitamos saber al respecto en este contexto. Debemos descargarlo, configurarlo y ejecutarlo antes de comenzar con Kafka. Antes de comenzar a trabajar con ZooKeeper, aseg√∫rese de tener JRE instalado y configurado. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede descargar la √∫ltima versi√≥n de ZooKeeper desde el sitio web oficial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Extraemos los archivos del archivo ZooKeeper descargado a una carpeta en el disco. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la carpeta zookeeper con el n√∫mero de versi√≥n, encontramos la carpeta conf y en ella el archivo "zoo_sample.cfg".</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥pielo y cambie el nombre de la copia a "zoo.cfg". Abra el archivo de copia y busque la l√≠nea dataDir = / tmp / zookeeper en √©l. En esta l√≠nea escribimos la ruta completa a nuestra carpeta zookeeper-x.x.x. A m√≠ me parece esto: dataDir = C: \\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora agregamos la variable de entorno del sistema: ZOOKEEPER_HOME = C: \ ZooKeeper \ zookeeper-3.4.9 y al final de la variable de sistema Path, agregue la entrada:;% ZOOKEEPER_HOME % \ bin; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la l√≠nea de comando y escriba el comando:</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Si todo se hace correctamente, ver√° algo como lo siguiente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto significa que ZooKeeper comenz√≥ normalmente. Procedemos directamente a la instalaci√≥n y configuraci√≥n del servidor Apache Kafka. Descargue la √∫ltima versi√≥n del sitio oficial y extraiga el contenido del archivo: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kafka.apache.org/downloads</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En la carpeta con Kafka encontramos la carpeta de configuraci√≥n, en ella encontramos el archivo server.properties y lo abrimos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontramos la l√≠nea log.dirs = / tmp / kafka-logs e indicamos en ella la ruta donde Kafka guardar√° los registros: log.dirs = c: / kafka / kafka-logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la misma carpeta, edite el archivo zookeeper.properties. Cambiamos la l√≠nea dataDir = / tmp / zookeeper a dataDir = c: / kafka / zookeeper-data, sin olvidar indicar la ruta a su carpeta Kafka despu√©s del nombre del disco. Si hiciste todo bien, puedes ejecutar ZooKeeper y Kafka.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para algunos, puede ser una sorpresa desagradable que no haya GUI para controlar Kafka. </font><font style="vertical-align: inherit;">Quiz√°s esto se deba a que el servicio est√° dise√±ado para nerds duros que trabajan exclusivamente con la consola. </font><font style="vertical-align: inherit;">De una forma u otra, para ejecutar Kafka necesitamos una l√≠nea de comando. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero necesitas iniciar ZooKeeper. </font><font style="vertical-align: inherit;">En la carpeta con el kafka encontramos la carpeta bin / windows, en ella encontramos el archivo para iniciar el servicio zookeeper-server-start.bat, haga clic en √©l. </font><font style="vertical-align: inherit;">¬øNo pasa nada? </font><font style="vertical-align: inherit;">Deber√≠a ser as√≠. </font><font style="vertical-align: inherit;">Abra la consola en esta carpeta y escriba:</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ¬øNo funciona de nuevo? </font><font style="vertical-align: inherit;">Esta es la norma </font><font style="vertical-align: inherit;">Esto se debe a que zookeeper-server-start.bat requiere los par√°metros especificados en el archivo zookeeper.properties, que, como recordamos, se encuentra en la carpeta de configuraci√≥n para su trabajo. </font><font style="vertical-align: inherit;">Escribimos a la consola:</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora todo deber√≠a comenzar normalmente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez m√°s, abra la consola en esta carpeta (¬°no cierre ZooKeeper!) Y ejecute kafka:</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para no escribir comandos cada vez en la l√≠nea de comandos, puede usar el m√©todo probado anterior y crear un archivo por lotes con el siguiente contenido:</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La l√≠nea de tiempo de espera 10 es necesaria para establecer una pausa entre el cuidador del zool√≥gico y el kafka. </font><font style="vertical-align: inherit;">Si hizo todo bien, al hacer clic en el archivo por lotes, se abrir√°n dos consolas con zookeeper y kafka en ejecuci√≥n. Ahora podemos crear un productor y un consumidor de mensajes con los par√°metros necesarios directamente desde la l√≠nea de comandos. </font><font style="vertical-align: inherit;">Pero, en la pr√°ctica, puede ser necesario a menos que se pruebe el servicio. </font><font style="vertical-align: inherit;">Estaremos mucho m√°s interesados ‚Äã‚Äãen c√≥mo trabajar con kafka de IDEA.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabaja con kafka de IDEA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribiremos la aplicaci√≥n m√°s simple posible, que simult√°neamente ser√° el productor y el consumidor del mensaje, y luego le agregaremos funciones √∫tiles. </font><font style="vertical-align: inherit;">Crea un nuevo proyecto de primavera. </font><font style="vertical-align: inherit;">Esto se hace m√°s convenientemente usando un inicializador de resorte. </font><font style="vertical-align: inherit;">Agregue las dependencias org.springframework.kafka y spring-boot-starter-web </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el archivo pom.xml deber√≠a tener este aspecto: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para enviar mensajes, necesitamos el objeto KafkaTemplate &lt;K, V&gt;. </font><font style="vertical-align: inherit;">Como vemos, el objeto est√° escrito. </font><font style="vertical-align: inherit;">El primer par√°metro es el tipo de clave, el segundo es el mensaje en s√≠. </font><font style="vertical-align: inherit;">Por ahora, indicaremos ambos par√°metros como String. </font><font style="vertical-align: inherit;">Crearemos el objeto en el controlador de clase. </font><font style="vertical-align: inherit;">Declare KafkaTemplate y p√≠dale a Spring que lo inicialice anotando</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autowired</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principio, nuestro productor est√° listo. Todo lo que queda por hacer es llamar al m√©todo send () en √©l. Hay varias versiones sobrecargadas de este m√©todo. Usamos en nuestro proyecto una opci√≥n con 3 par√°metros: enviar (tema de cadena, clave K, datos V). Como KafkaTemplate est√° escrito por String, la clave y los datos en el m√©todo de env√≠o ser√°n una cadena. El primer par√°metro indica el tema, es decir, el tema al que se enviar√°n los mensajes y a los que los consumidores pueden suscribirse para recibirlos. Si el tema especificado en el m√©todo de env√≠o no existe, se crear√° autom√°ticamente. El texto completo de la clase se ve as√≠.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador se asigna a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / msg, la clave y el mensaje en s√≠ se transmiten en el cuerpo de la solicitud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El remitente del mensaje est√° listo, ahora cree un oyente. </font><font style="vertical-align: inherit;">Spring tambi√©n te permite hacer esto sin mucho esfuerzo. </font><font style="vertical-align: inherit;">Es suficiente crear un m√©todo y marcarlo con la anotaci√≥n @KafkaListener, en cuyos par√°metros puede especificar solo el tema que se escuchar√°. </font><font style="vertical-align: inherit;">En nuestro caso, se ve as√≠.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El m√©todo en s√≠, marcado con anotaciones, puede especificar un par√°metro aceptado, que tiene el tipo de mensaje transmitido por el productor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clase en la que se crear√° el consumidor debe estar marcada con la anotaci√≥n @EnableKafka.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, en el archivo de configuraci√≥n de application.property, debe especificar el par√°metro de concierge groupe-id. </font><font style="vertical-align: inherit;">Si esto no se hace, la aplicaci√≥n no se iniciar√°. </font><font style="vertical-align: inherit;">El par√°metro es de tipo String y puede ser cualquier cosa.</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro proyecto kafka m√°s simple est√° listo. </font><font style="vertical-align: inherit;">Tenemos un remitente y un destinatario de mensajes. </font><font style="vertical-align: inherit;">Solo queda correr. </font><font style="vertical-align: inherit;">Primero, inicie ZooKeeper y Kafka utilizando el archivo por lotes que escribimos anteriormente, luego inicie nuestra aplicaci√≥n. </font><font style="vertical-align: inherit;">Es m√°s conveniente enviar una solicitud utilizando Postman. </font><font style="vertical-align: inherit;">En el cuerpo de la solicitud, no olvide especificar los par√°metros msgId y msg. </font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vemos esa imagen en IDEA, entonces todo funciona: el productor envi√≥ un mensaje, el consumidor lo recibi√≥ y lo mostr√≥ en la consola.</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complicamos el proyecto</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los proyectos reales que usan Kafka son ciertamente m√°s complicados que el que creamos. Ahora que hemos descubierto las funciones b√°sicas del servicio, considere qu√© caracter√≠sticas adicionales proporciona. Para empezar, mejoraremos al productor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si abri√≥ el m√©todo send (), puede notar que todas sus variantes tienen un valor de retorno de ListenableFuture &lt;SendResult &lt;K, V &gt;&gt;. Ahora no consideraremos en detalle las capacidades de esta interfaz. Aqu√≠ bastar√° decir que es necesario ver el resultado del env√≠o de un mensaje.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El m√©todo addCallback () acepta dos par√°metros: SuccessCallback y FailureCallback. </font><font style="vertical-align: inherit;">Ambos son interfaces funcionales. </font><font style="vertical-align: inherit;">Por el nombre puede comprender que el m√©todo del primero se llamar√° como resultado del env√≠o exitoso del mensaje, el segundo, como resultado de un error. Ahora, si ejecutamos el proyecto, veremos algo como lo siguiente en la consola:</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Miremos cuidadosamente a nuestro productor nuevamente. </font><font style="vertical-align: inherit;">Curiosamente, ¬øqu√© sucede si la clave no es String, sino, digamos, Long, pero como mensaje transmitido, peor a√∫n, alg√∫n tipo de DTO complicado? </font><font style="vertical-align: inherit;">Primero, intentemos cambiar la clave a un valor num√©rico ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si especificamos Long como la clave en el productor, la aplicaci√≥n se iniciar√° normalmente, pero cuando intente enviar un mensaje, se lanzar√° una ClassCastException y se informar√° que la clase Long no se puede convertir a la clase String.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si intentamos crear manualmente el objeto KafkaTemplate, veremos que el objeto de interfaz ProducerFactory &lt;K, V&gt;, por ejemplo, DefaultKafkaProducerFactory &lt;&gt;, se pasa al constructor como un par√°metro. Para crear un DefaultKafkaProducerFactory, necesitamos pasar un Mapa que contenga su configuraci√≥n de productor a su constructor. Todo el c√≥digo para la configuraci√≥n y creaci√≥n del productor se colocar√° en una clase separada. Para hacer esto, cree el paquete de configuraci√≥n y en √©l la clase KafkaProducerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el m√©todo productorConfigs (), cree un mapa con las configuraciones y especifique LongSerializer.class como el serializador para la clave. </font><font style="vertical-align: inherit;">Comenzamos, enviamos una solicitud de Postman y vemos que ahora todo funciona como deber√≠a: el productor env√≠a un mensaje y el consumidor lo recibe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora cambiemos el tipo del valor transmitido. </font><font style="vertical-align: inherit;">¬øQu√© pasa si no tenemos una clase est√°ndar de la biblioteca de Java, sino alg√∫n tipo de DTO personalizado? </font><font style="vertical-align: inherit;">Digamos esto</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para enviar DTO como mensaje, debe realizar algunos cambios en la configuraci√≥n del productor. </font><font style="vertical-align: inherit;">Especifique JsonSerializer.class como el serializador del valor del mensaje y no olvide cambiar el tipo de Cadena a UserDto en todas partes.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enviar un mensaje. La siguiente l√≠nea se mostrar√° en la consola: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora vamos a complicar al consumidor. Antes de esto, nuestro m√©todo public void msgListener (String msg), marcado con la anotaci√≥n @KafkaListener (topics = "msg") tom√≥ String como par√°metro y lo mostr√≥ en la consola. ¬øQu√© sucede si queremos obtener otros par√°metros del mensaje transmitido, por ejemplo, una clave o una partici√≥n? En este caso, se debe cambiar el tipo del valor transmitido.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde el objeto ConsumerRecord podemos obtener todos los par√°metros que nos interesan. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que en lugar de la clave en la consola, se muestra alg√∫n tipo de krakozyabry. Esto se debe a que StringDeserializer se usa de forma predeterminada para deserializar la clave, y si queremos que la clave en el formato entero se muestre correctamente, debemos cambiarla a LongDeserializer. Para configurar el consumidor en el paquete de configuraci√≥n, cree la clase KafkaConsumerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clase KafkaConsumerConfig es muy similar a la KafkaProducerConfig que creamos anteriormente. Tambi√©n hay un mapa que contiene las configuraciones necesarias, por ejemplo, como un deserializador para la clave y el valor. El mapa creado se usa para crear ConsumerFactory &lt;&gt;, que, a su vez, es necesario para crear KafkaListenerContainerFactory &lt;?&gt;. Un detalle importante: el m√©todo que devuelve KafkaListenerContainerFactory &lt;?&gt; Deber√≠a llamarse kafkaListenerContainerFactory (), de lo contrario Spring no podr√° encontrar el bean deseado y el proyecto no se compilar√°. Empezamos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que ahora la clave se muestra como deber√≠a, lo que significa que todo funciona. </font><font style="vertical-align: inherit;">Por supuesto, las capacidades de Apache Kafka van mucho m√°s all√° de las descritas en este art√≠culo, sin embargo, espero que despu√©s de leerlo tenga una idea sobre este servicio y, lo m√°s importante, pueda comenzar a trabajar con √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L√°vese las manos con m√°s frecuencia, use m√°scaras, no salga sin necesidad y sea saludable.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496170/index.html">Estamos condenados # 1 // Udalenka en crisis y muerte de originalidad</a></li>
<li><a href="../es496174/index.html">Aumento de la demanda de an√°lisis, equipos de productos, Amazon, Israel, Singapur, trabajo remoto, etc., se discuti√≥ mucho.</a></li>
<li><a href="../es496176/index.html">Gran conferencia virtual: experiencia del mundo real en la protecci√≥n de datos de empresas digitales modernas</a></li>
<li><a href="../es496178/index.html">Swift 5.2. Resumen de todos los cambios</a></li>
<li><a href="../es496180/index.html">Cuida la sombra de la juventud</a></li>
<li><a href="../es496184/index.html">Tecnolog√≠a de pantalla LED: Micro-LED vs. Mini LED</a></li>
<li><a href="../es496188/index.html">C√≥mo dejar de ver compulsivamente programas de televisi√≥n y empezar a vivir</a></li>
<li><a href="../es496190/index.html">Sobre Phrasal Verbs-2</a></li>
<li><a href="../es496192/index.html">Funciones de llamada de √≥xido desde Go</a></li>
<li><a href="../es496194/index.html">Sobre la binarizaci√≥n de im√°genes tomogr√°ficas de estructura fina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>