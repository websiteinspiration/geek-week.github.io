<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏻 🙏🏻 😐 Bekerja pintar dengan RabbitMQ di NestJS 🏐 🚵🏼 💪🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ketika mengembangkan sistem keuangan, mekanisme standar untuk memproses tugas-tugas yang telah diselesaikan di sebagian besar implementasi protokol AM...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bekerja pintar dengan RabbitMQ di NestJS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491076/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika mengembangkan sistem keuangan, mekanisme standar untuk memproses tugas-tugas yang telah diselesaikan di sebagian besar implementasi protokol AMQP tidak selalu cocok. </font><font style="vertical-align: inherit;">Pada titik tertentu, kami mengalami masalah seperti itu, tetapi hal pertama yang pertama.</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi standar RabbitMQ di NestJS membuatnya mudah untuk menerima pesan dalam fungsi-fungsi yang didekorasi:</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-built_in">console</span>.log(context.getMessage());<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rincian lebih lanjut tentang cara kerjanya dijelaskan di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juga bekerja dengan antrian di Nest juga tercakup dalam artikel ini di Habré</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya sesuatu yang lain mungkin diperlukan. </font><font style="vertical-align: inherit;">Namun, ada sejumlah kelemahan dalam implementasi saat ini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengirim hasil ack ke saluran, Anda harus menarik saluran secara manual dari konteks RmqContext dan mengirim sinyal ke sana.</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-keyword">const</span> channel = context.getChannelRef();
  <span class="hljs-keyword">const</span> originalMsg = context.getMessage();<font></font>
  channel.ack(originalMsg);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gunakan pola yang sama yang digunakan ketika bekerja dengan http handler dengan mengembalikan hasil eksekusi langsung dari fungsi sebagai objek biasa, Janji atau Dapat Diamati.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda perlu mengirim hasilnya dalam antrian terpisah, maka di setiap pengontrol yang menggunakan Kelinci Anda perlu tahu namanya. </font><font style="vertical-align: inherit;">Dengan kata lain, tidak ada cara untuk mengkonfigurasi ini di 1 tempat selama inisialisasi modul dan menggunakannya secara implisit.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada tahap konfigurasi modul, tentukan antrian untuk hasil operasi yang sukses dan untuk kesalahan. </font><font style="vertical-align: inherit;">Kami memutuskan untuk mengirim hasil operasi yang sukses dalam satu antrian, dan hasil yang salah di yang lain. </font><font style="vertical-align: inherit;">Menggunakan solusi untuk masalah 1, jika nilai kembali, Janji atau Dapat Diamati berhasil, maka hasilnya dikirim ke antrian operasi yang sukses, jika tidak, pesan ditolak dan jatuh ke dalam antrian kesalahan, RabbitMQ membuatnya mudah untuk melakukan ini menggunakan opsi x-dead. -pertukaran newsletter dan x-dead-letter-routing-key saat membuat antrian.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai pengguna perpustakaan, pengembang perlu mengetahui rincian protokol AMQP untuk mendapatkan id dari pesan berikutnya, memahami apa ack itu dan kapan harus memanggilnya, dll.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambahkan dekorator untuk mendapatkan id pesan. </font><font style="vertical-align: inherit;">Alih-alih ack, kembalikan hasil eksekusi dari fungsi handler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 4</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mungkin masalah yang paling penting: menyampaikan pesan kepada pawang lebih dari sekali. Ketika datang ke transaksi keuangan, ini adalah poin yang sangat penting, karena situasi mungkin muncul ketika uang sudah dikirim, dan operasi jatuh pada langkah terakhir - ketika menulis ke database atau mengirim pesan pengakuan ke broker. Salah satu solusi yang jelas adalah dengan menulis ID pesan yang dihasilkan oleh produsen dalam database ketika pesan diterima oleh konsumen, sebelum memproses pesan, jika belum ada, jika ada, maka tolak pesan tersebut. Tetapi protokol AMQP memberikan bendera yang dikirim kembali yang mengidentifikasi apakah pesan ini pernah dikirimkan ke klien lain, yang dapat kita gunakan untuk mendeteksi pesan yang dikirim ulang dan mengirimkannya ke antrian dengan kesalahan.Dalam implementasi saat ini di Nest, tidak ada cara untuk tidak mengirimkan pesan tersebut.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jangan mengirimkan pesan ini ke pawang, tetapi catat kesalahan pada tahap menerima pesan dari pengemudi. </font><font style="vertical-align: inherit;">Tentu saja, perilaku ini dapat dikonfigurasi pada tahap dekorasi metode untuk secara eksplisit menunjukkan bahwa kami masih ingin menerima pesan untuk jenis tindakan ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyelesaikan semua masalah di atas, implementasi protokolnya ditulis. </font><font style="vertical-align: inherit;">Seperti apa inisialisasi:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> amqp = <span class="hljs-keyword">await</span> NestFactory.create(<font></font>
 RabbitModule.forRoot({<font></font>
   <span class="hljs-attr">host</span>: process.env.AMQP_QUEUE_HOST,
   <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PORT, <span class="hljs-number">10</span>),
   <span class="hljs-attr">login</span>: process.env.AMQP_QUEUE_LOGIN,
   <span class="hljs-attr">password</span>: process.env.AMQP_QUEUE_PASSWORD,
   <span class="hljs-attr">tasksQueueNormal</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST,
   <span class="hljs-attr">tasksQueueRedelivery</span>: process.env.AMQP_QUEUE_REQUEST_ONCE_DELIVERY,
   <span class="hljs-attr">deadLetterRoutingKey</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_DEAD_LETTER,
   <span class="hljs-attr">deadLetterRoutingKeyRedelivery</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_ONCE_DELEVERY_DEAD_LETTER,
   <span class="hljs-attr">exchange</span>: process.env.AMQP_EXCHANGE_COMMAND,
   <span class="hljs-attr">prefetch</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PREFETCH, <span class="hljs-number">10</span>),<font></font>
 }),<font></font>
);<font></font>
<span class="hljs-keyword">const</span> transport = amqp.get&lt;RabbitTransport&gt;(RabbitTransport);<font></font>
app.connectMicroservice({<font></font>
 <span class="hljs-attr">strategy</span>: transport,
 <span class="hljs-attr">options</span>: {},<font></font>
});<font></font>
<font></font>
app.startAllMicroservices();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini kami menunjukkan nama-nama antrian untuk mengirimkan pesan, hasil, dan kesalahan, serta antrian individual yang tidak sensitif terhadap pengiriman ulang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada level controller, pekerjaannya sama seperti bekerja dengan http</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‘say_hey’)<font></font>
sayHay(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heyService.greet(requestId, q);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasil tugas akan jatuh ke dalam antrian hasil segera setelah Observable ini dijalankan. </font><font style="vertical-align: inherit;">Parameter yang dihiasi dengan @AMQPRequest sesuai dengan bidang korelasiId dari protokol. </font><font style="vertical-align: inherit;">Ini adalah pengidentifikasi unik untuk pesan yang dikirim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter @AMQPParam cocok dengan isi pesan itu sendiri. </font><font style="vertical-align: inherit;">Jika JSON, maka pesan akan tiba di fungsi yang sudah dikonversi ke objek. </font><font style="vertical-align: inherit;">Jika jenisnya sederhana, maka pesannya dikirim apa adanya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pesan berikut akan ada dalam surat mati:</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‘say_hey’)<font></font>
sayHayErr(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> throwError(‘Buy’);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada apa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambahkan Jenis Refleksi ke AMQPParam sehingga badan pesan dikonversi ke kelas yang diteruskan. </font><font style="vertical-align: inherit;">Sekarang hanya kasta untuk diketik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua kode dan instruksi pemasangan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tersedia di GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap pengeditan dan komentar dipersilakan.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id491052/index.html">Bagaimana dan mengapa kurator di St. Petersburg HSE membantu mahasiswa baru</a></li>
<li><a href="../id491054/index.html">Cara menandatangani korespondensi email dengan kunci GPG menggunakan token PKCS # 11</a></li>
<li><a href="../id491056/index.html">Ampere Altra - prosesor ARM 80-core pertama di dunia</a></li>
<li><a href="../id491058/index.html">Kematian, kematian, coronavirus dan matan</a></li>
<li><a href="../id491062/index.html">Angular: membuat elemen formulir kustom dan menyampaikan status formulir ke sana</a></li>
<li><a href="../id491084/index.html">saneex.c: coba / tangkap / akhirnya berdasarkan setjmp / longjmp (C99) lebih cepat dari pengecualian C ++ standar ¹</a></li>
<li><a href="../id491086/index.html">Perpustakaan Webix JavaScript melalui mata seorang pemula. Bagian 6. Interaksi server</a></li>
<li><a href="../id491088/index.html">GitHub: Perpustakaan Open Source Baru untuk OSINT</a></li>
<li><a href="../id491090/index.html">Konversi dokumen teks ke xml dalam C #</a></li>
<li><a href="../id491092/index.html">Bagaimana Crash Bandicoot Meretas Playstation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>