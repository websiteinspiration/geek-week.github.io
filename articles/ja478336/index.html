<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📎 ♍️ ⛑️ 非同期、Swoole、ParallelによるTarantool PHPコネクタの高速化 👩‍💼 🔐 🥩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PHPエコシステムには、現在、Tarantoolサーバーを操作するための2つのコネクタがあります。これは、Cで書かれた公式のPECL拡張機能tarantool / tarantool-phpと、PHPで書かれたtarantool-php / clientです。私は後者の作者です。
 
 この記事では...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>非同期、Swoole、ParallelによるTarantool PHPコネクタの高速化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/478336/"><img src="https://habrastorage.org/webt/5r/bm/wi/5rbmwilvinacbni2aggejp0n7sk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPエコシステムには、現在、Tarantoolサーバーを操作するための2つのコネクタがあります。これは、</font><font style="vertical-align: inherit;">Cで書かれ</font><font style="vertical-align: inherit;">た公式のPECL拡張機能</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarantool / tarantool-phpと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">PHPで書かれた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarantool-php / client</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">私は後者の作者です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、両方のライブラリーのパフォーマンスをテストした結果を共有し、コードの最小限の変更により、3から5の生産性向上を実現できる方法を示します（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合成テストで！</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何をテストしますか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期、並列、非同期非同期で実行</font><font style="vertical-align: inherit;">
される上記の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同期</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コネクタ</font><font style="vertical-align: inherit;">をテスト</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">:)また、コネクタ自体のコードには触れたくありません。</font><font style="vertical-align: inherit;">現時点では、目的を達成するためにいくつかの拡張機能が利用可能です。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、PHP用の高性能非同期フレームワークです。</font><font style="vertical-align: inherit;">AlibabaやBaiduなどのインターネット大手が使用します。</font><font style="vertical-align: inherit;">バージョン4.1.0以降、魔法の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole \ Runtime :: enableCoroutine（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドが登場し</font><font style="vertical-align: inherit;">、「PHP同期ネットワークライブラリを1行のコードで非同期に変換」できるようになりました。</font></font><br>
</li>
<li>Async ―           PHP.   ?  ,    ,        .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  .   Swoole,       <s> </s>      TCP  TLS    .     "<i>async.tcp = 1</i>".<br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Parallel</a> ―      Joe Watkins,     phpdbg, apcu, pthreads, pcov, uopz.   API     PHP     pthreads.     ,      ZTS (Zend Thread Safe)  PHP.<br>
</li>
</ul><br>
<h2>  ?</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先読みログを無効にして（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_mode = none</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、ネットワークバッファーを増やして</font><font style="vertical-align: inherit;">（</font><i><font style="vertical-align: inherit;">readahead </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 1 * 1024 * 1024</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">、Tarantoolインスタンスを起動してみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初のオプションはディスクでの作業を除外し、2番目のオプションはオペレーティングシステムのバッファーからより多くのリクエストを読み取ることを可能にし、それによってシステムコールの数を最小限に抑えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを操作するベンチマーク（挿入、削除、読み取りなど）の場合、ベンチマークを開始する前に、memtxスペースが作成（再）されます。ここで、整数（シーケンス）の順序付けられた値のジェネレーターによってプライマリインデックス値が作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スペースDDLは次のようになります。</font></font><br>
<br>
<pre><code class="lua hljs">space = box.schema.space.<span class="hljs-built_in">create</span>(<span class="hljs-built_in">config</span>.space_name, {<font></font>
    id = <span class="hljs-built_in">config</span>.space_id,<font></font>
    temporary = <span class="hljs-literal">true</span><font></font>
})<font></font>
<font></font>
space:create_index(<span class="hljs-string">'primary'</span>, {
    <span class="hljs-built_in">type</span> = <span class="hljs-string">'tree'</span>, <font></font>
    parts = {<span class="hljs-number">1</span>, <span class="hljs-string">'unsigned'</span>}, <font></font>
    sequence = <span class="hljs-literal">true</span><font></font>
})<font></font>
<font></font>
space:<span class="hljs-built_in">format</span>({<font></font>
    {name = <span class="hljs-string">'id'</span>, <span class="hljs-built_in">type</span> = <span class="hljs-string">'unsigned'</span>},<font></font>
    {name = <span class="hljs-string">'name'</span>, <span class="hljs-built_in">type</span> = <span class="hljs-string">'string'</span>, is_nullable = <span class="hljs-literal">false</span>}<font></font>
})</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要に応じて、ベンチマークを起動する前に、フォームの10,000タプルでスペースが埋められます</font></font><br>
<br>
<pre><code class="lua hljs">{id, <span class="hljs-string">'tuple_'</span> .. id}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タプルへのアクセスは、ランダムなキー値に従って実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベンチマーク自体はサーバーへの単一の要求であり、10,000回（回転）実行され、次にサーバーは反復で実行されます。 5回の反復間の時間のすべての偏差が許容誤差3％以内になるまで反復が繰り返されます*。その後、平均結果が取られます。反復の間に1秒間の休止があり、プロセッサがスロットルに入らないようにします。 Luaガベージコレクターは各反復の前にオフにされ、完了後に強制的に開始されます。 PHPプロセスは、ベンチマークに必要な拡張機能でのみ開始され、出力バッファリングがオンになり、ガベージコレクターがオフになります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*回転数、反復、エラーしきい値は、ベンチマーク設定で変更できます。</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト環境</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下に公開された結果はMacBookPro（2015）で作成され、オペレーティングシステムはFedora 30（カーネルバージョン5.3.8-200.fc30.x86_64）です。</font><font style="vertical-align: inherit;">Tarantoolはパラメーター "でdockerで起動されました</font></font><code>--network host"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージバージョン：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tarantool：2.3.0-115-g5ba5ed37e </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker：19.03.3、ビルドa872fc2f86 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP：7.3.11（cli）（ビルド：Oct 22 2019 08:11:04）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tarantool /クライアント：0.6.0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rybakit / msgpack：0.6.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ext-tarantool：0.3.2（+ 7.3のパッチ）* </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ext-msgpack：2.0.3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ext-async：0.3.0-8c1da46 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ext-swoole：4.4.12 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ext-parallel：1.1.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">残念ながら、公式コネクタはPHPバージョン&gt; 7.2では機能しません。PHP7.3で拡張機能をコンパイルして実行するには、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">パッチ</font></a><font style="vertical-align: inherit;">を使用する必要がありました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同期モード</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tarantoolのプロトコルは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessagePack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリ形式</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">メッセージ</font></a><font style="vertical-align: inherit;">をシリアル化します。</font><font style="vertical-align: inherit;">PECLコネクタでは、シリアル化はライブラリの奥深くに隠されており、ユーザーランドコードからエンコードプロセス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影響</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">与える</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ことはできません</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">対照的に、純粋なPHPのコネクターは、標準のエンコーダーを拡張するか、その実装を使用することにより、エンコードプロセスをカスタマイズする機能を提供します。</font><font style="vertical-align: inherit;">ボックスから2つのエンコーダーを使用できます。1つは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msgpack / msgpack-php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（MessagePack PECLの公式拡張）に</font><font style="vertical-align: inherit;">基づいており、もう1つ</font><font style="vertical-align: inherit;">は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rybakit / msgpack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（純粋なPHP）に</font><font style="vertical-align: inherit;">基づいてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コネクタを比較する前に、PHPコネクタのMessagePackエンコーダのパフォーマンスを測定し、将来のテストでは、最良の結果を示すものを使用します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/631/8bc/e7c/6318bce7c925c835268957cfaf313f8f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPバージョン（Pure）は速度がPECL拡張機能よりも劣ります</font><font style="vertical-align: inherit;">が、公式のMessagePack拡張機能では形式仕様が部分的にしか実装されていないため（たとえば、カスタムデータ型のサポートがないため、</font><font style="vertical-align: inherit;">実際のプロジェクト</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rybakit / msgpack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用することをお勧めし</font><font style="vertical-align: inherit;">ます） Decimal（Tarantool 2.3で導入された新しいデータ型）を使用できなくなり、他にも多くの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（PHP 7.4との互換性の問題を含む）が発生します。</font><font style="vertical-align: inherit;">まあ、一般的に、プロジェクトは放棄されたように見えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、同期モードでのコネクターのパフォーマンスを測定してみましょう。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/051/bb3/ed3/051bb3ed3341d0c19788325ea624f7c6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グラフからわかるように、PECLコネクタ（Tarantool）は、PHPコネクタ（クライアント）よりも優れたパフォーマンスを示します。しかし、これは、低速の言語で実装されることに加えて、後者のことを考えると、驚くべき、実際には、より多くの仕事をしていません：各呼び出しで、新しい</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レスポンス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトが作成され</font><font style="vertical-align: inherit;">、また、選択の場合（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基準</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、およびの場合、 Update / Upsert- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operations</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、別個のエンティティー</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーバーヘッドも追加します。明らかに、あなたは柔軟性にお金を払わなければなりません。ただし、一般に、PHPインタープリターは優れたパフォーマンスを示しますが、違いはありますが、それは重要ではなく、PHP 8のJITは言うまでもなく、PHP 7.4でプリロードを使用する場合はさらに少ない場合があります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。 Tarantool 2.0はSQLサポートを導入します。 SQLプロトコルを使用して選択、挿入、更新、削除の操作を実行して、その結果を同等のnoSQL（バイナリ）と比較してみましょう。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/134/2c9/81a/1342c981aa69d8d017c701a020aa697d.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLの結果はそれほど印象的ではありません（まだ同期モードをテストしていることを思い出します）。</font><font style="vertical-align: inherit;">ただし、私はこれについて前もって動揺することはありません。SQLサポートはまだ活発に開発</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ており</font></a><font style="vertical-align: inherit;">（比較的最近、たとえば、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">準備済みステートメントの</font></a><font style="vertical-align: inherit;">サポート</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が</font></a><font style="vertical-align: inherit;">追加</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">さ</font></a><font style="vertical-align: inherit;">れました</font><font style="vertical-align: inherit;">）、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のリストから判断すると、</font><font style="vertical-align: inherit;">SQLエンジンは将来、多くの最適化を待機します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では、Async拡張機能が上記の結果を改善するのにどのように役立つかを見てみましょう。</font><font style="vertical-align: inherit;">非同期プログラムを作成するために、拡張機能はコルーチンに基づくAPIを提供し、それを使用します。</font><font style="vertical-align: inherit;">経験的に、私たちの環境に最適なコルチンの量は25であることがわかります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/159/a6c/f99/159a6cf9989de3851fac5ee097b8fdf9.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
25のコルーチンで10,000の操作を「塗りつぶし」、何が起こったかを確認します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0d0/be5/d49/0d0be5d493856fb6cf4164218ed430d9.png"></div><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarantool-php / clientの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1秒あたりの操作数が3倍以上増加しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悲しいことに、PECLコネクタはext-asyncで始まっていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLはどうですか？</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bfe/a81/836/bfea818363bf23624fc04125ae11de6f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、非同期モードでは、バイナリプロトコルとSQLの違いがエラーの範囲内になっています。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スウール</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでも、Swooleのコルーチンの最適量を見つけます。</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e13/fd6/86b/e13fd686b5e8925465121dc8d951b79e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
25にとどまりましょう。Async拡張と同じトリックを繰り返しましょう。25のコルーチン間で10,000の操作を分散します。</font><font style="vertical-align: inherit;">さらに、すべての作業を2つのプロセスに分割する別のテストを追加します（つまり、各プロセスは25のコルーチンで5,000の操作を実行します）。</font><font style="vertical-align: inherit;">プロセスは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole \ Process</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して作成され</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/763/606/55c/76360655ca3480a8e57aff8cd55ad53c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Swoleは、1つのプロセスで実行している場合、Asyncと比較してわずかに低い結果を示しますが、2つのプロセスでは、画像が劇的に変化します（数値2はランダムに選択されませんでした。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ちなみに、Async拡張機能にはプロセスを操作するためのAPIもありますが、1つまたは複数のプロセスでベンチマークを実行した場合との違いはありませんでした（どこかで混乱した可能性があります）。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLとバイナリプロトコル：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4a6/5bf/b14/4a65bfb1491eaf141a3ad00bb0409b15.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非同期の場合と同様に、バイナリ操作とSQL操作の違いは非同期モードで平準化されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平行</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parallel拡張機能はコルーチンではなくスレッドに関するものであるため、並列スレッドの最適な数を測定します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e0/aa0/418/6e0aa0418e0c86ed36082f0566250e4d.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の車では16です。</font><font style="vertical-align: inherit;">コネクタのベンチマークを16の並列スレッドで実行します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/320/116/fed/320116fed16a23bda1a0849e8293e213.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、結果は非同期拡張よりも優れています（2つのプロセスで実行されているSwooleは数えません）。</font><font style="vertical-align: inherit;">PECLコネクタの場合、UpdateおよびUpsert操作の代わりに空であることに注意してください。</font><font style="vertical-align: inherit;">これは、これらの操作がエラーでクラッシュしたという事実によるものです-障害がext-parallel、ext-tarantool、またはその両方であったかどうかはわかりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、SQLのパフォーマンスを比較します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d86/59c/8c2/d8659c8c25b466fc5cc538b08e6d2441.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期して実行されているコネクタのグラフとの類似性に注意してください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一緒</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、すべての結果を1つのグラフにまとめて、テストされた拡張機能の全体像を確認します。</font><font style="vertical-align: inherit;">チャートに新しいテストを1つだけ追加しますが、まだ行っていません。Parallel*を使用して非同期コルーチンを並列で実行します。</font><font style="vertical-align: inherit;">前述の拡張機能を統合するという考えは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作者</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">によって</font></a><font style="vertical-align: inherit;">すでに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">議論され</font></a><font style="vertical-align: inherit;">ています</font><font style="vertical-align: inherit;">が、コンセンサスには達していません。私たち自身で行う必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* SwooleのコルーチンをParallelで起動できませんでした。これらの拡張機能には互換性がないようです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、最終結果：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb2/0b4/7ad/eb20b47ad5e371202e874e5c56b42d8e.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の代わりに</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の意見では、結果は非常にまともであり、何らかの理由でこれが制限ではないと確信しています！</font><font style="vertical-align: inherit;">自分だけで実際のプロジェクトでこれを決定する必要があるかどうかに関係なく、私にとっては、最小限の労力で同期TCPコネクタからどれだけ絞り出すことができるかを評価できる興味深い実験であったとだけ言っておきます。</font><font style="vertical-align: inherit;">ベンチマークを改善するためのアイデアがあれば、喜んでリクエストプールを検討します。</font><font style="vertical-align: inherit;">起動手順と結果を含むすべてのコードは、別の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公開され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478322/index.html">実際のプロジェクトでのアプリケーションに関するReact NativeとFlutterの比較</a></li>
<li><a href="../ja478324/index.html">最小の違い</a></li>
<li><a href="../ja478326/index.html">思慮深いクエリ：PWAキャッシュ戦略</a></li>
<li><a href="../ja478328/index.html">データサイエンティストが車を購入した方法</a></li>
<li><a href="../ja478330/index.html">DapはWeb用のもう1つのジェットエンジンです。全然違う</a></li>
<li><a href="../ja478340/index.html">Tinkoffインターンシッププログラムはどのように機能しますか？</a></li>
<li><a href="../ja478342/index.html">ボットは私たちを助けます</a></li>
<li><a href="../ja478344/index.html">メールを開始してスパムに巻き込まれないようにするにはどうすればよいですか？</a></li>
<li><a href="../ja478346/index.html">2020年にMacBook Pro 2011を購入するとどうなりますか？</a></li>
<li><a href="../ja478350/index.html">12月5日、ManyChatバックエンドMeetUp</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>