<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💽 👤 👨🏽‍🍳 DBLog-変更データキャプチャの一般的なフレームワーク ⤵️ ➖ 🌂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは！コース「High Load Architect」の学生のために特別に準備した記事の翻訳を読むことをお勧めします。
 
 
 
 前書き
 データ変更の追跡（Change Data Capture、CDC）を使用すると、データベースでコミットされた変更をリアルタイムで受信し、さま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBLog-変更データキャプチャの一般的なフレームワーク</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/494784/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みなさん、こんにちは！</font><font style="vertical-align: inherit;">コース</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「High Load Architect」の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学生のために特別に準備した記事の翻訳を読むことをお勧めします</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/0l/li/m7/0llim77k9jjhhp94nyd5qozgmxw.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ変更の追跡（Change Data Capture、CDC）を使用すると、データベースでコミットされた変更をリアルタイムで受信し、さまざまなコンシューマーに配布できます[1] [2]。 CDCは、異種データウェアハウジング（MySQLやElasticSearchなど）間の同期が必要な場合にますます一般的になり、デュアル書き込みトランザクションや分散トランザクションなどの従来の方法の代替となります[3] [4]。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLやPostgreSQLなどのデータベースでのCDCのソースは、トランザクションログ（トランザクションログ）です。ただし、トランザクションログは通常切り捨てられるため、変更の履歴全体が含まれていない場合があります。したがって、ソースの完全な状態を取得するには、ダンプが必要です。多くの場合、同じライブラリ、データベースAPI、およびプロトコルを使用するいくつかのオープンソースCDCプロジェクトを調査したところ、これらのプロジェクトには、要件を満たさない多くの制限が見つかりました。たとえば、ダンプ（完全なデータスナップショット）が完了するまでログイベントの処理を停止する、オンデマンドまたは実装でダンプダンプを開始できない、テーブルロックの使用による書き込みトラフィックに影響を与える。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、</font><b><font style="vertical-align: inherit;">DBLog</font></b><font style="vertical-align: inherit;">が開発され</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログとダンプの処理に対する統一されたアプローチ。</font><font style="vertical-align: inherit;">これをサポートするには、いくつかの関数をDBMSに実装する必要があります。これらの関数は、MySQL、PostgreSQL、MariaDB、およびその他のいくつかのデータベースにすでに含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogの機能の一部：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログイベントは発生順に処理されます。</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダンプは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すべてのテーブル、1つのテーブル、またはテーブルの特定の主キーに対して</font><b><font style="vertical-align: inherit;">いつでも作成でき</font></b><font style="vertical-align: inherit;">ます。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ処理はダンプ処理と交互に行われ、ダンプをブロックに分割します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、ログ処理はダンプ処理と並行して行うことができます。</font><font style="vertical-align: inherit;">プロセスが終了した場合は、最後に完了したブロックの後で、最初からやり直すことなく再開できます。</font><font style="vertical-align: inherit;">また、ダンプの作成時にスループットを調整し、必要に応じて作成を一時停止することもできます。</font></font></li>
<li><b>   </b>,          .</li>
<li><b>   </b>: ,     API.</li>
<li><b>     </b>.    ,           .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前に、</font><font style="vertical-align: inherit;">データの強化と同期のためのプラットフォームである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">について説明しました</font><font style="vertical-align: inherit;">。 Deltaの目標は、そのうちの1つがプライマリ（MySQLなど）で、他の派生物（ElasticSearchなど）が複数のデータストアを同期することです。重要な開発要件の1つは、ソースから受信者への変更の伝播の遅延が少ないことと、イベントストリームの高可用性です。これらの条件は、すべてのデータウェアハウスが1つのチームによって使用されているかどうか、または1つのチームがデータを所有し、他のチームがそれを消費するかどうかに関係なく適用されます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">に関する記事では</font><font style="vertical-align: inherit;">、イベント処理などのデータ同期を超えた使用例についても説明しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを同期してイベントを処理するには、変更をリアルタイムで追跡できることに加えて、次の要件を満たす必要があります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全な状態を取得します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">派生ストア（ElasticSearchなど）は、最終的にソースの完全な状態を格納する必要があります。</font><font style="vertical-align: inherit;">元のデータベースのダンプを通じてこれを実装します。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつでも状態の回復を開始します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダンプを1次初期化のみの1回限りの操作と見なす代わりに、すべてのテーブル、1つのテーブル、または特定の主キーに対していつでも行うことができます。</font><font style="vertical-align: inherit;">これは、データの損失または損傷が発生した場合の消費者の回復にとって非常に重要です。</font></font></li>
<li><b>    - </b>.          . ,        (,    ).              - .  ,  -        .</li>
<li><b>    </b>.                          .     API,     , ,  .        ,          ,  ,  .</li>
<li><b>   </b>.     Netflix   ,   Kafka, SQS, Kinesis,     Netflix,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Keystone</a>.   ,           (,    ),      (,    ).           .        API.</li>
<li><b>   </b>.  Netflix  ,    (MySQL, PostgreSQL)  AWS RDS.        .</li>
</ul><br>
<br>
<h3> </h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maxwell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpinalTap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Yelp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL Streamer、</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Debezium</font></a><font style="vertical-align: inherit;"> 
など、いくつかの既存のオープンソースソリューションを調査</font><font style="vertical-align: inherit;">し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">データ収集に関しては、トランザクションログを使用して、すべて同じように機能します。</font><font style="vertical-align: inherit;">たとえば、MySQLのbinlogレプリケーションプロトコルまたはPostgreSQLのレプリケーションスロットを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ダンプを処理する場合、次の制限の少なくとも1つがあります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダンプの作成中にログイベントの処理を停止します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その結果、ダンプが大きい場合、ログイベントの処理が長期間停止します。</font><font style="vertical-align: inherit;">消費者が変更の伝播にわずかな遅延を当てにしている場合、これは問題になります。</font></font></li>
<li><b>     </b>.                .                (,   ElasticSearch)        .</li>
<li><b>      </b>.         .                    [5].          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a>,         .         . ,  PostgreSQL RDS        .</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のデータベース機能の使用</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一部のソリューションでは、すべてのシステムには存在しない追加のデータベース機能を使用することがわかりました。</font><font style="vertical-align: inherit;">たとえば、MySQLでブラックホールエンジンを使用したり、PostgreSQLのレプリケーションスロットを通じてダンプの一貫したスナップショットを取得したりします。</font><font style="vertical-align: inherit;">これにより、異なるデータベース間でのコードの再利用が制限されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局、私たちはダンプを扱うために別のアプローチを取ることを決めました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログとダンプのイベントを交互に実行して、一緒に実行できるようにします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつでもダンプを開始します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルロックを使用しない</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のデータベース機能を使用しないでください。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBLogフレームワーク</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogは、ダンプと変更をリアルタイムで受信するためのJavaフレームワークです。ダンプは部分的に実行されるため、リアルタイムイベントと交互に行われ、処理が長時間遅延することはありません。ダンプはAPIを介していつでも行うことができます。これにより、コンシューマはデータベースの完全な状態を初期化段階以降に取得して、災害復旧を行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームワークを設計するとき、データベースへの影響を最小限に抑えることを考えました。ダンプは、必要に応じて一時停止および再開できます。これは、クラッシュリカバリと、データベースがボトルネックになった場合の停止の両方で機能します。また、書き込み操作に影響を与えないようにテーブルをロックしません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogを使用すると、別のデータベースやAPIを含むさまざまな形式でイベントを記録できます。</font><font style="vertical-align: inherit;">ログとダンプの処理に関連する状態を保存し、マスターノードを選択するには、Zookeeperを使用します。</font><font style="vertical-align: inherit;">DBLogを作成するときに、さまざまなプラグインを接続する機能を実装し、必要に応じて実装を変更できるようにします（たとえば、Zookeeperを別のものに置き換える）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ログとダンプの処理について詳しく説明します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームワークでは、コミットの順序を維持しながら、変更された各行のイベントをリアルタイムでデータベースに記録する必要があります。これらのイベントのソースは、トランザクションログであると想定されています。データベースは、DBLogが使用できるトランスポートを介してそれらを送信します。このトランスポートでは、「変更ログ」という用語を使用します。イベントには、作成、作成、更新、または削除のタイプがあります。イベントごとに、ログ内のシーケンス番号（ログシーケンス番号）、操作中の列の状態、および操作の実行時に適用されたスキームを提供する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各変更は、DBLogイベント形式にシリアル化され、ライターに送信されて、出力に転送されます。</font><font style="vertical-align: inherit;">ライターへのイベントの送信は、非ブロッキング操作です。ライターは別のスレッドで実行され、内部バッファーにイベントを蓄積するためです。</font><font style="vertical-align: inherit;">バッファリングされたイベントは、受信した順に送信されます。</font><font style="vertical-align: inherit;">フレームワークを使用すると、カスタムフォーマッタを接続して、イベントを任意の形式にシリアル化できます。</font><font style="vertical-align: inherit;">出力は、ストリーム、データウェアハウス、さらにはAPIなどの任意の受信者に接続できるようにする単純なインターフェースです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダンプ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションログの保存期間は限られており、元のデータセット全体を復元するために使用できないため、ダンプが必要です。ダンプはブロック（チャンク）で作成されるので、ログイベントと交互になり、それらを同時に処理できます。ブロックの選択された行ごとに、イベントが生成され、ログイベントと同じ形式でシリアル化されます。したがって、コンシューマーはログまたはダンプからのイベントを心配する必要はありません。ログイベントとダンプイベントの両方が同じライターを介して出力に送信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダンプは、APIを介して、すべてのテーブル、1つのテーブル、またはテーブルの特定の主キーに対していつでもスケジュールできます。テーブルのダンプは、指定されたサイズのブロックによって実行されます。また、新しいブロックの処理の遅延を設定して、現時点ではログイベントのみを許可することもできます。ブロックサイズと遅延により、ログとダンプイベントの処理のバランスをとることができます。どちらの設定も実行時に変更できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブロック（チャンク）を選択するには、テーブルを主キーの昇順で並べ替え、主キーが前のブロックの最後の主キーより大きい行を選択します。このクエリを効率的に実行するにはデータベースが必要です。これは通常、一連の主キーに対して範囲スキャンを実装するシステムに適用されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/io/cc/kaioccujfq6yx3mcch7btisn-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図1. 4つの列c1-c4およびc1を主キー（pk）とする表の内訳整数型の主キー、ブロックサイズ3.ブロック2は条件c1 &gt;&gt;によって選択されます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブロックは、ログイベントの処理を長期間遅延させず、変更の履歴を保存して、古い値で選択された行が新しい行を上書きできないようにする必要があります。イベント。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブロックを順番に選択できるようにするために、変更ログに認識可能な「透かし」を作成します。</font><font style="vertical-align: inherit;">透かしは、ソースデータベースのテーブルを通じて実装されます。</font><font style="vertical-align: inherit;">このテーブルは特別な名前空間に格納されるため、アプリケーションテーブルとの競合はありません。</font><font style="vertical-align: inherit;">UUID値を持つ1行のみが格納されます。</font><font style="vertical-align: inherit;">この値が特定のUUIDに変更されると、透かしが作成されます。</font><font style="vertical-align: inherit;">行を更新すると、変更イベントが発生し、最終的には変更ログを通じて受信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
透かし入りダンプは次のように作成されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログイベントの処理を一時的に停止します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">透かしテーブルを更新して、「低」透かしを生成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のブロックのSELECTを開始し、主キーによってインデックスが付けられた結果をメモリに保存します。</font></font></li>
<li> “” (high)  ,    .</li>
<li>    .         .</li>
<li>              ,     .</li>
<li>     ,     ,         .</li>
<li>   ,     1.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECTは、ある時点までのコミットされた変更を表す状態を返すことになっています。または、以下と同等です。SELECTは、変更ログの特定の位置で実行され、この時点までの変更が考慮されます。通常、データベースはSELECTの実行時間に関する情報を提供しません（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MariaDBを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">除く</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのアプローチの主な考え方は、変更ログで、ブロック内のSELECT位置の保持を保証するウィンドウを定義することです。ウィンドウは下の透かしを書き込むことによって開かれ、その後SELECTが実行され、ウィンドウは上の透かしを書き込むことによって閉じられます。 SELECTの正確な位置は不明であるため、このウィンドウのログイベントと競合する選択された行はすべて削除されます。これにより、変更ログの履歴が書き換えられることがなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが機能するためには、SELECTは下のウォーターマークの時点以降のテーブルの状態を読み取る必要があります（下のウォーターマークの後で読み取り前に行われた変更を含めることは許容されます）。一般に、</font><b><font style="vertical-align: inherit;">SELECT</font></b><font style="vertical-align: inherit;">は、</font><b><font style="vertical-align: inherit;">実行前に行われた変更</font></b><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">確認する</font></b><font style="vertical-align: inherit;">ために必要です</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これを「古くない読み取り」と呼びます。また、上位ウォーターマークは後に書き込まれるため、その前にSELECTが実行されることが保証されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図2aおよび2bは、ブロック選択アルゴリズムを示しています。例として、k1からk6までの主キーを持つテーブルを示します。変更ログの各エントリは、主キーの作成、更新、または削除イベントを表します。図2aは、透かしの生成とブロックの選択（手順1〜4）を示しています。手順2と4でウォーターマークテーブルを更新すると、2つの変更イベント（マゼンタ）が作成され、最終的にログを通じて受信されます。図2bでは、ウォーターマークの間に表示される主キー（ステップ5から7）を使用して、結果セットから削除された現在のブロックの行に注目しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/3w/ej/8w3wej0evpfqtnpdkbozswm58yu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図2a-ブロック選択の透かしアルゴリズム（ステップ1〜4）。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/sg/i5/9s/sgi59s3d8zgf-f2eusi2itklqyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図2b-ブロックを選択するための透かしアルゴリズム（ステップ5〜7）。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ以上のトランザクションが多くの行の変更を行った場合、下の透かしと上の透かしの間に多数のイベントがログに表示される可能性があることに注意してください。</font><font style="vertical-align: inherit;">このため、ウォーターマークを見逃さないように、ステージ2〜4でログの処理を一時的に停止します。</font><font style="vertical-align: inherit;">したがって、ログイベントの処理はイベントごとに再開できます。これにより、最終的に、ログのログイベントをキャッシュする必要なくウォーターマークを検出できます。</font><font style="vertical-align: inherit;">手順2〜4は高速であることが期待されるため、ログ処理は短時間だけ中断されます。透かしの更新は単一の書き込み操作であり、SELECTは制限付きで実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステップ7で上位ウォーターマークが受信されるとすぐに、ブロックの競合しないラインが、受信された順序で出力に送信されます。</font><font style="vertical-align: inherit;">ライターは別のスレッドで実行されるため、これは非ブロッキング操作です。これにより、手順7の後でログの処理をすばやく再開できます。その後、上限のウォーターマークの後に発生するイベントのログの処理が続行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図2cは、図2aおよび2bと同じ例を使用したブロック全体の記録順序を示しています。</font><font style="vertical-align: inherit;">上限のウォーターマークの前に表示されるログのイベントが最初に記録されます。</font><font style="vertical-align: inherit;">次に、ブロック結果の残りの行（マゼンタ）。</font><font style="vertical-align: inherit;">そして最後に、トップウォーターマークの後に発生するイベントが記録されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4y/er/et/4yeretd8vbgtxvbp7sm9ppdxe7m.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図2c-出力を記録する順序。</font><font style="vertical-align: inherit;">ダンプで交互を取り除く。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポートされているデータベース</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogを使用するには、データベースは変更ログを、コミットされた変更と履歴のない読み取りの線形履歴として提供する必要があります。これらの条件は、MySQL、PostgreSQL、MariaDBなどのシステムで満たされているため、これらのデータベースでフレームワークを同じように使用できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでのところ、MySQLとPostgreSQLのサポートが追加されています。各データベースは独自のプロトコルを使用するため、各データベースは独自のライブラリを使用してログイベントを受信します。 MySQLの場合</font><font style="vertical-align: inherit;">、binlogレプリケーションプロトコルを実装</font><font style="vertical-align: inherit;">する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shyiko / mysql-binlog-connector</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><font style="vertical-align: inherit;">ます。 PostgreSQLの場合、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal2json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プラグインのレプリケーションスロットがあります</font><font style="vertical-align: inherit;">。変更は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">jdbcドライバー</font></a><font style="vertical-align: inherit;">によって実装されるストリーミング複製プロトコルを介して受け入れられ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL </font><font style="vertical-align: inherit;">キャプチャされた各変更のスキーマ定義は、MySQLとPostgreSQLでは異なります。</font><font style="vertical-align: inherit;">PostgreSQLでは、wal2jsonに名前、列タイプ、値が含まれています。</font><font style="vertical-align: inherit;">MySQLの場合、スキーマの変更はbinlogイベントとして追跡する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダンプ処理はSQLとJDBCを使用して行われ、ブロック選択の実装とウォーターマークの更新のみが必要でした。</font><font style="vertical-align: inherit;">MySQLとPostgreSQLの場合、同じコードが使用され、他の同様のデータベースに使用できます。</font><font style="vertical-align: inherit;">ダンプ処理自体はSQLまたはJDBCに依存せず、異なる標準を使用していても、DBLogの要件を満たすデータベースを使用できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/wg/nz/wuwgnzkxmagsrtt2_qnyp_yfiy8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図3-高レベルのDBLogアーキテクチャ。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高可用性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogは、単一ノードのアクティブ/パッシブアーキテクチャを使用します。</font><font style="vertical-align: inherit;">1つのインスタンスはアクティブ（先行）であり、他のインスタンスはパッシブ（スタンバイ）です。</font><font style="vertical-align: inherit;">ホストを選択するには、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Zookeeper</font></a><font style="vertical-align: inherit;">を使用します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リースはマスターノードに使用されます。リースを定期的に更新して、マスターであり続ける必要があります。</font><font style="vertical-align: inherit;">リースの更新が終了すると、リーダーの機能が別のノードに移ります。</font><font style="vertical-align: inherit;">現在、各AZ（アベイラビリティーゾーン、通常は3 AZ）ごとに1つのコピーを展開しているため、1つのAZが落ちた場合でも、別のAZのコピーは最小の合計ダウンタイムで処理を続行できます。</font><font style="vertical-align: inherit;">バックアップインスタンスは異なるリージョンに配置できますが、変更をキャプチャするためのレイテンシを低くするために、データベースホストと同じリージョンで作業することをお勧めします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生産での使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deltaで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用されるMySQLおよびPostgreSQLコネクタの基盤です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">2018年以降、Deltaはデータウェアハウスの同期とNetflixスタジオアプリケーションでのイベント処理のために本番環境で使用されています。</font><font style="vertical-align: inherit;">Deltaコネクタは、イベントシリアライザーを使用します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keystone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのNetflix固有のストリームが出力として使用されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5g/3j/fo/5g3jfo6pe8l-mpsqrngh6ylvtyc.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図4-Deltaコネクタ。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deltaに加えて、DBLogはNetflixでも使用され、独自のデータ形式を持つ他のデータ移動プラットフォーム用のコネクタを作成します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちと居て</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogには、この記事では取り上げていない次のような追加機能があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックを使用せずにテーブルスキーマを取得する機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーマストレージとの統合。</font><font style="vertical-align: inherit;">イベントごとに、スキームはストレージに保存され、ストレージへのリンクはイベントペイロードで示されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単調な書き込みモード。</font><font style="vertical-align: inherit;">特定の行の状態を保存した後、その過去の状態を上書きできないようにします。</font><font style="vertical-align: inherit;">したがって、消費者は、時間の前後に移動することなく、順方向でのみ状態変化を受け取ります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2020年にDBLogソースコードを開き、追加のドキュメントを含める予定です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">謝辞</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLogの開発に貢献してくれた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Snyder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raghuram Onti Srinivasan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tharanga Gamaethige</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yun Wangに</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">感謝</font></a><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[1]ダス、シルシャンカ、他。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「すべてがデータバスに搭載されています！：Linkedinのスケーラブルで一貫性のある変更データキャプチャプラットフォーム。」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドコンピューティングに関する第3回ACMシンポジウム。</font><font style="vertical-align: inherit;">ACM、2012年</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[2] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「変更データキャプチャ（SQL Server）について」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Microsoft SQLドキュメント、2019年</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[3] Kleppmann、Martin、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ログを使用して強固なデータインフラストラクチャを構築する（または、二重書き込みが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不適切</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">な理由）」</font></a><font style="vertical-align: inherit;">、コンフルエント、2015年</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[4]クレップマン、マーティン、アラステアR.ベレスフォード、ボルヘスビンゲン。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「オンラインイベント処理。」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACM 62.5（2019）のコミュニケーション：43–49 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[5] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://debezium.io/documentation/reference/0.10/connectors/mysql.html#snapshots </font></font><br>
</a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの詳細。</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja494766/index.html">近未来の通信技術トレンド</a></li>
<li><a href="../ja494772/index.html">米国でロボット呼び出しとの戦いがどのように進展しているか-政治家と電気通信会社の対策について</a></li>
<li><a href="../ja494776/index.html">PostgreSQLアンチパターン：SQLでの条件の計算</a></li>
<li><a href="../ja494780/index.html">コロナウイルス時代のアマゾン従業員の啓示と恐怖</a></li>
<li><a href="../ja494782/index.html">TensorFlow LiteとAzure Custom Visionを使用してAndroidで画像を分類する</a></li>
<li><a href="../ja494786/index.html">GDBでのMitMのようなRTOSサポート</a></li>
<li><a href="../ja494788/index.html">メールの仕組み</a></li>
<li><a href="../ja494792/index.html">Yandex.Routing：物流に突入し、未来を変えることにした方法</a></li>
<li><a href="../ja494794/index.html">私たちは長い腕を持っています</a></li>
<li><a href="../ja494798/index.html">Snowden：パンデミックは終了しますが、人口の監視は残ります</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>