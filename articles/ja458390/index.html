<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👉🏽 🐖 🏅 Ceph-「膝の上」から「本番」までパート2 🚣 🧕🏾 🧛🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="（ここの最初の部分：https : //habr.com/en/post/456446/）
 セフ
 前書き
 

ネットワークはCephの重要な要素の1つであり、当社では少し具体的であるため、まずネットワークについて少し説明します。
 主にネットワークインフラストラクチャなど、Ceph自体の説明は...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ceph-「膝の上」から「本番」までパート2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458390/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ここの最初の部分：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//habr.com/en/post/456446/</font></a><font style="vertical-align: inherit;">）</font></font></p><br>
<h1 id="ceph"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セフ</font></font></h1><br>
<h3 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークはCephの重要な要素の1つであり、当社では少し具体的であるため、まずネットワークについて少し説明します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主にネットワークインフラストラクチャなど、Ceph自体の説明ははるかに少なくなります。</font><font style="vertical-align: inherit;">CephサーバーとProxmox仮想化サーバーの一部の機能のみを説明します。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり、ネットワークトポロジー自体は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leaf-Spine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として構築されてい</font><strong><font style="vertical-align: inherit;">ます。</font></strong><font style="vertical-align: inherit;">古典的な3層アーキテクチャは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コア</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（コアルーター）、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集約</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（集約ルーター）があり、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント</font><font style="vertical-align: inherit;">（アクセスルーター）に</font><font style="vertical-align: inherit;">直接接続されて</font><font style="vertical-align: inherit;">いるネットワークです</font><font style="vertical-align: inherit;">。</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3レベルのスキーム</font></font></strong></p><br>
<p><img src="https://habrastorage.org/webt/yf/e8/cm/yfe8cmp5qspkply3yniplpk53oo.jpeg"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leaf-Spineトポロジは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（大まかに言えばメインルータ）と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leaf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ブランチ）</font><font style="vertical-align: inherit;">の2つのレベルで構成され</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2レベルのスキーム</font></font></strong></p><br>
<p><img src="https://habrastorage.org/webt/dw/ka/qo/dwkaqo4_ru7urikqyvmv3mqe8ik.jpeg"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての内部および外部ルーティングはBGPに基づいて構築されています。</font><font style="vertical-align: inherit;">アクセス制御、アナウンスなどを扱う主なシステムは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XCloudです。</font></font></strong></a><br>
,    ( -   )    L3  (    Leaf ,           Spine ),    BGP   unicast ,    anycast   ,          ECMP .    ,      ,          IPv6,   BGP unnumbered standard   RFC 5549. -     BGP       Quagga         .     FRRouting (         : Cumulus  XCloudNetworks),      .</p><br>
<p>       "".</p><br>
<h2 id="poisk-puti"> </h2><br>
<p>  cluster network:</p><br>
<p>1)    BGP</p><br>
<p>2)         LACP</p><br>
<p>3)         OSPF</p><br>
<h3 id="testy"></h3><br>
<p>   : </p><br>
<p>) ,    iperf, qperf, nuttcp</p><br>
<p>b)   Ceph ceph-gobench, rados bench,  rbd       dd     ,   fio</p><br>
<p>       SAS .      rbd   ,    .       .</p><br>
<h3 id="pervyy-variant"> </h3><br>
<p><strong>    ,  BGP.</strong> </p><br>
<p>          : </p><br>
<p>        ,   latency (   ).<br>
       s3  anycast ,      radosgateway.    ,       RGW   ,      —    Nginx       RGW,        leaf- (, ,     —       anycast    ).           ,     .</p><br>
<p>      ,    prod ,        leaf  spine —      .<br>
,          .<br>
 iperf   BW  3Gbps  1, 10  100       .<br>
   :</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/0a5/257/66b/0a525766bf7e61ffc4ba1129db0d17fd.png"></p><br>
<p> <strong>1</strong>   <strong>9.30 — 9.43 Gbits/sec</strong> (     ,  <strong>39148</strong>).          ,      .      <strong>500-600.</strong><br>
 <strong>10</strong>  <strong>9.63 Gbits/sec</strong>  ,        <strong>17045.</strong><br>
 <strong>100</strong>       <strong>10</strong>,     :   <strong>3354</strong></p><br>
<h3 id="vtoroy-variant"> </h3><br>
<p><strong>LACP</strong></p><br>
<p>   Juniper EX4500.    ,       ,   .<br>
    :</p><br>
<pre><code class="plaintext hljs">root@ceph01-test:~# cat /etc/network/interfaces<font></font>
auto ens3f0<font></font>
iface ens3f0 inet manual<font></font>
bond-master bond0<font></font>
post-up /sbin/ethtool -G ens3f0 rx 8192<font></font>
post-up /sbin/ethtool -G ens3f0 tx 8192<font></font>
post-up /sbin/ethtool -L ens3f0 combined 32<font></font>
post-up /sbin/ip link set ens3f0  txqueuelen 10000<font></font>
mtu 9000<font></font>
<font></font>
auto ens3f1<font></font>
iface ens3f1 inet manual<font></font>
bond-master bond0<font></font>
post-up /sbin/ethtool -G ens3f1 rx 8192<font></font>
post-up /sbin/ethtool -G ens3f1 tx 8192<font></font>
post-up /sbin/ethtool -L ens3f1 combined 32<font></font>
post-up /sbin/ip link set ens3f1  txqueuelen 10000<font></font>
mtu 9000<font></font>
<font></font>
auto bond0<font></font>
iface bond0 inet static<font></font>
address 10.10.10.1<font></font>
netmask 255.255.255.0<font></font>
slaves none<font></font>
bond_mode 802.3ad<font></font>
bond_miimon 100<font></font>
bond_downdelay 200<font></font>
bond_xmit_hash_policy 3 #(layer3+4 )<font></font>
mtu 9000</code></pre><br>
<p> iperf  qperf  Bw  <strong>16Gbits/sec.</strong>     :<br>
<strong>rr, balance-xor  802.3ad.</strong> -     <strong>layer2+3  layer3+4</strong> (      ).<br>
      sysctl  <strong>net.ipv4.fib_multipath_hash_policy,</strong> (     <strong>net.ipv4.tcp_congestion_control</strong>,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  ValdikSS</a>)).</p><br>
<p>           <strong>18Gbits/sec</strong> (    <strong>balance-xor  802.3ad</strong>,         )      " " .</p><br>
<h3 id="tretiy-variant"> </h3><br>
<p><strong>OSPF</strong></p><br>
<p>     LACP   ( ,      ).       vlan-    (   ,         QA   PROD ).</p><br>
<p>       vlan (     ).            ,    cluster network  CEPH.</p><br>
<p> <em>public network</em> (     SSH )   BGP,    OSPF  frr,     .</p><br>
<p><strong>10.10.10.0/24  20.20.20.0/24</strong> —     </p><br>
<p><strong>172.16.1.0/24</strong> —   </p><br>
<p><img src="https://habrastorage.org/webt/t5/c5/fp/t5c5fpxxwqv7u82ywsvkuumcsag.jpeg"></p><br>
<p> :<br>
 <strong>ens1f0 ens1f1</strong>    <br>
 <strong>ens4f0 ens4f1</strong>     </p><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">oot@ceph01-test:~# cat /etc/network/interfaces<font></font>
# This file describes the network interfaces available on your system<font></font>
# and how to activate them. For more information, see interfaces(5).<font></font>
<font></font>
source /etc/network/interfaces.d/*<font></font>
<font></font>
# The loopback network interface<font></font>
auto lo<font></font>
iface lo inet loopback<font></font>
<font></font>
auto ens1f0<font></font>
iface ens1f0 inet static<font></font>
post-up /sbin/ethtool -G ens1f0 rx 8192<font></font>
post-up /sbin/ethtool -G ens1f0 tx 8192<font></font>
post-up /sbin/ethtool -L ens1f0 combined 32<font></font>
post-up /sbin/ip link set ens1f0  txqueuelen 10000<font></font>
mtu 9000<font></font>
address 10.10.10.1/24<font></font>
<font></font>
auto ens1f1<font></font>
iface ens1f1 inet static<font></font>
post-up /sbin/ethtool -G ens1f1 rx 8192<font></font>
post-up /sbin/ethtool -G ens1f1 tx 8192<font></font>
post-up /sbin/ethtool -L ens1f1 combined 32<font></font>
post-up /sbin/ip link set ens1f1  txqueuelen 10000<font></font>
mtu 9000<font></font>
address 20.20.20.1/24<font></font>
<font></font>
auto ens4f0<font></font>
iface ens4f0 inet manual<font></font>
post-up /sbin/ethtool -G ens4f0 rx 8192<font></font>
post-up /sbin/ethtool -G ens4f0 tx 8192<font></font>
post-up /sbin/ethtool -L ens4f0 combined 32<font></font>
post-up /sbin/ip link set ens4f0  txqueuelen 10000<font></font>
mtu 9000<font></font>
<font></font>
auto ens4f1<font></font>
iface ens4f1 inet manual<font></font>
post-up /sbin/ethtool -G ens4f1 rx 8192<font></font>
post-up /sbin/ethtool -G ens4f1 tx 8192<font></font>
post-up /sbin/ethtool -L ens4f1 combined 32<font></font>
post-up /sbin/ip link set ens4f1  txqueuelen 10000<font></font>
mtu 9000<font></font>
<font></font>
#     loopback-:<font></font>
auto lo:0 <font></font>
iface lo:0 inet static <font></font>
        address 55.66.77.88/32<font></font>
        dns-nameservers 55.66.77.88  <font></font>
<font></font>
auto lo:1<font></font>
iface lo:1 inet static<font></font>
    address 172.16.1.1/32</code></pre><br>
<p> frr  :</p><br>
<pre><code class="plaintext hljs">root@ceph01-test:~# cat /etc/frr/frr.conf<font></font>
frr version 6.0<font></font>
frr defaults traditional<font></font>
hostname ceph01-prod<font></font>
log file /var/log/frr/bgpd.log<font></font>
log timestamp precision 6<font></font>
no ipv6 forwarding<font></font>
service integrated-vtysh-config<font></font>
username cumulus nopassword<font></font>
!<font></font>
interface ens4f0<font></font>
 ipv6 nd ra-interval 10<font></font>
!<font></font>
interface ens4f1<font></font>
 ipv6 nd ra-interval 10<font></font>
!<font></font>
router bgp 65500<font></font>
 bgp router-id 55.66.77.88 # ,      <font></font>
 timers bgp 10 30<font></font>
 neighbor ens4f0 interface remote-as 65001<font></font>
 neighbor ens4f0 bfd<font></font>
 neighbor ens4f1 interface remote-as 65001<font></font>
 neighbor ens4f1 bfd<font></font>
 !<font></font>
 address-family ipv4 unicast<font></font>
  redistribute connected route-map redis-default<font></font>
 exit-address-family<font></font>
!<font></font>
router ospf<font></font>
 ospf router-id 172.16.0.1<font></font>
 redistribute connected route-map ceph-loopbacks<font></font>
 network 10.10.10.0/24 area 0.0.0.0<font></font>
 network 20.20.20.0/24 area 0.0.0.0<font></font>
!<font></font>
ip prefix-list ceph-loopbacks seq 10 permit 172.16.1.0/24 ge 32<font></font>
ip prefix-list default-out seq 5 permit 0.0.0.0/0 ge 32<font></font>
!<font></font>
route-map ceph-loopbacks permit 10<font></font>
 match ip address prefix-list ceph-loopbacks<font></font>
!<font></font>
route-map redis-default permit 10<font></font>
 match ip address prefix-list default-out<font></font>
!<font></font>
line vty<font></font>
!</code></pre><br>
<p>     iperf, qperf  ..       <strong>19.8 Gbit/sec,</strong>   latency   <strong>20us</strong></p><br>
<p><em> <strong>bgp router-id:</strong>           .     ,     IP  .         ,    FRR   IP   loopback.     :<br>
1)        (,    172.16.0.0) ,   —      <strong>router-id</strong> , ,    .         .<br>
2)     anycast ,          <strong>router-id</strong> —        <strong>router-id.</strong></em> </p><br>
<h2 id="chast-2"> 2</h2><br>
<p>   QA     Ceph.</p><br>
<h3 id="network">NETWORK</h3><br>
<h3 id="pereezd-s-odnoy-seti-na-dve">     </h3><br>
<p> cluster network   ,     ,  OSD   <strong>ceph tell osd.* injectargs.</strong>         —  ,        .    OSD       —  -       —  OSD   ,   . ,  cluster network (, ,  public_network)  ,      .    —      ,   . Ceph      — OSD      ,     . </p><br>
<p>   ,      bgp      ,   —  ospf    ,     .            .       ,  ACL    ,       (     ""  ACL       .    spain-,     leaf-). </p><br>
<p>  , ,  :     bgp,   ospf. </p><br>
<p>   :</p><br>
<p>1)  cluster network  ceph   :  bgp   ospf<br>
  frr    ,  </p><br>
<pre><code class="plaintext hljs">ip prefix-list default-out seq 5 permit 0.0.0.0/0 ge 32</code></pre><br>
<p>     ,        loopback ,         .</p><br>
<p>2)    <strong>ceph.conf</strong>  </p><br>
<pre><code class="plaintext hljs">cluster network = 172.16.1.0/24, 55.66.77.88/27</code></pre><br>
<p>     OSD,       <strong>172.16.1.0/24.</strong></p><br>
<pre><code class="plaintext hljs">root@ceph01-prod:~#ceph osd set noout<font></font>
# -          OSD<font></font>
#     .  ,    <font></font>
#  , OSD      30 .<font></font>
root@ceph01-prod:~#for i in $(ps ax | grep osd | grep -v grep| awk '{ print $10}'); \<font></font>
root@ceph01-prod:~# do systemctl restart ceph-osd@$i; sleep 30; done</code></pre><br>
<p>3)        </p><br>
<pre><code class="plaintext hljs">cluster network = 172.16.1.0/24</code></pre><br>
<p>  . </p><br>
<p>,      . </p><br>
<p>:<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://shalaginov.com/2016/03/26/--leaf-spine/</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.xcloudnetworks.com/case-studies/innova-case-study/</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/rumanzo/ceph-gobench</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458376/index.html">別のプログラミング言語ではありません。パート1：ドメインロジック</a></li>
<li><a href="../ja458378/index.html">サイトのレイアウトにAvocodeを使用します。初心者向けのレビュー。ボーナス-30日間の試用期間を登録する</a></li>
<li><a href="../ja458382/index.html">なぜこれを教えるのですか？</a></li>
<li><a href="../ja458384/index.html">HP 3D Structured Light Scanner Pro S3レビューとテスト</a></li>
<li><a href="../ja458388/index.html">深い（学習+ランダム）フォレストと記事の解析</a></li>
<li><a href="../ja458394/index.html">例としてLoRaWANを使用したワイヤレスプロトコルの保護</a></li>
<li><a href="../ja458396/index.html">サーバー側レンダリングでVue.jsでの開発を便利にする方法</a></li>
<li><a href="../ja458398/index.html">遠隔作業の衛生またはテレパシーの利点</a></li>
<li><a href="../ja458404/index.html">モノリスからマイクロサービスへの移行：歴史と実践</a></li>
<li><a href="../ja458406/index.html">ユーティリティおよび非ユーティリティプログラムに関する30以上の質問</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>