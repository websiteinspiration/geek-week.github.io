<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👼🏽 🏇🏼 🙏🏽 Économisez beaucoup d'argent sur de gros volumes dans PostgreSQL 🤦🏻 🐅 🛀🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Poursuivant le sujet de l'enregistrement de grands flux de données, soulevé par l' article précédent sur le partitionnement , nous examinons ici les f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Économisez beaucoup d'argent sur de gros volumes dans PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498292/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poursuivant le sujet de l'enregistrement de grands flux de données, soulevé par l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article précédent sur le partitionnement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous examinons ici les façons dont vous pouvez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réduire la taille "physique" stockée</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans PostgreSQL, et leur impact sur les performances du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paramètres TOAST et de l'alignement des données</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">«En moyenne», ces méthodes permettront d'économiser pas trop de ressources, mais sans aucune modification du code de l'application.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cj/c-/lx/cjc-lxht8brbyy9xif_sicdwk70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, notre expérience s'est avérée très productive à cet égard, car le référentiel de presque toutes les surveillances est de par sa nature </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principalement composé uniquement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en termes de données enregistrées. </font><font style="vertical-align: inherit;">Et si vous êtes intéressé par la façon dont vous pouvez apprendre à une base de données à écrire sur un disque au lieu de la </font><font style="vertical-align: inherit;">moitié </font><font style="vertical-align: inherit;">de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200 Mo / s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - je demande une coupe.</font></font><br>
<a name="habracut"></a><br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Petits secrets du Big Data</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon le profil de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il reçoit régulièrement des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><b><font style="vertical-align: inherit;">texte</font></b><font style="vertical-align: inherit;"> des journaux </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le complexe VLSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dont nous surveillons les bases de données, est un produit multicomposant avec des structures de données complexes, les requêtes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour obtenir des performances maximales</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont obtenues par de tels </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«multi-volumes» avec une logique algorithmique complexe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, le volume de chaque instance individuelle de la demande ou du plan d'exécution résultant dans le journal qui nous parvient s'avère assez «moyen». </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons la structure de l'une des tables dans lesquelles nous écrivons les données "brutes" - c'est-à-dire, voici le texte original de l'entrée de journal:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> rawdata_orig(<font></font>
  pack <span class="hljs-comment">-- PK</span>
    <span class="hljs-keyword">uuid</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, recno <span class="hljs-comment">-- PK</span>
    <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, dt <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">data</span> <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">text</span>
, PRIMARY <span class="hljs-keyword">KEY</span>(pack, recno)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle plaque typique (déjà partitionnée, bien sûr, c'est donc un modèle de section), où le plus important est le texte. Parfois assez volumineux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelons que la taille «physique» d'un enregistrement dans PG ne peut pas occuper plus d'une page de données, mais la taille «logique» est une question complètement différente. Pour écrire une valeur de volume (varchar / text / bytea) dans le champ, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">technologie TOAST est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilisée </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL utilise une taille de page fixe (généralement 8 Ko) et ne permet pas aux tuples de s'étendre sur plusieurs pages. </font><font style="vertical-align: inherit;">Par conséquent, il est impossible de stocker directement de très grandes valeurs de champ. </font><font style="vertical-align: inherit;">Pour surmonter cette limitation, les grandes valeurs de champ sont compressées et / ou divisées en plusieurs lignes physiques. </font><font style="vertical-align: inherit;">Cela se passe inaperçu par l'utilisateur et affecte légèrement la plupart du code du serveur. </font><font style="vertical-align: inherit;">Cette méthode est connue sous le nom de TOAST ...</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, pour chaque table avec des champs "potentiellement volumineux" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, une table couplée est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatiquement </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">créée avec "découpage" de</font></a><font style="vertical-align: inherit;"> chaque enregistrement "volumineux" en segments de 2 Ko:</font></font><br>
<br>
<pre><code class="sql hljs">TOAST(<font></font>
  chunk_id<font></font>
    integer<font></font>
, chunk_seq<font></font>
    integer<font></font>
, chunk_data<font></font>
    bytea<font></font>
, PRIMARY KEY(chunk_id, chunk_seq)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, si nous devons écrire une ligne avec une valeur "grande" </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors le véritable enregistrement se produira </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non seulement dans la table principale et son PK, mais aussi dans TOAST et son PK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réduit l'effet TOAST</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la plupart des enregistrements ici ne sont toujours pas si gros, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ils devraient tenir dans 8 Ko</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - comment économiseriez-vous là-dessus? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici l'attribut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>STORAGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la colonne du tableau </font><font style="vertical-align: inherit;">vient à notre aide </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXTENDED</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet à la fois la compression et le stockage séparé. </font><font style="vertical-align: inherit;">Il s'agit de l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">option standard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la plupart des types de données compatibles TOAST. </font><font style="vertical-align: inherit;">Tout d'abord, une tentative est effectuée pour effectuer la compression, puis elle est enregistrée en dehors du tableau si la ligne est toujours trop grande.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAIN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet la compression, mais pas un stockage séparé. </font><font style="vertical-align: inherit;">(En fait, un stockage séparé sera cependant effectué pour ces colonnes, mais uniquement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en dernier recours</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lorsqu'il n'y a pas d'autre moyen de réduire la ligne pour qu'elle tienne sur la page.)</font></font></li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, c'est exactement ce dont nous avons besoin pour le texte - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serrez-le autant que possible, et même s'il ne correspond pas du tout - mettez-le dans TOAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous pouvez le faire directement "à la volée", avec une seule commande:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawdata_orig <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">SET</span> <span class="hljs-keyword">STORAGE</span> <span class="hljs-keyword">MAIN</span>;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment évaluer l'effet</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que le flux de données change chaque jour, nous ne pouvons pas comparer les nombres absolus, mais en termes relatifs, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus la proportion que</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons enregistrée dans TOAST est </font><b><font style="vertical-align: inherit;">petite</font></b><font style="vertical-align: inherit;"> , mieux c'est. </font><font style="vertical-align: inherit;">Mais il y a un danger - plus le volume «physique» de chaque enregistrement est important, plus l'indice est «large», car plus de pages de données doivent être couvertes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Section </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avant modifications</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (39%)<font></font>
TOAST = 54GB (57%)<font></font>
PK    =  4GB ( 4%)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Section </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">après modifications</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (67%)<font></font>
TOAST = 16GB (29%)<font></font>
PK    =  2GB ( 4%)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, nous avons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commencé à écrire dans TOAST 2 fois moins souvent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ce qui a déchargé non seulement le disque, mais aussi le CPU:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jc/te/dr/jctedr4gcninasuw54qer9qu_8u.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bp/lj/wr/bpljwrysoy42rtnu3ds0btue7ka.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note que nous avons également commencé à «lire» moins le disque, pas seulement à «écrire» - parce que lorsque vous insérez un enregistrement dans une table, vous devez également «soustraire» une partie de l'arborescence de chacun des indices pour déterminer sa position future.</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui sur PostgreSQL 11 vit bien</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après la mise à niveau vers PG11, nous avons décidé de continuer à "régler" TOAST et avons remarqué qu'à partir de cette version, le paramètre devenait disponible pour la configuration </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>toast_tuple_target</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code de traitement TOAST n'est déclenché que lorsque la valeur de la ligne à stocker dans la table est supérieure à TOAST_TUPLE_THRESHOLD octets (généralement 2 Ko). </font><font style="vertical-align: inherit;">Le code TOAST compressera et / ou déplacera les valeurs de champ hors de la table jusqu'à ce que la valeur de la ligne soit inférieure à TOAST_TUPLE_TARGET octets (variable, généralement 2 Ko également) ou qu'il devienne impossible de réduire la taille.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons décidé que les données dont nous disposons habituellement sont soit «très courtes», soit immédiatement «très longues», nous avons donc décidé de nous limiter à la valeur la plus basse possible:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawplan_orig <span class="hljs-keyword">SET</span> (toast_tuple_target = <span class="hljs-number">128</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment les nouveaux paramètres ont affecté le chargement du disque après la migration:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/cz/k7/ppczk7f8qj9cu_hixtltdk_wvo4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pas mal! </font><font style="vertical-align: inherit;">La </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file d'attente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> moyenne </font><b><font style="vertical-align: inherit;">d'un disque a été réduite d'</font></b><font style="vertical-align: inherit;"> environ 1,5 fois, et l'occupation du disque - de 20%! </font><font style="vertical-align: inherit;">Mais peut-être que cela a affecté le processeur?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xa/vj/sq/xavjsqger1hmawiiidzngvzcff0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moins, cela n'a certainement pas empiré. </font><font style="vertical-align: inherit;">Cependant, il est difficile de juger si même de tels volumes ne peuvent toujours pas augmenter la charge CPU moyenne au-dessus de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'un changement de position, la somme ... change!</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, un sou économise un rouble, et avec nos volumes de stockage d'environ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 To / mois,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> même une petite optimisation peut donner un bon profit. Par conséquent, nous avons attiré l'attention sur la structure physique de nos données - comment exactement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les «champs» sont disposés à l'intérieur de l'enregistrement de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chaque table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parce qu'en raison de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'alignement des données,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cela </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affecte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directement </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">le volume résultant</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De nombreuses architectures assurent l'alignement des données au-delà des limites des mots machine. </font><font style="vertical-align: inherit;">Par exemple, sur un système x86 32 bits, les entiers (type entier, occupent 4 octets) seront alignés sur la bordure des mots de 4 octets, ainsi que les nombres à virgule flottante double précision (type double précision, 8 octets). </font><font style="vertical-align: inherit;">Et sur un système 64 bits, les valeurs doubles seront alignées sur la bordure des mots de 8 octets. </font><font style="vertical-align: inherit;">C'est une autre raison de l'incompatibilité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En raison de l'alignement, la taille de la ligne du tableau dépend de l'ordre des champs. </font><font style="vertical-align: inherit;">Habituellement, cet effet n'est pas très visible, mais dans certains cas, il peut entraîner une augmentation significative de la taille. </font><font style="vertical-align: inherit;">Par exemple, si vous placez des champs de types char (1) et entier mélangés, entre eux, en règle générale, 3 octets seront gaspillés pour rien.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par les modèles synthétiques:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span>
, <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span><font></font>
));<font></font>
<span class="hljs-comment">-- 48 </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span>
, <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span><font></font>
));<font></font>
<span class="hljs-comment">-- 46 </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'où venait la paire d'octets supplémentaire dans le premier cas? </font><font style="vertical-align: inherit;">Tout est simple - un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">petit entier de 2 octets est aligné sur une limite de 4 octets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant le champ suivant, et quand c'est le dernier, il n'y a rien et pas besoin de l'aligner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En théorie, tout va bien et vous pouvez réorganiser les champs à votre guise. </font><font style="vertical-align: inherit;">Vérifions les données réelles sur l'exemple de l'une des tables, dont la section quotidienne prend 10-15 Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Structure source:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190220<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  dt date,</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-20'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La section après avoir changé l'ordre des colonnes est exactement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le même champ, seul l'ordre est différent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190221<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  dt date NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-21'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le volume total de la section est déterminé par le nombre de «faits» et dépend uniquement des processus externes, donc nous divisons la taille de heap ( </font></font><code>pg_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) par le nombre d'enregistrements qu'il contient - c'est-à-dire que nous obtenons la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taille moyenne de l'enregistrement stocké réel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jx/6e/im/jx6eimznnvdqtrzp6aohdvxluzs.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moins 6% du volume</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , excellent! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais tout, bien sûr, n'est pas si rose - car </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les indices on ne peut pas changer l'ordre des champs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et donc "en général" ( </font></font><code>pg_total_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/az/3m/6z/az3m6zsyv47wtawrbk_tdmwdpfg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... après tout, ils ont </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">économisé 1,5% ici</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sans changer une seule ligne de code. </font><font style="vertical-align: inherit;">Oui oui!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gb/dr/ps/gbdrpsonli0eclk4ozdjjtofnda.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note que l'agencement des champs ci-dessus n'est pas le fait que le plus optimal. </font><font style="vertical-align: inherit;">Parce que certains blocs de champ ne veulent pas déjà être «déchirés» pour des raisons esthétiques - par exemple, une paire </font></font><code>(pack, recno)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est PK pour cette table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, la définition de l'arrangement de champ "minimum" est une tâche "exhaustive" assez simple. </font><font style="vertical-align: inherit;">Par conséquent, vous pouvez obtenir des résultats sur vos données encore meilleurs que les nôtres - essayez-le!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498280/index.html">L'histoire de l'oiseau Dodo du genre Phoenix. La grande chute de Dodo EST</a></li>
<li><a href="../fr498282/index.html">[instruction] Création d'un compte et d'un site sur la plateforme Google Site</a></li>
<li><a href="../fr498284/index.html">Comment optimiser l'apprentissage de l'anglais</a></li>
<li><a href="../fr498288/index.html">Votre ville a besoin d'un bus de métro</a></li>
<li><a href="../fr498290/index.html">Hydrologie procédurale: simulation dynamique des rivières et des lacs</a></li>
<li><a href="../fr498294/index.html">Détection d'objets Reconnaissez et régnez. Partie 1</a></li>
<li><a href="../fr498296/index.html">Conception au niveau du système. Partie 1. De l'idée au système</a></li>
<li><a href="../fr498298/index.html">Les entreprises utilisent des primes de bogue pour acheter le silence des pirates</a></li>
<li><a href="../fr498300/index.html">Blitz.Engine: Asset System</a></li>
<li><a href="../fr498302/index.html">Licence avancée de l'OIT. Pourquoi est-il nécessaire maintenant?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>