<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧙 🤜🏻 👏🏽 Trucs et astuces de Kubernetes: fonctionnalités d'exécution gracieuses d'arrêt dans NGINX et PHP-FPM 📉 🧜🏼 🌻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une condition typique pour implémenter CI / CD dans Kubernetes: l'application doit être en mesure d'arrêter d'accepter de nouvelles demandes de client...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trucs et astuces de Kubernetes: fonctionnalités d'exécution gracieuses d'arrêt dans NGINX et PHP-FPM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une condition typique pour implémenter CI / CD dans Kubernetes: l'application doit être en mesure d'arrêter d'accepter de nouvelles demandes de clients avant de s'arrêter, et surtout, de terminer avec succès les demandes existantes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ry/ef/karyefzfd99wtpxne9r_o73wies.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le respect de cette condition vous permet de réaliser zéro temps d'arrêt pendant le déploiement. </font><font style="vertical-align: inherit;">Cependant, même lorsque vous utilisez des bundles très populaires (tels que NGINX et PHP-FPM), vous pouvez rencontrer des difficultés qui entraîneront une vague d'erreurs à chaque déploiement ...</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Théorie. </font><font style="vertical-align: inherit;">Comment vit pod</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons déjà publié </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article en</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> détail sur le cycle de vie des pods </font><font style="vertical-align: inherit;">. Dans le cadre de cette rubrique, nous nous intéressons à ce qui suit: au moment où le pod entre dans l'état </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminating</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de nouvelles requêtes lui sont envoyées (le pod </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est supprimé</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la liste des endpoints pour le service). Ainsi, pour éviter les temps d'arrêt lors du déploiement, de notre côté, il suffit de résoudre correctement le problème de l'arrêt de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne faut pas oublier non plus que le délai de grâce est de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 secondes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par défaut </font><font style="vertical-align: inherit;">: après cela, le pod sera arrêté et l'application devrait réussir à traiter toutes les demandes avant ce délai. </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: bien que toute demande qui s'exécute pendant plus de 5 à 10 secondes soit déjà problématique, et un arrêt gracieux ne l'aidera plus ...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pour mieux comprendre ce qui se passe lorsque le pod termine son travail, il suffit d'étudier le schéma suivant: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/pt/ou/zxptou-qe7zxqgab6pszsdo5vlk.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A1, B1 - Obtenir des modifications état du sous </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A2: Envoi de SIGTERM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B2 - Suppression du pod des noeuds finaux </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B3 - Obtention des modifications (la liste des noeuds finaux a changé) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B4 - Mise à jour des règles iptables</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Remarque: la suppression du pod de noeud final et l'envoi de SIGTERM ne se produisent pas séquentiellement, mais en parallèle. Et du fait qu'Ingress ne reçoit pas immédiatement une liste mise à jour des Endpoints, les nouvelles demandes des clients seront envoyées au pod, ce qui provoquera 500 erreurs lors de la terminaison du pod</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(nous avons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traduit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des informations plus détaillées sur cette question </font><font style="vertical-align: inherit;">)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous devez résoudre ce problème de la manière suivante:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Envoyez les en-têtes de Connection: close response (s'il s'agit d'une application HTTP).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S'il n'y a aucun moyen d'apporter des modifications au code, l'article décrit une solution qui vous permettra de traiter les demandes jusqu'à la fin de la période de grâce.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Théorie. </font><font style="vertical-align: inherit;">Comment NGINX et PHP-FPM mettent fin à leurs processus</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par NGINX, car tout est plus ou moins évident avec lui. </font><font style="vertical-align: inherit;">Immergé dans la théorie, nous apprenons que NGINX a un processus maître et plusieurs «travailleurs» - ce sont des processus enfants qui traitent les demandes des clients. </font><font style="vertical-align: inherit;">Une fonctionnalité pratique est fournie: utiliser la commande pour </font></font><code>nginx -s &lt;SIGNAL&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminer les processus soit en mode d'arrêt rapide soit en mode d'arrêt progressif. </font><font style="vertical-align: inherit;">Évidemment, nous nous intéressons précisément à cette dernière option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, tout est simple: vous devez ajouter une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">hook preStop</font></a><font style="vertical-align: inherit;"> qui enverra un signal d'arrêt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">progressif</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cela peut être fait dans Déploiement, dans le bloc conteneur:</font></font><br>
<br>
<pre><code class="plaintext hljs">       lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /usr/sbin/nginx<font></font>
              - -s<font></font>
              - quit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, au moment où le pod termine son travail dans les journaux de conteneur NGINX, nous allons voir ce qui suit:</font></font><br>
<br>
<pre><code class="plaintext hljs">2018/01/25 13:58:31 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down<font></font>
2018/01/25 13:58:31 [notice] 11#11: gracefully shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cela signifiera ce dont nous avons besoin: NGINX attend la fin des requêtes, puis tue le processus. </font><font style="vertical-align: inherit;">Cependant, un problème courant sera discuté ci-dessous, à cause duquel, même s'il existe une commande, le </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus </font><font style="vertical-align: inherit;">ne </font><font style="vertical-align: inherit;">se termine pas correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et à ce stade, nous avons terminé avec NGINX: au moins, vous pouvez comprendre à partir des journaux que tout fonctionne comme il se doit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et PHP-FPM? </font><font style="vertical-align: inherit;">Comment gère-t-il un arrêt progressif? </font><font style="vertical-align: inherit;">Faisons les choses correctement.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de PHP-FPM, un peu moins d'informations. </font><font style="vertical-align: inherit;">Si vous vous concentrez sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manuel officiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de PHP-FPM, il vous indiquera que les signaux POSIX suivants sont reçus:</font></font><br>
<br>
<ol>
<li> <code>SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- arrêt rapide;</font></font></li>
<li> <code>SIGQUIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - arrêt gracieux (ce dont nous avons besoin).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les autres signaux de ce problème ne sont pas nécessaires, par conséquent, leur analyse est omise. </font><font style="vertical-align: inherit;">Pour terminer le processus correctement, vous devrez écrire le hook preStop suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">        lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /bin/kill<font></font>
              - -SIGQUIT<font></font>
              - "1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À première vue, c'est tout ce qui est nécessaire pour effectuer un arrêt progressif dans les deux conteneurs. </font><font style="vertical-align: inherit;">Cependant, la tâche est plus compliquée qu'il n'y paraît. </font><font style="vertical-align: inherit;">Ensuite, nous avons examiné deux cas dans lesquels l'arrêt progressif n'a pas fonctionné et a causé une inaccessibilité à court terme du projet pendant le déploiement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entraine toi. </font><font style="vertical-align: inherit;">Problèmes possibles avec un arrêt progressif</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, il est utile de se souvenir: en plus d'exécuter la commande, </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a une autre étape à laquelle vous devez faire attention. Nous avons rencontré un problème lorsque NGINX au lieu d'un signal SIGQUIT a quand même envoyé SIGTERM, à cause duquel les demandes ne se sont pas terminées correctement. Des cas similaires peuvent être trouvés, par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Malheureusement, nous n'avons pas pu établir une raison spécifique à ce comportement: il y avait un soupçon de la version NGINX, mais cela n'a pas été confirmé. La symptomatologie était que dans les journaux du conteneur NGINX les messages </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"socket ouvert # 10 laissé dans la connexion 5"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ont été observés </font><font style="vertical-align: inherit;">, après quoi le pod s'est arrêté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons observer un tel problème, par exemple, par les réponses à l'entrée dont nous avons besoin: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/sz/ip/umszip1dlpudotn2dstg17qfnzs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicateurs de code d'état au moment du déploiement</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous obtenons uniquement le code d'erreur 503 d'Ingress lui-même: il ne peut pas accéder au conteneur NGINX, car il n'est plus disponible. </font><font style="vertical-align: inherit;">Si vous regardez les journaux du conteneur avec NGINX, ils contiennent les éléments suivants:</font></font><br>
<br>
<pre><code class="plaintext hljs">[alert] 13939#0: *154 open socket #3 left in connection 16<font></font>
[alert] 13939#0: *168 open socket #6 left in connection 13</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir modifié le signal d'arrêt, le conteneur commence à s'arrêter correctement: cela est confirmé par le fait qu'une erreur 503 n'est plus observée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous rencontrez un problème similaire, il est logique de déterminer quel signal d'arrêt est utilisé dans le conteneur et à quoi ressemble exactement le crochet preStop. </font><font style="vertical-align: inherit;">Il est possible que la raison réside précisément dans cela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM ... et plus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème avec PHP-FPM est décrit de manière triviale: il n'attend pas la fin des processus enfants, les termine, à cause de quoi il y a 502 erreurs lors du déploiement et d'autres opérations. Depuis 2005, plusieurs messages d'erreur sur bugs.php.net (par exemple </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) décrivent ce problème. Mais dans les journaux, vous ne verrez probablement rien: PHP-FPM annoncera l'achèvement de son processus sans aucune erreur ou notification tierce. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de préciser que le problème lui-même peut, dans une plus ou moins grande mesure, dépendre de l'application elle-même et peut ne pas apparaître, par exemple, dans la surveillance. Si vous le rencontrez toujours, une solution de contournement simple vient à l’esprit: ajoutez un crochet preStop avec</font></font><code>sleep(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il vous permettra de terminer toutes les demandes précédentes (nous n'en acceptons pas de nouvelles, car le pod est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déjà</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à l'état de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), et après 30 secondes, le pod se terminera avec un signal </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'avère que </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le conteneur, il ressemblera à ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">    lifecycle:<font></font>
      preStop:<font></font>
        exec:<font></font>
          command:<font></font>
          - /bin/sleep<font></font>
          - "30"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, en raison de l'indication de 30 secondes, </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous </font><font style="vertical-align: inherit;">augmenterons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">considérablement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le temps de déploiement, car chaque pod sera interrompu pendant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au moins</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30 secondes, ce qui est mauvais. Que peut-on faire avec ça? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons maintenant au responsable de l'exécution directe de la demande. Dans notre cas, il s'agit de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par défaut ne surveille pas l'exécution de ses processus enfants</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : le processus maître se termine immédiatement. Ce comportement peut être modifié à l'aide d'une directive </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui spécifie les délais d'attente des signaux du maître par les processus enfants. Si vous définissez la valeur sur 20 secondes, cela couvrira la plupart des demandes en cours d'exécution dans le conteneur, et après leur achèvement, le processus maître sera arrêté.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette connaissance, nous reviendrons sur notre dernier problème. Comme déjà mentionné, Kubernetes n'est pas une plateforme monolithique: il faut un certain temps pour l'interaction entre ses différents composants. Cela est particulièrement vrai lorsque nous considérons le travail d'Ingresss et d'autres composants connexes, car en raison d'un tel retard au moment du déploiement, il est facile d'obtenir une rafale de 500 erreurs. Par exemple, une erreur peut se produire au stade de l'envoi d'une demande en amont, mais le «décalage temporel» de l'interaction entre les composants est plutôt court - moins d'une seconde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en conjonction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec la directive déjà mentionnée </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la construction suivante peut être utilisée pour </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">lifecycle:<font></font>
  preStop:<font></font>
    exec:<font></font>
      command: ["/bin/bash","-c","/bin/sleep 1; kill -QUIT 1"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous compensons le retard de l'équipe </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et n'augmentons pas significativement le temps de déploiement: y a-t-il une différence notable entre 30 secondes et une? .. En fait, le «travail principal» est pris en charge </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais n'est </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisé que comme «filet de sécurité» en cas de retard. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De manière générale, le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comportement décrit et la solution de contournement correspondante ne concernent pas uniquement PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une situation similaire peut survenir d'une manière ou d'une autre lors de l'utilisation d'autres langages / frameworks. </font><font style="vertical-align: inherit;">Si vous ne pouvez pas corriger l'arrêt progressif par d'autres moyens - par exemple, réécrivez le code afin que l'application traite correctement les signaux de terminaison - vous pouvez utiliser la méthode décrite. </font><font style="vertical-align: inherit;">Ce n'est peut-être pas le plus beau, mais ça marche.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entraine toi. </font><font style="vertical-align: inherit;">Test de charge pour vérifier les performances du pod</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test de charge est un moyen de vérifier le fonctionnement du conteneur, car cette procédure vous rapproche des conditions de combat réelles lorsque les utilisateurs visitent le site. Vous pouvez utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour tester les recommandations ci-dessus </font><font style="vertical-align: inherit;">: il couvre parfaitement tous nos besoins. Ce qui suit sont des trucs et astuces pour tester avec un clair - grâce aux graphiques de Grafana et Yandex.Tank lui-même - un exemple de notre expérience. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chose la plus importante ici est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de vérifier les changements par étapes.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Après avoir ajouté un nouveau correctif, exécutez le test et voyez si les résultats ont changé par rapport au lancement précédent. Sinon, il sera difficile d'identifier des solutions inefficaces et, à l'avenir, vous ne pourrez que nuire (par exemple, augmenter le temps de déploiement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre mise en garde - regardez les journaux du conteneur lors de sa fermeture. Des informations sur l'arrêt progressif y sont-elles enregistrées? Y a-t-il des erreurs dans les journaux lors de l'accès à d'autres ressources (par exemple, un conteneur PHP-FPM voisin)? Erreurs de l'application elle-même (comme dans le cas de NGINX décrit ci-dessus)? J'espère que les informations d'introduction de cet article aideront à mieux comprendre ce qui arrive au conteneur lors de sa résiliation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le premier test a eu lieu sans </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et sans directives supplémentaires pour le serveur d'applications (</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en PHP-FPM). Le but de ce test était d'identifier le nombre approximatif d'erreurs (et si elles existent). De plus, d'après des informations supplémentaires, il faut savoir que le temps moyen de déploiement de chaque foyer était d'environ 5 à 10 secondes jusqu'à l'état de préparation complète. Les résultats sont les suivants: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/yw/ap/ceywapg8q2kpztr-zdslhjy8brm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une éclaboussure de 502 erreurs est visible sur le panneau d'informations Yandex.Tank, qui s'est produite au moment du déploiement et a duré jusqu'à 5 secondes en moyenne. Vraisemblablement, cela a mis fin aux demandes existantes adressées à l'ancien module lors de sa fermeture. Après cela, 503 erreurs sont apparues, ce qui était le résultat d'un conteneur NGINX arrêté, qui s'est également déconnecté en raison du backend (à cause duquel Ingress n'a pas pu s'y connecter). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en PHP-FPM nous aidera à attendre la fin des processus enfants, c'est-à-dire </font><font style="vertical-align: inherit;">corriger de telles erreurs. </font><font style="vertical-align: inherit;">Déploiement répété à l'aide de cette directive: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/8g/0c/t58g0cs5b6umhjkmvlhjktbkio0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il n'y a plus d'erreurs lors du déploiement des 500! </font><font style="vertical-align: inherit;">Le déploiement est réussi, l'arrêt progressif fonctionne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il convient de se rappeler le moment avec les conteneurs Ingress, un petit pourcentage d'erreurs dans lesquelles nous pouvons obtenir en raison d'un décalage temporel. </font><font style="vertical-align: inherit;">Pour les éviter, il reste à ajouter la construction avec </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et à répéter le déploiement. </font><font style="vertical-align: inherit;">Cependant, dans notre cas particulier, aucun changement n'était visible (pas encore d'erreurs).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'achèvement correct du processus, nous attendons le comportement suivant de l'application:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Attendez quelques secondes, puis arrêtez d'accepter de nouvelles connexions.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Attendez que toutes les demandes soient terminées et fermez toutes les connexions keepalive qui n'exécutent pas les demandes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Terminez votre processus.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, toutes les applications ne peuvent pas fonctionner de cette façon. </font><font style="vertical-align: inherit;">Une solution au problème dans les réalités de Kubernetes est:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajout d'un crochet pré-stop qui attendra quelques secondes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> étudier le fichier de configuration de notre backend pour les paramètres pertinents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple NGINX nous permet de comprendre que même une application qui initialement doit correctement traiter les signaux pour l'achèvement peut ne pas le faire, il est donc essentiel de vérifier 500 erreurs lors du déploiement de l'application. Il vous permet également de regarder le problème plus largement et de ne pas vous concentrer sur un pod ou un conteneur séparé, mais de regarder l'ensemble de l'infrastructure dans son ensemble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Tank peut être utilisé comme outil de test conjointement avec tout système de surveillance (dans notre cas, les données de Grafana avec un backend sous la forme de Prométhée ont été prises pour le test). Les problèmes liés à l'arrêt progressif sont clairement visibles sous de lourdes charges que le benchmark peut générer, et la surveillance permet d'analyser la situation plus en détail pendant ou après le test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Répondre aux commentaires sur l'article: il convient de mentionner que les problèmes et les solutions sont décrits ici en relation avec NGINX Ingress. </font><font style="vertical-align: inherit;">Pour d'autres cas, il existe d'autres solutions que, peut-être, nous considérerons dans les matériaux suivants du cycle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autres du cycle de trucs et astuces de K8:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pages d'erreur personnalisées dans NGINX Ingress</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur l'allocation des nœuds et la charge sur l'application web</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accès aux sites de développement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accélérer le bootstrap des grandes bases de données.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489984/index.html">AMA à propos d'Udalenka: demandez - nous répondons</a></li>
<li><a href="../fr489986/index.html">Utilitaire Power Stage Designer - Power Developer Developer Tool</a></li>
<li><a href="../fr489988/index.html">«Levez les mains en l'air!»: Un examen mono de la dashcam Playme TIO S</a></li>
<li><a href="../fr489990/index.html">Comment Service Desk a-t-il sauvé une société de services ou que se passe-t-il si votre entreprise se développe?</a></li>
<li><a href="../fr489992/index.html">Arrêt correct des pods dans le cluster Kubernetes</a></li>
<li><a href="../fr489998/index.html">11. Mise en route de Fortinet v6.0. Licence</a></li>
<li><a href="../fr490002/index.html">Comment GraphQL sur Kotlin et Micronaut et créer un point d'accès unique à l'API de plusieurs microservices</a></li>
<li><a href="../fr490006/index.html">Programme éducatif pour les spécifications techniques</a></li>
<li><a href="../fr490010/index.html">Examen du système de type pour vérifier l'exactitude de la musique</a></li>
<li><a href="../fr490012/index.html">Alertes et erreurs de stockage, comment les gérer?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>