<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëá üëÉüèø üë©üèæ‚Äçü§ù‚Äçüë®üèª Learn French or how to get a universal adapter from a PSA diagnostic scanner üë®üèª‚Äçüç≥ ü§∫ üë®üèæ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To prevent a decrease in IQ during self-isolation, there was a desire to do something useful for themselves, and if you're lucky - not only. Cutting t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Learn French or how to get a universal adapter from a PSA diagnostic scanner</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498358/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To prevent a decrease in IQ during self-isolation, there was a desire to do something useful for themselves, and if you're lucky - not only. </font><font style="vertical-align: inherit;">Cutting the nth circle around the apartment, my eyes caught on a car scanner, which I took from a friend for further study, namely Lexia 3, aka Actia XS Evolution. </font><font style="vertical-align: inherit;">Here's one: </font></font><br>
<img src="https://habrastorage.org/webt/8k/pd/yu/8kpdyuolcbvw8jvbs03qqbkqtys.jpeg" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Its huge drawback was that only DiagBox software designed to diagnose Peugeout / Citroen cars can work with it. </font><font style="vertical-align: inherit;">It was impossible to put up with the latter (s), therefore the idea arose that if this scanner was forced to send and receive arbitrary messages to the vehicle‚Äôs CAN bus, thereby turning it into a universal adapter.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the action plan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collect USB communication between the PC and our patient.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Understand how communication occurs between the adapter driver and software.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repeat the exchange and feel good (spoiler: it turned out to be a bit more complicated).</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Exchange</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The DiagBox software complex freely surfs the Internet, so there were no difficulties with step 1, especially since it comes with a small utility for identifying the adapter, which somewhat simplified the task from step 2. When receiving an exchange via USB, a trial version of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USBLyzer helped</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are going to success. </font><font style="vertical-align: inherit;">In the picture, the sent data packet, the type of device in the dispatcher, and the same utility. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n_/ev/n1/n_evn1nmme3s8mrog8zea5lj_fu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking at the IRPs when opening the device and exchanging with it, we can conclude that the work is done through the standard Windows I / O mechanism, namely, to open the device‚Äôs virtual file, the CreateFile function and for the exchange, DeviceIOControl.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hz/3r/gr/hz3rgrrv-hbc_h13gg9zluh4m0q.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Debriefing</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data is collected, IOCTL ID and flags are received, it remains the case for small, open the file device and send a packet of bytes there. </font><font style="vertical-align: inherit;">Just open it? </font><font style="vertical-align: inherit;">Search through WinObj did not give any results, when connected, the adapter does not have an exact name, only an implicit link with a constantly changing ID, that is, simply opening a device like a COM port will not work</font></font><br>
<br>
<pre><code class="cpp hljs">CreateFile(<span class="hljs-string">"\\\\.\\COM1"</span>, ...)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Studying the program files made it clear, everything turned out to be quite simple - the adapter has its own unique GUID, with the help of which the operating system is asked for a list of all devices with such a GUID and if they are present, we will get a link to the device, the </font></font><br>
<code>\\?\USB#VID_103A&amp;PID_F000#6&amp;268bff9b&amp;0&amp;7#{75a835f4-d77d-4402-8585-c42247f25b76}\vcommusb0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opening of which will be successful. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Function returning the path instead of the GUID:</font></font><br>
<br>
<pre><code class="cpp hljs">CM_Get_Device_Interface_List(InterfaceClassGuid, pDeviceID, Buffer, BufferLen, ulFlags);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The "file" opens successfully, do not forget about the flags that were obtained via USBLyzer</font></font><br>
<br>
<pre><code class="cpp hljs">Device = CreateFile(DeviceName, GENERIC_WRITE | GENERIC_READ, FILE_SHARE_WRITE | FILE_SHARE_READ, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Final</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We send a packet of bytes, and in response - silence ...</font></font><br>
<br>
<pre><code class="cpp hljs">bStatus = DeviceIoControl(Device, <span class="hljs-number">0x220003</span>, send_buf, send_len, out_buf, max_out_len, &amp;returned_len, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a long time I sat and looked at the monitor, here is the same exchange, here are the responses from the device, here are the flags, exactly the same as I repeated, but nothing comes of it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qw/cy/kx/qwcykx8st4jbyqhrk28d4k5qxcs.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having finally lost all hope of success, I had one last thing - heavy artillery in the form of a disk from the Hacker magazine with the OllyDbg program. </font><font style="vertical-align: inherit;">We start, attach to the process, put the breakpoint on the DeviceIoControl functions and what we see. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/en/nq/cf/ennqcflp-6n8tmii2x1qutuntp8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The king is not real. </font><font style="vertical-align: inherit;">A completely different IOCTL code, the data is not at all like the one seen through USBLyzer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What was sent to the device:</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;b&gt;00 FA&lt;/b&gt; &lt;i&gt;AA&lt;/i&gt; BA 7C 15 00 00 00 00 00 00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And that went over USB:</font></font><br>
<br>
<pre><code class="plaintext hljs">40 05 15 C0 &lt;b&gt;00 FA&lt;/b&gt; 00 00 &lt;i&gt;AA&lt;/i&gt; 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 41</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The hint was in the name of the device visible in the task manager. I found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the </font><font style="vertical-align: inherit;">Microsoft website </font><font style="vertical-align: inherit;">about what a UMDF USB driver is. Clear block diagram: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/wc/gd/d2wcgdfeky6nkjd3oe8x2eh7h8g.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that what we see in USBLyzer is the transport layer of client data transfer, which is implemented in the UMDF driver (direction 7 in the picture), while we transfer data to the device (direction 2 in the picture), which will first go to the driver, and then go to the USB bus. I hope I clearly explained. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it‚Äôs all clear where the other IOCTL IDs and data come from. Well, it‚Äôs even simpler, you don‚Äôt have to rack your brains on how to implement transport, we have the simplest request-response interface. Also in the program files the description of the exchange protocol (partial) was accidentally overloaded, it is a pity only in French.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p1/y4/5e/p1y45e74qzrcfbffatkfde5osxm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to him, in the message above, the firmware version (00 FA) was requested, to which a response was received with the line APPLI_XS_Fuji_ P106138A V4.3.0 @ACTIA 02.01.12. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ALL. </font><font style="vertical-align: inherit;">We configure CAN, send request-response addresses for communication using the ISO-TP protocol and get a fully working adapter with the car. </font><font style="vertical-align: inherit;">For ease of use, a wrapper was written that, as far as possible, complies with the PassThru J2534 standard, so that this adapter can be used with various automotive software, including its own design. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Video of work (stdout is output to the console for debugging convenience):</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/pG5GZoDYQoM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources can be found here</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498340/index.html">About the new IDA Home (review)</a></li>
<li><a href="../en498346/index.html">GoLand 2020.1 - Enhanced support for Go Modules, a lot of auto-completion and much more</a></li>
<li><a href="../en498350/index.html">The best materials for job interviews and job searches</a></li>
<li><a href="../en498352/index.html">SHISHUA: the world's fastest pseudo random number generator</a></li>
<li><a href="../en498354/index.html">How to translate ‚ÄúWishlist‚Äù into ‚Äúhardware‚Äù, or semi-ideal semi-mobile semi-desktop</a></li>
<li><a href="../en498360/index.html">Integrated Server Load Metrics Evaluation</a></li>
<li><a href="../en498362/index.html">Kingston maintains leadership in SSD shipments: how do we do it?</a></li>
<li><a href="../en498366/index.html">What algorithms do Yandex developers implement every day</a></li>
<li><a href="../en498368/index.html">The story of one switch</a></li>
<li><a href="../en498370/index.html">SAP UI5 and Confirmation Windows: Again About the Context</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>