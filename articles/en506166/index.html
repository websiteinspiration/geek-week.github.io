<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô¶Ô∏è üë®‚Äçüë®‚Äçüëß‚Äçüë¶ üìΩÔ∏è Configuring a neural network to detect the necessary objects üë©üèª‚Äçüöí ‚≠êÔ∏è üí§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neural networks are complex mathematical algorithms that help solve a wide range of problems. Before use, they must be set up and trained. Neural netw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Configuring a neural network to detect the necessary objects</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506166/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/8f/2g/g2/8f2gg2qg7j-d7tzt-iykqfgc0qo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neural networks are complex mathematical algorithms that help solve a wide range of problems. Before use, they must be set up and trained. Neural network training is quite a long time and expensive computational process. However, there are tools through which we can simplify these problems. Today we will consider the process of retraining a neural network to detect a specific object in an image. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, we will use the YOLOv3 algorithm to detect objects. You can find additional materials on the article on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . An example of installation and configuration is carried out on Windows 10.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we need to download or clone the necessary materials for retraining the neural network for a specific type of object from this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In order to avoid problems with access or permissions, it is better to place the materials in the directory of your account, for example: C: \ Users \ user_name \ Documents \ NN \. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Go to the yolov3-master folder, call the terminal (command line) and execute the pip install -U -r requirements.txt command. When the command was run, some of the packages were not installed, because in the pip repository for windows, packages with this name do not exist. For the installation to succeed, in requirements.txt we need to comment out several packages ("torch&gt; = 1.5" and "pycocotools"). Then install pytorch with the following command:</font></font><a name="habracut"></a><br>
<br>
<pre><code class="python hljs">pip install torch==<span class="hljs-number">1.5</span><span class="hljs-number">.0</span> torchvision==<span class="hljs-number">0.6</span><span class="hljs-number">.0</span> -f https://download.pytorch.org/whl/torch_stable.html</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The pycocotools package is not needed in our case. It is also necessary to download and install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUDA tools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so that your calculations take place on the video card, which at times increases the speed of retraining.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. After the installation is successfully completed, we can begin to prepare the data. For the algorithm to work better, photographs for training must be taken from the materials on which the processing will be performed. For example, it is necessary to process video materials from surveillance cameras that are installed in a room where objects are located at a large angle. In such a situation, it will be very difficult to train an algorithm for detecting objects that are very different from pictures on the Internet on which a neural network was trained. Thus, the training sample is compiled either from screen shots using video materials, or using manual shooting with a camera. The size of the training sample can vary greatly, it all depends on the nature of the task. In this example, the data set consists of 46 images, which depict three types of objects (pen, pencil, marker).Photographing was carried out against the background of the table and A4 sheet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. The next step is to mark the objects in the image. </font><font style="vertical-align: inherit;">However, before starting the markup, it is necessary to increase the training sample using several augmentation methods. </font><font style="vertical-align: inherit;">This is important for improving the ability of a neural network to recognize objects in various variations. </font><font style="vertical-align: inherit;">A few examples of augmentation can be found in this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notebook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Upon completion of the augmentation, we combine the original images with the augmentation result into one folder (it is important that the images should be located in the root of the yolov3_master folder, for example: C: \ Users \ user_name \ Documents \ NN \ yolov3_master \ images \). </font><font style="vertical-align: inherit;">Next, using the labelImg program, we mark up the objects, sequentially performing the following steps:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z5/kt/dd/z5ktddwmvl-ulta3vsbva2macvs.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select the folder with images (... \ yolov3_master \ images \);</font></font></li>
<li>    .       labels,       (‚Ä¶.\yolov3_master\labels\);</li>
<li>   c PascalVOC  YOLO;</li>
<li>    ;</li>
<li>   ,     ;</li>
<li>       (Pen, Pencil, Marker),            ;</li>
<li>;</li>
<li> ;</li>
<li>       4 ‚Äì 8.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, text documents with image names appear in the labels folder, which contain the class label and four coordinates - the normalized values ‚Äã‚Äãx, y, w, h, which describe the location of the rectangle for each object in the image (1 is the line number in the Notepad ++ editor and does not apply to the contents of the document): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7c/t8/ws/7ct8wsuqhzfhzkupfd1ntjyc3j0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Next, we need to divide the prepared sample into a training and a test one. In this case, it is necessary to create 2 text documents (train_112.txt and test_24.txt), which will indicate the full location path for each image. An example of creating documents can be found in a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notebook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. In order for the desired objects to be named, you must create a file with the extension .names, for example objects.names, which lists the names in the same order as indicated in classes.txt in the labels folder. It looks something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ex/0h/g1/ex0hg17zt5nnqgyxn-qoeasf9ak.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to create a file with the extension .data, for example conf.data, which indicates the number of classes (in this example 3), files with the names of objects, and also files with the location of the images for the training and test samples: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/e8/z6/i-e8z6pmganhasy40yick2wjhx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Files objects. names, conf.data and subsequent files must be placed in the following directory: yolov3_master \ data \, having previously deleted all files from it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. For retraining, you need to configure the configuration file, for this from the folder (... \ yolov3_master \ cfg) copy the file yolov3-spp.cfg to the folder (... \ yolov3_master \ data). Next, you need to edit the lines (636,643 - 722,729 - 809,816) for each of the three layers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gn/ef/w5/gnefw5t095nq8jgbxkopwlmh1um.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where, filters = (5 + n) * 3 and classes = n. n is the number of classes (in this example 3). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Next, you need to download the weights for the configured configuration file. To do this, </font><font style="vertical-align: inherit;">download the yolov3-spp.pt file </font><font style="vertical-align: inherit;">from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and place it in (... \ yolov3_master \ data). For example, the yolov3-spp algorithm is used. However, there are several variations of the algorithm, for example, yolov3-tiny, which is a light version of yolov3-spp. The light version is less accurate, but the material processing speed is much higher.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. We proceed directly to the retraining of the algorithm for your object type. To do this, in the folder ... \ yolov3_master \ run the command line and enter the following command:</font></font><br>
<br>
<pre><code class="python hljs">python train.py --cfg data/yolov3-spp.cfg --data data/conf.data --weights data/yolov3-spp.pt --nosave</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After running the command, an error of the following nature may occur: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/or/bg/hk/orbghkbzcmnaktnvp6fhpsnlwgy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem, it is necessary to comment out lines in the utils.py file in the utils folder: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y3/k1/51/y3k151rlmya3guveav5c8o2xk8i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the body of the check_git_status function, we comment out all lines except print, into which we will pass any line, for example, ‚Äúss‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An error of the following type may also appear: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0v/t7/1w/0vt71wd0snopl_cvxl17tyyl0gu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This error indicates that there is not enough video card memory to build a computational graph. One way to solve this problem is to reduce the size of the batch during training. To do this, in the file (... \ yolov3_master \ train.py) you need to change the batch_size parameter, the default is 16, change to a lower value (8 or 4) multiple of 4: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/gk/yy/r3gkyy0ua0bfoyae5dmduxn3qtg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also pass this value explicitly, using the parameter value during initialization:</font></font><br>
<br>
<pre><code class="python hljs">python train.py --cfg data/yolov3-spp.cfg --data data/conf.data --weights data/yolov3-spp.pt --batch-size <span class="hljs-number">4</span> --nosave</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the example above, we specified a configuration file, a file with information about the training set, weights, and a save option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The --nosave parameter indicates that only the final file with the scales will be saved. You can also set the save mode in the train.py file, for example, if you want to save weights every 400 epoch:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s3/di/ax/s3diaxobwljgntbmhpnj3lxzoda.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also important to specify the --epochs parameter, the number of eras depends on the type of objects, the size of the training sample, and other factors. In this example, initially there were 46 images, using augmentation methods the data set was increased to 136, of which 112 were a training sample, 24 were a test sample. The calculations were carried out on a GTX 1060 6 GB graphics card. The first attempt was carried out for 300 eras, the training took about 2.5 hours. Revealed a very poor accuracy of the algorithm. The second attempt was carried out for 1200 eras, the training took ~ 12 hours. Upon completion of training, weights will be saved in the folder (... \ yolov3_master \ weights \) ‚Äã‚Äã- file last.pt. In order to check the operability of the algorithm, you must run the following command:</font></font><br>
<br>
<pre><code class="python hljs">python detect.py --weights weights/last.pt --cfg data/yolov3-spp.cfg --names data/objects.names</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before running the command, you must place the images for processing by the algorithm in the folder (... \ yolov3_master \ data \ samples \). </font><font style="vertical-align: inherit;">The result will appear in the folder (... \ yolov3_master \ output \). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/vo/bd/nwvobdpaqfbon5cnxlog7hebkgq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, a retraining of the finished neural network was carried out, which was able to determine 80 classes of objects for the new 3 types of objects that were not included in this list. </font><font style="vertical-align: inherit;">For the marker object, the algorithm is not entirely accurate; confidence is less than 0.5. </font><font style="vertical-align: inherit;">One of the reasons may be the small size of the training sample, because </font><font style="vertical-align: inherit;">in this example, images with markers were 26%, the rest are pens and pencils.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506148/index.html">The science of color perception turns our relationship with screens</a></li>
<li><a href="../en506150/index.html">Hit the SETI: voluntary computing for skeptics, optimists, and sophisticated crunchers</a></li>
<li><a href="../en506152/index.html">Collecting metrics from a "foreign" class using jmx and javaassist as javaagent</a></li>
<li><a href="../en506158/index.html">useSWR is my new favorite React library</a></li>
<li><a href="../en506164/index.html">#nodesigndev: design by the hands of developers</a></li>
<li><a href="../en506168/index.html">Great guide to Google Trends: how to read all these statistics and learn how to catch trends</a></li>
<li><a href="../en506170/index.html">Abstract data type. Part 1: Data (Data Type)</a></li>
<li><a href="../en506176/index.html">Creaform 3D Scanner Overview</a></li>
<li><a href="../en506178/index.html">Trends Changing the Future of Software Testing: Expert Opinion</a></li>
<li><a href="../en506180/index.html">How to choose the right power for your UPS. We analyze the example of Eaton</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>