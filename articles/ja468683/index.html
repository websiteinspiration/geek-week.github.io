<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍍 💪🏿 👇 Dockerサービスの標準化の理論と実践 🏐 👲🏼 ⛹🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今日すでにマイクロサービスアプリケーションアーキテクチャのトピックについての情報は、そのエッジを埋めることができましたが、それがあなたの製品に適しているかどうかを決定するのに今日十分に十分です。そして、この道を選択することを決定した企業が多くの工学的および文化的課題に直面しなければならないことは全く...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Dockerサービスの標準化の理論と実践</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日すでにマイクロサービスアプリケーションアーキテクチャのトピックについての情報は、そのエッジを埋めることができましたが、それがあなたの製品に適しているかどうかを決定するのに今日十分に十分です。</font><font style="vertical-align: inherit;">そして、この道を選択することを決定した企業が多くの工学的および文化的課題に直面しなければならないことは全く秘密ではありません。</font><font style="vertical-align: inherit;">問題の原因の1つは、あらゆる場所で増加しているオーバーヘッドであり、これは、生産プロセスに関連するルーチンにも同様に当てはまります。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>
<sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像ソース：</font></font></a></em></sub></p><br>
<p>  ,  –    ,    ,      .      ,      .            ,    DevOps-           ,          ,  , .</p><a name="habracut"></a><br>
<p>     ,      -,        ,      :         ,        .</p><br>
<p>               ,        .       ,       ,          ,       ,    -  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> «  »  .</p><br>
<p>,   « »      ,              .     ,       ,    ,                 .  ,              .    , ,         . ,            ,         ,  ,   .          ,        ,      ,     .</p><br>
<p>   ,       ,         end-to-end      (  ).</p><br>
<p></p><div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text">      « »,    ,          .       ,         , :<br>
<br>
 —     90%    C#;<br>
 —      ,   ,    –  —       ;<br>
 —   .NET ,    ,  (   );<br>
 —      CI-,   vendor lock-in;<br>
 —   .NET   «», «»  «»        ,       .</div></div><br>
<h2 id="nemnogo-predystorii"> </h2><br>
<p> 2017-  Microsoft    .NET Core 2.0,    C#-      Linux, …</p><br>
<p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>
<sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> :</a></em></sub></p><br>
<p>  ,   ,       Windows,   Linux,   -   SSH,    CI/CD     .     ,   -  .   ,        .            .</p><br>
<p>           ,  ,          ,       .</p><br>
<p>-,                   ,      ,         .    - ,       ,    .</p><br>
<p>-,    ,       , ,   ,       .   ,  «- »,      .  , -      ,       .      docker-,     , -     .   ,  ,     ,                 .</p><br>
<p> -,  ,              ,                    .  ,     ,      ,     ,        .   ,         ,       CI,      .</p><br>
<p>  ,   -       ,   ,            docker-       ,     ,    continuous.</p><br>
<h2 id="cli-vs-gui">CLI vs. GUI</h2><br>
<p>    ,     ,   .       :          (   Bitbucket)       .  ,   ,       .        .</p><br>
<p>,     :</p><br>
<ul>
<li>    ,     ,  ,   pull-  ..;</li>
<li>    ,  :<br>
<ul>
<li>       <code>SolutionInfo.props</code> (  );</li>
<li>     <code>src</code>;</li>
<li><code>.gitignore</code>, <code>README.md</code>  ..;</li>
</ul></li>
<li>  Git-;</li>
<li>       .</li>
</ul><br>
<p>  Bitbucket REST API      ,          –  .   «-»               ,  :</p><br>
<ul>
<li>   Bitbucket,   ;</li>
<li>      ;</li>
<li>   ,       ;</li>
<li>    (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">dotnet templating</a>)       ;</li>
<li>           <code>*.md</code> ;</li>
<li>    CI/CD  (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Bamboo Specs</a>)   .</li>
</ul><br>
<p> , ,   ,  ,   ,     , ,   «Hello world!» ,     CI-,      ,   ,    .</p><br>
<p>  .     ,  ,   .    ,    .</p><br>
<h2 id="struktura"></h2><br>
<p>            ,    CI    .     ,    CI     ,   , ,       .  ,               CI,      .  ,         ,    Git-     . ,   .  ,   ,     <code>build.sh</code>,        ,  .   ,  ,     <em>SampleService</em>      <em>Sandbox</em>.</p><br>
<pre><code class="plaintext hljs">.<font></font>
├── [bamboo-specs]<font></font>
├── [devops.build]<font></font>
│ ├── build.sh<font></font>
│ └── ...<font></font>
├── [docs]<font></font>
├── [.scripts]<font></font>
├── [src]<font></font>
│ ├── [CodeAnalysis]<font></font>
│ ├── [Sandbox.SampleService]<font></font>
│ ├── [Sandbox.SampleService.Bootstrap]<font></font>
│ ├── [Sandbox.SampleService.Client]<font></font>
│ ├── [Sandbox.SampleService.Tests]<font></font>
│ ├── Directory.Build.props<font></font>
│ ├── NLog.config<font></font>
│ ├── NuGet.Config<font></font>
│ └── Sandbox.SampleService.sln<font></font>
├── .gitattributes<font></font>
├── .gitignore<font></font>
├── .gitmodules<font></font>
├── CHANGELOG.md<font></font>
├── README.md<font></font>
└── SolutionInfo.props</code></pre><br>
<p>   –   Git. <code>bamboo-specs</code> –  «Pipeline as Code»  CI- Atlassian Bamboo (      - Jenkinsfile), <code>devops.build</code> –   ,     .       <code>.scripts</code>.  <code>src</code>   .NET : <code>NuGet.Config</code>    <acronym>NuGet</acronym>-, <code>NLog.config</code> – dev-time  <acronym>NLog</acronym>.   ,  NLog   –     .    –     <code>Directory.Build.props</code>. -        .NET ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.   ,     <code>Directory.Build.props</code>  <code>Directory.Build.targets</code>                . ,       code-style  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">StyleCop.Analyzers</a>      <code>CodeAnalysis</code>,            (<em>Company</em>, <em>Copyright</em>  ..),      <code>&lt;Import&gt;</code>  <code>SolutionInfo.props</code>,          ,     .      ,   , URL    ,    ,           .</p><br>
<div class="spoiler"><b class="spoiler_title"> `SolutionInfo.props`</b><div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Project</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">"devops.build/SolutionInfo.xsd"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Product name --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Product</span>&gt;</span>Sandbox.SampleService<span class="hljs-tag">&lt;/<span class="hljs-name">Product</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BaseVersion</span>&gt;</span>0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">BaseVersion</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">EntryProject</span>&gt;</span>Sandbox.SampleService.Bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">EntryProject</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Exposed port --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ExposedPort</span>&gt;</span>4000/tcp<span class="hljs-tag">&lt;/<span class="hljs-name">ExposedPort</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">GlobalizationInvariant</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">GlobalizationInvariant</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Project URL --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">RepositoryUrl</span>&gt;</span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag">&lt;/<span class="hljs-name">RepositoryUrl</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">DocumentationUrl</span>&gt;</span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag">&lt;/<span class="hljs-name">DocumentationUrl</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Your name here --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Authors</span>&gt;</span>User Name <span class="hljs-symbol">&amp;lt;</span>username@contoso.com<span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Authors</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Project description --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Description</span>&gt;</span>The sample service for demo purposes.<span class="hljs-tag">&lt;/<span class="hljs-name">Description</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BambooBlanKey</span>&gt;</span>SMPL<span class="hljs-tag">&lt;/<span class="hljs-name">BambooBlanKey</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"> `Directory.Build.props`</b><div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">Project</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Import</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"Exists('..\SolutionInfo.props')"</span> <span class="hljs-attr">Project</span>=<span class="hljs-string">"..\SolutionInfo.props"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">None</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span> 
      <span class="hljs-attr">Link</span>=<span class="hljs-string">"stylecop.json"</span>
      <span class="hljs-attr">CopyToOutputDirectory</span>=<span class="hljs-string">"Never"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"StyleCop.Analyzers"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"1.*"</span> <span class="hljs-attr">PrivateAssets</span>=<span class="hljs-string">"all"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CodeAnalysisRuleSet</span>&gt;</span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag">&lt;/<span class="hljs-name">CodeAnalysisRuleSet</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">GenerateDocumentationFile</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">GenerateDocumentationFile</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">LangVersion</span>&gt;</span>latest<span class="hljs-tag">&lt;/<span class="hljs-name">LangVersion</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- default base version --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BaseVersion</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(BaseVersion)' == ''"</span>&gt;</span>0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">BaseVersion</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- default build number and format --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BuildNumber</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(BuildNumber)' == ''"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">BuildNumber</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BuildNumber</span>&gt;</span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag">&lt;/<span class="hljs-name">BuildNumber</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- default version suffix --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">VersionSuffix</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(VersionSuffix)' == ''"</span>&gt;</span>local<span class="hljs-tag">&lt;/<span class="hljs-name">VersionSuffix</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">VersionSuffix</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">VersionSuffix</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- format version prefix --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">VersionPrefix</span>&gt;</span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag">&lt;/<span class="hljs-name">VersionPrefix</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">IsPackable</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">IsPackable</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageProjectUrl</span>&gt;</span>$(RepositoryUrl)<span class="hljs-tag">&lt;/<span class="hljs-name">PackageProjectUrl</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Company</span>&gt;</span>Contoso<span class="hljs-tag">&lt;/<span class="hljs-name">Company</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Copyright</span>&gt;</span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag">&lt;/<span class="hljs-name">Copyright</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span></code></pre></div></div><br>
<h2 id="sborka"></h2><br>
<p>  ,     ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.   ,        ,    ,     ,            legacy-.      ,             docker-,         ,     .</p><br>
<p>   .        -  Linux,    Windows-  ,         .             .NET :  MSBuild      XML,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Psake</a> (Powershell),   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">FAKE</a> (F#).      -   .  ,   ,           ,        -   Docker CLI  Git,           Dockerfile.<br>
    FAKE 5,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Cake</a>  .NET Core     ,          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PowerShell 6 Core</a>  ,     .       Psake,   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Invoke-Build</a>,    Psake ,    ,  ,    .   .           ,  ,               :</p><br>
<ul>
<li>      (tasks),          .</li>
<li>   , , exec {}       .</li>
<li>      Ctrl+C        Exit-Build. ,      ,       .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br>
<h2 id="universalnyy-dockerfile"> Dockerfile</h2><br>
<p>   Dockerfile     <code>docker build</code>     ,        ,    .   ,      «» ,  ,  ,     .  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Microsoft</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Dockerfile</a>,           Dockerfile,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">multi-stage</a>     «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Test Runner</a>»    .</p><br>
<h2 id="multi-stage-pattern-i-argumenty">Multi-stage   </h2><br>
<p>           . ,    <code>dotnet build</code>   ,    ,   ,     <code>dotnet publish</code>. ,   ,       , <br>
<code>dotnet build --target &lt;name&gt;</code><br>
,    ,   .     NuGet-,  ,  runtime-   .</p><br>
<p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br>
<p>   ,   feature-.       ,      healthcheck.</p><br>
<p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br>
<p>,    –     .     Dockerfile  <code>ARG</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   ,        .</p><br>
<pre><code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2<font></font>
ARG ALPINE_VERSION=<font></font>
ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION}<font></font>
ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION}<font></font>
FROM ${BUILD_BASE} AS restore<font></font>
...<font></font>
FROM ${RUNTIME_BASE} AS runtime<font></font>
...</code></pre><br>
<p>           . -,       ASP.NET Core ,  runtime-   : <code>mcr.microsoft.com/dotnet/core/aspnet</code>.           <code>SolutionInfo.props</code>        .          .NET ore : , ,    ( !).</p><br>
<p>-,      «» Dockerfile,      ,         runtime-. ,      JavaScript  Vue.js,       ,      «» Dockerfile:</p><br>
<pre><code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2<font></font>
ARG ALPINE_VERSION=<font></font>
ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION}<font></font>
<font></font>
FROM node:alpine AS install<font></font>
WORKDIR /build<font></font>
COPY package.json .<font></font>
RUN npm install<font></font>
<font></font>
FROM install AS src<font></font>
COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"]<font></font>
COPY ClientApp ./ClientApp<font></font>
<font></font>
FROM src AS publish<font></font>
RUN npm run build-prod<font></font>
<font></font>
FROM ${RUNTIME_BASE} AS appbase<font></font>
COPY --from=publish /build/wwwroot/ /app/wwwroot/</code></pre><br>
<p>    ,      runtime- ASP.NET     RUNTIME_BASE.      ,   ,   ,      <code>docker build</code>.    Volume? :</p><br>
<pre><code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2<font></font>
ARG ALPINE_VERSION=<font></font>
ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION}<font></font>
<font></font>
FROM ${RUNTIME_BASE} AS runtime<font></font>
ARG VOLUME<font></font>
VOLUME ${VOLUME}</code></pre><br>
<p>   Dockerfile  ,   VOLUME  .       .</p><br>
<h2 id="zapusk-testov"> </h2><br>
<p>              «Test Runner» .     , ,   :</p><br>
<ul>
<li>   ,   -   ;</li>
<li>           ,       CI ;</li>
<li>    ,       <code>docker run --network &lt;test_network_name&gt;</code>.</li>
</ul><br>
<p>  ,         ,   .  , ,  <code>docker-compose.yaml</code>,       .           ,       ,     .</p><br>
<p> runtime-      healthcheck,     .       ,        .</p><br>
<p> ,    runner-,     <code>dotnet build</code>,       <code>dotnet publish</code>, <code>dotnet pack</code>  <code>dotnet nuget push</code>.       .</p><br>
<h2 id="healthcheck-i-zavisimosti-os">Healthcheck   </h2><br>
<p>   ,        - .                  healthcheck.      Web-    curl,   gRPC- ,  , headless    ,        .</p><br>
<p>         ,       ,       :</p><br>
<pre><code class="plaintext hljs">.scripts<font></font>
├── healthcheck.sh<font></font>
├── run.sh<font></font>
└── runtime-deps.sh</code></pre><br>
<p> <code>healthcheck.sh</code>    ,    :</p><br>
<ul>
<li><p> Web   curl:</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/ash</span>
<span class="hljs-built_in">set</span> –e<font></font>
curl -sIf -o /dev/null -w <span class="hljs-string">"%{http_code}\n"</span> 127.0.0.1/health || <span class="hljs-built_in">exit</span> 1</code></pre><br>
</li>
<li><p>     cli :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/ash</span>
<span class="hljs-built_in">set</span> –e<font></font>
healthcheck || <span class="hljs-built_in">exit</span> 1</code></pre><br>
</li>
</ul><br>
<p>  <code>runtime-deps.sh</code>   ,  ,       ,       .  :</p><br>
<ul>
<li><p> Web :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/ash</span>
apk add --no-cache curl icu-libs</code></pre><br>
</li>
<li><p> gRPC :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/ash</span>
apk add --no-cache libc6-compat</code></pre><br>
</li>
</ul><br>
<p>        ,      .   <code>run.sh</code>,   .</p><br>
<h2 id="entrypoint-skript">Entrypoint </h2><br>
<p>,  ,      Dockerfile,  ,     – <code>CMD</code>  <code>ENTRYPOINT</code>.  ,         ,        .      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.   ,   99%    ENTRYPOINT  exec-:</p><br>
<p>ENTRYPOINT ["/path/to/executable"]</p><br>
<p>  ,        ,   SIGTERM  ..,        -  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> PID 1</a>.   ,    ,   ? ,    :<br>
<code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code><br>
     , ?    :   !  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">entrypoint-</a>.        (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>) ,    ,  .</p><br>
<p>       ,      :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">set</span> -e
<span class="hljs-keyword">if</span> [ ! -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ] &amp;&amp; $(<span class="hljs-built_in">command</span> -v <span class="hljs-variable">$1</span> &gt;/dev/null 2&gt;&amp;1)
<span class="hljs-keyword">then</span>
  <span class="hljs-built_in">exec</span> <span class="hljs-variable">$@</span> 
<span class="hljs-keyword">else</span>
  <span class="hljs-built_in">exec</span> /usr/bin/dotnet /app/<span class="hljs-variable">${ENTRY_PROJECT}</span>.dll <span class="hljs-variable">$@</span>
<span class="hljs-keyword">fi</span></code></pre><br>
<p>      :<br>
<code>docker run &lt;image&gt; env</code> –   env  ,   .<br>
<code>docker run &lt;image&gt; -param1 value1</code> –     .</p><br>
<p>      <code>exec</code>:            PID 1   .</p><br>
<h2 id="chto-esche"> </h2><br>
<p>,             .        ,    ,        «» .    ,           :</p><br>
<ul>
<li>    : ,  ,   ,   .</li>
<li> runtime-   NLog,              json,    .</li>
<li>         .</li>
</ul><br>
<p> , ,     .       . ,            cli .       ,           .NET ,      (,  <code>healthcheck</code>).</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>        .     ,     ,        ,      ,      ,    .        .          ,  .</p><br>
<p>            ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           .</p><br>
<p>,    !   ,    «  »,       ,             .      ,    Docker        .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468663/index.html">自動音声認識タスクでのEnd2 Endアプローチ</a></li>
<li><a href="../ja468665/index.html">かんがい器を買う時が来ていませんか？</a></li>
<li><a href="../ja468673/index.html">ワークショップ「個人データのセキュリティの確保」-10月3日、サンクトペテルブルク</a></li>
<li><a href="../ja468677/index.html">スマートフォンXiaomi Mi Mix Alphaの発表</a></li>
<li><a href="../ja468679/index.html">KubernetesのセキュリティのABC：認証、承認、監査</a></li>
<li><a href="../ja468685/index.html">音響心理学、ロスレス、およびオーディオ標準について他に何を知っていますか</a></li>
<li><a href="../ja468687/index.html">株式市場を規制するための中央銀行の新しい取り組みを分析します：投資家の3つのグループ、初心者向けの制限</a></li>
<li><a href="../ja468689/index.html">シンガポールでのITビジネスの登録：どうすればよいですか？</a></li>
<li><a href="../ja468691/index.html">システムまたはLOLDrivers上の危険なサードパーティドライバー</a></li>
<li><a href="../ja468693/index.html">自動化がウォルマートの従業員を破壊する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>