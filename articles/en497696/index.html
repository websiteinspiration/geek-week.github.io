<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêç üåõ ‚òÑÔ∏è How does Ryuk ransomware that attacks enterprises ü§ôüèæ üåâ üö¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ryuk is one of the most well-known ransomware options in the last few years. Since he first appeared in the summer of 2018, he has compiled an impress...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How does Ryuk ransomware that attacks enterprises</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497696/"><img src="https://habrastorage.org/webt/wc/6r/b3/wc6rb3xxu-e_aw_mg1pxcy_23yq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk is one of the most well-known ransomware options in the last few years. </font><font style="vertical-align: inherit;">Since he first appeared in the summer of 2018, he has compiled </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an impressive list of victims</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , especially in the business environment, which is the main target of his attacks.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. General information</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This document contains an analysis of the Ryuk ransomware option, as well as the bootloader responsible for downloading the malware to the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk ransomware first appeared in the summer of 2018. One of the differences between Ryuk and other ransomware is that it aims to attack corporate environments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In mid-2019, cyber-crime groups attacked a huge number of Spanish companies with the help of this cryptor. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x5/ax/et/x5axetxacru5kb7h6er1vagmdqy.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font></font><br>
</i><br>
<img src="https://habrastorage.org/webt/oc/kn/ee/ockneevf4elmwczdwsmimtsvnuk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure </font></font><br>
</i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">1: Excerpt from El Confidencial regarding Ryuk ransomware attack [1] </font></i><i><font style="vertical-align: inherit;">2: Excerpt from El Pa√≠s about an attack by Ryuk ransomware [2]</font></i></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This year, Ryuk attacked a large number of companies in different countries. As you can see in the figures below, Germany, China, Algeria and India suffered the most.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comparing the number of cyber attacks, we can see that millions of users were affected by Ryuk and the huge amount of data was compromised, resulting in serious economic damage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/4u/y-/-p4uy-fnectlv0mqwtvupfa--vc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 3: Illustration of Ryuk's global activity. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/sq/oe/hm/sqoehmto6enrwgz6kjt4_sdpgz0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 4: 16 countries most affected by Ryuk </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/qj/1_/d2/qj1_d2eze5bigcd0gqvvrwiw9ns.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 5: The number of users attacked by Ryuk ransomware (in millions)</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
According to the usual principle of the operation of such threats, this ransomware after encryption shows the victim a ransom notification that must be paid in bitcoins to the specified address to restore access to encrypted files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This malware has changed since it first appeared.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A variant of this threat analyzed in this document was discovered during an attempt to launch an attack in January 2020. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to its complexity, this malware is often attributed to organized cybercriminals, also known as APT groups. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part of the Ryuk code has a noticeable resemblance to the code and structure of another well-known Hermes cryptographer, with which they have a number of identical functions. That is why Ryuk was initially associated with the North Korean group Lazarus, which at that time was suspected of being behind the Hermes ransomware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subsequently, CrowdStrike‚Äôs Falcon X noted that Ryuk was actually created by WIZARD SPIDER [4].</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is some evidence to support this assumption. Firstly, this ransomware was advertised on the exploit.in website, which is a well-known Russian malware market and was previously associated with some Russian APT groups. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This fact excludes the theory that Ryuk could be developed by the Lazarus APT group, as this does not match the way the group acts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, Ryuk was touted as an encryptor that will not work on Russian, Ukrainian and Belarusian systems. This behavior is determined by the function found in some versions of Ryuk, where it checks the language of the system in which this encryptor is running and stops its operation if the system has Russian, Ukrainian or Belarusian. Finally, when conducting an expert analysis of a machine that was hacked by the WIZARD SPIDER group, several ‚Äúartifacts‚Äù were discovered that were supposedly used in the development of Ryuk as a variant of the Hermes ransomware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the other hand, experts Gabriela Nicolao and Luciano Martins suggested that the cryptographer might have been developed by the CryptoTech APT team [5].</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This follows from the fact that a few months before the appearance of Ryuk, this group posted information on the forum of the same site that they had developed a new version of the Hermes ransomware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several forum users have wondered if CryptoTech really created Ryuk. </font><font style="vertical-align: inherit;">After that, this group defended itself and stated that it had evidence that they had developed 100% of this encryptor.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Characteristics</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start with the bootloader, whose task is to identify the system in which it is located, so that you can run the ‚Äúcorrect‚Äù version of the Ryuk encryptor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The bootloader hash is as follows: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MD5 A73130B0E379A989CBA3D695A157A495 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SHA256 EF231EE1A2481B7E627921468E79BB4369CCFAEB19A575748DD2B664ABC4F469 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the features of this bootloader is that it does not contain any data - the creators of this malware did not include any information in it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes they include erroneous data in order to make the user think that he is allegedly launching a legitimate application. </font><font style="vertical-align: inherit;">However, as we will see later, in the event that the infection does not involve interaction with the user (as is the case with this encryptor), then the attackers do not consider it necessary to use meta-data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rj/zx/yu/rjzxyuaec1nfxajxzwufks4hb0w.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">6:</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sample </font><i><font style="vertical-align: inherit;">meta data The sample</font></i><font style="vertical-align: inherit;"> was compiled in 32-bit format so that it can be run on both 32-bit and 64-bit systems.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Penetration vector</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sample that downloads and launches Ryuk entered our system through a remote connection, and the access parameters were obtained thanks to a preliminary RDP attack. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pt/jd/bj/ptjdbj8ce7mgfuy8vowq8gogitm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 7: Attack Registry An</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
attacker managed to log into a system remotely. After that, he created an executable file with our sample. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This executable file was blocked by an antivirus solution before launch. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ez/gj/gq/ezgjgq4iagc2lep3pebhom5cox0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 8: Blocking the sample </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/tg/zv/-k/tgzv-keet96r81465eywpeahn8a.jpeg"><br>
<img src="https://habrastorage.org/webt/c_/0j/wz/c_0jwzu0madpx1t-pmfdznt-xny.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 9: Sample Lock</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When a malicious file was blocked, the attacker tried to download an encrypted version of the executable file, which was also blocked. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/za/f8/mh/zaf8mhwwbu4rr9u_elmazc9cmns.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 10: A set of samples that an attacker tried to run</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Finally, he tried to download another malicious file through an encrypted console</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PowerShell in order to bypass anti-virus protection. </font><font style="vertical-align: inherit;">But he was also blocked. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lw/4b/mj/lw4bmjqpqtkf1zrqhhe0zb-4rzm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">11: PowerShell with the blocked malicious content </font></font><br>
</i><br>
<img src="https://habrastorage.org/webt/eu/dj/he/eudjheox40zpaop3cphprkuc-5c.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">12: PowerShell with blocked malicious content</font></font><br>
 </i><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Bootloader</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When it is executed, it writes the ReadMe file to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% temp%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">, which is typical of Ryuk. This file - a ransom demand, containing e-mail address protonmail domain, which is quite common in this family of malware: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msifelabem1981@protonmail.com </font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/qt/pg/zm/qtpgzmcdohk4siulk9nuayvwhqm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/bk/wa/u9/bkwau9on8kixa8bsmiikectemqu.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 13: Redemption requirement</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
During the execution of the bootloader, you can see that it launches several executable files with random names. They are stored in a hidden </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUBLIC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">, but if the option </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúShow hidden files and folders‚Äù is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not active in the operating system </font><font style="vertical-align: inherit;">, they will remain hidden. Moreover, these files are 64-bit unlike the parent file, which is 32-bit.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/ko/z3/8bkoz3_hgnilr-2i7sytnv5g2ik.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/fe/fb/z-/fefbz-5_yiuoiftotqmnei2hrvq.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 14: Executable files launched by the sample</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As you can see in the above figure, Ryuk launches icacls.exe, which will be used to modify all ACLs (Access control list), thus guaranteeing access and changing flags. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It gets full access under all users to all files on the device (/ T) regardless of errors (/ C) and without showing any messages (/ Q). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mf/bt/nc/mfbtnclxe4usjepbuizjzknslmu.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. Figure 15: Execution options for icacls.exe launched by the sample.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is important to note that Ryuk checks which version of Windows is running. To do this, it </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
checks the version using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetVersionExW</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in which it checks the value of the </font><b><font style="vertical-align: inherit;">lpVersionInformation</font></b><font style="vertical-align: inherit;"> flag</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">showing whether the current version of Windows is later than </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows XP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lc/iv/yv/lcivyvqvjmm8jximv35wbo_v8ps.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/g8/t_/da/g8t_dabeoemyz2v0u93a8ivfilk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on whether you are running a later version than Windows XP, the bootloader will write to the local user folder - in this case, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% Public%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gg/gr/at/gggrateobojjggmubdykjordzy4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 17: Checking the operating system version The</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
recorded file is Ryuk. Then it launches it, passing its own address as a parameter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hh/0f/ct/hh0fctenv0yqswmtw9rhmhjjwv0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 18: Running Ryuk through ShellExecute</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The first thing Ryuk does is get the input parameters. This time there are two input parameters (the executable file itself and the dropper address), which are used to remove their own traces. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1r/wu/vo/1rwuvoxtlg3lmusyoiem1v-e3da.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/op/wf/f7/opwff7lstsb0iq-nbvfqipywy6y.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 19: Creating a process</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also see that as soon as he launched his executable files, he deletes himself, thus leaving no trace of his presence in the folder where he was executed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tp/ui/af/tpuiafv8uy2rmzsuememmnkaxxa.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">20: file deletion</font></font></i><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. RYUK</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1 Presence</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ryuk, like other malware, tries to stay on the system for as long as possible. As shown above, one way to achieve this goal is to secretly create and run executable files. For this, the most common practice is to modify the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CurrentVersion \ Run</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> registry key </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, you can see that for this purpose, the first executable file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VWjRF.exe</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
(the file name is randomly generated) launches </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/8b/g2/sd8bg232guhntext0cy-exeh3be.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/nn/og/fo/nnogfoscybmwjhn9xnwd0gw7118.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 21: Executing the VWjRF.exe file</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Then a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command is entered </font><font style="vertical-align: inherit;">with the name " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Thus, if you want to check the registry keys at any time, you can easily not notice this change, given the similarity of this name with svchost. Thanks to this key, Ryuk ensures its presence in the system. If the system has not yet been infected then when you reboot the system, the executable will try again </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ta/my/42/tamy42jg8mihxlgmxgzfjzqvfui.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 22: The sample ensures the presence of the registry key</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We can also see that this executable stops the two services: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
" </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audioendpointbuilder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", which, as its name implies, matches the system audio, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h-/28/g8/h-28g8z69elv6rzdsjo2xuvrok4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 23: Sample stops system audio</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">samss service</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is an account management service. Stopping these two services is a characteristic of Ryuk. In this case, if the system is connected to the SIEM system, the encryptor tries to stop sending </font><font style="vertical-align: inherit;">any warnings </font><font style="vertical-align: inherit;">to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SIEM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Thus, he defends his next steps, as some SAM services will not be able to start their work correctly after Ryuk is executed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/fn/l1/wjfnl14it7llrkny9xpfvrs30di.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 24: The sample stops the Samss service </font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2 Privileges</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Generally speaking, Ryuk starts with horizontal movement within the network or is launched by another malicious program, such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emotet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trickbot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which in case of privilege escalation transfers these elevated rights to the encryptor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In advance, as a prelude to the implementation process, we see that it runs the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImpersonateSelf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process </font><font style="vertical-align: inherit;">, which means that the security content of the access token will be transferred to the stream, where it will be immediately received using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetCurrentThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9y/nm/ut/9ynmutmaqq2wovbdswheiipajcc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 25: Calling ImpersonateSelf</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Then we see that it will associate the access token with the stream. We also see that one of the flags is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DesiredAccess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which can be used to control the access that the stream will have. In this case, the value that edx will receive must be </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TOKEN_ALL_ACESS,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or else </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TOKEN_WRITE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/vc/a_/uivca_yeyyvr5m-hwyolmei6k3u.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/tm/gy/yg/tmgyygvshjspnungxwqitl_jqm0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 26: Creating a stream token</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Then it will use</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SeDebugPrivilege</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will make a call to get Debug debugging rights with respect to the stream, as a result of which, by specifying </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PROCESS_ALL_ACCESS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it will be able to access any required process. Now, given that the encryptor already has a prepared stream, it remains only to proceed to the final stage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/lf/ki/0mlfkifvdv7hk7rizfyus_7oco4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 27: Calling SeDebugPrivilege and the function of escalating rights</font></font><br>
 </i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
On the one hand, we have LookupPrivilegeValueW, which provides us with the necessary information about the privileges that we want to raise. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ts/wd/db/tswddbwi0jyghyqjpniu6rphmpe.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 28: Requesting information about privileges for their escalation</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
On the other hand, we have </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AdjustTokenPrivileges</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which allows us to obtain the necessary rights to our stream. In this case, the most important is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NewState.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose flag will grant privileges. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ki/sx/pa/kisxpam9ymp6ivk8remgfwfx4aq.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/9m/0s/sa/9m0ssakqkkjd4wzm4wqfav-mn7g.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. Figure 29: Setting rights for the token </font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3 Deployment</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this section, we will show how the sample performs the deployment process previously mentioned in this report. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main goal of the implementation process, as well as escalation, is to gain access to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shadow copies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . To do this, he needs to work with the stream with rights higher than that of the local user. As soon as he obtains such higher rights, he will delete the copies and make changes to other processes in order to make it impossible to return to an earlier restore point in the operating system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As is usually the case with this type of malware, it uses </font><b><font style="vertical-align: inherit;">CreateToolHelp32Snapshot</font></b><font style="vertical-align: inherit;"> to complete the implementation</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so it takes a snapshot of the currently running processes and tries to access these processes using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenProcess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As soon as he gets access to the process, he also opens a token with his information to obtain process parameters. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dc/do/xz/dcdoxzczq1ti1kf5fu_5y_rikc8.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Figure </font><i><font style="vertical-align: inherit;">30: Receiving processes from a computer</font></i><font style="vertical-align: inherit;"> We can dynamically see how it receives a list of running processes in routine 140002D9C using CreateToolhelp32Snapshot. After receiving them, he goes through the list, trying to open processes one by one using OpenProcess until he can do it. In this case, the first process he was able to open was </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äútaskhost.exe‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k0/24/og/k024ogcd6ioxwnjbfuhjuefrce4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 31: Dynamic execution of a procedure to obtain a process</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can see that he subsequently reads the token of the process, so it is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenProcessToken</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20008</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8j/zl/kn/8jzlkngsiwxlyol93ozqx8ebjrm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 32: Reading process token information</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It also checks that the process into which it will be embedded is not </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">csrss.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explorer.exe, lsaas.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or that it has a set of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NT authority</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permissions </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hr/xr/9k/hrxr9kefgjfbtsex5awxtlqmjcm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. Figure 33: Excluded processes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We can dynamically see how it first checks using the process token information in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">140002D9C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to find out if the account whose rights are used to execute the process is an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NT AUTHORITY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> account </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4v/_v/-c/4v_v-cloz4ndee9gs0qbihghn9k.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 34: Checking NT AUTHORITY</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And later, outside the procedure, it checks that it is not </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">csrss.exe, explorer.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lsaas.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/uy/gg/wauyggzhisvonm1cyqr3cahfdc0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 35: Checking NT AUTHORITY</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After he took a snapshot of the processes, opened the processes and verified that none of them are excluded, he is ready to write down the processes that will be implemented into memory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, he first reserves a region in memory ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), writes to it ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessmemory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and creates a stream ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). To work with these functions, he uses the PIDs of the selected processes, which he previously obtained using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateToolhelp32Snapshot</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s7/zp/pl/s7zpplpua6q4w1mgpurwvgtzyxy.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 36: Embed Code</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Here we can dynamically observe how it uses the process PID to call the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><b><font style="vertical-align: inherit;">. </font></b></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/k1/j-/7nk1j-saztq--oxfo2xwzyiowgk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. Figure 37: Invoking VirtualAllocEx </font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4 Encryption</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this section, we will look at part of this sample related to encryption. In the following figure, you can see two routines called " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary_EncodeString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " and " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encode_Func</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", which are responsible for performing the encryption procedure. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/iu/1r/o5iu1rimo3qfnbgpnl4mvwcpwug.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 38: Encryption Procedures</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
At first we can see how it loads a string that will later be used to de-obfuscate everything that is needed: imports, DLLs, commands, files, and CSPs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/x6/te/dux6tehj_i7jcqkupvfdb3hlcfw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 39: Deobfuscation chain</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following figure shows the first import that it deobfuscates in the R4 register, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This will be used later to load the necessary DLLs. We can also see another line in register R12, which is used together with the previous line to perform deobfuscation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/la/oo/to/laootohjrpgt3fa-yeetqz6rxzo.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 40: Dynamic deobfuscation.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
He continues to load commands that he will execute later to disable backups, restore points, and safe boot modes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/qt/le/ceqtleaezfngmfgtrlhpgxl-vbw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 41: Downloading commands</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Then it loads the location where it will drop 3 files: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows.bat, run.sct</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start.bat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wj/9f/efwj9fcrtd5vai-3jjp6kblwsu0.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/jx/sg/sa/jxsgsaqyu0omqswv0-eseu5aeok.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/yq/g4/ur/yqg4urwb1wqlo52wgoocuccbi00.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/i2/fc/2t/i2fc2t2mcj6qrwau7gikqb4ohf4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 42: File Locations</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These 3 files are used to check the privileges that each location has. If the required privileges are not available, Ryuk stops execution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It continues to load lines corresponding to three files. The first, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DECRYPT_INFORMATION.html</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , contains the information needed to restore files. The second, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUBLIC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , contains the RSA public key. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vf/w1/do/vfw1doq6ayau0i8pkniuc-rd5mk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 43: String DECRYPT INFORMATION.html</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Third, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNIQUE_ID_DO_NOT_REMOVE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , contains the encrypted key that will be used in the next routine to perform encryption. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/1l/s1/u_1ls1stszk23gkrsh2mwonnvgi.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 44: UNIQUE ID DO NOT REMOVE String</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Finally, it loads the required libraries along with the required imports and CSP ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Enhanced RSA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AES Cryptographic Provider</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7d/b9/q1/7db9q1wjr1k_y1bfsefiewsc-6g.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 45: Downloading libraries</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After all the deobfuscation is completed, he proceeds to perform the actions required for encryption: iterate over all logical drives, perform what was loaded in the previous subroutine, strengthen the presence in the system, drop the RyukReadMe.html file, encrypt, enumerate all network drives, switching to discovered devices and their encryption. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It all starts with downloading " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " and writing the RSA public key. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_n/me/r-/_nmer-jvdpleozaujmoemqo7u9s.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 46: Preparing for Encryption</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It then retrieves all logical drives using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetLogicalDrives</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and disables all backups, recovery points, and safe boot modes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/ov/f8/faovf8myihdrkrtulhzcu_50e8q.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 47: Deactivating recovery tools</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After that, he strengthens his presence in the system, as we saw above, and writes the first </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RyukReadMe.html</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TEMP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x8/7u/at/x87uatt-xtzmrn0un3-jqt5o0hw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Figure </font><i><font style="vertical-align: inherit;">48: Publishing a buyback notification.</font></i><font style="vertical-align: inherit;"> In the following figure, you can see how it creates a file, downloads the contents and writes it: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/5o/2n/vu5o2nliyrqgsmugbe9jpx0-1mc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure. Figure 49: Downloading and recording the contents of a file.</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In order to be able to perform the same actions on all devices, it uses </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
" </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icacls.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " as we showed above. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bd/6a/qb/bd6aqbnkrrba-polrck91kh53w0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 50: Using icalcls.exe</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, it starts encrypting files with the exception of the "* .exe", "* .dll" files, system files, and other locations specified as an encrypted white list. </font><font style="vertical-align: inherit;">For this, it uses imports: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptAcquireContextW</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (where the use of AES and RSA is indicated), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptDeriveKey, CryptGenKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptDestroyKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. </font><font style="vertical-align: inherit;">An attempt is also being made to expand its effect on detected network devices using WNetEnumResourceW and then encrypt them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9j/yn/mj/9jynmjtzu26dwvfg3ugrthcxo0o.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">51: System File Encryption</font></font></i><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Imports and related flags</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is a table listing the most relevant imports and flags used by the sample:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/bn/he/ribnhe9istspdndifpecxgnzljc.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. IOC</font></font></h4><br>
<img src="https://habrastorage.org/webt/bf/gu/cr/bfgucrrkqw-l2jurn09ovgljhas.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">users \ Public \ run.sct</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start Menu \ Programs \ Startup \ start.bat AppData \ Roaming \ Microsoft \ Windows \ Start</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menu \ ProgramsStartup \ start.bat</font></font></li>
</ul><br>
<br>
<img src="https://habrastorage.org/webt/ld/od/e2/ldode2_iiqa4jqw4ol46ch5dov4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk ransomware technical report compiled by PandaLabs antivirus lab experts.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. References</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. ‚ÄúEveris y Prisa Radio sufren un grave ciberataque que secuestra sus sistemas.‚Äù Https: // www. elconfidencial.com/tecnologia/2019-11-04/ everis-la-ser-ciberataque-ransomware-15_2312019 /, Publicada el 04/11/2019. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. ‚ÄúUn virus de origen ruso ataca a importantes empresas espa√±olas.‚Äù Https: //elpais.com/ tecnologia / 2019/11/04 / actualidad / 1572897654_ 251312.html, Publicada el 04/11/2019. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. ‚ÄúVB2019 paper: Shinigami's revenge: the long tail of the Ryuk malware.‚Äù Https://securelist.com/ story-of-the-year-2019-cities-under-ransomware-siege / 95456 /, Publicada el 11 / </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12/2019 4. ‚ÄúBig Game Hunting with Ryuk: Another Lucrativebased Ransomware.‚Äù Https: // www. crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/, Publicada el 01/10/2019.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. ‚ÄúVB2019 paper: Shinigami's revenge: the long tail of the Ryuk malware.‚Äù Https: // www. </font><font style="vertical-align: inherit;">virusbulletin.com/virusbulletin/2019/10/ vb2019-paper-shinigamis-revenge-long-tail-r</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497680/index.html">Your telegram seems to be flowing</a></li>
<li><a href="../en497682/index.html">Pavel Klemenkov, NVIDIA: We are trying to narrow the gap between what a data scientist can do and what he needs to be able to do.</a></li>
<li><a href="../en497684/index.html">Hype curve: what IT technologies are at their peak and what will remain stable demand</a></li>
<li><a href="../en497686/index.html">Bacteria-killing implant material</a></li>
<li><a href="../en497688/index.html">How the Kubernetes Evening School Works</a></li>
<li><a href="../en497700/index.html">Weekly online mitaps on backing and DevOps, security and robots from April 17</a></li>
<li><a href="../en497702/index.html">Five trends in data storage that you should pay attention to in 2020</a></li>
<li><a href="../en497708/index.html">We invite you to a series of Fujitsu webinars in April and May</a></li>
<li><a href="../en497714/index.html">How to protect processes and kernel extensions on macOS</a></li>
<li><a href="../en497724/index.html">Preparing a server for publishing a web-app in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>