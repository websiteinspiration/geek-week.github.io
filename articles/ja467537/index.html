<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😴 👊🏾 🈵 ビデオデコード用のライブラリ。PythonとRustの比較 😩 🐇 🦗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="多くの人が不思議に思っています-Pythonのデコード操作はどれくらい遅いですか？コンパイルされた言語が関係するすべてのものの速度を向上させることは本当ですか？どちらが速いですか：OpenCVまたは何もありませんか？あなたはカットの下でこれらと他の役に立たない質問への答えを読むことができません。特定...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ビデオデコード用のライブラリ。PythonとRustの比較</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467537/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの人が不思議に思っています-Pythonのデコード操作はどれくらい遅いですか？</font><font style="vertical-align: inherit;">コンパイルされた言語が関係するすべてのものの速度を向上させることは本当ですか？</font><font style="vertical-align: inherit;">どちらが速いですか：OpenCVまたは何もありませんか？</font><font style="vertical-align: inherit;">あなたはカットの下でこれらと他の役に立たない質問への答えを読むことができません。</font><font style="vertical-align: inherit;">特定のタスクには通常、退屈なパフォーマンス調査があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味のある方、大歓迎です！</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私が取り組んでいるプロジェクトの主要な部分は、リアルタイムビデオで人とその行動を認識することです。</font><font style="vertical-align: inherit;">それはもともとPython + OpenCVで書かれました。</font><font style="vertical-align: inherit;">もちろん、ある時点で突然、スケールアップ、生産性の向上、あらゆる方法での最適化が必要になりました。</font><font style="vertical-align: inherit;">そして、ビデオストリームを操作するためにライブラリーの中を最初に見てみることにしました。</font><font style="vertical-align: inherit;">同時に、言語がこのタスクのパフォーマンスにどの程度影響するかを確認します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も人気があると考えられています（実際、選択肢はそれほど大きくありません）。</font></font></p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opencv</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ffmpeg</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gstreamer</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VLC</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヴァルッカ</font></font></a></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VLCとValkkaはほぼ即座に倒れました。</font><font style="vertical-align: inherit;">最初のものは、グラフィカルインターフェースを呼び出さないと機能しませんでした。</font><font style="vertical-align: inherit;">2番目のものは、ドキュメントがほとんどなく、他の言語用のライブラリがさらに少なくなっています。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、最初の3つについて詳しく説明し、Pythonでのパフォーマンスを比較します。</font></font></p><br>
<h3 id="opencv"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opencv</font></font></h3><br>
<h4 id="plyusy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長所</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常にシンプルなインタラクションインターフェイス</font></font></li>
<li>   Python   V </li>
<li> </li>
</ul><br>
<h4 id="minusy"></h4><br>
<ul>
<li>          rtsp-.    FFmpeg        ,   GStreamer  .        </li>
<li> FFmpeg    - (    FFmpeg)</li>
<li>-         </li>
</ul><br>
<p>       numpy.ndarray,     BGR (     RGB  ).       ,    ,      ,  .             ,         python   pickable.</p><br>
<p> ,  , ,    Queue,      pickle.dumps()  pickle.loads() (    Python 3.8      shared memory).     FullHD .   ndarray   ~6  .</p><br>
<p>          .  numpy.ndarray    bytes  ,        .</p><br>
<h3 id="ffmpeg">FFmpeg</h3><br>
<h4 id="plyusy-1"></h4><br>
<ul>
<li>    </li>
<li>     </li>
<li>  </li>
</ul><br>
<h4 id="minusy-1"></h4><br>
<ul>
<li>    OpenCV —      rtsp-:        ,   .    ,   ,     - ,         -      </li>
<li>    —       Python.     :     linux pipe,     zram   .  ,    </li>
</ul><br>
<h3 id="gstreamer">GStreamer</h3><br>
<h4 id="plyusy-2"></h4><br>
<ul>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Python</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Rust</a></li>
<li>      .          -</li>
<li>   rtsp,     (        ),   </li>
</ul><br>
<h4 id="minusy-2"></h4><br>
<ul>
<li>  </li>
<li>   ,  FFmpeg   5-10%</li>
</ul><br>
<h2 id="primery-koda-i-proizvoditelnost">   </h2><br>
<p>      . -  ,  ,      :</p><br>
<ol>
<li>  </li>
<li>     RGB  GRAY8 (    ML    ,      3  )</li>
<li> ,   /  pickle</li>
</ol><br>
<p> OpenCV    .        —  .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> cv2<font></font>
<font></font>
source = <span class="hljs-string">'Tractor_500kbps_x264.mp4'</span><font></font>
cap = cv2.VideoCapture(source)<font></font>
<span class="hljs-keyword">while</span> cap.isOpened():<font></font>
    ret, frame = cap.read()<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ret:
        <span class="hljs-keyword">break</span><font></font>
    pickle.loads(cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY).dumps())<font></font>
cap.release()</code></pre><br>
<p> FFmpeg     Python (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ffmpeg-python</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">scikit-video</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ffmpy</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ffmpeg</a>). ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ffmpeg-python</a>:  ,   .     —       subprocess.Popen      linux pipe  stdout,    Python   stdout     numpy ndarray.</p><br>
<p>    :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> Popen, PIPE, DEVNULL
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> cv2<font></font>
<font></font>
source = <span class="hljs-string">'Tractor_500kbps_x264.mp4'</span>
width, height = (<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>)<font></font>
stream_url = <span class="hljs-string">f'ffmpeg -vcodec h264 -i <span class="hljs-subst">{source}</span> -f rawvideo -pix_fmt yuv420p pipe:'</span>.split(<span class="hljs-string">' '</span>)
<span class="hljs-keyword">with</span> Popen(stream_url, stdout=PIPE, stderr=DEVNULL) <span class="hljs-keyword">as</span> p:
    <span class="hljs-keyword">while</span> p.stdout.readable():<font></font>
        yuv_height = int(height+height//<span class="hljs-number">2</span>)<font></font>
        raw_frame = p.stdout.read(yuv_height * width)<font></font>
        <span class="hljs-keyword">if</span> len(raw_frame) == yuv_height * width:<font></font>
            frame = np.frombuffer(raw_frame, np.uint8).reshape((yuv_height, width))<font></font>
            cv2.cvtColor(frame, cv2.COLOR_YUV2RGB_I420)<font></font>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">break</span>
    p.stdout.flush()</code></pre><br>
<p>       . ,   bytearray    . , ,  ffprobe   ,     ,      .    ,    , . . ffprobe    rtsp-    .</p><br>
<p>  —   .          YUV,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">I420</a> (YUV420p),           .         RGB. </p><br>
<p>,    GPU (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">NVDEC</a>)      NV12     YUV.    ffmpeg          OpenCV.      .</p><br>
<p>C GStreamer    , ,  ,  .</p><br>
<div class="spoiler"><b class="spoiler_title">    GStreamer</b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> gi<font></font>
<font></font>
gi.require_version(<span class="hljs-string">'Gst'</span>, <span class="hljs-string">'1.0'</span>)<font></font>
gi.require_version(<span class="hljs-string">'GLib'</span>, <span class="hljs-string">'2.0'</span>)<font></font>
gi.require_version(<span class="hljs-string">'GObject'</span>, <span class="hljs-string">'2.0'</span>)<font></font>
<font></font>
<span class="hljs-keyword">from</span> gi.repository <span class="hljs-keyword">import</span> GLib, Gst<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bus_call</span>(<span class="hljs-params">bus, message, loop, pipe</span>):</span><font></font>
    t = message.type<font></font>
    <span class="hljs-keyword">if</span> t == Gst.MessageType.EOS:<font></font>
        pipe.set_state(Gst.State.NULL)<font></font>
        loop.quit()<font></font>
    <span class="hljs-keyword">elif</span> t == Gst.MessageType.ERROR:<font></font>
        err, debug = message.parse_error()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{err}</span>: <span class="hljs-subst">{debug}</span>'</span>)<font></font>
        pipe.set_state(Gst.State.NULL)<font></font>
        loop.quit()<font></font>
    <span class="hljs-keyword">return</span> Gst.FlowReturn.OK<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yuv_rgb</span>(<span class="hljs-params">appsink</span>):</span>
    sample = appsink.emit(<span class="hljs-string">"pull-sample"</span>)<font></font>
    buf = sample.get_buffer()<font></font>
    caps = sample.get_caps()<font></font>
    height = caps.get_structure(<span class="hljs-number">0</span>).get_value(<span class="hljs-string">'height'</span>)<font></font>
    width = caps.get_structure(<span class="hljs-number">0</span>).get_value(<span class="hljs-string">'width'</span>)<font></font>
    stream_format = caps.get_structure(<span class="hljs-number">0</span>).get_value(<span class="hljs-string">'format'</span>)<font></font>
    data = buf.extract_dup(<span class="hljs-number">0</span>, buf.get_size())
    <span class="hljs-keyword">if</span> data:<font></font>
        frame = np.frombuffer(data, np.uint8).reshape((height+height//<span class="hljs-number">2</span>, width))<font></font>
        cv2.cvtColor(frame, cv2.COLOR_YUV2RGB_I420)<font></font>
    <span class="hljs-keyword">return</span> Gst.FlowReturn.OK<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pipe_init</span>(<span class="hljs-params">source, on_new_sample, pix_format</span>):</span>
    Gst.init(<span class="hljs-literal">None</span>)<font></font>
    pipe = Gst.Pipeline.new(<span class="hljs-string">'dynamic'</span>)<font></font>
<font></font>
    src = Gst.ElementFactory.make(<span class="hljs-string">'filesrc'</span>)<font></font>
    demux = Gst.ElementFactory.make(<span class="hljs-string">'qtdemux'</span>)<font></font>
    parse = Gst.ElementFactory.make(<span class="hljs-string">'h264parse'</span>)<font></font>
    decode = Gst.ElementFactory.make(<span class="hljs-string">'avdec_h264'</span>)<font></font>
    convert = Gst.ElementFactory.make(<span class="hljs-string">'videoconvert'</span>)<font></font>
    sink = Gst.ElementFactory.make(<span class="hljs-string">'appsink'</span>)<font></font>
<font></font>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> (src, demux, parse, decode, convert, sink):<font></font>
        pipe.add(item)<font></font>
<font></font>
    src.link(demux)<font></font>
    demux.connect(<span class="hljs-string">'pad-added'</span>, <span class="hljs-keyword">lambda</span> element, pad: element.link(parse))<font></font>
    parse.link(decode)<font></font>
    decode.link(convert)<font></font>
    convert.link(sink)<font></font>
<font></font>
    src.set_property(<span class="hljs-string">'location'</span>, source)<font></font>
<font></font>
    sink.set_property(<span class="hljs-string">"emit-signals"</span>, <span class="hljs-literal">True</span>)<font></font>
    sink.set_property(<span class="hljs-string">"max-buffers"</span>, <span class="hljs-number">1</span>)<font></font>
    caps = Gst.caps_from_string(<span class="hljs-string">f"video/x-raw, format=(string)<span class="hljs-subst">{pix_format}</span>"</span>)<font></font>
    sink.set_property(<span class="hljs-string">"caps"</span>, caps)<font></font>
    sink.set_property(<span class="hljs-string">"drop"</span>, <span class="hljs-literal">True</span>)<font></font>
    sink.set_property(<span class="hljs-string">"wait-on-eos"</span>, <span class="hljs-literal">True</span>)<font></font>
    sink.set_property(<span class="hljs-string">'sync'</span>, <span class="hljs-literal">False</span>)<font></font>
    sink.connect(<span class="hljs-string">"new-sample"</span>, on_new_sample)
    <span class="hljs-keyword">return</span> pipe<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">source, sink_callback, pix_format</span>):</span><font></font>
    loop = GLib.MainLoop()<font></font>
    pipe = pipe_init(source, sink_callback, pix_format)<font></font>
<font></font>
    bus = pipe.get_bus()<font></font>
    bus.add_signal_watch()<font></font>
    bus.enable_sync_message_emission()<font></font>
    bus.connect(<span class="hljs-string">'message'</span>, bus_call, loop, pipe)<font></font>
<font></font>
    pipe.set_state(Gst.State.PLAYING)<font></font>
    loop.run()<font></font>
<font></font>
run(<span class="hljs-string">'Tractor_500kbps_x264.mp4'</span>, yuv_rgb, <span class="hljs-string">'I420'</span>)</code></pre></div></div><br>
<p> GStreamer     appsink,   callback-      .</p><br>
<h3 id="chto-zhe-s-proizvoditelnostyu">   ?</h3><br>
<p>     Intel Core i5-6600K,  10 .  Python   timeit.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Tractor_500kbps_x264.mp4</a>.</p><br>
<p> :</p><br>
<ul>
<li>pure —    </li>
<li>gray8 —   BGR  GRAY8  OpenCV</li>
<li>rgb —   BGR  RGB  OpenCV</li>
<li>yuv_gray —     I420</li>
<li>yuv_gray8 —   YUV420p  GRAY8  OpenCV</li>
<li>yuv_rgb —   YUV420p  RGB  OpenCV</li>
<li>native_gray —   YUV420p  GRAY8  </li>
<li>native_rgb —   YUV420p  RGB  </li>
</ul><br>
<h4 id="native">Native</h4><br>
<p> FFmpeg  GStreamer     ,    /dev/null.       .</p><br>
<pre><code class="bash hljs">ffmpeg -vcodec h264 -i Tractor_500kbps_x264.mp4 -f null /dev/null<font></font>
<font></font>
frame=  252 fps=0.0 q=-0.0 Lsize=N/A time=00:00:10.28 bitrate=N/A speed=24.6x<font></font>
<font></font>
gst-launch-1.0 filesrc location=<span class="hljs-string">"Tractor_500kbps_x264.mp4"</span> ! qtdemux ! h264parse ! avdec_h264 ! videoconvert ! fakesink<font></font>
<font></font>
Execution ended after 0:00:00.551382068</code></pre><br>
<h4 id="opencv-1">OpenCV</h4><br>
<p>  .                pickle       .  ,     pickle   .</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th> </th>
<th>  </th>
<th>  </th>
</tr>
</thead>
<tbody>
<tr>
<td>pure</td>
<td>8.7099</td>
<td>0.8710</td>
<td>289.3268 fps</td>
</tr>
<tr>
<td>gray8</td>
<td>20.3162</td>
<td>2.0316</td>
<td>124.0389 fps</td>
</tr>
<tr>
<td>rgb</td>
<td>74.3420</td>
<td>7.4342</td>
<td>33.8974 fps</td>
</tr>
</tbody>
</table></div><br>
<h4 id="ffmpeg-1">FFmpeg</h4><br>
<p>   .              OpenCV.       pickle        .</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th> </th>
<th>  </th>
<th>  </th>
</tr>
</thead>
<tbody>
<tr>
<td>pure</td>
<td>8.3283</td>
<td>0.8328</td>
<td>302.5810 fps</td>
</tr>
<tr>
<td>yuv_gray</td>
<td>7.3772</td>
<td>0.7377</td>
<td>341.5925 fps</td>
</tr>
<tr>
<td>yuv_gray8</td>
<td>8.2721</td>
<td>0.8272</td>
<td>304.6402 fps</td>
</tr>
<tr>
<td>yuv_rgb</td>
<td>9.3969</td>
<td>0.9397</td>
<td>268.1733 fps</td>
</tr>
<tr>
<td>native_gray</td>
<td>10.7005</td>
<td>1.0700</td>
<td>235.5041 fps</td>
</tr>
<tr>
<td>native_rgb</td>
<td>13.7820</td>
<td>1.3782</td>
<td>182.8466 fps</td>
</tr>
</tbody>
</table></div><br>
<p> ,       ,   OpenCV. yuv_gray —    I420 ,     .</p><br>
<h4 id="gstreamer-1">GStreamer</h4><br>
<p>   ,   FFmpeg,       .</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th> </th>
<th>  </th>
<th>  </th>
</tr>
</thead>
<tbody>
<tr>
<td>pure</td>
<td>7.1359</td>
<td>0.7136</td>
<td>353.1457 fps</td>
</tr>
<tr>
<td>yuv_gray</td>
<td>6.8841</td>
<td>0.6884</td>
<td>366.0609 fps</td>
</tr>
<tr>
<td>yuv_gray8</td>
<td>7.3328</td>
<td>0.7333</td>
<td>343.6599 fps</td>
</tr>
<tr>
<td>yuv_rgb</td>
<td>8.9191</td>
<td>0.8919</td>
<td>282.5403 fps</td>
</tr>
<tr>
<td>native_gray</td>
<td>20.2932</td>
<td>2.3832</td>
<td>105.7409 fps</td>
</tr>
<tr>
<td>native_rgb</td>
<td>23.8318</td>
<td>2.0293</td>
<td>124.1793 fps</td>
</tr>
</tbody>
</table></div><br>
<p>    ,   FFmpeg.     -    .</p><br>
<p>   Python   30%    . ,    , GStreamer,   ,   ,    ,        10%  20%.      ,    RGB ,   GRAY8.      python:</p><br>
<pre><code class="bash hljs">gst-launch-1.0 filesrc location=<span class="hljs-string">"Tractor_500kbps_x264.mp4"</span> ! qtdemux ! h264parse ! avdec_h264 ! videoconvert ! <span class="hljs-string">"video/x-raw, format=(string)GRAY8"</span> ! fakesink<font></font>
<font></font>
Execution ended after 0:00:02.229323128<font></font>
<font></font>
gst-launch-1.0 filesrc location=<span class="hljs-string">"Tractor_500kbps_x264.mp4"</span> ! qtdemux ! h264parse ! avdec_h264 ! videoconvert ! <span class="hljs-string">"video/x-raw, format=(string)RGB"</span> ! fakesink<font></font>
<font></font>
Execution ended after 0:00:01.150704119</code></pre><br>
<p> , ,  Python  ,    -  ,     .         Rust.</p><br>
<h4 id="opencv-2">OpenCV</h4><br>
<pre><code class="rust hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> opencv;<font></font>
<font></font>
<span class="hljs-keyword">use</span> opencv::{core, videoio, imgproc};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() -&gt; opencv::<span class="hljs-built_in">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> filename = <span class="hljs-string">"Tractor_500kbps_x264.mp4"</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> cam = videoio::VideoCapture::new_from_file_with_backend(filename, videoio::CAP_ANY)?;
    <span class="hljs-keyword">let</span> opened = videoio::VideoCapture::is_opened(&amp;cam)?;
    <span class="hljs-keyword">if</span> !opened { <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Unable to open default camera!"</span>) };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> frame = core::Mat::default()?;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> gray = core::Mat::default()?;
    <span class="hljs-keyword">loop</span> {<font></font>
        cam.read(&amp;<span class="hljs-keyword">mut</span> frame)?;
        <span class="hljs-keyword">if</span> frame.size()?.width &gt; <span class="hljs-number">0</span> {<font></font>
            imgproc::cvt_color(&amp;frame, &amp;<span class="hljs-keyword">mut</span> gray, imgproc::COLOR_BGR2RGB, <span class="hljs-number">0</span>)?;<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">break</span><font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<h4 id="gstreamer-2">GStreamer</h4><br>
<div class="spoiler"><b class="spoiler_title">    GStreamer  Rust</b><div class="spoiler_text"><pre><code class="rust hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> opencv;
<span class="hljs-keyword">use</span> crate::opencv::prelude::Vector;<font></font>
<font></font>
<span class="hljs-keyword">use</span> std::time::SystemTime;
<span class="hljs-keyword">use</span> opencv::{core, videoio, imgproc};
<span class="hljs-keyword">use</span> opencv::types::{VectorOfint};<font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> gstreamer <span class="hljs-keyword">as</span> gst;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> gstreamer_app <span class="hljs-keyword">as</span> gst_app;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> failure;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> glib;<font></font>
<font></font>
<span class="hljs-keyword">use</span> failure::Error;
<span class="hljs-keyword">use</span> gst::prelude::*;<font></font>
<font></font>
<span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> failure_derive;<font></font>
<font></font>
<span class="hljs-meta">#[derive(Debug, Fail)]</span>
<span class="hljs-meta">#[fail(display = <span class="hljs-meta-string">"Missing element {}"</span>, _0)]</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MissingElement</span></span>(&amp;<span class="hljs-symbol">'static</span> <span class="hljs-built_in">str</span>);<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Camera</span></span> {<font></font>
    pipe: gst::Pipeline,<font></font>
    main_loop: glib::MainLoop,<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span> Camera {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(location: &amp;<span class="hljs-built_in">str</span>) -&gt; Camera {<font></font>
        Camera {<font></font>
            pipe: Camera::create_pipeline(location).unwrap(),<font></font>
            main_loop: glib::MainLoop::new(<span class="hljs-literal">None</span>, <span class="hljs-literal">false</span>),<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run</span></span>(&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">Result</span>&lt;(), Error&gt; {
        <span class="hljs-keyword">self</span>.create_bus()?;
        <span class="hljs-keyword">self</span>.pipe.set_state(gst::State::Playing)?;
        <span class="hljs-keyword">self</span>.main_loop.run();
        <span class="hljs-literal">Ok</span>(())<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">create_bus</span></span>(&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">Result</span>&lt;(), Error&gt;{
        <span class="hljs-keyword">let</span> bus = <span class="hljs-keyword">self</span>.pipe.get_bus().expect(<span class="hljs-string">"Pipeline without bus. Shouldn't happen!"</span>);
        <span class="hljs-keyword">let</span> ml = <span class="hljs-keyword">self</span>.main_loop.clone();
        <span class="hljs-keyword">let</span> pipe = <span class="hljs-keyword">self</span>.pipe.clone();<font></font>
        bus.add_watch(<span class="hljs-keyword">move</span> |_: &amp;gst::Bus, msg: &amp;gst::Message| {
            <span class="hljs-keyword">use</span> gst::MessageView;
            <span class="hljs-keyword">match</span> msg.view() {<font></font>
                MessageView::Eos(..) =&gt; {<font></font>
                    pipe.set_state(gst::State::Null).unwrap();<font></font>
                    ml.quit();<font></font>
                },<font></font>
                MessageView::Error(err) =&gt; {<font></font>
                    <span class="hljs-built_in">println!</span>(
                        <span class="hljs-string">"Error from {:?}: {} ({:?})"</span>,<font></font>
                        err.get_src().map(|s| s.get_path_string()),<font></font>
                        err.get_error(),<font></font>
                        err.get_debug()<font></font>
                    );<font></font>
                    pipe.set_state(gst::State::Null).unwrap();<font></font>
                    ml.quit();<font></font>
                }<font></font>
                _ =&gt; (),<font></font>
            };<font></font>
            glib::Continue(<span class="hljs-literal">true</span>)<font></font>
        });<font></font>
        <span class="hljs-literal">Ok</span>(())<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">create_pipeline</span></span>(location: &amp;<span class="hljs-built_in">str</span>) -&gt; <span class="hljs-built_in">Result</span>&lt;gst::Pipeline, Error&gt; {<font></font>
        gst::init()?;<font></font>
<font></font>
        <span class="hljs-keyword">let</span> src = gst::ElementFactory::make(<span class="hljs-string">"filesrc"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"src"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create filesource"</span>))?;
        <span class="hljs-keyword">let</span> demux = gst::ElementFactory::make(<span class="hljs-string">"qtdemux"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"demux"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create demux"</span>))?;
        <span class="hljs-keyword">let</span> parse = gst::ElementFactory::make(<span class="hljs-string">"h264parse"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"parse"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create parse"</span>))?;
        <span class="hljs-keyword">let</span> decode = gst::ElementFactory::make(<span class="hljs-string">"avdec_h264"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"decode"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create decodebin"</span>))?;
        <span class="hljs-keyword">let</span> convert = gst::ElementFactory::make(<span class="hljs-string">"videoconvert"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"convert"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create convert"</span>))?;
        <span class="hljs-keyword">let</span> sink = gst::ElementFactory::make(<span class="hljs-string">"appsink"</span>, <span class="hljs-literal">Some</span>(<span class="hljs-string">"appsink"</span>))<font></font>
            .ok_or(MissingElement(<span class="hljs-string">"cant create appsink"</span>))?;<font></font>
<font></font>
        src.set_property(<span class="hljs-string">"location"</span>, &amp;location)?;<font></font>
<font></font>
        <span class="hljs-keyword">let</span> pipeline = gst::Pipeline::new(<span class="hljs-literal">None</span>);<font></font>
        pipeline.add_many(&amp;[&amp;src, &amp;demux, &amp;parse, &amp;decode, &amp;convert, &amp;sink])?;<font></font>
        src.link(&amp;demux)?;<font></font>
        parse.link(&amp;decode)?;<font></font>
        decode.link(&amp;convert)?;<font></font>
        convert.link(&amp;sink)?;<font></font>
<font></font>
        <span class="hljs-keyword">let</span> sink_pad = parse.get_static_pad(<span class="hljs-string">"sink"</span>).unwrap();<font></font>
        demux.connect_pad_added(<span class="hljs-keyword">move</span> |_dbin, src_pad| {<font></font>
            src_pad.link(&amp;sink_pad).expect(<span class="hljs-string">"Not linked"</span>);<font></font>
        });<font></font>
<font></font>
        <span class="hljs-keyword">let</span> appsink = sink.dynamic_cast::&lt;gst_app::AppSink&gt;()<font></font>
            .expect(<span class="hljs-string">"Sink element is expected to be an appsink!"</span>);<font></font>
        appsink.set_emit_signals(<span class="hljs-literal">true</span>);<font></font>
        appsink.set_max_buffers(<span class="hljs-number">1</span>);<font></font>
        appsink.set_drop(<span class="hljs-literal">true</span>);<font></font>
        appsink.set_wait_on_eos(<span class="hljs-literal">false</span>);<font></font>
        appsink.set_property(<span class="hljs-string">"sync"</span>, &amp;<span class="hljs-literal">false</span>)?;<font></font>
        appsink.set_callbacks(<font></font>
            gst_app::AppSinkCallbacks::new()<font></font>
                .new_sample(<span class="hljs-keyword">move</span> |appsink: &amp;gst_app::AppSink| {
                    <span class="hljs-keyword">let</span> sample = appsink.pull_sample().ok_or(gst::FlowError::Eos)?;
                    <span class="hljs-keyword">let</span> buffer = sample.get_buffer().ok_or_else(||gst::FlowError::Error)?;
                    <span class="hljs-keyword">let</span> map = buffer.map_readable().ok_or_else(||gst::FlowError::Error)?;
                    <span class="hljs-keyword">let</span> samples = map.as_slice();
                    <span class="hljs-keyword">let</span> dims = VectorOfint::from_iter(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1080</span>+<span class="hljs-number">1080</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1920</span>]);
                    <span class="hljs-keyword">let</span> frame = core::Mat::from_slice(samples).unwrap().reshape_nd(<span class="hljs-number">1</span>, &amp;dims).unwrap();
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> rgb = core::Mat::default().unwrap();<font></font>
                    imgproc::cvt_color(&amp;frame, &amp;<span class="hljs-keyword">mut</span> rgb, imgproc::COLOR_YUV2RGB_I420, <span class="hljs-number">3</span>).unwrap();
                    <span class="hljs-literal">Ok</span>(gst::FlowSuccess::<span class="hljs-literal">Ok</span>)<font></font>
                })<font></font>
                .build()<font></font>
        );<font></font>
        <span class="hljs-literal">Ok</span>(pipeline)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> filename = <span class="hljs-string">"Tractor_500kbps_x264.mp4"</span>;
    <span class="hljs-keyword">let</span> camera = Camera::new(filename);<font></font>
    camera.run().expect(<span class="hljs-string">"Loop stopped"</span>);<font></font>
}<font></font>
</code></pre></div></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
<th> </th>
<th>  </th>
<th>  </th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenCV</td>
<td>pure</td>
<td>8.733</td>
<td>0.8733</td>
<td>288.5606 fps</td>
</tr>
<tr>
<td>OpenCV</td>
<td>rgb</td>
<td>10.5890</td>
<td>1.0589</td>
<td>237.9828 fps</td>
</tr>
<tr>
<td>GStreamer</td>
<td>pure</td>
<td>5.487</td>
<td>0.5487</td>
<td>459.2673 fps</td>
</tr>
<tr>
<td>GStreamer</td>
<td>yuv_rgb</td>
<td>7.8290</td>
<td>0.7829</td>
<td>321.8802 fps</td>
</tr>
</tbody>
</table></div><br>
<p>   OpenCV    .   GStreamer  ~15%  .            OpenCV.  ,     Python   opencv-python  pypi,     OpenCV,   .    ,   Arch Linux.</p><br>
<p>  ,     GStreamer      OpenCV              . </p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467525/index.html">Angularでモジュールを管理する方法（およびそれだけではない）</a></li>
<li><a href="../ja467529/index.html">CQM-自然言語での検索エンジン最適化のためのディープラーニングの別の見方</a></li>
<li><a href="../ja467531/index.html">反応状態機械</a></li>
<li><a href="../ja467533/index.html">情報のノイズを聞く：誰もが発見してはならない音楽とビデオ</a></li>
<li><a href="../ja467535/index.html">【質問】ロシアではポルノは禁止されていますか？</a></li>
<li><a href="../ja467539/index.html">CA / BフォーラムがSSL証明書を397日に短縮することに反対票を投じた</a></li>
<li><a href="../ja467543/index.html">SSHチャット、パート2</a></li>
<li><a href="../ja467545/index.html">ShIoTiny：ばねまたはリアルタイムのない時計とそれを使用する方法</a></li>
<li><a href="../ja467547/index.html">DNSTapおよびBGPでILVロックをバイパスする</a></li>
<li><a href="../ja467549/index.html">SpaceXは計画よりも早く衛星インターネットネットワークを展開する計画</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>