<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô¶Ô∏è üìà üòª Wir schreiben in PostgreSQL auf einem Sublight: 1 Host, 1 Tag, 1 TB ü§õ ‚õèÔ∏è üôãüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="K√ºrzlich habe ich dar√ºber gesprochen, wie die Standardrezepte verwendet werden k√∂nnen, um die Leistung von SQL-Abfragen aus einer PostgreSQL-Datenbank...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben in PostgreSQL auf einem Sublight: 1 Host, 1 Tag, 1 TB</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/497008/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K√ºrzlich habe ich dar√ºber gesprochen, wie die Standardrezepte verwendet werden k√∂nnen, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um die Leistung von SQL-Abfragen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus einer PostgreSQL-Datenbank zu </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">verbessern</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Heute werden wir dar√ºber sprechen, wie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie das Schreiben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in die Datenbank </font><b><font style="vertical-align: inherit;">effizienter gestalten</font></b><font style="vertical-align: inherit;"> k√∂nnen, ohne ‚ÄûWendungen‚Äú in der Konfiguration zu verwenden - einfach indem Sie die Datenfl√ºsse korrekt organisieren.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lv/ir/or/lvirorsnhddruod1aggj8x4fgei.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1. </font><font style="vertical-align: inherit;">Partitionierung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Artikel dar√ºber, wie und warum es sich lohnt, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angewandte Partitionierung ‚Äûtheoretisch‚Äú zu organisieren,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurde bereits ver√∂ffentlicht. Hier konzentrieren wir uns auf die Praxis, einige Ans√§tze im Rahmen unseres </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberwachungsdienstes f√ºr Hunderte von PostgreSQL-Servern zu verwenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"F√§lle vergangener Tage ..."</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie jedes MVP begann unser Projekt zun√§chst unter relativ geringer Last - die √úberwachung wurde nur f√ºr die zehn kritischsten Server durchgef√ºhrt, alle Tabellen waren relativ kompakt ... Aber die Zeit verging, es gab immer mehr √ºberwachte Hosts und versuchte erneut, etwas damit zu tun Bei einem der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tische mit einer Gr√∂√üe von 1,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> haben wir festgestellt, dass es zwar m√∂glich ist, so </font><b><font style="vertical-align: inherit;">weiterzuleben</font></b><font style="vertical-align: inherit;"> , aber sehr unpraktisch ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zeiten waren fast episch, verschiedene PostgreSQL 9.x-Varianten waren relevant, daher mussten alle Partitionen ‚Äûmanuell‚Äú durchgef√ºhrt werden - durch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabellenvererbung und</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dynamische Routing- </font><b><font style="vertical-align: inherit;">Trigger</font></b></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/-k/sv/tt-ksvme0jrmkz2qzkh8va95pjs.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die resultierende L√∂sung erwies sich als universell genug, um sie in alle Tabellen √ºbersetzen zu k√∂nnen:</font></font><br>
<br>
<ul>
<li>   ¬´¬ª  ,     <b>   </b>.</li>
<li>       ¬´¬ª ,     <b> </b> <code>BEFORE INSERT</code>  ¬´¬ª    .      ‚Äî     ...</li>
<li>‚Ä¶   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>CREATE TABLE ... (LIKE ... INCLUDING ...)</code></a>      <b>     </b>,         .</li>
</ul><br>
<h4>PG10:  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Partitionierung durch Vererbung war jedoch in der Vergangenheit nicht gut geeignet, um mit einem aktiven Schreibstrom oder einer gro√üen Anzahl von Nachkommenabschnitten zu arbeiten. </font><font style="vertical-align: inherit;">Sie k√∂nnen sich beispielsweise daran erinnern, dass der Algorithmus zur Auswahl des gew√ºnschten Abschnitts eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quadratische Komplexit√§t</font></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
aufwies und </font><font style="vertical-align: inherit;">mit mehr als 100 Abschnitten funktioniert. Sie verstehen, wie ... </font><font style="vertical-align: inherit;">In PG10 wurde diese Situation durch die Implementierung der Unterst√ºtzung f√ºr die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">native Partitionierung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erheblich optimiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Daher haben wir sofort versucht, es unmittelbar nach der Migration des Speichers anzuwenden, aber ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sich nach dem Ausgraben des Handbuchs herausstellte, war die nativ partitionierte Tabelle in dieser Version:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterst√ºtzt keine Beschreibung von Indizes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterst√ºtzt keine Trigger darauf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kann selbst kein "Nachkomme" sein</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht unterst√ºtzen </font></font><code>INSERT ... ON CONFLICT</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschnitt kann nicht automatisch erzeugt werden</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als wir schmerzhaft einen Rechen auf die Stirn bekamen, stellten wir fest, dass wir nicht auf eine √Ñnderung der Anwendung verzichten konnten, und schoben die weitere Forschung um sechs Monate auf.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PG10: Zweite Chance</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also begannen wir, die Probleme der Reihe nach zu l√∂sen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Da sich die Trigger </font></font><code>ON CONFLICT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an einigen Stellen als notwendig herausstellten, haben wir eine Zwischen- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxy-Tabelle erstellt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um sie zu ermitteln </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben das "Routing"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Triggern beseitigt - das hei√üt von </font></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie nahmen eine separate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorlagentabelle mit allen Indizes heraus,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so dass sie nicht einmal in der Proxy-Tabelle vorhanden waren.</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sn/3h/ra/sn3hrac9yg0-hrifkjszy7fhih0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schlie√ülich wurde die Haupttabelle bereits nativ partitioniert. </font><font style="vertical-align: inherit;">Das Erstellen eines neuen Abschnitts bleibt im Gewissen der Anwendung.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W√∂rterb√ºcher ‚Äûs√§gen‚Äú</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie in jedem Analysesystem hatten wir auch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄûFakten‚Äú und ‚ÄûSchnitte‚Äú</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (W√∂rterb√ºcher). In unserem Fall handelte es sich in dieser Eigenschaft beispielsweise um den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hauptteil der ‚ÄûVorlage‚Äú des</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gleichen Typs langsamer Abfragen oder um den Text der Abfrage selbst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unsere "Fakten" waren lange Zeit nach Tagen unterteilt, so dass wir die veralteten Abschnitte ruhig l√∂schten und sie uns nicht st√∂rten (Protokolle!). Aber mit den W√∂rterb√ºchern stellte sich das Problem </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
heraus </font><font style="vertical-align: inherit;">... </font><font style="vertical-align: inherit;">Um nicht zu sagen, dass es viele davon gab, aber ungef√§hr </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100 TB ‚ÄûFakten‚Äú erwiesen sich als W√∂rterbuch f√ºr 2,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sie k√∂nnen bequemerweise nichts aus einer solchen Tabelle l√∂schen, Sie werden es nicht rechtzeitig dr√ºcken, und das Schreiben darauf wurde allm√§hlich langsamer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint wie ein W√∂rterbuch ... darin sollte jeder Eintrag genau einmal pr√§sentiert werden ... und das ist richtig, aber! .. Niemand st√∂rt uns, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºr jeden Tag ein eigenes W√∂rterbuch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu haben </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Ja, dies bringt eine gewisse Redundanz mit sich, erm√∂glicht Ihnen jedoch Folgendes:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben / Lesen schneller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aufgrund kleinerer Abschnittsgr√∂√üe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbrauchen Sie weniger Speicher,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indem Sie mit kompakteren Indizes arbeiten</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speichern Sie weniger Daten,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da veraltete </font><b><font style="vertical-align: inherit;">Daten</font></b><font style="vertical-align: inherit;"> schnell entfernt werden k√∂nnen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolge des gesamten Ma√ünahmenkomplexes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verringerte sich die CPU-Auslastung um ~ 30% und die Festplatte um ~ 50%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/re/uf/x0/reufx0_4pxhj6cci456x4eb6j8q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig haben wir weiterhin genau dasselbe in die Datenbank geschrieben, nur mit weniger Last.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">Datenbankentwicklung und Refactoring</font></font></h2><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben uns also darauf geeinigt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
, dass </font><b><font style="vertical-align: inherit;">wir f√ºr jeden Tag einen eigenen Abschnitt</font></b><font style="vertical-align: inherit;"> mit Daten haben. Tats√§chlich ist dies </font></font><code>CHECK (dt = '2018-10-12'::date)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Partitionierungsschl√ºssel und die Bedingung, dass der Datensatz in einen bestimmten Abschnitt f√§llt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da alle Berichte in unserem Service nach einem bestimmten Datum erstellt wurden, waren die Indizes aus den "nicht partitionierten Zeiten" alle Arten von ihnen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Server, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datum</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Planvorlage)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Server, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datum</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Plan-Knoten)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datum</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Fehlerklasse, Server)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber jetzt hat jeder Abschnitt </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seine eigenen Instanzen f√ºr</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeden solchen Index ... Und innerhalb jedes Abschnitts ist das </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datum konstant</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... Es stellt sich heraus, dass wir uns jetzt in jedem solchen Index befinden</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir geben trivial eine Konstante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> als eines der Felder ein, wodurch sowohl das Volumen als auch die Suchzeit erh√∂ht werden, aber kein Ergebnis erzielt wird. </font><font style="vertical-align: inherit;">Sie haben einen Rechen hinterlassen, oops ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rv/to/de/rvtodengrwqlkufq8ovxlp71xn4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Richtung der Optimierung liegt auf der Hand - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entfernen Sie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einfach </font><b><font style="vertical-align: inherit;">das Datumsfeld aus allen Indizes</font></b><font style="vertical-align: inherit;"> f√ºr partitionierte Tabellen. </font><font style="vertical-align: inherit;">Bei unseren Volumina betr√§gt der Gewinn ungef√§hr </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 TB / Woche</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt bemerken wir, dass dieses Terabyte noch irgendwie aufgeschrieben werden musste. </font><font style="vertical-align: inherit;">Das hei√üt, wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√ºssen jetzt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auch </font><b><font style="vertical-align: inherit;">weniger Festplatte laden</font></b><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">In diesem Bild ist der Effekt der Reinigung, der wir eine Woche gewidmet haben, deutlich sichtbar:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/4d/dv/x04ddvnrw9ga5m5gt4fukn44vza.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3 </font><font style="vertical-align: inherit;">Die Spitzenlast ‚Äûverschmieren‚Äú</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines der gro√üen Probleme geladener Systeme ist die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ºberm√§√üige Synchronisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einiger Vorg√§nge, f√ºr die dies nicht erforderlich ist. Manchmal "weil sie es nicht bemerkt haben", manchmal "es war einfacher", aber fr√ºher oder sp√§ter muss man es loswerden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir bringen das vorherige Bild n√§her - und wir sehen, dass die Scheibe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einer Last mit doppelter Amplitude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zwischen benachbarten Proben </font><b><font style="vertical-align: inherit;">"wackelt"</font></b><font style="vertical-align: inherit;"> , was bei so vielen Operationen offensichtlich nicht "statistisch" sein sollte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p4/9v/bw/p49vbwkzasfbjhcnudcmsqaxgaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies zu erreichen ist recht einfach. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast 1000 Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurden bereits f√ºr die √úberwachung eingerichtet </font><font style="vertical-align: inherit;">, jeder wird von einem separaten logischen Stream verarbeitet, und jeder Stream speichert die gesammelten Informationen zum Senden an die Datenbank mit einer bestimmten H√§ufigkeit, etwa wie folgt:</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem liegt hier genau darin, dass </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alle Threads ungef√§hr zur gleichen Zeit beginnen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so dass die Sendezeiten f√ºr sie fast immer ‚Äûauf den Punkt‚Äú fallen. </font><font style="vertical-align: inherit;">Ups Nr. 2 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gl√ºcklicherweise kann dies leicht durch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzuf√ºgen einer "zuf√§lligen" Zeitspanne</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> korrigiert werden </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval * (<span class="hljs-number">1</span> + <span class="hljs-number">0.1</span> * (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>)))</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4. </font><font style="vertical-align: inherit;">Caching, das </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muss</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sein</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das dritte traditionelle Hochlastproblem ist das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlen eines Caches,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wo es sein </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k√∂nnte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel haben wir es m√∂glich gemacht, die Aufteilung der Knoten des Plans (alle diese </font></font><code>Seq Scan on users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">zu analysieren </font><font style="vertical-align: inherit;">, aber sofort vergessen, dass sie im Wesentlichen gleich sind und vergessen haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nein, nat√ºrlich wird nichts wiederholt in die Datenbank geschrieben, dies unterbricht den Trigger mit </font></font><code>INSERT ... ON CONFLICT DO NOTHING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die Daten erreichen die Basis jedoch ohnehin nicht und Sie m√ºssen zus√§tzliche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lesevorg√§nge durchf√ºhren, um den Konflikt zu √ºberpr√ºfen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hoppla Nr. 3 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Unterschied in der Anzahl der Datens√§tze, die vor / nach dem Aktivieren des Caching an die Datenbank gesendet wurden, ist offensichtlich: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/ed/jm/nuedjmsij1za8mx-dhkcvg36baw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dies ist ein gleichzeitiger R√ºckgang der Speicherlast:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oc/bx/hz/ocbxhzmmplggqzowyekkkl2lsk0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terabyte pro Tag klingt nur be√§ngstigend. </font><font style="vertical-align: inherit;">Wenn Sie alles richtig machen, sind dies nur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 ^ 40 Bytes / 86400 Sekunden = ~ 12,5 MB / s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die sogar Desktop-IDE-Schrauben halten. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber im Ernst, selbst mit einem zehnfachen ‚ÄûVersatz‚Äú der Last w√§hrend des Tages k√∂nnen Sie die M√∂glichkeiten moderner SSDs leicht erf√ºllen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/7l/e5/in7le5modvgype2possbfitaqxy.jpeg"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496996/index.html">Merkmale der datengesteuerten Petrochemie</a></li>
<li><a href="../de496998/index.html">Wie ungeschultes Gehirn die Welt im Zeitalter des Coronavirus zerst√∂rt</a></li>
<li><a href="../de497000/index.html">Power Automate VS Logic Apps. Funktionen Logik-Apps</a></li>
<li><a href="../de497004/index.html">Verwerfen Sie die Aktivierung (TRIM) unter Linux f√ºr SSD</a></li>
<li><a href="../de497006/index.html">MITM-Angriffe von Dom.ru.</a></li>
<li><a href="../de497010/index.html">In Zeiten des Marktabschwungs investieren: 3 Strategien f√ºr das Verhalten an der B√∂rse</a></li>
<li><a href="../de497014/index.html">Wer sind Sie, QS-Ingenieur oder Tester?</a></li>
<li><a href="../de497016/index.html">13. April Java Digest</a></li>
<li><a href="../de497020/index.html">DocuSign, ein beliebter digitaler Signaturdienst, unterst√ºtzt jetzt die GlobalSign-Infrastruktur</a></li>
<li><a href="../de497022/index.html">Aktualisieren des Unternehmensnetzwerkzugriffs. Neue ExtremeSwitching X435 Gigabit-Switches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>