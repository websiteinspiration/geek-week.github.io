<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤧 📭 🦐 Comience a recopilar errores en las funciones de copia 🍷 🚾 🚛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="He notado varias veces que los programadores cometen errores en funciones simples de copia de datos. Este tema requerirá mucho más tiempo en el futuro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comience a recopilar errores en las funciones de copia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/495642/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/741/90d/4d9/74190d4d9f31774d50d91381d3f3f536.png" alt="memcpy"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He notado varias veces que los programadores cometen errores en funciones simples de copia de datos. </font><font style="vertical-align: inherit;">Este tema requerirá mucho más tiempo en el futuro para estudiar y seleccionar material para escribir un artículo completo. </font><font style="vertical-align: inherit;">Pero quería compartir un par de ejemplos que noté recientemente.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿El fenómeno Baadera-Meinhof? </font><font style="vertical-align: inherit;">No, no lo creo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como miembro del equipo PVS-Studio, encuentro una gran cantidad de errores que descubrimos en varios proyectos. Me gusta DevRel: me gusta hablar de eso :). Hoy decidí hablar sobre las funciones de copia de datos implementadas incorrectamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me he encontrado con tales funciones fallidas más de una vez. Pero no los escribí, porque no le di ninguna importancia a esto. Sin embargo, desde que noté esta tendencia, es hora de comenzar a recopilarlos. Para comenzar, compartiré los dos últimos casos notados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguien puede argumentar que hay dos casos: esto no es una regularidad. Y eso, tal vez, llamé la atención sobre ellos únicamente porque me conocieron después de un corto período de tiempo y desencadenaron el fenómeno </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baader-Meinhof</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El fenómeno Baader-Meinhof, también la ilusión de frecuencia, es una distorsión cognitiva en la que la información recientemente descubierta que aparece nuevamente después de un corto período de tiempo se percibe como inusualmente frecuente. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que esto no es así. </font><font style="vertical-align: inherit;">Ya tenía la experiencia de tal observación sobre las funciones de comparación, que luego fue confirmada por el material recopilado: "El </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mal vive en las funciones de comparación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien, vamos al grano. </font><font style="vertical-align: inherit;">La introducción para dar solo dos ejemplos hasta ahora ha sido demasiado larga :).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo N1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artículo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre la verificación Zephyr RTOS, describí un intento fallido de implementar la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strdup analógica</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {<font></font>
    ((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;
    <span class="hljs-built_in">memcpy</span>(cpy_mntpt, mntpt, <span class="hljs-built_in">strlen</span>(mntpt));<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Advertencia de PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V575</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-628] La función 'memcpy' no copia toda la cadena. </font><font style="vertical-align: inherit;">Use la función 'strcpy / strcpy_s' para preservar la terminal nula. </font><font style="vertical-align: inherit;">shell.c 427 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El analizador informa que la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcpy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> copia la línea, pero no copia el terminal cero, y esto es muy sospechoso. </font><font style="vertical-align: inherit;">Parece que este terminal 0 se copia aquí:</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, hay un error tipográfico aquí, debido a que el terminal cero se copia a sí mismo. </font><font style="vertical-align: inherit;">Tenga en cuenta que escribir en la matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpy_mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como resultado, la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt_prepare</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelve una cadena que está incompleta con un terminal cero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, el programador quería escribir así:</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)cpy_mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No está claro por qué el código está escrito de manera tan confusa y no estándar. </font><font style="vertical-align: inherit;">Como resultado, se cometió un grave error en una función pequeña y sin complicaciones. </font><font style="vertical-align: inherit;">Este código se puede simplificar a la siguiente opción:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {
    <span class="hljs-built_in">strcpy</span>(cpy_mntpt, mntpt);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo N2</font></font></h2><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">myMemCpy</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dest, <span class="hljs-keyword">void</span> *src, <span class="hljs-keyword">size_t</span> n)</span> 
</span>{ 
   <span class="hljs-keyword">char</span> *csrc = (<span class="hljs-keyword">char</span> *)src; 
   <span class="hljs-keyword">char</span> *cdest = (<span class="hljs-keyword">char</span> *)dest; 
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++) <font></font>
     cdest[i] = csrc[i]; <font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No identificamos este código nosotros mismos usando PVS-Studio, pero accidentalmente lo encontré en el sitio web de StackOverflow: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C y análisis de código estático: ¿Es esto más seguro que memcpy? </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, si marca esta función utilizando el analizador PVS-Studio, notará correctamente:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V104</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conversión implícita de 'i' a tipo memsize en una expresión aritmética: i &lt;n test.cpp 26</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V108</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tipo de índice incorrecto: cdest [no es de tipo memsize]. </font><font style="vertical-align: inherit;">Utilice el tipo memsize en su lugar. </font><font style="vertical-align: inherit;">test.cpp 27</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V108</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tipo de índice incorrecto: csrc [no es de tipo memsize]. </font><font style="vertical-align: inherit;">Utilice el tipo memsize en su lugar. </font><font style="vertical-align: inherit;">test.cpp 27</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, este código contiene una falla, como se indica en las respuestas a StackOverflow. No puede usar una variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como índice </font><font style="vertical-align: inherit;">. En un programa de 64 bits, casi con certeza (no consideramos arquitecturas exóticas), la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> será de 32 bits y la función no podrá copiar más de INT_MAX bytes. Aquellos. No más de 2 gigabytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con un búfer más grande para copiar, se producirá un desbordamiento de la variable de signo, que desde el punto de vista de C y C ++ es un comportamiento indefinido. Y, por cierto, no intente adivinar exactamente cómo se manifestará el error. Este es en realidad un tema difícil, sobre el que puede leer en el artículo "El </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comportamiento indefinido está más cerca de lo que piensa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es especialmente divertido que este código apareciera como un intento de eliminar alguna advertencia del analizador Checkmarx que se produjo cuando se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llamó a la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> función </font><i><font style="vertical-align: inherit;">memcpy</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El programador no encontró nada mejor que hacer su propia bicicleta. </font><font style="vertical-align: inherit;">Y a pesar de la simplicidad de la función de copia, aún resultó ser incorrecta. </font><font style="vertical-align: inherit;">Es decir, de hecho, la persona probablemente lo hizo aún peor de lo que era. </font><font style="vertical-align: inherit;">En lugar de comprender el motivo de la advertencia, enmascaró el problema escribiendo su propia función (confundiendo el analizador). </font><font style="vertical-align: inherit;">Además agregó un error usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el contador </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ah, sí, ese código aún puede dificultar la optimización. </font><font style="vertical-align: inherit;">Es ineficiente usar su propio código en lugar de la eficiente función de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoria</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimizada </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No hagas esto :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, solo estoy al comienzo del viaje y, probablemente, tomará más de un año antes de que acumule materiales para una publicación exhaustiva sobre este tema. </font><font style="vertical-align: inherit;">En realidad, solo ahora comenzaré a escribir tales casos. </font><font style="vertical-align: inherit;">Gracias por su atención y mire qué interesante encontrará el analizador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en su código C / C ++ / C # / Java.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea compartir este artículo con una audiencia de habla inglesa, utilice el enlace a la traducción: Andrey Karpov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicio de mi colección de errores encontrados en las funciones de copia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495622/index.html">Avión digital con sistema de aire acondicionado gemelo (SLE)</a></li>
<li><a href="../es495624/index.html">¿Por qué la Xbox Series X será la compra principal de 2020?</a></li>
<li><a href="../es495634/index.html">Todos lo hacen: por qué los empleados son la principal amenaza para la seguridad de la información corporativa y cómo lidiar con ella</a></li>
<li><a href="../es495636/index.html">Crear enlaces de Python para bibliotecas C / C ++ usando SIP. Parte 2</a></li>
<li><a href="../es495638/index.html">Coma en inglés: 5 reglas y 3 errores principales</a></li>
<li><a href="../es495644/index.html">TS Total Sight. Herramienta de recopilación de eventos, análisis de incidentes y respuesta a amenazas.</a></li>
<li><a href="../es495646/index.html">Qué podcasts no estresantes para escuchar el fin de semana</a></li>
<li><a href="../es495658/index.html">Dónde obtener audio para el aprendizaje automático: una selección de bibliotecas abiertas bajo licencia Creative Commons</a></li>
<li><a href="../es495660/index.html">NVMe sobre Fibre Channel. ¿Qué es y dónde se necesita?</a></li>
<li><a href="../es495670/index.html">Migración de un Data Lake continuo a un Data Mesh distribuido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>