<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌳 🦏 🧔🏽 IPSec Allmächtig 🧝 👨🏾‍💼 👇🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Nachmittag Freunde. Es ist kein Geheimnis, dass viele von uns mindestens einmal haben, sich aber mit der Notwendigkeit befassen mussten, ein VPN...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Allmächtig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guten Nachmittag Freunde. </font><font style="vertical-align: inherit;">Es ist kein Geheimnis, dass viele von uns mindestens einmal haben, sich aber mit der Notwendigkeit befassen mussten, ein VPN zu konfigurieren. </font><font style="vertical-align: inherit;">Als aktiver Leser von Habr bemerkte ich, dass es trotz der Fülle an Artikeln über IPSec für viele immer noch etwas Kompliziertes und Überladenes zu sein scheint. </font><font style="vertical-align: inherit;">In diesem Artikel werde ich versuchen, diese Mythen anhand meiner eigenen voll funktionsfähigen Konfiguration zu zerstreuen. </font><font style="vertical-align: inherit;">In vier Beispielen werden wir die Konfiguration der beliebtesten Linux-Lösung (Strongswan) vollständig durchgehen, von einem einfachen Tunnel mit Seitenauthentifizierung mit PSK-Schlüsseln bis zu einer Host-zu-Host-Verbindung mit Authentifizierung beider Seiten basierend auf Zertifikaten von Let's Encrypt. </font><font style="vertical-align: inherit;">Interessant? </font><font style="vertical-align: inherit;">Willkommen bei Katze!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ursprünglich war das VPN nur für die Organisation des Kanals zwischen dem Mini-Router der Eltern und dem Heim-Server am Krankenbett geplant, der gleichzeitig als Router fungiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach kurzer Zeit wurde Keenetic von zwei Geräten zu diesem Unternehmen hinzugefügt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber als es anfing, stellte sich heraus, dass es schwierig war aufzuhören, und bald tauchten Telefone und ein Laptop auf dem Diagramm auf, die sich vor dem allsehenden Werbeauge von MT_Free und anderen unverschlüsselten WiFi-Netzwerken verstecken wollten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann wurde der geliebte ILV endlich stärker, der Banhammer, in den er sich unglaublich verliebt hatte, öffentlich in alle Richtungen zu schwingen, und um seine Sorge um bloße Sterbliche zu neutralisieren, musste er </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den ausländischen IT-Sektor unterstützen</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um VPS im Ausland zu erwerben.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus verschwendet eine bestimmte Bürgerin, die wie Shapoklyak aussieht, überall mit ihrem </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fadenkreuz durch das</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket </font><s><font style="vertical-align: inherit;">herum</font></s><font style="vertical-align: inherit;"> und glaubt wahrscheinlich, dass „Wer Menschen hilft, Zeit verschwendet. </font><font style="vertical-align: inherit;">Du kannst nicht berühmt werden für gute Taten. “Ich wollte heimlich einen Blick auf den Verkehr eines anderen werfen und ihn mit Bleistift aufnehmen. </font><font style="vertical-align: inherit;">Wir müssen uns auch gegen solche unaufgeforderte Liebe und VPN verteidigen, in diesem Fall genau das, was der Arzt angeordnet hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eine kurze Zusammenfassung zusammenzufassen. </font><font style="vertical-align: inherit;">Es musste eine Lösung gefunden werden, mit der im Idealfall mehrere Aufgaben gleichzeitig abgeschlossen werden konnten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verbindung zwischen Linux-Routern herstellen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Baue einen Tunnel zwischen Linux und Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ermöglichen Sie tragbaren Geräten (Telefonen, Laptops) aus nicht vertrauenswürdigen Netzwerken den Zugriff auf Heimressourcen und das Internet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen Sie einen sicher verschlüsselten Tunnel zum Remote-VPS</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht das wunderbare KISS-Prinzip - Halten Sie es einfach, dumm. </font><font style="vertical-align: inherit;">Je weniger Komponenten beteiligt sind und je einfacher die Konfiguration der einzelnen Komponenten ist, desto zuverlässiger.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übersicht bestehender Lösungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie kurz auf das ein, was jetzt ist: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP-</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Großvater Lenin aller Protokolle. </font><font style="vertical-align: inherit;">Gestorben, "Verfallen auf Schimmel und Lindenhonig." </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Verwendet dies nur ein Anbieter? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Wireguard-</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Projekt entwickelt sich. </font><font style="vertical-align: inherit;">Aktiv gesägt. </font><font style="vertical-align: inherit;">Es ist einfach, einen Tunnel zwischen zwei Peers mit einer statischen IP zu erstellen. </font><font style="vertical-align: inherit;">In anderen Fällen sind Krücken, Fahrräder mit Vierkanträdern und ein blaues Isolierband immer bereit zu helfen, aber das ist nicht unser Weg. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN-</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vorteile:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unterstützung für mehrere Plattformen - Windows, Linux, OpenWRT und seine Derivate, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Starke Verschlüsselung und Zertifikatsunterstützung.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibilität der Anpassung.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Und Nachteile:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arbeiten Sie vollständig im Benutzerbereich.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eingeschränkte Unterstützung durch Heimrouter - krenenko-kosenko auf Mikrotik (ohne die anderen Vorteile der Drüsen zu beeinträchtigen) und normal in OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schwierigkeiten beim Einrichten mobiler Clients: Sie müssen Konfigurationen irgendwo herunterladen oder ein eigenes Installationsprogramm erstellen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn es mehrere Tunnel gibt, warten Tänze mit der Bearbeitung der Systemeinheiten auf dem Server.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (Open-Source-Implementierung des Cisco Anyconnect-Protokolls)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Eine sehr interessante Lösung, über die leider einige Informationen </font><b><font style="vertical-align: inherit;">vorliegen</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vorteile:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Relativ breite Unterstützung für verschiedene Plattformen - Windows, Android, Mac basierend auf der nativen Cisco Anyconnect-Anwendung aus dem Store - ist eine ideale Option, um Zugriff auf das interne Netzwerk tragbarer Geräte zu erhalten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Starke Verschlüsselung, Zertifikatunterstützung, 2FA-Konnektivität</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Protokoll selbst ist vollständig TLS-basiert (im Gegensatz zu OpenVPN, das an Port 443 leicht erkannt werden kann). </font><font style="vertical-align: inherit;">Neben TLS wird auch DTLS unterstützt. Während der eingerichteten Sitzung kann der Client auf die Datenübertragung über UDP umschalten und umgekehrt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hervorragende Koexistenz an einem Port eines VPN und eines vollwertigen Webservers mit Sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Einfache Einrichtung von Server und Clients.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier waren nicht ohne Nachteile:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arbeiten Sie vollständig im Benutzerbereich.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP über TCP ist eine schlechte Idee.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es gibt keine Unterstützung durch Geräte vom Kunden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die Komplexität der Installation von Tunneln zwischen zwei Linux: theoretisch möglich, praktisch - es ist besser, Zeit mit etwas Nützlicherem zu verbringen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn es mehrere Tunnel gibt, warten Tänze mit mehreren Konfigurationen und Bearbeitungssystemen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint eine Sackgasse zu sein, aber nachdem ich genauer hinschaute und ein wenig Zeit mit dem Lernen verbracht hatte, wurde mir klar, dass IPSec auf IKEv2-Basis alles andere ersetzen kann. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC-Vorteile</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mit dem Aufkommen von IKEv2 ist das Protokoll selbst im Vergleich zur vorherigen Version einfacher zu konfigurieren, jedoch auf Kosten des Verlusts der Abwärtskompatibilität.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dank der Standardisierung wird überall und an allem gearbeitet - die Liste kann unbegrenzt gepflegt werden. </font><font style="vertical-align: inherit;">Linux, Mikrotik (in den neuesten Versionen von RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows bietet ab Windows 7 auch native Unterstützung.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hohe Geschwindigkeit: Verkehrsverarbeitung komplett im Kernel-Space. </font><font style="vertical-align: inherit;">Der User-Space-Teil wird nur zum Festlegen von Verbindungsparametern und zum Überwachen des Kanalzustands benötigt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die Möglichkeit, mehrere Authentifizierungsmethoden zu verwenden: sowohl PSK als auch Zertifikate und in beliebiger Kombination.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verschiedene Betriebsarten: Tunnel und Transport. </font><font style="vertical-align: inherit;">Wie sie sich unterscheiden, kann man auch auf Habré nachlesen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unerwünschte Einstellungen für Zwischenknoten: Wenn in der ersten Version von IKE Probleme durch NAT verursacht wurden, verfügt IKEv2 über integrierte Mechanismen zur Überwindung von NAT und der nativen Fragmentierung von IKE-Nachrichten, mit denen Sie eine Verbindung auf Kanälen mit einer MTU-Kurve herstellen können. </font><font style="vertical-align: inherit;">Mit Blick auf die Zukunft werde ich sagen, dass ich in der Praxis noch nie auf ein WiFi-Netzwerk gestoßen bin, wo immer ein Client eine Verbindung herstellen kann.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachteile haben jedoch auch:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie müssen einige Zeit damit verbringen, zu studieren und zu verstehen, wie es funktioniert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Funktion, die einen Neuling verwirren kann: IPSec erstellt im Gegensatz zu herkömmlichen VPN-Lösungen keine Netzwerkschnittstellen. </font><font style="vertical-align: inherit;">Es werden nur Richtlinien für die Verkehrsverarbeitung festgelegt, alles andere wird mithilfe einer Firewall gelöst.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor wir mit dem Setup fortfahren, gehen wir davon aus, dass der Leser mit den grundlegenden Konzepten und Begriffen bereits ein wenig vertraut ist. </font><font style="vertical-align: inherit;">Um Anfängern zu helfen, können Sie einen Artikel von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und Habr selbst </font><font style="vertical-align: inherit;">empfehlen </font><font style="vertical-align: inherit;">, zu dem es bereits interessante und nützliche Artikel zu diesem Thema gibt.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Schritte beim Einrichten</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir uns für die Entscheidung entschieden haben, fahren wir mit der Konfiguration fort. </font><font style="vertical-align: inherit;">Das Netzwerkdiagramm hat in meinem Fall das folgende Formular (unter dem Spoiler entfernt)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netzwerkdiagramm</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist der </font><b><font style="vertical-align: inherit;">Heimserver,</font></b><font style="vertical-align: inherit;"> der das Zentrum des Netzwerks darstellt. Externe IP 1.1.1.1. Ein internes Netzwerk 10.0.0.0/23 und eine andere Adresse 10.255.255.1/30 zum Einrichten einer privaten BGP-Sitzung mit VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein Linux-Router, der auf einem kleinen, leisen Nettop basiert, das von den Eltern installiert wurde. Der ISP gibt eine dynamische IP-Adresse aus. Internes Netzwerk 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scharfetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> Router mit installiertem IPSec. Der ISP gibt eine dynamische IP-Adresse aus. Internes Netzwerk 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Straßenkämpfer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tragbare Geräte, die Verbindungen von nicht vertrauenswürdigen Netzwerken herstellen. Adressen werden dynamisch an Clients ausgegeben, wenn sie über den internen Pool verbunden sind (10.1.1.0/24). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS außerhalb der Gerichtsbarkeit eines angesehenen ILV. </font><font style="vertical-align: inherit;">Externe IP - 5.5.5.5, interne Adresse 10.255.255.2/30 zum Einstellen einer privaten BGP-Sitzung.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erster Schritt. </font><font style="vertical-align: inherit;">Von einfach bis komplex: Tunnel mit Pre-Shared Keys (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf beiden Linux-Boxen installieren wir die notwendigen Pakete:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Öffnen Sie auf beiden Hosts die Ports 500 / udp, 4500 / udp und lassen Sie den Durchgang des ESP-Protokolls zu. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie die Datei /etc/strongswan/ipsec.secrects (auf der Hostseite ipsecgw.example.com) und fügen Sie die folgende Zeile hinzu:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der zweiten Seite ähnlich:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall ist die ID eine fiktive E-Mail-Adresse. </font><font style="vertical-align: inherit;">Weitere Informationen finden Sie im offiziellen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geheimnisse gespeichert, weitergehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie auf dem Host ipsecgw.example.com die Datei /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In ähnlicher Weise bearbeiten wir auf dem Remote-Peer /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie die Konfigurationen vergleichen, können Sie sehen, dass sie fast gespiegelt sind. Nur die Definitionen von Peers werden ausgetauscht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Anweisung </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bewirkt, dass charon eine Falle für Datenverkehr setzt, der in die Anweisungen left / rightsubnet (Verkehrsselektoren) fällt. </font><font style="vertical-align: inherit;">Die Koordination der Tunnelparameter und des Schlüsselaustauschs beginnt unmittelbar nach dem Auftreten von Verkehr, der unter die gegebenen Bedingungen fällt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem Server ipsecgw.example.com in den Firewall-Einstellungen verbieten wir das Maskieren für ein 10.0.3.0/24-Netzwerk. </font><font style="vertical-align: inherit;">Paketweiterleitung zwischen 10.0.0.0/23 und 10.0.3.0/24 zulassen und umgekehrt. </font><font style="vertical-align: inherit;">Auf dem Remote-Host führen wir ähnliche Einstellungen durch, indem wir die Maskierung für das 10.0.0.0/23-Netzwerk deaktivieren und die Weiterleitung einrichten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir starten strongswan auf beiden Servern neu und versuchen, den zentralen Knoten zu pingen:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie sicher, dass alles funktioniert:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist auch nützlich sicherzustellen, dass der Parameter make_before_break in der Datei /etc/strongswan/strongswan.d/charon.conf bei allen Peers auf yes gesetzt ist. </font><font style="vertical-align: inherit;">In diesem Fall löscht der Charon-Daemon, der das IKEv2-Protokoll bedient, die aktuelle Sicherheitszuordnung während des Schlüsseländerungsvorgangs nicht, sondern erstellt zuerst eine neue.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schritt zwei </font><font style="vertical-align: inherit;">Das Erscheinen von Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine angenehme Überraschung war das in die offizielle Keenetic-Firmware integrierte IPSec-VPN. </font><font style="vertical-align: inherit;">Um es zu aktivieren, gehen Sie einfach zu den </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KeeneticOS-Komponenteneinstellungen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und fügen Sie das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket hinzu </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir bereiten die Einstellungen auf dem zentralen Knoten dafür vor: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie /etc/strongswan/ipsec.secrects und fügen Sie die PSK für den neuen Peer hinzu:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie /etc/strongswan/ipsec.conf und fügen Sie am Ende eine weitere Verbindung hinzu:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Keenetic-Seite erfolgt die Konfiguration in der WebUI über den Pfad: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Verbindungen -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andere Verbindungen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es ist ziemlich einfach</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 Bilder)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie vorhaben, ein erhebliches Verkehrsaufkommen durch den Tunnel zu leiten, können Sie versuchen, die Hardwarebeschleunigung zu aktivieren, die von vielen Modellen unterstützt wird. </font><font style="vertical-align: inherit;">Aktiviert durch den </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardwarebefehl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der </font><b><font style="vertical-align: inherit;">Crypto Engine</font></b><font style="vertical-align: inherit;"> in der CLI. </font><font style="vertical-align: inherit;">So deaktivieren und verarbeiten Sie Verschlüsselungs- und Hashing-Prozesse mithilfe allgemeiner CPU-Anweisungen - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crypto Engine-Software</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nach dem Speichern der Einstellungen stellen wir strongswan wieder her und lassen Keenetic eine halbe Minute nachdenken. </font><font style="vertical-align: inherit;">Dann sehen wir im Terminal eine erfolgreiche Verbindung:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alles arbeitet:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schritt drei </font><font style="vertical-align: inherit;">Schutz mobiler Geräte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Lesen einer Reihe von Handbüchern und Artikeln wurde beschlossen, bei einer Reihe von kostenlosen Zertifikaten von Let's Encrypt anzuhalten, um den Server und die klassische Autorisierung durch Login und Passwort für Clients zu authentifizieren. </font><font style="vertical-align: inherit;">Auf diese Weise müssen wir keine eigene PKI-Infrastruktur mehr unterhalten, den Ablauf von Schlüsseln überwachen und unnötige Gesten mit Mobilgeräten ausführen, indem wir selbstsignierte Zertifikate in der vertrauenswürdigen Liste installieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie die fehlenden Pakete:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir erhalten das Standalone-Zertifikat (vergessen Sie nicht, zuerst 80 / tcp in den iptables-Einstellungen zu öffnen):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem certbot seine Arbeit abgeschlossen hat, müssen wir Strongswan beibringen, unser Zertifikat zu sehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie im Verzeichnis /etc/strongswan/ipsec.d/cacerts zwei symbolische Links: einen zum Stammspeicher vertrauenswürdiger Zertifikate in / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">und eine Sekunde mit dem Namen ca.pem, der auf /etc/letsencrypt/live/ipsecgw.example.com/chain.pem verweist</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Verzeichnis /etc/strongswan/ipsec.d/certs werden außerdem zwei Symlinks erstellt: Der erste mit dem Namen certificate.pem bezieht sich auf die Datei /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">Und die zweite mit dem Namen fullchain.pem, die auf /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem verweist</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Platzieren Sie im Verzeichnis /etc/strongswan/ipsec.d/private den Symlink key.pem, der auf den von certbot generierten privaten Schlüssel verweist und auf dem Pfad /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem liegt</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie ipsec.secrets eine Authentifizierung über RSA und eine Reihe von Anmeldungen / Kennwörtern für neue Benutzer hinzu:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir starten Strongswan neu und wenn wir sudo strongswan listcerts aufrufen, sollten wir die Zertifikatinformationen sehen:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann beschreiben wir die neue Verbindung in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht, die Datei / etc / sysconfig / certbot zu bearbeiten, um anzuzeigen, dass das Zertifikat auch als eigenständig aktualisiert wird, und fügen Sie CERTBOT_ARGS = "- standalone" hinzu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie auch nicht, den Timer certbot-erneuern.timer einzuschalten und den Hook so einzustellen, dass Strongswan neu gestartet wird, falls ein neues Zertifikat ausgestellt wird. </font><font style="vertical-align: inherit;">Platzieren Sie dazu entweder ein einfaches Bash-Skript in / etc / letsencrypt / erneueral-hooks / deploy / oder bearbeiten Sie die Datei / etc / sysconfig / certbot erneut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir starten Strongswan neu, aktivieren die Maskierung für das 10.1.1.0/24-Netzwerk in iptables und konfigurieren anschließend mobile Geräte.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Anwendung von Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir starten und erstellen eine neue</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir speichern das Profil, stellen eine Verbindung her und müssen uns nach einer Sekunde keine Sorgen mehr machen, dass jemand uns ausspionieren kann.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir überprüfen:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows der aktuellen Versionen war angenehm überrascht. </font><font style="vertical-align: inherit;">Die gesamte Konfiguration des neuen VPN erfolgt durch Aufrufen von zwei PowerShell-Cmdlets:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und noch etwas, wenn Strongswan so konfiguriert ist, dass es IPv6-Adressen an Clients ausgibt (ja, das kann er auch):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vierter Teil, Finale. </font><font style="vertical-align: inherit;">Wir haben ein Fenster nach Europa geschnitten</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem die Provider-Stubs „Die Website wurde durch die Entscheidung der linken Ferse des fünften stellvertretenden Staatsanwalts des Dorfes Trudovye Mozoli im Landkreis Bogozabyt blockiert“ erschienen, erschien ein kleiner, unauffälliger VPS (mit dem gut klingenden Domainnamen rkn.example.com) tausend Kilometer von Affen entfernt, die gerne mit einem Banhammer winken und Netzwerke von Größe blockieren / 16 auf einmal. Und dieses kleine VPS zu drehen war eine wundervolle Kreation von Kollegen von NIC.CZ namens BIRD. Der Vogel der ersten Version starb ständig in Panik an der Aktivität von Affen mit Schlagstöcken, die auf dem Höhepunkt ihrer Arbeitstätigkeit fast 4% des Internets verboten und während der Neukonfiguration tief nachdenklich blieben. Daher wurde er auf Version 2.0.7 aktualisiert. Wenn Leser interessiert sind, werde ich einen Artikel über den Übergang von BIRD zu BIRD2 veröffentlichen, in dem sich das Konfigurationsformat dramatisch geändert hat.Die neue Version ist jedoch viel schneller geworden und es gibt keine Probleme bei der Neukonfiguration mit einer großen Anzahl von Routen. Und da wir das dynamische Routing-Protokoll verwenden, muss es eine Netzwerkschnittstelle geben, über die Sie den Verkehr weiterleiten müssen. Standardmäßig erstellt IPSec keine Schnittstellen, aber aufgrund seiner Flexibilität können wir die klassischen GRE-Tunnel verwenden, die wir in Zukunft schützen werden. Als Bonus authentifizieren sich die Hosts ipsecgw.example.com und rkn.example.com gegenseitig mit sich selbst erneuernden Lets Encrypt-Zertifikaten. Kein PSK, nur Zertifikate, nur Hardcore, es gibt nicht viel Sicherheit.Standardmäßig erstellt IPSec keine Schnittstellen, aber aufgrund seiner Flexibilität können wir die klassischen GRE-Tunnel verwenden, die wir in Zukunft schützen werden. Als Bonus authentifizieren sich die Hosts ipsecgw.example.com und rkn.example.com gegenseitig mit sich selbst erneuernden Lets Encrypt-Zertifikaten. Kein PSK, nur Zertifikate, nur Hardcore, es gibt nicht viel Sicherheit.Standardmäßig erstellt IPSec keine Schnittstellen, aber aufgrund seiner Flexibilität können wir die klassischen GRE-Tunnel verwenden, die wir in Zukunft schützen werden. Als Bonus authentifizieren sich die Hosts ipsecgw.example.com und rkn.example.com gegenseitig mit sich selbst erneuernden Lets Encrypt-Zertifikaten. Kein PSK, nur Zertifikate, nur Hardcore, es gibt nicht viel Sicherheit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir glauben, dass der VPS vorbereitet ist, Strongswan und Certbot bereits installiert sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem Host ipsecgw.example.com (seine IP ist 1.1.1.1) beschreiben wir die neue gif0-Schnittstelle:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem Host vps.example.com gespiegelt (seine IP ist 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir erhöhen die Schnittstellen, aber da iptables keine Regel hat, die das GRE-Protokoll zulässt, wird der Datenverkehr nicht unterbrochen (was wir brauchen, da es in GRE keinen Schutz gegen Fans jeglicher Art von gesetzgeberischen „Paketen“ gibt).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kochen VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst erhalten wir ein weiteres Zertifikat für den Domainnamen rkn.example.com. </font><font style="vertical-align: inherit;">Erstellen Sie Symlinks in /etc/strongswan/ipsec.d, wie im vorherigen Abschnitt beschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie ipsec.secrets, indem Sie eine einzelne Zeile hinzufügen:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie die ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Hostseite wird ipsecgw.example.com auch zu ipsec.conf im Setup-Abschnitt mit dem Parameter strictcrlpolicy = yes hinzugefügt, der eine strikte CRL-Prüfung umfasst. </font><font style="vertical-align: inherit;">Und beschreiben Sie eine andere Verbindung:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurationen werden fast gespiegelt. </font><font style="vertical-align: inherit;">Der aufmerksame Leser konnte bereits einige Punkte beachten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% dynamic - Weist Strongswan an, Richtlinien auf alle Arten von Datenverkehr zwischen Peers anzuwenden</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht, die Firewall zu konfigurieren und Zertifikate automatisch zu erneuern. </font><font style="vertical-align: inherit;">Beginnen Sie nach dem Neustart von Strongswan auf beiden Servern mit dem Ping auf der anderen Seite des GRE-Tunnels und sehen Sie eine erfolgreiche Verbindung. </font><font style="vertical-align: inherit;">Auf VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und auf der Hostseite ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unter dem Spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Tunnel ist installiert, Pings gehen, in tcpdump ist sichtbar, dass nur ESP zwischen Hosts geht. </font><font style="vertical-align: inherit;">Es scheint möglich zu sein, sich zu freuen. </font><font style="vertical-align: inherit;">Aber Sie können sich nicht entspannen, ohne alles bis zum Ende zu überprüfen. </font><font style="vertical-align: inherit;">Wir versuchen, das Zertifikat für VPS und ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, es ist alles kaputt</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir beginnen ein unangenehmes Merkmal von Let's Encrypt zu verstehen und zu stolpern, das in allem anderen schön ist - bei jeder Neuausstellung des Zertifikats ändert sich auch der damit verbundene private Schlüssel. Der private Schlüssel hat sich geändert - und der öffentliche hat sich geändert. Auf den ersten Blick ist die Situation für uns hoffnungslos: Selbst wenn wir den öffentlichen Schlüssel während der erneuten Ausstellung des Zertifikats mithilfe des Hooks in certbot leicht extrahieren und über SSH an die Remote-Seite weitergeben können, ist nicht klar, wie der Remote-Strongswan ihn erneut lesen kann. Die Hilfe kam jedoch von dort, wo sie nicht gewartet haben - systemd kann Änderungen am Dateisystem überwachen und die mit dem Ereignis verbundenen Dienste ausführen. Dies werden wir verwenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden auf jedem der Hosts mit den am stärksten eingeschränkten Rechten einen Keywatcher-Dienstbenutzer erstellen, für jeden von ihnen SSH-Schlüssel generieren und diese zwischen den Hosts austauschen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie auf dem Host ipsecgw.example.com das Verzeichnis / opt / ipsec-pubkey, in dem wir zwei Skripte ablegen.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf VPS (dem Host rkn.example.com) erstellen wir auf ähnliche Weise ein Verzeichnis mit demselben Namen, in dem wir auch ähnliche Skripte erstellen und nur den Namen des Schlüssels ändern. </font><font style="vertical-align: inherit;">Code, um den Artikel nicht zu überladen, unter</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Skript pubkey-copy.sh wird benötigt, um den öffentlichen Teil des Schlüssels zu extrahieren und auf den Remote-Host zu kopieren, wenn ein neues Zertifikat ausgestellt wird. </font><font style="vertical-align: inherit;">Erstellen Sie dazu im Verzeichnis / etc / letsencrypt / erneueral-hooks / deploy auf beiden Servern ein weiteres Mikroskript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hälfte des Problems ist behoben, Zertifikate werden erneut ausgestellt, öffentliche Schlüssel werden extrahiert und zwischen den Servern kopiert, und es ist Zeit für systemd mit seinen Pfadeinheiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie auf dem Server ipsecgw.example.com im Verzeichnis / etc / systemd / system die Datei keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ähnliches gilt für den VPS-Host:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und schließlich erstellen wir auf jedem Server einen diesem Gerät zugeordneten Dienst, der gestartet wird, wenn die Bedingung (PathChanged) erfüllt ist - die Datei ändern und nach der Aufzeichnung schließen. </font><font style="vertical-align: inherit;">Wir erstellen die Dateien /etc/systemd/system/keyupdater.service und schreiben:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht, die Systemd-Konfigurationen mit sudo systemctl daemon-reload erneut zu lesen und den Pfadeinheiten über sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater einen Autostart zuzuweisen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobald der Remote-Host die Datei mit dem öffentlichen Schlüssel in das Home-Verzeichnis des Keywatcher-Benutzers schreibt und der Dateideskriptor geschlossen wird, startet systemd automatisch den entsprechenden Dienst, der den Schlüssel an den gewünschten Speicherort kopiert und Strongswan neu startet. </font><font style="vertical-align: inherit;">Der Tunnel wird mit dem richtigen öffentlichen Schlüssel der zweiten Seite installiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können ausatmen und das Ergebnis genießen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anstelle einer Schlussfolgerung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir gerade die sahen die </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hölle</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist IPSec nicht so gefährlich , </font><font style="vertical-align: inherit;">wie es gemalt ist. </font><font style="vertical-align: inherit;">Es wurde lediglich eine voll funktionsfähige Konfiguration beschrieben, die derzeit verwendet wird. </font><font style="vertical-align: inherit;">Auch ohne viel Wissen können Sie ein VPN konfigurieren und Ihre Daten zuverlässig schützen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich blieben die Momente der Einrichtung von iptables außerhalb des Geltungsbereichs des Artikels, aber der Artikel selbst erwies sich als bereits umfangreich, und es wurde viel über iptables geschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt Punkte in dem Artikel, die verbessert werden können, sei es die Weigerung, den Strongswan-Dämon neu zu starten und seine Konfigurationen und Zertifikate erneut zu lesen, aber ich konnte dies nicht erreichen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Neustarts des Daemons waren jedoch nicht beängstigend: Ein oder zwei Pings zwischen Peers gehen verloren, mobile Clients stellen die Verbindung selbst wieder her.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dass die Kollegen in den Kommentaren die richtige Lösung finden.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504464/index.html">Wie wir auf den TableAdapter gekommen sind und die Arbeit mit UITableView vereinfacht haben</a></li>
<li><a href="../de504468/index.html">Raspberry Pi-Leistung: Fügen Sie ZRAM hinzu und ändern Sie die Kernelparameter</a></li>
<li><a href="../de504472/index.html">Meine besten kostenlosen Entwicklertools</a></li>
<li><a href="../de504480/index.html">Wie finde ich einen Vermarkter, mit dem es sich lohnt, zusammenzuarbeiten?</a></li>
<li><a href="../de504482/index.html">Fragen Sie uns: DIT beantwortet Fragen</a></li>
<li><a href="../de504486/index.html">Prozess: Erstellen von Vue 3</a></li>
<li><a href="../de504488/index.html">Welche Branchen und Technologien werden sich nach der Lösung des COVID-19-Problems schnell entwickeln?</a></li>
<li><a href="../de504490/index.html">Juni Online Events Digest</a></li>
<li><a href="../de504492/index.html">Drücken Sie den Knopf: Theorie und Praxis der elektronischen Abstimmung - Runder Tisch am 30. Mai</a></li>
<li><a href="../de504502/index.html">Das kurze und seltsame Leben des ersten freundlichen Roboters der Welt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>