<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö´ üôèüèª üèÜ Stas Afanasyev. Juno. Pipelines based on io.Reader / io.Writer. Part 1 üè≥Ô∏è üìß üç∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the report, we will talk about the concept of io.Reader / io.Writer, why they are needed, how to implement them correctly and what pitfalls exist i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Stas Afanasyev. Juno. Pipelines based on io.Reader / io.Writer. Part 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/491484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the report, we will talk about the concept of io.Reader / io.Writer, why they are needed, how to implement them correctly and what pitfalls exist in this regard, as well as about building pipelines based on standard and custom io.Reader / io.Writer implementations .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/nv/uj/rdnvujcjwsukejxq_6a9syayawu.jpeg"><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stanislav Afanasyev (hereinafter - SA):</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Good afternoon! My name is Stas. I came from Minsk, from the Juno company. Thank you for coming on this rainy day, having found the strength to leave the house. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today I want to talk with you on such a topic as building pipelines Go based on io.Reader / io.Writer interfaces. What I‚Äôll talk about today is, in general, the concept of io.Reader / io.Writer interfaces, why they are needed, how to use them correctly and, most important, how to implement them correctly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will also talk about building pipelines based on various implementations of these interfaces. We will talk about existing methods, discuss their pros and cons. I will mention various pitfalls (this will be in abundance).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before we begin, we must answer the question, why are these interfaces needed at all? </font><font style="vertical-align: inherit;">Raise your hands, who works with Go tightly (every day, every other day) ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/pd/f4/d2pdf4kdwdjk_vxkqz6fwckqrgk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great! </font><font style="vertical-align: inherit;">We still have a Go community. </font><font style="vertical-align: inherit;">I think many of you have worked with these interfaces, have heard of them, at least. </font><font style="vertical-align: inherit;">You may not even know about them, but you certainly should have heard something about them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, these interfaces are an abstraction of the input-output operation in all its manifestations. </font><font style="vertical-align: inherit;">Secondly, it is a very convenient API that allows you to build pipelines, like a constructor from cubes, without really thinking about the internal details of the implementation. </font><font style="vertical-align: inherit;">At least that was originally intended.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a very simple interface. It consists of only one method - the Read method. Conceptually, the io.Reader interface implementation can be a network connection - for example, where there is no data yet, but they can appear there: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n-/4n/dc/n-4ndcbxpoxkul6h227ue7hruli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be a buffer in memory where the data already exists and can be read out entirely. It can also be a file descriptor - we can read this file in pieces if it is very large. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conceptual implementation of the io.Reader interface is access to some data. All cases that I wrote are supported by the Read method. It has only one argument - this is slice byte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One point to make here. Those who came to Go recently or came from some other technology, where there was no similar API (I am one of those), this signature is a bit confusing. The Read method seems to somehow read this slice. In fact, the opposite is true: the Reader interface implementation reads the data inside and fills this slice with the data that this implementation has.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The maximum amount of data that can be read on request by the Read method is equal to the length of this slice. </font><font style="vertical-align: inherit;">A regular implementation returns as much data as it can return at the time of the request, or the maximum amount that fits into this slice. </font><font style="vertical-align: inherit;">This suggests that Reader can be read in pieces: at least by byte, at least ten - as you like. </font><font style="vertical-align: inherit;">And the client that calls Reader, according to the return values ‚Äã‚Äãfrom the Read method, thinks how to live on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Read method returns two values:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of bytes subtracted;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an error if it occurred.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These values ‚Äã‚Äãinfluence the further behavior of the client. </font><font style="vertical-align: inherit;">There is a gif on the slide that shows, displays this process, which I just described:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ww/sf/siwwsf6u8mb1nkztg0ltnumkckw.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/p1/hk/mb/p1hkmbpfp8-twtnznjj2ihireaa.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Io.Reader - How to?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are exactly two ways for your data to satisfy the Reader interface. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l0/fm/e7/l0fme7quz_tqzilkfiuiddpgjk4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first is the simplest. If you have some kind of slice byte, and you want to make it satisfy the Reader interface, you can take the implementation of some standard library that already satisfies this interface. For example, Reader from the bytes package. On the slide above you can see the signature of how this Reader is created. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a more complicated way - to implement the Reader interface yourself. There are approximately 30 lines in the documentation with tricky rules, restrictions that must be followed. Before we talk about all of them, it became interesting to me: ‚ÄúAnd in what cases are not enough standard implementations (standard library)? When is the moment when we need to implement the Reader interface ourselves? ‚Äù</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to answer this question, I took the thousand of the most popular repositories on Github (by the number of stars), added them and found all implementations of the Reader interface there. </font><font style="vertical-align: inherit;">On the slide, I have some statistics (categorized) of when people implement this interface.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most popular category is connections. </font><font style="vertical-align: inherit;">This is an implementation of both proprietary protocols and wrappers for existing types. </font><font style="vertical-align: inherit;">So, Brad Fitzpatrick has a Camlistore project - there is an example in the form of statTrackingConn, which, in general, is an ordinary Wrapper over the con type from the net package (adds metrics to this type).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second most popular category is custom buffers. </font><font style="vertical-align: inherit;">Here I liked the one and only example: dataBuffer from the x / net package. </font><font style="vertical-align: inherit;">Its peculiarity is that it stores data cut into chunks, and when subtracting it passes through these chunks. </font><font style="vertical-align: inherit;">If the data in the chunk is over, it moves on to the next chunk. </font><font style="vertical-align: inherit;">At the same time, he takes into account the length, the place that he can fill in the transmitted slice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another category is all kinds of progress-bars, counting the number of bytes subtracted with sending in metrics ...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on this data, we can say that the need to implement the io.Reader interface occurs quite often. </font><font style="vertical-align: inherit;">Let's then start talking about the rules that are in the documentation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentation Rules</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I said, the list of rules, and in general the documentation is quite large, massive. 30 lines is enough for an interface that consists of only three lines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first, most important rule concerns the number of bytes returned. It must be strictly greater than or equal to zero and less than or equal to the length of the sent slice. Why is it important? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/kp/xh/1kkpxhahoiicme8z8vbdbq5ajbm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since this is a fairly strict contract, the client can trust the amount that comes from the implementation. There are Wrappers in the standard library (for example, bytes.Buffer and bufio). There is such a moment in the standard library: some implementations trust wrapped Readers, some do not trust (we will talk about this later).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bufio doesn't trust anything at all - it checks absolutely everything. </font><font style="vertical-align: inherit;">Bytes.Buffer trusts absolutely everything that arrives to him. </font><font style="vertical-align: inherit;">Now I will demonstrate what is happening in connection with this ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will now consider three possible cases - these are three implemented Readers. </font><font style="vertical-align: inherit;">They are quite synthetic, useful for understanding. </font><font style="vertical-align: inherit;">We will read all these Readers using the ReadAll helper. </font><font style="vertical-align: inherit;">His signature is presented at the top of the slide:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ib/c1/7b/ibc17bdqyrimk3xce2khqwera4w.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Example 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ReadAll is a helper that takes some kind of implementation of the Reader interface, reads all of it and returns the data that it read, as well as an error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our first example is Reader, which will always return -1 and nil as an error, i.e. such a NegativeReader. Let's run it and see what happens: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/3h/l-/7n3hl-2vdvmgvmw80eljlorapiw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, panic for no reason is a sign of foolishness. But who in this case is fool - me or byte.Buffer - depends on the point of view. Those who write this package and who follow it have different points of view. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happened here? Bytes.Buffer accepted a negative number of bytes, did not check that it was negative, and tried to cut off the internal buffer along the upper boundary, which he received - and we got out of the slice bounds.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two problems in this example. The first is that the signature is not forbidden to return negative numbers, and the documentation is forbidden. If the signature had Uint, then we would get a classic overflow (when a signed number is interpreted as unsigned). And this is a very tricky bug, which will certainly happen on Friday night, when you are already home assembled. Therefore, panic in this case is the preferred option.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second ‚Äúpoint‚Äù is that the stack trace does not understand what happened at all. It is clear that we have gone beyond the boundaries of the slice - so what? When you have such a multilayer pipe and such an error occurs, it is not immediately clear what happened. So the bufio of the standard library also ‚Äúpanics‚Äù in this situation, but it does it more beautifully. He immediately writes: ‚ÄúI subtracted a negative number of bytes. I won‚Äôt do anything else - I don‚Äôt know what to do with it. ‚Äù</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And bytes.Buffer is panicking as best he can. </font><font style="vertical-align: inherit;">I posted an issue to Golang asking me to add a human error. </font><font style="vertical-align: inherit;">Day three, we discussed the prospects of this decision. </font><font style="vertical-align: inherit;">The reason is this: historically it happened that different people at different times made different uncoordinated decisions. </font><font style="vertical-align: inherit;">And now we have the following: in one case we don‚Äôt trust the implementation at all (we check everything), and in the other we trust completely, we don‚Äôt get what it comes from there. </font><font style="vertical-align: inherit;">This is an unresolved issue, and we will talk more about this.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Example 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following situation: our Reader will always return 0 and nil as results. </font><font style="vertical-align: inherit;">From the point of view of contracts, everything is legal here - there are no problems. </font><font style="vertical-align: inherit;">The only caveat: the documentation says that implementations are not recommended to return the values ‚Äã‚Äã0 and nil, in addition to the case, when the length of the sent slice is zero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In real life, such a Reader can cause a lot of trouble. </font><font style="vertical-align: inherit;">So, we return to the question, should we trust Reader? </font><font style="vertical-align: inherit;">For example, a check is built into bufio: it sequentially reads Reader exactly 100 times - if such a pair of values ‚Äã‚Äãis returned 100 times, it simply returns NoProgress. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is nothing like this in bytes.Buffer. </font><font style="vertical-align: inherit;">If we run this example, we get just an endless loop (ReadAll uses bytes.Buffer under the hood, not Reader itself):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/br/zu/xhbrzuvnof4dxubt2d26i6q4l_q.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Example 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One more example. </font><font style="vertical-align: inherit;">It is also quite synthetic, but useful for understanding: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/pe/xp/gapexpzfyhd6za09ss_uuwbrmlk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we always return 1 and nil. </font><font style="vertical-align: inherit;">It would seem that there are no problems here either - everything is legal from the point of view of the contract. </font><font style="vertical-align: inherit;">There is a nuance: if I run this example on my computer, then it will freeze after 30 seconds ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is due to the fact that the client that reads this Reader (that is, bytes.Buffer) never gets a sign of the end of the data - it reads, subtracts ... Plus, he gets one subtracted byte every time. </font><font style="vertical-align: inherit;">For him, this means that at some point, the repositioned buffer ends, it still runs - the situation repeats, and it runs to infinity until it bursts.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 2. </font><font style="vertical-align: inherit;">Error return</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We come to the second important rule for implementing the Reader interface - this is an error return. </font><font style="vertical-align: inherit;">The documentation states three errors that the implementation should return. </font><font style="vertical-align: inherit;">The most important of them is EOF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EOF is the very sign of the end of the data, which the implementation should return whenever it runs out of data. </font><font style="vertical-align: inherit;">Conceptually, this is, in general, not a mistake, but made as a mistake. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is another mistake called UnexpectedEOF. </font><font style="vertical-align: inherit;">If suddenly while reading Reader can no longer read the data, it was thought that it would return UnexpectedEOF. </font><font style="vertical-align: inherit;">But in fact, this error is used only in one place of the standard library - in the ReadAtLeast function.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-c/og/la/-coglawtrylyakbq0kxlc0ob9rs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another mistake is NoProgress, which we already talked about. </font><font style="vertical-align: inherit;">The documentation says so: this is a sign that the interface is implemented sucks.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Io.Reader # 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The documentation stipulates a set of cases on how to correctly return the error. </font><font style="vertical-align: inherit;">Below you can see three possible cases: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m1/ef/si/m1efsipabh8oypgch-7_ni2syc8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can return an error both with the number of bytes subtracted, and separately. </font><font style="vertical-align: inherit;">But if all of a sudden your data runs out in your Reader, and you cannot return the EOF [end sign] right now (many implementations of the standard library work just like that), then it is assumed that you will return EOF to the next consecutive call (that is, you must let go customer). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the client, this means that there is no more data - do not come to me anymore. </font><font style="vertical-align: inherit;">If you return nil, and the client needs data, then he should come to you again.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader. </font><font style="vertical-align: inherit;">Mistakes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, according to Reader, these were the main important rules. </font><font style="vertical-align: inherit;">There is still a set of small ones, but they are not so important and do not lead to such a situation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xv/iu/az/xviuazv5segzzd5ganrbinp8xli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before we go through everything related to Reader, we need to answer the question: is it important, do errors often happen in custom implementations? </font><font style="vertical-align: inherit;">To answer this question, I turned to my spool for 1000 repositories (and there we got about 550 custom implementations). </font><font style="vertical-align: inherit;">I looked through the first hundred with my eyes. </font><font style="vertical-align: inherit;">Of course, this is not super-analysis, but what it is ... I </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
identified the two most popular errors:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">never returns EOF;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">too much trust in the wrapped Reader.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Again, this is a problem from my point of view. </font><font style="vertical-align: inherit;">And from those who are watching the io package, this is not a problem. </font><font style="vertical-align: inherit;">We‚Äôll talk about this again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like to return to one nuance. </font><font style="vertical-align: inherit;">See: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/3h/9q/te3h9q46okeg22rijrfyxrmi4da.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client should never interpret the pair 0 and nil as EOF. </font><font style="vertical-align: inherit;">This is mistake! </font><font style="vertical-align: inherit;">For Reader, this value is just an opportunity to let go of the client. </font><font style="vertical-align: inherit;">So the two errors that I said about seem insignificant, but it‚Äôs enough to imagine that you have a multi-layer pipeline in the prod and a small, sly ‚Äúbagul‚Äù has crept in the middle, then the ‚Äúunderground knock‚Äù will not take long - guaranteed! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to Reader, basically everything. </font><font style="vertical-align: inherit;">These were the basic implementation rules.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Writer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the other end of the pipelines, we have io.Writer, which is where we usually write data. </font><font style="vertical-align: inherit;">A very similar interface: it also consists of one method (Write), their signature is similar. </font><font style="vertical-align: inherit;">From the point of view of semantics, the Writer interface is more understandable: I would say that as it is heard, it is written. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fq/ya/ls/fqyalshoz2lwp48cs5u8oa9ymdk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Write method takes a slice byte and writes it in its entirety. </font><font style="vertical-align: inherit;">He also has a set of rules that must be followed.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first of these concerns the returned number of bytes written. </font><font style="vertical-align: inherit;">I would say that it is not so strict, because I did not find a single example when it would lead to some critical consequences - for example, to panic'am. </font><font style="vertical-align: inherit;">This is not very strict because there is the following rule ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Writer implementation is required to return an error whenever the amount of data written is less than what was sent. </font><font style="vertical-align: inherit;">That is, partial recording is not supported. </font><font style="vertical-align: inherit;">This means that it is not very important how many bytes were written.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One more rule: Writer should by no means modify the sent slice, because the client will still work with this slice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writer should not hold this slice (Reader has the same rule). </font><font style="vertical-align: inherit;">If you need data in your implementation for some operations, you just need to copy this slide, and that‚Äôs it.</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iy/tx/qe/iytxqemg1nabcwxyfzxtgszmjxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By Reader and Writer, that's it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dendrogram</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especially for this report, I generated a graph of implementation and designed it in the form of a dendrogram. </font><font style="vertical-align: inherit;">Those who want right now can follow this QR code: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/zp/pq/r2zppqu-0snqu80oqyxxpxakkpc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This dendrogram has all implementations of all interfaces of the io package. </font><font style="vertical-align: inherit;">This dendrogram is needed to simply understand: what and with what you can stick together in the pipelines, where and what you can read, where you can write. </font><font style="vertical-align: inherit;">I will still refer to it in the course of my report, so please refer to the QR code.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pipelines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We talked about what Reader, io.Writer is. Now let's talk about the API that exists in the standard library for building pipelines. Let's start with the basics. Maybe it will not even be interesting to anyone. However, this is very important. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will read the data from the standard input stream (from Stdin): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/tq/4m/zqtq4mfocqntafmpk5m_scirhcm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stdin is represented in Go by a global variable of type file from the os package. If you take a look at the dendrogram, you will notice that the file type implements the Reader and Writer interfaces as well. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Right now we are interested in Reader. We will be reading out Stdin using the same ReadAll helper that we already used.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One nuance regarding this helper is worth noting: ReadAll reads Reader to the end, but it determines the ending by EOF, according to the sign of the end that we talked about. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will now limit the amount of data that we read from Stdin. To do this, there is an implementation of LimitedReader in the standard library: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/dm/hn/qqdmhnj73dfyxpdlrpoffwzimgq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like you to pay attention to how LimitedReader limits the number of bytes to be read. One would think that this implementation, this Wrapper, subtracts everything that is in the Reader, which it wraps, and then gives as much as we want. But everything works a little differently ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LimitedReader trims the slice given to it as an argument along the upper boundary. </font><font style="vertical-align: inherit;">And he passes this cropped slice to Reader, which wraps it. </font><font style="vertical-align: inherit;">This is a clear demonstration of how the length of the read data is regulated in the io.Reader interface implementations.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error return end of file</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another interesting point: note how this implementation returns an EOF error! </font><font style="vertical-align: inherit;">The returned named values ‚Äã‚Äãare used here, and they are assigned by the values ‚Äã‚Äãthat we get from the wrapped Reader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if it happens that there is more data in the wrapped Reader than we need, we assign the values ‚Äã‚Äãof the wrapped Reader - for example, 10 bytes and nil - because there is still data in the wrapped Reader. </font><font style="vertical-align: inherit;">But the variable n, which decreases (in the penultimate line), says that we have reached the ‚Äúbottom‚Äù - the end of what we need. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next iteration, the client should come again - on the first condition, he will receive EOF. </font><font style="vertical-align: inherit;">This is the case that I mentioned. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be continued very soon ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kuyjuGk1USY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud-based VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491470/index.html">How to protect your assets during stock market corrections?</a></li>
<li><a href="../en491476/index.html">MEMS accelerometers, magnetometers and orientation angles</a></li>
<li><a href="../en491478/index.html">A new implant for the blind connects directly to the brain</a></li>
<li><a href="../en491480/index.html">CoVirus MVP project - an online map of coronavirus infection or a ‚Äúred button" in your hand</a></li>
<li><a href="../en491482/index.html">Introducing PowerShell 7.0</a></li>
<li><a href="../en491486/index.html">Custom script when closing the lid of the laptop and locking the screen without sleep</a></li>
<li><a href="../en491488/index.html">What does it mean to be Agile?</a></li>
<li><a href="../en491490/index.html">How does Gitlab-CI inherit environment variables?</a></li>
<li><a href="../en491494/index.html">The grandiose scam of Soviet science: why a reusable orbital ship turned out to be one-time</a></li>
<li><a href="../en491496/index.html">IntelliJ IDEA Tips & Tricks: 1. Comparing Files and Folders</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>