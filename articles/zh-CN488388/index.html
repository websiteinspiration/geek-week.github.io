<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐾 🐦 🛌🏾 重新登录和HTTP基本身份验证 ↘️ 🥔 👩🏿‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web开发人员早就意识到登录和登录受HTTP Basic Authorization保护的站点的问题。尽管还有其他身份验证方法不会遇到此问题，但是基本授权通常仍然是最佳选择。该网络具有足够的材料来描述各种通用和特定的解决方案。但是，不幸的是，我发现它们全部都仅描述了部分解决方案，这些解决方案只能在一...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>重新登录和HTTP基本身份验证</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488388/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web开发人员早就意识到登录和登录受HTTP Basic Authorization保护的站点的问题。</font><font style="vertical-align: inherit;">尽管还有其他身份验证方法不会遇到此问题，但是基本授权通常仍然是最佳选择。</font><font style="vertical-align: inherit;">该网络具有足够的材料来描述各种通用和特定的解决方案。</font><font style="vertical-align: inherit;">但是，不幸的是，我发现它们全部都仅描述了部分解决方案，这些解决方案只能在一种浏览器中使用，而不能在另一种浏览器中使用。</font><font style="vertical-align: inherit;">在猫之下，我给出了我对该问题研究的一般性最终结果</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我马上要预约，因为我不是前端开发人员，也没有深入研究各种“品牌”和浏览器版本。</font><font style="vertical-align: inherit;">仅在撰写本文时具有相关版本的主流。</font><font style="vertical-align: inherit;">对于大多数Web任务而言，这就足够了。</font><font style="vertical-align: inherit;">对于那些需要支持整个浏览器“ zoo”的开发人员而言，本文可能是一个很好的起点</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，问题的实质是HTTP基本授权标准不提供日志记录。</font><font style="vertical-align: inherit;">通常。</font><font style="vertical-align: inherit;">当您进入受“基本授权”保护的页面时，浏览器本身将显示带有请求登录名/密码的窗口，并在成功登录后将其保存在其深处。</font><font style="vertical-align: inherit;">然后，对该站点其他受保护页面的所有后续请求将自动使用Authorization标头中的这些值：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">授权：基本bm9uZTpub25l</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中bm9uZTpub25l是base64编码的登录名/密码链接无：无（您的用户名和密码可能不同）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了登录，您只需要在浏览器的最深处及其上重置旧的用户名/密码即可。录制新唱片的地方。</font><font style="vertical-align: inherit;">这就是惊喜等待着我们的地方。</font><font style="vertical-align: inherit;">由于没有标准规范此操作，因此每个浏览器都根据自己的理解进行操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更糟糕的是，由于登录名/密码请求窗口是它自己的浏览器窗口，该窗口已经仅响应HTTP页面标题，因此在对页面正文进行任何处理之前会弹出该窗口。</font><font style="vertical-align: inherit;">也就是说，在接收到状态为401的服务器响应时执行某些javascript不起作用。</font><font style="vertical-align: inherit;">在用户面前，此窗口会反复出现，并反复要求输入登录名/密码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，这一点很关键，因为对于几乎所有浏览器而言，注销的唯一方法是使用明显错误的登录名/密码向服务器发送请求，接收状态为401的服务器响应，然后重置浏览器的登录名/密码缓存。</font><font style="vertical-align: inherit;">但是，如果同时浏览器不允许您处理响应401并继续为新用户进行登录过程，即使在读取HTTP标头并抛出您要输入的授权形式的阶段也要进行控制，那么您将无法使用它，已经是一个问题。</font><font style="vertical-align: inherit;">这是通过引用还是XMLHttpRequest或提取的普通请求都没关系。</font><font style="vertical-align: inherit;">浏览器仍在解析标头的阶段进行控制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所以…</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始数据：</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在单独的logout.html页面上，所有逻辑均位于javascript脚本中，部分内容在演示过程中给出</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定的网址-成功登录后要重定向的页面地址</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定了url401-始终返回HTTP 401错误（未经授权）的页面地址</font></font></li>
</ol><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// file logout.html</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/"</span>);
<span class="hljs-keyword">const</span> url401 = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/401"</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IE浏览器</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的产品不需要对此浏览器的支持，因此该解决方案我还没有亲自测试过。</font><font style="vertical-align: inherit;">不过，根据Google的说法，有一个解决方案，它也许是所有方法中最简单，最优雅的。</font><font style="vertical-align: inherit;">而且，我从未见过任何信息表明此针对Microsoft浏览器的解决方案已失去其相关性：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.execCommand(<span class="hljs-string">"ClearAuthenticationCache"</span>)) {
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在IE中，有一个ClearAuthenticationCache方法可以丢弃“那些非常深的肠”。</font><font style="vertical-align: inherit;">简洁大方。</font><font style="vertical-align: inherit;">并且没有与辅助页面401跳舞。我不知道此方法是否在Edge中有效。</font><font style="vertical-align: inherit;">大概是。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果该方法存在并且“有效”，则document.execCommand构造返回true。</font><font style="vertical-align: inherit;">然后window.location.assign（URL）重定向用户以输入新的用户名和密码</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firefox（72.0.1）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的任务范围内，这是最有问题的浏览器。</font><font style="vertical-align: inherit;">对于他来说，仍然不存在完整的解决方案。</font><font style="vertical-align: inherit;">在15到20年的时间里，开发人员团队的错误跟踪器一直挂着一个针对所指示问题的请求。</font><font style="vertical-align: inherit;">但是“事情仍然存在。” </font><font style="vertical-align: inherit;">可以达到的最大值是曲线razlogin。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
输入：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在通过XMLHttpRequest或获取请求收到401响应后，Firefox不会刷新密码缓存。</font><font style="vertical-align: inherit;">只有通过常规请求，并在URL本身中输入登录名/密码。</font><font style="vertical-align: inherit;">也就是说，类似</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http：// //无：none@mysite.com/</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 编码：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/firefox|iceweasel|fxios/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    url.username = <span class="hljs-string">'none'</span>;<font></font>
    url.password = <span class="hljs-string">'none'</span>;
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，用户会收到一个登录名/密码输入表单，无论您输入什么形式，都会一次又一次弹出。</font><font style="vertical-align: inherit;">事实是输入的值不会覆盖URL中指定的登录名/密码值。</font><font style="vertical-align: inherit;">也就是说，不是输入的值，而是一堆不输入的值：每次都不会有输入到服务器的值。</font><font style="vertical-align: inherit;">要使用其他名称登录，用户必须单击“取消”，转到开始页面（http://mysite.com/），然后在此处输入新的登录名/密码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
歪？</font><font style="vertical-align: inherit;">但是a，没有其他解决方案</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">谷歌浏览器（79.0.3945.88）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于Chrome，提取方法效果很好。</font><font style="vertical-align: inherit;">但是XMLHttpRequest不起作用（（（（（缓存未重置，并且不会发生日志记录。此外，我尝试将登录名/密码设置为open方法的参数并设置标头。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/chrome/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    fetch(url401, {<font></font>
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Basic '</span> + btoa(<span class="hljs-string">'none:none'</span>),
        <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span><font></font>
      }<font></font>
    }).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.error(err));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们使用明显不正确的用户名/密码对页面401进行提取请求，我们从服务器收到401响应，浏览器刷新了其缓存。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器不应返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWW-Authenticate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标头</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">否则，浏览器将获得控制权，并且永远不会发生从页面401进行重定向。</font><font style="vertical-align: inherit;">按照约定，如果在request中指定了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With：XMLHttpRequest</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则服务器不应返回此标头</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标头已添加到request中</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safari（12）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于Safari，情况恰好相反：XMLHttpRequest有效，但fetch不起作用</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
    xhr.open(<span class="hljs-string">"GET"</span>, url401, <span class="hljs-literal">true</span>, <span class="hljs-string">'none'</span>, <span class="hljs-string">'none'</span>);<font></font>
    xhr.setRequestHeader(<span class="hljs-string">'X-Requested-With'</span>, <span class="hljs-string">'XMLHttpRequest'</span>);<font></font>
    xhr.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-built_in">console</span>.error(err);<font></font>
    };<font></font>
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    };<font></font>
    xhr.send()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些操作与Chrome中的操作相同，仅通过XMLHttpRequest才</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
适用于Safari 6+版本。</font><font style="vertical-align: inherit;">早期版本有自己的错误。</font><font style="vertical-align: inherit;">尤其是，例如在5.1版本中，每次重定向时，浏览器都会强制重新请求授权，这就是为什么重定向到最终页面的授权原则上不起作用的原因。</font><font style="vertical-align: inherit;">在5.0之前的版本中，日志记录无效。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488376/index.html">当原则“让所有事情都下地狱，那就去做！” 不起作用：拖拉笔记</a></li>
<li><a href="../zh-CN488378/index.html">简要介绍JS中的命名</a></li>
<li><a href="../zh-CN488380/index.html">通过“一个地方”在STM中最简单的开始</a></li>
<li><a href="../zh-CN488382/index.html">我为我访问的网站增加了3-25秒的延迟</a></li>
<li><a href="../zh-CN488386/index.html">应用网络异常分析工具的案例：通过浏览器插件的攻击</a></li>
<li><a href="../zh-CN488390/index.html">如何使用OpenId Connect成为Telegram机器人的朋友</a></li>
<li><a href="../zh-CN488392/index.html">适用于k8s的生产就绪图像</a></li>
<li><a href="../zh-CN488404/index.html">2020年值得期待的游戏</a></li>
<li><a href="../zh-CN488406/index.html">IPv6-您做错了</a></li>
<li><a href="../zh-CN488408/index.html">STM32以太网-RS485 IoT网关</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>