<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲🏽 👩🏽‍✈️ ⏩ Natas Web。Webの脆弱性の悪用を目的としたCTFプラットフォームの通過。パート4 📝 🧔🏾 🖖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、Natasウォーゲームを例にして、いくつかのWEB IDの操作について説明します。各レベルは、次のレベルのパスワードにアクセスできます。すべてのパスワードは/ etc / natas_webpass /ファイルにも保存されます。たとえば、natas5のパスワードは/ etc / nat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Natas Web。Webの脆弱性の悪用を目的としたCTFプラットフォームの通過。パート4</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464863/"><img src="https://habrastorage.org/webt/_-/zf/_u/_-zf_uvvs6ypsybfrqslsnqwx8k.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウォーゲームを例にして、いくつかのWEB IDの操作について説明します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">各レベルは、次のレベルのパスワードにアクセスできます。</font><font style="vertical-align: inherit;">すべてのパスワードは/ etc / natas_webpass /ファイルにも保存されます。</font><font style="vertical-align: inherit;">たとえば、natas5のパスワードは/ etc / natas_webpass / natas5ファイルに保存され、ユーザーnatas4およびnatas5の読み取り専用です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
過去のパート：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組織情報</font></font></b><div class="spoiler_text">  ,    -           ,        :<br>
<br>
<ul>
<li>PWN;</li>
<li> (Crypto);</li>
<li>c  (Network);</li>
<li> (Reverse Engineering);</li>
<li> (Stegano);</li>
<li>   WEB-.</li>
</ul><br>
         ,    ,        ,     .<br>
<cut></cut><br>
      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>.<br>
<cut></cut><br>
      .          ,  -      ,      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル22</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースコードを分析すると、revelio GETパラメーターが空でない場合はパスワードが表示されることが明らかになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qt/h2/7d/qth27dcdtjul75hszlw2cvcyzsg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、最初のチェックで、管理セッションがインストールされていない場合、パラメーターなしでこのページにリダイレクトされます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5r/u3/0h/5ru30hiuygieq26yxphung51ulm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
curlなどのブラウザではなく、Webエージェントを使用するだけです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/et/fm/6o/etfm6oitmynlnoijxpllonqov4u.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/d5/tz/p0/d5tzp0aslqz9xhuweeitrt-e3tk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パスワードを削除します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル23</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースコードを分析します。</font><font style="vertical-align: inherit;">strstr（s1、s2）関数は、s2で始まるs1からの部分文字列を返します。</font><font style="vertical-align: inherit;">また、phpは自動的に型をキャストします。</font><font style="vertical-align: inherit;">つまり、文字列を比較すると、文字列が数字になり、余分な文字が破棄されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gj/yq/4j/gjyq4jlb7vmcj1oxrxwpwk6tc3s.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字列「11iloveyou」は、私たちの状態に適しています。</font><font style="vertical-align: inherit;">最初のチェックでは、「iloveyou」、つまりTrueが返されます。</font><font style="vertical-align: inherit;">2番目のチェック、11&gt; 10、つまりTrue。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e_/j1/jo/e_j1jo7sj3k6nblm-prlhwzrlig.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル24</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このレベルには論理エラーも含まれています。</font><font style="vertical-align: inherit;">strcmpがFALSEを返した場合でも、条件はtrueです。</font><font style="vertical-align: inherit;">ただし、エラーが発生した場合でも、strcmpはFALSEを返します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dl/en/md/dlenmdk6mgztpnckq_uy_89ks90.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
phpは自動的に型をキャストしますが、配列を文字列にキャストすることはできません。</font><font style="vertical-align: inherit;">これを行うには、ページのソースコードを開き、フィールド名を「passwd」から「passwd []」に変更します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l3/gg/e0/l3gge0cb1bsjagoz59mc9rkrhbi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どんなラインでもお送りします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/yd/py/puydpyhz83who8ph9cynamtt_qm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パスワードを削除します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル25</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースコードを分析するときに最も興味深いのは、ユーザーが制御できるフィールドを処理するlogRequest（）関数です。</font><font style="vertical-align: inherit;">これは、User_Agentおよびcookie session_idのHTTPヘッダーです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5w/lr/cs/5wlrcsv-hltqircjccutifmbzfs.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/z9/gj/wc/z9gjwc_ttjkrp6xtawcgbdgtw0m.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/hp/u6/sq/hpu6sqmspwgypwixjz5vzzyappw.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのシーケンス“ ../”が文字列から削除されることを検討する価値がありますが、これは“ ... /。/” =&gt;“ ../”の方法で実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策のアイデア：ログを記録するためのパスは、私たちが制御できるsession_idに依存し、表示言語を選択することにより、サーバー上のパスが選択されます-LFIにより、ログファイルを読み取ることができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/dr/te/lkdrtevuv7sbaeelyf1vstsagiq.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/bu/cx/pb/bucxpbzzxagwpkvvnamvk_sap_g.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/8y/dr/u5/8ydru5lvj9cunuxuge0jmz9zpv8.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/zm/be/qk/zmbeqk2m5ssbh9rljmlyzr7zjo8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ etc / natas_webpass / natas26からのパスワードをログファイルに書き込む必要があります。</font><font style="vertical-align: inherit;">Webエージェントが最初に記録されてからファイルから出力されるため、このフィールドにphpコードを追加します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bp/um/qy/bpumqyyp-jptpd5aqnbv2sooizs.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/cy/ce/a4/cycea4udcst1dildxt50psa9lg4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パスワードを取得します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル26</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例には、非常に深刻な脆弱性があります-オブジェクトのフィルター処理されていない逆シリアル化です。</font><font style="vertical-align: inherit;">unserialize（）関数は、1つのシリアル化された変数を受け取り、それをPHPオブジェクトに変換します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/45/aq/2t/45aq2tsecnjzewtlbpybi--vcca.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変換された値が返されます。これは、整数、浮動小数点数、文字列、配列、またはオブジェクトにすることができます。</font><font style="vertical-align: inherit;">それら。</font><font style="vertical-align: inherit;">任意のコードを実行できます。</font><font style="vertical-align: inherit;">Loggerクラスは、作成されると、特定の情報をファイルに書き込みます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6r/bb/or/6rbborrkvdmwnvhdrywxmrhe0yo.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイデアは次のとおりです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loggerクラスを書き直します。メッセージの1つではなく、パスワードを出力するPHPコードが含まれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base64でエンコードします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クッキーに貼り付けます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログファイルにアクセスします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パスワードを削除します。</font></font></li>
</ol><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span></span>{
	<span class="hljs-keyword">private</span> $logFile;
	<span class="hljs-keyword">private</span> $initMsg;
	<span class="hljs-keyword">private</span> $exitMsg;<font></font>
	<font></font>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$file</span>)</span>{
		<span class="hljs-keyword">$this</span>-&gt;initMsg=<span class="hljs-string">"&lt;? passthru('cat /etc/natas_webpass/natas27'); ?&gt;"</span>;
		<span class="hljs-keyword">$this</span>-&gt;exitMsg=<span class="hljs-string">"&lt;? passthru('cat /etc/natas_webpass/natas27'); ?&gt;"</span>;
		<span class="hljs-keyword">$this</span>-&gt;logFile = <span class="hljs-string">"img/phpobjinj.php"</span>;<font></font>
	}<font></font>
	<font></font>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">$msg</span>)</span>{<font></font>
		;<font></font>
	}<font></font>
	<font></font>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{<font></font>
		;<font></font>
	}<font></font>
}<font></font>
<font></font>
$obj = <span class="hljs-keyword">new</span> Logger(<span class="hljs-string">"obj"</span>);
<span class="hljs-keyword">echo</span> urlencode(base64_encode(serialize($obj)));
<span class="hljs-meta">?&gt;</span></code></pre><br>
<img src="https://habrastorage.org/webt/_m/ew/2n/_mew2nh3ozpfmk5cnjxltfn8gvk.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/xh/fc/ms/xhfcmsciwcv2bsirfgm-mol0-re.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/mr/w2/qe/mrw2qegouxyawwhdfme9cgzwhcs.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パスワードを取得します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル27</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサービスは、ユーザーデータを提供します。</font><font style="vertical-align: inherit;">ただし、ユーザーが存在しない場合は、指定されたユーザー名とパスワードでユーザーを作成します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/w1/nt/qyw1nthdmxbnzi4bnrshl-4rtki.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、ユーザーを作成した後、サービスがログイン時に自分のパスワードをチェックしないことです。</font><font style="vertical-align: inherit;">この場合、フィルタリング後のログインとパスワードの最初の64文字のみがデータベースに分類されます。</font><font style="vertical-align: inherit;">それだけでなく、ユーザー名natas28も知っています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k1/ie/6e/k1ie6ecolxgi9hamjihcaxy7vkg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
空のパスワードと名前でユーザーを作成します： "natas28_60-spaces_ any-character"。</font><font style="vertical-align: inherit;">（したがって、チェック中はユーザーnatas28との一致はありませんが、作成中にはフィルターされてデータベースに追加されます。つまり、次の呼び出しではパスワードはチェックされません）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/me/nv/aj/menvaj0iqxtzablifx2w2ozfddw.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/kf/hf/xg/kfhfxgjx3vpuz7gdvyfc2ncxrge.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前natas28と空のパスワードを使用します。</font><font style="vertical-align: inherit;">ユーザーデータnatas28を取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つづく。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegramで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参加でき</font><font style="vertical-align: inherit;">ます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja464849/index.html">ユーティリティタスクでのRの使用</a></li>
<li><a href="../ja464853/index.html">オーディオ機器を聴く場所：日本からロシアまで、オーディオファンのためのテーマ施設の文化</a></li>
<li><a href="../ja464857/index.html">マルチタスクマイクロカーネルOS開発-スケジューラ</a></li>
<li><a href="../ja464859/index.html">複数のNema 17ステッピングモーターまたはNemaStepperを同時に制御する</a></li>
<li><a href="../ja464861/index.html">スクラムミニリファレンスとガイド</a></li>
<li><a href="../ja464865/index.html">ITプロジェクトのデータウェアハウスとしての電報</a></li>
<li><a href="../ja464867/index.html">"消しゴム"</a></li>
<li><a href="../ja464869/index.html">モノリスの物語。パート2</a></li>
<li><a href="../ja464871/index.html">初心者向けの機械学習の本15冊</a></li>
<li><a href="../ja464873/index.html">為替で通貨を使用して操作を行う理由：3つの実際的なシナリオ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>