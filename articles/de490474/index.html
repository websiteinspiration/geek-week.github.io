<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèª ü¶ä üßÄ STM32 Teil 1: Die Grundlagen üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ üë≠ üå©Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sie k√∂nnen Code nicht vertrauen, den Sie nicht vollst√§ndig selbst geschrieben haben. - Ken ThompsonVielleicht mein Lieblingszitat. Sie war der Grund, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Teil 1: Die Grundlagen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490474/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie k√∂nnen Code nicht vertrauen, den Sie nicht vollst√§ndig selbst geschrieben haben. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ken Thompson</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vielleicht mein Lieblingszitat. Sie war der Grund, warum ich mich entschied, in die Tiefen des Kaninchenlochs einzutauchen. Ich habe meine Reise in die Welt des Programmierens erst vor kurzem begonnen, nur ungef√§hr ein Monat verging und ich beschloss, Artikel zu schreiben, um das Material zu konsolidieren. Alles begann mit einer einfachen Aufgabe, die Lampen in Ihrem Fotostudio mit Arduina zu synchronisieren. Das Problem wurde gel√∂st, aber ich ging nicht mehr ins Fotostudio, es ist keine Zeit. Von diesem Moment an beschloss ich, mich gr√ºndlich mit der Programmierung von Mikrocontrollern zu besch√§ftigen. Arduin, obwohl in seiner Einfachheit attraktiv, mochte ich die Plattform nicht. Die Wahl fiel auf die Firma ST und ihre beliebten Produkte. Zu diesem Zeitpunkt hatte ich noch keine Ahnung, was der Unterschied war, aber als typischer Verbraucher habe ich mir die Geschwindigkeit des ‚ÄûProzessors‚Äú und die Speichermenge verglichen und mir ein beeindruckendes Board mit einem STM32F746NG-Display gekauft - Discovery.Ich werde die Momente der Verzweiflung verpassen und auf den Punkt kommen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eingebettet in das Bild eines Programmierers las ich viel, studierte, experimentierte. </font><font style="vertical-align: inherit;">Und wie ich oben bereits beschrieben habe, wollte ich gut lernen, das ist alles. </font><font style="vertical-align: inherit;">Und daf√ºr habe ich mir ein Ziel gesetzt, keine vorgefertigten L√∂sungen, nur meine. </font><font style="vertical-align: inherit;">Und wenn alles f√ºr mich geklappt hat, werden Sie Erfolg haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste von allem, was Sie brauchen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16+ </font><font style="vertical-align: inherit;">virtuelle Maschine </font><font style="vertical-align: inherit;">oder was auch immer</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arm-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compiler - Download unter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads</font></font></a> </li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openocd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Debugger und Programmierer - Sie k√∂nnen nicht √ºber den Link herunterladen, wir sammeln aus den Quellen, die Anleitung ist beigef√ºgt</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/openocd/code openocd</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Texteditor nach Ihren W√ºnschen</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alles installiert und montiert ist, k√∂nnen wir mit dem ersten Projekt fortfahren! </font><font style="vertical-align: inherit;">Und nein, es ist nicht einmal eine blinkende Gl√ºhbirne. </font><font style="vertical-align: inherit;">Zun√§chst m√ºssen wir uns mit dem Initialisierungsprozess der Mikrotiterplatte selbst befassen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was wir brauchen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linker.ld</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init.c</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit dem letzten Absatz Init.c. </font><font style="vertical-align: inherit;">Zun√§chst sollte unser mk die Adresse laden. "Stapelzeiger" ist ein Zeiger auf die Speicheradresse, die f√ºr die PUSH- und POP-Anweisungen verwendet wird. </font><font style="vertical-align: inherit;">Ich empfehle Ihnen dringend, diese beiden Anweisungen gr√ºndlich zu studieren, da ich nicht alle Anweisungen im Detail erl√§utern werde. </font><font style="vertical-align: inherit;">Wie Sie dies implementieren, siehe unten.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns nun dieses Beispiel an. </font><font style="vertical-align: inherit;">Extern bedeutet, dass das Symbol extern ist, und wir haben dieses Symbol in der Datei Linker.ld deklariert. Wir werden etwas sp√§ter darauf zur√ºckkommen.</font></font><br>
<br>
<pre><code class="cpp hljs"> __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Hier verwenden wir ein Attribut, das den Compiler anweist, das Array im Abschnitt isr_vector zu platzieren, und dass es auch dann im Programm enthalten sein muss, wenn wir es nicht im Code verwenden. Und sein erstes Element wird der gleiche Zeiger sein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns nun herausfinden, warum dieses Array ist und womit es gegessen wird. Im Gegensatz zu einem herk√∂mmlichen Prozessor beginnt die Ausf√ºhrung von Mikron auf der Armarchitektur, wenn nicht von der Nulladresse, sondern von der Adresse, auf die der Zeiger in diesem Array zeigt, alles kompliziert ist. Au√üerdem zeigt der erste Zeiger in diesem Array immer auf den Anfang des Stapels, der zweite zeigt jedoch bereits auf den Anfang unseres Codes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde ein Beispiel geben. Es wird angegeben, dass der Stapel mit 0x20010000 beginnt und der Programmcode 0x0800008 lautet. dann kann das Array geschrieben werden als</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {
    <span class="hljs-number">0x20010000</span>,
    <span class="hljs-number">0x08000008</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das hei√üt, die Steuerung initialisiert zuerst den Stapel, ber√ºcksichtigt dann die Adresse des ersten Befehls und l√§dt sie in das Programmz√§hlerregister. Das Wichtigste ist nun, dass diese Zahlen je nach Modell unterschiedlich sein k√∂nnen, aber am Beispiel von stm32f7 kann ich mit Sicherheit sagen, dass sich dieses Array unter der Adresse 0x08000000 im Speicher befinden sollte. Von dieser Adresse aus beginnt mk nach dem Einschalten oder Zur√ºcksetzen seine Arbeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werden wir anhalten und darauf achten, wie dieses Array in den Abschnitt eingef√ºgt wird, den wir ben√∂tigen. Dies erfolgt durch "ld" oder Linker. Dieses Programm sammelt unser gesamtes Programm zusammen und das Linker.ld-Skript wird daf√ºr verwendet. Ich gebe ein Beispiel und analysiere es weiter.</font></font><br>
<br>
<pre><code class="plaintext hljs">MEMORY{<font></font>
	ROM_AXIM (rx) : ORIGIN = 0x08000000, LENGTH = 1M<font></font>
	RAM_DTCM (rwx): ORIGIN = 0x20000000, LENGTH = 64K<font></font>
}<font></font>
<font></font>
_estack = LENGTH(RAM_DTCM) + ORIGIN(RAM_DTCM);<font></font>
<font></font>
SECTIONS{<font></font>
	.isr_vector : {<font></font>
	KEEP(*(.isr_vector))<font></font>
	} &gt;ROM_AXIM&lt;/code&gt;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, was hier passiert. MEMORY definiert Speicherabschnitte und SECTIONS definiert Abschnitte. hier sehen wir unseren Stapel und die Tatsache, dass er gleich der Summe aus dem Beginn des Ged√§chtnisses und seiner L√§nge, dh dem Ende unseres Ged√§chtnisses, ist. Der Abschnitt .isr_vector, in den wir unser Array einf√ºgen, ist ebenfalls definiert. </font></font><code>&gt;ROM_AXIM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am Ende unseres Abschnitts bedeutet, dass dieser Abschnitt in den Speicherabschnitt eingef√ºgt werden sollte, der mit 0x08000000 beginnt, wie von unseren Mikrometern gefordert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir platzieren das Array dort, wo es jetzt notwendig ist. Wir ben√∂tigen eine Anweisung, damit unser Mikron funktioniert. Hier ist die erweiterte init.c:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie bereits erw√§hnt, muss die zweite Adresse ein Zeiger auf die erste Funktion oder Anweisung sein. </font><font style="vertical-align: inherit;">Und wieder die Attribute, aber alles ist einfach, die Funktion gibt keine Werte zur√ºck und folgt einem ABI am Eingang, dh nackt "nackt". </font><font style="vertical-align: inherit;">In solchen Funktionen wird der √ºbliche Assembler geschoben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt ist es an der Zeit, unseren Code zu kompilieren und zu sehen, was sich unter der Haube befindet. </font><font style="vertical-align: inherit;">Wir werden das Makefile vorerst nicht ber√ºhren.</font></font><br>
<br>
<pre><code class="bash hljs">arm-none-eabi-gcc -c init.c -o init.o -mthumb</code></pre><br>
<pre><code class="bash hljs">arm-none-eabi-gcc -TLinker.ld -o prog.elf init.o -Wl,--gc-sections -nostartfiles -nodefaultlibs -nostdlib</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier sehen wir viel Unverst√§ndliches. </font><font style="vertical-align: inherit;">in Ordnung:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-mthumb kompiliert f√ºr armv7, das nur Thumb-Anweisungen verwendet </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TLinker.ld gibt das Linker-Skript an. </font><font style="vertical-align: inherit;">Standardm√§√üig wird es f√ºr die Ausf√ºhrung in der Linux-Umgebung kompiliert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Wl, - gc-section -nostartfiles -nodefaultlibs -nostdlib entfernt alle Standardbibliotheken, Initialisierungsdateien der Umgebung C und alle anderen Hilfsbibliotheken wie Mathematik.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nat√ºrlich macht es keinen Sinn, dies in Mikrometer zu laden. </font><font style="vertical-align: inherit;">Aber es macht Sinn, die Bin√§rdatei zu betrachten und zu studieren.</font></font><br>
<br>
<pre><code class="bash hljs">objcopy -O ihex prog.elf prog.bin</code></pre><br>
<pre><code class="bash hljs">hexdump prog.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann werden wir die Schlussfolgerung sehen. </font><font style="vertical-align: inherit;">"00000000: 00 01 00 02 09 00 00 08", das unseren Erfolg symbolisiert. </font><font style="vertical-align: inherit;">Dies ist mein erster Artikel, und ich konnte nicht das gesamte Material und die Essenz vollst√§ndig enth√ºllen. Im n√§chsten Abschnitt werde ich die Mechanismen detaillierter beschreiben und wir Freunde k√∂nnen zu einem Programm √ºbergehen, das kein Licht blinkt, sondern die Uhr des Prozessors und der Busse konfiguriert.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de490462/index.html">Dienstleistungsmonopol und Netzneutralit√§t - Beeren werden voraus sein</a></li>
<li><a href="../de490464/index.html">√úber einen erfolglosen Versuch, das Urheberrecht brutal zu erzwingen, oder √ºber 68 Milliarden Musikst√ºcke, die nichts √§ndern werden</a></li>
<li><a href="../de490466/index.html">Roadmap mathematischer Disziplinen f√ºr maschinelles Lernen, Teil 2 (Wahrscheinlichkeiten)</a></li>
<li><a href="../de490470/index.html">OWASP Moskau 2020/1</a></li>
<li><a href="../de490472/index.html">Da habe ich eine semi-dezentrale Kryptow√§hrung in PHP geschrieben. (Teil 1 - Sammeln von Bibliotheken)</a></li>
<li><a href="../de490476/index.html">Drahtloser Sensor zum √ñffnen und Schlie√üen mit erweiterter Funktionalit√§t</a></li>
<li><a href="../de490478/index.html">DIY DIY L√∂tstation v2</a></li>
<li><a href="../de490480/index.html">O Tiling-wm in 2 Worten</a></li>
<li><a href="../de490484/index.html">Verwalten von Smart-Home-Sensoren mit dem Google-Assistenten</a></li>
<li><a href="../de490490/index.html">Wochenendlesung: 10 Materialien zu den Auswirkungen von Ger√§uschen auf die Gesundheit - von ‚ÄûL√§rmhygiene‚Äú √ºber guten Schlaf bis hin zu GTD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>