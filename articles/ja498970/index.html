<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🔧 🙆🏼 👯 Kubernetes ConfigMaps：知っておくべきニュアンス 😜 🧐 🌹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注：これは本格的なガイド記事ではなく、KubernetesでConfigMapをすでに使用している、またはアプリケーションで動作するようにアプリケーションを準備しているだけのユーザーへの注意/ヒントです。
 
 
 
 背景：rsyncから... Kubernetes
 前に何があったの？ 「クラシ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps：知っておくべきニュアンス</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：これは本格的なガイド記事ではなく、KubernetesでConfigMapをすでに使用している、またはアプリケーションで動作するようにアプリケーションを準備しているだけのユーザーへの注意/ヒントです。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景：rsyncから... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前に何があったの？ 「クラシック管理」の時代では、最も単純なバージョンでは、設定ファイルはアプリケーションのすぐ隣（または、必要に応じてリポジトリ）に配置されていました。それは簡単です。私たちは、コードとともに基本構成（CD）を構成とともに作成します。条件付きのrsync実装でさえ、CDの基本と呼ぶことができます。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャが大きくなると、さまざまな環境（開発/ステージ/実稼働）ごとに異なる構成が必要になります。アプリケーションは、使用する構成を理解するようにトレーニングされ、それらを開始の引数または環境に設定された環境変数として渡します。さらに便利なChef / Puppet / Ansibleの登場により、CDはさらに複雑になっています。役割はサーバーに表示され、環境はさまざまな場所で記述されなくなります。IaC（コードとしてのインフラストラクチャー）に移行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が続いた？ Kubernetes自体の重要な利点を確認でき、この環境で動作するようにアプリケーションを変更する必要があるとさえ考えられる場合、移行が行われました。途中、たくさんのニュアンスや構成の違いが予想されたのですが、なんとか本編に対応したところ、待望のK8sで動作するアプリケーションが動作しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、アプリケーションの横のリポジトリで準備された設定を使用するか、ENVをコンテナに渡すことができます。</font><font style="vertical-align: inherit;">ただし、これらのメソッドに加えて、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も使用できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このK8sプリミティブを使用すると、構成でGoテンプレートを使用できます。</font><font style="vertical-align: inherit;">それらをHTMLページのようにレンダリングし、再起動せずに設定を変更するときにアプリケーションをリロードします。</font><font style="vertical-align: inherit;">ConfigMapsを使用すると、異なる環境で3つ以上の構成を保持し、それぞれの関連性を追跡する必要がなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigMapの一般的な概要は、たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そしてこの記事では、それらを扱ういくつかの機能に焦点を当てます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シンプルなConfigMap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesでの構成はどのように見えましたか？</font><font style="vertical-align: inherit;">外出先のテンプレートから何が得られましたか？</font><font style="vertical-align: inherit;">たとえば、Helmチャートからデプロイされたアプリケーションの通常のConfigMapは次のとおりです。</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで値がで置換</font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルから取得されます</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">なぜ正確に</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">Goテンプレートエンジンはどのように機能しますか？</font><font style="vertical-align: inherit;">これらの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">詳しく説明し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出し</font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、マップから必要な行を選択するのに役立ちます。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、構成の特定の行とフラグメント全体の両方を取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ConfigMapは次のようになります。</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...および</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-次のコンテンツ：</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここ</font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">関係するの</font><font style="vertical-align: inherit;">は環境の名前です。</font><font style="vertical-align: inherit;">デプロイメント中にこの値を置き換えると、さまざまなコンテンツでConfigMapをレンダリングできます。</font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに必要なのは </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の要素に目的の値が含まれているリストを返します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定が多い場合</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのConfigMapには、いくつかの構成ファイルを含めることができます。</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各構成を個別にマウントすることもできます。</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...または、ディレクトリを使用してすべての構成を一度に取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デプロイ中にDeploymentリソースの説明を変更すると、Kubernetesは新しいReplicaSetを作成し、古いものを0に減らし、新しいものを指定された数のレプリカに増やします。</font><font style="vertical-align: inherit;">（これはデプロイメント戦略にも当てはまります</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなアクションは、新しい説明でポッドを再作成することにつながります。</font><font style="vertical-align: inherit;">例：画像</font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">ありましたが、</font><font style="vertical-align: inherit;">-になりました</font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、Deploymentの説明で正確に何を変更したかはまったく問題ではありません。主なことは、これにより、replicaSet（およびその結果、ポッド）が再作成されたことです。</font><font style="vertical-align: inherit;">この場合、アプリケーションの新しいバージョンの構成ファイルの新しいバージョンが自動的にマウントされ、問題はありません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap変更応答</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigMapが変更された場合、4つのイベントシナリオが発生する可能性があります。</font><font style="vertical-align: inherit;">それらを考慮してください：</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap’,   Deployment,   pod  ,   —        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod’   / pod’.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より詳しく分析します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シナリオ1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">唯一の</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ConfigMapを修正しましたか？</font><font style="vertical-align: inherit;">アプリケーションは再起動しません。</font><font style="vertical-align: inherit;">によるマウントの場合</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ポッドを手動で再起動するまで変更はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてがシンプルです。Kubernetesは、特定のバージョンのリソースのポッドにConfigMapをマウントします。</font><font style="vertical-align: inherit;">でマウントされているため</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、構成に対する追加の「影響」はありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シナリオ2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポッドを再作成しないとファイルを更新できませんか？</font><font style="vertical-align: inherit;">デプロイに6つのレプリカがあるので、順番にすべてを手動で実行できます</font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その後、新しいポッドを作成すると、新しいバージョンのConfigMapが「取得」されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シナリオ3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような操作を手動で実行するのにうんざりしていませんか？</font><font style="vertical-align: inherit;">この問題の解決策は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helmのヒントとコツに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記載されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レンダリングされたアノテーション設定のハッシュは、単に</font><font style="vertical-align: inherit;">pod（</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">テンプレートに</font><font style="vertical-align: inherit;">書き込ま</font><font style="vertical-align: inherit;">れ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注釈は、値を格納できる任意のKey-Valueフィールドです。</font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらを将来のポッドの</font><font style="vertical-align: inherit;">テンプレートに登録すると</font><font style="vertical-align: inherit;">、これらのフィールドはレプリカセットとポッド自体に含まれます。</font><font style="vertical-align: inherit;">Kubernetesは、ポッドテンプレートが変更されたことに気づき（sha256構成が変更されたため）、</font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このアノテーション以外は何も変更されずに</font><font style="vertical-align: inherit;">開始さ</font><font style="vertical-align: inherit;">れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は、手動によるそれを行うだろうかと似-その結果、我々は実際には、単に自動的に再作成するポッドをトリガし、展開のアプリケーションと説明の同じバージョンを保存し、</font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動的にで：「正しく」すでに、しかし</font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シナリオ4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、アプリケーションはすでに構成の変更を監視して自動的に再読み込みする方法を知っていますか？</font><font style="vertical-align: inherit;">ここにConfigMapの重要な機能があります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesでは、設定がでマウントされている場合</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ポッドが再起動されるまで更新されません</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（前述の最初の3つのシナリオを参照）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ただし、ConfigMapをなし</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ディレクトリとしてマウント</font><font style="vertical-align: inherit;">すると、コンテナ内には、ポッドを再起動せずに更新された設定を持つディレクトリが存在します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
覚えておくと便利な他の機能があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナ内のこのような更新された設定ファイルは、少し遅れて更新されます。</font><font style="vertical-align: inherit;">これは、ファイルが正確にマウントされておらず、Kubernetesオブジェクトがマウントされているためです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部のファイルはシンボリックリンクです。</font><font style="vertical-align: inherit;">の例</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ディレクトリによってマウントされ</font><font style="vertical-align: inherit;">ない</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">はどうなり</font><font style="vertical-align: inherit;">ますか？</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（デプロイまたはを介して</font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）構成</font><font style="vertical-align: inherit;">を更新し、</font><font style="vertical-align: inherit;">2分（APIサーバーのキャッシュ時間）待機します。</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesによって作成されたディレクトリの変更されたタイムスタンプに注意してください。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更の追跡</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に-構成の変更を監視する方法の簡単な例。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このようなGoアプリケーションを使用します</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...そのような設定でそれを追加します：</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行すると、ログは次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、このアプリケーションをKubernetesにインストールし、イメージからのファイルではなく、ConfigMap構成をポッドにマウントします。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helmチャート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">例が</font></a><font style="vertical-align: inherit;"> GitHubに用意されています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigMapのみを変更します。</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、次のようにクラスターのHelmチャートを更新します。</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が起こるか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションv1およびv2は再起動しません。</font><font style="vertical-align: inherit;">彼らにとって、Deploymentに変更はありません-彼らはまだアリスを歓迎します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v3アプリケーションが再起動し、構成を再度読み取り、Bobに挨拶しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4アプリケーションは再起動しませんでした。</font><font style="vertical-align: inherit;">ConfigMapはディレクトリとしてマウントされているため、ポッドを再起動することなく、構成の変更に気付き、その場で構成が変更されました。</font><font style="vertical-align: inherit;">はい、アプリケーションは簡単な例の変更に気づきました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からのイベントメッセージを参照してください</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様の状況（ConfigMapの変更の追跡）が、より大人の（そして「実際の」）プロジェクトでどのように解決されているかは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらで確認できます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、記事の上記のすべてがKubernetes（</font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">Secret'ovにも当てはまることを思い出し</font><font style="vertical-align: inherit;">ておくと役立ちます。ConfigMapに非常に似ているのは何の理由にもなりません...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボーナス！</font><font style="vertical-align: inherit;">サードパーティのソリューション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定の変更を追跡するトピックに興味がある場合は、これのための既製のユーティリティがすでにあります。</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルが変更された場合、HTTPリクエストを送信します。</font><font style="vertical-align: inherit;">開発者はSIGHUPに送信を教えることも計画していますが、2019年10月以降のコミットの欠如により、これらの計画は問題となっています。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ConfigMap /シークレットを監視し、関連付けられたリソースに対してローリングアップグレードを実行します（作成者がそれを呼び出します）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなアプリケーションをサイドカーコンテナで既存のアプリケーションに起動すると便利です。</font><font style="vertical-align: inherit;">ただし、Kubernetes / ConfigMapとconfigsの機能が「ライブ」</font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ではなく、デプロイの一部としてのみ</font><font style="vertical-align: inherit;">編集できることがわかっている場合</font><font style="vertical-align: inherit;">、そのようなユーティリティの機能は不必要に見える可能性があります。</font><font style="vertical-align: inherit;">基本機能の複製。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KubernetesでのConfigMapの登場により、構成は次の開発ラウンドに移行しました。テンプレートエンジンの使用により、HTMLページのレンダリングに匹敵する柔軟性がもたらされました。</font><font style="vertical-align: inherit;">幸いなことに、このような合併症は</font><font style="vertical-align: inherit;">既存のソリューションに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取って代わるもので</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はなく</font><font style="vertical-align: inherit;">、それらを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">補完するもの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">となりました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、新機能を冗長であると考える管理者（または、開発者でさえ）にとって、古き良き古いファイルがまだ利用可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにConfigMap'amiを使用している、または単に見ているだけの人のために、記事では、使用の本質とニュアンスの概要を説明しています。</font><font style="vertical-align: inherit;">あなたがトピックについてあなた自身のヒントとトリックを持っているなら-私はコメントで見てうれしいです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションをKubernetesに移植するときのローカルファイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Kubernetes  Helm:    </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja498944/index.html">電報、犬、または鏡を作らない方法</a></li>
<li><a href="../ja498948/index.html">ドラゴンの時間です。パズルによる自己分離</a></li>
<li><a href="../ja498952/index.html">DINS JS EVENINGにご招待します。アスペクト指向プログラミングとVuejs 3コンポジションAPIフレームワークについて話しています。</a></li>
<li><a href="../ja498958/index.html">エラーはUIAlertControllerではありません</a></li>
<li><a href="../ja498962/index.html">マルチタスクについて：制御下のウィンドウ</a></li>
<li><a href="../ja498974/index.html">コロナウイルス：不安の危険な幻想</a></li>
<li><a href="../ja498976/index.html">.NET 5.0 Preview 3の紹介</a></li>
<li><a href="../ja498978/index.html">GraylogとNLogを使用してC＃アプリケーションからログを収集する。個人的体験</a></li>
<li><a href="../ja498982/index.html">ドリームキャストのフロッピー</a></li>
<li><a href="../ja498984/index.html">ステルススクール：ステルスゲームの5種類のガジェット</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>