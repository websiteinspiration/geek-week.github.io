<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìé üò© üö¶ O Ableton n√£o √© necess√°rio: conecte o Ableton Push 2 ao rack de VCV üëö üë©üèø‚Äçü§ù‚Äçüë®üèª üò¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ultimamente, a cria√ß√£o da m√∫sica acontece da mesma maneira que uma fotografia h√° 10 anos: cada uma tem sua pr√≥pria conta DSLR e instagram. A ind√∫stria...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>O Ableton n√£o √© necess√°rio: conecte o Ableton Push 2 ao rack de VCV</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491244/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/vm/8j/qkvm8jnnid3kb_8kybxztptlbfu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ultimamente, a cria√ß√£o da m√∫sica acontece da mesma maneira que uma fotografia h√° 10 anos: cada uma tem sua pr√≥pria conta DSLR e instagram. A ind√∫stria da m√∫sica est√° muito feliz com isso, porque esse interesse gera muito dinheiro. Todos os dias surgem novos plugins VST e dispositivos anal√≥gicos, o n√∫mero de cursos tem√°ticos est√° crescendo rapidamente, blogs dedicados √† produ√ß√£o musical v√£o para o topo do youtube. Nesse contexto, os projetos de c√≥digo aberto parecem muito interessantes, permitindo que qualquer pessoa que queira se experimentar como produtor sem gastar muito dinheiro com isso. Um desses projetos √© o VCV Rack, que visa tornar a classe mais cara de instrumentos musicais - sintetizadores modulares anal√≥gicos - acess√≠vel a todos. Recentemente, quando tive a ideia de uma faixa,e na m√£o havia apenas um laptop linux, eu queria fazer a faixa inteira em VCV. E ao longo do caminho, houve um desejo de controlar os sintetizadores usando o controlador midi de uma maneira que o uso dos m√≥dulos dispon√≠veis n√£o funcionasse. No final, decidi escrever um plugin para conectar o Ableton Push 2 ao VCV Rack. Falaremos sobre o que aconteceu e como escrever nossos pr√≥prios m√≥dulos para VCV neste artigo.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncia r√°pida</font></font></b><div class="spoiler_text">VCV Rack ‚Äî open source ,   .  VCV  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">  </a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
Ableton Push 2 ‚Äî    midi-  Ableton,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"> DAW</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">API    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0CdMvkBOUgs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API de rack de VCV</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada m√≥dulo no VCV consiste em duas partes - √°udio e gr√°fico. </font><font style="vertical-align: inherit;">A parte de √°udio herda da classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o m√©todo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , chamado para cada amostra, ou seja, com uma frequ√™ncia de amostragem. </font><font style="vertical-align: inherit;">A prop√≥sito, a frequ√™ncia de amostragem no VCV pode variar de 44,1 kHz padr√£o a 768 kHz, o que permite emula√ß√£o mais precisa de sintetizadores modulares com capacidade de computa√ß√£o suficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objetos do tipo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ModuleWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o respons√°veis ‚Äã‚Äãpelos gr√°ficos </font><font style="vertical-align: inherit;">, que herdam o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da estrutura base </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O VCV usa a biblioteca de gr√°ficos vetoriais nanovg. </font><font style="vertical-align: inherit;">Desenho dentro do m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isso pode ocorrer dentro dos limites do m√≥dulo (o excesso √© cortado pelo mecanismo) e, por exemplo, no buffer de estrutura, que ainda usamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, o que √© necess√°rio para escrever seu m√≥dulo para VCV?</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurando o Ambiente e Instalando o Rack SDK</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro passo √© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bem descrito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na documenta√ß√£o e n√£o causa nenhuma dificuldade (pelo menos no linux), portanto, n√£o iremos nos debru√ßar sobre ele.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gere um modelo de plug-in</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° um script helper.py para isso no Rack SDK. </font><font style="vertical-align: inherit;">Ele precisa dizer createplugin e depois especificar o nome do plug-in e, opcionalmente, informa√ß√µes sobre ele.</font></font><br>
<br>
<pre><code class="bash hljs">&lt;Rack SDK folder&gt;/helper.py createplugin MyPlugin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o modelo do plugin √© criado, ele pode ser compilado e instalado com o comando</font></font><br>
<br>
<pre><code class="bash hljs">RACK_DIR=&lt;Rack SDK folder&gt; make install</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenhe a interface do m√≥dulo</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada plug-in pode conter v√°rios m√≥dulos e, para cada um dos m√≥dulos, voc√™ precisa desenhar um painel principal. Para isso, a documenta√ß√£o do VCV nos oferece o uso do Inkscape ou de qualquer outro editor de vetores. Como os m√≥dulos no VCV s√£o montados em um suporte virtual Eurorack, sua altura √© sempre 128,5 mm e a largura deve ser um m√∫ltiplo de 5,08 mm. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elementos b√°sicos da interface, como soquetes CV / Gate, bot√µes e l√¢mpadas, podem ser marcados em forma de vetor. Para fazer isso, desenhe em seu lugar c√≠rculos das cores correspondentes ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais detalhes aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), para que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py gere</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo para essa marca√ß√£o. Pessoalmente, pareceu-me que esse n√£o √© um recurso muito conveniente e √© mais f√°cil colocar elementos diretamente do c√≥digo. Quando a imagem e o layout estiverem prontos, voc√™ precisar√° executar o </font><i><font style="vertical-align: inherit;">helper.py</font></i><font style="vertical-align: inherit;"> novamente</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para criar um modelo de m√≥dulo e associ√°-lo ao painel frontal.</font></font><br>
<br>
<pre><code class="bash hljs">helper.py createmodule MyModule res/MyModule.svg src/MyModule.cpp</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conectamos bot√µes e tor√ß√µes</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/oz/wq/z_/ozwqz_ss4sqqdci_q7dxbarbfve.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m da tela, o Ableton Push 2 √© visto pelo computador como um dispositivo USB-MIDI comum, o que facilita o estabelecimento de uma conex√£o entre ele e o rack de VCV. </font><font style="vertical-align: inherit;">Para fazer isso, crie uma fila midi de entrada e uma porta midi de sa√≠da dentro da classe do m√≥dulo.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de inicializa√ß√£o</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AbletonPush2</span> :</span> Module {<font></font>
    midi::Output midiOutput;<font></font>
    midi::InputQueue midiInput;<font></font>
<font></font>
    <span class="hljs-keyword">bool</span> inputConnected;
    <span class="hljs-keyword">bool</span> outputConnected;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar encontrar o Ableton Push entre os dispositivos midi conectados e conectar a ele. </font><font style="vertical-align: inherit;">Como o m√≥dulo foi projetado para funcionar exclusivamente com o Ableton Push, n√£o precisamos sobrecarregar o usu√°rio com a escolha do dispositivo e voc√™ pode simplesmente encontr√°-lo pelo nome.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de conex√£o do controlador</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">connectPush</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> in_devs = midiInput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; in_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiInput.getDeviceName(in_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiInput.setDeviceId(in_devs[i]);<font></font>
            inputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
		<font></font>
    <span class="hljs-keyword">auto</span> out_devs = midiOutput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; out_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiOutput.getDeviceName(out_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiOutput.setDeviceId(out_devs[i]);<font></font>
            outputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, no m√©todo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">voc√™ pode verificar periodicamente se o controlador est√° conectado e perguntar √† fila do midi se alguma mensagem chegou. </font><font style="vertical-align: inherit;">Aqui vale a pena mencionar o que e como √© geralmente codificado no padr√£o midi. </font><font style="vertical-align: inherit;">De fato, existem dois tipos principais de mensagens: Nota ON / OFF, transmitindo o n√∫mero da nota e pressionando a for√ßa, e CC - Command Control, transmitindo o valor num√©rico de algum par√¢metro vari√°vel. </font><font style="vertical-align: inherit;">Mais informa√ß√µes sobre o midi podem ser encontradas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de pesquisa da fila MIDI</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ProcessArgs &amp;args)</span> <span class="hljs-keyword">override</span> </span>{
    <span class="hljs-keyword">if</span> (sampleCounter &gt; args.sampleRate / updateFrequency) {<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((!inputConnected) &amp;&amp; (!outputConnected)) {<font></font>
            connectPush();<font></font>
        }<font></font>
<font></font>
	midi::Message msg;<font></font>
	<span class="hljs-keyword">while</span> (midiInput.shift(&amp;msg)) {<font></font>
	    processMidi(msg);<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, quero ensinar os controles a brilharem em cores diferentes, para que seja mais conveniente naveg√°-los. Para fazer isso, precisaremos enviar a ele o comando midi apropriado. Considere, por exemplo, o teclado n√∫mero 36 (este √© o teclado esquerdo mais baixo). Se voc√™ clicar nele, o controlador enviar√° o comando 0x90 (nota ativada), seguido pelo n√∫mero da nota (36) e um n√∫mero de 0 a 127, o que significa a for√ßa da impressora. E quando, pelo contr√°rio, o computador envia ao controlador o mesmo comando 0x90 e o mesmo n√∫mero de nota 36, ‚Äã‚Äão terceiro n√∫mero indica a cor com a qual o teclado inferior esquerdo deve brilhar. Os n√∫meros dos bot√µes e bot√µes s√£o mostrados na figura acima. O Push tem algumas possibilidades para trabalhar com cores, paletas, anima√ß√£o e outros par√¢metros de luz de fundo. N√£o entrei em detalhes e simplesmente trouxe todas as cores poss√≠veis da paleta padr√£o para os blocos e escolhi as que eu mais gostava.Mas, no caso geral, a convers√£o de comandos midi em valores de PWM em LEDs, de acordo com a documenta√ß√£o, √© assim:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/at/zq/8oatzqvwy_gwqvgu4cmjgjpbknm.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de controle da luz de fundo</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note, <span class="hljs-keyword">int</span> color)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(color);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x9</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOff</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(<span class="hljs-number">0</span>);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x8</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s conectamos a tela</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/os/yl/kv/osylkvou5ba8_aoa3rwhst94uiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectar a tela, voc√™ precisa trabalhar com USB. </font><font style="vertical-align: inherit;">O pr√≥prio controlador n√£o sabe desenhar nada e n√£o sabe nada sobre gr√°ficos. </font><font style="vertical-align: inherit;">Tudo o que ele quer √© enviar um quadro de 160x960 pixels em tamanho pelo menos a cada 2 segundos. </font><font style="vertical-align: inherit;">Toda a renderiza√ß√£o ocorre na lateral do computador. </font><font style="vertical-align: inherit;">Para iniciar, conecte e abra o dispositivo USB, conforme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descrito na documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exibir c√≥digo de conex√£o</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _MSC_VER</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span><font></font>
<font></font>
<span class="hljs-comment">// see following link for a discussion of the</span>
<span class="hljs-comment">// warning suppression:</span>
<span class="hljs-comment">// http://sourceforge.net/mailarchive/forum.php?</span>
<span class="hljs-comment">// thread_name=50F6011C.2020000%40akeo.ie&amp;forum_name=libusbx-devel</span><font></font>
<font></font>
<span class="hljs-comment">// Disable: warning C4200: nonstandard extension used:</span>
<span class="hljs-comment">// zero-sized array in struct/union</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(disable:4200)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __linux__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libusb-1.0/libusb.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"libusb.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ABLETON_VENDOR_ID 0x2982</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_PRODUCT_ID  0x1967</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> libusb_device_handle* <span class="hljs-title">open_push2_device</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> result;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> ((result = libusb_init(<span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%d] could not initilialize usblib\n"</span>, result);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_set_debug(<span class="hljs-literal">NULL</span>, LIBUSB_LOG_LEVEL_ERROR);<font></font>
<font></font>
  libusb_device** devices;<font></font>
  <span class="hljs-keyword">ssize_t</span> count;<font></font>
  count = libusb_get_device_list(<span class="hljs-literal">NULL</span>, &amp;devices);
  <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%ld] could not get usb device list\n"</span>, count);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_device* device;<font></font>
  libusb_device_handle* device_handle = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
  <span class="hljs-keyword">char</span> ErrorMsg[<span class="hljs-number">128</span>];<font></font>
<font></font>
  <span class="hljs-comment">// set message in case we get to the end of the list w/o finding a device</span>
  <span class="hljs-built_in">sprintf</span>(ErrorMsg, <span class="hljs-string">"error: Ableton Push 2 device not found\n"</span>);<font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; (device = devices[i]) != <span class="hljs-literal">NULL</span>; i++)<font></font>
  {<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">libusb_device_descriptor</span> <span class="hljs-title">descriptor</span>;</span>
    <span class="hljs-keyword">if</span> ((result = libusb_get_device_descriptor(device, &amp;descriptor)) &lt; <span class="hljs-number">0</span>)<font></font>
    {<font></font>
      <span class="hljs-built_in">sprintf</span>(ErrorMsg,
        <span class="hljs-string">"error: [%d] could not get usb device descriptor\n"</span>, result);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (descriptor.bDeviceClass == LIBUSB_CLASS_PER_INTERFACE<font></font>
      &amp;&amp; descriptor.idVendor == ABLETON_VENDOR_ID<font></font>
      &amp;&amp; descriptor.idProduct == PUSH2_PRODUCT_ID)<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ((result = libusb_open(device, &amp;device_handle)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not open Ableton Push 2 device\n"</span>, result);<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((result = libusb_claim_interface(device_handle, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not claim interface 0 of Push 2 device\n"</span>, result);<font></font>
        libusb_close(device_handle);<font></font>
        device_handle = <span class="hljs-literal">NULL</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// successfully opened</span><font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (device_handle == <span class="hljs-literal">NULL</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(ErrorMsg);<font></font>
  }<font></font>
<font></font>
  libusb_free_device_list(devices, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> device_handle;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close_push2_device</span><span class="hljs-params">(libusb_device_handle* device_handle)</span>
</span>{<font></font>
  libusb_release_interface(device_handle, <span class="hljs-number">0</span>);<font></font>
  libusb_close(device_handle);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para transmitir um quadro, voc√™ deve primeiro enviar um cabe√ßalho de 16 bytes e, em seguida, 160 linhas de 960 n√∫meros de 16 bits cada. </font><font style="vertical-align: inherit;">Ao mesmo tempo, de acordo com a documenta√ß√£o, as strings n√£o devem ser transmitidas em 1920 bytes, mas em pacotes de 2048 bytes, complementados com zeros.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de transfer√™ncia de quadros</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Push2Display</span> :</span> FramebufferWidget {<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frame_header[<span class="hljs-number">16</span>] = {
          <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x88</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> <font></font>
    };<font></font>
<font></font>
    libusb_device_handle* device_handle;<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* image;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendDisplay</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * image)</span> </span>{
        <span class="hljs-keyword">int</span> actual_length;<font></font>
     <font></font>
        libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, frame_header, <span class="hljs-keyword">sizeof</span>(frame_header), &amp;actual_length, TRANSFER_TIMEOUT);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">160</span>; i++)<font></font>
            libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, &amp;image[(<span class="hljs-number">159</span> - i)*<span class="hljs-number">1920</span>], <span class="hljs-number">2048</span>, &amp;actual_length, TRANSFER_TIMEOUT);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora resta apenas desenhar e gravar um quadro no buffer. </font><font style="vertical-align: inherit;">Para fazer isso, use a classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramebufferWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que implementa o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drawFramebuffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O rack VCV </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pronto para</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uso usa a biblioteca </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">nanovg</font></a><font style="vertical-align: inherit;"> , por isso √© muito f√°cil escrever gr√°ficos aqui. </font><font style="vertical-align: inherit;">Aprendemos o contexto gr√°fico atual da vari√°vel global APP e salvamos seu estado. </font><font style="vertical-align: inherit;">Em seguida, crie um quadro vazio de 160x960 e desenhe-o com o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Depois disso, copie o framebuffer para a matriz que ser√° enviada via USB e retorne o estado do contexto. </font><font style="vertical-align: inherit;">No final, defina o sinalizador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que, na pr√≥xima itera√ß√£o da renderiza√ß√£o, o mecanismo VCV n√£o esque√ßa de atualizar nosso widget.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de renderiza√ß√£o de quadro</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">drawFramebuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{<font></font>
<font></font>
    NVGcontext* vg = APP-&gt;window-&gt;vg;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (display_connected) {<font></font>
        nvgSave(vg);<font></font>
	glViewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>);<font></font>
        glClearColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
        glClear(GL_COLOR_BUFFER_BIT|GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
	nvgBeginFrame(vg, <span class="hljs-number">960</span>,  <span class="hljs-number">160</span>, <span class="hljs-number">1</span>);<font></font>
        draw(vg);<font></font>
        nvgEndFrame(vg);<font></font>
<font></font>
        glReadPixels(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>, GL_RGB, GL_UNSIGNED_SHORT_5_6_5, image); <font></font>
<font></font>
        <span class="hljs-comment">//  XOR   ,  </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>*<span class="hljs-number">960</span>; i ++){<font></font>
            image[i * <span class="hljs-number">4</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] ^= <span class="hljs-number">0xF3</span>;<font></font>
            image[i * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] ^= <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
	    	<font></font>
	sendDisplay(image);<font></font>
<font></font>
	nvgRestore(vg);<font></font>
    }<font></font>
<font></font>
    dirty = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≥gica de intera√ß√£o e mapeamento de par√¢metros</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para minha tarefa, eu queria poder alternar padr√µes gravados em seq√ºenciadores e, ao mesmo tempo, controlar um certo conjunto de par√¢metros, o meu para cada grupo de padr√µes. </font><font style="vertical-align: inherit;">Por mapeamento, entendo a liga√ß√£o do par√¢metro de um m√≥dulo com o par√¢metro de outro m√≥dulo ou controlador midi. </font><font style="vertical-align: inherit;">Encontrei muito pouca informa√ß√£o sobre como fazer um mapeamento bonito, ent√£o peguei a maior parte do c√≥digo que o implementa a partir do m√≥dulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI Map</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> embutido no VCV </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em resumo, para cada grupo de par√¢metros, um objeto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ParamHandle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especial √© </font><i><font style="vertical-align: inherit;">criado l√°</font></i><font style="vertical-align: inherit;"> , que </font><font style="vertical-align: inherit;">informa ao mecanismo </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atrav√©s de muletas o</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que est√° conectado com o que.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um m√≥dulo que recebi no final. </font><font style="vertical-align: inherit;">Al√©m da convers√£o padr√£o de midi para CV, permite agrupar pads, atribuir cores a eles e associar par√¢metros arbitr√°rios de m√≥dulos a codificadores Push, exibindo seus nomes e valores no visor do controlador. </font><font style="vertical-align: inherit;">No v√≠deo abaixo, voc√™ pode ver sua vis√£o geral e, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste v√≠deo, voc√™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ver em a√ß√£o.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OhdxXv6uHF0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo completo est√° dispon√≠vel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conseguimos test√°-lo apenas no Linux (Ubuntu 18.04), no MacOS o monitor n√£o se conectou devido √†s especificidades do libusb e houve atrasos estranhos na interface midi. </font><font style="vertical-align: inherit;">Apesar disso, o VCV Rack deixou uma impress√£o muito boa como estrutura e como DAW modular, espero que o VCV continue a se desenvolver, e este artigo ajude algu√©m a escrever seus pr√≥prios m√≥dulos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491232/index.html">RPA + Machine Learning = Automa√ß√£o Inteligente</a></li>
<li><a href="../pt491234/index.html">Tr√™s truques para trabalhar com o SOLIDWORKS para modelar pe√ßas para impress√£o 3D</a></li>
<li><a href="../pt491236/index.html">Programa√ß√£o ass√≠ncrona no .NET: pr√°ticas recomendadas</a></li>
<li><a href="../pt491238/index.html">An√°lise de C√≥digo Gen√©tico II</a></li>
<li><a href="../pt491240/index.html">O caminho para as nuvens: ontem e hoje Adobe</a></li>
<li><a href="../pt491246/index.html">Confer√™ncia DEFCON 27. Seu carro √© meu carro. Parte 2</a></li>
<li><a href="../pt491250/index.html">L√¢mpadas LED Gauss Basic</a></li>
<li><a href="../pt491252/index.html">5 recursos pouco conhecidos do JSON.stringify ()</a></li>
<li><a href="../pt491256/index.html">Desenvolvimento do m√≥dulo no iMX8 da NXP. Recursos de transfer√™ncia de rastreamento DDR</a></li>
<li><a href="../pt491258/index.html">Meninas de TI, de onde voc√™ √©? Vamos construir um mapa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>