<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍚 ⛩️ 📒 GitLab CI: 6 fonctionnalités des dernières versions que nous attendions 🧘🏻 👨🏿‍🚀 🌦️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À l'ère du CI / CD omniprésent, nous sommes confrontés à une large gamme d'outils connexes, y compris les systèmes CI. Cependant, c'est GitLab qui est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GitLab CI: 6 fonctionnalités des dernières versions que nous attendions</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/491888/"><img src="https://habrastorage.org/webt/gw/s2/_l/gws2_lpk_xse3zwysoxi7yhgedi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'ère du CI / CD omniprésent, nous sommes confrontés à une large gamme d'outils connexes, y compris les systèmes CI. Cependant, c'est GitLab qui est devenu le plus proche pour nous, vraiment «natif». Il a gagné une popularité notable dans l'industrie dans son ensemble *. Les développeurs du produit n'ont pas été à la traîne de l'intérêt croissant pour son utilisation, ravissant régulièrement la communauté des développeurs et des ingénieurs DevOps avec de nouvelles versions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/lp/fl/lelpfl_26qkmpjz5qf5cjq4bbd0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mois du référentiel GitLab et agrégation de balises</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab est le cas lorsque le développement actif apporte de nombreuses fonctionnalités nouvelles et intéressantes. Si pour les utilisateurs potentiels, ce n'est qu'un des facteurs de choix d'un outil, pour les outils existants, la situation est la suivante: si vous n'avez pas mis à jour votre installation GitLab au cours du dernier mois, alors avec une forte probabilité vous avez manqué quelque chose d'intéressant. Y compris les mises à jour de sécurité émergentes régulièrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À propos des plus importants - c.-à-d. demandés par nos ingénieurs et clients DevOps - innovations dans les dernières versions de l'édition communautaire de GitLab, et cet article sera discuté.</font></font><a name="habracut"></a><br>
<br>
<i>*   5  ,  «GitLab»,   : «,   GitHub?».     — ,  Google Trends <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  5-    «gitlab»   .     «»  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.     ,   ,     «»   .</i><br>
<br>
<h2>№1: needs</h2><br>
<ul>
<li>     job'.</li>
<li>    GitLab: 12.2.</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pensée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>dependencies</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- c'est ce dont vous avez besoin? Probablement, nous n'avons pas été les seuls à avoir fait l'erreur d'assigner cette directive ... Il faut lister les jobs précédents, dont les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artefacts</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seront nécessaires. Il s'agit d'artefacts et non de dépendance à l'égard des performances de la tâche précédente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'il se soit produit qu'à un moment donné, il y a des tâches qui ne sont pas nécessaires à exécuter, mais pour une raison quelconque, il n'y a aucune possibilité ou simplement le désir de les faire passer à un stade distinct (la paresse est le moteur du progrès, mais ne vous laissez pas emporter). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/sa/k1/_usak1lrpdqpjtxln69r3ktc5ag.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comme vous pouvez le voir, stage </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contient des boutons permettant de déployer à la fois la production et la phase, ainsi que les </font><i><font style="vertical-align: inherit;">tests Selenium de</font></i><font style="vertical-align: inherit;"> travail</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour une raison quelconque n'est pas exécuté. </font><font style="vertical-align: inherit;">C'est simple: il attend que tous les travaux de l'étape précédente soient terminés avec succès. </font><font style="vertical-align: inherit;">Cependant, dans le cadre du même pipeline, nous n'avons pas besoin de déployer l'étape maintenant pour exécuter les tests (il a été pompé plus tôt, pas dans la balise). </font><font style="vertical-align: inherit;">Que faire? </font><font style="vertical-align: inherit;">Viennent ensuite les secours </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besoins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous listons uniquement les travaux précédents nécessaires pour exécuter nos tests:</font></font><br>
<br>
<pre><code class="plaintext hljs">  needs:<font></font>
    - To production (Cluster 1)<font></font>
    - To production (Cluster 2)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... et nous obtenons un travail, qui est automatiquement appelé après que seuls les travaux répertoriés sont exécutés: de manière </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/9y/8z/jm9y8zesapj3neflq_xmn7er70i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pratique, non? </font><font style="vertical-align: inherit;">Mais une fois que je m'attendais à ce que la directive fonctionne quelque chose comme ça </font></font><code>dependencies</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ° 2: étend</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ancres et alias YAML améliorés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduit depuis GitLab 11.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#extends</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fatigué des rouleaux de lecture </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Vous manquez le principe de réutilisation du code? Ensuite, vous avez déjà essayé et probablement réussi à amener le vôtre </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un état comme celui-ci:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: &amp;base_deploy<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Test:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: test.example.com<font></font>
    name: test<font></font>
<font></font>
Deploy Production:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"<font></font>
    MY_VAR: "10"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Super? Cependant, si vous regardez attentivement, quelque chose attire votre attention ... Pourquoi avons-nous changé de production non seulement </font></font><code>variables.CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais aussi prescrit une deuxième fois </font></font><code>variables.MY_VAR=10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Faut-il prendre cette variable </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Il s'avère que cela ne devrait pas: YAML fonctionne de sorte que, en redéfinissant ce qui est reçu de l'ancre, il </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'élargisse pas le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contenu des champs correspondants, mais le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remplace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par conséquent, nous sommes obligés de lister les variables que nous connaissons déjà dans le paragraphe correspondant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, «se développe» est le bon mot: c'est exactement ce que la fonction en question est appelée. </font></font><code>Extends</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils nous permettent non seulement de réécrire le champ, comme cela se produit avec l'ancre, mais de procéder à une fusion intelligente pour cela:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: <font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Production:<font></font>
  extends: .base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, dans le travail final </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployer la production, il y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aura à la fois une variable </font></font><code>MY_VAR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur par défaut et une valeur remplacée </font></font><code>CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que ce soit une bagatelle, mais imaginez: vous avez un </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et 20 circuits déployés de manière similaire. </font><font style="vertical-align: inherit;">Ils doivent être transmis à d'autres </font></font><code>cluster</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>environment.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout en conservant un certain ensemble de variables ou d'autres champs correspondants ... Cette petite douceur nous a permis de réduire la description du déploiement de nombreux circuits de développement de 2-3 fois.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ° 3: inclure</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous divisons l'énorme YAML en plusieurs et le réutilisons dans d'autres projets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduit dans Core depuis la version 11.4.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#include</font></font></a></li>
</ul><br>
<code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela ressemble toujours </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à une instruction de pliage pour un aspirateur en 20 langues (dont vous ne comprenez que votre langue maternelle). Est-</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce difficile quand vous avez besoin de traiter une de ses sections sans changer face à des travaux inconnus rencontrés sur le chemin? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ami de longue date de la programmation vous aidera à </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">stages:<font></font>
  - test<font></font>
  - build<font></font>
  - deploy<font></font>
<font></font>
variables:<font></font>
  VAR_FOR_ALL: 42<font></font>
<font></font>
include:<font></font>
  - local: .gitlab/ci/test.yml<font></font>
  - local: .gitlab/ci/build.yml<font></font>
  - local: .gitlab/ci/deploy-base.yml<font></font>
  - local: .gitlab/ci/deploy-production.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceux. </font><font style="vertical-align: inherit;">Maintenant, nous modifions hardiment le déploiement en production, tandis que les testeurs sont occupés à modifier leur fichier, que nous ne verrons peut-être même pas. </font><font style="vertical-align: inherit;">De plus, cela permet d'éviter les conflits de fusion: ce n'est pas toujours amusant de comprendre le code de quelqu'un d'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que se passe-t-il si nous connaissons le pipeline de nos 20 projets de part et d'autre, pouvons-nous en expliquer la logique de chaque travail? </font><font style="vertical-align: inherit;">Comment cela nous aidera-t-il? </font><font style="vertical-align: inherit;">Pour ceux qui ont atteint l'illumination dans la réutilisation du code et pour tous ceux qui ont de nombreux projets similaires, vous pouvez:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - inclure les fichiers CI GitLab d'un autre référentiel de la même instance GitLab,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: template</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - collections de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèles GitLab prêts à l'emploi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: remote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un fichier externe (accessible via HTTPS).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une douzaine de projets du même type avec du code différent, mais déployés de la même manière - facilement et sans maintenir à jour CI dans tous les référentiels! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple d'utilisation pratique </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a également été donné dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ° 4: uniquement / sauf refs</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conditions complètes, y compris les variables et les modifications de fichiers.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme il s'agit de toute une famille de fonctions, certaines parties ont commencé à apparaître dans GitLab 10.0, tandis que d'autres (par exemple, </font></font><code>changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ont </font><font style="vertical-align: inherit;">commencé à apparaître dans </font><font style="vertical-align: inherit;">11.4.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#onlyexcept-advanced</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, il me semble que ce n'est pas un pipeline qui nous écoute, mais nous lui. </font><font style="vertical-align: inherit;">Un excellent outil de gestion est </font></font><code>only</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- désormais intégré. </font><font style="vertical-align: inherit;">Qu'est-ce que ça veut dire? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas le plus simple (et peut-être le plus agréable), sauter les étapes:</font></font><br>
<br>
<pre><code class="plaintext hljs">Tests:<font></font>
  only:<font></font>
    - master<font></font>
  except:<font></font>
    refs:<font></font>
    - schedules<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $CI_COMMIT_MESSAGE =~ /skip tests/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple de travail, il s'exécute uniquement sur la branche principale, mais ne peut pas être déclenché par une planification ou un déclencheur (GitLab partage les appels et les déclencheurs d'API, bien qu'il s'agisse essentiellement de la même API). </font><font style="vertical-align: inherit;">Le travail ne sera pas exécuté s'il y a une phrase secrète de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saut de tests</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le message de validation </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par exemple, une faute de frappe dans le </font></font><code>README.md</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet ou la documentation a </font><font style="vertical-align: inherit;">été corrigée </font><font style="vertical-align: inherit;">- pourquoi attendre les résultats du test? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Hé, 2020 est dehors!" </font><font style="vertical-align: inherit;">Pourquoi devrais-je expliquer à chaque fois à la boîte de fer qu'il n'est pas nécessaire d'exécuter des tests lors du changement de la documentation? » </font><font style="vertical-align: inherit;">Et vraiment: </font></font><code>only:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il vous permet d'exécuter des tests lors de la modification de fichiers uniquement dans certains répertoires. </font><font style="vertical-align: inherit;">Par exemple:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
      - master<font></font>
      - merge_requests<font></font>
    changes:<font></font>
      - "front/**/*"<font></font>
      - "jest.config.js"<font></font>
      - "package.json"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour l'action inverse - i.e. </font><font style="vertical-align: inherit;">ne courez pas - oui </font></font><code>except:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ° 5: règles</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Règles de travail individuelles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduit dans GitLab 12.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#rules</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette directive est très similaire aux précédentes </font></font><code>only:*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais avec une différence importante: elle vous permet de contrôler le paramètre </font></font><code>when</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par exemple, si vous ne souhaitez pas supprimer complètement la possibilité de démarrer un travail. </font><font style="vertical-align: inherit;">Vous pouvez simplement laisser le bouton qui, si vous le souhaitez, sera appelé indépendamment, sans lancer de nouveau pipeline ou sans faire de commit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: environnement: auto_stop_in</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arrêtez les environnements en l'absence d'activité.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduit dans GitLab 12.8.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#environmentauto_stop_in</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons eu connaissance de cette opportunité juste avant la publication de l'article et n'avons pas encore eu suffisamment de temps pour le tester dans la pratique, mais c'est certainement «la même chose» qui était si attendue dans plusieurs projets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez spécifier un paramètre dans les environnements GitLab </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- il est très utile lorsque vous souhaitez créer et supprimer des environnements dynamiquement, par exemple, pour chaque branche. Le travail marqué par k </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est exécuté, par exemple, lorsque la fusion du MR est dans la branche principale ou lorsque le MR est fermé (ou même simplement en cliquant sur le bouton), grâce à quoi l'environnement inutile est automatiquement supprimé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est pratique, logique, fonctionne ... sinon pour le facteur humain. De nombreux développeurs fusionnent les MR non pas en cliquant sur un bouton dans GitLab, mais localement via </font></font><code>git merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Vous pouvez les comprendre: c'est pratique! Mais dans ce cas, la logique</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela ne fonctionne pas, nous avons accumulé un environnement oublié ... C'est là que les tant attendus sont utiles </font></font><code>auto_stop_in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: cabanes temporaires quand il n'y a pas assez d'opportunités</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré toutes ces fonctions (et bien d'autres) nouvelles et demandées de GitLab, malheureusement, les conditions pour remplir un travail sont parfois impossibles à décrire en termes de capacités actuellement disponibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab n'est pas parfait, mais il fournit les outils de base pour construire un pipeline de rêve ... si vous êtes prêt à aller au-delà de la modeste DSL en plongeant dans le monde des scripts. </font><font style="vertical-align: inherit;">Voici quelques solutions de notre expérience, qui ne prétendent en aucun cas être idéologiquement correctes ou recommandées, mais sont présentées davantage pour démontrer différentes possibilités avec un manque de fonctionnalité API intégrée.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution de contournement n ° 1: lancez deux tâches avec un seul bouton</font></font></h3><br>
<pre><code class="plaintext hljs">script:<font></font>
  - &gt; <font></font>
    export CI_PROD_CL1_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 1)")][0] | .id'`<font></font>
  - &gt; <font></font>
    export CI_PROD_CL2_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 2)")][0] | .id'`<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL1_JOB_ID/play"<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL2_JOB_ID/play"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pourquoi pas, si vous en avez vraiment envie?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution n ° 2: transfert modifié dans les fichiers MR MR pour rubocop à l'intérieur de l'image</font></font></h3><br>
<pre><code class="plaintext hljs">Rubocop:<font></font>
  stage: test<font></font>
  allow_failure: false<font></font>
  script:<font></font>
    ...<font></font>
    - export VARFILE=$(mktemp)<font></font>
    - export MASTERCOMMIT=$(git merge-base origin/master HEAD)<font></font>
    - echo -ne 'CHANGED_FILES=' &gt; ${VARFILE}<font></font>
    - if [ $(git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' | wc -w |awk '{print $1}') -gt 0 ]; then<font></font>
        git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' |tr '\n' ' ' &gt;&gt; ${VARFILE} ;<font></font>
      fi<font></font>
    - if [ $(wc -w ${VARFILE} | awk '{print $1}') -gt 1 ]; then<font></font>
        werf --stages-storage :local run rails-dev --docker-options="--rm --user app --env-file=${VARFILE}" -- bash -c /scripts/rubocop.sh ;<font></font>
      fi<font></font>
    - rm ${VARFILE}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas d'image à l'intérieur </font></font><code>.git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, j'ai donc dû sortir pour vérifier uniquement les fichiers modifiés. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque: Ce n'est pas une situation très standard et une tentative désespérée de se conformer à de nombreuses conditions du problème, dont la description n'est pas incluse dans la portée de cet article.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution de contournement n ° 3: déclencheur pour démarrer des travaux à partir d'autres référentiels lors du déploiement</font></font></h3><br>
<pre><code class="plaintext hljs">  before_script:<font></font>
    - |<font></font>
      echo '### Trigger review: infra'<font></font>
      curl -s -X POST \<font></font>
        -F "token=$REVIEW_TOKEN_INFRA" \<font></font>
        -F "ref=master" \<font></font>
        -F "variables[REVIEW_NS]=$CI_ENVIRONMENT_SLUG" \<font></font>
        -F "variables[ACTION]=auto_review_start" \<font></font>
        https://gitlab.example.com/api/v4/projects/${INFRA_PROJECT_ID}/trigger/pipeline</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait qu'une chose aussi simple et nécessaire (dans le monde des microservices) déploie un autre microservice dans un circuit fraîchement créé en tant que dépendance. </font><font style="vertical-align: inherit;">Mais ce n'est donc pas un appel d'API et une fonctionnalité déjà familière (décrite ci-dessus) est requise:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $ACTION == "auto_review_start"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarques:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Job on trigger est conçu pour être lié à la transmission d'une variable à l'API, de manière similaire à l'exemple n ° 1. </font><font style="vertical-align: inherit;">Il est plus logique de l'implémenter sur l'API avec le nom de travail transmis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Oui, la fonction est dans la version commerciale (EE) de GitLab, mais nous ne la considérons pas.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab essaie de suivre les tendances, implémentant progressivement des fonctionnalités agréables et demandées par la communauté DevOps. </font><font style="vertical-align: inherit;">Ils sont assez faciles à utiliser et lorsque les capacités de base ne sont pas suffisantes, ils peuvent toujours être étendus avec des scripts. </font><font style="vertical-align: inherit;">Et si nous voyons que cela ne s'avère pas si élégant et pratique à l'appui ... il reste à attendre les nouvelles versions de GitLab - ou à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aider le projet avec notre contribution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblage et déploiement du même type de microservices avec werf et GitLab CI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JUnit dans GitLab CI avec Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">werf —    CI/CD  Kubernetes (   )</a>» <i>( ; 27  2019  DevOpsConf)</i>;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">       GitLab CI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab CI       production</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491876/index.html">MosQA # 2 - matériaux de mitap et recherche de tous les drapeaux de la quête</a></li>
<li><a href="../fr491880/index.html">5 étapes d'inévitabilité de l'adoption de la certification ISO / IEC 27001. Colère</a></li>
<li><a href="../fr491882/index.html">Automatisez l'entrée dans SecureCRT à l'aide de scripts</a></li>
<li><a href="../fr491884/index.html">Gestion globale des connaissances dans une entreprise informatique</a></li>
<li><a href="../fr491886/index.html">KnowledgeConf 2020 Online: mise en œuvre d'une gestion des connaissances étape par étape</a></li>
<li><a href="../fr491890/index.html">Drive Anatomy: SSD</a></li>
<li><a href="../fr491896/index.html">Comment nous, Cyan, améliorons un produit grâce à la recherche sur l'expérience utilisateur</a></li>
<li><a href="../fr491900/index.html">Flexibilité et automatisation dans l'apprentissage automatique</a></li>
<li><a href="../fr491902/index.html">Écrire un simple éditeur WYSIWYG avec ProseMirror</a></li>
<li><a href="../fr491904/index.html">Comment écrire du code Python sûr. Repas Kushal Das</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>