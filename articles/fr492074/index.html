<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👩🏻 👨🏿‍🎓 👨🏿‍🍳 Faut que vous y allez rapidement. Synchronisation rapide des e-mails IMAP 👲🏻 👩🏿‍🤝‍👨🏾 🤸🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Je m'appelle Ilya. Il y a deux ans, j'ai rejoint le client mobile IMAP. Les versions antérieures de l'application téléchargeaient longtemps la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Faut que vous y allez rapidement. Synchronisation rapide des e-mails IMAP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! Je m'appelle Ilya. Il y a deux ans, j'ai rejoint le client mobile IMAP. Les versions antérieures de l'application téléchargeaient longtemps la liste des lettres et dépensaient beaucoup de trafic pour mettre à jour la boîte aux lettres. La question s'est posée de l'optimisation du travail avec le protocole et des capacités de ce protocole en général. Je ne savais rien du protocole et je me suis plongé dans la lecture de la documentation. Il s'avère que pendant tout ce temps le client a utilisé le protocole sans interruption et n'a pas du tout pris en compte les fonctionnalités d'implémentation. Ces fonctionnalités ont permis d'accélérer le téléchargement des e-mails de 2 à 3 fois. A propos de ce qu'est IMAP et quelles sont les puces pour l'optimiser plus tard dans mon article.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne plongerai pas trop profondément dans le protocole. </font><font style="vertical-align: inherit;">Un article plutôt de la catégorie «Je voudrais lire cet article il y a deux ans». </font><font style="vertical-align: inherit;">Il est peu probable que les gourous IMAP trouvent de nouvelles informations par eux-mêmes. </font><font style="vertical-align: inherit;">Cet article s'appuie sur la description du protocole de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connexion au serveur</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP est un protocole avec état. </font><font style="vertical-align: inherit;">Ce fut une découverte pour moi, avant que je n'avais pas vu ou travaillé avec de tels protocoles. </font><font style="vertical-align: inherit;">Considérez le schéma de travail avec le serveur.&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allons dans l'ordre, et surtout, avec des exemples. </font><font style="vertical-align: inherit;">Vous devez d'abord créer une connexion au serveur. </font><font style="vertical-align: inherit;">Pour ce faire, utilisez la bibliothèque openSSL.</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Très bien, la connexion est établie et vous pouvez observer la réponse OK avec une ligne qui commence par la réponse CAPABILITY</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">feuille de triche</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pratique </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">pour</font></a><font style="vertical-align: inherit;"> chacun des CAPABILITY </font><font style="vertical-align: inherit;">, où toutes les valeurs de CAPABILITY possibles sont écrites avec des liens vers le RFC. </font><font style="vertical-align: inherit;">Par exemple, IMAP4rev1 indique au client que le serveur fonctionne conformément à la norme IMAP4 et IDLE signale que vous pouvez vous abonner aux modifications qui se produisent dans la boîte aux lettres.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autorisation du serveur</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après vous être connecté au serveur, vous devez vous rendre dans votre boîte aux lettres. </font><font style="vertical-align: inherit;">Cela se fait à l'aide de la commande LOGIN.</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors, arrêtez, connectez-vous, je comprends, et a1 qu'est-ce que c'est? </font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Peut </font><i><font style="vertical-align: inherit;">-</font></i><font style="vertical-align: inherit;"> être demandez-vous. </font><font style="vertical-align: inherit;">Et c'est le tag d'équipe. </font><font style="vertical-align: inherit;">Dans l'intérêt du client, les balises doivent être différentes, car la réponse arrive avec la même balise que la demande, ce qui signifie qu'elle peut être mise en correspondance pour l'analyse entre les équipes. </font><font style="vertical-align: inherit;">Le serveur peut également renvoyer une réponse avec un astérisque au début, comme * OK, cela s'appelle une réponse non balisée. </font><font style="vertical-align: inherit;">Fondamentalement, une telle réponse est renvoyée pour les équipes qui attendent plusieurs entités dans la réponse, par exemple, LIST.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande de liste de dossiers</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour demander une liste de lettres dans un dossier, vous devez d'abord trouver ces dossiers. </font><font style="vertical-align: inherit;">Cela se fait par la commande LIST. </font><font style="vertical-align: inherit;">Cette commande renvoie une liste de dossiers sur le serveur.</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST «» *<font></font>
* LIST (\HasNoChildren \Trash) «/» Trash<font></font>
* LIST (\HasNoChildren \Sent) «/» Sent<font></font>
* LIST (\HasNoChildren \Drafts) «/» Drafts<font></font>
* LIST (\HasNoChildren \Junk) «/» Junk<font></font>
* LIST (\HasNoChildren) «/» INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier paramètre de la commande est l'espace de noms. Si le serveur prend en charge l'espace de noms, ses valeurs peuvent être demandées à l'aide de la requête NAMESPACE. L'espace de noms standard ressemble à une chaîne vide. Ensuite, le paramètre des caractères génériques entre en jeu. Avec lui, nous pouvons dire au serveur quels dossiers nous devons retourner. Par exemple, nous pouvons obtenir: une branche d'arborescence de dossiers, uniquement des racines, ou tout simplement, comme dans l'exemple ci-dessus. Il vaut mieux ne pas le faire, car qui sait combien de dossiers l’utilisateur a dans la boîte. Les auteurs du protocole recommandent d'utiliser «%» - dans ce cas, vous obtiendrez tous les dossiers de niveau supérieur de la boîte aux lettres.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après la réponse, nous comprenons qu'il s'agit d'une réponse non balisée où chaque ligne est votre dossier dans la zone. </font><font style="vertical-align: inherit;">Tout d'abord, il existe des indicateurs par lesquels nous lisons les méta-informations du dossier, par exemple, dans l'exemple, tous les dossiers n'ont pas de descendants et certains dossiers à usage spécial (tels que la corbeille, le courrier indésirable, etc.). </font><font style="vertical-align: inherit;">Vient ensuite le caractère séparateur de dossier. </font><font style="vertical-align: inherit;">Ce symbole est utilisé pour les sous-dossiers. </font><font style="vertical-align: inherit;">Par exemple, pour un descendant du dossier Corbeille, le nom ressemblerait à «Corbeille / Nouveau dossier». </font><font style="vertical-align: inherit;">Après tous les dossiers, le serveur nous renverra OK avec la balise que nous avons affectée à la commande et le temps d'exécution de cette commande.&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sélection de dossier</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, selon le schéma, nous devons sélectionner un dossier à partir duquel nous resserrerons nos messages. </font><font style="vertical-align: inherit;">Cela se fait à l'aide de la commande SELECT.</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous sélectionnez un dossier, toutes les informations le concernant sont renvoyées. </font><font style="vertical-align: inherit;">Allons dans l'ordre.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Répondez avec des drapeaux autorisés dans le dossier pour les lettres.&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Répondez avec des indicateurs que le client peut changer pour toujours</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Répondre avec le nombre de lettres dans le dossier</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La réponse est avec le nombre de lettres récentes, c'est-à-dire celles que nous avons reçues entre les sélections de dossiers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Répondre avec le nombre de messages non lus</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, pour l'instant, nous allons nous attarder sur cela. </font><font style="vertical-align: inherit;">Le reste des informations dont nous n'avons pas besoin.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demander des lettres</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la chose la plus intéressante est la demande de lettres. </font><font style="vertical-align: inherit;">Vous devez être extrêmement prudent ici, en particulier sur les clients mobiles. </font><font style="vertical-align: inherit;">D'accord, il est peu probable que lorsque vous entrez dans l'application, vous recevrez des milliers de messages du serveur vers votre base de données. </font><font style="vertical-align: inherit;">De plus, cela n'a aucun sens de télécharger la lettre entière, car il peut ne pas être pratique d'afficher, par exemple, une liste de toutes les lettres. </font><font style="vertical-align: inherit;">Par exemple, pour afficher rapidement les lettres des utilisateurs, nous ne demanderons qu'une "enveloppe". </font><font style="vertical-align: inherit;">Dans cette enveloppe, nous voulons voir: l'expéditeur, le destinataire, l'objet de la lettre et la date d'envoi. </font><font style="vertical-align: inherit;">Nous chargerons les 10 premiers messages.</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deux-points énumère le segment du nombre de lettres que nous voulons recevoir et entre parenthèses ce que nous voulons lire de ces lettres, dans ce cas l'enveloppe de la lettre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je donnerai la réponse sous forme abrégée:</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est clair que rien n'est clair. </font><font style="vertical-align: inherit;">Et le fait est que le format d'enveloppe est dicté par la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 2822.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Je ne le considérerai pas dans cet article. </font><font style="vertical-align: inherit;">Cette enveloppe contient toutes les informations nécessaires: date de réception de la lettre, objet de la lettre, expéditeur, destinataire et même messageId. </font><font style="vertical-align: inherit;">Ses clients utilisent pour afficher une conversation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc pu montrer à l'utilisateur des informations de base sur la lettre, mais qu'en est-il du corps? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut télécharger immédiatement tout le corps de la lettre, quelle que soit sa taille, ce n'est bien sûr pas pour longtemps mais néanmoins coûteux sur le réseau et la mémoire. </font><font style="vertical-align: inherit;">Soit dit en passant, cela se fait avec la même commande FETCH.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayez une telle commande dans votre boîte de réception, et vous comprendrez ce que j'entendais par «coûteux», même avec 10 messages, nous obtenons une réponse assez volumineuse avec absolument toutes les informations sur la lettre. En parlant d'elle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À quelle fréquence avez-vous téléchargé la source de la lettre chez un client que vous connaissez pour voir à quoi elle ressemble dans sa forme originale? Sinon, tirons-en une lettre de test. Dans ce document, j'ai ajouté une photo directement à la lettre et une photo en pièce jointe. Enregistrez-le au format eml, puis ouvrez-le avec n'importe quel éditeur de texte. Selon le client, vous recevrez différentes sources de la lettre, mais en général elles seront similaires.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par l'en-tête de l'e-mail:</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=»--=_Part_722_554093397.1567975288»<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les méta-informations sont décrites dans l'en-tête de la lettre, de qui, à qui, quand, type de contenu du message, sujet et priorité de la lettre. </font><font style="vertical-align: inherit;">Le champ limite indique la limite de la lettre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprenez mieux ce que cela signifie.</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=»--=_Part_583_946112260.1567975288»<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=»--=_Part_881_599167713.1567975288»<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D«font-family: XO Tahion; font-size: 16px; direction: ltr»&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=«2018-09-04 22.46.36.jpg»<font></font>
Content-Disposition: inline; filename=«2018-09-04 22.46.36.jpg»<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque frontière est la frontière habituelle d'un écrit. </font><font style="vertical-align: inherit;">Ils commencent par deux tirets "-". </font><font style="vertical-align: inherit;">La bordure de fermeture comporte ces deux tirets à la fin. </font><font style="vertical-align: inherit;">Il est décrit plus en détail dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 1341.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cela peut être appelé la partie principale de la lettre, des parties de la lettre et leurs types MIME sont décrits ici.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos des types MIME</font></font></b><div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un type MIME est un type de support qui a été décrit dans MIME ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multipurpose Internet Mail Extensions)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour décrire les types de contenu à l'intérieur d'un message électronique.&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multipart / mixed nous indique que la lettre a une structure mixte, c'est-à-dire que différentes parties des lettres peuvent être différentes représentations de telle ou telle information.&nbsp;</font></font></li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas de texte simple ici, il est donc plus logique de prendre une représentation html. Dans cette présentation html, il y a juste une image avec le paramètre Content-Disposition: inline, c'est-à-dire qu'il est situé directement dans le corps de la lettre, et non dans les documents joints. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le lien vers cette image n'est pas assez simple. Il est décrit par le paramètre Content-ID, qui est égal à </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ceci est un lien vers la partie suivante de la lettre - une image encodée en base 64. Pour sauver mes nerfs, je n'ai pas inclus tout le code base 64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière partie de la lettre a la forme&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Disposition: attachment; filename=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
qui a déjà Content-Disposition non pas en ligne, comme l'image ci-dessus, mais une pièce jointe. </font><font style="vertical-align: inherit;">Cette image devrait simplement aller dans le panneau de pièce jointe, soit dit en passant, elle est également encodée en base-64 et a une grande taille. </font><font style="vertical-align: inherit;">Ici, il devient clair que vous ne devez pas charger à nouveau le corps entier de la lettre si nous voulons afficher uniquement des informations de base.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retour au protocole</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir travaillé sur les lettres, vous devez fermer le dossier sélectionné et dire au revoir au serveur. </font><font style="vertical-align: inherit;">Pour fermer le dossier, nous devons entrer la commande FERMER. </font><font style="vertical-align: inherit;">Oui, c'est si simple</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, si vous avez travaillé avec la console en parallèle avec moi et lu l'article, un événement pas si agréable aurait pu se produire, le serveur pourrait fermer votre connexion par timeout. </font><font style="vertical-align: inherit;">C'est tout à fait normal, et chaque serveur a son propre délai d'expiration, par exemple, nous avons 30 minutes.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, il est recommandé de faire la commande NOOP en arrière-plan</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne fait littéralement rien, mais vous permet de conserver la connexion sans délai autant que nous en avons besoin. </font><font style="vertical-align: inherit;">Si vous sélectionnez actuellement un dossier, NOOP peut fonctionner comme une demande périodique de modifications de ce dossier&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, dans la réponse, nous sommes informés de deux messages supprimés, un nouveau et que le nombre de messages dans ce dossier est de 16 472. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note également que vous ne pouvez travailler qu'avec un seul dossier sélectionné, il n'y a pas de travail parallèle ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, à la fin, fermez la session avec le serveur et nous lui dirons au revoir.</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons la triste réponse BYE sans étiquette, ce qui signifie qu'il est temps de terminer le travail.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronisation rapide avec CONDSOTORE et QRESYNC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez utiliser l'opération NOOP pour suivre les modifications dans une zone d'un dossier sélectionné. Mais que faire si nous voulons découvrir ce qui a changé dans le dossier pendant que nous travaillions avec un autre? L'option la plus évidente consiste à trier toutes les lettres du stockage local, qu'il s'agisse d'un cache ou d'une base de données, et de comparer avec ce que le serveur renverra. D'une part, c'est en effet une solution, et sur certains serveurs, ce sera littéralement la seule vraie. D'un autre côté, nous voulons afficher les lettres aussi rapidement que le protocole le permet généralement. Heureusement, notre serveur prend en charge les extensions de protocole telles que CONDSTORE et QRESYNC, qui ont été ajoutées à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le premier ajoute un numéro spécial de 63 bits au message et au dossier, appelé la séquence mod, qui augmente avec chaque opération sur cette lettre. La séquence de modules la plus élevée parmi tous les messages est ajoutée au dossier. Par conséquent, chaque fois que vous vous connectez à un dossier sur un serveur qui prend en charge CONDSTORE, nous pouvons facilement savoir si quelque chose a changé ou non, simplement en comparant les valeurs de séquence de mod pour les dossiers local et serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, cette extension ajoute des paramètres supplémentaires pour les commandes STORE et FETCH - CHANGEDSINCE mod-sequence et UNCHANGEDSINCE mod-sequence, qui vous permettent d'effectuer une opération si la séquence de modules des messages transmis est respectivement plus grande et plus petite que celle-ci. Regardons un exemple.</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai simulé une situation dans laquelle nous allons dans la boîte aux lettres et je n'en savais rien auparavant, c'est-à-dire que notre séquence de mod locale est 0. Comme vous pouvez le voir, le serveur nous renvoie généralement tous les messages qui se trouvent dans la boîte aux lettres, car avant cela, nous ne recevions rien et je ne sais rien de la boîte. En réponse à une demande de lettres UID de CHANGEDSINCE, une réponse OK non étiquetée est également accompagnée d'un HIGHESTMODESEQ que nous allons maintenant enregistrer, et pour chaque message notre MODSEQ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons </font><font style="vertical-align: inherit;">effectuer </font><font style="vertical-align: inherit;">certaines opérations avec la boîte aux lettres: ajouter de nouvelles lettres, changer les drapeaux. Faisons une nouvelle demande mais avec la séquence de mod précédente</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et nous voyons déjà la différence, au lieu de sortir 20 anciennes et nouvelles communautés qui viennent d'arriver (astérisque en 17221: * signifie prendre les lettres du numéro 17221 au maximum possible) nous recevons des lettres dont le MODSEQ est supérieur au précédent. Cela aide assez bien à synchroniser un dossier dans lequel nous ne sommes pas depuis un certain temps et à obtenir une sorte de distribution des lettres modifiées, au lieu d'essayer toutes les lettres possibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait, beaucoup mieux? Mais QRESYNC rend l'opération de synchronisation encore plus rapide, il vous permet de spécifier les paramètres MODSEQ et les UID de message que nous connaissons lors de la sélection du dossier. Expliquons avec un exemple. D'abord, QRESYNC doit être activé avec la commande ENABLE.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puisque nous ne savions rien sur le dossier avant cela, le serveur ne nous renvoie que des informations sur le dossier, sans une pépite de ses modifications. Supposons que nous ayons demandé les vingt premiers messages et que nous nous souvenions de leur UID et de HIGHESTMODESEQ. Nous quittons le dossier, nous envoyons un message, supprimons le message, modifions les indicateurs et revenons avec les informations passées sur le dossier</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, lorsque nous choisissons un dossier modifié, nous obtenons immédiatement une pépite de modifications, sous la forme d'une réponse VANISHED (EARLIER) pour les messages qui ont été supprimés et FETCH pour les messages qui ont été ajoutés ou modifiés. Il est maintenant encore plus facile de synchroniser le dossier si l'utilisateur ne l'a pas visité depuis longtemps. C'est un moyen très cool si vous avez un tas de messages stockés localement dans le cache et que vous ne voulez pas les comparer avec des messages sur le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier paramètre de cette demande est UIDVALIDITY, qui est essentiellement utilisé pour vérifier que l'uid que vous avez reçu précédemment n'a pas changé dans le dossier. Cela peut se produire si le serveur modifie l'ID de session de session en session pour tous les messages ou si le dossier a été supprimé et qu'un dossier du même nom a été créé à sa place.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxième paramètre est le HIGHESTMODSEQ que nous connaissons et le dernier est l'intervalle des UID connus, ils peuvent être écrits comme deux points, si l'intervalle est continu, ou séparés par une virgule.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon exemple, je suis tombé sur une situation où l'ignorance du domaine conduit à un fonctionnement incorrect et sous-optimal de l'application. </font><font style="vertical-align: inherit;">Je n'ai pas couvert toutes les options possibles pour l'utilisation du protocole avec cet article. </font><font style="vertical-align: inherit;">Mais j'espère que pour le prochain développeur du client IMAP, les informations ci-dessus seront utiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP a une tonne de choses intéressantes. </font><font style="vertical-align: inherit;">Les commandes de synchronisation rapide ne sont qu'un début, en fait, vous pouvez optimiser davantage différentes commandes IMAP, en fonction des capacités du serveur, et rendre le travail avec le courrier plus rapide, plus économique sur le réseau et la mémoire, et généralement plus agréable. </font><font style="vertical-align: inherit;">Mais j'en parlerai plus tard.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492058/index.html">ROS2 vs ROS1. Installation de ROS2 sur Ubuntu 18.04</a></li>
<li><a href="../fr492060/index.html">Comment résoudre? "ECONNREFUSED - connexion refusée par le serveur"</a></li>
<li><a href="../fr492062/index.html">Modèle de serveur d'arrière-plan Golang - partie 1 (serveur HTTP)</a></li>
<li><a href="../fr492066/index.html">Pourquoi Event Sourcing est l'anti-modèle pour l'interaction des microservices</a></li>
<li><a href="../fr492068/index.html">S7 Group ouvre un département «Technologies de l'information dans l'aviation» au MIPT</a></li>
<li><a href="../fr492076/index.html">Un exemple d'architecture hexagonale en Java</a></li>
<li><a href="../fr492078/index.html">Les matériaux les plus importants et utiles sur le coronavirus COVID-19</a></li>
<li><a href="../fr492082/index.html">Comment simplifier la gestion des appareils domestiques et les sécuriser (partager des idées sur Kauri Safe Smart Home)</a></li>
<li><a href="../fr492086/index.html">Coronavirus vs informatique russe: les entreprises sont-elles prêtes à transférer leurs employés vers un site distant?</a></li>
<li><a href="../fr492088/index.html">Test du moteur de jeu Amazon Lumberyard. Approches et outils</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>