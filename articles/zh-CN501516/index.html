<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‡ ğŸ§ ğŸ›µ è®©æˆ‘ä»¬å…³é—­çœŸç©ºå—ï¼Ÿé˜¿åˆ—å…‹è°¢Â·åˆ—ç´¢å¤«æ–¯åŸº ğŸ™‹ğŸ½ ğŸ£ ğŸ’¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é˜¿åˆ—å…‹è°¢Â·åˆ—ç´¢å¤«æ–¯åŸºï¼ˆAlexei Lesovskyï¼‰2018å¹´æŠ¥å‘Šçš„è§£ç â€œè®©æˆ‘ä»¬å…³é—­çœŸç©ºå—ï¼Ÿï¼â€
 

ç¼–è€…æ³¨ï¼šæœ‰å…³æ›´æ”¹å‚æ•°çš„ä»»ä½•å»ºè®®åº”å§‹ç»ˆåœ¨å…¶ä»–æŠ¥å‘Šä¸­è¿›è¡Œæ¯”è¾ƒã€‚
 

å½“PostgreSQLä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°è¿™æ ·çš„è°ƒç”¨ï¼Œè€Œä¸»è¦çš„æ€€ç–‘æ˜¯ vacuumï¼ˆä»¥ä¸‹ç®€ç§°â€œçœŸç©ºâ€ï¼‰ã€‚æ ¹æ®ç»éªŒï¼Œè®¸å¤šäººæ­£åœ¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>è®©æˆ‘ä»¬å…³é—­çœŸç©ºå—ï¼Ÿé˜¿åˆ—å…‹è°¢Â·åˆ—ç´¢å¤«æ–¯åŸº</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501516/"><h4 id="rasshifrovka-doklada-2018-goda--alekseya-lesovskogo-davayte-otklyuchim-vacuum"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é˜¿åˆ—å…‹è°¢Â·åˆ—ç´¢å¤«æ–¯åŸºï¼ˆAlexei Lesovskyï¼‰2018å¹´æŠ¥å‘Šçš„è§£ç â€œè®©æˆ‘ä»¬å…³é—­çœŸç©ºå—ï¼Ÿï¼â€</font></font></h4><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼–è€…æ³¨ï¼šæœ‰å…³æ›´æ”¹å‚æ•°çš„ä»»ä½•å»ºè®®åº”å§‹ç»ˆåœ¨å…¶ä»–æŠ¥å‘Šä¸­è¿›è¡Œæ¯”è¾ƒã€‚</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“PostgreSQLä¸­å‡ºç°é—®é¢˜æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°è¿™æ ·çš„è°ƒç”¨ï¼Œè€Œä¸»è¦çš„æ€€ç–‘æ˜¯ </font></font><code>vacuum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆä»¥ä¸‹ç®€ç§°â€œçœŸç©ºâ€ï¼‰ã€‚æ ¹æ®ç»éªŒï¼Œè®¸å¤šäººæ­£åœ¨è¸©è¿™ç§è€™ï¼Œæˆ‘å’Œæˆ‘çš„Data EgretåŒäº‹ç»å¸¸ä¸å¾—ä¸å¯¹åæœè¿›è¡Œè€™ï¼Œå› ä¸ºé‚£æ ·ä¼šä½¿ä¸€åˆ‡å˜å¾—æ›´ç³Ÿã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ³¨æ„çœŸç©ºæœ¬èº«ï¼Œé‚£ä¹ˆä¹Ÿè®¸æ²¡æœ‰äººä¼šä½¿ç”¨Postgresï¼Œä½†ä¸æ­¤åŒæ—¶å¯¹ä»–ä¸€æ— æ‰€çŸ¥ã€‚æ¯•ç«Ÿï¼ŒçœŸç©ºçš„å†å²æ˜¯åœ¨å¾ˆä¹…ä»¥å‰å¼€å§‹çš„ï¼Œåœ¨Internetä¸Šï¼Œæ‚¨å¯ä»¥åœ¨é‚®ä»¶åˆ—è¡¨ä¸Šæ‰¾åˆ°è®¸å¤šæœ‰å…³çœŸç©ºçš„æ–°æ—§å¸–å­ï¼Œå…¶ä¸­åŒ…æ‹¬å†—é•¿çš„è®¨è®ºã€‚å°½ç®¡æœ‰å…³çœŸç©ºçš„ä¸»é¢˜åœ¨PostgreSQLçš„å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¯¦ç»†æè¿°ï¼Œä½†æ–°çš„å¸–å­å’Œæ–°çš„è®¨è®ºå°†ç»§ç»­å‡ºç°ã€‚ä¹Ÿè®¸è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè®¸å¤šç¥è¯ï¼Œæ•…äº‹ï¼Œææ€–æ•…äº‹å’Œè¯¯è§£ä¸çœŸç©ºæœ‰å…³çš„åŸå› ã€‚åŒæ—¶ï¼ŒçœŸç©ºæ˜¯PostgreSQLæœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ï¼Œä»–çš„å·¥ä½œç›´æ¥å½±å“äº†ç”Ÿäº§åŠ›ã€‚ä¸å¯èƒ½åœ¨ä¸€ä¸ªæŠ¥å‘Šä¸­ç»å¯¹åœ°è¯´æ˜æœ‰å…³çœŸç©ºçš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘æƒ³æ­ç¤ºä¸çœŸç©ºæœ‰å…³çš„å…³é”®ç‚¹ï¼Œä¾‹å¦‚çœŸç©ºçš„å†…éƒ¨ç»“æ„ï¼Œè°ƒä¼˜çš„ä¸»è¦æ–¹æ³•ï¼Œç›‘è§†æ€§èƒ½ï¼Œç›‘è§†ä»¥åŠä»¥çœŸç©ºä¸ºä¸»è¦å†…å®¹æ—¶è¯¥æ€ä¹ˆåšã€‚æ€€ç–‘æ‰€æœ‰éº»çƒ¦ã€‚å¥½å§ï¼Œå½“ç„¶ï¼Œæˆ‘æƒ³æ¶ˆé™¤ä¸çœŸç©ºç›¸å…³çš„å¸¸è§ç¥è¯å’Œè¯¯è§£ã€‚æˆ‘æƒ³æ¶ˆé™¤ä¸çœŸç©ºç›¸å…³çš„å¸¸è§ç¥è¯å’Œè¯¯è§£ã€‚æˆ‘æƒ³æ¶ˆé™¤ä¸çœŸç©ºç›¸å…³çš„å¸¸è§ç¥è¯å’Œè¯¯è§£ã€‚</font></font></p><br>
<p><img src="https://habrastorage.org/webt/fx/sv/3m/fxsv3mqxulmnu4rdh_eipwrvvdm.png"></p><a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/eaqnn67RYfU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p> !   .      :  ,      . ,           .   ,   .  ,       - ,    .</p><br>
<p><img src="https://habrastorage.org/webt/k0/q0/k_/k0q0k_kbdrqxy8aamojouthl0xe.png"></p><br>
<p>   ,     ,      ,       .  ,     .  ,        ,    ,      .</p><br>
<p><img src="https://habrastorage.org/webt/0v/nw/uv/0vnwuvq_xpyl4z2f32zfkyragsg.png"></p><br>
<p> ,     ,   ?</p><br>
<p><img src="https://habrastorage.org/webt/3w/rp/kp/3wrpkpqbjqzuz6k3q8h_s3rzafy.png"></p><br>
<p>               : Â«    ,  .  - . , Â». </p><br>
<p>  ?  ,     .   ,      ,   ,  â€“ 100 % (  ).  ,    .     - . </p><br>
<p><img src="https://habrastorage.org/webt/r0/bi/6q/r0bi6qtbpbdhpmh95itmamo5fny.png"></p><br>
<p>  ,     .  postgresâ€™ . ,   . ,     .  ,        .    .     - . </p><br>
<p><img src="https://habrastorage.org/webt/ki/zn/id/kiznid6nupp9ofsryuotcz9olsk.png"></p><br>
<p>   ,     .  -       ,    ,   , . .     . </p><br>
<p><img src="https://habrastorage.org/webt/7h/2u/3n/7h2u3nqb8mz019qfgwskfv3_23c.png"></p><br>
<p> -   / : Â« ,     Â».   ,       .     -  .</p><br>
<p><img src="https://habrastorage.org/webt/en/tn/lj/entnljkothqilsmlubxaxjmglsa.png"></p><br>
<p>     ,  , ,  <code>iotop</code>  ,       .   - .     .               .</p><br>
<p>     .                    .  ,     .</p><br>
<p><img src="https://habrastorage.org/webt/5p/uh/zo/5puhzov2cqvzyprnnt2qpprrnme.png"></p><br>
<p>    ?    , -   .   .   .   . </p><br>
<p><img src="https://habrastorage.org/webt/jg/vf/g3/jgvfg34k-xk3l2xryqvjukmixd4.png"></p><br>
<p>  -  - : Â«  .       â€“ <code>autovacuum</code>.          Â». </p><br>
<p><img src="https://habrastorage.org/webt/ed/ui/p6/eduip6msje8zxkrqnh4-8vabosg.png"></p><br>
<p> ,     , ,     :  ,   .      .      . </p><br>
<p>   ,          . </p><br>
<ul>
<li>    ( DBA)  â€“  ,     .       ,        .       ,      . </li>
<li>    ,     .    .     .       . </li>
<li>   ,   <code>shared buffers</code>,          ( , ),   .       .     - ,            shared buffers. </li>
<li>         .   .       â€“      . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/lc/do/dt/lcdodt4jbsygkgp8jx041vcbfsw.png"></p><br>
<p>    .         .      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://github.com/lesovsky/ConferenceStuff/tree/master/2016.highload</a></p><br>
<p>    ?   <code>pgbench</code>      .  pgbench      .            .    ,      . . .      ,      . </p><br>
<p><img src="https://habrastorage.org/webt/cb/xd/97/cbxd97cteefhstwlddgwori2ajc.png"></p><br>
<p>     . ,       .  ,  ,    ,  -    .   ,     Postgres,     (         ,   ).             ,       .</p><br>
<p><img src="https://habrastorage.org/webt/we/ts/d9/wetsd9tb46ev3juckcwk9ezt2ta.png"></p><br>
<p>     ,   MVCC.</p><br>
<p>MVCC (Multi-Version Concurrency Control) â€“  ""  ,  Postgres', . .                    .</p><br>
<ul>
<li>    .     .            .</li>
<li>            .</li>
<li> ,    ;     (     ).</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/eo/qt/lc/eoqtlcif0e8ox_ihwmuqclbgwew.png"></p><br>
<p>    ?     .       .     (snapshot).</p><br>
<p><img src="https://habrastorage.org/webt/d-/zx/ja/d-zxjayq6qlxhpcu2bfxythgtqm.png"></p><br>
<p>       :   ,    .              ,        ( COMMIT  ROLLBACK).</p><br>
<p><img src="https://habrastorage.org/webt/6z/ph/sb/6zphsbe6c9bckavrgr_fgbknwme.png"></p><br>
<p>     COMMIT,        ,        .       ,        "  ".   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">   PostgreSQL</a>.</p><br>
<p>    .   ,  . -    ,     Â«deleteÂ», Â«updateÂ».     .. ""  â€” <code>dead tuples</code>. </p><br>
<p><img src="https://habrastorage.org/webt/iw/kx/w0/iwkxw0lsgd6tagswlyis5m65ouu.png"></p><br>
<p>     .    â€“    <code>xmin</code>.    ,    . . .    insert,    xmin   . </p><br>
<p>    ,             .       <code>xmax</code>    ,   .</p><br>
<p> delete.   .      â€”   <code>xmax</code>     ,    .</p><br>
<p>              ,     ""   .   ,   xmax       .            â€”            ,  Postgres         ,        .      -    -       , ..        ,          .</p><br>
<p><img src="https://habrastorage.org/webt/8i/-c/cg/8i-ccgu38dh9ydkg7ue9sk1qqn0.png"></p><br>
<p>     ,    ?    ,    ,                ,    . </p><br>
<p>       .     ,              .      .</p><br>
<p><img src="https://habrastorage.org/webt/7r/cq/f1/7rcqf1nzi4dtbmownh9rqfchbz4.png"></p><br>
<p>  Â«deleteÂ», Â«updateÂ»   ,  /            .     ,       ,   -        .</p><br>
<p><img src="https://habrastorage.org/webt/fd/0h/fc/fd0hfcbvlzr83cdaf4ktpwlszoc.png"></p><br>
<p>    ,      .        .</p><br>
<p><img src="https://habrastorage.org/webt/xh/pu/mb/xhpumb0tkvun4urwv534i0s1gje.png"></p><br>
<p>      ,      ,   ,   . .</p><br>
<p><img src="https://habrastorage.org/webt/17/fu/kg/17fukg6fvv_ttf4jdwub_mk27ho.png"></p><br>
<p> :</p><br>
<ul>
<li>   ,    ,   ,   "",    ,      .</li>
<li>  shared buffers             . </li>
<li>   <code>bloat</code> , ..   â€”               . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/5u/sn/se/5usnsewb85uihdn5nenam9yjf2c.png"></p><br>
<p>        .     ?</p><br>
<ul>
<li>-,   .</li>
<li>   Postgres,    .       .    .      ,      ,   -       ,   .</li>
<li>    .    .     .</li>
<li>     â€“        .     .         .    ,         .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ew/8v/dt/ew8vdtf5y49avskvvnunodanele.png"></p><br>
<ul>
<li>      -   . ,     Postgres      .      ,      .   ,      .</li>
<li>           ,     .</li>
<li>    ,    <code>  </code>.     32 , .    4294967296.       ,         .      ,    ,                  (        ).    .. <code>to prevent wraparound vacuum</code>,       .  wraparound vacuum     â€”    .</li>
<li>    ,     ,    .          -   .           .        .          ,       .      ,      .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/oo/kv/w0/ookvw0ol3x-fulqpcltgnhw9zwe.png"></p><br>
<ul>
<li><strong>     .</strong>      Postgres ,  Postgres     ,    ,    Pentium,          -   , .     -  .  ,             ,  ,  <strong>    ,   -  .</strong>       .       .</li>
<li> Postgres      .              .       9.6.   ,       9.6     ,       9.6. (    ,     Postgres 12)</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ob/n6/cn/obn6cnkpbariycrvnlrqxloa2se.png"></p><br>
<p>    - .      .</p><br>
<p><img src="https://habrastorage.org/webt/_w/bj/66/_wbj66wqi-nindu2znh5gsnjqna.png"></p><br>
<p>-,     ,          ..  â€” <code>cost-based vacuum</code>.       . </p><br>
<p>  ,   :     .    ,        ( ) â€”       .        .</p><br>
<p>      <em> </em>,      <em>  </em>.                 .</p><br>
<p>        .  <code>vacuum_cost_page_hit</code>, <code>vacuum_cost_page_miss</code>, <code>vacuum_cost_page_dirty</code>,   hit, miss, dirty.</p><br>
<p><strong>Hit</strong> â€“   ,    ,    shared buffers, . .    .    ,               . </p><br>
<p><strong>Miss</strong> â€“      shared buffers       .      .     ,       .     ,     shared buffers,          (page cache)   -  .    ,        .</p><br>
<p><strong>Dirty</strong> â€“   ,     ,                .         .</p><br>
<p>         .       <strong>vacuum_cost_limit</strong>.                  .</p><br>
<p>    <strong>vacuum_cost_delay</strong>.   ,     cost limit          .    cost delay     .</p><br>
<p>      ,          ,    ,         .          .   . </p><br>
<p><img src="https://habrastorage.org/webt/km/tg/ci/kmtgcideecl9aqsljdkwouizedw.png"></p><br>
<p>-,    . -    ,    ,   .</p><br>
<ul>
<li>  ,        32  ,       . <strong>,   ,   autovacuum_max_workers   10-15 %     .</strong></li>
<li>  <strong>autovacuum_naptime</strong>.  ,       . <strong>    60 .     .     ,       1 </strong>.  ,              .     ,       â€“     . . .    .  ,      .</li>
<li>    â€“  ,   <strong>vacuum_cost_limit</strong>,     ,      ,     .    , <strong>vacuum_cost_limit</strong>     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/oo/2e/47/oo2e47hrh4hxob8jvyjjucjc0ly.png"></p><br>
<p>-,           ,               .     ,         .           â€“      .</p><br>
<p>   .                <strong>autovacuum_vacuum_scale_factor</strong>. scale factor   . -  scale_factor 0.2, . . 20 %.</p><br>
<p>     <strong>autovacuum_vacuum_threshold</strong>. - â€“ 50 .     ,          ,    .</p><br>
<p><img src="https://habrastorage.org/webt/63/en/ti/63enti4gfce93el_fce3twqvrso.png"></p><br>
<p> , -           20 %.              ,     <strong>autovacuum_vacuum_threshold</strong>   , , 1-2-5 %. </p><br>
<p><img src="https://habrastorage.org/webt/zi/1s/oq/zi1soqr-3vks3mqnxi1hcr1bsyo.png"></p><br>
<p>  ,     <strong>autovacuum_vacuum_scale_factor</strong>    .      .     ,   1 % â€”     .     <strong>autovacuum_vacuum_scale_factor</strong>  0.    <strong>autovacuum_vacuum_threshold</strong>, . .  ,     ,    .      <strong>autovacuum_vacuum_scale_factor</strong>     ,       <strong>autovacuum_vacuum_threshold</strong>.</p><br>
<p><img src="https://habrastorage.org/webt/rm/jj/r3/rmjjr3cxwqz4cxutagmm9gcnujo.png"></p><br>
<p>     ,   .  4-5 ,  HDD    ,        .    HDD      .   ,     ,     .   , ,    ,  . </p><br>
<p> SSD    .      SSD        .   ,    . </p><br>
<p>  SSD     .  ,       .    ,    (, ),    .    â€“    ,     .</p><br>
<p>    NVMe ,       ,      .    I/O    .     ,       . ,      -  â€“   -       .    ,   IO,   ,  .</p><br>
<p><img src="https://habrastorage.org/webt/_w/ui/pp/_wuippkoa0tusm7tvz2tke2admk.png"></p><br>
<p>        -  .   <strong>vacuum_cost_delay</strong>  <strong>vacuum_cost_limit</strong>.        . . .     .        .  .  â€“       .          .</p><br>
<p>  ,    .    ,     ,     . </p><br>
<p><img src="https://habrastorage.org/webt/il/wp/7r/ilwp7rhrlmrv9kmau_4z2__plca.png"></p><br>
<pre><code class="plaintext hljs">vacuum_cost_delay = 0<font></font>
vacuum_cost_page_hit = 0<font></font>
vacuum_cost_page_miss = 5<font></font>
vacuum_cost_page_dirty = 5<font></font>
vacuum_cost_limit = 200<font></font>
--<font></font>
autovacuum_max_workers = 10<font></font>
autovacuum_naptime = 1s<font></font>
autovacuum_vacuum_threshold = 50<font></font>
autovacuum_analyze_threshold = 50<font></font>
autovacuum_vacuum_scale_factor = 0.05<font></font>
autovacuum_analyze_scale_factor = 0.05<font></font>
autovacuum_vacuum_cost_delay = 5ms<font></font>
autovacuum_vacuum_cost_limit = -1</code></pre><br>
<p>      SSD ,      .  ,            ,     . </p><br>
<p><strong>   :    SSD.</strong></p><br>
<p><img src="https://habrastorage.org/webt/ix/sd/ob/ixsdobjhrykz7d6mzhdorx66_n0.png"></p><br>
<p>            .   -       ,  -  ""           ,       .</p><br>
<p>          ,    <code>storage parameters</code>.        <code>tablespaces</code>,      .        ,    .</p><br>
<p><img src="https://habrastorage.org/webt/tf/qp/pf/tfqppfseyswfcbfn4fvxsv-74d4.png"></p><br>
<p>  ,        â€”    ,     ,               ,      Postgres. ,  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">pgcompacttable</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">pg_repack</a>.</p><br>
<p>   <code>bloat</code>     . </p><br>
<p>      ,         ,   .         â€“   ,    (  ).          . </p><br>
<p><img src="https://habrastorage.org/webt/jj/ct/4r/jjct4rtt6pjarvfjpifbvfzt39i.png"></p><br>
<p>        ,   .  -  . </p><br>
<p> Postgres    ,   ,    . </p><br>
<p>   <code>pg_stat_activity</code>.   ,     (<code>view</code>)     ,        ,      .</p><br>
<p>       ,      ,    ,     . . .     pg_stat_atctivity   ().</p><br>
<p><img src="https://habrastorage.org/webt/ad/s1/r3/ads1r32i9l8xq6p0yplfgalwuv8.png"></p><br>
<p>  , ,       .         ,          <code>prevent wraparound</code> .      (<code>autovacuum_max_workers</code>)â€“        .</p><br>
<p>       â€“       .        , ,       ,                 .        â€”          .          .</p><br>
<p><img src="https://habrastorage.org/webt/iv/kt/be/ivktbevhwtimzgspbkqf-x_y9we.png"></p><br>
<p> ,   ,  <code>pg_stat_progress_vacuum</code>      9.6.           .</p><br>
<p>      ,            ,    .    <code>pg_stat_activity</code>    ,    ,    , ,      <code>pg_stat_progress_vacuum</code>     .</p><br>
<p><img src="https://habrastorage.org/webt/rt/xk/fw/rtxkfw2t_nmyn3fuxgpa55eavag.png"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://github.com/lesovsky/uber-scripts/blob/master/postgresql/sql/vacuum_activity.sql</a></p><br>
<p> ,    ,   ,             .     ,       50 %         .        3 ,       3 .</p><br>
<p> â€”         :     ,    .   ,    .</p><br>
<p><img src="https://habrastorage.org/webt/f8/bo/db/f8bodbtuoqugyofhyzvcqqlrv40.png"></p><br>
<p>      :</p><br>
<ul>
<li><strong>  .     .</strong> </li>
<li>   .   cost-based,     cost-. </li>
<li>  â€“  .      ,      ,     .</li>
</ul><br>
<p></p><br>
<p><em>!   !   .  9.6       ,   .        ,  ,    ,   .    - ?  ,  -  ?</em></p><br>
<p> .  9.6  freeze-,            .    postgresâ€™  ,      wraparound vacuum.    ,     . ,  ,     .    , ,       .        ,        9.5  .    ,      .       ,          . </p><br>
<p><em>  ,           buffer cache,     read?</em></p><br>
<p>,  autovacuum worker ,    buffer-.       32 , -.   ,          . </p><br>
<p><em>     ?</em></p><br>
<p>, ,     buffer cache,        page cache,    ,     .     .    ,   page cache,   shared buffers        .</p><br>
<p><em>,    !  ,     .    ,      .  time   .  5  1 ,  .     .            ,      5     100 %   CPU,   storage.      .</em> </p><br>
<p>  â€“    .   â€“  .       CPU,  -   .      â€“     ?       Ubuntu.   Ubuntu       <code>powersave</code>. . .,  ,     3,4 GHz,       â€“ 1,2.    .      performance  .      . , ,  ,     , ,   ,    .  ,     ,    . </p><br>
<p>              .    ,     , . .   -  ,           .   - bloat -     ,          .          . </p><br>
<p><em>  ! ,       .       :   .   -  autovacuum_vacuum_scale_factor  autovacuum_vacuum_threshold  .        ,     ,  ,     .    ,  naptime    ,    analyze.     Postgres        .    pg_class reltuples</em></p><br>
<p>.</p><br>
<p><em>    .      .</em> </p><br>
<p>. </p><br>
<p><em>         dead tuples  community   ,    2ndQuadrant.  â€“ .        analyze   reltuples   .</em></p><br>
<p>,  .   â€“    .    . <strong>  ,       Â«idle in transactionsÂ»,     ,      .</strong>     -    .    , . .      ,    . </p><br>
<p><em> ,      ?</em></p><br>
<p>,    MVCC   .       -  ,    .</p><br>
<p><em>     reltuples?</em></p><br>
<p> .   . </p><br>
<p><em>( )   .   ,    .   : update, insert  . .        : ,     .     tuples.    .</em></p><br>
<p>, . .       ,    .        .  reltuples  .     ,    ,     ,    , . . .    -    â€“    .      . </p><br>
<p><em>   ,      .         -    ?</em> </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresä»£ç ä¸­æœ‰å•ç‹¬çš„å‡½æ•°ï¼Œç”¨äºæ”¶é›†æœ‰å…³è¡¨å†…æ•°æ®åˆ†å¸ƒçš„ç»Ÿè®¡ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è‡ªåŠ¨çœŸç©ºå­ç³»ç»Ÿã€‚</font><font style="vertical-align: inherit;">å®ƒä»è¡¨ä¸­è¯»å–æœ‰é™å¤§å°çš„æ ·æœ¬æ•°æ®ã€‚</font><font style="vertical-align: inherit;">å¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ ¹æ®æ•°æ®å»ºç«‹åˆ†å¸ƒã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œä»–å°†è¯¥ä¿¡æ¯ä¿å­˜åœ¨ç³»ç»Ÿç›®å½•</font></font><code>pg_statistic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ–ç³»ç»Ÿè§†å›¾ä¸­</font></font><code>pg_stats</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å½“è®¡åˆ’è€…æ„å»ºæŸ¥è¯¢è®¡åˆ’æ—¶ï¼Œå®ƒä¼šä»è¯¥ç›®å½•ä¸­è¯»å–ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">å¹¶åœ¨æ­¤åŸºç¡€ä¸Šåˆ¶å®šè®¡åˆ’ã€‚</font><font style="vertical-align: inherit;">ç„¶åä»–é€‰æ‹©äº†æœ€å¥½çš„ä¸€ä¸ªã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501500/index.html">è§†è§‰é»‘å®¢ï¼šä»€ä¹ˆæ„æˆå¨èƒä»¥åŠå¦‚ä½•ä¿æŠ¤è‡ªå·±å…å—é—´è°ä¾µå®³</a></li>
<li><a href="../zh-CN501502/index.html">æ–°å®éªŒå®¤æ•°å­—ç»¼åˆç»§ç»­å“ˆé‡Œæ–¯ä¹¦å¹¶å¸®åŠ©åˆ¶ä½œFPGAè§†é¢‘æ¸¸æˆ</a></li>
<li><a href="../zh-CN501506/index.html">å…³äºGDIæ³„æ¼å’Œè¿æ°”çš„é‡è¦æ€§</a></li>
<li><a href="../zh-CN501508/index.html">è¯¥æ­»çš„è€å®¢æˆ·å…³ç³»ç®¡ç†</a></li>
<li><a href="../zh-CN501510/index.html">Ruby on Railsæ¡†æ¶å¯¹Fullstackå¼€å‘çš„æ–°è§è§£</a></li>
<li><a href="../zh-CN501520/index.html">Cï¼ƒ8ï¼Œæ— æ•ˆã€‚æˆ‘ä»¬å¦‚ä½•ç”Ÿæ´»</a></li>
<li><a href="../zh-CN501522/index.html">å…è´¹çš„Skillboxç½‘ç»œç ”è®¨ä¼šï¼šç”¨PHPï¼ŒUnityå’ŒUnreal Engineç¼–å†™æ¸¸æˆ</a></li>
<li><a href="../zh-CN501524/index.html">åŒæ­¥åœ°çƒå’Œç”Ÿç‰©ä½“ç”µç£åœºçš„ç§˜å¯†</a></li>
<li><a href="../zh-CN501526/index.html">ä¸ºä»€ä¹ˆåŠ æ‹¿å¤§è‹±è¯­è¢«è®¤ä¸ºæ˜¯â€œè‚®è„çš„â€ï¼ŒåŸºåŠªÂ·é‡Œç»´æ–¯ä¸å®ƒæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
<li><a href="../zh-CN501528/index.html">ã€Šæ‰“å‡»ä¸ç½‘ç»œå®‰å…¨ï¼šLinuxå‘½ä»¤è¡Œä¸­çš„æ”»å‡»ï¼Œé˜²å¾¡å’Œåˆ†æã€‹ä¸€ä¹¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>