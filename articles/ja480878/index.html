<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍖 🌅 👩🏾‍🔬 アンドロイド 表面 👨🏽‍🚒 💽 🏴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="免責事項
 

この記事は、ビデオやカメラでの作業経験がほとんどない初心者のandroid開発者、特にグラフィカの例の分析を開始し、それらが難しいと感じた開発者を対象としています。ここでは、状態図で示される基本的な手順の簡単な説明で同様のコードを見ていきます。
 

タイトルにSurfaceクラスが...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>アンドロイド 表面</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480878/"><h2 id="diskleymer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は、ビデオやカメラでの作業経験がほとんどない初心者のandroid開発者、特に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラフィカの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例の分析を開始し</font><font style="vertical-align: inherit;">、それらが難しいと</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">感じた開発</font></a><font style="vertical-align: inherit;">者を対象として</font><font style="vertical-align: inherit;">います。ここでは、状態図で示される基本的な手順の簡単な説明で同様のコードを見ていきます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイトルにSurfaceクラスが表示されるのはなぜですか？</font><font style="vertical-align: inherit;">Androidでは、多くのクラスの名前に「</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface」</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という単語が含まれています</font><font style="vertical-align: inherit;">（Surface、SurfaceHolder、SurfaceTexture、SurfaceView、GLSurfaceView）。これらは共通の階層によって接続されていませんが、画像出力を処理するための低レベルのロジックによって結合されています。</font><font style="vertical-align: inherit;">SDKのこの特定の部分での作業を開示する試みを強調するために、タイトルでそれを使用することは私には理にかなっているように思われました。</font></font></p><a name="habracut"></a><br>
<h2 id="primer-ispolzovaniya-s-raznym-api"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なるAPIでの使用例</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の例を書いてみましょう。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カメラからプレビューを取り、その上にアニメーションドローアブルをオーバーレイし、画面上にすべて表示し、必要に応じてファイルに書き込みます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なコードは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https://github.com/tttzof351/AndroidSurfaceExample/</font></a><font style="vertical-align: inherit;">になり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示には</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLSurfaceView</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EGLSurfaceクラス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">して記録し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API V2を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介してカメラと通信し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一般的なスキームは、おおよそ次のとおりです。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/9o/rc/o5/9orco54m0chpg_og4db_qppsrjm.png"></p><br>
<h2 id="nalozhenie-neskolkih-surface"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のサーフェスを重ねる</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surfaceは実際には、画像を埋める必要のあるメモリ内の領域へのハンドルです。</font><font style="vertical-align: inherit;">ほとんどの場合、画面またはファイルに何かを表示しようとするため、データを生成する「プロセス」のバッファのように機能します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のSurfaceからオーバーレイを作成するには、OpenGLを使用します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、2つの正方形の外部テクスチャを作成し、それらから取得します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードでは、次のようになります。</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenGLExtarnalTexture.kt</font></font></a></p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> textures = IntArray(<span class="hljs-number">1</span>)<font></font>
GLES20.glGenTextures(<span class="hljs-number">1</span>, textures, <span class="hljs-number">0</span>)
<span class="hljs-keyword">val</span> textureId = textures[<span class="hljs-number">0</span>]
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">val</span> textureWidth = ...
<span class="hljs-keyword">val</span> textureHeight = ...
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">val</span> surfaceTexture = SurfaceTexture(textureId)<font></font>
surfaceTexture.setDefaultBufferSize(textureWidth, textureHeight)<font></font>
<span class="hljs-comment">//, surface  ""   </span>
<span class="hljs-keyword">val</span> surface = Surface(surfaceTexture)</code></pre><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XYZ座標</font></font></strong></p><br>
<p>        ,           OpenGL:       (),    .  -1  1. </p><br>
<p>        (      z     0f) —        preview  ,     drawable-:</p><br>
<p>   :</p><br>
<p><img src="https://habrastorage.org/webt/mu/fj/kr/mufjkrznafatofs4lsn-ywm_h7i.png"></p><br>
<pre><code class="kotlin hljs">fullscreenTexture = floatArrayOf(
   <span class="hljs-comment">// X,     Y,     Z  </span>
   -<span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,
    <span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,<font></font>
   -<span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,
    <span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,<font></font>
)<font></font>
smallTexture = floatArrayOf(<font></font>
   <span class="hljs-comment">// X,      Y,    Z</span>
    <span class="hljs-number">0.3f</span>,   <span class="hljs-number">0.3f</span>,  <span class="hljs-number">0.0f</span>,
    <span class="hljs-number">0.8f</span>,   <span class="hljs-number">0.3f</span>,  <span class="hljs-number">0.0f</span>,
    <span class="hljs-number">0.3f</span>,   <span class="hljs-number">0.8f</span>,  <span class="hljs-number">0.0f</span>,
    <span class="hljs-number">0.8f</span>,   <span class="hljs-number">0.8f</span>,  <span class="hljs-number">0.0f</span>
)</code></pre><br>
<p><strong>UV </strong></p><br>
<p>  ? ,   :(</p><br>
<p>                         —    OpenGL  <strong>UV</strong>  —           0  1    . </p><br>
<p>    —       <strong>UV</strong>        ,         1.</p><br>
<p>   —                    -  .  0.8     .</p><br>
<p>  —            —        ,        .     fullscreen      (2   )     1080x1920.               .<br>
    —      (1, 1, 0)    UV  (0, 0),    (0.8f, 0.8f)  . </p><br>
<p><img src="https://habrastorage.org/webt/fk/ur/ig/fkurigpfo4l_hnl1fonbgj1dao0.png"></p><br>
<p>    XYZ  UV:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">// X,     Y,     Z,     U,     V</span>
-<span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.8f</span>, <span class="hljs-number">0.8f</span>,
 <span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.8f</span>, <span class="hljs-number">0.0f</span>,<font></font>
-<span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.8f</span>,
 <span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span></code></pre><br>
<p>    preview               .        0.8f.<br>
        1?        OpenGL-       .                 “”</p><br>
<p><strong>:    /          UV   !</strong></p><br>
<p><strong>    </strong></p><br>
<p><img src="https://habrastorage.org/webt/au/wp/zx/auwpzx9wgczhb79_4bbfu9nyk_a.png"></p><br>
<pre><code class="kotlin hljs">fullscreenTexture = floatArrayOf(
  <span class="hljs-comment">// X,   Y,      Z,      U,  V</span>
   -<span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>,
    <span class="hljs-number">1.0f</span>,  -<span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>,<font></font>
   -<span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span>,
    <span class="hljs-number">1.0f</span>,   <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span><font></font>
)<font></font>
smallTexture = floatArrayOf(<font></font>
  <span class="hljs-comment">// X,   Y,      Z,      U,  V</span>
    <span class="hljs-number">0.3f</span>,   <span class="hljs-number">0.3f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>,
    <span class="hljs-number">0.8f</span>,   <span class="hljs-number">0.3f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>,
    <span class="hljs-number">0.3f</span>,   <span class="hljs-number">0.8f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>,
    <span class="hljs-number">0.8f</span>,   <span class="hljs-number">0.8f</span>,  <span class="hljs-number">0.0f</span>,  <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span>
)</code></pre><br>
<p><strong></strong></p><br>
<p>  XYZ  UV-    —          .         : <strong>MVPMatrix</strong>  <strong>TexMatrix</strong>   XYZ  UV  . </p><br>
<p> OpenGL2     ,   -  . ,          ,         ,          ,    . </p><br>
<p>    — vertex  fragment. </p><br>
<p> (vertex)    ,      XYZ / UV        OpenGL  <strong>gl_Position</strong>           . </p><br>
<p> (fragment)   <strong>gl_FragColor</strong>  .</p><br>
<p> :   vertex       ,  :</p><br>
<ul>
<li>MVPMatrix -&gt; <strong>uMVPMatrix</strong></li>
<li><strong>TexMatrix -&gt; uTexMatrix</strong></li>
<li> XYZ   -&gt; <strong>aPosition</strong></li>
<li>UV  -&gt; <strong>aTextureCoord</strong></li>
</ul><br>
<p><strong>vTextureCoord</strong> —      vertex   fragment <br>
 fragment     UV           .</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> vertexShader = <span class="hljs-string">"""
   uniform mat4 uMVPMatrix;
   uniform mat4 uTexMatrix;
   attribute vec4 aPosition;
   attribute vec4 aTextureCoord;
   varying vec2 vTextureCoord;
   void main() {
       gl_Position = uMVPMatrix * aPosition;
       vTextureCoord = (uTexMatrix * aTextureCoord).xy;
   }
"""</span>
<span class="hljs-keyword">val</span> fragmentShader = <span class="hljs-string">"""
   #extension GL_OES_EGL_image_external : require
   precision mediump float;
   varying vec2 vTextureCoord;
   uniform samplerExternalOES sTexture;
   void main() {
       gl_FragColor = texture2D(sTexture, vTextureCoord);
   }
"""</span></code></pre><br>
<p>     :</p><br>
<ul>
<li>uniform —         ,          ,         </li>
<li>attribute —       ,      </li>
<li>varying —      vertex   fragment</li>
</ul><br>
<p>    ?      id () :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> aPositionHandle = GLES20.glGetAttribLocation(programId, <span class="hljs-string">"aPosition"</span>)</code></pre><br>
<p>   id   :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//      floatbuffer</span>
<span class="hljs-keyword">val</span> verticesBuffer = ByteBuffer.allocateDirect(<font></font>
    fullscreenTexture.size * FLOAT_SIZE_BYTES<font></font>
).order(<font></font>
    ByteOrder.nativeOrder()<font></font>
).asFloatBuffer()<font></font>
verticesBuffer.put(fullscreenTexture).position(<span class="hljs-number">0</span>)
<span class="hljs-comment">/*
   -  XYZ   0 .    
  id      ,   
  ,               - 5  - XYZUV,  4 - -   float
*/</span>
verticesBuffer.position(<span class="hljs-number">0</span>)<font></font>
GLES20.glVertexAttribPointer(<font></font>
    aPositionHandle,<font></font>
    <span class="hljs-number">3</span>,<font></font>
    GLES20.GL_FLOAT,<font></font>
    <span class="hljs-literal">false</span>,
    <span class="hljs-number">5</span> * <span class="hljs-number">4</span>,<font></font>
    verticesBuffer<font></font>
)</code></pre><br>
<p><strong> </strong></p><br>
<p>              ,  OpenGL   :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateFrame</span><span class="hljs-params">(...)</span></span> {<font></font>
    ...<font></font>
    surfaceTexture.updateTexImage()<font></font>
    GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>)<font></font>
} </code></pre><br>
<p>       OpenGL     —    : </p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">OpenGLExternalTexture.kt</a></p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenGLExternalTexture</span></span>(verticesData: FloatArray, ...) {
    <span class="hljs-keyword">val</span> surfaceTexture: SurfaceTexture
    <span class="hljs-keyword">val</span> surface: Surface
    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// ,    .</span><font></font>
    }<font></font>
    ...<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateFrame</span><span class="hljs-params">(aPositionHandle: <span class="hljs-type">Int</span>, ...)</span></span> {...} <span class="hljs-comment">// ,  </span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">release</span><span class="hljs-params">()</span></span> {...} <span class="hljs-comment">//  </span>
}</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">OpenGLScene.kt</a></p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenGLScene</span></span>(<font></font>
    sceneWidth: <span class="hljs-built_in">Int</span>,<font></font>
    sceneHeight: <span class="hljs-built_in">Int</span>,<font></font>
    ...<font></font>
) {<font></font>
    <span class="hljs-keyword">val</span> fullscreenTexture = OpenGLExternalTexture(...)
    <span class="hljs-keyword">val</span> smallTexture = OpenGLExternalTexture(..)<font></font>
<font></font>
    <span class="hljs-keyword">val</span> aPositionHandle: <span class="hljs-built_in">Int</span> <font></font>
    ...<font></font>
    <span class="hljs-keyword">init</span> {
      <span class="hljs-comment">// ,        .</span><font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateFrame</span><span class="hljs-params">()</span></span> {<font></font>
        ...<font></font>
        fullscreenTexture.updateFrame(aPositionHandle, ...)<font></font>
        smallTexture.updateFrame(aPositionHandle, ...)<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">release</span><span class="hljs-params">()</span></span> {<font></font>
        fullscreenTexture.release()<font></font>
        smallTexture.release()        <font></font>
    }<font></font>
}</code></pre><br>
<h2 id="statemachine--mashina-sostoyaniy--konechnyy-avtomat">StateMachine /   /  </h2><br>
<p> API          (     Drawable-).        StateMachine- —      ,        .</p><br>
<p>        ,      :</p><br>
<pre><code class="kotlin hljs">imageView.setOnClickListener {<font></font>
    loadImage { bitmap -&gt; <font></font>
        imageView.setBitmap(bitmap)<font></font>
    }<font></font>
}</code></pre><br>
<p>    —   ,        :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> uiMachine = UIMachine()<font></font>
imageView.setOnClickListener { uiMachine.send(Click(imageView)) }<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UIMachine</span> </span>{
    <span class="hljs-keyword">var</span> state: State = WaitClick()
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">send</span><span class="hljs-params">(action: <span class="hljs-type">Action</span>)</span></span> = transition(action)
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transition</span><span class="hljs-params">(action: <span class="hljs-type">Action</span>)</span></span> {
        <span class="hljs-keyword">val</span> state = <span class="hljs-keyword">this</span>.state
        <span class="hljs-keyword">when</span> {<font></font>
            state <span class="hljs-keyword">is</span> WaitingClick &amp;&amp; action <span class="hljs-keyword">is</span> Click -&gt; {
                <span class="hljs-keyword">this</span>.state = WaitBitmap(imageView = action.imageView)<font></font>
                loadImage { send(BitmapIsReady(bitmap = it)) }<font></font>
            }<font></font>
            state <span class="hljs-keyword">is</span> WaitingBitmap &amp;&amp; action <span class="hljs-keyword">is</span> BitmapIsReady -&gt; {
                <span class="hljs-keyword">this</span>.state = WaitClick<font></font>
                state.imageView.setImageBitmap(action.bitmap)<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
} <font></font>
<span class="hljs-keyword">sealed</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">State</span> </span>{
    <span class="hljs-keyword">object</span> WaitingClick : State()
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WaitingBitmap</span></span>(<span class="hljs-keyword">val</span> imageView: ImageView): State()<font></font>
}<font></font>
<span class="hljs-keyword">sealed</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Action</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Click</span></span>(<span class="hljs-keyword">val</span> imageView: ImageView): Action()
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BitmapIsReady</span></span>(<span class="hljs-keyword">val</span> bitmap: Bitmap): Action()<font></font>
}</code></pre><br>
<p>    <strong><em></em></strong> ,      ,   :         <strong>loadImage,</strong>       ,       ,      ,      transition           .   :</p><br>
<p><img src="https://habrastorage.org/webt/-n/2p/mq/-n2pmqdwfsps932me0wfsrvyj_q.png"><br>
  ,    .      ,   .             .</p><br>
<p>    StateMachine:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Action</span></span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">State</span></span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StateMachine</span>&lt;<span class="hljs-type">S : State, A : Action</span>&gt; </span>{
    <span class="hljs-keyword">var</span> state: S
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transition</span><span class="hljs-params">(action: <span class="hljs-type">A</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">send</span><span class="hljs-params">(action: <span class="hljs-type">A</span>)</span></span>
}</code></pre><br>
<h2 id="glsurfaceview">GLSurfaceView</h2><br>
<p>    -    OpenGL  android   GLSurfaceView —       , /     GLSurfaceView::onResume/onPause.</p><br>
<p>        16:9</p><br>
<p>       — GLSurfaceView.Renderer.<br>
   StateMachine-   -  :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GLSurfaceMachine.kt</a></p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GLSurfaceMachine</span>: <span class="hljs-type">StateMachine</span>&lt;<span class="hljs-type">GLSurfaceState, GLSurfaceAction</span>&gt; </span>{
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> state: GLSurfaceState = WaitCreate()
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">send</span><span class="hljs-params">(action: <span class="hljs-type">GLSurfaceAction</span>)</span></span> = transition(action)
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transition</span><span class="hljs-params">(action: <span class="hljs-type">GLSurfaceAction</span>)</span></span> {
        <span class="hljs-keyword">val</span> state = <span class="hljs-keyword">this</span>.state
        <span class="hljs-keyword">when</span> {<font></font>
            state <span class="hljs-keyword">is</span> WaitCreate &amp;&amp; action <span class="hljs-keyword">is</span> Create -&gt; {
                <span class="hljs-keyword">this</span>.state = WaitSurfaceReady(...)
                <span class="hljs-keyword">this</span>.state.glSurfaceView?.setRenderer(<span class="hljs-keyword">object</span> :Renderer {
                    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceChanged</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span><font></font>
                        send(SurfaceReady(width, height, gl))<font></font>
                    }<font></font>
                    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceCreated</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, config: <span class="hljs-type">EGLConfig</span>?)</span></span> {<font></font>
                    }<font></font>
                    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {<font></font>
                        send(Draw)<font></font>
                    }<font></font>
                })          <font></font>
            }<font></font>
            state <span class="hljs-keyword">is</span> WaitSurfaceReady &amp;&amp; action <span class="hljs-keyword">is</span> SurfaceReady -&gt; {            
                <span class="hljs-keyword">val</span> openGLScene = OpenGLScene(width, height)
                <span class="hljs-keyword">this</span>.state = DrawingAvailable(openGLScene, ...)<font></font>
            }<font></font>
            state <span class="hljs-keyword">is</span> DrawingAvailable &amp;&amp; action <span class="hljs-keyword">is</span> Draw -&gt; {<font></font>
                state.openGLScene.updateFrame()<font></font>
            }<font></font>
            state !<span class="hljs-keyword">is</span> WaitCreate &amp;&amp; action <span class="hljs-keyword">is</span> Stop -&gt; {<font></font>
                state.uiHolder.glSurfaceView?.onPause()<font></font>
                state.uiHolder.openGLScene?.release()<font></font>
                <span class="hljs-keyword">this</span>.state = WaitSurfaceReady()<font></font>
            }<font></font>
<font></font>
            state <span class="hljs-keyword">is</span> WaitSurfaceReady &amp;&amp; action <span class="hljs-keyword">is</span> Start -&gt; {<font></font>
              state.uiHolder.glSurfaceView?.onResume()<font></font>
            }           <font></font>
        }<font></font>
    }<font></font>
}<font></font>
...<font></font>
<span class="hljs-keyword">val</span> glSurfaceMachine = GLSurfaceMachine()
<span class="hljs-keyword">val</span> glSurfaceView = findViewById(R.id.gl_view)<font></font>
glSurfaceView.layoutParams.width = width<font></font>
glSurfaceView.layoutParams.height = ((<span class="hljs-number">16f</span>/<span class="hljs-number">9f</span>) * width).toInt()<font></font>
glSurfaceMachine.send(GLSurfaceAction.Create(glSurfaceView, ...))</code></pre><br>
<p>   :</p><br>
<p><img src="https://habrastorage.org/webt/mx/5i/xb/mx5ixbssfaqci1ktsmumu94jbz0.png"></p><br>
<p>    -   ,        —        .       ,    Surface-      .      .    —    CanvasDrawable:</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">CanvasDrawable.kt</a></p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CanvasDrawable</span> : <span class="hljs-type">Drawable</span></span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> backgroundPaint = Paint().apply { ... }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> circlePaint = Paint().apply { ... }
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {<font></font>
        canvas.drawRect(bounds, backgroundPaint)<font></font>
        <span class="hljs-keyword">val</span> width = bounds.width()
        <span class="hljs-keyword">val</span> height = bounds.height()
        <span class="hljs-keyword">val</span> posX = ...
        <span class="hljs-keyword">val</span> posY = ...<font></font>
        canvas.drawCircle(posX, posY, <span class="hljs-number">0.1f</span> * width, circlePaint)<font></font>
    }<font></font>
    ...<font></font>
}</code></pre><br>
<p>   GLSurfaceMachine     canvasDrawable  canvas-   surface   :</p><br>
<pre><code class="kotlin hljs">state <span class="hljs-keyword">is</span> DrawingAvailable &amp;&amp; action <span class="hljs-keyword">is</span> Draw -&gt; {
  <span class="hljs-keyword">val</span> canvasDrawable = state.canvasDrawable
  <span class="hljs-keyword">val</span> smallTexture = state.openGLScene.smallTexture
  <span class="hljs-keyword">val</span> bounds = canvasDrawable.bounds
  <span class="hljs-keyword">val</span> canvas = smallSurface.lockCanvas(bounds)<font></font>
  canvasDrawable.draw(canvas)<font></font>
  smallSurface.unlockCanvasAndPost(canvas)<font></font>
  state.openGLScene.updateFrame()<font></font>
}</code></pre><br>
<p>   - :</p><br>
<p><img src="https://habrastorage.org/webt/vo/4r/-d/vo4r-dgpynjvynvxdomy2fezp9y.png"></p><br>
<h2 id="camera-api-v2">Camera API V2</h2><br>
<p>      ,     preview     surface. </p><br>
<p>     :</p><br>
<ul>
<li>  permission-.      <strong>WaitingStart</strong></li>
<li>  camera manager-,   id (   —  back  front,              )  ,   ,  ,  cameraDevice.  <strong>WaitingOpen</strong></li>
</ul><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> manager = getSystemService(Context.CAMERA_SERVICE) <span class="hljs-keyword">as</span> CameraManager
<span class="hljs-keyword">var</span> resultCameraId: String? = <span class="hljs-literal">null</span>
<span class="hljs-keyword">var</span> resultSize: Size? = <span class="hljs-literal">null</span>
<span class="hljs-keyword">for</span> (cameraId <span class="hljs-keyword">in</span> manager.cameraIdList) {
    <span class="hljs-keyword">val</span> chars = manager.getCameraCharacteristics(cameraId)
    <span class="hljs-keyword">val</span> facing = chars.<span class="hljs-keyword">get</span>(CameraCharacteristics.LENS_FACING) ?: -<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> (facing == LENS_FACING_BACK) {
         <span class="hljs-keyword">val</span> confMap = chars.<span class="hljs-keyword">get</span>(<font></font>
            CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP<font></font>
        )<font></font>
        <span class="hljs-keyword">val</span> sizes = confMap?.getOutputSizes(SurfaceTexture::<span class="hljs-keyword">class</span>.java)<font></font>
        resultSize = findSize(sizes)<font></font>
        resultCameraId = cameraId<font></font>
        break<font></font>
    }<font></font>
}<font></font>
resultCameraId?.let { cameraId -&gt; <font></font>
    manager.openCamera(cameraId, <span class="hljs-keyword">object</span> : CameraDevice.StateCallback() {
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">fun</span> onOpened(camera: CameraDevice) {<font></font>
            //Success <span class="hljs-keyword">open</span> camera<font></font>
            ...<font></font>
        }<font></font>
    })<font></font>
}</code></pre><br>
<ul>
<li>         Surface-   .  <strong>WaitingSurface</strong></li>
<li>  cameraDevice, Surface          .  <strong>WaitingSession</strong></li>
</ul><br>
<pre><code class="kotlin hljs">cameraDevice.createCaptureSession(<font></font>
    arrayListOf(surface),<font></font>
    <span class="hljs-keyword">object</span> : CameraCaptureSession.StateCallback() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onConfigured</span><span class="hljs-params">(session: <span class="hljs-type">CameraCaptureSession</span>)</span></span> {<font></font>
            send(CameraAction.SessionReady(session))<font></font>
        }<font></font>
    },<font></font>
    handler<font></font>
)</code></pre><br>
<ul>
<li>    preview.  <strong>StartingPreview</strong></li>
</ul><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> request = cameraDevice.createCaptureRequest(<font></font>
    CameraDevice.TEMPLATE_PREVIEW<font></font>
).apply {<font></font>
    addTarget(surface)<font></font>
}<font></font>
session.setRepeatingRequest(<font></font>
    request.build(),<font></font>
    <span class="hljs-keyword">object</span> : CameraCaptureSession.CaptureCallback() {...}<font></font>
    handler<font></font>
)</code></pre><br>
<p>   :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">CameraMachine.kt</a></p><br>
<p><img src="https://habrastorage.org/webt/i6/tj/q1/i6tjq12xls77hudocvpnt0m6qy0.png"></p><br>
<p><img src="https://habrastorage.org/webt/6w/ad/fp/6wadfpayduldvtqwcrjggkoce6y.png"></p><br>
<h2 id="mediacodec">MediaCodec</h2><br>
<p>MediaCodec       ,     API   input/output  (,  ,     )     (       encoder/decoder),      . </p><br>
<p>  ,       ByteBuffer,       Surface    MediaCodec::createInputSurface,      ,    (           gpu).</p><br>
<p>,        Surface-     GLSurfaceMachine  Surface  MediaCodec-.    : Surface     consumer-   -       .    getBitmap/readImage/…</p><br>
<p>   :    GL           ,        id-     .    GL   Surface  MediaCodec-,   EGLSurface —            OpenGLScene.            .</p><br>
<p>EGL    OpenGL API    ,       grafika.  (EncoderHelper)  MediaCodec-     ,       :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">EncoderMachine.kt</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">EncoderHelper.kt</a></p><br>
<p><img src="https://habrastorage.org/webt/d1/gc/kf/d1gckfqligsrwynmmkq_bb2yzoy.png"></p><br>
<h2 id="itog">:</h2><br>
<ul>
<li>         OpenGL-</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android Media APIは非常に低レベルであり、柔軟性を提供しますが、場合によっては、必要以上に多くのコードを作成する必要があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期APIはStateMachinesでラップできます</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja480866/index.html">Web開発の新時代または「すべてがすでにそこにある」</a></li>
<li><a href="../ja480870/index.html">10年の結果</a></li>
<li><a href="../ja480872/index.html">Intelは6か月前に報告されたセキュリティホールを閉じました</a></li>
<li><a href="../ja480874/index.html">ニュートリノの研究は数学の予想外の発見につながりました</a></li>
<li><a href="../ja480876/index.html">Dockをクリーンアップし、xCodeなしでアプリケーションを作成します</a></li>
<li><a href="../ja480884/index.html">5分でPython GUI</a></li>
<li><a href="../ja480886/index.html">ニューラルネットワークと黄金比：2回目の実行</a></li>
<li><a href="../ja480888/index.html">DIYコルーチン。パート1.レイジージェネレーター</a></li>
<li><a href="../ja480890/index.html">Expressパネルの使用に関する調査結果</a></li>
<li><a href="../ja480892/index.html">バルーンインターネット</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>