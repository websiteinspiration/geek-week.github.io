<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌚 🏧 🧢 Portar APIs a TypeScript como un solucionador de problemas 🦍 🤦🏻 👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La interfaz React del programa Ejecutar se ha convertido de JavaScript a TypeScript. Pero el backend, escrito en Ruby, no se tocó. Sin embargo, los pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Portar APIs a TypeScript como un solucionador de problemas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499664/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interfaz React del programa Ejecutar se ha </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertido</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de JavaScript a TypeScript. Pero el backend, escrito en Ruby, no se tocó. Sin embargo, los problemas asociados con este backend hicieron que los desarrolladores del proyecto pensaran en cambiar de Ruby a TypeScript. La traducción del material que publicamos hoy está dedicada a la historia de portar el backend Ejecutar programa de Ruby a TypeScript, y qué problemas esto ayudó a resolver.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/hu/xl/8o/huxl8onleza7_5gvfndf7s-6sxm.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al usar el backend de Ruby, a veces olvidamos que algunas propiedades de API almacenan una serie de cadenas, no una simple cadena. A veces cambiamos un fragmento de API al que se accedió en diferentes lugares, pero se olvidó de actualizar el código en uno de estos lugares. Estos son los problemas habituales de un lenguaje dinámico que son característicos de cualquier sistema cuyo código no esté 100% cubierto por las pruebas. (Esto, aunque menos común, ocurre cuando el código está completamente cubierto por las pruebas). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, estos problemas han desaparecido de la interfaz desde que lo cambiamos a TypeScript. Tengo más experiencia en la programación del servidor que en el cliente, pero, a pesar de esto, cometí más errores al trabajar con el back-end y no con la interfaz. Todo esto indica que el backend también debe convertirse a TypeScript.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Porté el backend de Ruby a TypeScript en marzo de 2019 en aproximadamente 2 semanas. ¡Y todo funcionó como debería! Implementamos un nuevo código en producción el 14 de abril de 2019. Era una versión beta disponible para un número limitado de usuarios. Después de eso, nada se rompió. Los usuarios ni siquiera notaron nada. Aquí hay un gráfico que ilustra el estado de nuestra base de código antes e inmediatamente después de la transición. El eje x representa el tiempo (en días), el eje y representa el número de líneas de código.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b26/90c/6a7/b2690c6a794a02298ad7b124c812d9d5.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traducción del front-end de JavaScript a TypeScript, y traducción del backend de Ruby a TypeScript</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Durante el proceso de portabilidad, escribí una gran cantidad de código auxiliar. Entonces, tenemos nuestra propia herramienta para ejecutar pruebas con un volumen de 200 líneas. Tenemos una biblioteca de 120 líneas para trabajar con la base de datos, así como una biblioteca de enrutamiento más grande para la API que conecta el código de front-end y back-end.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestra propia infraestructura, lo más interesante para hablar es el enrutador. Es un contenedor para Express, que garantiza la correcta aplicación de los tipos que se utilizan tanto en el código del cliente como del servidor. Esto significa que cuando una parte de la API cambia, la otra ni siquiera se compila sin realizar cambios para eliminar las diferencias.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí hay un controlador de back-end que devuelve una lista de publicaciones de blog. </font><font style="vertical-align: inherit;">Este es uno de los fragmentos de código similares más simples del sistema:</font></font><br>
<br>
<pre><code class="javascript hljs">router.handleGet(api.blog, <span class="hljs-keyword">async</span> () =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">return</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">posts</span>: blog.posts,<font></font>
&nbsp;&nbsp;}<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cambiamos el nombre de la clave </font></font><code>posts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font><code>blogPosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, obtenemos un error de compilación, cuyo texto se muestra a continuación (aquí, por brevedad, se omite la información sobre los tipos de objetos).</font></font><br>
<br>
<pre><code class="javascript hljs">Property <span class="hljs-string">'posts'</span> is missing <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span> but required <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span>.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada punto final está definido por un objeto de vista </font></font><code>api.someNameHere</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este objeto es compartido por el cliente y el servidor. </font><font style="vertical-align: inherit;">Tenga en cuenta que los tipos no se mencionan directamente en la declaración del controlador. </font><font style="vertical-align: inherit;">Todos se infieren del argumento </font></font><code>api.blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque funciona para puntos finales simples, como el punto final descrito anteriormente </font></font><code>blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pero es adecuado para puntos finales más complejos. </font><font style="vertical-align: inherit;">Por ejemplo, una API de punto final para trabajar con lecciones tiene una clave profundamente anidada de tipo lógico </font></font><code>.lesson.steps[index].isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Gracias a todo esto, ahora es imposible cometer los siguientes errores:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si intentamos acceder </font></font><code>isinteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al cliente o intentamos devolver dicha clave del servidor, el código no se compilará. </font><font style="vertical-align: inherit;">El nombre de la clave debería verse </font></font><code>isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con mayúscula </font></font><code>I</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li>     <code>isInteractive</code>  —   .</li>
<li>    <code>isInteractive</code>    <code>number</code>,  , ,  .</li>
<li>     API, ,  <code>isInteractive</code> —  ,    , ,   ,           , , ,  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que todo esto incluye la generación de código. Esto se hace usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io-ts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y un par de cientos de líneas de código de nuestro propio enrutador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Declarar tipos de API requiere trabajo adicional, pero el trabajo es simple. Al cambiar la estructura de la API, necesitamos saber cómo cambia la estructura del código. Hacemos cambios en las declaraciones de la API, y luego el compilador nos señala todos los lugares donde el código necesita ser reparado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es difícil apreciar la importancia de estos mecanismos hasta que los use por un tiempo. Podemos mover objetos grandes de un lugar en la API a otro, cambiar el nombre de las claves, podemos dividir objetos grandes en partes, fusionar objetos pequeños en un objeto, dividir o fusionar puntos finales completos. Y podemos hacer todo esto sin preocuparnos por el hecho de que olvidamos hacer los cambios apropiados en el código del cliente o servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí hay un ejemplo real. Recientemente, pasé unas 20 horas en cuatro días libres rediseñando el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programa de ejecución de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> API </font><font style="vertical-align: inherit;">. Toda la estructura de la API ha cambiado. Al comparar el nuevo código de cliente y servidor con el antiguo, se registraron decenas de miles de cambios de línea. Rediseñé el código de enrutamiento del lado del servidor (como el anterior</font></font><code>handleGet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Reescribí todas las declaraciones de tipo para la API, haciendo muchos de ellos grandes cambios estructurales. Y, además, reescribí todas las partes del cliente en las que se llamaron las API modificadas. Durante este trabajo, se cambiaron 246 de los 292 archivos de origen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la mayoría de este trabajo, me basé solo en un sistema de tipos. En la última hora de este caso de 20 horas, comencé a ejecutar pruebas que, en su mayor parte, terminaron con éxito. Al final, realizamos una serie completa de pruebas y encontramos tres pequeños errores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos estos fueron errores lógicos: condiciones que accidentalmente llevaron al programa al lugar equivocado. Típicamente, un sistema de tipos no ayuda a encontrar tales errores. Tomó varios minutos corregir estos errores. Esta API rediseñada se implementó hace unos meses. Cuando lees algo en</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuestro sitio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : es esta API la que emite materiales relevantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto no significa que el sistema de tipo estático garantice que el código siempre será correcto. Este sistema no permite prescindir de las pruebas. Pero simplifica enormemente la refactorización. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te contaré sobre la generación automática de código. A saber, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esquemas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para generar definiciones de tipo a partir de la estructura de nuestra base de datos. El sistema se conecta a la base de datos Postgres, analiza los tipos de columna y escribe las definiciones de tipo TypeScript correspondientes en el archivo normal </font></font><code>.d.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilizado por la aplicación.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro script de migración mantiene actualizado un archivo con tipos de esquema de base de datos cada vez que se inicia. Debido a esto, no tenemos que admitir manualmente estos tipos. Los modelos usan definiciones de tipos de bases de datos para garantizar que el código de la aplicación acceda correctamente a todo lo almacenado en la base de datos. No faltan tablas, ni columnas faltantes, ni entradas </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en columnas no compatibles </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Recordamos procesar correctamente </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en columnas de soporte </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Y todo esto se comprueba estáticamente en tiempo de compilación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esto en conjunto crea una cadena confiable de transferencia de información de tipo estático, que se extiende desde la base de datos a las propiedades de los componentes React en la interfaz:</font></font><br>
<br>
<ul>
<li>      ,     (    API)     ,          .</li>
<li>     API    ,   API,      (     )  .</li>
<li>  React-   ,   API,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mientras trabajaba en este material, no pude recordar un solo caso de inconsistencia en el código asociado con la API que pasó la compilación. No tuvimos fallas de producción que surgieron porque el código del cliente y del servidor relacionado con la API tenía ideas diferentes sobre el formulario de datos. Y todo esto no es el resultado de pruebas automatizadas. Nosotros, para la API en sí, no escribimos pruebas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto nos coloca en una posición extremadamente agradable: podemos concentrarnos en las partes más importantes de la aplicación. Paso muy poco tiempo haciendo conversiones de tipos. Mucho menos de lo que pasé identificando las causas de errores confusos que penetraron capas de código escritas en Ruby o JavaScript, y luego causaron extrañas excepciones en algún lugar muy lejos de la fuente del error.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Así es como se ve el proyecto después de traducir el backend a TypeScript. </font><font style="vertical-align: inherit;">Como puede ver, se ha escrito mucho código desde la transición. </font><font style="vertical-align: inherit;">Tuvimos suficiente tiempo para evaluar las consecuencias de la decisión.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/298/9b7/9ba/2989b79ba9dc2a646b7ebeac3ba834bd.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TypeScript se utiliza en la interfaz y el backend del proyecto.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aquí no hemos planteado la pregunta habitual para tales publicaciones, que es lograr los mismos resultados no a través de la mecanografía, sino mediante el uso de pruebas. </font><font style="vertical-align: inherit;">Tales resultados no pueden lograrse usando solo pruebas. </font><font style="vertical-align: inherit;">Nosotros, muy posiblemente, hablaremos más sobre esto. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Queridos lectores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Tradujo proyectos escritos en otros idiomas a TypeScript?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499652/index.html">¿Hay vida en desarrollo después del decreto?</a></li>
<li><a href="../es499654/index.html">¿Cómo implementar CRM en un sitio remoto y ganar?</a></li>
<li><a href="../es499656/index.html">Simulación de controlador de temperatura PID</a></li>
<li><a href="../es499658/index.html">¿Un hombre trabajador en lugar de un probador? ¿Vale la pena estudiar Selenium en 2020?</a></li>
<li><a href="../es499662/index.html">Raíz de confianza para IoT y otras tendencias de seguridad de IoT</a></li>
<li><a href="../es499666/index.html">PEP 572 (expresiones de asignación en python 3.8)</a></li>
<li><a href="../es499668/index.html">Road to Hell Dependencias de JavaScript</a></li>
<li><a href="../es499670/index.html">Я перехожу на JavaScript</a></li>
<li><a href="../es499674/index.html">Otro paso para las computadoras ópticas</a></li>
<li><a href="../es499676/index.html">Más de 90 herramientas útiles para Kubernetes: implementación, administración, monitoreo, seguridad y más</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>