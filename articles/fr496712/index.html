<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜– ğŸš´ğŸ¼ ğŸ›ŒğŸ¾ Une fois Ã  un pentest, ou Comment tout casser avec l'aide d'un urologue et de Roskomnadzor ğŸ›©ï¸ ğŸ‘ŒğŸ½ ğŸ¤—</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est basÃ© sur un pentest trÃ¨s rÃ©ussi, qui a Ã©tÃ© rÃ©alisÃ© par des spÃ©cialistes du Groupe IB il y a quelques annÃ©es: une histoire s'est produi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Une fois Ã  un pentest, ou Comment tout casser avec l'aide d'un urologue et de Roskomnadzor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article est basÃ© sur un pentest trÃ¨s rÃ©ussi, qui a Ã©tÃ© rÃ©alisÃ© par des spÃ©cialistes du Groupe IB il y a quelques annÃ©es: une histoire s'est produite qui prÃ©tend Ãªtre une adaptation cinÃ©matographique Ã  Bollywood. Maintenant, probablement, la rÃ©action du lecteur suivra: "Oh, un autre article de relations publiques, encore une fois ceux-ci sont dessinÃ©s, Ã  quel point ils sont bons, n'oubliez pas d'acheter un pentest." Eh bien, d'une part, Ã§a l'est. Cependant, il existe un certain nombre de raisons pour lesquelles cet article est apparu. Je voulais montrer ce que font exactement les pentesters, Ã  quel point ce travail peut Ãªtre intÃ©ressant et non trivial, quelles circonstances amusantes peuvent se dÃ©velopper sur des projets, et surtout, montrer du matÃ©riel en direct avec des exemples rÃ©els.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour rÃ©tablir l'Ã©quilibre de la modestie dans le monde, aprÃ¨s un certain temps, nous Ã©crirons sur le penteste, qui n'a pas disparu. </font><font style="vertical-align: inherit;">Nous montrons comment des processus bien Ã©tablis dans une entreprise peuvent protÃ©ger contre toute une gamme d'attaques, mÃªme bien prÃ©parÃ©es, simplement parce que ces processus existent et fonctionnent vraiment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client de cet article, aussi, tout allait bien en gÃ©nÃ©ral, au moins mieux que 95% du marchÃ© en FÃ©dÃ©ration de Russie, selon nos sentiments, mais il y avait un certain nombre de nuances mineures qui ont formÃ© une longue chaÃ®ne d'Ã©vÃ©nements, ce qui a conduit d'abord Ã  un long rapport sur le travail , puis Ã  cet article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, faites le plein de pop-corn et bienvenue au dÃ©tective. </font><font style="vertical-align: inherit;">Je </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donne la parole Ã  Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , directeur technique de l'Audit and Consulting Group-IB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 1. Docteur Pochkin </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AnnÃ©e 2018. Il y a un client - une entreprise informatique de haute technologie qui sert elle-mÃªme de nombreux clients. Il souhaite obtenir une rÃ©ponse Ã  la question: est-il possible, sans aucune connaissance et accÃ¨s initiaux, via Internet, d'obtenir des droits d'administrateur pour un domaine Active Directory? Aucune ingÃ©nierie sociale n'est intÃ©ressante ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hein, mais en vain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), elles ne vont pas spÃ©cifiquement interfÃ©rer avec le travail, mais elles peuvent recharger accidentellement un serveur Ã©trange, par exemple. Une tÃ¢che supplÃ©mentaire consiste Ã  identifier autant d'autres vecteurs d'attaque que possible par rapport au pÃ©rimÃ¨tre externe. La sociÃ©tÃ© effectue rÃ©guliÃ¨rement de tels tests, et maintenant la date limite pour un nouveau test. Les conditions sont presque typiques, adÃ©quates, comprÃ©hensibles. Descendre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un nom de client - que ce soit "Entreprise", avec le site principal </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Bien sÃ»r, le client est appelÃ© diffÃ©remment, mais dans cet article, tout sera dÃ©personnalisÃ©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je mÃ¨ne une veille rÃ©seau - je dÃ©couvre les adresses et domaines rÃ©pertoriÃ©s par le client, dessine un schÃ©ma de rÃ©seau, comment les services sont distribuÃ©s Ã  ces adresses. J'obtiens le rÃ©sultat: plus de 4000 adresses IP en direct. Je regarde Ã  travers les domaines de ces rÃ©seaux: heureusement, la grande majoritÃ© sont des rÃ©seaux destinÃ©s aux clients clients, et ils ne nous intÃ©ressent pas formellement. Le client est du mÃªme avis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste un rÃ©seau avec 256 adresses, pour lequel Ã  ce stade il y a dÃ©jÃ  une comprÃ©hension de la distribution des domaines et des sous-domaines par adresses IP, il y a des informations sur les ports scannÃ©s, ce qui signifie que vous pouvez regarder les services pour les plus intÃ©ressants avec vos yeux. En parallÃ¨le, toutes sortes de scanners sont lancÃ©s Ã  des adresses IP accessibles et sÃ©parÃ©ment - sur des sites Web.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup de services. C'est gÃ©nÃ©ralement une joie pour le pentester et l'anticipation d'une victoire rapide, car plus il y a de services, plus le champ d'attaque est grand et plus il est facile de trouver un artefact. Un rapide coup d'Å“il sur les sites Web a montrÃ© que la plupart d'entre eux sont des interfaces Web des produits bien connus des grandes entreprises mondiales qui disent qu'ils ne sont pas satisfaits de vous. Ils demandent un nom d'utilisateur et un mot de passe, Ã  partir du seuil oÃ¹ ils secouent le champ pour entrer le deuxiÃ¨me facteur, ils demandent un certificat client TLS ou les envoient Ã  Microsoft ADFS. Certains sont tout simplement indisponibles sur Internet. Pour certains, vous devez Ã©videmment avoir un client payant spÃ©cial pour trois salaires ou connaÃ®tre l'URL exacte Ã  saisir. Nous allons omettre une autre semaine de dÃ©couragement progressif dans le processus visant Ã  "traverser" le logiciel par version pour les vulnÃ©rabilitÃ©s connues, rechercher des contenus cachÃ©s dans les chemins Web et les fuites de comptes de services tiers tels que LinkedIn,tente de sÃ©lectionner des mots de passe pour eux, ainsi que de creuser des vulnÃ©rabilitÃ©s dans des sites Web auto-dÃ©crits - Ã  propos, selon les statistiques, c'est le vecteur le plus prometteur d'une attaque externe Ã  ce jour. ImmÃ©diatement, je note le pistolet de cinÃ©ma, qui a ensuite tirÃ©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait donc deux sites qui se dÃ©marquaient de centaines de services. Ces sites avaient une chose en commun: si vous ne vous engagez pas dans une reconnaissance mÃ©ticuleuse du rÃ©seau par domaine, mais que vous recherchez Â«sur le devantÂ» des ports ouverts ou empoisonnez le scanner de vulnÃ©rabilitÃ© sur une plage IP connue, alors ces sites vont se passer de la vÃ©rification, ils ne seront tout simplement pas visibles sans connaÃ®tre le nom DNS. Peut-Ãªtre ont-ils Ã©tÃ© manquÃ©s plus tÃ´t, du moins, et nos outils automatiques n'y ont pas trouvÃ© de problÃ¨mes, mÃªme s'ils Ã©taient dÃ©finis directement sur la ressource.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, sur le fait que les scanners prÃ©cÃ©demment lancÃ©s ont Ã©tÃ© gÃ©nÃ©ralement trouvÃ©s. Permettez-moi de vous rappeler: pour certains, Â«pentestÂ» Ã©quivaut Ã  Â«numÃ©risation automatisÃ©eÂ». Et les scanners de ce projet n'ont rien dit. Eh bien, les vulnÃ©rabilitÃ©s moyennes ont montrÃ© le maximum (3 sur 5 en termes de danger): certains services ont un mauvais certificat TLS ou des algorithmes de cryptage obsolÃ¨tes, et la plupart des sites ont un dÃ©tournement de clic. Mais lÃ -dessus, vous n'atteindrez pas l'objectif. Les scanners seraient probablement plus utiles ici, mais permettez-moi de vous rappeler: le client lui-mÃªme est en mesure d'acheter de tels programmes et de se tester avec eux, et Ã  en juger par les rÃ©sultats ternes, il l'a dÃ©jÃ  vÃ©rifiÃ©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retour aux sites "anormaux". Le premier est quelque chose comme un Wiki local Ã  une adresse non standard, mais laissez wiki.company [.] Ru figurer dans cet article. Elle a Ã©galement immÃ©diatement demandÃ© un nom d'utilisateur et un mot de passe, mais dÃ©jÃ  via NTLM dans le navigateur. Pour l'utilisateur, cela ressemble Ã  une fenÃªtre ascÃ©tique demandant un nom d'utilisateur et un mot de passe. Et c'est une mauvaise pratique.</font></font><br>
<br>
<blockquote> . NTLM  -      .   â€”    Active Directory.       company.ru,   Â«Â» DNS-.  ,    - ,        ,    - .  â€”        NTLM (, ?),     Â«Â» ,         .    ,      .         â€”  ,    .  â€”       .         â€” , ,  .  â€”   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une mauvaise caractÃ©ristique des produits Microsoft: mÃªme si vous n'avez pas spÃ©cifiquement publiÃ© un tel NTLM, il sera au moins dans l'installation par dÃ©faut dans OWA et Lync. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, l'auteur de cet article a bloquÃ© une fois de la mÃªme maniÃ¨re accidentellement environ 1 000 comptes d'employÃ©s d'une grande banque en une heure seulement, puis a eu un aspect un peu pÃ¢le. </font><font style="vertical-align: inherit;">Les services informatiques de la banque Ã©taient Ã©galement pÃ¢les, mais tout s'est bien terminÃ© et nous avons mÃªme Ã©tÃ© fÃ©licitÃ©s d'avoir Ã©tÃ© les premiers Ã  trouver ce problÃ¨me et provoquÃ© une correction rapide et dÃ©cisive.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le deuxiÃ¨me site avait l'adresse "Ã©videmment-un-nom.company.ru". </font><font style="vertical-align: inherit;">TrouvÃ© via Google, quelque chose comme Ã§a Ã  la page 10. </font><font style="vertical-align: inherit;">Le design commence au milieu des annÃ©es 2000, et une personne respectable a regardÃ© la page principale, quelque chose comme ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis il a pris un cadre de "Dogâ€™s Heart", mais croyez-moi, il Ã©tait Ã  peu prÃ¨s similaire, mÃªme la palette de couleurs dans des couleurs similaires. Que le site s'appelle </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'Ã©tait un site personnel ... d'un urologue. Il est devenu intÃ©ressant de voir ce que fait le site de l'urologue sur le sous-domaine d'une entreprise de haute technologie. Une brÃ¨ve fouille chez Google a montrÃ© que ce mÃ©decin Ã©tait co-fondateur de l'une des personnes morales de notre client et a mÃªme contribuÃ© environ 1000 roubles de capital social. Le site a probablement Ã©tÃ© crÃ©Ã© il y a de nombreuses annÃ©es et les ressources du serveur du client ont Ã©tÃ© utilisÃ©es comme hÃ©bergement. Le site a depuis longtemps perdu sa pertinence, mais pour une raison quelconque, il est restÃ© longtemps opÃ©rationnel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En termes de vulnÃ©rabilitÃ©s, le site Web lui-mÃªme Ã©tait sÃ»r. Pour l'avenir, je dirai qu'il s'agissait d'un ensemble de statistiques - de simples pages html avec des insertions d'illustrations sous forme de reins et de vessies. "Briser" un tel site est inutile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le serveur Web en dessous Ã©tait plus intÃ©ressant. Ã€ en juger par l'en-tÃªte du serveur HTTP, il y avait IIS 6.0, ce qui signifie que Windows 2003 a Ã©tÃ© utilisÃ© comme systÃ¨me d'exploitation. Le scanner a prÃ©cÃ©demment rÃ©vÃ©lÃ© que ce site Web particulier de l'urologue, contrairement Ã  d'autres hÃ´tes virtuels sur le mÃªme serveur Web, avait rÃ©pondu Ã  la commande PROPFIND, c'est-Ã -dire que WebDAV y avait fonctionnÃ©. Soit dit en passant, le scanner a Ã©mis ces informations avec la marque Info (dans la langue des rapports du scanner, c'est le danger le plus faible) - de telles choses sont gÃ©nÃ©ralement simplement ignorÃ©es. En combinaison, cela a donnÃ© un effet intÃ©ressant, qui n'a Ã©tÃ© rÃ©vÃ©lÃ© qu'aprÃ¨s une nouvelle fouille dans Google: une vulnÃ©rabilitÃ© de dÃ©bordement de tampon rare associÃ©e Ã  un ensemble de Shadow Brokers, Ã  savoir CVE-2017-7269, qui avait dÃ©jÃ  un exploit prÃªt. En d'autres termes, ce sera un dÃ©sastre si vous avez Windows 2003 et WebDAV s'exÃ©cute sur IIS.Bien que travaillant dans la production de Windows 2003 en 2018, c'est en soi une catastrophe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exploit s'est retrouvÃ© dans Metasploit et a Ã©tÃ© immÃ©diatement testÃ© avec une charge qui a envoyÃ© une requÃªte DNS Ã  un service contrÃ´lÃ© - Burp Collaborator est traditionnellement utilisÃ© pour intercepter les requÃªtes DNS. Ã‰tonnamment, cela a fonctionnÃ© la premiÃ¨re fois: une secousse a Ã©tÃ© reÃ§ue dans DNS. Ensuite, il y a eu une tentative de crÃ©ation d'une connexion dorsale via le port 80 (c'est-Ã -dire une connexion rÃ©seau du serveur Ã  l'attaquant, avec accÃ¨s Ã  cmd.exe sur l'hÃ´te victime), mais un fiasco s'est produit. La connexion n'est pas venue et aprÃ¨s la troisiÃ¨me tentative d'opÃ©ration, le site, avec toutes les images divertissantes, a disparu pour de bon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, cela est suivi d'une lettre dans le style "client, rÃ©veille-toi, nous avons tout laissÃ© tomber". Mais on nous a dit que le site n'a rien Ã  voir avec les processus mÃ©tier et y fonctionne en gÃ©nÃ©ral, on ne sait pas pourquoi, comme l'ensemble du serveur, et que nous pouvons utiliser cette ressource Ã  notre guise.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s environ une journÃ©e, le site a soudainement commencÃ© Ã  fonctionner de lui-mÃªme. AprÃ¨s avoir construit un stand Ã  partir de WebDAV sur IIS 6.0, j'ai constatÃ© que le paramÃ¨tre par dÃ©faut est de redÃ©marrer les workflows IIS toutes les 30 heures. Autrement dit, lorsque le contrÃ´le est sorti du code shell, le flux de travail IIS s'est terminÃ©, puis il a redÃ©marrÃ© plusieurs fois lui-mÃªme, puis s'est arrÃªtÃ© pendant 30 heures.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis la premiÃ¨re fois que bekconnect sur TCP a Ã©chouÃ©, j'ai annulÃ© ce problÃ¨me sur un port fermÃ©. </font><font style="vertical-align: inherit;">Autrement dit, il a suggÃ©rÃ© la prÃ©sence d'un pare-feu qui ne laissait pas sortir les connexions sortantes. </font><font style="vertical-align: inherit;">J'ai commencÃ© Ã  exÃ©cuter des codes shell qui trient Ã  travers de nombreux ports TCP et UDP, il n'y avait aucun effet. </font><font style="vertical-align: inherit;">La connexion inverse se charge via http (s) de Metasploit - meterpreter / reverse_http (s) ne fonctionne pas. </font><font style="vertical-align: inherit;">Soudain, la connexion au mÃªme port 80 a Ã©tÃ© Ã©tablie, mais a immÃ©diatement Ã©tÃ© rompue. </font><font style="vertical-align: inherit;">Il l'a dÃ©duit de l'action de l'IPS encore imaginaire, qui n'aimait pas le trafic mÃ©trique. </font><font style="vertical-align: inherit;">Ã€ la lumiÃ¨re du fait que la connexion de TCP pur au port 80 a Ã©chouÃ©, mais http l'a fait, j'ai conclu que le proxy http Ã©tait en quelque sorte configurÃ© dans le systÃ¨me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TestÃ© mÃªme mÃ¨tre mÃ¨tre via DNS (merci</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour ses efforts, a sauvÃ© de nombreux projets), rappelant le tout premier succÃ¨s, mais il n'a mÃªme pas travaillÃ© sur le stand - le code shell Ã©tait trop volumineux pour cette vulnÃ©rabilitÃ©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En rÃ©alitÃ©, cela ressemblait Ã  ceci: 3-4 tentatives d'attaque dans les 5 minutes, puis attendez 30 heures. Et donc pendant trois semaines consÃ©cutives. J'ai mÃªme mis en place un rappel pour ne pas perdre de temps. De plus, il y avait une diffÃ©rence dans le comportement des environnements de test et de combat: il y avait deux exploits similaires pour cette vulnÃ©rabilitÃ©, l'un de Metasploit, le second d'Internet, refait Ã  partir de la version Shadow Brokers. Ainsi, au combat, seul Metasploit a fonctionnÃ©, sur le stand - seulement le second, ce qui a compliquÃ© le dÃ©bogage et brisÃ© le cerveau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au final, le code shell s'est avÃ©rÃ© efficace, qui a tÃ©lÃ©chargÃ© un fichier exe depuis un serveur donnÃ© via http et l'a exÃ©cutÃ© sur le systÃ¨me cible. Le shellcode Ã©tait assez petit pour tenir, et au moins cela a fonctionnÃ©. Ã‰tant donnÃ© que le serveur TCP n'aimait pas du tout le trafic et que http (s) a Ã©tÃ© inspectÃ© pour meterpreter, j'ai dÃ©cidÃ© que le moyen le plus rapide Ã©tait de tÃ©lÃ©charger le fichier exe qui contenait le DNS-meterpreter via ce shellcode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LÃ  encore, le problÃ¨me s'est posÃ©: lors du tÃ©lÃ©chargement du fichier exe et, comme les tentatives l'ont montrÃ©, quoi qu'il en soit, le tÃ©lÃ©chargement a Ã©tÃ© interrompu. </font><font style="vertical-align: inherit;">Encore une fois, une sorte de dispositif de sÃ©curitÃ© entre mon serveur et l'urologue n'aimait pas le trafic http avec exe Ã  l'intÃ©rieur. </font><font style="vertical-align: inherit;">Cela semblait Ãªtre une solution Â«rapideÂ» pour changer le shellcode afin qu'il obscurcisse le trafic http Ã  la volÃ©e, afin que les donnÃ©es binaires abstraites soient transfÃ©rÃ©es au lieu d'exe. </font><font style="vertical-align: inherit;">Enfin, l'attaque a rÃ©ussi, le contrÃ´le est passÃ© par le canal DNS fin:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est immÃ©diatement devenu clair que j'avais les droits les plus simples sur le workflow IIS qui me permettent de ne rien faire. </font><font style="vertical-align: inherit;">Voici Ã  quoi cela ressemblait sur la console Metasploit:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les mÃ©thodologies pentest suggÃ¨rent fortement que vous devez augmenter les droits lors de l'accÃ¨s. Habituellement, je ne le fais pas localement, car le tout premier accÃ¨s est considÃ©rÃ© simplement comme un point d'entrÃ©e rÃ©seau, et compromettre une autre machine sur le mÃªme rÃ©seau est gÃ©nÃ©ralement plus facile et plus rapide que l'augmentation des privilÃ¨ges sur un hÃ´te existant. Mais ce n'est pas le cas, car le canal DNS est trÃ¨s Ã©troit et il ne permettra pas au trafic de se dÃ©placer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En supposant que ce serveur avec Windows 2003 n'a pas Ã©tÃ© rÃ©parÃ© Ã  partir de la vulnÃ©rabilitÃ© bien connue MS17-010, je tunnelise le trafic vers le port 445 / TCP via le tunnel DNS meterpreter vers localhost (oui, cela est Ã©galement possible) et j'essaie d'exÃ©cuter un exe prÃ©cÃ©demment tÃ©lÃ©chargÃ© via la vulnÃ©rabilitÃ©. L'attaque fonctionne, j'obtiens une deuxiÃ¨me connexion, mais avec les privilÃ¨ges SYSTEM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fait intÃ©ressant, le serveur essayait toujours de se protÃ©ger contre MS17-010 - il avait dÃ©sactivÃ© les services rÃ©seau vulnÃ©rables sur l'interface externe. </font><font style="vertical-align: inherit;">Cela protÃ¨ge vraiment contre les attaques via le rÃ©seau, mais l'attaque de l'intÃ©rieur de l'hÃ´te local a fonctionnÃ©, car vous ne pouvez pas simplement prendre et dÃ©sactiver rapidement SMB sur localhost.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, de nouveaux dÃ©tails intÃ©ressants sont rÃ©vÃ©lÃ©s:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec les autorisations SYSTEM, vous pouvez facilement installer une connexion arriÃ¨re via TCP. </font><font style="vertical-align: inherit;">De toute Ã©vidence, l'interdiction de TCP direct est exclusivement un problÃ¨me utilisateur limitÃ© IIS. </font><font style="vertical-align: inherit;">Spoiler: le trafic des utilisateurs IIS Ã©tait en quelque sorte enveloppÃ© dans le proxy ISA local dans les deux sens. </font><font style="vertical-align: inherit;">Comment cela fonctionne exactement n'est pas reproduit.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je suis dans une certaine Â«DMZÂ» (et ce n'est pas un domaine Active Directory, mais WORKGROUP) - cela semble logique. </font><font style="vertical-align: inherit;">Mais au lieu de l'adresse IP privÃ©e ("grise") attendue, je suis plutÃ´t "blanche", exactement la mÃªme que celle que j'ai attaquÃ©e plus tÃ´t. </font><font style="vertical-align: inherit;">Cela signifie que la sociÃ©tÃ© est tellement ancienne pour le monde de l'adressage IPv4 qu'elle peut se permettre de garder la zone DMZ Ã  128 adresses Â«blanchesÂ» sans NAT selon le schÃ©ma, comme cela a Ã©tÃ© illustrÃ© dans les manuels Cisco 2005.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur Ã©tant ancien, Mimikatz est garanti de fonctionner directement depuis la mÃ©moire:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'obtiens le mot de passe de l'administrateur local, je tunnel le trafic RDP via TCP et je vais dans un bureau confortable. </font><font style="vertical-align: inherit;">Ã‰tant donnÃ© que vous pouvez faire quoi que ce soit avec le serveur, je supprime l'antivirus, je trouve que le serveur est accessible Ã  partir d'Internet uniquement sur les ports TCP 80 et 443, et 443 n'Ã©tait pas occupÃ©. </font><font style="vertical-align: inherit;">J'Ã©lÃ¨ve le serveur OpenVPN Ã  443, j'ajoute les fonctions NAT pour mon trafic VPN et j'obtiens un accÃ¨s direct au rÃ©seau DMZ sous une forme illimitÃ©e via mon OpenVPN. </font><font style="vertical-align: inherit;">Il est Ã  noter que l'ISA, avec certaines fonctionnalitÃ©s IPS non dÃ©sactivables, a bloquÃ© mon trafic avec une analyse de port, pour laquelle il a dÃ» Ãªtre remplacÃ© par un RRAS plus simple et plus flexible. </font><font style="vertical-align: inherit;">Les pentesters doivent donc parfois tout administrer.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un lecteur attentif demandera: "Et quel est le deuxiÃ¨me site - un wiki avec authentification NTLM, sur lequel tant de choses ont Ã©tÃ© Ã©crites?" </font><font style="vertical-align: inherit;">Ã€ ce sujet plus loin.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 2. N'Ãªtes-vous toujours pas en train de chiffrer? </font><font style="vertical-align: inherit;">Ensuite, nous </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allons Ã  vous</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dÃ©jÃ  ici</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a donc accÃ¨s au segment de rÃ©seau DMZ. </font><font style="vertical-align: inherit;">Vous devez vous adresser Ã  l'administrateur du domaine. </font><font style="vertical-align: inherit;">La premiÃ¨re chose qui me vient Ã  l'esprit est de vÃ©rifier automatiquement la sÃ©curitÃ© des services Ã  l'intÃ©rieur du segment DMZ, d'autant plus qu'ils sont dÃ©sormais beaucoup plus ouverts Ã  la recherche. </font><font style="vertical-align: inherit;">Une image typique dans un test de pÃ©nÃ©tration: le pÃ©rimÃ¨tre externe est mieux protÃ©gÃ© que les services internes, et lorsque vous obtenez un accÃ¨s Ã  une grande infrastructure, il est beaucoup plus facile d'obtenir des droits Ã©tendus dans un domaine uniquement parce que ce domaine commence Ã  Ãªtre accessible pour les outils, et deuxiÃ¨mement, il y a toujours quelques problÃ¨mes critiques dans l'infrastructure pour plusieurs milliers d'hÃ´tes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je charge des scanners sur DMZ via le tunnel OpenVPN, j'attends. J'ouvre le rapport - encore une fois rien de grave, apparemment quelqu'un a marchÃ© de la mÃªme maniÃ¨re vers moi. L'Ã©tape suivante consiste Ã  examiner comment les hÃ´tes communiquent au sein du rÃ©seau DMZ. Pour ce faire, pour commencer, un Wireshark rÃ©gulier est lancÃ© avec l'Ã©coute des requÃªtes de diffusion, principalement ARP. Les colis ARP ont Ã©tÃ© collectÃ©s toute la journÃ©e. Il s'avÃ¨re que plusieurs passerelles sont utilisÃ©es dans ce segment. Cela vous sera utile plus tard. En collant des donnÃ©es sur les donnÃ©es de rÃ©ponse aux requÃªtes ARP et de numÃ©risation de port, j'ai trouvÃ© les points de sortie du trafic utilisateur Ã  partir du rÃ©seau local en plus des services qui Ã©taient auparavant connus, tels que le Web et la messagerie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pour le moment je n'avais pas accÃ¨s Ã  d'autres systÃ¨mes et qu'il n'y avait pas un seul compte pour les services d'entreprise, il a Ã©tÃ© dÃ©cidÃ© de rÃ©cupÃ©rer au moins une partie du trafic Ã  l'aide d'ARP Spoofing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel a Ã©tÃ© lancÃ© sur le serveur de l'urologue. </font><font style="vertical-align: inherit;">Compte tenu des flux de trafic identifiÃ©s, les paires les plus prometteuses ont Ã©tÃ© sÃ©lectionnÃ©es pour l'attaque Â«homme au milieuÂ», puis par un dÃ©marrage Ã  court terme pendant 5 Ã  10 minutes, avec une minuterie pour redÃ©marrer le serveur en cas de Â«gelÂ», du trafic rÃ©seau a Ã©tÃ© reÃ§u. </font><font style="vertical-align: inherit;">Comme dans la blague, il y avait deux nouvelles:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bon: beaucoup d'informations d'identification ont Ã©tÃ© capturÃ©es et l'attaque dans son ensemble a fonctionnÃ©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mauvais: toutes les informations d'identification provenaient des clients du client lui-mÃªme. </font><font style="vertical-align: inherit;">Fournissant des services d'assistance, des spÃ©cialistes du client connectÃ©s Ã  des services client qui n'ont pas toujours configurÃ© le chiffrement du trafic.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consÃ©quence, je me suis emparÃ© de nombreuses informations d'identification qui Ã©taient inutiles dans le contexte du projet, mais certainement intÃ©ressantes comme dÃ©monstration du danger d'une attaque. Routeurs frontaliers de grandes entreprises avec telnet, transfert des ports http de dÃ©bogage vers CRM interne avec toutes les donnÃ©es, accÃ¨s direct Ã  RDP depuis Windows XP sur le rÃ©seau local et autres obscurantismes. Il s'est avÃ©rÃ© une sorte de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compromis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">la chaÃ®ne d'approvisionnement selon la matrice MITRE</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Ã©galement trouvÃ© une occasion amusante de collecter des e-mails provenant du trafic, quelque chose comme Ã§a. Ceci est un exemple d'une lettre finie qui est passÃ©e de notre client au port SMTP de son client, encore une fois, sans cryptage. Un certain Andrei demande Ã  son homonyme de renvoyer la documentation, qui est disposÃ©e sur un disque cloud avec un nom d'utilisateur, un mot de passe et un lien dans une lettre de rÃ©ponse:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci est un autre rappel que vous devez crypter tous les services. On ne sait pas qui et quand lira et appliquera spÃ©cifiquement vos donnÃ©es - un fournisseur, un administrateur systÃ¨me d'une autre entreprise ou un tel pentester. Je suis silencieux que beaucoup peuvent simplement intercepter le trafic non chiffrÃ©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MalgrÃ© le succÃ¨s apparent, cela n'a pas Ã©tÃ© rapprochÃ© de l'objectif. Il Ã©tait possible, bien sÃ»r, de rester longtemps assis et d'obtenir des informations prÃ©cieuses, mais pas le fait qu'elles y seraient apparues, et l'attaque elle-mÃªme est trÃ¨s risquÃ©e en termes d'intÃ©gritÃ© du rÃ©seau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s une nouvelle fouille dans les services, une idÃ©e intÃ©ressante m'est venue Ã  l'esprit. Il existe un tel utilitaire appelÃ© Responder (il est facile de trouver des exemples d'applications de ce nom), qui, en Â«empoisonnantÂ» les demandes de diffusion, provoque des connexions sur une variÃ©tÃ© de protocoles tels que SMB, HTTP, LDAP, etc. de diffÃ©rentes maniÃ¨res, chaque personne qui se connecte est invitÃ©e Ã  s'authentifier et Ã  s'ajuster pour que l'authentification passe par NTLM et dans un mode transparent pour la victime. Le plus souvent, un attaquant recueille ainsi des poignÃ©es de main NetNTLMv2 et d'eux, selon le dictionnaire, rÃ©cupÃ¨re rapidement les mots de passe du domaine utilisateur. Je voulais quelque chose de similaire ici, mais les utilisateurs Ã©taient assis Â«derriÃ¨re le murÂ», ou plutÃ´t, ils Ã©taient sÃ©parÃ©s par un pare-feu, et sur le WEB, ils Ã©taient passÃ©s par le cluster proxy Blue Coat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelez-vous, j'ai spÃ©cifiÃ© que le nom de domaine Active Directory coÃ¯ncidait avec le domaine "externe", c'est-Ã -dire Ã©tait company.ru? Ainsi, Windows, plus prÃ©cisÃ©ment Internet Explorer (et Edge et Chrome), permettent Ã  l'utilisateur de s'authentifier de maniÃ¨re transparente en HTTP via NTLM, s'il considÃ¨re que le site se trouve dans une Â«zone intranetÂ». L'un des signes de Â«l'intranetÂ» est un appel Ã  une adresse IP Â«griseÂ» ou Ã  un nom DNS court, c'est-Ã -dire sans points. Puisqu'un serveur avec un nom IP et DNS Â«blancÂ» preobrazhensky.company.ru Ã©tait Ã  sa disposition, et que les machines de domaine obtiennent gÃ©nÃ©ralement le suffixe de domaine Active Directory via DHCP pour simplifier la saisie du nom, elles n'avaient qu'Ã  Ã©crire l'URL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">preobrazhensky</font></a><font style="vertical-align: inherit;"> dans la barre d'adresse</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin qu'ils trouvent le bon chemin vers un serveur urologue compromis, sans oublier qu'il s'appelle dÃ©sormais "Intranet". </font><font style="vertical-align: inherit;">C'est-Ã -dire, en mÃªme temps me donner l'utilisateur de la poignÃ©e de main NTLM Ã  son insu. </font><font style="vertical-align: inherit;">Reste Ã  faire rÃ©flÃ©chir les navigateurs clients sur l'urgence d'accÃ©der Ã  ce serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le merveilleux utilitaire Intercepter-NG est venu Ã  la rescousse (merci</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intercepter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Il vous a permis de modifier le trafic lors de vos dÃ©placements et a parfaitement fonctionnÃ© sur Windows 2003. Il y avait mÃªme une fonctionnalitÃ© distincte pour modifier uniquement les fichiers JavaScript dans le flux de trafic. Il Ã©tait prÃ©vu une sorte de Cross-Site Scripting massif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mandataires Blue Coat par le biais desquels les utilisateurs ont accÃ©dÃ© au contenu statique global du WEB mis en cache pÃ©riodiquement. En interceptant le trafic, il Ã©tait clair qu'ils fonctionnaient 24 heures sur 24, demandant sans cesse des statistiques frÃ©quemment utilisÃ©es pour accÃ©lÃ©rer l'affichage du contenu pendant les heures de pointe. De plus, BlueCoat avait un agent utilisateur spÃ©cifique, qui le distinguait clairement d'un utilisateur vivant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javascript a Ã©tÃ© prÃ©parÃ©, ce qui, avec l'aide d'Intercepter-NG la nuit, a passÃ© une heure entiÃ¨re Ã  implÃ©menter chaque rÃ©ponse avec des fichiers JS pour Blue Coat. Le script a fait ce qui suit:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DÃ©tectÃ© le navigateur actuel par User-Agent. </font><font style="vertical-align: inherit;">Si c'Ã©tait Internet Explorer, Edge ou Chrome - cela fonctionnait.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendu que le DOM de la page soit formÃ©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai insÃ©rÃ© une image invisible avec l'attribut src du type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky dans le DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / NNNNNNN.png, oÃ¹ NNN sont des chiffres arbitraires afin que BlueCoat ne cache pas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DÃ©finissez une variable indicateur globale indiquant que l'injection a Ã©tÃ© effectuÃ©e et que vous n'avez plus besoin d'insÃ©rer d'images.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le navigateur a essayÃ© de charger cette image, sur le port 8080 du serveur compromis, il attendait le tunnel TCP vers mon ordinateur portable, oÃ¹ le mÃªme rÃ©pondeur a Ã©tÃ© lancÃ©, ce qui nÃ©cessite une connexion NTLM Ã  partir du navigateur.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A en juger par les journaux du RÃ©pondant, le matin, les gens sont venus travailler, ont allumÃ© leur poste de travail, puis ont commencÃ© Ã  visiter le serveur de l'urologue en masse et de maniÃ¨re invisible, sans oublier de Â«fusionnerÂ» les poignÃ©es de main NTLM. </font><font style="vertical-align: inherit;">Des poignÃ©es de main ont plu toute la journÃ©e et ont clairement accumulÃ© du matÃ©riel pour une attaque de rÃ©cupÃ©ration de mot de passe notoirement rÃ©ussie. </font><font style="vertical-align: inherit;">Voici Ã  quoi ressemblaient les journaux du rÃ©pondeur:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visites massives et secrÃ¨tes des utilisateurs sur le serveur de l'urologue</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous avez probablement dÃ©jÃ  remarquÃ© que toute cette histoire est construite sur le principe "tout allait bien, mais il y avait une dÃ©ception, puis il y avait du dÃ©passement, et puis tout est arrivÃ© au succÃ¨s". </font><font style="vertical-align: inherit;">Donc, il y avait une dÃ©ception. </font><font style="vertical-align: inherit;">Sur les cinq cents poignÃ©es de main uniques, aucune n'a Ã©tÃ© rÃ©vÃ©lÃ©e. </font><font style="vertical-align: inherit;">Et cela tient compte du fait que mÃªme sur un ordinateur portable avec un processeur mort, ces poignÃ©es de main NTLMv2 dÃ©passent la vitesse de plusieurs centaines de millions de tentatives par seconde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai dÃ» m'armer de techniques de mutation de mot de passe, d'une carte graphique, d'un dictionnaire plus Ã©pais et attendre. </font><font style="vertical-align: inherit;">AprÃ¨s un long moment, plusieurs comptes avec des mots de passe de la forme Â«Q11111111 ... .1111111qÂ» ont Ã©tÃ© ouverts, ce qui suggÃ¨re que tous les utilisateurs ont Ã©tÃ© une fois contraints de proposer un mot de passe trÃ¨s long avec une casse de caractÃ¨res diffÃ©rente, ce qui Ã©tait censÃ© Ãªtre compliquÃ©. </font><font style="vertical-align: inherit;">Mais vous ne pouvez pas simplement Ã©chouer un utilisateur chevronnÃ©, et de cette faÃ§on, il a rendu la mÃ©moire plus facile. </font><font style="vertical-align: inherit;">Au total, environ 5 piÃ¨ces ont Ã©tÃ© ouvertes, et une seule d'entre elles avait des droits prÃ©cieux sur les services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 3. Roskomnadzor contre-attaque</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, les premiers comptes de domaine ont Ã©tÃ© reÃ§us. </font><font style="vertical-align: inherit;">Si Ã  ce stade vous ne vous Ãªtes pas endormi aprÃ¨s une longue lecture, vous vous souviendrez probablement que j'ai mentionnÃ© un service qui ne nÃ©cessitait pas de second facteur d'authentification: il s'agit d'un wiki avec authentification NTLM. </font><font style="vertical-align: inherit;">Bien sÃ»r, la premiÃ¨re chose qu'ils ont faite a Ã©tÃ© d'entrer. </font><font style="vertical-align: inherit;">Creuser dans la base de connaissances interne a rapidement donnÃ© des rÃ©sultats:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'entreprise dispose d'un rÃ©seau WiFi avec authentification de compte de domaine avec accÃ¨s Ã  un rÃ©seau local. </font><font style="vertical-align: inherit;">Avec l'ensemble de donnÃ©es actuel, il s'agit dÃ©jÃ  d'un vecteur d'attaque efficace, mais vous devez vous rendre au bureau avec vos pieds et vous placer quelque part dans le bureau du client.</font></font></li>
<li> ,    , â€¦    Â« Â» ,              .    Â«Â»  Â«Â»        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sÃ»r, le Â«deuxiÃ¨me facteurÂ» a Ã©tÃ© immÃ©diatement ajoutÃ© au compte compromis en tant qu'application sur mon tÃ©lÃ©phone. Il y avait un programme qui pouvait envoyer Ã  haute voix une demande push au tÃ©lÃ©phone avec les boutons Â«approuverÂ» / Â«dÃ©sapprouverÂ», ou afficher silencieusement le code OTP Ã  l'Ã©cran pour une entrÃ©e indÃ©pendante supplÃ©mentaire. De plus, la premiÃ¨re mÃ©thode Ã©tait censÃ©e Ãªtre la seule instruction correcte, mais ne fonctionnait pas, contrairement Ã  la mÃ©thode OTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec le "deuxiÃ¨me facteur" cassÃ©, j'ai rÃ©ussi Ã  me connecter Ã  la messagerie Outlook Web Access et Ã  accÃ©der Ã  distance Ã  Citrix Netscaler Gateway. Dans Outlook, une surprise attendait par la poste:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cette photo rare, vous pouvez voir comment Roskomnadzor aide les pentesters.C'Ã©tait</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
les premiers mois aprÃ¨s le fameux verrou de ventilateur Telegram, lorsque des rÃ©seaux entiers avec des milliers d'adresses ont inexorablement disparu de l'accÃ¨s. Il est devenu clair pourquoi le push n'a pas fonctionnÃ© tout de suite et pourquoi ma Â«victimeÂ» n'a pas sonnÃ© l'alarme car ils ont commencÃ© Ã  utiliser son compte pendant les heures d'ouverture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceux qui connaissent Citrix Netscaler imaginent qu'il est gÃ©nÃ©ralement implÃ©mentÃ© de telle sorte qu'il est possible de transmettre Ã  l'utilisateur uniquement une interface d'image, en essayant de ne pas lui donner les outils nÃ©cessaires pour lancer des applications tierces et transfÃ©rer des donnÃ©es, en limitant de toutes les maniÃ¨res possibles les actions via des coquilles de contrÃ´le standard. Par ma profession, je n'ai obtenu que 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s avoir marchÃ© un peu sur l'interface 1C, j'ai trouvÃ© qu'il y avait des modules de traitement externes. </font><font style="vertical-align: inherit;">Ils peuvent Ãªtre chargÃ©s Ã  partir de l'interface et ils seront exÃ©cutÃ©s sur le client ou le serveur, selon les droits et les paramÃ¨tres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai demandÃ© Ã  des amis programmeurs 1C de crÃ©er un tel traitement qui prendrait une chaÃ®ne et l'exÃ©cuterait. </font><font style="vertical-align: inherit;">Dans 1C, le lancement du processus ressemble Ã  ceci (extrait d'Internet). </font><font style="vertical-align: inherit;">D'accord, la syntaxe du langage 1C frappe une personne russophone avec son immÃ©diatetÃ©? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le traitement a Ã©tÃ© parfaitement exÃ©cutÃ©, il s'est avÃ©rÃ© ce que les Pentesters appellent le Â«shellÂ» - Internet Explorer a Ã©tÃ© lancÃ© Ã  travers lui.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tÃ´t, l'adresse du systÃ¨me a Ã©tÃ© trouvÃ©e dans l'e-mail, ce qui vous permet de commander des laissez-passer pour le territoire. </font><font style="vertical-align: inherit;">J'ai commandÃ© un pass au cas oÃ¹ je devrais utiliser le vecteur d'attaque via WiFi.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur Internet, ils disent que dans le bureau du client il y avait encore une restauration gratuite savoureuse, mais je prÃ©fÃ©rais toujours dÃ©velopper une attaque via un site distant, c'est plus calme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AppLocker a Ã©tÃ© activÃ© sur le serveur d'applications avec Citrix, mais il a Ã©tÃ© contournÃ©. </font><font style="vertical-align: inherit;">Le mÃªme Meterpreter a Ã©tÃ© chargÃ© et dÃ©marrÃ© via DNS, car les versions http (s) ne voulaient pas se connecter et je ne connaissais pas l'adresse proxy interne Ã  ce moment-lÃ . </font><font style="vertical-align: inherit;">Ã€ propos, Ã  partir de ce moment, le penteste externe s'est essentiellement transformÃ© en penteste interne.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 4. Droits d'administrateur pour les utilisateurs - c'est mauvais, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premiÃ¨re chose qu'un Pentester fait lorsqu'il prend le contrÃ´le de la session d'un utilisateur de domaine est de collecter toutes les informations sur les droits du domaine. </font><font style="vertical-align: inherit;">Il existe un tel utilitaire BloodHound, qui vous permet automatiquement de tÃ©lÃ©charger des informations sur les utilisateurs, les ordinateurs, les groupes de sÃ©curitÃ© via le protocole LDAP Ã  partir du contrÃ´leur de domaine, et des informations sur l'utilisateur qui s'est rÃ©cemment connectÃ© et qui est l'administrateur local via SMB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une technique typique pour capturer des privilÃ¨ges d'administrateur de domaine semble simplifiÃ©e comme un cycle d'actions monotones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons aux ordinateurs de domaine, oÃ¹ il existe des droits d'administrateur local, basÃ©s sur des comptes de domaine dÃ©jÃ  capturÃ©s.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Â«Fin de cycleÂ», comme l'Ã©criraient les programmeurs 1C ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, notre utilisateur s'est avÃ©rÃ© Ãªtre un administrateur local sur un seul hÃ´te avec Windows 7, dont le nom Ã©tait le mot "VDI", ou "Virtual Desktop Infrastructure", des machines virtuelles personnelles. </font><font style="vertical-align: inherit;">Le concepteur du service VDI a probablement laissÃ© entendre que, puisque le VDI est le systÃ¨me d'exploitation personnel de l'utilisateur, laissez-le ensuite modifier l'environnement logiciel, comme vous le souhaitez, de toute faÃ§on l'hÃ´te peut Ãªtre "rechargÃ©". </font><font style="vertical-align: inherit;">J'ai aussi pensÃ© que, en gÃ©nÃ©ral, l'idÃ©e est bonne, je suis allÃ© chez cet hÃ´te VDI personnel et j'y ai fait un socket:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'y ai installÃ© le client OpenVPN, qui a crÃ©Ã© un tunnel via Internet vers mon serveur. </font><font style="vertical-align: inherit;">Le client a dÃ» passer Ã  travers le trÃ¨s Blue Coat avec l'authentification de domaine, mais OpenVPN s'est dÃ©brouillÃ©, comme on dit, hors de la boÃ®te.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InstallÃ© sur VDI OpenSSH. </font><font style="vertical-align: inherit;">Eh bien, vraiment, qu'est-ce que ce Windows 7 sans SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VoilÃ  Ã  quoi cela ressemblait vivant. </font><font style="vertical-align: inherit;">Je vous rappelle que tout cela doit Ãªtre fait via Citrix et 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des techniques de promotion de l'accÃ¨s aux ordinateurs voisins consiste Ã  vÃ©rifier la correspondance des mots de passe des administrateurs locaux. </font><font style="vertical-align: inherit;">Ici, la chance attendait tout de suite: le hachage NTLM de l'administrateur local par dÃ©faut (qui s'appelait soudainement Administrateur) a approchÃ© les hÃ´tes VDI voisins, dont il y avait plusieurs centaines, via l'attaque passe-le-hachage. </font><font style="vertical-align: inherit;">Bien sÃ»r, l'attaque les a immÃ©diatement dÃ©passÃ©s.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, les administrateurs VDI se sont tirÃ© une balle dans le pied deux fois:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La premiÃ¨re fois que les machines VDI n'ont pas Ã©tÃ© mises en action par LAPS, il a essentiellement enregistrÃ© le mÃªme mot de passe administrateur local Ã  partir d'une image qui a Ã©tÃ© massivement dÃ©ployÃ©e sur VDI.</font></font></li>
<li>   â€”   ,    pass-the-hash .          ,         ,   â€” .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi le service SSH sur ce Windows? TrÃ¨s simple: le serveur OpenSSH fournit dÃ©sormais non seulement un shell de commande interactif pratique sans interfÃ©rer avec le travail de l'utilisateur, mais Ã©galement un proxy socks5 sur VDI. GrÃ¢ce Ã  ces chaussettes, je me suis connectÃ© via SMB et j'ai collectÃ© des comptes en cache de toutes ces centaines de machines VDI, puis j'ai cherchÃ© le chemin vers l'administrateur de domaine dans les graphiques BloodHound. Avec des centaines d'hÃ´tes Ã  ma disposition, j'ai trouvÃ© ce chemin assez rapidement. Les droits d'administrateur de domaine ont Ã©tÃ© obtenus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici une image tirÃ©e d'Internet, montrant une recherche similaire. Les liens indiquent qui est l'administrateur et qui a saisi oÃ¹.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, rappelez-vous la condition dÃ¨s le dÃ©but du projet - Â«ne pas appliquer l'ingÃ©nierie socialeÂ». </font><font style="vertical-align: inherit;">Donc, je propose de rÃ©flÃ©chir Ã  combien tout ce Bollywood serait coupÃ© avec des effets spÃ©ciaux, si l'on pouvait nÃ©anmoins appliquer un phishing banal. </font><font style="vertical-align: inherit;">Mais personnellement, j'Ã©tais trÃ¨s intÃ©ressÃ© Ã  faire tout cela. </font><font style="vertical-align: inherit;">J'espÃ¨re que cette lecture vous a intÃ©ressÃ©. </font><font style="vertical-align: inherit;">Bien sÃ»r, tous les projets ne semblent pas aussi intrigants, mais le travail dans son ensemble est trÃ¨s dÃ©routant et ne stagne pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablement, quelqu'un aura une question: comment se protÃ©ger? </font><font style="vertical-align: inherit;">MÃªme dans cet article, de nombreuses techniques sont dÃ©crites, les administrateurs Windows n'en connaissent mÃªme pas beaucoup. </font><font style="vertical-align: inherit;">Cependant, je propose de les examiner du point de vue des principes et des mesures hackneyed de sÃ©curitÃ© de l'information:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'utilisez pas de logiciels obsolÃ¨tes (rappelez-vous Windows 2003 au dÃ©but?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne laissez pas les systÃ¨mes inutiles allumÃ©s (pourquoi le site de l'urologue?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vÃ©rifiez vous-mÃªme la force des mots de passe des utilisateurs (sinon les </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soldats ... les</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pentesters le </font><font style="vertical-align: inherit;">feront </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne pas avoir les mÃªmes mots de passe pour diffÃ©rents comptes (compromis VDI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et autre</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sÃ»r, il est trÃ¨s difficile Ã  mettre en Å“uvre, mais dans le prochain article nous montrerons en pratique que c'est tout Ã  fait possible.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496702/index.html">PCI Express dans les FPGA Intel sÃ©rie V: principes de base de l'interface et fonctionnalitÃ©s matÃ©rielles essentielles</a></li>
<li><a href="../fr496704/index.html">PCB de la fusÃ©e Saturn-5 - reverse engineering avec explications</a></li>
<li><a href="../fr496706/index.html">Lecture en fin de semaine: histoire des formats audio - L'Ã¢ge des cassettes et le dÃ©veloppement des technologies de synthÃ¨se vocale</a></li>
<li><a href="../fr496708/index.html">Canon spatial, fusÃ©e Ã  vapeur et miroir orbital</a></li>
<li><a href="../fr496710/index.html">Informations informatiques: simples et rapides</a></li>
<li><a href="../fr496714/index.html">Power Automate VS Logic Apps. informations gÃ©nÃ©rales</a></li>
<li><a href="../fr496716/index.html">Power Automate VS Logic Apps. BoÃ®tiers Power Automate</a></li>
<li><a href="../fr496720/index.html">Projet LLHD - Langage universel de description du matÃ©riel</a></li>
<li><a href="../fr496722/index.html">API Tinkov Investissement. Premiers pas</a></li>
<li><a href="../fr496726/index.html">Gent au fond</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>