<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😖 🚴🏼 🛌🏾 Une fois à un pentest, ou Comment tout casser avec l'aide d'un urologue et de Roskomnadzor 🛩️ 👌🏽 🤗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est basé sur un pentest très réussi, qui a été réalisé par des spécialistes du Groupe IB il y a quelques années: une histoire s'est produi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Une fois à un pentest, ou Comment tout casser avec l'aide d'un urologue et de Roskomnadzor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article est basé sur un pentest très réussi, qui a été réalisé par des spécialistes du Groupe IB il y a quelques années: une histoire s'est produite qui prétend être une adaptation cinématographique à Bollywood. Maintenant, probablement, la réaction du lecteur suivra: "Oh, un autre article de relations publiques, encore une fois ceux-ci sont dessinés, à quel point ils sont bons, n'oubliez pas d'acheter un pentest." Eh bien, d'une part, ça l'est. Cependant, il existe un certain nombre de raisons pour lesquelles cet article est apparu. Je voulais montrer ce que font exactement les pentesters, à quel point ce travail peut être intéressant et non trivial, quelles circonstances amusantes peuvent se développer sur des projets, et surtout, montrer du matériel en direct avec des exemples réels.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour rétablir l'équilibre de la modestie dans le monde, après un certain temps, nous écrirons sur le penteste, qui n'a pas disparu. </font><font style="vertical-align: inherit;">Nous montrons comment des processus bien établis dans une entreprise peuvent protéger contre toute une gamme d'attaques, même bien préparées, simplement parce que ces processus existent et fonctionnent vraiment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client de cet article, aussi, tout allait bien en général, au moins mieux que 95% du marché en Fédération de Russie, selon nos sentiments, mais il y avait un certain nombre de nuances mineures qui ont formé une longue chaîne d'événements, ce qui a conduit d'abord à un long rapport sur le travail , puis à cet article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, faites le plein de pop-corn et bienvenue au détective. </font><font style="vertical-align: inherit;">Je </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donne la parole à Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , directeur technique de l'Audit and Consulting Group-IB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 1. Docteur Pochkin </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Année 2018. Il y a un client - une entreprise informatique de haute technologie qui sert elle-même de nombreux clients. Il souhaite obtenir une réponse à la question: est-il possible, sans aucune connaissance et accès initiaux, via Internet, d'obtenir des droits d'administrateur pour un domaine Active Directory? Aucune ingénierie sociale n'est intéressante ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hein, mais en vain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), elles ne vont pas spécifiquement interférer avec le travail, mais elles peuvent recharger accidentellement un serveur étrange, par exemple. Une tâche supplémentaire consiste à identifier autant d'autres vecteurs d'attaque que possible par rapport au périmètre externe. La société effectue régulièrement de tels tests, et maintenant la date limite pour un nouveau test. Les conditions sont presque typiques, adéquates, compréhensibles. Descendre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un nom de client - que ce soit "Entreprise", avec le site principal </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Bien sûr, le client est appelé différemment, mais dans cet article, tout sera dépersonnalisé. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je mène une veille réseau - je découvre les adresses et domaines répertoriés par le client, dessine un schéma de réseau, comment les services sont distribués à ces adresses. J'obtiens le résultat: plus de 4000 adresses IP en direct. Je regarde à travers les domaines de ces réseaux: heureusement, la grande majorité sont des réseaux destinés aux clients clients, et ils ne nous intéressent pas formellement. Le client est du même avis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste un réseau avec 256 adresses, pour lequel à ce stade il y a déjà une compréhension de la distribution des domaines et des sous-domaines par adresses IP, il y a des informations sur les ports scannés, ce qui signifie que vous pouvez regarder les services pour les plus intéressants avec vos yeux. En parallèle, toutes sortes de scanners sont lancés à des adresses IP accessibles et séparément - sur des sites Web.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup de services. C'est généralement une joie pour le pentester et l'anticipation d'une victoire rapide, car plus il y a de services, plus le champ d'attaque est grand et plus il est facile de trouver un artefact. Un rapide coup d'œil sur les sites Web a montré que la plupart d'entre eux sont des interfaces Web des produits bien connus des grandes entreprises mondiales qui disent qu'ils ne sont pas satisfaits de vous. Ils demandent un nom d'utilisateur et un mot de passe, à partir du seuil où ils secouent le champ pour entrer le deuxième facteur, ils demandent un certificat client TLS ou les envoient à Microsoft ADFS. Certains sont tout simplement indisponibles sur Internet. Pour certains, vous devez évidemment avoir un client payant spécial pour trois salaires ou connaître l'URL exacte à saisir. Nous allons omettre une autre semaine de découragement progressif dans le processus visant à "traverser" le logiciel par version pour les vulnérabilités connues, rechercher des contenus cachés dans les chemins Web et les fuites de comptes de services tiers tels que LinkedIn,tente de sélectionner des mots de passe pour eux, ainsi que de creuser des vulnérabilités dans des sites Web auto-décrits - à propos, selon les statistiques, c'est le vecteur le plus prometteur d'une attaque externe à ce jour. Immédiatement, je note le pistolet de cinéma, qui a ensuite tiré.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait donc deux sites qui se démarquaient de centaines de services. Ces sites avaient une chose en commun: si vous ne vous engagez pas dans une reconnaissance méticuleuse du réseau par domaine, mais que vous recherchez «sur le devant» des ports ouverts ou empoisonnez le scanner de vulnérabilité sur une plage IP connue, alors ces sites vont se passer de la vérification, ils ne seront tout simplement pas visibles sans connaître le nom DNS. Peut-être ont-ils été manqués plus tôt, du moins, et nos outils automatiques n'y ont pas trouvé de problèmes, même s'ils étaient définis directement sur la ressource.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, sur le fait que les scanners précédemment lancés ont été généralement trouvés. Permettez-moi de vous rappeler: pour certains, «pentest» équivaut à «numérisation automatisée». Et les scanners de ce projet n'ont rien dit. Eh bien, les vulnérabilités moyennes ont montré le maximum (3 sur 5 en termes de danger): certains services ont un mauvais certificat TLS ou des algorithmes de cryptage obsolètes, et la plupart des sites ont un détournement de clic. Mais là-dessus, vous n'atteindrez pas l'objectif. Les scanners seraient probablement plus utiles ici, mais permettez-moi de vous rappeler: le client lui-même est en mesure d'acheter de tels programmes et de se tester avec eux, et à en juger par les résultats ternes, il l'a déjà vérifié.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retour aux sites "anormaux". Le premier est quelque chose comme un Wiki local à une adresse non standard, mais laissez wiki.company [.] Ru figurer dans cet article. Elle a également immédiatement demandé un nom d'utilisateur et un mot de passe, mais déjà via NTLM dans le navigateur. Pour l'utilisateur, cela ressemble à une fenêtre ascétique demandant un nom d'utilisateur et un mot de passe. Et c'est une mauvaise pratique.</font></font><br>
<br>
<blockquote> . NTLM  -      .   —    Active Directory.       company.ru,   «» DNS-.  ,    - ,        ,    - .  —        NTLM (, ?),     «» ,         .    ,      .         —  ,    .  —       .         — , ,  .  —   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une mauvaise caractéristique des produits Microsoft: même si vous n'avez pas spécifiquement publié un tel NTLM, il sera au moins dans l'installation par défaut dans OWA et Lync. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, l'auteur de cet article a bloqué une fois de la même manière accidentellement environ 1 000 comptes d'employés d'une grande banque en une heure seulement, puis a eu un aspect un peu pâle. </font><font style="vertical-align: inherit;">Les services informatiques de la banque étaient également pâles, mais tout s'est bien terminé et nous avons même été félicités d'avoir été les premiers à trouver ce problème et provoqué une correction rapide et décisive.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le deuxième site avait l'adresse "évidemment-un-nom.company.ru". </font><font style="vertical-align: inherit;">Trouvé via Google, quelque chose comme ça à la page 10. </font><font style="vertical-align: inherit;">Le design commence au milieu des années 2000, et une personne respectable a regardé la page principale, quelque chose comme ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis il a pris un cadre de "Dog’s Heart", mais croyez-moi, il était à peu près similaire, même la palette de couleurs dans des couleurs similaires. Que le site s'appelle </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'était un site personnel ... d'un urologue. Il est devenu intéressant de voir ce que fait le site de l'urologue sur le sous-domaine d'une entreprise de haute technologie. Une brève fouille chez Google a montré que ce médecin était co-fondateur de l'une des personnes morales de notre client et a même contribué environ 1000 roubles de capital social. Le site a probablement été créé il y a de nombreuses années et les ressources du serveur du client ont été utilisées comme hébergement. Le site a depuis longtemps perdu sa pertinence, mais pour une raison quelconque, il est resté longtemps opérationnel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En termes de vulnérabilités, le site Web lui-même était sûr. Pour l'avenir, je dirai qu'il s'agissait d'un ensemble de statistiques - de simples pages html avec des insertions d'illustrations sous forme de reins et de vessies. "Briser" un tel site est inutile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le serveur Web en dessous était plus intéressant. À en juger par l'en-tête du serveur HTTP, il y avait IIS 6.0, ce qui signifie que Windows 2003 a été utilisé comme système d'exploitation. Le scanner a précédemment révélé que ce site Web particulier de l'urologue, contrairement à d'autres hôtes virtuels sur le même serveur Web, avait répondu à la commande PROPFIND, c'est-à-dire que WebDAV y avait fonctionné. Soit dit en passant, le scanner a émis ces informations avec la marque Info (dans la langue des rapports du scanner, c'est le danger le plus faible) - de telles choses sont généralement simplement ignorées. En combinaison, cela a donné un effet intéressant, qui n'a été révélé qu'après une nouvelle fouille dans Google: une vulnérabilité de débordement de tampon rare associée à un ensemble de Shadow Brokers, à savoir CVE-2017-7269, qui avait déjà un exploit prêt. En d'autres termes, ce sera un désastre si vous avez Windows 2003 et WebDAV s'exécute sur IIS.Bien que travaillant dans la production de Windows 2003 en 2018, c'est en soi une catastrophe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exploit s'est retrouvé dans Metasploit et a été immédiatement testé avec une charge qui a envoyé une requête DNS à un service contrôlé - Burp Collaborator est traditionnellement utilisé pour intercepter les requêtes DNS. Étonnamment, cela a fonctionné la première fois: une secousse a été reçue dans DNS. Ensuite, il y a eu une tentative de création d'une connexion dorsale via le port 80 (c'est-à-dire une connexion réseau du serveur à l'attaquant, avec accès à cmd.exe sur l'hôte victime), mais un fiasco s'est produit. La connexion n'est pas venue et après la troisième tentative d'opération, le site, avec toutes les images divertissantes, a disparu pour de bon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, cela est suivi d'une lettre dans le style "client, réveille-toi, nous avons tout laissé tomber". Mais on nous a dit que le site n'a rien à voir avec les processus métier et y fonctionne en général, on ne sait pas pourquoi, comme l'ensemble du serveur, et que nous pouvons utiliser cette ressource à notre guise.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après environ une journée, le site a soudainement commencé à fonctionner de lui-même. Après avoir construit un stand à partir de WebDAV sur IIS 6.0, j'ai constaté que le paramètre par défaut est de redémarrer les workflows IIS toutes les 30 heures. Autrement dit, lorsque le contrôle est sorti du code shell, le flux de travail IIS s'est terminé, puis il a redémarré plusieurs fois lui-même, puis s'est arrêté pendant 30 heures.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis la première fois que bekconnect sur TCP a échoué, j'ai annulé ce problème sur un port fermé. </font><font style="vertical-align: inherit;">Autrement dit, il a suggéré la présence d'un pare-feu qui ne laissait pas sortir les connexions sortantes. </font><font style="vertical-align: inherit;">J'ai commencé à exécuter des codes shell qui trient à travers de nombreux ports TCP et UDP, il n'y avait aucun effet. </font><font style="vertical-align: inherit;">La connexion inverse se charge via http (s) de Metasploit - meterpreter / reverse_http (s) ne fonctionne pas. </font><font style="vertical-align: inherit;">Soudain, la connexion au même port 80 a été établie, mais a immédiatement été rompue. </font><font style="vertical-align: inherit;">Il l'a déduit de l'action de l'IPS encore imaginaire, qui n'aimait pas le trafic métrique. </font><font style="vertical-align: inherit;">À la lumière du fait que la connexion de TCP pur au port 80 a échoué, mais http l'a fait, j'ai conclu que le proxy http était en quelque sorte configuré dans le système. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testé même mètre mètre via DNS (merci</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour ses efforts, a sauvé de nombreux projets), rappelant le tout premier succès, mais il n'a même pas travaillé sur le stand - le code shell était trop volumineux pour cette vulnérabilité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En réalité, cela ressemblait à ceci: 3-4 tentatives d'attaque dans les 5 minutes, puis attendez 30 heures. Et donc pendant trois semaines consécutives. J'ai même mis en place un rappel pour ne pas perdre de temps. De plus, il y avait une différence dans le comportement des environnements de test et de combat: il y avait deux exploits similaires pour cette vulnérabilité, l'un de Metasploit, le second d'Internet, refait à partir de la version Shadow Brokers. Ainsi, au combat, seul Metasploit a fonctionné, sur le stand - seulement le second, ce qui a compliqué le débogage et brisé le cerveau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au final, le code shell s'est avéré efficace, qui a téléchargé un fichier exe depuis un serveur donné via http et l'a exécuté sur le système cible. Le shellcode était assez petit pour tenir, et au moins cela a fonctionné. Étant donné que le serveur TCP n'aimait pas du tout le trafic et que http (s) a été inspecté pour meterpreter, j'ai décidé que le moyen le plus rapide était de télécharger le fichier exe qui contenait le DNS-meterpreter via ce shellcode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Là encore, le problème s'est posé: lors du téléchargement du fichier exe et, comme les tentatives l'ont montré, quoi qu'il en soit, le téléchargement a été interrompu. </font><font style="vertical-align: inherit;">Encore une fois, une sorte de dispositif de sécurité entre mon serveur et l'urologue n'aimait pas le trafic http avec exe à l'intérieur. </font><font style="vertical-align: inherit;">Cela semblait être une solution «rapide» pour changer le shellcode afin qu'il obscurcisse le trafic http à la volée, afin que les données binaires abstraites soient transférées au lieu d'exe. </font><font style="vertical-align: inherit;">Enfin, l'attaque a réussi, le contrôle est passé par le canal DNS fin:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est immédiatement devenu clair que j'avais les droits les plus simples sur le workflow IIS qui me permettent de ne rien faire. </font><font style="vertical-align: inherit;">Voici à quoi cela ressemblait sur la console Metasploit:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les méthodologies pentest suggèrent fortement que vous devez augmenter les droits lors de l'accès. Habituellement, je ne le fais pas localement, car le tout premier accès est considéré simplement comme un point d'entrée réseau, et compromettre une autre machine sur le même réseau est généralement plus facile et plus rapide que l'augmentation des privilèges sur un hôte existant. Mais ce n'est pas le cas, car le canal DNS est très étroit et il ne permettra pas au trafic de se déplacer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En supposant que ce serveur avec Windows 2003 n'a pas été réparé à partir de la vulnérabilité bien connue MS17-010, je tunnelise le trafic vers le port 445 / TCP via le tunnel DNS meterpreter vers localhost (oui, cela est également possible) et j'essaie d'exécuter un exe précédemment téléchargé via la vulnérabilité. L'attaque fonctionne, j'obtiens une deuxième connexion, mais avec les privilèges SYSTEM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fait intéressant, le serveur essayait toujours de se protéger contre MS17-010 - il avait désactivé les services réseau vulnérables sur l'interface externe. </font><font style="vertical-align: inherit;">Cela protège vraiment contre les attaques via le réseau, mais l'attaque de l'intérieur de l'hôte local a fonctionné, car vous ne pouvez pas simplement prendre et désactiver rapidement SMB sur localhost.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, de nouveaux détails intéressants sont révélés:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec les autorisations SYSTEM, vous pouvez facilement installer une connexion arrière via TCP. </font><font style="vertical-align: inherit;">De toute évidence, l'interdiction de TCP direct est exclusivement un problème utilisateur limité IIS. </font><font style="vertical-align: inherit;">Spoiler: le trafic des utilisateurs IIS était en quelque sorte enveloppé dans le proxy ISA local dans les deux sens. </font><font style="vertical-align: inherit;">Comment cela fonctionne exactement n'est pas reproduit.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je suis dans une certaine «DMZ» (et ce n'est pas un domaine Active Directory, mais WORKGROUP) - cela semble logique. </font><font style="vertical-align: inherit;">Mais au lieu de l'adresse IP privée ("grise") attendue, je suis plutôt "blanche", exactement la même que celle que j'ai attaquée plus tôt. </font><font style="vertical-align: inherit;">Cela signifie que la société est tellement ancienne pour le monde de l'adressage IPv4 qu'elle peut se permettre de garder la zone DMZ à 128 adresses «blanches» sans NAT selon le schéma, comme cela a été illustré dans les manuels Cisco 2005.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur étant ancien, Mimikatz est garanti de fonctionner directement depuis la mémoire:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'obtiens le mot de passe de l'administrateur local, je tunnel le trafic RDP via TCP et je vais dans un bureau confortable. </font><font style="vertical-align: inherit;">Étant donné que vous pouvez faire quoi que ce soit avec le serveur, je supprime l'antivirus, je trouve que le serveur est accessible à partir d'Internet uniquement sur les ports TCP 80 et 443, et 443 n'était pas occupé. </font><font style="vertical-align: inherit;">J'élève le serveur OpenVPN à 443, j'ajoute les fonctions NAT pour mon trafic VPN et j'obtiens un accès direct au réseau DMZ sous une forme illimitée via mon OpenVPN. </font><font style="vertical-align: inherit;">Il est à noter que l'ISA, avec certaines fonctionnalités IPS non désactivables, a bloqué mon trafic avec une analyse de port, pour laquelle il a dû être remplacé par un RRAS plus simple et plus flexible. </font><font style="vertical-align: inherit;">Les pentesters doivent donc parfois tout administrer.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un lecteur attentif demandera: "Et quel est le deuxième site - un wiki avec authentification NTLM, sur lequel tant de choses ont été écrites?" </font><font style="vertical-align: inherit;">À ce sujet plus loin.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 2. N'êtes-vous toujours pas en train de chiffrer? </font><font style="vertical-align: inherit;">Ensuite, nous </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allons à vous</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> déjà ici</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a donc accès au segment de réseau DMZ. </font><font style="vertical-align: inherit;">Vous devez vous adresser à l'administrateur du domaine. </font><font style="vertical-align: inherit;">La première chose qui me vient à l'esprit est de vérifier automatiquement la sécurité des services à l'intérieur du segment DMZ, d'autant plus qu'ils sont désormais beaucoup plus ouverts à la recherche. </font><font style="vertical-align: inherit;">Une image typique dans un test de pénétration: le périmètre externe est mieux protégé que les services internes, et lorsque vous obtenez un accès à une grande infrastructure, il est beaucoup plus facile d'obtenir des droits étendus dans un domaine uniquement parce que ce domaine commence à être accessible pour les outils, et deuxièmement, il y a toujours quelques problèmes critiques dans l'infrastructure pour plusieurs milliers d'hôtes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je charge des scanners sur DMZ via le tunnel OpenVPN, j'attends. J'ouvre le rapport - encore une fois rien de grave, apparemment quelqu'un a marché de la même manière vers moi. L'étape suivante consiste à examiner comment les hôtes communiquent au sein du réseau DMZ. Pour ce faire, pour commencer, un Wireshark régulier est lancé avec l'écoute des requêtes de diffusion, principalement ARP. Les colis ARP ont été collectés toute la journée. Il s'avère que plusieurs passerelles sont utilisées dans ce segment. Cela vous sera utile plus tard. En collant des données sur les données de réponse aux requêtes ARP et de numérisation de port, j'ai trouvé les points de sortie du trafic utilisateur à partir du réseau local en plus des services qui étaient auparavant connus, tels que le Web et la messagerie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pour le moment je n'avais pas accès à d'autres systèmes et qu'il n'y avait pas un seul compte pour les services d'entreprise, il a été décidé de récupérer au moins une partie du trafic à l'aide d'ARP Spoofing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel a été lancé sur le serveur de l'urologue. </font><font style="vertical-align: inherit;">Compte tenu des flux de trafic identifiés, les paires les plus prometteuses ont été sélectionnées pour l'attaque «homme au milieu», puis par un démarrage à court terme pendant 5 à 10 minutes, avec une minuterie pour redémarrer le serveur en cas de «gel», du trafic réseau a été reçu. </font><font style="vertical-align: inherit;">Comme dans la blague, il y avait deux nouvelles:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bon: beaucoup d'informations d'identification ont été capturées et l'attaque dans son ensemble a fonctionné.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mauvais: toutes les informations d'identification provenaient des clients du client lui-même. </font><font style="vertical-align: inherit;">Fournissant des services d'assistance, des spécialistes du client connectés à des services client qui n'ont pas toujours configuré le chiffrement du trafic.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, je me suis emparé de nombreuses informations d'identification qui étaient inutiles dans le contexte du projet, mais certainement intéressantes comme démonstration du danger d'une attaque. Routeurs frontaliers de grandes entreprises avec telnet, transfert des ports http de débogage vers CRM interne avec toutes les données, accès direct à RDP depuis Windows XP sur le réseau local et autres obscurantismes. Il s'est avéré une sorte de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compromis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">la chaîne d'approvisionnement selon la matrice MITRE</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A également trouvé une occasion amusante de collecter des e-mails provenant du trafic, quelque chose comme ça. Ceci est un exemple d'une lettre finie qui est passée de notre client au port SMTP de son client, encore une fois, sans cryptage. Un certain Andrei demande à son homonyme de renvoyer la documentation, qui est disposée sur un disque cloud avec un nom d'utilisateur, un mot de passe et un lien dans une lettre de réponse:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci est un autre rappel que vous devez crypter tous les services. On ne sait pas qui et quand lira et appliquera spécifiquement vos données - un fournisseur, un administrateur système d'une autre entreprise ou un tel pentester. Je suis silencieux que beaucoup peuvent simplement intercepter le trafic non chiffré. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le succès apparent, cela n'a pas été rapproché de l'objectif. Il était possible, bien sûr, de rester longtemps assis et d'obtenir des informations précieuses, mais pas le fait qu'elles y seraient apparues, et l'attaque elle-même est très risquée en termes d'intégrité du réseau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après une nouvelle fouille dans les services, une idée intéressante m'est venue à l'esprit. Il existe un tel utilitaire appelé Responder (il est facile de trouver des exemples d'applications de ce nom), qui, en «empoisonnant» les demandes de diffusion, provoque des connexions sur une variété de protocoles tels que SMB, HTTP, LDAP, etc. de différentes manières, chaque personne qui se connecte est invitée à s'authentifier et à s'ajuster pour que l'authentification passe par NTLM et dans un mode transparent pour la victime. Le plus souvent, un attaquant recueille ainsi des poignées de main NetNTLMv2 et d'eux, selon le dictionnaire, récupère rapidement les mots de passe du domaine utilisateur. Je voulais quelque chose de similaire ici, mais les utilisateurs étaient assis «derrière le mur», ou plutôt, ils étaient séparés par un pare-feu, et sur le WEB, ils étaient passés par le cluster proxy Blue Coat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelez-vous, j'ai spécifié que le nom de domaine Active Directory coïncidait avec le domaine "externe", c'est-à-dire était company.ru? Ainsi, Windows, plus précisément Internet Explorer (et Edge et Chrome), permettent à l'utilisateur de s'authentifier de manière transparente en HTTP via NTLM, s'il considère que le site se trouve dans une «zone intranet». L'un des signes de «l'intranet» est un appel à une adresse IP «grise» ou à un nom DNS court, c'est-à-dire sans points. Puisqu'un serveur avec un nom IP et DNS «blanc» preobrazhensky.company.ru était à sa disposition, et que les machines de domaine obtiennent généralement le suffixe de domaine Active Directory via DHCP pour simplifier la saisie du nom, elles n'avaient qu'à écrire l'URL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">preobrazhensky</font></a><font style="vertical-align: inherit;"> dans la barre d'adresse</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin qu'ils trouvent le bon chemin vers un serveur urologue compromis, sans oublier qu'il s'appelle désormais "Intranet". </font><font style="vertical-align: inherit;">C'est-à-dire, en même temps me donner l'utilisateur de la poignée de main NTLM à son insu. </font><font style="vertical-align: inherit;">Reste à faire réfléchir les navigateurs clients sur l'urgence d'accéder à ce serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le merveilleux utilitaire Intercepter-NG est venu à la rescousse (merci</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intercepter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Il vous a permis de modifier le trafic lors de vos déplacements et a parfaitement fonctionné sur Windows 2003. Il y avait même une fonctionnalité distincte pour modifier uniquement les fichiers JavaScript dans le flux de trafic. Il était prévu une sorte de Cross-Site Scripting massif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mandataires Blue Coat par le biais desquels les utilisateurs ont accédé au contenu statique global du WEB mis en cache périodiquement. En interceptant le trafic, il était clair qu'ils fonctionnaient 24 heures sur 24, demandant sans cesse des statistiques fréquemment utilisées pour accélérer l'affichage du contenu pendant les heures de pointe. De plus, BlueCoat avait un agent utilisateur spécifique, qui le distinguait clairement d'un utilisateur vivant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javascript a été préparé, ce qui, avec l'aide d'Intercepter-NG la nuit, a passé une heure entière à implémenter chaque réponse avec des fichiers JS pour Blue Coat. Le script a fait ce qui suit:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Détecté le navigateur actuel par User-Agent. </font><font style="vertical-align: inherit;">Si c'était Internet Explorer, Edge ou Chrome - cela fonctionnait.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendu que le DOM de la page soit formé.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai inséré une image invisible avec l'attribut src du type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky dans le DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / NNNNNNN.png, où NNN sont des chiffres arbitraires afin que BlueCoat ne cache pas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez une variable indicateur globale indiquant que l'injection a été effectuée et que vous n'avez plus besoin d'insérer d'images.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le navigateur a essayé de charger cette image, sur le port 8080 du serveur compromis, il attendait le tunnel TCP vers mon ordinateur portable, où le même répondeur a été lancé, ce qui nécessite une connexion NTLM à partir du navigateur.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A en juger par les journaux du Répondant, le matin, les gens sont venus travailler, ont allumé leur poste de travail, puis ont commencé à visiter le serveur de l'urologue en masse et de manière invisible, sans oublier de «fusionner» les poignées de main NTLM. </font><font style="vertical-align: inherit;">Des poignées de main ont plu toute la journée et ont clairement accumulé du matériel pour une attaque de récupération de mot de passe notoirement réussie. </font><font style="vertical-align: inherit;">Voici à quoi ressemblaient les journaux du répondeur:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visites massives et secrètes des utilisateurs sur le serveur de l'urologue</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous avez probablement déjà remarqué que toute cette histoire est construite sur le principe "tout allait bien, mais il y avait une déception, puis il y avait du dépassement, et puis tout est arrivé au succès". </font><font style="vertical-align: inherit;">Donc, il y avait une déception. </font><font style="vertical-align: inherit;">Sur les cinq cents poignées de main uniques, aucune n'a été révélée. </font><font style="vertical-align: inherit;">Et cela tient compte du fait que même sur un ordinateur portable avec un processeur mort, ces poignées de main NTLMv2 dépassent la vitesse de plusieurs centaines de millions de tentatives par seconde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai dû m'armer de techniques de mutation de mot de passe, d'une carte graphique, d'un dictionnaire plus épais et attendre. </font><font style="vertical-align: inherit;">Après un long moment, plusieurs comptes avec des mots de passe de la forme «Q11111111 ... .1111111q» ont été ouverts, ce qui suggère que tous les utilisateurs ont été une fois contraints de proposer un mot de passe très long avec une casse de caractères différente, ce qui était censé être compliqué. </font><font style="vertical-align: inherit;">Mais vous ne pouvez pas simplement échouer un utilisateur chevronné, et de cette façon, il a rendu la mémoire plus facile. </font><font style="vertical-align: inherit;">Au total, environ 5 pièces ont été ouvertes, et une seule d'entre elles avait des droits précieux sur les services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 3. Roskomnadzor contre-attaque</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, les premiers comptes de domaine ont été reçus. </font><font style="vertical-align: inherit;">Si à ce stade vous ne vous êtes pas endormi après une longue lecture, vous vous souviendrez probablement que j'ai mentionné un service qui ne nécessitait pas de second facteur d'authentification: il s'agit d'un wiki avec authentification NTLM. </font><font style="vertical-align: inherit;">Bien sûr, la première chose qu'ils ont faite a été d'entrer. </font><font style="vertical-align: inherit;">Creuser dans la base de connaissances interne a rapidement donné des résultats:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'entreprise dispose d'un réseau WiFi avec authentification de compte de domaine avec accès à un réseau local. </font><font style="vertical-align: inherit;">Avec l'ensemble de données actuel, il s'agit déjà d'un vecteur d'attaque efficace, mais vous devez vous rendre au bureau avec vos pieds et vous placer quelque part dans le bureau du client.</font></font></li>
<li> ,    , …    « » ,              .    «»  «»        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, le «deuxième facteur» a été immédiatement ajouté au compte compromis en tant qu'application sur mon téléphone. Il y avait un programme qui pouvait envoyer à haute voix une demande push au téléphone avec les boutons «approuver» / «désapprouver», ou afficher silencieusement le code OTP à l'écran pour une entrée indépendante supplémentaire. De plus, la première méthode était censée être la seule instruction correcte, mais ne fonctionnait pas, contrairement à la méthode OTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec le "deuxième facteur" cassé, j'ai réussi à me connecter à la messagerie Outlook Web Access et à accéder à distance à Citrix Netscaler Gateway. Dans Outlook, une surprise attendait par la poste:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cette photo rare, vous pouvez voir comment Roskomnadzor aide les pentesters.C'était</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
les premiers mois après le fameux verrou de ventilateur Telegram, lorsque des réseaux entiers avec des milliers d'adresses ont inexorablement disparu de l'accès. Il est devenu clair pourquoi le push n'a pas fonctionné tout de suite et pourquoi ma «victime» n'a pas sonné l'alarme car ils ont commencé à utiliser son compte pendant les heures d'ouverture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceux qui connaissent Citrix Netscaler imaginent qu'il est généralement implémenté de telle sorte qu'il est possible de transmettre à l'utilisateur uniquement une interface d'image, en essayant de ne pas lui donner les outils nécessaires pour lancer des applications tierces et transférer des données, en limitant de toutes les manières possibles les actions via des coquilles de contrôle standard. Par ma profession, je n'ai obtenu que 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir marché un peu sur l'interface 1C, j'ai trouvé qu'il y avait des modules de traitement externes. </font><font style="vertical-align: inherit;">Ils peuvent être chargés à partir de l'interface et ils seront exécutés sur le client ou le serveur, selon les droits et les paramètres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai demandé à des amis programmeurs 1C de créer un tel traitement qui prendrait une chaîne et l'exécuterait. </font><font style="vertical-align: inherit;">Dans 1C, le lancement du processus ressemble à ceci (extrait d'Internet). </font><font style="vertical-align: inherit;">D'accord, la syntaxe du langage 1C frappe une personne russophone avec son immédiateté? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le traitement a été parfaitement exécuté, il s'est avéré ce que les Pentesters appellent le «shell» - Internet Explorer a été lancé à travers lui.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tôt, l'adresse du système a été trouvée dans l'e-mail, ce qui vous permet de commander des laissez-passer pour le territoire. </font><font style="vertical-align: inherit;">J'ai commandé un pass au cas où je devrais utiliser le vecteur d'attaque via WiFi.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur Internet, ils disent que dans le bureau du client il y avait encore une restauration gratuite savoureuse, mais je préférais toujours développer une attaque via un site distant, c'est plus calme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AppLocker a été activé sur le serveur d'applications avec Citrix, mais il a été contourné. </font><font style="vertical-align: inherit;">Le même Meterpreter a été chargé et démarré via DNS, car les versions http (s) ne voulaient pas se connecter et je ne connaissais pas l'adresse proxy interne à ce moment-là. </font><font style="vertical-align: inherit;">À propos, à partir de ce moment, le penteste externe s'est essentiellement transformé en penteste interne.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 4. Droits d'administrateur pour les utilisateurs - c'est mauvais, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première chose qu'un Pentester fait lorsqu'il prend le contrôle de la session d'un utilisateur de domaine est de collecter toutes les informations sur les droits du domaine. </font><font style="vertical-align: inherit;">Il existe un tel utilitaire BloodHound, qui vous permet automatiquement de télécharger des informations sur les utilisateurs, les ordinateurs, les groupes de sécurité via le protocole LDAP à partir du contrôleur de domaine, et des informations sur l'utilisateur qui s'est récemment connecté et qui est l'administrateur local via SMB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une technique typique pour capturer des privilèges d'administrateur de domaine semble simplifiée comme un cycle d'actions monotones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons aux ordinateurs de domaine, où il existe des droits d'administrateur local, basés sur des comptes de domaine déjà capturés.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
«Fin de cycle», comme l'écriraient les programmeurs 1C ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, notre utilisateur s'est avéré être un administrateur local sur un seul hôte avec Windows 7, dont le nom était le mot "VDI", ou "Virtual Desktop Infrastructure", des machines virtuelles personnelles. </font><font style="vertical-align: inherit;">Le concepteur du service VDI a probablement laissé entendre que, puisque le VDI est le système d'exploitation personnel de l'utilisateur, laissez-le ensuite modifier l'environnement logiciel, comme vous le souhaitez, de toute façon l'hôte peut être "rechargé". </font><font style="vertical-align: inherit;">J'ai aussi pensé que, en général, l'idée est bonne, je suis allé chez cet hôte VDI personnel et j'y ai fait un socket:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'y ai installé le client OpenVPN, qui a créé un tunnel via Internet vers mon serveur. </font><font style="vertical-align: inherit;">Le client a dû passer à travers le très Blue Coat avec l'authentification de domaine, mais OpenVPN s'est débrouillé, comme on dit, hors de la boîte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installé sur VDI OpenSSH. </font><font style="vertical-align: inherit;">Eh bien, vraiment, qu'est-ce que ce Windows 7 sans SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voilà à quoi cela ressemblait vivant. </font><font style="vertical-align: inherit;">Je vous rappelle que tout cela doit être fait via Citrix et 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des techniques de promotion de l'accès aux ordinateurs voisins consiste à vérifier la correspondance des mots de passe des administrateurs locaux. </font><font style="vertical-align: inherit;">Ici, la chance attendait tout de suite: le hachage NTLM de l'administrateur local par défaut (qui s'appelait soudainement Administrateur) a approché les hôtes VDI voisins, dont il y avait plusieurs centaines, via l'attaque passe-le-hachage. </font><font style="vertical-align: inherit;">Bien sûr, l'attaque les a immédiatement dépassés.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, les administrateurs VDI se sont tiré une balle dans le pied deux fois:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La première fois que les machines VDI n'ont pas été mises en action par LAPS, il a essentiellement enregistré le même mot de passe administrateur local à partir d'une image qui a été massivement déployée sur VDI.</font></font></li>
<li>   —   ,    pass-the-hash .          ,         ,   — .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi le service SSH sur ce Windows? Très simple: le serveur OpenSSH fournit désormais non seulement un shell de commande interactif pratique sans interférer avec le travail de l'utilisateur, mais également un proxy socks5 sur VDI. Grâce à ces chaussettes, je me suis connecté via SMB et j'ai collecté des comptes en cache de toutes ces centaines de machines VDI, puis j'ai cherché le chemin vers l'administrateur de domaine dans les graphiques BloodHound. Avec des centaines d'hôtes à ma disposition, j'ai trouvé ce chemin assez rapidement. Les droits d'administrateur de domaine ont été obtenus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici une image tirée d'Internet, montrant une recherche similaire. Les liens indiquent qui est l'administrateur et qui a saisi où.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, rappelez-vous la condition dès le début du projet - «ne pas appliquer l'ingénierie sociale». </font><font style="vertical-align: inherit;">Donc, je propose de réfléchir à combien tout ce Bollywood serait coupé avec des effets spéciaux, si l'on pouvait néanmoins appliquer un phishing banal. </font><font style="vertical-align: inherit;">Mais personnellement, j'étais très intéressé à faire tout cela. </font><font style="vertical-align: inherit;">J'espère que cette lecture vous a intéressé. </font><font style="vertical-align: inherit;">Bien sûr, tous les projets ne semblent pas aussi intrigants, mais le travail dans son ensemble est très déroutant et ne stagne pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablement, quelqu'un aura une question: comment se protéger? </font><font style="vertical-align: inherit;">Même dans cet article, de nombreuses techniques sont décrites, les administrateurs Windows n'en connaissent même pas beaucoup. </font><font style="vertical-align: inherit;">Cependant, je propose de les examiner du point de vue des principes et des mesures hackneyed de sécurité de l'information:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'utilisez pas de logiciels obsolètes (rappelez-vous Windows 2003 au début?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne laissez pas les systèmes inutiles allumés (pourquoi le site de l'urologue?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vérifiez vous-même la force des mots de passe des utilisateurs (sinon les </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soldats ... les</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pentesters le </font><font style="vertical-align: inherit;">feront </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne pas avoir les mêmes mots de passe pour différents comptes (compromis VDI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et autre</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, il est très difficile à mettre en œuvre, mais dans le prochain article nous montrerons en pratique que c'est tout à fait possible.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496702/index.html">PCI Express dans les FPGA Intel série V: principes de base de l'interface et fonctionnalités matérielles essentielles</a></li>
<li><a href="../fr496704/index.html">PCB de la fusée Saturn-5 - reverse engineering avec explications</a></li>
<li><a href="../fr496706/index.html">Lecture en fin de semaine: histoire des formats audio - L'âge des cassettes et le développement des technologies de synthèse vocale</a></li>
<li><a href="../fr496708/index.html">Canon spatial, fusée à vapeur et miroir orbital</a></li>
<li><a href="../fr496710/index.html">Informations informatiques: simples et rapides</a></li>
<li><a href="../fr496714/index.html">Power Automate VS Logic Apps. informations générales</a></li>
<li><a href="../fr496716/index.html">Power Automate VS Logic Apps. Boîtiers Power Automate</a></li>
<li><a href="../fr496720/index.html">Projet LLHD - Langage universel de description du matériel</a></li>
<li><a href="../fr496722/index.html">API Tinkov Investissement. Premiers pas</a></li>
<li><a href="../fr496726/index.html">Gent au fond</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>