<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜó üêâ üìú Food Infrastructure: How We Support Tanuki üêô üåå üçî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To paraphrase one famous historical figure, the most important of all the services for us is delivery. What would we do in the current situation witho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Food Infrastructure: How We Support Tanuki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/500634/"><img src="https://habrastorage.org/webt/vi/gs/zm/vigszmdhwabpqlqr9bgrcx_ozaw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To paraphrase one famous historical figure, the most important of all the services for us is delivery. What would we do in the current situation without rolls or pizza at home? I don‚Äôt want to imagine. It so happened that 2 years ago we took on the support of one of the largest networks - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanuki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The monthly audience of the site is about a million people. It is now in 2020. In 2018, when the Tanuki started cooperation with us, it was 2 times smaller. We ensured a painless move to a new data center and completely redid the infrastructure - thanks to which, in fact, the site and applications are able to withstand the increased load without problems.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At times, we strongly regret that we are geographically far from the nearest Tanuki restaurant: otherwise, all our successes (and little misfortunes) would be jammed with delicious rolls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, today we want to tell you the story of the support of one of the largest web projects of the domestic ‚Äúhospitality industry‚Äù.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We met at the end of March 2018. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
International Women's Day has long passed, but the guys have just coped with its consequences. </font><font style="vertical-align: inherit;">Everything is pretty banal: on the eve of March 8, traffic increased sharply, and the site was unavailable for a long time. </font><font style="vertical-align: inherit;">Really long, not a couple of hours. </font><font style="vertical-align: inherit;">Because traffic flew not only through the main site, but also came from the application (available for Android and iOS), as well as aggregators (Yandex.Food, Delivery Club, Zaka-Zaka).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What we saw</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Technically, the project turned out to be quite complicated:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The site is a react application with SSR (server side rendering).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mobile applications - for iOS / Android.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API - all applications work with it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External systems, including order processing.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system was a reverse proxy server: the traffic to them went through the protection system from DDoS attacks and from there it was already distributed to the backend servers. </font><font style="vertical-align: inherit;">At the time of acceptance, there was an old site and an API for mobile versions, and the development of a new site began. </font><font style="vertical-align: inherit;">The development of the new API was carried out on separate servers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The database cluster consisted of two servers with master / master replication, where switching in the event of a failure was performed at the network level due to floating IP. </font><font style="vertical-align: inherit;">All write applications worked with this IP, while there were MySQL slaves for reading located on each backend server - where the application, accordingly, worked with localhost. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the reception, we saw the following problems:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An insufficiently reliable balancing mechanism in the database configuration. </font><font style="vertical-align: inherit;">Master replication master led to frequent failures.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slaves on each backend - required a large amount of disk space. </font><font style="vertical-align: inherit;">And any manipulation or adding new backend servers was expensive.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was no common deployment system for applications - there was a self-contained deployment system via the web.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was no system for collecting logs - as a result of which it is quite difficult to investigate incidents, first of all, in working with the order system, since there is no way to determine how a particular order was received.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was no monitoring of business indicators - it was not possible to timely record a decrease or complete absence of orders.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the initial audit of the servers accepted for monitoring, we started with the formation of an operational roadmap. </font><font style="vertical-align: inherit;">Initially, two main areas of work were identified:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stabilization of applications.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organization of a comfortable development environment for the new API and site.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The decisions in the first direction were primarily related to the stabilization of the MySQL cluster. I did not want to refuse the master replication master, but it was impossible to continue working with a floating IP. Disruptions in network connectivity were periodically observed, which led to disruptions in the operation of the cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we decided to abandon the floating IP in favor of a proxy server, where the upstream will be controlled between the masters, as we used nginx as a proxy for MySQL. The second step is the allocation of two separate servers for slaves. Work with them was also organized through a proxy server. And since the reorganization, we forgot about the problems associated with working with the database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we monitored orders at the query level in the database. Any deviation from the norm - to a greater or lesser extent - immediately gave rise to an investigation. Then, at the log level, we formed metrics for monitoring external interactions, in particular, with the order management system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Together with colleagues, upon their requests, we carried out an additional adjustment of all systems to stable and fast operation. It was both tuning MySQL and updating versions of PHP. In addition, colleagues introduced a caching system based on Redis, which also helped to reduce the load on the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this was important ... But the main thing for the business was an increase in sales. And in this context, the company managers had high hopes for the new site. For developers, it was necessary to get a stable and convenient system for deployment and application control.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we thought about the assembly and delivery pipelines of the CI / CD application, as well as the systems for collecting and working with logs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All client repositories were hosted on a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self-hosted bitbucket solution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">For the organization of the pipelines, jenkins was chosen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To begin with, it was customary to implement pipelines on dev environments - this allowed us to significantly increase the development speed. </font><font style="vertical-align: inherit;">Then it was introduced on production circuits, where the automatic deployment allowed us to avoid frequent errors, usually caused by the human factor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After implementation, CI / CD started organizing the collection of logs and working with them. </font><font style="vertical-align: inherit;">The ELK stack was chosen as the main one, which allowed the client to conduct investigations faster and better in the event of an incident. </font><font style="vertical-align: inherit;">And as a result, application development went faster.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúMore terrible than two fires ...‚Äù </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After solving quite complex, but nonetheless standard tasks, the Tanuki told us what they had wanted to say for a long time: ‚ÄúLet's move!‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The change in DC was caused by economic factors. </font><font style="vertical-align: inherit;">In addition, the client expanded its infrastructure with additional services that were already in the new DC, which also influenced the decision to move. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Migration of any system, let alone complex one, is a process that requires extensive planning and large resources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The move was carried out iteratively: at the first stage, reverse proxy servers were created in the new DC. </font><font style="vertical-align: inherit;">And since only they have public ip, they also acted as access points to the system for administrators. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we launched all infrastructure services - logging and CI / CD. </font><font style="vertical-align: inherit;">A </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allowed to organize a convenient, manageable and fairly reliable service of interaction between client applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following databases migrated, Redis and the queue broker - RabbitMQ. It was important to organize everything so that they were correctly registered in the service discovery protocol, which, in turn, controlled the operation of the DNS. Note that the applications did not work directly with the database, but through Haproxy, which allows you to conveniently and balance between databases and switch in case of failure.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the preparatory stage, database replication between data centers did not rise. I just had to transfer the backups. Next, we started to configure the applications directly, and this is the organization of all interaction through the internal DNS - the interaction between the application and the database / Redis / RabbitMQ / external services (for example, order services). Naturally, at the same stage, all CI / CD mechanisms were immediately connected - and then a second change in architecture arose. Previously, changing the application settings through the interface was not possible - only through editing files directly in the console. Immediately, we introduced a solution that allows you to conveniently manage settings - through the web interface. It was based on the Hashicorp vault (Consul acted as a backend for it), which allowed us to build convenient mechanisms for managing environment variables.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to switch services to the new DC. </font><font style="vertical-align: inherit;">Since the work of all systems was organized using the http protocol, and all domains went through a system of protection against DDoS attacks, switching switched to manipulating upstream directly in the interface of this system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Previously, the necessary replicas were organized from the old DC to the new one. </font><font style="vertical-align: inherit;">And a switch was made to the agreed window of work.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What infrastructure looks like now</font></font></h4><br>
<br>
<img src="https://habrastorage.org/webt/bw/t8/-b/bwt8-bwnoht1bovv2dpszzcivr0.jpeg"><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All traffic goes to the balancers. </font><font style="vertical-align: inherit;">Traffic to the API goes from the Tanuki application (on Android / iOS) not directly, but through Qrator.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On a static server is the main site of the tanuki.ru project, a server with landing pages.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The backend cluster now consists of servers: frontend, static, servers for applications.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme of order passing The</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
received order passes through Qrator (immediately we filter out attacks) and comes to the API. </font><font style="vertical-align: inherit;">Then he goes to Raiden to deliver the order, goes to Redis and goes to nginx, after which he leaves for the database.</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What has changed for the customer</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reliability of the system: problems were observed in July 2019 - orders were not issued within an hour. </font><font style="vertical-align: inherit;">But that was before the global move. </font><font style="vertical-align: inherit;">No major incidents were subsequently observed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The life of developers: they have a convenient development environment, CI / CD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fault tolerance: the infrastructure now withstands a lot of traffic. </font><font style="vertical-align: inherit;">For example, during the holidays, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peaked at 550 units.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What's next</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In modern conditions, online sales come to the fore. </font><font style="vertical-align: inherit;">The project should provide reliability and accessibility for service customers. </font><font style="vertical-align: inherit;">But development is also a very important component: product releases should be as quick and invisible to end users as possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another important issue is the utilization of resources and reducing the cost of maintaining the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this leads to the need to review the system as a whole. </font><font style="vertical-align: inherit;">The first step is to organize application containerization. </font><font style="vertical-align: inherit;">Then it plans to organize a Kubernetes cluster. </font><font style="vertical-align: inherit;">But we will talk about this in the next article. </font><font style="vertical-align: inherit;">In the meantime - bon appetit :-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500614/index.html">Folder Sharing in Zimbra Open-Source Edition</a></li>
<li><a href="../en500616/index.html">Fujitsu and Microsoft Joint Fuinitsu PRIMEFLEX Webinar</a></li>
<li><a href="../en500622/index.html">Can a manager motivate his employees?</a></li>
<li><a href="../en500624/index.html">Management of individual development of team members</a></li>
<li><a href="../en500632/index.html">Build sentry and its dependencies in rpm. Installing sentry from rpm, basic setup. LDAP connection</a></li>
<li><a href="../en500638/index.html">The new Chinese promising manned ship. Its history and role in the modern moon race</a></li>
<li><a href="../en500640/index.html">How to make a successful outsourcing company</a></li>
<li><a href="../en500642/index.html">Igrostroy: threshold for entering the industry, specialties and possible income</a></li>
<li><a href="../en500644/index.html">Random Coffee Habr Edition - networking for the IT community</a></li>
<li><a href="../en500646/index.html">Cooking bytecode in the JVM kitchen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>