<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄ üìß üë° Acceso seguro a una casa inteligente en ausencia de una IP p√∫blica (parte 2) üåò ‚ÅâÔ∏è üíÜüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introducci√≥n
 En la primera parte, escrib√≠ sobre el enunciado del problema y c√≥mo se transform√≥ la lista de deseos. Al final, decid√≠ usar OpenVPN, per...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acceso seguro a una casa inteligente en ausencia de una IP p√∫blica (parte 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505412/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la primera parte,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escrib√≠ sobre el enunciado del problema y c√≥mo se transform√≥ la lista de deseos. </font><font style="vertical-align: inherit;">Al final, decid√≠ usar OpenVPN, pero, debido al hecho de que decid√≠ ejecutar todo en contenedores Docker, result√≥ que no era tan simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debo decir de inmediato que m√°s tarde rehice todo de nuevo, como resultado rechac√© un VPS externo. </font><font style="vertical-align: inherit;">Sin embargo, dado que todo est√° en contenedores, en el proceso me encontr√© con una serie de caracter√≠sticas interesantes, que ser√°n discutidas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Describir√© solo puntos clave.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker</font></font></h3><br>
<pre><code class="plaintext hljs">docker run -d --name iobhost  --net=host -v /opt/iobroker/:/opt/iobroker/ --device=/dev/ttyACM0 --env-file /opt/ioBroker_env.list --restart=always buanet/iobroker:latest
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como tengo un MiHome Gateway, los sensores est√°n conectados a √©l, incluso se configuraron varios escenarios, que a√∫n no quiero romper, conect√© ioBroker a √©l. Vio los sensores, no tuvo que volver a atarlos al palo Zigbee (aunque tambi√©n los hay, y algunos botones est√°n conectados a √©l). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠, para que ioBroker se comunique con MiHome Gateway y comience a ejecutarlo con el par√°metro --net = host. Aquellos. utiliza la interfaz de host; no necesita especificar qu√© puertos reenviar al contenedor. Sin esto, no podr√≠a ver la puerta de enlace, porque trabaja a trav√©s de multidifusi√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El par√°metro --device = / dev / ttyACM0 es necesario para reenviar el dispositivo USB Zigbee al contenedor. </font><font style="vertical-align: inherit;">Tambi√©n en /opt/ioBroker_env.list tuve que agregar la l√≠nea USBDEVICES = "/ dev / ttyACM0". </font><font style="vertical-align: inherit;">Es importante que esta l√≠nea est√© presente en el momento del primer inicio del contenedor, cuando ve un directorio vac√≠o y comienza su configuraci√≥n inicial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede configurarlo m√°s tarde, por supuesto, pero tendr√° que hacer movimientos corporales adicionales.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor MQTT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un VPS externo, lanz√≥ el mosquito eclipse. </font><font style="vertical-align: inherit;">Primero configur√© TLS para √©l emitiendo un certificado Let's cifre. </font><font style="vertical-align: inherit;">Luego decidi√≥ que los clientes deben presentar el certificado, y solo entonces el nombre y la contrase√±a (protecci√≥n contra fuerza bruta). </font><font style="vertical-align: inherit;">As√≠ que lo rehice a autofirmado, para que los clientes escriban certificados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openvpn</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utiliza im√°genes populares con Docker Hub. </font><font style="vertical-align: inherit;">Para el servidor (VPS) kylemanna / openvpn. </font><font style="vertical-align: inherit;">Para el cliente (el servidor dom√©stico donde est√° instalado ioBroker) - ekristen / openvpn-client.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalizaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ tuve que jugar. </font><font style="vertical-align: inherit;">En el proceso, sent√≠ bien los aspectos de la red del acoplador, al trabajar con iptables, descubr√≠ uno nuevo, que inclu√≠a </font><font style="vertical-align: inherit;">plan de red con el que no ten√≠a negocios antes. </font><font style="vertical-align: inherit;">En realidad, por lo tanto, decid√≠ escribir este art√≠culo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor VPS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la instalaci√≥n de OpenVPN y la configuraci√≥n, todo es est√°ndar, ya </font><font style="vertical-align: inherit;">que est√° escrito </font><font style="vertical-align: inherit;">en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/r/kylemanna/openvpn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que hice adicionalmente fue aumentar los bucles adicionales en el VPS y el servidor dom√©stico. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/netplan/01-netcfg.yaml</font></font></i><br>
<br>
<pre><code class="plaintext hljs">	# This file describes the network interfaces available on your system<font></font>
	# For more information, see netplan(5).<font></font>
	network:<font></font>
	  version: 2<font></font>
	  renderer: networkd<font></font>
	  &lt;b&gt;ethernets:<font></font>
	    lo:<font></font>
	      renderer: networkd<font></font>
	      match:<font></font>
	        name: lo<font></font>
	      addresses:<font></font>
        - 192.168.16.1/32&lt;/b&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Negrita destac√≥ el "aditivo". Los espacios no parecen mostrarse, aunque son muy importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las direcciones en los ejemplos usar√°n 192.168.6.0 para la red dom√©stica y 192.168.16.0 para loopback. Intentar√© no equivocarme en ning√∫n lado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openvpn.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agregado</font></font><br>
<br>
<pre><code class="plaintext hljs">server 192.168.16.192 255.255.255.192<font></font>
push "dhcp-option DNS 192.168.16.6"<font></font>
push "route 192.168.16.0 255.255.255.128"<font></font>
client-to-client<font></font>
client-config-dir       /etc/openvpn/ccd/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realic√© un loopback especialmente desde 192.168.16.0/25, y doy direcciones a clientes desde 192.168.16.128/25, para que posteriormente las reglas de resoluci√≥n en iptables puedan configurarse con una √∫nica grilla 192.168.16.0/24 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, VPS tiene un loopback de 192.168.16.1, tiene mqtt en √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servidor dom√©stico tiene 192.168.16.6. Existe iobroker, tambi√©n conocido como dns para clientes dom√©sticos y redefine una serie de nombres de dominio para conectarse desde la red dom√©stica o a trav√©s de una VPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hab√≠a una idea en todas partes para registrar su IP "real" de la red. Escriba ccd / iobroker para especificar </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iroute 192.168.6.6 255.255.255.255</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, aparentemente por el hecho de que esta es una direcci√≥n de la red en la interfaz WiFi de la computadora port√°til dom√©stica, y en muchos casos es la puerta de enlace predeterminada, hubo fallas. Incluyendo con un tel√©fono inteligente. Y quer√≠a que la red dom√©stica funcionara tanto con un cliente activo como sin √©l. Y no tuve que desconectar fren√©ticamente al cliente, volver a casa para obtener acceso a otros recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, configur√© este servidor y sus contenedores para interactuar siempre con loopback, independientemente de si la VPN est√° activa. Y se estaba dirigiendo la misma direcci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ccd / iobroker</font></font></i><br>
<br>
<pre><code class="plaintext hljs">iroute 192.168.16.6 255.255.255.255</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, todos los clientes VPN saben que la red 192.168.16.0/24 es accesible a trav√©s de una VPN. Si env√≠an paquetes a 192.168.16.1 (VPS de bucle invertido), el paquete est√° encriptado, ingresa al contenedor openvpn, descifrado, la ruta predeterminada va a 172.17.0.1 (puerta de enlace predeterminada en los contenedores predeterminados), llega al host, todo est√° bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øc√≥mo puedo "hacer ping" al cliente VPN desde el host VPS o acceder al servidor dom√©stico con la direcci√≥n 192.168.16.6 (y no su IP temporal en el t√∫nel VPN que est√° dentro del contenedor OpenVPN)? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, la malla 192.168.16.0 debe enrutarse al contenedor OpenVPN. Por supuesto, puedo ver que es 172.17.0.3. Pero un d√≠a puede cambiar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si OpenVPN se implementara directamente en el servidor, y no en el contenedor, todo funcionar√≠a solo. </font><font style="vertical-align: inherit;">Y luego tuve que hacerlo con astucia. </font><font style="vertical-align: inherit;">Creo un script que es desarrollado por lo √∫ltimo en el sistema, y ‚Äã‚Äãlo pongo en √©l:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' vpn-client)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquellos. </font><font style="vertical-align: inherit;">A trav√©s de la inspecci√≥n de Docker, descubro la direcci√≥n IP del contenedor en ejecuci√≥n y luego enruto la cuadr√≠cula a ella de la manera habitual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferencia del habitual rc.local, tuve que buscarlo en Google, pero c√≥mo, de hecho, hacer un script que se ejecute en √∫ltimo lugar. </font><font style="vertical-align: inherit;">Aqu√≠ hay una breve instrucci√≥n: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree el archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit] <font></font>
Description=My Custom Target<font></font>
Requires=multi-user.target<font></font>
After=multi-user.target<font></font>
AllowIsolate=yes<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crear archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/last_command.service</font></font></i> <br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=My custom command<font></font>
After=multi-user.target<font></font>
[Service]<font></font>
Type=simple<font></font>
ExecStart=/usr/local/bin/my_last_command.sh<font></font>
[Install]<font></font>
WantedBy=custom.target<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree el directorio </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target.wants</font></font></i><br>
<br>
<pre><code class="plaintext hljs">ln -s /etc/systemd/system/last_command.service \   /etc/systemd/system/custom.target.wants/last_command.service<font></font>
systemctl daemon-reload<font></font>
systemctl set-default custom.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea comenzar de inmediato, sin esperar un reinicio: systemctl isolate custom.target </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, despu√©s del reinicio </font><font style="vertical-align: inherit;">, el </font><font style="vertical-align: inherit;">archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descrito en ExecStart </font><font style="vertical-align: inherit;">ser√° el √∫ltimo </font><font style="vertical-align: inherit;">en iniciarse.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el servidor mqtt, tengo 2 puertos planteados: 8883 con TLS y autenticaci√≥n, accesible desde Internet para sensores remotos. S√≠, y yo mismo puedo conectar MQTT Explorer de alguna manera y verificar qu√© y c√≥mo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1883 ya sin TLS, requiere solo un nombre de usuario y contrase√±a. Necesario para el hogar Sonoff rfBridge, que TLS no sabe c√≥mo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto no da miedo, porque el tr√°fico desde casa ir√° al servidor con iobroker, que es la puerta de enlace predeterminada para 192.168.16.0, reenviar√° el paquete a un contenedor con OpenVPN, etc. Sin embargo, debe permitir el acceso al puerto 1883 solo desde el interior. Aquellos. iptables </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El enfoque est√°ndar es negar el acceso a este puerto desde cualquier lugar, luego seguir la regla que permite el acceso desde redes internas.</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I INPUT -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cuadr√≠cula se indica aqu√≠ 172.17.0.0, porque de OpenVPN a los "vecinos" termino yendo como hide NAT (que es un contenedor de iobroker que rfBridge es de una red WiFi), y no de los originales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠ funciona. </font><font style="vertical-align: inherit;">Pero hay un matiz. </font><font style="vertical-align: inherit;">Mi puerto 1883 se reenv√≠a al contenedor mqtt. </font><font style="vertical-align: inherit;">Y, como result√≥, iptables primero cumple la cadena DOCKER-USER. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, con esta regla, se permiti√≥ el acceso al puerto 1883 a la regla de bloqueo. </font><font style="vertical-align: inherit;">Y desde Internet, tambi√©n puede conectarse f√°cilmente a √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Se debe crear una regla de bloqueo en la cadena DOCKER-USER!</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I DOCKR-USER -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la inferior, que permite el acceso desde redes internas, por alguna raz√≥n requiere ENTRADA.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de inicio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La parte principal es la misma. </font><font style="vertical-align: inherit;">Sin embargo, aunque era un cliente, tuvo que enrutar el tr√°fico desde una red WiFi (rfBridge) a mqtt en VPS. </font><font style="vertical-align: inherit;">Aquellos. </font><font style="vertical-align: inherit;">movimiento de tr√°fico: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rfBridge (192.168.6.8) -&gt; host iobroker (192.168.6.6) -&gt; contenedor vpn-client (172.17.0.?) -&gt; contenedor opevpn en VPS -&gt; loopback VPS (192.168.16.1) -&gt; contenedor mqtt (puerto 1883) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permitimos paquetes "reenviados" para la cuadr√≠cula con clientes y bucles:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A FORWARD -d 192.168.16.0/24 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y pasar a los detalles del contenedor.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarea 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como recordar√°n, la interacci√≥n entre los subsistemas que he configurado a trav√©s del bucle invertido. </font><font style="vertical-align: inherit;">Aquellos. </font><font style="vertical-align: inherit;">es necesario que los paquetes en 192.168.16.6 desde vpn-client vayan al host (172.17.0.1) y no al t√∫nel VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si ejecuta este comando en un contenedor en ejecuci√≥n, todo funcionar√°. </font><font style="vertical-align: inherit;">Despu√©s del reinicio, esto se olvidar√°, pero puede especificarlo en el archivo de configuraci√≥n iobroker.ovpn </font></font><br>
<code>route 192.168.16.6 255.255.255.255 172.17.0.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y openvpn instalar√° esta ruta cuando se inicie el contenedor. </font><font style="vertical-align: inherit;">Esto se resuelve f√°cilmente de una manera est√°ndar.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarea 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los paquetes de la red dom√©stica 192.168.6.0 (por ejemplo, de rfBridge) van al host iobroker y se reenv√≠an al contenedor vpn-client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, intencionalmente no incluyo la red 192.168.6.0 en el dominio de cifrado, el contenedor OpenVPN en VPS no sabe qu√© hacer con esta red. La soluci√≥n obvia es hacer NAT dentro de vpn-client para que el paquete en el VPS provenga de su direcci√≥n. Pero hay un matiz. ¬øC√≥mo guardar los comandos necesarios de iptables despu√©s de reiniciar el contenedor? Iptables-persistent no es tan f√°cil de poner all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, puede armar un nuevo contenedor con aditivos. Pero no quiero, porque el procedimiento de actualizaci√≥n ser√° m√°s complicado. En lugar de "asesinado y lanzado m√°s reciente, y sac√≥ la configuraci√≥n de la carpeta montada", ser√° necesario iniciar el ensamblaje ... No por eso me estoy comunicando con contenedores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, decid√≠ "despu√©s del inicio del contenedor, ejecutar por la fuerza comandos que le indiquen a iptables que haga NAT". </font><font style="vertical-align: inherit;">Us√© el equipo para esto </font></font><br>
<code>docker events --filter "container=vpn-client" --filter "event=start"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ella cuelga y espera el evento especificado en los filtros. </font><font style="vertical-align: inherit;">En mi caso, inicie el contenedor. </font><font style="vertical-align: inherit;">Despu√©s de eso, a trav√©s de Docker Exec, ejecuto los comandos requeridos desde el host en √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, por analog√≠a con VPS, configuro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh</font></font></i><br>
<br>
<pre><code class="plaintext hljs">#!/bin/bash<font></font>
cont="vpn-client"<font></font>
ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' $cont)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr<font></font>
for (( ; ; ))<font></font>
do<font></font>
  docker events --filter "container=$cont" --filter "event=start"<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.16.0/255.255.255.0 -j MASQUERADE<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.6.0/255.255.255.0 -j MASQUERADE<font></font>
done<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay ejemplos en los que la salida de los eventos de Docker se pasa a la entrada awk, que ejecuta los comandos. </font><font style="vertical-align: inherit;">Pero me pareci√≥ m√°s f√°cil "colgar" antes del evento, ejecutar comandos y volver a esperar el evento.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Honestamente, no quer√≠a escribir esta publicaci√≥n. Obtuve una experiencia interesante, pero result√≥ "no hermosa", es demasiado dif√≠cil, no me gusta tanto. As√≠ que nuevamente rehice todo, rechac√© VPS en general. Pero desde que promet√≠ la segunda parte ... Adem√°s, me impresion√≥ el enfoque con los eventos de Docker, quer√≠a compartirlo. Creo que ser√° √∫til. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, as√≠ lo decid√≠. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no pude publicar vis a trav√©s de proxy inverso y puedo tomar f√°cilmente mqtt desde el exterior como un servicio, no necesito VPS para esta tarea. Tambi√©n puedo cargar firmware para las actualizaciones de OTA en el alojamiento, hay un beneficio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mqtt asumi√≥ wqtt.ru. </font><font style="vertical-align: inherit;">TLS es (las contrase√±as se env√≠an de forma segura). </font><font style="vertical-align: inherit;">La velocidad es excelente (10 ms frente a 80 ms para mymqtthub). </font><font style="vertical-align: inherit;">No se requieren temas para reescribir en '$ device / &lt;crazy ID&gt; / events' (como Yandex). </font><font style="vertical-align: inherit;">Aquellos. </font><font style="vertical-align: inherit;">en cuyo caso puedes saltar a alg√∫n lugar f√°cilmente. </font><font style="vertical-align: inherit;">El precio es barato (300 rublos por a√±o). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Publico el firmware para OTA en el existente para hosting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El acceso a vis todav√≠a es a trav√©s de Zerotier. </font><font style="vertical-align: inherit;">Es muy simple y conveniente. </font><font style="vertical-align: inherit;">E incluso si est√°n rotos, es poco probable que vea el nivel de CO2 en mi casa por el simple hecho de hacerlo. </font><font style="vertical-align: inherit;">E incluso si esto sucede, pronto se har√° famoso que si me rompen personalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es hermoso, funciona sin fallas, es f√°cil hacer cambios si es necesario, no hay servidores innecesarios que necesiten mantenimiento, estoy satisfecho.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es505394/index.html">Antig√ºedades: Nokia E90, el √∫ltimo comunicador</a></li>
<li><a href="../es505398/index.html">Los lados oscuros y claros del trabajo en Yandex</a></li>
<li><a href="../es505400/index.html">¬øC√≥mo deber√≠an ser las modelos?</a></li>
<li><a href="../es505402/index.html">Superposici√≥n de una textura 2D en un objeto 3D usando p5.js (parte 2 - aplicando un patr√≥n a un cubo)</a></li>
<li><a href="../es505404/index.html">La forma m√°s f√°cil de aprender ingl√©s con videos TED</a></li>
<li><a href="../es505416/index.html">MikroTik en modo repetidor, como One-Two-Three</a></li>
<li><a href="../es505418/index.html">[Pregunta] ¬øHas visto personas que usan suscripciones de contenido m√≥vil?</a></li>
<li><a href="../fr486176/index.html">M√©mo de correspondance par e-mail d'entreprise</a></li>
<li><a href="../fr486178/index.html">FOSS News No. 1 - revue des nouvelles gratuites et open source du 27 janvier au 2 f√©vrier 2020</a></li>
<li><a href="../fr486180/index.html">Conseils et sources pour cr√©er des applications sans serveur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>