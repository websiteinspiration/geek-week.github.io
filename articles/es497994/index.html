<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõê üë®üèæ‚Äçüîß üêÇ La mec√°nica del lenguaje escapa al an√°lisis üë®üèΩ‚Äçü§ù‚Äçüë®üèª üëÅ‚Äçüó® üìç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preludio
 Este es el segundo de cuatro art√≠culos de una serie que proporcionar√° informaci√≥n sobre la mec√°nica y el dise√±o de punteros, pilas, montones...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>La mec√°nica del lenguaje escapa al an√°lisis</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497994/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preludio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es el segundo de cuatro art√≠culos de una serie que proporcionar√° informaci√≥n sobre la mec√°nica y el dise√±o de punteros, pilas, montones, an√°lisis de escape y sem√°ntica Go / Value. </font><font style="vertical-align: inherit;">Esta publicaci√≥n trata sobre montones y an√°lisis de escape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tabla de contenido:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√°nica del lenguaje en pilas y punteros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traducci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√°nica del lenguaje en el an√°lisis de escape</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√°nica del lenguaje en perfiles de memoria</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filosof√≠a de dise√±o sobre datos y sem√°ntica</font></font></a></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la primera publicaci√≥n de esta serie, habl√© sobre los conceptos b√°sicos de la mec√°nica del puntero utilizando un ejemplo en el que el valor se distribuye en la pila entre goroutines. No te mostr√© lo que sucede cuando divides el valor en la pila. Para comprender esto, debe averiguar sobre otra √°rea de la memoria donde pueden estar los valores: sobre el "mont√≥n". Con este conocimiento, puede comenzar a estudiar el "an√°lisis de escape".</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El an√°lisis de escape es un proceso que el compilador utiliza para determinar la ubicaci√≥n de los valores creados por su programa. </font><font style="vertical-align: inherit;">En particular, el compilador realiza un an√°lisis de c√≥digo est√°tico para determinar si el valor se puede colocar en el marco de la pila para la funci√≥n que lo construye, o si el valor debe "escaparse" al mont√≥n. </font><font style="vertical-align: inherit;">No hay una sola palabra clave o funci√≥n en Go que pueda usar para decirle al compilador qu√© decisi√≥n tomar. </font><font style="vertical-align: inherit;">Solo la forma en que escribe su c√≥digo condicionalmente le permite influir en esta decisi√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Much√≠simo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un mont√≥n es una segunda √°rea de memoria, adem√°s de la pila, utilizada para almacenar valores. El mont√≥n no es autolimpiante como las pilas, por lo que usar esta memoria es m√°s costoso. En primer lugar, los costos est√°n asociados con el recolector de basura (GC), que debe mantener limpia esta √°rea. Cuando se inicia el GC, utilizar√° el 25% de la potencia disponible de su procesador. Adem√°s, potencialmente puede crear microsegundos de demoras para "detener el mundo". La ventaja de tener un GC es que no tiene que preocuparse por administrar la memoria de almacenamiento din√°mico que hist√≥ricamente ha sido compleja y propensa a errores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los valores en el mont√≥n provocan asignaciones de memoria en Go. </font><font style="vertical-align: inherit;">Estas asignaciones ejercen presi√≥n sobre el GC porque cada valor en el mont√≥n al que el puntero ya no hace referencia debe eliminarse. </font><font style="vertical-align: inherit;">Cuantos m√°s valores necesite verificar y eliminar, m√°s trabajo debe realizar el GC en cada inicio. </font><font style="vertical-align: inherit;">Por lo tanto, el algoritmo de estimulaci√≥n trabaja constantemente para equilibrar el tama√±o del mont√≥n y la velocidad de ejecuci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compartir pila</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el lenguaje Go, ni una sola goroutina puede tener un puntero apuntando a un recuerdo en la pila de otra goroutine. </font><font style="vertical-align: inherit;">Esto se debe al hecho de que la memoria de la pila para goroutines se puede reemplazar con un nuevo bloque de memoria, cuando la pila debe aumentar o disminuir. </font><font style="vertical-align: inherit;">Si en el tiempo de ejecuci√≥n tuvieras que rastrear los punteros de la pila en otra rutina, tendr√≠as que manejar demasiado, y el retraso de "detener el mundo" al actualizar los punteros a estas pilas ser√≠a asombroso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay un ejemplo de una pila que se reemplaza varias veces debido al crecimiento. </font><font style="vertical-align: inherit;">Mire la salida en las l√≠neas 2 y 6. Ver√° dos veces los cambios de direcci√≥n del valor de la cadena dentro del marco de la pila principal. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/pxn5u4EBSI</font></font></a> <br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√°nica de escape</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada vez que se comparte un valor fuera de la regi√≥n del marco de la pila de una funci√≥n, se coloca (o asigna) en un mont√≥n. La tarea de los algoritmos de an√°lisis de escape es encontrar tales situaciones y mantener el nivel de integridad en el programa. La integridad es garantizar que el acceso a cualquier valor sea siempre preciso, consistente y eficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eche un vistazo a este ejemplo para conocer los mecanismos b√°sicos del an√°lisis de escape. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/Y_VZxYteKO</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Listado 1</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">package</span> main
<span class="hljs-number">02</span>
<span class="hljs-number">03</span> <span class="hljs-keyword">type</span> user <span class="hljs-keyword">struct</span> {
<span class="hljs-number">04</span>     name  <span class="hljs-keyword">string</span>
<span class="hljs-number">05</span>     email <span class="hljs-keyword">string</span>
<span class="hljs-number">06</span> }
<span class="hljs-number">07</span>
<span class="hljs-number">08</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
<span class="hljs-number">09</span>     u1 := createUserV1()
<span class="hljs-number">10</span>     u2 := createUserV2()
<span class="hljs-number">11</span>
<span class="hljs-number">12</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"u1"</span>, &amp;u1, <span class="hljs-string">"u2"</span>, &amp;u2)
<span class="hljs-number">13</span> }
<span class="hljs-number">14</span>
<span class="hljs-number">15</span> <span class="hljs-comment">//go:noinline</span>
<span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }
<span class="hljs-number">25</span>
<span class="hljs-number">26</span> <span class="hljs-comment">//go:noinline</span>
<span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso la directiva go: noinline para que el compilador no incruste c√≥digo para estas funciones directamente en main. La incrustaci√≥n eliminar√° las llamadas a funciones y complicar√° este ejemplo. Hablar√© sobre los efectos secundarios de incrustar en la pr√≥xima publicaci√≥n.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
El Listado 1 muestra un programa con dos funciones diferentes que crean un valor de tipo usuario y lo devuelven a la persona que llama. La primera versi√≥n de la funci√≥n usa la sem√°ntica del valor cuando regresa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 2</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dije que la funci√≥n usa la sem√°ntica de los valores cuando regresa, porque un valor de tipo usuario creado por esta funci√≥n se copia y se pasa a la pila de llamadas. Esto significa que la funci√≥n de llamada recibe una copia del valor en s√≠.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Puede ver la creaci√≥n de un valor de tipo usuario, ejecutado en las l√≠neas 17 a 20. Luego, en la l√≠nea 23, se pasa una copia del valor a la pila de llamadas y se devuelve al llamante. Despu√©s de devolver la funci√≥n, la pila tiene el siguiente aspecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagen 1 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/me/pj/hsmepjswe1d_ggonuc8jkwscyk8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la Figura 1, puede ver que existe un valor de tipo usuario en ambos marcos despu√©s de llamar a createUserV1. En la segunda versi√≥n de la funci√≥n, la sem√°ntica del puntero se usa para regresar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 3</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dije que una funci√≥n usa sem√°ntica de puntero cuando regresa, porque la pila de llamadas comparte un valor de tipo usuario creado por esta funci√≥n. Esto significa que la funci√≥n de llamada recibe una copia de la direcci√≥n donde se encuentran los valores.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Puede ver el mismo literal estructural que se usa en las l√≠neas 28 a 31 para crear un valor de tipo usuario, pero en la l√≠nea 34 el retorno de la funci√≥n es diferente. En lugar de pasar una copia del valor a la pila de llamadas, se pasa una copia de la direcci√≥n del valor. Basado en esto, puede pensar que despu√©s de la llamada, la pila se ve as√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagen 2</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/ld/nh/muldnhq-xncjaz97pv-647tybme.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si lo que ve en la Figura 2 realmente est√° sucediendo, tendr√° un problema de integridad. </font><font style="vertical-align: inherit;">Un puntero apunta a una pila de llamadas a la memoria que ya no es v√°lida. </font><font style="vertical-align: inherit;">La pr√≥xima vez que se llame a la funci√≥n, la memoria indicada ser√° reformateada y reinicializada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ es donde el an√°lisis de escape comienza a mantener la integridad. </font><font style="vertical-align: inherit;">En este caso, el compilador determinar√° que no es seguro crear un valor de tipo usuario dentro del marco de la pila createUserV2, por lo que crear√° un valor en el mont√≥n. </font><font style="vertical-align: inherit;">Esto suceder√° inmediatamente durante la construcci√≥n en la l√≠nea 28.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legibilidad</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como aprendi√≥ en una publicaci√≥n anterior, una funci√≥n tiene acceso directo a la memoria dentro de su marco a trav√©s del puntero del marco, pero el acceso a la memoria fuera del marco requiere acceso indirecto. Esto significa que el acceso a los valores que caen en el mont√≥n tambi√©n debe hacerse indirectamente a trav√©s de un puntero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde c√≥mo se ve el c√≥digo createUserV2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 4</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La sintaxis oculta lo que realmente sucede en este c√≥digo. La variable u declarada en la l√≠nea 28 representa un valor de tipo usuario. La construcci√≥n en Go no le dice exactamente d√≥nde se almacena el valor en la memoria, por lo que antes de la declaraci√≥n de retorno en la l√≠nea 34 no sabe que el valor se acumular√°. Esto significa que aunque u representa un valor de tipo usuario, el acceso a este valor debe ser a trav√©s de un puntero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede visualizar una pila que se ve as√≠ despu√©s de una llamada a la funci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagen 3</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5u/ya/sv/5uyasv63ozdef8jclixqpv4anx4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La variable u en el marco de la pila para createUserV2 representa el valor en el mont√≥n, no en la pila. </font><font style="vertical-align: inherit;">Esto significa que usar u para acceder a un valor requiere acceso a un puntero, no el acceso directo sugerido por la sintaxis. </font><font style="vertical-align: inherit;">Puede pensar, ¬øpor qu√© no hacer un puntero inmediatamente, ya que para acceder al valor que representa todav√≠a se requiere el uso de un puntero? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 5</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := &amp;user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si lo hace, perder√° legibilidad, que no podr√≠a perder en su c√≥digo. </font><font style="vertical-align: inherit;">Al√©jese del cuerpo de la funci√≥n por un segundo y conc√©ntrese en el retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 6</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øDe qu√© est√° hablando este regreso? </font><font style="vertical-align: inherit;">Todo lo que dice es que una copia de u se inserta en la pila de llamadas. </font><font style="vertical-align: inherit;">Mientras tanto, ¬øqu√© le dice return cuando usa el operador &amp;? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 7</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias al operador &amp; return, ahora le dice que est√° compartiendo la pila de llamadas y, por lo tanto, sale al mont√≥n. Recuerde que los punteros est√°n destinados a usarse juntos y, mientras leen el c√≥digo, reemplazan el operador &amp; con la frase "compartir". Es muy poderoso en t√©rminos de legibilidad. Esto es algo que no me gustar√≠a perder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay otro ejemplo donde la construcci√≥n de valores usando sem√°ntica de puntero degrada la legibilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 8</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">var</span> u *user
<span class="hljs-number">02</span> err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(r), &amp;u)
<span class="hljs-number">03</span> <span class="hljs-keyword">return</span> u, err</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que este c√≥digo funcione, cuando llame a json.Unmarshal en la l√≠nea 02, debe pasar un puntero a una variable de puntero. Una llamada json.Unmarshal crear√° un valor de tipo usuario y asignar√° su direcci√≥n a una variable de puntero. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/koI8EjpeIx</font></font></a> </i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Lo que dice este c√≥digo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01: Cree un puntero de tipo usuario con un valor nulo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
02: Comparte la variable u con json. Funci√≥n Unmarshal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
03: Devuelva una copia de la variable u a la persona que llama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No es del todo obvio que un valor de tipo usuario creado por la funci√≥n json.Unmarshal se pasa al llamador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo cambia la legibilidad cuando se usa la sem√°ntica de valores durante la declaraci√≥n de variables? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 9</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">var</span> u user
<span class="hljs-number">02</span> err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(r), &amp;u)
<span class="hljs-number">03</span> <span class="hljs-keyword">return</span> &amp;u, err</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que dice este c√≥digo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01: Cree un valor de tipo usuario con un valor nulo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
02: Comparte la variable u con json. Funci√≥n Unmarshal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
03: Comparta la variable u con la persona que llama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esta muy claro. </font><font style="vertical-align: inherit;">La l√≠nea 02 divide el valor de tipo de usuario en la pila de llamadas en json.Unmarshal, y la l√≠nea 03 divide el valor de la pila de llamadas de nuevo al llamante. </font><font style="vertical-align: inherit;">Este recurso compartido har√° que el valor se mueva al mont√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilice la sem√°ntica de los valores al crear valores y aproveche la legibilidad del operador &amp; para aclarar c√≥mo se separan los valores.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informes del compilador</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ver las decisiones tomadas por el compilador, puede pedirle que proporcione un informe. </font><font style="vertical-align: inherit;">Todo lo que tiene que hacer es usar el modificador -gcflags con la opci√≥n -m cuando llame a go build. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, puede usar 4 niveles de -m, pero despu√©s de 2 niveles de informaci√≥n se vuelve demasiado. </font><font style="vertical-align: inherit;">Usar√© 2 niveles -m. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 10</font></font><br>
<br>
<pre><code class="bash hljs">$ go build -gcflags <span class="hljs-string">"-m -m"</span><font></font>
./main.go:16: cannot inline createUserV1: marked go:noinline<font></font>
./main.go:27: cannot inline createUserV2: marked go:noinline<font></font>
./main.go:8: cannot inline main: non-leaf <span class="hljs-keyword">function</span><font></font>
./main.go:22: createUserV1 &amp;u does not escape<font></font>
./main.go:34: &amp;u escapes to heap<font></font>
./main.go:34:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34<font></font>
./main.go:31: moved to heap: u<font></font>
./main.go:33: createUserV2 &amp;u does not escape<font></font>
./main.go:12: main &amp;u1 does not escape<font></font>
./main.go:12: main &amp;u2 does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede ver que el compilador informa decisiones para volcar el valor en el mont√≥n. </font><font style="vertical-align: inherit;">¬øQu√© dice el compilador? </font><font style="vertical-align: inherit;">Primero, mire nuevamente las funciones createUserV1 y createUserV2 para actualizarlas en la memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 13</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }<font></font>
<font></font>
<span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con esta l√≠nea en el informe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 14</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:22: createUserV1 &amp;u does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto sugiere que la llamada a la funci√≥n println dentro de la funci√≥n createUserV1 no hace que el tipo de usuario sea volcado en el mont√≥n. Este caso tuvo que verificarse porque se usa junto con la funci√≥n println. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, mire estas l√≠neas en el informe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 15</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:34: &amp;u escapes to heap<font></font>
./main.go:34:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34<font></font>
./main.go:31: moved to heap: u<font></font>
./main.go:33: createUserV2 &amp;u does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estas l√≠neas dicen que el valor del tipo de usuario asociado con la variable u, que tiene el tipo de usuario nombrado y se crea en la l√≠nea 31, se vierte en el mont√≥n debido al retorno en la l√≠nea 34. La √∫ltima l√≠nea dice lo mismo que antes, println call en la l√≠nea 33 no restablece el tipo de usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lectura de estos informes puede ser confusa y puede variar ligeramente dependiendo de si el tipo de la variable en cuesti√≥n se basa en un tipo con nombre o literal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifique la variable u para que sea el usuario de tipo literal * en lugar del usuario de tipo con nombre, como era antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 16</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := &amp;user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute el informe nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado 17</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:30: &amp;user literal escapes to heap<font></font>
./main.go:30:     from u (assigned) at ./main.go:28<font></font>
./main.go:30:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora el informe dice que el valor del tipo de usuario al que hace referencia la variable u, que tiene el tipo literal * usuario y se cre√≥ en la l√≠nea 28, se volca en el mont√≥n debido al retorno en la l√≠nea 34.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crear un valor no determina d√≥nde est√° ubicado. </font><font style="vertical-align: inherit;">Solo c√≥mo se divide el valor determinar√° qu√© har√° el compilador con este valor. </font><font style="vertical-align: inherit;">Cada vez que comparte un valor en la pila de llamadas, se descarga en el mont√≥n. </font><font style="vertical-align: inherit;">Hay otras razones por las cuales un valor puede escapar de la pila. </font><font style="vertical-align: inherit;">Hablar√© de ellos en la pr√≥xima publicaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El prop√≥sito de estas publicaciones es proporcionar una gu√≠a para elegir usar sem√°ntica de valor o sem√°ntica de puntero para cualquier tipo dado. </font><font style="vertical-align: inherit;">Cada sem√°ntica se combina con ganancias y valor. </font><font style="vertical-align: inherit;">La sem√°ntica de los valores almacena los valores en la pila, lo que reduce la carga en el GC. </font><font style="vertical-align: inherit;">Sin embargo, hay diferentes copias del mismo valor que deben almacenarse, rastrearse y mantenerse. </font><font style="vertical-align: inherit;">La sem√°ntica de puntero pone los valores en un mont√≥n, lo que puede ejercer presi√≥n sobre el GC. </font><font style="vertical-align: inherit;">Sin embargo, son efectivos porque solo hay un valor que debe almacenarse, rastrearse y mantenerse. </font><font style="vertical-align: inherit;">El punto clave es el uso de cada sem√°ntica de manera correcta, consistente y equilibrada.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es497982/index.html">Enfoque funcional y de proceso para la gesti√≥n. ¬øC√≥mo y qu√© gestionar?</a></li>
<li><a href="../es497984/index.html">Migraci√≥n de reCAPTCHA a hCaptcha en Cloudflare</a></li>
<li><a href="../es497986/index.html">Supervisi√≥n de toda la memoria utilizada por una p√°gina web: performance.measureMemory ()</a></li>
<li><a href="../es497988/index.html">Reaccionar el perfil de rendimiento de la aplicaci√≥n</a></li>
<li><a href="../es497990/index.html">PostgreSQL: Desarrollo de extensiones (funciones) en lenguaje C</a></li>
<li><a href="../es497996/index.html">No quieres fortalecer la inmunidad. O los extremos del cuerpo humano</a></li>
<li><a href="../es498000/index.html">Cosas que me gustar√≠a saber antes de desarrollar mi propio juego</a></li>
<li><a href="../es498002/index.html">Gu√≠a de bolsillo para el Z3</a></li>
<li><a href="../es498004/index.html">Estaci√≥n de trabajo en un contenedor acoplable</a></li>
<li><a href="../es498006/index.html">Elegir un abogado de patentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>