<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÉ üêß üßìüèΩ Goroutine-Stapelpuffer üêí ü§∏üèΩ ü¶Ç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich habe mich gefragt, ob ich Arrays und Slices auf dem Stapel platziert habe, wie std :: array in C ++ und Arrays in C. Der Stapel wurde von Vincent ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Goroutine-Stapelpuffer</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490618/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe mich gefragt, ob ich Arrays und Slices auf dem Stapel platziert habe, wie std :: array in C ++ und Arrays in C. </font><font style="vertical-align: inherit;">Der Stapel wurde von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vincent Blanchon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in dem Artikel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go: Wie entwickelt sich die Goroutine-Stapelgr√∂√üe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gut geschrieben </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">? </font></a><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vincent spricht √ºber Stapelwechsel in Goroutinen. </font><font style="vertical-align: inherit;">Zusammenfassend:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minimale Stapelgr√∂√üe 2 KB;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die maximale Gr√∂√üe h√§ngt von der Architektur ab, bei einer 64-Bit-Architektur von 1 GB.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jedes Mal verdoppelt sich die Stapelgr√∂√üe;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Stapel nimmt zu und ab.</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich werde herausfinden, wie viel auf den Stapel gelegt werden kann und welchen Overhead dies mit sich bringen kann.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich werde go 1.13.8 verwenden, das aus dem Quellcode mit Debugging-Informationen und Kompilierungsoptionen kompiliert wurde </font></font><code>-gcflags=-m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um die Debug-Ausgabe zu erhalten, w√§hrend das Programm ausgef√ºhrt wird, sollten Sie </font></font><code>runtime/stack.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Konstante </font></font><code>stackDebug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf den gew√ºnschten Wert setzen:</font></font></p><br>
<pre><code class="go hljs"><span class="hljs-keyword">const</span> (
    <span class="hljs-comment">// stackDebug == 0: no logging</span>
    <span class="hljs-comment">//            == 1: logging of per-stack operations</span>
    <span class="hljs-comment">//            == 2: logging of per-frame operations</span>
    <span class="hljs-comment">//            == 3: logging of per-word updates</span>
    <span class="hljs-comment">//            == 4: logging of per-word reads</span>
    stackDebug       = <span class="hljs-number">0</span>
    <span class="hljs-comment">//...</span>
)</code></pre><br>
<h4 id="ochen-prostaya-programma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sehr einfaches Programm</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich beginne mit einem Programm, das nichts unternimmt, um zu sehen, wie sich der Stapel unter der Hauptgoroutine abhebt:</font></font></p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
}</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sehen, wie der globale Pool mit den Segmenten 2, 8, 32 KB gef√ºllt ist:</font></font></p><br>
<pre><code class="bash hljs">$ GOMAXPROCS=1 ./app <font></font>
stackalloc 32768<font></font>
  allocated 0xc000002000<font></font>
stackalloc 2048<font></font>
stackcacherefill order=0<font></font>
  allocated 0xc000036000<font></font>
stackalloc 32768<font></font>
  allocated 0xc00003a000<font></font>
stackalloc 8192<font></font>
stackcacherefill order=2<font></font>
  allocated 0xc000046000<font></font>
stackalloc 2048<font></font>
  allocated 0xc000036800<font></font>
stackalloc 2048<font></font>
  allocated 0xc000037000<font></font>
stackalloc 2048<font></font>
  allocated 0xc000037800<font></font>
stackalloc 32768<font></font>
  allocated 0xc00004e000<font></font>
stackalloc 8192<font></font>
  allocated 0xc000048000</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist ein wichtiger Punkt. </font><font style="vertical-align: inherit;">Wir k√∂nnen davon ausgehen, dass der zugewiesene Speicher wiederverwendet wird.</font></font></p><br>
<h4 id="ne-ochen-prostaya-programma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht sehr einfaches Programm</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wo ohne </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Welt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helloWorld</span><span class="hljs-params">()</span></span>  {<font></font>
    fmt.Println(<span class="hljs-string">"Hello world!"</span>)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
    helloWorld()<font></font>
}</code></pre><br>
<pre><code class="bash hljs">runtime: newstack sp=0xc000036348 stack=[0xc000036000, 0xc000036800]<font></font>
    morebuf={pc:0x41463b sp:0xc000036358 lr:0x0}<font></font>
    <span class="hljs-built_in">sched</span>={pc:0x4225b1 sp:0xc000036350 lr:0x0 ctxt:0x0}<font></font>
stackalloc 4096<font></font>
stackcacherefill order=1<font></font>
  allocated 0xc000060000<font></font>
copystack gp=0xc000000180 [0xc000036000 0xc000036350 0xc000036800] -&gt; [0xc000060000 0xc000060b50 0xc000061000]/4096<font></font>
stackfree 0xc000036000 2048<font></font>
stack grow <span class="hljs-keyword">done</span><font></font>
stackalloc 2048<font></font>
  allocated 0xc000036000<font></font>
Hello world!</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gr√∂√üe von 2 KB war nicht ausreichend und die Zuweisung von 4 KB des Blocks ging. </font><font style="vertical-align: inherit;">Wir werden uns mit den Zahlen in eckigen Klammern befassen. </font><font style="vertical-align: inherit;">Dies sind Adressen, an den R√§ndern ist dies der Strukturwert:</font></font></p><br>
<pre><code class="go hljs"><span class="hljs-comment">// Stack describes a Go execution stack.</span>
<span class="hljs-comment">// The bounds of the stack are exactly [lo, hi),</span>
<span class="hljs-comment">// with no implicit data structures on either side.</span>
<span class="hljs-keyword">type</span> stack <span class="hljs-keyword">struct</span> {<font></font>
    lo <span class="hljs-keyword">uintptr</span>
    hi <span class="hljs-keyword">uintptr</span>
}</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der Mitte ist dies eine Adresse, die angibt, wie viel der Stapel verwendet wird, berechnet wie folgt:</font></font></p><br>
<pre><code class="go hljs"><span class="hljs-comment">//...</span><font></font>
used := old.hi - gp.sched.sp<font></font>
<span class="hljs-comment">//...</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"copystack gp="</span>, gp, <span class="hljs-string">" ["</span>, hex(old.lo), <span class="hljs-string">" "</span>, hex(old.hi-used), <span class="hljs-string">" "</span>, hex(old.hi), <span class="hljs-string">"]"</span>, <span class="hljs-string">" -&gt; ["</span>, hex(<span class="hljs-built_in">new</span>.lo), <span class="hljs-string">" "</span>, hex(<span class="hljs-built_in">new</span>.hi-used), <span class="hljs-string">" "</span>, hex(<span class="hljs-built_in">new</span>.hi), <span class="hljs-string">"]/"</span>, newsize, <span class="hljs-string">"\n"</span>)</code></pre><br>
<p>  :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>[0xc000036000 0xc000036350 0xc000036800]</td>
<td>2048</td>
<td>848</td>
</tr>
<tr>
<td>[0xc000060000 0xc000060b50 0xc000061000]</td>
<td>4096</td>
<td>2896</td>
</tr>
</tbody>
</table></div><br>
<p>    -  :</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helloWorld</span><span class="hljs-params">()</span></span>  {<font></font>
    fmt.Println(<span class="hljs-string">"Hello world!"</span>)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span> ; i&lt; <span class="hljs-number">12</span> ; i++ {
        <span class="hljs-keyword">go</span> helloWorld()<font></font>
    }<font></font>
<font></font>
    time.Sleep(<span class="hljs-number">5</span>*time.Second)<font></font>
}</code></pre><br>
<pre><code class="bash hljs">$ ./app 2&gt;&amp;1 | grep <span class="hljs-string">"alloc 4"</span><font></font>
stackalloc 4096<font></font>
stackalloc 4096<font></font>
stackalloc 4096<font></font>
stackalloc 4096<font></font>
stackalloc 4096</code></pre><br>
<p>  ,        .    .</p><br>
<h4 id="massivy"></h4><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">stack_test.go</a>  ,    .      <em>bigsize</em>,    <code>go build -gcflags=-m</code>    <code>main.go:8:6: moved to heap: x</code>.</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">const</span> bigsize = <span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>
<span class="hljs-keyword">const</span> depth = <span class="hljs-number">50</span><font></font>
<font></font>
<span class="hljs-comment">//go:noinline</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">step</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">byte</span></span> {
    <span class="hljs-keyword">var</span> x [bigsize]<span class="hljs-keyword">byte</span>
    <span class="hljs-keyword">if</span> i != depth {
        <span class="hljs-keyword">return</span> x[i] * step(i+<span class="hljs-number">1</span>)<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> x[i]<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
    step(<span class="hljs-number">0</span>)<font></font>
}</code></pre><br>
<p> 10 MB,   depth &gt; 50  <code>stack overflow</code>:</p><br>
<pre><code class="bash hljs">runtime: goroutine stack exceeds 1000000000-byte <span class="hljs-built_in">limit</span>
fatal error: stack overflow</code></pre><br>
<p> ,     <code>-gcflags="-m"</code></p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">const</span> bigsize = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">int</span></span> { <span class="hljs-comment">// readSelf buff does not escape</span>
    f, err := os.Open(<span class="hljs-string">"main.go"</span>) <span class="hljs-comment">// inlining call to os.Open</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    count, _ := f.Read(buff)<font></font>
    <span class="hljs-keyword">if</span> err := f.Close(); err != <span class="hljs-literal">nil</span> { <span class="hljs-comment">// inlining call to os.(*File).Close</span>
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> count<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>, count <span class="hljs-keyword">int</span>)</span></span> { <span class="hljs-comment">// printSelf buff does not escape</span>
    tmp := <span class="hljs-keyword">string</span>(buff[:count]) <span class="hljs-comment">// string(buff[:count]) escapes to heap</span>
    <span class="hljs-comment">// inlining call to fmt.Println</span>
    <span class="hljs-comment">// tmp escapes to heap</span>
    <span class="hljs-comment">// printSelf []interface {} literal does not escape</span>
    <span class="hljs-comment">// io.Writer(os.Stdout) escapes to heap</span><font></font>
    fmt.Println(tmp)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> data [bigsize]<span class="hljs-keyword">byte</span><font></font>
    cnt := readSelf(data[:])<font></font>
    printSelf(data[:], cnt)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
    foo() <span class="hljs-comment">// can inline main</span>
}</code></pre><br>
<p>  ,     ,   :</p><br>
<pre><code class="plaintext hljs">stackalloc 2048<font></font>
stackcacherefill order=0<font></font>
  allocated 0xc000042000<font></font>
runtime: newstack sp=0xc00008ef40 stack=[0xc00008e000, 0xc00008f000]<font></font>
    morebuf={pc:0x48e4e0 sp:0xc00008ef50 lr:0x0}<font></font>
    sched={pc:0x48e4b8 sp:0xc00008ef48 lr:0x0 ctxt:0x0}<font></font>
stackalloc 8192<font></font>
stackcacherefill order=2<font></font>
  allocated 0xc000078000<font></font>
copystack gp=0xc000000180 [0xc00008e000 0xc00008ef48 0xc00008f000] -&gt; [0xc000078000 0xc000079f48 0xc00007a000]/8192<font></font>
stackfree 0xc00008e000 4096<font></font>
stack grow done<font></font>
...<font></font>
runtime: newstack sp=0xc0010aff40 stack=[0xc0008b0000, 0xc0010b0000]<font></font>
    morebuf={pc:0x48e4e0 sp:0xc0010aff50 lr:0x0}<font></font>
    sched={pc:0x48e4b8 sp:0xc0010aff48 lr:0x0 ctxt:0x0}<font></font>
stackalloc 16777216<font></font>
  allocated 0xc0010b0000<font></font>
copystack gp=0xc000000180 [0xc0008b0000 0xc0010aff48 0xc0010b0000] -&gt; [0xc0010b0000 0xc0020aff48 0xc0020b0000]/16777216<font></font>
stackfree 0xc0008b0000 8388608<font></font>
stack grow done</code></pre><br>
<p>        ,        .</p><br>
<h4 id="slaysy"></h4><br>
<p>  64 KB     :</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">const</span> bigsize = <span class="hljs-number">1024</span>*<span class="hljs-number">64</span> - <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">int</span></span> { <span class="hljs-comment">// readSelf buff does not escape</span>
    f, err := os.Open(<span class="hljs-string">"main.go"</span>) <span class="hljs-comment">// inlining call to os.Open</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    count, _ := f.Read(buff)<font></font>
    <span class="hljs-keyword">if</span> err := f.Close(); err != <span class="hljs-literal">nil</span> { <span class="hljs-comment">// inlining call to os.(*File).Close</span>
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> count<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>, count <span class="hljs-keyword">int</span>)</span></span> { <span class="hljs-comment">// printSelf buff does not escape</span>
    tmp := <span class="hljs-keyword">string</span>(buff[:count]) <span class="hljs-comment">// string(buff[:count]) escapes to heap</span>
    <span class="hljs-comment">// inlining call to fmt.Println</span>
    <span class="hljs-comment">// tmp escapes to heap</span>
    <span class="hljs-comment">// printSelf []interface {} literal does not escape</span>
    <span class="hljs-comment">// io.Writer(os.Stdout) escapes to heap</span><font></font>
    fmt.Println(tmp)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {<font></font>
    data := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, bigsize) <span class="hljs-comment">// make([]byte, bigsize) does not escape</span><font></font>
    cnt := readSelf(data)<font></font>
    printSelf(data, cnt)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">// can inline main</span><font></font>
    foo()<font></font>
}</code></pre><br>
<pre><code class="plaintext hljs">stackalloc 131072<font></font>
  allocated 0xc0000d0000<font></font>
copystack gp=0xc000000180 [0xc0000c0000 0xc0000cff48 0xc0000d0000] -&gt; [0xc0000d0000 0xc0000eff48 0xc0000f0000]/131072<font></font>
stackfree 0xc0000c0000 65536</code></pre><br>
<h4 id="proizvoditelnost-ili-eyo-otsutstvie">   </h4><br>
<p> Go    (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">zero values</a>).       .      ,         sync.Pool.</p><br>
<p> :</p><br>
<ul>
<li>  ( );</li>
<li>  ;</li>
<li> ( <code>/dev/null</code>).</li>
</ul><br>
<p>,  ,    . </p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">int</span></span> {<font></font>
    f, err := os.Open(<span class="hljs-string">"bench_test.go"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    count, err := f.Read(buff)<font></font>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> err := f.Close(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> count<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printSelf</span><span class="hljs-params">(buff []<span class="hljs-keyword">byte</span>, count <span class="hljs-keyword">int</span>)</span></span> {<font></font>
    f, err := os.OpenFile(os.DevNull, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="hljs-number">0644</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> _, err := f.Write(buff[:count]); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> err := f.Close(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//go:noinline</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">usePoolBlock4k</span><span class="hljs-params">()</span></span> {<font></font>
    inputp := pool4blocks.Get().(*[]<span class="hljs-keyword">byte</span>)<font></font>
    outputp := pool4blocks.Get().(*[]<span class="hljs-keyword">byte</span>)<font></font>
<font></font>
    cnt := readSelf(*inputp)<font></font>
    <span class="hljs-built_in">copy</span>(*outputp, *inputp)<font></font>
    printSelf(*outputp, cnt)<font></font>
<font></font>
    pool4blocks.Put(inputp)<font></font>
    pool4blocks.Put(outputp)<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//go:noinline</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">useStackBlock4k</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> input [block4k]<span class="hljs-keyword">byte</span>
    <span class="hljs-keyword">var</span> output [block4k]<span class="hljs-keyword">byte</span><font></font>
<font></font>
    cnt := readSelf(input[:])<font></font>
    <span class="hljs-built_in">copy</span>(output[:], input[:])<font></font>
    printSelf(output[:], cnt)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkPoolBlock4k</span><span class="hljs-params">(b *testing.B)</span></span> {<font></font>
    runtime.GC()<font></font>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++ {<font></font>
        data := pool4blocks.Get()<font></font>
        pool4blocks.Put(data)<font></font>
    }<font></font>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++ {<font></font>
        usePoolBlock4k()<font></font>
    }<font></font>
<font></font>
    b.ResetTimer()<font></font>
<font></font>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {<font></font>
        usePoolBlock4k()<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkStackBlock4k</span><span class="hljs-params">(b *testing.B)</span></span> {<font></font>
    runtime.GC()<font></font>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++ {<font></font>
        useStackBlock4k()<font></font>
    }<font></font>
    b.ResetTimer()<font></font>
<font></font>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {<font></font>
        useStackBlock4k()<font></font>
    }<font></font>
}</code></pre></div></div><br>
<pre><code class="bash hljs">$ go <span class="hljs-built_in">test</span> -bench=. -benchmem<font></font>
goos: linux<font></font>
goarch: amd64<font></font>
pkg: gostack/04_benchmarks<font></font>
BenchmarkPoolBlock4k-12           312918          3804 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkStackBlock4k-12          313255          3833 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkPoolBlock8k-12           300796          3980 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkStackBlock8k-12          294266          4110 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkPoolBlock16k-12          288734          4138 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkStackBlock16k-12         269382          4408 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkPoolBlock32k-12          272139          4407 ns/op         256 B/op          8 allocs/op<font></font>
BenchmarkStackBlock32k-12         240339          4957 ns/op         256 B/op          8 allocs/op<font></font>
PASS</code></pre><br>
<p>      4 KB,     .    ,       .    :</p><br>
<pre><code class="plaintext hljs">(pprof) top 15<font></font>
Showing nodes accounting for 7.99s, 79.58% of 10.04s total<font></font>
Dropped 104 nodes (cum &lt;= 0.05s)<font></font>
Showing top 15 nodes out of 85<font></font>
      flat  flat%   sum%        cum   cum%<font></font>
     3.11s 30.98% 30.98%      3.38s 33.67%  syscall.Syscall6<font></font>
     2.01s 20.02% 51.00%      2.31s 23.01%  syscall.Syscall<font></font>
     0.83s  8.27% 59.26%      0.83s  8.27%  runtime.epollctl<font></font>
     0.60s  5.98% 65.24%      0.60s  5.98%  runtime.memmove<font></font>
     0.21s  2.09% 67.33%      0.21s  2.09%  runtime.unlock<font></font>
     0.18s  1.79% 69.12%      0.18s  1.79%  runtime.nextFreeFast<font></font>
     0.14s  1.39% 70.52%      0.33s  3.29%  runtime.exitsyscall<font></font>
     0.14s  1.39% 71.91%      0.21s  2.09%  runtime.reentersyscall<font></font>
     0.13s  1.29% 73.21%      0.46s  4.58%  runtime.mallocgc<font></font>
     0.12s  1.20% 74.40%      1.25s 12.45%  gostack/04_benchmarks.useStackBlock32k<font></font>
     0.12s  1.20% 75.60%      0.13s  1.29%  runtime.exitsyscallfast<font></font>
     0.11s  1.10% 76.69%      0.45s  4.48%  runtime.SetFinalizer<font></font>
     0.11s  1.10% 77.79%      0.11s  1.10%  runtime.casgstatus<font></font>
     0.10s     1% 78.78%      0.13s  1.29%  runtime.deferreturn<font></font>
     0.08s   0.8% 79.58%      1.24s 12.35%  gostack/04_benchmarks.useStackBlock16k</code></pre><br>
<p>  syscalls.    <code>useStackBlock32k</code>  <code>getFromStack32k</code>.     120ms:</p><br>
<pre><code class="plaintext hljs">(pprof) list useStackBlock32k<font></font>
Total: 10.04s<font></font>
ROUTINE ======================== useStackBlock32k in bench_test.go<font></font>
     120ms      1.25s (flat, cum) 12.45% of Total<font></font>
         .          .    158:   printSelf(output[:], cnt)<font></font>
         .          .    159:}<font></font>
         .          .    160:<font></font>
         .          .    161://go:noinline<font></font>
         .          .    162:func useStackBlock32k() {<font></font>
      90ms       90ms    163:   var input [block32k]byte<font></font>
      30ms       30ms    164:   var output [block32k]byte<font></font>
         .          .    165:<font></font>
         .      530ms    166:   cnt := readSelf(input[:])<font></font>
         .      160ms    167:   copy(output[:], input[:])<font></font>
         .      440ms    168:   printSelf(output[:], cnt)<font></font>
         .          .    169:}<font></font>
<font></font>
ROUTINE ======================== usePoolBlock32k in bench_test.go<font></font>
      10ms      1.18s (flat, cum) 11.75% of Total<font></font>
         .          .    115:   pool16blocks.Put(outputp)<font></font>
         .          .    116:}<font></font>
         .          .    117:<font></font>
         .          .    118://go:noinline<font></font>
         .          .    119:func usePoolBlock32k() {<font></font>
         .       10ms    120:   inputp := pool32blocks.Get().(*[]byte)<font></font>
         .       10ms    121:   outputp := pool32blocks.Get().(*[]byte)<font></font>
         .          .    122:<font></font>
         .      520ms    123:   cnt := readSelf(*inputp)<font></font>
      10ms      200ms    124:   copy(*outputp, *inputp)<font></font>
         .      440ms    125:   printSelf(*outputp, cnt)<font></font>
         .          .    126:<font></font>
         .          .    127:   pool32blocks.Put(inputp)<font></font>
         .          .    128:   pool32blocks.Put(outputp)<font></font>
         .          .    129:}</code></pre><br>
<p>:</p><br>
<ul>
<li>      10 MB;</li>
<li>      64 KB;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt Overhead zum Aufteilen des Stapels.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt Overhead bei </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nullwert</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de490604/index.html">Verwenden von Gradle- und Github-Aktionen zum Ver√∂ffentlichen eines Java-Projekts im Sonatype Maven Central Repository</a></li>
<li><a href="../de490608/index.html">Systemcode√ºberpr√ºfung mit Git-Tools</a></li>
<li><a href="../de490610/index.html">Baidu schl√§gt Waymo in Kalifornien Robomobile Autonomy Rating</a></li>
<li><a href="../de490612/index.html">Funktionaler Ansatz f√ºr Transaktionen auf Scala oder schreiben Sie Ihre eigene n√ºtzliche Monade</a></li>
<li><a href="../de490616/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends f√ºr die letzte Woche Nr. 404 (24. Februar - 1. M√§rz 2020)</a></li>
<li><a href="../de490620/index.html">Wenn ich die Worte "Wiederherstellung des neuronalen Netzwerks" h√∂re, klettere ich, um Backups zu √ºberpr√ºfen</a></li>
<li><a href="../de490622/index.html">Bek√§mpfung von Speicherlecks in Webanwendungen</a></li>
<li><a href="../de490624/index.html">Funktionsrichtlinien-HTTP-Header- und Webbrowser-Steuerung</a></li>
<li><a href="../de490626/index.html">Eine vollst√§ndige Anleitung zu Daten- * HTML-Attributen</a></li>
<li><a href="../de490628/index.html">Was tun, wenn CSS das Parsen von Seiten blockiert?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>