<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë¶‚Äçüë¶ üëêüèø üßïüèø Anatom√≠a del sistema NSI üë©‚Äçüç≥ ‚ÜïÔ∏è üåû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo est√° basado en hechos reales, 
 y todos los problemas en √©l no son imaginarios. (C)
 
 Al principio, me gustar√≠a se√±alar que el art√≠culo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Anatom√≠a del sistema NSI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492414/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este art√≠culo est√° basado en hechos reales, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 y todos los problemas en √©l no son imaginarios. (C)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Al principio, me gustar√≠a se√±alar que el art√≠culo no pretende mostrar la invenci√≥n de la bicicleta, porque muchas t√©cnicas han existido durante mucho tiempo en la cultura del desarrollo de bases de datos. Sin embargo, para resumir, analice los problemas que pueden resolver y muestre c√≥mo puede trabajar con ellos. Y hay suficientes problemas a pesar del hecho de que la informaci√≥n de referencia (NSI) no se aplica a la l√≥gica empresarial, sino que est√° a su servicio. El proceso est√°ndar de dibujar otra placa para almacenar el directorio muy pronto comienza a crecer con muletas o alteraciones que requieren mucho tiempo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, en mi caso, result√≥ ser la misma imagen: el sistema ha sido productivo durante m√°s de diez a√±os, construido sobre el mismo principio, si es necesario, dibuje y enci√©ndalo. Por lo tanto, se crearon varias tablas para almacenar diversos tipos de equipos. Pero luego lleg√≥ la hora X, cuando se hizo necesario agregar un par de mesas m√°s para nuevos equipos y al mismo tiempo todos (incluidos los viejos) deber√≠an ser incluidos en un determinado grupo. Esto significa que los enlaces a diferentes tablas deben incluirse en la tabla de referencias cruzadas entre el grupo y los cinco tipos de equipos, es decir, para cada uno de sus propios campos con una constante en la tabla correspondiente. Y si se agrega uno m√°s, cambie la estructura. Y el procesamiento debe hacerse seg√∫n los campos que se llenen. Entonces surge el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primer problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥mo resumir diferentes tablas para que pueda trabajar con ellas por igual y no cambiar la estructura si se agrega otra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Una idea maravillosa, creamos una etiqueta separada que est√° dise√±ada para almacenar el concepto abstracto de equipo con una indicaci√≥n del tipo, y luego las tabletas restantes remiten por clave externa a sus padres. En esta ola alegre, llenamos registros de uno en la placa creada y tratamos de crear el otro tambi√©n. Pero algo sali√≥ mal, la restricci√≥n de clave principal funcion√≥, ¬øpor qu√© lo har√≠a? Y al hecho de que en los albores de la turbulenta juventud del sistema, cada plato ten√≠a sus propias secuencias. Por supuesto, con el tiempo se corrigi√≥ esta desgracia, pero las viejas llaves a√∫n permanec√≠an. Adem√°s, germinaron ra√≠ces en claves for√°neas con otras tablas. Arreglamos el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segundo problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asociado con la numeraci√≥n de extremo a extremo de todos los directorios</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tormento con las mesas del equipo no termin√≥ all√≠. Debido a que seg√∫n los √∫ltimos requisitos, el equipo tiene varias caracter√≠sticas, adem√°s, su n√∫mero es variable y una caracter√≠stica puede tener varios valores. Entonces aparece un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tercer problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saber, poder almacenar un n√∫mero variable de caracter√≠sticas de un registro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que lo lograron, pero el cliente est√° alerta, siempre tiene algo nuevo listo. Y luego llega la demanda: todos los directorios son hist√≥ricos (por ejemplo, el nombre del producto era uno y luego se renombr√≥, y de acuerdo con los documentos para diferentes fechas, debe mostrar el nombre actual). El requisito en s√≠ mismo es normal, no puedes decir nada. Y si hay alguien m√°s en el departamento de desarrollo que est√° pasando por un per√≠odo de prueba, entonces todo est√° cubierto de chocolate, es posible que no note que esto es un problema. Sin embargo, todo sigue como de costumbre, con un desglose completo, y luego a√∫n debe hacer esto. Creamos placas duplicando las tablas de los directorios correspondientes para almacenar all√≠ la cronolog√≠a de los cambios en el directorio. Pero al crear estas tablas, tambi√©n creamos un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuarto problema para</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nosotros mismos </font><font style="vertical-align: inherit;">,</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora en el c√≥digo, dependiendo de la fecha, uno debe referirse a la tabla principal o al hist√≥rico</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, somos buenos amigos, tambi√©n ganamos esto))) Ahora, mientras bebe t√© de su propia taza, comienza a discutir con otros colegas sobre lo que ten√≠an que resolver, y comprende que la lista de problemas est√° creciendo. La discusi√≥n plantea la cuesti√≥n de c√≥mo almacenar versiones del mismo registro. Quiero hacer una reserva de que la versi√≥n no es algo que encaje en la tabla de historicidad. En historicidad, es comprensible, hasta esa fecha hab√≠a un nombre, y a partir de esta fecha, otro se vuelve relevante. Y en el control de versiones, se entiende que el registro se guard√≥ primero con un error, y despu√©s de unas horas se entendi√≥ y cambi√≥, y debe conocer todos los estados de este registro. En primer lugar, deber√≠a haber aplastamiento por un tiempo, no solo un d√≠a. Y en segundo lugar, tales huellas son necesarias en caso de enfrentamiento. Por ejemplo, completaron la lista de precios, cometieron un error, lograron vender los productos a ese precio y luego corrigieron:pero al final del d√≠a hubo un desequilibrio. Sin embargo, la decisi√≥n de tales situaciones me molest√≥ personalmente, se propuso almacenar todos esos cambios en la tabla misma. No organizar√© holivar sobre cu√°nto es tan correcto, pero para m√≠ ha quedado claro</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El quinto problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saber</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">el almacenamiento de cambios de registros</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, resumiendo lo anterior, vemos cinco rastrillos pesados ‚Äã‚Äãfrente a nosotros. </font><font style="vertical-align: inherit;">Ahora nuestra tarea es determinar una estrategia que le permita moverse y no pisarlas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°nto puede pisar el mismo rastrillo, desechemos y compremos otros nuevos?</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzando a dise√±ar un sistema desde cero, nadie puede predecir el camino de su desarrollo y, por lo tanto, no puede decir a qu√© nivel ser√° necesario generalizar, como en el ejemplo descrito con el equipo. </font><font style="vertical-align: inherit;">Por lo tanto, tiene sentido establecer inmediatamente una entidad abstracta que se distribuya a todas las tablas NSI. </font><font style="vertical-align: inherit;">Por lo tanto, todos los directorios tendr√°n un prototipo en un solo directorio con la divisi√≥n en tipos.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_type (<font></font>
    nsi_type_id     <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>           <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    table_name      <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_type_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>       <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    create_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    modif_date  <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    begin_date  <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_nsi_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_type (nsi_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_uk <span class="hljs-keyword">UNIQUE</span>(nsi_type_id, nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SEQUENCE</span> nsi_seq
  <span class="hljs-keyword">MINVALUE</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">INCREMENT</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">CACHE</span> <span class="hljs-number">20</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tabla del sistema nsi_type se completa a medida que se agregan nuevos directorios. </font><font style="vertical-align: inherit;">La tabla nsi almacena claves y campos del sistema. </font><font style="vertical-align: inherit;">Al mismo tiempo, creamos nuestra propia secuencia y, por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tanto, </font><b><font style="vertical-align: inherit;">cerramos el segundo problema</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n crearemos un paquete que contenga la funcionalidad b√°sica para trabajar con directorios y lo llenaremos gradualmente.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">NONEDITIONABLE</span> <span class="hljs-keyword">PACKAGE</span> <span class="hljs-keyword">BODY</span> pkg_nsi
<span class="hljs-keyword">IS</span><font></font>
<font></font>
    <span class="hljs-comment">/*      
    *  @param p_table_name VARCHAR2 -  
    *  @return nsi.nsi_type_id%TYPE -    nsi_type
    */</span>
    <span class="hljs-keyword">FUNCTION</span> get_type_id(p_table_name <span class="hljs-keyword">IN</span> <span class="hljs-built_in">VARCHAR2</span>) 
    <span class="hljs-keyword">RETURN</span> nsi_type.nsi_type_id%<span class="hljs-keyword">TYPE</span>
    <span class="hljs-keyword">AS</span>
       v_type_id 	nsi_type.nsi_type_id%<span class="hljs-keyword">TYPE</span>; 
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_type_id <span class="hljs-keyword">INTO</span> v_type_id 
        <span class="hljs-keyword">FROM</span> nsi_type
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">TRIM</span>(<span class="hljs-keyword">LOWER</span>(table_name)) = <span class="hljs-keyword">TRIM</span>(<span class="hljs-keyword">LOWER</span>(p_table_name));<font></font>
<font></font>
        RETURN v_type_id;<font></font>
    <span class="hljs-keyword">END</span> get_type_id;<font></font>
<font></font>
    <span class="hljs-comment">/*   id  nsi_seq
    *  @return nsi.nsi_id%TYPE - id  nsi_seq
    */</span><font></font>
    FUNCTION get_nsi_id <font></font>
    RETURN nsi.nsi_id%TYPE<font></font>
    AS<font></font>
       v_id 	nsi.nsi_id%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>    
        <span class="hljs-keyword">SELECT</span> nsi_seq.NEXTVAL <span class="hljs-keyword">INTO</span> v_id <span class="hljs-keyword">FROM</span> DUAL;<font></font>
        RETURN v_id;<font></font>
    <span class="hljs-keyword">END</span> get_nsi_id;<font></font>
<font></font>
    <span class="hljs-comment">/*      
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -    nsi_type 
    *  @return nsi_type.table_name%TYPE -  
    */</span><font></font>
    FUNCTION get_table_name(p_nsi_type_id IN nsi_type.nsi_type_id%TYPE) <font></font>
    RETURN nsi_type.table_name%TYPE<font></font>
    AS<font></font>
       v_table_name nsi_type.table_name%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> table_name <span class="hljs-keyword">INTO</span> v_table_name 
        <span class="hljs-keyword">FROM</span> nsi_type
        <span class="hljs-keyword">WHERE</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        RETURN v_table_name;<font></font>
    <span class="hljs-keyword">END</span> get_table_name;<font></font>
<font></font>
    <span class="hljs-comment">/*        nsi
    *  @param p_nsi_id nsi.nsi_id%TYPE -   
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -   
    *  @return nsi.descr%TYPE - 
    */</span><font></font>
    FUNCTION get_nsi_descr (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi.nsi_type_id%TYPE) <font></font>
    RETURN nsi.descr%TYPE<font></font>
    AS<font></font>
       v_nsi_descr  nsi.descr%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">descr</span> 
          <span class="hljs-keyword">INTO</span> v_nsi_descr 
          <span class="hljs-keyword">FROM</span> nsi
         <span class="hljs-keyword">WHERE</span> nsi_id = p_nsi_id
           <span class="hljs-keyword">AND</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        RETURN v_nsi_descr;<font></font>
    <span class="hljs-keyword">END</span> get_nsi_descr;<font></font>
...<font></font>
<span class="hljs-keyword">END</span> pkg_nsi;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasta ahora, se han proporcionado funciones auxiliares para proporcionar la infraestructura necesaria. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, la tarea es crear un directorio de organizaciones, donde, sin √©l, cualquier compa√±√≠a contacte a organizaciones de terceros: estos son proveedores, clientes y socios. </font><font style="vertical-align: inherit;">Inmediatamente agregue el tipo correspondiente a la tabla nsi_type y defina la tabla nsi_organization.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_organization (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    full_name   <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    inn         <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">12</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_organization_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_organization_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_type (nsi_type_id, <span class="hljs-keyword">name</span>, <span class="hljs-keyword">descr</span>, table_name) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>, <span class="hljs-string">''</span>, <span class="hljs-string">' , , , '</span>, <span class="hljs-string">'nsi_organization'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, antes de que sea demasiado tarde, debe recordar el rastrillo con el n√∫mero "cinco". </font><font style="vertical-align: inherit;">Si comenzamos a agregar registros a la tabla de organizaciones creada, entonces este evento debe corregirse en alg√∫n lugar.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_log (<font></font>
    nsi_log_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id            <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    table_name        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    oper_num          <span class="hljs-built_in">NUMBER</span>,
    <span class="hljs-keyword">descr</span>             <span class="hljs-keyword">CLOB</span>,<font></font>
    create_date       <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_log_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_log_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_log_oper_num_ch <span class="hljs-keyword">CHECK</span> (oper_num <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>))<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_log <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.nsi_log_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.table_name <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.oper_num <span class="hljs-keyword">IS</span> <span class="hljs-string">'  (1 -  , 2 -  , 3 -  , 4 -  , 5 -  , 6 -  , 7 -   ).'</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.descr <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.create_date <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y tambi√©n se ha agregado una funci√≥n de registro al paquete.</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--  CHECK nsi_log_oper_num_ch</span><font></font>
    NSI_LOG_OPERNUM_INSERT          NUMBER := 1;<font></font>
    NSI_LOG_OPERNUM_UPDATE          NUMBER := 2;<font></font>
    NSI_LOG_OPERNUM_DELETE          NUMBER := 3;<font></font>
    NSI_LOG_OPERNUM_ATTR_INSERT     NUMBER := 4;<font></font>
    NSI_LOG_OPERNUM_ATTR_UPDATE     NUMBER := 5;<font></font>
    NSI_LOG_OPERNUM_ATTR_DELETE     NUMBER := 6;<font></font>
    NSI_LOG_OPERNUM_HISTORY_PUSH    NUMBER := 7;<font></font>
<font></font>
    <span class="hljs-comment">/*    .
    *  @param p_nsi_id nsi.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -  
    *  @param p_oper_num NUMBER -  
    *  @param p_descr VARCHAR2 - 
    */</span><font></font>
    PROCEDURE log_oper (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi_type.nsi_type_id%TYPE,<font></font>
        p_oper_num      IN NUMBER,<font></font>
        p_descr         IN VARCHAR2)<font></font>
    AS<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_log <font></font>
        (nsi_log_id, nsi_id, table_name, oper_num, <span class="hljs-keyword">descr</span>, create_date)
        <span class="hljs-keyword">VALUES</span> 
        (get_nsi_id(), p_nsi_id, get_table_name(p_nsi_type_id), p_oper_num, p_descr, <span class="hljs-keyword">Sysdate</span>);
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se resuelve</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el </font><b><font style="vertical-align: inherit;">quinto problema</font></b><font style="vertical-align: inherit;"> , ahora para cualquier registro NSI puede ver lo que le sucedi√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos tratando de agregar una organizaci√≥n all√≠.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (nsi_id, <span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">' "  "'</span>, <span class="hljs-string">'  "  "'</span>, <span class="hljs-string">'11223344'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, nos encontramos con la constante nsi_organization_nsi_fk. </font><font style="vertical-align: inherit;">Por lo tanto, todas las tablas de b√∫squeda deben estar equipadas con el refinamiento necesario de los desencadenantes.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :NEW.name || ''', full_name = ''' || :NEW.full_name || ''', inn = ''' || :NEW.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_update 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">UPDATE</span> nsi
       <span class="hljs-keyword">SET</span> modif_date = Trunc(<span class="hljs-keyword">Sysdate</span>)
     <span class="hljs-keyword">WHERE</span> nsi_id = :NEW.nsi_id
       <span class="hljs-keyword">AND</span> nsi_type_id = v_type_id;<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :NEW.name || ''', full_name = ''' || :NEW.full_name || ''', inn = ''' || :NEW.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_delete 
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi
    <span class="hljs-keyword">WHERE</span> nsi_id = :OLD.nsi_id
      <span class="hljs-keyword">AND</span> nsi_type_id = v_type_id;<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :OLD.name || ''', full_name = ''' || :OLD.full_name || ''', inn = ''' || :OLD.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora agregar el registro funcionar√° sin problemas (no es necesario especificar la clave). </font><font style="vertical-align: inherit;">Al mismo tiempo, el primer registro aparecer√° en la tabla nsi, y este evento tambi√©n se registrar√° en la tabla de registro.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' "  "'</span>, <span class="hljs-string">'  "  "'</span>, <span class="hljs-string">'11223344'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero por ahora, solo puede notar los costos adicionales de crear una tabla de alg√∫n tipo de directorio, y no la ventaja de un enfoque √∫nico. </font><font style="vertical-align: inherit;">Luego recordamos el cuarto problema: necesitamos almacenar la historicidad de los datos en las tablas del directorio, as√≠ como recuperar el estado actual para una fecha determinada.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_history (<font></font>
    nsi_history_id  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id          <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id     <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">version</span>         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">content</span>         <span class="hljs-keyword">CLOB</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    note            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    begin_date      <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date        <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,     
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_history_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_nsi_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_type (nsi_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_content_json_chk <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">content</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">JSON</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_history <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_history_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.version <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.content <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.note <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el paquete pkg_nsi, agregamos la funci√≥n de guardar el registro en la tabla hist√≥rica. </font><font style="vertical-align: inherit;">Almacenaremos el registro en formato json, por lo que el paquete tambi√©n tendr√° la oportunidad de obtener json para la solicitud transmitida.</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*     json
    *  @param p_query VARCHAR2 - 
    *  @return CLOB -  json
    */</span><font></font>
    FUNCTION get_json(p_query IN VARCHAR2) <font></font>
    RETURN CLOB<font></font>
    AS<font></font>
      v_theCursor       integer default dbms_sql.open_cursor;<font></font>
      v_columnValue     varchar2(4000);<font></font>
      v_status          integer;<font></font>
      v_descTbl         dbms_sql.desc_tab;<font></font>
      v_colCnt          number;<font></font>
      v_res             clob;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        dbms_sql.parse(v_theCursor, p_query, dbms_sql.native);<font></font>
        dbms_sql.describe_columns( v_theCursor, v_colCnt, v_descTbl);<font></font>
<font></font>
        FOR i IN 1 .. v_colCnt LOOP<font></font>
            dbms_sql.define_column(v_theCursor, i, v_columnValue, 4000);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
      <font></font>
        v_status := dbms_sql.execute(v_theCursor);<font></font>
        WHILE ( dbms_sql.fetch_rows(v_theCursor) &gt; 0 ) LOOP<font></font>
            FOR i IN 1 .. v_colCnt LOOP<font></font>
                dbms_sql.column_value( v_theCursor, i, v_columnValue );<font></font>
                IF i &gt; 1 THEN<font></font>
                    v_res := v_res || ', ';<font></font>
                <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
                v_res := v_res || '"' || v_descTbl(i).col_name || '" : "' || <span class="hljs-keyword">replace</span>(v_columnValue, <span class="hljs-string">'"'</span>, <span class="hljs-string">'\"'</span>) || <span class="hljs-string">'"'</span>;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
            <font></font>
            <span class="hljs-comment">--   ,     ,   </span>
            <span class="hljs-comment">--     </span><font></font>
            EXIT;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        RETURN '{' || v_res || '}';<font></font>
      <font></font>
    exception<font></font>
        when others then dbms_sql.close_cursor( v_theCursor ); RAISE;<font></font>
    <span class="hljs-keyword">END</span> get_json;<font></font>
<font></font>
    <span class="hljs-comment">/*       .
    *  @param p_nsi_id nsi.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -  
    *  @param p_end_date nsi_history.end_date%TYPE -     
    *  @param p_note nsi_history.note%TYPE -     
    */</span><font></font>
    PROCEDURE nsi_history_push (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi_type.nsi_type_id%TYPE,<font></font>
        p_end_date      IN nsi_history.end_date%TYPE,<font></font>
        p_note          IN nsi_history.note%TYPE)<font></font>
    AS<font></font>
        v_table_name VARCHAR2(50);<font></font>
        v_content CLOB;<font></font>
        v_max_ver NUMBER;<font></font>
        v_begin_date DATE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">IF</span> (p_end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">THEN</span><font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                <span class="hljs-string">'[nsi_history_push]     .'</span>); 
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        IF (Trunc(p_end_date) &gt; Trunc(Sysdate) ) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_history_push]       .'); <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> begin_date <span class="hljs-keyword">INTO</span> v_begin_date
          <span class="hljs-keyword">FROM</span> nsi
         <span class="hljs-keyword">WHERE</span> nsi_id = p_nsi_id
           <span class="hljs-keyword">AND</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        IF (Trunc(p_end_date) &lt; Trunc(v_begin_date) ) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_history_push]            .'); <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        v_table_name := get_table_name(p_nsi_type_id);<font></font>
        v_content := get_json ('<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">' || v_table_name || '</span> <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-string">' || p_nsi_id);
        
        SELECT MAX(version) INTO v_max_ver
          FROM nsi_history
         WHERE nsi_id = p_nsi_id
           AND nsi_type_id = p_nsi_type_id;
          
        IF (v_max_ver IS NULL) THEN
            v_max_ver := 0;
        END IF;

        v_max_ver := v_max_ver + 1;
        
        UPDATE nsi
           SET begin_date = Trunc(p_end_date) + 1
         WHERE nsi_id = p_nsi_id
           AND nsi_type_id = p_nsi_type_id;
           
        INSERT INTO nsi_history
        (nsi_history_id, nsi_id, nsi_type_id, version, content, note, begin_date, end_date)
        VALUES (get_nsi_id, p_nsi_id, p_nsi_type_id, v_max_ver, v_content, p_note, v_begin_date, Trunc(p_end_date));
        
        log_oper(p_nsi_id, p_nsi_type_id, NSI_LOG_OPERNUM_HISTORY_PUSH, v_content);
    END nsi_history_push; 
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, cualquier directorio puede usar esta funci√≥n para capturar el estado actual en el historial. </font><font style="vertical-align: inherit;">Ya es bueno, al menos algo √∫til vino de tal generalizaci√≥n))) Para extraer el estado actual del directorio, agregamos la funci√≥n de canalizaci√≥n correspondiente al paquete. </font><font style="vertical-align: inherit;">Las entradas de directorio se devolver√°n en el tipo extendido por los campos del sistema.</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--     nsi_organization     nsi</span><font></font>
    TYPE nsi_organization_rec IS RECORD(<font></font>
        nsi_id          nsi_organization.nsi_id%TYPE, <font></font>
        name            nsi_organization.name%TYPE,<font></font>
        full_name       nsi_organization.full_name%TYPE,<font></font>
        inn             nsi_organization.inn%TYPE,<font></font>
        nsi_type_id     nsi.nsi_type_id%TYPE, <font></font>
        create_date     nsi.create_date%TYPE,<font></font>
        modif_date      nsi.create_date%TYPE,<font></font>
        version         nsi_history.version%TYPE,<font></font>
        begin_date      nsi.begin_date%TYPE,<font></font>
        end_date        nsi_history.end_date%TYPE<font></font>
    );<font></font>
    TYPE nsi_organization_list IS TABLE OF nsi_organization_rec;<font></font>
<font></font>
    <span class="hljs-comment">/*  ,    .
    *     ,    .
    *  @param p_date DATE - ,      
    *  @return nsi_organization_table -    nsi_organization_rec
    */</span><font></font>
    FUNCTION nsi_organization_table(p_date IN DATE := null) <font></font>
    RETURN nsi_organization_list PIPELINED<font></font>
    AS<font></font>
        v_date date;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_date := Trunc(<span class="hljs-keyword">Sysdate</span>);<font></font>
        IF p_date IS NOT NULL THEN<font></font>
            v_date := Trunc(p_date);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> <font></font>
                o.nsi_id, o.name, o.full_name, o.inn,<font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">version</span>, n.begin_date, <span class="hljs-keyword">to_date</span>(<span class="hljs-literal">null</span>) <span class="hljs-keyword">AS</span> end_date
            <span class="hljs-keyword">FROM</span> 
                nsi_organization o <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (o.nsi_id = n.nsi_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                n.begin_date &lt;= v_date<font></font>
            <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
            <span class="hljs-keyword">SELECT</span> <font></font>
                n.nsi_id, <font></font>
                json_value(h.content, <span class="hljs-string">'$.NAME'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <font></font>
                json_value(h.content, <span class="hljs-string">'$.FULL_NAME'</span>) <span class="hljs-keyword">AS</span> full_name,<font></font>
                json_value(h.content, <span class="hljs-string">'$.INN'</span>) <span class="hljs-keyword">AS</span> inn, <font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                h.version, h.begin_date, h.end_date<font></font>
            <span class="hljs-keyword">FROM</span> 
                nsi_history h <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (h.nsi_id = n.nsi_id <span class="hljs-keyword">AND</span> h.nsi_type_id = n.nsi_type_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                    h.begin_date &lt;= v_date<font></font>
                <span class="hljs-keyword">AND</span> h.end_date &gt;= v_date<font></font>
        ) <span class="hljs-keyword">LOOP</span>
            <span class="hljs-keyword">PIPE</span> <span class="hljs-keyword">ROW</span> (rec);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    <span class="hljs-keyword">END</span> nsi_organization_table;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplicable a nuestra tabla nsi_organization. </font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NSI_TYPE_ID"	"DESCR"	"CREATE_DATE"	"MODIF_DATE"	"BEGIN_DATE"<font></font>
1	1	" ""  """	11.03.20	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">begin</span>
<span class="hljs-comment">--       ,      </span>
    pkg_nsi.nsi_history_push(<span class="hljs-number">202</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">sysdate</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">end</span>;
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi_history;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_HISTORY_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VERSION"	"CONTENT"	"NOTE"	"BEGIN_DATE"	"END_DATE"<font></font>
205	1	1	1	"{""NSI_ID"" : ""1"", ""NAME"" : "" \""  \"""", ""FULL_NAME"" : ""  \""  \"""", ""INN"" : ""11223344""}"	" "	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-comment">--       ,         </span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NSI_TYPE_ID"	"DESCR"	"CREATE_DATE"	"MODIF_DATE"	"BEGIN_DATE"<font></font>
1	1	" ""  """	11.03.20	11.03.20	12.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--        </span>
<span class="hljs-comment">--     inn, version, begin_date, end_date</span>
<span class="hljs-comment">--       0</span>
<span class="hljs-keyword">update</span> nsi_organization <span class="hljs-keyword">set</span> inn=<span class="hljs-string">'99887766'</span> <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span>(pkg_nsi.nsi_organization_table(<span class="hljs-keyword">sysdate</span>));
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NAME"	"FULL_NAME"	"INN"	"NSI_TYPE_ID"	"CREATE_DATE"	"MODIF_DATE"	"VERSION"	"BEGIN_DATE"	"END_DATE"<font></font>
1	" ""  """	"  ""  """	"11223344"	1	11.03.20	11.03.20	1	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span>(pkg_nsi.nsi_organization_table(<span class="hljs-keyword">sysdate</span>+<span class="hljs-number">1</span>));
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NAME"	"FULL_NAME"	"INN"	"NSI_TYPE_ID"	"CREATE_DATE"	"MODIF_DATE"	"VERSION"	"BEGIN_DATE"	"END_DATE"<font></font>
1	" ""  """	"  ""  """	"99887766"	1	11.03.20	11.03.20	0	12.03.20	<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci√≥n nsi_organization_table es muy √∫til porque satisface nuestros requisitos y finalmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lleva el problema cuatro al pasado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Siga adelante. </font><font style="vertical-align: inherit;">Dado que tenemos esa ventaja con la introducci√≥n de un enfoque unificado para trabajar con todos los directorios, tambi√©n lo utilizaremos para almacenar informaci√≥n adicional que se puede asignar a cualquier entrada desde cualquier directorio. </font><font style="vertical-align: inherit;">Tal mecanismo existe desde hace mucho tiempo, llamado patr√≥n EAV, y lo estamos implementando.</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--  CHECK nsi_attribute_type_ch</span><font></font>
    NSI_ATTRIBUTE_TYPE_STRING   NUMBER := 1;<font></font>
    NSI_ATTRIBUTE_TYPE_INT      NUMBER := 2;<font></font>
    NSI_ATTRIBUTE_TYPE_DOUBLE   NUMBER := 3;<font></font>
    NSI_ATTRIBUTE_TYPE_DATE     NUMBER := 4;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_attribute_type (<font></font>
    nsi_attribute_type_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    value_type              <span class="hljs-built_in">NUMBER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>                   <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_ch <span class="hljs-keyword">CHECK</span> (value_type <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_attribute_type <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.nsi_attribute_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.value_type <span class="hljs-keyword">IS</span> <span class="hljs-string">'  (1 - , 2 - , 3 - , 4 - )'</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.descr <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_attribute (<font></font>
    nsi_attribute_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_attribute_type_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id                  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id             <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    value_1                 <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    value_2_3               <span class="hljs-built_in">NUMBER</span>,<font></font>
    value_4                 <span class="hljs-built_in">DATE</span>,<font></font>
    begin_date              <span class="hljs-built_in">DATE</span>,<font></font>
    end_date                <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_attribute_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_attribute_type (nsi_attribute_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id, nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id, nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_attribute <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_attribute_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_attribute_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_type_id <span class="hljs-keyword">is</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_1 <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_2_3 <span class="hljs-keyword">IS</span> <span class="hljs-string">'    '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_4 <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muy a menudo, en el contexto de los documentos, se deben usar nombres propios en algunos casos, por lo que crearemos una nueva tabla con individuos y, por analog√≠a con las organizaciones, agregaremos el procesamiento de disparo y un tipo para la selecci√≥n.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_person (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    surname         <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    patronymic      <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    birthday        <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_person_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_person_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_person <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.surname <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.patronymic <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.birthday <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_person_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_person <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_person'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :NEW.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_person_trg_update 
BEFORE UPDATE ON nsi_person FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_person<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :NEW.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_person_trg_delete 
AFTER DELETE ON nsi_person FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_person<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :OLD.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por complementar el paquete pkg_nsi con el procesamiento de esta tabla.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     nsi_person     nsi</span><font></font>
    TYPE nsi_person_rec IS RECORD(<font></font>
        nsi_id          nsi_person.nsi_id%TYPE, <font></font>
        surname         nsi_person.surname%TYPE,<font></font>
        name            nsi_person.name%TYPE,<font></font>
        patronymic      nsi_person.patronymic%TYPE,<font></font>
        birthday        nsi_person.birthday%TYPE,<font></font>
        nsi_type_id     nsi.nsi_type_id%TYPE, <font></font>
        create_date     nsi.create_date%TYPE,<font></font>
        modif_date      nsi.create_date%TYPE,<font></font>
        version         nsi_history.version%TYPE,<font></font>
        begin_date      nsi.begin_date%TYPE,<font></font>
        end_date        nsi_history.end_date%TYPE<font></font>
    );<font></font>
    TYPE nsi_person_list IS TABLE OF nsi_person_rec;<font></font>
<font></font>
    <span class="hljs-comment">/*  ,    .
    *     ,    .
    *  @param p_date DATE - ,      
    *  @return nsi_person_table -    nsi_person_rec
    */</span><font></font>
    FUNCTION nsi_person_table(p_date IN DATE := null) <font></font>
    RETURN nsi_person_list PIPELINED<font></font>
    AS<font></font>
        v_date date;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_date := Trunc(<span class="hljs-keyword">Sysdate</span>);<font></font>
        IF p_date IS NOT NULL THEN<font></font>
            v_date := Trunc(p_date);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> <font></font>
                p.nsi_id, p.surname, p.name, p.patronymic, p.birthday, <font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">version</span>, n.begin_date, <span class="hljs-keyword">to_date</span>(<span class="hljs-literal">null</span>) <span class="hljs-keyword">AS</span> end_date
            <span class="hljs-keyword">FROM</span> 
                nsi_person p <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (p.nsi_id = n.nsi_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                n.begin_date &lt;= v_date<font></font>
            <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
            <span class="hljs-keyword">SELECT</span> <font></font>
                n.nsi_id, <font></font>
                json_value(h.content, <span class="hljs-string">'$.SURNAME'</span>) <span class="hljs-keyword">AS</span> surname, <font></font>
                json_value(h.content, <span class="hljs-string">'$.NAME'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>,<font></font>
                json_value(h.content, <span class="hljs-string">'$.PATRONYMIC'</span>) <span class="hljs-keyword">AS</span> patronymic,
                <span class="hljs-keyword">to_date</span>(json_value(h.content, <span class="hljs-string">'$.BIRTHDAY'</span>)) <span class="hljs-keyword">AS</span> birthday,<font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                h.version, h.begin_date, h.end_date<font></font>
            <span class="hljs-keyword">FROM</span> 
                nsi_history h <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (h.nsi_id = n.nsi_id <span class="hljs-keyword">AND</span> h.nsi_type_id = n.nsi_type_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                    h.begin_date &lt;= v_date<font></font>
                <span class="hljs-keyword">AND</span> h.end_date &gt;= v_date<font></font>
        ) <span class="hljs-keyword">LOOP</span>
            <span class="hljs-keyword">PIPE</span> <span class="hljs-keyword">ROW</span> (rec);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    <span class="hljs-keyword">END</span> nsi_person_table;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y agregue a alguien a esta tabla.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_person<font></font>
(surname, <span class="hljs-keyword">name</span>, patronymic, birthday)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'22.12.70'</span>, <span class="hljs-string">'dd.mm.yy'</span>));
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crea atributos para el caso genitivo m√°s buscado.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el paquete pkg_nsi agregamos funciones para trabajar con atributos de directorio.</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*   id      .
    *  @param p_nsi_attribute_type_id nsi_attribute_type.nsi_attribute_type_id%TYPE -  
    *  @param p_value_type nsi_attribute_type.value_type%TYPE -  
    *  @param p_descr nsi_attribute_type.descr%TYPE -  
    */</span><font></font>
    PROCEDURE get_attribute_type (<font></font>
        p_nsi_attribute_type_id IN nsi_attribute_type.nsi_attribute_type_id%TYPE,<font></font>
        p_value_type            OUT nsi_attribute_type.value_type%TYPE,<font></font>
        p_descr                 OUT nsi_attribute_type.descr%TYPE)<font></font>
    AS<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> value_type, <span class="hljs-keyword">descr</span>
          <span class="hljs-keyword">INTO</span> p_value_type, p_descr
          <span class="hljs-keyword">FROM</span> nsi_attribute_type
         <span class="hljs-keyword">WHERE</span> nsi_attribute_type_id = p_nsi_attribute_type_id;
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE -  
    *  @param p_nsi_id nsi_attribute.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_attribute.nsi_type_id%TYPE -  
    *  @param p_value_1 nsi_attribute.value_1%TYPE -   
    *  @param p_value_2_3 nsi_attribute.value_2_3%TYPE -   
    *  @param p_value_4 nsi_attribute.value_4%TYPE -   
    *  @param p_begin_date nsi_attribute.begin_date%TYPE -    
    *  @param p_end_date nsi_attribute.end_date%TYPE -    
    */</span><font></font>
    PROCEDURE nsi_attribute_insert (<font></font>
        p_nsi_attribute_type_id IN nsi_attribute.nsi_attribute_type_id%TYPE,<font></font>
        p_nsi_id                IN nsi_attribute.nsi_id%TYPE,<font></font>
        p_nsi_type_id           IN nsi_attribute.nsi_type_id%TYPE,<font></font>
        p_value_1               IN nsi_attribute.value_1%TYPE,<font></font>
        p_value_2_3             IN nsi_attribute.value_2_3%TYPE,<font></font>
        p_value_4               IN nsi_attribute.value_4%TYPE,<font></font>
        p_begin_date            IN nsi_attribute.begin_date%TYPE,<font></font>
        p_end_date              IN nsi_attribute.end_date%TYPE)<font></font>
    AS<font></font>
        v_id            NUMBER;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        get_attribute_type(p_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
<font></font>
        IF (v_value_type = NSI_ATTRIBUTE_TYPE_STRING) THEN<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,<font></font>
                    p_value_1, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_1;<font></font>
                    <font></font>
        ELSIF (v_value_type IN (NSI_ATTRIBUTE_TYPE_INT, NSI_ATTRIBUTE_TYPE_DOUBLE)) THEN<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,
                    <span class="hljs-literal">null</span>, p_value_2_3, <span class="hljs-literal">null</span>, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_2_3;<font></font>
                    <font></font>
        ELSE<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, p_value_4, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_4;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_id, p_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       ' : ' || v_log_descr || <font></font>
                       ' : ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper(p_nsi_id, p_nsi_type_id, NSI_LOG_OPERNUM_ATTR_INSERT, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*      .
    *  @param p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE -  
    *  @param p_value_1 nsi_attribute.value_1%TYPE -   
    *  @param p_value_2_3 nsi_attribute.value_2_3%TYPE -   
    *  @param p_value_4 nsi_attribute.value_4%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_attribute_value (<font></font>
        p_nsi_attribute_id      IN nsi_attribute.nsi_attribute_id%TYPE,<font></font>
        p_value_1               IN nsi_attribute.value_1%TYPE,<font></font>
        p_value_2_3             IN nsi_attribute.value_2_3%TYPE,<font></font>
        p_value_4               IN nsi_attribute.value_4%TYPE)<font></font>
    AS<font></font>
        v_nsi_id            nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id       nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
        v_value_type        nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr             nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id  nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_attribute_type_id, nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_attribute_type_id, v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
          <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
          <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        IF (v_value_type = NSI_ATTRIBUTE_TYPE_STRING) THEN<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = p_value_1,<font></font>
                   value_2_3 = <span class="hljs-literal">null</span>,<font></font>
                   value_4 = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_1;<font></font>
                    <font></font>
        ELSIF (v_value_type IN (NSI_ATTRIBUTE_TYPE_INT, NSI_ATTRIBUTE_TYPE_DOUBLE)) THEN<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = <span class="hljs-literal">null</span>,<font></font>
                   value_2_3 = p_value_2_3,<font></font>
                   value_4 = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_2_3;<font></font>
                    <font></font>
        ELSE<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = <span class="hljs-literal">null</span>,<font></font>
                   value_2_3 = <span class="hljs-literal">null</span>,<font></font>
                   value_4 = p_value_4<font></font>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_4;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       '  : ' || v_log_descr;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE -  
    *  @param p_begin_date nsi_attribute.begin_date%TYPE -    
    *  @param p_end_date nsi_attribute.end_date%TYPE -    
    */</span><font></font>
    PROCEDURE nsi_attribute_period (<font></font>
        p_nsi_attribute_id  IN nsi_attribute.nsi_attribute_id%TYPE,<font></font>
        p_begin_date        IN nsi_attribute.begin_date%TYPE,<font></font>
        p_end_date          IN nsi_attribute.end_date%TYPE)<font></font>
    AS<font></font>
        v_nsi_id        nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id   nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id, nsi_attribute_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id, v_nsi_attribute_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
    <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_attribute
           <span class="hljs-keyword">SET</span> begin_date = p_begin_date,<font></font>
               end_date = p_end_date<font></font>
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       '  : ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_attribute_id nsi_person.nsi_attribute_id%TYPE - id  nsi_attribute
    */</span><font></font>
    PROCEDURE nsi_attribute_delete (p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE)<font></font>
    AS<font></font>
        v_nsi_id        nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id   nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id, nsi_attribute_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id, v_nsi_attribute_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
    <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_attribute
        <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_DELETE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora asigne los atributos apropiados.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_insert(<span class="hljs-number">1</span>, <span class="hljs-number">225</span>, <span class="hljs-number">6</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">sysdate</span>, <span class="hljs-literal">null</span>);<font></font>
    pkg_nsi.nsi_attribute_insert(2, 225, 6, '', null, null, sysdate, null);<font></font>
    pkg_nsi.nsi_attribute_insert(3, 225, 6, '', null, null, sysdate, null);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">--      ,      ,  </span>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			11.03.20	<font></font>
232	2	225	6	""			11.03.20	<font></font>
234	3	225	6	""			11.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_value(<span class="hljs-number">230</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
<span class="hljs-keyword">end</span>;
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			11.03.20<font></font>
232	2	225	6	""			11.03.20	<font></font>
234	3	225	6	""			11.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--       </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_period(<span class="hljs-number">230</span>, <span class="hljs-keyword">sysdate</span><span class="hljs-number">-1</span>, <span class="hljs-literal">null</span>);<font></font>
    pkg_nsi.nsi_attribute_period(232, sysdate-1, null);<font></font>
    pkg_nsi.nsi_attribute_period(234, sysdate-1, null);<font></font>
<span class="hljs-keyword">end</span>;
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			10.03.20	<font></font>
232	2	225	6	""			10.03.20	<font></font>
234	3	225	6	""			10.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">venceremos el tercer problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de las tablas de referencia en el sistema NSI, la relaci√≥n entre ellas tambi√©n es importante. </font><font style="vertical-align: inherit;">Entonces, por ejemplo, las grandes organizaciones incluyen varias unidades, sucursales, departamentos, etc., que pueden integrarse en una estructura de √°rbol. </font><font style="vertical-align: inherit;">Para empezar, crearemos varias organizaciones m√°s en nuestro sistema que estar√°n subordinadas a los "cuernos y pezu√±as" existentes.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'1111111111'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'2222222222'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'3333333333'</span>);<font></font>
<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------</span><font></font>
281	1	   	13.03.20	13.03.20	13.03.20<font></font>
283	1	   	13.03.20	13.03.20	13.03.20<font></font>
285	1	   	13.03.20	13.03.20	13.03.20<font></font>
1	1	 "  "	11.03.20	13.03.20	12.03.20<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora es necesario mostrar en qu√© relaci√≥n se encuentran estas organizaciones entre s√≠. </font><font style="vertical-align: inherit;">Para hacer esto, necesita una tabla con una estructura de √°rbol y una indicaci√≥n del per√≠odo de acci√≥n, porque todo est√° sujeto a un cambio en el tiempo y debe tener esto en cuenta.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_structure (<font></font>
    nsi_structure_id    <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_parent_structure_id <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>),<font></font>
    nsi_id              <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    ordnum              <span class="hljs-built_in">NUMBER</span>,<font></font>
    begin_date          <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date            <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_structure_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_structure_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_parent_struct_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_parent_structure_id) <span class="hljs-keyword">REFERENCES</span> nsi_structure (nsi_structure_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_struct_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id, nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id, nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_structure <span class="hljs-keyword">IS</span> <span class="hljs-string">'.   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.ordnum <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, debe ampliar las capacidades del paquete pkg_nsi para poder personalizar la estructura de varias tablas. </font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*   .
    *  @param p_nsi_parent_structure_id nsi_structure.nsi_parent_structure_id%TYPE -  
    *  @param p_nsi_id nsi_structure.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_structure.nsi_type_id%TYPE -  
    *  @param p_ordnum nsi_structure.ordnum%TYPE -  
    *  @param p_begin_date nsi_structure.begin_date%TYPE -    
    *  @param p_end_date nsi_structure.end_date%TYPE -    
    */</span><font></font>
    FUNCTION nsi_structure_insert (<font></font>
        p_nsi_parent_structure_id   IN nsi_structure.nsi_parent_structure_id%TYPE,<font></font>
        p_nsi_id                    IN nsi_structure.nsi_id%TYPE,<font></font>
        p_nsi_type_id               IN nsi_structure.nsi_type_id%TYPE,<font></font>
        p_ordnum                    IN nsi_structure.ordnum%TYPE,<font></font>
        p_begin_date                IN nsi_structure.begin_date%TYPE, <font></font>
        p_end_date                  IN nsi_structure.end_date%TYPE)<font></font>
    RETURN nsi_structure.nsi_structure_id%TYPE<font></font>
    AS<font></font>
        v_id        NUMBER;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        v_type_id := get_type_id('nsi_structure');<font></font>
<font></font>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_structure (<font></font>
            nsi_structure_id, nsi_parent_structure_id,<font></font>
            nsi_id, nsi_type_id, ordnum, begin_date, end_date)<font></font>
        <span class="hljs-keyword">VALUES</span> (<font></font>
            v_id, p_nsi_parent_structure_id, <font></font>
            p_nsi_id, p_nsi_type_id, p_ordnum, Trunc(p_begin_date), Trunc(p_end_date));<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_id, p_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (v_id, v_type_id, NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
        <font></font>
        RETURN v_id;<font></font>
    <span class="hljs-keyword">END</span> nsi_structure_insert;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    *  @param p_ordnum nsi_structure.ordnum%TYPE -  
    */</span><font></font>
    PROCEDURE nsi_structure_ordnum (<font></font>
        p_nsi_structure_id  IN nsi_structure.nsi_structure_id%TYPE,<font></font>
        p_ordnum            IN nsi_structure.ordnum%TYPE)<font></font>
    AS<font></font>
        v_nsi_id 		    nsi_structure.nsi_id%TYPE;<font></font>
        v_nsi_type_id 	    nsi_structure.nsi_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_structure
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_structure
           <span class="hljs-keyword">SET</span> ordnum = p_ordnum 
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_ordnum;<font></font>
        log_oper (p_nsi_structure_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    *  @param p_begin_date nsi_structure.begin_date%TYPE -   
    *  @param p_end_date nsi_structure.end_date%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_structure_period (<font></font>
        p_nsi_structure_id  IN nsi_structure.nsi_structure_id%TYPE,<font></font>
        p_begin_date        IN nsi_structure.begin_date%TYPE, <font></font>
        p_end_date          IN nsi_structure.end_date%TYPE)<font></font>
    AS<font></font>
        v_nsi_id 		    nsi_structure.nsi_id%TYPE;<font></font>
        v_nsi_type_id 	    nsi_structure.nsi_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_structure
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_structure
           <span class="hljs-keyword">SET</span> begin_date = Trunc(p_begin_date),<font></font>
               end_date = Trunc(p_end_date) <font></font>
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (p_nsi_structure_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    */</span><font></font>
    PROCEDURE nsi_structure_delete (p_nsi_structure_id IN nsi_structure.nsi_structure_id%TYPE)<font></font>
    AS<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> nsi_structure_id, nsi_parent_structure_id,<font></font>
                    nsi_id, nsi_type_id, ordnum, begin_date, end_date<font></font>
            <span class="hljs-keyword">FROM</span> nsi_structure
            <span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> nsi_structure_id = p_nsi_structure_id
            <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">PRIOR</span> nsi_structure_id = nsi_parent_structure_id<font></font>
        )<font></font>
        <span class="hljs-keyword">LOOP</span>
            v_log_descr := <span class="hljs-string">'['</span> || pkg_nsi.get_nsi_descr(rec.nsi_id, rec.nsi_type_id) || <span class="hljs-string">'] '</span>;<font></font>
            v_log_descr := v_log_descr || ' ' || rec.begin_date || ' - ' || rec.end_date;<font></font>
            pkg_nsi.log_oper (rec.nsi_structure_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_structure
        <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s del advenimiento de tal instrumento, uno puede construir relaciones entre organizaciones de manera segura.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span>
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">number</span>;<font></font>
    root_id number;<font></font>
<span class="hljs-keyword">begin</span>
    root_id := pkg_nsi.nsi_structure_insert(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'13.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-literal">null</span>);<font></font>
    id := pkg_nsi.nsi_structure_insert(root_id, 281, 1, null, to_date('13.02.20', 'dd.mm.yy'), to_date('15.02.20', 'dd.mm.yy'));<font></font>
    id := pkg_nsi.nsi_structure_insert(root_id, 283, 1, null, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    id := pkg_nsi.nsi_structure_insert(id, 285, 1, null, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id);
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
318	316	281	1		13.02.20	15.02.20<font></font>
320	316	283	1		13.02.20	<font></font>
322	320	285	1		13.02.20	<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_structure_ordnum(<span class="hljs-number">320</span>, <span class="hljs-number">1</span>);<font></font>
    pkg_nsi.nsi_structure_ordnum(318, 2);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
320	316	283	1	1	13.02.20	<font></font>
322	320	285	1		13.02.20	<font></font>
318	316	281	1	2	13.02.20	15.02.20<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_structure_period(<span class="hljs-number">320</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'14.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'14.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>));
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
320	316	283	1	1	14.02.20	14.02.20<font></font>
322	320	285	1		13.02.20	<font></font>
318	316	281	1	2	13.02.20	15.02.20<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que los directorios est√°n separados de la estructura, cada vez resulta que las organizaciones tienen en cuenta que sus relaciones son engorrosas, por lo que simplificamos un poco nuestra vida.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">VIEW</span> V_NSI_ORGANIZATION <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <font></font>
    s.nsi_structure_id, s.nsi_parent_structure_id,<font></font>
    s.ordnum, s.begin_date, s.end_date,<font></font>
    s.nsi_id, s.nsi_type_id, o.name, o.full_name, o.inn<font></font>
<span class="hljs-keyword">FROM</span> nsi_structure s <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi_organization o
    <span class="hljs-keyword">ON</span> (s.nsi_id = o.nsi_id)
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> v_nsi_organization;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316			13.02.20		1	1	 "  "	  "  "	99887766<font></font>
320	316	1	14.02.20	14.02.20	283	1	   	   	2222222222<font></font>
322	320		13.02.20		285	1	   	   	3333333333<font></font>
318	316	2	13.02.20	15.02.20	281	1	   	   	1111111111<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hecho de que estemos construyendo un √°rbol es maravilloso, pero todos los nodos de este √°rbol pertenecen a una entidad, y nuestra tarea es realizar la construcci√≥n de una relaci√≥n entre diferentes entidades. </font><font style="vertical-align: inherit;">Esto tampoco es un problema, porque la estructura no est√° vinculada a ning√∫n libro de referencia espec√≠fico, sino que funciona como un todo en todo el sistema NSI. </font><font style="vertical-align: inherit;">Por ejemplo, construiremos un clasificador para los puestos del servicio civil estatal y un clasificador para los puestos del municipio.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_classifier (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    code        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">name</span>        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_classifier_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_classifier_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_classifier <span class="hljs-keyword">IS</span> <span class="hljs-string">'. '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.code <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_classifier_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_classifier <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_classifier'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_classifier_trg_update 
BEFORE UPDATE ON nsi_classifier FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_classifier<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_classifier_trg_delete 
AFTER DELETE ON nsi_classifier FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_classifier<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post_group (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_group_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_group_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post_group <span class="hljs-keyword">is</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_group.nsi_id <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_group.name <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_group_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post_group <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post_group'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_group_trg_update 
BEFORE UPDATE ON nsi_post_group FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_group<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_group_trg_delete 
AFTER DELETE ON nsi_post_group FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_group<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post_category (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_category_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_category_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post_category <span class="hljs-keyword">is</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_category.nsi_id <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_category.name <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_category_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post_category <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post_category'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_category_trg_update 
BEFORE UPDATE ON nsi_post_category FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_category<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_category_trg_delete 
AFTER DELETE ON nsi_post_category FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_category<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post (<font></font>
    nsi_id          <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    code_OKPDTR     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post <span class="hljs-keyword">IS</span> <span class="hljs-string">'. '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.code_OKPDTR <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_trg_update 
BEFORE UPDATE ON nsi_post FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_trg_delete 
AFTER DELETE ON nsi_post FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo queda completar y recolectar los clasificadores necesarios.</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_classifier (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'  '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_classifier (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'  '</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' ()'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' '</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'24742'</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26480'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'23509'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'20419'</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26541'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26544'</span>, <span class="hljs-string">' 2 '</span>);<font></font>
<font></font>
<span class="hljs-keyword">commit</span>;<font></font>
<font></font>
<span class="hljs-keyword">declare</span>
    post_id <span class="hljs-built_in">number</span>;<font></font>
    classif_id number;<font></font>
    categ_id number;<font></font>
    group_id number;<font></font>
<span class="hljs-keyword">begin</span>
    <span class="hljs-comment">--   </span>
    classif_id := pkg_nsi.nsi_structure_insert(<span class="hljs-literal">null</span>, <span class="hljs-number">331</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'13.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-literal">null</span>);
    <span class="hljs-comment">-- </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 347, 4, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 335, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  ()</span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 349, 4, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 337, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 351, 4, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 341, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 361, 3, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 353, 4, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 361, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 363, 3, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  2 </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 345, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
<font></font>
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure s
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_id = <span class="hljs-number">331</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">----------------------------------------------------------------------------------</span><font></font>
"NSI_STRUCTURE_ID"	"NSI_PARENT_STRUCTURE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"ORDNUM"	"BEGIN_DATE"	"END_DATE"<font></font>
385		331	5		13.02.20	<font></font>
387	385	347	4	1	13.02.20	<font></font>
389	387	355	3	1	13.02.20	<font></font>
391	387	357	3	2	13.02.20	<font></font>
393	391	335	2	1	13.02.20	<font></font>
395	387	359	3	3	13.02.20	<font></font>
397	385	349	4	2	13.02.20	<font></font>
399	397	355	3	1	13.02.20	<font></font>
401	397	357	3	2	13.02.20	<font></font>
403	397	359	3	3	13.02.20	<font></font>
405	403	337	2	1	13.02.20	<font></font>
407	385	351	4	3	13.02.20	<font></font>
409	407	355	3	1	13.02.20	<font></font>
411	407	357	3	2	13.02.20	<font></font>
413	407	359	3	3	13.02.20	<font></font>
415	413	341	2	1	13.02.20	<font></font>
417	407	361	3	4	13.02.20	<font></font>
419	385	353	4	4	13.02.20	<font></font>
421	419	357	3	1	13.02.20	<font></font>
423	419	359	3	2	13.02.20	<font></font>
425	419	361	3	3	13.02.20	<font></font>
427	419	363	3	4	13.02.20	<font></font>
429	427	345	2	1	13.02.20	<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Oh, qu√© legible es!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">VIEW</span> V_NSI_CLASSIFIRE_GGS <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <font></font>
    s.nsi_structure_id, s.nsi_parent_structure_id,<font></font>
    s.ordnum, s.begin_date, s.end_date,<font></font>
    n.nsi_id, n.nsi_type_id, n.descr<font></font>
<span class="hljs-keyword">FROM</span> nsi_structure s <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
    <span class="hljs-keyword">ON</span> (s.nsi_id = n.nsi_id)
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (s.nsi_id = <span class="hljs-number">331</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> V_NSI_CLASSIFIRE_GGS ;
<span class="hljs-comment">----------------------------------------------------------------------------------</span><font></font>
"NSI_STRUCTURE_ID"	"NSI_PARENT_STRUCTURE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"ORDNUM"	"BEGIN_DATE"	"END_DATE"<font></font>
385			13.02.20		331	5	  <font></font>
387	385	1	13.02.20		347	4	<font></font>
389	387	1	13.02.20		355	3	<font></font>
391	387	2	13.02.20		357	3	<font></font>
393	391	1	13.02.20		335	2	 <font></font>
395	387	3	13.02.20		359	3	<font></font>
397	385	2	13.02.20		349	4	 ()<font></font>
399	397	1	13.02.20		355	3	<font></font>
401	397	2	13.02.20		357	3	<font></font>
403	397	3	13.02.20		359	3	<font></font>
405	403	1	13.02.20		337	2	<font></font>
407	385	3	13.02.20		351	4	<font></font>
409	407	1	13.02.20		355	3	<font></font>
411	407	2	13.02.20		357	3	<font></font>
413	407	3	13.02.20		359	3	<font></font>
415	413	1	13.02.20		341	2	 <font></font>
417	407	4	13.02.20		361	3	<font></font>
419	385	4	13.02.20		353	4	 <font></font>
421	419	1	13.02.20		357	3	<font></font>
423	419	2	13.02.20		359	3	<font></font>
425	419	3	13.02.20		361	3	<font></font>
427	419	4	13.02.20		363	3	<font></font>
429	427	1	13.02.20		345	2	 2 <font></font>
<span class="hljs-comment">----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No debe olvidarse que, adem√°s de la relaci√≥n de inclusi√≥n (incluida la del √°rbol), existe una relaci√≥n de intersecci√≥n, es decir, tablas cruzadas. </font><font style="vertical-align: inherit;">Esto agrega una condici√≥n adicional para verificar la intersecci√≥n del tiempo.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_cross (<font></font>
    nsi_cross_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_main_id         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_main_type_id    <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_detail_id       <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_detail_type_id  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    begin_date          <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date            <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_cross_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_main_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_main_type_id, nsi_main_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_type_id, nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_detail_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_detail_type_id, nsi_detail_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_type_id, nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_cross <span class="hljs-keyword">IS</span> <span class="hljs-string">'. - '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_cross_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_main_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_main_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_detail_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_detail_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*        -.
    *  @param p_nsi_main_id nsi_cross.nsi_main_id%TYPE -   
    *  @param p_nsi_main_type_id nsi_cross.nsi_main_type_id%TYPE -    
    *  @param p_nsi_detail_id nsi_cross.nsi_detail_id%TYPE -   
    *  @param p_nsi_detail_type_id nsi_cross.nsi_detail_type_id%TYPE -    
    *  @param p_begin_date DATE -    
    *  @param p_end_date DATE -    
    */</span><font></font>
    PROCEDURE nsi_cross_check_period (<font></font>
        p_nsi_cross_id          IN nsi_cross.nsi_cross_id%TYPE,<font></font>
        p_begin_date            IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date              IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_cnt NUMBER;<font></font>
        v_nsi_main_id           nsi_cross.nsi_main_id%TYPE;<font></font>
        v_nsi_main_type_id      nsi_cross.nsi_main_type_id%TYPE;<font></font>
        v_nsi_detail_id         nsi_cross.nsi_detail_id%TYPE;<font></font>
        v_nsi_detail_type_id    nsi_cross.nsi_detail_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">IF</span> (p_end_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (Trunc(p_begin_date) &gt; Trunc(p_end_date)) <span class="hljs-keyword">THEN</span><font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                <span class="hljs-string">'[nsi_cross_check_period]         '</span> || Trunc(p_begin_date) || <span class="hljs-string">' - '</span> || Trunc(p_end_date)); 
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MIN</span>(nsi_main_id), <span class="hljs-keyword">MIN</span>(nsi_main_type_id),
               <span class="hljs-keyword">MIN</span>(nsi_detail_id), <span class="hljs-keyword">MIN</span>(nsi_detail_type_id) 
          <span class="hljs-keyword">INTO</span> v_nsi_main_id, v_nsi_main_type_id,<font></font>
               v_nsi_detail_id, v_nsi_detail_type_id <font></font>
          <span class="hljs-keyword">FROM</span> nsi_cross
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
         <font></font>
        v_cnt := 0;<font></font>
        <font></font>
        IF (v_nsi_main_id IS NOT NULL) THEN<font></font>
        <font></font>
            IF (p_end_date IS NOT NULL) THEN<font></font>
                <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
                  <span class="hljs-keyword">INTO</span> v_cnt
                  <span class="hljs-keyword">FROM</span> nsi_cross
                 <span class="hljs-keyword">WHERE</span> nsi_main_id = v_nsi_main_id
                   <span class="hljs-keyword">AND</span> nsi_main_type_id = v_nsi_main_type_id
                   <span class="hljs-keyword">AND</span> nsi_detail_id = v_nsi_detail_id
                   <span class="hljs-keyword">AND</span> nsi_detail_type_id = v_nsi_detail_type_id
                   <span class="hljs-keyword">AND</span> nsi_cross_id &lt;&gt; p_nsi_cross_id
                   <span class="hljs-keyword">AND</span> begin_date &lt;= Trunc(p_end_date)
                   <span class="hljs-keyword">AND</span> ((end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span> (end_date &gt;= Trunc(p_end_date)));<font></font>
            ELSE<font></font>
                <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
                  <span class="hljs-keyword">INTO</span> v_cnt
                  <span class="hljs-keyword">FROM</span> nsi_cross
                 <span class="hljs-keyword">WHERE</span> nsi_main_id = v_nsi_main_id
                   <span class="hljs-keyword">AND</span> nsi_main_type_id = v_nsi_main_type_id
                   <span class="hljs-keyword">AND</span> nsi_detail_id = v_nsi_detail_id
                   <span class="hljs-keyword">AND</span> nsi_detail_type_id = v_nsi_detail_type_id
                   <span class="hljs-keyword">AND</span> nsi_cross_id &lt;&gt; p_nsi_cross_id
                   <span class="hljs-keyword">AND</span> ((<font></font>
                        (end_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (end_date &gt;= Trunc(p_begin_date))<font></font>
                        ) <span class="hljs-keyword">OR</span> (end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)<font></font>
                        );<font></font>
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        IF (v_cnt &gt; 0) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_cross_check_period]     ' || p_begin_date || ' - ' || p_end_date);    <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_main_id nsi_cross.nsi_main_id%TYPE -   
    *  @param p_nsi_main_type_id nsi_cross.nsi_main_type_id%TYPE -    
    *  @param p_nsi_detail_id nsi_cross.nsi_detail_id%TYPE -   
    *  @param p_nsi_detail_type_id nsi_cross.nsi_detail_type_id%TYPE -    
    *  @param p_begin_date DATE -    
    *  @param p_end_date DATE -    
    */</span><font></font>
    PROCEDURE nsi_cross_insert (<font></font>
        p_nsi_main_id           IN nsi_cross.nsi_main_id%TYPE,<font></font>
        p_nsi_main_type_id      IN nsi_cross.nsi_main_type_id%TYPE,<font></font>
        p_nsi_detail_id         IN nsi_cross.nsi_detail_id%TYPE,<font></font>
        p_nsi_detail_type_id    IN nsi_cross.nsi_detail_type_id%TYPE,<font></font>
        p_begin_date            IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date              IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_id        NUMBER;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        v_type_id := get_type_id('nsi_cross');<font></font>
<font></font>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_cross (<font></font>
            nsi_cross_id, nsi_main_id, nsi_main_type_id,<font></font>
            nsi_detail_id, nsi_detail_type_id, <font></font>
            begin_date, end_date)<font></font>
        <span class="hljs-keyword">VALUES</span> (<font></font>
            v_id, p_nsi_main_id, p_nsi_main_type_id,<font></font>
            p_nsi_detail_id, p_nsi_detail_type_id, <font></font>
            Trunc(p_begin_date), Trunc(p_end_date));<font></font>
<font></font>
        nsi_cross_check_period (v_id, p_begin_date, p_end_date);<font></font>
<font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_main_id, p_nsi_main_type_id) || ' &lt;=&gt; ' || get_nsi_descr(p_nsi_detail_id, p_nsi_detail_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (v_id, v_type_id, NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span> nsi_cross_insert;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_cross_id nsi_cross.nsi_cross_id%TYPE -  nsi_cross
    *  @param p_begin_date nsi_cross.begin_date%TYPE -   
    *  @param p_end_date nsi_cross.end_date%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_cross_period (<font></font>
        p_nsi_cross_id  IN nsi_cross.nsi_cross_id%TYPE,<font></font>
        p_begin_date    IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date      IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_main_id 		    nsi_cross.nsi_main_id%TYPE;<font></font>
        v_main_type_id 	    nsi_cross.nsi_main_type_id%TYPE;<font></font>
        v_detail_id 		nsi_cross.nsi_detail_id%TYPE;<font></font>
        v_detail_type_id 	nsi_cross.nsi_detail_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_cross'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_main_id, nsi_main_type_id,<font></font>
               nsi_detail_id, nsi_detail_type_id<font></font>
          <span class="hljs-keyword">INTO</span> v_main_id, v_main_type_id,<font></font>
               v_detail_id, v_detail_type_id<font></font>
          <span class="hljs-keyword">FROM</span> nsi_cross
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
<font></font>
        nsi_cross_check_period (p_nsi_cross_id, p_begin_date, p_end_date);<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_cross
           <span class="hljs-keyword">SET</span> begin_date = Trunc(p_begin_date),<font></font>
               end_date = Trunc(p_end_date) <font></font>
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_main_id, v_main_type_id) || ' &lt;=&gt; ' || get_nsi_descr(v_detail_id, v_detail_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (p_nsi_cross_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_cross_id nsi_cross.nsi_cross_id%TYPE -  nsi_cross
    */</span><font></font>
    PROCEDURE nsi_cross_delete (p_nsi_cross_id IN nsi_cross.nsi_cross_id%TYPE)<font></font>
    AS<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_cross'</span>);<font></font>
        <font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> nsi_cross_id, nsi_main_id, nsi_main_type_id,<font></font>
                    nsi_detail_id, nsi_detail_type_id,<font></font>
                    begin_date, end_date<font></font>
            <span class="hljs-keyword">FROM</span> nsi_cross
            <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id<font></font>
        )<font></font>
        <span class="hljs-keyword">LOOP</span>
            v_log_descr := <span class="hljs-string">'['</span> || pkg_nsi.get_nsi_descr(rec.nsi_main_id, rec.nsi_main_type_id) || <span class="hljs-string">' &lt;=&gt; '</span> || pkg_nsi.get_nsi_descr(rec.nsi_detail_id, rec.nsi_detail_type_id) || <span class="hljs-string">'] '</span>;<font></font>
            v_log_descr := v_log_descr || ' ' || rec.begin_date || ' - ' || rec.end_date;<font></font>
            pkg_nsi.log_oper (rec.nsi_cross_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_cross
        <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;
    <span class="hljs-keyword">END</span>;
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo, ahora podemos decir con confianza que hemos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cerrado el primer problema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, puede intentar adjuntar muchas cosas a este sistema, pero creo que complet√© la tarea al comienzo del art√≠culo, y el resto ya puede considerarse en el proceso de discusi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El material se prepar√≥ en Oracle versi√≥n 18c, aunque el soporte nativo para el formato json ya est√° presente en la versi√≥n 12. Aqu√≠ hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al archivo de script.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492398/index.html">Configuramos nuestros dispositivos para trabajo remoto, podcasting, video y transmisi√≥n</a></li>
<li><a href="../es492404/index.html">Flutter + arduino nano 33 BLE sense = sensor BLE muy simple</a></li>
<li><a href="../es492406/index.html">Podcasts para geek: un par de programas probados sobre gesti√≥n de proyectos, an√°lisis de tecnolog√≠a y GTD</a></li>
<li><a href="../es492408/index.html">La asistencia de escritorio de Yandex ha disminuido: lo que sucedi√≥ en 2019 y c√≥mo afectar√° en 2020</a></li>
<li><a href="../es492410/index.html">C ++ es m√°s r√°pido y seguro que Rust, Yandex ha tomado medidas</a></li>
<li><a href="../es492420/index.html">Wechat o una aplicaci√≥n verdaderamente completa. ¬øQu√© puede hacer un desarrollador con √©l?</a></li>
<li><a href="../es492422/index.html">Escobar Fold 2 - La estafa contin√∫a</a></li>
<li><a href="../es492424/index.html">Angular: otra forma de darse de baja</a></li>
<li><a href="../es492426/index.html">C√≥mo evitar las minas de tecnolog√≠a de la informaci√≥n</a></li>
<li><a href="../es492432/index.html">FastText: receta de c√≥digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>