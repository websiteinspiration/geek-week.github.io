<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèôÔ∏è üßóüèø üéÖüèº Escalando testes do Android em Odnoklassniki üåº üõÄüèª üçî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°! Meu nome √© Roman Ivanitsky, trabalho na equipe de automa√ß√£o de testes do Odnoklassniki. OK √© um servi√ßo enorme, com mais de 70 milh√µes de usu√°rio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Escalando testes do Android em Odnoklassniki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√°! Meu nome √© Roman Ivanitsky, trabalho na equipe de automa√ß√£o de testes do Odnoklassniki. OK √© um servi√ßo enorme, com mais de 70 milh√µes de usu√°rios. Se falamos de dispositivos m√≥veis, a maioria usa OK.RU em smartphones com Android. Por esse motivo, levamos muito a s√©rio o teste de nosso aplicativo Android. Neste artigo, contarei a hist√≥ria do desenvolvimento de testes automatizados em nossa empresa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012, Odnoklassniki, a empresa est√° experimentando um aumento ativo no n√∫mero de usu√°rios e um aumento no n√∫mero de recursos do usu√°rio. </font><font style="vertical-align: inherit;">Para atender aos objetivos de neg√≥cios, foi necess√°rio diminuir o ciclo de libera√ß√£o, mas isso foi prejudicado pelo fato de que todas as funcionalidades foram testadas manualmente. </font><font style="vertical-align: inherit;">A solu√ß√£o para esse problema veio por si s√≥ - precisamos de autotestes. </font><font style="vertical-align: inherit;">Assim, em 2012 em Odnoklassniki, uma equipe de automa√ß√£o de testes apareceu e o primeiro passo foi come√ßar a escrever testes.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de hist√≥ria</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os primeiros autotestes em Odnoklassniki foram escritos em Selenium. No lan√ßamento, eles criaram Jenkins, Selenium Grid com Selenium Hub e um conjunto de Selenium Node. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solu√ß√£o r√°pida, in√≠cio r√°pido, lucro r√°pido - perfeito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o tempo, o n√∫mero de testes aumentou e os servi√ßos auxiliares apareceram - por exemplo, servi√ßos de inicializa√ß√£o, servi√ßo de relat√≥rio, servi√ßo de dados de teste. No final de 2014, t√≠nhamos mil testes realizados em quinze a vinte minutos. Isso n√£o nos convinha, pois estava claro que o n√∫mero de testes aumentaria e, com isso, o tempo necess√°rio para execut√°-los aumentaria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naquela √©poca, a infraestrutura de testes automatizados era assim:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, com uma quantidade de N√≥ Sel√™nio maior ou igual a 200, o Hub n√£o conseguiu lidar com a carga. </font><font style="vertical-align: inherit;">Agora, esse problema j√° foi estudado, e √© por isso que ferramentas como o Zalenium ou o Selenoid favorito de todos apareceram. </font><font style="vertical-align: inherit;">Mas em 2014 n√£o havia solu√ß√£o padr√£o, ent√£o decidimos fazer a nossa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definidos os requisitos m√≠nimos que o servi√ßo deve atender:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escalabilidade. </font><font style="vertical-align: inherit;">N√£o queremos depender das limita√ß√µes do Selenium Hub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estabilidade. </font><font style="vertical-align: inherit;">Em 2014, o Selenium Hub n√£o era famoso por sua opera√ß√£o est√°vel.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toler√¢ncia ao erro. </font><font style="vertical-align: inherit;">Precisamos da capacidade de continuar o processo de teste no caso de uma falha do datacenter ou de qualquer um dos servidores.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, nossa solu√ß√£o para dimensionar o Selenium Grid apareceu, consistindo de um coordenador e gerenciadores de n√≥s, aparentemente muito semelhantes ao Selenium Grid padr√£o, mas com seus pr√≥prios recursos. </font><font style="vertical-align: inherit;">Esses recursos ser√£o discutidos mais adiante.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coordenador</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, √© um intermedi√°rio de recursos (os recursos s√£o entendidos como navegadores). Possui uma API externa atrav√©s da qual os testes enviam solicita√ß√µes de recursos. Essas consultas s√£o salvas no banco de dados como tarefas a serem executadas. O coordenador sabe tudo sobre a configura√ß√£o do nosso cluster - quais gerenciadores de n√≥s existem, que tipos de recursos esses gerenciadores de n√≥s podem fornecer, o n√∫mero total de recursos, quantos recursos est√£o envolvidos no momento nas tarefas. Ao mesmo tempo, ele monitora os recursos - atividade, estabilidade e, nesse caso, notifica os respons√°veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma caracter√≠stica do coordenador √© que ele integra todos os gerenciadores de n√≥s nos chamados farms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a fazenda se parece. Mais da metade dos recursos s√£o usados ‚Äã‚Äãe todos os n√≥s online:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m pode exibir n√≥s offline ou inseri-los em rota√ß√£o em uma determinada porcentagem; isso √© necess√°rio se for necess√°rio reduzir a carga em um n√≥ espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada farm pode ser combinado com outros em uma unidade l√≥gica, que chamamos de servi√ßo. Ao mesmo tempo, um farm pode ser inclu√≠do em v√°rios servi√ßos diferentes. Em primeiro lugar, possibilita definir limites e priorizar os recursos utilizados por cada servi√ßo espec√≠fico. Em segundo lugar, ele permite que voc√™ gerencie facilmente a configura√ß√£o - temos a capacidade de adicionar o n√∫mero de gerenciadores de n√≥s no servi√ßo imediatamente ou vice-versa para remov√™-los do farm para poder interagir com esses gerenciadores de n√≥s, por exemplo, configurar ou atualizar etc. .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A API do coordenador √© bastante simples: √© poss√≠vel solicitar o servi√ßo para a quantidade atual de recursos utilizados, obter seu limite e iniciar ou interromper algum recurso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciador de n√≥s</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um servi√ßo que pode fazer duas coisas bem: receber tarefas do coordenador e lan√ßar alguns recursos sob demanda. </font><font style="vertical-align: inherit;">Por padr√£o, ele √© projetado para que cada inicializa√ß√£o do recurso seja isolada, ou seja, nenhuma das ativa√ß√µes anteriores possa afetar o lan√ßamento de testes subsequentes. </font><font style="vertical-align: inherit;">Como resposta, o coordenador usa um monte de host e um conjunto de portas elevadas. </font><font style="vertical-align: inherit;">Por exemplo, o host no qual o servidor Selenium foi iniciado e sua porta. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No host, fica assim: o servi√ßo do gerenciador de n√≥s est√° em execu√ß√£o e gerencia todo o ciclo de vida do recurso. </font><font style="vertical-align: inherit;">Ele pega os navegadores, os conclui, garante que eles n√£o sejam esquecidos de fechar. </font><font style="vertical-align: inherit;">Para garantir o isolamento um do outro, tudo isso acontece em nome do usu√°rio do servi√ßo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intera√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O teste interage com a infraestrutura descrita acima, da seguinte maneira: ele aborda o coordenador com uma solicita√ß√£o dos recursos necess√°rios, o coordenador salva essa tarefa como exigindo execu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gerenciador de n√≥s, por sua vez, recorre ao coordenador de tarefas. Tendo recebido a tarefa, ele inicia o recurso. Depois disso, ele envia o resultado do lan√ßamento ao coordenador, as partidas com falha tamb√©m s√£o relatadas ao coordenador. O teste recebe o resultado da solicita√ß√£o de recurso e, se for bem-sucedido, come√ßa a trabalhar diretamente com o recurso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As vantagens dessa abordagem s√£o reduzir a carga no coordenador, ganhando a capacidade de trabalhar diretamente com o recurso. Contras - a necessidade de implementar a l√≥gica da intera√ß√£o com o coordenador dentro das estruturas de teste, mas para n√≥s isso √© aceit√°vel.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, podemos rodar mais de 800 navegadores em paralelo em tr√™s data centers. </font><font style="vertical-align: inherit;">Para o coordenador, esse n√£o √© o limite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A toler√¢ncia a falhas √© garantida pelo lan√ßamento de v√°rias inst√¢ncias do coordenador encerradas atr√°s do firewall do DNS em diferentes datacenters. </font><font style="vertical-align: inherit;">Isso garante o acesso √† inst√¢ncia de trabalho no caso de um problema com o datacenter ou servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtivemos uma solu√ß√£o que atendeu a todos os requisitos inicialmente definidos. </font><font style="vertical-align: inherit;">Est√° em opera√ß√£o constante desde 2015 e provou sua efic√°cia.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando se trata de testar no Android, geralmente existem duas abordagens principais. O primeiro √© usar o WebDriver - √© assim que o Selendroid e o Appium funcionam. O segundo - ao trabalhar com ferramentas nativas, implementou o Robotium, o UI Automator ou o Espresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As semelhan√ßas fundamentais entre essas abordagens s√£o obter o dispositivo e o navegador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muito mais diferen√ßas, a principal delas √© a necessidade de instalar o APK testado, com o qual levaremos artefatos na forma de logs, capturas de tela etc. e tamb√©m, o fato de o teste ser realizado no pr√≥prio dispositivo, e n√£o no IC.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 2015, o Odnoklassniki come√ßou a cobrir seu aplicativo Android com autotestes. Selecionamos uma m√°quina Linux, conectamos um dispositivo real via USB e come√ßamos a escrever testes no Robotium. Esta solu√ß√£o simples permitiu obter resultados rapidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tempo passou, o n√∫mero de testes e o n√∫mero de dispositivos aumentaram. Para resolver tarefas de gerenciamento, o Gerenciador de Dispositivos foi criado - um wrapper sobre </font><font style="vertical-align: inherit;">comandos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Android Debug Bridge), que permite que a interface http api os execute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi assim que a primeira API do Gerenciador de dispositivos foi exibida - com sua ajuda, voc√™ pode obter uma lista de dispositivos, instalar / desinstalar APKs, executar testes e obter resultados.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, percebemos que os resultados do teste s√£o degradados na inicializa√ß√£o no servidor ADB ao qual mais de um dispositivo est√° conectado. A solu√ß√£o que nos ajudou a melhorar a estabilidade foi encontrada no isolamento de cada servidor ADB usando o Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O farm est√° pronto - voc√™ pode conectar telefones. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitos est√£o familiarizados com esta imagem. Ouvi dizer que, se voc√™ est√° envolvido em fazendas Android, est√° como se estivesse no inferno todos os dias.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um emulador do Android veio em nosso aux√≠lio. Seu uso foi devido a dois fatores: primeiro, na √©poca, j√° havia atingido o n√≠vel necess√°rio de estabilidade; em segundo lugar, n√£o t√≠nhamos nenhum recurso que dependesse especificamente do ferro em nossos testes. Al√©m disso, esse emulador foi bem projetado na infraestrutura existente naquele momento. O pr√≥ximo passo foi ensinar o gerenciador de n√≥s a lan√ßar novos tipos de recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que √© necess√°rio para executar o emulador do Android? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa de um SDK do Android com um conjunto de utilit√°rios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o voc√™ precisa criar o AVD - Dispositivo Virtual Android - √© assim que seu emulador Android ser√° organizado - qual arquitetura ele ter√°, quantos n√∫cleos ele usar√°, se os servi√ßos do Google estar√£o dispon√≠veis etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, voc√™ precisa selecionar o nome do AVD criado, definir os par√¢metros, por exemplo, transferir a porta na qual o ADB ser√° iniciado e iniciar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existe uma peculiaridade nesse esquema - o sistema permite executar apenas um emulador de inst√¢ncia em um AVD espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o para esse problema foi criar um AVD b√°sico, armazenado na mem√≥ria, possibilitando copi√°-lo em outro lugar. </font><font style="vertical-align: inherit;">Durante o lan√ßamento do emulador do Android, o AVD base foi copiado para um diret√≥rio tempor√°rio mapeado na mem√≥ria, ap√≥s o qual foi iniciado. </font><font style="vertical-align: inherit;">Esse esquema funcionou rapidamente, mas era complicado. </font><font style="vertical-align: inherit;">At√© o momento, esse problema foi resolvido pela op√ß√£o somente leitura, que permite executar emuladores Android em quantidades ilimitadas a partir de um AVD</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atua√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nos resultados do trabalho com AVD, desenvolvemos v√°rias recomenda√ß√µes internas:</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto √†s imagens do Docker para teste no Android, quero destacar Agoda e Selenoid, eles usam os recursos dos emuladores do Android ao m√°ximo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferen√ßa entre eles √© que, no Selenoid padr√£o, voc√™ tem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Agoda e usou o emulador "limpo". Al√©m disso, o Selenoid tem mais apoio da comunidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final de 2018, o CloudNode-Manager foi criado, entra em contato com o coordenador, recebe tarefas e √© iniciado usando comandos na nuvem. Em vez de m√°quinas de ferro, este servi√ßo usa os recursos da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuvem √∫nica - a nuvem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> privada de Odnoklassniki.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conseguimos alcan√ßar o dimensionamento ensinando o DeviceManager a trabalhar com o Coordenador. Para fazer isso, tive que alterar a API do gerenciador de dispositivos para adicionar a capacidade de solicitar um tipo de dispositivo (virtual / real). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â o que acontece se voc√™ tentar executar a Instala√ß√£o do ADB em 250 emuladores a partir de uma √∫nica m√°quina. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os atendentes reagiram imediatamente a isso e iniciaram um incidente - a m√°quina carregava a interface de rede gigabit com tr√°fego de sa√≠da. Essa complexidade foi resolvida aumentando a taxa de transfer√™ncia no servidor. N√£o posso dizer que esse problema nos deu muitos problemas, mas voc√™ n√£o deve esquecer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que o sucesso √© o Gerenciador de dispositivos, coordenador, dimensionamento. Podemos executar testes em todo o farm. Em princ√≠pio, podemos execut√°-los em todas as solicita√ß√µes de recebimento, e o desenvolvedor receber√° rapidamente um feedback.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas nem tudo √© t√£o r√≥seo. Voc√™ deve ter notado que at√© agora nada foi dito sobre a qualidade dos testes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era assim que eram os nossos lan√ßamentos. E o mais interessante √© que entre os lan√ßamentos, testes completamente diferentes podem cair. Foram quedas inst√°veis. E nem eu, nem os desenvolvedores, nem os testadores confiamos nesses resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como lidamos com esse problema? Eles apenas copiaram tudo, de Robotium a Espresso, e ficou bom ... Na verdade, n√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver esse problema, n√£o apenas reescrevemos tudo no Espresso, mas tamb√©m come√ßamos a usar a API para todos os tipos de a√ß√µes, como upload de fotos, cria√ß√£o de postagens, adi√ß√£o de amigos, etc., fizemos um login r√°pido, utilizamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diplinks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que permitem acessar diretamente a tela desejada e, √© claro, analisamos todos os casos de teste.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, os testes s√£o parecidos com o seguinte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode observar que os testes em vermelho permanecem, mas √© importante lembrar que esses s√£o testes de ponta a ponta que s√£o executados na produ√ß√£o. Temos um limite no n√∫mero de testes que podem cair no ramo principal do aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, temos testes e dimensionamento est√°veis. No entanto, a infraestrutura de teste ainda est√° altamente ligada aos testes. Ao mesmo tempo, devido √† expectativa de testes de ponta a ponta, o IC est√° ocupado e outros assemblies podem enfileirar-se, aguardando agentes livres. Al√©m disso, n√£o h√° um esquema claro para trabalhar com partidas paralelas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os motivos mencionados acima tornaram-se o √≠mpeto para o desenvolvimento do QueueRunner - um servi√ßo que permite executar testes de forma ass√≠ncrona, sem bloquear o IC. </font><font style="vertical-align: inherit;">Para funcionar, ele precisa de um teste e um APK, al√©m de um conjunto de testes. </font><font style="vertical-align: inherit;">Depois de receber os dados necess√°rios, ele poder√° organizar execu√ß√µes de execu√ß√µes na fila, alocando e liberando os recursos necess√°rios. </font><font style="vertical-align: inherit;">O QueueRunner baixa os resultados da execu√ß√£o para Jira e Stash e tamb√©m os envia por correio e no messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O QueueRunner possui um fluxo de teste - monitora o ciclo de vida do teste. </font><font style="vertical-align: inherit;">O fluxo padr√£o que usamos agora consiste em cinco etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dispositivo receptor. </font><font style="vertical-align: inherit;">Nesse ponto, o Gerenciador de dispositivos solicita ao coordenador um dispositivo real ou virtual.</font></font></li>
<li> .        APK  ,    ‚Äì  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, cinco etapas simples s√£o o ciclo de vida completo do teste em nosso servi√ßo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que benef√≠cios o QueueRunner nos deu? Em primeiro lugar, ele usa todos os recursos poss√≠veis ao m√°ximo - pode ser dimensionado para todo o farm e obter resultados rapidamente. Em segundo lugar, com o b√¥nus, tivemos a oportunidade de controlar a sequ√™ncia de testes. Por exemplo, podemos executar os testes mais longos ou mais problem√°ticos no in√≠cio e, assim, reduzir o tempo que leva para esperar a execu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O QueueRunner tamb√©m permite fazer retrays inteligentes. Armazenamos todos os dados no banco de dados, para que a qualquer momento possamos ver o hist√≥rico do teste. Por exemplo, √© poss√≠vel examinar a propor√ß√£o de aprova√ß√µes com e sem √™xito do teste e decidir se, em princ√≠pio, vale a pena reiniciar o teste.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O QueueRunner e o Devicemanager nos deram a capacidade de se adaptar √† quantidade de recursos. Agora podemos escalar para todo o farm, gra√ßas ao uso de emuladores, ou seja, um n√∫mero quase ilimitado de dispositivos virtuais nos deu a oportunidade de executar muito mais testes, mas se por algum motivo os recursos n√£o estiverem dispon√≠veis, o servi√ßo esperar√° que eles retornem e n√£o haver√° perda de lan√ßamentos. Utilizamos apenas os recursos dispon√≠veis, portanto, ap√≥s algum tempo os resultados ainda ser√£o obtidos e, ao mesmo tempo, o IC n√£o ser√° bloqueado. E o mais importante, a infraestrutura e os testes de teste agora est√£o separados. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, para executar testes no Android, voc√™ s√≥ precisa nos fornecer um APK de teste e uma lista de testes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Percorremos um longo caminho desde o farm Selenium em m√°quinas virtuais at√© o lan√ßamento de testes do Android na nuvem. </font><font style="vertical-align: inherit;">No entanto, esse caminho ainda n√£o foi conclu√≠do.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processo de desenvolvimento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como a infraestrutura de teste est√° relacionada ao processo de desenvolvimento e como os testadores e desenvolvedores a veem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossa equipe do Android usa o GitFlow padr√£o: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cada recurso tem sua pr√≥pria ramifica√ß√£o. O principal desenvolvimento ocorre no ramo de desenvolvimento. Um desenvolvedor que decide criar um novo super recurso come√ßa seu desenvolvimento em sua pr√≥pria ramifica√ß√£o, enquanto outros desenvolvedores podem trabalhar em outras ramifica√ß√µes em paralelo. Quando um desenvolvedor considera que o melhor c√≥digo ideal e bonito do mundo est√° pronto e precisa ser implementado para os usu√°rios o mais r√°pido poss√≠vel, ele faz uma solicita√ß√£o de pull no desenvolvimento, a unidade √© montada automaticamente, testes de unidade e testes de componentes s√£o executados. Simultaneamente, os APKs s√£o montados, enviados ao QueueRunner e os testes de ponta a ponta s√£o executados. Depois disso, os resultados da execu√ß√£o dos testes chegam ao desenvolvedor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existe uma alta probabilidade de que, ap√≥s a cria√ß√£o da ramifica√ß√£o do recurso em desenvolvimento, houvesse muitos commits. </font><font style="vertical-align: inherit;">Isso significa que desenvolver pode n√£o ser o que costumava ser. </font><font style="vertical-align: inherit;">Portanto, a pr√©-mesclagem acontece primeiro - mesclamos o desenvolvimento para o ramo de recursos atual e √© nesse estado prematuro que constru√≠mos, testes de unidade, testes de componentes, ponta a ponta e, com base nesses resultados, fazemos um relat√≥rio. </font><font style="vertical-align: inherit;">Assim, entendemos como o recurso √© funcional na vers√£o atual do develop e, se tudo estiver correto, ele ser√° enviado aos usu√°rios.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comunicando</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que os relat√≥rios do Stash se parecem: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso bot primeiro escreve que os testes foram iniciados e, quando s√£o aprovados, atualiza a mensagem e adiciona quantos passaram, quantos ca√≠ram, quantos erros conhecidos e quantos testes s√£o escamosos. Ele escreve a mesma coisa em Jira e adiciona um link para uma compara√ß√£o de lan√ßamentos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a compara√ß√£o dos dois lan√ßamentos se parece: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, a execu√ß√£o atual no ramo de recursos √© comparada com a √∫ltima execu√ß√£o no desenvolvimento. Ele cont√©m informa√ß√µes sobre o n√∫mero de testes que est√£o sendo executados, problemas de correspond√™ncia, testes descartados e testes inst√°veis ‚Äã‚Äãinst√°veis ‚Äã‚Äãque estavam em um estado e alternaram para outro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se pelo menos um teste de unidade ou mais do que um limite de testes de ponta a ponta cair, a mesclagem ser√° bloqueada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender se os testes caem de forma est√°vel, comparamos os hashes dos tra√ßos das quedas, antes que eles sejam eliminados preliminarmente dos n√∫meros, apenas os n√∫meros das linhas permanecem. </font><font style="vertical-align: inherit;">Se os hashes corresponderem, ent√£o ser√° a mesma queda, se forem diferentes, provavelmente as quedas ser√£o diferentes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, implementamos uma solu√ß√£o est√°vel e tolerante a falhas que se adapta bem √† nossa infraestrutura. </font><font style="vertical-align: inherit;">Em seguida, a infraestrutura resultante foi adaptada para testes do Android. </font><font style="vertical-align: inherit;">N√≥s fomos ajudados nisso pelo gerenciador de dispositivos, que nos ajuda a trabalhar simultaneamente com dispositivos reais e virtuais, assim como pelo QueueRunner, que nos ajudou a separar a infraestrutura e os testes, e n√£o bloquear o IC durante os testes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parecia o tempo de execu√ß√£o do teste por uma semana em 2016 - a partir de cinquenta minutos ou mais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que parece agora: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
este gr√°fico mostra as execu√ß√µes ocorridas ao longo de 2 horas de um dia √∫til m√©dio. </font><font style="vertical-align: inherit;">O tempo de execu√ß√£o foi reduzido para um m√°ximo de 15 minutos, o n√∫mero de execu√ß√µes aumentou acentuadamente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt497700/index.html">Mitaps online semanais sobre suporte e DevOps, seguran√ßa e rob√¥s a partir de 17 de abril</a></li>
<li><a href="../pt497702/index.html">Cinco tend√™ncias em armazenamento de dados que voc√™ deve prestar aten√ß√£o em 2020</a></li>
<li><a href="../pt497708/index.html">Convidamos voc√™ a uma s√©rie de semin√°rios on-line da Fujitsu em abril e maio</a></li>
<li><a href="../pt497714/index.html">Como proteger processos e extens√µes de kernel no macOS</a></li>
<li><a href="../pt497724/index.html">Preparando um servidor para publicar um aplicativo Web em Python</a></li>
<li><a href="../pt497728/index.html">Os perigos de "queimar" chips</a></li>
<li><a href="../pt497730/index.html">BDD conveniente: SpecFlow + TFS</a></li>
<li><a href="../pt497736/index.html">Revis√£o de 10 novos motores de combust√£o interna</a></li>
<li><a href="../pt497738/index.html">Teste-se em Swift: um quebra-cabe√ßa para os amantes de quebra-cabe√ßas</a></li>
<li><a href="../pt497740/index.html">As montadoras admitem que demorou muito tempo para ve√≠culos totalmente n√£o tripulados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>