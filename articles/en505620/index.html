<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé∫ üë®üèæ‚Äç‚öñÔ∏è üë®üèæ‚Äçü§ù‚Äçüë®üèª HackTheBox. Walkthrough Nest. NTFS streams, reverse C # and SMB walker ü§£ üôèüèæ üë©üèø‚Äçü§ù‚Äçüë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to publish solutions sent for further processing from the HackTheBox site . 
 
 In this article, we wander around in SMB resources for a lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox. Walkthrough Nest. NTFS streams, reverse C # and SMB walker</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505620/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/1q/ca/yw/1qcaywxbp6rhhpdnvzrz962rtuq.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I continue to publish solutions sent for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">further processing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> site </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we wander around in SMB resources for a long time, find alternative NTFS streams and reverse the application in C #. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connection to the laboratory is via VPN. </font><font style="vertical-align: inherit;">It is recommended not to connect from a work computer or from a host where the data important to you is available, since you get into a private network with people who know something in the field of information security :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizational Information</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This machine has an IP address 10.10.10.178, which I add to / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.178    nest.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we scan open ports. </font><font style="vertical-align: inherit;">Since it takes a long time to scan all the ports with nmap, I will first do this with masscan. </font><font style="vertical-align: inherit;">We scan all TCP and UDP ports from the tun0 interface at a speed of 500 packets per second.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.178  --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/xj/kx/xl/xjkxxlv08bbqnoe4gbgwtguoxps.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, for more detailed information about the services that operate on ports, we will run a scan with the -A option.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A nest.htb -p445,4386</code></pre><br>
<img src="https://habrastorage.org/webt/m0/of/ri/m0ofrismd3eiavaq3pwsdwrnf5u.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, let's pay attention to the SMB resource. Let's try to log in as a guest. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/ja/sr/erjasr0e1z10xlk-viawzul3ztw.png" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sauna </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And discover the available resources. Let's recursively look at all the content that is available to us. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eo/g7/m_/eog7m_ppephro2mox1k3qiiav4w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of the above files, the most interesting note is ‚ÄúWelcome Email.txt‚Äù. We will connect to the resource and save this file to our local machine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/bj/np/pzbjnpsuibvqekhaw8srf-94ns8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the message itself, the resource and credentials for connecting to it are reported. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/j2/gh/saj2ghkvbfk8lny49jizvvawyfm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see all the contents of the resource, but already using the credentials found. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kx/ld/_8/kxld_8g1kwwcgrzgsjidyj8xi1o.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we should always be interested in configuration files, since you can find the names of resources, services, or even credentials in them. Therefore, we again connect to the resource and take all the configs.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n1/rr/zm/n1rrzmayhnjffj3qcrykh_fmsq0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in one file we find the name of the private resource "Secure $", and in the other - the user's credentials. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b1/f0/wc/b1f0wciwt8jctq6xpggbn6h3-oi.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/v7/gp/cz/v7gpcze1fwtf_5ktriy3x7tn3c4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the password does not fit, apparently it is encrypted. But it turns out to turn to the found resource with existing credentials. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9l/x0/bg/9lx0bgkmvtsdmun0mmxdbg4apo4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we cannot view the contents of the IT directory, since we have one directory inside (it follows from the config). We look at the entire contents of \ Secure $ \ IT \ Carl \. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vq/pz/af/vqpzaftcpmf2e8fipswnp2m-p7q.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The VisualBasic project is located there. I connected via explorer and copied the project folder to the local machine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/x5/fj/vhx5fj_fhxvhyflzzj51sdjztvm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We open the project and find the place where the password is read from the config and decrypted. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yl/rl/2t/ylrl2tkmtdg2m6cemcg7v12cy3q.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a quick look at the encryption principle itself, I didn‚Äôt really want to climb, so we load the project in Visual Studio and change the code to find out the password when debugging.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d8/bm/5x/d8bm5xgp4myrmxhfarjrkptq-as.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/-q/oq/nd/-qoqndiavdp-95wpjrqvscvbzbs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we find out the real password of the user. </font><font style="vertical-align: inherit;">We connect and take the token.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/xc/xq/pgxcxqkosw6yyvbxw9ylt7hehc0.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look further in the user's working directory. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xq/82/ua/xq82uaot_ewfco-r8zoccjit8sg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the configuration file, we understand what works on the second port. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sc/e4/bu/sce4buc1y2ojoojs5afzfjgi72o.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But by connecting and seeing help, we understand that we need a password. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5i/6t/x5/5i6tx5hboicu1cy54axpuwgby9m.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go into the directory and download the application, perhaps by analyzing it, we can find the password. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/hz/r4/kwhzr41tyd7ycefdozvehrcxdpc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is fortunate that this application is written in C #, this will allow us to easily decompile the entire project using dnSpy. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vb/yv/je/vbyvjettxqh2e1kmkuy5uld6k9g.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/b-/03/dd/b-03ddpj7wa36l3yquitc4qe4eu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the program, the program receives a configuration file as input, from where it obtains certain parameters. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ru/bh/4c/rubh4cc_xlxeuoeid_zbzrixlvy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we don‚Äôt find anything in the project. </font><font style="vertical-align: inherit;">Further, a lot of time was spent until the realization came to peer into the empty file ‚ÄúDebug Mode Password.txt‚Äù. </font><font style="vertical-align: inherit;">Connect the network resource.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/za/ww/ljzaww9bc1okdei5zb6ijm2mili.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see all the streams of this file. And we determine that the Password stream stores 15 characters. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/ex/ui/jcexuiyaeurfbkqtyifktjyl7l8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We read it, find the password for debug mode (dull ... it happens). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h6/j-/zd/h6j-zdp23tjyzvghmvtavtueuvs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect again, enter this password and see the help. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kb/ow/qx/kbowqxqut1w80cxgj-emecsytv8.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/2_/le/oz/2_leozjuut9uequuljlrsbipvre.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then it was worth a little wandering around in the application, because you need to find some kind of config for the decompiled project. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pc/ny/qy/pcnyqykndlb9rjh8sxkzxssa-q0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Judging by the name of the application, let's go to LDAP. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4k/sw/wl/4kswwl3l-kjdx_mxow_q4jb31pg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And again we find the application that we already have and the config file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/kq/wf/ixkqwfnbqek_xvaqotvzb4ttp9i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are the parameters that are converted in the application. Find the decryption function, and draw the value to the console before returning it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/ao/fr/vjaofrlr3cxfxlo45gwp1zntgk4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, we will change one of the conditions so that the application does not stop when checking for a file.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7x/x-/f_/7xx-f_w2b8glnjotuipvuezzjbw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We recompile the project and run the application, specifying the config as an argument. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fo/ug/s5/fougs58hhnawb91i6tpbsybm63s.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we get the administrator password. </font><font style="vertical-align: inherit;">Next, we successfully connect using psexec. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/ty/ku/_utykuvl0nxpltgzolgmckr19eq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have full control over the machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can join us on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There you can find interesting materials, merged courses, as well as software. </font><font style="vertical-align: inherit;">Let's put together a community in which there will be people who are versed in many areas of IT, then we can always help each other on any IT and information security issues.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505608/index.html">Vuex - solve an old dispute with new methods</a></li>
<li><a href="../en505612/index.html">MK-61: history, emulation, device</a></li>
<li><a href="../en505614/index.html">–°—Ç–∞–≤–∫–∏ –≤–∫–ª–∞–¥–æ–≤ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö –±–∞–Ω–∫–æ–≤ —Å–Ω–∏–∑–∏–ª–∏—Å—å –¥–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞: –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∫—É, –∏ –ø—Ä–∏—á–µ–º –∑–¥–µ—Å—å –±–∏—Ä–∂–∞</a></li>
<li><a href="../en505616/index.html">Recognition of the Russian alphabet: from collecting a dataset to creating a GUI</a></li>
<li><a href="../en505618/index.html">GRASP Templates: Creator</a></li>
<li><a href="../en505624/index.html">How to process a data frame with billions of records in seconds?</a></li>
<li><a href="../en505632/index.html">Memory allocators</a></li>
<li><a href="../en505634/index.html">Proxy Settings for WSL (Ubuntu)</a></li>
<li><a href="../en505640/index.html">Publication Rating Objectivity</a></li>
<li><a href="../en505642/index.html">Transparent coroutines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>