<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”ƒ ğŸ‘ƒğŸ¿ ğŸˆ¶ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ4.ã‚¸ã‚§ãƒ³ã‚­ãƒ³ã‚¹ ğŸ§œğŸ¿ ğŸ™‡ğŸ½ ğŸ¥ </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã‚“ã«ã¡ã¯ã€ãƒãƒ–ãƒ«ï¼
 

ã“ã‚Œã¯ã€ä¸€é€£ã®è¨˜äº‹ã€ŒLearning to Deploy microservicesã€ã®4ç•ªç›®ã§æœ€å¾Œã®éƒ¨åˆ†ã§ã™ã€‚ä»Šæ—¥ã¯ã€Jenkinsã‚’æ§‹æˆã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚Jenkinsã¯ã€åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã‹ã‚‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ4.ã‚¸ã‚§ãƒ³ã‚­ãƒ³ã‚¹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493580/"><p><img src="https://habrastorage.org/webt/m0/kw/le/m0kwle2zleti3meldshk_1ct98o.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚“ã«ã¡ã¯ã€ãƒãƒ–ãƒ«ï¼</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€ä¸€é€£ã®è¨˜äº‹ã€ŒLearning to Deploy microservicesã€ã®4ç•ªç›®ã§æœ€å¾Œã®éƒ¨åˆ†ã§ã™ã€‚ä»Šæ—¥ã¯ã€Jenkinsã‚’æ§‹æˆã—ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">Jenkinsã¯ã€åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã‹ã‚‰æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã€Dockerã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ãŠã‚ˆã³ãƒ†ã‚¹ãƒˆã—ã¦ã‹ã‚‰ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åé›†ã—ã¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ¼ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æœ€å¾Œã®æ“ä½œJenkinsã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°ã—ã€Helmã¨å¯¾è©±ã—ã¾ã™ï¼ˆè©³ç´°ã«ã¤ã„ã¦ã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰ã®ãƒ‘ãƒ¼ãƒˆã§èª¬æ˜ã—ã¾ã™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€é€£ã®è¨˜äº‹ã®æ¦‚è¦ï¼š</font></font></p><br>
<ol>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Spring Boot,   Docker</a></p><br>
<p><strong><em> : Java 11, Spring Boot, Docker, image optimization</em></strong></p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Kubernetes      Google Kubernetes Engine</a></p><br>
<p><strong><em> : Kubernetes, GKE, resource management, autoscaling, secrets</em></strong></p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Helm 3     </a></p><br>
<p><strong><em> : Helm 3, chart deployment</em></strong></p><br>
</li>
<li><p> Jenkins        </p><br>
<p><strong><em> : Jenkins configuration, plugins, separate configs repository</em></strong></p><br>
</li>
</ol><br>
<p>Jenkins â€”    ,   Java.      -    .           Groovy,     (Jenkinsfile)         .     , ,          .</p><br>
<p>    GitHub  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h2 id="ustanovka-i-nastroyka-jenkins">   Jenkins</h2><br>
<h4 id="ustanovka"></h4><br>
<p>    Jenkins:</p><br>
<ul>
<li> war-</li>
<li>  Docker-</li>
<li>  Kubernetes</li>
</ul><br>
<p>War-             (â„– Apache Tomcat).      ,        .</p><br>
<p>   ,  Jenkins  Docker.   Jenkins     ,        .     â€”   (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   ),      'docker:dind',        Jenkins'.</p><br>
<p>   Jenkins   Kubernetes.     Jenkins,        .        ,       .        .    Jenkins  Google Kubernetes Engine     .</p><br>
<p>      ,       Jenkins  Docker .   ,         stateful   Kubernetes.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>    Jenkins  Kubernetes.</p><br>
<p>   ,    Jenkins   .       , , Google Compute Engine.   ,      Jenkins  Raspberry Pi,  -   ""            Docker-.     Raspberry Pi   .</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="bash hljs">docker network create jenkins<font></font>
<font></font>
docker volume create jenkins-docker-certs<font></font>
docker volume create jenkins-data<font></font>
<font></font>
docker container run \<font></font>
  --name jenkins-docker \<font></font>
  --detach \<font></font>
  --privileged \<font></font>
  --network jenkins \<font></font>
  --network-alias docker \<font></font>
  --env DOCKER_TLS_CERTDIR=/certs \<font></font>
  --volume jenkins-docker-certs:/certs/client \<font></font>
  --volume jenkins-data:/var/jenkins_home \<font></font>
  --publish 2376:2376 \<font></font>
  docker:dind<font></font>
<font></font>
docker container run \<font></font>
  --name jenkins-blueocean \<font></font>
  --detach \<font></font>
  --network jenkins \<font></font>
  --env DOCKER_HOST=tcp://docker:2376 \<font></font>
  --env DOCKER_CERT_PATH=/certs/client \<font></font>
  --env DOCKER_TLS_VERIFY=1 \<font></font>
  --publish 8080:8080 \<font></font>
  --publish 50000:50000 \<font></font>
  --volume jenkins-data:/var/jenkins_home \<font></font>
  --volume jenkins-docker-certs:/certs/client:ro \<font></font>
  jenkinsci/blueocean</code></pre></div></div><br>
<p>  Jenkins  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://localhost:8080/</a>   .  Jenkins   UI,  .     "  " (IaC).         â€”   Groovy.        .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h4 id="plaginy"></h4><br>
<p>      (Manage Jenkins -&gt; Manage Plugins).     .     'Blue Ocean',        .</p><br>
<p>       : Remote File Plugin  Kubernetes CLI. Remote File Plugin   Jenkinsfile   ,  Kubernetes CLI    kubectl   .</p><br>
<h4 id="ustanovka-helm"> Helm</h4><br>
<p>       Helm-,          Helm.   Helm   ,     .      (<code>docker exec -it jenkins-blueocean bash</code>),            /usr/bin.     Helm-:</p><br>
<pre><code class="bash hljs">helm repo add msvc-repo https://anshelen.github.io/microservices-deploy/<font></font>
helm repo update</code></pre><br>
<h4 id="globalnye-peremennye-sredy">  </h4><br>
<p>     ,     .      ,       .   ,    ,          Jenkins. ,          â€”    .</p><br>
<p>     (Manage Jenkins -&gt; Configure System -&gt; Global properties -&gt; Environment Variables):</p><br>
<ul>
<li>CLUSTER_URL â€”  - Kubernetes.    <code>kubectl cluster-info</code></li>
<li>CLUSTER_NAMESPACE â€”   </li>
<li>HELM_PROJECT â€”   Helm</li>
<li>HELM_CHART â€”  Helm-.     'msvc-repo/msvc-chart'</li>
</ul><br>
<h4 id="sekrety"></h4><br>
<p> Jenkins        , ,  -,  ,    .      Credentials -&gt; System -&gt; Global credentials -&gt; Add Credentials:</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th> </th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>github-creds</td>
<td>username with password</td>
<td>/  git-</td>
</tr>
<tr>
<td>dockerhub-creds</td>
<td>username with password</td>
<td>/   Docker-</td>
</tr>
<tr>
<td>kubernetes-creds</td>
<td>secret text</td>
<td>    </td>
</tr>
</tbody>
</table></div><br>
<p>     NOTES.txt           .      ,   Helm- (<code>helm status msvc-project</code>).</p><br>
<h2 id="konfiguraciya-payplayna"> </h2><br>
<p>    ,    Groovy,         .     .</p><br>
<p> Jenkins    ()     (stage).      (agent). </p><br>
<p>      :</p><br>
<ol>
<li>Build.  </li>
<li>Test.  .       ,    Maven        </li>
<li>Package.  jar-</li>
<li>Push Images.  Docker-      .      â€”   latest   </li>
<li>Trigger Kubernetes.  Kubernetes  Docker-   </li>
</ol><br>
<p><img src="https://habrastorage.org/webt/pp/ii/nz/ppiinzxlxnzscurfsojgo7jhtbu.png"></p><br>
<h4 id="struktura-fayla-konfiguracii">  </h4><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">pipeline {<font></font>
  agent none<font></font>
  options { ... }<font></font>
  environment { ... }<font></font>
  stages {<font></font>
    stage("Prepare container") {<font></font>
      agent {<font></font>
        docker {<font></font>
          image 'openjdk:11.0.5-slim'<font></font>
          args '-v $HOME/.m2:/root/.m2'<font></font>
        }<font></font>
      }<font></font>
      stages {<font></font>
        stage('Build') { ... }<font></font>
        stage('Test') { ... }<font></font>
        stage('Package') { ... }<font></font>
      }<font></font>
    }<font></font>
<font></font>
    stage('Push images') {<font></font>
      agent any<font></font>
      when { branch 'master' }<font></font>
      steps { ... }<font></font>
    }<font></font>
<font></font>
    stage('Trigger kubernetes') {<font></font>
      agent any<font></font>
      when { branch 'master' }<font></font>
      steps { ... }<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p>  Jenkins    "" â€”      ,      .  pipeline        .          ,             .    pipeline   'none'.    ,          -  .</p><br>
<p> Build, Test  Package     Docker-      .   Docker-         Java 11 (Jenkins   Java 8).         ,      'Prepare container'   'docker'.   args    .m2         Jenkins'.   .m2     Maven,     ,     .</p><br>
<p>   Push Images  Trigger Kubernetes  'any'.  ,         .         Jenkins'.          - (<code>when { branch 'master' }</code>).</p><br>
<p>        ,     options  environment.</p><br>
<h4 id="opcii"></h4><br>
<pre><code class="plaintext hljs">options {<font></font>
  skipStagesAfterUnstable()<font></font>
  skipDefaultCheckout()<font></font>
}</code></pre><br>
<p>            .    :</p><br>
<ul>
<li><p><strong><em>skipStagesAfterUnstable</em></strong>  Jenkins   , e   .         UNSTABLE   .          .</p><br>
</li>
<li><p><strong><em>skipDefaultCheckout</em></strong>     .  Jenkins  force         (   Prepare Checkout, Push images  Trigger Kubernetes).       .           .          â€”   Build.   skipDefaultCheckout,      .   ,  Jenkins      . , ,     Build      Test.</p><br>
</li>
</ul><br>
<h4 id="peremennye-sredy"> </h4><br>
<pre><code class="plaintext hljs">environment {<font></font>
  IMAGE_BASE = 'anshelen/microservices-backend'<font></font>
  IMAGE_TAG = "v$BUILD_NUMBER"<font></font>
  IMAGE_NAME = "${env.IMAGE_BASE}:${env.IMAGE_TAG}"<font></font>
  IMAGE_NAME_LATEST = "${env.IMAGE_BASE}:latest"<font></font>
  DOCKERFILE_NAME = "Dockerfile-packaged"<font></font>
}</code></pre><br>
<p>         ,     .   ,   -  .            Docker-.</p><br>
<p>            latest ,  ,      -      .   ,           ,        .  IMAGE_TAG      ,         BUILD_NUMBER.           ,      (     ).    BUILD_NUMBER   ,       "".       â€”      .         ,      .</p><br>
<h4 id="kompilyaciya-testirovanie-sborka">, , </h4><br>
<pre><code class="plaintext hljs">stage("Prepare container") {<font></font>
  agent {<font></font>
    docker {<font></font>
      image 'openjdk:11.0.5-slim'<font></font>
      args '-v $HOME/.m2:/root/.m2'<font></font>
    }<font></font>
  }<font></font>
  stages {<font></font>
    stage('Build') {<font></font>
      steps {<font></font>
        checkout scm<font></font>
        sh './mvnw compile'<font></font>
      }<font></font>
    }<font></font>
    stage('Test') {<font></font>
      steps {<font></font>
        sh './mvnw test'<font></font>
        junit '**/target/surefire-reports/TEST-*.xml'<font></font>
      }<font></font>
    }<font></font>
    stage('Package') {<font></font>
      steps {<font></font>
        sh './mvnw package -DskipTests'<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p>   ,        ,          .    Maven      ,        .</p><br>
<p>         <code>checkout scm</code>.     ,     Jenkins.   bash-   .</p><br>
<p>    <code>junit '**/target/surefire-reports/TEST-*.xml'</code>   Jenkins'     .       -.</p><br>
<p>     jar-   .</p><br>
<h4 id="sozdanie-i-otpravka-docker-obraza-v-reestr">   Docker-  </h4><br>
<p>      Docker-     .      Jenkins,           Maven-.</p><br>
<p>     -  ,       .  -         .       ,          Jenkins.      Dockerfile-packaged.</p><br>
<div class="spoiler"><b class="spoiler_title"> Dockerfile</b><div class="spoiler_text"><pre><code class="plaintext hljs">FROM adoptopenjdk/openjdk11:jdk-11.0.5_10-alpine as builder<font></font>
ADD . /src<font></font>
WORKDIR /src<font></font>
RUN ./mvnw package -DskipTests<font></font>
<font></font>
FROM alpine:3.10.3 as packager<font></font>
RUN apk --no-cache add openjdk11-jdk openjdk11-jmods<font></font>
ENV JAVA_MINIMAL="/opt/java-minimal"<font></font>
# build minimal JRE<font></font>
RUN /usr/lib/jvm/java-11-openjdk/bin/jlink \<font></font>
    --verbose \<font></font>
    --add-modules \<font></font>
        java.base,java.sql,java.naming,java.desktop,java.management,java.security.jgss,java.instrument \<font></font>
    --compress 2 --strip-debug --no-header-files --no-man-pages \<font></font>
    --release-info="add:IMPLEMENTOR=radistao:IMPLEMENTOR_VERSION=radistao_JRE" \<font></font>
    --output "$JAVA_MINIMAL"<font></font>
<font></font>
FROM alpine:3.10.3<font></font>
LABEL maintainer="Anton Shelenkov anshelen@yandex.ru"<font></font>
ENV JAVA_HOME=/opt/java-minimal<font></font>
ENV PATH="$PATH:$JAVA_HOME/bin"<font></font>
COPY --from=packager "$JAVA_HOME" "$JAVA_HOME"<font></font>
COPY --from=builder /src/target/microservices-backend-*.jar app.jar<font></font>
EXPOSE 8080<font></font>
ENTRYPOINT ["java","-jar","/app.jar"]</code></pre></div></div><br>
<p>Dockerfile-packaged:</p><br>
<pre><code class="plaintext hljs">FROM alpine:3.10.3 as packager<font></font>
RUN apk --no-cache add openjdk11-jdk openjdk11-jmods<font></font>
ENV JAVA_MINIMAL="/opt/java-minimal"<font></font>
# build minimal JRE<font></font>
RUN /usr/lib/jvm/java-11-openjdk/bin/jlink \<font></font>
    --verbose \<font></font>
    --add-modules \<font></font>
        java.base,java.sql,java.naming,java.desktop,java.management,java.security.jgss,java.instrument \<font></font>
    --compress 2 --strip-debug --no-header-files --no-man-pages \<font></font>
    --release-info="add:IMPLEMENTOR=radistao:IMPLEMENTOR_VERSION=radistao_JRE" \<font></font>
    --output "$JAVA_MINIMAL"<font></font>
<font></font>
FROM alpine:3.10.3<font></font>
LABEL maintainer="Anton Shelenkov anshelen@yandex.ru"<font></font>
ENV JAVA_HOME=/opt/java-minimal<font></font>
ENV PATH="$PATH:$JAVA_HOME/bin"<font></font>
COPY --from=packager "$JAVA_HOME" "$JAVA_HOME"<font></font>
COPY /target/microservices-backend-*.jar app.jar<font></font>
EXPOSE 8080<font></font>
ENTRYPOINT ["java","-jar","/app.jar"]</code></pre><br>
<p>-    .</p><br>
<p> Push Images:</p><br>
<pre><code class="plaintext hljs">stage('Push images') {<font></font>
  agent any<font></font>
  when {<font></font>
    branch 'master'<font></font>
  }<font></font>
  steps {<font></font>
    script {<font></font>
      def dockerImage = docker.build("${env.IMAGE_NAME}", "-f ${env.DOCKERFILE_NAME} .")<font></font>
      docker.withRegistry('', 'dockerhub-creds') {<font></font>
        dockerImage.push()<font></font>
        dockerImage.push("latest")<font></font>
      }<font></font>
      echo "Pushed Docker Image: ${env.IMAGE_NAME}"<font></font>
    }<font></font>
    sh "docker rmi ${env.IMAGE_NAME} ${env.IMAGE_NAME_LATEST}"<font></font>
  }<font></font>
}</code></pre><br>
<p> Jenkins       ,       .  Jenkins        ,           <code>script</code>.</p><br>
<p> <code>docker.build</code>   .   (  )        <code>${env.IMAGE_NAME}</code>.     <code>docker.build</code>      ,     -.</p><br>
<p> <code>docker.withRegistry('', 'dockerhub-creds')</code>     ,     'dockerhub-creds'.       ,       'latest'.      <code>echo</code>.</p><br>
<p>       .</p><br>
<h4 id="obnovlenie-klastera-kubernetes">  Kubernetes</h4><br>
<p>    Kubernetes,      ,         .</p><br>
<pre><code class="plaintext hljs">stage('Trigger kubernetes') {<font></font>
  agent any<font></font>
  when {<font></font>
    branch 'master'<font></font>
  }<font></font>
  steps {<font></font>
    withKubeConfig([credentialsId: 'kubernetes-creds', serverUrl: "${CLUSTER_URL}", namespace: "${CLUSTER_NAMESPACE}"]) {<font></font>
      sh "helm upgrade ${HELM_PROJECT} ${HELM_CHART} --reuse-values --set backend.image.tag=${env.IMAGE_TAG}"<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p> <code>withKubeConfig</code>   Kubernetes CLI    kubectl  .        Helm-.          Jenkins, , , <code>${CLUSTER_URL}</code>.</p><br>
<h4 id="itogovyy-jenkinsfile"> Jenkinsfile</h4><br>
<div class="spoiler"><b class="spoiler_title">Jenkins-backend</b><div class="spoiler_text"><pre><code class="plaintext hljs">pipeline {<font></font>
  agent none<font></font>
  options {<font></font>
    skipStagesAfterUnstable()<font></font>
    skipDefaultCheckout()<font></font>
  }<font></font>
  environment {<font></font>
    IMAGE_BASE = 'anshelen/microservices-backend'<font></font>
    IMAGE_TAG = "v$BUILD_NUMBER"<font></font>
    IMAGE_NAME = "${env.IMAGE_BASE}:${env.IMAGE_TAG}"<font></font>
    IMAGE_NAME_LATEST = "${env.IMAGE_BASE}:latest"<font></font>
    DOCKERFILE_NAME = "Dockerfile-packaged"<font></font>
  }<font></font>
  stages {<font></font>
    stage("Prepare container") {<font></font>
      agent {<font></font>
        docker {<font></font>
          image 'openjdk:11.0.5-slim'<font></font>
          args '-v $HOME/.m2:/root/.m2'<font></font>
        }<font></font>
      }<font></font>
      stages {<font></font>
        stage('Build') {<font></font>
          steps {<font></font>
            checkout scm<font></font>
            sh './mvnw compile'<font></font>
          }<font></font>
        }<font></font>
        stage('Test') {<font></font>
          steps {<font></font>
            sh './mvnw test'<font></font>
            junit '**/target/surefire-reports/TEST-*.xml'<font></font>
          }<font></font>
        }<font></font>
        stage('Package') {<font></font>
          steps {<font></font>
            sh './mvnw package -DskipTests'<font></font>
          }<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
<font></font>
    stage('Push images') {<font></font>
      agent any<font></font>
      when {<font></font>
        branch 'master'<font></font>
      }<font></font>
      steps {<font></font>
        script {<font></font>
          def dockerImage = docker.build("${env.IMAGE_NAME}", "-f ${env.DOCKERFILE_NAME} .")<font></font>
          docker.withRegistry('', 'dockerhub-creds') {<font></font>
            dockerImage.push()<font></font>
            dockerImage.push("latest")<font></font>
          }<font></font>
          echo "Pushed Docker Image: ${env.IMAGE_NAME}"<font></font>
        }<font></font>
        sh "docker rmi ${env.IMAGE_NAME} ${env.IMAGE_NAME_LATEST}"<font></font>
      }<font></font>
    }<font></font>
<font></font>
    stage('Trigger kubernetes') {<font></font>
      agent any<font></font>
      when {<font></font>
        branch 'master'<font></font>
      }<font></font>
      steps {<font></font>
        withKubeConfig([credentialsId: 'kubernetes-creds', serverUrl: "${CLUSTER_URL}", namespace: "${CLUSTER_NAMESPACE}"]) {<font></font>
          sh "helm upgrade ${HELM_PROJECT} ${HELM_CHART} --reuse-values --set backend.image.tag=${env.IMAGE_TAG}"<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
</div></div><br>
<p>Jenkinsfile     .</p><br>
<h2 id="podklyuchenie-payplayna"> </h2><br>
<p> Jenkins    .      Multibranch pipeline.     ,         .</p><br>
<p>     ,     Jenkins.      New Item -&gt; Multibranch Pipeline.   :</p><br>
<ul>
<li><p>Branch sources.  GitHub,   'Credentials'    /     URL     .</p><br>
</li>
<li><p>Build Configuration.  Mode  'by Remote File Plugin',   â€” Repository URL,        Jenkinsfile,   Script Path     .</p><br>
<p><img src="https://habrastorage.org/webt/na/eh/ly/naehly023tpox4jn80jkj9sasdg.png"></p><br>
</li>
<li><p>Scan Repository Triggers.     ,   Jenkins  ,   -    .     ,  Jenkins   ,       .    â€”  -.          . ,    ,   Jenkins        (      ,  Jenkins    IP-).  -     .</p><br>
</li>
</ul><br>
<h2 id="zapusk"></h2><br>
<p>     ,   .       Blue Ocean (Open Blue Ocean).      ,       Maven-.           ,       (<code>helm get values msvc-project</code>).</p><br>
<p>  Jenkins          .</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenkinsã¯éå¸¸ã«æŸ”è»Ÿãªã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚Šã€è¤‡é›‘ã•ã®ç¶™ç¶šçš„ãªçµ±åˆã¨å±•é–‹ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã§ã¯ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã«è§¦ã‚Œã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å°†æ¥ã€ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯å¤§å¹…ã«æ”¹å–„ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€é€šçŸ¥ã€è¿½åŠ ã®ã‚¹ãƒ†ãƒƒãƒ—ã€Webãƒ•ãƒƒã‚¯ãªã©ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ã•ã‚‰ã«å¤šãã®ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja493566/index.html">ç¹”ã‚Šãƒ†ã‚¹ãƒˆ-ABãƒ†ã‚¹ãƒˆã‚ˆã‚Š100å€é«˜é€Ÿ</a></li>
<li><a href="../ja493568/index.html">ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°-è„šæœ¬å®¶ã ã‘ã§ãªã</a></li>
<li><a href="../ja493572/index.html">...ãã—ã¦èª°ã«ã¨ã£ã¦ã‚‚ä¸€ã¤ã®ã‚³ã‚¢ã€‚ã™ã¹ã¦ã®ç”Ÿå­˜è€…ã«æ§ã’ã‚‹</a></li>
<li><a href="../ja493574/index.html">ãƒ–ãƒ©ã‚¦ã‚¶ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚­ã‚·</a></li>
<li><a href="../ja493578/index.html">å…ˆé€±ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸–ç•Œã‹ã‚‰ã®æ–°é®®ãªé£Ÿæã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆNo. 407ï¼ˆ2020å¹´3æœˆ16æ—¥ã€œ22æ—¥ï¼‰</a></li>
<li><a href="../ja493582/index.html">äººå·¥å¤ï¼šã‚³ãƒ­ãƒŠã‚¦ã‚¤ãƒ«ã‚¹ã«å¯¾ã™ã‚‹é ç´«å¤–ç·š</a></li>
<li><a href="../ja493584/index.html">OpenStreetMap No. 503ã®ä¸–ç•Œã‹ã‚‰ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆ2020å¹´3æœˆ3æ—¥ã€œ2020å¹´3æœˆ9æ—¥ï¼‰</a></li>
<li><a href="../ja493586/index.html">.NET 5å‘ã‘ã®JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æœ€é©åŒ–</a></li>
<li><a href="../ja493590/index.html">Cisco AnyConnectãŒå˜ãªã‚‹VPNã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ãªã„ç†ç”±</a></li>
<li><a href="../ja493594/index.html">PHPãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆNo. 176ï¼ˆ2020å¹´3æœˆ11ã€œ23æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>