<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÉÔ∏è üßö üßìüèΩ Automation testing software QIWI-terminals üë®üèø‚Äçüîß üë©üèΩ‚Äçü§ù‚Äçüë®üèº ü§°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 Today we‚Äôll talk about a specific topic: software testing automation for QIWI self-service terminals. 
 
 There are areas in the topi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Automation testing software QIWI-terminals</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/487326/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we‚Äôll talk about a specific topic: software testing automation for QIWI self-service terminals. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are areas in the topic of testing automation that are scanned up and down several times, for example, testing web services. For such areas, there are separate tools, patterns, and best practices. You do not need to invent anything, the risks are minimal, you take and do. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are reverse situations. The subject area is specific, no one has a peep at the ready-made solutions, there are no tools, the technological stack of the product is peculiar. You have to dive deep into the subject area, from sticks and uh ... other improvised materials to craft tools for yourself and simultaneously collect many, many rakes of different sizes and lethal force.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted to talk about something like this today. </font><font style="vertical-align: inherit;">The article is suitable for those involved in the development and testing of software for bank terminals or self-service machines. </font><font style="vertical-align: inherit;">And also to those who want to expand their technical horizons with examples of "but it also happens like this." </font><i><font style="vertical-align: inherit;">QIWI-terminal in 2020. In the background, you can see its filling.</font></i></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/gd/rg/6q/gdrg6qjnbzj6mt3us-mzmizjdzm.jpeg" width="700"></a><br>
<i><font style="vertical-align: inherit;"></font></i><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first QIWI terminal appeared in 2004 and then was able to replenish the account of a mobile phone. </font><font style="vertical-align: inherit;">Since then, a lot of water has flowed, and ASO (self-service machines) have changed a lot. </font><font style="vertical-align: inherit;">Now with the help of them you can replenish bank cards, make transfers, pay for services of various suppliers (providers) - housing and communal services, traffic police fines, credit organizations, our own QIWI products (QIWI wallet, interest-free installment card Conscience). </font><font style="vertical-align: inherit;">QIWI terminals can also operate in the mode of postamata (automated points of delivery for online stores).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a terminal like?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ASO terminal, from the point of view of iron, is an ordinary desktop with specific peripherals, such as bill acceptors and coin acceptors, receipt printers, dispensers, POS terminals (receiving plastic cards), etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the first problem. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/az/aa/egazaaihld5ys8j0b-3_qdb7wj0.png" width="900"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This famous photograph was taken in Sonoma County, California. They say that these are natural colors, without any processing. By the way, it was on the territory of Sonoma County that the southernmost Russian colony in America was located.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Yes, that's her. The operating system, which was discontinued in 2014, is Windows XP. The POSReady version was pulled right up to 2019, but ... It's not so simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that the terminals are not the property of QIWI. They belong to partners, the so-called Agents, individual entrepreneurs and legal entities that conclude an agreement with QIWI purchase terminals, rent space in shopping centers and receive almost passive income.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, 90% of the fleet of QIWI terminals (and there are more than 100k in Russia and foreign countries) are running Windows XP on a variety of hardware - from 512 MB to 4 GB of RAM, a variety of CPUs (from Pentium 4 deep zero years to more- less modern Core i5) and different quality and speed of the Internet. </font><font style="vertical-align: inherit;">Terminals of different ages, some of them are regularly upgraded, and some of them have not been upgraded for a very long time (it works - don‚Äôt touch it!). </font><font style="vertical-align: inherit;">Our task is to regularly supply the latest terminal software updates (it is called MarATL) and maintain compatibility with all this variety of toppings and peripherals.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expired Support Operating System</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine a simple test automation circuit. We have a CI server, for example, TeamCity or Jenkins. Our terminal software is collected from raws by event (commit or heap), the collected binary file is laid out somewhere. The software automatically installs, the night functional autotests are launched ... Uh, stop! Where is the software installation going? And How? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I said above, 90 percent of the terminals are running Windows XP, which ended in 2014. This means that this OS no longer complies with security policies for a long time, no updates are released for it, there is no fresh working software for it, and even the native Microsoft Visual Studio compiles C ++ for it only after dancing with a tambourine, or rather with the version of the toolchain for the MSBuild collector.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, running tests and some kind of software on a terminal or virtual machine with Windows XP is a very bad idea. </font><font style="vertical-align: inherit;">You cannot raise Buildagent TeamCity on XP, you cannot configure such a machine in Ansible playbook, there are no containers there either. </font><font style="vertical-align: inherit;">Virtualization templates for Windows XP are also not that much. </font><font style="vertical-align: inherit;">In any large company that thinks about information security, a Windows XP machine will be kept away from the corporate network, or even less the domain. </font><font style="vertical-align: inherit;">That is, all interaction with the terminal (or virtual machine pretending to be it) must occur remotely, the terminal itself must have a minimum of third-party software.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some people are surprised when they hear about a bunch of OpenSSH and Windows XP. In a modern version of Microsoft, OSH support is included directly in the system. In the not-so-modern (Windows 7), there are SSH installers using PowerShell. C Windows XP, the situation is a little worse, but only a little. There is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an ancient version of the installer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that runs on it without additional software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSH is an old, good, reliable way to remotely control a host, a well-known technology. You need to implement classes of SSH connectors that can do several things in parallel. For example, in the online mode, load fresh logs from the terminal, execute some commands (copying files, running scripts, issuing rights, obtaining a list of processes, monitoring the terminal‚Äôs system time, etc.).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitoring system time is especially interesting. </font><font style="vertical-align: inherit;">By standard command-line tools, Windows XP displays time only in a formatted form hours-minutes-seconds, etc., no UNIX-time for you. </font><font style="vertical-align: inherit;">The ambush, for example, is that XP has not received timezone updates for a long time, and our Russian government is known for constant games with the cancellation of summer or winter time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, the standard Windows XP SP3 in the Moscow time zone shows the time one hour earlier than the real Moscow time. </font><font style="vertical-align: inherit;">Accordingly, the timestamps of the terminal logs in any case do not coincide with the time on the test circuit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Payments-Payments-Payments ...</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The QIWI terminal interface is essentially a web that runs on a browser engine, which is usually quite old. According to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">websocket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> protocol </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">,</font></a><font style="vertical-align: inherit;"> it interacts with MarATL, actually a terminal software. When choosing a payment on the terminal (for example, paying for cellular communications) using a series of commands, a payment provider is selected, the amount of commissions, restrictions on accepting bills are determined, a payment is created for a specific provider, which is then sent through payment terminal processing to payments.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interacting with the web interface remotely is an so-so idea, especially interface tests - another task. You can create a test web page that will be based on the test time instead of the standard index.html. The page runs a JS script that works with terminal software, and on the other hand creates a web socket client that looks outward towards the host on which the tests are running. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the side of autotests, you need to implement a web socket server that waits at the start of client connection from the terminal and sends commands that are unchanged through the test page to the terminal software. Software responses are also sent to the test web socket server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, you can describe the set of commands for the payment test in the form of JSON, which successively describes which commands you need to send and what kind of response to wait for them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ny/vd/cs/nyvdcso14yaogv1timvpqol6fo8.png" width="900"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface test page. </font><font style="vertical-align: inherit;">Displays the commands passing through it.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And where is the money?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most insidious technical task is to simulate the peripheral devices of the terminal. The receipt printer is simulated trivially, a virtual printer is created in the OS that prints the data to a file. You can get this check from the terminal (or its copy, formed by the terminal software itself) and decode it, simultaneously checking, for example, that all necessary fields are present in this check. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More complicated with devices that accept money - bill acceptors and coin acceptors. It is clear that if we want to test the payment scenario, we need to somehow emulate the presence of the bill acceptor on the terminal, support the functionality of accepting bills, returning, simulating various problems (for example, returning a crumpled bill).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most money receiving devices operate using the CashCode NET protocol. This protocol defines the scenarios of interaction between the bill acceptor and the controller (in our case, the controller is our terminal software). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yc/aw/9l/ycaw9la3u_se2p5ykxmdu_coej0.png" width="900"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of the interaction of the controller and the validator of banknotes using the CashCode protocol. With a certain frequency, the controller requests the status of the device. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/tl/ti/uu/tltiuu__xuocvrsdw3tovvygpok.png" width="900"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The minimum size of the CashCode command is 6 bytes. For a description of the commands, see the CashCode NET protocol specification.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The standard bill acceptor is connected to the terminal via the COM port. There are third-party utilities that allow you to create a virtual serial port on the machine, for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSPE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Even scripts for forwarding this port through a TCP connection are supported.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our case is simpler, we need a tool that can cling to the port using WinAPI and has an arbitrary convenient interface, for example, the simplest stdin / stdout, which can be hooked up using SSH. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tula in a separate stream communicates with the controller via a serial port and, if necessary, imitates situations of receiving supposedly ‚Äúmoney‚Äù. </font><font style="vertical-align: inherit;">It is also necessary to have some kind of pool of test accounts or providers, the payments for which will not be processed for real, but will at some point be repulsed. </font><font style="vertical-align: inherit;">Or, for more complex cases, the money does go through real processing, but gets to special accounts, from which then again they will be debited for payment tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such is the cycle of money in nature. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/it/ke/em/itkeemvvzwk4glzhd6g_2p1dyqw.jpeg" width="500"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receipt printer (above) and bill acceptor (below).</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24/7</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Software for terminals and ATMs should be extremely resistant to various emergency situations - lack of Internet, problems with a bill acceptor, etc. </font><font style="vertical-align: inherit;">Since such software runs on a terminal with a very high priority and rights, it essentially intercepts all OS control. </font><font style="vertical-align: inherit;">You can‚Äôt just collapse it or close it with Alt-F4. </font><font style="vertical-align: inherit;">Software can reboot itself and the terminal, incl. </font><font style="vertical-align: inherit;">In a loop. </font><font style="vertical-align: inherit;">It is also necessary to check such stressful scenarios, for example, the lack of communication with payment processing. </font><font style="vertical-align: inherit;">The terminal responds to this with periodic reboots, you need to check that it does it correctly and correctly every time it loads the terminal software.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation from scratch and update</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installed terminal software is centrally updated using payment processing. Processing plans to update a specific terminal and determines the update profile for it, that is, what files and where to load from. To update, it is necessary to perform a number of procedures in the processing database, and then monitor the terminal. Check by logs that the download of necessary files has begun and that the update has been successfully completed and the terminal software has risen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A clean installation from scratch is harder. Usually, a person does it in the fields by simply copying the installation file to the terminal and entering settings and authorization data into the installer forms, which is usually a WinAPI application with standard Windows controllers (TextBox, CheckBox, etc.).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our automatic tests for a clean installation script, a Python script is attached to the terminal, which the installer starts, interacts with the controllers using the pywinauto library and writes its own installation log. </font><font style="vertical-align: inherit;">After the first stage of the installation is completed, the script ends, and the terminal software passes authorization in processing, receives paths to the installation profile, and downloads all the necessary files. </font><font style="vertical-align: inherit;">Here, in real time, you need to monitor the logs on the terminal through SSH. </font><font style="vertical-align: inherit;">All abnormal situations during installation (for example, incorrect authorization data) are written to it, you need to read these logs online and, if necessary, consider the clean installation test failed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1i/tj/gg/1itjggzumvgacogdyp0rj71ljfo.jpeg" width="500"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean installation from scratch MarATL</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We went over overviews on the main technical aspects of creating autotests for terminal software. </font><font style="vertical-align: inherit;">Without diving deep into technology, we sorted out a big task into separate aspects. </font><font style="vertical-align: inherit;">Ask questions in the comments, if the topic is interesting, you can highlight some points in a separate article in more detail. </font><font style="vertical-align: inherit;">Thank you for the attention!</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487326/">https://habr.com/ru/post/en487326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487310/index.html">How to calculate the financial model of a loyalty program</a></li>
<li><a href="../en487314/index.html">The burden of white-collar workers (about discrimination in IT)</a></li>
<li><a href="../en487318/index.html">Introduction to mutual authentication of services in Java with TLS / SSL</a></li>
<li><a href="../en487322/index.html">Visualization of science: illustrations and infographics</a></li>
<li><a href="../en487324/index.html">Two-week news aggregator</a></li>
<li><a href="../en487332/index.html">Test cheap Ergolux LED bulbs</a></li>
<li><a href="../en487334/index.html">How ‚Äúremote" improves collaboration</a></li>
<li><a href="../en487336/index.html">Unity - Enable Multidex or Too Many Methods</a></li>
<li><a href="../en487340/index.html">As we did the next designer of chat bots. Part 1</a></li>
<li><a href="../en487342/index.html">Lesson # 2 - Meetings and Events</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>