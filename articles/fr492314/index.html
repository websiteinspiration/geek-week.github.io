<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💟 🎇 🔘 Maison intelligente: création de tableaux d'eau et d'électricité dans Home Assistant 👴🏿 🔐 🆓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque fois que je reçois une facture d'électricité et d'eau, je me demande - ma famille consomme-t-elle vraiment autant? Eh bien, oui, la salle de ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Maison intelligente: création de tableaux d'eau et d'électricité dans Home Assistant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wj/lf/i3/wjlfi38qar57vvhqgpwuzdalerw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque fois que je reçois une facture d'électricité et d'eau, je me demande - ma famille consomme-t-elle vraiment autant? Eh bien, oui, la salle de bain a un plancher chauffant et une chaudière, mais ils ne s’alimentent pas constamment. Nous semblons également économiser de l'eau (même si nous aimons aussi les éclaboussures dans la salle de bain). Il y a quelques années, j'avais déjà </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connecté </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">compteurs d'eau</font></a><font style="vertical-align: inherit;"> et d' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">électricité</font></a><font style="vertical-align: inherit;"> à une maison intelligente, mais c'était collé là-dessus. Les mains ne sont arrivées à l'analyse de la consommation que maintenant, à propos de laquelle, en fait, cet article concerne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis récemment passé à Home Assistant en tant que système de maison intelligente. L'une des raisons était simplement la possibilité d'organiser la collecte d'une grande quantité de données avec la possibilité de construire facilement différents types de graphiques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les informations décrites dans cet article ne sont pas nouvelles, toutes ces choses avec des sauces différentes ont déjà été décrites sur Internet. </font><font style="vertical-align: inherit;">Mais chaque article, en règle générale, ne décrit qu'une approche ou un aspect. </font><font style="vertical-align: inherit;">J'ai dû comparer toutes ces approches et choisir moi-même la plus appropriée. </font><font style="vertical-align: inherit;">L'article ne fournit toujours pas d'informations complètes sur la collecte de données, mais c'est une sorte de résumé de la façon dont je l'ai fait. </font><font style="vertical-align: inherit;">Les critiques constructives et les suggestions d'amélioration sont donc les bienvenues.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation du problème</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, l'objectif de l'exercice d'aujourd'hui est d'obtenir de beaux graphiques de consommation d'eau et d'électricité:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes les heures pendant 2 jours</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les jours pendant 2 semaines</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(facultatif) hebdomadaire et mensuel</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est là que quelques difficultés nous attendent:</font></font><br>
<br>
<ul>
<li>  ,  ,  .         . <br>
<br>
  ,     ,     .  home assistant,  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">mini-graph-card</a>,     :<br>
<br>
<ul>
<li>        (     ,         )</li>
<li>       (   ,      )</li>
</ul></li>
<li> ,  home assistant        SQLite <s>( , ,    MySQL  Postgres)</s>,        . , ,               json   <br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"old_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"aafc8ca305ba4e49ad4c97f0eddd8893"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}, <span class="hljs-attr">"new_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"0de64b8af6f14bb9a419dcf3b200ef56"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}}</code></pre><br>
     (    ,    ),         .      SDM220      10-15 ,         8.      ,      . ..         100-200  .      ,      (    home assistant  raspberry PI),            .</li>
<li>  ,      .           <s> </s>   .           (RS232/RS485/Modbus/Zigbee)   .<br>
<br>
         (    ),      X -  .            .         ,        . , ,        home assistant,          ,             (  home assistant).</li>
</ul><br>
<h2> 1</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, voyons ce que l'assistant à domicile est fourni hors de la boîte. Mesurer la consommation sur une période est une fonctionnalité très demandée. Bien sûr, il a été réalisé il y a longtemps sous la forme d'un composant spécialisé - utility_meter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'essence du composant est qu'il démarre la variable current_accumulated_value à l'intérieur et la réinitialise après une période spécifiée (heure / semaine / mois). Le composant lui-même surveille la variable entrante (la valeur d'une sorte de capteur), souscrit aux modifications de la valeur elle-même - vous obtenez simplement le résultat final. Cette chose est décrite en quelques lignes dans le fichier de configuration.</font></font><br>
<br>
<pre><code class="python hljs">utility_meter:<font></font>
  water_cold_hour_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: hourly<font></font>
  water_cold_day_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: daily<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici sensor.water_meter_cold est la valeur actuelle du compteur en litres, que j'obtiens </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directement de la pièce de fer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par mqtt. La conception crée 2 nouveaux capteurs water_cold_hour_um et water_cold_day_um, qui accumulent des lectures horaires et quotidiennes, les réinitialisant après une période. Voici un tableau de batterie d'une demi-heure. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/u3/fk/leu3fkbgddojjis_lmcawt6gcv4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code du graphique horaire et quotidien pour lovelace-UI ressemble à ceci:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le problème de cette approche réside dans cet algorithme. Comme je l'ai mentionné, pour chaque valeur d'entrée (la lecture actuelle du compteur pour chaque litre suivant), 1 Ko d'enregistrement est généré dans la base de données. Chaque compteur d'utilité génère également une nouvelle valeur, qui s'ajoute également à la base de données. Si je veux collecter des relevés horaires / quotidiens / hebdomadaires / mensuels, et pour plusieurs élévateurs à eau, et même ajouter un tas de compteurs électriques - ce sera beaucoup de données. Eh bien, plus précisément, il n'y a pas beaucoup de données, mais comme l'assistant à domicile écrit dans la base de données un tas d'informations inutiles, la taille de la base de données augmentera à pas de géant. J'ai même peur d'estimer la taille de la base des graphiques hebdomadaires et mensuels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, le compteur d'utilité seul ne résout pas la tâche. </font><font style="vertical-align: inherit;">Le graphique des valeurs que le compteur d'utilité donne est une fonction augmentant de façon monotone qui se remet à 0 toutes les heures. </font><font style="vertical-align: inherit;">Nous avons besoin d'un tableau de consommation convivial, combien de litres ont été consommés au cours de la période. </font><font style="vertical-align: inherit;">Le composant standard de graphique d'historique ne sait pas comment procéder, mais le composant de mini-carte graphique externe peut nous aider. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici le code de la carte pour lovelace-UI:</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_hour_um<font></font>
        group_by: hour<font></font>
        hours_to_show: <span class="hljs-number">48</span>
        name: <span class="hljs-string">"Hourly water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">1</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des paramètres standard comme le nom du capteur, le type de graphique, la couleur (je n'ai pas aimé l'orange standard), il est important de noter 3 paramètres:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_by: hour - le graphique sera généré avec les colonnes alignées au début de l'heure</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points_per_hour: 1 - une barre pour chaque heure</font></font></li>
<li>  , aggregate_func: max —       .         </li>
</ul><br>
<img src="https://habrastorage.org/webt/yj/du/c7/yjduc7nhxnq18qvcityd_ul91y0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ne faites pas attention à un certain nombre de colonnes sur la gauche - c'est le comportement standard d'un composant s'il n'y a pas de données. Et il n'y avait pas de données - j'ai seulement activé la collecte de données des compteurs d'utilité il y a quelques heures seulement pour le plaisir de cet article (je vous dirai mon approche actuelle un peu plus tard). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette image, je voulais montrer que parfois l'affichage des données fonctionne même et que les barres reflètent vraiment les valeurs correctes. Mais ce n'est pas tout. La colonne sélectionnée pour l'intervalle de 11 à 12 heures du matin pour une raison quelconque affiche 19 litres, bien que sur le tableau à pleines dents un peu plus élevé pour la même période, nous voyons une consommation de 62 litres à partir du même capteur. Soit un insecte, soit des mains tordues. Mais je ne comprends pas pourquoi les données de droite se sont interrompues - la consommation y était normale, ce qui est également visible sur le calendrier à pleines dents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, je n'ai pas réussi à obtenir la crédibilité de cette approche - le graphique montre presque toujours une sorte d'hérésie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le même code pour le capteur de jour.</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_day_um<font></font>
        group_by: interval<font></font>
        hours_to_show: <span class="hljs-number">360</span>
        name: <span class="hljs-string">"Daily water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">0.0416666666</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que le paramètre group_by est défini sur intervalle et que le paramètre points_per_hour règle tout. </font><font style="vertical-align: inherit;">Et c'est un autre problème de ce composant - points_per_hour fonctionne bien sur les graphiques en une heure ou moins, mais dégoûtant à de grands intervalles. </font><font style="vertical-align: inherit;">Donc, pour obtenir une colonne en une journée, je devais entrer la valeur 1/24 = 0,04166666. </font><font style="vertical-align: inherit;">Je ne parle pas de graphiques hebdomadaires et mensuels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approche 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je viens de découvrir l'assistant à domicile, je suis tombé sur cette vidéo ici:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-0HrYFCRH0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ami recueille les données de consommation de plusieurs types de points de vente Xiaomi. Sa tâche est un peu plus facile - il suffit d'afficher la valeur de la consommation pour aujourd'hui, hier et pour le mois. Aucun horaire n'est requis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laissons de côté la discussion sur l'intégration manuelle des valeurs de puissance instantanées - j'ai déjà écrit sur la «précision» de cette approche. On ne sait pas pourquoi il n'a pas utilisé les valeurs de consommation accumulées, qui sont déjà collectées par le même point de vente. À mon avis, l'intégration à l'intérieur du morceau de fer fonctionnera mieux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la vidéo nous prenons l'idée de calculer manuellement la consommation de la période. Le paysan ne compte que les valeurs d'aujourd'hui et d'hier, mais nous allons aller plus loin et essayer de dessiner un graphique. L'essence de la méthode proposée dans mon cas est la suivante.</font></font><br>
<br>
<ul>
<li>  ___,      </li>
<li>     (   )          .         —    ,         . </li>
<li>  “”  ___     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela peut être fait </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par le</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biais de l'assistant à domicile lui-même. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devrez écrire un peu plus de code que dans l'approche précédente. </font><font style="vertical-align: inherit;">Pour commencer, obtenons ces mêmes «variables». </font><font style="vertical-align: inherit;">Hors de la boîte, nous n'avons pas l'entité "variable", mais vous pouvez utiliser les services du courtier mqtt. </font><font style="vertical-align: inherit;">Nous y enverrons des valeurs avec le drapeau retenue = vrai - cela enregistrera la valeur à l'intérieur du courtier, et vous pouvez la retirer à tout moment, même lorsque l'assistant à domicile redémarre. </font><font style="vertical-align: inherit;">J'ai fait tout de suite des compteurs d'heures et de jours.</font></font><br>
<br>
<pre><code class="python hljs">- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour"</span><font></font>
  name: water_hour<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
  name: water_hour_begin<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day"</span><font></font>
  name: water_day<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
  name: water_day_begin<font></font>
  unit_of_measurement: l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute la magie opère dans l'automatisation, qui s'exécute chaque heure et chaque nuit, respectivement.</font></font><br>
<br>
<pre><code class="python hljs">- id: water_new_hour<font></font>
  alias: water_new_hour<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time_pattern<font></font>
      minutes: <span class="hljs-number">0</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_hour_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true<font></font>
<font></font>
- id: water_new_day<font></font>
  alias: water_new_day<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time<font></font>
      at: <span class="hljs-string">"00:00:00"</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_day_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux automatisations effectuent 2 actions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La valeur de l'intervalle est calculée comme la différence entre la valeur de début et la valeur de fin</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettre à jour la valeur de base pour l'intervalle suivant</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique dans ce cas est résolu par le graphique historique habituel:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemble à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/nn/ah/rpnnahsspezbcydtjmhlu6kb53w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, c'est déjà ce dont vous avez besoin. </font><font style="vertical-align: inherit;">L'avantage de cette méthode est que les données sont générées une fois par intervalle. </font><font style="vertical-align: inherit;">Ceux. </font><font style="vertical-align: inherit;">seulement 24 entrées par jour pour le graphique horaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, cela ne résout toujours pas le problème général d'une base croissante. </font><font style="vertical-align: inherit;">Si je veux un calendrier de consommation mensuel, je devrai stocker des données pendant au moins un an. </font><font style="vertical-align: inherit;">Et comme l'assistant à domicile ne fournit qu'un seul paramètre pour la durée de stockage pour l'ensemble de la base de données, cela signifie que TOUTES les données du système devront être stockées pendant une année entière. </font><font style="vertical-align: inherit;">Par exemple, pendant un an, je consomme 200 mètres cubes d'eau, ce qui signifie que ce sont 200 000 enregistrements dans la base de données. </font><font style="vertical-align: inherit;">Et si vous prenez en compte d'autres capteurs, le chiffre devient indécent du tout.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approche 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, les personnes intelligentes ont déjà résolu ce problème en écrivant la base de données InfluxDB. Cette base de données est spécialement optimisée pour stocker des données temporelles et est idéale pour stocker les valeurs de différents capteurs. Le système fournit également un langage de requête de type SQL qui vous permet de sélectionner des valeurs dans la base de données, puis de les agréger de différentes manières. Enfin, différentes données peuvent être stockées à différents moments. Par exemple, les relevés changeant fréquemment tels que la température ou l'humidité peuvent être stockés pendant seulement quelques semaines, tandis que les relevés quotidiens de la consommation d'eau peuvent être stockés pendant une année entière.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus d'InfluxDB, les gens intelligents ont également inventé Grafana, un système de cartographie basé sur les données d'InfluxDB. </font><font style="vertical-align: inherit;">Grafana peut dessiner différents types de graphiques, les personnaliser en détail et, plus important encore, ces graphiques peuvent être «collés» sur l'assistant à domicile lovelace-UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inspirez-vous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les articles décrivent en détail le processus d'installation et de connexion d'InfluxDB et de Grafana à l'assistant domestique. </font><font style="vertical-align: inherit;">Je vais me concentrer sur la résolution de mon problème spécifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, tout d'abord, commençons à additionner la valeur du compteur dans influxDB. </font><font style="vertical-align: inherit;">Un morceau de la configuration de l'assistant à domicile (dans cet exemple, je vais m'amuser non seulement avec du froid, mais aussi avec de l'eau chaude):</font></font><br>
<br>
<pre><code class="python hljs">influxdb:<font></font>
  host: localhost<font></font>
  max_retries: <span class="hljs-number">3</span><font></font>
  default_measurement: state<font></font>
  database: homeassistant<font></font>
  include:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Désactivez l'enregistrement des mêmes données dans la base de données interne de l'assistant à domicile afin de ne pas les gonfler à nouveau:</font></font><br>
<br>
<pre><code class="python hljs">recorder:<font></font>
  purge_keep_days: <span class="hljs-number">10</span>
  purge_interval: <span class="hljs-number">1</span><font></font>
  exclude:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant à la console InfluxDB et configurons notre base de données. En particulier, vous devez configurer la durée de stockage de telle ou telle donnée. Ceci est réglementé par le soi-disant politique de rétention - elle est similaire aux bases de données à l'intérieur de la base de données principale, chaque base de données interne ayant ses propres paramètres. Par défaut, toutes les données sont stockées dans une politique de rétention appelée autogen, ces données seront stockées pendant une semaine. Je souhaite que les données horaires soient stockées pendant un mois, l'hebdomadaire pendant un an et que le mensuel ne soit jamais supprimé. Créer une politique de rétention appropriée</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"month"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">30</span>d <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"year"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">52</span>w <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"infinite"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> INF <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, en fait, l'astuce principale est l'agrégation de données à l'aide d'une requête continue. </font><font style="vertical-align: inherit;">Il s'agit d'un mécanisme qui démarre automatiquement une requête à des intervalles spécifiés, agrège les données de cette requête et ajoute le résultat à une nouvelle valeur. </font><font style="vertical-align: inherit;">Regardons un exemple (j'écris dans une colonne pour plus de lisibilité, mais en fait j'ai dû saisir cette commande sur une seule ligne)</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> CONTINUOUS <span class="hljs-keyword">QUERY</span> cq_water_hourly <span class="hljs-keyword">ON</span> homeassistant 
<span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span> 
  <span class="hljs-keyword">INTO</span> homeassistant.month.water_meter_hour 
  <span class="hljs-keyword">FROM</span> homeassistant.autogen.l 
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id fill(previous) 
<span class="hljs-keyword">END</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette commande:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crée une requête continue nommée cq_water_cold_hourly dans la base de données homeassistant</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande sera exécutée toutes les heures (temps (1h))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande va récupérer toutes les données de la mesure'a homeassistant.autogen.l (litres), y compris les lectures d'eau froide et chaude</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les données agrégées seront regroupées par entity_id, ce qui créera des valeurs distinctes pour l'eau froide et l'eau chaude.</font></font></li>
<li>               ,      max(value) </li>
<li>     homeassistant.month.water_meter_hour,  month   retention policy     .               entity_id     value</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La nuit ou lorsque personne n'est à la maison, il n'y a pas de consommation d'eau et il n'y a donc pas non plus de nouvelles entrées dans homeassistant.autogen.l. Pour éviter les valeurs manquantes dans les requêtes régulières, vous pouvez utiliser fill (précédent). Cela forcera InfluxDB à utiliser la valeur de la dernière heure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, la requête continue a une particularité: l'astuce de remplissage (précédente) ne fonctionne pas et les enregistrements ne sont tout simplement pas créés. De plus, il s'agit d'un problème insurmontable qui fait l'objet de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discussions depuis plus d'un an</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous traiterons ce problème plus tard, et laissons remplir (précédent) dans la requête continue - cela n'interfère pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérifions ce qui s'est passé (bien sûr, vous devez attendre quelques heures):</font></font><br>
<br>
<pre><code class="python hljs">&gt; select * <span class="hljs-keyword">from</span> homeassistant.month.water_meter_hour group by entity_id<font></font>
...<font></font>
name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 value<font></font>
----                 -----<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370511</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370513</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370527</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370605</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370635</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370699</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370761</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370767</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370810</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370818</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370827</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370849</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370921</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que les valeurs de la base de données sont stockées en UTC, par conséquent, dans cette liste, elles diffèrent de 3 heures - les valeurs de 7 h dans la sortie InfluxDB correspondent aux valeurs de 10 h dans les graphiques ci-dessus. </font><font style="vertical-align: inherit;">Notez également qu'entre 2 et 5 heures du matin, il n'y a tout simplement aucun enregistrement - c'est la même caractéristique de la requête continue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, la valeur agrégée est également une séquence à augmentation monotone, seuls les enregistrements sont moins fréquents - une fois par heure. </font><font style="vertical-align: inherit;">Mais ce n'est pas un problème - nous pouvons écrire une autre requête qui produira les données correctes pour le graphique.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">difference</span>(<span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>)) 
<span class="hljs-keyword">FROM</span> homeassistant.month.water_meter_hour 
<span class="hljs-keyword">WHERE</span> entity_id=<span class="hljs-string">'water_meter_cold'</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-keyword">now</span>() <span class="hljs-number">-24</span>h 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id <font></font>
fill(previous)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je décrypterai:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la base de données homeassistant.month.water_meter_hour, nous extrayons les données pour entity_id = 'water_meter_cold' pour le dernier jour (heure&gt; = maintenant () -24h). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme je l'ai mentionné dans la séquence homeassistant.month.water_meter_hour, certaines entrées peuvent être manquantes. </font><font style="vertical-align: inherit;">Nous régénérerons ces données en exécutant une requête avec l'heure GROUP BY (1h). </font><font style="vertical-align: inherit;">Ce remplissage de temps (précédent) fonctionnera selon les besoins, générant les données manquantes (la fonction prendra la valeur précédente)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La chose la plus importante dans cette demande est la fonction de différence, qui calculera la différence entre les marques horaires. </font><font style="vertical-align: inherit;">En soi, il ne fonctionne pas et nécessite une fonction d'agrégation. </font><font style="vertical-align: inherit;">Soit le max () utilisé auparavant.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le résultat de l'exécution ressemble à ceci</font></font><br>
<br>
<pre><code class="python hljs">name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 difference<font></font>
----                 ----------<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">2</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T03:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T04:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">14</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">78</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">30</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">64</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">62</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">6</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">43</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">8</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">9</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">22</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">72</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De 2 à 5 heures du matin (UTC), il n'y avait pas de consommation. </font><font style="vertical-align: inherit;">Néanmoins, la requête renverra la même valeur de consommation en raison du remplissage (précédent), et la fonction de différence soustraira cette valeur d'elle-même et obtiendra 0 à la sortie, ce qui est réellement requis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'à construire un planning. </font><font style="vertical-align: inherit;">Pour ce faire, ouvrez Grafana, ouvrez un tableau de bord existant (ou créez un nouveau), créez un nouveau panneau. </font><font style="vertical-align: inherit;">Les paramètres du graphique seront comme ceci. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/q0/c8/uxq0c834j1eq4h7ey4qazk4cc7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais afficher les données sur l'eau froide et chaude sur un graphique. </font><font style="vertical-align: inherit;">La demande est exactement la même que celle décrite ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les paramètres d'affichage sont définis comme suit. </font><font style="vertical-align: inherit;">J'aurai un graphique avec des lignes, qui passe par des escaliers. </font><font style="vertical-align: inherit;">Je vais expliquer le paramètre Stack juste en dessous. </font><font style="vertical-align: inherit;">Il y a quelques autres options d'affichage ci-dessous, mais elles ne sont pas si intéressantes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/rd/5x/bird5xpaysckqtigczjerbp5mti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ajouter le programme reçu à l'assistant à domicile dont vous avez besoin:</font></font><br>
<br>
<ul>
<li>    . -         </li>
<li>     ,    share</li>
<li>      embed</li>
<li>  current time range —       URL </li>
<li>  .     light</li>
<li>  URL    lovelace-UI</li>
</ul><br>
<pre><code class="python hljs">      - type: iframe<font></font>
        id: graf_water_hourly<font></font>
        url: <span class="hljs-string">"http://192.168.10.200:3000/d-solo/rZARemQWk/water?orgId=1&amp;panelId=2&amp;from=now-2d&amp;to=now&amp;theme=light"</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que la plage de temps (2 derniers jours) est définie ici, et non dans les paramètres du tableau de bord. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique ressemble à ceci. Je n'ai pas utilisé d'eau chaude au cours des 2 derniers jours, donc seul un graphique de l'eau froide est dessiné. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/e7/hk/mse7hkckiwjjm_b5ppli9dakd2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas décidé par moi-même quel horaire je préfère, une ligne de pas ou de vrais bars. Par conséquent, je vais simplement donner un exemple de graphique de consommation quotidienne, mais cette fois en colonnes. Les demandes sont construites de la même manière que celle décrite ci-dessus. Les paramètres d'affichage sont les suivants: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/se/jt/nssejtoburugxcldedjuj0cvywm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce graphique ressemble à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zd/yl/hj/zdylhjfnrdonlnkezr3n4dlwdwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc à propos du paramètre Stack. Dans ce graphique, une colonne d'eau froide est dessinée au-dessus d'une colonne d'eau chaude. La hauteur totale correspond à la consommation totale d'eau froide et chaude pour la période.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les graphiques présentés sont dynamiques. Vous pouvez passer la souris sur un point d'intérêt et voir les détails et la valeur à un point spécifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, quelques cuillères à soupe de goudron n'ont pas pu faire. Sur le graphique à barres (contrairement au graphique avec des lignes de pas), le milieu de la barre n'est pas au milieu de la journée, mais à 00h00. Ceux. la moitié gauche de la colonne est dessinée à la place de la veille. Les cartes du samedi et du dimanche sont donc un peu plus à gauche que la zone bleuâtre. Jusqu'à ce que je comprenne comment le gagner.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre problème est l'incapacité de fonctionner correctement à intervalles mensuels. </font><font style="vertical-align: inherit;">Le fait est que la durée de l'heure / jour / semaine est fixe, mais la durée du mois est différente à chaque fois. </font><font style="vertical-align: inherit;">InfluxDB ne peut fonctionner qu'à intervalles réguliers. </font><font style="vertical-align: inherit;">Jusqu'à présent, mon cerveau était suffisant pour définir un intervalle fixe de 30 jours. </font><font style="vertical-align: inherit;">Oui, le graphique flottera un peu au cours de l'année et les colonnes ne correspondront pas exactement aux mois. </font><font style="vertical-align: inherit;">Mais comme cette chose m'intéresse simplement en tant que périphérique d'affichage, je suis d'accord avec ça. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vois au moins deux solutions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Score sur les horaires mensuels et limite hebdomadaire. </font><font style="vertical-align: inherit;">52 bars hebdomadaires pour l'année ont l'air plutôt bien</font></font></li>
<li>     №2,       .     .          —    .</li>
</ul><br>
<br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne sais pas pourquoi, mais je marche sur ce genre de graphiques. Ils montrent que la vie bat son plein et que tout change. Hier, c'était beaucoup, aujourd'hui ne suffit pas, demain sera autre chose. Reste à travailler avec les ménages sur le thème de la consommation. Mais même avec les appétits actuels, juste un chiffre important et incompréhensible dans le paiement se transforme déjà en une image assez claire de la consommation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré une carrière de programmeur de près de 20 ans, je n'ai pratiquement pas croisé les bases de données. Par conséquent, l'installation d'une base de données externe semblait quelque chose d'abstrus et d'incompréhensible. Tout a été changé par l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article susmentionné</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il s'est avéré que le vissage d'un outil approprié se fait en quelques clics, et avec un outil spécialisé, la tâche de graphique devient un peu plus facile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le titre, j'ai mentionné la consommation d'électricité. </font><font style="vertical-align: inherit;">Malheureusement, pour le moment, je ne peux pas donner un seul graphique. </font><font style="vertical-align: inherit;">Un compteur SDM120 est mort et l'autre est bogué lors de l'accès via Modbus. </font><font style="vertical-align: inherit;">Cependant, cela n'affecte pas le sujet de cet article - les graphiques seront construits de la même manière que pour l'eau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, j'ai cité les approches que j'ai moi-même essayées. </font><font style="vertical-align: inherit;">Il y a sûrement d'autres façons d'organiser la collecte et la visualisation de données que je ne connais pas. </font><font style="vertical-align: inherit;">Dites-le moi dans les commentaires, ça va être très intéressant pour moi. </font><font style="vertical-align: inherit;">Je serai heureux de recevoir des critiques constructives et de nouvelles idées. </font><font style="vertical-align: inherit;">J'espère que le matériel présenté aidera également quelqu'un.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492298/index.html">Polygones Another World: IBM PC</a></li>
<li><a href="../fr492302/index.html">Stand intelligent avec smartphones pour testeurs - un projet de démarrage de l'accélérateur de l'Université ITMO</a></li>
<li><a href="../fr492306/index.html">Lidars au CES</a></li>
<li><a href="../fr492308/index.html">Les neurones et leur modélisation</a></li>
<li><a href="../fr492312/index.html">Sérialisation Avro chez Kafka</a></li>
<li><a href="../fr492318/index.html">Comment le coronavirus affecte l'industrie informatique</a></li>
<li><a href="../fr492320/index.html">Covid-19, votre société et vous en termes de science des données</a></li>
<li><a href="../fr492322/index.html">Raspberry Pi + Fedora (aarch64) = Hotspot Wi-Fi (ou un routeur framboise dans un chapeau bleu)</a></li>
<li><a href="../fr492326/index.html">Analyse de la popularité des vidéos YouTube des participants à l'Eurovision 2020</a></li>
<li><a href="../fr492328/index.html">Intégration et déploiement continus d'applications de bureau avec GitHub Actions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>