<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíü üéá üîò Maison intelligente: cr√©ation de tableaux d'eau et d'√©lectricit√© dans Home Assistant üë¥üèø üîê üÜì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque fois que je re√ßois une facture d'√©lectricit√© et d'eau, je me demande - ma famille consomme-t-elle vraiment autant? Eh bien, oui, la salle de ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Maison intelligente: cr√©ation de tableaux d'eau et d'√©lectricit√© dans Home Assistant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wj/lf/i3/wjlfi38qar57vvhqgpwuzdalerw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque fois que je re√ßois une facture d'√©lectricit√© et d'eau, je me demande - ma famille consomme-t-elle vraiment autant? Eh bien, oui, la salle de bain a un plancher chauffant et une chaudi√®re, mais ils ne s‚Äôalimentent pas constamment. Nous semblons √©galement √©conomiser de l'eau (m√™me si nous aimons aussi les √©claboussures dans la salle de bain). Il y a quelques ann√©es, j'avais d√©j√† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connect√© </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">compteurs d'eau</font></a><font style="vertical-align: inherit;"> et d' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">√©lectricit√©</font></a><font style="vertical-align: inherit;"> √† une maison intelligente, mais c'√©tait coll√© l√†-dessus. Les mains ne sont arriv√©es √† l'analyse de la consommation que maintenant, √† propos de laquelle, en fait, cet article concerne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis r√©cemment pass√© √† Home Assistant en tant que syst√®me de maison intelligente. L'une des raisons √©tait simplement la possibilit√© d'organiser la collecte d'une grande quantit√© de donn√©es avec la possibilit√© de construire facilement diff√©rents types de graphiques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les informations d√©crites dans cet article ne sont pas nouvelles, toutes ces choses avec des sauces diff√©rentes ont d√©j√† √©t√© d√©crites sur Internet. </font><font style="vertical-align: inherit;">Mais chaque article, en r√®gle g√©n√©rale, ne d√©crit qu'une approche ou un aspect. </font><font style="vertical-align: inherit;">J'ai d√ª comparer toutes ces approches et choisir moi-m√™me la plus appropri√©e. </font><font style="vertical-align: inherit;">L'article ne fournit toujours pas d'informations compl√®tes sur la collecte de donn√©es, mais c'est une sorte de r√©sum√© de la fa√ßon dont je l'ai fait. </font><font style="vertical-align: inherit;">Les critiques constructives et les suggestions d'am√©lioration sont donc les bienvenues.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation du probl√®me</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, l'objectif de l'exercice d'aujourd'hui est d'obtenir de beaux graphiques de consommation d'eau et d'√©lectricit√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes les heures pendant 2 jours</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les jours pendant 2 semaines</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(facultatif) hebdomadaire et mensuel</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est l√† que quelques difficult√©s nous attendent:</font></font><br>
<br>
<ul>
<li>  ,  ,  .         . <br>
<br>
  ,     ,     .  home assistant,  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">mini-graph-card</a>,     :<br>
<br>
<ul>
<li>        (     ,         )</li>
<li>       (   ,      )</li>
</ul></li>
<li> ,  home assistant        SQLite <s>( , ,    MySQL  Postgres)</s>,        . , ,               json   <br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"old_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"aafc8ca305ba4e49ad4c97f0eddd8893"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}, <span class="hljs-attr">"new_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"0de64b8af6f14bb9a419dcf3b200ef56"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}}</code></pre><br>
     (    ,    ),         .      SDM220      10-15 ,         8.      ,      . ..         100-200  .      ,      (    home assistant  raspberry PI),            .</li>
<li>  ,      .           <s> </s>   .           (RS232/RS485/Modbus/Zigbee)   .<br>
<br>
         (    ),      X -  .            .         ,        . , ,        home assistant,          ,             (  home assistant).</li>
</ul><br>
<h2> 1</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, voyons ce que l'assistant √† domicile est fourni hors de la bo√Æte. Mesurer la consommation sur une p√©riode est une fonctionnalit√© tr√®s demand√©e. Bien s√ªr, il a √©t√© r√©alis√© il y a longtemps sous la forme d'un composant sp√©cialis√© - utility_meter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'essence du composant est qu'il d√©marre la variable current_accumulated_value √† l'int√©rieur et la r√©initialise apr√®s une p√©riode sp√©cifi√©e (heure / semaine / mois). Le composant lui-m√™me surveille la variable entrante (la valeur d'une sorte de capteur), souscrit aux modifications de la valeur elle-m√™me - vous obtenez simplement le r√©sultat final. Cette chose est d√©crite en quelques lignes dans le fichier de configuration.</font></font><br>
<br>
<pre><code class="python hljs">utility_meter:<font></font>
  water_cold_hour_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: hourly<font></font>
  water_cold_day_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: daily<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici sensor.water_meter_cold est la valeur actuelle du compteur en litres, que j'obtiens </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directement de la pi√®ce de fer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par mqtt. La conception cr√©e 2 nouveaux capteurs water_cold_hour_um et water_cold_day_um, qui accumulent des lectures horaires et quotidiennes, les r√©initialisant apr√®s une p√©riode. Voici un tableau de batterie d'une demi-heure. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/u3/fk/leu3fkbgddojjis_lmcawt6gcv4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code du graphique horaire et quotidien pour lovelace-UI ressemble √† ceci:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le probl√®me de cette approche r√©side dans cet algorithme. Comme je l'ai mentionn√©, pour chaque valeur d'entr√©e (la lecture actuelle du compteur pour chaque litre suivant), 1 Ko d'enregistrement est g√©n√©r√© dans la base de donn√©es. Chaque compteur d'utilit√© g√©n√®re √©galement une nouvelle valeur, qui s'ajoute √©galement √† la base de donn√©es. Si je veux collecter des relev√©s horaires / quotidiens / hebdomadaires / mensuels, et pour plusieurs √©l√©vateurs √† eau, et m√™me ajouter un tas de compteurs √©lectriques - ce sera beaucoup de donn√©es. Eh bien, plus pr√©cis√©ment, il n'y a pas beaucoup de donn√©es, mais comme l'assistant √† domicile √©crit dans la base de donn√©es un tas d'informations inutiles, la taille de la base de donn√©es augmentera √† pas de g√©ant. J'ai m√™me peur d'estimer la taille de la base des graphiques hebdomadaires et mensuels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, le compteur d'utilit√© seul ne r√©sout pas la t√¢che. </font><font style="vertical-align: inherit;">Le graphique des valeurs que le compteur d'utilit√© donne est une fonction augmentant de fa√ßon monotone qui se remet √† 0 toutes les heures. </font><font style="vertical-align: inherit;">Nous avons besoin d'un tableau de consommation convivial, combien de litres ont √©t√© consomm√©s au cours de la p√©riode. </font><font style="vertical-align: inherit;">Le composant standard de graphique d'historique ne sait pas comment proc√©der, mais le composant de mini-carte graphique externe peut nous aider. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici le code de la carte pour lovelace-UI:</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_hour_um<font></font>
        group_by: hour<font></font>
        hours_to_show: <span class="hljs-number">48</span>
        name: <span class="hljs-string">"Hourly water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">1</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des param√®tres standard comme le nom du capteur, le type de graphique, la couleur (je n'ai pas aim√© l'orange standard), il est important de noter 3 param√®tres:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_by: hour - le graphique sera g√©n√©r√© avec les colonnes align√©es au d√©but de l'heure</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points_per_hour: 1 - une barre pour chaque heure</font></font></li>
<li>  , aggregate_func: max ‚Äî       .         </li>
</ul><br>
<img src="https://habrastorage.org/webt/yj/du/c7/yjduc7nhxnq18qvcityd_ul91y0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ne faites pas attention √† un certain nombre de colonnes sur la gauche - c'est le comportement standard d'un composant s'il n'y a pas de donn√©es. Et il n'y avait pas de donn√©es - j'ai seulement activ√© la collecte de donn√©es des compteurs d'utilit√© il y a quelques heures seulement pour le plaisir de cet article (je vous dirai mon approche actuelle un peu plus tard). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette image, je voulais montrer que parfois l'affichage des donn√©es fonctionne m√™me et que les barres refl√®tent vraiment les valeurs correctes. Mais ce n'est pas tout. La colonne s√©lectionn√©e pour l'intervalle de 11 √† 12 heures du matin pour une raison quelconque affiche 19 litres, bien que sur le tableau √† pleines dents un peu plus √©lev√© pour la m√™me p√©riode, nous voyons une consommation de 62 litres √† partir du m√™me capteur. Soit un insecte, soit des mains tordues. Mais je ne comprends pas pourquoi les donn√©es de droite se sont interrompues - la consommation y √©tait normale, ce qui est √©galement visible sur le calendrier √† pleines dents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, je n'ai pas r√©ussi √† obtenir la cr√©dibilit√© de cette approche - le graphique montre presque toujours une sorte d'h√©r√©sie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le m√™me code pour le capteur de jour.</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_day_um<font></font>
        group_by: interval<font></font>
        hours_to_show: <span class="hljs-number">360</span>
        name: <span class="hljs-string">"Daily water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">0.0416666666</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que le param√®tre group_by est d√©fini sur intervalle et que le param√®tre points_per_hour r√®gle tout. </font><font style="vertical-align: inherit;">Et c'est un autre probl√®me de ce composant - points_per_hour fonctionne bien sur les graphiques en une heure ou moins, mais d√©go√ªtant √† de grands intervalles. </font><font style="vertical-align: inherit;">Donc, pour obtenir une colonne en une journ√©e, je devais entrer la valeur 1/24 = 0,04166666. </font><font style="vertical-align: inherit;">Je ne parle pas de graphiques hebdomadaires et mensuels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approche 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je viens de d√©couvrir l'assistant √† domicile, je suis tomb√© sur cette vid√©o ici:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-0HrYFCRH0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ami recueille les donn√©es de consommation de plusieurs types de points de vente Xiaomi. Sa t√¢che est un peu plus facile - il suffit d'afficher la valeur de la consommation pour aujourd'hui, hier et pour le mois. Aucun horaire n'est requis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laissons de c√¥t√© la discussion sur l'int√©gration manuelle des valeurs de puissance instantan√©es - j'ai d√©j√† √©crit sur la ¬´pr√©cision¬ª de cette approche. On ne sait pas pourquoi il n'a pas utilis√© les valeurs de consommation accumul√©es, qui sont d√©j√† collect√©es par le m√™me point de vente. √Ä mon avis, l'int√©gration √† l'int√©rieur du morceau de fer fonctionnera mieux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la vid√©o nous prenons l'id√©e de calculer manuellement la consommation de la p√©riode. Le paysan ne compte que les valeurs d'aujourd'hui et d'hier, mais nous allons aller plus loin et essayer de dessiner un graphique. L'essence de la m√©thode propos√©e dans mon cas est la suivante.</font></font><br>
<br>
<ul>
<li>  ___,      </li>
<li>     (   )          .         ‚Äî    ,         . </li>
<li>  ‚Äú‚Äù  ___     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela peut √™tre fait </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par le</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biais de l'assistant √† domicile lui-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devrez √©crire un peu plus de code que dans l'approche pr√©c√©dente. </font><font style="vertical-align: inherit;">Pour commencer, obtenons ces m√™mes ¬´variables¬ª. </font><font style="vertical-align: inherit;">Hors de la bo√Æte, nous n'avons pas l'entit√© "variable", mais vous pouvez utiliser les services du courtier mqtt. </font><font style="vertical-align: inherit;">Nous y enverrons des valeurs avec le drapeau retenue = vrai - cela enregistrera la valeur √† l'int√©rieur du courtier, et vous pouvez la retirer √† tout moment, m√™me lorsque l'assistant √† domicile red√©marre. </font><font style="vertical-align: inherit;">J'ai fait tout de suite des compteurs d'heures et de jours.</font></font><br>
<br>
<pre><code class="python hljs">- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour"</span><font></font>
  name: water_hour<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
  name: water_hour_begin<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day"</span><font></font>
  name: water_day<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
  name: water_day_begin<font></font>
  unit_of_measurement: l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute la magie op√®re dans l'automatisation, qui s'ex√©cute chaque heure et chaque nuit, respectivement.</font></font><br>
<br>
<pre><code class="python hljs">- id: water_new_hour<font></font>
  alias: water_new_hour<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time_pattern<font></font>
      minutes: <span class="hljs-number">0</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_hour_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true<font></font>
<font></font>
- id: water_new_day<font></font>
  alias: water_new_day<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time<font></font>
      at: <span class="hljs-string">"00:00:00"</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_day_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux automatisations effectuent 2 actions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La valeur de l'intervalle est calcul√©e comme la diff√©rence entre la valeur de d√©but et la valeur de fin</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettre √† jour la valeur de base pour l'intervalle suivant</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique dans ce cas est r√©solu par le graphique historique habituel:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/nn/ah/rpnnahsspezbcydtjmhlu6kb53w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, c'est d√©j√† ce dont vous avez besoin. </font><font style="vertical-align: inherit;">L'avantage de cette m√©thode est que les donn√©es sont g√©n√©r√©es une fois par intervalle. </font><font style="vertical-align: inherit;">Ceux. </font><font style="vertical-align: inherit;">seulement 24 entr√©es par jour pour le graphique horaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, cela ne r√©sout toujours pas le probl√®me g√©n√©ral d'une base croissante. </font><font style="vertical-align: inherit;">Si je veux un calendrier de consommation mensuel, je devrai stocker des donn√©es pendant au moins un an. </font><font style="vertical-align: inherit;">Et comme l'assistant √† domicile ne fournit qu'un seul param√®tre pour la dur√©e de stockage pour l'ensemble de la base de donn√©es, cela signifie que TOUTES les donn√©es du syst√®me devront √™tre stock√©es pendant une ann√©e enti√®re. </font><font style="vertical-align: inherit;">Par exemple, pendant un an, je consomme 200 m√®tres cubes d'eau, ce qui signifie que ce sont 200 000 enregistrements dans la base de donn√©es. </font><font style="vertical-align: inherit;">Et si vous prenez en compte d'autres capteurs, le chiffre devient ind√©cent du tout.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approche 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, les personnes intelligentes ont d√©j√† r√©solu ce probl√®me en √©crivant la base de donn√©es InfluxDB. Cette base de donn√©es est sp√©cialement optimis√©e pour stocker des donn√©es temporelles et est id√©ale pour stocker les valeurs de diff√©rents capteurs. Le syst√®me fournit √©galement un langage de requ√™te de type SQL qui vous permet de s√©lectionner des valeurs dans la base de donn√©es, puis de les agr√©ger de diff√©rentes mani√®res. Enfin, diff√©rentes donn√©es peuvent √™tre stock√©es √† diff√©rents moments. Par exemple, les relev√©s changeant fr√©quemment tels que la temp√©rature ou l'humidit√© peuvent √™tre stock√©s pendant seulement quelques semaines, tandis que les relev√©s quotidiens de la consommation d'eau peuvent √™tre stock√©s pendant une ann√©e enti√®re.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus d'InfluxDB, les gens intelligents ont √©galement invent√© Grafana, un syst√®me de cartographie bas√© sur les donn√©es d'InfluxDB. </font><font style="vertical-align: inherit;">Grafana peut dessiner diff√©rents types de graphiques, les personnaliser en d√©tail et, plus important encore, ces graphiques peuvent √™tre ¬´coll√©s¬ª sur l'assistant √† domicile lovelace-UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inspirez-vous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les articles d√©crivent en d√©tail le processus d'installation et de connexion d'InfluxDB et de Grafana √† l'assistant domestique. </font><font style="vertical-align: inherit;">Je vais me concentrer sur la r√©solution de mon probl√®me sp√©cifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, tout d'abord, commen√ßons √† additionner la valeur du compteur dans influxDB. </font><font style="vertical-align: inherit;">Un morceau de la configuration de l'assistant √† domicile (dans cet exemple, je vais m'amuser non seulement avec du froid, mais aussi avec de l'eau chaude):</font></font><br>
<br>
<pre><code class="python hljs">influxdb:<font></font>
  host: localhost<font></font>
  max_retries: <span class="hljs-number">3</span><font></font>
  default_measurement: state<font></font>
  database: homeassistant<font></font>
  include:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©sactivez l'enregistrement des m√™mes donn√©es dans la base de donn√©es interne de l'assistant √† domicile afin de ne pas les gonfler √† nouveau:</font></font><br>
<br>
<pre><code class="python hljs">recorder:<font></font>
  purge_keep_days: <span class="hljs-number">10</span>
  purge_interval: <span class="hljs-number">1</span><font></font>
  exclude:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant √† la console InfluxDB et configurons notre base de donn√©es. En particulier, vous devez configurer la dur√©e de stockage de telle ou telle donn√©e. Ceci est r√©glement√© par le soi-disant politique de r√©tention - elle est similaire aux bases de donn√©es √† l'int√©rieur de la base de donn√©es principale, chaque base de donn√©es interne ayant ses propres param√®tres. Par d√©faut, toutes les donn√©es sont stock√©es dans une politique de r√©tention appel√©e autogen, ces donn√©es seront stock√©es pendant une semaine. Je souhaite que les donn√©es horaires soient stock√©es pendant un mois, l'hebdomadaire pendant un an et que le mensuel ne soit jamais supprim√©. Cr√©er une politique de r√©tention appropri√©e</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"month"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">30</span>d <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"year"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">52</span>w <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"infinite"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> INF <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, en fait, l'astuce principale est l'agr√©gation de donn√©es √† l'aide d'une requ√™te continue. </font><font style="vertical-align: inherit;">Il s'agit d'un m√©canisme qui d√©marre automatiquement une requ√™te √† des intervalles sp√©cifi√©s, agr√®ge les donn√©es de cette requ√™te et ajoute le r√©sultat √† une nouvelle valeur. </font><font style="vertical-align: inherit;">Regardons un exemple (j'√©cris dans une colonne pour plus de lisibilit√©, mais en fait j'ai d√ª saisir cette commande sur une seule ligne)</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> CONTINUOUS <span class="hljs-keyword">QUERY</span> cq_water_hourly <span class="hljs-keyword">ON</span> homeassistant 
<span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span> 
  <span class="hljs-keyword">INTO</span> homeassistant.month.water_meter_hour 
  <span class="hljs-keyword">FROM</span> homeassistant.autogen.l 
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id fill(previous) 
<span class="hljs-keyword">END</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette commande:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©e une requ√™te continue nomm√©e cq_water_cold_hourly dans la base de donn√©es homeassistant</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande sera ex√©cut√©e toutes les heures (temps (1h))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande va r√©cup√©rer toutes les donn√©es de la mesure'a homeassistant.autogen.l (litres), y compris les lectures d'eau froide et chaude</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les donn√©es agr√©g√©es seront regroup√©es par entity_id, ce qui cr√©era des valeurs distinctes pour l'eau froide et l'eau chaude.</font></font></li>
<li>               ,      max(value) </li>
<li>     homeassistant.month.water_meter_hour,  month   retention policy     .               entity_id     value</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La nuit ou lorsque personne n'est √† la maison, il n'y a pas de consommation d'eau et il n'y a donc pas non plus de nouvelles entr√©es dans homeassistant.autogen.l. Pour √©viter les valeurs manquantes dans les requ√™tes r√©guli√®res, vous pouvez utiliser fill (pr√©c√©dent). Cela forcera InfluxDB √† utiliser la valeur de la derni√®re heure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, la requ√™te continue a une particularit√©: l'astuce de remplissage (pr√©c√©dente) ne fonctionne pas et les enregistrements ne sont tout simplement pas cr√©√©s. De plus, il s'agit d'un probl√®me insurmontable qui fait l'objet de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discussions depuis plus d'un an</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous traiterons ce probl√®me plus tard, et laissons remplir (pr√©c√©dent) dans la requ√™te continue - cela n'interf√®re pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifions ce qui s'est pass√© (bien s√ªr, vous devez attendre quelques heures):</font></font><br>
<br>
<pre><code class="python hljs">&gt; select * <span class="hljs-keyword">from</span> homeassistant.month.water_meter_hour group by entity_id<font></font>
...<font></font>
name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 value<font></font>
----                 -----<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370511</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370513</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370527</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370605</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370635</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370699</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370761</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370767</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370810</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370818</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370827</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370849</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370921</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que les valeurs de la base de donn√©es sont stock√©es en UTC, par cons√©quent, dans cette liste, elles diff√®rent de 3 heures - les valeurs de 7 h dans la sortie InfluxDB correspondent aux valeurs de 10 h dans les graphiques ci-dessus. </font><font style="vertical-align: inherit;">Notez √©galement qu'entre 2 et 5 heures du matin, il n'y a tout simplement aucun enregistrement - c'est la m√™me caract√©ristique de la requ√™te continue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, la valeur agr√©g√©e est √©galement une s√©quence √† augmentation monotone, seuls les enregistrements sont moins fr√©quents - une fois par heure. </font><font style="vertical-align: inherit;">Mais ce n'est pas un probl√®me - nous pouvons √©crire une autre requ√™te qui produira les donn√©es correctes pour le graphique.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">difference</span>(<span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>)) 
<span class="hljs-keyword">FROM</span> homeassistant.month.water_meter_hour 
<span class="hljs-keyword">WHERE</span> entity_id=<span class="hljs-string">'water_meter_cold'</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-keyword">now</span>() <span class="hljs-number">-24</span>h 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id <font></font>
fill(previous)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je d√©crypterai:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la base de donn√©es homeassistant.month.water_meter_hour, nous extrayons les donn√©es pour entity_id = 'water_meter_cold' pour le dernier jour (heure&gt; = maintenant () -24h). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme je l'ai mentionn√© dans la s√©quence homeassistant.month.water_meter_hour, certaines entr√©es peuvent √™tre manquantes. </font><font style="vertical-align: inherit;">Nous r√©g√©n√©rerons ces donn√©es en ex√©cutant une requ√™te avec l'heure GROUP BY (1h). </font><font style="vertical-align: inherit;">Ce remplissage de temps (pr√©c√©dent) fonctionnera selon les besoins, g√©n√©rant les donn√©es manquantes (la fonction prendra la valeur pr√©c√©dente)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La chose la plus importante dans cette demande est la fonction de diff√©rence, qui calculera la diff√©rence entre les marques horaires. </font><font style="vertical-align: inherit;">En soi, il ne fonctionne pas et n√©cessite une fonction d'agr√©gation. </font><font style="vertical-align: inherit;">Soit le max () utilis√© auparavant.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat de l'ex√©cution ressemble √† ceci</font></font><br>
<br>
<pre><code class="python hljs">name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 difference<font></font>
----                 ----------<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">2</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T03:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T04:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">14</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">78</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">30</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">64</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">62</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">6</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">43</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">8</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">9</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">22</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">72</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De 2 √† 5 heures du matin (UTC), il n'y avait pas de consommation. </font><font style="vertical-align: inherit;">N√©anmoins, la requ√™te renverra la m√™me valeur de consommation en raison du remplissage (pr√©c√©dent), et la fonction de diff√©rence soustraira cette valeur d'elle-m√™me et obtiendra 0 √† la sortie, ce qui est r√©ellement requis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'√† construire un planning. </font><font style="vertical-align: inherit;">Pour ce faire, ouvrez Grafana, ouvrez un tableau de bord existant (ou cr√©ez un nouveau), cr√©ez un nouveau panneau. </font><font style="vertical-align: inherit;">Les param√®tres du graphique seront comme ceci. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/q0/c8/uxq0c834j1eq4h7ey4qazk4cc7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais afficher les donn√©es sur l'eau froide et chaude sur un graphique. </font><font style="vertical-align: inherit;">La demande est exactement la m√™me que celle d√©crite ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les param√®tres d'affichage sont d√©finis comme suit. </font><font style="vertical-align: inherit;">J'aurai un graphique avec des lignes, qui passe par des escaliers. </font><font style="vertical-align: inherit;">Je vais expliquer le param√®tre Stack juste en dessous. </font><font style="vertical-align: inherit;">Il y a quelques autres options d'affichage ci-dessous, mais elles ne sont pas si int√©ressantes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/rd/5x/bird5xpaysckqtigczjerbp5mti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ajouter le programme re√ßu √† l'assistant √† domicile dont vous avez besoin:</font></font><br>
<br>
<ul>
<li>    . -         </li>
<li>     ,    share</li>
<li>      embed</li>
<li>  current time range ‚Äî       URL </li>
<li>  .     light</li>
<li>  URL    lovelace-UI</li>
</ul><br>
<pre><code class="python hljs">      - type: iframe<font></font>
        id: graf_water_hourly<font></font>
        url: <span class="hljs-string">"http://192.168.10.200:3000/d-solo/rZARemQWk/water?orgId=1&amp;panelId=2&amp;from=now-2d&amp;to=now&amp;theme=light"</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que la plage de temps (2 derniers jours) est d√©finie ici, et non dans les param√®tres du tableau de bord. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique ressemble √† ceci. Je n'ai pas utilis√© d'eau chaude au cours des 2 derniers jours, donc seul un graphique de l'eau froide est dessin√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/e7/hk/mse7hkckiwjjm_b5ppli9dakd2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas d√©cid√© par moi-m√™me quel horaire je pr√©f√®re, une ligne de pas ou de vrais bars. Par cons√©quent, je vais simplement donner un exemple de graphique de consommation quotidienne, mais cette fois en colonnes. Les demandes sont construites de la m√™me mani√®re que celle d√©crite ci-dessus. Les param√®tres d'affichage sont les suivants: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/se/jt/nssejtoburugxcldedjuj0cvywm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce graphique ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zd/yl/hj/zdylhjfnrdonlnkezr3n4dlwdwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc √† propos du param√®tre Stack. Dans ce graphique, une colonne d'eau froide est dessin√©e au-dessus d'une colonne d'eau chaude. La hauteur totale correspond √† la consommation totale d'eau froide et chaude pour la p√©riode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les graphiques pr√©sent√©s sont dynamiques. Vous pouvez passer la souris sur un point d'int√©r√™t et voir les d√©tails et la valeur √† un point sp√©cifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, quelques cuill√®res √† soupe de goudron n'ont pas pu faire. Sur le graphique √† barres (contrairement au graphique avec des lignes de pas), le milieu de la barre n'est pas au milieu de la journ√©e, mais √† 00h00. Ceux. la moiti√© gauche de la colonne est dessin√©e √† la place de la veille. Les cartes du samedi et du dimanche sont donc un peu plus √† gauche que la zone bleu√¢tre. Jusqu'√† ce que je comprenne comment le gagner.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre probl√®me est l'incapacit√© de fonctionner correctement √† intervalles mensuels. </font><font style="vertical-align: inherit;">Le fait est que la dur√©e de l'heure / jour / semaine est fixe, mais la dur√©e du mois est diff√©rente √† chaque fois. </font><font style="vertical-align: inherit;">InfluxDB ne peut fonctionner qu'√† intervalles r√©guliers. </font><font style="vertical-align: inherit;">Jusqu'√† pr√©sent, mon cerveau √©tait suffisant pour d√©finir un intervalle fixe de 30 jours. </font><font style="vertical-align: inherit;">Oui, le graphique flottera un peu au cours de l'ann√©e et les colonnes ne correspondront pas exactement aux mois. </font><font style="vertical-align: inherit;">Mais comme cette chose m'int√©resse simplement en tant que p√©riph√©rique d'affichage, je suis d'accord avec √ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vois au moins deux solutions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Score sur les horaires mensuels et limite hebdomadaire. </font><font style="vertical-align: inherit;">52 bars hebdomadaires pour l'ann√©e ont l'air plut√¥t bien</font></font></li>
<li>     ‚Ññ2,       .     .          ‚Äî    .</li>
</ul><br>
<br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne sais pas pourquoi, mais je marche sur ce genre de graphiques. Ils montrent que la vie bat son plein et que tout change. Hier, c'√©tait beaucoup, aujourd'hui ne suffit pas, demain sera autre chose. Reste √† travailler avec les m√©nages sur le th√®me de la consommation. Mais m√™me avec les app√©tits actuels, juste un chiffre important et incompr√©hensible dans le paiement se transforme d√©j√† en une image assez claire de la consommation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© une carri√®re de programmeur de pr√®s de 20 ans, je n'ai pratiquement pas crois√© les bases de donn√©es. Par cons√©quent, l'installation d'une base de donn√©es externe semblait quelque chose d'abstrus et d'incompr√©hensible. Tout a √©t√© chang√© par l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article susmentionn√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il s'est av√©r√© que le vissage d'un outil appropri√© se fait en quelques clics, et avec un outil sp√©cialis√©, la t√¢che de graphique devient un peu plus facile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le titre, j'ai mentionn√© la consommation d'√©lectricit√©. </font><font style="vertical-align: inherit;">Malheureusement, pour le moment, je ne peux pas donner un seul graphique. </font><font style="vertical-align: inherit;">Un compteur SDM120 est mort et l'autre est bogu√© lors de l'acc√®s via Modbus. </font><font style="vertical-align: inherit;">Cependant, cela n'affecte pas le sujet de cet article - les graphiques seront construits de la m√™me mani√®re que pour l'eau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, j'ai cit√© les approches que j'ai moi-m√™me essay√©es. </font><font style="vertical-align: inherit;">Il y a s√ªrement d'autres fa√ßons d'organiser la collecte et la visualisation de donn√©es que je ne connais pas. </font><font style="vertical-align: inherit;">Dites-le moi dans les commentaires, √ßa va √™tre tr√®s int√©ressant pour moi. </font><font style="vertical-align: inherit;">Je serai heureux de recevoir des critiques constructives et de nouvelles id√©es. </font><font style="vertical-align: inherit;">J'esp√®re que le mat√©riel pr√©sent√© aidera √©galement quelqu'un.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492298/index.html">Polygones Another World: IBM PC</a></li>
<li><a href="../fr492302/index.html">Stand intelligent avec smartphones pour testeurs - un projet de d√©marrage de l'acc√©l√©rateur de l'Universit√© ITMO</a></li>
<li><a href="../fr492306/index.html">Lidars au CES</a></li>
<li><a href="../fr492308/index.html">Les neurones et leur mod√©lisation</a></li>
<li><a href="../fr492312/index.html">S√©rialisation Avro chez Kafka</a></li>
<li><a href="../fr492318/index.html">Comment le coronavirus affecte l'industrie informatique</a></li>
<li><a href="../fr492320/index.html">Covid-19, votre soci√©t√© et vous en termes de science des donn√©es</a></li>
<li><a href="../fr492322/index.html">Raspberry Pi + Fedora (aarch64) = Hotspot Wi-Fi (ou un routeur framboise dans un chapeau bleu)</a></li>
<li><a href="../fr492326/index.html">Analyse de la popularit√© des vid√©os YouTube des participants √† l'Eurovision 2020</a></li>
<li><a href="../fr492328/index.html">Int√©gration et d√©ploiement continus d'applications de bureau avec GitHub Actions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>