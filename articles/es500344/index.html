<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò• üë¥üèø ü§∑ Casa inteligente sobre ruedas ... Alice. Parte 2. ZIGBEE üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ üíÄ üèõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuaci√≥n de la √©pica con control de voz.
 En la parte anterior, a trav√©s de Alice, la voz fue controlada por los controladores MiLight. Pero tales...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Casa inteligente sobre ruedas ... Alice. Parte 2. ZIGBEE</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500344/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuaci√≥n de la √©pica con control de voz.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la parte anterior, a trav√©s de Alice, la voz fue controlada por los controladores MiLight. Pero tales controladores no se encuentran en todas las casas, lo que limita en gran medida nuestras capacidades. Por lo tanto, me propuse expandir el control por voz a l√°mparas, l√°mparas, candelabros comunes, etc., pero con una alteraci√≥n m√≠nima del sistema de iluminaci√≥n est√°ndar. Todo lo que se necesitar√° para tal sistema es el reemplazo de interruptores convencionales con interruptores inteligentes que operan de acuerdo con el protocolo ZigBee y la instalaci√≥n de un coordinador USB ZigBee CC2531. Naturalmente, del art√≠culo anterior, ya tenemos una columna Yandex inteligente y un desastre personalizado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El costo de CC2531 cost√≥ 250 rublos, el programador para √©l CC-Debugger Texas Instrument - 500 rublos. Los interruptores inteligentes t√°ctiles Livolo VL-C701Z-11 fueron los m√°s caros, alrededor de 2000 rublos cada uno, y un poco m√°s tarde, el interruptor de bot√≥n Zigbee del interruptor de pared Aqara tambi√©n se agreg√≥ alrededor de 2000.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, plane√© controlar los conmutadores a trav√©s del enrutador de puerta de enlace ZigBee patentado Livolo C700ZW-12, conectarlo al hub abierto y dirigir usando Alice a trav√©s de yandex2mqtt. Conect√© las gl√°ndulas a la electricidad, configur√© la aplicaci√≥n de Livolo en el tel√©fono. Vi los interruptores de la puerta de enlace, conectados, y todo funcion√≥ perfectamente desde el tel√©fono. Pero el hub abierto con el enrutador no se pudo fusionar debido a la falta de la funcionalidad necesaria en el hub abierto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tuve que abandonar la puerta de enlace y fusionar los interruptores directamente con el dongle CC2531. Y aqu√≠ el proyecto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del amigo Koenkk </font><font style="vertical-align: inherit;">ayud√≥ con esto </font><font style="vertical-align: inherit;">. Como resultado, logramos conectar el coordinador de ZigBee con interruptores inteligentes, primero verificamos su funcionamiento a trav√©s de consultas en el tema mqtt para el an√°lisis y luego configuramos el control con Alice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, ¬øc√≥mo fue la configuraci√≥n? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Destelle el sniffer CC2531 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con el firmware</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del coordinador y con√©ctelo al puerto usb. Para evitar mensajes sobre la falta de energ√≠a, es mejor conectar al menos 2A a una fuente de alimentaci√≥n de 5V. Verificamos que el dispositivo en el sistema est√© correctamente definido: ls -l / dev / serial / by-id mostrar√° algo como usb-Texas_Instruments_TI_CC2531_USB_CDC ___ 0X00124B0458ED3DDF-if00 -&gt; ../../ttyACM0. La presencia de la √∫ltima pieza de salida "-&gt; ../../ttyACM0" es muy importante si es as√≠. Un palo puede decidir sin esta parte y nada funcionar√°. Parpadear el palo me ayud√≥ con tal problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Instale </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zigbee2mqtt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero no inicie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Es importante configurar /opt/zigbee2mqtt/data/configuration.yaml correctamente. El hecho es que los conmutadores inteligentes Livolo operan en el canal 26, por lo que este canal debe establecerse expl√≠citamente en el archivo. Y tambi√©n es importante prestar atenci√≥n a la cantidad de espacios al principio de las l√≠neas del archivo. Para verificar la sintaxis del archivo de configuraci√≥n, puede usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validador YAML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Despu√©s de que el archivo de configuraci√≥n se haya registrado correctamente y el dongle est√© atascado, ejecute zigbee2mqtt. Luego pisamos los interruptores, comenzamos el emparejamiento y miramos la salida de la consola. Habr√° una l√≠nea de intercambio de datos, rassharkivaniya mutua entre los dispositivos y, finalmente, algo como esto: </font></font><code>MQTT publish: topic 'zigbee2mqtt/0x001*********a8c9', payload '{"state_left":"OFF","state_right":"OFF","linkquality":60}'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esto significa que el conmutador est√° conectado y se le env√≠a su estado. Si ejecuta un par de consolas m√°s, puede controlar la luz a trav√©s del tema mqtt: apagar</font></font><code>- mosquitto_pub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -m OFF -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y gire, </font></font><code>mosquitto_pub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -m ON -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y tambi√©n puede consultar al equipo en Topeka </font></font><code>mosquitto_sub -d -h localhost -t zigbee2mqtt/0x001*********a8c9/left/set -u a**** -P *****</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por cierto, para Livolo y Aqara, los temas difieren no solo en los identificadores 0x0 ..., sino tambi√©n en la estructura. La estructura de temas para dispositivos compatibles se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Despu√©s de haber verificado que podemos administrar dispositivos a trav√©s de mqtt, emparejaremos todo con Yandex. Algunos matices han aparecido aqu√≠. Los comandos para controlar dispositivos a trav√©s de zigbee2mqtt llegaron a temas en forma de ENCENDIDO / APAGADO, y yandex2mqtt como result√≥ da 1/0. La soluci√≥n a este problema fue editar en yandex2mqtt el archivo /mnt/data/root/yandex2mqtt/device.js. ¬øNecesita reemplazar int = val en el interruptor en el caso "on"? a 'on': 'off' en lugar de '1': '0'. Naturalmente, los comandos de conmutaci√≥n tuvieron que corregirse en el centro abierto en los temas correspondientes. Sin esto, la luz sobre Milight dejar√≠a de funcionar. Y lo m√°s interesante sali√≥ a la luz all√≠: dado que yandex2mqtt y zigbee2mqtt publican todo en el servidor mqtt local, parece que los dispositivos zenbee no necesitan un centro abierto para administrar dispositivos.El paquete funciona directamente - yandex (Alice) -yandex2mqtt-mqtt-zigbee2mqtt-device zigbee. Incluso inesperadamente de alguna manera. Pero continuemos. Archivaremos el tema de control del dispositivo en el archivo de configuraci√≥n /mnt/data/root/yandex2mqtt/config.js en un nuevo dispositivo virtual, actualizaremos la lista de dispositivos en el sistema de di√°logo Yandex y puedes patear a Alice para encender la luz.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Tambi√©n fue posible conectar un par de sensores Xiaomi, un sensor de fugas y un sensor de temperatura / humedad / presi√≥n al sistema. </font><font style="vertical-align: inherit;">Funcionan con bater√≠as 2032. Naturalmente, no est√°n controladas, pero simplemente dejan caer informaci√≥n peri√≥dicamente, </font></font><code>#033[32mzigbee2mqtt:info #033[39m 2020-05-04 21:12:21: MQTT publish: topic 'zigbee2mqtt/0x0015************', payload '{"battery":91,"voltage":2985,"temperature":26.2,"humidity":28.65,"pressure":1006.9,"linkquality":52}' -   #  #033[32mzigbee2mqtt:info #033[39m 2020-05-04 21:21:07: MQTT publish: topic 'zigbee2mqtt/0x001************7', payload '{"battery":100,"voltage":3025,"linkquality":0,"water_leak":true}' </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como un sensor de fugas en un vaso de agua, </font><font style="vertical-align: inherit;">en los temas </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hasta ahora, no hay ning√∫n beneficio particular, pero si todo esto es otparsit y hacer algo reactivo como enviar SMS o d√≠gitos a alg√∫n bozal web, entonces ser√° muy bueno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y un peque√±o video:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Pb8veRpRMTY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/9uNynR_LL-o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es500332/index.html">4 de mayo Java Digest</a></li>
<li><a href="../es500334/index.html">Twisters o Nevera en Pilot Brothers</a></li>
<li><a href="../es500336/index.html">Parte 2: M√≥dulos y AppStore. ESPboy: un gadget para juegos retro y experimentos con IoT</a></li>
<li><a href="../es500338/index.html">[Traducci√≥n] Enjuague</a></li>
<li><a href="../es500342/index.html">¬øQu√© podcasts tienen el "Comit√©", "Habr" y Sports.ru</a></li>
<li><a href="../es500346/index.html">Problemas con DNS en Kubernetes. Post-mortem p√∫blico</a></li>
<li><a href="../es500348/index.html">La pandemia de COVID-19 a trav√©s de los ojos de un matem√°tico, o por qu√© el cl√°sico modelo SEIRD no funciona</a></li>
<li><a href="../es500352/index.html">¬øC√≥mo obtener una pasant√≠a en Facebook y obtener una oferta en Londres? Haga una pregunta a un ingeniero de Facebook</a></li>
<li><a href="../es500354/index.html">Una nueva forma de rastrear datos en Google Tag Manager: etiquetado del lado del servidor</a></li>
<li><a href="../es500356/index.html">Transferencia directa de archivos entre dispositivos a trav√©s de WebRTC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>