<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👈🏿 👩🏼‍🤝‍👩🏻 👏🏻 Volcanic Piglet、または日曜大工のSQL 🌼 🍲 💟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="データの収集、保存、変換、および提示は、データエンジニアが直面する主な課題です。ビジネスインテリジェンスBadoo部門は、ユーザーデバイスから1日に送信される200億を超えるイベント、または2 TBの受信データを受信して​​処理します。
 

 — , . - , .
 

, . PigletQL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Volcanic Piglet、または日曜大工のSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/461699/"><p><img src="https://habrastorage.org/webt/sl/pt/ay/slptaynsfh2p62e4epxcf6_xfaw.jpeg"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データの収集、保存、変換、および提示は、データエンジニアが直面する主な課題です。</font><font style="vertical-align: inherit;">ビジネスインテリジェンスBadoo部門は、ユーザーデバイスから1日に送信される200億を超えるイベント、または2 TBの受信データを受信して​​処理します。</font></font></p><br>
<p>      —    ,          .         - ,         .</p><br>
<p>,         .                  PigletQL.</p><a name="habracut"></a><br>
<h1 id="soderzhanie"></h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  SQL</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Volcano   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PigletQL</a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></li>
</ul><br>
<h1 id="predystoriya"></h1><br>
<p>      ,          ( ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>).    —       (Exasol)   Hadoop    (Hive  Presto).</p><br>
<p>       — ,         .    ,             .    -    ,         .</p><br>
<p>        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a> SQL,        .            (, streamvbyte),                .</p><br>
<p>            ,     ,        .</p><br>
<p>    ,         .         SQL,       .</p><br>
<p>             — Volcano.         SQL — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PigletQL</a>,          .</p><br>
<h1 id="struktura-interpretatora-sql">  SQL</h1><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/cw/gc/jr/cwgcjrjdybx4snxrzxqmyh4tu9c.jpeg" alt="通訳者の構造"></a></p><br>
<p>              SQL.          ,     .        ,          .           .</p><br>
<p>      .  ,     (<em></em>),   :     ,       . .  ,   —    ,         .             .</p><br>
<p>            ,     <em> </em>.</p><br>
<p>                     .        <em>  </em>,          : ,  , ,    . .</p><br>
<p>              :        ,     .  ,      ,     ,    (<em></em> )      . .                  ,      .</p><br>
<p>         — <em> </em>.       ,               ,     .          .          ,    .</p><br>
<p>          .</p><br>
<h1 id="model-volcano-i-ispolnenie-zaprosov"> Volcano   </h1><br>
<p>           ,         Volcano,    90-.</p><br>
<p>  Volcano           : open, next, close.  ,     — state.  open   ,  next    <em></em> (. tuple),  NULL,    ,  close   :</p><br>
<p><img src="https://habrastorage.org/webt/oj/rs/td/ojrstdsuwcja-qrhljipd3cooeu.jpeg"></p><br>
<p>      ,      .  ,  ,        ,   ,     :</p><br>
<p><img src="https://habrastorage.org/webt/qv/pk/pj/qvpkpjoiusjmjxvxj6xlp_lci3y.jpeg"></p><br>
<p>            .</p><br>
<p>  Volcano        ,          PigletQL.</p><br>
<h1 id="pigletql">PigletQL</h1><br>
<p><img src="https://habrastorage.org/webt/j9/sq/4w/j9sq4wdaertiyjii_h-vnxihrak.jpeg"></p><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PigletQL</a>.    C,      SQL,     — 32-   .     .          .</p><br>
<p> PigletQL     SELECT       .   (CREATE TABLE  INSERT)      .</p><br>
<p>    PigletQL:</p><br>
<pre><code class="plaintext hljs">&gt; ./pigletql<font></font>
&gt; CREATE TABLE tab1 (col1,col2,col3);<font></font>
&gt; INSERT INTO tab1 VALUES (1,2,3);<font></font>
&gt; INSERT INTO tab1 VALUES (4,5,6);<font></font>
&gt; SELECT col1,col2,col3 FROM tab1;<font></font>
col1 col2 col3<font></font>
1 2 3<font></font>
4 5 6<font></font>
rows: 2<font></font>
&gt; SELECT col1 FROM tab1 ORDER BY col1 DESC;<font></font>
col1<font></font>
4<font></font>
1<font></font>
rows: 2</code></pre><br>
<h2 id="leksicheskiy-i-sintaksicheskiy-analizatory">   </h2><br>
<p>PigletQL —   ,              .</p><br>
<p>   .       (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">scanner_t</a>),       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">scanner_t</span> *<span class="hljs-title">scanner_create</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-built_in">string</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scanner_destroy</span><span class="hljs-params">(<span class="hljs-keyword">scanner_t</span> *scanner)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">token_t</span> <span class="hljs-title">scanner_next</span><span class="hljs-params">(<span class="hljs-keyword">scanner_t</span> *scanner)</span></span>;</code></pre><br>
<p>     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">parser_t</a>, ,    (scanner_t),   query_t   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">query_t</span> *<span class="hljs-title">query_create</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">query_destroy</span><span class="hljs-params">(<span class="hljs-keyword">query_t</span> *query)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">parser_t</span> *<span class="hljs-title">parser_create</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">parser_destroy</span><span class="hljs-params">(<span class="hljs-keyword">parser_t</span> *parser)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">parser_parse</span><span class="hljs-params">(<span class="hljs-keyword">parser_t</span> *parser, <span class="hljs-keyword">scanner_t</span> *scanner, <span class="hljs-keyword">query_t</span> *query)</span></span>;</code></pre><br>
<p>   query_t —     PigletQL  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> query_tag {<font></font>
    QUERY_SELECT,<font></font>
    QUERY_CREATE_TABLE,<font></font>
    QUERY_INSERT,<font></font>
} query_tag;<font></font>
<font></font>
<span class="hljs-comment">/*
 * ... query_select_t, query_create_table_t, query_insert_t definitions ...
 **/</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">query_t</span> {</span><font></font>
    query_tag tag;<font></font>
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">query_select_t</span> select;
        <span class="hljs-keyword">query_create_table_t</span> create_table;
        <span class="hljs-keyword">query_insert_t</span> insert;<font></font>
    } as;<font></font>
} <span class="hljs-keyword">query_t</span>;</code></pre><br>
<p>     PigletQL — SELECT.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">query_select_t</a>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">query_select_t</span> {</span>
    <span class="hljs-comment">/* Attributes to output */</span>
    <span class="hljs-keyword">attr_name_t</span> attr_names[MAX_ATTR_NUM];
    <span class="hljs-keyword">uint16_t</span> attr_num;<font></font>
<font></font>
    <span class="hljs-comment">/* Relations to get tuples from */</span>
    <span class="hljs-keyword">rel_name_t</span> rel_names[MAX_REL_NUM];
    <span class="hljs-keyword">uint16_t</span> rel_num;<font></font>
<font></font>
    <span class="hljs-comment">/* Predicates to apply to tuples */</span>
    <span class="hljs-keyword">query_predicate_t</span> predicates[MAX_PRED_NUM];
    <span class="hljs-keyword">uint16_t</span> pred_num;<font></font>
<font></font>
    <span class="hljs-comment">/* Pick an attribute to sort by */</span>
    <span class="hljs-keyword">bool</span> has_order;
    <span class="hljs-keyword">attr_name_t</span> order_by_attr;
    <span class="hljs-keyword">sort_order_t</span> order_type;<font></font>
} <span class="hljs-keyword">query_select_t</span>;</code></pre><br>
<p>    (   ),    — ,  ,  ,    ,    .</p><br>
<h2 id="semanticheskiy-analizator"> </h2><br>
<p>     SQL     ,         .  ,     ,    ,       .</p><br>
<p> PigletQL    ,            .  SELECT, ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">validate_select</a>.     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">validate_select</span><span class="hljs-params">(<span class="hljs-keyword">catalogue_t</span> *cat, <span class="hljs-keyword">const</span> <span class="hljs-keyword">query_select_t</span> *query)</span>
</span>{
    <span class="hljs-comment">/* All the relations should exist */</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> rel_i = <span class="hljs-number">0</span>; rel_i &lt; query-&gt;rel_num; rel_i++) {
        <span class="hljs-keyword">if</span> (catalogue_get_relation(cat, query-&gt;rel_names[rel_i]))
            <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error: relation '%s' does not exist\n"</span>, query-&gt;rel_names[rel_i]);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Relation names should be unique */</span>
    <span class="hljs-keyword">if</span> (!rel_names_unique(query-&gt;rel_names, query-&gt;rel_num))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-comment">/* Attribute names should be unique */</span>
    <span class="hljs-keyword">if</span> (!attr_names_unique(query-&gt;attr_names, query-&gt;attr_num))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-comment">/* Attributes should be present in relations listed */</span>
    <span class="hljs-comment">/* ... */</span><font></font>
<font></font>
    <span class="hljs-comment">/* ORDER BY attribute should be available in the list of attributes chosen */</span>
    <span class="hljs-comment">/* ... */</span><font></font>
<font></font>
    <span class="hljs-comment">/* Predicate attributes should be available in the list of attributes projected */</span>
    <span class="hljs-comment">/* ... */</span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br>
<p>  ,          .</p><br>
<h2 id="kompilyaciya-zaprosov-v-promezhutochnoe-predstavlenie">    </h2><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/b3/7i/6a/b37i6a7mfq9z6adzpkmdpcuunls.jpeg"></a></p><br>
<p>   SQL  ,  , :    .</p><br>
<p>  PigletQL  CREATE TABLE  INSERT      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">query_create_table_t</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">query_insert_t</a>.    SELECT     ,     .</p><br>
<p>         :</p><br>
<ol>
<li><p>    ("… FROM relation1, relation2, …")    ,       scan.</p><br>
</li>
<li><p>     scan        join.</p><br>
</li>
<li><p>,   ("SELECT attr1, attr2, …"),   project.</p><br>
</li>
<li><p>  -  ("… WHERE a=1 AND b&gt;10 …"),       select.</p><br>
</li>
<li><p>     ("… ORDER BY attr1 DESC"),       sort.</p><br>
</li>
</ol><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> PigletQL:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">operator_t</span> *<span class="hljs-title">compile_select</span><span class="hljs-params">(<span class="hljs-keyword">catalogue_t</span> *cat, <span class="hljs-keyword">const</span> <span class="hljs-keyword">query_select_t</span> *query)</span>
</span>{
    <span class="hljs-comment">/* Current root operator */</span>
    <span class="hljs-keyword">operator_t</span> *root_op = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
    <span class="hljs-comment">/* 1. Scan ops */</span>
    <span class="hljs-comment">/* 2. Join ops*/</span><font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">size_t</span> rel_i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">relation_t</span> *rel = catalogue_get_relation(cat, query-&gt;rel_names[rel_i]);<font></font>
        root_op = scan_op_create(rel);<font></font>
        rel_i += <span class="hljs-number">1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (; rel_i &lt; query-&gt;rel_num; rel_i++) {<font></font>
            rel = catalogue_get_relation(cat, query-&gt;rel_names[rel_i]);<font></font>
            <span class="hljs-keyword">operator_t</span> *scan_op = scan_op_create(rel);<font></font>
            root_op = join_op_create(root_op, scan_op);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* 3. Project */</span><font></font>
    root_op = proj_op_create(root_op, query-&gt;attr_names, query-&gt;attr_num);<font></font>
<font></font>
    <span class="hljs-comment">/* 4. Select */</span>
    <span class="hljs-keyword">if</span> (query-&gt;pred_num &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">operator_t</span> *select_op = select_op_create(root_op);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> pred_i = <span class="hljs-number">0</span>; pred_i &lt; query-&gt;pred_num; pred_i++) {
            <span class="hljs-keyword">query_predicate_t</span> predicate = query-&gt;predicates[pred_i];<font></font>
<font></font>
            <span class="hljs-comment">/* Add a predicate to the select operator */</span>
            <span class="hljs-comment">/* ... */</span><font></font>
        }<font></font>
        root_op = select_op;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* 5. Sort */</span>
    <span class="hljs-keyword">if</span> (query-&gt;has_order)<font></font>
        root_op = sort_op_create(root_op, query-&gt;order_by_attr, query-&gt;order_type);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> root_op;<font></font>
}</code></pre><br>
<p>      ,  PigletQL       .</p><br>
<h2 id="ispolnenie-promezhutochnogo-predstavleniya">  </h2><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/q7/dj/xe/q7djxezm_g_dcjund49iztea5ec.jpeg"></a></p><br>
<p> Volcano            open/next/close.  ,   Volcano — ,    «»   ,        pull-.</p><br>
<p>           ,          .</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> SELECT</a>  PigletQL:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">eval_select</span><span class="hljs-params">(<span class="hljs-keyword">catalogue_t</span> *cat, <span class="hljs-keyword">const</span> <span class="hljs-keyword">query_select_t</span> *query)</span>
</span>{
    <span class="hljs-comment">/* Compile the operator tree:  */</span>
    <span class="hljs-keyword">operator_t</span> *root_op = compile_select(cat, query);<font></font>
<font></font>
    <span class="hljs-comment">/* Eval the tree: */</span><font></font>
    {<font></font>
        root_op-&gt;open(root_op-&gt;state);<font></font>
<font></font>
        <span class="hljs-keyword">size_t</span> tuples_received = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">tuple_t</span> *tuple = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">while</span>((tuple = root_op-&gt;next(root_op-&gt;state))) {
            <span class="hljs-comment">/* attribute list for the first row only */</span>
            <span class="hljs-keyword">if</span> (tuples_received == <span class="hljs-number">0</span>)<font></font>
                dump_tuple_header(tuple);<font></font>
<font></font>
            <span class="hljs-comment">/* A table of tuples */</span><font></font>
            dump_tuple(tuple);<font></font>
<font></font>
            tuples_received++;<font></font>
        }<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"rows: %zu\n"</span>, tuples_received);<font></font>
<font></font>
        root_op-&gt;close(root_op-&gt;state);<font></font>
    }<font></font>
<font></font>
    root_op-&gt;destroy(root_op);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}</code></pre><br>
<p>    compile_select,    ,          open/next/close.   next    ,  NULL.     ,     ,       close.</p><br>
<p>         .</p><br>
<h2 id="operatory"></h2><br>
<p>   PigletQL —  .      .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>          open/next/close     destroy,      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*op_open)</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span></span>;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">tuple_t</span> *(*op_next)(<span class="hljs-keyword">void</span> *state);
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*op_close)</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*op_destroy)</span><span class="hljs-params">(<span class="hljs-keyword">operator_t</span> *op)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/* The operator itself is just 4 pointers to related ops and operator state */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">operator_t</span> {</span><font></font>
    op_open open;<font></font>
    op_next next;<font></font>
    op_close close;<font></font>
    op_destroy destroy;<font></font>
<font></font>
    <span class="hljs-keyword">void</span> *state;<font></font>
} ;</code></pre><br>
<p> ,        ( state).</p><br>
<p>      :  scan     sort.</p><br>
<h3 id="operator-scan"> scan</h3><br>
<p>,      , — scan.      . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  scan</a> —    ,    ,       -   ,  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scan_op_state_t</span> {</span>
    <span class="hljs-comment">/* A reference to the relation being scanned */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">relation_t</span> *relation;
    <span class="hljs-comment">/* Next tuple index to retrieve from the relation */</span>
    <span class="hljs-keyword">uint32_t</span> next_tuple_i;
    <span class="hljs-comment">/* A structure to be filled with references to tuple data */</span>
    <span class="hljs-keyword">tuple_t</span> current_tuple;<font></font>
} <span class="hljs-keyword">scan_op_state_t</span>;</code></pre><br>
<p>    scan  -;   (   )  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">operator_t</span> *<span class="hljs-title">scan_op_create</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">relation_t</span> *relation)</span>
</span>{
    <span class="hljs-keyword">operator_t</span> *op = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*op));<font></font>
    assert(op);<font></font>
<font></font>
    *op = (<span class="hljs-keyword">operator_t</span>) {<font></font>
        .open = scan_op_open,<font></font>
        .next = scan_op_next,<font></font>
        .close = scan_op_close,<font></font>
        .destroy = scan_op_destroy,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">scan_op_state_t</span> *state = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*state));<font></font>
    assert(state);<font></font>
<font></font>
    *state = (<span class="hljs-keyword">scan_op_state_t</span>) {<font></font>
        .relation = relation,<font></font>
        .next_tuple_i = <span class="hljs-number">0</span>,<font></font>
        .current_tuple.tag = TUPLE_SOURCE,<font></font>
        .current_tuple.as.source.tuple_i = <span class="hljs-number">0</span>,<font></font>
        .current_tuple.as.source.relation = relation,<font></font>
    };<font></font>
    op-&gt;state = state;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> op;<font></font>
}</code></pre><br>
<p> open/close   scan       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scan_op_open</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">scan_op_state_t</span> *op_state = (typeof(op_state)) state;<font></font>
    op_state-&gt;next_tuple_i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">tuple_t</span> *current_tuple = &amp;op_state-&gt;current_tuple;<font></font>
    current_tuple-&gt;as.source.tuple_i = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scan_op_close</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">scan_op_state_t</span> *op_state = (typeof(op_state)) state;<font></font>
    op_state-&gt;next_tuple_i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">tuple_t</span> *current_tuple = &amp;op_state-&gt;current_tuple;<font></font>
    current_tuple-&gt;as.source.tuple_i = <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
<p> next    ,  NULL,      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">tuple_t</span> *<span class="hljs-title">scan_op_next</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">scan_op_state_t</span> *op_state = (typeof(op_state)) state;
    <span class="hljs-keyword">if</span> (op_state-&gt;next_tuple_i &gt;= op_state-&gt;relation-&gt;tuple_num)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
    <span class="hljs-keyword">tuple_source_t</span> *source_tuple = &amp;op_state-&gt;current_tuple.as.source;<font></font>
    source_tuple-&gt;tuple_i = op_state-&gt;next_tuple_i;<font></font>
    op_state-&gt;next_tuple_i++;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> &amp;op_state-&gt;current_tuple;<font></font>
}<font></font>
</code></pre><br>
<h3 id="operator-sort"> sort</h3><br>
<p> sort      .        ,    ,   .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a> :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sort_op_state_t</span> {</span>
    <span class="hljs-keyword">operator_t</span> *source;
    <span class="hljs-comment">/* Attribute to sort tuples by */</span>
    <span class="hljs-keyword">attr_name_t</span> sort_attr_name;
    <span class="hljs-comment">/* Sort order, descending or ascending */</span>
    <span class="hljs-keyword">sort_order_t</span> sort_order;<font></font>
<font></font>
    <span class="hljs-comment">/* Temporary relation to be used for sorting*/</span>
    <span class="hljs-keyword">relation_t</span> *tmp_relation;
    <span class="hljs-comment">/* Relation scan op */</span>
    <span class="hljs-keyword">operator_t</span> *tmp_relation_scan_op;<font></font>
} <span class="hljs-keyword">sort_op_state_t</span>;</code></pre><br>
<p>       (sort_attr_name  sort_order)    (tmp_relation).        open:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sort_op_open</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">sort_op_state_t</span> *op_state = (typeof(op_state)) state;
    <span class="hljs-keyword">operator_t</span> *source = op_state-&gt;source;<font></font>
<font></font>
    <span class="hljs-comment">/* Materialize a table to be sorted */</span><font></font>
    source-&gt;open(source-&gt;state);<font></font>
    <span class="hljs-keyword">tuple_t</span> *tuple = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">while</span>((tuple = source-&gt;next(source-&gt;state))) {
        <span class="hljs-keyword">if</span> (!op_state-&gt;tmp_relation) {<font></font>
            op_state-&gt;tmp_relation = relation_create_for_tuple(tuple);<font></font>
            assert(op_state-&gt;tmp_relation);<font></font>
            op_state-&gt;tmp_relation_scan_op = scan_op_create(op_state-&gt;tmp_relation);<font></font>
        }<font></font>
        relation_append_tuple(op_state-&gt;tmp_relation, tuple);<font></font>
    }<font></font>
    source-&gt;close(source-&gt;state);<font></font>
<font></font>
    <span class="hljs-comment">/* Sort it */</span><font></font>
    relation_order_by(op_state-&gt;tmp_relation, op_state-&gt;sort_attr_name, op_state-&gt;sort_order);<font></font>
<font></font>
    <span class="hljs-comment">/* Open a scan op on it */</span><font></font>
    op_state-&gt;tmp_relation_scan_op-&gt;open(op_state-&gt;tmp_relation_scan_op-&gt;state);<font></font>
}</code></pre><br>
<p>       tmp_relation_scan_op:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">tuple_t</span> *<span class="hljs-title">sort_op_next</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">sort_op_state_t</span> *op_state = (typeof(op_state)) state;
    <span class="hljs-keyword">return</span> op_state-&gt;tmp_relation_scan_op-&gt;next(op_state-&gt;tmp_relation_scan_op-&gt;state);;<font></font>
}<font></font>
</code></pre><br>
<p>     close:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sort_op_close</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *state)</span>
</span>{
    <span class="hljs-keyword">sort_op_state_t</span> *op_state = (typeof(op_state)) state;
    <span class="hljs-comment">/* If there was a tmp relation - destroy it */</span>
    <span class="hljs-keyword">if</span> (op_state-&gt;tmp_relation) {<font></font>
        op_state-&gt;tmp_relation_scan_op-&gt;close(op_state-&gt;tmp_relation_scan_op-&gt;state);<font></font>
        scan_op_destroy(op_state-&gt;tmp_relation_scan_op);<font></font>
        relation_destroy(op_state-&gt;tmp_relation);<font></font>
        op_state-&gt;tmp_relation = <span class="hljs-literal">NULL</span>;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>  ,            .</p><br>
<h2 id="primery-raboty"> </h2><br>
<p>    PigletQL      .</p><br>
<p>  ,      :</p><br>
<pre><code class="plaintext hljs">&gt; ./pigletql<font></font>
&gt; create table rel1 (a1,a2,a3);<font></font>
&gt; insert into rel1 values (1,2,3);<font></font>
&gt; insert into rel1 values (4,5,6);<font></font>
&gt; select a1 from rel1;<font></font>
a1<font></font>
1<font></font>
4<font></font>
rows: 2<font></font>
&gt;</code></pre><br>
<p>          scan       project:</p><br>
<p><img src="https://habrastorage.org/webt/3n/63/oa/3n63oa4mcglybfftogb195rdxko.jpeg"></p><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">&gt; ./pigletql<font></font>
&gt; create table rel1 (a1,a2,a3);<font></font>
&gt; insert into rel1 values (1,2,3);<font></font>
&gt; insert into rel1 values (4,5,6);<font></font>
&gt; select a1 from rel1 where a1 &gt; 3;<font></font>
a1<font></font>
4<font></font>
rows: 1<font></font>
&gt;</code></pre><br>
<p>   select:</p><br>
<p><img src="https://habrastorage.org/webt/h8/82/r7/h882r7yfruh0orjlenqkb-o6lzk.jpeg"></p><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">&gt; ./pigletql<font></font>
&gt; create table rel1 (a1,a2,a3);<font></font>
&gt; insert into rel1 values (1,2,3);<font></font>
&gt; insert into rel1 values (4,5,6);<font></font>
&gt; select a1 from rel1 order by a1 desc;<font></font>
a1<font></font>
4<font></font>
1<font></font>
rows: 2</code></pre><br>
<p>  scan   open  (<em></em>)  ,        .     next          :</p><br>
<p><img src="https://habrastorage.org/webt/oq/ec/ap/oqecap_w6sdwv3-d7fckp2lfeyo.jpeg"></p><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">&gt; ./pigletql<font></font>
&gt; create table rel1 (a1,a2,a3);<font></font>
&gt; insert into rel1 values (1,2,3);<font></font>
&gt; insert into rel1 values (4,5,6);<font></font>
&gt; create table rel2 (a4,a5,a6);<font></font>
&gt; insert into rel2 values (7,8,6);<font></font>
&gt; insert into rel2 values (9,10,6);<font></font>
&gt; select a1,a2,a3,a4,a5,a6 from rel1, rel2 where a3=a6;<font></font>
a1 a2 a3 a4 a5 a6<font></font>
4 5 6 7 8 6<font></font>
4 5 6 9 10 6<font></font>
rows: 2</code></pre><br>
<p> join  PigletQL     ,            .   ,     :</p><br>
<p><img src="https://habrastorage.org/webt/if/ct/zp/ifctzpcu29dnns3ijm3bwlckzyk.jpeg"></p><br>
<h1 id="vyvody"></h1><br>
<p> ,      ,   SQL,  , ,          .            -,             .</p><br>
<p>  PigletQL    SQL,           Volcano     (!)  ,       .</p><br>
<p>   :            ,       .</p><br>
<h1 id="literatura"></h1><br>
<p>       ,   ,  “Database system implementation” (Garcia-Molina H., Ullman J. D., Widom J., 2000),   .</p><br>
<p>   —  .   ,           .       “Database design and implementation” (Sciore E., 2008),          Java.</p><br>
<p>    -     Volcano.      ,      Google Scholar: “Volcano — an extensible and parallel query evaluation system” (Graefe G., 1994).</p><br>
<p>     SQL      ,           .            “Query evaluation techniques for large databases” (Graefe G. 1993).</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461689/index.html">開発者のIoT識別</a></li>
<li><a href="../ja461691/index.html">Astra Linux Special Edition OSの脆弱性をどのようにクローズするか</a></li>
<li><a href="../ja461693/index.html">Raspberry PiとBeagleBone Black用のOpenCV 4のクロスコンパイル</a></li>
<li><a href="../ja461695/index.html">VFXインターンシップ</a></li>
<li><a href="../ja461697/index.html">ビールの知性</a></li>
<li><a href="../ja461703/index.html">プログラマーの作業におけるマイクロステップレポート</a></li>
<li><a href="../ja461707/index.html">とらえどころのないマルヴァリの冒険、パートV：その他のDDEおよびCOMスクリプトレット</a></li>
<li><a href="../ja461709/index.html">iOS開発者になりたい場合に何を期待するか</a></li>
<li><a href="../ja461713/index.html">クラウドバックアップを保存する4つの方法</a></li>
<li><a href="../ja461715/index.html">Techdirとしての恐怖と嫌悪</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>