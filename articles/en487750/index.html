<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🅰️ 👏🏻 👨🏿‍🎤 Some subtleties of injection collections in Spring 🖖🏽 😱 🤛🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! My name is Vladislav Rodin. I am currently teaching courses on software architecture and high load software architecture on the OTUS p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Some subtleties of injection collections in Spring</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/487750/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font><font style="vertical-align: inherit;">My name is Vladislav Rodin. </font><font style="vertical-align: inherit;">I am currently teaching courses on software architecture and high load software architecture on the OTUS portal. </font><font style="vertical-align: inherit;">Now in OTUS there is an open set for the new thread of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Developer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">on the Spring Framework</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In anticipation of the start of the course, I decided to write a little copyright material that I want to share with you.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/z-/xc/bw/z-xcbwfaea9ckpi7rtggkasvdmq.png"><br>
<hr><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring contains a lot of “magic” within itself, carrying out some unobvious things on its own. </font><font style="vertical-align: inherit;">Ignorance or misunderstanding of this can lead to side effects that you may encounter in the process of writing your application using this framework. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of these unobvious things is injection of Java Collection Framework interfaces. </font><font style="vertical-align: inherit;">Having independently stepped on a rake related to this topic, and having heard the next questions from my colleagues, I decided to sort it out and record the results of my research in the form of an article with the hope that it would help someone already in work or during the initial development of Spring.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scenario</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at a service that will work with movie heroes. </font><font style="vertical-align: inherit;">There will be 3 of them: Rambo, Terminator and Gandalf. </font><font style="vertical-align: inherit;">Each of them will represent a separate class, and their parent will be common - Hero.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hero</span> </span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rambo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Rambo"</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Terminator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Terminator"</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gandalf</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Gandalf"</span>;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Injection List</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's assume that we want to create a service that will work with the heroes of the militants. </font><font style="vertical-align: inherit;">Probably, you will have to inject a list of such heroes into it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No problem! </font><font style="vertical-align: inherit;">Create a service and configuration:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActionHeroesService</span> </span>{
    <span class="hljs-meta">@Autowired</span><font></font>
    List&lt;Hero&gt; actionHeroes;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroesConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Hero&gt; <span class="hljs-title">action</span><span class="hljs-params">()</span> </span>{<font></font>
        List&lt;Hero&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<font></font>
        result.add(<span class="hljs-keyword">new</span> Terminator());<font></font>
        result.add(<span class="hljs-keyword">new</span> Rambo());
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is fine, but when checking it can be found that Gandalf is on the list! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring, seeing that it was necessary to inject the List, went around the beans located in the context, found among them all that fit the generic type, collected List from them and injected it, ignoring our List. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to get Spring to do what we want?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 1. Crutch</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the problem is precisely in trying to inject the Java Collection Framework’s interface, you can simply replace List with ArrayList in the service and, of course, in the configuration so that Spring finds an instance of the class we need. </font><font style="vertical-align: inherit;">Then everything will work as we expected.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroesConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ArrayList&lt;Hero&gt; <span class="hljs-title">action</span><span class="hljs-params">()</span> </span>{<font></font>
        ArrayList&lt;Hero&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<font></font>
        result.add(<span class="hljs-keyword">new</span> Terminator());<font></font>
        result.add(<span class="hljs-keyword">new</span> Rambo());
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActionHeroesService</span> </span>{
    <span class="hljs-meta">@Autowired</span><font></font>
    ArrayList&lt;Hero&gt; actionHeroes;<font></font>
}<font></font>
</code></pre> <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 2. More correct</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another way to tie Spring’s hands is to ask him to inject into the service not just any List, but a bean with a special name, adding Qualifier. </font><font style="vertical-align: inherit;">Thus, we will be able to inject our bean.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActionHeroesService</span> </span>{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier("action")</span><font></font>
    List&lt;Hero&gt; actionHeroes;<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Injection Maps</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If many people know about the nuance of the injection of List, then things are generally worse with the Map. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's write a service that will work with the main characters of the films. Map will be injected into it, containing the names of the films by the keys, and by the values ​​of the beans of the main characters:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainCharactersService</span> </span>{
    <span class="hljs-meta">@Autowired</span><font></font>
    Map&lt;String, Hero&gt; mainCharactersByFilmName;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroesConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Hero&gt; <span class="hljs-title">mainCharactersByFilmName</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Hero&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
<font></font>
        result.put(<span class="hljs-string">"rambo"</span>, <span class="hljs-keyword">new</span> Rambo());<font></font>
        result.put(<span class="hljs-string">"terminator"</span>, <span class="hljs-keyword">new</span> Terminator());<font></font>
        result.put(<span class="hljs-string">"LOTR"</span>, <span class="hljs-keyword">new</span> Gandalf());<font></font>
<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At startup, you can see that Gandalf’s key is not LOTR, but gandalf, from which we can conclude that it was not the name of the film that was written, but the name of the bean, whereas in the case of Rimbaud and the terminator it was just lucky: the names of the main characters coincide with movie titles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, when it is necessary to inject a Map, the key of which is String, and the value of the beans, Spring (as in the case of the List) will simply ignore the Map we proposed, go through the context and collect all the suitable beans s, and will create a Map with them as values ​​and with their names as keys. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The workarounds are similar to those that worked for the List:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 1. Crutch</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Replace Map with HashMap:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainCharactersService</span> </span>{
    <span class="hljs-meta">@Autowired</span><font></font>
    HashMap&lt;String, Hero&gt; mainCharactersByFilmName;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroesConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HashMap&lt;String, Hero&gt; <span class="hljs-title">mainCharactersByFilmName</span><span class="hljs-params">()</span> </span>{<font></font>
        HashMap&lt;String, Hero&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
<font></font>
        result.put(<span class="hljs-string">"rambo"</span>, <span class="hljs-keyword">new</span> Rambo());<font></font>
        result.put(<span class="hljs-string">"terminator"</span>, <span class="hljs-keyword">new</span> Terminator());<font></font>
        result.put(<span class="hljs-string">"LOTR"</span>, <span class="hljs-keyword">new</span> Gandalf());<font></font>
<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 2. More correct</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add Qualifier:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainCharactersService</span> </span>{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier("mainCharactersByFilmName")</span><font></font>
    Map&lt;String, Hero&gt; mainCharactersByFilmName;<font></font>
}<font></font>
<font></font>
</code></pre></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487740/index.html">Assembling a portable magnetometer</a></li>
<li><a href="../en487742/index.html">Arbitrage Trading (Bellman-Ford Algorithm)</a></li>
<li><a href="../en487744/index.html">FARO Introduces FOCUS S 70 Laser 3D Scanner</a></li>
<li><a href="../en487746/index.html">Eternal</a></li>
<li><a href="../en487748/index.html">$ 3 hardware encryption key - is this possible?</a></li>
<li><a href="../en487752/index.html">Optimize storage: a case of unification and lower cost of ownership</a></li>
<li><a href="../en487754/index.html">Organization of the intranet (automation of IT production). Part 1 - Users and Mail</a></li>
<li><a href="../en487756/index.html">RIT, Maxim Lapshin (Erlyvideo): how a programmer to grow a company</a></li>
<li><a href="../en487764/index.html">I am 14 and I combine school with work in IT</a></li>
<li><a href="../en487768/index.html">Opening ports 4321 and 9898 on Xiaomi Gateway 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>