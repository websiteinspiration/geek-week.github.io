<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤵🏻 🕺🏽 🍟 Die Entwicklung der Facebook-Webhook-Verarbeitung: von null auf 25.000 pro Sekunde 👩🏼‍⚕️ ☝🏽 🏚️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Höchstwahrscheinlich muss niemand sagen, was Webhooks sind. Aber nur für den Fall: Webhooks sind ein Mechanismus zum Melden von Ereignissen in einem e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Die Entwicklung der Facebook-Webhook-Verarbeitung: von null auf 25.000 pro Sekunde</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Höchstwahrscheinlich muss niemand sagen, was Webhooks sind. Aber nur für den Fall: Webhooks sind ein Mechanismus zum Melden von Ereignissen in einem externen System. Zum Beispiel über den Kauf in einem Online-Shop über eine Online-Kasse, das Senden eines Codes an ein GitHub-Repository oder Benutzeraktionen in Chats. In einer typischen API müssen Sie den Server ständig abfragen, wenn der Benutzer etwas im Chat geschrieben hat. Mithilfe des Webhook-Mechanismus können Sie Benachrichtigungen "abonnieren", und der Server selbst sendet eine HTTP-Anforderung, wenn ein Ereignis auftritt. Dies ist bequemer und schneller als das ständige Anfordern neuer Daten auf dem Server.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat ist eine Plattform, mit der Unternehmen über Chat in Instant Messenger mit ihren Kunden kommunizieren können. Webhooks sind einer der wichtigen Bestandteile von ManyChat, da das Unternehmen über sie mit den Kunden kommuniziert. Und sie kommunizieren viel - zum Beispiel senden Unternehmen über ein System monatlich Milliarden von Nachrichten an ihre Kunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die meisten Nachrichten werden über Facebook Messenger gesendet. Es hat eine Funktion - eine langsame API. Wenn ein Kunde eine Nachricht schreibt, um Pizza zu bestellen, sendet Facebook einen Webhook an ManyChat. Die Plattform verarbeitet es, sendet die Anfrage zurück und der Benutzer erhält eine Nachricht. Aufgrund der langsamen API dauern einige Anforderungen einige Sekunden. Wenn die Plattform jedoch längere Zeit nicht reagiert, verliert das Unternehmen den Client und Facebook kann die Anwendung von Webhooks trennen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher ist die Verarbeitung von Webhooks eine der wichtigsten technischen Aufgaben der Plattform. </font><font style="vertical-align: inherit;">Um das Problem zu lösen, hat ManyChat seine Verarbeitungsarchitektur im Laufe von drei Jahren mehrmals von einem einfachen Controller in Yii auf ein verteiltes System mit Galaxien geändert. </font><font style="vertical-align: inherit;">Lesen Sie mehr darüber unter dem Schnitt Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Storno</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov leitet die Entwicklung bei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und programmiert seit 2001 professionell in PHP. </font><font style="vertical-align: inherit;">Dmitry wird Ihnen erzählen, wie sich die Architektur zusammen mit dem Wachstum von Service und Last verändert hat, welche Lösungen und Technologien in verschiedenen Phasen angewendet wurden, wie sich die Webhook-Verarbeitung entwickelt hat und wie die Plattform mit bescheidenen Ressourcen in PHP mit einer enormen Last fertig wird. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis. </font><font style="vertical-align: inherit;">Der Artikel basiert auf Dmitrys Bericht „Die Entwicklung der Facebook-Webhook-Verarbeitung: von null auf 12.500 pro Sekunde“ in </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aber während er sich vorbereitete, stiegen die Indikatoren auf 25.000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist ManyChat?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst werde ich Sie in den Kontext unserer Aufgaben einführen. ManyChat ist ein Service, mit dem Unternehmen Instant Messenger für Marketing, Vertrieb und Support einsetzen können. Das Hauptprodukt ist die </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plattform für Messenger Marketing auf Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Drei Jahre lang nutzten mehr als 1 Million Unternehmen aus 100 Ländern der Welt den Service, um mit 700 Millionen ihrer Kunden zu kommunizieren. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf der Client-Seite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sieht es so aus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schaltflächen, Bilder und Galerien in den Dialogen im Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dies ist die Facebook Messenger-Oberfläche. Zusätzlich zu Textnachrichten können Sie darin interaktive Elemente senden, um mit Kunden zu interagieren, in einen Dialog zu treten, das Interesse an Ihren Produkten zu steigern und zu verkaufen. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Von der Geschäftsseite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alles sieht anders aus. </font><font style="vertical-align: inherit;">Dies ist die Oberfläche unserer Webanwendung, über die Unternehmensvertreter mithilfe einer visuellen Oberfläche Dialogskripte erstellen und programmieren. </font><font style="vertical-align: inherit;">Das Bild ist ein Beispiel für ein Szenario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Herzstück unseres Systems ist die Flow Builder-Komponente. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Skripte und Automatisierungsregeln nennen wir einen </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Zur Vereinfachung können wir daher sagen, dass ManyChat ein Bot-Designer ist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Beispiel für einen Bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Client des Unternehmens, das am Dialog teilnimmt, wird als </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abonnent bezeichnet</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da der Client für die Interaktion </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den Bot abonniert</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum Facebook Messenger, wir sind das Land des überlebenden Telegramms? </font><font style="vertical-align: inherit;">Dafür gibt es Gründe.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     №1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Interaktion mit Facebook ist folgendermaßen organisiert: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business verwendet eine Webanwendung, um die Logik des Bots zu konfigurieren. </font><font style="vertical-align: inherit;">Wenn ein Kunde über das Telefon mit dem Bot interagiert, erhält Facebook Informationen dazu und sendet uns einen Webhook. </font><font style="vertical-align: inherit;">ManyChat verarbeitet es abhängig von der vom Unternehmen programmierten Logik und sendet die Anforderung zurück. </font><font style="vertical-align: inherit;">Dann liefert Facebook die Nachricht an das Telefon des Benutzers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technologischer Stapel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir machen das alles auf einem bescheidenen Stapel. </font><font style="vertical-align: inherit;">Im Zentrum steht natürlich PHP. </font><font style="vertical-align: inherit;">Auf dem Webserver wird Nginx ausgeführt, die Hauptdatenbank ist PostgreSQL, und es gibt auch Redis und Elasticsearch. </font><font style="vertical-align: inherit;">Alles dreht sich in den Amazon Web Services-Clouds.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Umgang mit Facebook Webhook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die Webcam von Facebook aus: Dies ist eine Anfrage mit Nutzdaten im JSON-Format.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webhooks machen nur 10% unserer Last aus, sind aber der wichtigste Teil des Systems. </font><font style="vertical-align: inherit;">Über sie kommuniziert das Unternehmen mit den Benutzern. </font><font style="vertical-align: inherit;">Wenn Nachrichten langsamer werden oder nicht gesendet werden, weigert sich der Benutzer, mit dem Bot zu interagieren, und das Unternehmen verliert den Client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werfen wir einen Blick auf die Entwicklung unserer Architektur seit der Einführung des Produkts. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mai 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wir haben gerade unseren Service gestartet: 20 Bots, von denen 10 Testbots sind, und 20 Abonnenten. </font><font style="vertical-align: inherit;">Die Last betrug 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Interaktionsschema sah folgendermaßen aus:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anfrage geht an nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx greift auf PHP-FPM zu.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM bringt die Anwendung auf Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Webhook-Controller verarbeitet die Logik und sendet entsprechend Anfragen an Facebook.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Menge Nginx und PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juni 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Einen Monat später kündigten wir ManyChat auf ProductHunt an und die Anzahl der Bots stieg auf 2.000. </font><font style="vertical-align: inherit;">Die Anzahl der Abonnenten ist auf 7 Tausend gestiegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Moment trat das erste Problem im System auf. </font><font style="vertical-align: inherit;">Die Facebook-API ist nicht sehr schnell: Einige Anfragen können mehrere Sekunden dauern, und mehrere Anfragen können mehrere zehn Sekunden dauern. </font><font style="vertical-align: inherit;">Der Webhook-Server möchte jedoch, dass wir schnell reagieren. </font><font style="vertical-align: inherit;">Aufgrund der langsamen API reagieren wir nicht lange: Der Server schwört zuerst und kann dann die Anwendung vollständig von Webhooks trennen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt nur wenige Benutzer, wir entwickeln die Anwendung noch, wir suchen unseren Markt, unser Publikum und das Ladeproblem ist bereits aufgetreten. </font><font style="vertical-align: inherit;">Wir wurden jedoch durch eine einfache Lösung gerettet: In </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dem Moment, in dem der Controller startet, unterbrechen wir den Zugriff auf Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir sagen Facebook, dass alles in Ordnung ist, aber im Hintergrund bearbeiten wir Anfragen und Webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warteschlangen auf PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dezember 2016. Der</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Service wuchs um das 5- bis 10-fache: 10.000 Bots und 700.000 Abonnenten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig haben wir an neuen Aufgaben gearbeitet: Anzeigen von Statistiken, Nachrichtenübermittlung, Konvertieren von Impressionen und Übergängen. </font><font style="vertical-align: inherit;">Auch Live Chat implementiert. </font><font style="vertical-align: inherit;">Neben der Automatisierung von Interaktionen können Unternehmen Nachrichten direkt an ihren Abonnenten schreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Lösung dieser Probleme erhöhte die Anzahl der Kettenhaken um das Vierfache. </font><font style="vertical-align: inherit;">Für jede gesendete Nachricht haben wir 3 zusätzliche Webhooks erhalten. </font><font style="vertical-align: inherit;">Das Verarbeitungssystem musste erneut verbessert werden. </font><font style="vertical-align: inherit;">Wir sind eine kleine Plattform, nur zwei Personen haben am Backend gearbeitet, daher haben wir die einfachste Lösung gewählt - Warteschlangen unter PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wollen noch keine komplexen Systeme implementieren, also teilen wir einfach die Verarbeitungsabläufe. </font><font style="vertical-align: inherit;">Webhooks, die schnell verarbeitet werden müssen, damit der Benutzer eine Antwort erhält, werden synchron verarbeitet. </font><font style="vertical-align: inherit;">Der Rest wird in Warteschlangen für asynchrone Anforderungen gesendet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warteschlangen bei Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juni 2017. Der</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Service wächst: 75.000 Bots, 7 Millionen Abonnenten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir implementieren eine weitere neue Funktion. Alle von uns verarbeiteten Webhooks betrafen nur die Kommunikation im Messenger. Jetzt haben wir uns entschlossen, Unternehmen die Möglichkeit zu geben, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit Abonnenten von Unternehmensseiten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu kommunizieren, </font><font style="vertical-align: inherit;">und neue Arten von Webhooks zu verarbeiten - solche, die sich auf den Feed der Seite selbst beziehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geschäftsseiten-Feeds werden nicht selten aktualisiert. Vermarkter posten oft etwas, dann folgen sie jedem wie und zählen sie. Es gibt keinen großen Verkehr auf Geschäftsseiten. Aber es gibt umgekehrte Situationen, zum Beispiel </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry ist eine berühmte amerikanische Sängerin mit einer großen Anzahl von Fans auf der ganzen Welt. </font><font style="vertical-align: inherit;">Allein in ihrer Facebook-Gruppe gibt es 64 Millionen Abonnenten. </font><font style="vertical-align: inherit;">Irgendwann entschieden sich die Vermarkter des Sängers, einen Bot auf Facebook Messenger zu erstellen und entschieden sich für unsere Plattform. </font><font style="vertical-align: inherit;">In diesem Moment, als sie eine Nachricht veröffentlichten, in der sie aufgefordert wurden, den Bot zu abonnieren, stieg unsere Last um das 3-4-fache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Situation hat uns zu dem Verständnis verholfen, dass wir ohne die normale Implementierung der Warteschlangen nichts tun können. </font><font style="vertical-align: inherit;">Als Lösung wählten sie Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Wahl von Redis für Warteschlangen ist eine fantastisch gute Entscheidung.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Er half bei der Lösung einer Vielzahl von Problemen. Jetzt leitet jede Sekunde durch unseren Redis-Cluster 1 Million verschiedene Anfragen. Wir verwenden es nicht nur für alle kaskadierenden Warteschlangen, sondern auch für andere Aufgaben, zum Beispiel die Überwachung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warteschlangen auf Redis wurden beim ersten Versuch nicht implementiert. Als wir anfingen, Webhooks in Redis zu falten und in einem Prozess zu verarbeiten, haben wir den Trichter oben erweitert: Es wurden auch mehr eingehende Webhooks verarbeitet, aber der Prozess selbst dauerte noch einige Zeit. Diese erste Entscheidung war erfolglos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als sie versuchten, die Anzahl dieser Anfragen zu skalieren, gab es einen leichten Zusammenbruch. Die Warteschlange kann Anforderungen von verschiedenen Seiten sammeln, aber Anforderungen von einer Seite können hintereinander gestellt werden. Wenn ein Handler langsam ist, werden Anforderungen von einem Abonnenten und von einem Bot in der falschen Reihenfolge verarbeitet. Der Benutzer sendet Nachrichten, führt einige Aktionen mit dem Bot aus, erhält jedoch zufällig eine Antwort. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies scheint ein seltener Fall zu sein, aber Tests unserer Workloads haben gezeigt, dass dies häufig vorkommen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir suchten nach einer anderen Lösung. Hier kam die Einfachheit und Kraft von Redis zur Rettung - wir beschlossen, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für jeden Bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eine </font><strong><font style="vertical-align: inherit;">Warteschlange zu erstellen</font></strong><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie es funktioniert? Nachrichten, die sich auf jeden Bot beziehen, werden der Warteschlange hinzugefügt. Um den Handler nicht für jede Warteschlange zu erhöhen, haben wir eine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Steuerwarteschlange erstellt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sie arbeitet so. Jedes Mal, wenn eine Anfrage von einem Bot kommt, werden zwei Nachrichten in Redis veröffentlicht: eine in der Warteschlange des Bots, die zweite in der Steuerung. Der Handler überwacht das Steuerelement und jedes Mal, wenn er den Dämon startet, wenn eine Aufgabe zur Verarbeitung des Bots vorliegt. Der Dämon stellt die Warteschlange des entsprechenden Bots auf. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben der Hauptaufgabe haben wir das Problem der „lauten Nachbarn“ gelöst. In diesem Fall hat ein Bot eine große Menge von Webhooks generiert und das System verlangsamt, da andere Seiten auf die Verarbeitung warten. Um das Problem zu lösen, reicht eine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skalierung aus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Wenn die Steuerwarteschlange voll ist, fügen wir neue Handler hinzu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus sind die </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warteschlangen virtuell</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dies sind nur Zellen im Redis-Speicher. </font><font style="vertical-align: inherit;">Wenn sich nichts in der Warteschlange befindet, existiert es nicht, es belegt nichts.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Januar 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wir haben 1 Milliarde Beiträge pro Monat erreicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Last betrug 5.000 RPS pro System. Dies ist keine Spitzenlast, sondern Standard. Wenn Bots berühmter Sänger auftauchen, wächst alles schon mehrmals aus dieser Figur. Aber das ist kein Problem. Das Problem liegt in PHP-FPM: Es kann der Last von 5.000 RPS nicht mehr standhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle sprachen damals von modischer asynchroner Verarbeitung. Wir haben es uns genauer angesehen, ReactPHP gesehen, Schnelltests durchgeführt, es durch PHP-FPM ersetzt und sofort eine 4-fache Steigerung erzielt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben die Verarbeitung unserer Verarbeitung nicht umgeschrieben - ReactPHP hat das Yii-Framework erhöht. Zuerst haben wir 4 ReactPHP-Dienste aufgerufen, und später haben wir 30 erreicht. Wir haben lange davon gelebt und das Framework hat die Last bewältigt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobald wir den Trichter erweitert hatten, kam es zu einem weiteren Zusammenbruch: Nach dem Starten des Trichters an der Rezeption begann die Verarbeitung erneut zu leiden. </font><font style="vertical-align: inherit;">Um dieses Problem bereits zu lösen, haben wir uns entschlossen, die Verarbeitung in Cluster aufzuteilen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie nahmen Bots, verteilten sie in Cluster und bauten logische Ketten von Redis, Postgres und einem Handler. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir das Konzept der </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Galaxie“ entwickelt - eine logische physische Abstraktion über die Verarbeitung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es besteht aus Instanzen: Redis, PostgreSQL und einer Reihe von PHP-Diensten. </font><font style="vertical-align: inherit;">Jeder Bot gehört zu einem bestimmten Cluster, und ReactPHP weiß, in welchem ​​Cluster die Nachricht für diesen Bot platziert werden muss. </font><font style="vertical-align: inherit;">Das obige Schema funktioniert weiter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Universum erweitert sich, das Universum unserer Systeme auch, und wir fügen in diesem Fall eine neue „Galaxie“ hinzu.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Galaxien sind unsere Art zu skalieren.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen von ReactPHP durch eine Reihe von Nginx und Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den nächsten sechs Monaten sind wir weiter gewachsen: 200 Millionen Abonnenten und 3 Milliarden Nachrichten pro Monat. </font><font style="vertical-align: inherit;">Stellen Sie sich eine Site für 200 Millionen registrierte Benutzer vor - dieselbe Last. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein neues Problem ist aufgetreten. </font><font style="vertical-align: inherit;">Webhooks sind kleine Aufgaben des gleichen Typs, und PHP eignet sich nicht zum Lösen dieser Aufgaben. </font><font style="vertical-align: inherit;">Sogar ReactPHP hat nicht mehr geholfen.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Er konnte die Last von 10 000 RPS nicht bewältigen - seit der Einführung von ReactPHP hat die Last zugenommen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Darüber hinaus musste es auch bei Bereitstellungen nacheinander neu gestartet werden, da Sie die Verarbeitung eingehender Webhooks nicht unterbrechen können. </font><font style="vertical-align: inherit;">Facebook deaktiviert die Anwendung, wenn es feststellt, dass es Probleme gibt. </font><font style="vertical-align: inherit;">Für ManyChat ist dies eine Katastrophe - 650.000 aktiv tätige Unternehmen werden uns nicht vergeben.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher haben wir nach und nach andere Logik als ReactPHP abgebissen, an die Prozessoren übergeben und neue Warteschlangen isoliert. Dabei stellten sie fest, dass </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP eine einfache Aufgabe ausführt: Es nimmt einen Webhook und stellt ihn in eine Warteschlange</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Der Rest wird durch Verarbeitungen erledigt. Gibt es Analoga für eine so einfache Aufgabe? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben uns daran erinnert, dass Nginx Module hat und die </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty-</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek bemerkt </font><font style="vertical-align: inherit;">. Neben der Unterstützung der Programmiersprache Lua verfügte sie über ein Modul für die Arbeit mit Redis. Ein in 3 Stunden geschriebener Test zeigte, dass die gesamte Arbeit von 30 Diensten auf ReactPHP direkt auf der Nginx-Seite ausgeführt werden kann. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So stellte sich heraus: Wir verarbeiten eine Art Endpunkt, nehmen den Anforderungshauptteil auf und fügen ihn direkt zu Redis hinzu.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty und Lua haben zur Steigerung des Durchsatzes beigetragen. </font><font style="vertical-align: inherit;">Wir bewältigen weiterhin unsere Arbeitsbelastung, der Service lebt weiter, alle sind glücklich.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbesserung der Lösung auf Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die letzte Phase ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anmerkung: zum Zeitpunkt des Berichts</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ist der </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Februar 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 Millionen Abonnenten senden und empfangen jeden Monat 7 Millionen Nachrichten von einer Million Bots. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist ein Schritt zur Verbesserung unserer Lösung für Lua. </font><font style="vertical-align: inherit;">Biss nach und nach etwas Logik aus den Warteschlangen ab und übertrage die primäre Verarbeitung der Verteilung von Webhooks zwischen Systemen an Lua. </font><font style="vertical-align: inherit;">Jetzt sind unsere Systeme produktiver und weniger abhängig. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir pflegen eine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getrennte Verarbeitung und eine asynchrone Verarbeitung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Die Verarbeitung betrifft Statistiken und andere Dinge - jetzt ist es ein völlig anderes System. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das System scheint einfach, ist es aber nicht. </font><font style="vertical-align: inherit;">Unter der Haube gibt es 500 Dienste, die ihre Anfragen bearbeiten. </font><font style="vertical-align: inherit;">Das gesamte System läuft auf 50 Amazon-Instanzen: Redis, PostgreSQL und die PHP-Handler selbst.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evolution verarbeiten</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highload kann in PHP cool sein.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erinnern Sie sich kurz daran, wie wir dies bei der Entwicklung des Systems getan haben.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Begonnen mit normalem Nginx und PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warteschlangen zu PostgreSQL und dann zu Redis hinzugefügt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clustering hinzugefügt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP implementiert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben ReactPHP durch eine Reihe von Nginx und Lua ersetzt und später die Logik in die Reihe verschoben.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus eigener Erfahrung haben wir herausgefunden, dass es möglich ist, Architektur zu erweitern und aufzubauen, indem anfällige Teile nacheinander geändert werden, einfache bekannte Ansätze verwendet werden und der Stapel nicht erweitert wird.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de486824/index.html">Schlechter Rat bei der Arbeit mit ANTLR</a></li>
<li><a href="../de486826/index.html">Erstellen eines vollwertigen Viberbot auf Django 2 und der Viber REST-API. Erster Teil - Webhook</a></li>
<li><a href="../de486828/index.html">Food Design Digest, Januar 2020</a></li>
<li><a href="../de486832/index.html">Wie viele Jahre Taiga vergehen - verstehe nein</a></li>
<li><a href="../de486842/index.html">Konsul + iptables =: 3</a></li>
<li><a href="../de486850/index.html">Neuer reservierter Sitzplatz - wie ein Kapselhotel</a></li>
<li><a href="../de486858/index.html">Erstellen eines vollwertigen Viberbot. Teil zwei - erster Kontakt oder "convert_started"</a></li>
<li><a href="../de486860/index.html">ATX12VO - Essen auf eine neue Art und Weise</a></li>
<li><a href="../de486862/index.html">5 Gründe, warum Motion Design Ihnen hilft, mit Menschen in Kontakt zu treten</a></li>
<li><a href="../de486864/index.html">Migration von OpenVPN zu WireGuard, um Netzwerke zu einem L2-Netzwerk zusammenzuführen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>