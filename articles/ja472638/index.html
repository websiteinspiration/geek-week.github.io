<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👩🏼 🧒🏼 🏁 Spring BootとAppCDSで鋳鉄製ウォーカーを構築する 🎪 👩🏼‍🤝‍👨🏾 🕙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="アプリケーションクラスデータ共有（AppCDS） -起動を高速化してメモリを節約するJVM機能。登場したの JDK 1.5（2004年）でのHotSpotバックに始まったばかりで、長い時間のためにそれが残って非常に限定されるものではなく、部分的にでも商用。OpenJDK 10（2018）でのみ、一般...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spring BootとAppCDSで鋳鉄製ウォーカーを構築する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472638/"><p><img src="https://habrastorage.org/webt/se/py/8z/sepy8zdhkojsr-xiqs-lwdtyegy.jpeg"></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションクラスデータ共有（AppCDS）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -起動を高速化してメモリを節約するJVM機能。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">登場したの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> JDK 1.5（2004年）でのHotSpotバックに始まったばかりで、長い時間のためにそれが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">残って</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に限定されるものではなく、部分的にでも商用。</font><font style="vertical-align: inherit;">OpenJDK 10（2018）でのみ、一般ユーザー</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用できるようになり、同時に範囲が拡大しました。</font><font style="vertical-align: inherit;">そして最近</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リリースされた</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Java 13は、このアプリケーションをよりシンプルにしようとしました。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AppCDSの考え方は、一度ロードされたクラスを、同じホスト上の同じJVMのインスタンス間で「共有」することです。</font><font style="vertical-align: inherit;">これは、マイクロサービス、特に何千ものライブラリクラスを持つSpring Bootの「ブロイラー」にとって素晴らしいはずです。なぜなら、これらのクラスは、各JVMインスタンスの開始時に毎回ロード（解析および検証）する必要がなく、メモリ内で複製されないためです。</font><font style="vertical-align: inherit;">つまり、起動が速くなり、メモリ消費量が少なくなるはずです。</font><font style="vertical-align: inherit;">素晴らしいですね。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてがそうです、すべてがそうです。</font><font style="vertical-align: inherit;">しかし、あなた、odnokhabryaninが大通りの標識ではなく特定の数と例を信じていた場合は、katへようこそ-それが実際にどのようになっているかを理解してみましょう...</font></font></p><a name="habracut"></a><br>
<h2 id="vmesto-disclaimera"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項の代わりに</font></font></h2><br>
<p>      AppCDS,     .    ,    JVM     ,        enterprise-,     .     ,   AppCDS  module-path,  AppCDS     ( HotSpot)     .         ,    ,  ,      .          production,   ,   …</p><br>
<h2 id="teoriya"></h2><br>
<h3 id="kratkoe-vvedenie-v-appcds">   AppCDS</h3><br>
<p>         , :</p><br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>    (  Java 13,   Spring Boot)</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>    ( Java 13,   )</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>    ( Java 13,     Spring Boot)</li>
</ul><br>
<p>   ,    ,    .</p><br>
<p>-, AppCDS –      HotSpot  CDS,    :</p><br>
<p><img src="https://habrastorage.org/webt/gi/kg/ro/gikgrobp0s_hbnr5ox8z6d1ziqc.png"></p><br>
<p>     ,    (  ):</p><br>
<ol>
<li>  ,      </li>
<li>    ,   memory mapping’</li>
<li>       </li>
</ol><br>
<p> ,    3  –   .    , .</p><br>
<p>  ,         ,  ,    JVM    ,  ,           .    ,   ?</p><br>
<p>    :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>,     Java    . , :</p><br>
<ul>
<li> OpenJDK <strong>10  11</strong>   <strong> 1</strong>,       JDK,           <code>$JAVA_HOME\lib\classlist</code> (≈1200 .).</li>
<li> OpenJDK <strong>12</strong>   <strong> 2</strong>,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>     ,    “ ”     .</li>
<li> ,      (     ),<br>
 OpenJDK <strong>13</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> Dynamic CDS Archives – ,            .    <strong> 1  2</strong>       (    ,    ).</li>
</ul><br>
<p> ,         AppCDS,       3 ,      .</p><br>
<p>   ,   AppCDS      :         (  JAR-),     .     //    ,  JVM      .    ,     :    ,      ,       “JAR hell”. ,  JVM     ,         .       ,     , –   ;         . ,  JVM         ,   classpath,     AppCDS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>: “Classpath         (   ),      .” </p><br>
<blockquote>Note that the classpath used at archive creation time must be the same as (or a prefix of) the classpath used at run time.</blockquote><p>    , ,   , classpath    ,  :</p><br>
<ul>
<li> “” <code>.class</code>-    ,<br>
, <code>java com.example.Main</code></li>
<li>   JAR-   wildcard,<br>
, <code>java -cp mydir/* com.example.Main</code></li>
<li>  JAR- / ZIP-,<br>
, <code>java -cp lib1.jar;lib2.jar com.example.Main</code></li>
</ul><br>
<p>(   ,  classpath     -, ,  JVM- <code>-cp/-classpath/--class-path</code>,   <code>CLASSPATH</code>    JAR- <code>Class-Path</code>)</p><br>
<p>    AppCDS    –   JAR-. ,  HotSpot JVM ,   classpath’  AppCDS-             ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  –   .</p><br>
<blockquote>CDS/AppCDS supports archiving classes from JAR files only.</blockquote><p>  ,     , ..    JAR   JAR  (     Dynamic CDS, . ).   ,    JAR-,  Spring Boot’,     AppCDS  ,  . </p><br>
<p>     CDS  ,          (   <code>0x800000000</code>).      ,             (Address Space Layout Randomization (ASLR)),       .   HotSpot JVM      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <code>-Xshare</code>,   :</p><br>
<ul>
<li><code>-Xshare:on</code> –    CDS/AppCDS;   , JVM    .   <strong>    production</strong>,           .</li>
<li><code>-Xshare:off</code> – () CDS/AppCDS;      (    )</li>
<li><code>-Xshare:auto</code> –   JVM,  ,       ,       </li>
</ul><br>
<p>      Oracle   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>    ,      .</p><br>
<p>     ,    …</p><br>
<h3 id="varianty-primeneniya-appcds">  AppCDS</h3><br>
<p>  ,     AppCDS <del>  </del>   .        ,    ,       .</p><br>
<p>      AppCDS,   CDS –          (. "   AppCDS").    ,        Spring Boot     .      shared-          (.  ):</p><br>
<p><img src="https://habrastorage.org/webt/lz/7x/9l/lz7x9lodfzwv4ihwjjifjyxsf_a.png"></p><br>
<p> ,      AppCDS,     ,       .    ,           .            AppCDS.</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>№</th>
<th></th>
<th></th>
<th>  CPU</th>
<th>  RAM</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td></td>
<td>+</td>
<td>±</td>
<td></td>
</tr>
<tr>
<td><strong>2</strong></td>
<td><strong></strong></td>
<td><strong></strong></td>
<td><strong>++</strong></td>
<td><strong>++</strong></td>
<td><strong></strong></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td> </td>
<td>++</td>
<td>++</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td></td>
<td> </td>
<td>+++</td>
<td>+++</td>
<td></td>
</tr>
</tbody>
</table></div><br>
<p> :</p><br>
<ul>
<li>         (№1)          (   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Windows</a>)</li>
<li>     ,      ,        (   №1-2  №3-4)</li>
<li>         , ,      ,      .</li>
</ul><br>
<p>     <strong>   №2</strong> ( №1),          AppCDS           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">JEP-350</a> Dynamic CDS Archives,     .</p><br>
<h3 id="dynamic-cds-archives">Dynamic CDS Archives</h3><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">JEP-350</a> Dynamic CDS Archives –     Java 13 –    AppCDS.   ,    . ,  , “”   AppCDS   3 : (1)    , (2)      (3)     .        3-,  –    .      ( №1)     (     ),            ,    Spring Boot.   JEP-350     ,    , ,  .   ,  JVM      ,           “” . ,  .    ,    ,             . ,   AppCDS,            ,   -        .          ,    JVM- , ,    –    JVM.  ,        ,    .       :</p><br>
<ul>
<li>    JVM,    ,            (     ).</li>
<li>      ,       .  -  ,           ,          .      HTTP-   (        ),       . </li>
</ul><br>
<p>         ,      “”    ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   Java ,      3-  . </p><br>
<p>  Dynamic CDS Archives     JVM   :</p><br>
<ol>
<li>    <code>-XX:ArchiveClassesAtExit=archive.jsa</code>,        (     )</li>
<li>    <code>-XX:SharedArchiveFile=archive.jsa</code>,       </li>
</ol><br>
<p>           .            ( JDK),             , : </p><br>
<pre><code class="bash hljs">-XX:SharedArchiveFile=base.jsa:dynamic.jsa</code></pre><br>
<p><em>( Windows      “;”)</em></p><br>
<p>    AppCDS ,        .</p><br>
<h2 id="praktika"></h2><br>
<h3 id="podopytnyy-krolik"> </h3><br>
<p>   AppCDS      HelloWorld’,       Spring Boot.             ,   “ ”,    .       ( ELK)   ;      – ,       <code>tail</code>' – .    -,           ,      (  XML),     ,    .   <strong>ó</strong> ( “ ”,     )   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> GitHub</a>.     :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/q3/lo/m_/q3lom_x6c9wghlerm1g9oa9-yfw.png"></a></p><br>
<p>    Spring Boot + Spring Integration,     <code>tail</code>, <code>docker</code>  <code>kubectl</code> (    , Docker-  Kubernetes- ).      “” JAR- Spring Boot.  runtime     <strong>≈10 </strong>,     –  Spring  JDK. ,      ,  ,            ,    CPU.</p><br>
<h3 id="odinochnyy-eksperiment"> </h3><br>
<p>      Dynamic AppCDS   .     ,      –  ,          . </p><br>
<h4 id="vvodnye-zamechaniya"> </h4><br>
<ul>
<li>     Linux.   Windows  macOS  .</li>
<li>      JIT- ,  ,         ( <code>-Xint</code>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>),        .</li>
<li>          .     ,  ,  ,       ,    ,    . </li>
<li>        ,        .     “<strong> CDS</strong>” –            . , ,  ,         ;          ,        .</li>
</ul><br>
<h4 id="referentnaya-tochka"> </h4><br>
<p>      , ..     AppCDS’  .     :</p><br>
<ol>
<li><p> OpenJDK 13 (,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Liberica</a>,   lite-).<br>
       <code>PATH</code>   <code>JAVA_HOME</code>, , :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_HOME=~/tools/jdk-13</code></pre><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> ó (      v0.12.1).</p><br>
<p>      <code>config/application.yaml</code>   <code>server.address</code>        (    <code>localhost</code>).</p><br>
</li>
<li><p>    JVM.<br>
      <code>JAVA_OPTS</code>    :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_OPTS=-Xlog:class+load=info:file=<span class="hljs-built_in">log</span>/class-load.log</code></pre><br>
<p>    JVM   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   .</p><br>
</li>
<li><p>  :</p><br>
<ol>
<li>   <code>bin/analog</code></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:8083</a>  ,    </li>
<li>   <code>Ctrl+C</code>    <code>bin/analog</code></li>
</ol><br>
</li>
<li><p>  (    <code>log/</code>)</p><br>
<ul>
<li><p>    (  <code>class-load.log</code>):</p><br>
<pre><code class="bash hljs">cat class-load.log | wc -l<font></font>
10463</code></pre><br>
</li>
<li><p>       (  ):</p><br>
<pre><code class="bash hljs">grep -o <span class="hljs-string">'source: shared'</span> - class-load.log<font></font>
1146</code></pre><br>
</li>
<li><p>   (  ;  <code>analog.log</code>):</p><br>
<pre><code class="bash hljs">grep -oE <span class="hljs-string">'\(JVM running for .+\)'</span> analog.log | grep -oE <span class="hljs-string">'[0-9]\.[0-9]+'</span> | awk <span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span>
4.5225</code></pre><br>
</li>
</ul><br>
</li>
</ol><br>
<p>,     CDS  <code>1146/10463=0,1095</code> <strong>≈11%</strong>.   ,      (      AppCDS),  ,    12- ,   JDK <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  CDS- <code>$JAVA_HOME/lib/server/classes.jsa</code>,       :</p><br>
<pre><code class="bash hljs">cat <span class="hljs-variable">$JAVA_HOME</span>/lib/classlist | wc -l<font></font>
1170</code></pre><br>
<p>,    ,      AppCDS    ,   .</p><br>
<h4 id="osnovnoy-opyt"> </h4><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,    AppCDS           <code>-XX:ArchiveClassesAtExit</code>.           .          (), :</p><br>
<ol>
<li><p>     :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">"<span class="hljs-variable">$JAVA_OPTS</span> -XX:ArchiveClassesAtExit=work/classes.jsa"</span></code></pre><br>
</li>
<li><p> :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">"<span class="hljs-variable">$JAVA_OPTS</span> -Xlog:cds=debug:file=log/cds.log"</span>
</code></pre><br>
<p>      CDS-   .</p><br>
</li>
<li><p>    ,    :</p><br>
<ol>
<li>   <code>bin/analog</code></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:8083</a>  ,    </li>
<li>   <code>Ctrl+C</code>    <code>bin/analog</code><br>
          warning’,   <code>log/cds.log</code>   ;     .</li>
</ol><br>
</li>
<li><p>      :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">"-XX:SharedArchiveFile=work/classes.jsa -Xlog:class+load=info:file=log/class-load.log -Xlog:class+path=debug:file=log/class-path.log"</span>
</code></pre><br>
<p>     <code>JAVA_OPTS</code>,     ,   (1)   , (2)     (3)   class-path. </p><br>
</li>
<li><p>        3. </p><br>
</li>
<li><p>  (    <code>log/</code>)</p><br>
<ul>
<li><p>,  AppCDS   (  <code>class-path.log</code>):</p><br>
<pre><code class="plaintext hljs">[0.011s][info][class,path] type=BOOT <font></font>
[0.011s][info][class,path] Expecting BOOT path=/home/upc/tools/jdk-13/lib/modules<font></font>
[0.011s][info][class,path] ok<font></font>
[0.011s][info][class,path] type=APP <font></font>
[0.011s][info][class,path] Expecting -Djava.class.path=/home/upc/tmp/analog/lib/analog.jar<font></font>
[0.011s][info][class,path] ok<font></font>
</code></pre><br>
<p> <code>ok</code>   <code>type=BOOT</code>  <code>type=APP</code>    ,       CDS- .</p><br>
</li>
<li><p>    (  <code>class-load.log</code>):</p><br>
<pre><code class="bash hljs">cat class-load.log | wc -l<font></font>
10403<font></font>
</code></pre><br>
</li>
<li><p>       (  ):</p><br>
<pre><code class="bash hljs">grep -o <span class="hljs-string">'source: shared'</span> -c class-load.log<font></font>
6910<font></font>
</code></pre><br>
</li>
<li><p>   (  ;   <code>analog.log</code>):</p><br>
<pre><code class="bash hljs">grep -oE <span class="hljs-string">'\(JVM running for .+\)'</span> analog.log | grep -oE <span class="hljs-string">'[0-9]\.[0-9]+'</span> | awk <span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span><font></font>
4.04167<font></font>
</code></pre><br>
</li>
</ul><br>
</li>
</ol><br>
<p>      CDS   <code>6910/10403≈0,66</code> <strong>=66%</strong>,    <strong> 55%</strong>     .        <code>(4,5225-4,04167)=0,48</code> , ..     <strong>≈10,6%</strong>   .</p><br>
<h4 id="analiz-rezultatov"> </h4><br>
<p><em>  : “   ?”</em></p><br>
<p>,  ,    ,        .         ,     ,      .</p><br>
<p> ,      <code>log/cds.log</code>,         .    HotSpot JVM   warning’  ,    CDS .     :</p><br>
<pre><code class="bash hljs">grep -o <span class="hljs-string">'[warning]'</span> cds.log -c<font></font>
3591<font></font>
</code></pre><br>
<p>,     <code>class-load.log</code>  10+     66%   ,   ,    <code>cds.log</code> 3600  –    “” 44%  CDS.   ,    . </p><br>
<p>    <code>cds.log</code>, ,        4 .     :</p><br>
<pre><code class="plaintext hljs">Skipping org/springframework/web/client/HttpClientErrorException: Not linked<font></font>
Pre JDK 6 class not supported by CDS: 49.0 org/jrobin/core/RrdUpdater<font></font>
Skipping java/util/stream/Collectors$$Lambda$554: Unsafe anonymous class<font></font>
Skipping ch/qos/logback/classic/LoggerContext: interface org/slf4j/ILoggerFactory is excluded<font></font>
</code></pre><br>
<p>  3591         :</p><br>
<p><img src="https://habrastorage.org/webt/sp/f6/6k/spf66kzmkajvdxki1xdiwjyx9lg.png"></p><br>
<p>   :</p><br>
<ul>
<li><p><code>Unsafe anonymous class</code><br>
  JVM   “”   ,       -,         .</p><br>
</li>
<li><p><code>Not linked</code><br>
     , “”     ,  ,   .      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">StackOverflow </a>    . , ,       “” () JAR-  ,   AppCDS.       ,     (  ).</p><br>
</li>
<li><p><code>Pre JDK 6 class</code><br>
 ,   CDS    Java 5.        class-   ,   CDS    .    ,    ,  6,  Java,       .       -   ,      runtime- (, slf4j).</p><br>
</li>
<li><p><code>Skipping ... : super class/interface ... is excluded</code><br>
  ,  “”     .          CDS’,    . :</p><br>
<pre><code class="plaintext hljs">[warning][cds] Pre JDK 6 class not supported by CDS: 49.0 org/slf4j/spi/MDCAdapter<font></font>
[warning][cds] Skipping ch/qos/logback/classic/util/LogbackMDCAdapter: interface org/slf4j/spi/MDCAdapter is excluded<font></font>
</code></pre><br>
</li>
</ul><br>
<p><strong></strong></p><br>
<blockquote> CDS       100%.</blockquote><p>,     ,  ,         ,  ,     .      .</p><br>
<h3 id="mnozhestvennyy-eksperiment"> </h3><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">JEP-310</a>, AppCDS                         JDK.   .       ,     .    CDS (, ,     )       .</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p>    (    ),   -   ;      “ ”.  Spring Boot,        - ;      JVM.       <code>ANALOG_OPTS</code>   ,   Gradle’. </p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> ANALOG_OPTS=<span class="hljs-string">"-Djavamelody.enabled=false -Dlogging.config=classpath:logging/logback-console.xml"</span>
<span class="hljs-built_in">export</span> ANALOG_OPTS=<span class="hljs-string">"<span class="hljs-variable">$ANALOG_OPTS</span> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span>
</code></pre><br>
<p>     JavaMelody,             ,        ,       .     TCP-    ;       .</p><br>
<p> ,    ,   JVM      AppCDS    .         <code>JAVA_OPTS</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">JVM Unified Logging Framework</a>:</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">"-Xlog:class+load=info:file=log/class-load-%p.log -Xlog:class+path=debug:file=log/class-path-%p.log"</span>
<span class="hljs-built_in">export</span> JAVA_OPTS=<span class="hljs-string">"<span class="hljs-variable">$JAVA_OPTS</span> -XX:SharedArchiveFile=work/classes.jsa"</span>
</code></pre><br>
<p>       <code>%p</code>,    JVM      (PID).   AppCDS  ,     (         ).</p></div></div><br>
<h4 id="osnovnoy-opyt-1"> </h4><br>
<p> ,          .                  .     :</p><br>
<ol>
<li><p>     <code>server.port</code>  <code>nodes.this.agentPort</code>,      :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> ANALOG_OPTS=<span class="hljs-string">"<span class="hljs-variable">$ANALOG_OPTS</span> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span>
</code></pre><br>
<p>,       (    ).</p><br>
</li>
<li><p>   <code>bin/analog</code></p><br>
<p><em>()</em>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:8091</a>  ,    </p><br>
</li>
<li><p> PID  (  ), :</p><br>
<pre><code class="bash hljs">pgrep -f analog<font></font>
13792<font></font>
</code></pre><br>
</li>
<li><p>     <code>pmap</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>):</p><br>
<pre><code class="bash hljs">pmap -XX 13792 | sed -n -e <span class="hljs-string">'2p;$p'</span><font></font>
        Address Perm   Offset Device   Inode    Size KernelPageSize MMUPageSize    Rss    Pss Shared_Clean Shared_Dirty Private_Clean Private_Dirty Referenced Anonymous LazyFree AnonHugePages ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked ProtectionKey                   VmFlagsMapping<font></font>
                                             3186952           1548        1548 328132 325183         3256            0         10848        314028     212620    314024        0             0              0              0               0    0       0 325183             0 KB <font></font>
</code></pre><br>
<p>          ;   .</p><br>
</li>
<li><p>  1-4     (,  ).</p><br>
</li>
</ol><br>
<h4 id="analiz-rezultatov-1"> </h4><br>
<p>   <code>pmap</code>             .        CDS’    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a>.    ,  ,        PSS:</p><br>
<blockquote>The "proportional set size" (PSS) of a process is the count of pages it has in memory, where each page is divided by the number of processes sharing it. So if a process has 1000 pages all to itself, and 1000 shared with one other process, its PSS will be 1500.</blockquote><p> ,   ,  “ ” .        ,      .</p><br>
<p>   PSS       ,    :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Iteration:</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody>
<tr>
<td>PSS of inst#1:</td>
<td>339 088</td>
<td>313 778</td>
<td>305 517</td>
<td>301 153</td>
<td>298 604</td>
</tr>
<tr>
<td>PSS of inst#2:</td>
<td></td>
<td>314 904</td>
<td>306 567</td>
<td>302 555</td>
<td>299 919</td>
</tr>
<tr>
<td>PSS of inst#3:</td>
<td></td>
<td></td>
<td>314 914</td>
<td>311 008</td>
<td>308 691</td>
</tr>
<tr>
<td>PSS of inst#4:</td>
<td></td>
<td></td>
<td></td>
<td>306 563</td>
<td>304 495</td>
</tr>
<tr>
<td>PSS of inst#5:</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>294 686</td>
</tr>
<tr>
<td><em>Average:</em></td>
<td>339 088</td>
<td>314 341</td>
<td>308 999</td>
<td>305 320</td>
<td>301 279</td>
</tr>
</tbody>
</table></div><br>
<p>        ,      - :</p><br>
<ul>
<li>       “” </li>
<li>    , PSS  </li>
<li> “” ,     PSS     </li>
</ul><br>
<p>   ,      .         AppCDS.        ,       <code>-XX:SharedArchiveFile=work/classes.jsa</code>   <code>-Xshare:off</code>,    CDS .              ,    .</p><br>
<p><img src="https://habrastorage.org/webt/vq/4s/n6/vq4sn66zppmcyl5aovqj6xpkwyq.png"></p><br>
<p>      :</p><br>
<ul>
<li><p> PSS  AppCDS      CDS.<br>
         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  ,  ,    HelloWorld- JVM   CDS   2   ,   CDS.      PSS            CDS,     .        :</p><br>
</li>
<li><p>   PSS   AppCDS    2-  ; 3-      .<br>
       ,      ,    ,     .  ,        AppCDS,   ,   ,      3-    .<br>
 :    ,    CDS?      :</p><br>
</li>
<li><p>   CDS/AppCDS  JVM      ,  PSS       .  ,    ,      <code>pmap</code>,   “”   <code>sed</code>‘.              :</p><br>
<pre><code class="bash hljs">pmap -X `pgrep -f analog`<font></font>
14981: <span class="hljs-comment"># ...</span><font></font>
       Address Perm   Offset Device   Inode    Size    Rss    Pss ... Mapping<font></font>
  <span class="hljs-comment"># ...                                                               ...</span><font></font>
  7faf5e31a000 r-xp 00000000  08:03  269427   17944  14200  14200 ... libjvm.so<font></font>
  <span class="hljs-comment"># ...                                                               ...</span><font></font>
  7faf5f7f9000 r-xp 00000000  08:03 1447189    1948   1756     25 ... libc-2.27.so<font></font>
</code></pre><br>
<p>      (<code>Mapping</code>)  , “”      .       JVM  (<code>libjvm.so</code>   ),     (<code>libc-2.27.so</code>  ).    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>        :</p><br>
<blockquote>For the Java VM, the read-only parts of the loaded shared libraries (i.e. <code>libjvm.so</code>) can be shared between all the VM instances running at the same time. This explains why, taking together, the two VM’s consume less memory (i.e. have a smaller memory footprint) than the simple sum of their single resident set sizes when running alone.</blockquote><br>
</li>
</ul><br>
<p>          .     ,  , .  ,          ,         JVM     ,    Java-    .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>  GeekOut:</p><br>
<p><img src="https://habrastorage.org/webt/wp/ia/qo/wpiaqom-2teiw_iegjacskkt3sm.png"></p><br>
<p>, , ,      AppCDS    , ..     Java-.   ,             JVM,  , -      .</p><br>
<p>      VisualVM      Metaspace    AppCDS  ,      :</p><br>
<p><strong> AppCDS</strong></p><br>
<p><img src="https://habrastorage.org/webt/pt/wv/6r/ptwv6rmyk8j7f7yzgxrjkqrsvww.png"></p><br>
<p><strong> AppCDS</strong></p><br>
<p><img src="https://habrastorage.org/webt/dt/jn/0m/dtjn0mdpcgykbfynjbwdma2vmqm.png"></p><br>
<p>  ,         128     Metaspace   AppCDS    <code>64.2 MiB / 8.96 MiB</code> <strong>≈7,2  </strong>,   CDS .            (.  )       <code>66.4 MiB / 13.9 MiB</code> <strong>≈4,8 </strong>.      ,    AppCDS      ,       Metaspace.            Metaspace,    ,    CDS .</p><br>
<h2 id="vmesto-zaklyucheniya"> </h2><br>
<p>           Spring Boot  AppCDS –  JVM,        .</p><br>
<ul>
<li>           JEP-350 Dynamic CDS Archives –    JDK 13.</li>
<li>   Spring Boot  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ó</a>          CDS (  ). ,           100%   -   <strong>66%</strong>.      ,      <strong>≈11%</strong> (    15%,      ).</li>
<li>    ,       5-     PSS (      ).  ,  AppCDS     ,   <strong>  </strong>           , <strong> 8%</strong> (PSS).       ,    CDS,     ,     .        AppCDS  <strong> </strong>.</li>
<li>         Metaspace,  ,         AppCDS  <strong> 5  </strong>,   CDS.</li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もちろん、そのような結果から判断すると、AppCDSは、控えめに言っても「キラー機能」の称号に値しません。</font><font style="vertical-align: inherit;">ただし、その範囲は、Spring Bootのマイクロサービスに限定されるものではありません。</font><font style="vertical-align: inherit;">リソースを多く消費する他のアプリケーションでは、AppCDSが鋳鉄製ウォーカーをより機敏にすることができることを私は完全に認めます。</font><font style="vertical-align: inherit;">さらに、ここでは</font><font style="vertical-align: inherit;">、Spring Boot上の</font><font style="vertical-align: inherit;">多くの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なる</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションに</font><font style="vertical-align: inherit;">AppCDSを適用するためのオプションを考慮していなかったことを思い出します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私のプロジェクトでは、この道をたどり、興味深い特殊効果をたくさん見つけましたが、これは完全に異なるトピックです...</font></font></p><br>
<p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カバー写真</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニック・Fewings</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsplash</font></font></a></em></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472620/index.html">ミュージアムデータアート。Mera CM 7209ビデオ端末の検査</a></li>
<li><a href="../ja472622/index.html">職業データエンジニアのための平準化計画</a></li>
<li><a href="../ja472626/index.html">ASRock Z3​​90 Phantom Gaming 7マザーボードのレビュー：9900KSの準備</a></li>
<li><a href="../ja472628/index.html">PIL pythonを使用したエンコーディング、シフト暗号、ブルートハッシュ、画像作成。r0ot-mi Crytoによる問題解決。パート1</a></li>
<li><a href="../ja472636/index.html">DotNext 2019モスクワプログラムの概要：誰が何を教えてくれますか？</a></li>
<li><a href="../ja472640/index.html">スタートアップの成長を支援するために6年間で学んだこと</a></li>
<li><a href="../ja472642/index.html">フリーランスのwebdev-どのように、誰と一緒に作業する価値がないか</a></li>
<li><a href="../ja472644/index.html">国際企業でのインターンシップ：面接を埋めて切望されたオファーを取得しない方法</a></li>
<li><a href="../ja472650/index.html">テクニカルサポートに対する恐怖、痛み、憎しみ</a></li>
<li><a href="../ja472658/index.html">未来についてのほぼすべてHolyJS 2019モスクワ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>