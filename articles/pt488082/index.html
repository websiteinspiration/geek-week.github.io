<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêª ‚úãüèª üï¥üèæ Em poucas palavras: Async / Await Best Practices in .NET üôãüèæ üßôüèº üôãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antecipando o in√≠cio do curso, "C # Developer" preparou uma tradu√ß√£o de material interessante.
 
 
 
 Async / Await - Introdu√ß√£o
 A constru√ß√£o da ling...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Em poucas palavras: Async / Await Best Practices in .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/488082/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecipando o in√≠cio do curso, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"C # Developer"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> preparou uma tradu√ß√£o de material interessante.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/6f/io/l8/6fiol8vwkg-r8ja-3zurutnz-ci.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async / Await - Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A constru√ß√£o da linguagem Async / Await existe desde o C # vers√£o 5.0 (2012) e rapidamente se tornou um dos pilares da moderna programa√ß√£o .NET - qualquer desenvolvedor de C # que se preze deveria us√°-lo para melhorar o desempenho do aplicativo, a capacidade de resposta geral e a legibilidade do c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Async / Await simplifica a introdu√ß√£o de c√≥digos ass√≠ncronos e elimina a necessidade de o programador entender os detalhes de seu processamento, mas quantos de n√≥s realmente sabemos como ele funciona e quais s√£o as vantagens e desvantagens desse m√©todo? </font><font style="vertical-align: inherit;">H√° muitas informa√ß√µes √∫teis, mas s√£o fragmentadas, ent√£o decidi escrever este artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, ent√£o, vamos nos aprofundar no t√≥pico.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°quina de estado (IAsyncStateMachine)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que voc√™ precisa saber √© que sempre que voc√™ tem um m√©todo ou fun√ß√£o com o Async / Await, o compilador realmente transforma seu m√©todo em uma classe gerada que implementa a interface IAsyncStateMachine. Essa classe √© respons√°vel por manter o estado do seu m√©todo durante o ciclo de vida de uma opera√ß√£o ass√≠ncrona - encapsula todas as vari√°veis ‚Äã‚Äãdo seu m√©todo na forma de campos e divide seu c√≥digo em se√ß√µes que s√£o executadas durante transi√ß√µes de m√°quina de estado entre estados, para que o thread possa sair do m√©todo e quando retornar√°, o estado n√£o mudar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como exemplo, aqui est√° uma defini√ß√£o de classe muito simples com dois m√©todos ass√≠ncronos: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
using System.Threading.Tasks;</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System.Diagnostics;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AsyncAwait</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncAwait</span><font></font>
    {<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">int</span> myVariable = <span class="hljs-number">0</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After First Await"</span>);<font></font>
            myVariable = <span class="hljs-number">1</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After Second Await"</span>);<font></font>
            myVariable = <span class="hljs-number">2</span>;<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DummyAsyncMethod</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-comment">// </span><font></font>
        }<font></font>
<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma classe com dois m√©todos ass√≠ncronos</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Se observarmos o c√≥digo gerado durante a montagem, veremos algo assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/xe/63/qoxe63foidhmllsdwfi78tdhrsm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que temos 2 novas classes internas geradas para n√≥s, uma para cada m√©todo ass√≠ncrono. Essas classes cont√™m uma m√°quina de estado para cada um dos nossos m√©todos ass√≠ncronos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, tendo estudado o c√≥digo descompilado para </font></font><code><code>&lt;AsyncAwaitExample&gt;</code></code><code> d__0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, notamos que nossa vari√°vel interna </font></font><code>¬´myVariable¬ª</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agora </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">um campo de classe: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/_m/qj/gd_mqjxvsjfw9-_zfd7740n42ua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tamb√©m podemos ver outros campos de classe usados ‚Äã‚Äãinternamente para manter o estado </font></font><code>IAsyncStateMachine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A m√°quina de estados passa por estados usando o m√©todo</font></font><code>MoveNext()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de fato, um interruptor grande. </font><font style="vertical-align: inherit;">Observe como o m√©todo continua em se√ß√µes diferentes ap√≥s cada uma das chamadas ass√≠ncronas (com o r√≥tulo de continua√ß√£o anterior). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/li/ea/kmlieahswg0ebqn3db5nctfzsti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso significa que a eleg√¢ncia ass√≠ncrona / aguardada tem um pre√ßo. </font><font style="vertical-align: inherit;">O uso de async / waitit realmente adiciona alguma complexidade (da qual voc√™ talvez n√£o esteja ciente). </font><font style="vertical-align: inherit;">Na l√≥gica do servidor, isso pode n√£o ser cr√≠tico, mas, em particular, ao programar aplicativos m√≥veis que levam em considera√ß√£o cada ciclo de CPU e de mem√≥ria KB, lembre-se disso, pois a quantidade de sobrecarga pode aumentar rapidamente. </font><font style="vertical-align: inherit;">Posteriormente neste artigo, discutiremos as pr√°ticas recomendadas para usar o Async / Await somente quando necess√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para uma explica√ß√£o bastante instrutiva da m√°quina de estado, assista a este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo no YouTube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando usar o Async / Await</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, existem dois cen√°rios em que o Async / Await √© a solu√ß√£o certa.</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho relacionado √† E / S</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : seu c√≥digo espera algo, como dados de um banco de dados, leitura de um arquivo, chamada de um servi√ßo da web. </font><font style="vertical-align: inherit;">Nesse caso, voc√™ deve usar Async / Await, n√£o a Biblioteca Paralela de Tarefas.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho relacionado √† CPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : seu c√≥digo executar√° c√°lculos complexos. </font><font style="vertical-align: inherit;">Nesse caso, voc√™ deve usar Async / Await, mas precisa iniciar o trabalho em outro thread usando o Task.Run. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode considerar usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a Biblioteca Paralela de Tarefas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ass√≠ncrono todo o caminho</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao come√ßar a trabalhar com m√©todos ass√≠ncronos, voc√™ notar√° rapidamente que a natureza ass√≠ncrona do c√≥digo come√ßa a se espalhar pela hierarquia de chamadas - isso significa que voc√™ tamb√©m deve tornar o c√≥digo de chamada ass√≠ncrono e assim por diante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ficar tentado a "parar" isso bloqueando o c√≥digo usando Task.Result ou Task.Wait, convertendo uma pequena parte do aplicativo e envolvendo-o em uma API s√≠ncrona para que o restante do aplicativo fique isolado das altera√ß√µes. Infelizmente, esta √© uma receita para criar impasses dif√≠ceis de rastrear.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A melhor solu√ß√£o para esse problema √© permitir que o c√≥digo ass√≠ncrono cres√ßa naturalmente na base de c√≥digo. </font><font style="vertical-align: inherit;">Se voc√™ seguir esta decis√£o, ver√° a extens√£o do c√≥digo ass√≠ncrono em seu ponto de entrada, geralmente um manipulador de eventos ou uma a√ß√£o do controlador. </font><font style="vertical-align: inherit;">Renda-se √† assincronia sem deixar rastro! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais informa√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o m√©todo for declarado como ass√≠ncrono, certifique-se de que esteja aguardando!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como discutimos, quando o compilador encontra um m√©todo ass√≠ncrono, ele transforma esse m√©todo em uma m√°quina de estado. </font><font style="vertical-align: inherit;">Se o seu c√≥digo n√£o esperar no corpo, o compilador gerar√° um aviso, mas a m√°quina de estado ser√° criada, adicionando sobrecarga desnecess√°ria para uma opera√ß√£o que nunca ser√° conclu√≠da.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evitar vazio ass√≠ncrono</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O v√°cuo ass√≠ncrono √© algo que realmente deve ser evitado. </font><font style="vertical-align: inherit;">Torne uma regra usar a tarefa ass√≠ncrona em vez do vazio ass√≠ncrono.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os m√©todos async void e async Task</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Existem v√°rios motivos para isso, incluindo:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exce√ß√µes lan√ßadas no m√©todo ass√≠ncrono nulo n√£o podem ser capturadas fora deste m√©todo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></li>
</ul><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando uma exce√ß√£o √© lan√ßada do </font><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">Tarefa ass√≠ncrona ou Tarefa ass√≠ncrona </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, essa exce√ß√£o √© capturada e colocada no objeto Tarefa. </font><font style="vertical-align: inherit;">Ao usar m√©todos async void, o objeto Task est√° ausente; portanto, quaisquer exce√ß√µes lan√ßadas no m√©todo async void ser√£o chamadas diretamente no SynchronizationContext, que estava ativo quando o m√©todo async void foi iniciado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere o exemplo abaixo. </font><font style="vertical-align: inherit;">O bloco de captura nunca ser√° alcan√ßado.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThisWillNotCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        AsyncVoidMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span>(Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//     </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exce√ß√µes lan√ßadas no m√©todo async void n√£o podem ser capturadas fora deste</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
m√©todo.Compare com este c√≥digo, onde, em vez de async void, temos a tarefa ass√≠ncrona. </font><font style="vertical-align: inherit;">Nesse caso, a captura ser√° alcan√ß√°vel.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ThisWillCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-keyword">await</span> AsyncTaskMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//    </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A exce√ß√£o √© capturada e colocada no objeto Tarefa.</font></font></i><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os m√©todos ass√≠ncronos nulos podem causar efeitos colaterais indesejados se o chamador n√£o esperar que eles sejam ass√≠ncronos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : se o m√©todo ass√≠ncrono n√£o retornar nada, use a tarefa ass√≠ncrona (sem um " </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" para a tarefa) como tipo de retorno.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os m√©todos ass√≠ncronos nulos s√£o muito dif√≠ceis de testar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : devido a diferen√ßas no tratamento e layout de erros, √© dif√≠cil escrever testes de unidade que chamam m√©todos ass√≠ncronos nulos. </font><font style="vertical-align: inherit;">Teste Asynchronous MSTest s√≥ funciona para m√©todos ass√≠ncronos que retornam um Task ou Task </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma exce√ß√£o a essa pr√°tica s√£o manipuladores de eventos ass√≠ncronos. </font><font style="vertical-align: inherit;">Mas mesmo neste caso, √© recomend√°vel minimizar o c√≥digo escrito no pr√≥prio manipulador - espere um m√©todo de tarefa ass√≠ncrona que contenha l√≥gica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais informa√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preferir tarefa de retorno em vez de retorno aguardar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como j√° discutido, toda vez que voc√™ declara um m√©todo como ass√≠ncrono, o compilador cria uma classe de m√°quina de estado que realmente envolve a l√≥gica do seu m√©todo. Isso adiciona certas despesas gerais que podem se acumular, especialmente para dispositivos m√≥veis, onde temos limites de recursos mais rigorosos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, um m√©todo n√£o precisa ser ass√≠ncrono, mas retorna a Tarefa </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e permite que o outro lado o manipule adequadamente. Se a √∫ltima frase do seu c√≥digo for um retorno aguardado, considere refator√°-lo para que o tipo de retorno do m√©todo seja Tarefa </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(em vez de ass√≠ncrono T). </font><font style="vertical-align: inherit;">Por isso, voc√™ evita gerar uma m√°quina de estado, o que torna seu c√≥digo mais flex√≠vel. </font><font style="vertical-align: inherit;">O √∫nico caso que realmente queremos esperar √© quando fazemos algo com o resultado da tarefa ass√≠ncrona na continua√ß√£o do m√©todo.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">AsyncTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//  !</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">//await -   ,  await  </span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> GetData();<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">JustTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//!</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">// Task</span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preferir retornar tarefa em vez de retornar aguardar</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Observe que se n√£o tivermos aguardado e retornar a tarefa </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o retorno ocorrer√° imediatamente; portanto, se o c√≥digo estiver dentro de um bloco try / catch, a exce√ß√£o n√£o ser√° capturada. </font><font style="vertical-align: inherit;">Da mesma forma, se o c√≥digo estiver dentro do bloco using, ele excluir√° imediatamente o objeto. </font><font style="vertical-align: inherit;">Veja a pr√≥xima dica.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o coloque a tarefa de retorno dentro de try..catch {} ou usando {} blocos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Tarefa de Retorno pode causar comportamento indefinido quando usada dentro de um bloco try..catch (uma exce√ß√£o lan√ßada pelo m√©todo ass√≠ncrono nunca ser√° capturada) ou dentro de um bloco using, porque a tarefa ser√° retornada imediatamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ precisar agrupar seu c√≥digo ass√≠ncrono em uma tentativa .. captura ou usando o bloco, use return wait aguardar.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskExceptionNotCaught</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">try</span><font></font>
   {<font></font>
       <span class="hljs-comment">// ...</span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
   }<font></font>
   <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
<font></font>
   {<font></font>
       <span class="hljs-comment">//     </span><font></font>
<font></font>
       Debug.WriteLine(ex.Message);<font></font>
       <span class="hljs-keyword">throw</span>;<font></font>
   }<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskUsingProblem</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> resource = GetResource())<font></font>
   {<font></font>
<font></font>
       <span class="hljs-comment">// ...  ,     , ,    </span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData(resource);<font></font>
   }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o envolva a tarefa de retorno dentro de blocos </font></font><code>try..catch{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou</font></font><code>using{}</code></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais informa√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√≥pico sobre estouro de pilha.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evite usar </font></font><code>.Wait()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>.Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- use em vez disso</font></font><code>GetAwaiter().GetResult()</code></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisar bloquear a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espera pela conclus√£o da tarefa ass√≠ncrona, use </font></font><code>GetAwaiter().GetResult().</code> <code>Wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lance quaisquer exce√ß√µes </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que complica o tratamento de erros. </font><font style="vertical-align: inherit;">A vantagem </font></font><code>GetAwaiter().GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© que ele retorna a exce√ß√£o usual </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetAwaiterGetResultExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">// ,    ,     AggregateException  </span><font></font>
<font></font>
   <span class="hljs-keyword">string</span> data = GetData().Result;<font></font>
<font></font>
   <span class="hljs-comment">// ,   ,      </span><font></font>
<font></font>
   data = GetData().GetAwaiter().GetResult();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ precisar bloquear a espera pela conclus√£o da tarefa ass√≠ncrona, use as </font></font><code>GetAwaiter().GetResult().</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
informa√ß√µes adicionais neste </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o m√©todo for ass√≠ncrono, adicione o sufixo Async ao seu nome</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© a conven√ß√£o usada no .NET para distinguir mais facilmente m√©todos s√≠ncronos e ass√≠ncronos (com exce√ß√£o dos manipuladores de eventos ou m√©todos do controlador da web, mas eles ainda n√£o devem ser explicitamente chamados pelo seu c√≥digo).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os m√©todos de biblioteca ass√≠ncrona devem usar Task.ConfigureAwait (false) para melhorar o desempenho</font></font></h3><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O .NET Framework tem o conceito de um "contexto de sincroniza√ß√£o", que √© uma maneira de "voltar para onde voc√™ estava antes". Sempre que uma tarefa est√° aguardando, ela captura o contexto de sincroniza√ß√£o atual antes de aguardar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a conclus√£o da tarefa </font></font><code>.Post()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o </font><font style="vertical-align: inherit;">m√©todo de </font><font style="vertical-align: inherit;">contexto de sincroniza√ß√£o </font><font style="vertical-align: inherit;">√© chamado </font><font style="vertical-align: inherit;">, que retoma o trabalho de onde estava antes. Isso √© √∫til para retornar ao thread da interface do usu√°rio ou para o mesmo contexto do ASP.NET etc.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao escrever o c√≥digo da biblioteca, voc√™ raramente precisa voltar ao contexto em que estava antes. Quando Task.ConfigureAwait (false) √© usado, o c√≥digo n√£o tenta mais continuar de onde estava antes; em vez disso, se poss√≠vel, o c√≥digo sai no encadeamento que concluiu a tarefa, o que evita a altern√¢ncia de contexto. Isso melhora um pouco o desempenho e pode ajudar a evitar conflitos.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ConfigureAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//   ConfigureAwait(false)   .</span><font></font>
<font></font>
   <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">await</span> GetData().ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, use ConfigureAwait (false) para processos do servidor e c√≥digo da biblioteca. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© especialmente importante quando o m√©todo da biblioteca √© chamado um grande n√∫mero de vezes, para uma melhor capacidade de resposta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, use ConfigureAwait (false) para processos do servidor em geral. N√£o nos importamos com qual thread √© usado para continuar, ao contr√°rio dos aplicativos em que precisamos retornar ao thread da interface do usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora ... No ASP.NET Core, a Microsoft acabou com o SynchronizationContext, portanto, teoricamente, voc√™ n√£o precisa disso. Mas se voc√™ escrever um c√≥digo de biblioteca que possa ser reutilizado em outros aplicativos (por exemplo, aplicativo de interface do usu√°rio, ASP.NET herdado, Xamarin Forms), isso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continuar√° sendo uma pr√°tica recomendada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para uma boa explica√ß√£o desse conceito, assista a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este v√≠deo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relat√≥rio de andamento da tarefa ass√≠ncrona</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um caso de uso bastante comum para m√©todos ass√≠ncronos √© trabalhar em segundo plano, liberar o thread da interface do usu√°rio para outras tarefas e manter a capacidade de resposta. Nesse cen√°rio, conv√©m relatar o progresso de volta √† interface com o usu√°rio para que ele possa monitorar o progresso do processo e interagir com a opera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver esse problema comum, o .NET fornece a interface IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que fornece o m√©todo Report </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, invocado por uma tarefa ass√≠ncrona para relatar o progresso ao chamador. Essa interface √© aceita como um par√¢metro do m√©todo ass√≠ncrono - o chamador deve fornecer um objeto que implemente essa interface.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O .NET fornece o Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a implementa√ß√£o padr√£o do IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que √© realmente recomendada, pois lida com toda a l√≥gica de baixo n√≠vel associada ao salvamento e restaura√ß√£o do contexto de sincroniza√ß√£o. O Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamb√©m fornece um evento da A√ß√£o </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font><font style="vertical-align: inherit;">e um retorno de chamada </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ambos chamados quando uma tarefa relata o progresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juntos, o IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fornecem uma maneira f√°cil de transferir informa√ß√µes de progresso de uma tarefa em segundo plano para um thread da interface do usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por favor, note que </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser um valor simples, como um int, ou um objeto que forne√ßa informa√ß√µes contextuais sobre o progresso, como a porcentagem de conclus√£o, uma descri√ß√£o de cadeia de caracteres da opera√ß√£o atual, ETA e assim por diante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere com que frequ√™ncia voc√™ relata o progresso. </font><font style="vertical-align: inherit;">Dependendo da opera√ß√£o que voc√™ est√° executando, voc√™ pode descobrir que seus relat√≥rios de c√≥digo progridem v√°rias vezes por segundo, o que pode resultar na interface do usu√°rio se tornar menos responsiva. </font><font style="vertical-align: inherit;">Nesse cen√°rio, recomenda-se que o progresso seja relatado em intervalos maiores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais informa√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no blog oficial do Microsoft .NET.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cancelar tarefas ass√≠ncronas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro caso de uso comum para tarefas em segundo plano √© a capacidade de cancelar a execu√ß√£o. </font><font style="vertical-align: inherit;">O .NET fornece a classe CancellationToken. </font><font style="vertical-align: inherit;">O m√©todo ass√≠ncrono recebe o objeto CancellationToken, que √© ent√£o compartilhado pelo c√≥digo da parte que chama e pelo m√©todo ass√≠ncrono, fornecendo um mecanismo para sinalizar o cancelamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso mais comum, o cancelamento ocorre da seguinte maneira:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O chamador cria um objeto CancellationTokenSource.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O chamador chama a API ass√≠ncrona cancelada e passa o CancellationToken do CancellationTokenSource (CancellationTokenSource.Token).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O chamador solicita um cancelamento usando o objeto CancellationTokenSource (CancellationTokenSource.Cancel ()).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tarefa confirma o cancelamento e cancela a si mesma, geralmente usando o m√©todo CancellationToken.ThrowIfCancellationRequested.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que, para que esse mecanismo funcione, voc√™ precisar√° escrever um c√≥digo para verificar os cancelamentos solicitados em intervalos regulares (ou seja, a cada itera√ß√£o do seu c√≥digo ou em um ponto de interrup√ß√£o natural na l√≥gica). </font><font style="vertical-align: inherit;">Idealmente, ap√≥s uma solicita√ß√£o de cancelamento, a tarefa ass√≠ncrona deve ser cancelada o mais r√°pido poss√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ deve considerar desfazer todos os m√©todos que podem levar muito tempo para serem conclu√≠dos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais informa√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no blog oficial do Microsoft .NET.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relat√≥rio de andamento e cancelamento - exemplo</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> System.Windows.Forms;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">TestAsyncAwait</span><font></font>
{<font></font>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span> : <span class="hljs-title">Form</span><font></font>
   {<font></font>
       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span>(<span class="hljs-params"></span>)</span><font></font>
       {<font></font>
           InitializeComponent();<font></font>
       }<font></font>
<font></font>
       CancellationTokenSource _cts = <span class="hljs-keyword">new</span> CancellationTokenSource();<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnRunAsync_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-comment">//   .</span><font></font>
<font></font>
            &lt;<span class="hljs-keyword">int</span>&gt;   ,          ,   ,    , ETA  . .<font></font>
<font></font>
           <span class="hljs-keyword">var</span> progressIndicator = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-keyword">int</span>&gt;(ReportProgress);<font></font>
<font></font>
           <span class="hljs-keyword">try</span><font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">//   ,         </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> AsyncMethod(progressIndicator, _cts.Token);<font></font>
<font></font>
           }<font></font>
<font></font>
           <span class="hljs-keyword">catch</span> (OperationCanceledException ex)<font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">// </span><font></font>
<font></font>
               lblProgress.Text = <span class="hljs-string">"Cancelled"</span>;<font></font>
           }<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnCancel_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
          <span class="hljs-comment">// </span><font></font>
           _cts.Cancel();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReportProgress</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
<font></font>
       {<font></font>
           <span class="hljs-comment">//    </span><font></font>
<font></font>
           lblProgress.Text = <span class="hljs-keyword">value</span>.ToString();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncMethod</span>(<span class="hljs-params">IProgress&lt;<span class="hljs-keyword">int</span>&gt; progress, CancellationToken ct</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<font></font>
<font></font>
           {<font></font>
              <span class="hljs-comment">//   ,     </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (ct != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   ct.ThrowIfCancellationRequested();<font></font>
<font></font>
               }<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (progress != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   progress.Report(i);<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguardando um per√≠odo de tempo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ precisar esperar um pouco (por exemplo, tente novamente verificar a disponibilidade do recurso), use Task.Delay - nunca use Thread.Sleep nesse cen√°rio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguardando a conclus√£o de v√°rias tarefas ass√≠ncronas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use Task.WaitAny para aguardar a conclus√£o de qualquer tarefa. </font><font style="vertical-align: inherit;">Use Task.WaitAll para aguardar a conclus√£o de todas as tarefas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preciso me apressar para mudar para C # 7 ou 8? </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inscreva-se em um semin√°rio on</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">line gratuito</font></a><font style="vertical-align: inherit;"> para discutir este t√≥pico.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt488060/index.html">Backblaze - estat√≠sticas do disco r√≠gido de 2019</a></li>
<li><a href="../pt488062/index.html">Meetup sobre Dynamics 365 & Power Platform em Lamoda - Relat√≥rio</a></li>
<li><a href="../pt488064/index.html">Sete raz√µes pelas quais o Linux</a></li>
<li><a href="../pt488072/index.html">A inje√ß√£o de depend√™ncia de Koin ou o localizador de servi√ßo?</a></li>
<li><a href="../pt488078/index.html">Meu bot para a Copa AI AI 2019</a></li>
<li><a href="../pt488088/index.html">Como Habr interage com √≥rg√£os estaduais e outros candidatos. Relat√≥rio de transpar√™ncia para todos os anos</a></li>
<li><a href="../pt488092/index.html">Hackathons. Como tirar o m√°ximo proveito e sobreviver</a></li>
<li><a href="../pt488096/index.html">400g. Vista do lado da transmiss√£o. ZR / ZR +</a></li>
<li><a href="../pt488098/index.html">Como criar um projeto Django a partir de um modelo</a></li>
<li><a href="../pt488102/index.html">O relacionamento entre C # e C #: REST, gRPC e tudo mais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>