<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÄ üôåüèø üîï Investigation of information security incidents in the wild: unexpected sources of information üì≠ ‚õπüèæ üç±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A lot has been written about the investigation of computer incidents, or Digital Forensics, there are many ready-made hardware and software tools, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Investigation of information security incidents in the wild: unexpected sources of information</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/504866/"><img src="https://habrastorage.org/webt/s2/dt/2e/s2dt2etmktuybpbmavpncacs0y4.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lot has been written about the investigation of computer incidents, or Digital Forensics, there are many ready-made hardware and software tools, the main artifacts of operating systems are well known and described in manuals, books and articles. </font><font style="vertical-align: inherit;">It would seem that it‚Äôs difficult - read the manual and find the required. </font><font style="vertical-align: inherit;">But there are technically difficult cases when the analysis of those very well-known artifacts does not provide enough information to restore the chronology of events. </font><font style="vertical-align: inherit;">How to be in this situation? </font><font style="vertical-align: inherit;">We analyze it with real examples of our investigations.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is there a general lack of basic artifacts? </font><font style="vertical-align: inherit;">There may be several reasons:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The infrastructure is not adequately prepared for full monitoring and response to events (we </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about this </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">here</font></a><font style="vertical-align: inherit;"> )</font></font></li>
<li>  ,      (        Digital Forensic)</li>
<li>   ,        ( ‚Äì   ,  MFT-).</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, if the infrastructure is large and diverse, the incident developed for a long time, and the attacker is a ‚Äúshredded kalach,‚Äù additional sources of information are needed to disclose all its actions and restore the chronology of events. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on the situation, SIEM systems, analysis of Netflow network flows or raw traffic (although in reality in 90% of cases this is not possible), as well as unusual artifacts that relate to any third-party software, by coincidence, may come to the rescue. in the customer‚Äôs infrastructure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is on the last type of artifacts that we will stop.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivanti Endpoint Manager (formerly LANDESK Management Suite). </font><font style="vertical-align: inherit;">IT Asset Management System</font></font></h2><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.ivanti.ru/company/history/landesk</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Connecting to the monitoring of one of our new customers, we detected in his infrastructure the cleaning of event logs on one of the servers, while there were no other manifestations of malicious activity in the SIEM system. </font><font style="vertical-align: inherit;">During the analysis, it was found that the server was compromised, and the attacker used special equipment to go unnoticed. </font><font style="vertical-align: inherit;">It consisted of the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Security log events were redirected to a separate temporary file,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an attacker performed the necessary actions,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">events are redirected back to the Security log,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporary file was deleted. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profit!</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, despite the fact that the Security journal was set up appropriately, it did not contain any events related to malicious activity, while it itself looked untouched. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a short analysis, we found out that the attacker has been ‚Äúliving‚Äù in the infrastructure for about 2-3 years, which made it possible to compromise all key servers. In such cases, the value of any additional sources of information increases, since some basic artifacts are either frayed or uninformative and do not allow a complete picture of the incident. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In search of additional sources of information, we conducted an oral inventory of services and systems used in the infrastructure and found that, together with the implementation of our monitoring, the customer began to deploy an IT asset management system</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ivanti Endpoint Manager. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the system was still unstable (events from agents were not partially sent </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
to the server), we were unable to centrally view events from the hosts on the server. </font><font style="vertical-align: inherit;">Nevertheless, having decided to search for artifacts stored by Ivanti Endpoint directly on the host, we found that this software stores information about process launches locally in the following registry branch: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HKLM \ SOFTWARE \ Wow6432Node] \ LANDesk \ ManagementSuite \ WinClient \ SoftwareMonitoring \ MonitorLog \ &lt; The path to the executable file&gt; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following information is stored in the corresponding keys:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first start time (in FILETIME format)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last run time (in FILETIME format)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of starts</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user with rights of which the executable file was launched</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/d5/5v/1l/d55v1lxgs3s3m4-6w7ak6gwu_we.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivanti Endpoint process launch artifacts</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Thanks to this information, we were able to determine the time of the attacker's appearance on some systems that we did not know about before. </font><font style="vertical-align: inherit;">In addition, part of his toolkit was disclosed based solely on the name of executable files.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Citrix NetScaler </font><font style="vertical-align: inherit;">System for providing access to corporate resources and applications</font></font></h2><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.citrix.com/en-us/products/citrix-adc </font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/ik/h_/-8/ikh_-8o-xps_finxi99cfpobtka.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Citrix NetScaler Workflow</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Another interesting investigation. An attacker entered the company‚Äôs infrastructure through a VPN. He worked in the UTC +8 time zone. After authentication, it behaved quite aggressively (actively scanned internal subnets using the mask / 24 and / 16), as a result of which, in fact, it was noticed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The VPN was configured on the Citrix NetScaler Enterprise Resource and Application System. Having studied its logs, we were able to establish the time of the first ‚Äúvisit‚Äù (read the date of compromise), the accounts of employees used by the attacker (by the way, more than 5 accounts were compromised) and the IP addresses of the proxy servers from which he worked.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The investigation itself ended successfully: we managed to establish a source of compromise - it turned out that the internal system for resetting credentials accessible from the Internet was subject to SQL injection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But now I want to note something else: after passing VPN authentication on Citrix NetScaler, all HTTP user requests were successfully logged. The attacker probably either did not know this, or confused his network interfaces and sent his own queries to search engines through the customer‚Äôs corporate network. This allowed us to obtain information about the systems of interest to the attacker, his competencies and the tools used. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/69/bp/c1/69bpc1it9-vmhkz7q4pycfi5l-y.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Citrix NetScaler log file </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/e4/ch/gq/e4chgqzsitxeughcu7tthlr82hg.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information that an attacker was looking for through Citrix NetScaler </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/mr/h4/4t/mrh44tahsirj75jhah7pvtki0x8.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information that an attacker was looking for through Citrix NetScaler</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secret Net Studio. </font><font style="vertical-align: inherit;">System for protecting information from unauthorized access</font></font></h2><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.securitycode.ru/products/secret_net</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
One fine day, a ticket with an suspicious authentication incident fell on our first line under the account of an IT employee of the company on the administration server at night (the employee was on vacation at that time, he had a VPN did not have). </font><font style="vertical-align: inherit;">Architecturally, the administration server was located in a separate network segment along with several other key servers of the company (including the Secret Net server), and events to our SIEM were received only from the administration server itself (unfortunately, customers do not always agree to connect all potential sources )</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first line, processing the ticket and collecting information about what happened after the authentication, stumbles upon various suspicious process launches (non-standard paths, binary file names in one letter) and mstsc.exe launch, indicating a possible RDP session. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizing that this was a potential compromise, we requested images of all servers</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and began their analysis. Opening the first image (Secret Net server), we received a ‚Äúbig surprise‚Äù as a present: the System, Security, and Application logs were deleted, and removed so that even recovery attempts were unsuccessful. It was only possible to compare that the entries in the SecretS server TerminalServices logs coincided in time with the launch of mstsc.exe on the administration server, which means that the attacker was definitely on Secret Net. Analysis of the remaining servers also failed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we found ourselves in a situation where it is known for certain that the attacker is there (he definitely did and started something), but we don‚Äôt have host logs, because the traces are deleted, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and there are no network logs, because all the servers are on the same subnet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solution was found even from this situation. </font><font style="vertical-align: inherit;">The Secret Net system is very versatile and consists of many components, both kernel level and user level. </font><font style="vertical-align: inherit;">After analyzing each log file recorded and saved by various components of Secret Net, we came across several excellent artifacts left by file control. </font><font style="vertical-align: inherit;">When we put everything together, we got information about the actions of the attacker (he really was on every server from this subnet), and about his tools. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, the information received helped to completely get rid of the presence of an attacker in the infrastructure. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/le/sq/umlesq3ecnv0qstpziczebig6pe.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme of an attacker working through the Secret Net Studio server Secret </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">Log </font></i><i><font style="vertical-align: inherit;">Studio </font></i></font><br>
<br>
<img src="https://habrastorage.org/webt/ob/xe/uw/obxeuw6fn5wskcu3smvvqoylmm4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file control file</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVRT. </font><font style="vertical-align: inherit;">Free antivirus tool</font></font></h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.kaspersky.ru/downloads/thank-you/free-virus-removal-tool</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We were contacted for help in investigating an incident related to outgoing malicious activity (botnet and miner activity) from the public addresses of the company. Having received the images and logs of the system, we began the analysis and found some artifacts indicating a compromise of the organization‚Äôs public web service and the malicious files left. Unfortunately, this was not enough to answer all the questions asked by the customer: among other things, we did not find file traces of the miner, although there was not much time between fixing malicious activity and our investigation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returning once again to the artifacts and logs, we drew attention to the traces of several free antivirus scanners. It became clear that the files we were missing were encrypted and quarantined, and the timestamps of the file system were safely erased. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Among the scanners used was KVRT, which detected some malicious files and quarantined them. The standard location of quarantine files is C: \ KVRT_Data \ Quarantine, and decrypting them is very easy: a simple XOR with a well-known key is e2 45 48 ec 69 0e 5c ac. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cp/ay/uk/cpayuky5cibup6sdzzcsbzjq9qg.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decrypted KVRT quarantine</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As it turned out later, the IT administrator still managed to scan the system with free antivirus scanners before our arrival, despite the recommendation not to touch anything.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, quarantined files helped close gaps in the chronology of events and answer all questions.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each investigation is always something unusual, unique and versatile. </font><font style="vertical-align: inherit;">Yes, there are known artifacts of operating systems, but before the investigation begins, it is difficult to predict the completeness of the information that can be obtained after their analysis. </font><font style="vertical-align: inherit;">Therefore, before a technical investigation of the incident, we recommend that you take an inventory of the software and systems and not be lazy to study them as a possible source in the investigation.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504854/index.html">Outer Join at LINQ</a></li>
<li><a href="../en504856/index.html">Top 10 Reasons to Switch to Oracle Cloud How can businesses accelerate innovation?</a></li>
<li><a href="../en504858/index.html">The heroine of ‚ÄúProfessions of the Future‚Äù shared her thoughts on Russian education</a></li>
<li><a href="../en504860/index.html">24 dataset for retail and ecommerce</a></li>
<li><a href="../en504864/index.html">How to write and send a resume. Instructions for beginners</a></li>
<li><a href="../en504868/index.html">Home Internet Gateway. Initial setup of a 6-port minicomputer on Ubuntu Server 20.04 LTS</a></li>
<li><a href="../en504878/index.html">109 free courses in Data Science</a></li>
<li><a href="../en504880/index.html">Development, optimization and release of Synthety games on Unity</a></li>
<li><a href="../en504884/index.html">Dangerous Peripherals: Understanding Thunderspy</a></li>
<li><a href="../en504886/index.html">Selenium WebDriver at the service of the developer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>