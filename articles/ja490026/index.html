<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌅 👊🏻 🦐 Elasticsearchがデータを整理する方法：データの共有、クリーニング、バックアップ 🏣 ☦️ ✊🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事は、Elasticsearchに保存されたログを分割する問題にどのように遭遇したかについての実用的な話です。そのため、バックアップとインデックス管理へのアプローチを変更する必要がありました。
 
 
 
 本番環境が立ち上がった直後にすべてが始まりました。「戦闘」のKubernetesクラス...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Elasticsearchがデータを整理する方法：データの共有、クリーニング、バックアップ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/490026/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は、Elasticsearchに保存されたログを分割する問題にどのように遭遇したかについての実用的な話です。そのため、バックアップとインデックス管理へのアプローチを変更する必要がありました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5s/wo/w2/5swow2bqxoliv36e1r3eaboz-ym.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本番環境が立ち上がった直後にすべてが始まりました。</font><font style="vertical-align: inherit;">「戦闘」のKubernetesクラスターがあり、fluentdが収集してログに直接送信したすべてのログ</font></font><code>logstash-yyy.mm.dd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><a name="habracut"></a><br>
<br>
<img src="https://habrastorage.org/webt/rm/uc/ce/rmuccezpyhbhaalkmv-n4dfc4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、一部のアプリケーションログを最大90日間検索するためのリクエストが表示されました。</font><font style="vertical-align: inherit;">当時、私たちはこれを買う余裕がありませんでした。そのような期間の現在のインデックスの保存は、すべての合理的な対策を超えるでしょう。</font><font style="vertical-align: inherit;">そのため、そのようなアプリケーション用に個別のインデックスパターンを作成し、それに対して個別の保持を構成することが決定されました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログの分離</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなタスクを達成するためにし、「不要」なものから「必要」のログを分離するために、我々は使用</font></font><code>match</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluentd </font><font style="vertical-align: inherit;">パラメータを</font><font style="vertical-align: inherit;">し、内の別のセクション作成した</font></font><code>output.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前空間に必要なサービスの基に検索を</font></font><code>production</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タグ付けに応じて、入力プラグイン（とも変更するために指定</font></font><code>@id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>logstash_prefix</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そう別の場所に録音を送信します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果のフラグメント</font></font><code>output.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;match kubernetes.var.log.containers.**_production_**&gt;<font></font>
      @id elasticsearch1<font></font>
      @type elasticsearch<font></font>
      logstash_format true<font></font>
      logstash_prefix log-prod<font></font>
     ...<font></font>
&lt;/match&gt;<font></font>
&lt;match kubernetes.**&gt;<font></font>
      @id elasticsearch<font></font>
      @type elasticsearch<font></font>
      logstash_format true<font></font>
      logstash_prefix logstash<font></font>
     ...<font></font>
&lt;/match&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論-2つのタイプのインデックス（</font></font><code>log-prod-yyyy.mm.dd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>logstash-yyyy.mm.dd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が</font><font style="vertical-align: inherit;">あります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pd/ew/n2/pdewn2hdkj-d0rzxnn1g0tc9bpo.png"><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスのクリーニング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その時点で</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キュレーター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はすでにクラスター</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">構成されており</font><font style="vertical-align: inherit;">、14日より古いインデックスをクリアしました。</font><font style="vertical-align: inherit;">Kubernetesクラスターに直接デプロイするCronJobオブジェクトとして説明されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
のイラスト</font></font><code>action_file.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">-<font></font>
    actions:<font></font>
      1:<font></font>
        action: delete_indices<font></font>
        description: &gt;-<font></font>
          Delete indices older than 14 days (based on index name), for logstash-<font></font>
          prefixed indices. Ignore the error if the filter does not result in an<font></font>
          actionable list of indices (ignore_empty_list) and exit cleanly.<font></font>
        options:<font></font>
          ignore_empty_list: True<font></font>
          timeout_override:<font></font>
          continue_if_exception: False<font></font>
          disable_action: False<font></font>
          allow_ilm_indices: True<font></font>
        filters:<font></font>
        - filtertype: pattern<font></font>
          kind: prefix<font></font>
          value: logstash<font></font>
        - filtertype: age<font></font>
          source: name<font></font>
          direction: older<font></font>
          timestring: '%Y.%m.%d'<font></font>
          unit: days<font></font>
          unit_count: 14</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、キュレーターを使用するオプションは冗長であると判断しました（個別のソフトウェアとして実行され、個別の設定とクラウンによる起動が必要です）。結局のところ、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスライフサイクルポリシー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してクリーニングをやり直すことができ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticsearchバージョン6.6 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2019年1月にリリースされた）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以降、インデックスの保存時間を追跡するポリシーをインデックステンプレートに添付できるようになりました。</font><font style="vertical-align: inherit;">ポリシーを使用して、クリーンアップを制御するだけでなく、インデックスとの対話を簡素化する他のタスク（たとえば、日ごとではなくサイズごとにインデックスを調整する）も使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、この種類のポリシーを2つ作成するだけで済みました。</font></font><br>
<br>
<pre><code class="json hljs">PUT _ilm/policy/prod_retention<font></font>
{<font></font>
    <span class="hljs-attr">"policy"</span> : {
      <span class="hljs-attr">"phases"</span> : {
        <span class="hljs-attr">"delete"</span> : {
          <span class="hljs-attr">"min_age"</span> : <span class="hljs-string">"90d"</span>,
          <span class="hljs-attr">"actions"</span> : {
            <span class="hljs-attr">"delete"</span> : { }<font></font>
          }<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
PUT _ilm/policy/default_retention<font></font>
{<font></font>
    <span class="hljs-attr">"policy"</span> : {
      <span class="hljs-attr">"phases"</span> : {
        <span class="hljs-attr">"delete"</span> : {
          <span class="hljs-attr">"min_age"</span> : <span class="hljs-string">"14d"</span>,
          <span class="hljs-attr">"actions"</span> : {
            <span class="hljs-attr">"delete"</span> : { }<font></font>
          }<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...そしてそれらを必要なインデックステンプレートに添付します。</font></font><br>
<br>
<pre><code class="json hljs">PUT _template/log_prod_template<font></font>
{<font></font>
  <span class="hljs-attr">"index_patterns"</span>: [<span class="hljs-string">"log-prod-*"</span>],                 
  <span class="hljs-attr">"settings"</span>: {
    <span class="hljs-attr">"index.lifecycle.name"</span>: <span class="hljs-string">"prod_retention"</span>,        <font></font>
  }<font></font>
}<font></font>
PUT _template/default_template<font></font>
{<font></font>
  <span class="hljs-attr">"index_patterns"</span>: [<span class="hljs-string">"logstash-*"</span>],                 
  <span class="hljs-attr">"settings"</span>: {
    <span class="hljs-attr">"index.lifecycle.name"</span>: <span class="hljs-string">"default_retention"</span>,        <font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、Elasticsearchクラスターがデータストレージを個別に管理します。</font><font style="vertical-align: inherit;">つまり、</font></font><code>index_patterns</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記</font><font style="vertical-align: inherit;">のテンプレートに該当するすべてのインデックス</font><font style="vertical-align: inherit;">は、ポリシーで指定された日数が経過すると消去されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ここで私たちは別の問題に直面しています...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター内およびリモートクラスターからのインデックス再作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成したfluentdで作成したポリシー、パターン、変更は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、新しく作成されたインデックスにのみ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影響</font><b><font style="vertical-align: inherit;">します</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">すでにあるものを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するには、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Reindex APIに</font></a><font style="vertical-align: inherit;">連絡して、再インデックスプロセスを開始する必要があり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポリシーが適用されるように、すでに閉じられているインデックスから「必要な」ログを選択し、それら自体を再インデックスする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これには2つの単純なクエリで十分です。</font></font><br>
<br>
<pre><code class="json hljs">POST _reindex<font></font>
{<font></font>
  <span class="hljs-attr">"source"</span>: {
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"logstash-2019.10.24"</span>,
    <span class="hljs-attr">"query"</span>: {
      <span class="hljs-attr">"match"</span>: {
        <span class="hljs-attr">"kubernetes.namespace_name"</span>: <span class="hljs-string">"production"</span><font></font>
      }<font></font>
    }<font></font>
  },<font></font>
  <span class="hljs-attr">"dest"</span>: {
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"log-prod-2019.10.24"</span><font></font>
  }<font></font>
}<font></font>
<font></font>
POST _reindex<font></font>
{<font></font>
  <span class="hljs-attr">"source"</span>: {
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"logstash-2019.10.24"</span>
    <span class="hljs-string">"query"</span>: {
      <span class="hljs-attr">"bool"</span>: { 
        <span class="hljs-attr">"must_not"</span>: {
          <span class="hljs-attr">"match"</span>: {
            <span class="hljs-attr">"kubernetes.namespace_name"</span>: <span class="hljs-string">"production"</span><font></font>
           }<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  },<font></font>
  <span class="hljs-attr">"dest"</span>: {
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"logstash-2019.10.24-ri"</span><font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで古いインデックスを削除できます！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、他にも問題があります。すでに知られているように、キュレーターは以前に構成され、14日間の保持でクラスターをクリーンアップしました。したがって、私たちに関連するサービスの場合、一度削除されたものからデータを復元する必要があります。バックアップはここで役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちに当てはまる最も単純なケースでは、バックアップは</font></font><code>elasticdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのインデックスを一度に</font><font style="vertical-align: inherit;">呼び出すことによって行われ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="bash hljs">/usr/bin/elasticdump --all <span class="hljs-variable">$OPTIONS</span> --input=http://localhost:9200 --output=$</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生産開始からのすべてを拡大することは不可能でした。</font><font style="vertical-align: inherit;">クラスターにはそれほど多くのスペースがありませんでした。</font><font style="vertical-align: inherit;">さらに、バックアップからログへのアクセスが必要になりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策は</font><font style="vertical-align: inherit;">、バックアップが復元される</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一時的なクラスター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">展開する</font></b><font style="vertical-align: inherit;">ことです。</font><font style="vertical-align: inherit;">そこから、必要なログを取得します（すでに説明したのと同様の方法で）。</font><font style="vertical-align: inherit;">並行して、バックアップの削除をより便利な方法にする方法について考え始めました。詳細については、以下を参照してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、次の手順（一時的なクラスター上）：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 十分に大きいディスクを持つ別のサーバーに別のElasticsearchをインストールします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ダンプファイルからバックアップを展開します。</font></font><br>
<br>
<pre><code class="bash hljs">/usr/bin/elasticdump --bulk --input=dump.json --output=http://127.0.0.1:9200/</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタ内のインデックスは緑色にならないことに注意してください。</font><font style="vertical-align: inherit;">ダンプを1ノード構成に転送します。</font><font style="vertical-align: inherit;">しかし、これを心配する価値はありません。主なことは、原始破片のみを引き出すことです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リモートクラスタからインデックスを再作成できるようにするには、それらを次のホワイトリストに追加する必要があることを忘れないでください</font></font><code>elasticsearch.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">reindex.remote.whitelist: 1.2.3.4:9200</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、現在の本番クラスターのリモートクラスターからインデックスの再作成をリクエストします。</font></font><br>
<br>
<pre><code class="json hljs">POST _reindex<font></font>
{<font></font>
  <span class="hljs-attr">"source"</span>: {
    <span class="hljs-attr">"remote"</span>: {
      <span class="hljs-attr">"host"</span>: <span class="hljs-string">"http://1.2.3.4:9200"</span><font></font>
    },<font></font>
    <span class="hljs-attr">"size"</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"logstash-2019.10.24"</span>,
    <span class="hljs-attr">"query"</span>: {
      <span class="hljs-attr">"match"</span>: {
        <span class="hljs-attr">"kubernetes.namespace_name"</span>: <span class="hljs-string">"production"</span><font></font>
      }<font></font>
    }<font></font>
  },<font></font>
  <span class="hljs-attr">"dest"</span>: {
    <span class="hljs-attr">"index"</span>: <span class="hljs-string">"log-prod-2019.10.24"</span><font></font>
  }<font></font>
}</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリクエストにより、ネットワークを介して本番クラスターに送信されるリモートクラスタードキュメントのインデックスから取得します。</font><font style="vertical-align: inherit;">一時クラスターの側では、リクエストに適さないすべてのドキュメントがフィルターされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータ</font></font><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、インデックスの再作成プロセスを高速化するために使用されます。</font></font><br>
<br>
<ul>
<li> <code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -パッケージで転送されるインデックス作成用のドキュメントの数を増やす。</font></font></li>
<li> <code>slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-このタスクを6つのサブタスクに分割し、並行してインデックスの再作成を行います。</font><font style="vertical-align: inherit;">（このパラメーターは、リモートクラスターからのインデックス再作成では機能しません）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストElasticsearchでは、最大のパフォーマンスが得られるようにインデックステンプレートを調整しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なすべてのログが1つの場所にあり、必要に応じて完全に分割されている場合は、一時クラスターを削除できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/9y/xo/4m9yxo7bcko3dslumlqgfeg0ufa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elasticsearchのバックアップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックアップに戻るときが来まし</font></font><code>elasticdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た。すべてのインデックスで</font><font style="vertical-align: inherit;">実行</font><font style="vertical-align: inherit;">することは、最善のソリューションとはほど遠いものです。</font><font style="vertical-align: inherit;">少なくとも、回復には適切な時間がかかる場合があり、1時間ごとが重要になる場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなタスクは、Elasticsearch自体に「与える」ことができます-S3に</font><font style="vertical-align: inherit;">基づく</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショットリポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、私たち自身がこのアプローチを選択した主な理由は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Elasticsearchへのクエリのネイティブ構文が使用されるため、このようなバックアップの作成と復元の利便性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショットは段階的にロールされます。</font><font style="vertical-align: inherit;">既存のデータに新しいデータを追加する。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> スナップショットからインデックスを復元し、クラスターのグローバルな状態を復元する機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S3は、単なるファイルよりもバックアップを保存するための信頼性の高い場所のようです（通常、HAモードでS3を使用する理由を含みます）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S3の移植性：特定のプロバイダーに縛られることなく、S3を独自の新しい場所に展開できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S3でバックアップを設定するには、スナップショットリポジトリがS3と通信できるように、Elasticsearchにプラグインを追加インストールする必要があります。</font><font style="vertical-align: inherit;">全体の構成は、次の手順で行われます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> すべてのノードにS3のプラグインをインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">bin/elasticsearch-plugin install repository-s3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...同時にS3をホワイトリストに追加し</font></font><code>elasticsearch.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます：</font></font><br>
<br>
<pre><code class="plaintext hljs">    Repositories.url.allowed_urls:<font></font>
- "https://example.com/*"</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー</font></font><code>SECRET</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font><code>ACCESS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elasticsearchキーストアに</font><font style="vertical-align: inherit;">追加し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">デフォルトでは、ユーザーはS3への接続に使用されます</font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">bin/elasticsearch-keystore add s3.client.default.access_key<font></font>
bin/elasticsearch-keystore add s3.client.default.secret_key</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...その後、すべてのノードでElasticsearchサービスを1つずつ再起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> スナップショット用のリポジトリを作成します。</font></font><br>
<br>
<pre><code class="json hljs">PUT /_snapshot/es_s3_repository<font></font>
{<font></font>
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"s3"</span>,
  <span class="hljs-attr">"settings"</span>: {
    <span class="hljs-attr">"bucket"</span>: <span class="hljs-string">"es-snapshot"</span>,
    <span class="hljs-attr">"region"</span>: <span class="hljs-string">"us-east-1"</span>,
    <span class="hljs-attr">"endpoint"</span>: <span class="hljs-string">"https://example.com"</span><font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、スナップショットを作成するために、スナップショット</font><font style="vertical-align: inherit;">の名前が​​次の形式になる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントからの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十分な</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">例</font></a><font style="vertical-align: inherit;">があり</font></font><code>snapshot-2018.05.11</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="json hljs">PUT /_snapshot/my_backup/%<span class="hljs-number">3</span>Csnapshot-%<span class="hljs-number">7</span>Bnow%<span class="hljs-number">2</span>Fd%<span class="hljs-number">7</span>D%<span class="hljs-number">3</span>E</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> インデックスの復元をテストするだけです。</font></font><br>
<br>
<pre><code class="json hljs">POST /_snapshot/es_s3_repository/snapshot<span class="hljs-number">-2019.12</span><span class="hljs-number">.30</span>/_restore<font></font>
{<font></font>
  <span class="hljs-attr">"indices"</span>: <span class="hljs-string">"logstash-2019.12.29"</span>,
  <span class="hljs-attr">"rename_pattern"</span>: <span class="hljs-string">"logstash-(.+)"</span>,
  <span class="hljs-attr">"rename_replacement"</span>: <span class="hljs-string">"restored_index_$1"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、「次の」インデックスを復元し、名前を変更するだけです。</font><font style="vertical-align: inherit;">ただし、同じインデックスに復元することができます。これを行うには、クラスター内のインデックスが閉じていて、スナップショット内のインデックスと同じ数のシャードを持っている必要があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スナップショットの削除ステータスは、APIを介して名前で確認でき、スナップショット情報を呼び出してフィールドを確認できます</font></font><code>state</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="json hljs">GET /_snapshot/es_s3_repository/snapshot_2019<span class="hljs-number">.12</span><span class="hljs-number">.30</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リカバリステータスはクラスタ自体から確認できます。リカバリの開始時に、クラスタはstatus </font></font><code>red</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">なります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">インデックスのプライマリシャードが復元されます。</font><font style="vertical-align: inherit;">プロセスが完了するとすぐに</font></font><code>yellow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、指定された数のレプリカが作成されるまで、</font><font style="vertical-align: inherit;">インデックスとクラスターがステータスになります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">クエリ行に直接示され</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ているヘルプ</font></font><code>wait_for_completion=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">して、ステータスを追跡することもでき</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果-作成されたスナップショットからインデックスの正確なコピーを取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">green open restored_index_2019.12.29    eJ4wXqg9RAebo1Su7PftIg 1 1 1836257 0   1.9gb 1000.1mb<font></font>
green open logstash-2019.12.29          vE8Fyb40QiedcW0k7vNQZQ 1 1 1836257 0   1.9gb 1000.1mb</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まとめと欠点</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticsearchクラスターにおける最適なソリューションは次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fluentdで出力プラグインを構成すると、クラスターの出口で直接ログを共有できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> インデックスのライフサイクルポリシー。インデックスによって占有されているスペースの問題を心配する必要がありません。 </font></font></li>
<li>     snapshot repository (   ),         S3,    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ニーズの変化によるポリシーとテンプレートの変更により、クラスター内のすべてのインデックスのインデックスを再作成する必要があることに注意してください。バックアップを使用すると、画像は理想からさらに遠くなります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックアップをElasticsearch自体に「引き渡した」という事実にもかかわらず、スナップショットの削除を起動し、その実装を監視することは、私たちの仕事のままです：APIへのアクセス、（に</font></font><code>wait_for_completion</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よる）</font><font style="vertical-align: inherit;">ステータスの追跡、</font><font style="vertical-align: inherit;">および</font><font style="vertical-align: inherit;">ステータスごとの</font><font style="vertical-align: inherit;">スクリプトを使用して自分で作成します。便利なことに、バックアップリポジトリには別の問題があります。プラグインが少なすぎることです。たとえば、S3の代わりに完全にシンプルなものを必要とする場合、モバイルと同様にWebDAVを介して作業する方法はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、このシステムの分離は、バックアップに対する集中型のアプローチの使用にはあまり適しておらず、これを可能にするユニバーサルツール（オープンソースツールの中でも）はまだ見つかっていません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日だけでなくKubernetesのログ：期待と現実</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K8sのRedisオペレーターと、このデータベースからのデータを分析するためのユーティリティのミニオーバービュー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのSRE-日常生活からの6つの実用的な物語</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。」</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja490014/index.html">プロのようなJavaScriptツリーの揺れ</a></li>
<li><a href="../ja490018/index.html">片手でモバイルアプリケーションを設計する方法</a></li>
<li><a href="../ja490020/index.html">PVS-Studioの例によるIT分野での英語への翻訳</a></li>
<li><a href="../ja490022/index.html">PowerShellを使用してREST APIを操作する</a></li>
<li><a href="../ja490024/index.html">PhpStormプラグインでルーチンを取り除く</a></li>
<li><a href="../ja490028/index.html">検索と評価：候補者のための検索と評価ツール</a></li>
<li><a href="../ja490032/index.html">主なものに関する古い曲：なぜバックアップが必要なのか、ここでHPE StoreOnceがどのように役立つのか</a></li>
<li><a href="../ja490034/index.html">RaffeisenbankでのML REPAミートアップ：放送を続ける</a></li>
<li><a href="../ja490040/index.html">Dockerを管理するWindowsのPython-Celery</a></li>
<li><a href="../ja490042/index.html">Positive Technologiesの調査：8つの金融機関のうち7つがインターネットからネットワークに入ることができます</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>