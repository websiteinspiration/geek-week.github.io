<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÆ üëä üè∑Ô∏è Call shared libraries from Similink ‚ô£Ô∏è ‚ôèÔ∏è ‚úãüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 
 I present to you the translation of an article by my colleague Mikhail on methods for invoking shared libraries in Simulink. Why was it cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Call shared libraries from Similink</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, Habr! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I present to you the translation of an article by my colleague Mikhail on methods for invoking shared libraries in Simulink. Why was it created at all? The fact is that many companies already have many legacy models that we would like to reuse and we are often asked questions: ‚ÄúHow can I integrate legacy into Simulink? And if my legacy is in the form of a DLL? ‚Äù Therefore, the original article was written. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the cat, several ways to call shared libraries in Simulink are discussed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All changes to the code were made with the permission of Mikhail and made so as not to overload the article.</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article shows how to use functions from shared libraries in Simulink models. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say we need to embed the exlib library in Simulink. </font><font style="vertical-align: inherit;">Its code is contained in the sources of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is a very simple library containing three functions: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_init (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - opens a file for writing. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print (float data)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - writes data to a file. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - closes the file.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Library assembly</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, compile the library. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This step is not necessary if the library is precompiled and delivered as a binary file. In this case, you can immediately go to step 3, but remember that to work with the library you need to get the .dll file (or .so for Linux) and the corresponding header file (.h) from the library provider. For Windows, you will also need a .lib file, which is not a static library, but the so-called import library. This import library is required for implicit linking. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we will use the MATLAB mex command, which calls the current active host compiler to compile the shared library (exlib.dll on Windows and exlib.so on Linux). It is important to make sure that the command</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
to select a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supported compiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now use mex to compile the library:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code for building a library</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Checking the compiled library</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After compilation, you need to make sure that the resulting library can be loaded and used in MATLAB:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code for checking the library</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we‚Äôve made sure everything works, let's get started with Simulink!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking a shared library using S functions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S-functions allow you to use C-code in Simulink. </font><font style="vertical-align: inherit;">This approach allows the user to develop any C code needed to load the library and call its functions. </font><font style="vertical-align: inherit;">Then, this code is compiled into a binary file that is recognized by Simulink and linked to a shared library. </font><font style="vertical-align: inherit;">This binary is called an S function. </font><font style="vertical-align: inherit;">Simulink has a block for calling this S function. </font><font style="vertical-align: inherit;">There are several approaches for creating S-functions in Simulink.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the Legacy Code Tool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first approach is to use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a tool that helps you automatically create S-functions according to specifications created using MATLAB. </font><font style="vertical-align: inherit;">In this example, the S-function is linked to the import library (on Windows we need the corresponding * .lib file) and the library functions are called. </font><font style="vertical-align: inherit;">This approach is called implicit linking. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, you need to initialize the structure for the Legacy Code Tool</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code for initializing the Legacy Code Tool structure</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create an S-function, compile and link it:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, create the Simulink block:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing S Functions Manually</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second approach is to write your own S-functions for loading a shared library and calling functions from this library. </font><font style="vertical-align: inherit;">This approach will use explicit linking, also called runtime linking. </font><font style="vertical-align: inherit;">The easiest solution is to adapt the S-function that was automatically generated earlier by the Legacy Code Tool. </font><font style="vertical-align: inherit;">In this example, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlStart</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> functions </font><i><font style="vertical-align: inherit;">are </font></i><i><font style="vertical-align: inherit;">modified</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's how these functions look after modification:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compile the resulting S-function:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And run the simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using S-Function Builder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another approach is to use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is a special unit that can be seen as a cross between the Legacy Code Tool and hand-written S-functions in terms of complexity. </font><font style="vertical-align: inherit;">S-Function Builder provides a graphical interface that describes the characteristics of your S-function, and the S-function is created automatically. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are some performance limitations and problems with using S-Function Builder. </font><font style="vertical-align: inherit;">Currently, this is considered an obsolete approach to creating S-functions. </font><font style="vertical-align: inherit;">It is recommended to use the C function block, which appeared in the release of R2020a and is discussed later.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking a shared library using MATLAB Function </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB Function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">allows you to use the MATLAB language to describe a custom algorithm in Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To call the shared library from the MATLAB function, use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, which can only be used in the body of the MATLAB Function (and not MATLAB). </font><font style="vertical-align: inherit;">Coder.ceval does not require MATLAB Coder to work. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code for the MATLAB Function block calling the shared library:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach has one drawback - the lack of a good way to call the completion function at the end of the simulation (compared to the MATLAB System block). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can define the completion function for the model by setting exlib_term (); in the model settings in the category </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Terminate function</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If the ‚ÄúImport custom code‚Äù parameter is set in the model settings, then you need to specify all the code dependencies in the ‚ÄúSimulation Target‚Äù panel (instead of using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). If this parameter is not set, then you can combine the settings from Simulation Target, coder.cinclude and coder.updateBuildInfo.</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Another way is to maintain dependencies using</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and call </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by convention, as demonstrated in the example above. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking a shared library from Stateflow </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to use the shared library functions in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diagrams </font><font style="vertical-align: inherit;">, then these functions should be called directly from Stateflow. Stateflow documentation has examples that show how to do this. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calling an external function in Stateflow is very simple - you need to specify the name of the function in the Stateflow diagram: </font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Additionally, you need to configure the model parameters so that Stateflow knows where to look for these external functions. In the settings of </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Libraries, you</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> need to enter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.lib (or exlib.so in Linux)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Header File you</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> need to enter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is also important not to forget to specify the completion function. AT</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Terminate function</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> must specify</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exlib_term (); </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the simulation:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that the information in this section applies to Stateflow diagrams that use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the C action language</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If the Stateflow diagram uses </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the MATLAB action language</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval is required</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as is the case with the MATLAB Function.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking a shared library using the MATLAB System block </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MATLAB System block</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to use system objects in Simulink. </font><font style="vertical-align: inherit;">More information about this block can be found in the documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Support for system objects appeared in Simulink in the release of R2013b. </font><font style="vertical-align: inherit;">Many people use system objects because they make it easy to define the initialization, simulation, and completion functions. </font><font style="vertical-align: inherit;">Also, system objects can use the auxiliary MATLAB code for these functions ‚Äî for example, for pre- and post-processing data of a step function ‚Äî all without writing C code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the system object used in the MATLAB System block looks like:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System Object Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking shared libraries using the C Caller block </font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">allows you to call C functions directly from Simulink. More information about this block can be found in the documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a relatively new approach that first appeared in MATLAB R2018b. Its main goal is to make function calls and C libraries in Simulink extremely simple. But it has limitations, which you can read about in the documentation for this block. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib has</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> been added to </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Libraries</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Header</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the model settings, just click the "Refresh custom code" button in the C Caller block, to see all the functions contained in the library.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After selecting the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_print</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, the port specification dialog is filled in automatically: </font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And again, you need to add the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function calls </font><font style="vertical-align: inherit;">to the Simulation Target. </font><font style="vertical-align: inherit;">You can also add a couple of other C Caller blocks to directly call the initialization and termination functions. </font><font style="vertical-align: inherit;">These C Caller blocks need to be placed in the Initialize Function and Terminate Function subsystems. </font><font style="vertical-align: inherit;">You can also consider the following example from Stateflow: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schedule Subsystems to Execute at Specific Times</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Run the simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking shared libraries using the C Function block</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The latest addition to integrating external code into Simulink is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">. He appeared in the R2020a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It resembles the C Caller block in terms of ease of use, but allows you to create a C wrapper around imported functions (thus, this block resembles S-Function Builder). But, most likely, the main scenario for using the C Function block is not to call existing C functions, but to write small pieces of C code, if such code is needed in the application. For example, you may need access to hardware registers or the compiler's built-in functions. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to add </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the settings </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulation Target -&gt; Libraries"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the settings </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulation Target -&gt; Header file"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the model settings. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, in the settings of the C Function block, you need to add a character for the input data with the data type single and specify the output, start and end code:</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoking shared libraries generated using Embedded Coder </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the scenarios for using Embedded Coder is the automatic generation of C-code from the Simulink model and the packaging of this code in a shared library. The documentation also has an example that shows how to automatically generate a shared library and call it from an external application written in C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that if you just need to run the algorithm or part of the algorithm as C code in the same Simulink model, then it‚Äôs better to use S-functions of Simulink Coder or </font><i><font style="vertical-align: inherit;">software-in-the-loop</font></i><font style="vertical-align: inherit;"> simulation</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">However, if the shared library generated by Embedded Coder is used for semi-natural modeling, it may be necessary to integrate the same library into the larger model used by other developers and thus protect their intellectual property. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working with a shared library generated by Embedded Coder is no different from working with a shared library, which was used in the article. </font><font style="vertical-align: inherit;">Consider a simple model that has two inputs and one output:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After assembling the model, we get a .dll file (.so on Linux), a .lib file (an import library for .dll), and a .exp file (an export file for communicating with .dll).</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The generated shared library exports the following characters:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, inputs and outputs are exported as global characters, and the initialization, step, and completion functions follow the model naming convention. </font><font style="vertical-align: inherit;">If necessary, you can configure function prototypes, symbol names, and more (a discussion of these settings is beyond the scope of this article). </font><font style="vertical-align: inherit;">In this model, the prototype of the step function of the model is defined as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step (In1, In2)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To call these functions, you need to use one of the methods listed above. </font><font style="vertical-align: inherit;">For example, you can use the MATLAB Function (for simplicity we only call the step function):</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the simulation and look at its results:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article describes various approaches to invoking shared libraries from Simulink models. </font><font style="vertical-align: inherit;">Both implicit and explicit links were considered. </font><font style="vertical-align: inherit;">All methods have their pros and cons, and their suitability depends on the specific workflow, requirements and goals. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approach works best when implementing an implicit link with a shared library, because in this case we can just call functions directly from the library, and the linker will take care of the rest. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MATLAB System block</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is another approach that provides the following benefits:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excellent compliance with the paradigm of initialization, step and completion functions, allowing you to maintain all these functions within the block itself, and not on the scale of the model</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The disadvantage of using the MATLAB Function block is that its use can lead to an additional overhead during code generation. Thus, the Legacy Code Tool and S functions are still preferred for generating production code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A hand-written S function is best suited for implementing an explicit link to a shared library. In this case, you need to use functions such as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in order to be able to call functions. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The C Caller block</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> introduced in R2018b is by far the easiest way to call C functions, but it has its limitations. The same can be said for the </font><b><font style="vertical-align: inherit;">C Function</font></b><font style="vertical-align: inherit;"> block.</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is the newest addition to the R2020a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download sources and models </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503894/index.html">Announcement of the online meeting NskTechTalks # 12: where can the front-end developer grow and what if nothing comes of it?</a></li>
<li><a href="../en503898/index.html">One day remote front-end</a></li>
<li><a href="../en503902/index.html">How to get neighbors to work on their project, or InnerSource for a bank</a></li>
<li><a href="../en503904/index.html">The world and n worlds, or mathematics for the humanities</a></li>
<li><a href="../en503906/index.html">LabVIEW NXG - Simple Data Types and Type Coercion</a></li>
<li><a href="../en503910/index.html">Experiments on people who have gone to "udalenka"</a></li>
<li><a href="../en503916/index.html">Learning to trade on the exchange. Part one: setting up a test environment</a></li>
<li><a href="../en503918/index.html">Managing Packages with Go Modules: A Pragmatic Guide</a></li>
<li><a href="../en503920/index.html">How we test microphone systems on STM32: the experience of Yandex device developers</a></li>
<li><a href="../en503922/index.html">Why the EU eradicates cookie walls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>