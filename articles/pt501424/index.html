<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♎️ ☝🏻 👨🏾‍🔬 Da vida com o Kubernetes: como removemos o DBMS (e não apenas) dos ambientes de revisão para os estáticos 😶 🚊 ✍🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota : este artigo não afirma ser uma prática recomendada. Ele descreve a experiência de uma implementação específica de uma tarefa de infraestrutura ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Da vida com o Kubernetes: como removemos o DBMS (e não apenas) dos ambientes de revisão para os estáticos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/501424/"><img src="https://habrastorage.org/webt/ae/yu/zw/aeyuzw9pz0k6d0pbc0g86pxkfd0.png"><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : este artigo não afirma ser uma prática recomendada. </font><font style="vertical-align: inherit;">Ele descreve a experiência de uma implementação específica de uma tarefa de infraestrutura em termos de uso do Kubernetes e Helm, que pode ser útil na solução de problemas relacionados. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O uso de ambientes de revisão no CI / CD pode ser muito útil, tanto para desenvolvedores quanto para engenheiros de sistema. </font><font style="vertical-align: inherit;">Vamos primeiro sincronizar as idéias gerais sobre eles:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Os ambientes de revisão podem ser criados a partir de ramificações separadas nos repositórios Git definidos pelos desenvolvedores (as chamadas ramificações de recursos).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles podem ter instâncias DBMS separadas, processadores de filas, serviços de cache, etc. </font><font style="vertical-align: inherit;">- em geral, tudo para a reprodução completa do ambiente de produção.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles permitem o desenvolvimento paralelo, acelerando significativamente o lançamento de novos recursos no aplicativo. </font><font style="vertical-align: inherit;">Ao mesmo tempo, dezenas desses ambientes podem ser necessários todos os dias, e é por isso que a velocidade de sua criação é crítica.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na interseção do segundo e terceiro pontos, surgem frequentemente dificuldades: como a infraestrutura é muito diferente, seus componentes podem ser implantados por um longo tempo. </font><font style="vertical-align: inherit;">Esse tempo gasto, por exemplo, inclui a restauração do banco de dados a partir de um backup já preparado *. </font><font style="vertical-align: inherit;">O artigo é sobre a maneira fascinante como resolvemos resolver esse problema.</font></font><a name="habracut"></a><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* A propósito, especificamente sobre grandes despejos de banco de dados nesse contexto, já escrevemos no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">material sobre como acelerar o banco de dados de autoinicialização</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .)</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema e a maneira de resolvê-lo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um dos projetos, recebemos a tarefa de "criar um único ponto de entrada para desenvolvedores e engenheiros de controle de qualidade". </font><font style="vertical-align: inherit;">Esta formulação escondeu tecnicamente o seguinte:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para simplificar o trabalho dos engenheiros de controle de qualidade e de alguns outros funcionários, retire todos os bancos de dados (e vhosts correspondentes) usados ​​na revisão, em um ambiente estático separado. </font><font style="vertical-align: inherit;">Pelas razões prevalecentes no projeto, essa maneira de interagir com elas foi ótima.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduza o tempo necessário para criar um ambiente de revisão. </font><font style="vertical-align: inherit;">Todo o processo de sua criação a partir do zero está implícito, ou seja, </font><font style="vertical-align: inherit;">incluindo clonagem de banco de dados, migrações etc.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do ponto de vista da implementação, o principal problema se resume a garantir a idempotência ao criar e excluir ambientes de revisão. Para isso, alteramos o mecanismo de criação de ambientes de revisão migrando primeiro os serviços </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL, MongoDB e RabbitMQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um ambiente estático. Estático refere-se a um ambiente "permanente" que não será criado a pedido do usuário (como é o caso dos ambientes de revisão). </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante!</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A abordagem com um ambiente estático está </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longe de ser ideal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - por suas deficiências específicas, consulte o final do artigo. No entanto, compartilhamos essa experiência em detalhes, pois ela pode ser mais ou menos aplicável em outras tarefas e, ao mesmo tempo, serve de argumento ao discutir questões de design de infraestrutura.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, a sequência de ações na implementação:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao criar um ambiente de revisão, o seguinte deve ocorrer uma vez: a criação de bancos de dados em dois DBMSs (MongoDB e PostgreSQL), a restauração de bancos de dados de um backup / modelo e a criação de vhost no RabbitMQ. </font><font style="vertical-align: inherit;">Isso exigirá uma maneira conveniente de carregar dumps atuais. </font><font style="vertical-align: inherit;">(Se você já tinha revisado ambientes antes, provavelmente já possui uma solução pronta para isso.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Após a conclusão do ambiente de revisão, você deve excluir o banco de dados e o host virtual no RabbitMQ.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, a infraestrutura opera dentro da estrutura do Kubernetes (usando Helm). </font><font style="vertical-align: inherit;">Portanto, para a implementação das tarefas acima, os </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganchos Helm eram</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> excelentes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eles podem ser executados antes da criação de todos os outros componentes na versão Helm e / ou após a remoção. </font><font style="vertical-align: inherit;">Portanto:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para a tarefa de inicialização, usaremos um gancho </font></font><code>pre-install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para iniciá-lo antes de criar todos os recursos no release;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para a tarefa de exclusão, um gancho </font></font><code>post-delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos passar aos detalhes da implementação.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementação prática</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na versão original, este projeto usava apenas um trabalho, composto por três contêineres. </font><font style="vertical-align: inherit;">Obviamente, isso não é totalmente conveniente, pois o resultado é um grande manifesto que é muito difícil de ler. </font><font style="vertical-align: inherit;">Portanto, dividimos em três pequenos trabalhos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, é apresentada uma lista do PostgreSQL, e os outros dois (MongoDB e RabbitMQ) são idênticos na estrutura do manifesto:</font></font><br>
<br>
<pre><code class="plaintext hljs">{{- if .Values.global.review }}<font></font>
---<font></font>
apiVersion: batch/v1<font></font>
kind: Job<font></font>
metadata:<font></font>
  name: db-create-postgres-database<font></font>
  annotations:<font></font>
    "helm.sh/hook": "pre-install"<font></font>
    "helm.sh/hook-weight": "5"<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      name: init-db-postgres<font></font>
    spec:<font></font>
      volumes:<font></font>
      - name: postgres-scripts<font></font>
        configMap:<font></font>
          defaultMode: 0755<font></font>
          name: postgresql-configmap<font></font>
      containers:<font></font>
      - name: init-postgres-database<font></font>
        image: private-registry/postgres <font></font>
        command: ["/docker-entrypoint-initdb.d/01-review-load-dump.sh"]<font></font>
        volumeMounts:<font></font>
        - name: postgres-scripts<font></font>
          mountPath: /docker-entrypoint-initdb.d/01-review-load-dump.sh<font></font>
          subPath: review-load-dump.sh<font></font>
        env:<font></font>
{{- include "postgres_env" . | indent 8 }}<font></font>
      restartPolicy: Never<font></font>
{{- end }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comentários sobre o conteúdo do manifesto:</font></font><br>
<br>
<ol>
<li> Job    review-.  review   CI/CD       Helm- (. <code>if</code>  <code>.Values.global.review</code>    ).</li>
<li>  Job      — , ConfigMap.       ,  ,       .       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>hook-weight</code></a>.</li>
<li>      cURL   ,        PostgreSQL,       .</li>
<li>      PostgreSQL    :     ,     shell- .</li>
</ol><br>
<h3>PostgreSQL</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mais interessante está no script de shell ( </font></font><code>review-load-dump.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">já mencionado na lista </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Quais são as opções gerais para restaurar um banco de dados no PostgreSQL?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Recuperação "padrão" do backup;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recuperação usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modelos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, a diferença entre as duas abordagens está principalmente na velocidade de criação de um banco de dados para o novo ambiente. </font><font style="vertical-align: inherit;">No primeiro - carregamos o dump do banco de dados e o restauramos </font></font><code>pg_restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">E conosco isso acontece mais lentamente que o segundo método, portanto, a escolha correspondente foi feita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando a segunda opção ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recuperação com modelos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), você pode clonar o banco de dados no nível físico sem enviar dados para ele remotamente do contêiner em outro ambiente - isso reduz o tempo de recuperação. </font><font style="vertical-align: inherit;">No entanto, há uma limitação: você não pode clonar um banco de dados no qual as conexões ativas permanecem. </font><font style="vertical-align: inherit;">Como usamos o estágio como o ambiente estático (e não um ambiente de revisão separado), precisamos criar um segundo banco de dados e convertê-lo em um modelo, atualizando-o diariamente (por exemplo, pela manhã). </font><font style="vertical-align: inherit;">Um pequeno CronJob foi preparado para isso:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: batch/v1beta1<font></font>
kind: CronJob<font></font>
metadata:<font></font>
  name: update-postgres-template<font></font>
spec:<font></font>
  schedule: "50 4 * * *"<font></font>
  concurrencyPolicy: Forbid<font></font>
  successfulJobsHistoryLimit: 3<font></font>
  failedJobsHistoryLimit: 3<font></font>
  startingDeadlineSeconds: 600<font></font>
  jobTemplate:<font></font>
    spec:<font></font>
      template:<font></font>
        spec:<font></font>
          restartPolicy: Never<font></font>
          imagePullSecrets:<font></font>
          - name: registrysecret<font></font>
          volumes:<font></font>
          - name: postgres-scripts<font></font>
            configMap:<font></font>
              defaultMode: 0755<font></font>
              name: postgresql-configmap-update-cron<font></font>
          containers:<font></font>
          - name: cron<font></font>
            command: ["/docker-entrypoint-initdb.d/update-postgres-template.sh"]<font></font>
          image: private-registry/postgres <font></font>
            volumeMounts:<font></font>
            - name: postgres-scripts<font></font>
              mountPath: /docker-entrypoint-initdb.d/update-postgres-template.sh<font></font>
              subPath: update-postgres-template.sh<font></font>
            env:<font></font>
{{- include "postgres_env" . | indent 8 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manifesto completo do ConfigMap que contém o script provavelmente não faz muito sentido (relate nos comentários se esse não for o caso). </font><font style="vertical-align: inherit;">Em vez disso, darei a coisa mais importante - um script bash:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#!/bin/bash -x</span><font></font>
<font></font>
CREDENTIALS=<span class="hljs-string">"postgresql://<span class="hljs-variable">${POSTGRES_USER}</span>:<span class="hljs-variable">${POSTGRES_PASSWORD}</span>@<span class="hljs-variable">${POSTGRES_HOST}</span>/postgres"</span><font></font>
<font></font>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"REVOKE CONNECT ON DATABASE <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span> FROM public"</span>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '<span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span>'"</span><font></font>
<font></font>
curl --fail -vsL <span class="hljs-variable">${HOST_FORDEV}</span>/latest_<span class="hljs-variable">${POSTGRES_DB_STAGE}</span>.psql -o /tmp/<span class="hljs-variable">${POSTGRES_DB}</span>.psql<font></font>
<font></font>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"ALTER DATABASE <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span> WITH is_template false allow_connections true;"</span>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"DROP DATABASE <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span>;"</span> || <span class="hljs-literal">true</span>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"CREATE DATABASE <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span>;"</span> || <span class="hljs-literal">true</span>
pg_restore -U <span class="hljs-variable">${POSTGRES_USER}</span> -h <span class="hljs-variable">${POSTGRES_HOST}</span> -w -j 4 -d <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span> /tmp/<span class="hljs-variable">${POSTGRES_DB}</span>.psql<font></font>
<font></font>
psql -d <span class="hljs-string">"<span class="hljs-variable">${CREDENTIALS}</span>"</span> -w -c <span class="hljs-string">"ALTER DATABASE <span class="hljs-variable">${POSTGRES_DB_TEMPLATE}</span> WITH is_template true allow_connections false;"</span><font></font>
<font></font>
rm -v /tmp/<span class="hljs-variable">${POSTGRES_DB}</span>.psql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você pode restaurar vários bancos de dados ao mesmo tempo a partir de um modelo sem conflitos. </font><font style="vertical-align: inherit;">O principal é que as conexões com o banco de dados devem ser proibidas e o próprio banco de dados deve ser um modelo. </font><font style="vertical-align: inherit;">Isso é feito na penúltima etapa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manifesto que contém o script de shell para restaurar o banco de dados ficou assim:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: postgresql-configmap<font></font>
  annotations:<font></font>
    "helm.sh/hook": "pre-install"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded<font></font>
data:<font></font>
  review-load-dump.sh: |<font></font>
    #!/bin/bash -x<font></font>
    <font></font>
 <font></font>
 <font></font>
    CREDENTIALS="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/postgres"<font></font>
<font></font>
    if [ "$( psql -d "${CREDENTIALS}" -tAc "SELECT CASE WHEN EXISTS (SELECT * FROM pg_stat_activity WHERE datname = '${POSTGRES_DB}' LIMIT 1) THEN 1 ELSE 0 END;" )" = '1' ]<font></font>
      then<font></font>
          echo "Open connections has been found in ${POSTGRES_DB} database, will drop them"<font></font>
          psql -d "${CREDENTIALS}" -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '${POSTGRES_DB}' -- AND pid &lt;&gt; pg_backend_pid();"<font></font>
      else<font></font>
          echo "No open connections has been found ${POSTGRES_DB} database, skipping this stage"<font></font>
    fi<font></font>
<font></font>
    psql -d "${CREDENTIALS}" -c "DROP DATABASE ${POSTGRES_DB}"<font></font>
<font></font>
    if [ "$( psql -d "${CREDENTIALS}" -tAc "SELECT 1 FROM pg_database WHERE datname='${POSTGRES_DB}'" )" = '1' ]<font></font>
      then<font></font>
          echo "Database ${POSTGRES_DB} still exists, delete review job failed"<font></font>
          exit 1<font></font>
      else<font></font>
          echo "Database ${POSTGRES_DB} does not exist, skipping"<font></font>
    fi<font></font>
<font></font>
<font></font>
    psql ${CREDENTIALS} -d postgres -c 'CREATE DATABASE ${POSTGRES_DB} TEMPLATE "loot-stage-copy"'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparentemente, eles estão envolvidos aqui </font></font><code>hook-delete-policy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Detalhes sobre a aplicação dessas políticas estão escritos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No manifesto fornecido, usamos o </font></font><code>before-hook-creation,hook-succeeded</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que permite atender aos seguintes requisitos: exclua o objeto anterior antes de criar um novo gancho e exclua somente quando o gancho tiver êxito. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excluiremos o banco de dados neste ConfigMap:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: postgresql-configmap-on-delete<font></font>
  annotations:<font></font>
    "helm.sh/hook": "post-delete, pre-delete"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation<font></font>
data:<font></font>
  review-delete-db.sh: |<font></font>
    #!/bin/bash -e<font></font>
<font></font>
    CREDENTIALS="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/postgres"<font></font>
<font></font>
    psql -d "${CREDENTIALS}" -w postgres -c "DROP DATABASE ${POSTGRES_DB}"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o tenhamos movido para um ConfigMap separado, ele pode ser colocado em um ConfigMap regular </font></font><code>command</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Afinal, ele pode ser transformado em uma linha sem complicar a aparência do próprio manifesto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a opção com os modelos do PostgreSQL, por algum motivo, não se adequar ou não se encaixar, você poderá retornar ao </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caminho de recuperação "padrão"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mencionado acima </font><b><font style="vertical-align: inherit;">usando o backup</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O algoritmo será trivial:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Todas as noites, é feito um backup do banco de dados para que possa ser baixado da rede local do cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No momento da criação do ambiente de revisão, o banco de dados é carregado e restaurado a partir do dump.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quando o dump é implantado, todas as outras ações são executadas.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, o script de recuperação se tornará aproximadamente da seguinte maneira:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: postgresql-configmap<font></font>
  annotations:<font></font>
    "helm.sh/hook": "pre-install"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded<font></font>
data:<font></font>
  review-load-dump.sh: |<font></font>
    #!/bin/bash -x<font></font>
<font></font>
    CREDENTIALS="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/postgres"<font></font>
    psql -d "${CREDENTIALS}" -w -c "DROP DATABASE ${POSTGRES_DB}" || true<font></font>
    psql -d "${CREDENTIALS}" -w -c "CREATE DATABASE ${POSTGRES_DB}"<font></font>
<font></font>
    curl --fail -vsL ${HOST_FORDEV}/latest_${POSTGRES_DB_STAGE}.psql -o /tmp/${POSTGRES_DB}.psql<font></font>
<font></font>
    psql psql -d "${CREDENTIALS}" -w -c "CREATE EXTENSION ip4r;"<font></font>
    pg_restore -U ${POSTGRES_USER} -h ${POSTGRES_HOST} -w -j 4 -d ${POSTGRES_DB} /tmp/${POSTGRES_DB}.psql<font></font>
    rm -v /tmp/${POSTGRES_DB}.psql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O procedimento corresponde ao que já foi descrito acima. A única alteração é a remoção do arquivo psql após todo o trabalho ter sido adicionado. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : no script de recuperação e no script de desinstalação, o banco de dados é excluído todas as vezes. Isso é feito para evitar possíveis conflitos durante a recriação da revisão: você precisa garantir que o banco de dados seja realmente excluído. Além disso, esse problema pode ser resolvido com a adição de um sinalizador </font></font><code>--clean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no utilitário </font></font><code>pg_restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas tenha cuidado: esse sinalizador limpa os dados apenas dos elementos que estão no próprio despejo, portanto, no nosso caso, essa opção não funciona.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtivemos um mecanismo funcional que requer melhorias adicionais (até a substituição de scripts Bash por um código mais elegante). </font><font style="vertical-align: inherit;">Vamos deixá-los fora do escopo do artigo (embora os comentários sobre o tópico, é claro, sejam bem-vindos).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mongodb</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O próximo componente é o MongoDB. </font><font style="vertical-align: inherit;">A principal dificuldade é que, para este DBMS, a opção de copiar o banco de dados (como no PostgreSQL) existe de maneira bastante nominal, porque:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele está em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um estado obsoleto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acordo com os resultados de nossos testes, não encontramos uma grande diferença no tempo de recuperação do banco de dados em comparação com o usual </font></font><code>mongo_restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, observo que o teste foi realizado como parte de um projeto - no seu caso, os resultados podem ser completamente diferentes.</font></font></i></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que, no caso de um grande volume de banco de dados, um sério problema pode surgir: economizamos tempo ao restaurar o banco de dados no PgSQL, mas, ao mesmo tempo, restauramos o despejo no Mongo por muito tempo. </font><font style="vertical-align: inherit;">No momento da redação deste artigo, e dentro da estrutura da infraestrutura existente, vimos três maneiras (a propósito, elas podem ser combinadas):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A recuperação pode demorar, por exemplo, se o DBMS estiver localizado em um sistema de arquivos de rede (para casos que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estejam no </font><font style="vertical-align: inherit;">ambiente de produção). </font><font style="vertical-align: inherit;">Em seguida, você pode simplesmente transferir o DBMS do palco para um nó separado e usar o armazenamento local. </font><font style="vertical-align: inherit;">Como isso não é produção, a velocidade de criação de uma revisão é mais crítica para nós.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você pode levar cada recuperação de tarefa para um pod separado, permitindo pré-executar migrações e outros processos que dependem da operação do DBMS. </font><font style="vertical-align: inherit;">Assim, economizamos tempo preenchendo-os com antecedência.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Às vezes, você pode reduzir o tamanho do dump excluindo dados antigos / irrelevantes - até o ponto em que é suficiente deixar apenas a estrutura do banco de dados. </font><font style="vertical-align: inherit;">Obviamente, isso não ocorre nos casos em que é necessário um dump completo (por exemplo, para tarefas de teste de controle de qualidade).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você não precisar criar rapidamente ambientes de revisão, todas as dificuldades descritas poderão ser ignoradas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não sendo possível copiar o banco de dados de maneira semelhante ao PgSQL, seguiremos o primeiro caminho, ou seja, </font><font style="vertical-align: inherit;">recuperação padrão do backup. </font><font style="vertical-align: inherit;">O algoritmo é o mesmo que com o PgSQL. </font><font style="vertical-align: inherit;">É fácil ver se você olha para os manifestos:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: mongodb-scripts-on-delete<font></font>
  annotations:<font></font>
    "helm.sh/hook": "post-delete, pre-delete"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation<font></font>
data:<font></font>
  review-delete-db.sh: |<font></font>
    #!/bin/bash -x<font></font>
<font></font>
    mongo ${MONGODB_NAME} --eval "db.dropDatabase()" --host ${MONGODB_REPLICASET}/${MONGODB_HOST}<font></font>
---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: mongodb-scripts<font></font>
  annotations:<font></font>
    "helm.sh/hook": "pre-install"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded<font></font>
data:<font></font>
  review-load-dump.sh: |<font></font>
    #!/bin/bash -x<font></font>
<font></font>
    curl --fail -vsL ${HOST_FORDEV}/latest_${MONGODB_NAME_STAGE}.gz -o /tmp/${MONGODB_NAME}.gz<font></font>
<font></font>
    mongo ${MONGODB_NAME} --eval "db.dropDatabase()" --host ${MONGODB_REPLICASET}/${MONGODB_HOST}<font></font>
    mongorestore --gzip --nsFrom "${MONGODB_NAME_STAGE}.*" --nsTo "${MONGODB_NAME}.*" --archive=/tmp/${MONGODB_NAME}.gz --host ${MONGODB_REPLICASET}/${MONGODB_HOST}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Há um detalhe importante aqui. No nosso caso, o MongoDB está no cluster e você precisa ter certeza de que a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conexão sempre acontece com o nó Primário</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se você especificar, por exemplo, o primeiro host no quorum, depois de algum tempo poderá mudar de Primário para Secundário, o que impedirá a criação de um banco de dados. Portanto, você precisa se conectar não a um host, mas imediatamente ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReplicaSet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , listando todos os hosts nele. Por esse motivo, é necessário tornar o MongoDB como um StatefulSet para que os nomes de host sejam sempre os mesmos (sem mencionar que o MongoDB é um aplicativo com estado por natureza). Nesta opção, você garante a conexão com o nó Primário. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o MongoDB, também excluímos o banco de dados antes de criar a revisão - isso é feito pelos mesmos motivos que no PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Última nuance: como o banco de dados para revisão está no mesmo ambiente que o estágio, é necessário um nome separado para o banco de dados clonado. </font><font style="vertical-align: inherit;">Se o despejo não for um arquivo BSON, ocorrerá o seguinte erro:</font></font><br>
<br>
<pre><code class="plaintext hljs">the --db and --collection args should only be used when restoring from a BSON file. Other uses are deprecated and will not exist in the future; use --nsInclude instead</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, no exemplo acima, </font></font><code>--nsFrom</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font><font style="vertical-align: inherit;">são usados </font></font><code>--nsTo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não encontramos outros problemas com a recuperação. </font><font style="vertical-align: inherit;">No final, acrescentarei apenas que a documentação do </font></font><code>copyDatabase</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB está disponível </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - caso você queira experimentar esta opção.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rabbitmq</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A última aplicação em nossa lista de requisitos foi o RabbitMQ. </font><font style="vertical-align: inherit;">É simples: você precisa criar um novo vhost em nome do usuário com o qual o aplicativo se conectará. </font><font style="vertical-align: inherit;">E depois exclua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manifesto para criar e remover vhosts:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: rabbitmq-configmap<font></font>
  annotations:<font></font>
    "helm.sh/hook": "pre-install"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded<font></font>
data:<font></font>
  rabbitmq-setup-vhost.sh: |<font></font>
    #!/bin/bash -x<font></font>
<font></font>
    /usr/local/bin/rabbitmqadmin -H ${RABBITMQ_HOST} -u ${RABBITMQ_USER} -p ${RABBITMQ_PASSWORD} declare vhost name=${RABBITMQ_VHOST}<font></font>
---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: rabbitmq-configmap-on-delete<font></font>
  annotations:<font></font>
    "helm.sh/hook": "post-delete, pre-delete"<font></font>
    "helm.sh/hook-weight": "1"<font></font>
    "helm.sh/hook-delete-policy": before-hook-creation<font></font>
data:<font></font>
  rabbitmq-delete-vhost.sh: |<font></font>
    #!/bin/bash -x<font></font>
<font></font>
    /usr/local/bin/rabbitmqadmin -H ${RABBITMQ_HOST} -u ${RABBITMQ_USER} -p ${RABBITMQ_PASSWORD} delete vhost name=${RABBITMQ_VHOST}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com grandes dificuldades no RabbitMQ nós (até agora?) Não encontramos. </font><font style="vertical-align: inherit;">Em geral, a mesma abordagem pode ser aplicada a qualquer outro serviço que não tenha um vínculo crítico com os dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desvantagens</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que essa decisão não afirma ser “melhores práticas”?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Acontece um único ponto de falha na forma de um ambiente de palco.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se um aplicativo em um ambiente de estágio for executado apenas em uma réplica, ficaremos ainda mais dependentes do host no qual esse aplicativo é executado. </font><font style="vertical-align: inherit;">Consequentemente, com um aumento no número de ambientes de revisão, a carga no nó aumenta proporcionalmente sem a capacidade de equilibrar essa carga.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não foi possível resolver completamente esses dois problemas, levando em consideração os recursos da infraestrutura de um projeto específico; no entanto, os danos em potencial podem ser minimizados com o agrupamento (adição de novos nós) e o dimensionamento vertical. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À medida que o aplicativo se desenvolve e com o aumento do número de desenvolvedores, mais cedo ou mais tarde, a carga nos ambientes de revisão aumenta e novos requisitos são adicionados a eles. É importante que os desenvolvedores entreguem as próximas alterações na produção o mais rápido possível, mas para tornar isso possível, precisamos de ambientes de revisão dinâmica que tornem o desenvolvimento "paralelo". Como resultado, a carga na infraestrutura está aumentando e o tempo para a criação desses ambientes está aumentando. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo foi escrito com base em experiências reais e bastante específicas. Somente em casos excepcionais isolamos quaisquer serviços em ambientes estáticos, e aqui era especificamente sobre ele. Uma medida tão necessária nos permitiu acelerar o desenvolvimento e a depuração do aplicativo - graças à capacidade de criar rapidamente ambientes de revisão do zero.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando começamos a fazer essa tarefa, parecia muito simples, mas, ao trabalharmos, descobrimos muitas nuances. </font><font style="vertical-align: inherit;">Foram eles que foram reunidos no artigo final: embora não sejam universais, eles podem servir de exemplo para a base / inspiração de suas próprias decisões sobre a aceleração dos ambientes de revisão.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia também no nosso blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dicas e truques do Kubernetes: acelerando a inicialização de grandes bancos de dados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migração desobstruída do RabbitMQ para Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migração desobstruída do MongoDB para o Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Executando equipes no processo de entrega de uma nova versão do aplicativo para o Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .”</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt501412/index.html">Rastreamento ocular móvel no PyTorch</a></li>
<li><a href="../pt501414/index.html">Configurando Debian, Nginx e Gunicorn para um projeto Django</a></li>
<li><a href="../pt501416/index.html">Um pouco sobre o WebRTC: o que usar e o caso da prática</a></li>
<li><a href="../pt501418/index.html">Maratona da Semana 4: Motivação</a></li>
<li><a href="../pt501420/index.html">Mitapas on-line e programas no YouTube: JUG Ru Group Stream Week</a></li>
<li><a href="../pt501426/index.html">Unison: configurando e automatizando a sincronização bidirecional de diretórios em dois servidores</a></li>
<li><a href="../pt501430/index.html">Ótimo guia para design e planejamento de conteúdo de sites</a></li>
<li><a href="../pt501432/index.html">Duas alternativas ao JDBC</a></li>
<li><a href="../pt501434/index.html">Semana 20 de segurança: invadir um computador através do Thunderbolt</a></li>
<li><a href="../pt501436/index.html">Algoritmo de reconhecimento de número na imagem com baixa probabilidade do segundo tipo de erro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>