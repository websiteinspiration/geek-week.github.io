<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèº üôéüèº üëèüèº Guide de compression d'animation squelette üñåÔ∏è ü§∞üèª ü§òüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article sera un bref aper√ßu de la fa√ßon d'impl√©menter un sch√©ma de compression d'animation simple et de certains concepts associ√©s. Je ne suis nul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guide de compression d'animation squelette</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491958/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/o1/6v/gp/o16vgpz4u-9_ntko92qweoxqzx0.png" height="50%" width="50%"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article sera un bref aper√ßu de la fa√ßon d'impl√©menter un sch√©ma de compression d'animation simple et de certains concepts associ√©s. </font><font style="vertical-align: inherit;">Je ne suis nullement un expert en la mati√®re, mais il y a tr√®s peu d'informations √† ce sujet, et elles sont assez fragment√©es. </font><font style="vertical-align: inherit;">Si vous souhaitez lire des articles plus approfondis sur ce sujet, je vous recommande de consulter les liens suivants:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://nfrechette.github.io/2016/10/21/anim_compression_toc/</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://technology.riotgames.com/news/compressing-skeletal-animation-data</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://bitsquid.blogspot.com/2009/11/bitsquid-low-level-animation-system.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://bitsquid.blogspot.com/2011/10/low-level-animation-part-2.html</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer, il convient de donner une br√®ve introduction √† l'animation squelettique et √† certains de ses concepts de base.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de l'animation et de la compression</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'animation squelettique est un sujet assez simple, si vous oubliez le skinning. Nous avons un concept de squelette contenant des transformations des os d'un personnage. Ces transformations osseuses sont stock√©es dans un format hi√©rarchique; en fait, ils sont stock√©s comme un delta entre leur position globale et la position du parent. La terminologie ici est d√©routante, car dans le moteur de jeu local est souvent appel√© l'espace mod√®le / personnage, et global est l'espace mondial. Dans la terminologie de l'animation, local est appel√© l'espace du parent de l'os, et global est soit l'espace du personnage soit l'espace du monde, selon qu'il y a mouvement de l'os racine; mais ne nous inqui√©tons pas trop. L'important est que les transformations osseuses soient stock√©es localement par rapport √† leurs parents. Cela pr√©sente de nombreux avantages, et en particulier lors du m√©lange (m√©lange):si le m√©lange des deux positions √©tait global, alors elles seraient interpol√©es lin√©airement dans la position, ce qui entra√Ænerait une augmentation et une diminution des os et une d√©formation du personnage.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et si vous utilisez des deltas, le m√©lange est effectu√© d'une diff√©rence √† l'autre, donc si la transformation delta pour un os entre deux poses est la m√™me, la longueur de l'os reste constante. Je pense qu'il est plus facile (mais pas tout √† fait exact) de proc√©der de cette fa√ßon: l'utilisation de deltas conduit √† un mouvement ¬´sph√©rique¬ª des positions osseuses lors du m√©lange, et le m√©lange des transformations globales conduit √† un mouvement lin√©aire des positions osseuses.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'animation squelettique n'est qu'une liste ordonn√©e d'images cl√©s avec une fr√©quence d'images (g√©n√©ralement) constante. L'image cl√© est la pose squelette. Si nous voulons obtenir une pose entre les images cl√©s, nous √©chantillonnons les deux images cl√©s et les m√©langons entre elles, en utilisant la fraction du temps entre elles comme poids du m√©lange. L'image ci-dessous montre une animation cr√©√©e √† 30 images par seconde. L'animation a un total de 5 images et nous devons obtenir la pose 0,52 s apr√®s le d√©but. Par cons√©quent, nous devons √©chantillonner la pose dans l'image 1 et la pose dans l'image 2, puis m√©langer entre eux avec un poids de m√©lange d'environ 57%.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/733/f11/c43/733f11c43022b935901e6f20f8a70fab.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple d'animation de 5 images et une demande de pose √† un temps d'image interm√©diaire</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ayant les informations ci-dessus et croyant que la m√©moire n'est pas un probl√®me pour nous, la sauvegarde s√©quentielle de la pose serait le moyen id√©al pour stocker l'animation, comme indiqu√© ci-dessous:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d28/7c5/f3c/d287c5f3cbfd9a8144d20432c3a258dc.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage de donn√©es d'animation simple</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi est-ce parfait? L'√©chantillonnage d'une image cl√© se r√©sume √† une simple op√©ration de m√©morisation. L'√©chantillonnage d'une pose interm√©diaire n√©cessite deux op√©rations memcpy et une op√©ration de m√©lange. Du point de vue du cache, nous copions en utilisant memcpy deux blocs de donn√©es dans l'ordre, c'est-√†-dire qu'apr√®s avoir copi√© la premi√®re trame, l'un des caches aura d√©j√† une deuxi√®me trame. Vous pouvez dire: attendez, quand nous faisons le mixage, nous devons m√©langer tous les os; Et si la plupart d'entre eux ne changent pas entre les images? Ne serait-il pas pr√©f√©rable de stocker les os en tant qu'enregistrements et de ne m√©langer que les transformations modifi√©es? Eh bien, si cela est r√©alis√©, un peu plus de rat√©s de cache peuvent potentiellement se produire lors de la lecture des enregistrements individuels, puis vous devrez garder une trace des conversions que vous devez m√©langer, et ainsi de suite ... Le m√©lange peut sembler beaucoup de travail fastidieux,mais c'est essentiellement l'application d'une instruction √† deux blocs de m√©moire qui sont d√©j√† dans le cache. De plus, le code de mixage est relativement simple, souvent juste un ensemble d'instructions SIMD sans branchement, et un processeur moderne les traitera en quelques instants.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me avec cette approche est qu'elle prend une tr√®s grande quantit√© de m√©moire, en particulier dans les jeux o√π les conditions suivantes sont vraies pour 95% des donn√©es.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les os ont une longueur constante</font></font></strong><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les personnages de la plupart des jeux n'√©tirent pas les os, par cons√©quent, au sein d'une m√™me animation, les enregistrements des transformations sont constants.</font></font></li>
</ul></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'√©chelonnons g√©n√©ralement pas les os.</font></font></strong><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©chelle est rarement utilis√©e dans les animations de jeu. </font><font style="vertical-align: inherit;">Il est assez activement utilis√© dans les films et les effets visuels, mais tr√®s peu dans les jeux. </font><font style="vertical-align: inherit;">M√™me lorsqu'elle est utilis√©e, la m√™me √©chelle est g√©n√©ralement utilis√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, dans la plupart des animations que j'ai cr√©√©es lors de l'ex√©cution, j'ai profit√© de ce fait et j'ai conserv√© la transformation osseuse enti√®re en 8 variables flottantes: 4 pour faire pivoter le quaternion, 3 pour se d√©placer et 1 pour l'√©chelle. </font><font style="vertical-align: inherit;">Cela r√©duit consid√©rablement la taille de la pose au moment de l'ex√©cution, offrant une productivit√© accrue lors du m√©lange et de la copie.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec tout cela √† l'esprit, si vous regardez le format de donn√©es d'origine, vous pouvez voir √† quel point il est inefficace de d√©penser de la m√©moire. </font><font style="vertical-align: inherit;">Nous dupliquons les valeurs de d√©placement et d'√©chelle de chaque os, m√™me si elles ne changent pas. </font><font style="vertical-align: inherit;">Et la situation devient rapidement incontr√¥lable. </font><font style="vertical-align: inherit;">Habituellement, les animateurs cr√©ent des animations √† une fr√©quence de 30 images par seconde, et dans les jeux de niveau AAA, un personnage poss√®de g√©n√©ralement environ 100 os. </font><font style="vertical-align: inherit;">Sur la base de cette quantit√© d'informations et d'un format de 8 flottants, nous avons besoin d'environ 3 Ko par pose et de 94 Ko par seconde d'animation. </font><font style="vertical-align: inherit;">Les valeurs s'accumulent rapidement et sur certaines plates-formes peuvent facilement obstruer toute la m√©moire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parlons donc de compression; </font><font style="vertical-align: inherit;">Lorsque vous essayez de compresser des donn√©es, plusieurs aspects doivent √™tre pris en compte:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ratio de compression</font></font></strong><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combien avons-nous r√©ussi √† r√©duire la quantit√© de m√©moire occup√©e</font></font></li>
</ul></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualit√©</font></font></strong><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combien d'informations nous avons perdu des donn√©es sources</font></font></li>
</ul></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Taux de compression</font></font></strong><ul>
<li>     </li>
</ul></li>
<li><strong> </strong><ul>
<li>           .</li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis principalement pr√©occup√© par la qualit√© et la vitesse, et moins par la m√©moire. De plus, je travaille avec des animations de jeu, et je peux profiter du fait qu'en fait, pour r√©duire la charge sur la m√©moire, nous n'avons pas √† utiliser de d√©placement et d'√©chelle dans les donn√©es. Pour cette raison, nous pouvons √©viter une diminution de la qualit√© caus√©e par une diminution du nombre de trames et d'autres solutions avec des pertes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √©galement extr√™mement important de noter que vous ne devez pas sous-estimer l'effet de la compression d'animation sur les performances: dans l'un de mes projets pr√©c√©dents, le taux d'√©chantillonnage a diminu√© d'environ 35%, et il y a √©galement eu des probl√®mes de qualit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous commen√ßons √† travailler avec la compression des donn√©es d'animation, il y a deux principaux domaines importants √† consid√©rer:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä quelle vitesse pouvons-nous compresser des √©l√©ments d'information individuels dans une image cl√© (quaternions, float, etc.).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment pouvons-nous compresser la s√©quence d'images cl√©s pour supprimer les informations redondantes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discr√©tisation des donn√©es</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La quasi-totalit√© de cette section peut √™tre r√©duite √† un seul principe: discr√©tiser les donn√©es. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La discr√©tisation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un moyen difficile de dire que nous voulons convertir une valeur d'un intervalle continu en un ensemble discret de valeurs.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flotteur de discr√©tisation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand il s'agit d'√©chantillonner des valeurs flottantes, nous nous effor√ßons de prendre cette valeur flottante et de la repr√©senter comme un entier en utilisant moins de bits. L'astuce est qu'un entier peut ne pas repr√©senter r√©ellement un nombre source, mais une valeur dans un intervalle discret, mapp√© sur un intervalle continu. Habituellement, une approche tr√®s simple est utilis√©e. Pour √©chantillonner une valeur, nous avons d'abord besoin d'un intervalle pour la valeur d'origine; Ayant re√ßu cet intervalle, nous normalisons la valeur initiale de cet intervalle. Cette valeur normalis√©e est ensuite multipli√©e par la valeur maximale possible pour la taille de sortie donn√©e souhait√©e en bits. Autrement dit, pour 16 bits, nous multiplions la valeur par 65535. Ensuite, la valeur r√©sultante est arrondie √† l'entier le plus proche et stock√©e. Ceci est clairement montr√© dans l'image:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f7b/e73/827/f7be73827067126fd51c0bf6f2396b10.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de discr√©tisation d'un flottant 32 bits en un entier non sign√© 16.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pour obtenir √† nouveau la valeur d'origine, nous effectuons simplement les op√©rations dans l'ordre inverse. Il est important de noter ici que nous devons enregistrer quelque part l'intervalle initial de la valeur; sinon, nous ne pourrons pas d√©coder la valeur √©chantillonn√©e. Le nombre de bits dans la valeur √©chantillonn√©e d√©termine la taille de pas dans l'intervalle normalis√©, et donc la taille de pas dans l'intervalle d'origine: la valeur d√©cod√©e sera un multiple de cette taille de pas, ce qui nous permet de calculer facilement l'erreur maximale qui se produit en raison du processus d'√©chantillonnage, afin que nous puissions d√©terminer le nombre de bits requis pour notre application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne donnerai pas d'exemples de code source, car il existe une biblioth√®que assez pratique et simple pour effectuer des op√©rations d'√©chantillonnage de base, ce qui est une bonne source sur ce sujet: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/r-lyeh-archived/quant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (je dirais que vous ne devez pas utiliser sa fonction de discr√©tisation quaternion, mais plus √† ce sujet plus tard).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression Quaternion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La compression quaternion est un sujet bien √©tudi√©, donc je ne r√©p√©terai pas ce que les autres ont mieux expliqu√©. </font><font style="vertical-align: inherit;">Voici un lien vers un article de compression d'instantan√© qui fournit la meilleure description sur ce sujet: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gafferongames.com/post/snapshot_compression/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, j'ai quelque chose √† dire sur le sujet. </font><font style="vertical-align: inherit;">Les articles bitsquid, qui parlent de compression quaternion, sugg√®rent de compresser le quaternion en 32 bits en utilisant environ 10 bits de donn√©es pour chaque composant quaternion. </font><font style="vertical-align: inherit;">C'est exactement ce que fait Quant, car il est bas√© sur des publications bitsquid. </font><font style="vertical-align: inherit;">√Ä mon avis, une telle compression est trop importante et dans mes tests, elle a provoqu√© de fortes secousses. </font><font style="vertical-align: inherit;">Peut-√™tre que les auteurs ont utilis√© des hi√©rarchies moins profondes du personnage, mais si vous multipliez les quaternions de plus de 15 de mes exemples d'animation, l'erreur combin√©e s'av√®re assez grave. </font><font style="vertical-align: inherit;">√Ä mon avis, le </font><font style="vertical-align: inherit;">minimum </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absolu</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de pr√©cision est de 48 bits par quaternion.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©duction des effectifs due √† l'√©chantillonnage</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer √† consid√©rer les diff√©rentes m√©thodes de compression et la disposition des enregistrements, voyons quel type de compression nous obtenons si nous appliquons simplement la discr√©tisation dans le circuit d'origine. Nous utiliserons le m√™me exemple que pr√©c√©demment (un squelette de 100 os), donc si nous utilisons 48 bits (3 x 16 bits) par quaternion, 48 bits (3 √ó 16) pour se d√©placer et 16 bits pour √©voluer, puis au total pour la conversion nous avons besoin de 14 octets au lieu de 32 octets. C'est 43,75% de la taille d'origine. Autrement dit, pour 1 seconde d'animation avec une fr√©quence de 30 images par seconde, nous avons r√©duit le volume d'environ 94 Ko √† environ 41 Ko.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est pas mal du tout, la discr√©tisation est une op√©ration relativement peu co√ªteuse, donc cela n'affectera pas trop le temps de d√©ballage. </font><font style="vertical-align: inherit;">Nous avons trouv√© un bon point de d√©part pour le d√©part, et dans certains cas, cela sera m√™me suffisant pour impl√©menter des animations dans le budget des ressources et assurer une excellente qualit√© et performance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression d'enregistrement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout devient tr√®s compliqu√© ici, surtout lorsque les d√©veloppeurs commencent √† essayer des techniques telles que la r√©duction de l'image cl√©, l'ajustement de courbe, etc. </font><font style="vertical-align: inherit;">√Ä ce stade √©galement, nous commen√ßons vraiment √† r√©duire la qualit√© des animations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans presque toutes ces d√©cisions, il est suppos√© que les caract√©ristiques de chaque os (rotation, d√©placement et √©chelle) sont stock√©es dans un enregistrement distinct. </font><font style="vertical-align: inherit;">Par cons√©quent, nous pouvons inverser le circuit, comme je l'ai montr√© plus t√¥t:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f64/752/16a/f6475216adb6ac795e1737de30aef6af.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sauvegarde des donn√©es des os sous forme d'enregistrements</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici, nous enregistrons simplement tous les enregistrements de mani√®re s√©quentielle, mais nous pouvons √©galement regrouper tous les enregistrements de rotations, de d√©placements et d'√©chelles. L'id√©e de base est que nous passons du stockage des donn√©es de chaque pose au stockage des enregistrements.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela fait, nous pouvons utiliser d'autres moyens pour r√©duire davantage la m√©moire occup√©e. La premi√®re consiste √† commencer √† supprimer des images. Remarque: cela ne n√©cessite pas de format d'enregistrement et cette m√©thode peut √™tre appliqu√©e dans le sch√©ma pr√©c√©dent. Cette m√©thode fonctionne, mais conduit √† la perte de petits mouvements dans l'animation, car nous supprimons la plupart des donn√©es. Cette technique √©tait activement utilis√©e sur la PS3, et parfois nous devions nous pencher sur des fr√©quences d'√©chantillonnage incroyablement basses, par exemple, jusqu'√† 7 images par seconde (g√©n√©ralement pour des animations peu importantes). J'ai de mauvais souvenirs de cela, en tant que programmeur d'animation, je vois clairement les d√©tails perdus et l'expressivit√©, mais si vous regardez du point de vue du programmeur syst√®me, nous pouvons dire que l'animation est "presque" la m√™me, car en g√©n√©ral le mouvement est pr√©serv√©, mais en m√™me temps nous √©conomiser beaucoup de m√©moire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oublions cette approche (√† mon avis, elle est trop destructrice) et consid√©rons d'autres options possibles. Une autre approche populaire consiste √† cr√©er une courbe pour chaque enregistrement et √† r√©duire les images cl√©s sur la courbe, c'est-√†-dire suppression des images cl√©s en double. Du point de vue des animations de jeu, avec cette approche, les enregistrements de mouvement et d'√©chelle sont parfaitement compress√©s, parfois r√©duits √† une seule image cl√©. Cette solution est non destructive, mais n√©cessite un d√©ballage, car chaque fois que nous avons besoin d'obtenir la transformation, nous devons calculer la courbe, car nous ne pouvons plus simplement acc√©der aux donn√©es en m√©moire. La situation peut √™tre un peu am√©lior√©e si vous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calculez des animations dans une seule direction.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et stocker l'√©tat de l'√©chantillonneur de chaque animation pour chaque os (c'est-√†-dire d'o√π obtenir le calcul de la courbe), mais vous devez payer pour cela avec une augmentation de la m√©moire et une augmentation significative de la complexit√© du code. Dans les syst√®mes d'animation modernes, nous ne jouons souvent pas d'animations du d√©but √† la fin. Souvent √† certains d√©calages temporels, ils effectuent des transitions vers de nouvelles animations gr√¢ce √† des choses comme le m√©lange synchronis√© ou la correspondance de phase. Souvent, nous √©chantillonnons des poses individuelles mais pas cons√©cutives pour impl√©menter des choses comme m√©langer viser / regarder un objet, et souvent les animations sont jou√©es dans l'ordre inverse. Par cons√©quent, je ne recommande pas d'utiliser une telle solution, elle ne vaut tout simplement pas la peine caus√©e par la complexit√© et les bogues potentiels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi le concept de supprimer non seulement les cl√©s identiques sur les courbes, mais aussi de sp√©cifier un seuil auquel les cl√©s similaires sont supprim√©es; cela conduit au fait que l'animation devient plus att√©nu√©e, similaire √† la m√©thode de suppression d'images, car le r√©sultat final est le m√™me en termes de donn√©es. Des sch√©mas de compression d'animation sont souvent utilis√©s, dans lesquels des param√®tres de compression sont d√©finis pour chaque enregistrement, et les animateurs sont constamment tourment√©s par ces valeurs, essayant de maintenir la qualit√© et de r√©duire la taille en m√™me temps. Il s'agit d'un flux de travail douloureux et stressant, mais il est n√©cessaire si vous travaillez avec la m√©moire limit√©e des anciennes g√©n√©rations de consoles. Heureusement, nous avons aujourd'hui un budget m√©moire important et nous n'avons pas besoin de choses aussi terribles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous ces aspects sont d√©voil√©s dans les articles de Riot / BitSquid et Nicholas (voir les liens au d√©but de mon article). Je n'en parlerai pas en d√©tail. Au lieu de cela, je vais parler de ce que j'ai d√©cid√© de compresser les enregistrements ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai ... d√©cid√© de ne pas compresser les enregistrements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer √† agiter, laissez-moi vous expliquer ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque je sauvegarde les donn√©es dans les enregistrements, je stocke les donn√©es de rotation pour toutes les images. En ce qui concerne le mouvement et l'√©chelle, je v√©rifie si le mouvement et l'√©chelle sont statiques pendant la compression, et si c'est le cas, je n'enregistre qu'une seule valeur par enregistrement. Autrement dit, si l'enregistrement se d√©place le long de X, mais pas le long de Y et Z, alors je sauvegarde toutes les valeurs de d√©placement de l'enregistrement le long de X, mais une seule valeur de d√©placement de l'enregistrement le long de Y et Z.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette situation se produit pour la plupart des os dans environ 95% de nos animations, donc √† la fin, nous pouvons r√©duire consid√©rablement la m√©moire occup√©e, absolument sans perdre en qualit√©. Cela n√©cessite un travail du point de vue de la cr√©ation de contenu (DCC): nous ne voulons pas que les os aient de l√©gers mouvements et zooms dans le flux de travail de cr√©ation d'animation, mais un tel avantage vaut le co√ªt suppl√©mentaire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre exemple d'animation, il n'y a que deux enregistrements avec d√©placement et aucun enregistrement avec √©chelle. Ensuite, pendant 1 seconde d'animation, le volume de donn√©es passe de 41 Ko √† 18,6 Ko (soit jusqu'√† 20% du volume des donn√©es d'origine). La situation devient encore meilleure avec l'augmentation de la dur√©e de l'animation, nous d√©pensons des ressources uniquement pour l'enregistrement des virages et des mouvements dynamiques, et le co√ªt des enregistrements statiques reste constant, ce qui √©conomise davantage dans les longues animations. Et nous n'avons pas √† subir de perte de qualit√© caus√©e par l'√©chantillonnage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec toutes ces informations √† l'esprit, mon sch√©ma de donn√©es final ressemble √† ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9f5/347/eb0/9f5347eb09718967ebacbe89d443e992.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de sch√©ma de donn√©es d'animation compress√© (3 images par enregistrement)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
De plus, je sauvegarde le d√©calage dans le bloc de donn√©es pour d√©marrer les donn√©es de chaque os. </font><font style="vertical-align: inherit;">Cela est n√©cessaire car parfois nous devons √©chantillonner des donn√©es pour un seul os sans lire la pose enti√®re. </font><font style="vertical-align: inherit;">Cela nous permet d'acc√©der rapidement aux donn√©es d'enregistrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des donn√©es d'animation stock√©es dans un bloc de m√©moire, j'ai √©galement des options de compression pour chaque enregistrement:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d7/b3d/7a3/4d7b3d7a3f1362c0429d72591268dbce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de param√®tres de compression pour les enregistrements de mon moteur Kruger</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ces param√®tres stockent toutes les donn√©es dont j'ai besoin pour d√©coder les valeurs √©chantillonn√©es de chaque enregistrement. </font><font style="vertical-align: inherit;">Ils surveillent √©galement la statique des enregistrements afin que je sache comment g√©rer les donn√©es compress√©es lorsque je tombe sur un enregistrement statique lors de l'√©chantillonnage.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©galement remarquer que la discr√©tisation de chaque enregistrement est individuelle: pendant la compression, je surveille les valeurs minimales et maximales de chaque caract√©ristique (par exemple, le long du X) de chaque enregistrement pour garantir que les donn√©es sont discr√©tis√©es dans l'intervalle minimum / maximum et maintenir une pr√©cision maximale. </font><font style="vertical-align: inherit;">Je ne pense pas qu'il soit g√©n√©ralement possible de cr√©er des intervalles d'√©chantillonnage globaux sans d√©truire vos donn√©es (lorsque les valeurs sont en dehors de l'intervalle) et sans commettre d'erreurs significatives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quoi qu'il en soit, voici un bref r√©sum√© de mes stupides tentatives pour impl√©menter la compression d'animation: au final, j'utilise presque la compression.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491942/index.html">Comment nous utilisons item2vec pour recommander des produits similaires</a></li>
<li><a href="../fr491944/index.html">Comment combiner deux plates-formes en une seule et ne pas offenser les utilisateurs. Exp√©rience des d√©veloppeurs Yandex.Kew</a></li>
<li><a href="../fr491946/index.html">Lois de programmation</a></li>
<li><a href="../fr491948/index.html">Les jetons de conception peuvent faire plus: cr√©er une source unique d'informations sur les composants de l'interface utilisateur</a></li>
<li><a href="../fr491956/index.html">Version Rust 1.42.0: mod√®les de tranche et messages de panique plus pratiques</a></li>
<li><a href="../fr491960/index.html">Era quand il est difficile de se perdre</a></li>
<li><a href="../fr491962/index.html">VPN killer. Acc√®s √† distance appropri√© aux serveurs de combat</a></li>
<li><a href="../fr491964/index.html">Ex√©cution de code √† distance dans SMB v3: CVE-2020-0796</a></li>
<li><a href="../fr491974/index.html">Coronavirus: pourquoi vous devez agir d√®s maintenant</a></li>
<li><a href="../fr491976/index.html">Nous transformons l'√©conomie UNITAIRE pour une boutique ou une production en ligne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>