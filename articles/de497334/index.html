<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí≥ ‚úçüèΩ üë©‚Äçüåæ Die ber√ºchtigten Fehler und wie man sie am Beispiel von ClickHouse vermeidet üë©üèø‚Äçü§ù‚Äçüë©üèª üîù üíÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn Sie Code schreiben, bereiten Sie sich auf Probleme vor. Sie werden es definitiv sein und sollten von allen Seiten erwartet werden: von Ihrem Code...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Die ber√ºchtigten Fehler und wie man sie am Beispiel von ClickHouse vermeidet</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497334/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie Code schreiben, bereiten Sie sich auf Probleme vor. </font><font style="vertical-align: inherit;">Sie werden es definitiv sein und sollten von allen Seiten erwartet werden: von Ihrem Code und Compiler, vom Betriebssystem und der Hardware, und Benutzer werfen manchmal ‚Äû√úberraschungen‚Äú auf. </font><font style="vertical-align: inherit;">Wenn Sie den Cluster auf kosmische Skalen skaliert haben, erwarten Sie "Space" -Fehler. </font><font style="vertical-align: inherit;">Besonders wenn es um Daten aus dem Internetverkehr geht.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ooBAQIe0KlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey Milovidov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) wird √ºber die l√§cherlichsten, entmutigendsten und hoffnungslosesten Probleme seiner Erfahrung bei der Entwicklung und Unterst√ºtzung von ClickHouse sprechen. </font><font style="vertical-align: inherit;">Mal sehen, wie sie debuggt werden mussten und welche Ma√ünahmen die Entwickler von Anfang an ergreifen sollten, damit es weniger Probleme gibt.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notorische Fehler</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie Code geschrieben haben, bereiten Sie sich sofort auf Probleme vor. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler im Code.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie werden ben√∂tigt. Angenommen, Sie haben den perfekten Code geschrieben, kompiliert, aber </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Compiler werden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fehler </font><strong><font style="vertical-align: inherit;">angezeigt,</font></strong><font style="vertical-align: inherit;"> und der Code funktioniert nicht richtig. Wir haben den Compiler repariert, alles kompiliert - f√ºhren Sie es aus. Aber (unerwartet) funktioniert alles falsch, weil </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es auch Fehler im Kernel des Betriebssystems gibt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Betriebssystem keine Fehler enth√§lt, liegt dies zwangsl√§ufig </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in der Hardware vor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Selbst wenn Sie den perfekten Code geschrieben haben, der perfekt auf der perfekten Hardware funktioniert, treten immer noch Probleme auf, z. B. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationsfehler</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es scheint, dass Sie alles richtig gemacht haben, aber jemand hat einen Fehler in der Konfigurationsdatei gemacht, und alles funktioniert nicht mehr.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn alle Fehler behoben wurden, beenden die Benutzer den Vorgang, da sie Ihren Code st√§ndig "falsch" verwenden. </font><font style="vertical-align: inherit;">Das Problem liegt aber definitiv nicht bei den Benutzern, sondern im Code: Sie </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">haben etwas geschrieben, das schwer zu verwenden ist</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns diese Fehler anhand einiger Beispiele an.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationsfehler</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√∂schen von Daten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Der erste Fall aus der Praxis. Zum Gl√ºck nicht meine und nicht Yandex, mach dir keine Sorgen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einf√ºhrung zuerst. Die Architektur eines Map-Reduce-Clusters (z. B. Hadoop) besteht aus mehreren Datenservern (Datenknoten), die Daten speichern, und einem oder mehreren Master-Servern, die den Speicherort aller Daten auf den Servern kennen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Datenknoten kennen die Adresse des Masters und stellen eine Verbindung zu diesem her. Der Assistent √ºberwacht, wo und welche Daten sich befinden sollen, und gibt den Datenknoten verschiedene Befehle: "Laden Sie die Daten X herunter, Sie m√ºssen die Daten Y haben und die Daten Z l√∂schen." Was k√∂nnte schiefgehen?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine neue Konfigurationsdatei auf alle Datenknoten hochgeladen wurde, wurden sie f√§lschlicherweise von einem anderen Cluster aus mit dem Master verbunden und nicht mit ihrem eigenen. </font><font style="vertical-align: inherit;">Der Master sah sich die Daten an, √ºber die die Datenknoten informiert wurden, entschied, dass die Daten falsch waren und gel√∂scht werden sollten. </font><font style="vertical-align: inherit;">Das Problem wurde festgestellt, als die H√§lfte der Daten gel√∂scht wurde.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/ii/6i/s8ii6igrww4j3zdjhrfyyqrl2nk.png" width="350"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die epischsten Fehler sind diejenigen, die zum versehentlichen L√∂schen von Daten f√ºhren.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies zu vermeiden ist sehr einfach. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daten nicht l√∂schen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Legen Sie es beispielsweise in ein separates Verzeichnis oder l√∂schen Sie es mit Verz√∂gerung. Zuerst √ºbertragen wir, damit sie f√ºr den Benutzer nicht sichtbar sind. Wenn er feststellt, dass innerhalb weniger Tage etwas verschwunden ist, geben wir es zur√ºck. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√∂schen Sie keine unerwarteten Daten, wenn die Ursache unbekannt ist</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Begrenzen Sie programmgesteuert den Beginn des L√∂schens unbekannter Daten: unerwartet, mit seltsamen Namen oder wenn zu viele vorhanden sind. Der Administrator wird feststellen, dass der Server nicht startet und eine Nachricht schreibt, und wird verstehen. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn das Programm destruktive Aktionen ausf√ºhrt, isolieren Sie Test und Produktion auf Netzwerkebene</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(iptables). Das L√∂schen von Dateien oder das Senden von E-Mails ist beispielsweise eine destruktive Aktion, da dadurch die Aufmerksamkeit einer Person ‚Äûaufgefressen‚Äú wird. Setzen Sie eine Schwelle auf sie: Hundert Briefe k√∂nnen gesendet werden, und f√ºr tausend setzen Sie ein Sicherheits-Kontrollk√§stchen, das gesetzt wird, bevor etwas Schreckliches passiert. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das zweite Beispiel stammt bereits aus meiner Praxis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine gute Firma hatte irgendwie einen seltsamen ClickHouse-Cluster. Das Seltsame war, dass die Replikate nicht synchronisiert wurden. Beim Neustart des Servers wurde er nicht gestartet und es wurde die Meldung angezeigt, dass alle Daten falsch waren: ‚ÄûEs gibt viele unerwartete Daten, ich werde nicht starten. Wir m√ºssen die Flagge setzen </font></font><code>force_restore_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und es herausfinden. ‚Äú</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Niemand konnte es in der Firma herausfinden - sie haben nur die Flagge gesetzt. Gleichzeitig verschwand die H√§lfte der Daten irgendwo, was zu Diagrammen mit L√ºcken f√ºhrte. Die Entwickler wandten sich an mich, ich dachte, dass etwas Interessantes passiert, und beschlossen, dies zu untersuchen. Als der Morgen einige Stunden sp√§ter kam und die V√∂gel vor dem Fenster zu singen begannen, wurde mir klar, dass ich nichts verstand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der ClickHouse-Server verwendet den ZooKeeper-Dienst zur Koordination. ClickHouse speichert Daten, und ZooKeeper bestimmt, auf welchen Servern welche Daten liegen sollen: Speichert Metadaten dar√ºber, auf welchen Daten sich welches Replikat befinden soll. ZooKeeper ist auch ein Cluster - er repliziert nach einem sehr guten verteilten Konsensalgorithmus mit strenger Konsistenz.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Regel besteht ZooKeeper aus 3 Computern, manchmal aus 5. In der ClickHouse-Konfiguration werden alle Computer gleichzeitig angezeigt, die Verbindung wird mit einem zuf√§lligen Computer hergestellt, interagiert mit diesem Computer und dieser Server repliziert alle Anforderungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist passiert? Das Unternehmen hatte drei ZooKeeper-Server. Sie arbeiteten jedoch nicht als </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster von drei Knoten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sondern als </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drei unabh√§ngige Knoten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - drei Cluster von einem Knoten. Ein ClickHouse stellt eine Verbindung zu einem Server her und schreibt Daten. Die Replikate m√∂chten diese Daten herunterladen, sind jedoch nirgends zu finden. Beim Neustart stellt der Server eine Verbindung zu einem anderen ZooKeeper her: Er sieht, dass die Daten, mit denen er zuvor gearbeitet hat, √ºberfl√ºssig sind, und muss irgendwo verschoben werden. Er l√∂scht sie nicht, sondern √ºbertr√§gt sie in ein separates Verzeichnis - in ClickHouse werden Daten nicht so einfach gel√∂scht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich beschlie√üe, die ZooKeeper-Konfiguration zu korrigieren. </font><font style="vertical-align: inherit;">Ich benenne alle Daten um und fordere </font></font><code>ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teile der Daten aus dem Verzeichnis an </font></font><code>detached/unexpeted_*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen wurden alle Daten wiederhergestellt, die Replikate wurden synchronisiert, es gab keine Verluste, die Diagramme waren kontinuierlich. </font><font style="vertical-align: inherit;">Das Unternehmen ist zufrieden, dankbar, als h√§tte es bereits vergessen, wie alles zuvor schlecht funktioniert hatte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies waren einfache Konfigurationsfehler. </font><font style="vertical-align: inherit;">Weitere Fehler werden im Code enthalten sein.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler im Code</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir schreiben Code in C ++. </font><font style="vertical-align: inherit;">Dies bedeutet, dass wir bereits Probleme haben.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das n√§chste Beispiel ist ein echter Fehler aus der Produktion </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Yandex.Metrica-Cluster</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2015) - eine Folge des C ++ - Codes. </font><font style="vertical-align: inherit;">Der Fehler war, dass der Benutzer manchmal eine Fehlermeldung erhielt, anstatt auf die Anfrage zu antworten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Pr√ºfsumme stimmt nicht √ºberein, besch√§digte Daten" - die Pr√ºfsumme stimmt nicht √ºberein, die Daten sind kaputt - be√§ngstigend!</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache wurde inkonsistent. </font><font style="vertical-align: inherit;">Es muss ein Fehler darin sein ‚Äú- der Cache wurde inkonsistent, h√∂chstwahrscheinlich ein Fehler darin.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Code, den wir geschrieben haben, informiert sich selbst dar√ºber, dass dort ein Fehler vorliegt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
" </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√ºfsumme stimmt nicht √ºberein, besch√§digte Daten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." </font><font style="vertical-align: inherit;">Pr√ºfsummen komprimierter Datenbl√∂cke werden vor dem Dekomprimieren gepr√ºft. </font><font style="vertical-align: inherit;">Normalerweise tritt dieser Fehler auf, wenn Daten im Dateisystem besch√§digt werden. </font><font style="vertical-align: inherit;">Aus verschiedenen Gr√ºnden stellen sich einige Dateien beim Neustart des Servers als M√ºll heraus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber hier ist ein anderer Fall: Ich habe die Datei manuell gelesen, die Pr√ºfsumme stimmt √ºberein, es gibt keinen Fehler. </font><font style="vertical-align: inherit;">Einmal aufgetreten, wird der Fehler bei wiederholter Anforderung stabil reproduziert. </font><font style="vertical-align: inherit;">Wenn der Server neu gestartet wird, verschwindet der Fehler f√ºr eine Weile und erscheint dann wieder stabil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht ist die Sache im RAM? </font><font style="vertical-align: inherit;">Eine typische Situation ist, wenn Bits darin schlagen. </font><font style="vertical-align: inherit;">Ich schaue in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dmesg</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(kern.log), aber es gibt keine Maschinenpr√ºfungsausnahmen - sie schreiben normalerweise, wenn etwas mit dem RAM nicht stimmt. Wenn der Server RAM geschlagen h√§tte, w√ºrde nicht nur mein Programm falsch funktionieren, sondern alle anderen w√ºrden zuf√§llig Fehler erzeugen. Es gibt jedoch keine anderen Manifestationen des Fehlers. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache wurde inkonsistent. Es muss ein Fehler darin sein. "</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dies ist ein klarer Fehler im Code, und wir schreiben in C ++ - vielleicht Speicherzugriff? Tests unter AddressSanitizer, ThreadSanitizer, MemorySanitizer und UndefinedBehaviorSanitizer in CI zeigen jedoch nichts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht werden einige Testf√§lle nicht behandelt? Ich sammle den Server mit AddressSanitizer, f√ºhre ihn in der Produktion aus - er f√§ngt nichts ab. F√ºr einige Zeit wird der Fehler durch Zur√ºcksetzen eines Markierungscaches (Sachet-Cache) behoben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der Programmierregeln besagt: Wenn der Fehler nicht klar ist, schauen Sie sich den Code genau an und hoffen Sie, dort etwas zu finden. Ich habe es getan, einen Fehler gefunden, ihn behoben - es hat nicht geholfen. Ich sehe mir eine andere Stelle im Code an - es gibt auch einen Fehler. Korrigiert, hat wieder nicht geholfen. Ich habe ein paar mehr behoben, der Code wurde besser, aber der Fehler verschwand immer noch nicht! </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ursache.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Der Versuch, ein Muster nach Server, Zeit und Art der Last zu finden, hilft nichts. Dann erkannte er, dass sich das Problem nur in einem der Cluster und niemals in den anderen manifestiert. Der Fehler wird nicht so oft reproduziert, erscheint jedoch nach einem Neustart immer auf einem Cluster und auf dem anderen ist alles sauber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass der Grund daf√ºr ist, dass im "Problem" -Cluster eine neue Funktion verwendet wurde - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache-W√∂rterb√ºcher</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sie verwenden den handgeschriebenen Speicherzuordner </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ArenaWithFreeLists</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wir haben nicht nur in C ++ geschrieben, sondern auch eine Art benutzerdefinierte Allokatoren gesehen - wir verurteilen uns zweimal zu Problemen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArenaWithFreeLists ist ein Teil des Speichers, in dem der Speicher nacheinander in Gr√∂√üen zugewiesen wird, die durch zwei teilbar sind: 16, 32, 64 Byte. </font><font style="vertical-align: inherit;">Wenn Speicher freigegeben wird, bilden sie eine einfach verkn√ºpfte Liste freier FreeLists-Bl√∂cke. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns den Code an.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArenaWithFreeLists</span>
{</span>
    Block * free_lists[<span class="hljs-number">16</span>] {};
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">sizeToPreviousPowerOfTwo</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">return</span> _bit_scan_reverse(size - <span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">char</span> * <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> list_idx = findFreeListIndex(size);<font></font>
        free_lists[list_idx] -&gt;...<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird eine Funktion </font></font><code>_bit_scan_reverse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Unterstrich am Anfang verwendet.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt eine ungeschriebene Regel: "Wenn eine Funktion am Anfang einen Unterstrich hat, lesen Sie die Dokumentation einmal und wenn zwei, lesen Sie sie zweimal."</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir h√∂ren zu und lesen die Dokumentation: ‚Äûint _bit_scan_reverse (int a). Setzen Sie dst auf den Index des h√∂chsten gesetzten Bits in der 32-Bit-Ganzzahl a. Wenn in a keine Bits gesetzt sind, ist dst </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undefiniert</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . " Wir scheinen ein Problem gefunden zu haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In C ++ wird diese Situation f√ºr den Compiler als unm√∂glich angesehen. Der Compiler kann undefiniertes Verhalten, diese ‚ÄûUnm√∂glichkeit‚Äú, als Annahme f√ºr die Optimierung des Codes verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Compiler macht nichts falsch - er generiert ehrlich Montageanweisungen </font></font><code>bsr %edi, %eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Aber, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn der Operand null ist, hat die Anweisung </font></font></strong><code><strong>bsr</strong></code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht definiertes Verhalten nicht an der C ++ Ebene, sondern auf CPU - </font><font style="vertical-align: inherit;">Ebene.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn das Quellregister Null ist, √§ndert sich das Zielregister nicht: Es gab etwas M√ºll am Eingang, dieser M√ºll bleibt auch am Ausgang.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis h√§ngt davon ab, wo der Compiler diese Anweisung ablegt. </font><font style="vertical-align: inherit;">Manchmal ist eine Funktion mit dieser Anweisung inline, manchmal nicht. </font><font style="vertical-align: inherit;">Im zweiten Fall gibt es so etwas wie diesen Code:</font></font><br>
<br>
<pre><code class="cpp hljs">bsrl %edi, %eax<font></font>
retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann habe ich mir ein Beispiel f√ºr √§hnlichen Code in meiner Bin√§rdatei mit angesehen </font></font><code>objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/6k/4f/lq6k4fg0lwpm2nhwhxbyauyjt2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den Ergebnissen sehe ich, dass manchmal das Quellregister und das Zielregister gleich sind. </font><font style="vertical-align: inherit;">Wenn es Null gab, ist das Ergebnis auch Null - alles ist in Ordnung. </font><font style="vertical-align: inherit;">Aber manchmal sind die Register unterschiedlich und das Ergebnis ist M√ºll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie manifestiert sich dieser Fehler?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir verwenden Garbage als Index im FreeLists-Array. </font><font style="vertical-align: inherit;">Anstelle eines Arrays gehen wir zu einer entfernten Adresse und erhalten Speicherzugriff.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben Gl√ºck, dass fast alle Adressen in der N√§he mit Daten aus dem Cache gef√ºllt sind - wir verderben den Cache. </font><font style="vertical-align: inherit;">Der Cache enth√§lt Datei-Offsets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir lesen Dateien mit dem falschen Versatz. </font><font style="vertical-align: inherit;">Aus dem falschen Offset erhalten wir die Pr√ºfsumme. </font><font style="vertical-align: inherit;">Es gibt jedoch keine Pr√ºfsumme, sondern etwas anderes - diese Pr√ºfsumme stimmt nicht mit den folgenden Daten √ºberein.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erhalten den Fehler "Pr√ºfsumme stimmt nicht √ºberein, besch√§digte Daten".</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gl√ºcklicherweise sind nicht Daten besch√§digt, sondern nur der Cache im RAM. </font><font style="vertical-align: inherit;">Wir wurden sofort √ºber den Fehler informiert, da wir die Daten √ºberpr√ºfen. </font><font style="vertical-align: inherit;">Der Fehler wurde </font><font style="vertical-align: inherit;">am 27. Dezember 2015 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">behoben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und ging zum Feiern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen, kann zumindest der falsche Code behoben werden. </font><font style="vertical-align: inherit;">Aber wie behebt man Fehler in der Hardware?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K√§fer in Eisen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies sind nicht einmal Fehler, sondern physikalische Gesetze - unvermeidliche Auswirkungen. Nach physikalischen Gesetzen ist Eisen unweigerlich fehlerhaft. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nichtatomares Schreiben in RAID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Zum Beispiel haben wir RAID1 erstellt. Es besteht aus zwei Festplatten. Dies bedeutet, dass ein Server ein verteiltes System ist: Daten werden auf eine Festplatte und auf eine andere geschrieben. Was aber, wenn Daten auf eine Disc geschrieben werden und die Stromversorgung w√§hrend der Aufnahme auf die zweite unterbrochen wird? Daten auf einem RAID1-Array sind nicht konsistent. Wir werden nicht verstehen k√∂nnen, welche Daten korrekt sind, weil wir das eine oder andere Byte lesen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen damit umgehen, indem Sie das Protokoll platzieren. In ZFS ist dieses Problem beispielsweise gel√∂st, aber dazu sp√§ter mehr. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit Rot auf HDD und SSD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Bits auf Festplatten und auf SSDs k√∂nnen einfach so schlecht werden. Moderne SSDs, insbesondere solche mit mehrstufigen Zellen, sollen sicherstellen, dass sich die Zellen st√§ndig verschlechtern. Fehlerkorrekturcodes helfen, aber manchmal verschlechtern sich die Zellen so sehr und so sehr, dass selbst dies nicht spart. Es werden unentdeckte Fehler erhalten. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit flippt im RAM</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (aber was ist mit ECC?). Im RAM von Servern sind auch Bits besch√§digt. Es hat auch Fehlerkorrekturcodes. Wenn Fehler auftreten, sind sie normalerweise in den Meldungen im Linux-Kernel-Protokoll in dmesg sichtbar. Wenn es viele Fehler gibt, sehen wir etwas wie: "N Millionen Fehler mit Speicher wurden behoben." Aber einzelne Teile werden nicht bemerkt und mit Sicherheit wird etwas fehlerhaft sein. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit-Flips auf CPU- und Netzwerkebene</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es gibt Fehler auf CPU-Ebene, in CPU-Caches und nat√ºrlich beim √úbertragen von Daten √ºber ein Netzwerk.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie manifestieren sich Eisenfehler normalerweise? Das Ticket " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein fehlerhafter Znode verhindert das Starten von ClickHouse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">geht an GitHub </font><font style="vertical-align: inherit;">- die Daten im ZooKeeper-Knoten sind besch√§digt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In ZooKeeper schreiben wir normalerweise einige Metadaten im Klartext. Mit ihm stimmt etwas nicht - " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replik</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " ist sehr seltsam geschrieben. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/gk/zk/8_gkzkxlb1dzwhiph0saer-0d50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es kommt selten vor, dass sich aufgrund eines Fehlers im Code ein Bit √§ndert. Nat√ºrlich k√∂nnen wir einen solchen Code schreiben: Wir nehmen den Bloom-Filter, √§ndern das Bit an bestimmten Adressen, berechnen die Adressen falsch, √§ndern das falsche Bit, es f√§llt auf einige Daten. Das ist es, jetzt in ClickHouse ist es nicht ‚Äû </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replik‚Äú</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sondern ‚Äû </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repli </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äú und auf sie alle Daten falsch ist. Aber normalerweise ist eine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ñnderung in einem Bit ein Symptom f√ºr Eisenprobleme</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht kennen Sie das Beispiel der Bitquatting. </font><font style="vertical-align: inherit;">Artyom Dinaburg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hat ein Experiment durchgef√ºhrt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Es gibt Domains im Internet, die viel Verkehr haben, obwohl Benutzer diese Domains nicht alleine aufrufen. </font><font style="vertical-align: inherit;">Beispielsweise ist eine solche Domain FB-CDN.com ein Facebook-CDN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artyom hat eine √§hnliche Domain (und viele andere) registriert, aber ein bisschen ge√§ndert. </font><font style="vertical-align: inherit;">Zum Beispiel FA-CDN.com anstelle von FB-CDN.com. </font><font style="vertical-align: inherit;">Die Domain wurde nirgendwo ver√∂ffentlicht, aber es kam Verkehr dazu. </font><font style="vertical-align: inherit;">Manchmal wurde der FB-CDN-Host in die HTTP-Header geschrieben, und die Anforderung wurde aufgrund von RAM-Fehlern auf den Ger√§ten der Benutzer an einen anderen Host gesendet. </font><font style="vertical-align: inherit;">RAM mit Fehlerkorrektur hilft nicht immer. </font><font style="vertical-align: inherit;">Manchmal st√∂rt es sogar und f√ºhrt zu Schwachstellen (lesen Sie √ºber Rowhammer, ECCploit, RAMBleed).</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit: √úberpr√ºfen Sie die Daten immer selbst.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie beim Schreiben in das Dateisystem unbedingt. </font><font style="vertical-align: inherit;">√úberpr√ºfen Sie beim Senden √ºber das Netzwerk auch die Check-Summary - erwarten Sie nicht, dass dort Check-Summen vorhanden sind.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weitere Bugs! ..</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produktionscluster-Metriken</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Benutzer, die auf eine Anfrage antworten, erhalten manchmal eine Ausnahme: "Pr√ºfsumme stimmt nicht √ºberein: besch√§digte Daten" - die Pr√ºfsumme ist nicht korrekt, die Daten sind besch√§digt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/lb/wz/jylbwzqxrbk-g3hgygq4bktgdr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Fehlermeldung werden detaillierte Daten angezeigt: Welcher Pr√ºfbetrag wurde erwartet, welcher Pr√ºfbetrag ist tats√§chlich in diesen Daten enthalten, die Gr√∂√üe des Blocks, f√ºr den wir den Pr√ºfbetrag pr√ºfen, und der Ausnahmekontext. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als wir das Paket √ºber das Netzwerk von einem Server erhalten haben, ist eine Ausnahme aufgetreten - es kommt mir bekannt vor. </font><font style="vertical-align: inherit;">Vielleicht wieder durch Erinnerung, Rassenzustand oder etwas anderes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Ausnahme trat 2015 auf. Der Fehler wurde behoben, er erschien nicht mehr. Im Februar 2019 erschien er pl√∂tzlich wieder. Zu dieser Zeit war ich auf einer der Konferenzen, meine Kollegen haben sich mit dem Problem befasst. Der Fehler wurde mit ClickHouse mehrmals t√§glich auf 1000 Servern reproduziert: Es ist nicht m√∂glich, Statistiken auf einem Server und dann auf einem anderen zu sammeln. Gleichzeitig gab es zu diesem Zeitpunkt keine Neuerscheinungen. Es hat nicht geklappt und das Problem gel√∂st, aber nach ein paar Tagen ist der Fehler selbst verschwunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie verga√üen den Fehler und am 15. Mai 2019 wiederholte er sich. Wir haben uns weiter um sie gek√ºmmert. Als erstes habe ich mir alle verf√ºgbaren Protokolle und Grafiken angesehen. Er studierte sie den ganzen Tag, verstand nichts, fand keine Muster. Wenn das Problem nicht reproduziert werden kann, besteht die einzige M√∂glichkeit darin, alle F√§lle zu erfassen und </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach Mustern zu suchen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und Sucht. </font><font style="vertical-align: inherit;">M√∂glicherweise funktioniert der Linux-Kernel nicht richtig mit dem Prozessor, speichert oder l√§dt falsch Register.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothesen und Muster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 von 9 Servern mit E5-2683 v4 sind ausgefallen. Von der Fehleranf√§lligkeit ist jedoch nur etwa die H√§lfte des E5-2683 v4 eine leere Hypothese. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler werden normalerweise nicht wiederholt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Zus√§tzlich zum mtauxyz-Cluster, in dem tats√§chlich besch√§digte Daten vorhanden sind (fehlerhafte Daten auf der Festplatte). Dies ist ein weiterer Fall, wir lehnen die Hypothese ab. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Fehler h√§ngt nicht vom Linux-Kernel ab</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - auf verschiedenen Servern √ºberpr√ºft, nichts gefunden. Nichts interessantes in kern.log, </font></font><code>machine check exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keine </font><font style="vertical-align: inherit;">Nachrichten </font><font style="vertical-align: inherit;">. In Netzwerkgrafiken, einschlie√ülich Retransmittern, CPU, IO, Netzwerk, nichts Interessantes. Alle Netzwerkadapter auf den Servern, auf denen Fehler auftreten und nicht angezeigt werden, sind identisch. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt keine Muster</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Was zu tun ist? Suchen Sie weiter nach Mustern. Zweiter Versuch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich schaue mir Upsime-Server an:</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Betriebszeit ist hoch, die Server arbeiten stabil</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Segfault und so etwas nicht. Ich freue mich immer, wenn ich sehe, dass das Programm mit segfault abgest√ºrzt ist - zumindest ist es abgest√ºrzt. Schlimmer noch, wenn es einen Fehler gibt, verdirbt es etwas, aber niemand bemerkt es. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler werden nach Tag gruppiert</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und treten innerhalb weniger Tage auf. In etwa 2 Tagen erscheinen mehr, in einigen weniger, dann wieder mehr - es ist nicht m√∂glich, den Zeitpunkt des Auftretens von Fehlern genau zu bestimmen. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einige Fehler stimmen mit den Paketen und dem erwarteten Scheckbetrag √ºberein.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die meisten Fehler haben nur zwei Paketoptionen. Ich hatte Gl√ºck, weil wir in der Fehlermeldung genau den Wert der Pr√ºfsumme hinzugef√ºgt haben, was beim Erstellen von Statistiken geholfen hat. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Servermuster</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">woher wir die Daten lesen. Die Gr√∂√üe des komprimierten Blocks, den wir pr√ºfen, betr√§gt weniger als ein Kilobyte. Sah auf die Packungsgr√∂√üen in HEX. Dies war f√ºr mich nicht n√ºtzlich - die bin√§re Darstellung von Paketgr√∂√üen und Pr√ºfsummen ist nicht erkennbar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe den Fehler nicht behoben - ich habe wieder nach Mustern gesucht. Dritter Versuch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus irgendeinem Grund tritt der Fehler nur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem der Cluster auf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - in den dritten Replikaten im Vladimir DC (wir nennen Rechenzentren gerne nach St√§dtenamen). Im Februar 2019 trat auch in Vladimirs DC ein Fehler auf, jedoch in einer anderen Version von ClickHouse. Dies ist ein weiteres Argument gegen die Hypothese, dass wir den falschen Code geschrieben haben. Wir haben es von Februar bis Mai bereits dreimal umgeschrieben - der </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler ist wahrscheinlich nicht im Code enthalten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Fehler beim Lesen von Paketen √ºber das Netzwerk -</font></font><code>while receiving packet from</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das Paket, bei dem der Fehler aufgetreten ist, h√§ngt von der Struktur der Anforderung ab. </font><font style="vertical-align: inherit;">Bei Anfragen, die sich in der Struktur unterscheiden, ein Fehler bei verschiedenen Pr√ºfsummen. </font><font style="vertical-align: inherit;">Bei Anforderungen, bei denen sich der Fehler auf derselben Pr√ºfsumme befindet, unterscheiden sich die Konstanten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Anfragen mit einem Fehler, bis auf eine, sind </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Zum Vergleich gibt es jedoch eine ungew√∂hnlich einfache Anforderung, und die komprimierte Blockgr√∂√üe daf√ºr betr√§gt nur 75 Byte.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(ReceiveTimestamp) <span class="hljs-keyword">FROM</span> tracking_events_all 
<span class="hljs-keyword">WHERE</span> APIKey = <span class="hljs-number">1111</span> <span class="hljs-keyword">AND</span> (OperatingSystem <span class="hljs-keyword">IN</span> (<span class="hljs-string">'android'</span>, <span class="hljs-string">'ios'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir lehnen die Hypothese des Einflusses ab </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am interessantesten ist, dass die betroffenen Server </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach ihren Namen in Bereiche gruppiert sind</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich war m√ºde und verzweifelt und begann nach v√∂llig wahnhaften Mustern zu suchen. </font><font style="vertical-align: inherit;">Es ist gut, dass ich den Code nicht mit Numerologie debuggen konnte. </font><font style="vertical-align: inherit;">Aber es gab immer noch Hinweise.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gruppen der Problemserver sind dieselben wie im Februar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemserver befinden sich in bestimmten Teilen des Rechenzentrums. </font><font style="vertical-align: inherit;">In DC Vladimir gibt es sogenannte Linien - seine verschiedenen Teile: VLA-02, VLA-03, VLA-04. </font><font style="vertical-align: inherit;">Fehler sind klar gruppiert: In einigen Warteschlangen ist es gut (VLA-02), in anderen Problemen (VLA-03, VLA-04).</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debugging eingeben</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es blieb nur das Debuggen mit der "Spear" -Methode. </font><font style="vertical-align: inherit;">Dies bedeutet, die Hypothese zu bilden: "Was passiert, wenn Sie dies versuchen?" </font><font style="vertical-align: inherit;">und Daten sammeln. </font><font style="vertical-align: inherit;">Zum Beispiel habe ich eine </font></font><code>query_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einfache Abfrage mit einem Fehler </font><font style="vertical-align: inherit;">in der Tabelle gefunden, </font><font style="vertical-align: inherit;">f√ºr die die Paketgr√∂√üe </font></font><code>size of compressed block</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehr klein ist (= 107). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/zz/fd/cszzfdvfkob2rhon1-n_xfnqtn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich nahm die Anfrage, kopierte sie und f√ºhrte sie manuell mit clickhouse-local aus.</font></font><br>
<br>
<pre><code class="sql hljs">strace -f -e trace=network -s 1000 -x \<font></font>
clickhouse-local <span class="hljs-comment">--query "</span>
    <span class="hljs-keyword">SELECT</span> uniqIf(DeviceIDHash, SessionType = <span class="hljs-number">0</span>)
    <span class="hljs-keyword">FROM</span> remote(<span class="hljs-string">'127.0.0.{2,3}'</span>, mobile.generic_events)
    <span class="hljs-keyword">WHERE</span> StartDate = <span class="hljs-string">'2019-02-07'</span> <span class="hljs-keyword">AND</span> APIKey <span class="hljs-keyword">IN</span> (<span class="hljs-number">616988</span>,<span class="hljs-number">711663</span>,<span class="hljs-number">507671</span>,<span class="hljs-number">835591</span>,<span class="hljs-number">262098</span>,<span class="hljs-number">159700</span>,<span class="hljs-number">635121</span>,<span class="hljs-number">509222</span>)
        <span class="hljs-keyword">AND</span> EventType = <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> TOTALS<span class="hljs-string">" --config config.xml</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Hilfe von strace habe ich einen Snapshot (Dump) von Bl√∂cken √ºber das Netzwerk erhalten - genau dieselben Pakete, die empfangen werden, wenn diese Anforderung ausgef√ºhrt wird, und ich kann sie untersuchen. Sie k√∂nnen tcpdump daf√ºr verwenden, dies ist jedoch unpraktisch: Es ist schwierig, eine bestimmte Anforderung vom Produktionsverkehr zu isolieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit strace k√∂nnen Sie den ClickHouse-Server selbst verfolgen. Aber dieser Server funktioniert in der Produktion. Wenn ich das mache, bekomme ich eine Reihe unverst√§ndlicher Informationen. Aus diesem Grund habe ich ein separates Programm gestartet, das genau eine Anforderung ausf√ºhrt. Bereits f√ºr dieses Programm starte ich strace und bekomme, was √ºber das Netzwerk √ºbertragen wurde. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anfrage wird fehlerfrei ausgef√ºhrt - der Fehler wird nicht reproduziert</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Bei einer Reproduktion w√§re das Problem behoben. Daher habe ich die Pakete in eine Textdatei kopiert und das Protokoll manuell analysiert.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f5/0y/-8/f50y-8qvloj4brnns-nvgydpbsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Scheckbetrag war der gleiche wie erwartet. </font><font style="vertical-align: inherit;">Dies ist genau das Paket, bei dem manchmal, zu einem anderen Zeitpunkt, bei anderen Anforderungen Fehler aufgetreten sind. </font><font style="vertical-align: inherit;">Bisher sind jedoch keine Fehler aufgetreten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe ein einfaches Programm geschrieben, das ein Paket nimmt und den Pr√ºfbetrag √ºberpr√ºft, wenn ein Bit in jedem Byte ersetzt wird. </font><font style="vertical-align: inherit;">Das Programm f√ºhrte an jeder m√∂glichen Position einen Bit-Flip durch und las den Pr√ºfbetrag. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/fn/wr/3mfnwrp1udvm_ecrw0lnpcyoz0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe das Programm gestartet und festgestellt, dass Sie, wenn Sie den Wert eines Bits √§ndern, genau die kaputte Pr√ºfsumme erhalten, f√ºr die es eine Beschwerde gibt</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardwareproblem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn in der Software ein Fehler auftritt (z. B. beim Durchlaufen des Speichers), ist ein Einzelbit-Flip unwahrscheinlich. </font><font style="vertical-align: inherit;">Daher erschien eine neue Hypothese - das Problem liegt in der Dr√ºse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Man k√∂nnte den Deckel des Laptops schlie√üen und sagen: "Das Problem ist nicht auf unserer Seite, aber in der Hardware machen wir das nicht." </font><font style="vertical-align: inherit;">Aber nein, versuchen wir zu verstehen, wo das Problem liegt: im RAM, auf der Festplatte, im Prozessor, auf der Netzwerkkarte oder im RAM der Netzwerkkarte in den Netzwerkger√§ten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie lokalisiere ich ein Hardwareproblem?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Problem trat auf und verschwand an bestimmten Daten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betroffene Server werden nach ihren Namen gruppiert : </font></font><code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gruppen der Problemserver sind dieselben wie im Februar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemserver befinden sich nur in bestimmten Warteschlangen des Rechenzentrums.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab Fragen an Netzwerktechniker - die Daten schlagen auf Netzwerk-Switches. Es stellt sich heraus, dass Netzwerktechniker genau an diesen Daten Switches gegen andere ausgetauscht haben. Nach einer Frage ersetzten sie sie durch die vorherigen und das Problem verschwand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem ist behoben, es bleiben jedoch noch Fragen offen (nicht mehr f√ºr Ingenieure). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum hilft ECC (Fehlerkorrekturspeicher) bei Netzwerk-Switches nicht?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Da sich mehrere Bit-Flip gegenseitig kompensieren k√∂nnen, wird ein unerkannter Fehler angezeigt. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum helfen TCP-Pr√ºfsummen nicht?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie sind schwach. Wenn sich nur ein Bit in den Daten ge√§ndert hat, wird die √Ñnderung bei TCP-Pr√ºfsummen immer angezeigt. Wenn sich zwei Bits ge√§ndert haben, werden die √Ñnderungen m√∂glicherweise nicht erkannt - sie heben sich gegenseitig auf.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Paket hat sich nur ein Bit ge√§ndert, aber der Fehler ist nicht sichtbar. Das liegt daran, dass sich im TCP-Segment 2 Bits ge√§ndert haben: Sie haben die Pr√ºfsumme daraus berechnet, sie stimmte √ºberein. In einem TCP-Segment befindet sich jedoch mehr als ein Paket unserer Anwendung. Und f√ºr einen von ihnen ber√ºcksichtigen wir bereits unsere Pr√ºfsumme. In diesem Paket hat sich nur ein Bit ge√§ndert. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum helfen Ethernet-Pr√ºfsummen nicht - sind sie st√§rker als TCP? </font></font></strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ethernet-Pr√ºfbetrag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie die Daten, damit sie w√§hrend der √úbertragung durch ein Segment nicht unterbrochen werden (ich kann mich mit der Terminologie irren, ich bin kein Netzwerktechniker). </font><font style="vertical-align: inherit;">Netzwerkger√§te leiten diese Pakete weiter und k√∂nnen w√§hrend der Weiterleitung einige Daten weiterleiten. </font><font style="vertical-align: inherit;">Daher werden die Scheckbetr√§ge einfach nachgez√§hlt. </font><font style="vertical-align: inherit;">Wir haben √ºberpr√ºft - auf dem Draht haben sich die Pakete nicht ge√§ndert. </font><font style="vertical-align: inherit;">Wenn sie jedoch den Netzwerk-Switch selbst schlagen, wird der Pr√ºfbetrag neu berechnet (er ist anders) und das Paket weitergeleitet.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nichts wird Sie retten - √ºberpr√ºfen Sie selbst. </font><font style="vertical-align: inherit;">Erwarten Sie nicht, dass jemand dies f√ºr Sie tut.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºr Datenbl√∂cke wird eine 128-Bit-Pr√ºfsumme ber√ºcksichtigt (dieser Overkill nur f√ºr den Fall). </font><font style="vertical-align: inherit;">Wir informieren den Benutzer korrekt √ºber den Fehler. </font><font style="vertical-align: inherit;">Daten werden √ºber das Netzwerk √ºbertragen, sie sind besch√§digt, aber wir zeichnen sie nirgendwo auf - alle unsere Daten sind in Ordnung, Sie k√∂nnen sich keine Sorgen machen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die in ClickHouse gespeicherten Daten bleiben konsistent. </font><font style="vertical-align: inherit;">Verwenden Sie Pr√ºfsummen in ClickHouse. </font><font style="vertical-align: inherit;">Wir lieben Schecksummen so sehr, dass wir sofort drei Optionen in Betracht ziehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºr komprimierte Datenbl√∂cke beim Schreiben in eine Datei in das Netzwerk.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gesamtpr√ºfung ist die Summe der komprimierten Daten f√ºr die √úberpr√ºfung der Abstimmung.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gesamtpr√ºfung ist die Summe der nicht komprimierten Daten f√ºr die √úberpr√ºfung der Abstimmung.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt Fehler in Datenkomprimierungsalgorithmen. Dies ist ein bekannter Fall. </font><font style="vertical-align: inherit;">Daher ber√ºcksichtigen wir beim Replizieren der Daten auch die Gesamtpr√ºfsumme der komprimierten Daten und die Gesamtmenge der nicht komprimierten Daten.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haben Sie keine Angst, die Scheckbetr√§ge zu z√§hlen, sie werden nicht langsamer.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nat√ºrlich kommt es darauf an, welche und wie man z√§hlt. </font><font style="vertical-align: inherit;">Es gibt Nuancen, aber achten Sie darauf, den Scheckbetrag zu ber√ºcksichtigen. </font><font style="vertical-align: inherit;">Wenn Sie beispielsweise anhand der komprimierten Daten z√§hlen, sind weniger Daten vorhanden, die jedoch nicht langsamer werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbesserte Fehlermeldung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie kann man dem Benutzer erkl√§ren, wenn er eine solche Fehlermeldung erh√§lt, dass dies ein Hardwareproblem ist? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t4/f6/rj/t4f6rj1mtuo38kojydfgddfh2nc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Pr√ºfsumme nicht √ºbereinstimmt, versuche ich vor dem Senden einer Ausnahme, jedes Bit zu √§ndern - nur f√ºr den Fall. Wenn die Pr√ºfsumme beim √Ñndern konvergiert und ein Bit ge√§ndert wird, liegt das Problem h√∂chstwahrscheinlich an der Hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir diesen Fehler erkennen k√∂nnen und er sich √§ndert, wenn ein Bit ge√§ndert wird, warum nicht beheben? Wir k√∂nnen dies tun, aber wenn wir st√§ndig Fehler beheben, wei√ü der Benutzer nicht, dass das Ger√§t ein Problem aufweist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als wir herausfanden, dass es Probleme mit den Schaltern gab, berichteten Leute aus anderen Abteilungen: ‚ÄûUnd wir haben ein bisschen falsch an Mongo geschrieben! Und in PostgreSQL hat uns etwas erreicht! ‚Äú Das ist gut, aber es ist besser, Probleme fr√ºher zu melden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als wir eine neue Diagnoseversion ver√∂ffentlichten, schrieb der erste Benutzer, f√ºr den sie funktionierte, eine Woche sp√§ter: "Hier ist die Nachricht - was ist das Problem?" </font><font style="vertical-align: inherit;">Leider hat er es nicht gelesen. </font><font style="vertical-align: inherit;">Aber ich habe mit einer Wahrscheinlichkeit von 99% gelesen und vorgeschlagen, dass das Problem bei der Hardware liegt, wenn der Fehler auf einem Server auftritt. </font><font style="vertical-align: inherit;">Ich lasse den verbleibenden Prozentsatz f√ºr den Fall, dass ich den Code falsch geschrieben habe - dies passiert. </font><font style="vertical-align: inherit;">Infolgedessen ersetzte der Benutzer die SSD und das Problem verschwand.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Delirium" in den Daten</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses interessante und unerwartete Problem machte mir Sorgen. Wir haben Yandex.Metrica-Daten. Ein einfacher JSON wird in einer der Spalten in die Datenbank geschrieben - Benutzerparameter aus dem JavaScript-Code des Z√§hlers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich mache eine Anfrage und der ClickHouse-Server ist mit Segfault abgest√ºrzt. Anhand der Stapelverfolgung wurde mir klar, was das Problem war - ein neues Commit unserer externen Mitarbeiter aus einem anderen Land. Das Commit behoben, Segfault verschwand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich </font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºhre </font><font style="vertical-align: inherit;">die gleiche Anfrage aus: </font><font style="vertical-align: inherit;">In ClickHouse, um JSON zu bekommen, aber wieder, Unsinn, funktioniert alles langsam. Ich bekomme JSON und es ist 10 MB. Ich zeige es an und schaue aufmerksamer: </font></font><code>{"jserrs": cannot find property of object undefind...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und dann fiel ein Megabyte Bin√§rcode heraus.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/ab/1g/ntab1gtbj8eialtctjq4nu-ucdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab Gedanken, dass dies wieder eine Passage aus dem Ged√§chtnis oder eine Rassenbedingung ist. </font><font style="vertical-align: inherit;">Viele solcher Bin√§rdaten sind schlecht, sie k√∂nnen alles enthalten. </font><font style="vertical-align: inherit;">Wenn ja, finde ich jetzt dort Passw√∂rter und private Schl√ºssel. </font><font style="vertical-align: inherit;">Da ich aber nichts gefunden habe, habe ich die Hypothese sofort zur√ºckgewiesen. </font><font style="vertical-align: inherit;">Vielleicht ist dies ein Fehler in meinem Programm auf dem ClickHouse-Server? </font><font style="vertical-align: inherit;">Vielleicht in einem Programm, das schreibt (es ist auch in C ++ geschrieben) - pl√∂tzlich legt sie versehentlich ihren Speicherauszug in ClickHouse ab? </font><font style="vertical-align: inherit;">In dieser H√∂lle begann ich mir die Briefe genau anzusehen und stellte fest, dass es nicht so einfach war.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis Pfad</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der gleiche M√ºll wurde in zwei Clustern unabh√§ngig voneinander aufgezeichnet. </font><font style="vertical-align: inherit;">Die Daten sind Junk, aber es ist g√ºltig UTF-8. </font><font style="vertical-align: inherit;">Dieses UTF-8 hat einige seltsame URLs, Schriftnamen und viele Buchstaben "I" in einer Reihe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist das Besondere an dem kleinen kyrillischen "Ich"? </font><font style="vertical-align: inherit;">Nein, das ist nicht Yandex. </font><font style="vertical-align: inherit;">Tatsache ist, dass es sich bei der Codierung von Windows 1251 um das 255. Zeichen handelt. </font><font style="vertical-align: inherit;">Und auf unseren Linux-Servern verwendet niemand die Windows 1251-Codierung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellt sich heraus, dass dies ein Speicherauszug des Browsers ist: Der JavaScript-Code des Metrikz√§hlers sammelt JavaScript-Fehler. </font><font style="vertical-align: inherit;">Wie sich herausstellte, ist die Antwort einfach - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alles kam vom Benutzer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier k√∂nnen Schlussfolgerungen gezogen werden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs aus dem ganzen Internet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Metrica sammelt Datenverkehr von 1 Milliarde Ger√§ten im Internet: Browser auf PCs, Handys, Tablets. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√ºll wird unvermeidlich kommen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Es gibt Fehler in Benutzerger√§ten, √ºberall unzuverl√§ssigen RAM und schreckliche Hardware, die √ºberhitzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Datenbank speichert mehr als 30 Billionen Zeilen (Seitenaufrufe). Wenn Sie die Daten aus dieser Tabelle analysieren, finden Sie dort alles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher ist es richtig, diesen M√ºll einfach zu filtern, bevor Sie in die Datenbank schreiben. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie m√ºssen keinen M√ºll in die Datenbank schreiben - sie mag es nicht.</font></font></b><br>
<br>
<blockquote> HighLoad++   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> 133 </a>   ),       -  ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">++</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP Russia 2020 Online</a>. <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Badoo</a>, <b> PHP Russia 2020 Online  </b>. PHP Russia 2020 Online  13 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.<br>
<br>
          ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>,     . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de497324/index.html">"Wie der Apfel eines Auges ..." oder wir stellen ein einfaches Sicherheitssystem her, das auf einem Mikrocontroller (Canny oder Arduino) und Raspberry PI basiert</a></li>
<li><a href="../de497326/index.html">Sicherere SSH-Konnektivit√§t mit DNSSEC</a></li>
<li><a href="../de497328/index.html">Einfache M√∂glichkeit, eine Sprache zu lernen (beliebig)</a></li>
<li><a href="../de497330/index.html">Chrome Remote Desktop. Ferngesteuerte Hilfe</a></li>
<li><a href="../de497332/index.html">Houston, wir haben ein Problem. Systemdesignfehler</a></li>
<li><a href="../de497336/index.html">Computermarken der 90er Jahre, Teil 3, endg√ºltig</a></li>
<li><a href="../de497338/index.html">Was letzte Woche mit dem Transport passiert ist - die Krise entwickelt sich</a></li>
<li><a href="../de497340/index.html">COVID-19: So h√∂ren Sie auf, Nachrichten zu lesen und Daten zu analysieren</a></li>
<li><a href="../de497342/index.html">Browser zur √úberwachung von API-Anforderungen: Aufbau einer sicheren Kommunikation zwischen dem Front-End und dem Back-End</a></li>
<li><a href="../de497346/index.html">Beschleunigen Sie mit Rust und LLVM 100-mal Numpy, Scikit und Pandas: Interview mit Entwickler Weld</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>