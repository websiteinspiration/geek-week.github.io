<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèº üêì ü¶Ä SSH Little Tricks üö´ ü•• üíÖüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article has compiled our best practices for using SSH more efficiently. From it you will learn how:
 
 

- Add second factor to SSH login
- Safe ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SSH Little Tricks</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/499920/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article has compiled our best practices for using SSH more efficiently. </font><font style="vertical-align: inherit;">From it you will learn how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add second factor to SSH login</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safe to use agent forwarding</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log out of an SSH session</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keep Permanent Terminal Open</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Share a remote terminal session with a friend (without Zoom!)</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding a second factor to your SSH</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second authentication factor can be added to your SSH connections in five different ways:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update your OpenSSH and use the encryption key. </font><font style="vertical-align: inherit;">In February 2020, support for FIDO U2F (Universal Second Factor) encryption keys was added to OpenSSH. </font><font style="vertical-align: inherit;">This is a great new feature, but there is a nuance: only those clients and servers that have upgraded to OpenSSH version 8.2 and higher will be able to use encryption keys, since the February update introduces new types of keys for them. </font><font style="vertical-align: inherit;">You </font></font><code>ssh ‚ÄìV</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can check the client version of SSH with the command, and the server version with the command</font></font><code>nc [servername] 22 </code><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two new types of keys were added to the February version - ecdsa-sk and ed25519-sk (together with the corresponding certificates). </font><font style="vertical-align: inherit;">To generate a key file, just insert your encryption key and run the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ssh-keygen -t ecdsa-sk -f ~/.ssh/id_ecdsa_sk</code></pre><br>
           U2F .     U2F  ‚Äî          .<br>
<br>
 ,            .<br>
<br>
-     OpenSSH   -sk-.       U2F           .  -  :<br>
<br>
<pre><code class="plaintext hljs">$ ssh-keygen -t ecdsa-sk -O resident -f ~/.ssh/id_ecdsa_sk</code></pre><br>
,         ,      :<br>
<br>
<pre><code class="plaintext hljs">$ ssh-add -K</code></pre><br>
           .</li>
<li> PIV+PKCS11  Yubikey.         SSHD       .  Yubico     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">U2F+SSH  PIV/PKCS11</a>.        FIDO U2F,    ,    ,    .</li>
<li>  yubikey-agent ssh-.    SSH   Yubikeys.       .</li>
<li> Touch ID  sekey. Sekey  SSH     ,        Mac‚Äô    Touch ID   .</li>
<li> Single Sign On SSH. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  </a>      .    single sign on SSH         ‚Äî     (MFA).</li>
</ol><br>
<h2>  agent forwarding</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SHH agent forwarding allows a remote host to access the SSH agent of your local device. When you use SSH with agent forwarding enabled (usually via ssh -A), there will be two channels in the connection: your interactive session and the channel for agent forwarding. Through this channel, the Unix socket created by your local SSH agent connects to the remote host. This is a risky method, as a user with root access on a remote device can access your local SSH agent and potentially impersonate you on the network. Using the standard SSH agent from the Open SSH kit, you don‚Äôt even know that this happened. Having a U2F key (or Sekey) will help you effectively block any attempts to use your SSH agent from the outside.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even with this precaution, it is a good idea to use agent forwarding as little as possible. </font><font style="vertical-align: inherit;">You should not use it at every session - use agent forwarding only when you are sure of its necessity for the current session.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exiting a Hanging Session</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interruption of the network, uncontrolled behavior of programs, or an escape sequence that blocks keyboard input are all possible causes of an SSH session breaking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several ways to end a hung session:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatically exit when network is interrupted. </font><font style="vertical-align: inherit;">In your .ssh / config you need to add the following:</font></font><br>
<br>
<pre><code class="plaintext hljs">ServerAliveInterval 5<font></font>
ServerAliveCountMax 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ssh will send echo to the remote host every ServerAliveInterval seconds to verify the connection. </font><font style="vertical-align: inherit;">If more ServerAliveCountMax echoes do not receive a response, ssh will end the connection in timeout and exit the session.</font></font></li>
<li>  . ssh     ~ ()  .  ~.         . (       .)  ~?        .  ,     ~   ,     ~ .</li>
</ol> <br>
<i><b>    ?</b>           .         IPv4  WiFi,  IP- .   SSH   TCP ,  ,   ,       IP-,       ,  SSH        .    IP-,         .    ,         TCP-    .             .  ,       . IPv6      ,          . ,       .</i><br>
<br>
<h2>       </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two different approaches to how to maintain a connection when switching between different networks or if you want to disconnect for a short time. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mosh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eternal Terminal</font></font></a></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you really need a connection that does not subside even when you switch between networks, use the Mosh mobile shell. This is a secure shell that first uses an SSH handshake and then switches to its own encrypted channel for the duration of the session. So Mosh creates a separate, very stable and secure channel that is able to withstand Internet interruptions, changing the IP address of your laptop, serious network outages, and much more, all thanks to the magic of UDP connections, as well as Mosh sync protocol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use Mosh, you will need to install it on both the client and the server, and open the ports 60000-61000 for disconnected UPD traffic to your remote host. In the future, it will be enough to use for the connection </font></font><code>mosh user@server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mosh operates at the level of screens and keystrokes, which gives it a number of advantages over forwarding the binary stream of standard input and output between the client and the SSH server. If we need to synchronize only screens and keystrokes, then later to restore an interrupted connection becomes much easier. While SSH will buffer and send everything that happened, Mosh only needs to buffer the keystrokes and synchronize the last frame of the terminal window with the client. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Use tmux</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to ‚Äúcome and go when you want‚Äù and keep the terminal session on a remote host, use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminal multiplexer</font></font></a> <code>tmux</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I love tmux and use it constantly. </font><font style="vertical-align: inherit;">If your SSH connection is interrupted, then just to reconnect and enter to return to your tmux session </font></font><code>tmux attach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In addition, it has such wonderful functions as intra-terminal tabs and panels, similar to the tabs in the iOS terminal, and the ability to share terminals with others. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some people like to embellish their tmux with Byobu, a package that greatly improves the usability of tmux and adds a lot of keyboard shortcuts to it. </font><font style="vertical-align: inherit;">Byobu ships with Ubuntu and is easy to install on a Mac via Homebrew.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sharing a remote terminal session with a friend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes when debugging complex problems on your servers, you may want to share an SSH session with someone who is not in the same room as you. </font><font style="vertical-align: inherit;">tmux is perfect for such a task! </font><font style="vertical-align: inherit;">It is enough to take just a few steps:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure that tmux is on your bastion host, or on some server you are going to work with.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both of you will need to connect via SSH to the device using one account.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of you must start tmux to start a tmux session.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another should run tmux attach</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voila! </font><font style="vertical-align: inherit;">You have a common terminal.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want more sophisticated multi-user tmux sessions, try tmate, this is a fork of tmux which greatly simplifies joint terminal sessions.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499902/index.html">How TCP Reset Attack Works</a></li>
<li><a href="../en499904/index.html">"I'm scared". What to do?</a></li>
<li><a href="../en499906/index.html">Examples of using AR in the toy industry</a></li>
<li><a href="../en499908/index.html">Diving Into the Depth: How to Realize Freedom of Choice in the Digital World</a></li>
<li><a href="../en499910/index.html">Balance in decision making. Fork "random experience"</a></li>
<li><a href="../en499922/index.html">Finally we deal with the Modbus baud rate</a></li>
<li><a href="../en499926/index.html">April 30th Java Digest</a></li>
<li><a href="../en499928/index.html">Udalenka: what changed with COVID-19 and who is now even better than before</a></li>
<li><a href="../en499930/index.html">How I designed blocks and transactions on my Go blockchain</a></li>
<li><a href="../en499934/index.html">Whip effect and beer game: modeling and supply chain management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>