<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèΩ ü§© ü§ûüèæ Quick calculation of formulas from Excel in C # üçë üé∞ üë©‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How often do you hear from customers that they will send data to Excel or ask you to import or upload in an Excel-compatible format? I am sure that in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Quick calculation of formulas from Excel in C #</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/498032/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How often do you hear from customers that they will send data to Excel or ask you to import or upload in an Excel-compatible format? </font><font style="vertical-align: inherit;">I am sure that in most areas Excel is one of the most popular, powerful and at the same time simple and convenient tools. </font><font style="vertical-align: inherit;">But the most problematic point is always the integration of such data with various automated systems. </font><font style="vertical-align: inherit;">Our team was asked to consider the possibility of performing data calculations using the settings from a custom Excel file.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8g/to/wx/8gtowxbs0dnpmjvr59epns8b0sq.jpeg" alt="Quick calculation of formulas from Excel in C #"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need to choose a productive library for working with Excel files or if you are looking for a solution for calculating complex financial (and not only) data with a convenient tool for managing and visualizing formulas out of the box, welcome to cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Studying the requirements of a new project in the company, we found one very interesting point: ‚ÄúThe developed solution should be able to calculate the cost of the product (namely, the balcony) when changing the configuration and instantly display the new cost on the interface. It is necessary to provide the ability to download an Excel file with all the calculation functions and component price lists. ‚Äù The client needed to develop a portal for designing the configuration of balconies depending on the sizes, shapes, types of glazing and materials used, types of fastenings, as well as many other related parameters that are used to calculate the exact cost of production and reliability indicators. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We formalize the input requirements so that it is easier to understand in which context it was necessary to solve the problem:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quick calculation of prices on the interface when changing the parameters of the balcony;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quick calculation of design data, including many different configurations of balconies and individual offers, supplied by a separate calculation file;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the long term - the development of functionality using various resource-consuming operations (tasks of optimizing parameters, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All this is on a remote server with output via API, because </font><font style="vertical-align: inherit;">All formulas are the intellectual property of the customer and should not be visible to third parties;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peak-loaded input data stream: the user can frequently and quickly change parameters to select the product configuration according to their requirements.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It sounds very unusual and super tempting, let's get started!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turnkey solutions and data preparation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any research to solve complex problems begins with surfing on StackOverflow, GitHub and many forums looking for ready-made solutions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several ready-made solutions were selected that supported reading data from Excel files, as well as being able to perform calculations based on formulas specified inside the library. </font><font style="vertical-align: inherit;">Among these libraries there are both completely free solutions and commercial developments.&nbsp;</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Library</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentation</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">License</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/JanKallman/EPPlus</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/JanKallman/EPPlus/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNU Library General Public License&nbsp;</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/EPPlusSoftware/EPPlus</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/EPPlusSoftware/EPPlus/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Polyform Noncommercial License 1.0.0 ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.epplussoftware.com/LicenseOverview</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )&nbsp;</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/tonyqus/npoi</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/tonyqus/npoi/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache License 2.0</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.e-iceblue.com/Introduce/excel-for-net-introduce.html</a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.e-iceblue.com/Tutorials/Spire.XLS/Spire.XLS-Program-Guide/Spire.XLS-Program-Guide-Content.html</a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.e-iceblue.com/Tutorials/Licensing/License-Agreement.html</a>&nbsp;</td>
</tr>
<tr>
<td><strong>Excel Interop</strong><i>(Microsoft.Office.Interop.Excel)</i></td>
<td>n/a</td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">docs.microsoft.com/ru-ru/dotnet/api/microsoft.office.interop.excel._workbook?view=excel-pia</a></td>
<td><i>  Excel     </i></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to write load tests and measure the runtime of each library. To do this, prepare test data. We create a new Excel file, define 10 cells for the input parameters and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remember this moment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) formula to obtain a result that uses all the input parameters. In the formula, we try to use all possible mathematical functions of various computational complexity and combine them in a tricky way. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because it is also about money (the cost of the product), it is important to look at the accuracy of the results. In this case, we will take the resulting values ‚Äã‚Äãthat were obtained using </font><strong><font style="vertical-align: inherit;">Excel Interop</font></strong><font style="vertical-align: inherit;"> as the reference</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">because The data obtained in this way is calculated through the Excel core and is equal to the values ‚Äã‚Äãthat customers see when developing formulas and manually calculating the cost.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a reference runtime, we will use native code manually written in pure C # to display the same formula written in Excel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Translated Initial Test Formula:</font></font><br>
<br>
<pre><code class="plaintext hljs">public double Execute(double[] p)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return Math.Pow(p[0] * p[8] / p[4] * Math.Sin(p[5]) * Math.Cos(p[2]) +<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Math.Abs(p[1] - (p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8]))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Math.Sqrt(p[0] * p[0] + p[1] * p[1]) / 2.0 * Math.PI, p[9]);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We form a stream of random input data for N iterations (in this case, we use 10,000 vectors). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start the calculations for each vector of input parameters on the whole stream, get the results and measure the time of initialization of the library and the general calculation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To compare the accuracy of the results, we use two indicators - the standard deviation and the percentage of matching values ‚Äã‚Äãwith a certain accuracy step epsilon. If you randomly generate a list of input values ‚Äã‚Äãwith a floating point after the decimal point, you must determine the accuracy of the input parameters - this will allow you to get the correct results. Otherwise, random numbers can have a large difference of orders of magnitude - this can greatly affect the accuracy of the results and affect the estimate of the error of the result.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because Initially, we assume that it is required to operate with constant values ‚Äã‚Äãof the cost of materials, as well as some constants from different fields of knowledge, we can accept that all input parameters will have values ‚Äã‚Äãaccurate to 3 decimal places. Ideally, you need to specify a valid range of values ‚Äã‚Äãfor each of the parameters and use only them to generate random values, but since the formula for testing was compiled randomly without any mathematical and physical justification, then it is not possible to calculate such a range of values ‚Äã‚Äãfor all 10 parameters in a reasonable period of time. Therefore, in calculations it is sometimes possible to obtain a calculation error. We exclude such input data vectors already at the time of calculation for accuracy indicators,but we will count such errors as a separate characteristic.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test Architecture&nbsp;</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each separate library, its own class has been created that implements an interface </font></font><code>ITestExecutor </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that includes 3 methods - </font></font><code>SetUp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Execute </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>TearDown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">public interface ITestExecutor<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//      <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;void SetUp();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//   ,           <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;double Execute(double[] p);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//    ,      <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;void TearDown();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Methods </font></font><code>SetUp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>TearDown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used only once in the process of testing the library and are not considered when measuring time calculations on the entire set of input data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the testing algorithm boiled down to the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data preparation (we form a stream of input vectors of a given accuracy);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allocation of memory for the resulting data (an array of results for each library, an array with the number of errors);&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization of libraries;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtaining calculation results for each of the libraries with saving the result in a pre-prepared array and recording the execution time;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Completion of work with the code of libraries;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysis of the data:</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A graphical representation of this algorithm is presented below.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sl/yg/e0/slyge0dloc1dednqql-hgga6um4.png" alt="Flow chart of performance and accuracy testing of Excel support libraries"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Results of the first iteration</font></font></h1><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Index</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Native</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4</font></font></strong><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
&amp; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel interop</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization Time (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">257</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">266</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">632</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1653</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wed </font><font style="vertical-align: inherit;">time for 1 pass (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0002</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.4086</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.6847</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.9782</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">38.8423</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avg </font><font style="vertical-align: inherit;">deviation</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000394</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000395</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000237</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000631</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accuracy</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99.99%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99.92%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99.97%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99.84%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mistakes</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.94%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.94%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.52%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.94%</font></font></td>
</tr>
</tbody></table></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why are the results of EPPlus 5 and EPPlus 4 combined?</font></font></b>
                        <div class="spoiler_text">      EPPlus      .    ,       ,         .    ,         .     EPPlus 5     ,       .          ,      EPPlus,    .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first iteration of the tests showed a good result, in which the leaders among the libraries immediately became visible. </font><font style="vertical-align: inherit;">As can be seen from the above data, the absolute leader in this situation is the EPPlus library. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results are not impressive compared to the native code, but you can live. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This could have been stopped, but after talking with customers the first doubts crept in: the results were too good.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zp/7s/ry/zp7sryxdmhkg5rp8xfhwf537kti.jpeg"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Features of working with the Spire library</font></font></b>
                        <div class="spoiler_text">     Spire  ,             InvalidCastException.      ,          Excel-    ,     ,      ,     .                    try...catch.       ,         .<br>
</div>
                    </div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rake of the first iteration of tests</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Above, I asked you to draw your attention to one point that played an important role in obtaining results. We suspected that the formulas used in the real Excel file of the customer would be far from primitive, with many dependencies inside, but we did not suspect that this could greatly affect the indicators. Nevertheless, initially, when compiling the test data, I did not foresee this, and the data from the customer (at least the information that at least 120 input parameters are used in the final file) hinted that we need to think and add formulas with dependencies between cells .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start preparing new data for the next iteration of testing. </font><font style="vertical-align: inherit;">Let us dwell on 10 input parameters and add an additional 4 new formulas with dependence only on parameters and 1 aggregating formula, which is based on these four cells with formulas and will also rely on the values ‚Äã‚Äãof the input data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The new formula that will be used for subsequent tests:</font></font><br>
<br>
<pre><code class="plaintext hljs">public double Execute(double[] p)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price1 = Math.Pow(p[0] * p[8] / p[4] * Math.Sin(p[5]) * Math.Cos(p[2]) +<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Math.Abs(p[1] - (p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8]))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Math.Sqrt(p[0] * p[0] + p[1] * p[1]) / 2.0 * Math.PI, p[9]);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price2 = p[4] * p[5] * p[2] / Math.Max(1, Math.Abs(p[7]));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price3 = Math.Abs(p[7] - p[3]) * p[2];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price4 = Math.Sqrt(Math.Abs(p[1] * p[2] + p[3] * p[4] + p[5] * p[6]) + 1.0);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price5 = p[0] * Math.Cos(p[1]) + p[2] * Math.Sin(p[1]);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var sum = p[0] + p[1] + p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8] + p[9];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price6 = sum / Math.Max(1, Math.Abs((p[0] + p[1] + p[2] + p[3]) / 4.0))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ sum / Math.Max(1, Math.Abs((p[4] + p[5] + p[6] + p[7] + p[8] + p[9]) / 6.0));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var pricingAverage = (price1 + price2 + price3 + price4 + price5 + price6) / 6.0;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return pricingAverage / Math.Max(1, Math.Abs(price1 + price2 + price3 + price4 + price5 + price6));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the resulting formula turned out to be much more complicated, which naturally affected the results - not for the better. </font><font style="vertical-align: inherit;">A table with the results is presented below:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Index</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Native</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4 </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel interop</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization Time (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">241</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">368</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">722</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1640</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wed </font><font style="vertical-align: inherit;">time for 1 pass (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0004</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.9174 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 124%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.8996 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 177%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7647 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 11%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50.7194 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 30%)</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avg </font><font style="vertical-align: inherit;">deviation</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,035884</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accuracy</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98.79%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mistakes</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.28%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
</tr>
</tbody></table></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xg/l5/ye/xgl5yefp3_meak1f4qzj1mctjsm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: Because </font><font style="vertical-align: inherit;">Excel Interop is too large, had to be excluded from the chart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As can be seen from the results, the situation has become completely unsuitable for use in production. </font><font style="vertical-align: inherit;">A little sad, stock up coffee and dive head deeper into the study - straight into the code generation.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nv/d_/kh/nvd_khyfluufkuwh64vikgafdpe.jpeg"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code Generation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you suddenly never faced a similar task, then we will conduct a brief excursion.&nbsp;</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code generation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a way of solving a problem by dynamically generating source code based on input data with subsequent compilation and execution. </font><font style="vertical-align: inherit;">There is both static code generation that occurs during the build of the project (as an example I can cite T4MVC, which creates new code based on templates and metadata that can be used when writing the main application code), and dynamic code that runs during runtime.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our task is to form a new function based on the source data (formulas from Excel), which receives the result based on the vector of input values. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you must:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read the formula from the file;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collect all dependencies;</font></font></li>
<li>       C#;</li>
<li>     ;</li>
<li>            ;</li>
<li>     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the libraries presented are suitable for reading formulas, however, the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library turned out to be the most convenient interface for such functionality </font><font style="vertical-align: inherit;">. Having rummaged a bit in the source code of this library, I discovered public classes for forming a list of tokens and its further transformation into an expression tree. Bingo, I thought! A ready-made expression tree from the box is ideal, just go through it and form our C # code.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But a big catch was waiting for me when I began to study the nodes of the resulting expression tree. Some nodes, in particular the call to Excel functions, encapsulated information on the function used and its input parameters and did not provide any open access to this data. Therefore, work with the finished expression tree had to be postponed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go one level lower and try to work with the list of tokens. Everything is quite simple here: we have tokens that have type and value. Because we are given a function and we need to form a function, then we can instead convert the tree tokens to the equivalent in C #. The main thing in this approach is to organize compatible functions. Most mathematical functions were already compatible - such as calculating the cosine, sine, obtaining the root, and raising to a power. But the aggregation functions - such as the maximum value, minimum, amount - needed to be finalized. The main difference is that in Excel, these functions work with a range of values. For simplicity of the prototype, we will make functions that take a list of parameters as input, previously expanding the range of values ‚Äã‚Äãinto a linear list.This way we get the correct and compatible conversion from Excel syntax to C # syntax.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is the main code for converting a list of tokens from an Excel formula into a valid C # code.</font></font><br>
<br>
<pre><code class="plaintext hljs">private string TransformToSharpCode(string formula, ParsingContext parsingContext)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize basic compile components, e.g. lexer<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var lexer = new Lexer(parsingContext.Configuration.FunctionRepository, parsingContext.NameValueProvider);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// List of dependency variables that can be filled during formula transformation<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var variables = new Dictionary&lt;string, string&gt;();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;using (var scope = parsingContext.Scopes.NewScope(RangeAddress.Empty))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Take resulting code line<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var compiledResultCode = TransformToSharpCode(formula, parsingContext, scope, lexer, variables);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var output = new StringBuilder();<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Define dependency variables in reverse order.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (var variableDefinition in variables.Reverse())<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.AppendLine($"var {variableDefinition.Key} = {variableDefinition.Value};");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Take the result<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.AppendLine($"return {compiledResultCode};");<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return output.ToString();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
}<font></font>
<font></font>
private string TransformToSharpCode(ICollection&lt;Token&gt; tokens, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var output = new StringBuilder();<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;foreach (Token token in tokens)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (token.TokenType)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Function:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(BuildFunctionName(token.Value));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.OpeningParenthesis:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append("(");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.ClosingParenthesis:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(")");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Comma:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(", ");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.ExcelAddress:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var address = token.Value;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(TransformAddressToSharpCode(address, parsingContext, scope, lexer, variables));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Decimal:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Integer:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Boolean:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(token.Value);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Operator:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(token.Value);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return output.ToString();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next nuance in the conversion was the use of Excel constants - they are functions, so in C # they also have to be wrapped in a function.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to solve only one question: the conversion of cell references to a parameter. In the case where the token contains information about the cell, we first determine what is stored in this cell. If this is a formula, expand it recursively. If the constant is replaced with a C # -analog link, of the form </font></font><code>p[row, column]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where it </font></font><code>p</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be either a two-dimensional array or an indexed access class for correct data mapping. With a range of cells, we do the same, just pre-expand the range into individual cells and process them separately. Thus, we cover the main functionality when translating an Excel function.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/kk/hz/gwkkhzpfeudqdzcbfsgsdzdtolo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is the code for converting a link to an Excel spreadsheet cell into a valid C # code:</font></font><br>
<br>
<pre><code class="plaintext hljs">private string TransformAddressToSharpCode(string excelAddress, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Try to parse excel range of addresses<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Currently, reference to another worksheet in address string is not supported<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var rangeParts = excelAddress.Split(':');<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (rangeParts.Length == 1)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Unpack single excel address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return UnpackExcelAddress(excelAddress, parsingContext, scope, lexer, variables);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Parse excel range address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(rangeParts[0], out int startRowIndex, out int startColumnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(rangeParts[1], out int endRowIndex, out int endColumnIndex);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var rowDelta = endRowIndex - startRowIndex;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var columnDelta = endColumnIndex - startColumnIndex;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var allAccessors = new List&lt;string&gt;(Math.Abs(rowDelta * columnDelta));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// TODO This part of code doesn't support reverse-ordered range address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;for (var rowIndex = startRowIndex; rowIndex &lt;= endRowIndex; rowIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (var columnIndex = startColumnIndex; columnIndex &lt;= endColumnIndex; columnIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Unpack single excel address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAccessors.Add(UnpackExcelAddress(rowIndex, columnIndex, parsingContext, scope, lexer, variables));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return string.Join(", ", allAccessors);<font></font>
}<font></font>
<font></font>
private string UnpackExcelAddress(string excelAddress, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(excelAddress, out int rowIndex, out int columnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return UnpackExcelAddress(rowIndex, columnIndex, parsingContext, scope, lexer, variables);<font></font>
}<font></font>
<font></font>
private string UnpackExcelAddress(int rowIndex, int columnIndex, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var formula = parsingContext.ExcelDataProvider.GetRangeFormula(_worksheet.Name, rowIndex, columnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (string.IsNullOrWhiteSpace(formula))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// When excel address doesn't contain information about any excel formula, we should just use external input data parameter provider.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $"p[{rowIndex},{columnIndex}]";<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// When formula is provided, try to identify that variable is not defined yet<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// TODO Worksheet name is not included in variable name, potentially that can cause conflicts<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Extracting and reusing calculations via local variables improves performance for 0.0045ms<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var cellVariableId = $"C{rowIndex}R{columnIndex}";<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (variables.ContainsKey(cellVariableId))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return cellVariableId;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// When variable does not exist, transform new formula and register that to variable scope<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;variables.Add(cellVariableId, TransformToSharpCode(formula, parsingContext, scope, lexer, variables));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return cellVariableId;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains only to wrap the resulting converted code into a static function, link the assembly with compatibility functions, and compile the dynamic assembly. </font><font style="vertical-align: inherit;">Load it into memory, get a link to our function - and you can use it.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We write a wrapper class for testing and run tests with time measurement.&nbsp;</font></font><br>
<br>
<pre><code class="plaintext hljs">public void SetUp()<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize excel package by EPPlus library<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_package = new ExcelPackage(new FileInfo(_fileName));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_workbook = _package.Workbook;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_worksheet = _workbook.Worksheets[1];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_inputRange = new ExcelRange[10];<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;for (int rowIndex = 0; rowIndex &lt; 10; rowIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_inputRange[rowIndex] = _worksheet.Cells[rowIndex + 1, 2];<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Access to result cell and extract formula string<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_resultRange = _worksheet.Cells[11, 2];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var formula = _resultRange.Formula;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize parsing context and setup data provider<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var parsingContext = ParsingContext.Create();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;parsingContext.ExcelDataProvider = new EpplusExcelDataProvider(_package);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Transform Excel formula to CSharp code<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var sourceCode = TransformToSharpCode(formula, parsingContext);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Compile CSharp code to IL dynamic assembly via helper wrappers<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_code = CodeGenerator.CreateCode&lt;double&gt;(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sourceCode,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new string[]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// List of used namespaces<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"System", // Required for Math functions<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ExcelCalculations.PerformanceTests" // Required for Excel function wrappers stored at ExcelCompiledFunctions static class<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new string[]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Add reference to current compiled assembly, that is required to use Excel function wrappers located at ExcelCompiledFunctions static class<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"....\\bin\\Debug\\ExcelCalculations.PerformanceTests.exe"<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Notify that this source code should use parameter;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Use abstract p parameter - interface for values accessing.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new CodeParameter("p", typeof(IExcelValueProvider))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we have a prototype of this solution and mark it as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-I</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . After running the tests, we get the long-awaited result. The acceleration is almost 300 times. Already not bad, but the resulting code is still 16 times slower than the native one. Could it be better? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes you can! Let's try to improve the result due to the fact that we will replace all links to additional cells with formulas with variables. Our test uses multiple use of dependent cells in the formula, so in the first version of the translator we received multiple calculations of the same data. Therefore, it was decided to use intermediate variables in the calculations. After expanding the code using the generation of dependent variables, we got a performance increase of 2 more times. This improvement is called</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-II</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The comparison table is presented below:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Library</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wed </font><font style="vertical-align: inherit;">time (ms)</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coef. </font><font style="vertical-align: inherit;">slowdowns</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Native</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.00004</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-II</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.003</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-I</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.0061</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sixteen</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,2089</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3023</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under these conditions and the time limits that were allotted for the task, we got a result that brings us closer to the performance of the native code with a slight lag - 8 times, compared with the original version - a lag of several orders of magnitude, 3028 times. </font><font style="vertical-align: inherit;">But is it possible to improve the result and get as close to the native code as possible, if you remove the time limits and how much will it be appropriate?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My answer is yes, but, unfortunately, I no longer had time to implement these techniques. </font><font style="vertical-align: inherit;">Perhaps I will devote a separate article to this topic. </font><font style="vertical-align: inherit;">At the moment, I can only talk about the main ideas and options, writing them in the form of short abstracts that have been verified by reverse transformation. </font><font style="vertical-align: inherit;">By reverse conversion, I mean the degradation of native code, written by hand, in the direction of the generated code. </font><font style="vertical-align: inherit;">This approach allows you to check some theses quickly enough and does not require significant changes in the code. </font><font style="vertical-align: inherit;">It also allows you to answer the question of how the performance of the native code will deteriorate under certain conditions, which will mean that if the generated code is improved automatically in the opposite direction, we can get a performance improvement with a similar coefficient.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abstracts</font></font></h2><br>
<ol>
<li>  ,                     ;</li>
<li>           inline      ;</li>
<li> -     Sum, Max, Min   ;</li>
<li>  Sum  inline     ;</li>
<li>   (         )    .</li>
</ol><br>
<h1></h1><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong></strong></td>
<td><strong>Native</strong></td>
<td><strong>EPPlus Compiled, Mark-II</strong></td>
<td><strong>EPPlus 4</strong><strong>EPPlus 5</strong></td>
<td><strong>NPOI</strong></td>
<td><strong>Spire</strong></td>
<td><strong>Excel Interop</strong></td>
</tr>
<tr>
<td><strong>  ()</strong></td>
<td>0</td>
<td>239</td>
<td>241</td>
<td>368</td>
<td>722</td>
<td>1640</td>
</tr>
<tr>
<td><strong>.   1  ()</strong></td>
<td>0,0004</td>
<td>0,003</td>
<td>0,9174</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,8996</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7,7647</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50,7194</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avg </font><font style="vertical-align: inherit;">deviation</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,035884</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accuracy</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98.79%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / a</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mistakes</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.28%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.3%</font></font></td>
</tr>
</tbody></table></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kd/py/vy/kdpyvy0-qfqtfbwgtvbwjo28coo.png" alt="Quick calculation of formulas from Excel in C #"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Summing up the steps, we have a mechanism for converting formulas directly from a custom Excel document into working code on the server. </font><font style="vertical-align: inherit;">This allows you to use the incredible flexibility of integrating Excel with any business solution without losing the powerful user interface that a large number of users are used to working with. </font><font style="vertical-align: inherit;">Was it possible to develop such a convenient interface with the same set of tools for analyzing and visualizing data as in Excel for such a short development period? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And what were the most unusual and interesting integrations with Excel documents you had to implement?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498022/index.html">The digest of interesting materials for the mobile # 341 developer (on April 13 - 19)</a></li>
<li><a href="../en498024/index.html">Building cities with a click of the mouse with Houdini and Python</a></li>
<li><a href="../en498026/index.html">FOSS News No. 12 - review of free and open source news for April 13-19, 2020</a></li>
<li><a href="../en498028/index.html">Python COVID-19 pandemic simulation</a></li>
<li><a href="../en498030/index.html">Backup: where, how and why?</a></li>
<li><a href="../en498034/index.html">The modern by design aircraft is protected against biological threats (COVID-19) better than you think</a></li>
<li><a href="../en498036/index.html">Mark Andriessen: It's time to create for ourselves (It's Time to Build)</a></li>
<li><a href="../en498038/index.html">The digest of fresh materials from the world of the front-end for the last week No. 411 (April 13-19, 2020)</a></li>
<li><a href="../en498042/index.html">Parse, not validate</a></li>
<li><a href="../en498046/index.html">Researchers are developing an approach to reducing bias in computer vision datasets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>