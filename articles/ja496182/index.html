<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌭 🙀 🤶🏽 ダミーのApache Kafka 🎄 📺 🧑🏽‍🤝‍🧑🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事は、マイクロサービスアーキテクチャとApache Kafkaサービスに慣れ始めたばかりの方に役立ちます。この資料は詳細なチュートリアルであるとは主張していませんが、このテクノロジーをすぐに使い始めるのに役立ちます。Windows 10にKafkaをインストールして構成する方法について説明しま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ダミーのApache Kafka</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は、マイクロサービスアーキテクチャとApache Kafkaサービスに慣れ始めたばかりの方に役立ちます。</font><font style="vertical-align: inherit;">この資料は詳細なチュートリアルであるとは主張していませんが、このテクノロジーをすぐに使い始めるのに役立ちます。</font><font style="vertical-align: inherit;">Windows 10にKafkaをインストールして構成する方法について説明します。また、Intellij IDEAとSpring Bootを使用してプロジェクトを作成します。</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何のために？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまなツールの理解の難しさは、多くの場合、開発者がこれらのツールが必要になる状況に遭遇したことがないという事実に関連しています。 Kafkaでは、これはまったく同じです。このテクノロジーが役立つ状況について説明します。モノリシックアプリケーションアーキテクチャを使用している場合は、もちろんKafkaは必要ありません。マイクロサービスへの移行に伴い、すべてが変化します。実際、各マイクロサービスは、1つまたは別の機能を実行する個別のプログラムであり、他のマイクロサービスとは独立して起動できます。マイクロサービスは、別々のデスクに座って問題を個別に解決するオフィスの従業員と比較できます。このような分散チームの作業は、中央の調整なしでは考えられません。従業員は、メッセージや作業結果を相互に交換できる必要があります。マイクロサービス用のApache Kafkaは、この問題を解決するように設計されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafkaはメッセージブローカーです。これにより、マイクロサービスは相互にやり取りして、重要な情報を送受信できます。問題は、通常のPOSTを使用しないことです。これらの目的のために、必要なデータを転送し、同じ方法で回答を取得できる本文で要求します。このアプローチには、明らかな欠点がいくつかあります。たとえば、プロデューサー（メッセージを送信するサービス）は、コンシューマー（データを受信するサービス）からの要求に応じて、応答の形式でのみデータを送信できます。コンシューマがPOSTリクエストを送信し、プロデューサがそれに応答するとします。現時点では、なんらかの理由で、消費者は答えを受け入れることができません。データはどうなりますか？それらは失われます。消費者は再びリクエストを送信する必要があり、この間、受信したいデータが変更されていないことを望みます。プロデューサーはまだリクエストを受け入れる準備ができています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafkaは、マイクロサービス間でメッセージを交換するときに発生するこの問題および他の多くの問題を解決します。</font><font style="vertical-align: inherit;">中断のない便利なデータ交換は、マイクロサービスアーキテクチャの安定した動作を保証するために解決する必要がある主要な問題の1つであることを思い出してください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10にZooKeeperとApache Kafkaをインストールして構成する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に知っておくべきことは、Apache KafkaがZooKeeperサービスの上で実行されることです。 ZooKeeperは分散構成および同期サービスであり、このコンテキストでそれについて知る必要があるのはそれだけです。 Kafkaを使い始める前に、ダウンロードして構成し、実行する必要があります。 ZooKeeperでの作業を開始する前に、JREがインストールおよび構成されていることを確認してください。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZooKeeperの最新バージョンは、公式Webサイトからダウンロードできます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダウンロードしたZooKeeperアーカイブからディスク上のフォルダーにファイルを抽出します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン番号のあるzookeeperフォルダーでconfフォルダーを見つけ、その中にファイル「zoo_sample.cfg」を見つけます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それをコピーして、コピーの名前を「zoo.cfg」に変更します。コピーファイルを開いて、dataDir = / tmp / zookeeperという行を見つけます。この行では、zookeeper-x.x.xフォルダーへの完全パスを書き込みます。私にとっては次のようになります：dataDir = C：\\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、システム環境変数ZOOKEEPER_HOME = C：\ ZooKeeper \ zookeeper-3.4.9を追加し、システム変数Pathの末尾にエントリを追加します。;％ZOOKEEPER_HOME ％ \ 置き場; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドラインを実行して、コマンドを記述します。</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 すべてが正しく行われると、次のようなものが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ZooKeeperが正常に起動したことを意味します。 Apache Kafkaサーバーのインストールと構成に直接進みます。公式サイトから最新バージョンをダウンロードし、アーカイブの内容を抽出し</font><font style="vertical-align: inherit;">
ます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。kafka.apache.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">downloads</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kafkaのフォルダーにconfigフォルダーがあり、その中にserver.propertiesファイルがあり、それを開きます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
log.dirs = / tmp / kafka-logsという行を見つけ、その中にKafkaがログを保存するパスを示します。log.dirs= c：/ kafka / kafka-logs。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じフォルダーで、zookeeper.propertiesファイルを編集します。行dataDir = / tmp / zookeeperをdataDir = c：/ kafka / zookeeper-dataに変更します。ディスク名の後にKafkaフォルダーへのパスを指定することを忘れないでください。すべてが正しければ、ZooKeeperとKafkaを実行できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のユーザーにとって、Kafkaを制御するGUIがないことは不愉快な驚きかもしれません。</font><font style="vertical-align: inherit;">おそらくこれは、サービスがコンソールのみで動作する過酷なオタク向けに設計されているためです。</font><font style="vertical-align: inherit;">いずれにしても、Kafkaを実行するにはコマンドラインが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ZooKeeperを起動する必要があります。</font><font style="vertical-align: inherit;">kafkaのあるフォルダーでbin / windowsフォルダーを見つけ、そこにzookeeper-server-start.batサービスを開始するファイルを見つけてクリックします。</font><font style="vertical-align: inherit;">何も起こりません？</font><font style="vertical-align: inherit;">そうなるはずです。</font><font style="vertical-align: inherit;">このフォルダーでコンソールを開き、次のように記述します。</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 もう動かないの？</font><font style="vertical-align: inherit;">これが標準です。</font><font style="vertical-align: inherit;">これは、zookeeper-server-start.batがzookeeper.propertiesファイルで指定されたパラメーターを必要とするためです。</font><font style="vertical-align: inherit;">コンソールに書き込みます：</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これですべてが正常に開始されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、このフォルダーでコンソールを開き（ZooKeeperは閉じないでください）、kafkaを実行します。</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドラインで毎回コマンドを記述しないようにするために、古い実績のある方法を使用して、次の内容のバッチファイルを作成できます。</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
zookeeperとkafkaの起動の間に一時停止を設定するには、タイムアウト10行が必要です。</font><font style="vertical-align: inherit;">バッチファイルをクリックすると、2つのコンソールが開き、zookeeperとkafkaが実行されます。これで、コマンドラインから直接必要なパラメーターを使用してメッセージプロデューサーとコンシューマーを作成できます。</font><font style="vertical-align: inherit;">ただし、実際には、サービスをテストする場合を除いて必要になる場合があります。</font><font style="vertical-align: inherit;">IDEAのkafkaを使用する方法にもっと興味があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDEAのkafkaを使用する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージのプロデューサーとコンシューマーを同時に兼ねる、可能な限り単純なアプリケーションを作成し、それに便利な機能を追加します。</font><font style="vertical-align: inherit;">新しいSpringプロジェクトを作成します。</font><font style="vertical-align: inherit;">これは、スプリング初期化子を使用して行うのが最も便利です。</font><font style="vertical-align: inherit;">依存関係org.springframework.kafkaおよびspring-boot-starter-webを追加します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、pom.xmlファイルは</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようになります。メッセージを送信するには、KafkaTemplate &lt;K、V&gt;オブジェクトが必要です。</font><font style="vertical-align: inherit;">ご覧のとおり、オブジェクトは型付けされています。</font><font style="vertical-align: inherit;">最初のパラメーターはキーのタイプ、2番目はメッセージ自体です。</font><font style="vertical-align: inherit;">ここでは、両方のパラメータを文字列として示します。</font><font style="vertical-align: inherit;">クラスコントローラーでオブジェクトを作成します。</font><font style="vertical-align: inherit;">KafkaTemplateを宣言し、アノテーションを付けて初期化するようSpringに要求する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動配線</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、生産者は準備が整っています。あとは、その上でsend（）メソッドを呼び出すだけです。このメソッドにはオーバーロードされたバージョンがいくつかあります。プロジェクトでは、3つのパラメーターを持つオプションを使用します-送信（文字列トピック、Kキー、Vデータ）。 KafkaTemplateは文字列によって型付けされるため、sendメソッドのキーとデータは文字列になります。最初のパラメータはトピック、つまりメッセージが送信されるトピック、およびコンシューマがメッセージを受信するためにサブスクライブできるトピックを示します。 sendメソッドで指定されたトピックが存在しない場合は、自動的に作成されます。完全なクラステキストは次のようになります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhostに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マップします</font><font style="vertical-align: inherit;">：8080 / msg、キーとメッセージ自体がリクエスト本文で送信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージ送信者の準備ができました。リスナーを作成してください。</font><font style="vertical-align: inherit;">Springでは、これを簡単に行うことができます。</font><font style="vertical-align: inherit;">メソッドを作成し、@ KafkaListenerアノテーションを使用してマークを付けるだけで十分です。このパラメータでは、リッスンするトピックのみを指定できます。</font><font style="vertical-align: inherit;">私たちの場合、このようになります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アノテーションでマークされたメソッド自体は、プロデューサーによって送信されたメッセージのタイプを持つ1つの受け入れられたパラメーターを指定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンシューマーが作成されるクラスには、@ EnableKafkaアノテーションを付ける必要があります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、application.property設定ファイルでは、コンシェルジュパラメータgroupe-idを指定する必要があります。</font><font style="vertical-align: inherit;">これを行わないと、アプリケーションは起動しません。</font><font style="vertical-align: inherit;">パラメータのタイプはStringで、何でもかまいません。</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純なカフカプロジェクトの準備が整いました。</font><font style="vertical-align: inherit;">メッセージの送信者と受信者がいます。</font><font style="vertical-align: inherit;">走るだけです。</font><font style="vertical-align: inherit;">まず、先ほど書いたバッチファイルを使用してZooKeeperとKafkaを起動し、次にアプリケーションを起動します。</font><font style="vertical-align: inherit;">Postmanを使用してリクエストを送信するのが最も便利です。</font><font style="vertical-align: inherit;">リクエストの本文では、パラメータmsgIdおよびmsgを指定することを忘れないでください。</font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDEAでこのような画像を見ると、すべてが機能します。プロデューサーはメッセージを送信し、コンシューマーはそれを受信して​​コンソールに表示しました。</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトを複雑にする</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafkaを使用する実際のプロジェクトは、私たちが作成したプロジェクトよりも確かに複雑です。サービスの基本的な機能を理解したので、サービスが提供する追加の機能を検討します。まず、プロデューサーを改善します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
send（）メソッドを開いた場合、そのすべてのバリアントの戻り値がListenableFuture &lt;SendResult &lt;K、V &gt;&gt;であることがわかります。ここでは、このインターフェースの機能について詳しく検討しません。ここでは、メッセージの送信結果を表示する必要があると言うだけで十分です。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
addCallback（）メソッドは、SuccessCallbackとFailureCallbackの2つのパラメーターを受け入れます。</font><font style="vertical-align: inherit;">どちらも機能的なインターフェースです。</font><font style="vertical-align: inherit;">名前から、最初のメソッドがメッセージの送信に成功した結果として呼び出され、2番目のメソッドがエラーの結果として呼び出されることがわかります。プロジェクトを実行すると、コンソールに次のようなものが表示されます。</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度プロデューサーを注意深く見てみましょう。</font><font style="vertical-align: inherit;">興味深いことに、キーが文字列ではなく、たとえばLongであるが、送信されたメッセージとしてさらに悪い場合はどうなりますか？ある種の複雑なDTOですか？</font><font style="vertical-align: inherit;">まず、キーを数値に変更してみ</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ましょ</font><font style="vertical-align: inherit;">う... </font><font style="vertical-align: inherit;">プロデューサーでキーとしてLongを指定すると、アプリケーションは正常に起動しますが、メッセージを送信しようとするとClassCastExceptionがスローされ、LongクラスをStringクラスにキャストできないことが報告されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KafkaTemplateオブジェクトを手動で作成しようとすると、ProducerFactory &lt;K、V&gt;インターフェイスオブジェクト（DefaultKafkaProducerFactory &lt;&gt;など）がパラメーターとしてコンストラクターに渡されることがわかります。 DefaultKafkaProducerFactoryを作成するには、プロデューサー設定を含むマップをコンストラクターに渡す必要があります。プロデューサの構成と作成のためのすべてのコードは、別のクラスに配置されます。これを行うには、configパッケージを作成し、その中にKafkaProducerConfigクラスを作成します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
producerConfigs（）メソッドで、構成を含むマップを作成し、LongSerializer.classをキーのシリアライザーとして指定します。</font><font style="vertical-align: inherit;">まずPostmanからリクエストを送信し、すべてが正常に機能することを確認します。プロデューサーがメッセージを送信し、コンシューマーがメッセージを受信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、送信される値のタイプを変更します。</font><font style="vertical-align: inherit;">Javaライブラリの標準クラスがなく、何らかのカスタムDTOがある場合はどうでしょう。</font><font style="vertical-align: inherit;">これを言いましょう。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DTOをメッセージとして送信するには、プロデューサーの構成にいくつかの変更を加える必要があります。</font><font style="vertical-align: inherit;">メッセージ値のシリアライザーとしてJsonSerializer.classを指定し、どこでもString型をUserDtoに変更することを忘れないでください。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージを送る。次の行がコンソールに表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コンシューマーを複雑にします。これ以前は、アノテーション@KafkaListener（topics = "msg"）でマークされたメソッドpublic void msgListener（String msg）は、Stringをパラメーターとして取り、コンソールに表示していました。送信されたメッセージの他のパラメーター、たとえば、キーやパーティションを取得したい場合はどうなりますか？この場合、送信される値のタイプを変更する必要があります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConsumerRecordオブジェクトから、必要なすべてのパラメーターを取得できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールのキーの代わりに、ある種のkrakozyabryが表示されていることがわかります。これは、デフォルトでStringDeserializerを使用してキーをデシリアライズするためです。整数形式のキーを正しく表示するには、LongDeserializerに変更する必要があります。 configパッケージでコンシューマーを構成するには、KafkaConsumerConfigクラスを作成します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KafkaConsumerConfigクラスは、前に作成したKafkaProducerConfigとよく似ています。たとえば、キーと値のデシリアライザなど、必要な構成を含むマップもあります。作成されたマップは、ConsumerFactory &lt;&gt;を作成するために使用されます。これは、次にKafkaListenerContainerFactory &lt;？&gt;を作成するために必要です。重要な詳細：KafkaListenerContainerFactoryを返すメソッド&lt;？&gt; kafkaListenerContainerFactory（）を呼び出す必要があります。そうしないと、Springが目的のBeanを見つけられず、プロジェクトがコンパイルされません。始めます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、キーが適切に表示され、すべてが機能するようになったことがわかります。</font><font style="vertical-align: inherit;">もちろん、Apache Kafkaの機能はこの記事で説明した機能をはるかに超えていますが、それを読んだ後で、このサービスについてのアイデアが得られ、最も重要なこととして、このサービスを使い始めることができることを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より頻繁に手を洗い、マスクを着用し、不必要に外に出ず、健康であること。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja496170/index.html">運命＃1 //ウダレンカの危機と独創性の死</a></li>
<li><a href="../ja496174/index.html">分析、製品チーム、アマゾン、イスラエル、シンガポール、遠隔作業などに対する需要の増加-多くの議論が行われました。</a></li>
<li><a href="../ja496176/index.html">大きな仮想会議：最新のデジタル企業からデータを保護する実際の経験</a></li>
<li><a href="../ja496178/index.html">Swift 5.2。すべての変更の概要</a></li>
<li><a href="../ja496180/index.html">若者の影を大事にする</a></li>
<li><a href="../ja496184/index.html">LEDディスプレイテクノロジー：マイクロLEDと ミニLED</a></li>
<li><a href="../ja496186/index.html">Word2Vecを例として使用したエラー逆伝播アルゴリズム</a></li>
<li><a href="../ja496188/index.html">テレビ番組を見るのをやめて生活を始める方法</a></li>
<li><a href="../ja496190/index.html">Phrasal Verbs-2について</a></li>
<li><a href="../ja496192/index.html">GoからRust関数を呼び出す</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>