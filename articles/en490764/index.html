<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🤝‍👨🏿 🌠 🍏 Grafana, InfluxDB, two tags and one amount. Or how to calculate the sum of subgroups? 👗 ⤵️ 🥤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! 
 
 Engaged in performance testing. And I really like to set up monitoring and enjoy the metrics in Grafana . And the standard for sto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Grafana, InfluxDB, two tags and one amount. Or how to calculate the sum of subgroups?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/490764/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ol/b6/9a/olb69a8cdqhqtmjf-ic8x8qjevi.png"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello everyone! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Engaged in performance testing. </font><font style="vertical-align: inherit;">And I really like to set up monitoring and enjoy the metrics in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And the standard for storing metrics in load tools is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can save metrics from such popular tools as:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="  Apache.JMeter
Real-time results

In this document we will present the configuration setup to graph and historize the data in different backends:

 • InfluxDB setup for InfluxDBBackendListenerClient
 • InfluxDB setup for GraphiteBackendListenerClient
 • Grafana
 • Graphite"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache.JMeter</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="  Gatling
Realtime monitoring

The sections below describe how to configure Gatling with InfluxDB and Graphite, and use Grafana as a graphing library"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gatling</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="  LoadRunner Enterprise
Manage analysis servers

This section describes how to configure external analysis database servers to be used with LoadRunner Enterprise"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loadrunner enterprise</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="  Yandex.Tank
Modules / Artifact uploaders / InfluxDB

      Yandex.Tank  InfluxDB"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working with performance testing tools and their metrics, I have accumulated a selection of programming recipes for the bundle of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I propose to consider an interesting problem that arises where there is a metric with two or more tags. </font><font style="vertical-align: inherit;">I think this is not uncommon. </font><font style="vertical-align: inherit;">And in the general case, the task sounds like this: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calculating the total metric for a group, which is divided into subgroups</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are three options: </font></font></h3><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just the amount grouped by Type tag</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana-way. </font><font style="vertical-align: inherit;">We use a stack of values</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum of highs with subquery</font></font></a></li>
</ol> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it all began</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configured JVM MBean monitoring using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jolokia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegraf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And he visualized metrics on memory pools - how much memory is allocated by each memory pool in HEAP and beyond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Charts on JVM memory pools and garbage collector activity from 13:00 of the previous day to 01:00 of the night of the current day (period of 12 hours). Here you can see that the memory pools are divided into two groups: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And that around 17:00 there was garbage collection, after which the size of the memory pools decreased: </font><font style="vertical-align: inherit;">
To collect metrics on memory pools, I specified the </font><font style="vertical-align: inherit;">following settings </font><font style="vertical-align: inherit;">in the </font><b><font style="vertical-align: inherit;">telegraf</font></b><font style="vertical-align: inherit;"> configuration file </font><font style="vertical-align: inherit;">: </font><b><font style="vertical-align: inherit;">telegraf.conf</font></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ow/ow/os/owowosl0e-neglcsbew-0u7bjjq.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<pre><code class="apache hljs">[<span class="hljs-attribute">outputs</span>.influxdb]
  <span class="hljs-attribute">urls</span> =<span class="hljs-meta"> ["http://influxdb_server:8086"]</span>
  <span class="hljs-attribute">database</span> = <span class="hljs-string">"telegraf"</span>
  <span class="hljs-attribute">username</span> = <span class="hljs-string">"login-InfluxDb"</span>
  <span class="hljs-attribute">password</span> = <span class="hljs-string">"*****"</span>
  <span class="hljs-attribute">retention_policy</span> = <span class="hljs-string">"month"</span>
  <span class="hljs-attribute">influx_uint_support</span> = false<font></font>
<font></font>
[<span class="hljs-attribute">agent</span>]
  <span class="hljs-attribute">collection_jitter</span> = <span class="hljs-string">"2s"</span>
  <span class="hljs-attribute">interval</span> = <span class="hljs-string">"2s"</span>
  <span class="hljs-attribute">precision</span> = <span class="hljs-string">"s"</span><font></font>
<font></font>
[[<span class="hljs-attribute">inputs</span>.jolokia<span class="hljs-number">2</span>_agent]]
  <span class="hljs-attribute">username</span> = <span class="hljs-string">"login-Jolokia"</span>
  <span class="hljs-attribute">password</span> = <span class="hljs-string">"*****"</span>
  <span class="hljs-attribute">urls</span> =<span class="hljs-meta"> ["http://127.0.0.1:7777/jvm-service"]</span><font></font>
<font></font>
[[<span class="hljs-attribute">inputs</span>.jolokia<span class="hljs-number">2</span>_agent.metric]]
  <span class="hljs-attribute">paths</span> =<span class="hljs-meta"> ["Usage","PeakUsage","CollectionUsage","Type"]</span>
  <span class="hljs-attribute">name</span> = <span class="hljs-string">"java_memory_pool"</span>
  <span class="hljs-attribute">mbean</span> = <span class="hljs-string">"java.lang:name=*,type=MemoryPool"</span>
  <span class="hljs-attribute">tag_keys</span> =<span class="hljs-meta"> ["name"]</span><font></font>
<font></font>
[[<span class="hljs-attribute">processors</span>.converter]]<font></font>
  [<span class="hljs-attribute">processors</span>.converter.fields]
    <span class="hljs-attribute">integer</span> =<span class="hljs-meta"> ["CollectionUsage.*", "PeakUsage.*", "Usage.*"]</span>
    <span class="hljs-attribute">tag</span> =<span class="hljs-meta"> ["Type"]</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana, I</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constructed a query to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to display in graphs the maximum metric value </font></font><b><code>Usage.Committed</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a period of time with a step </font></font><b><code>$granularity</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1m) and grouped by two tags </font></font><b><code>Type</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(HEAP or NON_HEAP) and </font></font><b><code>name</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Metaspace, G1 Old Gen, ...): </font><font style="vertical-align: inherit;">
The same query in text form, taking into account all </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> variables </font><font style="vertical-align: inherit;">(pay attention to escaping variable values ​​with </font><font style="vertical-align: inherit;">- this is important for the query to work correctly):</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/qx/2z/-2/qx2z-2mblgxyi-u6g4mrbyvybf8.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><code>:regex</code></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-string">"Usage.committed"</span>)
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"telegraf"</span>.<span class="hljs-string">"month"</span>.<span class="hljs-string">"java_memory_pool"</span>
<span class="hljs-keyword">WHERE</span>
    host =~ /^${host:regex}$/ <span class="hljs-keyword">AND</span>
    jolokia_agent_url =~ /^${jolokia:regex}$/ <span class="hljs-keyword">AND</span><font></font>
    $timeFilter<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-string">"Type"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-built_in">time</span>($granularity)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same query in text form, taking into account the specific values ​​of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variables </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-string">"Usage.committed"</span>)
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"telegraf"</span>.<span class="hljs-string">"month"</span>.<span class="hljs-string">"java_memory_pool"</span>
<span class="hljs-keyword">WHERE</span>
    host =~ /^serverName$/ <span class="hljs-keyword">AND</span>
    jolokia_agent_url =~ /^<span class="hljs-keyword">http</span>:\/\/<span class="hljs-number">127</span>\<span class="hljs-number">.0</span>\<span class="hljs-number">.0</span>\<span class="hljs-number">.1</span>:<span class="hljs-number">7777</span>\/jvm-service$/ <span class="hljs-keyword">AND</span>
    <span class="hljs-built_in">time</span> &gt;= <span class="hljs-number">1583834400000</span>ms <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &lt;= <span class="hljs-number">1583877600000</span>ms
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-string">"Type"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>m)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grouping by time </font></font><b><code>GROUP BY time($granularity)</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or is </font></font><b><code>GROUP BY time(1m)</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used to reduce the number of points on the chart. </font><font style="vertical-align: inherit;">For a time period of 12 hours and a grouping step of 1 minute, we get: 12 x 60 = 720 times or 721 points (the last point with a value of null).</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">721</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the expected number of points in response to requests to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the current settings for the time interval (12 hours) and grouping step (1 minute).</font></font></blockquote> <br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
memory </font><b><font style="vertical-align: inherit;">pool: Metaspace</font></b><font style="vertical-align: inherit;"> (blue) is in the lead in memory consumption at 20:00. </font><font style="vertical-align: inherit;">And according to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP: G1 Old Gen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (yellow) there was a small local surge at 17:03. </font><font style="vertical-align: inherit;">And at the time of 20:00, in total, all </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pools left </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.5 MiB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (113.2 + 45.9 + 13.4), and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pools </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">128 MiB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (67 + 57 + 4).</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ku/mo/wf/kumowfdo6gkw3wx_b8mugtsp8l4.png"></a><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember the values ​​for 20:00: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pools </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.5 MiB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pools </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">128 MiB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We will focus on these values ​​in the future.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the context of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we obtained the metric value easily. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the context of only the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">, the metric value is also easy to obtain, since all the names of the memory pools are unique, and it is enough to leave the grouping of results only by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The question remains: how to get what size is allocated for all HEAP pools and all NON_HEAP pools in total?</font></font></blockquote><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Just the amount grouped by Type tag</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Sum grouped by tag</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first solution that may come to mind is to group the values ​​by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">and calculate the sum of the values ​​in each group. </font><font style="vertical-align: inherit;">Such a query will look like this: A </font><font style="vertical-align: inherit;">
textual representation of a sum calculation request grouped by </font><b><font style="vertical-align: inherit;">Type</font></b><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">with all </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> variables </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/xz/w_/4a/xzw_4aonrgekrw4onxv9fwcctlg.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">sum</span>(<span class="hljs-string">"Usage.committed"</span>)
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"telegraf"</span>.<span class="hljs-string">"month"</span>.<span class="hljs-string">"java_memory_pool"</span>
<span class="hljs-keyword">WHERE</span>
    host =~ /^${host:regex}$/ <span class="hljs-keyword">AND</span>
    jolokia_agent_url =~ /^${jolokia:regex}$/ <span class="hljs-keyword">AND</span><font></font>
    $timeFilter<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-string">"Type"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a valid query, but it will return only two points: the sum will be calculated with grouping only by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">with two values ​​(HEAP and NON_HEAP). </font><font style="vertical-align: inherit;">We won’t even see the schedule. </font><font style="vertical-align: inherit;">There will be two free-standing points with a huge sum in values ​​(more than 3 TiB): </font><font style="vertical-align: inherit;">
Such a sum is not suitable, a breakdown into time intervals is needed.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/sz/lx/bo/szlxboh0o4r3-jsq7jg9d49wnic.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Amount grouped by tag per minute</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the original query, we grouped metrics by a custom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ granularity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interval </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Let's do the grouping now by a custom interval. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This query will turn out, it added </font></font><b><code>GROUP BY time($granularity)</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
We get inflated values, instead of 172.5 MiB by </font><b><font style="vertical-align: inherit;">NON_HEAP</font></b><font style="vertical-align: inherit;"> we see 4.88 GiB: </font><font style="vertical-align: inherit;">
Since metrics are sent to InfluxDB once every 2 seconds (see </font><b><font style="vertical-align: inherit;">telegraf.conf</font></b><font style="vertical-align: inherit;"> above), the sum of readings in one minute will not give the amount in the moment, and the sum of thirty such amounts. </font><font style="vertical-align: inherit;">We cannot </font><font style="vertical-align: inherit;">
divide the result by constant </font><b><font style="vertical-align: inherit;">30</font></b><font style="vertical-align: inherit;"> either. </font><font style="vertical-align: inherit;">Since </font><b><font style="vertical-align: inherit;">$ granularity</font></b><font style="vertical-align: inherit;"> is a parameter, it can be set to both 1 minute and 10 minutes. </font><font style="vertical-align: inherit;">And the value of the amount will change.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/yb/xp/tw/ybxptwbmibq2xlujuuwbkwb83nq.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/9l/lo/hn/9llohn9ncpoztbtcsrfqzfzoqya.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">Tag grouped per second</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to correctly get the metric value for the current metric collection intensity (2 seconds), you need to calculate the amount for a fixed interval that does not exceed the metric collection intensity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to display statistics with a grouping in seconds. Add to the </font></font><b><code>GROUP BY</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grouping </font></font><b><code>time(1s)</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
With such a small granularity, we get a huge number of points for our time interval of 12 hours (12 hours * 60 minutes * 60 seconds = 43,200 intervals, 43,201 points per line, the last of which is null): </font><font style="vertical-align: inherit;">
43,201 points in each line of the graph. There are so many </font><b><font style="vertical-align: inherit;">points</font></b><font style="vertical-align: inherit;"> that </font><b><font style="vertical-align: inherit;">InfluxDB</font></b><font style="vertical-align: inherit;"> will form a response for a long time, </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> will take a response longer, and then the browser will draw such a huge number of points for a long time.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/vn/sl/q_/vnslq_lq48mzzh9hgmjwiuvcy2i.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/_2/mw/4k/_2mw4ki9rcnf140m2doyqsn-zxy.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And not in every second there are points: metrics were collected every 2 seconds, and grouping by every second, which means that every second point will be null. To see a smooth line, configure the connection of non-empty values. Otherwise, we won’t see the graphs: </font><font style="vertical-align: inherit;">
Previously, </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> was such that the browser hung during the drawing of a large number of points. Now the version of </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> has the ability to draw several tens of thousands of points: the browser simply skips some of them, draws a graph using the thinned data. But the graph is smoothed out. Highs are displayed as average highs.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/xx/ya/hf/xxyahfkl3xzk6ezsakvgsbi8lp4.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, there is a graph, it is displayed accurately, the metrics at 20:00 are calculated correctly, the metrics in the chart legend are calculated correctly. </font><font style="vertical-align: inherit;">But the graph is smoothed: bursts are not visible on it with an accuracy of 1 second. </font><font style="vertical-align: inherit;">In particular, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> surge </font><font style="vertical-align: inherit;">at 17:03 disappeared from the chart, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chart is </font><font style="vertical-align: inherit;">very smooth: The </font><font style="vertical-align: inherit;">
minus in performance will clearly manifest itself over a longer time interval. </font><font style="vertical-align: inherit;">If you try to build a graph in a month (720 hours), and not in 12 hours, then everything will freeze with such a small granularity (1 second), there will be too many points. </font><font style="vertical-align: inherit;">And there is a minus in the absence of peaks, a paradox - </font><b><font style="vertical-align: inherit;">due to the high accuracy of obtaining metrics, we get a low accuracy of their display</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/1g/vs/m8/1gvsm8owfg-ifjjcqwf-w1q2lbk.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Grafana-way. </font><font style="vertical-align: inherit;">We use a stack of values</font></font></h2><br><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">It was</font></b><font style="vertical-align: inherit;"> not possible </font><font style="vertical-align: inherit;">
to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple and productive solution with </font><b><font style="vertical-align: inherit;">InfluxDB</font></b><font style="vertical-align: inherit;"> and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> query </font><b><font style="vertical-align: inherit;">designer</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We will only try using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tools </font><b><font style="vertical-align: inherit;">to</font></b><font style="vertical-align: inherit;"> summarize the metrics </font><b><font style="vertical-align: inherit;">displayed</font></b><font style="vertical-align: inherit;"> in the original chart. </font><font style="vertical-align: inherit;">And yes, this is possible!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1. </font><font style="vertical-align: inherit;">Just make Hover tooltip / Stacked value: cummulative</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will leave the request for choosing metrics unchanged, the same as in the section “How it all began”: </font><font style="vertical-align: inherit;">
Metrics will be grouped by </font><b><font style="vertical-align: inherit;">Type</font></b><font style="vertical-align: inherit;"> and </font><b><font style="vertical-align: inherit;">name</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But we will only display the </font><b><font style="vertical-align: inherit;">Type</font></b><font style="vertical-align: inherit;"> tag in the names of the graphs </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
And in the visualization settings, we will group the metrics by </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> stacks </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
First, add the separation of two tags into two different stacks A and B, so that their values ​​do not intersect:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/s5/an/3e/s5an3errkt29lgc8byme6tnowz4.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ls/vg/to/lsvgtohynssezzeiy04px0qwq3c.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/no/py/5g/nopy5ggb9ittxbz2phdei1egphg.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add series override</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / HEAP / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : A</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add series override</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / NON_HEAP / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : B</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then configure the visualization of metrics to display the total values ​​in a tooltip with graphs:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stacking &amp; Null value</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : On</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hover tooltip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stacked value</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : cummulative</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hover tooltip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : single</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the different features of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you need to perform actions in that order. </font><font style="vertical-align: inherit;">If you change the order of actions or leave some fields with default settings, something will not work:</font></font><br>
<br>
<ul>
<li>    Stack <b>A</b>  <b>B</b>    <b>Stacking &amp; Null value</b> / <b>Stack</b>: On,    ;</li>
<li>  <b>Hover tooltip / Mode</b>    ,    <b>Single</b>,  <b>Hover tooltip</b>    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, we see many lines, such to ourselves. </font><font style="vertical-align: inherit;">But! </font><font style="vertical-align: inherit;">If you </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hover</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> over the topmost </font><b><font style="vertical-align: inherit;">NON_HEAP</font></b><font style="vertical-align: inherit;"> , the tooltip will show the sum of the values ​​of all </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAPs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The amount is considered true, already by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> means </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
And if you hover over the topmost chart with the name </font><b><font style="vertical-align: inherit;">HEAP</font></b><font style="vertical-align: inherit;"> , we will see the amount by </font><b><font style="vertical-align: inherit;">HEAP</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The graph is displayed correctly. </font><font style="vertical-align: inherit;">Even the </font><b><font style="vertical-align: inherit;">HEAP</font></b><font style="vertical-align: inherit;"> surge </font><font style="vertical-align: inherit;">at 17:03 is visible: </font><font style="vertical-align: inherit;">
Formally, the task is completed. </font><font style="vertical-align: inherit;">
But there are cons - a lot of extra charts are displayed. </font><font style="vertical-align: inherit;">You need to get the cursor to the very top of them. </font><font style="vertical-align: inherit;">And in the legend to the graph, not cumulative, but individual values ​​are displayed, so the legend has become useless.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/p9/tx/tw/p9txtwio9i4uozvliutk5_dg13o.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/g5/78/bo/g578boco1u0sncwf0jmh8ejsyow.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2. </font><font style="vertical-align: inherit;">Stacked value: cummulative with hiding intermediate lines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's fix the first minus of the previous solution: make sure that extra charts are not displayed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add new metrics with a different name and value 0 to the results.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add new metrics to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack A</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , to the top of the stack.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hide from the display - the original lines of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We add two new ones after the main request: request </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for receiving a series with values ​​0 and name </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[NON_HEAP]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and request </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for receiving a series with values ​​0 and name </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[HEAP]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . To get 0, we take the first value of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Usage.committed”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field in each time group </font><font style="vertical-align: inherit;">and subtract it: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first (“Usage.committed”) - first (“Usage.committed”)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - we get a stable 0. The names of the graphs are changed without losing meaning due to the square brackets: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[NON_HEAP]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[HEAP]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">[HEAP]</font></b><font style="vertical-align: inherit;"> and </font><b><font style="vertical-align: inherit;">HEAP are</font></b><font style="vertical-align: inherit;"> combined into </font><b><font style="vertical-align: inherit;">Stack A</font></b><font style="vertical-align: inherit;"> , and also hide all </font><b><font style="vertical-align: inherit;">HEAP</font></b><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">[NON_HEAP]</font></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/no/kh/0f/nokh0fb2fp1t_ictdthli2etylg.png"></a><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">combine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hide NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">Get the</font></b><font style="vertical-align: inherit;"> 
correct amount by </font><b><font style="vertical-align: inherit;">[NON_HEAP]</font></b><font style="vertical-align: inherit;"> in the Tooltip when hovering over the chart: </font><font style="vertical-align: inherit;">
Get the correct amount by </font><b><font style="vertical-align: inherit;">[HEAP]</font></b><font style="vertical-align: inherit;"> in the Tooltip when hovering over the chart. </font><font style="vertical-align: inherit;">And even all the bursts are visible: </font><font style="vertical-align: inherit;">
And the schedule is formed quickly. </font><font style="vertical-align: inherit;">But the legend always displays 0, the legend has become useless. </font><font style="vertical-align: inherit;">
Everything worked out! </font><font style="vertical-align: inherit;">True bypass is through the </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> stacks </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is because of this that the article was added to the </font><b><font style="vertical-align: inherit;">Abnormal Programming</font></b><font style="vertical-align: inherit;"> category </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/uf/zw/7s/ufzw7sw-oxjflnzkglbilrdgmw4.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ga/mh/nz/gamhnzyw1thhnbi5mflkwrlvr_i.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/p_/tp/ev/p_tpevfzm7rwkc1534vyhe92ozg.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. The sum of the highs with the subquery</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we have already embarked on the path of abnormal programming with a bunch of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , let's continue. </font><font style="vertical-align: inherit;">Let's make </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> return a small number of points and make the legend appear.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1 Sum of increments of the cumulative sum of maxima</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's delve into the possibilities of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Previously, I often helped out by taking the derivative of the cumulative amount, so we’ll try to apply this approach now. </font><font style="vertical-align: inherit;">Let's switch to the mode of manual editing of requests: </font><font style="vertical-align: inherit;">
Let's make such a request:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/om/-b/yt/om-bytkvhp5zisny6gw5io_g2ba.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">sum</span>(<span class="hljs-string">"U"</span>) <span class="hljs-keyword">FROM</span> (
        <span class="hljs-keyword">SELECT</span> non_negative_difference(cumulative_sum(<span class="hljs-keyword">max</span>(<span class="hljs-string">"Usage.committed"</span>))) <span class="hljs-keyword">AS</span> <span class="hljs-string">"U"</span> 
        <span class="hljs-keyword">FROM</span> <span class="hljs-string">"month"</span>.<span class="hljs-string">"java_memory_pool"</span> 
        <span class="hljs-keyword">WHERE</span> <font></font>
            (<font></font>
                <span class="hljs-string">"host"</span> =~ /^${host:regex}$/ <span class="hljs-keyword">AND</span> 
                <span class="hljs-string">"jolokia_agent_url"</span> =~ /^${jolokia:regex}$/<font></font>
            ) <span class="hljs-keyword">AND</span> <font></font>
            $timeFilter <font></font>
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>($granularity), <span class="hljs-string">"Type"</span>, <span class="hljs-string">"name"</span><font></font>
)<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">"Type"</span>, <span class="hljs-built_in">time</span>($granularity)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the maximum value of the metric in the group by time is taken and the sum of such values ​​from the moment the reference begins, grouped by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tags </font><font style="vertical-align: inherit;">. As a result, at each moment of time there will be a sum of all indications by type ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NON_HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) with separation by pool name, but not 30 values ​​are summed, as was the case in version 1.2, but only one is the maximum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if we take the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non_negative_difference</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> increment of </font><font style="vertical-align: inherit;">such a cumulative sum for the last step, then we will get the sum value of all data pools grouped by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tags </font><font style="vertical-align: inherit;">at the beginning of the time interval. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, to get the amount by tag only</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , without grouping by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag </font><font style="vertical-align: inherit;">, you need to make a top-level request with similar grouping parameters, but without grouping by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of such a complex query, we get the sum of all types. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perfect schedule. </font><font style="vertical-align: inherit;">The sum of the maxima is calculated correctly. </font><font style="vertical-align: inherit;">There is a legend with the correct values, non-zero. </font><font style="vertical-align: inherit;">In the tooltip you can display all the metrics, not just Single. </font><font style="vertical-align: inherit;">Even </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bursts are displayed </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
One thing but - the request turned out to be difficult: the sum of the increment of the cumulative sum of maxima with a change in the grouping level.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/an/yv/1t/anyv1t7m69cwrl6cnwgl-dwd7xy.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2 Sum of highs with a change in the grouping level</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Can you do something simpler than in version 3.1? Pandora's box is already open, we switched to manual query editing mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a suspicion that receiving an increment from the cumulative amount leads to a zero effect - one extinguishes the other. Get rid of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non_negative_difference (cumulative_sum (...))</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simplify the request. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We simply leave the sum of the maxima, with a decrease in the grouping level:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">sum</span>(<span class="hljs-string">"A"</span>)
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-string">"Usage.committed"</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">"A"</span>
    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"month"</span>.<span class="hljs-string">"java_memory_pool"</span> 
    <span class="hljs-keyword">WHERE</span><font></font>
            (<font></font>
                <span class="hljs-string">"host"</span> =~ /^${host:regex}$/ <span class="hljs-keyword">AND</span> 
                <span class="hljs-string">"jolokia_agent_url"</span> =~ /^${jolokia:regex}$/<font></font>
            ) <span class="hljs-keyword">AND</span> <font></font>
            $timeFilter<font></font>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>($granularity), <span class="hljs-string">"Type"</span>, <span class="hljs-string">"name"</span><font></font>
)<font></font>
<span class="hljs-keyword">WHERE</span> $timeFilter
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>($granularity), <span class="hljs-string">"Type"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a quick simple query that returns only 721 points per series in 12 hours, when grouped by minutes: 12 (hours) * 60 (minutes) = 720 intervals, 721 points (last empty). Please note that the time filter is duplicated. It is in the subquery and in the grouping request: </font><font style="vertical-align: inherit;">
Without </font><b><font style="vertical-align: inherit;">$ timeFilter,</font></b><font style="vertical-align: inherit;"> in the external grouping request, the number of returned points will not be 721 in 12 hours, but more. Since the subquery is grouped for the interval </font><b><font style="vertical-align: inherit;">from</font></b><font style="vertical-align: inherit;"> ... </font><b><font style="vertical-align: inherit;">to</font></b><font style="vertical-align: inherit;"> , and the grouping of an external request without a filter will be for the interval </font><b><font style="vertical-align: inherit;">from</font></b><font style="vertical-align: inherit;"> ... </font><b><font style="vertical-align: inherit;">now</font></b><font style="vertical-align: inherit;"> . And if in </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> a time interval not last X-hours is selected (not such that </font><b><font style="vertical-align: inherit;">to</font></b><font style="vertical-align: inherit;"> = </font><b><font style="vertical-align: inherit;">now</font></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/8s/ab/tg/8sabtg9rebcu-tonmirjck2jdmk.png"></a><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but for the interval from the past ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &lt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">now</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), then empty points with a null value at the end of the selection will appear. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The resulting graph turned out to be simple, fast, correct. </font><font style="vertical-align: inherit;">With a legend that displays summary metrics. </font><font style="vertical-align: inherit;">With tooltip for multiple lines at once. </font><font style="vertical-align: inherit;">And also with the display of all bursts of values: </font><font style="vertical-align: inherit;">
The result is achieved!</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/an/yv/1t/anyv1t7m69cwrl6cnwgl-dwd7xy.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References (instead of references)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Distributions of the tools used in the article:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grafana</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (6.5.0)</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">influxdb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (1.7.9)</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">telegraf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (1.13.3)</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jolokia-jvm-1.6.2-agent.jar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (1.6.2)</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Documentation about the capabilities of the tools used in the article:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essence</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description</font></font></th>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retention policy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB Data Retention</font></font></a></td>
<td>Retention policy <b>montn</b>   30  ,     JVM    .       <b>auto</b>,     .   «  »   <b>telegraf.conf</b>      <b>InfluxDB</b>  ,      <b>Grafana</b></td>
</tr>
<tr>
<td>Telegraf / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">InfluxDB v1.x Output Plugin</a></td>
<td>    <b>Telegraf</b>  <b>InfluxDB</b>.     <b>telegraf.conf</b></td>
</tr>
<tr>
<td>Telegraf / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">agent / interval</a></td>
<td>   ,     2 .   «  »   <b>telegraf.conf</b>.   «1.2.       »  «1.3.       »</td>
</tr>
<tr>
<td>Java 8 / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Interface MemoryPoolMXBean</a></td>
<td>  MemoryPool,  ,     bool,  long.     <b>telegraf.conf</b>    int</td>
</tr>
<tr>
<td>Telegraf / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Jolokia2 Input Plugins</a></td>
<td>  <b>telegraf.conf</b>   MBean-,     <b>InfluxDB</b></td>
</tr>
<tr>
<td>Telegraf / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Converter Processor</a></td>
<td>  <b>telegraf.conf</b>,      <b>float</b>   <b>int</b>    <b>InfluxDB</b>.      <b>Type</b>   <b>Type</b>,        </td>
</tr>
<tr>
<td>Grafana / Variables / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Advanced Formatting Options / Regex</a></td>
<td> Grafana,    Multiselect    ,    ,     ,    <b><code>~ /^<u>${}</u>$/</code></b> — ,  <b><code>~ /^${<u>:regex</u>}$/</code></b></td>
</tr>
<tr>
<td>Grafana / Variables / Global Built-in Variables / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">The $timeFilter or $__timeFilter Variable</a></td>
<td> Grafana- <b>$timeFilter</b>,     </td>
</tr>
<tr>
<td>InfluxDB / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">MAX()</a></td>
<td>  <b>MAX()</b>  <b>InfluxDB</b> 1.7,       </td>
</tr>
<tr>
<td>InfluxDB / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">SUM()</a></td>
<td>    <b>SUM()</b>  <b>InfluxDB</b> 1.7</td>
</tr>
<tr>
<td>InfluxDB / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Subqueries</a></td>
<td>    <b>InfluxDB</b> 1.7,     3 </td>
</tr>
<tr>
<td>InfluxDB / Transformation / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">CUMULATIVE_SUM()</a></td>
<td>  <b>CUMULATIVE_SUM()</b>,        <b>InfluxDB</b>,    <b>NON_NEGATIVE_DERIVATIVE()</b></td>
</tr>
<tr>
<td>InfluxDB / Transformation / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">NON_NEGATIVE_DERIVATIVE()</a></td>
<td>  <b>NON_NEGATIVE_DERIVATIVE()</b>,     3 .     <b>CUMULATIVE_SUM()</b> —          3</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Using Grafana’s Query Inspector to troubleshoot issues</a></td>
<td> <b>Query Inspector</b>,         ,        Grafana-</td>
</tr>
<tr>
<td>Grafana / Graph / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Draw Options</a></td>
<td>  Stack, Tooltip,…              «2. Grafana-way.   » </td>
</tr>
<tr>
<td>Grafana / Graph / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Series overrides</a></td>
<td>       (     )  <b>Grafana</b></td>
</tr>
</tbody></table></div><br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">combination of Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> needs to be well known to performance testing engineers. And in this bundle, many simple tasks are very interesting, and they can not always be solved by normal programming methods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes abnormal programming skills may be needed with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> features </font><font style="vertical-align: inherit;">and subtleties of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> query </font><b><font style="vertical-align: inherit;">language</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the article, four steps were taken into account of the implementation of summarizing a metric with a grouping by one tag, but which has several tags. The task was interesting. And there are many such tasks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">am</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> preparing a report on the subtleties of programming with </font><b><font style="vertical-align: inherit;">Grafana</font></b><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">I will periodically publish materials on this topic. </font><font style="vertical-align: inherit;">In the meantime, I will be happy with your questions on the current article.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490754/index.html">Visual Studio Code Code Editor. The most detailed guide for setting up and installing plugins for beginners</a></li>
<li><a href="../en490756/index.html">Deploy Jenkins as code</a></li>
<li><a href="../en490758/index.html">Mathematicians have proved the universal law of turbulence</a></li>
<li><a href="../en490760/index.html">Ray Casting Visual Search (RCVS). Simple and fast algorithm for finding 3D models similar in geometry</a></li>
<li><a href="../en490762/index.html">How to forecast airfare?</a></li>
<li><a href="../en490766/index.html">How to understand a beginner, which language to choose for the desired profession?</a></li>
<li><a href="../en490768/index.html">When computer games are your job: the internal device of cloud gaming</a></li>
<li><a href="../en490770/index.html">Down with the technical debt! At TechLead Conf 2020, we’ll show you how</a></li>
<li><a href="../en490772/index.html">How to write and publish a smart contract in the Telegram Open Network (TON)</a></li>
<li><a href="../en490774/index.html">Responsive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>