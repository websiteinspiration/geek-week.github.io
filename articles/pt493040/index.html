<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëßüèΩ üë±üèø üé® Barra de rolagem que falhou üßíüèª üë≤üèº üåø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente lan√ßou uma nova vers√£o do Windows Terminal. Tudo ficaria bem, mas o desempenho de sua barra de rolagem deixava muito a desejar. Portanto,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Barra de rolagem que falhou</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente lan√ßou uma nova vers√£o do Windows Terminal. </font><font style="vertical-align: inherit;">Tudo ficaria bem, mas o desempenho de sua barra de rolagem deixava muito a desejar. </font><font style="vertical-align: inherit;">Portanto, √© hora de enfi√°-lo e tocar pandeiro.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que os usu√°rios costumam fazer com a nova vers√£o de qualquer aplicativo? </font><font style="vertical-align: inherit;">√â isso mesmo, exatamente o que os testadores n√£o fizeram. </font><font style="vertical-align: inherit;">Portanto, ap√≥s um breve uso do terminal para a finalidade pretendida, comecei a fazer coisas terr√≠veis com ele. </font><font style="vertical-align: inherit;">Tudo bem, tudo bem, eu apenas derramei caf√© no teclado e acidentalmente apertei &lt;Enter&gt; quando o limpei. </font><font style="vertical-align: inherit;">O que aconteceu no final?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, n√£o parece muito impressionante, mas n√£o se apresse em jogar pedras em mim. </font><font style="vertical-align: inherit;">Preste aten√ß√£o ao lado direito. </font><font style="vertical-align: inherit;">Primeiro tente descobrir o que h√° de errado com ela. </font><font style="vertical-align: inherit;">Aqui est√° uma captura de tela para uma dica:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, o t√≠tulo do artigo foi um s√©rio spoiler. :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, h√° um problema com a barra de rolagem. Movendo-se para uma nova linha muitas vezes, depois de cruzar a borda inferior, voc√™ normalmente espera que uma barra de rolagem apare√ßa e pode rolar para cima. No entanto, isso n√£o acontece at√© escrevermos um comando com a sa√≠da de alguma coisa. Vamos apenas dizer que o comportamento √© estranho. No entanto, isso pode n√£o ter sido t√£o cr√≠tico se a barra de rolagem funcionasse ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de testar um pouco, descobri que mudar para uma nova linha n√£o aumenta o buffer. Isso apenas produz a sa√≠da de comandos. Portanto, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acima </font><font style="vertical-align: inherit;">aumentar√° o buffer em apenas uma linha. Por esse motivo, com o tempo, perderemos muita hist√≥ria, principalmente depois de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">claro.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que me veio √† mente foi usar nosso analisador e ver o que diz:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A conclus√£o, √© claro, √© de tamanho impressionante, ent√£o aproveitarei o poder de filtrar e cortar tudo, exceto o que cont√©m a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o posso dizer que existem muitas mensagens ... Bem, talvez haja algo relacionado ao buffer?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O analisador n√£o falhou e encontrou algo interessante. </font><font style="vertical-align: inherit;">Eu destaquei este aviso acima. </font><font style="vertical-align: inherit;">Vamos ver o que est√° errado l√°: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Existem subexpress√µes id√™nticas √† esquerda e √† direita do operador '-': bufferHeight - bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo √© acompanhado por um coment√°rio: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Configure a altura do ScrollViewer e a grade que estamos usando para falsificar nossa altura de rolagem". </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro que simular a altura do rolo √© bom, mas por que estamos colocando 0 no m√°ximo? </font><font style="vertical-align: inherit;">Voltando √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ficou claro que o c√≥digo n√£o √© muito suspeito. </font><font style="vertical-align: inherit;">N√£o me interpretem mal: subtrair uma vari√°vel de si mesma √©, √© claro, suspeito, mas obtemos um zero na sa√≠da, o que n√£o nos prejudica. </font><font style="vertical-align: inherit;">De qualquer forma, tentei especificar o </font><font style="vertical-align: inherit;">valor padr√£o (1) </font><font style="vertical-align: inherit;">no campo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°ximo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A barra de rolagem apareceu, mas tamb√©m n√£o funciona:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se for o caso, apertei &lt;Enter&gt; por 30 segundos. Aparentemente, esse n√£o √© o problema, ent√£o vamos deix√°-lo como estava, exceto substituindo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por 0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, n√£o estamos particularmente perto de resolver o problema. Na aus√™ncia de uma oferta melhor para entrar em desagrado. No come√ßo, poder√≠amos colocar um ponto de interrup√ß√£o na linha alterada, mas duvido que isso nos ajude de alguma forma. Portanto, primeiro precisamos encontrar o fragmento respons√°vel pelo deslocamento da Viewport em rela√ß√£o ao buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pouco sobre como a barra de rolagem local (e provavelmente qualquer outra) funciona. Temos um grande buffer que armazena toda a sa√≠da. Para interagir com ele, algum tipo de abstra√ß√£o √© usada para desenhar na tela, neste caso, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando essas duas primitivas, podemos entender qual √© o nosso problema. Ir para uma nova linha n√£o aumenta o buffer e, por isso, simplesmente n√£o temos para onde ir. Portanto, o problema est√° nele.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armado com esse conhecimento comum, continuamos nossa debilidade her√≥ica. </font><font style="vertical-align: inherit;">Ap√≥s uma pequena caminhada pela fun√ß√£o, chamei a aten√ß√£o para este fragmento:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de configurar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acima </font><font style="vertical-align: inherit;">, configuramos v√°rias fun√ß√µes de retorno de chamada e executamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para nossa janela rec√©m-criada. </font><font style="vertical-align: inherit;">Ap√≥s o qual o lambda acima √© chamado. </font><font style="vertical-align: inherit;">Como esta √© a primeira vez que escrevemos algo no buffer, sugiro iniciar nossa depura√ß√£o a partir da√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definimos um ponto de interrup√ß√£o dentro do lambda e olhamos em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, temos duas vari√°veis ‚Äã‚Äãextremamente importantes para n√≥s - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Coloque pontos de interrup√ß√£o neles e descubra onde eles mudam. √â verdade que, com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">trapaceio um</font></i><font style="vertical-align: inherit;"> pouco e coloco um ponto de interrup√ß√£o n√£o na vari√°vel em si, mas em seu campo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">superior</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (s√≥ precisamos dela). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora clique em &lt;F5&gt;, e nada acontece ... Bem, vamos pressionar algumas dezenas de vezes &lt;Enter&gt;. Nada aconteceu. Aparentemente, no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , definimos um ponto de interrup√ß√£o de maneira muito imprudente, e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como esperado, permaneceu no topo do buffer, o que n√£o aumentou em tamanho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, faz sentido inserir um comando para fazer com que o v√©rtice seja atualizado.</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Depois disso, descobrimos um c√≥digo muito interessante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apontei um coment√°rio de onde paramos. </font><font style="vertical-align: inherit;">Se voc√™ olhar o coment√°rio sobre o fragmento, fica claro que estamos mais pr√≥ximos da solu√ß√£o do que nunca. </font><font style="vertical-align: inherit;">√â neste local que a parte vis√≠vel √© deslocada em rela√ß√£o ao buffer e temos a oportunidade de rolar. </font><font style="vertical-align: inherit;">Depois de observar um pouco o comportamento, notei um ponto interessante: ao passar para uma nova linha, o valor da vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© igual ao valor da </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">janela</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><i><font style="vertical-align: inherit;">visualiza√ß√£o</font></i><font style="vertical-align: inherit;"> , portanto, n√£o a omitimos e nada funciona. </font><font style="vertical-align: inherit;">Al√©m disso, h√° um problema semelhante com a vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, vamos aumentar o valor de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em um e ver o que aconteceu:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o resultado do lan√ßamento:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maravilhas! </font><font style="vertical-align: inherit;">Entrei em quantidade e a barra de rolagem funciona. </font><font style="vertical-align: inherit;">√â verdade, at√© o momento em que apresentamos algo ... Para demonstrar o arquivo, anexarei um gif:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparentemente, estamos fazendo alguns saltos extras para uma nova linha. </font><font style="vertical-align: inherit;">Vamos tentar limitar nossas transi√ß√µes usando a coordenada X. Somente mudaremos a linha quando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for 0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fragmento escrito acima mudar√° a coordenada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do cursor. </font><font style="vertical-align: inherit;">Ent√£o atualizamos a posi√ß√£o do cursor. </font><font style="vertical-align: inherit;">Em teoria, isso deve funcionar ... O que aconteceu?</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, claro, melhor. </font><font style="vertical-align: inherit;">No entanto, h√° um problema em que alteramos o ponto de sa√≠da, mas n√£o alteramos o buffer. </font><font style="vertical-align: inherit;">Portanto, vemos duas chamadas do mesmo comando. </font><font style="vertical-align: inherit;">Pode, √© claro, parecer que eu sei o que estou fazendo, mas n√£o √© assim. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse ponto, decidi verificar o conte√∫do do buffer e retornei ao ponto em que iniciei a depura√ß√£o:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu configurei um ponto de interrup√ß√£o no mesmo local da √∫ltima vez e comecei a examinar o conte√∫do da vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vamos come√ßar com o que vi na minha tela:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que voc√™ acha que estar√° na string </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quando eu pressionar &lt;Enter&gt;?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LONG DESCRIPTION"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O buffer inteiro que vemos agora.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O buffer inteiro, mas sem a primeira linha.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu n√£o vou definhar - o buffer inteiro, mas sem a primeira linha. </font><font style="vertical-align: inherit;">E este √© um problema consider√°vel, porque √© precisamente por isso que estamos perdendo a hist√≥ria, al√©m disso, pontualmente. </font><font style="vertical-align: inherit;">√â assim que o nosso fragmento de sa√≠da de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuidar√° de </font><font style="vertical-align: inherit;">ir para uma nova linha:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com uma flecha, marquei o local onde </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estava ‚ÄúLONG DESCRIPTOIN‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Talvez ent√£o substitua o buffer com um deslocamento de uma linha? </font><font style="vertical-align: inherit;">Isso funcionaria se esse retorno de chamada n√£o fosse chamado para todos os espirros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu descobri pelo menos tr√™s situa√ß√µes quando √© chamado,</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando inserimos qualquer caractere;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando passamos pela hist√≥ria;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando executamos o comando.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que voc√™ precisa mover o buffer apenas quando executamos o comando ou digite &lt;Enter&gt;. </font><font style="vertical-align: inherit;">Em outros casos, fazer isso √© uma m√° ideia. </font><font style="vertical-align: inherit;">Ent√£o, precisamos determinar de alguma forma o que precisa ser mudado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="Quadro 18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo foi uma tentativa de mostrar com que habilidade o PVS-Studio foi capaz de encontrar c√≥digos defeituosos que levaram ao erro que notei. </font><font style="vertical-align: inherit;">A mensagem sobre o t√≥pico de subtrair uma vari√°vel de si mesma me motivou fortemente, e eu rapidamente comecei a escrever texto. </font><font style="vertical-align: inherit;">Mas como voc√™ pode ver, minha alegria foi prematura e tudo se tornou muito mais complicado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o eu decidi parar. </font><font style="vertical-align: inherit;">Ainda era poss√≠vel passar algumas noites, mas quanto mais eu fazia isso, mais e mais problemas surgiam. </font><font style="vertical-align: inherit;">Tudo o que posso fazer √© desejar aos desenvolvedores do Terminal do Windows boa sorte na corre√ß√£o desse bug. </font><font style="vertical-align: inherit;">:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero n√£o decepcionar o leitor por n√£o ter terminado a pesquisa e que tenha sido interessante para mim dar um passeio pelo interior do projeto. Como compensa√ß√£o, sugiro usar o c√≥digo promocional #WindowsTerminal, gra√ßas ao qual voc√™ receber√° uma vers√£o demo do PVS-Studio n√£o por uma semana, mas imediatamente por um m√™s. Se voc√™ ainda n√£o experimentou o analisador est√°tico do PVS-Studio, esse √© um bom motivo para fazer exatamente isso. Basta digitar "#WindowsTerminal" no campo "Mensagem" na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p√°gina de download</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, aproveitando esta oportunidade, quero lembr√°-lo de que em breve haver√° uma vers√£o do analisador C # funcionando no Linux e no macOS. E agora voc√™ pode se inscrever para testes preliminares.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Maxim Zvyagintsev. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pequena barra de rolagem que n√£o podia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493026/index.html">Teste no prod: Canary Deployment</a></li>
<li><a href="../pt493032/index.html">5. Perguntas Mais Freq√ºentes do Check Point Maestro (FAQ)</a></li>
<li><a href="../pt493034/index.html">COVID-19: previs√£o do n√∫mero de pacientes com coronav√≠rus</a></li>
<li><a href="../pt493036/index.html">Tor√ßo e tor√ßo, quero confundir: manipula√ß√µes com grafeno de duas camadas</a></li>
<li><a href="../pt493038/index.html">Sobre a cultura corporativa para equipes distribu√≠das e n√£o apenas</a></li>
<li><a href="../pt493042/index.html">Segmento de dados de p√∫blico-alvo do mercado de publicidade e marketing on-line. Parte. 1. Altera√ß√µes na legisla√ß√£o</a></li>
<li><a href="../pt493046/index.html">Como planejar a abertura de um caf√© ou escrever seu pr√≥prio planejador para abrir estabelecimentos</a></li>
<li><a href="../pt493050/index.html">Pesquisa n√£o √© o que encontrar</a></li>
<li><a href="../pt493052/index.html">Problema</a></li>
<li><a href="../pt493060/index.html">Trabalho remoto como uma chance de revelar o gerente de projeto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>