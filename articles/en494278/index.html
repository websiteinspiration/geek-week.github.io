<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂ ‚ôæ üë≤üèø EF Core + Oracle: how to make migrations idempotent üßôüèª ü§Ωüèº üëçüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Typically, the EF Core framework is used in conjunction with MS SQL, another Microsoft product. However, this is not a dogma. For example, at CUSTIS w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EF Core + Oracle: how to make migrations idempotent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/494278/"><img src="https://habrastorage.org/webt/3a/lj/or/3aljorcjihhefstlxuybizl-3tg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typically, the EF Core framework is used in conjunction with MS SQL, another Microsoft product. </font><font style="vertical-align: inherit;">However, this is not a dogma. </font><font style="vertical-align: inherit;">For example, at CUSTIS we write business logic in C #, and we use Oracle to manage the databases. </font><font style="vertical-align: inherit;">EF Core has a wonderful migration mechanism, but in our case they are not idempotent. </font><font style="vertical-align: inherit;">The fact is that Oracle and a number of other databases, such as MySQL, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do not support transactional DDL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This means that if migration falls somewhere in the middle, it cannot be rolled or rolled back. </font><font style="vertical-align: inherit;">How to implement idempotent migrations to EF Core without MS SQL?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our company has a fairly powerful tool for installing patches on an Oracle database, which we use in a number of projects. </font><font style="vertical-align: inherit;">It was written when there was no Liquibase, EF migrations, and other open tools. </font><font style="vertical-align: inherit;">Patcher allows you to work with hundreds of databases, track installation history, view logs, store secrets and much more. </font><font style="vertical-align: inherit;">Scripts for changing the database are written in the form of SQL or m4 macros. </font><font style="vertical-align: inherit;">With their help, you can, among other things, modify the structure: create tables, columns and other objects. </font><font style="vertical-align: inherit;">Moreover, m4 macros are idempotent. </font><font style="vertical-align: inherit;">This means that if you try to create, for example, the table, the script does not fall, but sees that it already exists and skips the creation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose a script to install a patch consists of two operations:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create table A.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating Table B.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the script crashes after the first operation, table A remains in Oracle. Re-applying the patch will work correctly: the script will verify that A already exists, so it will immediately proceed to the second operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the advantages, the patcher still has a drawback - the tool is closed and is used only in CUSTIS. Developers have to learn to work with him, and outside the company such an experience is not very valuable. In addition, the patcher does not support Code First mode of operation, so all the scripts for changing the database structure have to be written manually. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We wanted to try some ready-made mechanism for installing patches and chose migration. At the end of 2019, another project was just launched for the customer, on which we decided to test a new approach. The main problem of this mechanism was the non-idepotency of migrations.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In MS SQL, a chain of DDL statements or migration is performed as a single compound transaction. </font><font style="vertical-align: inherit;">In case of interruption, the operation is completely canceled. </font><font style="vertical-align: inherit;">Oracle DDL is non-transactional, so a drop in migration will lead to an inconsistent state of the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Back to the patch, which consists of two operations: creating tables A and B. If the migrator falls after the first, Oracle will remain in table A. Restarting will not work - the operator </font></font><code>CREATE TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will not like that A already exists. </font><font style="vertical-align: inherit;">It will also fail to roll back the migration: EF Core writes to the system table that the migration was completed, only at the very end of the process. </font><font style="vertical-align: inherit;">From the point of view of EF Core, if the migration has not yet been completed, then there is nothing to roll back.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The search for a ready-made solution for Oracle on the Internet did not yield results. All I have found are articles on how to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">install</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> patches when working with EF. A little later on StackOverflow I came up with the idea of ‚Äã‚Äãmaking my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMigrationsSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This interface is responsible for generating SQL code that processes EF operations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The package </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle.EntityFrameworkCore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> included OracleMigrationsSqlGenerator, implements IMigrationsSqlGenerator. For example, if you want to add a column, the following code will be generated:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> MY_TABLE <span class="hljs-keyword">ADD</span> (MY_COLUMN <span class="hljs-built_in">DATE</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the code is passed to other classes to run in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To start, I tried to override a pair of OracleMigrationsSqlGenerator operations. </font><font style="vertical-align: inherit;">The task turned out to be quite feasible, and I started writing an idempotent migrant. </font><font style="vertical-align: inherit;">This is how </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> came </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">about</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before operation EF, our migrator checks to see if it has been performed before. </font><font style="vertical-align: inherit;">For example, a column is added like this:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    i <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> i
    <span class="hljs-keyword">FROM</span> user_tab_columns
    <span class="hljs-keyword">WHERE</span> table_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_TABLE'</span>) <span class="hljs-keyword">AND</span> column_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_COLUMN'</span>);<font></font>
    IF I != 1 THEN<font></font>
        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">IMMEDIATE</span> <span class="hljs-string">'ALTER TABLE MY_TABLE ADD (MY_COLUMN DATE)'</span>;  
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;       
<span class="hljs-keyword">END</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the package is very simple - you just need to replace it </font></font><code>IMigrationsSqlGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the right context:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
    {<font></font>
        optionsBuilder.ReplaceService&lt;IMigrationsSqlGenerator, IdempotentSqlGenerator&gt;();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Migrations are formed and set by the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standard tools for EF Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">dotnet ef migrations <span class="hljs-keyword">add</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.1</span>
dotnet ef database update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The general approach laid down in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be implemented in generators written for MySQL, MariaDB, Teradata, AmazonAurora and other databases in which DDL is not transactional.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The package is available on NuGet </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources on GitHub</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494264/index.html">Two-node cluster - the devil in detail</a></li>
<li><a href="../en494266/index.html">About udalenka, unprotected RDP and the increase in the number of servers available from the Internet</a></li>
<li><a href="../en494270/index.html">Antiquities: Remote Work on 1998 Devices</a></li>
<li><a href="../en494272/index.html">Creating an IT startup business plan: step-by-step detailed structure</a></li>
<li><a href="../en494274/index.html">E-commerce autotest system</a></li>
<li><a href="../en494284/index.html">Homemade antiseptic from what is in the pharmacy. We make alcohol from vodka without a moonshine in the old-fashioned way</a></li>
<li><a href="../en494286/index.html">Embox RTOS on Raspberry Pi</a></li>
<li><a href="../en494290/index.html">#YAMYWork. A decision that may be right</a></li>
<li><a href="../en494292/index.html">Wrike: 5 years with OKR</a></li>
<li><a href="../en494294/index.html">3D printing certified for the oil and gas and marine industries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>