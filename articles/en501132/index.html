<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëçüèø üïü üïõ How to make work with Microsoft Remote Desktop better üë¶üèª ‚è±Ô∏è ‚úãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share some tips on setting up remote connection to workstations via RDP. I'll tell you how to upgrade the ancient RPC-HTTP to UDP, praise an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to make work with Microsoft Remote Desktop better</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501132/"><img src="https://habrastorage.org/webt/dx/s8/wi/dxs8wiugrbhaov1gzied15gldk8.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I want to share some tips on setting up remote connection to workstations via RDP. I'll tell you how to upgrade the ancient RPC-HTTP to UDP, praise and scold Windows 10 and AVC, I will figure out a solution to several typical problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We believe that Remote Desktop Gateway (RDGW) is used for connection, and workstations act as servers. Using RDGW is very convenient because the gateway becomes a common entry point for all clients. This makes it possible to better control access, keep records of connections and their duration. Even if the VPN allows you to connect to working machines directly, this is not the best option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RDGW is quick, easy to configure, and Let's Encrypt and win-acme easily solve the problem with a trusted certificate.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are three transport protocols over which the client can connect to the server: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPC-HTTP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><font color="red"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bad</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><font color="orange"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">better</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP + UDP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><font color="green"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellent</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By server we mean a working machine, by a client - home. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing to start with is to turn ‚Äúbad‚Äù into ‚Äúexcellent‚Äù.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade RPC-HTTP to HTTP</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connection to a session using RPC-HTTP is easy to determine by the appearance of the connection strip. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7w/-0/aa/7w-0aativt247pvbumddqkf4epg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no connection quality icon (about it below), which means we are using the old RPC wrapped in TLS - this is very slow. </font><font style="vertical-align: inherit;">The point, of course, is not only in the wrapper - the protocol itself changes with each release of the OS, codecs, image packing algorithms change. </font><font style="vertical-align: inherit;">The fresher the protocol, the better. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows XP or Vista</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In XP, you can raise the protocol from 5.1 to 7. The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">windowsxp-kb969084-x86.exe hotfix.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In Vista, from 6 to 7. The hotfix has the same number, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">windows6.0-kb969084-x64.msu or Windows6.0-KB969084-x86 files .msu</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
But RDP 7 does not work over HTTP and UDP. Only upgrade the client and server to Windows 7 and later will help. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 7</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
First you need to upgrade the protocol to RDP 8.1, and then enable it. Support is added by updates that are grouped into a single download package: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.microsoft.com/en-US/download/details.aspx?id=40986</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Windows6.1-KB2574819-v2-x64.msu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
windows6.1-kb2592687-x64.msu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows6.1-KB2830477-x64.msu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows6.1-KB2857650-x64.msu </font></font><br>
<s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows6.1-KB2913751-x64.msu</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (replaced by kb2923545)</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">windows6.1-kb2923545-x64.msu</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
So you get both the fresh mstsc.exe client and RDP 8.1 support for the server side of the OS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/37/pl/yx37plxdymw73eubymzh1v0zgzm.png"><br>
<br>
<img src="https://habrastorage.org/webt/r1/kh/ip/r1khiphuyrmxmmodab_ecjiktiq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It became: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rt/9v/dj/rt9vdjdnfmus27h9nyn7ctpyp7g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the protocol must be turned on with the registry key (for this you can use the adm template bundled with Windows 7).</font></font><br>
<br>
<pre><code class="powershell hljs">[<span class="hljs-type">HKEY_LOCAL_MACHINE</span>\<span class="hljs-type">SOFTWARE</span>\<span class="hljs-type">Policies</span>\<span class="hljs-type">Microsoft</span>\<span class="hljs-type">Windows</span> <span class="hljs-type">NT</span>\<span class="hljs-type">Terminal</span> <span class="hljs-type">Services</span>]<font></font>
<span class="hljs-string">"fServerEnableRDP8"</span>=dword:<span class="hljs-number">00000001</span><font></font>
 <font></font>
[<span class="hljs-type">HKEY_LOCAL_MACHINE</span>\<span class="hljs-type">SOFTWARE</span>\<span class="hljs-type">Wow6432Node</span>\<span class="hljs-type">Policies</span>\<span class="hljs-type">Microsoft</span>\<span class="hljs-type">Windows</span> <span class="hljs-type">NT</span>\<span class="hljs-type">Terminal</span> <span class="hljs-type">Services</span>]<font></font>
<span class="hljs-string">"fServerEnableRDP8"</span>=dword:<span class="hljs-number">00000001</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enable UDP transport support in Group Policy. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/_t/ds/bg_tdse5uudrekmylffvhh_gqzq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We reboot the server with Windows 7. The same case when you may need to reboot twice - the value in the registry must be set before RDP is turned on, and Group Policy is applied later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything </font><font style="vertical-align: inherit;">
worked </font><font style="vertical-align: inherit;">out, then when you connect to the server, a connection quality icon (like in a phone for a mobile network) will appear in the session bar: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/_0/ok/8b_0okltugyxpizhhcydchtsve8.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 8 and newer The</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> protocol works out of the box.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade HTTP to HTTP + UDP</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your network is not prone to packet loss, UDP dramatically (for CAD - drastically) improves server responsiveness by using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FEC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to reduce retransmission, as well as switching packet delivery confirmation from the TCP / IP system stack to the RDP-UDP protocol level. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One main control session via HTTP is connected from each client (a keyboard / mouse is also transmitted in this channel), plus one or more UDP sessions to transmit a picture or other virtual channels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will only touch the tip of the iceberg. There are 3 different versions of the RDP-UDP protocol. In addition, UDP itself can operate in two modes: UDP-R (reliable) and UDP-L (lossy). Nothing just happens with Microsoft. But since nothing depends on us here, just keep in mind - the newer the operating system, the topic uses a more modern protocol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outside, RDP-UDP is wrapped in Datagram Transport Layer Security (DTLS) RFC4347, as you can see by opening Wireshark. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More details in the documents: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[MS-RDPEMT]: Remote Desktop Protocol: Multitransport Extension </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[MS-RDPEUDP]: Remote Desktop Protocol: UDP Transport Extension </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[MS-RDPEUDP2]: Remote Desktop Protocol: UDP Transport Extension Version 2</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Where wrong, correct you are welcome.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do you need to enable UDP? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RDP-UDP is supported starting from RDP 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The udp / 3389 port must be open on the client. If you closed it with a local firewall, ACL on the switch or an external firewall - the port must be opened. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the Remote Desktop Gateway server to the tcp / 443 port, open udp / 3391. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The port can be changed, here is how it is configured: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o6/n0/w3/o6n0w3fmookrhmxaqomyx8wretk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Windows 7, NLA (Network Level Authentication) must be enabled. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/kz/ny/ntkznyeqsvsh3msad2u59_rxcck.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Can be enabled in Group Policy </font></font><br>
<br>
<img src="https://habrastorage.org/webt/my/hj/sw/myhjswie2h7znzjoamnhf6clzq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
or through the registry</font></font><br>
<br>
<pre><code class="powershell hljs">[<span class="hljs-type">HKEY_LOCAL_MACHINE</span>\<span class="hljs-type">SYSTEM</span>\<span class="hljs-type">CurrentControlSet</span>\<span class="hljs-type">Control</span>\<span class="hljs-type">Terminal</span> <span class="hljs-type">Server</span>\<span class="hljs-type">WinStations</span>\<span class="hljs-type">RDP</span>-<span class="hljs-type">Tcp</span>]<font></font>
<span class="hljs-string">"SecurityLayer"</span>=dword:<span class="hljs-number">00000001</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is the connection is not clear. But without NLA on 7-ke does not work, on more recent releases of NLA for work UDP is not required. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After establishing a session over HTTP, the client and server </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try to</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> negotiate a UDP connection. If there is packet loss or delay, then the UDP session will not start. The exact UDP negotiation failure algorithm is not fully understood. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is configured, then after connecting, click on the link quality button. The window will indicate that UDP is negotiated. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d7/y4/jx/d7y4jx5ubs4i9zop5myyzg21oyo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the gateway, it looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oc/ld/7n/ocld7nbslu8dt_fjahnvd-zqvso.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have Windows 10 both on the server and on the client, then this is the fastest and most problem-free option. Microsoft is actively finalizing RDP, and in the latest releases 10 you can count on a good speed. Colleagues could not detect the difference between Citrix and Windows 10 RDP in AutoCAD speed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a good article about the evolution of AVC-based RDP codecs in Windows 10 </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remote Desktop Protocol (RDP) 10 AVC / H.264 improvements in Windows 10 and Windows Server 2016 Technical Preview</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Matching AVC with hardware encoding can be seen in the event log (see the article above for more details) ):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/4_/_n/kf4__nmejj4amr9nctpufhwfb6a.png"><br>
<br>
<img src="https://habrastorage.org/webt/ld/rn/ld/ldrnldvgbclldmcr2f8pxoztfxo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I note only that there is still a distortion problem even with h.264 4: 4: 4. </font><font style="vertical-align: inherit;">It immediately catches your eye if you work in PowerShell ISE - the error text is displayed with unpleasant distortion. </font><font style="vertical-align: inherit;">Moreover, everything is fine in the screenshot and in the photo. </font><font style="vertical-align: inherit;">Magic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also an indirect sign of the work of AVC are from time to time appearing green squares in the corners. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AVC and hardware coding in fresh builds should work out of the box, but group policy is never superfluous: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/hc/uo/pnhcuobl3frw-p4pfodd9xr_tsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given that AVC is hardware-encoded with a video card, updating video drivers is a good idea.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About problems</font></font></h1><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XP and Vista</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If the problem occurs on Windows XP or Vista, try updating the protocol to version 7 first (wrote at the beginning of the article). Be sure to enable CredSSP support. Microsoft has already deleted articles on the site, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">but the Internet remembers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If it doesn‚Äôt help, ‚Äúthe doctor speaks to the morgue, then to the morgue.‚Äù What the operating system has experienced over the past 15 years is better not to even think about it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLA</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sometimes it helps to disable NLA on the server. It did not work out the cause, the home cars are all different. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTLM</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Some clients attempt to log in using NTLMv1. The reasons are different, but you can fix it on the client like this:</font></font><br>
<br>
<pre><code class="powershell hljs">[<span class="hljs-type">HKEY_LOCAL_MACHINE</span>\<span class="hljs-type">SYSTEM</span>\<span class="hljs-type">CurrentControlSet</span>\<span class="hljs-type">Control</span>\<span class="hljs-type">Lsa</span>]<font></font>
<span class="hljs-string">"LmCompatibilityLevel"</span>=dword:<span class="hljs-number">00000003</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reboot is required. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are young and boldly</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afraid of nothing, then there is a more radical solution - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disabling Channel Binding</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the Remote Desktop Gateway</font></font><br>
<br>
<pre><code class="powershell hljs">HKLM\Software\Microsoft\Windows NT\CurrentVersion\TerminalServerGateway\Config\Core<font></font>
<span class="hljs-built_in">Type</span>: REG_DWORD<font></font>
Name: EnforceChannelBinding<font></font>
Value: <span class="hljs-number">0</span> (Decimal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You don‚Äôt have to do this. </font><font style="vertical-align: inherit;">But we did. </font><font style="vertical-align: inherit;">:-) For a client who insisted (no wrong, Insisted) that NTLMv1 on workstations he needed. </font><font style="vertical-align: inherit;">I don‚Äôt know, maybe there servers on NT4 without SP are still in operation. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disabling RDP 8+ in Windows 10</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If all else fails and the ideas run out, you can use the undocumented key to downgrade the RDP protocol to version 7.</font></font><br>
<br>
<pre><code class="powershell hljs">[<span class="hljs-type">HKEY_CURRENT_USER</span>\<span class="hljs-type">Software</span>\<span class="hljs-type">Microsoft</span>\<span class="hljs-type">Terminal</span> <span class="hljs-type">Server</span> <span class="hljs-type">Client</span>]<font></font>
<span class="hljs-string">"RDGClientTransport"</span>=dword:<span class="hljs-number">00000001</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I didn‚Äôt do it myself, and I don‚Äôt advise you. But to someone, they write that it helps. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DrWeb</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dr.Web SpIDerGate component may prohibit connection. In this case, an error is returned: </font></font><br>
<img src="https://habrastorage.org/webt/fs/76/zj/fs76zj-otc0v-v_qxkkwa0gviwo.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Dr.Web statistics there will be an entry: </font></font><br>
<img src="https://habrastorage.org/webt/ik/fe/qy/ikfeqyljaepzhnieksw4qsomh6y.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the comments on this article, a Dr.Web employee contacted me and our problem was resolved in the next update of the anti-virus databases. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have the same error, it is best to contact support. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a temporary solution, you can add the URL of your RDGW to the exceptions: </font></font><br>
<img src="https://habrastorage.org/webt/7c/do/k-/7cdok-2f6-4f2jj-bhlmjwqd2tq.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And only if it did not help to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disable the SpIDer Gate component completely</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System proxy I</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
met a decommissioned computer from some company where a local TMG was registered as a system proxy and the connection to RDGW did not work. This can be fixed like this:</font></font><br>
<br>
<pre><code class="powershell hljs">netsh winhttp show proxy &amp;&amp; netsh winhttp reset proxy</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Switching keyboard layouts</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sometimes extra layouts come. </font><font style="vertical-align: inherit;">You can disable the layout forwarding from the client</font></font><br>
<pre><code class="powershell hljs">[<span class="hljs-type">HKLM</span>\<span class="hljs-type">System</span>\<span class="hljs-type">CurrentControlSet</span>\<span class="hljs-type">Control</span>\<span class="hljs-type">Keyboard</span> <span class="hljs-type">Layout</span>]<font></font>
<span class="hljs-string">"IgnoreRemoteKeyboardLayout"</span>=dword:<span class="hljs-number">00000001</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPI problems</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Scaling comes from the client machine, and if it costs 125% on a home laptop, it will be the same on a working machine. </font><font style="vertical-align: inherit;">On servers, this can be turned off, but on workstations I could not find how. </font><font style="vertical-align: inherit;">But the Windows 10 app store has a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúmodern‚Äù client</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can configure DPI in it:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/dz/sm/igdzsmxjjsxc7bsmrixgkbachpm.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to monitor a gateway with RDGW</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a performance counter ‚ÄúTS Gateway \ Current Connections‚Äù, which is a bit buggy if there are no connections or the server has not rebooted for a long time. It shows exactly the number of connections, but as we remember, for HTTP + UDP there are at least two, and maybe more. Therefore, this is not a completely objective indicator of the number of employee connections. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a WMI class Win32_TSGatewayConnection. Its contents correspond to what you see in the Monitoring section of the Remote Desktop Gateway. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With it, the number of connections can be calculated more precisely:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Get-WmiObject</span> <span class="hljs-literal">-class</span> <span class="hljs-string">"Win32_TSGatewayConnection"</span> <span class="hljs-literal">-namespace</span> <span class="hljs-string">"root\cimv2\TerminalServices"</span> <font></font>
|?{<span class="hljs-variable">$_</span>.transportprotocol <span class="hljs-operator">-ne</span> <span class="hljs-number">2</span>}|<span class="hljs-built_in">select</span> username,connectedresource|<span class="hljs-built_in">sort</span> username|<span class="hljs-built_in">Get-Unique</span> <span class="hljs-literal">-AsString</span>| <span class="hljs-built_in">measure</span>|<span class="hljs-built_in">select</span> <span class="hljs-literal">-ExpandProperty</span> count<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just for fun there is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remote Display Analyzer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The free version did not show me anything useful, but suddenly it will come in handy for someone. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But what about fine tuning, tuning a few dozen session parameters? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Pareto principle is appropriate here: 20% of the efforts yield 80% of the result. </font><font style="vertical-align: inherit;">If you are ready to invest your time in the remaining 20% ‚Äã‚Äãof the result - excellent. </font><font style="vertical-align: inherit;">Just keep in mind that when you read an article about setting up a protocol in Windows 7, you don‚Äôt know what protocol the author wrote about - 7, 8 or 8.1. </font><font style="vertical-align: inherit;">When you read about Windows 10 without specifying a release, the problems are the same. </font><font style="vertical-align: inherit;">For example, they write that in fresh builds of Windows 10, the AVC / h.264 codec has changed to RDPGFX_CODECID_AVC444 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and in Windows Server 2016, RDPGFX_CODECID_AVC444 remains.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of all these tips, we use only two settings:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 bit color, you can read about it in the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS RDP Performance / Bandwidth Usage</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disabling </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">font smoothing font smoothing: i: 0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the article above or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance Tuning Remote Desktop Session Hosts</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I doubt that they give any tangible result. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we have come to the end of the article. </font><font style="vertical-align: inherit;">I wanted to be shorter, but it turned out as always. </font><font style="vertical-align: inherit;">I am glad if these tips help someone save time or improve the configuration of their infrastructure.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501118/index.html">Hooray (Oh no) - udalenka</a></li>
<li><a href="../en501120/index.html">What is a Google Ads Data Hub</a></li>
<li><a href="../en501126/index.html">Issue # 38: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../en501128/index.html">Why VR development doesn't suit you</a></li>
<li><a href="../en501130/index.html">Halt and Catch Fire - a team that deserves an adaptation</a></li>
<li><a href="../en501134/index.html">How the GitLab QA Team Uses the GitLab Performance Tool</a></li>
<li><a href="../en501138/index.html">10 online events that you can attend on the second of May</a></li>
<li><a href="../en501140/index.html">Increasing server data parser loyalty in iOS</a></li>
<li><a href="../en501142/index.html">Are you using a numeric keypad?</a></li>
<li><a href="../en501144/index.html">Is it possible to hack the brain with sound</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>