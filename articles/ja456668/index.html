<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✈️ 🖕🏾 💏 Microsoft ML Spark：SparkMLをより人道的にするSpark拡張機能とボーナスとしてLightGBM 💏 🏝️ 🤘🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spark MLを使用したことがある多くの人は、そこで行った作業の一部が「完全には成功しなかった」
 か、まったく実行されなかったことを知っています。Spark開発者の位置その中で、SparkMLは基本プラットフォームであり、すべての拡張機能は個別のパッケージでなければなりません。しかし、データサイ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Microsoft ML Spark：SparkMLをより人道的にするSpark拡張機能とボーナスとしてLightGBM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/456668/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark MLを使用したことがある多くの人は、そこで行った作業の一部が「完全には成功しなかった」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
か、まったく実行され</font><font style="vertical-align: inherit;">なかったことを知ってい</font><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark開発者の位置</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その中で、SparkMLは基本プラットフォームであり、すべての拡張機能は個別のパッケージでなければなりません。しかし、データサイエンティストとアナリストは、必要なものがほとんどある使い慣れたツール（Jupter、Zeppelin）で作業したいので、これは必ずしも便利ではありません。 500メガバイトのJARファイルをmaven-assemblyで収集したり、依存関係を自分の手でダウンロードしてSparkの起動パラメーターに追加したりしたくありません。 JVMプロジェクトビルドシステムでのより細かい作業には、Jupyter / Zeppelinに慣れているアナリストやデータサイエンティストによる多くの追加作業が必要になる場合があります。 DevOpsとクラスター管理者に一連のパッケージを計算ノードに置くよう依頼することは明らかに悪い考えです。 SparkMLの拡張機能を独自に作成した人なら誰でも、重要なクラスとメソッド（なぜかプライベート[ml]である）に隠された困難がいくつあるか知っています。保存するパラメータの種類などの制限</font></font></p><br>
<p> ,  ,   MMLSpark,    ,         SparkML  Scala  .</p><a name="habracut"></a><br>
<h2 id="vvedenie"></h2><br>
<p>-  ,          SparkML,       Spark.    — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PravdaML</a>,      ,     ,    GitHub,   .  ,       ,  ,       Maven/sbt   API,      .</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">MMLSpark</a>.</p><br>
<p> ,  ,      .          MMLSpark,   <del> SOTA  ImageNet</del>   Machine Learning.     .</p><br>
<p><img src="https://habrastorage.org/webt/rg/bt/sf/rgbtsf7j0ovmfa5lpjkfpfapzti.jpeg"></p><br>
<p>    API  Scala (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>), Python API (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>),  ,      GitHub ,    API   R.</p><br>
<p> GitHub   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    (PySpark+Jupyter)</a>,     .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  ,    Spark,        Scala,  , Scala         Transformer  Estimator,     SparkML Pipeline,   ,    numpy/pandas   UDF (    JVM),   .</p><br>
<h2 id="kratko-ob-ustanovke">  </h2><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.        Docker- Zeppelin,       . Docker   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  MMLSpark    Maven Central,   spark-packages,      Zeppelin       :</p><br>
<pre><code class="plaintext hljs">%spark.dep<font></font>
z.addRepo("bintray.com").url("http://dl.bintray.com/spark-packages/maven/")<font></font>
z.load("Azure:mmlspark:0.17")</code></pre><br>
<p> ,      :  , ,  XGBoost4j-spark,    Spark 2.3+,     Spark 2.2.1,     Docker- Zeppelin,  -    .</p><br>
<p><strong>:</strong>    MMLSpark     ,      CNTK (,   ,     cntk)    OpenCV.          "" ,        ,    HDFS   .csv,     . ,        ,          .        .</p><br>
<h2 id="chtenie-i-razvedochnyy-analiz">   </h2><br>
<p> , Spark+Zeppelin       EDA,      .      :</p><br>
<ul>
<li>  spark.sql.types,       </li>
<li>  spark.sql.functions,        </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">com.microsoft.ml.spark.SummarizeData</a>,     pandas.DataFrame.describe</li>
</ul><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">SummarizeData</span>
<span class="hljs-keyword">import</span> org.apache.spark.sql.functions._
<span class="hljs-keyword">import</span> org.apache.spark.sql.types._</code></pre><br>
<p>  :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> titanicSchema = <span class="hljs-type">StructType</span>(
    <span class="hljs-type">StructField</span>(<span class="hljs-string">"Passanger"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Survived"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"PClass"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Name"</span>, <span class="hljs-type">StringType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Sex"</span>, <span class="hljs-type">StringType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Age"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"SibSp"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Parch"</span>, <span class="hljs-type">ShortType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Ticket"</span>, <span class="hljs-type">StringType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Fare"</span>, <span class="hljs-type">FloatType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Cabin"</span>, <span class="hljs-type">StringType</span>) <font></font>
    :: <span class="hljs-type">StructField</span>(<span class="hljs-string">"Embarked"</span>, <span class="hljs-type">StringType</span>) <font></font>
    :: <span class="hljs-type">Nil</span><font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">val</span> train = spark<font></font>
    .read<font></font>
    .schema(titanicSchema)<font></font>
    .option(<span class="hljs-string">"header"</span>, <span class="hljs-literal">true</span>)<font></font>
    .csv(<span class="hljs-string">"/mountV/titanic/train.csv"</span>)</code></pre><br>
<p>     ,    :</p><br>
<pre><code class="scala hljs">println(<span class="hljs-string">s"Train shape is: <span class="hljs-subst">${train.count}</span> x <span class="hljs-subst">${train.columns.length}</span>"</span>)<font></font>
train.limit(<span class="hljs-number">5</span>).createOrReplaceTempView(<span class="hljs-string">"trainHead"</span>)</code></pre><br>
<p><strong>:</strong>       createOrReplaceTempView,     .show(5).   show  :   "",     "",      .</p><br>
<p>   : <code>Train shape is: 891 x 12</code><br>
   sql-     5 :</p><br>
<pre><code class="sql hljs">%sql
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> trainHead</code></pre><br>
<p><img src="https://habrastorage.org/webt/qe/jc/wj/qejcwjvi65jp6xucnorcdfdmxo4.png"></p><br>
<p>    Summary   :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">new</span> <span class="hljs-type">SummarizeData</span>()<font></font>
    .setBasic(<span class="hljs-literal">true</span>)<font></font>
    .setCounts(<span class="hljs-literal">true</span>)<font></font>
    .setPercentiles(<span class="hljs-literal">false</span>)<font></font>
    .setSample(<span class="hljs-literal">true</span>)<font></font>
    .setErrorThreshold(<span class="hljs-number">0.25</span>)<font></font>
    .transform(train)<font></font>
    .createOrReplaceTempView(<span class="hljs-string">"summary"</span>)</code></pre><br>
<p> SummarizeData      Dataset.describe,         ,       .        .<br>
<img src="https://habrastorage.org/webt/91/g4/8c/91g48c0oaqiuz8pjgklo38jaiis.png"></p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>,   ,     PravdaML  SummarizeData  .  Microsoft       <code>org.apache.spark.sql.functions</code>,       .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>VectorStatCollector</code></a>,         (      )      (, <code>VectorAssembler</code>    <code>DecimalType</code>).     ,      Spark,  SummarizeData  MMLSpark      <code>StackOverflow</code>  <code>org.apache.spark.sql.catalyst</code>,    <strong> </strong>,          (     ""  Spark 2.4      <code>Catalyst</code>).   ,   <strong> </strong>  ,   Microsoft  .  , ,   .</p></div></div><br>
<h2 id="ochistka-dannyh"> </h2><br>
<p>     —       .  -    (,      ) — 25    .    :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> trainFiltered = train.filter(!(isnan(col(<span class="hljs-string">"Survived"</span>)) || isnull(col(<span class="hljs-string">"Survived"</span>))))</code></pre><br>
<h3 id="obrabotka-strokovyh-dannyh">  </h3><br>
<p>  ,      ,    <code>Name</code>  <code>Cabin</code>.      ,    ,        .</p><br>
<p>       .<br>
  ,   :</p><br>
<ul>
<li>  ,    ,   ;</li>
<li>     SpakrML Transformer  Spark ML Estimator ,         Pipeline. </li>
</ul><br>
<p><strong>:</strong> Pipeline, -,  ,         ,   ,      "  "  -.         ,       .</p><br>
<p> SparkML  " "     — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">SQLTranformer</a>,    SQL   ,    Scala,   -              Idea.       MMLSpark,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">UDFTransformer</a>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">UDFTransformer</span></code></pre><br>
<p>     ,    ,      —    UDFTransformer.       ,       .</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> miss = <span class="hljs-string">".*miss\\..*"</span>.r
<span class="hljs-keyword">val</span> mr = <span class="hljs-string">".*mr\\..*"</span>.r
<span class="hljs-keyword">val</span> mrs = <span class="hljs-string">".*mrs\\..*"</span>.r
<span class="hljs-keyword">val</span> master = <span class="hljs-string">".*master.*"</span>.r<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convertNames</span></span>(input: <span class="hljs-type">String</span>): <span class="hljs-type">Option</span>[<span class="hljs-type">String</span>] = {
    <span class="hljs-type">Option</span>(input).map(x =&gt; {<font></font>
        x.toLowerCase <span class="hljs-keyword">match</span> {
            <span class="hljs-keyword">case</span> miss() =&gt; <span class="hljs-string">"Miss"</span>
            <span class="hljs-keyword">case</span> mr() =&gt; <span class="hljs-string">"Mr"</span>
            <span class="hljs-keyword">case</span> mrs() =&gt; <span class="hljs-string">"Mrs"</span>
            <span class="hljs-keyword">case</span> master() =&gt; <span class="hljs-string">"Master"</span>
            <span class="hljs-keyword">case</span> _ =&gt; <span class="hljs-string">"Unknown"</span><font></font>
        }<font></font>
    })<font></font>
}</code></pre><br>
<p>(  ,    Scala    , , ,    <code>null</code>,    <code>Double.NaN</code>,    <del> </del>   ,    <code>BooleanType</code>   ..)</p><br>
<p>   <code>UserDefinedFunction</code>       <code>Transformer</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> nameTransformUDF = udf(convertNames _)<font></font>
<font></font>
<span class="hljs-keyword">val</span> nameTransformer = <span class="hljs-keyword">new</span> <span class="hljs-type">UDFTransformer</span>()<font></font>
    .setUDF(nameTransformUDF)<font></font>
    .setInputCol(<span class="hljs-string">"Name"</span>)<font></font>
    .setOutputCol(<span class="hljs-string">"NameType"</span>)</code></pre><br>
<p><strong>:</strong>  Zeppelin   ,         production-, ,   UDF     ,  <code>extends Serializable</code>.  ,         ,     ,     Spark.</p><br>
<p>      <code>Cabin</code>.    :<br>
<img src="https://habrastorage.org/webt/1m/sn/n2/1msnn2zqeyerzpysj2ma3bwzuda.png"></p><br>
<p>,     ,  , ,    ..     (  ),    — ,    - , ,      ,        .   ,      <code>UDFTransformer</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getCabinsCount</span></span>(input: <span class="hljs-type">String</span>): <span class="hljs-type">Int</span> = {
    <span class="hljs-type">Option</span>(input) <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(x) =&gt; x.split(<span class="hljs-string">" "</span>).length
        <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt; <span class="hljs-number">-1</span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">val</span> numPattern = <span class="hljs-string">"([a-z])([0-9]+)"</span>.r<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getNumbersFromCabin</span></span>(input: <span class="hljs-type">String</span>): <span class="hljs-type">Int</span> = {
    <span class="hljs-type">Option</span>(input) <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(x) =&gt; {<font></font>
            x.split(<span class="hljs-string">" "</span>)(<span class="hljs-number">0</span>).toLowerCase <span class="hljs-keyword">match</span> {
                <span class="hljs-keyword">case</span> numPattern(sym, num) =&gt; <span class="hljs-type">Integer</span>.parseInt(num)
                <span class="hljs-keyword">case</span> _ =&gt; <span class="hljs-number">-1</span><font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt; <span class="hljs-number">-2</span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">val</span> cabinsCountUDF = udf(getCabinsCount _)
<span class="hljs-keyword">val</span> numbersFromCabinUDF = udf(getNumbersFromCabin _)<font></font>
<font></font>
<span class="hljs-keyword">val</span> cabinsCountTransformer = <span class="hljs-keyword">new</span> <span class="hljs-type">UDFTransformer</span>()<font></font>
    .setInputCol(<span class="hljs-string">"Cabin"</span>)<font></font>
    .setOutputCol(<span class="hljs-string">"CabinCount"</span>)<font></font>
    .setUDF(cabinsCountUDF)<font></font>
<font></font>
<span class="hljs-keyword">val</span> numbersFromCabinTransformer = <span class="hljs-keyword">new</span> <span class="hljs-type">UDFTransformer</span>()<font></font>
    .setInputCol(<span class="hljs-string">"Cabin"</span>)<font></font>
    .setOutputCol(<span class="hljs-string">"CabinNumber"</span>)<font></font>
    .setUDF(numbersFromCabinUDF)</code></pre><br>
<p>    ,    .     Zeppelin  :</p><br>
<p><img src="https://habrastorage.org/webt/h-/cj/l6/h-cjl6tzbakgmqxc1w-gt_kgwk0.png"></p><br>
<p> ,     .       ( ),         MMLSpark.     <code>Estimator</code>,    /        .</p><br>
<p> :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> org.apache.spark.sql.{<span class="hljs-type">Dataset</span>, <span class="hljs-type">DataFrame</span>}
<span class="hljs-keyword">import</span> org.apache.spark.ml.{<span class="hljs-type">Estimator</span>, <span class="hljs-type">Model</span>}
<span class="hljs-keyword">import</span> org.apache.spark.ml.param.{<span class="hljs-type">Param</span>, <span class="hljs-type">ParamMap</span>}<font></font>
<font></font>
<span class="hljs-keyword">import</span> org.apache.spark.ml.util.<span class="hljs-type">Identifiable</span>
<span class="hljs-keyword">import</span> org.apache.spark.ml.util.<span class="hljs-type">DefaultParamsWritable</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.{<span class="hljs-type">HasInputCol</span>, <span class="hljs-type">HasOutputCol</span>}
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">ConstructorWritable</span>
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">ConstructorReadable</span>
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">Wrappable</span></code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>ConstructorWritable</code></a>,     .   <code>Model</code> — "" ,    <code>fit(),</code>     ( , , 99% ),        .       ,  ,       DataScientist  ,      .</p><br>
<p>   <code>Estimator</code>.      —  <code>fit</code>,  —  :</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupImputerEstimator</span>(<span class="hljs-params">override val uid: <span class="hljs-type">String</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Estimator</span>[<span class="hljs-type">GroupImputerModel</span>]</span>
<span class="hljs-keyword">with</span> <span class="hljs-type">HasInputCol</span> <span class="hljs-keyword">with</span> <span class="hljs-type">HasOutputCol</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Wrappable</span> <span class="hljs-keyword">with</span> <span class="hljs-type">DefaultParamsWritable</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">this</span></span>() = <span class="hljs-keyword">this</span>(<span class="hljs-type">Identifiable</span>.randomUID(<span class="hljs-string">"GroupImputer"</span>))<font></font>
<font></font>
    <span class="hljs-keyword">val</span> groupCol: <span class="hljs-type">Param</span>[<span class="hljs-type">String</span>] = <span class="hljs-keyword">new</span> <span class="hljs-type">Param</span>[<span class="hljs-type">String</span>](
        <span class="hljs-keyword">this</span>, <span class="hljs-string">"groupCol"</span>, <span class="hljs-string">"Groupping column"</span><font></font>
    )<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setGroupCol</span></span>(v: <span class="hljs-type">String</span>): <span class="hljs-keyword">this</span>.<span class="hljs-keyword">type</span> = <span class="hljs-keyword">super</span>.set(groupCol, v)
    <span class="hljs-keyword">def</span> getGroupCol: String = $(groupCol)<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">def</span> fit(dataset: Dataset[_]): GroupImputerModel = {
        <span class="hljs-keyword">val</span> meanDF = dataset<font></font>
            .toDF<font></font>
            .groupBy($(groupCol))<font></font>
            .agg(mean(col($(inputCol))).alias("groupMean"))<font></font>
            .select(col($(groupCol)), col("groupMean"))<font></font>
<font></font>
        <span class="hljs-keyword">new</span> GroupImputerModel(<font></font>
            uid, meanDF, getInputCol, getOutputCol, getGroupCol<font></font>
        )<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">def</span> transformSchema(schema: StructType): StructType =<font></font>
    schema<font></font>
        .add(<font></font>
            StructField(<font></font>
                $(outputCol),<font></font>
                schema.filter(x =&gt; x.name == $(inputCol))(<span class="hljs-number">0</span>).dataType<font></font>
            )<font></font>
        )<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy</span></span>(extra: <span class="hljs-type">ParamMap</span>): <span class="hljs-type">Estimator</span>[<span class="hljs-type">GroupImputerModel</span>] = {
        <span class="hljs-keyword">val</span> to = <span class="hljs-keyword">new</span> <span class="hljs-type">GroupImputerEstimator</span>(<span class="hljs-keyword">this</span>.uid)<font></font>
        copyValues(to, extra).asInstanceOf[<span class="hljs-type">GroupImputerEstimator</span>]<font></font>
    }<font></font>
}</code></pre><br>
<p><strong>:</strong>    defaultCopy,      -   ,      .\&lt;init&gt;(java.lang.String), , ,     .      <code>copy</code> .</p><br>
<p>   <code>Model</code> — ,        <code>transform</code>.        <code>org.apache.spark.sql.functions</code>  <code>coalesce</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GroupImputerModel</span>(<span class="hljs-params">
    val uid: <span class="hljs-type">String</span>,
    val meanDF: <span class="hljs-type">DataFrame</span>,
    val inputCol: <span class="hljs-type">String</span>,
    val outputCol: <span class="hljs-type">String</span>,
    val groupCol: <span class="hljs-type">String</span>
</span>)</span>
<span class="hljs-keyword">extends</span> <span class="hljs-type">Model</span>[<span class="hljs-type">GroupImputerModel</span>]
<span class="hljs-keyword">with</span> <span class="hljs-type">ConstructorWritable</span>[<span class="hljs-type">GroupImputerModel</span>]<font></font>
{<font></font>
    <span class="hljs-keyword">val</span> ttag: <span class="hljs-type">TypeTag</span>[<span class="hljs-type">GroupImputerModel</span>] = typeTag[<span class="hljs-type">GroupImputerModel</span>]
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">objectsToSave</span></span>: <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>] = <span class="hljs-type">List</span>(uid, meanDF, inputCol, outputCol, groupCol)<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">copy</span></span>(extra: <span class="hljs-type">ParamMap</span>): <span class="hljs-type">GroupImputerModel</span> = 
        <span class="hljs-keyword">new</span> <span class="hljs-type">GroupImputerModel</span>(uid, meanDF, inputCol, outputCol, groupCol)<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transform</span></span>(dataset: <span class="hljs-type">Dataset</span>[_]): <span class="hljs-type">DataFrame</span> = {<font></font>
        dataset<font></font>
            .toDF<font></font>
            .join(meanDF, <span class="hljs-type">Seq</span>(groupCol), <span class="hljs-string">"left"</span>)<font></font>
            .withColumn(<font></font>
                outputCol,<font></font>
                coalesce(col(inputCol), col(<span class="hljs-string">"groupMean"</span>))<font></font>
                    .cast(<span class="hljs-type">IntegerType</span>))<font></font>
            .drop(<span class="hljs-string">"groupMean"</span>)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transformSchema</span> </span>(schema: <span class="hljs-type">StructType</span>): <span class="hljs-type">StructType</span> = schema<font></font>
        .add(<font></font>
            <span class="hljs-type">StructField</span>(outputCol, schema.filter(x =&gt; x.name == inputCol)(<span class="hljs-number">0</span>).dataType)<font></font>
        )<font></font>
}</code></pre><br>
<p> ,    ,  <code>Reader</code>,       MMLSpark <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ConstructorReadable</a>:</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">GroupImputerModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConstructorReadable</span>[<span class="hljs-type">GroupImputerModel</span>]</span></code></pre><br>
<h2 id="sozdanie-pipeline"> Pipeline</h2><br>
<p> Pipeline        SparkML,       MMLSpark — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">MultiColumnAdapter</a>,    SparkML-     ( , , StringIndexer  OneHotEncoder      ,      ):</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> org.apache.spark.ml.feature.{<span class="hljs-type">StringIndexer</span>, <span class="hljs-type">VectorAssembler</span>}
<span class="hljs-keyword">import</span> org.apache.spark.ml.<span class="hljs-type">Pipeline</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.{<span class="hljs-type">MultiColumnAdapter</span>, <span class="hljs-type">LightGBMClassifier</span>}</code></pre><br>
<p>        :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> catCols = <span class="hljs-type">Array</span>(<span class="hljs-string">"Sex"</span>, <span class="hljs-string">"Embarked"</span>, <span class="hljs-string">"NameType"</span>)
<span class="hljs-keyword">val</span> numCols = <span class="hljs-type">Array</span>(<span class="hljs-string">"PClass"</span>, <span class="hljs-string">"AgeNoMissings"</span>, <span class="hljs-string">"SibSp"</span>, <span class="hljs-string">"Parch"</span>, <span class="hljs-string">"CabinCount"</span>, <span class="hljs-string">"CabinNumber"</span>)</code></pre><br>
<p>   :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> stringEncoder = <span class="hljs-keyword">new</span> <span class="hljs-type">MultiColumnAdapter</span>()<font></font>
    .setBaseStage(<span class="hljs-keyword">new</span> <span class="hljs-type">StringIndexer</span>().setHandleInvalid(<span class="hljs-string">"keep"</span>))<font></font>
    .setInputCols(catCols)<font></font>
    .setOutputCols(catCols.map(x =&gt; x + <span class="hljs-string">"_freqEncoded"</span>))</code></pre><br>
<p><strong>:</strong>    scikit-learn  SparkML <code>StringIndexer</code>    frequency-encoder,         (..  0 &lt;  1,     ) —        .</p><br>
<p>  <code>Imputer</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> missingImputer = <span class="hljs-keyword">new</span> <span class="hljs-type">GroupImputerEstimator</span>()<font></font>
    .setInputCol(<span class="hljs-string">"Age"</span>)<font></font>
    .setOutputCol(<span class="hljs-string">"AgeNoMissings"</span>)<font></font>
    .setGroupCol(<span class="hljs-string">"Sex"</span>)</code></pre><br>
<p> <code>VectorAssembler</code>,    SparkML    <code>VectorType</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> assembler = <span class="hljs-keyword">new</span> <span class="hljs-type">VectorAssembler</span>()<font></font>
    .setInputCols(stringEncoder.getOutputCols ++ numCols)<font></font>
    .setOutputCol(<span class="hljs-string">"features"</span>)</code></pre><br>
<p>    MMLSpark   — LightGBM,    " "       XGBoost  CatBoost.      ,   ,   GBM,    SparkML (   ,  JVM-     ):</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> catColIndices = <span class="hljs-type">Array</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<font></font>
<font></font>
<span class="hljs-keyword">val</span> lgbClf = <span class="hljs-keyword">new</span> <span class="hljs-type">LightGBMClassifier</span>()<font></font>
    .setFeaturesCol(<span class="hljs-string">"features"</span>)<font></font>
    .setLabelCol(<span class="hljs-string">"Survived"</span>)<font></font>
    .setProbabilityCol(<span class="hljs-string">"predictedProb"</span>)<font></font>
    .setPredictionCol(<span class="hljs-string">"predictedLabel"</span>)<font></font>
    .setRawPredictionCol(<span class="hljs-string">"rawPrediction"</span>)<font></font>
    .setIsUnbalance(<span class="hljs-literal">true</span>)<font></font>
    .setCategoricalSlotIndexes(catColIndices)<font></font>
    .setObjective(<span class="hljs-string">"binary"</span>)</code></pre><br>
<p><strong>:</strong> LightGBM      (  catboost),     ,      ,     ,        .</p><br>
<div class="spoiler"><b class="spoiler_title">   LightGBM  Spark</b><div class="spoiler_text"><ul>
<li>    RadHat LightGBM  ,  - ,   - ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>  <code>glibc</code>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,  MMLSpark       Maven    LightGBM,    RadHat       .</li>
<li>LightGBM           ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>new java.net.ServerSocket(0)</code></a>,         .        ,  firewall-,  <del>  </del>    ,  LightGBM   (   ),   .      <code>ConnectionTimeOut</code>,    , ,  ,     GC  - .  ,    .</li>
</ul></div></div><br>
<p>     Pipeline:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> pipeline = <span class="hljs-keyword">new</span> <span class="hljs-type">Pipeline</span>()<font></font>
    .setStages(<font></font>
        <span class="hljs-type">Array</span>(<font></font>
            missingImputer,<font></font>
            nameTransformer,<font></font>
            cabinsCountTransformer,<font></font>
            numbersFromCabinTransformer,<font></font>
            stringEncoder,<font></font>
            assembler,<font></font>
            lgbClf<font></font>
        )<font></font>
    )</code></pre><br>
<h2 id="obuchenie"></h2><br>
<p>           Pipeline.       ,          ,     train  test  ,       ""  :</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">val</span> <span class="hljs-type">Array</span>(trainDF, testDF) = trainFiltered.randomSplit(<span class="hljs-type">Array</span>(<span class="hljs-number">0.8</span>, <span class="hljs-number">0.2</span>))<font></font>
<font></font>
println(<span class="hljs-string">s"Train rows: <span class="hljs-subst">${trainDF.count}</span>\nTest rows: <span class="hljs-subst">${testDF.count}</span>"</span>)
<span class="hljs-comment">// Train rows: 708</span>
<span class="hljs-comment">// Test rows: 158</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> predictions = pipeline<font></font>
    .fit(trainDF)<font></font>
    .transform(testDF)</code></pre><br>
<p>         MMLSpark — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ComputeModelStatistics</a>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> com.microsoft.ml.spark.<span class="hljs-type">ComputeModelStatistics</span>
<span class="hljs-keyword">import</span> com.microsoft.ml.spark.metrics.<span class="hljs-type">MetricConstants</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> modelEvaluator = <span class="hljs-keyword">new</span> <span class="hljs-type">ComputeModelStatistics</span>()<font></font>
    .setLabelCol(<span class="hljs-string">"Survived"</span>)<font></font>
    .setScoresCol(<span class="hljs-string">"predictedProb"</span>)<font></font>
    .setScoredLabelsCol(<span class="hljs-string">"predictedLabel"</span>)<font></font>
    .setEvaluationMetric(<span class="hljs-type">MetricConstants</span>.<span class="hljs-type">ClassificationMetrics</span>)</code></pre><br>
<p><img src="https://habrastorage.org/webt/we/rc/ba/wercbac58qpt0hsygugtqqkhc3u.png"></p><br>
<p>,   ,        .</p><br>
<h2 id="podbor-giperparametrov"> </h2><br>
<p>    MMLSpark     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>TuneHyperparameters</code></a>,       . ,  ,     <code>Pipeline</code>,    SparkML <code>CrossValidator</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">import</span> org.apache.spark.ml.tuning.{<span class="hljs-type">ParamGridBuilder</span>, <span class="hljs-type">CrossValidator</span>}
<span class="hljs-keyword">import</span> org.apache.spark.ml.evaluation.<span class="hljs-type">BinaryClassificationEvaluator</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> paramSpace = <span class="hljs-keyword">new</span> <span class="hljs-type">ParamGridBuilder</span>()<font></font>
    .addGrid(lgbClf.maxDepth, <span class="hljs-type">Array</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>))<font></font>
    .addGrid(lgbClf.learningRate, <span class="hljs-type">Array</span>(<span class="hljs-number">0.05</span>, <span class="hljs-number">0.1</span>))<font></font>
    .addGrid(lgbClf.numIterations, <span class="hljs-type">Array</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>))<font></font>
    .build<font></font>
<font></font>
println(<span class="hljs-string">s"Size of ParamsGrid: <span class="hljs-subst">${paramSpace.size}</span>"</span>)
<span class="hljs-comment">// Size of ParamsGrid: 8</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> crossValidator = <span class="hljs-keyword">new</span> <span class="hljs-type">CrossValidator</span>()<font></font>
    .setEstimator(pipeline)<font></font>
    .setEstimatorParamMaps(paramSpace)<font></font>
    .setNumFolds(<span class="hljs-number">3</span>)<font></font>
    .setSeed(<span class="hljs-number">42</span>L)<font></font>
    .setEvaluator(<font></font>
        <span class="hljs-keyword">new</span> <span class="hljs-type">BinaryClassificationEvaluator</span>()<font></font>
            .setMetricName(<span class="hljs-string">"areaUnderROC"</span>)<font></font>
            .setLabelCol(<span class="hljs-string">"Survived"</span>)<font></font>
            .setRawPredictionCol(<span class="hljs-string">"rawPrediction"</span>)<font></font>
    )<font></font>
<font></font>
<span class="hljs-keyword">val</span> bestModel = crossValidator<font></font>
    .fit(trainFiltered)</code></pre><br>
<p> ,     ,       , ,    .    "" :</p><br>
<pre><code class="scala hljs">crossValidator<font></font>
    .getEstimatorParamMaps<font></font>
    .zip(bestModel.avgMetrics)<font></font>
    .foreach(x =&gt; {<font></font>
        println(<font></font>
            <span class="hljs-string">"\n"</span> + <font></font>
            x._1<font></font>
                .toSeq<font></font>
                .foldLeft(<span class="hljs-keyword">new</span> <span class="hljs-type">StringBuilder</span>())(<font></font>
                    (a, b) =&gt; a<font></font>
                        .append(<span class="hljs-string">s"\n\t<span class="hljs-subst">${b.param.name}</span> : <span class="hljs-subst">${b.value}</span>"</span>))<font></font>
                            .toString <font></font>
                            + <span class="hljs-string">s"\n\tMetric: <span class="hljs-subst">${x._2}</span>"</span><font></font>
                )<font></font>
    })</code></pre><br>
<p>     :<br>
<img src="https://habrastorage.org/webt/xl/li/o7/xllio7tbr67gq_wqolrqwzkzswu.png"></p><br>
<p>           .                ,       .</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>    MMLSpark   0.17      .     Spark,   , MMLSpark                . Microsoft     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Databricks</a>,     DeepLearning,      ,    .</p><br>
<p> ,   ,     ,        Spark    reflect    private[ml] ,         .  , - ,     ,    <del> </del>  .   - ,        (  scaladoc),       .</p><br>
<p>   ,   - (      )  -        !</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456656/index.html">SDL 2のレッスン：レッスン4-PNGのストレッチ</a></li>
<li><a href="../ja456658/index.html">成長：チームでのスキルの評価方法</a></li>
<li><a href="../ja456662/index.html">テスト駆動開発を使用して心理療法士にお金を節約する方法</a></li>
<li><a href="../ja456664/index.html">ロボットがあなたのお金を失ったときに誰を訴えるか</a></li>
<li><a href="../ja456666/index.html">WebTotemまたはインターネットをより安全にしたい方法</a></li>
<li><a href="../ja456670/index.html">超スパイ認証方式について</a></li>
<li><a href="../ja456672/index.html">Nginxレシピ：PostgreSQLからWebSocketへの非同期通知</a></li>
<li><a href="../ja456674/index.html">あなたが知らなかったFacebookでのプロモーションの新しい機会</a></li>
<li><a href="../ja456676/index.html">分散PHPアプリケーションへのログイン</a></li>
<li><a href="../ja456678/index.html">未来の電子状態。パート4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>