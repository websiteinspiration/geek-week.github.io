<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>▪️ 🤹🏽 🙇🏿 WAL-G: Copias de seguridad y recuperación de bases de datos PostgreSQL 👩🏻‍🚒 👩🏿‍🤝‍👩🏽 👐🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace tiempo que se sabe que hacer copias de seguridad en volcados de SQL (usando pg_dump o pg_dumpall ) no es una buena idea. Para hacer una copia de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: Copias de seguridad y recuperación de bases de datos PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hace tiempo que se sabe que hacer copias de seguridad en volcados de SQL (usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) no es una buena idea. Para hacer una copia de seguridad de PostgreSQL, es mejor usar el comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que hace una copia binaria de los registros de WAL. Pero cuando comience a estudiar todo el proceso de creación de una copia de seguridad y restauración, comprenderá que necesita escribir al menos un par de triciclos para que todo esto funcione y no le cause dolor tanto desde arriba como desde abajo. Para aliviar el sufrimiento, se desarrolló WAL-G. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una herramienta escrita en Go para realizar copias de seguridad y restaurar bases de datos PostgreSQL ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y más recientemente, MySQL / MariaDB, MongoDB y FoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Es compatible con el almacenamiento de Amazon S3 (y análogos, por ejemplo, Yandex Object Storage), así como con Google Cloud Storage, Azure Storage, Swift Object Storage y solo con el sistema de archivos. </font><font style="vertical-align: inherit;">Toda la configuración se reduce a pasos simples, pero debido al hecho de que los artículos al respecto se encuentran dispersos en Internet, no existe un manual completo de instrucciones que incluya todos los pasos desde y hacia (hay varias publicaciones en Habré, pero faltan muchos puntos allí).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="copia de seguridad postgresql"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artículo está escrito principalmente para sistematizar su conocimiento. </font><font style="vertical-align: inherit;">No soy un DBA y puedo expresarlo en un lenguaje de desarrollo filisteo en alguna parte, ¡así que cualquier corrección es bienvenida! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por separado, observo que todo lo siguiente es relevante y verificado para PostgreSQL 12.3 en Ubuntu 18.04, todos los comandos deben ejecutarse como un usuario privilegiado.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalación</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el momento de escribir este artículo, la versión estable de WAL-G es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v0.2.15 (marzo de 2020)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Lo usaremos ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pero si desea ensamblarlo usted mismo desde la rama maestra, entonces el repositorio de github tiene todas las instrucciones para esto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Para descargar e instalar debes hacer:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de eso, primero debe configurar WAL-G y luego PostgreSQL.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuración WAL-G</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para un ejemplo de almacenamiento de respaldo, se utilizará Amazon S3 ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">porque está más cerca de mis servidores y su uso es muy barato</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Para trabajar con él, necesita un "cubo s3" y teclas de acceso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los artículos anteriores sobre WAL-G usaban la configuración utilizando variables de entorno, pero a partir de esta versión, la configuración puede ubicarse en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archivo .walg.json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el directorio de inicio del usuario de postgres. </font><font style="vertical-align: inherit;">Para crearlo, ejecute el siguiente script bash:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explicaré un poco en todos los aspectos:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la ruta a su bucket S3 donde se colocarán las copias de seguridad (puede </font><b><font style="vertical-align: inherit;">hacerlo</font></b><font style="vertical-align: inherit;"> tanto en la raíz como en la carpeta);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> –    S3 (<i>      –     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> –     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> –  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> –  «»     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la ruta al directorio con los datos de su base de datos ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede averiguarlo ejecutando el comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : conexión a la base de datos, con una copia de seguridad local es mejor hacerlo a través de unix-socket, como en este ejemplo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se pueden encontrar otros parámetros en la documentación: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuración de PostgreSQL</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que el archivador dentro de la base de datos cargue registros WAL en la nube y se recupere de ellos (si es necesario), debe establecer varios parámetros en el archivo de configuración </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Solo para empezar, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe asegurarse de</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que ninguna de las configuraciones a continuación se establezca en ningún otro valor, de modo que cuando reinicie la configuración, el DBMS no se caiga. </font><font style="vertical-align: inherit;">Puede agregar estos parámetros usando:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> “archive_timeout=60” &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descripción de los parámetros a configurar:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - cuánta información escribir en las revistas WAL, "réplica" - para escribir todo;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : habilite la descarga de registros WAL utilizando el comando del parámetro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : comando para archivar el registro WAL completo;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el archivado de registros se realiza solo cuando se completa, pero si su servidor cambia / agrega datos a la base de datos un poco, tiene sentido establecer un límite en segundos aquí, después de lo cual se forzará el comando de archivado ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tengo una escritura intensiva en la base de datos cada segundo, por lo tanto, Me negué a establecer este parámetro en producción</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : un comando para restaurar un registro WAL de una copia de seguridad, se usará si faltan los últimos cambios en la base de datos en la "copia de seguridad completa" (copia de seguridad base).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede leer más sobre todos estos parámetros en la traducción de la documentación oficial: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar un horario de respaldo</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos guste o no, pero cron es la forma más conveniente de comenzar. </font><font style="vertical-align: inherit;">Esto es lo que configuraremos para crear copias de seguridad. </font><font style="vertical-align: inherit;">Comencemos con el comando para crear una copia de seguridad completa: en wal-g, este es el argumento para ejecutar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pero primero, es mejor ejecutar este comando manualmente desde el usuario de postgres para asegurarse de que todo esté bien (y no haya ningún error de acceso):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los argumentos de inicio indican la ruta al directorio de datos; le recuerdo que puede reconocerlo ejecutando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todo salió bien y los datos se cargaron en el repositorio S3, puede configurar el inicio periódico en crontab:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este ejemplo, el proceso de copia de seguridad comienza todos los días a las 4:15 de la mañana.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eliminar copias de seguridad antiguas</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo más probable es que no necesite almacenar absolutamente todas las copias de seguridad de la era Mesozoica, por lo que será útil "limpiar" periódicamente su almacenamiento (tanto "copias de seguridad completas" como registros WAL). </font><font style="vertical-align: inherit;">Lo haremos todo también a través de la tarea cron:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron realizará esta tarea todos los días a las 6:30 de la mañana, eliminando todo (copias de seguridad completas, deltas y WAL) excepto las copias de los últimos 10 días, pero dejará al menos una copia de seguridad </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes de la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fecha especificada para que cualquier punto </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">posterior a la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fecha caiga en PITR .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reinstalar desde el respaldo</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No es ningún secreto que la garantía de una base saludable es la recuperación periódica y la verificación de la integridad de los datos en su interior. Cómo recuperarse usando WAL-G: lo contaré en esta sección y hablaremos de los controles más adelante. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por separado, vale la pena señalar</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que para la recuperación en un entorno de prueba (todo lo que no es producción), debe usar la cuenta de solo lectura en S3, para no sobrescribir accidentalmente las copias de seguridad. En el caso de WAL-G, debe configurar al usuario S3 los siguientes derechos en la Política de grupo ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Efecto: Permitir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Y, por supuesto, no olvide </font><font style="vertical-align: inherit;">configurar de </font><i><font style="vertical-align: inherit;">antemano </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el archivo de configuración </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que su base de prueba no quiera hacer una copia de seguridad en silencio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recuperación se realiza con un ligero movimiento de la mano con la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eliminación de todos los datos de PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (incluidos los usuarios), así que tenga mucho cuidado cuando ejecute los siguientes comandos.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que desean verificar el proceso de recuperación, a continuación se prepara una pequeña pieza de bash-magic, de modo que en caso de problemas en la recuperación, el script se bloquea con un código de salida distinto de cero. </font><font style="vertical-align: inherit;">En este ejemplo, se realizan 120 comprobaciones con un tiempo de espera de 5 segundos (solo 10 minutos para recuperarse) para averiguar si se eliminó el archivo de señal (esto significará que la recuperación fue exitosa):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de una recuperación exitosa, no olvide volver a iniciar todos los procesos (pgbouncer / monit, etc.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificación de datos después de la recuperación</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Asegúrese de verificar la integridad de la base de datos después de la recuperación, para que no haya ninguna situación con una copia de seguridad rota / torcida. </font><font style="vertical-align: inherit;">Y es mejor hacer esto con cada archivo creado, pero dónde y cómo depende de su imaginación (puede generar servidores individuales cada hora o ejecutar una prueba en CI). </font><font style="vertical-align: inherit;">Pero al menos, debe verificar los datos e índices en la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar los datos, es suficiente ejecutarlos a través del volcado, pero es mejor que al crear la base de datos tenga habilitadas las sumas de verificación ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sumas de verificación de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar índices: hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un módulo amcheck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tomaremos la consulta sql de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">las pruebas WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y construiremos una pequeña lógica en torno a:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       – )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep’ </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumiendo</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expreso mi gratitud a Andrei Borodin por su ayuda en la preparación de la publicación y gracias especialmente por su contribución al desarrollo de WAL-G. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta nota llegó a su fin. </font><font style="vertical-align: inherit;">Espero haber podido transmitir la facilidad de configuración y el enorme potencial para usar esta herramienta en su empresa. </font><font style="vertical-align: inherit;">Escuché mucho sobre WAL-G, pero no tuve tiempo suficiente para sentarme y resolverlo. </font><font style="vertical-align: inherit;">Y después de presentarlo en casa, este artículo salió de mí. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por separado, vale la pena señalar que WAL-G también puede funcionar con los siguientes DBMS:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y a juzgar por los commits, ¡se esperan algunos más!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es506594/index.html">Mejores prácticas de Redis, parte 3</a></li>
<li><a href="../es506598/index.html">Microsoft: Rust es la 'mejor oportunidad' en la industria de programación de sistemas seguros</a></li>
<li><a href="../es506600/index.html">El contrato para el desarrollo del sitio en términos de gestión de proyectos (teoría + muestra)</a></li>
<li><a href="../es506604/index.html">Concurrencia y eficiencia: Python vs FSM</a></li>
<li><a href="../es506606/index.html">Creación de clicker PIXI.js</a></li>
<li><a href="../es506612/index.html">Cómo aumentar la integridad de los cursos masivos en línea</a></li>
<li><a href="../es506620/index.html">Pensamiento creativo: qué es, cómo medir y aumentar su potencial</a></li>
<li><a href="../es506624/index.html">FOSS News No. 20 - revisión de noticias gratuitas y de código abierto del 8 al 14 de junio de 2020</a></li>
<li><a href="../es506626/index.html">Kamailio SBC o no SBC?</a></li>
<li><a href="../es506628/index.html">El resumen de materiales interesantes para el desarrollador móvil # 348 (del 8 al 14 de junio)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>