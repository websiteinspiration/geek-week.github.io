<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👨‍👦 👩🏾‍💼 🖖🏼 KVM（アンダー）VDI、bashを使用した1回限りの仮想マシン 👨🏿‍🤝‍👨🏻 ⛹🏼 🚚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事は誰のためのものですか？
 この記事は、「1回限り」のジョブのサービスを作成するタスクに直面したシステム管理者にとって興味深いかもしれません。 
 
 プロローグ
 小規模な地域ネットワークを持つ動的に発展している若い会社のITサポート部門は、外部クライアントが使用できるように「セルフサービ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>KVM（アンダー）VDI、bashを使用した1回限りの仮想マシン</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462203/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は誰のためのものですか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事は、「1回限り」のジョブのサービスを作成するタスクに直面したシステム管理者にとって興味深いかもしれません。 </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロローグ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小規模な地域ネットワークを持つ動的に発展している若い会社のITサポート部門は、外部クライアントが使用できるように「セルフサービスステーション」を編成するように依頼されました。ステーションデータは、会社の外部ポータルでの登録、外部デバイスからのデータのダウンロード、政府のポータルとの連携に使用されることになっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要な側面は、ほとんどのソフトウェアがMS Windowsで「シャープ化」されている（たとえば、「宣言」）ことであり、オープンフォーマットへの移行にもかかわらず、MS Officeは依然として電子ドキュメントの交換における主要な標準です。したがって、この問題を解決するときにMS Windowsを拒否することはできませんでした。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主な問題は、ユーザーセッションからさまざまなデータが蓄積される可能性であり、第三者への漏洩につながる可能性がありました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この状況はすでにMFCを失望させました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。しかし、準司法（州自治機関）MFCとは異なり、非州組織はそのような欠点に対してはるかに罰せられます。次の重要な問題は、外部ストレージメディアを操作する要件でした。このメディアには、必ず、悪意のあるマルウェアが多数存在します。アドレスのホワイトリストを介したインターネットへのアクセスの制限により、インターネットからマルウェアが侵入する可能性は低いと考えられました。他の部門の従業員が要件の開発に参加し、要件と要望を作成しました。最終要件は次のとおり</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></b><br>
<br>
<ul>
<li>     (     )  .</li>
<li> ,  ,     .</li>
<li>      .</li>
<li>     .</li>
<li>     5 ,    ,    .</li>
</ul><br>
<b> </b><br>
<br>
<ul>
<li>     –   4-.</li>
<li>    ,   «  »      .</li>
<li>    (, )     « ».</li>
<li> </li>
<li>   ()    .</li>
</ul><cut></cut><br>
<h4> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows livecdを十分に試してみたところ、結果として得られるソリューションは少なくとも3つの重要な点を満たさないという全員一致の結論に達しました。それらは長時間ロードされるか、完全にライブではないか、またはそれらのカスタマイズが激しい痛みに関連付けられていました。おそらく検索が不十分であり、いくつかのツールのセットに助言することができます。感謝します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、VDIに目を向け始めましたが、このタスクの場合、ほとんどのソリューションは高すぎるか、注意が必要です。そして、魔法を最小限に抑えたシンプルなツールが必要でした。その問題のほとんどは、サービスを再起動/再起動するだけで解決できました。幸いなことに、私たちは技術基盤として使用できる、廃止されたサービスからのサーバー機器、ローエンドクラスをブランチに持っていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に何が起こったのか？しかし、NDAの場合、最終的に何が起こったのかをお伝えすることはできませんが、検索の過程で、実験室テストでよく表れる興味深いスキームを開発しましたが、シリーズには入っていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの免責事項：著者は、提案されたソリューションがすべてのタスクを完全に解決し、自発的かつ歌でそれを行うと主張していません。著者は、Sein Englishe spracheがzehr schlechtであるという声明に事前に同意します。ソリューションが開発されなくなったため、バグ修正や機能の変更を当てにすることはできません。著者は、あなたが少なくともKVMに少し精通しており、Spiceプロトコルに関するレビュー記事を読んでいることを前提とし、Centosまたは別のGNU Linuxディストリビューションで少し作業しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、結果のソリューションのバックボーン、つまりクライアントとサーバーの相互作用と、問題のソリューションのフレームワーク内の仮想マシンのライフサイクルにおけるプロセスの本質を分析したいと思います。</font><font style="vertical-align: inherit;">記事が一般向けである場合は、Fedoraに基づいてシンクライアントを作成するためのライブイメージの実装の詳細を説明し、パフォーマンスとセキュリティを最適化するための仮想マシンとKVMサーバーのチューニングの詳細について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたが色紙、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペイント、ブラシ、接着剤</font><font style="vertical-align: inherit;">を取る場合</font><font style="vertical-align: inherit;">、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてもう少しスキル... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは100ルーブルを作ることができます！</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストベンチのスキームと説明</font></font></h4><br>
<img src="https://habrastorage.org/webt/pu/tu/rk/puturkaiwqcpbp4wld7ezdk_lcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての機器はブランチネットワーク内にあり、インターネットチャネルのみが送信されます。歴史的に、すでにプロキシサーバーがありましたが、それは特別なことではありません。しかし、とりわけ、仮想マシンからのトラフィックがフィルターされることになります（テキストの後半ではVMと略されます）。このサービスをKVMサーバーに配置することを妨げるものは何もありません。注意する必要があるのは、ディスクサブシステムへのサービスの負荷がどのように変化するかだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントステーション-実際には、サービスの「セルフサービスステーション」、「フロントエンド」。彼らはネットトップのLenovo IdeaCentreです。このユニットは何に適していますか？はい、ほとんどの人が、特にフロントパネルにある多数のUSBコネクタとカードリーダーに満足しています。私たちのスキームでは、ハードウェア書き込み保護付きのSDカードがカードリーダーに挿入され、そこにFedora 28の変更されたライブイメージが記録されます。もちろん、モニター、キーボード、マウスはネットトップに接続されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スイッチ-第2レベルの目立たないハードウェアスイッチ。サーバールームにあり、ライトで点滅します。 「セルフサービスステーション」以外のネットワークには接続されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KVM_Serverは回路のコアであり、ベンチテストでは、8 GBのRAMを搭載したCore 2 Quad Q9650が3台のWindows 10仮想マシンを自信を持ってプルしました。ディスクサブシステム-Adaptec 3405 2 RAID 1 + SSDドライブ。 Xeon 1220のフィールドトライアルでは、より深刻なLSI 9260 + SSDが5〜6台のVMを簡単に引き出しました。サーバーは廃止されたサービスから取得するので、資本コストはそれほどかかりません。 pool_Vm仮想マシンプールを備えたKVM仮想化システムがこのサーバーにデプロイされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VMはサービスのバックエンドである仮想マシンです。ユーザーの作品です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enp5s0は、「セルフサービスステーション」、dhcpd、ntpd、httpdのネットワークを監視し、xinetdが「シグナル」ポートをリッスンするネットワークインターフェースです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo0はループバック疑似インターフェースです。標準。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spice_console-非常に興味深いことに、従来のRDPとは異なり、KVM + Spiceプロトコルバンドルを有効にすると、追加のエンティティ（仮想マシンコンソールポート）が表示されます。</font><font style="vertical-align: inherit;">実際、このTCPポートに接続すると、ネットワークインターフェイスを介してVmに接続する必要なく、Vmコンソールが取得されます。</font><font style="vertical-align: inherit;">信号伝送のためのVmとのすべての相互作用、サーバーが引き継ぎます。</font><font style="vertical-align: inherit;">機能で最も近いものはIPKVMです。</font><font style="vertical-align: inherit;">それら。</font><font style="vertical-align: inherit;">VMモニターのイメージがこのポートに転送され、マウスの動きに関するデータがこのポートに送信されます。（最も重要なのは）Spiceプロトコルを介した対話により、USBデバイスが仮想マシンにシームレスにリダイレクトされ、まるでこのデバイスがVm自体に接続されているかのようになります。</font><font style="vertical-align: inherit;">フラッシュドライブ、スキャナー、ウェブカメラでテスト済み。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vnet0、virbr0、および仮想ネットワークカードVmは、仮想マシンのネットワークを形成します。 </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使い方</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントステーション</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
側から、クライアントステーションはFedora 28の変更されたライブイメージからグラフィカルモードでロードされ、ネットワークアドレススペース169.254.24.0/24からdhcpによってIPアドレスを受信します。</font><font style="vertical-align: inherit;">ブートプロセス中に、「シグナル」および「スパイス」サーバーポートへの接続を許可するファイアウォールルールが作成されます。</font><font style="vertical-align: inherit;">ダウンロードが完了すると、ステーションはクライアントユーザーの認証を待ちます。</font><font style="vertical-align: inherit;">ユーザーの承認後、「openbox」デスクトップマネージャーが起動し、承認されたユーザーに代わってautostart autostartスクリプトが実行されます。</font><font style="vertical-align: inherit;">とりわけ、autorunスクリプトはremote.shスクリプトを実行します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ HOME / .config / openbox /スクリプト/ remote.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
server_ip=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep <span class="hljs-string">"server_ip"</span> \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
vdi_signal_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep <span class="hljs-string">"vdi_signal_port"</span> \<font></font>
 |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
vdi_spice_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep <span class="hljs-string">"vdi_spice_port"</span> \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
animation_folder=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep <span class="hljs-string">"animation_folder"</span> \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
<font></font>
process=/usr/bin/remote-viewer<font></font>
<font></font>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">do</span>
 <span class="hljs-keyword">if</span> [ -z `/usr/bin/pidof feh` ]
 <span class="hljs-keyword">then</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$animation_folder</span>
 /usr/bin/feh -N -x -D1 <span class="hljs-variable">$animation_folder</span> &amp;
 <span class="hljs-keyword">else</span>
 /usr/bin/<span class="hljs-built_in">echo</span>
 <span class="hljs-keyword">fi</span>
/usr/bin/nc -i 1 <span class="hljs-variable">$server_ip</span> <span class="hljs-variable">$vdi_signal_port</span> |<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line
 <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">if</span> /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> |/usr/bin/grep <span class="hljs-string">"RULE ADDED, CONNECT NOW!"</span>
  <span class="hljs-keyword">then</span><font></font>
   /usr/bin/killall feh<font></font>
   pid_process=$(<span class="hljs-variable">$process</span> <span class="hljs-string">"spice://<span class="hljs-variable">$server_ip</span>:<span class="hljs-variable">$vdi_spice_port</span>"</span> \ 
   <span class="hljs-string">"--spice-disable-audio"</span> <span class="hljs-string">"--spice-disable-effects=animation"</span> \ 
   <span class="hljs-string">"--spice-preferred-compression=auto-glz"</span> <span class="hljs-string">"-k"</span> \
   <span class="hljs-string">"--kiosk-quit=on-disconnect"</span> | /bin/<span class="hljs-built_in">echo</span> $!)<font></font>
   /usr/bin/<span class="hljs-built_in">wait</span> <span class="hljs-variable">$pid_process</span>
   /usr/bin/killall -u <span class="hljs-variable">$USER</span>
   <span class="hljs-built_in">exit</span>
  <span class="hljs-keyword">else</span>
   /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> &gt;&gt; /var/<span class="hljs-built_in">log</span>/remote.log
  <span class="hljs-keyword">fi</span>
 <span class="hljs-keyword">done</span>
<span class="hljs-keyword">done</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/client.conf</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">server_ip=169.254.24.1<font></font>
vdi_signal_port=5905<font></font>
vdi_spice_port=5906<font></font>
animation_folder=/usr/share/backgrounds/animation<font></font>
background_folder=/usr/share/backgrounds2/fedora-workstation<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルclient.confの変数の説明</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
server_ip-アドレスKVM_Server </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vdi_signal_port-ポートxinetd </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vdi_spice_portが配置されているKVM_Server-接続要求がリモートビューアークライアントから選択されたVmのスパイスポートにリダイレクトされるネットワークポートKVM_Server（詳細は以下）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
animation_folder-デモ用の画像がでたらめのアニメーションから来る</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォルダーbackground_folder-スタンバイモードでのデモプレゼンテーション用に画像が来るフォルダー記事の次の部分でアニメーションについて詳しく説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
remote.shスクリプトは、構成ファイル/etc/client.confから設定を取得し、ncを使用してKVMサーバーの「vdi_signal_port」ポートに接続し、サーバーからデータストリームを受信します。その間、「RULE ADDED、CONNECT NOW」という文字列が必要です。目的の回線を受信すると、リモートビューアープロセスがキオスクモードで開始され、「vdi_spice_port」サーバーポートへの接続が確立されます。スクリプトの実行は、リモートビューアの実行が終了するまで中断されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバー側でのリダイレクトにより、「vdi_spice_port」ポートに接続しているリモートビューアは、lo0インターフェイスの「spice_console」ポートに到達します。</font><font style="vertical-align: inherit;">仮想マシンのコンソールに接続すると、ユーザーの作業が直接行われます。</font><font style="vertical-align: inherit;">接続を待機している間、ユーザーにはjpegファイルのスライドショーの形式ででたらめのアニメーションが表示されます。画像のあるディレクトリへのパスは、構成ファイルのanimation_folder変数の値によって決定されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仮想マシンの「spice_console」ポートへの接続が失われ、仮想マシンのシャットダウン/再起動（つまり、ユーザーセッションの実際の終了）が通知されると、承認済みユーザーに代わって実行されているすべてのプロセスが終了し、lightdmが再起動して承認画面に戻ります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVMサーバー側から</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークカードの「シグナル」ポートでは、enp5s0はxinetd接続を待機しています。</font><font style="vertical-align: inherit;">「シグナル」ポートに接続した後、xinetdは入力パラメーターを渡さずにvm_manager.shスクリプトを実行し、スクリプトの結果をクライアントステーションのncセッションにリダイレクトします。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/xinetd.d/test-server</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">service vdi_signal<font></font>
<font></font>
{<font></font>
port	=	5905<font></font>
socket_type	=	stream<font></font>
protocol	=	tcp<font></font>
<span class="hljs-built_in">wait</span>	=	no<font></font>
user	=	root<font></font>
server	=	/home/admin/scripts_vdi_new/vm_manager.sh<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/home/admin/scripts_vdi_new/vm_manager.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">
<span class="hljs-meta">#!/usr/bin/sh
</span>
<span class="hljs-comment">#&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;#</span><font></font>
SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_scripts_dir"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_SCRIPTS_DIR=<span class="hljs-variable">$SRV_SCRIPTS_DIR</span>"</span>
<span class="hljs-built_in">export</span> SRV_SCRIPTS_DIR=<span class="hljs-variable">$SRV_SCRIPTS_DIR</span><font></font>
SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \<font></font>
|/usr/bin/grep <span class="hljs-string">"srv_pool_size"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_POOL_SIZE=<span class="hljs-variable">$SRV_POOL_SIZE</span>"</span>
<span class="hljs-built_in">export</span> <span class="hljs-string">"SRV_POOL_SIZE=<span class="hljs-variable">$SRV_POOL_SIZE</span>"</span><font></font>
SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_start_port_pool"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> SRV_START_PORT_POOL=<span class="hljs-variable">$SRV_START_PORT_POOL</span>
<span class="hljs-built_in">export</span> SRV_START_PORT_POOL=<span class="hljs-variable">$SRV_START_PORT_POOL</span><font></font>
SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \<font></font>
|/usr/bin/grep <span class="hljs-string">"srv_tmp_dir"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_TMP_DIR=<span class="hljs-variable">$SRV_TMP_DIR</span>"</span>
<span class="hljs-built_in">export</span> SRV_TMP_DIR=<span class="hljs-variable">$SRV_TMP_DIR</span><font></font>
date=$(/usr/bin/date)<font></font>
<span class="hljs-comment">#&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;#</span><font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"# <span class="hljs-variable">$date</span> START EXECUTE VM_MANAGER.SH #"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">make_connect_to_vm</span></span>() {<font></font>
<font></font>
<span class="hljs-comment">#&lt;READING CLEAR.LIST AND CHECK PORT FOR NETWORK STATE&gt;#</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"READING CLEAN.LIST AND CHECK PORT STATE"</span>
<span class="hljs-comment">#&lt;CHECK FOR NO ONE PORT IN CLEAR.LIST&gt;#</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -z `/usr/bin/cat <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list` ]
<span class="hljs-keyword">then</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"NO AVALIBLE PORTS IN CLEAN.LIST FOUND"</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"Will try to make housekeeper, and create new vm"</span><font></font>
 make_housekeeper<font></font>
<span class="hljs-keyword">else</span>
 <span class="hljs-comment">#&lt;MINIMUN ONE PORT IN CLEAR.LIST FOUND&gt;#</span>
  /usr/bin/cat <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list |<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line
   <span class="hljs-keyword">do</span>
    clear_vm_port=$((<span class="hljs-variable">$line</span>))<font></font>
    /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"FOUND PORT <span class="hljs-variable">$clear_vm_port</span> IN CLEAN.LIST. TRY NETSTAT"</span> \ 
    <span class="hljs-string">"CHECK FOR PORT=<span class="hljs-variable">$clear_vm_port</span>"</span><font></font>
<font></font>
    <span class="hljs-comment">#&lt;NETSTAT LISTEN CHECK FOR PORT FROM CLEAN.LIST&gt;#</span>
    <span class="hljs-keyword">if</span> /usr/bin/netstat -lnt |/usr/bin/grep <span class="hljs-string">":<span class="hljs-variable">$clear_vm_port</span>"</span> &gt; /dev/null
     <span class="hljs-keyword">then</span>
     /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$clear_vm_port</span> IS LISTEN"</span>
     <span class="hljs-comment">#&lt;PORT IS LISTEN. CHECK FOR IS CONNECTED NOW&gt;#</span>
     <span class="hljs-keyword">if</span> /usr/bin/netstat -nt |/usr/bin/grep <span class="hljs-string">":<span class="hljs-variable">$clear_vm_port</span>"</span> \ <font></font>
     |/usr/bin/grep <span class="hljs-string">"ESTABLISHED"</span> &gt; /dev/null
       <span class="hljs-keyword">then</span>
<span class="hljs-comment">#&lt;PORT LISTEN AND ALREADY CONNECTED! MOVE PORT FROM CLEAR.LIST </span>
<span class="hljs-comment"># TO WASTE.LIST&gt;#</span>
       /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$clear_vm_port</span> IS ALREADY CONNECTED, MOVE PORT TO WASTE.LIST"</span>
       /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$clear_vm_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list<font></font>
       /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$clear_vm_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list
       <span class="hljs-keyword">else</span>
<span class="hljs-comment">#&lt;PORT LISTEN AND NO ONE CONNECT NOW. MOVE PORT FROM CLEAR.LIST TO </span>
<span class="hljs-comment"># CONN_WAIT.LIST AND CREATE IPTABLES RULES&gt;##</span>
       /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"OK, <span class="hljs-variable">$clear_vm_port</span> IS NOT ALREADY CONNECTED"</span>
       /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$clear_vm_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list<font></font>
       /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$clear_vm_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/conn_wait.list
       <span class="hljs-variable">$SRV_SCRIPTS_DIR</span>/vm_connect.sh <span class="hljs-variable">$clear_vm_port</span>
<span class="hljs-comment">#&lt;TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW WM&gt;#</span>
       /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW VM"</span><font></font>
       make_housekeeper<font></font>
       /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"# <span class="hljs-variable">$date</span> STOP EXECUTE VM_MANAGER.SH#"</span>
       <span class="hljs-built_in">exit</span>
       <span class="hljs-keyword">fi</span>
     <span class="hljs-keyword">else</span>
     <span class="hljs-comment">#&lt;PORT IS NOT A LISTEN. MOVE PORT FROM CLEAR.LIST TO WASTE.LIST&gt;#</span>
     /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">" "</span><span class="hljs-variable">$clear_vm_port</span><span class="hljs-string">" is NOT LISTEN. REMOVE PORT FROM CLEAR.LIST"</span>
     /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$clear_vm_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list<font></font>
     /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$clear_vm_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list<font></font>
    make_housekeeper<font></font>
     <span class="hljs-keyword">fi</span>
   <span class="hljs-keyword">done</span>
<span class="hljs-keyword">fi</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">make_housekeeper</span></span>() {<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"=Execute housekeeper="</span>
/usr/bin/cat <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list |<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line
 <span class="hljs-keyword">do</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
 <span class="hljs-keyword">if</span> /usr/bin/netstat -lnt |/usr/bin/grep <span class="hljs-string">":<span class="hljs-variable">$line</span>"</span> &gt; /dev/null
  <span class="hljs-keyword">then</span>
  /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"port_alive, vm is running"</span>
  <span class="hljs-keyword">if</span> /usr/bin/netstat -nt |/usr/bin/grep <span class="hljs-string">":<span class="hljs-variable">$line</span>"</span> \ <font></font>
   |/usr/bin/grep <span class="hljs-string">"ESTABLISHED"</span> &gt; /dev/null
    <span class="hljs-keyword">then</span>
    /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"port_in_use can't delete vm!!!"</span>
    <span class="hljs-keyword">else</span>
    /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"port_not in use. Deleting vm"</span>
    /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$line</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list<font></font>
    /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list
    <span class="hljs-variable">$SRV_SCRIPTS_DIR</span>/vm_delete.sh <span class="hljs-variable">$line</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"posible vm is already off. Deleting vm"</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"MOVE VM IN OFF STATE <span class="hljs-variable">$line</span> FROM WASTE.LIST TO"</span> \ 
  <span class="hljs-string">"RECYCLE.LIST AND DELETE VM"</span>
  /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$line</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list<font></font>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list
  <span class="hljs-variable">$SRV_SCRIPTS_DIR</span>/vm_delete.sh <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
 <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
create_clear_vm<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">create_clear_vm</span></span>() {<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"=Create new VM="</span>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">$SRV_POOL_SIZE</span> -gt 0 ]
<span class="hljs-keyword">do</span>
 new_vm_port=$((<span class="hljs-variable">$SRV_START_PORT_POOL</span>+<span class="hljs-variable">$SRV_POOL_SIZE</span>))<font></font>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"new_vm_port=<span class="hljs-variable">$new_vm_port</span>"</span>
 <span class="hljs-keyword">if</span> /usr/bin/grep <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span>"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list &gt; /dev/null
  <span class="hljs-keyword">then</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span> port is already defined in clear.list"</span>
  <span class="hljs-keyword">else</span>
  <span class="hljs-keyword">if</span> /usr/bin/grep <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span>"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list &gt; /dev/null
   <span class="hljs-keyword">then</span>
   /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span> port is already defined in waste.list"</span>
   <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">if</span> /usr/bin/grep <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span>"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list &gt; /dev/null
    <span class="hljs-keyword">then</span>
    /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span> PORT IS ALREADY DEFINED IN RECYCLE LIST"</span>
    <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">if</span>  /usr/bin/grep <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span>"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/conn_wait.list &gt; /dev/null
     <span class="hljs-keyword">then</span>
     /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$new_vm_port</span> PORT IS ALREADY DEFINED IN CONN_WAIT LIST"</span>
     <span class="hljs-keyword">else</span>
     /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"PORT IN NOT DEFINED IN NO ONE LIST WILL CREATE"</span> \
     <span class="hljs-string">"VM ON PORT <span class="hljs-variable">$new_vm_port</span>"</span>
     /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_vm_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list
     <span class="hljs-variable">$SRV_SCRIPTS_DIR</span>/vm_create.sh <span class="hljs-variable">$new_vm_port</span>
     <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
   <span class="hljs-keyword">fi</span>
 <span class="hljs-keyword">fi</span>
 SRV_POOL_SIZE=$((<span class="hljs-variable">$SRV_POOL_SIZE</span>-<span class="hljs-number">1</span>))
<span class="hljs-keyword">done</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"# <span class="hljs-variable">$date</span> STOP EXECUTE VM_MANAGER.SH #"</span><font></font>
}<font></font>
make_connect_to_vm |/usr/bin/tee -a /var/<span class="hljs-built_in">log</span>/vm_manager.log<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/vm_manager.conf</font></font></b><div class="spoiler_text">srv_scripts_dir=/home/admin/scripts_vdi_new<br>
srv_pool_size=4<br>
srv_start_port_pool=5920<br>
srv_tmp_dir=/tmp/vm_state<br>
base_host=win10_2<br>
input_iface=enp5s0<br>
vdi_spice_port=5906<br>
count_conn_tryes=10<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイルの変数の説明vm_manager.conf </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
srv_scripts_dir-スクリプトの場所のフォルダーvm_manager.sh、vm_connect.sh、vm_delete.sh、vm_create.sh、vm_clear.sh </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
srv_pool_size- </font><font style="vertical-align: inherit;">VM </font><font style="vertical-align: inherit;">のプールのサイズ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
srv_start_port_portは、ポートがコンソールを開始し、ポートは仮想マシンのポートを開始します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
srv_tmp_dir-一時ファイルのフォルダーbase_host- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vmクローンが</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
input_iface </font><font style="vertical-align: inherit;">プールに作成されるベースVm（ゴールドイメージ）</font><font style="vertical-align: inherit;">-クライアントステーションに向けられたサーバーネットワークインターフェイス</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vdi_spice_port-接続要求がリモートからリダイレクトされるサーバーネットワークポート-viewerクライアントからスパイスポート専用VM</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
count_conn_tryes-待機タイマー。その後、Vmへの接続が発生していないと見なされます（詳細については、vm_connect.shを参照）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vm_manager.shスクリプトは、vm_manager.confファイルから構成ファイルを読み取り、いくつかのパラメーターに従ってプール内の仮想マシンの状態を評価します。つまり、デプロイされているVMの数、空きクリーンVMがあるかどうかを評価します。</font><font style="vertical-align: inherit;">これを行うために、彼は「新しく作成された」仮想マシンの「spice_console」ポートの番号を含むファイルclear.listを読み取り（以下のVM作成サイクルを参照）、それらとの確立された接続を確認します。</font><font style="vertical-align: inherit;">ネットワーク接続が確立されているポートが検出された場合（絶対に検出されるべきではありません）、警告が表示され、ポートはwaste.listに転送されます。現在接続されていないclear.listファイルから最初のポートが見つかると、vm_manager.shはvm_connect.shスクリプトを呼び出してパスしますこのポートの番号をパラメータとして彼。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/home/admin/scripts_vdi_new/vm_connect.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span><font></font>
date=$(/usr/bin/date)<font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#"</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> <span class="hljs-string">"START EXECUTE VM_CONNECT.SH#"</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;#</span>
free_port=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span><font></font>
<font></font>
input_iface=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep <span class="hljs-string">"input_iface"</span> \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"input_iface=<span class="hljs-variable">$input_iface</span>"</span><font></font>
<font></font>
vdi_spice_port=$(/usr/bin/cat /etc/vm_manager.conf  \ <font></font>
|/usr/bin/grep <span class="hljs-string">"vdi_spice_port"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"vdi_spice_port=<span class="hljs-variable">$vdi_spice_port</span>"</span><font></font>
<font></font>
count_conn_tryes=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"count_conn_tryes"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"count_conn_tryes=<span class="hljs-variable">$count_conn_tryes</span>"</span>
<span class="hljs-comment">#&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;#</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"create rule for port"</span> <span class="hljs-variable">$free_port</span>
/usr/sbin/iptables -I INPUT -i <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --dport \ 
<span class="hljs-variable">$free_port</span>  -j ACCEPT<font></font>
/usr/sbin/iptables -I OUTPUT -o <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --sport \
<span class="hljs-variable">$free_port</span> -j ACCEPT<font></font>
/usr/sbin/iptables -t nat -I PREROUTING -p tcp -i <span class="hljs-variable">$input_iface</span> --dport \ 
<span class="hljs-variable">$vdi_spice_port</span> -j DNAT --to-destination 127.0.0.1:<span class="hljs-variable">$free_port</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"RULE ADDED, CONNECT NOW!"</span>
<span class="hljs-comment">#&lt;/CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;WAIT CONNECT ESTABLISHED AND ACTIVATE CONNECT TIMER&gt;#</span>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">$count_conn_tryes</span> -gt 0 ]
<span class="hljs-keyword">do</span>
<span class="hljs-keyword">if</span> /usr/bin/netstat -nt |/usr/bin/grep <span class="hljs-string">":<span class="hljs-variable">$free_port</span>"</span> \ <font></font>
|/usr/bin/grep <span class="hljs-string">"ESTABLISHED"</span> &gt; /dev/null
 <span class="hljs-keyword">then</span>
  /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$free_port</span> NOW in use!!!"</span><font></font>
  /usr/bin/sleep 1s<font></font>
  /usr/sbin/iptables -t nat -D PREROUTING -p tcp -i <span class="hljs-variable">$input_iface</span> --dport \ 
  <span class="hljs-variable">$vdi_spice_port</span> -j DNAT --to-destination 127.0.0.1:<span class="hljs-variable">$free_port</span>
  /usr/sbin/iptables -D INPUT -i <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --dport \ 
  <span class="hljs-variable">$free_port</span>  -j ACCEPT<font></font>
  /usr/sbin/iptables -D OUTPUT -o <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --sport \ 
  <span class="hljs-variable">$free_port</span> -j ACCEPT<font></font>
  /usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$free_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/conn_wait.list<font></font>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$free_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list
  <span class="hljs-built_in">return</span>
 <span class="hljs-keyword">else</span>
   /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$free_port</span> NOT IN USE"</span>
   /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"RULE ADDED, CONNECT NOW!"</span><font></font>
   /usr/bin/sleep 1s<font></font>
 <span class="hljs-keyword">fi</span>
count_conn_tryes=$((count_conn_tryes-<span class="hljs-number">1</span>))
<span class="hljs-keyword">done</span>
<span class="hljs-comment">#&lt;/WAIT CONNECT ESTABLISED AND ACTIVATE CONNECT TIMER&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;IF COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT \</span>
<span class="hljs-comment"># VM TO CLEAR.LIST&gt;#</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"REVERT IPTABLES RULE AND REVERT VM TO CLEAN \
LIST <span class="hljs-variable">$free_port</span>"</span>
/usr/sbin/iptables -t nat -D PREROUTING -p tcp -i <span class="hljs-variable">$input_iface</span> --dport \
<span class="hljs-variable">$vdi_spice_port</span> -j DNAT --to-destination 127.0.0.1:<span class="hljs-variable">$free_port</span>
/usr/sbin/iptables -D INPUT -i <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --dport <span class="hljs-variable">$free_port</span> \<font></font>
-j ACCEPT<font></font>
/usr/sbin/iptables -D OUTPUT -o <span class="hljs-variable">$input_iface</span> -p tcp -m tcp --sport \ 
<span class="hljs-variable">$free_port</span> -j ACCEPT<font></font>
/usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$free_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/conn_wait.list<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$free_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list
<span class="hljs-comment">#&lt;/COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT VM \</span>
<span class="hljs-comment">#TO CLEAR.LIST&gt;#</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#"</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> <span class="hljs-string">"END EXECUTE VM_CONNECT.SH#"</span><font></font>
<font></font>
<span class="hljs-comment"># Attention! Must Be!  sysctl net.ipv4.conf.all.route_localnet=1</span><font></font>
<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vm_connect.shスクリプトは、enp5s0インターフェースのサーバーポートのリダイレクト「vdi_spice_port」を、起動パラメーターとして渡されるlo0サーバーインターフェースにある「spice console port」VMにリダイレクトするファイアウォールルールを導入します。ポートがconn_wait.listに転送され、VMは保留中の接続と見なされます。 「RULE ADDED、CONNECT NOW」という行がサーバーの「シグナル」ポートのクライアントステーションセッションに送信されます。これは、サーバー上で実行されているremote.shスクリプトによって予期されます。接続待機サイクルは、構成ファイルの変数「count_conn_tryes」の値によって決定される試行回数から始まります。 ncセッションの毎秒、文字列「RULE ADDED、CONNECT NOW」が提供され、「spice_console」ポートへの確立された接続がチェックされます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定された試行回数で接続が失敗した場合、spice_consoleポートはclear.listに戻されます。vm_connect.shの実行が完了し、vm_manager.shの実行が再開され、クリーニングサイクルが開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントステーションがlo0インターフェイスのspice_consoleポートに接続すると、spiceサーバーポートとspice_consoleポート間のリダイレクトを作成するファイアウォールルールが削除され、ファイアウォールのステータスを判別するメカニズムによって接続がさらに維持されます。接続が切断された場合、spice_consoleポートへの再接続は失敗します。 spice_consoleポートがwaste.listに転送され、VMは「ダーティ」と見なされ、クリーニングを行わないと「クリーン」な仮想マシンのプールに戻ることができません。 vm_connect.shの実行が完了し、vm_manager.shの実行が再開され、クリーニングサイクルが開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングサイクルは、接続が確立されている仮想マシンポートのspice_console番号が転送されるwaste.listファイルを調べることから始まります。リストの各spice_consoleポートにアクティブな接続が存在するかどうかが判断されます。接続がない場合は、仮想マシンが使用されなくなったと見なされ、ポートがrecycle.listに転送され、このポートに属する仮想マシン（下記参照）を削除するプロセスが開始されます。ポートでアクティブなネットワーク接続が検出された場合、仮想マシンが使用されていると見なされ、アクションは実行されません。ポートがタップされていない場合、VMはオフになっていて、不要であると見なされます。ポートがrecycle.listに転送され、仮想マシンを削除するプロセスが開始されます。これを行うには、vm_delete.shスクリプトを呼び出します。パラメータ "spice_console"がVMポートに渡されるため、削除する必要があります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/home/admin/scripts_vdi_new/vm_delete.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-comment">#&lt;Set local VARIABLES&gt;#</span>
port_to_delete=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span><font></font>
date=$(/usr/bin/date)<font></font>
<span class="hljs-comment">#&lt;/Set local VARIABLES&gt;#</span><font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"# <span class="hljs-variable">$date</span> START EXECUTE VM_DELETE.SH#"</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"TRY DELETE VM ON PORT: <span class="hljs-variable">$vm_port</span>"</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;VM NAME SETUP&gt;#</span>
vm_name_part1=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep <span class="hljs-string">'base_host'</span> \<font></font>
|/usr/bin/cut -d<span class="hljs-string">'='</span> -f2)<font></font>
vm_name=$(/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$vm_name_part1</span>"</span><span class="hljs-string">"-"</span><span class="hljs-string">"<span class="hljs-variable">$port_to_delete</span>"</span>)
<span class="hljs-comment">#&lt;/VM NAME SETUP&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;SHUTDOWN AND DELETE VM&gt;#</span>
/usr/bin/virsh destroy <span class="hljs-variable">$vm_name</span>
/usr/bin/virsh undefine <span class="hljs-variable">$vm_name</span>
/usr/bin/rm -f /var/lib/libvirt/images_write/<span class="hljs-variable">$vm_name</span>.qcow2<font></font>
/usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$port_to_delete</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list
<span class="hljs-comment">#&lt;/SHUTDOWN AND DELETE VM&gt;#</span><font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"VM ON PORT <span class="hljs-variable">$vm_port</span> HAS BEEN DELETE AND REMOVE"</span> \
 <span class="hljs-string">"FROM RECYCLE.LIST. EXIT FROM VM_DELETE.SH"</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"# <span class="hljs-variable">$date</span> STOP EXECUTE VM_DELETE.SH#"</span>
<span class="hljs-built_in">exit</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仮想マシンの削除はかなり簡単な操作です。vm_delete.shスクリプトは、起動パラメーターとして渡されたポートを所有する仮想マシンの名前を決定します。</font><font style="vertical-align: inherit;">VMが強制的に停止され、VMがハイパーバイザーから削除され、このVMの仮想ハードディスクが削除されます。</font><font style="vertical-align: inherit;">spice_consoleポートがrecycle.listから削除されました。</font><font style="vertical-align: inherit;">vm_delete.shの実行が完了し、vm_manager.shの実行が再開されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作の最後に、スクリプトvm_manager.shが、waste.listから不要な仮想マシンをクリーンアップして、プールに仮想マシンを作成するサイクルを開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスは、ホスティングに使用できるspice_consoleポートの決定から始まります。これを行うには、仮想マシンのプール "spice_console"の開始ポートを設定する構成ファイル "srv_start_port_pool"のパラメーターと、仮想マシンの数の制限を決定するパラメーター "srv_pool_size"に基づいて、可能なすべてのポートバリアントが順次列挙されます。特定のポートごとに、clear.list、waste.list、conn_wait.list、recycle.listで検索されます。これらのファイルのいずれかにポートが見つかった場合、そのポートはビジーであると見なされ、スキップされます。指定したファイルでポートが見つからない場合は、recycle.listファイルに入力され、新しい仮想マシンの作成プロセスが開始されます。これを行うには、vm_createスクリプトを呼び出します。VMを作成するポートのspice_console番号がパラメーターとして渡されるsh。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/home/admin/scripts_vdi_new/vm_create.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#"</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> <span class="hljs-string">"START RUNNING VM_CREATE.SH#"</span><font></font>
<font></font>
new_vm_port=<span class="hljs-variable">$1</span><font></font>
date=$(/usr/bin/date)<font></font>
a=0<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> SRV_TMP_DIR=<span class="hljs-variable">$SRV_TMP_DIR</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;#</span>
base_host=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep <span class="hljs-string">"base_host"</span> \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base_host=<span class="hljs-variable">$base_host</span>"</span>
<span class="hljs-comment">#&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;#</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">hdd_image_locate</span></span>() {<font></font>
<font></font>
/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"Run STEP 1 - hdd_image_locate"</span><font></font>
<font></font>
hdd_base_image=$(/usr/bin/virsh dumpxml <span class="hljs-variable">$base_host</span> \ <font></font>
|/usr/bin/grep <span class="hljs-string">"source file"</span> |/usr/bin/grep <span class="hljs-string">"qcow2"</span> |/usr/bin/head -n 1 \<font></font>
|/usr/bin/cut -d <span class="hljs-string">"'"</span> -f2)
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$hdd_base_image</span>"</span> ]
<span class="hljs-keyword">then</span>
 /bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base hdd image not found!"</span>
<span class="hljs-keyword">else</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"hdd_base_image found is a <span class="hljs-variable">$hdd_base_image</span>. Run next step 2"</span><font></font>
<font></font>
<span class="hljs-comment">#&lt; CHECK FOR SNAPSHOT ON BASE HDD &gt;#</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> [ 0 -eq `/usr/bin/qemu-img info <span class="hljs-string">"<span class="hljs-variable">$hdd_base_image</span>"</span> | /usr/bin/grep -c <span class="hljs-string">"Snapshot"</span>` ]
  <span class="hljs-keyword">then</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base image haven't snapshot, run NEXT STEP 3"</span>
  <span class="hljs-keyword">else</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base hdd image have a snapshot, can't use this image"</span>
  <span class="hljs-built_in">exit</span>
  <span class="hljs-keyword">fi</span>
<span class="hljs-comment">#&lt;/ CHECK FOR SNAPSHOT ON BASE HDD &gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt; CHECK FOR HDD IMAGE IS LINK CLONE &gt;#</span>
  <span class="hljs-keyword">if</span> [ 0 -eq `/usr/bin/qemu-img info <span class="hljs-string">"<span class="hljs-variable">$hdd_base_image</span>"</span> |/usr/bin/grep -c <span class="hljs-string">"backing file"</span>
  <span class="hljs-keyword">then</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base image is not a linked clone, NEXT STEP 4"</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"Base image check complete!"</span>
  <span class="hljs-keyword">else</span>
  /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"base hdd image is a linked clone, can't use this image"</span>
  <span class="hljs-built_in">exit</span>
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-comment">#&lt;/ CHECK FOR HDD IMAGE IS LINK CLONE &gt;#</span><font></font>
cloning<font></font>
    }<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">cloning</span></span>() {
<span class="hljs-comment"># &lt;Step_1 turn the base VM off &gt;#</span>
 /usr/bin/virsh shutdown <span class="hljs-variable">$base_host</span> &gt; /dev/null 2&gt;&amp;1
 <span class="hljs-comment"># &lt;/Step_1 turn the base VM off &gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;Create_vm_config&gt;#</span><font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"Free port for Spice VM is <span class="hljs-variable">$new_vm_port</span>"</span><font></font>
<font></font>
 <span class="hljs-comment">#&lt;Setup_name_for_new_VM&gt;#</span>
new_vm_name=$(/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$base_host</span><span class="hljs-string">"-"</span><span class="hljs-variable">$new_vm_port</span>)
<span class="hljs-comment">#&lt;/Setup_name_for_new_VM&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;Make_base_config_as_clone_base_VM&gt;#</span>
/usr/bin/virsh dumpxml <span class="hljs-variable">$base_host</span> &gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;Make_base_config_as_clone_base_VM&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">##&lt;Setup_New_VM_Name_in_config&gt;##</span>
/usr/bin/sed -i <span class="hljs-string">"s%&lt;name&gt;<span class="hljs-variable">$base_host</span>&lt;/name&gt;%&lt;name&gt;<span class="hljs-variable">$new_vm_name</span>&lt;/name&gt;%g"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;/Setup_New_VM_Name_in_config&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;UUID Changing&gt;#</span>
old_uuid=$(/usr/bin/cat <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml |/usr/bin/grep <span class="hljs-string">"&lt;uuid&gt;"</span>)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> old UUID <span class="hljs-variable">$old_uuid</span>
new_uuid_part1=$(/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$old_uuid</span>"</span> |/usr/bin/cut -d <span class="hljs-string">"-"</span> -f 1,2)<font></font>
new_uuid_part2=$(/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$old_uuid</span>"</span> |/usr/bin/cut -d <span class="hljs-string">"-"</span> -f 4,5)<font></font>
new_uuid=$(/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_uuid_part1</span><span class="hljs-string">"-"</span><span class="hljs-variable">$new_vm_port</span><span class="hljs-string">"-"</span><span class="hljs-variable">$new_uuid_part2</span>)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_uuid</span>
/usr/bin/sed -i <span class="hljs-string">"s%<span class="hljs-variable">$old_uuid</span>%<span class="hljs-variable">$new_uuid</span>%g"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;/UUID Changing&gt;#</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">#&lt;Spice port replace&gt;#</span>
old_spice_port=$(/usr/bin/cat  <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml \ <font></font>
|/usr/bin/grep <span class="hljs-string">"graphics type='spice' port="</span>)<font></font>
/bin/<span class="hljs-built_in">echo</span> old spice port <span class="hljs-variable">$old_spice_port</span>
new_spice_port=$(/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;graphics type='spice' port='<span class="hljs-variable">$new_vm_port</span>' autoport='no' listen='127.0.0.1'&gt;"</span>)<font></font>
/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_spice_port</span>
/usr/bin/sed -i <span class="hljs-string">"s%<span class="hljs-variable">$old_spice_port</span>%<span class="hljs-variable">$new_spice_port</span>%g"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;/Spice port replace&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;MAC_ADDR_GENERATE&gt;#</span>
mac_new=$(/usr/bin/hexdump -n6 -e <span class="hljs-string">'/1 ":%02X"'</span> /dev/random|/usr/bin/sed s/^://g)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> New Mac is <span class="hljs-variable">$mac_new</span>
<span class="hljs-comment">#&lt;/MAC_ADDR_GENERATE&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;GET OLD MAC AND REPLACE&gt;#</span>
mac_old=$(/usr/bin/cat <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml |/usr/bin/grep <span class="hljs-string">"mac address="</span>)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> old mac is <span class="hljs-variable">$mac_old</span>
/usr/bin/sed -i <span class="hljs-string">"s%<span class="hljs-variable">$mac_old</span>%<span class="hljs-variable">$mac_new</span>%g"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;GET OLD MAC AND REPLACE&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;new_disk_create&gt;#</span>
/usr/bin/qemu-img create -f qcow2 -b <span class="hljs-variable">$hdd_base_image</span> /var/lib/libvirt/images_write/<span class="hljs-variable">$new_vm_name</span>.qcow2
<span class="hljs-comment">#&lt;/new_disk_create&gt;#</span><font></font>
<font></font>
<span class="hljs-comment">#&lt;attach_new_disk_in_confiig&gt;#</span>
/usr/bin/<span class="hljs-built_in">echo</span> hdd base image is <span class="hljs-variable">$hdd_base_image</span>
/usr/bin/sed -i <span class="hljs-string">"s%&lt;source file='<span class="hljs-variable">$hdd_base_image</span>'/&gt;%&lt;source file='/var/lib/libvirt/images_write/<span class="hljs-variable">$new_vm_name</span>.qcow2'/&gt;%g"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml
<span class="hljs-comment">#&lt;/attach_new_disk_in_confiig&gt;#</span><font></font>
<font></font>
starting_vm<font></font>
    <span class="hljs-comment">#&lt;/Create_vm config&gt;#</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-title">starting_vm</span></span>() {<font></font>
<font></font>
/usr/bin/virsh define <span class="hljs-variable">$SRV_TMP_DIR</span>/<span class="hljs-variable">$new_vm_name</span>.xml<font></font>
/usr/bin/virsh start <span class="hljs-variable">$new_vm_name</span>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">$a</span> -ne 1 ]
<span class="hljs-keyword">do</span>
<span class="hljs-keyword">if</span> /usr/bin/virsh list --all |/usr/bin/grep <span class="hljs-string">"<span class="hljs-variable">$new_vm_name</span>"</span> |/usr/bin/grep <span class="hljs-string">"running"</span> &gt; /dev/null 2&gt;&amp;1
<span class="hljs-keyword">then</span><font></font>
a=1<font></font>
/usr/bin/sed -i <span class="hljs-string">"/<span class="hljs-variable">$new_vm_port</span>/d"</span> <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_vm_port</span> &gt;&gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#"</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> <span class="hljs-string">"VM <span class="hljs-variable">$new_vm_name</span> IS STARTED #"</span>
<span class="hljs-keyword">else</span>
 /usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#VM <span class="hljs-variable">$new_vm_name</span> is not ready#"</span><font></font>
a=0<font></font>
/usr/bin/sleep 2s<font></font>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"#<span class="hljs-variable">$date</span>  EXIT FROM VM_CREATE.SH#"</span>
<span class="hljs-built_in">exit</span><font></font>
}<font></font>
<font></font>
hdd_image_locate<font></font>
<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい仮想マシンを作成するプロセス</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトvm_create.shは、構成ファイルから、クローン作成の基準となるサンプル仮想マシンを定義する変数「base_host」の値を読み取ります。</font><font style="vertical-align: inherit;">ハイパーバイザーのベースからVMのxml構成をアンロードし、VMディスクイメージの一連のチェックqcowを実行し、正常に完了すると、新しいVMのxml構成ファイルと新しいVMの「リンククローン」ディスクイメージを作成します。</font><font style="vertical-align: inherit;">その後、新しいVMのxml構成がハイパーバイザーデータベースにロードされ、VMが起動します。</font><font style="vertical-align: inherit;">spice_consoleポートがrecycle.listからclear.listに転送されます。</font><font style="vertical-align: inherit;">vm_create.shの実行が終了し、vm_manager.shの実行が終了します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次回接続するときは最初から始まります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
緊急の場合のために、キットにはプールからすべてのVMを強制的に実行し、リストの値をゼロにしてそれらを削除するスクリプトvm_clear.shが含まれています。</font><font style="vertical-align: inherit;">ロード段階でそれを呼び出すと、VDI（の下）を最初から開始できます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/home/admin/scripts_vdi_new/vm_clear.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/usr/bin/sh
</span>
<span class="hljs-comment">#set VARIABLES#</span><font></font>
SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_scripts_dir"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_SCRIPTS_DIR=<span class="hljs-variable">$SRV_SCRIPTS_DIR</span>"</span>
<span class="hljs-built_in">export</span> SRV_SCRIPTS_DIR=<span class="hljs-variable">$SRV_SCRIPTS_DIR</span><font></font>
<font></font>
SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_tmp_dir"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_TMP_DIR=<span class="hljs-variable">$SRV_TMP_DIR</span>"</span>
<span class="hljs-built_in">export</span> SRV_TMP_DIR=<span class="hljs-variable">$SRV_TMP_DIR</span><font></font>
<font></font>
SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_pool_size"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"SRV_POOL_SIZE=<span class="hljs-variable">$SRV_POOL_SIZE</span>"</span><font></font>
<font></font>
SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ <font></font>
|/usr/bin/grep <span class="hljs-string">"srv_start_port_pool"</span> |/usr/bin/cut -d <span class="hljs-string">"="</span> -f2)<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> SRV_START_PORT_POOL=<span class="hljs-variable">$SRV_START_PORT_POOL</span>
<span class="hljs-comment">#Set VARIABLES#</span><font></font>
<font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"= Cleanup ALL VM="</span><font></font>
<font></font>
/usr/bin/mkdir <span class="hljs-variable">$SRV_TMP_DIR</span><font></font>
<font></font>
/usr/sbin/service iptables restart<font></font>
/usr/bin/cat /dev/null &gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/clear.list<font></font>
/usr/bin/cat /dev/null &gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/waste.list<font></font>
/usr/bin/cat /dev/null &gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/recycle.list<font></font>
/usr/bin/cat /dev/null &gt; <span class="hljs-variable">$SRV_TMP_DIR</span>/conn_wait.list<font></font>
<font></font>
port_to_delete=$((<span class="hljs-variable">$SRV_START_PORT_POOL</span>+<span class="hljs-variable">$SRV_POOL_SIZE</span>))<font></font>
<font></font>
        <span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$port_to_delete</span>"</span> -gt <span class="hljs-string">"<span class="hljs-variable">$SRV_START_PORT_POOL</span>"</span> ]
          <span class="hljs-keyword">do</span>
		<span class="hljs-variable">$SRV_SCRIPTS_DIR</span>/vm_delete.sh <span class="hljs-variable">$port_to_delete</span>
		port_to_delete=$((<span class="hljs-variable">$port_to_delete</span>-<span class="hljs-number">1</span>))
        <span class="hljs-keyword">done</span><font></font>
<font></font>
/usr/bin/<span class="hljs-built_in">echo</span> <span class="hljs-string">"= EXIT FROM VM_CLEAR.SH="</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで私の話の最初の部分を終えたいと思います。</font><font style="vertical-align: inherit;">システム管理者がビジネスでunderVDIを試すには、上記で十分です。</font><font style="vertical-align: inherit;">コミュニティがこのトピックに興味を持ったら、2番目の部分でlivecd Fedoraの変更とそのキオスクへの変換について話します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462181/index.html">グループチャットでの効果的なコミュニケーションのルール</a></li>
<li><a href="../ja462185/index.html">革命は終わりました。リチウムイオン電池の代替品はありますか？</a></li>
<li><a href="../ja462189/index.html">travajsによるデータのエッチング</a></li>
<li><a href="../ja462191/index.html">DataArt Museum：北イタリアのツアー</a></li>
<li><a href="../ja462197/index.html">心を解放し、創造性を高める方法に関するヒント</a></li>
<li><a href="../ja462209/index.html">ポリコムのビデオ会議ソリューション。6年後の思い出...ステージ2。パート1。RMX1500</a></li>
<li><a href="../ja462213/index.html">学び、働きます：情報技術およびプログラミング学部の学部生の経験</a></li>
<li><a href="../ja462221/index.html">Google Playでの失望感</a></li>
<li><a href="../ja462227/index.html">8月9日、モスクワ-バックエンドストーリー4.0</a></li>
<li><a href="../ja462245/index.html">Linuxカーネルの例としての自動git bisect</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>