<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😺 👨‍🎤 🧓🏽 Comment nous avons accéléré l'encodage vidéo huit fois 🗺️ 🌓 🦅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque jour, des millions de téléspectateurs regardent des vidéos sur Internet. Mais pour que la vidéo soit disponible, elle doit non seulement être t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons accéléré l'encodage vidéo huit fois</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494154/"><img src="https://habrastorage.org/webt/mu/t5/ov/mut5ovwkds2o3dn2vnxmxvnelwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque jour, des millions de téléspectateurs regardent des vidéos sur Internet. Mais pour que la vidéo soit disponible, elle doit non seulement être téléchargée sur le serveur, mais également traitée. Plus cela se produit rapidement, meilleurs sont le service et ses utilisateurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je m'appelle Askar Kamalov, il y a un an, j'ai rejoint l'équipe de technologie vidéo Yandex. Aujourd'hui, je vais expliquer brièvement aux lecteurs de Habr comment, en utilisant la parallélisation du processus de codage, nous avons réussi à accélérer la livraison de vidéos à l'utilisateur à plusieurs reprises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce message intéressera principalement ceux qui n'ont pas pensé à ce qui se passe sous le capot des services vidéo. Dans les commentaires, vous pouvez poser des questions et suggérer des sujets pour de futurs articles.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques mots sur la tâche elle-même. </font><font style="vertical-align: inherit;">Yandex aide non seulement à rechercher des vidéos sur d'autres sites, mais stocke également des vidéos pour ses propres services. </font><font style="vertical-align: inherit;">Qu'il s'agisse d'un programme d'auteur ou d'un match de sport dans Ether, d'un film sur KinoPoisk ou de vidéos dans Zen et News - tout cela est téléchargé sur nos serveurs. </font><font style="vertical-align: inherit;">Pour que les utilisateurs regardent une vidéo, elle doit être préparée: la convertir au format requis, créer un aperçu ou même la piloter via la technologie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeepHD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Un fichier non préparé prend juste de la place. </font><font style="vertical-align: inherit;">Et nous parlons non seulement de l'utilisation optimale du fer, mais aussi de la vitesse de livraison du contenu aux utilisateurs. </font><font style="vertical-align: inherit;">Exemple: un record avec le moment décisif d'un match de hockey peut être recherché dans la recherche dans la minute qui suit l'événement lui-même.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codage séquentiel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le bonheur de l'utilisateur dépend en grande partie de la rapidité avec laquelle la vidéo devient disponible. </font><font style="vertical-align: inherit;">Et cela est principalement déterminé par la vitesse de transcodage. </font><font style="vertical-align: inherit;">Lorsqu'il n'y a pas d'exigences strictes pour la vitesse de téléchargement vidéo, il n'y a pas de problème. </font><font style="vertical-align: inherit;">Prenez un fichier unique et indivisible, convertissez-le, téléchargez. </font><font style="vertical-align: inherit;">Au début de notre voyage, nous avons travaillé comme ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lh/rv/ix/lhrvixp8ipl0f8yfbtxrm9uh174.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client télécharge la vidéo dans le référentiel, le composant Analyzer collecte des méta-informations et transfère la vidéo pour la conversion vers le composant Worker. </font><font style="vertical-align: inherit;">Toutes les étapes sont exécutées séquentiellement. </font><font style="vertical-align: inherit;">Dans le même temps, il peut y avoir de nombreux serveurs pour l'encodage, mais un seul est occupé à traiter une vidéo spécifique. </font><font style="vertical-align: inherit;">Disposition simple et transparente. </font><font style="vertical-align: inherit;">C'est là que ses mérites s'arrêtent. </font><font style="vertical-align: inherit;">Un tel schéma évolue uniquement verticalement (en raison de l'achat de serveurs plus puissants).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codage séquentiel avec résultat intermédiaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin d'atténuer en quelque sorte les attentes douloureuses, l'industrie a proposé une option de codage rapide. C'est un nom trompeur, car en fait, le codage à part entière a lieu séquentiellement et aussi longtemps. Mais avec un résultat intermédiaire. L'idée est la suivante: préparer et télécharger la version basse résolution de la vidéo dès que possible, et seulement plus tard - des versions haute résolution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'une part, la vidéo devient plus rapide. Et il est utile pour les événements importants. Mais de l'autre - l'image est floue, et cela agace le public.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'avère que vous devez non seulement traiter rapidement la vidéo, mais également préserver sa qualité. </font><font style="vertical-align: inherit;">C'est ce que les utilisateurs attendent désormais d'un service vidéo. </font><font style="vertical-align: inherit;">Il peut sembler suffisant d'acheter les serveurs les plus productifs (et de les mettre à niveau régulièrement tous en même temps). </font><font style="vertical-align: inherit;">Mais c'est une voie vers une impasse, car il y a toujours une vidéo qui ralentira même le matériel le plus puissant.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codage parallèle</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est beaucoup plus efficace de diviser une tâche difficile en plusieurs tâches moins complexes et de les résoudre simultanément sur différents serveurs. Tel est MapReduce pour la vidéo. Dans ce cas, nous ne nous reposons pas sur les performances d'un seul serveur et pouvons évoluer horizontalement (en ajoutant de nouvelles machines). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, l'idée de diviser une vidéo en petits morceaux, de les traiter et de les coller simultanément n'est pas un secret. Vous pouvez trouver de nombreuses références à cette approche (par exemple, sur Habré je recommande un article sur le projet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DistVIDc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Mais cela ne facilite généralement pas la tâche, car vous ne pouvez pas simplement prendre une solution toute faite et l'intégrer à vous-même. Nous devons nous adapter à notre infrastructure, à notre vidéo et même à notre charge de travail. En général, il est plus facile d'écrire le vôtre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, dans la nouvelle architecture, nous avons divisé le bloc Worker monolithique avec codage séquentiel en microservices Segmenter, Tcoder, Combiner.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/xo/db/zqxodbzp7qwxo22evvnn1ftyk8o.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segmenter divise la vidéo en fragments en environ 10 secondes. </font><font style="vertical-align: inherit;">Les fragments sont constitués d'un ou plusieurs GOP ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">groupe d'images</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Chaque GOP est indépendant et codé séparément, de sorte qu'il peut être décodé sans référence aux trames des autres GOP. </font><font style="vertical-align: inherit;">Autrement dit, les fragments peuvent être reproduits indépendamment les uns des autres. </font><font style="vertical-align: inherit;">Cette segmentation réduit la latence, vous permettant de commencer le traitement plus tôt.</font></font></li>
<li>Tcoder   .     ,    ,     (,     ,    ),             .   , Tcoder        .</li>
<li>ombiner   :   ,  Tcoder,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques mots sur le son. </font><font style="vertical-align: inherit;">Le codec audio AAC le plus populaire a une fonction désagréable. </font><font style="vertical-align: inherit;">Si vous codez les fragments séparément, les coller ensemble de manière transparente ne fonctionnera tout simplement pas. </font><font style="vertical-align: inherit;">Les transitions seront perceptibles. </font><font style="vertical-align: inherit;">Les codecs vidéo n'ont pas un tel problème. </font><font style="vertical-align: inherit;">Théoriquement, vous pouvez rechercher une solution technique difficile, mais ce jeu ne vaut tout simplement pas la chandelle (l'audio pèse beaucoup moins que la vidéo). </font><font style="vertical-align: inherit;">Par conséquent, seule la vidéo est codée en parallèle avec nous et la piste audio est traitée dans son ensemble.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">résultats</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce au traitement vidéo parallèle, nous avons considérablement réduit le délai entre le téléchargement d'une vidéo pour nous et sa disponibilité pour les utilisateurs. Par exemple, auparavant, il pouvait prendre deux heures pour créer plusieurs versions complètes de qualité différente pour un film FullHD d'une durée d'une heure et demie. Maintenant, tout cela prend 15 minutes. De plus, en traitement parallèle, nous créons une version haute résolution encore plus rapide qu'une version basse résolution avec l'ancienne approche avec un résultat intermédiaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et quelque chose d'autre. Avec l'ancienne approche, les serveurs pouvaient être manquants ou ils étaient inactifs sans tâches. Le codage parallèle peut augmenter la part d'utilisation du fer. Maintenant, notre cluster de plus d'un millier de serveurs est toujours occupé par quelque chose.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il y a encore place à amélioration. </font><font style="vertical-align: inherit;">Par exemple, nous pouvons gagner beaucoup de temps si nous commençons à traiter des fragments d'une vidéo avant même qu'elle ne soit arrivée en entier. </font><font style="vertical-align: inherit;">Comme ils disent, plus loin - plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Écrivez dans les commentaires sur les tâches dans le domaine du travail avec la vidéo que vous souhaitez lire.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liens utiles avec les pairs de l'industrie</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SVE: traitement vidéo distribué à l'échelle Facebook</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplifier l'innovation média chez Netflix avec Archer. </font><font style="vertical-align: inherit;">Blog sur la technologie Netflix</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494136/index.html">Quoi égoutter dans les yeux, pour ne pas démanger</a></li>
<li><a href="../fr494138/index.html">Droits de l'homme et algorithmes: la force brute du droit d'auteur ne fonctionnera pas aux États-Unis, en Australie, en Russie et dans l'UE</a></li>
<li><a href="../fr494140/index.html">Étude d'une campagne DNSpionage à l'aide de Cisco Threat Response, y compris le travail à distance</a></li>
<li><a href="../fr494150/index.html">ClickHouse à Avito: rencontres en direct avec Alexey Milovidov</a></li>
<li><a href="../fr494152/index.html">HoughNet: recherche de points de fuite fusionnés avec un algorithme classique</a></li>
<li><a href="../fr494156/index.html">Comment travailler à domicile - l'expérience des déménageurs Plesk</a></li>
<li><a href="../fr494158/index.html">Comment maintenir la qualité du travail en quarantaine</a></li>
<li><a href="../fr494162/index.html">Dépannage de Postgres avec pgCenter. Alexey Lesovsky</a></li>
<li><a href="../fr494164/index.html">Comment améliorer les performances des équipes agiles grâce aux tests</a></li>
<li><a href="../fr494170/index.html">Top 3 des fonctionnalités Python que vous ne connaissiez pas (probablement)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>