<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👿 🎬 🤟🏾 Cómo ejecutar cron más de una vez por minuto usando PHP 🎿 👨🏽‍🔧 🙎🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El archivo de configuración clásico para las entradas de trabajos cron en el sistema operativo Linux es el siguiente:
 
 

# ┌───────────── (0 - 59) #...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cómo ejecutar cron más de una vez por minuto usando PHP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498934/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El archivo de configuración clásico para las entradas de trabajos cron en el sistema operativo Linux es el siguiente:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># ┌─────────────  (0 - 59)</span>
<span class="hljs-comment"># │ ┌─────────────  (0 - 23)</span>
<span class="hljs-comment"># │ │ ┌─────────────  (1 - 31)</span>
<span class="hljs-comment"># │ │ │ ┌─────────────  (1 - 12)</span>
<span class="hljs-comment"># │ │ │ │ ┌─────────────   (0 - 6)</span>
<span class="hljs-comment"># │ │ │ │ │</span>
<span class="hljs-comment"># * * * * * &lt;  &gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los primeros cinco parámetros indican el tiempo de ejecución de esta tarea, y el sexto, el comando en sí, que debe ejecutarse. Los parámetros de tiempo son: minutos, horas, días, meses y día de la semana. Además, todos los números deben representarse como enteros o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en forma de sintaxis especial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el intervalo mínimo posible para iniciar un comando es una vez por minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para muchas tareas, la ejecución de comandos se necesita con mucha más frecuencia, por ejemplo, cada 10 segundos. Para algunas tareas de automatización de procesos de negocio, el retraso máximo permitido a menudo no es más de 1-1.5 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, el cron clásico no es adecuado para esto: debe mejorarse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La siguiente es una implementación paso a paso de crear funcionalidades adicionales (en PHP) para el cron clásico en Linux usando protección adicional contra reiniciar procesos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuración de tareas y configuración cron</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, utilizaremos la siguiente tarea:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la parte frontal, el usuario puede iniciar la ejecución de una tarea compleja haciendo clic en el botón "Ejecutar";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El back end después de escribir una nueva línea en la base de datos informa al usuario de la confirmación;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A través de cron, "rastrearemos" esas nuevas tareas y las completaremos lo más rápido posible para que el usuario no obtenga el resultado en un minuto, sino de inmediato *.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Si usa el lanzamiento de comandos, solo por minuto, la tarea comenzará cuando los segundos lleguen al cero más cercano (el comienzo de un nuevo minuto). </font><font style="vertical-align: inherit;">Por lo tanto, en la forma clásica, el usuario deberá esperar la ejecución de 0 a 59 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, cron se configurará en su forma máxima, es decir </font><font style="vertical-align: inherit;">una vez por minuto</font></font><br>
<br>
<pre><code class="bash hljs">* * * * * /usr/bin/php -q /run.php &gt; /dev/null 2&gt;&amp;1
<span class="hljs-comment">#/usr/bin/php -    PHP   (      )</span>
<span class="hljs-comment">#/run.php -   PHP   </span>
<span class="hljs-comment">#&gt; /dev/null 2&gt;&amp;1 - ,            run.php</span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciclo único</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, debe decidir con qué frecuencia solicitaremos nuevas tareas en la base de datos, dependiendo de esto, el número de ciclos y la suspensión lógica (función </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><code>sleep</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">cambiarán. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el ejemplo actual, se utiliza un paso de 10 segundos. </font><font style="vertical-align: inherit;">Por lo tanto, el número de ciclos es 60/10 = 6. Total, el código general es el siguiente:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">for</span> ($cycle = <span class="hljs-number">1</span>; $cycle &lt;= <span class="hljs-number">6</span>; $cycle++) { <span class="hljs-comment"># 6 </span>
    $all_tasks = get_all_tasks(); <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">if</span> ($all_tasks) { <span class="hljs-comment">#    - </span>
        <span class="hljs-keyword">foreach</span>($all_tasks <span class="hljs-keyword">as</span> $one_task) { <span class="hljs-comment">#     </span>
            solve_one_task($one_task); <span class="hljs-comment">#  </span><font></font>
        }<font></font>
    }<font></font>
    sleep(<span class="hljs-number">10</span>); <span class="hljs-comment">#  ,  ""  10 </span><font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aclaración</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : en este ejemplo, se utiliza un paso de 10 segundos, que puede proporcionar un intervalo mínimo de ejecución del script una vez cada 10 segundos. </font><font style="vertical-align: inherit;">En consecuencia, para una ejecución más frecuente, debe cambiar el número de ciclos y el "tiempo de suspensión".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evitar la ejecución repetida de tareas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la forma presentada, hay una incertidumbre, a saber, la ejecución repetida de la tarea si ya se ha iniciado. </font><font style="vertical-align: inherit;">Esto se vuelve especialmente cierto si la tarea es "difícil" y requiere unos segundos para implementarla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto crea un problema de re-ejecución:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La función </font></font><code>solve_one_task()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ya </font><font style="vertical-align: inherit;">se </font><font style="vertical-align: inherit;">está ejecutando, pero aún no ha completado su trabajo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, en la base de datos la tarea todavía está marcada como no cumplida;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente ciclo obtendrá esta tarea nuevamente y ejecutará la función </font></font><code>solve_one_task()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuevamente, con la misma tarea.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, esto se puede resolver, por ejemplo, cambiando algún estado en la base de datos para esta tarea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no cargaremos la base de datos: según mis pruebas, MYSQL puede aceptar la solicitud, pero no procesarla de inmediato. </font><font style="vertical-align: inherit;">Una diferencia de incluso 0,5 segundos puede conducir a la ejecución repetida, lo que categóricamente no es adecuado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También en este caso solo estamos hablando del estado de las tareas, por lo que es mejor usar el sistema de archivos del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El modelo de verificación básico se construye usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><code>flock</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una función que establece y desbloquea un archivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la ejecución de PHP, la función se puede representar de la siguiente manera:</font></font><br>
<br>
<pre><code class="php hljs">$lock_file_abs = <span class="hljs-string">'file'</span>; <span class="hljs-comment">#  </span>
$fp = fopen($lock_file_abs,<span class="hljs-string">"w+"</span>); <span class="hljs-comment">#   </span>
<span class="hljs-keyword">if</span> (flock($fp, LOCK_EX | LOCK_NB)) { <span class="hljs-comment">#,    </span>
    solve_one_task($one_task); <span class="hljs-comment">#  </span>
    flock($fp, LOCK_UN); <span class="hljs-comment">#   ,     </span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> {
    <span class="hljs-comment">#,   , ..       </span><font></font>
}<font></font>
fclose($fp); <span class="hljs-comment">#   </span>
unlink($lock_file_abs); <span class="hljs-comment"># ,   </span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La visión general de todo el ciclo es la siguiente:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">for</span> ($cycle = <span class="hljs-number">1</span>; $cycle &lt;= <span class="hljs-number">6</span>; $cycle++) {<font></font>
    $all_tasks = get_all_tasks();<font></font>
    <span class="hljs-keyword">if</span> ($all_tasks) {
        <span class="hljs-keyword">foreach</span>($all_tasks <span class="hljs-keyword">as</span> $one_task) {<font></font>
            $lock_file_abs = <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/locks/run_'</span>.$one_task[<span class="hljs-string">'id'</span>];<font></font>
            $fp = fopen($lock_file_abs,<span class="hljs-string">"w+"</span>);
            <span class="hljs-keyword">if</span> (flock($fp, LOCK_EX | LOCK_NB)) {<font></font>
                solve_one_task($one_task);<font></font>
                flock($fp, LOCK_UN);<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">#    </span><font></font>
            }<font></font>
            fclose($fp);<font></font>
            unlink($lock_file_abs);<font></font>
        }<font></font>
    }<font></font>
    sleep(<span class="hljs-number">10</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, dicho algoritmo le permite iniciar una ejecución cíclica del procesamiento de tareas y no le preocupa que la tarea se procese más de una vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora es suficiente simplemente ejecutar este código a través de cron cada minuto, y, a su vez, ejecutará ciclos más pequeños ya dentro de sí mismo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498922/index.html">Errores que arruinarán un proyecto de cualquier complejidad. Experiencia de gerentes de Redmadrobot</a></li>
<li><a href="../es498924/index.html">Por qué amo IKEv2 más que otras VPN</a></li>
<li><a href="../es498928/index.html">Lenguajes y tecnologías de impresoras</a></li>
<li><a href="../es498930/index.html">¿Por qué no tienes que convertirte en un líder de equipo?</a></li>
<li><a href="../es498932/index.html">El libro "Gestión de memoria en .NET para profesionales" en la traducción correcta del equipo DotNetRu</a></li>
<li><a href="../es498936/index.html">Enlace de API PHP de Cloudflare</a></li>
<li><a href="../es498940/index.html">AMA con Habr. # 18. Maratón, Promo y Resumen actualizado</a></li>
<li><a href="../es498942/index.html">Cómo está cambiando Service Desk en ITIL 4</a></li>
<li><a href="../es498944/index.html">Telegram. Perro, o cómo no hacer espejos</a></li>
<li><a href="../es498948/index.html">Hora de los dragones. Autoaislamiento con rompecabezas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>