<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë®üèΩ ‚úçüèº üéá GO Scheduler: Jetzt nicht kooperativ? ‚úçüèª üòû üë©üèæ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn Sie die Versionshinweise f√ºr Version GO 1.14 gelesen haben, haben Sie wahrscheinlich einige ziemlich interessante √Ñnderungen in der Laufzeit der ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GO Scheduler: Jetzt nicht kooperativ?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502506/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie die Versionshinweise f√ºr Version GO 1.14 gelesen haben, haben Sie wahrscheinlich einige ziemlich interessante √Ñnderungen in der Laufzeit der Sprache bemerkt. </font><font style="vertical-align: inherit;">Daher interessierte mich der Artikel sehr: "Goroutinen sind jetzt asynchron pr√§emptibel." </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass GO Scheduler (Scheduler) jetzt nicht kooperativ ist? </font><font style="vertical-align: inherit;">Nun, nachdem ich den entsprechenden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorschlag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diagonal gelesen hatte, war die </font><font style="vertical-align: inherit;">Neugier befriedigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einer Weile entschied ich mich jedoch, die Innovationen genauer zu untersuchen. </font><font style="vertical-align: inherit;">Ich m√∂chte die Ergebnisse dieser Studien teilen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/ur/hn/s0urhnlqgwhwtkwumpnyd2hfmyy.png" alt="Bild"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System Anforderungen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die nachfolgend beschriebenen Dinge erfordern vom Leser zus√§tzlich zu den Kenntnissen der GO-Sprache zus√§tzliche Kenntnisse, n√§mlich:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verst√§ndnis der Prinzipien des Schedulers (obwohl ich versuchen werde, unten "an den Fingern" zu erkl√§ren)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verstehen, wie der Garbage Collector funktioniert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verstehen, was GO Assembler ist </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende werde ich ein paar Links hinterlassen, die meiner Meinung nach diese Themen gut abdecken.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurz √ºber den Planer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie mich zun√§chst daran erinnern, was kooperatives und nicht kooperatives Multitasking ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit nicht kooperativem (verdr√§ngendem) Multitasking kennen wir alle das Beispiel des OS-Schedulers. Dieser Scheduler arbeitet im Hintergrund, entl√§dt Threads basierend auf verschiedenen Heuristiken und anstelle der entladenen CPU-Zeit beginnen andere Threads zu empfangen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Genossenschaftsplaner zeichnet sich durch ein anderes Verhalten aus - er schl√§ft, bis eine der Goroutinen ihn mit einem Hauch von Bereitschaft weckt, seinen Platz einem anderen zu geben. Der Planer entscheidet dann selbst, ob es notwendig ist, die aktuelle Goroutine aus dem Kontext zu entfernen, und wenn ja, wen er an ihre Stelle setzen soll. So funktionierte der GO-Scheduler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus betrachten wir die Eckpfeiler, mit denen der Scheduler arbeitet:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P - logische Prozessoren (wir k√∂nnen ihre Nummer mit der Funktion runtime.GOMAXPROCS √§ndern), auf jedem logischen Prozessor kann jeweils eine Goroutine unabh√§ngig ausgef√ºhrt werden. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M-OS-Threads. </font><font style="vertical-align: inherit;">Jedes P l√§uft auf einem Thread von M. Beachten Sie, dass P nicht immer gleich M ist. Beispielsweise kann ein Thread durch Syscall blockiert werden, und dann wird ein anderer Thread f√ºr sein P zugewiesen. </font><font style="vertical-align: inherit;">Und es gibt CGO und andere und andere Nuancen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G - Gorutine. </font><font style="vertical-align: inherit;">Nun, hier ist klar, dass G auf jedem P ausgef√ºhrt werden muss und der Scheduler dies √ºberwacht.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und das Letzte, was Sie wissen m√ºssen, und wann ruft der Scheduler tats√§chlich Goroutine auf? </font><font style="vertical-align: inherit;">Es ist einfach, normalerweise werden Anweisungen zum Aufrufen vom Compiler am Anfang des Hauptteils (Prolog) der Funktion eingef√ºgt (etwas sp√§ter werden wir genauer darauf eingehen).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und was ist eigentlich das Problem?</font></font></h3><br>
<img src="https://habrastorage.org/webt/8o/fa/qt/8ofaqt_aquvkvzoskizadsuzfyw.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu Beginn des Artikels haben Sie bereits festgestellt, dass sich das Prinzip der Arbeit des Schedulers in GO ge√§ndert hat. Betrachten wir die Gr√ºnde, warum diese √Ñnderungen vorgenommen wurden. </font><font style="vertical-align: inherit;">Schauen Sie sich den Code an:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unter dem Spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	runtime.GOMAXPROCS(<span class="hljs-number">1</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">var</span> u <span class="hljs-keyword">int</span>
		<span class="hljs-keyword">for</span> {<font></font>
			u -= <span class="hljs-number">2</span>
			<span class="hljs-keyword">if</span> u == <span class="hljs-number">1</span> {
				<span class="hljs-keyword">break</span><font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
	&lt;-time.After(time.Millisecond * <span class="hljs-number">5</span>) <span class="hljs-comment">//    main   ,         </span><font></font>
<font></font>
	fmt.Println(<span class="hljs-string">"go 1.13 has never been here"</span>)<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie es mit der Version GO &lt;1.14 kompilieren, wird die Zeile "go 1.13 war noch nie hier" nicht auf dem Bildschirm angezeigt. </font><font style="vertical-align: inherit;">Dies geschieht, weil, sobald der Scheduler der Goroutine mit einer Endlosschleife Prozessorzeit gibt, P vollst√§ndig erfasst wird, keine Funktionsaufrufe innerhalb dieser Goroutine auftreten, was bedeutet, dass wir den Scheduler nicht mehr aktivieren. </font><font style="vertical-align: inherit;">Und nur ein expliziter Aufruf von runtime.Gosched () l√§sst unser Programm beenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist nur ein Beispiel, bei dem Goroutine P erfasst und lange Zeit verhindert, dass andere Goroutinen auf diesem P ausgef√ºhrt werden. Weitere Optionen, wenn dieses Verhalten Probleme verursacht, finden Sie im Artikel.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorschlag analysieren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die L√∂sung f√ºr dieses Problem ist recht einfach. Machen wir dasselbe wie im OS-Scheduler! Lassen Sie GO einfach die Goroutine von P auslaufen und setzen Sie eine weitere dort ein, und daf√ºr werden wir die OS-Tools verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK, wie implementiert man das? Wir werden der Laufzeit erlauben, ein Signal an den Fluss zu senden, an dem Goroutine arbeitet. Wir werden den Prozessor dieses Signals in jedem Strom von M registrieren. Die Aufgabe des Prozessors besteht darin, zu bestimmen, ob die aktuelle Goroutine ersetzt werden kann. In diesem Fall speichern wir den aktuellen Status (Register und den Status des Stapels) und geben Ressourcen an einen anderen weiter. Andernfalls f√ºhren wir die aktuelle Goroutine weiter aus. Es ist erw√§hnenswert, dass das Konzept mit einem Signal eine L√∂sung f√ºr UNIX-Basissysteme darstellt, w√§hrend sich beispielsweise die Implementierung f√ºr Windows geringf√ºgig unterscheidet. √úbrigens wurde SIGURG als Signal zum Senden ausgew√§hlt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der schwierigste Teil dieser Implementierung besteht darin, festzustellen, ob Goroutine herausgedr√ºckt werden kann. </font><font style="vertical-align: inherit;">Tatsache ist, dass einige Stellen in unserem Code aus Sicht des Garbage Collectors atomar sein sollten. </font><font style="vertical-align: inherit;">Wir nennen solche Orte unsichere Punkte. </font><font style="vertical-align: inherit;">Wenn wir die Goroutine im Moment der Codeausf√ºhrung von einem unsicheren Punkt aus dr√ºcken und dann GC startet, ersetzt sie den Status unserer Goroutine, aufgenommen in einem unsicheren Punkt, und kann Dinge tun. </font><font style="vertical-align: inherit;">Schauen wir uns das sichere / unsichere Konzept genauer an.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bist du dorthin gegangen, GC?</font></font></h3><br>
<img src="https://habrastorage.org/webt/yw/ao/mw/ywaomwcstazbytzl9gwewm9agy8.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Versionen vor 1.12 verwendete Gosched zur Laufzeit Sicherheitspunkte an Stellen, an denen Sie den Scheduler definitiv aufrufen k√∂nnen, ohne bef√ºrchten zu m√ºssen, dass wir im atomaren Abschnitt des Codes f√ºr GC landen. </font><font style="vertical-align: inherit;">Wie bereits erw√§hnt, befinden sich Safe-Points-Daten im Prolog einer Funktion (wohlgemerkt jedoch nicht jeder Funktion). </font><font style="vertical-align: inherit;">Wenn Sie den go-shn-Assembler zerlegen, k√∂nnen Sie Einw√§nde erheben - dort sind keine offensichtlichen Scheduler-Aufrufe sichtbar. </font><font style="vertical-align: inherit;">Ja, aber Sie finden dort die Anweisung runtime.morestack call. Wenn Sie sich diese Funktion ansehen, wird ein Scheduler-Aufruf gefunden. </font><font style="vertical-align: inherit;">Unter dem Spoiler werde ich den Kommentar vor den GO-Quellen verbergen, oder Sie k√∂nnen den Assembler f√ºr Morestack selbst finden.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in der Quelle gefunden</font></font></b>
                        <div class="spoiler_text">Synchronous safe-points are implemented by overloading the stack bound check in function prologues. To preempt a goroutine at the next synchronous safe-point, the runtime poisons the goroutine's stack bound to a value that will cause the next stack bound check to fail and enter the stack growth implementation, which will detect that it was actually a preemption and redirect to preemption handling.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie zu einem Verdr√§ngungskonzept wechseln, kann ein Verdr√§ngungssignal unseren Gorutin nat√ºrlich √ºberall fangen. Aber die GO-Autoren haben beschlossen, keine sicheren Punkte zu hinterlassen, sondern √ºberall sichere Punkte zu deklarieren! Nat√ºrlich gibt es einen Haken, fast √ºberall. Wie oben erw√§hnt, gibt es einige unsichere Punkte, an denen wir niemanden verdr√§ngen werden. Schreiben wir einen einfachen unsicheren Punkt.</font></font><br>
<br>
<pre><code class="go hljs"><font></font>
j := &amp;someStruct{}<font></font>
p := unsafe.Pointer(j)<font></font>
<span class="hljs-comment">// unsafe-point start</span>
u := <span class="hljs-keyword">uintptr</span>(p)
<span class="hljs-comment">//do some stuff here</span><font></font>
p = unsafe.Pointer(u)<font></font>
<span class="hljs-comment">// unsafe-point end</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, wo das Problem liegt, probieren wir die Haut eines M√ºllsammlers an. Jedes Mal, wenn wir zur Arbeit gehen, m√ºssen wir die Wurzelknoten (Zeiger auf dem Stapel und in den Registern) herausfinden, mit denen wir mit dem Markieren beginnen. Da es zur Laufzeit unm√∂glich ist zu sagen, ob 64 Bytes im Speicher ein Zeiger oder nur eine Zahl sind, wenden wir uns dem Stapel zu und registrieren Karten (einige Caches mit Metainformationen), die uns freundlicherweise vom GO-Compiler zur Verf√ºgung gestellt wurden. Die Informationen in diesen Karten erm√∂glichen es uns, Zeiger zu finden. Also wurden wir geweckt und zur Arbeit geschickt, als GO Zeile 4 ausf√ºhrte. Als wir am Ort ankamen und die Karten betrachteten, stellten wir fest, dass sie leer waren (und dies ist wahr, da uintptr aus Sicht von GC eine Zahl und kein Zeiger ist). Nun, gestern haben wir von der Speicherzuweisung f√ºr j geh√∂rt, da wir jetzt nicht auf diesen Speicher zugreifen k√∂nnen - wir m√ºssen ihn bereinigen und nachdem wir den Speicher entfernt haben, gehen wir schlafen.Was weiter? Nun, die Beh√∂rden sind nachts aufgewacht und haben geschrien. Nun, Sie haben es selbst verstanden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles mit Theorie, ich schlage vor, in der Praxis zu √ºberlegen, wie all diese Signale, unsicheren Punkte und Registerkarten und Stapel funktionieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lass uns weiter √ºben</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe ein Beispiel vom Anfang des Artikels durch den Perf-Profiler doppelt ausgef√ºhrt (go 1.14 und go 1.13), um zu sehen, welche Systemaufrufe stattfinden, und sie zu vergleichen. </font><font style="vertical-align: inherit;">Der erforderliche Systemaufruf in der 14. Version wurde ziemlich schnell gefunden:</font></font><br>
<br>
<pre><code class="plaintext hljs">15.652 ( 0.003 ms): main/29614 tgkill(tgid: 29613 (main), pid: 29613 (main), sig: URG                ) = 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, offensichtlich hat die Laufzeit SIGURG an den Thread gesendet, auf dem sich die Goroutine dreht. </font><font style="vertical-align: inherit;">Ausgehend von diesem Wissen habe ich mir die Commits in GO angesehen, um herauszufinden, wohin und aus welchem ‚Äã‚ÄãGrund dieses Signal gesendet wird, und um den Ort zu finden, an dem der Signalhandler installiert ist. </font><font style="vertical-align: inherit;">Beginnen wir mit dem Senden. Die Funktion zum Senden von Signalen finden Sie in runtime / os_linux.go</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">signalM</span><span class="hljs-params">(mp *m, sig <span class="hljs-keyword">int</span>)</span></span> {<font></font>
	tgkill(getpid(), <span class="hljs-keyword">int</span>(mp.procid), sig)<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt finden wir Stellen im Laufzeitcode, von denen aus wir das Signal senden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Goroutine ausgesetzt ist, wenn es sich in einem laufenden Zustand befindet. </font><font style="vertical-align: inherit;">Die Suspend-Anforderung kommt vom Garbage Collector. </font><font style="vertical-align: inherit;">Hier werde ich vielleicht keinen Code hinzuf√ºgen, aber er befindet sich in der Datei runtime / preempt.go (suspendG)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn der Scheduler entscheidet, dass Goroutine zu lange arbeitet, wird runtime / proc.go (Wiederholung)</font></font><br>
<pre><code class="go hljs">
<span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now {<font></font>
	signalM(_p_)<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
forcePreemptNS - Konstante gleich 10 ms, pd.schedwhen - Zeitpunkt, zu dem der Scheduler f√ºr den pd-Stream das letzte Mal aufgerufen wurde</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Neben allen Streams wird dieses Signal w√§hrend einer Panik, StopTheWorld (GC) und einigen weiteren F√§llen gesendet (die ich umgehen muss, da die Gr√∂√üe des Artikels bereits √ºber den Rahmen hinausgeht).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben herausgefunden, wie und wann die Laufzeit ein Signal an M sendet. </font><font style="vertical-align: inherit;">Lassen Sie uns nun den Handler f√ºr dieses Signal finden und sehen, was der Stream tut, wenn er empfangen wird.</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSigPreempt</span><span class="hljs-params">(gp *g, ctxt *sigctxt)</span></span> {
	<span class="hljs-keyword">if</span> wantAsyncPreempt(gp) &amp;&amp; isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()) {
		<span class="hljs-comment">// Inject a call to asyncPreempt.</span><font></font>
		ctxt.pushCall(funcPC(asyncPreempt))<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus dieser Funktion geht hervor, dass Sie zum ‚ÄûEinrasten‚Äú zwei √úberpr√ºfungen durchf√ºhren m√ºssen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wantAsyncPreempt - Wir pr√ºfen, ob G erzwungen werden soll. Hier wird beispielsweise die G√ºltigkeit des aktuellen Goroutine-Status √ºberpr√ºft.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isAsyncSafePoint - √úberpr√ºfen Sie, ob es jetzt verdr√§ngt werden kann. </font><font style="vertical-align: inherit;">Die interessanteste √úberpr√ºfung hier ist, ob sich G an einem sicheren oder unsicheren Punkt befindet. </font><font style="vertical-align: inherit;">Au√üerdem m√ºssen wir sicher sein, dass der Thread, auf dem G ausgef√ºhrt wird, auch bereit ist, G zu verhindern.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn beide Pr√ºfungen bestanden sind, werden Anweisungen aus dem ausf√ºhrbaren Code aufgerufen, der den Status G speichert und den Scheduler aufruft.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und mehr √ºber unsichere</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich schlage vor, ein neues Beispiel zu analysieren, es wird einen anderen Fall mit unsicherem Punkt veranschaulichen:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein weiteres endloses Programm</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-comment">//go:nosplit</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">infiniteLoop</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> u <span class="hljs-keyword">int</span>
	<span class="hljs-keyword">for</span> {<font></font>
		u -= <span class="hljs-number">2</span>
		<span class="hljs-keyword">if</span> u == <span class="hljs-number">1</span> {
			<span class="hljs-keyword">break</span><font></font>
		}<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	runtime.GOMAXPROCS(<span class="hljs-number">1</span>)
	<span class="hljs-keyword">go</span> infiniteLoop()<font></font>
	&lt;-time.After(time.Millisecond * <span class="hljs-number">5</span>)<font></font>
<font></font>
	fmt.Println(<span class="hljs-string">"go 1.13 and 1.14 has never been here"</span>)<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie vielleicht erraten haben, wird die Inschrift ‚Äûgo 1.13 und 1.14 war noch nie hier‚Äú in GO 1.14 nicht zu sehen sein. </font><font style="vertical-align: inherit;">Dies liegt daran, dass wir ausdr√ºcklich verboten haben, die Funktion infiniteLoop (go: nosplit) zu unterbrechen. </font><font style="vertical-align: inherit;">Ein solches Verbot wird nur unter Verwendung eines unsicheren Punktes implementiert, der den gesamten Funktionsumfang darstellt. </font><font style="vertical-align: inherit;">Mal sehen, was der Compiler f√ºr die Funktion infiniteLoop generiert hat.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorsicht Assembler</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   TEXT    <span class="hljs-string">""</span>.infiniteLoop(SB), NOSPLIT|ABIInternal, $<span class="hljs-number">0</span><span class="hljs-number">-0</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   PCDATA  $<span class="hljs-number">0</span>, $<span class="hljs-number">-2</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   PCDATA  $<span class="hljs-number">1</span>, $<span class="hljs-number">-2</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">0</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">1</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">2</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   XORL    AX, AX
        <span class="hljs-number">0x0002</span> <span class="hljs-number">00002</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">12</span>)   JMP     <span class="hljs-number">8</span>
        <span class="hljs-number">0x0004</span> <span class="hljs-number">00004</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">13</span>)   ADDQ    $<span class="hljs-number">-2</span>, AX
        <span class="hljs-number">0x0008</span> <span class="hljs-number">00008</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span>)   CMPQ    AX, $<span class="hljs-number">3</span>
        <span class="hljs-number">0x000c</span> <span class="hljs-number">00012</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span>)   JNE     <span class="hljs-number">4</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   PCDATA  $<span class="hljs-number">0</span>, $<span class="hljs-number">-1</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   PCDATA  $<span class="hljs-number">1</span>, $<span class="hljs-number">-1</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   RET
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Fall ist der PCDATA-Befehl von Interesse. </font><font style="vertical-align: inherit;">Wenn der Linker diese Anweisung sieht, konvertiert er sie nicht in einen "echten" Assembler. </font><font style="vertical-align: inherit;">Stattdessen wird der Wert des 2. Arguments mit dem Schl√ºssel gleich dem entsprechenden Programmz√§hler (die Zahl, die links vom Funktionsnamen + Zeile zu sehen ist) in das Register oder die Stapelzuordnung eingef√ºgt (bestimmt durch das 1. Argument). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir in den Zeilen 10 und 15 sehen, setzen wir die Werte $ 2 und -1 in die Karte $ 0 bzw. $ 1. </font><font style="vertical-align: inherit;">Erinnern wir uns an diesen Moment und werfen wir einen Blick in die isAsyncSafePoint-Funktion, auf die ich Sie bereits aufmerksam gemacht habe. </font><font style="vertical-align: inherit;">Dort sehen wir folgende Zeilen:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isAsyncSafePoint</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
	smi := pcdatavalue(f, _PCDATA_RegMapIndex, pc, <span class="hljs-literal">nil</span>)
	<span class="hljs-keyword">if</span> smi == <span class="hljs-number">-2</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><font></font>
	}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An dieser Stelle pr√ºfen wir, ob sich Goroutine derzeit im sicheren Punkt befindet. </font><font style="vertical-align: inherit;">Wir wenden uns der Registerkarte zu (_PCDATA_RegMapIndex = 0) und √ºbergeben dem aktuellen PC den Wert. Wenn -2, dann ist G nicht im sicheren Punkt, was bedeutet, dass es nicht verdr√§ngt werden kann.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe meine "Forschung" dazu eingestellt, ich hoffe, der Artikel war auch f√ºr Sie n√ºtzlich. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich poste die versprochenen Links, aber bitte seien Sie vorsichtig, da einige der Informationen in diesen Artikeln veraltet sein k√∂nnten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GO Scheduler - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zweimal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembler GO.</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502494/index.html">7 Fehler eines Black Friday und wie Magento Cloud funktioniert - Video</a></li>
<li><a href="../de502496/index.html">Einfacher Webzugriff auf LabVIEW VI PHP-Anwendungen √ºber ActiveX Server</a></li>
<li><a href="../de502498/index.html">Best Practices zur Verbesserung der Leistung in C #</a></li>
<li><a href="../de502500/index.html">Die Entwicklung eines Passscanners: vom Sperrholzhandwerk zum echten Gesch√§ft</a></li>
<li><a href="../de502504/index.html">Umgeben Sie die Benutzerziffer</a></li>
<li><a href="../de502508/index.html">Trolley Robot 2.0. Teil 2. Management in rviz und ohne. Elemente der Sch√∂nheit in rviz</a></li>
<li><a href="../de502510/index.html">Was in der Cloud zu speichern</a></li>
<li><a href="../de502512/index.html">Ergebnisse des Wettbewerbs der Sofaexperten: die Regeln des wissenschaftlichen Stocherns</a></li>
<li><a href="../de502518/index.html">Wie man auf einen Baum klettert</a></li>
<li><a href="../de502520/index.html">Videoberichte von Mitap-Berichten zur Produktanalyse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>