<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👈🏽 🚇 🔁 Sports.ruがWYSIWYGエディターを書いたとき 🖨️ 👨🏼‍🎓 👨🏾‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2018年半ばに、Sports.ru はユーザー投稿用の新しいWYSIWYGテキストエディターへの移行を検討しました。2019年6月以降、エディターはベータモードになっています。この間、サービス全体のアーキテクチャの設計と、ProseMirrorライブラリに基づくブラウザーでのエディター自体の実装の...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sports.ruがWYSIWYGエディターを書いたとき</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sports_ru/blog/492228/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018年半ばに、Sports.ru </font><font style="vertical-align: inherit;">はユーザー投稿用の</font><font style="vertical-align: inherit;">新しい</font></font><abbr title="あなたが見たもの、それがあなたの手に入れたものだ"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WYSIWYG</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストエディター</font><font style="vertical-align: inherit;">への移行を検討し</font><font style="vertical-align: inherit;">ました。</font><font style="vertical-align: inherit;">2019年6月以降、エディターはベータモードになっています。</font><font style="vertical-align: inherit;">この間、サービス全体のアーキテクチャの設計と、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリに基づくブラウザーでのエディター自体の実装の両方に関連する多くの問題を解決</font><font style="vertical-align: inherit;">し、経験を共有することにしました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/2p/ag/wc2pagubhgtlo-bvev4wjyfmrsk.png"><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目次</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">1. </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">1.1.   WYSIWYG</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">1.2.  ,    </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">2.   </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3.  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3.1.  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3.2.    </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">4.  -</a><br>
<br>
<a name="Intro"></a><br>
<h2>1. </h2><br>
<a name="Why"></a><br>
<h3>1.1.   WYSIWYG</h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sports.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、毎月2,000万人のユーザーがいるスポーツに関するメディアです。クラシックメディアとの主な違いは、コミュニティと</font></font><abbr title="ユーザー作成コンテンツ"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UGC</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。ユーザーコンテンツ-評価、コメント、チャット、投稿-は編集上の価値を補完するだけでなく、ユーザーが相互にやり取りするためのプラットフォームも作成します。毎月、ユーザーはほぼ1万の投稿を書き込みます。それらの最高のものは、編集ページと一緒にサイトのメインページに送信され、モバイルアプリケーション、ソーシャルネットワークに送信されます。ユーザーコンテンツは、Sports.ruページの全読み取りの約40％を占めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはスポーツ作家にとって最も便利なプラットフォームになり、コンテンツを作成して関心のある視聴者に配信できるようにしたいと考えています。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">TinyMCE</font></a><font style="vertical-align: inherit;">エディターを使用して10年</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-そして、結局それは時代遅れになりました、それは現代のエディターに慣れていたチームとユーザーの両方に合うのをやめました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ff/ub/ig/ffubigpbednsp8phz7btg-icbm8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">1. TinyMCEに基づく古いエディターのインターフェース</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブログの作成</font><i><font style="vertical-align: inherit;">者</font></i><font style="vertical-align: inherit;">から、次の苦情について定期的に受け取りました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は長い間書いたのですが、誤ってタブを閉じてしまい、すべてが消えてしまいました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長いテキストを書くことは非常に不便です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各画像を挿入するには、まず画像を画像ホスティングにアップロードする必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チームはまた独自の不満を持っていました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TinyMCEでは、ファイルから画像を直接アップロードすることはできません。画像へのリンクを添付することしかできません。ユーザーがストレージに画像をアップロードできなかったため、ユーザーへのリンクが停止した場合、それについて何もできませんでした。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストの編集とフォーマットの可能性はバランスが取れていません。</font><font style="vertical-align: inherit;">一方で、テキストの内部ヘッダーなど、十分なスタイルがありませんでした。</font><font style="vertical-align: inherit;">一方、使用可能なツールを任意の組み合わせで使用することができました。</font><font style="vertical-align: inherit;">その結果、投稿は統一されていないように見えました（Sports.ruでは、設計システムの実装に向けた作業が開始され、ユーザーの投稿はそれに従っているはずです）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツはHTMLで作成および保存されるため、さまざまなクライアントの投稿のスタイルを管理し、投稿のレイアウトを変更するだけでは困難です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は、フロントエンド側で新しいエディターを作成する問題をどのように解決したかについてのストーリーです。</font><font style="vertical-align: inherit;">確かに、製品、デザイン、およびバックエンドパーツについても何かがあります。これがないと、フロントエンドで決定が行われた理由を理解するのが難しいためです。</font></font><br>
<br>
<a name="Task"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2。</font><font style="vertical-align: inherit;">開発者が直面するタスクの説明</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、Sports.ruでのブログ作成は苦痛でした。</font><font style="vertical-align: inherit;">原則として、新しいエディターを作成せずに、自動保存と自分のストレージに写真をアップロードする機能を追加するだけで、ユーザーと従業員からの苦情のほとんどが消えます。</font><font style="vertical-align: inherit;">しかし、私はまだ古いツールでツールをサポートするのではなく、簡単に開発およびスケーリングできる新しい最新のエディターを作成したいと考えていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不便なインターフェースに加えて、古いエディターの主な技術的問題の1つは、投稿のコンテンツがHTML文字列としてすぐに保存され、投稿の外観の変更がバックエンド開発者の介入を必要としたか、クライアントのランタイムに実装された（たとえば、広告ユニットの配置）ことでした。投稿の本文）。とりわけ、私たちの仕事は、データをプレゼンテーションから分離し、それに応じてレイアウトとインターフェイスをクライアントコードに残し、サーバーコードのデータを操作することでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロールモデルとして、私たちは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mediumを採用し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、時には</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Docの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アイデアをスパイしました</font><font style="vertical-align: inherit;">。すでに特定されている問題を解決することに加えて、エディターの使用をより快適にするいくつかの新機能を追加することにしました。</font></font><br>
<br>
<ul>
<li>  WYSIWYG, .. what you see is what you get (. « ,   »,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>),           ,     .     ,      ;</li>
<li>  (      ,       ,      ,   ,    ; ,           )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、編集者自身がSports.ruの機能に関連付けられるべきではありませんでした。Sports.ruは、当社の主力プロジェクトですが、まだ唯一のものではないためです。同社はまた</font><font style="vertical-align: inherit;">、賭け愛好家のBetting </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Insiderの</font></a><font style="vertical-align: inherit;">ためのソーシャルネットワークである</font><font style="vertical-align: inherit;">国際的なスポーツメディア</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tribunaを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発し</font><font style="vertical-align: inherit;">ており、最近、広告プロジェクトに従事する独自の制作スタジオを立ち上げました。オンラインエディタの開発は、編集と書式設定のための独自のツールセットを備えた、さまざまな組版とスタイルを備えた別のサイトでこのコードを再利用したくないほど高価です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストコンテンツがたくさんあるので、新しい投稿エディターの作成に取り掛かる前に、このコンテンツをどのように保存するかを考えました。 TinyMCEには選択肢がなく、コンテンツはHTMLにのみ保存する必要があり、前述のとおり、チームには適していませんでした。その結果、私たちは要件を満たすテキストデータを格納するための独自の形式を考え出し、それを構造化ボディと呼びました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構造化ボディは、コンテンツの構造を反映するオブジェクトの配列です。この場合、コンテンツは、独立したブロックである要素（段落、リスト、画像など）に分割されます。要素には、その型とそのプロパティに関する情報が格納されます。たとえば、サブタイトルブロックはテキストのタイトルを説明し、テキストとレベルフィールドを含む必要があります。したがって、textにはこの見出しのテキストが含まれ、levelにはレベル（1から4）が含まれます。 1つの第2レベルのヘッダーで構成される構造化された本体は、たとえば次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> structuredBody = [<font></font>
    {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">type</span>: <span class="hljs-string">'subtitle'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">value</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">level</span>: <span class="hljs-number">2</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },<font></font>
    },<font></font>
];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構造化された組織への移行により、ビジネスロジック、データ、およびそれらのプレゼンテーションを分離するプロセスを開始できました。最終的に、サーバーとクライアントはデータのみを交換する必要があります。そして、このデータをエンドユーザーに表示する方法と理由は、各クライアントが個別に決定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォーマットされた本文形式のコンテンツはJSONに格納され、その内容を検証するために、</font><font style="vertical-align: inherit;">構造化された本文スキーマと呼ばれる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSONスキーマ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成しました</font><font style="vertical-align: inherit;">。この図は、すべての有効な要素とそのプロパティを示しています。したがって、構造化された本体が必要な場合は常に、1組のキーと値のセットが使用されることを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、さまざまなチームが同じサービスを使用してこの形式のコンテンツを処理できるようになります。たとえば、コンテンツを表示するための構造化ボディからHTMLを生成するサービスや、コンテンツを作成するためのエディターなどです。これにより、コンテンツの作成と表示に関連するサービスのコア全体を開発およびサポートするコストが大幅に削減されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいエディターは、構造化されたボディ形式でのみ入出力コンテンツを受け入れる必要があると想定されていました。そしてここでは微妙な点を考慮する必要がありました：以前の投稿はすぐにHTMLに保存されたので、データベースからのこのHTML文字列は表示のためにクライアントに送信されました（以下、特に指定のない限り、クライアントとはブラウザのみを意味します）。次に、すべての投稿のコンテンツを構造化された本文に格納したいと思いますが、クライアントはHTMLしか処理できません。そのため、新しいエディターに移行するタスクとともに、構造化された本体から直接読み取るための投稿をクライアントが表示するための新しい方法を実装するタスクも同時に進行しています。象の断片を食べるほうがよいと判断したので、最初にTinyMCEを完全に放棄し、次に投稿を表示するロジックを実行する必要があります。また、すべての古い投稿でコンテンツを新しい形式に転送することができたわけではありません。つまり、これらの投稿は常にHTMLでのみ保存され、閲覧する能力も保持する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
合計：投稿の一部（新しい形式に正常に転送されたすべての新旧）は、読み取り用の新しい表示ロジックが実装されるまで、HTMLと構造化された本体、および残り（ほとんどの古いものと非常に古いもの）の2つの形式で保存されます。投稿）はHTMLにのみ残ります。</font></font><br>
<br>
<a name="How"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.ツールの選び方</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の機能と制限を考慮して、クライアントで投稿を編集および作成する機能を実現する必要がありました。いつものように、既製のソリューションを使用することも、独自のソリューションを作成することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、WYSIWYGエディターを作成するための既製のライブラリーとは何か、そしてそれらが私たちに適しているかどうかを調べました。私たちは、上の定住</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スレート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテンツをデータ構造に格納することに加えて、Vue + Vuexを使用してサイトを新しい技術スタックに移動し始めたため、Vueまたは純粋なJSを操作する能力も重要な瞬間でした。さらに、必要に応じて、完成したライブラリの機能を、新しいモジュール（サードパーティまたは自己作成）を使用して拡張したいと思います。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タブ。</font><font style="vertical-align: inherit;">1. Sports.ruの最も重要なパラメーターによるレビュー済みライブラリーの比較</font></font></i><br>
<img src="https://habrastorage.org/webt/fw/hf/xa/fwhfxa6ozwkyfdpdj8t6j5lcbuy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
表からわかるように、ProseMirrorは要件に完全に準拠しているため、テキストコンテンツを編集するために独自のライブラリーを作成するという考えはもはや考慮されませんでしたが、このライブラリーをより詳細に検討し始めました。</font><font style="vertical-align: inherit;">ツールを選択する段階で正直に忘れてしまったという理由だけで比較に至らなかっ</font><font style="vertical-align: inherit;">た、かなり人気のある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がまだあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">私たちの主要な要件によると、それも通過しますが、それはちょうど起こりました。</font><font style="vertical-align: inherit;">ProseMirrorとは何か、およびそれを使用する方法については、別の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに説明しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="What"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.何が起こったのか</font></font></h2><br>
<a name="Architecture"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1。</font><font style="vertical-align: inherit;">サービスアーキテクチャ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアント上のコンテンツエディター自体は、すべてとはほど遠いものです。</font><font style="vertical-align: inherit;">エディターを既存のプロジェクトに配置し、Webページのどこかに表示し、バックエンドとの相互作用を検討し、2つのエディターを同時にサポートする問題（古いエディターをすぐに放棄することはできなかった）を解決し、コンテンツを2つの形式（HTMLおよび構造化されたもの）で保存する必要があります。体）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのタスクはすべて、フロントエンド、バックエンド、およびそれらの統合に関連するタスクに分割できます。</font><font style="vertical-align: inherit;">私たちは主にフロントエンドと統合の問題に関係していますが、バックエンドタスクのいくつかの重要な側面についても触れています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エディターのフロントエンドサービスは、いくつかのレベルに分割できます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">投稿を作成および編集するためのWebページ。</font></font></li>
<li>Vue-app,    .  ,  ,   Vue,         -, , , ,       ..,    ,         ,      ;</li>
<li>WYSIWYG-   ProseMirror,      Vue.      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>;</li>
<li>SB2HTML –    HTML  structured body,    .    , structured body –       ,    .      ,   ,     ,      .    Sports.ru     HTML  structured body,  -     HTML  .       HTML    Node.Js,        JS-   .<br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
投稿を保存するプロセスを図4に示します。</font><font style="vertical-align: inherit;">2.構造化された本文形式の投稿のコンテンツとそのメタデータがバックエンドに転送されます。</font><font style="vertical-align: inherit;">バックエンドはSB2HTMLサービスにコンテンツを送信し、応答で準備が整ったHTMLを受信し、これをすべてデータベースに入れて、投稿が正常に保存されたことをクライアントに通知するか、エラーを報告します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/fp/j8/offpj883_eq2swjl-ogb6jxprks.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">2. WYSIWYGエディターで作成または編集するときに投稿を保存するためのスキーム</font></font></i><br>
<br>
<a name="Difficulties"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2。</font><font style="vertical-align: inherit;">どのような困難に直面しましたか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの困難がありました、それらは絶えずそしてしばしば最も予期しない瞬間に起こりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、コンテンツエディターはフォーム内にあり、タイトル、注釈など、投稿の作成に必要な追加データを入力できます。注釈については、ファイルから、およびインターネットからのリンクを介して画像をダウンロードできるようにする必要があります。ただし、コンテンツの場合は、ファイルから画像を読み込み、さらに、同じルールに従って参照によって読み込みます。そしてここで私たちはジレンマに直面しています：一方で、投稿のコンテンツは編集時に外部フォームから分離され、ProseMirrorツールによって提供されますが、一方で、</font><abbr title="自分を繰り返さないで"><font style="vertical-align: inherit;">DRYの</font></abbr><font style="vertical-align: inherit;">原則を観察したいと思います</font></font><abbr title="自分を繰り返さないで"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じコードを複製しないでください。これを次のように解決しました。画像のロードをVueフォームレベルのオブジェクトのメソッドセットとして記述し、このオブジェクトをパラメーターの1つとしてWYSIWYGエディターのコンストラクターに渡しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテンツを記述するエンティティ（ノードとフラグメント）は、ProseMirrorモデルで定義されます。ただし、トランザクションではインデックスのみを使用して、このトランザクションが適用される文字の範囲を決定します（インデックスは、ドキュメントの先頭と親ノードの先頭の両方からカウントされます）。文字のインデックス付けはProseMirrorの中心的な概念の1つですが、テキストを編集およびフォーマットする場合は、ProseMirrorモデルのエンティティについて考える方がはるかに便利です。その結果、コンテンツで快適に作業できるように、トランザクション用のドキュメントとの対話を簡素化するヘルパーを作成しました。作業の開始後、</font><font style="vertical-align: inherit;">同様のヘルパーのセットである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiptap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が表示</font></a><font style="vertical-align: inherit;">されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の問題は、スキームを作成する段階で、コンテンツを格納するための承認済みの内部形式（ニーズを満たす構造化された本体）が既にあり、ProseMirrorがコンテンツを独自の形式でストーリーに格納することです。 ProseMirror形式への切り替えは難しく、実用的ではありませんでした。ある形式のデータがAPIを介してクライアントに送信され、別の形式のデータを表示する必要がある状況にありました。変更または作成されたコンテンツを保存する必要がある場合も、同様の状況が発生します。これを行うために、フォーマットを前後に変換するコンバーターを実装しました。彼らは彼のために簡単なテストを書きました。それは構造化されたボディ形式で1つの投稿の内容を取り、それをProseMirror形式に変換し、元のバージョンを受信したものと比較します。それは迅速かつ簡単に判明しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来的には、ドキュメントスキームが変更され、概して、より複雑になるにつれて、わずかな変更がエディターでエラーを引き起こす可能性があることが明らかになり、そのようなテストは非常に不十分なカバレッジを与えるようです。その結果、2つの小さなコンバーターメソッドでノードとブランドのほぼすべての組み合わせのテストを作成する必要がありました。これらのテストがなければ、回路の次の変更が何かを壊すかどうかを判断することは不可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の問題は、新旧のテクノロジーの下位互換性の必要性に関連しています。私たちのWYSIWYGエディターはブラウザー（デスクトップ、そして近々モバイル）にのみ実装されています。したがって、クライアントでコンテンツを編集する場合、JSON形式の構造化ボディで提供されますが、ブラウザでの投稿の読み取りはHTMLからのみ実行されます。同時に、ほとんどのモバイルアプリケーションは、構造化された本文から直接ユーザー投稿を表示するように切り替えられています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モバイルアプリケーションの場合、クライアントが構造化ボディの要素を処理できない場合を想定する必要がありました。たとえば、新しい要素が構造化ボディに追加された場合、その表示はアプリケーションの新しいバージョンでのみ実装されます。すべてのユーザーが同時にアプリケーションを更新するわけではないため、古いバージョンの計画「B」を提供する必要がありました。構造化された本文からHTMLを作成する代わりに、目的の要素の既製のHTMLフラグメントを挿入します。各要素のHTMLフラグメントの存在は、構造化ボディスキームでは提供されていませんでした。この構造の目的は、HTMLへのデータの格納を拒否することでした。しかし、結局、2つの構造化されたボディスキーマ（1つは表示用、もう1つは編集用）が必要であるという結論に達しました。スキーム間の違いは編集用の構造化ボディには記事のコンテンツのみが含まれ、表示用にいくつかの追加要素を追加します。特に、各要素のHTMLフラグメントは、投稿がSB2HTMLサービスに保存されるときに作成され、構造化された本文にのみ追加されて投稿を表示します。さらに、構造化ボディは、表示用コンテンツに広告スペースも表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテンツをブラウザーで開いて編集する場合、すべての投稿が同じ方法で作成および表示されるため、基本的に不明な要素に遭遇することはありません。しかし、彼らは将来についてもそのようなケースを予測することに決めました。これを行うために、デフォルトのスタブ要素をProseMirrorスキーマに追加しました。この要素にunsupportedBlockという名前を付けました。サポートされていないアイテムの代わりにスタブが表示されます。この要素はサポートされておらず、編集できないことを示すテキストを含む灰色の長方形としてスタイルを設定しました。投稿が保存されると、そのような要素は構造化された本文では変更されません。ユーザーは他の要素との相対位置を変更できますが、不明な要素の内部コンテンツは変更または編集できません。ただし、ユーザーはそのような要素を削除することができます。その場合、もちろん、最終的なドキュメントには保存されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明されているすべての問題は、WYSIWYGエディター自体の実装の難しさに関連しています。しかし、それはベータモードで存在していましたが、TinyMCEの古いエディターを放棄することはできず、両方のエディターをサポートすることを強いられ、それらの間の後方互換性を提供しました。たとえば、WYSIWYGエディターで投稿を作成し、保存してからTinyMCEで編集し、保存し、WYSIWYGで再び開く、などです。その結果、WYSIWYGで開いたときに、前回のTinyMCEでの保存と同じコンテンツが表示されました。下位互換性を実装するには、HTMLコンテンツをTinyMCEに送信する必要がありました。TinyMCEは、構造化された本文から作成し、投稿を保存するときにデータベースに保存する方法を既に学習しました。そして、TinyMCEを介して投稿を保存すると、サーバー上で作成されたコンテンツがHTML2SBサービスを介して実行され、その結果、新鮮なHTMLと構造化された本文の両方を保存できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTML2SBは、SB2HTMLが行うことの反対です。つまり、コンテンツをHTMLから構造化された本文に変換します。</font><font style="vertical-align: inherit;">WYSIWYGエディターが作成される前は、投稿コンテンツを構造化された本文形式で取得する唯一の方法がHTMLからの直接解析だったため、年代順に、このサービスは何よりも早く登場しました。</font><font style="vertical-align: inherit;">HTML2SBはポストエディター周辺のバックエンドインフラストラクチャの一部でしたが、TinyMCEを放棄した後は不要になりました。</font></font><br>
<br>
<a name="Results"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.ベータ版の結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、WYSIWYG-editorはベータ版ですべてのユーザーが利用でき、すぐにSports.ru投稿のメインエディターになります。</font><font style="vertical-align: inherit;">ほとんどの要件を満たす投稿を作成および編集するためのツールをすでに受け取っています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">編集者のインターフェースが明確、簡潔、そしてモダンになり、長い投稿を書くことがはるかに簡単になりました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これで、ファイルから画像をダウンロードでき、リンクを使用して、リポジトリにすぐに配置できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要なソーシャルネットワークやビデオホスティングサイトからの埋め込みを埋め込むオプションが追加されました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストのフォーマットスタイルをクリーンアップ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モバイルアプリケーションはすでに構造化された本文からの投稿の表示に切り替えており、コンテンツに独自のスタイルを設定できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、エディターはまだ完全にデバッグされていません。定期的に新しいバグを検出しています。</font><font style="vertical-align: inherit;">次のアップデートが予定されています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動保存;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拡張された権限を持つユーザー（管理者、フルタイムの編集者）向けのWYSIWYGバージョン。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モバイルブラウザーからの投稿の作成と編集;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のユーザーによるドキュメントの並行編集に関するメッセージ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒントとオンボーディング;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スポーツチーム、試合、ラインナップの統計ウィジェット。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを書いている時点では、13,000を超える投稿がエディターのベータ版を通じて既に公開されています。これは、2019年6月から2020年2月までの期間のSports.ruのユーザーテキストの総数の約20％です。新しいエディターを通じて作成および公開された投稿のシェアは着実に増加しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/2i/4b/ad2i4b4dubgv9--l-vl7ghh6cnw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 3.新しいエディターで作成および公開されたユーザー投稿の割合</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいエディターを介して作成および公開されたユーザー投稿のシェアの有機的な成長は、ユーザーが更新に満足していることを示しているようです。これは、ベータテストの開始のアナウンスでのフィードバックによっても確認されます（一部は図4に示されています）。</font><font style="vertical-align: inherit;">したがって、今後数か月で、投稿の作成を新しいエディターに完全に転送し、そのサポートと開発のみに集中する予定です。&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ところで、WYSIWYGエディターにはどのような機能を追加しますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k-/bm/nz/k-bmnzzgoh5wi-nvq516-pca8uk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">4. WYSIWYGエディターの更新のアナウンスを含む投稿内のユーザーコメント&nbsp;</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492216/index.html">ビルド段階で.Netアプリケーションに値を保存する</a></li>
<li><a href="../ja492218/index.html">覚えておくべきアイコンのデザインルール</a></li>
<li><a href="../ja492220/index.html">5あまり知られていないパンダの秘密</a></li>
<li><a href="../ja492222/index.html">2019年のCTFZone Qualsのまとめ：鶏肉</a></li>
<li><a href="../ja492226/index.html">マネージドKubernetesの価格比較（2020）</a></li>
<li><a href="../ja492232/index.html">SmartcallがVoximplantキットになった経緯-ブランド変更とキラー機能</a></li>
<li><a href="../ja492234/index.html">研究：人々が社会的プロジェクトで受け取る収入を減らす準備ができている理由</a></li>
<li><a href="../ja492242/index.html">M5Stackとその連絡先</a></li>
<li><a href="../ja492244/index.html">コロナウイルスの期間の除去：家庭の「逮捕」または機会の時間？</a></li>
<li><a href="../ja492246/index.html">コロナウイルス：社会、経済、医学への影響の可能性</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>