<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔠 👻 🚬 "こんにちは世界" ターミナルに深く浸る 📬 ◻️ 📣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私はこの記事を、Sishny printfの分析に関する記事に触発されました。ただし、データが端末デバイスに入った後、データがどのように進むかについては、一瞬見逃されていました。この記事では、この欠陥を修正し、ターミナルのデータパスを分析したいと思います。また、ターミナルがシェルとどのように異なるか...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>"こんにちは世界" ターミナルに深く浸る</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460257/"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/ha/5f/0v/ha5f0vjiijc9c92bnnt56z7jcpg.jpeg"></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はこの記事を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Sishny printfの分析に関する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事に触発されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ただし、データが端末デバイスに入った後、データがどのように進むかについては、一瞬見逃されていました。</font><font style="vertical-align: inherit;">この記事では、この欠陥を修正し、ターミナルのデータパスを分析したいと思います。</font><font style="vertical-align: inherit;">また、ターミナルがシェルとどのように異なるか、疑似ターミナルとは何か、ターミナルエミュレータがどのように機能するかなどについても説明します。</font></font></p><a name="habracut"></a><br>
<h2 id="osnovy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基礎</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、ターミナル、シェル、コンソールが何であるか、ターミナルエミュレータが通常のターミナルとどのように異なるのか、なぜそのように命名されているのかを理解しましょう。</font><font style="vertical-align: inherit;">これについてはかなり多くの情報がすでに書かれているので、ここでは新しいことは何も聞こえません。</font><font style="vertical-align: inherit;">ここにあるほとんどすべての情報はインターネットから取得したものです。記事の最後にリンクを提供します。</font><font style="vertical-align: inherit;">これらすべての意味をすでに知っている人は、このセクションを安全にスキップできます。</font></font></p><br>
<hr><br>
<h3 id="terminal"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ターミナル</font></font></h3><br>
<p><strong>Terminal ()</strong> —     ,    .  ,      ,       teleprinter (teletype, teletypewriter  TTY ),      .          .             ,     ,   .     ,        (terminal end).</p><br>
<p> <strong>Teletype</strong>:</p><br>
<img src="https://habrastorage.org/webt/m3/_3/yt/m3_3ytmmoofzwgpr3dpu78w8m7i.jpeg" alt="テレタイプ" title="テレタイプ" width="430" height="370"><br>
<br>
<p>  <strong>Terminal</strong>:</p><br>
<img src="https://habrastorage.org/webt/pz/lj/eu/pzljeumccjvqmrunt-pqolnyx-c.jpeg" alt="ターミナル" title="ターミナル" width="430" height="370"><br>
<br>
<hr><br>
<h3 id="console">Console</h3><br>
<p><strong>Console ()</strong> — ,     .   ,      ,         .        ,      .</p><br>
<hr><br>
<h3 id="shell">Shell</h3><br>
<p>      ,        .</p><br>
<p><strong>Shell</strong> —  command line interpreter.   —   .     Shell'.    Bash ( . Bourne Again SHell,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,    «Born again» Shell,   «» Shell).  : Dash ( Shell, ,      /bin/sh), Zsh.</p><br>
<hr><br>
<p> ,  ,          .      ,  <em>Terminal Emulator</em>  <em>Virtual Console</em>.</p><br>
<h3 id="terminal-emulator">Terminal Emulator</h3><br>
<p><strong>Terminal Emulator</strong> —    .     ,       X Window System — Bash, Vim  .</p><br>
<p>     :</p><br>
<ol>
<li>    </li>
<li>    </li>
</ol><br>
<p>   Terminal Emulator     :       ,       .   ,   —     ,  - ,   /.  Terminal Emulator: gnome-terminal, xterm, konsole.</p><br>
<p><strong>   Shell  Terminal Emulator!</strong><br>
Terminal Emulator — GUI ,     X Window System. Shell —  command line interpreter,     ,     .    ,  <strong>  Bash</strong>,  <strong> Terminal Emulator,     Bash</strong>. Terminal Emulator  Bash —  2  .     /,  —   .</p><br>
<p>          .</p><br>
<hr><br>
<h3 id="virtual-console-virtual-terminal">Virtual Console (Virtual Terminal)</h3><br>
<p> Ctrl+Alt+FN,  N, ,    1  6. ,     —  Virtual Console ( )  Virtual Terminal ( ). ,      ?             ,   . Virtual Console   :         (,    , , ). </p><br>
<p>      Virtual Console,   Virtual Terminal,    ,  —  ,    ,       -     .</p><br>
<hr><br>
<h3 id="tty-ustroystva">TTY </h3><br>
<p>    <em>TTY </em> ( ),    .       ,   TTY     .</p><br>
<p>TTY      :</p><br>
<ol>
<li><strong> </strong>.                .</li>
<li><strong>TTY Line Discipline</strong> (. —  ).   —     , , ,     TTY .  ,       .     ,      .</li>
</ol><br>
<p> TTY :</p><br>
<p><img src="https://habrastorage.org/webt/zn/zw/dy/znzwdyjadyeidyogqoap8kfvgng.jpeg" title="TTYデバイスを構築する"></p><br>
<p> 3  TTY :</p><br>
<ol>
<li><em>Console device</em> —   Virtual Console.        .</li>
<li><em>PTY device</em> () —      .        ,     .</li>
<li><em>Serial device</em> —    .    ,           .</li>
</ol><br>
<p>          TTY  — .</p><br>
<hr><br>
<h2 id="tty-line-discipline">TTY Line Discipline</h2><br>
<p>    TTY .</p><br>
<p>      ,      /.    , ,    (. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" title="制御文字"> </a>)   . ,    ,   ,     -     —       .</p><br>
<p> ,   ,     Bash,   .   TTY        <em> (echoing)</em>.  —       .</p><br>
<p>  ,  ,  <code>a</code>,     TTY ,     TTY .       , ,    <code>echo</code>     .           ,     .    <code>backspace</code>  .  <code>^?</code>    ,  , ,       ,              . ,    Enter, TTY Line Discipline        ,        ,  LF.  ,     CR  LF  ,       —   .</p><br>
<p>    —          <code>Enter</code>,       .</p><br>
<h3 id="tty-line-editing">TTY Line Editing</h3><br>
<p><strong>TTY Line Editing</strong> —   ,        .  ,  <em>Line Editing</em> —         . , Bash  Vim   Line Editing.</p><br>
<p>       TTY     <strong>stty</strong>.   .</p><br>
<p> Bash    Shell  :</p><br>
<pre><code class="plaintext hljs">stty icanon -echo</code></pre><br>
<p>  -  —       ( ,        ).      —       .  : </p><br>
<pre><code class="plaintext hljs">stty raw echo</code></pre><br>
<p> - .  ,   .        Dash —  <code>/bin/sh</code>.      ( <code>Ctrl</code> +    )     <code>Enter</code>.   —       ?   ,  ,     Shell,  Line Editing     Line Editing Bash,        <em>raw</em>   .           .  raw  ? ,  <em>Vim</em>:           ,    ,            Vim.</p><br>
<p>        .      <code>stty &lt;control-character&gt; &lt;string&gt;</code>.<br>
  Bash:</p><br>
<pre><code class="bash hljs">stty erase 0</code></pre><br>
<p>   <code>erase</code>     <code>0</code>.  <code>backspace</code>    <code>^?</code>,           PTS   —  .          <code>0</code>  ,     tty line discipline       <code>erase</code>.         <code>stty erase ^\?</code>    ,       tty .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" title="男stty">man stty</a>.</p><br>
<hr><br>
<h2 id="terminal-emulator-i-pseudoterminal">Terminal Emulator  Pseudoterminal</h2><br>
<p> ,       X Window System, GNOME Terminal Server           . ,  - Shell (, Bash). </p><br>
<p>        <strong>Pseudoterminal</strong> (, PTY).     ,       —   .</p><br>
<p>     <em> TTY </em>:<br>
1) <strong>PTY master (PTM)</strong> —   .  GNOME Terminal Server          ,           . GNOME Terminal Server      X Window System  X .<br>
2) <strong>PTY slave (PTS)</strong> —   .  ,   ,          .   ,     (,   ,  ).</p><br>
<p> ,   PTS ,   PTM ,        PTM .  :  ,   PTM ,   PTS .       GNOME Terminal Server     .  PTM    PTS .</p><br>
<p>       :<br>
1) GNOME Terminal Server  master  slave      open()    <strong>/dev/ptmx</strong>.  open()     PTM  — <em>master_fd</em>.<br>
2) GNOME Terminal Server        <code>fork()</code>.       .<br>
3)   PTS      0, 1, 2 (stdin, stdout  stderr ).    /     .<br>
4)          <code>exec()</code>.   - Shell (, Bash).  ,    Bash,      ,    Bash,        PTS .</p><br>
<p>   ,      ,    <code>ls -la /proc/self/fd</code>:<br>
<img src="https://habrastorage.org/webt/nr/dx/97/nrdx97wllflvapnt76p3qqki3fw.jpeg"></p><br>
<p>PTS     <strong>/dev/pts/N</strong>,    PTM     .   ,  GNOME Terminal Server      PTM        ,        PTS          <code>open()</code>,     .</p><br>
<p>,  ,  ,  PTS ,  ,      ?   ,  PTS   <em> </em> (TTY ),    PTS    TTY   ,  PTS      ,   master ,      ,   master .      —    (??) .        ,    —    ,       ,       .</p><br>
<p>,  <em>PTS   TTY </em> —   .  :</p><br>
<ol>
<li>,     ,     . :  , /  .</li>
<li>, ,       (,     ),          . ,    .</li>
<li>   TTY Line Discipline,         ,     ,     .</li>
</ol><br>
<p>PTM    TTY ,      ,         .  ,   PTM    raw ,       PTS  PTM   . ,  <code>read()</code>  <code>write()</code>            .      ,    .</p><br>
<p>  GNOME Terminal Server        :</p><br>
<p><img src="https://habrastorage.org/webt/jz/y0/sg/jzy0sg0zjcceaflg6wyg7d5lkti.jpeg" title="GNOMEターミナルサーバーとターミナル内で実行されているプログラムとの通信プロセス"></p><br>
<p>   ,          .       , <em>  PTM  PTS </em>,           .      PTS ,     PTM ,  .</p><br>
<hr><br>
<h2 id="virtualnye-ustroystva"> </h2><br>
<p>, ,  ,       <em>/dev/pts/N</em>       ,     ? ,    Unix-       Unix,  ,    . ,     (. — device file)    .    <strong> </strong> (virtual device) —      ,    .</p><br>
<p>         . ,        <code>write()</code>  <code>read()</code>,     .    . </p><br>
<p>         <code>tty</code>.   ,  TTY     .   <code>echo "Hello, World!" &gt; /dev/pts/N</code>    ,  N —   PTS   ,     —        .      PTS    , <em>     ,    </em>.</p><br>
<p><img src="https://habrastorage.org/webt/nj/3s/rp/nj3srpuzyahyvukzicfr0b5wnja.png"></p><br>
<hr><br>
<h2 id="ustroystvo-psevdoterminala"> </h2><br>
<p>       ,     " " Linux —      .   ,          ,      .</p><br>
<p>     " ".     ,             . ,       . .</p><br>
<p> Linux ,     .       .       :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __init pty_init(<span class="hljs-keyword">void</span>)<font></font>
{<font></font>
    legacy_pty_init();<font></font>
    unix98_pty_init(); <span class="hljs-comment">// &lt;- ,   </span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
device_initcall(pty_init); <span class="hljs-comment">// ,      </span></code></pre><br>
<p>       <code>unix98_pty_init()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __init unix98_pty_init(<span class="hljs-keyword">void</span>)<font></font>
{<font></font>
    ptm_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,<font></font>
            TTY_DRIVER_RESET_TERMIOS |<font></font>
            TTY_DRIVER_REAL_RAW |<font></font>
            TTY_DRIVER_DYNAMIC_DEV |<font></font>
            TTY_DRIVER_DEVPTS_MEM |<font></font>
            TTY_DRIVER_DYNAMIC_ALLOC);<font></font>
    <span class="hljs-keyword">if</span> (IS_ERR(ptm_driver))<font></font>
        panic(<span class="hljs-string">"Couldn't allocate Unix98 ptm driver"</span>);<font></font>
    pts_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,<font></font>
            TTY_DRIVER_RESET_TERMIOS |<font></font>
            TTY_DRIVER_REAL_RAW |<font></font>
            TTY_DRIVER_DYNAMIC_DEV |<font></font>
            TTY_DRIVER_DEVPTS_MEM |<font></font>
            TTY_DRIVER_DYNAMIC_ALLOC);<font></font>
    <span class="hljs-keyword">if</span> (IS_ERR(pts_driver))<font></font>
        panic(<span class="hljs-string">"Couldn't allocate Unix98 pts driver"</span>);<font></font>
<font></font>
    ptm_driver-&gt;driver_name = <span class="hljs-string">"pty_master"</span>;<font></font>
    ptm_driver-&gt;name = <span class="hljs-string">"ptm"</span>;<font></font>
    ptm_driver-&gt;major = UNIX98_PTY_MASTER_MAJOR;<font></font>
    ptm_driver-&gt;minor_start = <span class="hljs-number">0</span>;<font></font>
    ptm_driver-&gt;type = TTY_DRIVER_TYPE_PTY;<font></font>
    ptm_driver-&gt;subtype = PTY_TYPE_MASTER;<font></font>
    ptm_driver-&gt;init_termios = tty_std_termios;<font></font>
    ptm_driver-&gt;init_termios.c_iflag = <span class="hljs-number">0</span>;<font></font>
    ptm_driver-&gt;init_termios.c_oflag = <span class="hljs-number">0</span>;<font></font>
    ptm_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;<font></font>
    ptm_driver-&gt;init_termios.c_lflag = <span class="hljs-number">0</span>;<font></font>
    ptm_driver-&gt;init_termios.c_ispeed = <span class="hljs-number">38400</span>;<font></font>
    ptm_driver-&gt;init_termios.c_ospeed = <span class="hljs-number">38400</span>;<font></font>
    ptm_driver-&gt;other = pts_driver;<font></font>
    tty_set_operations(ptm_driver, &amp;ptm_unix98_ops);<font></font>
<font></font>
    pts_driver-&gt;driver_name = <span class="hljs-string">"pty_slave"</span>;<font></font>
    pts_driver-&gt;name = <span class="hljs-string">"pts"</span>;<font></font>
    pts_driver-&gt;major = UNIX98_PTY_SLAVE_MAJOR;<font></font>
    pts_driver-&gt;minor_start = <span class="hljs-number">0</span>;<font></font>
    pts_driver-&gt;type = TTY_DRIVER_TYPE_PTY;<font></font>
    pts_driver-&gt;subtype = PTY_TYPE_SLAVE;<font></font>
    pts_driver-&gt;init_termios = tty_std_termios;<font></font>
    pts_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;<font></font>
    pts_driver-&gt;init_termios.c_ispeed = <span class="hljs-number">38400</span>;<font></font>
    pts_driver-&gt;init_termios.c_ospeed = <span class="hljs-number">38400</span>;<font></font>
    pts_driver-&gt;other = ptm_driver;<font></font>
    tty_set_operations(pts_driver, &amp;pty_unix98_ops);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (tty_register_driver(ptm_driver))<font></font>
        panic(<span class="hljs-string">"Couldn't register Unix98 ptm driver"</span>);
    <span class="hljs-keyword">if</span> (tty_register_driver(pts_driver))<font></font>
        panic(<span class="hljs-string">"Couldn't register Unix98 pts driver"</span>);<font></font>
<font></font>
    <span class="hljs-comment">/* Now create the /dev/ptmx special device */</span><font></font>
    tty_default_fops(&amp;ptmx_fops);<font></font>
    ptmx_fops.open = ptmx_open;<font></font>
<font></font>
    cdev_init(&amp;ptmx_cdev, &amp;ptmx_fops);<font></font>
    <span class="hljs-keyword">if</span> (cdev_add(&amp;ptmx_cdev, <span class="hljs-built_in">MKDEV</span>(TTYAUX_MAJOR, <span class="hljs-number">2</span>), <span class="hljs-number">1</span>) ||<font></font>
        register_chrdev_region(<span class="hljs-built_in">MKDEV</span>(TTYAUX_MAJOR, <span class="hljs-number">2</span>), <span class="hljs-number">1</span>, <span class="hljs-string">"/dev/ptmx"</span>) &lt; <span class="hljs-number">0</span>)<font></font>
        panic(<span class="hljs-string">"Couldn't register /dev/ptmx driver"</span>);<font></font>
    device_create(tty_class, <span class="hljs-literal">NULL</span>, <span class="hljs-built_in">MKDEV</span>(TTYAUX_MAJOR, <span class="hljs-number">2</span>), <span class="hljs-literal">NULL</span>, <span class="hljs-string">"ptmx"</span>);</code></pre><br>
<p>   3 : </p><br>
<ol>
<li> <code>tty_set_operatons</code>   pty master  pty slave .</li>
<li> <code>ptmx_open</code>,            <em>/dev/ptmx</em>. : /dev/ptmx —   PTM ,        .</li>
<li>  PTM  PTS .</li>
</ol><br>
<p>  :</p><br>
<h4 id="1-tty_set_operations">1. tty_set_operations</h4><br>
<p> <strong>tty_set_operations()</strong>        :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">void</span> tty_set_operations(<span class="hljs-keyword">struct</span> tty_driver *driver,
            <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations *op)<font></font>
{<font></font>
    driver-&gt;ops = op;<font></font>
};</code></pre><br>
<p> <strong>tty_operations</strong> —   ,        TTY .</p><br>
<p>     <code>pty_unix98_ops</code>  <code>ptm_unix98_ops</code>,        :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations ptm_unix98_ops = {<font></font>
    .install = pty_unix98_install,<font></font>
    .remove = pty_unix98_remove,<font></font>
    .open = pty_open,<font></font>
    .close = pty_close,<font></font>
    .write = pty_write,<font></font>
    <span class="hljs-comment">// ...</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations pty_unix98_ops = {<font></font>
    .install = pty_unix98_install,<font></font>
    .remove = pty_unix98_remove,<font></font>
    .open = pty_open,<font></font>
    .close = pty_close,<font></font>
    .write = pty_write,<font></font>
    <span class="hljs-comment">// ...</span>
};</code></pre><br>
<p>         printf  <code>pty_write</code> —      .</p><br>
<p>       :<br>
<img src="https://habrastorage.org/webt/o8/e-/kc/o8e-kcpqestn7f481gcx38qmzuo.jpeg"></p><br>
<p> ,       . , ,     read()  —     <code>pty_read()</code>.   ,       .  ,         —    TTY .</p><br>
<hr><br>
<h4 id="2-ptmx_open">2. ptmx_open</h4><br>
<p>   <strong>ptmx_open()</strong>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> ptmx_open(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *filp)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_struct *tty; <span class="hljs-comment">//    -   !</span>
    fsi = devpts_acquire(filp); <span class="hljs-comment">//     devpts</span><font></font>
<font></font>
    index = devpts_new_index(fsi); <span class="hljs-comment">//       /dev/pts</span>
    <span class="hljs-comment">// ...</span><font></font>
    tty = tty_init_dev(ptm_driver, index);<font></font>
    <span class="hljs-comment">// ...</span>
    devpts_pty_new(fsi, index, tty-&gt;link); <span class="hljs-comment">//     /dev/pts</span><font></font>
<font></font>
    retval = ptm_driver-&gt;ops-&gt;open(tty, filp); <span class="hljs-comment">//  PTM ,  </span>
}</code></pre><br>
<p>   <code>tty_init_dev()</code>,      PTM ,   —  .      PTY     ,      TTY        .</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">struct</span> tty_struct *tty_init_dev(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">int</span> idx)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_struct *tty;<font></font>
    tty = alloc_tty_struct(driver, idx);<font></font>
<font></font>
    retval = tty_driver_install_tty(driver, tty);<font></font>
<font></font>
    <span class="hljs-comment">/*
     * Structures all installed ... call the ldisc open routines.
     */</span>
    retval = tty_ldisc_setup(tty, tty-&gt;link); <span class="hljs-comment">//  ,      </span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> tty;<font></font>
}</code></pre><br>
<p>   <code>alloc_tty_struct()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">struct</span> tty_struct *alloc_tty_struct(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">int</span> idx)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_struct *tty;<font></font>
<font></font>
    tty = kzalloc(<span class="hljs-keyword">sizeof</span>(*tty), GFP_KERNEL); <span class="hljs-comment">//  tty_struct</span><font></font>
<font></font>
    tty_ldisc_init(tty) <span class="hljs-comment">//      tty_struct</span><font></font>
<font></font>
    tty-&gt;driver = driver; <span class="hljs-comment">//       tty_struct</span>
    tty-&gt;ops = driver-&gt;ops;  <span class="hljs-comment">//        tty_struct.    </span>
    tty-&gt;index = idx; <span class="hljs-comment">//   tty </span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> tty;<font></font>
}</code></pre><br>
<p>,    ,   <code>tty_ldisc_init()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">int</span> tty_ldisc_init(<span class="hljs-keyword">struct</span> tty_struct *tty)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_ldisc *ld = tty_ldisc_get(tty, N_TTY);
    <span class="hljs-keyword">if</span> (IS_ERR(ld))
        <span class="hljs-keyword">return</span> PTR_ERR(ld);<font></font>
    tty-&gt;ldisc = ld; <span class="hljs-comment">//        tty_struct</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>  <code>tty_ldisc_get()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> tty_ldisc *tty_ldisc_get(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">int</span> disc)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_ldisc *ld; <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">struct</span> tty_ldisc_ops *ldops; <span class="hljs-comment">//    </span><font></font>
<font></font>
    ldops = get_ldops(disc); <span class="hljs-comment">//      .   ,       .   - N_TTY</span><font></font>
<font></font>
    ld = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_ldisc), GFP_KERNEL | __GFP_NOFAIL);<font></font>
    ld-&gt;ops = ldops; <span class="hljs-comment">//      </span>
    ld-&gt;tty = tty; <span class="hljs-comment">//    tty_struct   .         </span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> ld;<font></font>
}</code></pre><br>
<p>,     <code>alloc_tty_struct()</code>,    <em>tty_struct</em>     —  <em>tty_ldisc</em>.       .      .</p><br>
<ul>
<li><strong>tty_struct</strong> —       TTY     .    :</li>
</ul><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">struct</span> tty_struct {
    <span class="hljs-keyword">struct</span> tty_driver *driver; <span class="hljs-comment">//  TTY </span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations *ops; <span class="hljs-comment">//  .    ,   driver-&gt;ops,      </span>
    <span class="hljs-keyword">int</span> index; <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">struct</span> tty_ldisc *ldisc; <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">struct</span> tty_struct *link; <span class="hljs-comment">//     PTY</span>
    <span class="hljs-comment">// ...</span>
}</code></pre><br>
<ul>
<li><strong>tty_ldisc</strong> —      TTY .          :</li>
</ul><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">struct</span> tty_ldisc {
    <span class="hljs-keyword">struct</span> tty_ldisc_ops *ops; <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">struct</span> tty_struct *tty; <span class="hljs-comment">//   tty_struct  .      </span>
};</code></pre><br>
<p>   ?                 ,     :<br>
<img src="https://habrastorage.org/webt/1d/bt/n4/1dbtn4m_6c6i4n7oaohoguci2m0.jpeg" alt="tty_structをビルドする" title="tty_structをビルドする"></p><br>
<p>   tty_struct    PTM .     PTS ?      <code>tty_init_dev()</code>    ,       <code>tty_driver_install_tty()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-comment">/**
 * This method is responsible
 * for ensuring any need additional structures are allocated and configured. 
*/</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> tty_driver_install_tty(<span class="hljs-keyword">struct</span> tty_driver *driver,
                        <span class="hljs-keyword">struct</span> tty_struct *tty)<font></font>
{<font></font>
    <span class="hljs-keyword">return</span> driver-&gt;ops-&gt;install ? driver-&gt;ops-&gt;install(driver, tty) :<font></font>
        tty_standard_install(driver, tty);<font></font>
}</code></pre><br>
<p>  ,         . PTS       . ,      ,  ,  ,  ,    -  !      ,    —    - ,    . ,    <em>driver-&gt;ops-&gt;install</em>?        PTM   :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations ptm_unix98_ops = {<font></font>
    .install = pty_unix98_install,<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br>
<p> ,     <code>pty_unix98_install()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> pty_unix98_install(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty)<font></font>
{<font></font>
    <span class="hljs-keyword">return</span> pty_common_install(driver, tty, <span class="hljs-literal">false</span>);<font></font>
}</code></pre><br>
<p>   <code>pty_common_install()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> pty_common_install(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty,
        <span class="hljs-keyword">bool</span> legacy)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_struct *o_tty; <span class="hljs-comment">// tty_struct    PTY -    PTS </span><font></font>
<font></font>
    <span class="hljs-comment">//    ,       install.   ,   PTM     tty_struct,       </span>
    <span class="hljs-keyword">if</span> (driver-&gt;subtype != PTY_TYPE_MASTER) 
        <span class="hljs-keyword">return</span> -EIO;<font></font>
<font></font>
    o_tty = alloc_tty_struct(driver-&gt;other, idx);<font></font>
<font></font>
    tty-&gt;link   = o_tty;<font></font>
    o_tty-&gt;link = tty;<font></font>
}</code></pre><br>
<p> ,   PTS       <em>tty_struct</em>   ,       PTS .           .  tty_struct  PTS    .</p><br>
<hr><br>
<h4 id="registraciya-drayvera"> </h4><br>
<p>       ,           TTY  (   -         ?).<br>
 —  ,       PTM,   PTS :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> file_operations tty_fops = {<font></font>
    .llseek     = no_llseek,<font></font>
    .read       = tty_read,<font></font>
    .write      = tty_write,<font></font>
    .poll       = tty_poll,<font></font>
    .unlocked_ioctl = tty_ioctl,<font></font>
    .compat_ioctl   = tty_compat_ioctl,<font></font>
    .open       = tty_open,<font></font>
    .release    = tty_release,<font></font>
    .fasync     = tty_fasync,<font></font>
    .show_fdinfo    = tty_show_fdinfo,<font></font>
};</code></pre><br>
<p>        ,                  TTY .</p><br>
<hr><br>
<p>.      ,       <em>/dev/ptmx</em>.  ,   PTS ,      ,   PTM ,      :</p><br>
<p><img src="https://habrastorage.org/webt/5w/aw/rg/5wawrgbqqw1_llmi1r8g2kbwrzc.jpeg" title="PTYを構築する"></p><br>
<hr><br>
<h2 id="hello-world">Hello, World!</h2><br>
<p>       .          "Hello, World!",        .</p><br>
<pre><code class="objectivec hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">void</span> main() {<font></font>
    printf(<span class="hljs-string">"Hello, World!\n"</span>);<font></font>
}</code></pre><br>
<p>,   "Hello, World!"    .   ,    ,  ,       .    ,    .  stdout  <em>/dev/null</em> —       .          ,       Linux.</p><br>
<p>     Unix        <em>write()</em>, <em>read()</em>, <em>close()</em>  ,    write()  /dev/pts/0         <code>__vfs_write()</code>:</p><br>
<pre><code class="objectivec hljs">ssize_t __vfs_write(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *buf, size_t count, loff_t *pos)<font></font>
{<font></font>
    ssize_t ret;<font></font>
<font></font>
    <span class="hljs-comment">//...</span><font></font>
    ret = file-&gt;f_op-&gt;write(file, buf, count, pos);<font></font>
    <span class="hljs-comment">//...</span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> ret;<font></font>
}</code></pre><br>
<p>    write()      .   ,            :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> file_operations tty_fops = {
    <span class="hljs-comment">// ...</span><font></font>
    .write = tty_write,<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br>
<p> <code>tty_write()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> ssize_t tty_write(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *buf,<font></font>
                        size_t count, loff_t *ppos)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_struct *tty = file_tty(file);
    <span class="hljs-keyword">struct</span> tty_ldisc *ld;<font></font>
    ssize_t ret;<font></font>
<font></font>
    ld = tty_ldisc_ref_wait(tty);<font></font>
    ret = do_tty_write(ld-&gt;ops-&gt;write, tty, file, buf, count);<font></font>
    tty_ldisc_deref(ld);<font></font>
    <span class="hljs-keyword">return</span> ret;<font></font>
}</code></pre><br>
<p>    <em>tty_struct</em>    TTY ,           write()  .       :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> tty_ldisc_ops n_tty_ops = {<font></font>
    .write           = n_tty_write,<font></font>
    <span class="hljs-comment">// ...</span>
};</code></pre><br>
<p>   <code>n_tty_write()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-comment">/**
 *  n_tty_write     -   write function for tty
 *  @tty: tty device
 *  @file: file object
 *  @buf: userspace buffer pointer
 *  @nr: size of I/O
 */</span>
<span class="hljs-keyword">static</span> ssize_t n_tty_write(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> file *file,
               <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, size_t nr)<font></font>
{<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *b = buf; <span class="hljs-comment">// b - ,       "Hello, World!".         </span>
    <span class="hljs-keyword">int</span> c; <span class="hljs-comment">//   </span><font></font>
<font></font>
    <span class="hljs-comment">//     PTS ,  write()    0,  ,    </span>
    <span class="hljs-keyword">while</span> (nr &gt; <span class="hljs-number">0</span>) {<font></font>
        c = tty-&gt;ops-&gt;write(tty, b, nr); <span class="hljs-comment">//  write()       TTY </span>
        <span class="hljs-keyword">if</span> (!c)
            <span class="hljs-keyword">break</span>;<font></font>
        b += c; <span class="hljs-comment">//    </span>
        nr -= c; <span class="hljs-comment">//      :  -  -  - </span><font></font>
    }<font></font>
}</code></pre><br>
<p>,  "Hello, World!"    write()   PTS .       :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> tty_operations pty_unix98_ops = {<font></font>
    .write = pty_write,<font></font>
        <span class="hljs-comment">// ...</span>
}</code></pre><br>
<p> <code>pty_write()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> pty_write(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> c)<font></font>
{<font></font>
  <span class="hljs-keyword">struct</span> tty_struct *to = tty-&gt;link; <span class="hljs-comment">//      PTY.    -  PTM </span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">//    PTM </span><font></font>
    c = tty_insert_flip_string(to-&gt;port, buf, c);<font></font>
    <span class="hljs-comment">//     ,      </span>
    <span class="hljs-keyword">if</span> (c) { <font></font>
      tty_flip_buffer_push(to-&gt;port);<font></font>
      tty_wakeup(tty);<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> c;<font></font>
}</code></pre><br>
<p>         :</p><br>
<pre><code class="objectivec hljs">        __vfs_write() -&gt; <span class="hljs-comment">// 1- :  </span><font></font>
                tty_write() -&gt;<font></font>
                        do_tty_write() -&gt;<font></font>
                                n_tty_write() -&gt; <span class="hljs-comment">// 2- :  </span>
                                        pty_write() <span class="hljs-comment">// 3- : </span></code></pre><br>
<p>    . ,       PTM . ,    .</p><br>
<p> ,          <em>flip buffer</em>. <strong>Flip buffer</strong> —   ,    .  tty driver   ,      .   ,              .      ,        ,       .     ,      ,            .  -        flip buffer —       (,    -  ,         flip).</p><br>
<p>         ,       .  <code>tty_insert_flip_string()</code>         <code>tty_insert_flip_string_fixed_flag()</code>,           PTM :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">int</span> tty_insert_flip_string_fixed_flag(<span class="hljs-keyword">struct</span> tty_port *port,
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *chars, <span class="hljs-keyword">char</span> flag, size_t size)<font></font>
{<font></font>
    <span class="hljs-keyword">int</span> copied = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">int</span> goal = min_t(size_t, size - copied, TTY_BUFFER_PAGE); <span class="hljs-comment">//     </span>
        <span class="hljs-keyword">int</span> space = __tty_buffer_request_room(port, goal, flags); <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">struct</span> tty_buffer *tb = port-&gt;buf.tail; <span class="hljs-comment">//      </span>
        <span class="hljs-keyword">if</span> (unlikely(space == <span class="hljs-number">0</span>))
            <span class="hljs-keyword">break</span>;<font></font>
        memcpy(char_buf_ptr(tb, tb-&gt;used), chars, space); <span class="hljs-comment">//     </span><font></font>
        tb-&gt;used += space;<font></font>
        copied += space;<font></font>
        chars += space;<font></font>
        <span class="hljs-comment">/* There is a small chance that we need to split the data over
           several buffers. If this is the case we must loop */</span>
    } <span class="hljs-keyword">while</span> (unlikely(size &gt; copied));
    <span class="hljs-keyword">return</span> copied;<font></font>
}</code></pre><br>
<p>  , flip buffer        ,       ,         .        ,   —        PTM ,             . </p><br>
<p>,   "Hello, World!"   PTM .    GNOME Terminal Server    <em>poll()</em> (  I/O)        master .  ,         ?    .      ,     ,      —        .</p><br>
<p>           <code>tty_flip_buffer_push()</code> (   pty_write):</p><br>
<pre><code class="objectivec hljs"><span class="hljs-comment">/**
 *  tty_flip_buffer_push    -   terminal
 *  @port: tty port to push
 *
 *  Queue a push of the terminal flip buffers to the line discipline.
 *  Can be called from IRQ/atomic context.
 *
 *  In the event of the queue being busy for flipping the work will be
 *  held off and retried later.
 */</span><font></font>
<font></font>
<span class="hljs-keyword">void</span> tty_flip_buffer_push(<span class="hljs-keyword">struct</span> tty_port *port)<font></font>
{<font></font>
    tty_schedule_flip(port);<font></font>
}</code></pre><br>
<p> <code>tty_schedule_flip()</code>,   ,        :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-comment">/**
 *  tty_schedule_flip   -   push characters to ldisc
 *  @port: tty port to push from
 *
 *  Takes any pending buffers and transfers their ownership to the
 *  ldisc side of the queue. It then schedules those characters for
 *  processing by the line discipline.
 */</span><font></font>
<font></font>
<span class="hljs-keyword">void</span> tty_schedule_flip(<span class="hljs-keyword">struct</span> tty_port *port)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_bufhead *buf = &amp;port-&gt;buf;<font></font>
<font></font>
    <span class="hljs-comment">/* paired w/ acquire in flush_to_ldisc(); ensures
     * flush_to_ldisc() sees buffer data.
     */</span><font></font>
    smp_store_release(&amp;buf-&gt;tail-&gt;commit, buf-&gt;tail-&gt;used);<font></font>
    queue_work(system_unbound_wq, &amp;buf-&gt;work);<font></font>
}</code></pre><br>
<p>  ,     <em>work</em> (,   -       )       ,      —    ,    <code>flush_to_ldisc()</code>:</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> flush_to_ldisc(<span class="hljs-keyword">struct</span> work_struct *work)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> tty_port *port = container_of(work, <span class="hljs-keyword">struct</span> tty_port, buf.work); <span class="hljs-comment">//   tty_port PTM . tty_port -       TTY </span>
    <span class="hljs-keyword">struct</span> tty_bufhead *buf = &amp;port-&gt;buf;
    <span class="hljs-keyword">struct</span> tty_buffer *head = buf-&gt;head;
    <span class="hljs-comment">// ...</span><font></font>
    receive_buf(port, head);<font></font>
    <span class="hljs-comment">// ...</span>
}</code></pre><br>
<p> <code>receive_buf()</code>          <code>__receive_buf()</code>,      :</p><br>
<pre><code class="objectivec hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __receive_buf(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *cp,
              <span class="hljs-keyword">char</span> *fp, <span class="hljs-keyword">int</span> count)<font></font>
{<font></font>
    <span class="hljs-keyword">struct</span> n_tty_data *ldata = tty-&gt;disc_data;
    <span class="hljs-keyword">bool</span> preops = I_ISTRIP(tty) || (I_IUCLC(tty) &amp;&amp; L_IEXTEN(tty));<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ldata-&gt;real_raw)<font></font>
        n_tty_receive_buf_real_raw(tty, cp, fp, count);<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ldata-&gt;raw || (L_EXTPROC(tty) &amp;&amp; !preops))<font></font>
        n_tty_receive_buf_raw(tty, cp, fp, count);<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tty-&gt;closing &amp;&amp; !L_EXTPROC(tty))<font></font>
        n_tty_receive_buf_closing(tty, cp, fp, count);<font></font>
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (ldata-&gt;lnext) {
            <span class="hljs-keyword">char</span> flag = TTY_NORMAL;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (fp)<font></font>
                flag = *fp++;<font></font>
            n_tty_receive_char_lnext(tty, *cp++, flag);<font></font>
            count--;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!preops &amp;&amp; !I_PARMRK(tty))<font></font>
            n_tty_receive_buf_fast(tty, cp, fp, count);<font></font>
        <span class="hljs-keyword">else</span><font></font>
            n_tty_receive_buf_standard(tty, cp, fp, count);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_cnt(ldata)) {<font></font>
        kill_fasync(&amp;tty-&gt;fasync, SIGIO, POLL_IN);<font></font>
        wake_up_interruptible_poll(&amp;tty-&gt;read_wait, EPOLLIN);<font></font>
    }<font></font>
}</code></pre><br>
<p> ,   <em>n_tty_receive_buf</em> ( ,    _raw)           <strong>read_buf</strong>,         TTY .      PTM    raw ,           read_buf. ,        PTM  PTS ,     .</p><br>
<p>      ,   :</p><br>
<pre><code class="objectivec hljs">    ...<font></font>
        pty_write() -&gt; <span class="hljs-comment">// 3- :  PTS </span><font></font>
                tty_insert_flip_string + tty_flip_buffer_push() -&gt;<font></font>
                        tty_schedule_flip() -&gt;<font></font>
            --- <span class="hljs-comment">//    PTM </span>
                flush_to_ldisc() -&gt; <span class="hljs-comment">// 2- :   PTM </span><font></font>
                        receive_buf() -&gt;<font></font>
                                n_tty_receive_buf -&gt;<font></font>
                                        n_tty_receive_buf_common -&gt;<font></font>
                                                __receive_buf()</code></pre><br>
<p>,   PTM        —         PTS .</p><br>
<p> :       PTM .  GNOME Terminal Server      "Hello, World!",  read()  PTM .  read()    write()    —  <code>n_tty_read()</code>.      ,  ,          — <em>read_buf</em> —   .  GNOME Terminal Server    X Server,     .</p><br>
<p> ,   "Hello, World!"   :</p><br>
<pre><code class="plaintext hljs"> -&gt; <font></font>
        PTY slave -&gt; <font></font>
                PTY master -&gt; <font></font>
                        GNOME-TERMINAl-SERVER -&gt; <font></font>
                                X Server -&gt;<font></font>
                                        -&gt; </code></pre><br>
<hr><br>
<h2 id="zaklyuchenie"></h2><br>
<p> .     :</p><br>
<ol>
<li>   </li>
<li>   </li>
<li>  TTY </li>
<li>  </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常のCプログラムから表示までのデータのパスは何ですか</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧いただきありがとうございます。</font><font style="vertical-align: inherit;">ご不明な点がございましたら、コメントでお気軽にお問い合わせください。</font></font></p><br>
<h3 id="istochniki"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出典</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux manページ</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://unix.stackexchange.com/q/96694/346664</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://unix.stackexchange.com/q/93531/346664</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://unix.stackexchange.com/q/117981/346664</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://askubuntu.com/q/506510</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.linusakesson.net/programming/tty/</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://spin0r.wordpress.com/2012/12/28/terminally-confused-part-seven/</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://habr.com/en/company/neobit/blog/330764/</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNIX環境での高度なプログラミング、第3版</font></font></li>
</ul><cut></cut></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460247/index.html">ELFのレシピ</a></li>
<li><a href="../ja460249/index.html">pwnable.kr 07を使用したタスクのソリューション-入力。pwntoolsを理解する</a></li>
<li><a href="../ja460251/index.html">人工的な愚かさ：私を助けなかったボット</a></li>
<li><a href="../ja460253/index.html">音声アシスタントのスキルを高める10の理由</a></li>
<li><a href="../ja460255/index.html">Node.jsのバックドア：理由、理由、方法</a></li>
<li><a href="../ja460259/index.html">UIおよびUXデザインとは何ですか？共通点と相違点は何ですか？</a></li>
<li><a href="../ja460261/index.html">アマゾン：25年間のeコマースの成功</a></li>
<li><a href="../ja460263/index.html">本当にスマートな検索を行う：ステップバイステップガイド</a></li>
<li><a href="../ja460265/index.html">Xcodeプロジェクトテンプレートを作成する</a></li>
<li><a href="../ja460273/index.html">最小のApple Payでの承認</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>