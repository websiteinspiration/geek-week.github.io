<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇🏼 🗳️ 🥨 ステロイドハイパーバイザー：FreeBSD + ZFS + cbsd 👩🏾‍🏭 🗃️ 🖼️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="このチュートリアルでは、FreeBSDをサーバー環境（レンタルハードウェアまたは独自のデータセンター）に手動で、またはAnsibleなどのオーケストレーションツールを使用してインストールすることがいかに簡単かつエレガントであるかを明らかにしたいと思います。ディスク暗号化、便利なスペース管理、コンテナ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ステロイドハイパーバイザー：FreeBSD + ZFS + cbsd</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479192/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このチュートリアルでは、FreeBSDをサーバー環境（レンタルハードウェアまたは独自のデータセンター）に手動で、またはAnsibleなどのオーケストレーションツールを使用してインストールすることがいかに簡単かつエレガントであるかを明らかにしたいと思います。</font><font style="vertical-align: inherit;">ディスク暗号化、便利なスペース管理、コンテナとフルVM向けのハイパーバイザー、便利で直感的なファイアウォール-これだけでなく、すぐに使用でき、適切なアプローチで構成するのに少し時間がかかります。</font></font></p><a name="habracut"></a><br>
<h4 id="ustanovka"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取り付け</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も単純なシナリオから始めましょう。</font><font style="vertical-align: inherit;">鉄片があるか、どこかにありますが、.iso（または.img）をCD-ROMまたはIPMIを使用してフィードできます。</font><font style="vertical-align: inherit;">またはさらに簡単です-ホスティング業者はインターフェースから直接mfsbsdイメージを提供します。</font><font style="vertical-align: inherit;">いずれの場合も、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mfsbsd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から起動し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></p><br>
<h4 id="linux-rescue-cd"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LinuxレスキューCD</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ホストが何らかの形でFreeBSDを提供しないことは起こりますが、Linux Rescueは提供します。</font><font style="vertical-align: inherit;">Linuxを起動し、mfsbsdディスクイメージをダウンロードして、ハードディスクにロールします。</font></font></p><br>
<p><code>root@rescue:~# wget https://mfsbsd.vx.sk/files/images/12/amd64/mfsbsd-12.1-RELEASE-amd64.img</code></p><br>
<pre><code class="plaintext hljs">root@rescue:~# dd if=mfsbsd-12.1-RELEASE-amd64.img of=/dev/sda bs=4M<font></font>
22+1 records in<font></font>
22+1 records out<font></font>
92307456 bytes (92 MB) copied, 0.386325 s, 239 MB/s</code></pre><br>
<p><code>root@rescue:~# reboot</code></p><br>
<h4 id="nastroyka-setevogo-adaptera"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークアダプターのセットアップ</font></font></h4><br>
<p> ,               IPMI/VNC/web.             ?      mfsbsd     .            SSH.     - FreeBSD    .</p><br>
<p>  .iso</p><br>
<p><code>root@ns312777:~ # fetch https://download.freebsd.org/ftp/releases/amd64/amd64/ISO-IMAGES/12.0/FreeBSD-12.0-RELEASE-amd64-dvd1.iso</code></p><br>
<p></p><br>
<p><code>root@ns312777:~ # mount -t cd9660 /dev/</code>mdconfig -f FreeBSD-12.0-RELEASE-amd64-dvd1.iso<code>/root/cd-rom</code></p><br>
<p> mfsbsd</p><br>
<p><code>root@ns312777:~ # fetch https://github.com/mmatuska/mfsbsd/archive/master.zip</code></p><br>
<p><code>root@ns312777:~ # unzip master.zip &amp;&amp; cd mfsbsd-master</code></p><br>
<p>  .   IP    <code>conf/rc.conf</code>  <code>conf/rc.conf.sample</code>.     <code>conf/authorized_keys</code>    .</p><br>
<p><code>root@ns312777:~/mfsbsd-master # ls -la conf/</code></p><br>
<pre><code class="plaintext hljs">total 55<font></font>
drwxr-xr-x  2 root  wheel    13 Dec  8 10:06 .<font></font>
drwxr-xr-x  7 root  wheel    13 Dec  8 10:11 ..<font></font>
-rw-r--r--  1 root  wheel   451 Dec  8 10:06 authorized_keys<font></font>
-rw-r--r--  1 root  wheel    50 Nov 30 22:54 authorized_keys.sample<font></font>
-rw-r--r--  1 root  wheel     3 Nov 30 22:54 boot.config.sample<font></font>
-rw-r--r--  1 root  wheel   156 Nov 30 22:54 hosts.sample<font></font>
-rw-r--r--  1 root  wheel   592 Nov 30 22:54 interfaces.conf.sample<font></font>
-rw-r--r--  1 root  wheel  1310 Nov 30 22:54 loader.conf.sample<font></font>
-rw-r--r--  1 root  wheel   739 Dec  8 10:06 rc.conf<font></font>
-rw-r--r--  1 root  wheel   689 Nov 30 22:54 rc.conf.sample<font></font>
-rw-r--r--  1 root  wheel    40 Nov 30 22:54 rc.local.sample<font></font>
-rw-r--r--  1 root  wheel   108 Nov 30 22:54 resolv.conf.sample<font></font>
-rw-r--r--  1 root  wheel   898 Nov 30 22:54 ttys.sample</code></pre><br>
<p>  !</p><br>
<p><code>root@ns312777:~/mfsbsd-master # make BASE=/root/cd-rom/usr/freebsd-dist</code></p><br>
<pre><code class="plaintext hljs">Extracting base and kernel ... done                                                                                    <font></font>
Removing selected files from distribution ... done                                                                     <font></font>
Installing configuration scripts and files ... done                                                                    <font></font>
Generating SSH host keys ... done                                                                                      <font></font>
Configuring boot environment ...x ./                                                                                   <font></font>
x ./linker.hints                                                                                                       <font></font>
x ./kernel                                                                                                             <font></font>
 done                                                                                                                  <font></font>
Installing pkgng ... done                                                                                              <font></font>
Compressing usr ... done                                                                                               <font></font>
Creating and compressing mfsroot ... done                                                                              <font></font>
Creating image file ...87072+0 records in                                                                              <font></font>
87072+0 records out                                                                                                    <font></font>
89161728 bytes transferred in 0.905906 secs (98422727 bytes/sec)                                                       <font></font>
87040+0 records in                                                                                                     <font></font>
87040+0 records out                                                                                                    <font></font>
89128960 bytes transferred in 0.877165 secs (101610229 bytes/sec)                                                      <font></font>
md3 created                                                                                                            <font></font>
md3p1 added                                                                                                            <font></font>
partcode written to md3p1                                                                                              <font></font>
bootcode written to md3                                                                                                <font></font>
md3p2 added                                                                                                            <font></font>
Calculated size of `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j': 80281600 bytes, 65 inodes                                                                                                                                                  <font></font>
Extent size set to 32768                                                                                               <font></font>
./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j: 76.6MB (156800 sectors) block size 32768, fragment size 4096                                                                                                                                    <font></font>
        using 1 cylinder groups of 76.56MB, 2450 blks, 256 inodes.                                                     <font></font>
super-block backups (for fsck -b #) at:                                                                                <font></font>
 64,                                                       <font></font>
Populating `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j'                                                              <font></font>
Image `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j' complete                                                          <font></font>
612+1 records in                                           <font></font>
612+1 records out                                          <font></font>
80281600 bytes transferred in 36.018812 secs (2228880 bytes/sec)                                                       <font></font>
<font></font>
 done                                                      <font></font>
</code></pre><br>
<h4 id="pochemu-mfsbsd"> mfsbsd?</h4><br>
<p>    FreeBSD     ,            . -  Linux rescue CD.      ,     FreeBSD    .</p><br>
<p> Linux rescue CD    .iso/.img     mfsbsd.</p><br>
<p><code>root@mfsbsd:~ # cd bin/</code></p><br>
<p> </p><br>
<pre><code class="plaintext hljs">root@mfsbsd:~/bin # gpart destroy -F /dev/ada0<font></font>
root@mfsbsd:~/bin # gpart destroy -F /dev/ada1</code></pre><br>
<p></p><br>
<p><code>root@mfsbsd:~/bin # ./destroygeom -d /dev/ada0 -d /dev/ada1</code></p><br>
<pre><code class="plaintext hljs">Destroying geom ada0:<font></font>
    Deleting partition 1 ... done<font></font>
    Deleting partition 2 ... done<font></font>
Destroying geom ada1:<font></font>
    Deleting partition 1 ... done<font></font>
    Deleting partition 2 ... done</code></pre><br>
<p>   .</p><br>
<pre><code class="plaintext hljs">root@mfsbsd:~/bin # ./zfsinstall <font></font>
Usage: ./zfsinstall [-h] -d geom_provider [-d geom_provider ...] [ -u dist_url ] [-r mirror|raidz] [-m mount_point] [-p zfs_pool_name] [-s swap_partition_size] [-z zfs_partition_size] [-c] [-C] [-l] [-4] [-A]</code></pre><br>
<p>..    3             .  ZFS       ,    .     ,    .</p><br>
<p><code>root@mfsbsd:~/bin # ./zfsinstall -d /dev/ada0 -d /dev/ada1 -d /dev/ada2 -r mirror -p zsys -z 25G</code></p><br>
<p>       </p><br>
<pre><code class="plaintext hljs">Fetching base files from: ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/12.0-RELEASE<font></font>
/tmp/base.txz                                          147 MB 3670 kBps    41s<font></font>
/tmp/kernel.txz                                         39 MB 2344 kBps    18s<font></font>
Creating GUID partitions on ada0 ... done<font></font>
Configuring ZFS bootcode on ada0 ... done<font></font>
=&gt;       40  937703008  ada0  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
<font></font>
Creating GUID partitions on ada1 ... done<font></font>
Configuring ZFS bootcode on ada1 ... done<font></font>
=&gt;       40  937703008  ada1  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
<font></font>
Creating GUID partitions on ada2 ... done<font></font>
Configuring ZFS bootcode on ada2 ... done<font></font>
=&gt;       40  937703008  ada2  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
<font></font>
Creating ZFS pool zsys on ada0p2 ada1p2 ada2p2 ... done<font></font>
Creating zsys root partition: ... done<font></font>
Creating zsys partitions: var tmp ... done<font></font>
Setting bootfs for zsys to zsys/root ... done<font></font>
NAME            USED  AVAIL  REFER  MOUNTPOINT<font></font>
zsys            712K  23.7G    88K  none<font></font>
zsys/root       264K  23.7G    88K  /mnt<font></font>
zsys/root/tmp    88K  23.7G    88K  /mnt/tmp<font></font>
zsys/root/var    88K  23.7G    88K  /mnt/var<font></font>
Extracting FreeBSD distribution ... done<font></font>
Writing /boot/loader.conf... done<font></font>
Writing /etc/fstab...Writing /etc/rc.conf... done<font></font>
Copying /boot/zfs/zpool.cache ... done<font></font>
<font></font>
Installation complete.<font></font>
The system will boot from ZFS with clean install on next reboot<font></font>
<font></font>
You may make adjustments to the installed system using chroot:<font></font>
chroot /mnt<font></font>
<font></font>
Some adjustments may require a mounted devfs:<font></font>
mount -t devfs devfs /mnt/dev<font></font>
<font></font>
WARNING - Don't export ZFS pool "zsys"!<font></font>
</code></pre><br>
<p> ,       <code>/mnt/</code>,         :</p><br>
<p>     mfsbsd   </p><br>
<p><code>root@mfsbsd:~/bin # mkdir /mnt/root/.ssh &amp;&amp; cp /root/.ssh/authorized_keys /mnt/root/.ssh/</code></p><br>
<p>  SSH (    <del>  </del>)</p><br>
<p><code>root@mfsbsd:~/bin # ee /mnt/etc/ssh/sshd_config</code></p><br>
<p>  "" </p><br>
<p><code>root@mfsbsd:~/bin # ee /mnt/etc/rc.conf</code></p><br>
<pre><code class="plaintext hljs">zfs_enable="YES"<font></font>
sshd_enable="YES"<font></font>
hostname="hyper.bitbsd.org"<font></font>
#<font></font>
# You need a gateway defined for a working network setup<font></font>
defaultrouter="37.79.8.254"<font></font>
ifconfig_em0="inet 37.79.8.111 netmask 255.255.255.0"</code></pre><br>
<p><em>      , ..     .      :</em></p><br>
<p><code>ifconfig_DEFAULT="DHCP"</code>  <code>/etc/rc.conf</code></p><br>
<p> DNS</p><br>
<p><code>root@mfsbsd:~/bin # ee /mnt/etc/resolv.conf</code></p><br>
<pre><code class="plaintext hljs">nameserver 8.8.8.8</code></pre><br>
<p>      </p><br>
<p><code>root@mfsbsd:~ # chroot /mnt</code></p><br>
<p>          - .</p><br>
<p>    </p><br>
<p><code>root@mfsbsd:~ # reboot</code></p><br>
<h4 id="bolshe-krasnoglaziya"> </h4><br>
<p>       ,         mfsbsd. </p><br>
<p>  FreeBSD:</p><br>
<p><img src="https://habrastorage.org/webt/kg/kc/em/kgkcemg0hh8naobvnrlk7sipfsg.png"></p><br>
<p> Live CD</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">memory-disk</a></p><br>
<pre><code class="plaintext hljs"># mdconfig -a -t swap -s 2g -u 9<font></font>
# newfs -U md9<font></font>
# mount /dev/md9 /tmp<font></font>
# cd /tmp</code></pre><br>
<p>         mfsbsd,  , mfsbsd  <code>/tmp/</code>   ,       .</p><br>
<p><code># fetch https://github.com/mmatuska/mfsbsd/archive/master.zip</code></p><br>
<p><code># unzip master.zip &amp;&amp; cd mfsbsd-master/tools</code></p><br>
<p>      — <code>./destroygeom</code>  <code>./zfsinstall</code></p><br>
<p>    Linux:</p><br>
<p>      ,      "" -, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   GRUB</a>.        grub.cfg  :</p><br>
<pre><code class="plaintext hljs">menuentry "mfsbsd-10.0-RELEASE-amd64.iso" {<font></font>
# Path to the iso<font></font>
        set isofile=/boot/boot-isos/mfsbsd-12.0-RELEASE-amd64.iso<font></font>
# (hd0,1) here may need to be adjusted of course depending where the partition is<font></font>
        loopback loop (hd0,1)$isofile<font></font>
        kfreebsd (loop)/boot/kernel/kernel.gz -v<font></font>
#       kfreebsd_loadenv (loop)/boot/device.hints<font></font>
#       kfreebsd_module (loop)/boot/kernel/geom_uzip.ko<font></font>
        kfreebsd_module (loop)/boot/kernel/ahci.ko<font></font>
        kfreebsd_module (loop)/mfsroot.gz type=mfs_root<font></font>
        set kFreeBSD.vfs.root.mountfrom="ufs:/dev/md0"<font></font>
        set kFreeBSD.mfsbsd.autodhcp="YES"<font></font>
# Define a new root password<font></font>
#       set kFreeBSD.mfsbsd.rootpw="foobar"<font></font>
# Alternatively define hashed root password<font></font>
#       set kFreeBSD.mfsbsd.rootpwhash=""<font></font>
}</code></pre><br>
<p>    .iso  <code>/boot/boot-isos/</code></p><br>
<p>    ,         —  .</p><br>
<p>        FreeBSD   .</p><br>
<h4 id="konfiguraciya-sistemy"> </h4><br>
<p>    , …          —        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">pf</a>,        .       —   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">ZFS</a>,         .     ,   .      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>,       .     ZFS     ,   2-     3- .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  ,   ,      - .</p><br>
<p><code>freebsd-update -r 12.1-RELEASE upgrade</code></p><br>
<p><em>     12.1   </em></p><br>
<p><em>   </em></p><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">root@:~ # gpart show /dev/ada0<font></font>
=&gt;        40  5860533088  ada0  GPT  (2.7T)<font></font>
          40         472     1  freebsd-boot  (236K)<font></font>
         512     8388608     2  freebsd-swap  (4.0G)<font></font>
     8389120   167772160     3  freebsd-zfs  (80G)<font></font>
   176161280  2097152000     4  freebsd-zfs  (1.0T)<font></font>
  2273313280  3587219848     5  freebsd-zfs  (1.7T)<font></font>
<font></font>
root@:~ # gpart show /dev/ada1<font></font>
=&gt;        40  5860533088  ada1  GPT  (2.7T)<font></font>
          40         472     1  freebsd-boot  (236K)<font></font>
         512     8388608     2  freebsd-swap  (4.0G)<font></font>
     8389120   167772160     3  freebsd-zfs  (80G)<font></font>
   176161280  2097152000     4  freebsd-zfs  (1.0T)<font></font>
  2273313280  3587219848     5  freebsd-zfs  (1.7T)<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">root@:~ # zpool status<font></font>
  pool: appdata<font></font>
 state: ONLINE<font></font>
  scan: none requested<font></font>
config:<font></font>
<font></font>
    NAME            STATE     READ WRITE CKSUM<font></font>
    appdata         ONLINE       0     0     0<font></font>
      mirror-0      ONLINE       0     0     0<font></font>
        ada0p4.eli  ONLINE       0     0     0<font></font>
        ada1p4.eli  ONLINE       0     0     0<font></font>
<font></font>
errors: No known data errors<font></font>
<font></font>
  pool: miscdata<font></font>
 state: ONLINE<font></font>
  scan: none requested<font></font>
config:<font></font>
<font></font>
    NAME          STATE     READ WRITE CKSUM<font></font>
    miscdata      ONLINE       0     0     0<font></font>
      ada0p5.eli  ONLINE       0     0     0<font></font>
      ada1p5.eli  ONLINE       0     0     0<font></font>
<font></font>
errors: No known data errors<font></font>
<font></font>
  pool: zsys<font></font>
 state: ONLINE<font></font>
  scan: none requested<font></font>
config:<font></font>
<font></font>
    NAME        STATE     READ WRITE CKSUM<font></font>
    zsys        ONLINE       0     0     0<font></font>
      mirror-0  ONLINE       0     0     0<font></font>
        ada0p3  ONLINE       0     0     0<font></font>
        ada1p3  ONLINE       0     0     0<font></font>
<font></font>
errors: No known data errors<font></font>
</code></pre><br>
<p>   ?      ,      3.       ,     ,  " ",     .      .       ?</p><br>
<pre><code class="plaintext hljs">root@:~ # zfs list<font></font>
NAME            USED  AVAIL  REFER  MOUNTPOINT<font></font>
appdata        75.5K   961G    23K  /appdata<font></font>
miscdata       75.5K  3.21T    23K  /miscdata<font></font>
zsys           2.02G  75.0G    88K  none<font></font>
zsys/root      2.02G  75.0G  1.18G  /<font></font>
zsys/root/tmp    88K  75.0G    88K  /tmp<font></font>
zsys/root/var   862M  75.0G   862M  /var<font></font>
</code></pre><br>
<p> appdata (   /dev/ada0p4.eli  /dev/ada1p4.eli)     ,  miscdata ("", ..      /dev/ada0p5.eli  /dev/ada1p5.eli)   .       ,        .</p><br>
<p>      1    3.2  . </p><br>
<p>   ? .       - :</p><br>
<pre><code class="plaintext hljs">root@:~ # gpart show /dev/ada0<font></font>
=&gt;        40  5860533088  ada0  GPT  (2.7T)<font></font>
          40         472     1  freebsd-boot  (236K)<font></font>
         512     8388608     2  freebsd-swap  (4.0G)<font></font>
     8389120   167772160     3  freebsd-zfs  (80G)<font></font>
   176161280  684371848    free  (2.7T)</code></pre><br>
<p>   ,     </p><br>
<p><code>root@:~ # gpart add -t freebsd-zfs -s 1000g /dev/ada0</code></p><br>
<p><code>root@:~ # gpart add -t freebsd-zfs -s 1000g /dev/ada1</code></p><br>
<p>   </p><br>
<p><code>root@:~ # gpart add -t freebsd-zfs /dev/ada0</code></p><br>
<p><code>root@:~ # gpart add -t freebsd-zfs /dev/ada1</code></p><br>
<p>     /dev/ada0p4, /dev/ada0p5, /dev/ada1p4  /dev/ada0p5. ..           ,      .</p><br>
<p><code>root@:~ # geli init /dev/ada0p4</code></p><br>
<p><code>root@:~ # geli init /dev/ada0p5</code></p><br>
<p><code>root@:~ # geli init /dev/ada1p4</code></p><br>
<p><code>root@:~ # geli init /dev/ada1p5</code></p><br>
<p>  ,   :</p><br>
<p><code>root@:~ # geli attach /dev/ada0p4</code></p><br>
<p><code>root@:~ # geli attach /dev/ada0p5</code></p><br>
<p><code>root@:~ # geli attach /dev/ada1p4</code></p><br>
<p><code>root@:~ # geli attach /dev/ada1p5</code></p><br>
<p>     /dev/ada0p4.eli, /dev/ada0p5.eli, /dev/ada1p4.eli  /dev/ada0p5.eli,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>   </p><br>
<p>  :</p><br>
<pre><code class="plaintext hljs">root@:~ # cat /root/attach_disks.sh <font></font>
<font></font>
#!/bin/sh<font></font>
geli attach /dev/ada0p4<font></font>
geli attach /dev/ada0p5<font></font>
geli attach /dev/ada1p4<font></font>
geli attach /dev/ada1p5</code></pre><br>
<p><code>root@:~ # zpool create appdata mirror /dev/ada0p4.eli /dev/ada1p4.eli</code></p><br>
<p>    </p><br>
<p><code>root@:~ # zpool create miscdata /dev/ada0p5.eli /dev/ada1p5.eli</code></p><br>
<p>       .   ,        . .    ,      .</p><br>
<p><em>   </em></p><br>
<p>   .       SSD   450.         ,       ,           .       :</p><br>
<p><code>root@:~ # gpart show /dev/ada[0-9]</code></p><br>
<pre><code class="plaintext hljs">=&gt;       40  937703008  ada0  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
<font></font>
=&gt;       40  937703008  ada1  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
<font></font>
=&gt;       40  937703008  ada2  GPT  (447G)<font></font>
         40        472     1  freebsd-boot  (236K)<font></font>
        512   52428800     2  freebsd-zfs  (25G)<font></font>
   52429312  885273736        - free -  (422G)<font></font>
</code></pre><br>
<p>   420  (    , ..   ,      )</p><br>
<pre><code class="plaintext hljs">root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada0<font></font>
ada0p3 added<font></font>
root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada1<font></font>
ada1p3 added<font></font>
root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada2<font></font>
ada2p3 added</code></pre><br>
<p></p><br>
<pre><code class="plaintext hljs">root@hyper:~ # geli init /dev/ada0p3 <font></font>
Enter new passphrase: <font></font>
Reenter new passphrase: <font></font>
<font></font>
Metadata backup for provider /dev/ada0p3 can be found in /var/backups/ada0p3.eli<font></font>
and can be restored with the following command:<font></font>
<font></font>
    # geli restore /var/backups/ada0p3.eli /dev/ada0p3<font></font>
<font></font>
root@hyper:~ # geli init /dev/ada1p3<font></font>
Enter new passphrase: <font></font>
Reenter new passphrase: <font></font>
<font></font>
Metadata backup for provider /dev/ada1p3 can be found in /var/backups/ada1p3.eli<font></font>
and can be restored with the following command:<font></font>
<font></font>
    # geli restore /var/backups/ada1p3.eli /dev/ada1p3<font></font>
<font></font>
root@hyper:~ # geli init /dev/ada2p3<font></font>
Enter new passphrase: <font></font>
Reenter new passphrase: <font></font>
<font></font>
Metadata backup for provider /dev/ada2p3 can be found in /var/backups/ada2p3.eli<font></font>
and can be restored with the following command:<font></font>
<font></font>
    # geli restore /var/backups/ada2p3.eli /dev/ada2p3</code></pre><br>
<p><em>  Metadata backup?</em></p><br>
<p> ,         ,   .         .        .</p><br>
<p>    </p><br>
<pre><code class="plaintext hljs">root@hyper:~ # geli attach /dev/ada0p3<font></font>
Enter passphrase: <font></font>
root@hyper:~ # geli attach /dev/ada1p3<font></font>
Enter passphrase: <font></font>
root@hyper:~ # geli attach /dev/ada2p3<font></font>
Enter passphrase: <font></font>
<font></font>
root@hyper:~ # zpool create safestore raidz1 /dev/ada0p3.eli /dev/ada1p3.eli /dev/ada2p3.eli</code></pre><br>
<p>       820   </p><br>
<pre><code class="plaintext hljs">root@hyper:~ # zfs list<font></font>
NAME               USED  AVAIL  REFER  MOUNTPOINT<font></font>
safestore         89.2K   810G  29.3K  /safestore<font></font>
...</code></pre><br>
<p> ZFS         .     ,    . ZFS     ,      .</p><br>
<p><strong>     </strong></p><br>
<p>FreeBSD       " " — jails  bhyve.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">cbsd</a>,    FreeBSD Jails, bhyve  XEN.        , ..     .</p><br>
<p>    FreeBSD.      .         .     ,      .      ,      ,      .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/95c/817/901/95c8179015447a58c383f4a4a81a510d.gif" alt="画像"></p><br>
<p>bhyve      ,     Ubuntu  .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/ffd/cb6/219/ffdcb6219c701e2e114100d9601e9fea.gif" alt="画像"></p><br>
<p><code>root@:~ # pkg install cbsd</code></p><br>
<p> ,      cbsd   11   35 .</p><br>
<pre><code class="plaintext hljs">New packages to be INSTALLED:<font></font>
    cbsd: 12.1.2<font></font>
    sudo: 1.8.28<font></font>
    gettext-runtime: 0.20.1<font></font>
    indexinfo: 0.3.1<font></font>
    libssh2: 1.8.2,3<font></font>
    ca_root_nss: 3.47.1<font></font>
    rsync: 3.1.3_1<font></font>
    libiconv: 1.14_11<font></font>
    pkgconf: 1.6.3,1<font></font>
    libedit: 3.1.20190324,1<font></font>
    sqlite3: 3.29.0<font></font>
    readline: 8.0.0<font></font>
<font></font>
Number of packages to be installed: 12<font></font>
<font></font>
The process will require 33 MiB more space.<font></font>
8 MiB to be downloaded.<font></font>
<font></font>
Proceed with this action? [y/N]: y<font></font>
</code></pre><br>
<p>      </p><br>
<p><code>root@:~ # zfs create miscdata/jails</code></p><br>
<p> cbsd</p><br>
<p><code>root@:~ # env workdir="/miscdata/jails" /usr/local/cbsd/sudoexec/initenv</code></p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">-------[CBSD v.12.1.2]-------<font></font>
 This is install/upgrade scripts for CBSD.<font></font>
 Don't forget to backup.<font></font>
-----------------------------<font></font>
Do you want prepare or upgrade hier environment for CBSD now?<font></font>
[yes(1) or no(0)]<font></font>
1<font></font>
&gt;&gt;&gt; Installing or upgrading<font></font>
[Stage 1: account &amp; dir hier]<font></font>
 * Check hier and permission...<font></font>
./.rssh missing (created)<font></font>
./.ssh missing (created)<font></font>
./.ssh/sockets missing (created)<font></font>
./basejail missing (created)<font></font>
./etc missing (created)<font></font>
./etc/defaults missing (created)<font></font>
./export missing (created)<font></font>
./ftmp missing (created)<font></font>
./import missing (created)<font></font>
./jails missing (created)<font></font>
./jails-data missing (created)<font></font>
./jails-fstab missing (created)<font></font>
./jails-rcconf missing (created)<font></font>
./jails-system missing (created)<font></font>
./share missing (created)<font></font>
./share/dialog missing (created)<font></font>
./share/helpers missing (created)<font></font>
./share/FreeBSD-jail-puppet-skel missing (created)<font></font>
./share/FreeBSD-jail-skel missing (created)<font></font>
./share/FreeBSD-jail-vnet-skel missing (created)<font></font>
./share/emulators missing (created)<font></font>
./src missing (created)<font></font>
./tmp missing (created)<font></font>
./var missing (created)<font></font>
./var/cron missing (created)<font></font>
./var/cron/tabs missing (created)<font></font>
./var/db missing (created)<font></font>
./var/log missing (created)<font></font>
./var/mail missing (created)<font></font>
./var/run missing (created)<font></font>
./var/spool missing (created)<font></font>
 * write directory id: jaildatadir<font></font>
 * write directory id: jailsysdir<font></font>
 * write directory id: jailrcconfdir<font></font>
 * write directory id: dbdir<font></font>
[Stage 2: build tools]<font></font>
Shall i add cbsd user into /usr/local/etc/sudoers.d/cbsd_sudoers sudo file to obtain root privileges for the most cbsd commands?<font></font>
[yes(1) or no(0)]<font></font>
1<font></font>
[Stage 3: local settings]<font></font>
Shall i modify the /etc/rc.conf to sets cbsd_workdir="/miscdata/jails"?: <font></font>
[yes(1) or no(0)]<font></font>
1<font></font>
/etc/rc.conf: cbsd_workdir:  -&gt; /miscdata/jails<font></font>
[Stage 4: update default skel resolv.conf]<font></font>
[Stage 5: refreshing inventory]<font></font>
nodename: CBSD Nodename for this host e.g. the hostname. Warning: this operation will recreate the ssh keys in /miscdata/jails/.ssh dir: hostname.org<font></font>
<font></font>
Empty inventory database created: /miscdata/jails/var/db/inv.hostname.org.sqlite<font></font>
nodeip: Node management IPv4 or IPv6 address (used for node interconnection), e.g: 151.106.27.106<font></font>
<font></font>
jnameserver: Jails default DNS name-server (for jails resolv.conf), e.g.: 9.9.9.9,149.112.112.112<font></font>
8.8.8.8,8.8.4.4<font></font>
nodeippool: Jail pool IP address range (networks for jails)<font></font>
Hint: use space as delimiter for multiple networks, e.g.: 10.0.0.0/16 151.106.27.106/24<font></font>
192.168.0.0/24<font></font>
nat_enable: Enable NAT for RFC1918 networks?<font></font>
[yes(1) or no(0)]<font></font>
0<font></font>
fbsdrepo: Use official FreeBSD repository? When no (0) the repository of CBSD is preferred (useful for stable=1) for fetching base/kernel?<font></font>
[yes(1) or no(0)]<font></font>
1<font></font>
zfsfeat: You are running on a ZFS-based system. Enable ZFS feature?<font></font>
[yes(1) or no(0)]<font></font>
1<font></font>
parallel: Parallel mode stop/start ?<font></font>
(0 - no parallel or positive value (in seconds) as timeout for next parallel sequence) e.g: 5<font></font>
0<font></font>
stable: Use STABLE branch instead of RELEASE by default? Attention: only the CBSD repository has a binary base for STABLE branch ?<font></font>
(STABLE_X instead of RELEASE_X_Y branch for base/kernel will be used), e.g.: 0 (use release)<font></font>
0<font></font>
sqlreplica: Enable sqlite3 replication to remote nodes ?<font></font>
(0 - no replica, 1 - try to replicate all local events to remote nodes) e.g: 1<font></font>
0<font></font>
statsd_bhyve_enable: Configure CBSD statsd services for collect RACCT bhyve statistics? ?<font></font>
(EXPERIMENTAL FEATURE)? e.g: 0<font></font>
0<font></font>
statsd_jail_enable: Configure CBSD statsd services for collect RACCT jail statistics? ?<font></font>
(EXPERIMENTAL FEATURE)? e.g: 0<font></font>
0<font></font>
statsd_hoster_enable: Configure CBSD statsd services for collect RACCT hoster statistics? ?<font></font>
(EXPERIMENTAL FEATURE)? e.g: 0<font></font>
0<font></font>
[Stage 6: authentication keys]<font></font>
Generating public/private rsa key pair.<font></font>
Your identification has been saved in /miscdata/jails/.ssh/8a3574aa0ec0ad3056e7dcf0f48adb01.id_rsa.<font></font>
Your public key has been saved in /miscdata/jails/.ssh/8a3574aa0ec0ad3056e7dcf0f48adb01.id_rsa.pub.<font></font>
The key fingerprint is:<font></font>
SHA256:bZM/lo6lx40vE48MxZea1KQMKYIBq3HyPWQrF0xn980 root@hostname.org<font></font>
The key's randomart image is:<font></font>
+---[RSA 2048]----+<font></font>
|  ..ooo .  .     |<font></font>
|   +.o....oo  .  |<font></font>
|o o =  . ..+E+ . |<font></font>
| * + o   . .* +  |<font></font>
|. o =   S =o +   |<font></font>
|   o .   ..o+.   |<font></font>
|           +**   |<font></font>
|           *O.o  |<font></font>
|          o..+.  |<font></font>
+----[SHA256]-----+<font></font>
[Stage 7: modules]<font></font>
Installing module pkg.d cmd: pkg<font></font>
Installing module bsdconf.d cmd: tzsetup<font></font>
Installing module bsdconf.d cmd: ssh<font></font>
Installing module bsdconf.d cmd: ftp<font></font>
Installing module bsdconf.d cmd: adduser<font></font>
Installing module bsdconf.d cmd: passwd<font></font>
Installing module bsdconf.d cmd: service<font></font>
Installing module bsdconf.d cmd: sysrc<font></font>
Installing module bsdconf.d cmd: userlist<font></font>
Installing module bsdconf.d cmd: grouplist<font></font>
Installing module bsdconf.d cmd: adduser-tui<font></font>
Installing module bsdconf.d cmd: pw<font></font>
Installing module bsdconf.d cmd: cloudinit<font></font>
Installing module zfsinstall.d cmd: zfsinstall<font></font>
[Stage 9: cleanup]<font></font>
 * Remove obsolete files...<font></font>
Configure RSYNC services for jail migration?<font></font>
[yes(1) or no(0)]<font></font>
0<font></font>
cbsdrsyncd_enable:  -&gt; YES<font></font>
Do you want to enable RACCT feature for resource accounting?<font></font>
[yes(1) or no(0)]<font></font>
0<font></font>
Shall i modify the /etc/rc.conf to sets cbsdd_enable=YES ?<font></font>
[yes(1) or no(0)]<font></font>
0<font></font>
cbsdd_enable:  -&gt; NO<font></font>
Shall i modify the /etc/rc.conf to sets rcshutdown_timeout="900"?<font></font>
[yes(1) or no(0)]<font></font>
0<font></font>
rcshutdown_timeout: 90 -&gt; 900<font></font>
[Stage X: upgrading]<font></font>
  * Insert default topology into vm_cpu_topology table<font></font>
  * Insert small1 group into vmpackage table<font></font>
&gt;&gt;&gt; Done<font></font>
  First CBSD initialization complete.<font></font>
<font></font>
  Now your can run:<font></font>
  service cbsdd start<font></font>
  to run CBSD services.<font></font>
<font></font>
  For change initenv settings in next time, use:<font></font>
  cbsd initenv-tui<font></font>
<font></font>
  Also don't forget to execute:<font></font>
  cbsd initenv<font></font>
  every time when you upgrade CBSD version.<font></font>
<font></font>
preseedinit: Would you like a config for "cbsd init" preseed to be printed?<font></font>
[yes(1) or no(0)]<font></font>
0</code></pre></div></div><br>
<p> cbsd .  <em>onestart</em>, ..    cbsd     , ..        .</p><br>
<p><code>root@:~ # service cbsdd onestart</code></p><br>
<p>        SSH (     ,          VNC/IPMI  )       <code>./root/attach_disks.sh</code>.</p><br>
<p>  cbsd    192.168.0.0/24     .          .     ,      ,   NAT     .</p><br>
<pre><code class="plaintext hljs">root@:~ # sysrc pf_enable=YES<font></font>
pf_enable: NO -&gt; YES<font></font>
root@:~ # service pf start<font></font>
/etc/rc.d/pf: WARNING: /etc/pf.conf is not readable.</code></pre><br>
<p>     </p><br>
<p><code>root@:~ # ee /etc/pf.conf</code></p><br>
<pre><code class="plaintext hljs">IF_PUBLIC="igb0"<font></font>
IP_PUBLIC="X.X.X.X"<font></font>
<font></font>
JAIL_IP_POOL="192.168.0.0/24"<font></font>
<font></font>
icmp_types="echoreq"<font></font>
<font></font>
set limit { states 100000, frags 20000, src-nodes 20000 }<font></font>
set skip on lo0<font></font>
scrub in all<font></font>
<font></font>
#NAT for others<font></font>
nat pass on $IF_PUBLIC from $JAIL_IP_POOL to any -&gt; $IP_PUBLIC<font></font>
<font></font>
## Jail HTTP/S port forward<font></font>
IP_JAIL="192.168.0.2"<font></font>
PORT_JAIL="{ 80, 443 }"<font></font>
rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_JAIL -&gt; $IP_JAIL<font></font>
</code></pre><br>
<p> </p><br>
<pre><code class="plaintext hljs">root@:~ # service pf start<font></font>
Enabling pf.<font></font>
root@:~ # pfctl -f /etc/pf.conf</code></pre><br>
<p>    </p><br>
<p><code>root@:~ # cbsd jconstruct-tui</code></p><br>
<p><img src="https://habrastorage.org/webt/md/kz/9x/mdkz9xlo12s5ausfki4zzi3gxzq.png"></p><br>
<p>      </p><br>
<p><img src="https://habrastorage.org/webt/1l/iy/om/1liyomcjdsmqvqjn1ged3oztnfo.png"></p><br>
<p>     <code>root@:~ # cbsd jconstruct-tui</code></p><br>
<p>  </p><br>
<p><code>root@:~ # cbsd jstart webapp</code></p><br>
<p>     </p><br>
<p><code>root@:~ # cbsd jlogin webapp</code></p><br>
<div class="spoiler"><b class="spoiler_title">  nginx</b><div class="spoiler_text"><pre><code class="plaintext hljs">webapp:/root@[12:58] # pkg install nginx <font></font>
Updating FreeBSD repository catalogue...<font></font>
FreeBSD repository is up to date.<font></font>
All repositories are up to date.<font></font>
Updating database digests format: 100%<font></font>
The following 2 package(s) will be affected (of 0 checked):<font></font>
<font></font>
New packages to be INSTALLED:<font></font>
    nginx: 1.16.1_4,2<font></font>
    pcre: 8.43_2<font></font>
<font></font>
Number of packages to be installed: 2<font></font>
<font></font>
The process will require 8 MiB more space.<font></font>
2 MiB to be downloaded.<font></font>
<font></font>
Proceed with this action? [y/N]: y<font></font>
[webapp.host.org] [1/2] Fetching nginx-1.16.1_4,2.txz: 100%  442 KiB 452.8kB/s    00:01    <font></font>
[webapp.host.org] [2/2] Fetching pcre-8.43_2.txz: 100%    1 MiB 638.0kB/s    00:02    <font></font>
Checking integrity... done (0 conflicting)<font></font>
[webapp.host.org] [1/2] Installing pcre-8.43_2...<font></font>
[webapp.host.org] [1/2] Extracting pcre-8.43_2: 100%<font></font>
[webapp.host.org] [2/2] Installing nginx-1.16.1_4,2...<font></font>
===&gt; Creating groups.<font></font>
Using existing group 'www'.<font></font>
===&gt; Creating users<font></font>
Using existing user 'www'.<font></font>
[webapp.host.org] [2/2] Extracting nginx-1.16.1_4,2: 100%<font></font>
=====<font></font>
Message from nginx-1.16.1_4,2:<font></font>
<font></font>
--<font></font>
Recent version of the NGINX introduces dynamic modules support.  In<font></font>
FreeBSD ports tree this feature was enabled by default with the DSO<font></font>
knob.  Several vendor's and third-party modules have been converted<font></font>
to dynamic modules.  Unset the DSO knob builds an NGINX without<font></font>
dynamic modules support.<font></font>
<font></font>
To load a module at runtime, include the new `load_module'<font></font>
directive in the main context, specifying the path to the shared<font></font>
object file for the module, enclosed in quotation marks.  When you<font></font>
reload the configuration or restart NGINX, the module is loaded in.<font></font>
It is possible to specify a path relative to the source directory,<font></font>
or a full path, please see<font></font>
https://www.nginx.com/blog/dynamic-modules-nginx-1-9-11/ and<font></font>
http://nginx.org/en/docs/ngx_core_module.html#load_module for<font></font>
details.<font></font>
<font></font>
Default path for the NGINX dynamic modules is<font></font>
<font></font>
/usr/local/libexec/nginx.<font></font>
webapp:/root@[12:59] # sysrc nginx_enable=YES<font></font>
nginx_enable:  -&gt; YES<font></font>
webapp:/root@[12:59] # service nginx start<font></font>
Performing sanity check on nginx configuration:<font></font>
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok<font></font>
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful<font></font>
Starting nginx.<font></font>
webapp:/root@[DING!] # sockstat -l4<font></font>
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      <font></font>
www      nginx      27982 6  tcp4   192.168.0.2:80        *:*<font></font>
root     nginx      27981 6  tcp4   192.168.0.2:80        *:*<font></font>
root     sendmail   25361 4  tcp4   192.168.0.2:25        *:*<font></font>
webapp:/root@[13:00] # <font></font>
</code></pre></div></div><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">root@:~ # jls<font></font>
   JID  IP Address      Hostname                      Path<font></font>
     1  192.168.0.1     tor.host.org                  /miscdata/jails/jails/tor<font></font>
     2  192.168.0.2     webapp.host.org               /miscdata/jails/jails/webapp<font></font>
     3  192.168.0.3     bitcoind.host.org             /miscdata/jails/jails/bitcoind<font></font>
     4  192.168.0.4     ethd.host.org                 /miscdata/jails/jails/ethd</code></pre><br>
<p> webapp     <code>nginx</code>,          <code>/etc/pf.conf</code></p><br>
<p><strong>   </strong></p><br>
<p>     .  .      </p><br>
<p> <code>/etc/rc.conf</code>            </p><br>
<pre><code class="plaintext hljs">ifconfig_igb0_alias="inet 192.168.0.1 netmask 255.255.255.0"<font></font>
gateway_enable="YES"</code></pre><br>
<pre><code class="plaintext hljs">root@hyper:~ # echo 'vmm_load="YES"' &gt;&gt; /boot/loader.conf <font></font>
root@hyper:~ # echo 'kld_list="vmm if_tap if_bridge nmdm"' &gt;&gt; /etc/rc.conf<font></font>
root@hyper:~ # reboot</code></pre><br>
<p>  ,        .</p><br>
<div class="spoiler"><b class="spoiler_title">/etc/pf.conf</b><div class="spoiler_text"><p>IF_PUBLIC="igb0"<br>
IP_PUBLIC="Y.Y.Y.Y"</p><br>
<p>JAIL_IP_POOL="192.168.0.0/24"</p><br>
<p>icmp_types="echoreq"</p><br>
<p>set limit { states 100000, frags 20000, src-nodes 20000 }<br>
set skip on lo0<br>
scrub in all</p><br>
<h1 id="nat-for-others">NAT for others</h1><br>
<p>nat pass on $IF_PUBLIC from $JAIL_IP_POOL to any -&gt; $IP_PUBLIC</p><br>
<h2 id="jail-https-port-forward">Jail HTTP/S port forward</h2><br>
<p>IP_JAIL="192.168.0.2"<br>
PORT_JAIL="{ 80, 443 }"<br>
rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_JAIL -&gt; $IP_JAIL</p></div></div><br>
<pre><code class="plaintext hljs">root@hyper:~ # sysrc pf_enable=YES<font></font>
pf_enable: NO -&gt; YES<font></font>
root@hyper:~ # service pf start<font></font>
Enabling pf.</code></pre><br>
<p>,   </p><br>
<p><code>root@hyper:~ # cbsd bconstruct-tui</code></p><br>
<p><img src="https://habrastorage.org/webt/ik/zb/_e/ikzb_einlgwc9i-tbfl560s03ww.png"></p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>root@hyper:~ # cbsd bstart debian<br>
init_systap: waiting for link: igb0<br>
Looks like /safestore/jails/vm/debian/dsk1.vhd is empty.<br>
May be you want to boot from CD?<br>
[yes(1) or no(0)]<br>
1<br>
Temporary boot device: cd<br>
vm_iso_path: iso-debian-10.1.0-amd64-DVD-1.iso<br>
No such media: /safestore/jails/src/iso/cbsd-iso-debian-10.1.0-amd64-DVD-1.iso in /safestore/jails/src/iso<br>
Shall i download it from: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://debian-cd.repulsive.eu/10.1.0/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://gensho.ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://cdimage.debian.org/cdimage/release/10.1.0/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://debian.mirror.cambrium.nl/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://mirror.overthewire.com.au/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://ftp.crifo.org/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://debian.cse.msu.edu/debian-cd/10.1.0/amd64/iso-dvd/</a>?<br>
[yes(1) or no(0)]<br>
1<br>
Download to: /safestore/jails/src/iso/cbsd-iso-debian-10.1.0-amd64-DVD-1.iso<br>
Scanning for fastest mirror…<br>
Mirror source: Bytes per 3sec:</p><br>
<ul>
<li>[ 1/14 ] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://cbsd.lifec0re.net/iso/</a>: 8036352</li>
</ul></div></div><br>
<p>     VNC    5900,       SSH</p><br>
<p><code>ssh hyperhost -L 5900:localhost:5900</code></p><br>
<p><img src="https://habrastorage.org/webt/aq/tr/ll/aqtrllbz9wryvpnsccxxlbiwbei.png"></p><br>
<p> . IP    -  192.168.0.100.</p><br>
<p>  <code>/etc/pf.conf</code>  SSH</p><br>
<pre><code class="plaintext hljs">## VM SSH port forward<font></font>
IP_VM="192.168.0.100"<font></font>
PORT_VM="{ 22100 }"<font></font>
rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_VM -&gt; $IP_VM port 22</code></pre><br>
<p>       .   ,   .</p><br>
<pre><code class="plaintext hljs">root@hyper:~ # zfs list<font></font>
NAME                              USED  AVAIL  REFER  MOUNTPOINT<font></font>
safestore                        5.89G   804G  29.3K  /safestore<font></font>
safestore/jails                  5.89G   804G  4.46G  /safestore/jails<font></font>
safestore/jails/debian            920M   804G   208K  /safestore/jails/vm/debian<font></font>
safestore/jails/debian/dsk1.vhd   919M   804G   919M  -<font></font>
safestore/jails/linuxjail         329M   804G   329M  /safestore/jails/jails-data/linuxjail-data<font></font>
safestore/jails/nginx            89.2M   804G  89.2M  /safestore/jails/jails-data/nginx-data<font></font>
safestore/jails/tor               117M   804G   117M  /safestore/jails/jails-data/tor-data<font></font>
zsystem                          1.85G  21.9G    88K  none<font></font>
zsystem/root                     1.85G  21.9G  1.20G  /<font></font>
zsystem/root/tmp                  120K  21.9G   120K  /tmp<font></font>
zsystem/root/var                  662M  21.9G   662M  /var<font></font>
</code></pre><br>
<p><code>root@hyper:~ # zfs snap safestore/jails/debian/dsk1.vhd@fresh</code></p><br>
<p>     .    .</p><br>
<h4 id="chaynaya-pauza---ansible">  — Ansible</h4><br>
<p>         3,   1300 .         .</p><br>
<div class="spoiler"><b class="spoiler_title">/etc/ansible/hosts</b><div class="spoiler_text"><pre><code class="plaintext hljs">[hyper-debian-group]<font></font>
hyper-debian<font></font>
<font></font>
[hyper-group]<font></font>
hyper<font></font>
<font></font>
[hyper-group:vars]<font></font>
ansible_python_interpreter=/usr/local/bin/python3.7</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">~/.ssh/config</b><div class="spoiler_text"><pre><code class="plaintext hljs">Host hyper<font></font>
    Hostname Y.Y.Y.Y<font></font>
        User root<font></font>
        Port 33696<font></font>
<font></font>
Host hyper-debian<font></font>
    Hostname Y.Y.Y.Y<font></font>
        User root<font></font>
        Port 22100<font></font>
</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">~/deploy-docker.yml</b><div class="spoiler_text"><pre><code class="plaintext hljs">- hosts: hyper-debian<font></font>
  gather_facts: no<font></font>
<font></font>
  tasks:<font></font>
  - name: Install a list of misc packages<font></font>
    apt:<font></font>
      update_cache: yes<font></font>
      pkg:<font></font>
        - apt-transport-https<font></font>
        - ca-certificates<font></font>
        - curl<font></font>
        - gnupg2<font></font>
        - software-properties-common<font></font>
<font></font>
  - name: Add Docker repo<font></font>
    shell: curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -<font></font>
<font></font>
  - name: Add Docker repo<font></font>
    shell: apt-key fingerprint 0EBFCD88<font></font>
<font></font>
  - name: Do some linux repo magic<font></font>
    shell: add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"<font></font>
<font></font>
  - name: Install Docker CE suite &amp; composer<font></font>
    apt:<font></font>
      update_cache: yes<font></font>
      pkg:<font></font>
        - docker-ce<font></font>
        - docker-ce-cli<font></font>
        - containerd.io<font></font>
        - docker-compose<font></font>
<font></font>
  - name: Update all packages to the latest version<font></font>
    apt:<font></font>
      upgrade: dist</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">~/rollback-debian.yml</b><div class="spoiler_text"><pre><code class="plaintext hljs">- hosts: hyper<font></font>
  gather_facts: no<font></font>
<font></font>
  tasks:<font></font>
  - name: stop debian<font></font>
    shell: cbsd bstop debian<font></font>
<font></font>
  - name: list ZFS datasets<font></font>
    shell: zfs list | grep debian<font></font>
    register: zfslist<font></font>
  - debug: var=zfslist.stdout_lines<font></font>
<font></font>
  - name: rollback debian<font></font>
    shell: zfs rollback safestore/jails/debian/dsk1.vhd@fresh<font></font>
<font></font>
  - name: list ZFS datasets<font></font>
    shell: zfs list | grep debian<font></font>
    register: zfslist<font></font>
  - debug: var=zfslist.stdout_lines<font></font>
<font></font>
  - name: start debian<font></font>
    shell: cbsd bstart debian</code></pre></div></div><br>
<p><strong>      ,   TerraForm </strong></p><br>
<p>      </p><br>
<pre><code class="plaintext hljs">[user@localhost ~]$ ansible-playbook deploy-docker.yml <font></font>
<font></font>
PLAY [hyper-debian] *******************************************************************************************************<font></font>
<font></font>
TASK [Install a list of misc packages] *********************************************************************************************<font></font>
changed: [hyper-debian]<font></font>
<font></font>
TASK [Add Docker repo] ********************************************************************************************************<font></font>
<font></font>
changed: [hyper-debian]<font></font>
<font></font>
TASK [Add Docker repo] ********************************************************************************************************<font></font>
<font></font>
changed: [hyper-debian]<font></font>
<font></font>
TASK [Do some linux repo magic] ********************************************************************************************************changed: [hyper-debian]<font></font>
<font></font>
TASK [Install Docker CE suite &amp; composer] ********************************************************************************************************changed: [hyper-debian]<font></font>
<font></font>
TASK [Update all packages to the latest version] ********************************************************************************************************ok: [hyper-debian]<font></font>
<font></font>
PLAY RECAP ********************************************************************************************************hyper-debian               : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <font></font>
</code></pre><br>
<p>             ,    iRedMail.</p><br>
<pre><code class="plaintext hljs">docker run --privileged -p 80:80 -p 443:443 \<font></font>
           -e "DOMAIN=example.com" -e "HOSTNAME=mail" \<font></font>
           -e "MYSQL_ROOT_PASSWORD=password" \<font></font>
           -e "SOGO_WORKERS=1" \<font></font>
           -e "TIMEZONE=Europe/Prague" \<font></font>
           -e "POSTMASTER_PASSWORD=password" \<font></font>
           -e "IREDAPD_PLUGINS=['reject_null_sender', 'reject_sender_login_mismatch', 'greylisting', 'throttle', 'amavisd_wblist', 'sql_alias_access_policy']" \<font></font>
           -v PATH/mysql:/var/lib/mysql \<font></font>
           -v PATH/vmail:/var/vmail \<font></font>
           -v PATH/clamav:/var/lib/clamav \<font></font>
           --name=iredmail lejmr/iredmail:mysql-latest</code></pre><br>
<p>      ?       -    Debian. </p><br>
<pre><code class="plaintext hljs">[user@localhost ~]$ ansible-playbook rollback-debian.yml <font></font>
<font></font>
PLAY [hyper] ********************************************************************************************************<font></font>
TASK [stop debian] ********************************************************************************************************changed: [hyper]<font></font>
<font></font>
TASK [list ZFS datasets] ********************************************************************************************************changed: [hyper]<font></font>
<font></font>
TASK [debug] ********************************************************************************************************ok: [hyper] =&gt; {<font></font>
    "zfslist.stdout_lines": [<font></font>
        "safestore/jails/debian           2.65G   803G   206K  /safestore/jails/vm/debian",<font></font>
        "safestore/jails/debian/dsk1.vhd  2.65G   803G  2.34G  -"<font></font>
    ]<font></font>
}<font></font>
<font></font>
TASK [rollback debian] ********************************************************************************************************changed: [hyper]<font></font>
<font></font>
TASK [list ZFS datasets] ********************************************************************************************************changed: [hyper]<font></font>
<font></font>
TASK [debug] ********************************************************************************************************ok: [hyper] =&gt; {<font></font>
    "zfslist.stdout_lines": [<font></font>
        "safestore/jails/debian            920M   804G   206K  /safestore/jails/vm/debian",<font></font>
        "safestore/jails/debian/dsk1.vhd   919M   804G   919M  -"<font></font>
    ]<font></font>
}<font></font>
<font></font>
TASK [start debian] ********************************************************************************************************changed: [hyper]<font></font>
<font></font>
PLAY RECAP ********************************************************************************************************hyper                      : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <font></font>
</code></pre><br>
<p>           ,          .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素材が気に入って便利になった場合は、ルーブルで投票して、ビットコインを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">1baysxTdXkwZnBosDdL1veb2zWDo6DC5b</font></a><font style="vertical-align: inherit;">に送信できます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたの実験で頑張ってください！</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja479180/index.html">Discordの作成-VPSサーバーへのデプロイメントを伴う.NET Core上のボット</a></li>
<li><a href="../ja479182/index.html">あんきプログラムで暗記のための声優による外国語の作成の練習</a></li>
<li><a href="../ja479184/index.html">pwnable.kr 26による問題解決-ascii_easy。私たちは、ROPガジェットを最初からすべて処理します</a></li>
<li><a href="../ja479186/index.html">並列計算の構造または「Go」演算子に対する引数について</a></li>
<li><a href="../ja479188/index.html">すべての自然数の合計：1 + 2 + 3 + 4 + ... パート2</a></li>
<li><a href="../ja479196/index.html">ほとんどのスーパーコンピュータはLinuxを実行しています-状況について話し合ってください</a></li>
<li><a href="../ja479200/index.html">フラクタル画像圧縮</a></li>
<li><a href="../ja479202/index.html">C ++と数値メソッド：近似ニュートンコート積分</a></li>
<li><a href="../ja479210/index.html">2020年1月1日から海外のオンラインストアでの購入はどうなりますか</a></li>
<li><a href="../ja479214/index.html">モスクワの開発者向けの今後の無料イベントの選択＃2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>