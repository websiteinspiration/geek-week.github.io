<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äç‚öñÔ∏è ‚óΩÔ∏è üíâ PostgreSQL: programaci√≥n del lado del servidor en lenguaje humano (PL / Perl, PL / Python, PL / v8) üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø üßîüèº üêÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Postgres es conocido por su extensibilidad, que tambi√©n se aplica a la compatibilidad con lenguajes de procedimiento (PL). Nadie puede presumir de un ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL: programaci√≥n del lado del servidor en lenguaje humano (PL / Perl, PL / Python, PL / v8)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/502254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgres es conocido por su extensibilidad, que tambi√©n se aplica a la compatibilidad con lenguajes de procedimiento (PL). Nadie puede presumir de un </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idioma con una</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lista de idiomas de esta longitud, y potencialmente esta lista no est√° del todo limitada: para conectar el idioma al servidor, no se requiere ning√∫n esfuerzo adicional. Incluso puede crear su propio idioma y convertirlo en un lenguaje de procedimiento del servidor. Las modificaciones en el DBMS no requerir√°n esto. Como mucho m√°s, esta extensibilidad se ha incorporado a la arquitectura de Postgres desde el principio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es posible ya veces necesario escribir idiomas PL para tareas. Mejor a√∫n, si alguien escribe dicho marco para escribir lenguajes para que pueda escribir no en C, sino elegir un lenguaje que sea m√°s c√≥modo para un desarrollador de lenguaje. Al igual que con FDW, que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se puede escribir en Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo fue escrito sobre la base de una serie de informes y clases magistrales sobre este tema realizadas por el autor en las conferencias </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PgConf.Russia 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PgConf.Russia 2018</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DevConf 2017</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No se trata de ex√≥ticos, sino de los lenguajes de procedimiento m√°s comunes PL / Perl, PL / Python y PL / V8 (es decir, JavaScript) y de comparar sus capacidades con PL / pgSQL.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øCu√°ndo vale la pena usar estos idiomas? </font><font style="vertical-align: inherit;">¬øCu√°ndo faltan SQL y PL / pgSQL?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego, cuando necesite trabajar con estructuras complejas, con algoritmos: atravesar √°rboles, por ejemplo, o cuando se requiera el an√°lisis HTML o XML, especialmente al extraerlos de archivos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando necesita generar din√°micamente SQL complejo (informes, ORM). </font><font style="vertical-align: inherit;">En PL / pgSQL, no solo es inconveniente, sino que tambi√©n funcionar√° m√°s lentamente en algunos casos;</font></font></li>
<li>         Perl  Python,        C/C++,      Perl  Python    .         . ,    Oracle.     ,    Postgres   .    Perl  Python  .</li>
<li>   ‚Äî    .   , ,   untrusted- (  ‚Äî . ),    Perlu  Python(3)u,    PL/V8.   Postgres  ,     ,   FDW,    ,         .       .  !</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y una cosa m√°s: si vas a escribir algo en C, entonces puedes hacer un prototipo en estos lenguajes que est√©n m√°s adaptados al desarrollo r√°pido.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo incrustar un idioma en Postgres</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar el lenguaje que necesita: escriba en C de una a tres funciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HANDLER: un manejador de llamadas que ejecutar√° una funci√≥n en el idioma (esta es una parte obligatoria);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INLINE - controlador de bloque an√≥nimo (si desea que el idioma admita bloques an√≥nimos);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VALIDADOR: funci√≥n de verificaci√≥n de c√≥digo al crear una funci√≥n (si desea que se realice esta verificaci√≥n).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto se describe en detalle en la documentaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Idiomas listos para usar" y otros idiomas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay cuatro idiomas que son compatibles " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para usar </font><font style="vertical-align: inherit;">": </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">PL / pgSQL</font></a><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Tcl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero el cosquilleo es m√°s bien un tributo a la historia: pocas personas lo usan ahora, ya no hablaremos m√°s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / Perl, PL / Python y, por supuesto, PL / pgSQL son compatibles con la comunidad de Postgres. El soporte para otros idiomas listos para usar recae en sus </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mantenedores</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : empresas, comunidades o desarrolladores espec√≠ficos interesados ‚Äã‚Äãen hacer que el lenguaje funcione dentro del DBMS. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> promueve Google. Pero de vez en cuando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hay razones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duda del futuro sin nubes de PL / V8. El actual responsable del proyecto PL / V8 de Google, Jerry Sievert, est√° considerando el soporte JS de Postgres basado en el servidor basado en un motor diferente (como QuickJS), ya que PL / V8 es dif√≠cil de construir y requiere 3-5 GB todo tipo de cosas en Linux al compilar, y esto a menudo genera problemas en diferentes sistemas operativos. Pero el PL / V8 es ampliamente utilizado y probado exhaustivamente. Es posible que PL / JS aparezca como una alternativa a otro motor JS, o por ahora solo como un nombre, al que nos acostumbraremos durante el per√≠odo de transici√≥n. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rara vez se usa. Personalmente no ten√≠a necesidad de escribir en PL / Java porque en PL / Perl y en PL / V8 hay suficiente funcionalidad para casi todas las tareas. Incluso Python no agrega caracter√≠sticas particularmente. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / R</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ötil para quienes gustan de las estad√≠sticas y aman este lenguaje. No hablaremos de √©l aqu√≠ tampoco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los lenguajes populares no son necesariamente populares con los almacenes de escritura: hay PL / PHP, pero ahora pr√°cticamente no es compatible con nadie; hay pocos que quieran escribir procedimientos de servidor en √©l. Para el lenguaje PL / Ruby, la imagen es de alguna manera la misma, aunque el lenguaje parece ser m√°s moderno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se est√° desarrollando un lenguaje de procedimiento basado en Go, ver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y tambi√©n, al parecer, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Lua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ser√° necesario estudiarlos. Para los fan√°ticos obstinados de la concha, incluso hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Sh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es dif√≠cil incluso imaginar para qu√© podr√≠a ser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay al menos un lenguaje de procedimiento (DSL) espec√≠fico de dominio que est√° estrechamente especializado para su tarea: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que sol√≠a ser muy popular para proxy y equilibrar la carga del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo, cubriremos los idiomas principales m√°s utilizados. Esto, por supuesto, es PL / PgSQL, PL / Perl, PL / Python y PL / V8, los llamaremos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / * a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> continuaci√≥n </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los idiomas "listos para usar" se instalan casi de manera literal, por lo general, la instalaci√≥n es sencilla. Pero para instalar PL / V8, si no encontr√≥ un paquete con la versi√≥n necesaria en el repositorio de su sistema operativo, esto es casi una haza√±a, porque para esto tendr√° que construir todo el V8 o, en otras palabras, Chromium. Al mismo tiempo, toda la infraestructura de desarrollo se descargar√° de google.com junto con el propio V8: cuente con un par de gigabytes de tr√°fico. Para Postgres 11 en Ubuntu, el paquete PL / V8 a√∫n no ha aparecido, solo V8 para PG 10 est√° disponible en el repositorio hasta ahora. Si lo desea, armelo a mano. Tambi√©n es importante que la versi√≥n que encontrar√° en el repositorio sea bastante antigua. En el momento de la publicaci√≥n del art√≠culo, la √∫ltima versi√≥n es 2.3.14.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de instalar el idioma en s√≠, tambi√©n debe "crear" el idioma: registrarlo en el directorio del sistema. </font><font style="vertical-align: inherit;">Esto debe ser realizado por el equipo.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> plperl;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(en lugar de plperl, puede sustituir el nombre de otro idioma, hay ciertos matices, ver m√°s abajo). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos fijamos en lo que sucedi√≥:</font></font><br>
<br>
<pre><code class="plaintext hljs">test_langs=# \x<font></font>
test_langs=# \dL+<font></font>
List of languages<font></font>
-[ RECORD 1 ]-----+---------------------------------<font></font>
Name              | plperl<font></font>
Owner             | postgres<font></font>
Trusted           | t<font></font>
Internal language | f<font></font>
Call handler      | plperl_call_handler()<font></font>
Validator         | plperl_validator(oid)<font></font>
Inline handler    | plperl_inline_handler(internal)<font></font>
Access privileges |<font></font>
Description       | PL/Perl procedural language<font></font>
-[ RECORD 2 ]-----+---------------------------------<font></font>
Name              | plpgsql<font></font>
Owner             | postgres<font></font>
Trusted           | t<font></font>
Internal language | f<font></font>
Call handler      | plpgsql_call_handler()<font></font>
Validator         | plpgsql_validator(oid)<font></font>
Inline handler    | plpgsql_inline_handler(internal)<font></font>
Access privileges |<font></font>
Description       | PL/pgSQL procedural language<font></font>
[ RECORD 3 ]-----+---------------------------------<font></font>
Name              | plv8<font></font>
Owner             | postgres<font></font>
Trusted           | t<font></font>
Internal language | f<font></font>
Call handler      | plv8_call_handler()<font></font>
Validator         | plv8_call_validator(oid)<font></font>
Inline handler    | plv8_inline_handler(internal)<font></font>
Access privileges |<font></font>
Description       |</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / pgSQL no necesita ser creado especialmente; siempre est√° en la base de datos. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Atenci√≥n! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL no debe confundirse con SQL. </font><font style="vertical-align: inherit;">Este es un idioma diferente. </font><font style="vertical-align: inherit;">Sin embargo, Postgres tambi√©n puede escribir funciones en SQL simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el mundo de los DBMS, a menudo hablan sobre el cumplimiento de SQL. </font><font style="vertical-align: inherit;">Los lenguajes de procedimiento tambi√©n tienen est√°ndares, aunque no se habla con tanta frecuencia. </font><font style="vertical-align: inherit;">El est√°ndar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL / PSM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es altamente compatible con el lenguaje de procedimiento de DB2. </font><font style="vertical-align: inherit;">Su implementaci√≥n est√° lejos de PL / pgSQL, aunque conceptualmente est√°n cerca. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL / JRT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el est√°ndar para los procedimientos de Java, y PL / Java es una buena combinaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idiomas confiables y no confiables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los lenguajes de procedimiento de Postgres son confiables (CONFIABLES) y no confiables (NO CONFIABLES). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los lenguajes de CONFIANZA, no existe la posibilidad de trabajar directamente con E / S, incluida la red, y de hecho con los recursos del sistema. Por lo tanto, tales funciones pueden ser creadas por cualquier usuario de la base de datos, estropear algo y no podr√° aprender demasiado. Las funciones en idiomas que NO SON DE CONFIANZA solo pueden ser creadas por un supervisor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el int√©rprete de idiomas admite tales restricciones, puede usarse para crear idiomas CONFIABLES y NO CONFIABLES. Entonces, con Perl, hay diferentes idiomas </font></font><code>plperl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>plperlu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Letra </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al final revela el car√°cter no confiable del lenguaje. </font><font style="vertical-align: inherit;">Python existe solo en una versi√≥n no confiable. </font><font style="vertical-align: inherit;">PL / v8 - por el contrario, solo en confianza. </font><font style="vertical-align: inherit;">Como resultado, PL / v8 no puede cargar ning√∫n m√≥dulo o biblioteca desde el disco, solo desde la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una funci√≥n en el idioma NO CONFIANZA puede hacer cualquier cosa: enviar un correo electr√≥nico, hacer ping a un sitio, iniciar sesi√≥n en una base de datos extranjera y ejecutar una solicitud HTTP. </font><font style="vertical-align: inherit;">Los idiomas de CONFIANZA se limitan al procesamiento de datos desde la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por CONFIANZA incluyen: </font></font><code>plpgsql, plperl, plv8, pljava</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que no se conf√≠a incluir: </font></font><code>plperlu, pljavau, plpython2u, plpython3u</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta: no hay PL / Python como TRUSTED (ya que no puede establecer restricciones en el acceso a los recursos all√≠), y PLpgSQL y PL / V8 son al rev√©s: no son CONFIABLES. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero Perl y Java est√°n disponibles en ambas versiones.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL vs PL / *</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo PL / pgSQL funciona de forma nativa con todos los tipos de datos que tiene Postgres. Otros idiomas no tienen muchos tipos de Postgres, y el int√©rprete de idiomas se encarga de convertir los datos en una representaci√≥n interna del idioma, reemplazando los tipos oscuros con texto. Sin embargo, se le puede ayudar con la ayuda de TRANSFORM, de la que hablar√© m√°s cerca del final del art√≠culo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las llamadas a funciones en PL / pgSQL suelen ser m√°s caras. Las funciones en otros idiomas pueden acceder a sus bibliotecas sin mirar el cat√°logo del sistema. PL / pgSQL no puede funcionar as√≠. Algunas consultas en PL / pgSQL funcionan durante mucho tiempo debido al hecho de que se admiten muchos tipos: para agregar dos enteros, el int√©rprete debe darse cuenta de que est√° tratando con enteros y no con otros tipos ex√≥ticos, luego decide c√≥mo doblarlos, y solo despu√©s de eso realmente doblarlos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que PL / pgSQL es CONFIABLE, no puede trabajar con la red y los discos de ella. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se trata de trabajar con estructuras de datos anidadas, PL / pgSQL solo tiene herramientas de Postgres para trabajar con JSON, que son muy engorrosas e improductivas, en otros idiomas, trabajar con estructuras anidadas es mucho m√°s simple y econ√≥mico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / * tiene su propia administraci√≥n de memoria, y usted necesita monitorear la memoria, o tal vez limitarla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe controlar cuidadosamente el manejo de errores, que tambi√©n es diferente para todos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero en PL / * hay un contexto de int√©rprete global, y se puede usar, por ejemplo, para el almacenamiento en cach√© de datos, incluidos los planes de consulta. </font><font style="vertical-align: inherit;">Si el idioma NO ES DE CONFIANZA, entonces la red y las unidades est√°n disponibles. </font><font style="vertical-align: inherit;">Todos estos lenguajes funcionan con la base de datos, por regla general, a trav√©s del SPI, pero m√°s sobre eso m√°s adelante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo m√°s de cerca a las caracter√≠sticas de los idiomas PL / *.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El int√©rprete de Perl es un c√≥digo considerable en la memoria, pero afortunadamente no se crea cuando se abre la conexi√≥n, sino solo cuando se inicia el primer procedimiento / funci√≥n almacenada PL / Perl. </font><font style="vertical-align: inherit;">Cuando se inicializa, se ejecuta el c√≥digo especificado en los par√°metros de configuraci√≥n de Postgres. </font><font style="vertical-align: inherit;">Por lo general, los m√≥dulos se cargan y se realizan c√°lculos previos. </font><font style="vertical-align: inherit;">
Si agreg√≥ al archivo de configuraci√≥n mientras se ejecuta la base de datos, haga que Postgres vuelva a leer la configuraci√≥n. </font><font style="vertical-align: inherit;">En este art√≠culo, los ejemplos usan un m√≥dulo </font><font style="vertical-align: inherit;">para visualizar estructuras de datos. </font><font style="vertical-align: inherit;">
Hay par√°metros para la inicializaci√≥n por separado de Perl TRUSTED y UNTRUSTED y, por supuesto, un par√°metro </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Quienes programan en Perl saben que sin </font><font style="vertical-align: inherit;">√©l no es un idioma, sino un malentendido.</font></font><br>
<br>
<code>plperl.on_init= 'use Data::Dumper;'<br>
plperl.on_plperl_init= ' ... '<br>
plperl.on_plperlu_init= ' ... '<br>
plperl.use_strict= on</code><br>
<br><font style="vertical-align: inherit;"></font><code>Data::Dumper</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>use_strict=on</code><font style="vertical-align: inherit;"></font><code>strict</code><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En √©l, el int√©rprete se crea de la misma manera la primera vez que se accede. Y aqu√≠ es importante decidir de inmediato qu√© python desea: segundo o tercero. Como sabes, Python existe en dos versiones populares (Python 2 y Python 3), pero el problema es que sus shki no se llevan bien en un solo proceso: hay un conflicto por nombre. Si trabaj√≥ con v2 en una sesi√≥n y luego llam√≥ a v3, Postgres se bloquear√°, y para el proceso del servidor (backend) esto ser√° un error fatal. Para acceder a una versi√≥n diferente, debe abrir otra sesi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferencia de Perl, a Python no se le puede decir qu√© hacer durante la inicializaci√≥n. Otro inconveniente: las l√≠neas simples son inconvenientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En todas las funciones de Python, se definen dos diccionarios: est√°tico </font></font><code>SD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y global </font></font><code>GD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Global </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intercambiar datos con todas las funciones dentro de un backend, lo que es atractivo y peligroso al mismo tiempo. </font><font style="vertical-align: inherit;">Cada funci√≥n tiene un diccionario est√°tico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En PL / Python, puede hacer subtransacciones, que discutiremos a continuaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo es de CONFIANZA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Convenientemente, los datos JSON se convierten autom√°ticamente en una estructura JS. En PL / V8, como en PL / Python, puede hacer subtransacciones. Hay una interfaz para llamadas a funciones simplificadas. Este es el √∫nico lenguaje de procedimiento en cuesti√≥n en el que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se pueden definir las funciones de la ventana</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sugieren que se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pueden definir en PL / R</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero este lenguaje est√° fuera del alcance de este art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y solo en PL / V8 hay un tiempo de espera de ejecuci√≥n. Es cierto que no est√° activado de forma predeterminada, y si construye PL / V8 a mano, debe decir que se activ√≥ durante el ensamblaje, y luego puede establecer tiempos de espera para las llamadas de funci√≥n con el par√°metro de configuraci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La inicializaci√≥n en PL / V8 parece interesante: dado que es confiable, no puede leer la biblioteca desde el disco, no puede cargar nada desde ning√∫n lugar. </font><font style="vertical-align: inherit;">Puede tomar todo lo que necesita solo de la base. </font><font style="vertical-align: inherit;">Por lo tanto, se define una funci√≥n de inicializador almacenada que se llama cuando se inicia el int√©rprete de idiomas. </font><font style="vertical-align: inherit;">El nombre de la funci√≥n se especifica en un par√°metro de configuraci√≥n especial:</font></font><br>
<br>
<pre><code class="pgsql hljs">plv8.start_proc=my_init # ( PL/V8-)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante la inicializaci√≥n, se pueden crear variables y funciones globales asignando sus valores a los atributos de esta variable. </font><font style="vertical-align: inherit;">Por ejemplo, as√≠:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> my_init()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">void</span> <span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">AS</span> $$<span class="php">
     this.get_57 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">57</span>; }; <span class="hljs-comment">//   </span>
     this.pi_square = <span class="hljs-number">9.8696044</span>;  <span class="hljs-comment">//   </span>
$$</span>;
<span class="hljs-keyword">SET</span> plv8.start_proc = <span class="hljs-string">'my_init'</span>;
<span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plv8 $$<span class="pgsql">
     plv8.elog(<span class="hljs-keyword">NOTICE</span>, pi_square, get_57() );
$$</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparaci√≥n de PL / Perl vs PL / Python vs PL / V8 en la pr√°ctica</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Mundo!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realicemos un ejercicio simple con el resultado de esta frase en los tres idiomas, primero en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y que haga algo m√°s √∫til, por ejemplo, le dice a su versi√≥n:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     elog(<span class="hljs-keyword">NOTICE</span>,"Hello World! $]");
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  Hello World!<font></font>
DO<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n puede usar las funciones habituales de Perl </font></font><code>warn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>die</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . M√°s precisamente en PL / Python3u (no confiable) - para mayor precisi√≥n.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">import</span> sys
     plpy.<span class="hljs-keyword">notice</span>(<span class="hljs-string">'Hello World! '</span> , hint=" ", detail=sys.version_info)
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;</code></pre><br>
<pre><code class="plaintext hljs"><font></font>
NOTICE:  Hello World! <font></font>
DETAIL:  sys.version_info(major=3, minor=6, micro=9, releaselevel='final', serial=0)<font></font>
HINT:   <font></font>
DO<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede usar </font></font><code>throw 'Errmsg'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hay muchas cosas que puede extraer de los mensajes de Postgres: contienen Sugerencia, Detalles, n√∫mero de l√≠nea y muchos otros par√°metros. </font><font style="vertical-align: inherit;">En PL / Python, se pueden pasar, pero no en los otros idiomas considerados: sus medios solo se pueden maldecir con una l√≠nea de texto sin formato. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En PL / Python, cada nivel de registro de postgres tiene su propia funci√≥n: AVISO, ADVERTENCIA, DEPURACI√ìN, REGISTRO, INFORMACI√ìN, FATAL. </font><font style="vertical-align: inherit;">Si es ERROR, entonces la transacci√≥n ha ca√≠do, si es FATAL, todo el backend ha ca√≠do. </font><font style="vertical-align: inherit;">Afortunadamente, el asunto no lleg√≥ a PANIC. </font><font style="vertical-align: inherit;">Puedes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leer aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En este idioma, Hello world es muy similar a la perla. </font><font style="vertical-align: inherit;">Puede dejar de </font></font><code>exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usar </font></font><code>throw</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y esto tambi√©n ser√° un manejo de errores, aunque las herramientas no son tan avanzadas como en Python. </font><font style="vertical-align: inherit;">Si t√∫ escribes</font></font><code>plv8.elog(ERROR)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el efecto ser√°, por cierto, el mismo.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     plv8.elog(<span class="hljs-keyword">NOTICE</span>, <span class="hljs-string">'Hello World!'</span>, plv8.<span class="hljs-keyword">version</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  Hello World! 2.3.14<font></font>
DO<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajar con la base</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos c√≥mo trabajar con una base de datos a partir de procedimientos almacenados. Postgres tiene una SPI (interfaz de programaci√≥n del servidor). Este es un conjunto de funciones C que est√° disponible para todos los autores de extensiones. Casi todos los idiomas PL proporcionan envoltorios para SPI, pero cada idioma lo hace un poco diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es improbable que una funci√≥n escrita en C pero usando SPI d√© una ganancia significativa en comparaci√≥n con PL / PgSQL y otros lenguajes de procedimiento. Pero una funci√≥n C que omite SPI y funciona con datos sin intermediarios (por ejemplo </font></font><code>table_beginscan/heap_getnext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) funcionar√° un orden de magnitud m√°s r√°pido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / Java tambi√©n usa SPI. Pero trabajar con la base de datos todav√≠a ocurre al estilo de JDBC y el est√°ndar JDBC. Para el creador de c√≥digo en PL / Java, todo sucede como si estuviera trabajando desde una aplicaci√≥n cliente, pero JNI (Java Native Interface) traduce las llamadas a la base de datos en las mismas funciones SPI. Es conveniente, y no hay obst√°culos fundamentales para traducir este principio a PL / Perl y PL / Python, pero por alguna raz√≥n esto no se ha hecho, y hasta ahora no es visible en los planes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, si lo desea, puede ir a bases extranjeras de la forma habitual: a trav√©s de DBI o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psycopg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es posible una base de datos local, pero ¬øpor qu√©?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no entras en el tema hol√≠stico "proceso en la base vs proceso en el cliente", e inmediatamente procedes del procesamiento m√°ximo m√°s cerca de los datos (al menos para no conducir muestras gigantes a trav√©s de la red), entonces la soluci√≥n para usar las funciones almacenadas en el servidor se ve naturalmente. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rendimiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tenga en cuenta que SPI tiene algunos gastos generales, y las consultas SQL en funciones pueden ser m√°s lentas que sin funciones. El 13er postgres incluy√≥ un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parche de Konstantin Knizhnik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que reduce estos costos. Pero, por supuesto, el procesamiento de los resultados de la consulta en una funci√≥n almacenada no requiere la transferencia del resultado al cliente y, por lo tanto, puede ser beneficioso en t√©rminos de rendimiento. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La seguridad</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: un conjunto de funciones depuradas y probadas a√≠sla la estructura de la base de datos del usuario, protege contra inyecciones SQL y otras travesuras. </font><font style="vertical-align: inherit;">De lo contrario, seguir√° siendo un dolor de cabeza para todos los desarrolladores de aplicaciones. </font><font style="vertical-align: inherit;">Reutilizaci√≥n de </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : si una gran cantidad de aplicaciones complejas funcionan con la base de datos, es conveniente almacenar funciones √∫tiles en el servidor, en lugar de volver a escribirlas en cada aplicaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo y de qu√© forma obtenemos datos de la base de datos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , todo es simple y claro. </font><font style="vertical-align: inherit;">La llamada </font></font><code>spi_exec_query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve el n√∫mero de filas procesadas, el estado y la matriz de filas seleccionadas por la consulta SQL:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="ruby"> 
     warn Data::Dumper::Dumper(
          spi_exec_query(<span class="hljs-string">'SELECT 57 AS x'</span>)
     )
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;</code></pre><br>
<pre><code class="plaintext hljs">WARNING:  $VAR1 = {<font></font>
          'rows' =&gt; [<font></font>
                    {<font></font>
                      'x' =&gt; '57'<font></font>
                    }<font></font>
                  ],<font></font>
          'processed' =&gt; 1,<font></font>
          'status' =&gt; 'SPI_OK_SELECT'<font></font>
        };<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python, la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consulta y el resultado se parecen a esto, pero aqu√≠ la funci√≥n no devuelve una estructura de datos, sino un objeto especial con el que puede trabajar de diferentes maneras. </font><font style="vertical-align: inherit;">Por lo general, pretende ser una matriz y, en consecuencia, puede extraer cadenas de ella.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql"> 
     plpy.<span class="hljs-keyword">notice</span>(
          plpy.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT 57 AS x'</span>)
     )
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  &lt;PLyResult status=5 nrows=1 rows=[{'x': 57}]&gt;<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora tomamos la primera l√≠nea, salimos de all√≠ X y obtenemos el valor: el n√∫mero.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql"> 
     plpy.<span class="hljs-keyword">notice</span>(
          plpy.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT 57 AS x'</span>)[<span class="hljs-number">0</span>][<span class="hljs-string">'x'</span>]
      )
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  57<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql"> 
     plv8.elog(<span class="hljs-keyword">NOTICE</span>, <span class="hljs-type">JSON</span>.stringify(
          plv8.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT 57 as x'</span>))
     );
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  [{"x":57}]<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ver la estructura, utilizamos la funci√≥n de biblioteca JSON.stringify, que no necesita cargarse espec√≠ficamente, ya est√° lista para usar como parte de PL / v8 de forma predeterminada. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blindaje</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar inyecciones SQL maliciosas, se deben escapar algunos caracteres en las consultas. Para hacer esto, en primer lugar, hay funciones SPI y funciones correspondientes (escritas en C) en lenguajes que funcionan como envoltorios SPI. Por ejemplo, en PL / Perl: </font></font><br>
<br>
<code>quote_literal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- toma ap√≥strofes y dobla 'y \. Dise√±ado para el cribado de datos de texto. </font></font><br>
<code>quote_nullable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- igual, pero </font></font><code>undef</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertido a NULL. </font></font><br>
<code>quote_ident</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- cita el nombre de la tabla o campo, si es necesario. √ötil en el caso cuando est√° construyendo una consulta SQL y sustituyendo los nombres de los objetos de la base de datos en ella. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="perl">
     <span class="hljs-keyword">warn</span> <span class="hljs-string">"macy's"</span>;
     <span class="hljs-keyword">warn</span> quote_literal(<span class="hljs-string">"macy's"</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;</code></pre><br>
<pre><code class="plaintext hljs">WARNING:  macy's at line 2.<font></font>
WARNING:  'macy''s' at line 3.<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta: el nombre de la tabla no debe escaparse como una l√≠nea de texto. </font><font style="vertical-align: inherit;">Por eso hay una funci√≥n </font></font><code>quote_ident</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero en PL / Perl hay otras funciones para proteger datos de tipos individuales de post-gres: </font><font style="vertical-align: inherit;">
una funci√≥n </font><font style="vertical-align: inherit;">debe aceptar cualquier tipo y convertir caracteres dudosos at√≠picos en algo obviamente seguro. </font><font style="vertical-align: inherit;">Funciona con una gran cantidad de tipos, pero, sin embargo, no con todos. </font><font style="vertical-align: inherit;">Ella, por ejemplo, no comprender√° los </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">tipos de rango</font></a><font style="vertical-align: inherit;"> y los percibir√° simplemente como cadenas de texto.</font></font><br>
<br>
<code>encode_bytea<br>
decode_bytea<br>
encode_array_literal<br>
encode_typed_literal<br>
encode_array_constructor</code><br>
<br><font style="vertical-align: inherit;"></font><code>quote_typed_literal</code><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="perl">
     <span class="hljs-keyword">warn</span> encode_typed_literal(
          [<span class="hljs-string">""</span>, <span class="hljs-string">" "</span>], <span class="hljs-string">"text[]"</span>
     );
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;</code></pre><br>
<pre><code class="plaintext hljs">WARNING:  {," "} at line 2.<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay </font><font style="vertical-align: inherit;">tres funciones similares </font><font style="vertical-align: inherit;">en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y funcionan de la misma manera:</font></font><br>
<br>
<code>plpy.quote_literal<br>
plpy.quote_nullable<br>
plpy.quote_ident</code><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql"> plpy.<span class="hljs-keyword">notice</span>(
     plpy.quote_literal("Macy's"));
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;</code></pre><pre><code class="plaintext hljs">NOTICE:  'Macy''s'<font></font>
DO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øSon las funciones en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8 las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mismas </font><font style="vertical-align: inherit;">? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Por supuesto! </font><font style="vertical-align: inherit;">Todo es igual hasta las caracter√≠sticas sint√°cticas.</font></font><br>
<br>
<code>plv8.quote_literal<br>
plv8.quote_nullable<br>
plv8.quote_ident</code><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
    plv8.elog(<span class="hljs-keyword">NOTICE</span>, plv8.quote_nullable("Macy's"));
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  'Macy''s'</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actuaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© idioma es el m√°s r√°pido? Usualmente responden: C. Pero la respuesta correcta es C </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SQL. ¬øPor qu√© SQL? El hecho es que una funci√≥n en este lenguaje no siempre se realiza expl√≠citamente. Puede incrustarse en la solicitud (el programador incorporar√° la funci√≥n en el cuerpo de la solicitud principal), se optimizar√° bien con la solicitud y el resultado ser√° m√°s r√°pido. Pero, ¬øbajo qu√© condiciones se puede incrustar el c√≥digo en una solicitud? Hay algunas condiciones simples sobre las que puede leer, por ejemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por ejemplo, una funci√≥n no debe ejecutarse con los derechos del propietario (para ser DEFINIDOR DE SEGURIDAD). La mayor√≠a de las funciones simples se ajustar√°n a estas condiciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo mediremos "en la rodilla", no en serio. Necesitamos una comparaci√≥n aproximada. Primero encienda el tiempo:</font></font><br>
<br>
<pre><code class="plaintext hljs">\timing</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probemos con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (los tiempos de ejecuci√≥n de los siguientes comandos son los valores promedio redondeados que el autor recibi√≥ en una PC descargada de seis a√±os. Se pueden comparar entre s√≠, pero no afirman ser cient√≠ficos):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> pg_class;
<span class="hljs-number">0.5</span> ms
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona muy rapido. </font><font style="vertical-align: inherit;">En otros idiomas, se pierde tiempo llamando a las funciones del idioma. </font><font style="vertical-align: inherit;">Por supuesto, la primera vez la solicitud se ejecutar√° m√°s lentamente debido a la inicializaci√≥n del int√©rprete. </font><font style="vertical-align: inherit;">Entonces se estabiliza. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probemos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">DECLARE</span> a <span class="hljs-type">int</span>;
     <span class="hljs-keyword">BEGIN</span>
          <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">INTO</span> a <span class="hljs-keyword">FROM</span> pg_class;
     <span class="hljs-keyword">END</span>;
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;
<span class="hljs-number">0.7</span> ms</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="perl">
     <span class="hljs-keyword">my</span> $x = spi_exec_query(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;
<span class="hljs-number">0.7</span> ms</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python:</font></font></b><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     x = plpy.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpythonu;
<span class="hljs-number">0.8</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era Python 2. Ahora </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (recuerde: Python2 y Python3 no viven pac√≠ficamente dentro de la misma sesi√≥n, es posible un conflicto de nombres):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     x = plpy.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;
<span class="hljs-number">0.9</span>ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y finalmente, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     var x = plv8.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8 ;
<span class="hljs-number">0.9</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero de alguna manera es muy r√°pido. </font><font style="vertical-align: inherit;">Intentemos ejecutar la consulta 1000 veces o 1 mill√≥n de veces, de repente la diferencia ser√° m√°s notable: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">DECLARE</span> a <span class="hljs-type">int</span>; i <span class="hljs-type">int</span>;
     <span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">0.</span><span class="hljs-number">.999999</span> <span class="hljs-keyword">LOOP</span>
          <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">INTO</span> a <span class="hljs-keyword">FROM</span> pg_class;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;
<span class="hljs-number">53</span>s</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="ruby">
     <span class="hljs-keyword">for</span> (<span class="hljs-number">0</span>..<span class="hljs-number">999999</span>) {
          spi_exec_query(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
     }
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;
<span class="hljs-number">102</span>s</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range (<span class="hljs-number">0</span>,<span class="hljs-number">1000000</span>) :
          plpy.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>)
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;
<span class="hljs-number">98</span>s</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">for</span>(var i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)
          plv8.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8;
<span class="hljs-number">100</span>ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que con PL / V8, el experimento se realiz√≥ con mil, no un mill√≥n de iteraciones. Con recursos moderados, el PL / V8 en un ciclo de 1 mill√≥n de operaciones consumir√° toda la memoria y colgar√° completamente el autom√≥vil. Ya en mil iteraciones, el proceso postgres selecciona 3.5GB de memoria y 100% de escritura en disco. De hecho, postgres lanza el entorno V8 y, por supuesto, consume memoria. Despu√©s de ejecutar la solicitud, este monstruo turbo no devolver√° la memoria. Para liberar memoria, debe finalizar la sesi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que PL / pgSQL ya es 2 veces m√°s r√°pido que PL / Perl y PL / Python. PL / V8 todav√≠a est√° ligeramente detr√°s de ellos, pero hacia el final del art√≠culo est√° parcialmente rehabilitado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, Perl con Python en estos experimentos muestra aproximadamente los mismos resultados. </font><font style="vertical-align: inherit;">Perl sol√≠a ser ligeramente inferior a Python; en las versiones modernas, es un poco m√°s r√°pido. </font><font style="vertical-align: inherit;">La tercera pit√≥n es un poco m√°s lenta que la segunda. </font><font style="vertical-align: inherit;">Toda la diferencia est√° dentro del 15%.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rendimiento con PREPARE</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las personas que saben entender√°n: algo est√° mal. </font><font style="vertical-align: inherit;">PL / pgSQL puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenar autom√°ticamente en cach√© los planes de consulta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y en PL / *, cada vez que la consulta se programa de nuevo. </font><font style="vertical-align: inherit;">En el buen sentido, debe preparar solicitudes, crear un plan de solicitud y, de acuerdo con este plan, deben ejecutarse tantas veces como sea necesario. </font><font style="vertical-align: inherit;">En PL / *, puede trabajar expl√≠citamente con planes de consulta, que intentaremos comenzar con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="perl">
     <span class="hljs-keyword">my</span> $h = spi_prepare(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
     <span class="hljs-keyword">for</span> (<span class="hljs-number">0</span>..<span class="hljs-number">999999</span>) {
          spi_exec_prepared($h);
     }
     spi_freeplan($h);
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;
<span class="hljs-number">60</span>s</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     h = plpy.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>)
     <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range (<span class="hljs-number">0</span>,<span class="hljs-number">1000000</span>): plpy.<span class="hljs-keyword">execute</span>(h)
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;
<span class="hljs-number">62</span>s</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     var h=plv8.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT count(*) FROM pg_class'</span>);
     <span class="hljs-keyword">for</span>(var i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++) h.<span class="hljs-keyword">execute</span>();
$$</span> <span class="hljs-keyword">LANGUAGE</span> plv8;
<span class="hljs-number">53</span>ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con </font></font><code>prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuestros dos idiomas, casi alcanzamos PL / pgSQL, mientras que el tercero tambi√©n quer√≠a, pero no lleg√≥ a la meta debido a la creciente demanda de memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero si no tiene en cuenta la memoria, entonces est√° claro que todos los idiomas van casi cara a cara, y no por casualidad. </font><font style="vertical-align: inherit;">Su cuello de botella ahora es com√∫n: trabajar con la base de datos a trav√©s de SPI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rendimiento inform√°tico</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que el rendimiento del lenguaje ha descansado en el trabajo con la base de datos. </font><font style="vertical-align: inherit;">Para comparar idiomas entre s√≠, intentemos calcular algo sin recurrir a la base de datos, por ejemplo, la suma de los cuadrados. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
     <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">bigint</span>; a <span class="hljs-type">bigint</span>;
     <span class="hljs-keyword">BEGIN</span> a=<span class="hljs-number">0</span>;
     <span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">0.</span><span class="hljs-number">.1000000</span> <span class="hljs-keyword">LOOP</span>
          a=a+i*i::<span class="hljs-type">bigint</span>;
     <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;
<span class="hljs-number">280</span>ms</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="perl">
     <span class="hljs-keyword">my</span> $a=<span class="hljs-number">0</span>;
     <span class="hljs-keyword">for</span> <span class="hljs-keyword">my</span> $i (<span class="hljs-number">0</span>..<span class="hljs-number">1000000</span>) { $a+=$i*$i; };
     <span class="hljs-keyword">warn</span> $a;
$$</span> <span class="hljs-keyword">LANGUAGE</span> plperl;
<span class="hljs-number">63</span>ms</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> $$<span class="pgsql">
a=<span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">1000001</span>): a=a+i*i
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u;
<span class="hljs-number">73</span>ms</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">DO $$<font></font>
     var a=0;<font></font>
     for(var i=0;i&lt;=1000000;i++) a+=i*i;<font></font>
     plv8.elog(NOTICE, a);<font></font>
$$ language plv8;<font></font>
7.5ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que PL / Perl y PL / Python superaron y superaron a PL / pgSQL, son 4 veces m√°s r√°pidos. </font><font style="vertical-align: inherit;">¬°Y el ocho est√° destrozando a todos! </font><font style="vertical-align: inherit;">¬øPero es realmente por nada? </font><font style="vertical-align: inherit;">¬øO lo conseguiremos para la cabeza? </font><font style="vertical-align: inherit;">Si, lo haremos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El n√∫mero en JavaScript es flotante, y el resultado es r√°pido, pero no exacto: 333333833333127550 en lugar de 333333833333500000. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° la f√≥rmula por la cual se </font><font style="vertical-align: inherit;">calcula el </font><font style="vertical-align: inherit;">resultado exacto:</font></font><br>
<br>
<pre><code class="plaintext hljs">‚àë = n*(n+1)*(2n+1)/6
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ejercicio, puedes probarlo usando inducci√≥n matem√°tica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el orden de la risa</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plv8 $$<span class="pgsql">
plv8.elog(<span class="hljs-keyword">NOTICE</span>, parseInt(<span class="hljs-number">33333383333312755033</span>)) $$</span>;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:<font></font>
33333383333312754000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Javascript, </font></font><code>parseInt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todav√≠a hace un flotador, no un Int. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BigInt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apareci√≥ en V8 en 2018 </font><font style="vertical-align: inherit;">, y ahora se puede contar con seguridad, pero en detrimento de la velocidad, ya que no es un entero de 64 bits, sino un entero de profundidad de bits arbitraria. </font><font style="vertical-align: inherit;">Sin embargo, en PL / V8 esta innovaci√≥n a√∫n no ha llegado. </font><font style="vertical-align: inherit;">En otros lenguajes de procedimiento, los n√∫meros de bits arbitrarios (an√°logos de SQL </font></font><code>numeric</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) son compatibles con bibliotecas especiales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Perl, hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulo Math :: BigFloat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para aritm√©tica con precisi√≥n arbitraria, y en Python, el paquete </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bigfloat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un contenedor de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cython</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alrededor de la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNU MPFR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funciones de rendimiento para ordenar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay un ejemplo pr√°ctico, que muestra la diferencia en el rendimiento de la clasificaci√≥n por funci√≥n, si esta funci√≥n est√° escrita en diferentes idiomas. </font><font style="vertical-align: inherit;">Tarea: ordenar los campos de texto que contienen los n√∫meros de los n√∫meros de la revista, que pueden ser los siguientes:</font></font><br>
<br>
<pre><code class="plaintext hljs">1<font></font>
2<font></font>
3<font></font>
4-5<font></font>
6<font></font>
6A<font></font>
6<font></font>
11<font></font>
12<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquellos. </font><font style="vertical-align: inherit;">en realidad es una cadena, pero comienza con un n√∫mero y debes ordenar por estos n√∫meros. </font><font style="vertical-align: inherit;">Por lo tanto, para ordenar correctamente como cadenas, complementamos la parte num√©rica con ceros a la izquierda para obtener:</font></font><br>
<br>
<pre><code class="plaintext hljs">0000000001<font></font>
0000000002<font></font>
0000000003<font></font>
0000000004-5<font></font>
0000000006<font></font>
0000000006A<font></font>
0000000006<font></font>
0000000011<font></font>
0000000012<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, s√© que esta no es la √∫nica soluci√≥n al problema (y ni siquiera del todo correcto). </font><font style="vertical-align: inherit;">Pero, por ejemplo, lo har√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solicitar un tipo, </font></font><code>SELECT ... ORDER BY nsort(n)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribimos funciones en PL / Perl, SQL, PL / Python y PL / V8 que convierten los n√∫meros de diario a este formulario:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> nsort(<span class="hljs-type">text</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">text</span> 
   <span class="hljs-keyword">LANGUAGE</span> PLPERL <span class="hljs-keyword">IMMUTABLE</span> <span class="hljs-keyword">AS</span> $$<span class="perl">
    <span class="hljs-keyword">my</span> $x = <span class="hljs-keyword">shift</span>;
    <span class="hljs-keyword">return</span> ($x =~ <span class="hljs-regexp">/^\s*(\d+)(.*)$/</span>)
        ? <span class="hljs-keyword">sprintf</span>(<span class="hljs-string">"%010d"</span>, $1).$2
        : $x;
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> _nsort(x <span class="hljs-type">text</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">text</span>
     <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span>  <span class="hljs-keyword">IMMUTABLE</span>  <span class="hljs-keyword">AS</span> $$<span class="pgsql">
 <span class="hljs-keyword">WITH</span> y <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> regexp_match(x,<span class="hljs-string">'^\s*(\d*)(.*)$'</span>) <span class="hljs-keyword">as</span> z
 )
 <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> z[<span class="hljs-number">1</span>] = <span class="hljs-string">''</span> <span class="hljs-keyword">THEN</span> x <span class="hljs-keyword">ELSE</span> lpad(z[<span class="hljs-number">1</span>],<span class="hljs-number">10</span>,<span class="hljs-string">'0'</span>) || z[<span class="hljs-number">2</span>] <span class="hljs-keyword">END</span> <span class="hljs-keyword">FROM</span> y;
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> py_nsort(x <span class="hljs-type">text</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">text</span> 
   <span class="hljs-keyword">LANGUAGE</span> plpython2u <span class="hljs-keyword">IMMUTABLE</span> <span class="hljs-keyword">AS</span> $$<span class="pgsql">
<span class="hljs-keyword">import</span> re
r = re.match(<span class="hljs-string">'^\s*(\d+)(.*)$'</span>, x)
<span class="hljs-keyword">return</span> x <span class="hljs-keyword">if</span> r == <span class="hljs-keyword">None</span> <span class="hljs-keyword">else</span> (<span class="hljs-string">'%010d'</span> % <span class="hljs-type">int</span>(r.<span class="hljs-keyword">group</span>(<span class="hljs-number">1</span>))) + r.<span class="hljs-keyword">group</span>(<span class="hljs-number">2</span>)
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> js_nsort(x <span class="hljs-type">text</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">text</span> 
   <span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">IMMUTABLE</span> <span class="hljs-keyword">AS</span> $$<span class="ruby">
var m = x.match(<span class="hljs-regexp">/^\s*(\d+)(.*)$/</span>);
<span class="hljs-keyword">if</span>(m) { <span class="hljs-keyword">return</span> m[<span class="hljs-number">1</span>].padStart(<span class="hljs-number">10</span>-m[<span class="hljs-number">1</span>].length,<span class="hljs-string">'0'</span>) + m[<span class="hljs-number">2</span>]; }
<span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> x; } 
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi biblioteca de 15.5 mil art√≠culos de revistas, una consulta que usa una funci√≥n en PL / Perl toma aproximadamente 64 ms contra 120 ms en PL / Python y 200 ms en PL / PgSQL. </font><font style="vertical-align: inherit;">Pero el m√°s r√°pido: PL / v8: 54 ms. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuando experimente con la ordenaci√≥n, proporcione la cantidad necesaria de memoria de trabajo para que la ordenaci√≥n se guarde en la memoria (se mostrar√° EXPLAIN </font></font><code>Sort Method: quicksort</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">La cantidad de memoria se establece mediante el par√°metro </font></font><code>work_mem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">set</span> work_mem = <span class="hljs-string">'20MB'</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memoria</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Perl no le gustan las estructuras en bucle; no sabe c√≥mo limpiarlas. </font><font style="vertical-align: inherit;">Si </font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene un puntero a </font></font><code>b</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y un </font></font><code>b</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puntero a </font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces el contador de referencia nunca se restablecer√° y la memoria no se liberar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los idiomas de recolecci√≥n de basura tienen otros problemas. </font><font style="vertical-align: inherit;">No se sabe, por ejemplo, cu√°ndo se liberar√° la memoria o si se liberar√° en absoluto. </font><font style="vertical-align: inherit;">O, si no se ocupa de esto a prop√≥sito, los recolectores ir√°n a recoger la basura en el momento m√°s inoportuno. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero tambi√©n hay funciones de administraci√≥n de memoria directamente relacionadas con Postgres. </font><font style="vertical-align: inherit;">Hay estructuras que SPI asigna, y Perl no siempre se da cuenta de que necesitan ser liberadas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
NO es as√≠:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">function</span> cr()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span> <span class="hljs-keyword">LANGUAGE</span> plperl <span class="hljs-keyword">AS</span>
$$<span class="perl">
     <span class="hljs-keyword">return</span> spi_exec_query(
           <span class="hljs-string">'SELECT count(*) FROM pg_class'</span>
     )-&gt;{rows}-&gt;[<span class="hljs-number">0</span>]-&gt;{count};
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠ contin√∫a:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">function</span> cr()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span> <span class="hljs-keyword">LANGUAGE</span> plperl <span class="hljs-keyword">AS</span>
$$<span class="perl">
     <span class="hljs-keyword">my</span> $h = spi_prepare(
          <span class="hljs-string">'SELECT count(*) FROM pg_class'</span>
     );
     <span class="hljs-keyword">return</span> spi_exec_prepared($h)-&gt;{rows}-&gt;[<span class="hljs-number">0</span>]-&gt;{count};
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de la ejecuci√≥n, el controlador </font></font><code>$h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seguir√° vivo, a pesar del hecho de que no queda un solo v√≠nculo vivo con √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° bien, solo necesita recordar la necesidad de liberar recursos expl√≠citamente con </font></font><code>spi_freeplan($h)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">function</span> cr()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span> <span class="hljs-keyword">LANGUAGE</span> plperl <span class="hljs-keyword">AS</span>
$$<span class="perl">
     <span class="hljs-keyword">my</span> $h = spi_prepare(
          <span class="hljs-string">'select count(*) from pg_class'</span>
     );
     <span class="hljs-keyword">my</span> $res = spi_exec_prepared($h)-&gt;{rows}-&gt;[<span class="hljs-number">0</span>]-&gt;{count};
     spi_freeplan($h);
     <span class="hljs-keyword">return</span> $res;
$$</span>;</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Python </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nunca fluye</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el plan se lanza autom√°ticamente:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">function</span> cr3() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">LANGUAGE</span> plpythonu <span class="hljs-keyword">as</span>
$$<span class="pgsql">
     <span class="hljs-keyword">return</span> plpy.<span class="hljs-keyword">execute</span>(
           <span class="hljs-string">'select count(*) from pg_class'</span>
     )[<span class="hljs-number">0</span>][<span class="hljs-string">'count'</span>]
$$</span>;</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Misma historia que Perl. </font><font style="vertical-align: inherit;">No fluye as√≠:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> crq() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">AS</span>
$$<span class="pgsql">
     <span class="hljs-keyword">return</span> plv8.<span class="hljs-keyword">execute</span>(
          <span class="hljs-string">'select count(*) from pg_class‚Äò
     )[0].count;
$$</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠ contin√∫a:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> crq() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">AS</span>
$$<span class="pgsql">
     var h = plv8.<span class="hljs-keyword">prepare</span>(
          <span class="hljs-string">'select count(*) from pg_class'</span>
     );
     <span class="hljs-keyword">return</span> h.<span class="hljs-keyword">execute</span>()[<span class="hljs-number">0</span>].count;
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuevamente: no te olvides de liberar recursos. </font><font style="vertical-align: inherit;">Aqu√≠ lo hace. </font></font><code>h.free();</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No fluye:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> crq() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">AS</span>
$$<span class="pgsql">
     var h = plv8.<span class="hljs-keyword">prepare</span>(
          <span class="hljs-string">'select count(*) from pg_class'</span>
     );
     var r = h.<span class="hljs-keyword">execute</span>()[<span class="hljs-number">0</span>].count;
     h.free();
     <span class="hljs-keyword">return</span> r;
$$</span>;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par√°metros</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es hora de entender c√≥mo se pasan los argumentos a las funciones. </font><font style="vertical-align: inherit;">En los ejemplos, pasaremos 4 par√°metros con tipos a la funci√≥n:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una matriz;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bytea y</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo </font><font style="vertical-align: inherit;">
entran en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> crq(a <span class="hljs-type">int</span>, b
<span class="hljs-type">bytea</span>, c <span class="hljs-type">int</span>[], d <span class="hljs-type">jsonb</span> ) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">void</span>
<span class="hljs-keyword">LANGUAGE</span> plperl <span class="hljs-keyword">AS</span>
$$<span class="perl">
    <span class="hljs-keyword">warn</span> Dumper(@_);
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> crq(<span class="hljs-number">1</span>,<span class="hljs-string">'abcd'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<span class="hljs-string">'{"a":2,"b":3}'</span>);</code></pre><br>
<pre><code class="plaintext hljs"><font></font>
WARNING:  $VAR1 = '1';<font></font>
$VAR2 = '\\x61626364';<font></font>
$VAR3 = bless( {<font></font>
                 'array' =&gt; [<font></font>
                              '1',<font></font>
                              '2',<font></font>
                              '3'<font></font>
                            ],<font></font>
                 'typeoid' =&gt; 1007<font></font>
               }, 'PostgreSQL::InServer::ARRAY' );<font></font>
$VAR4 = '{"a": 2, "b": 3}';<font></font>
 crq <font></font>
-----<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øSer√° JSON o JSONB? En este caso, no hay diferencia: todav√≠a tienen la forma de una cadena. Esta es una tarifa para la versatilidad: Postgres tiene muchos tipos, de diversos grados de "incrustaci√≥n". Exigirle al desarrollador que con el nuevo tipo que proporciona de inmediato y funciones de conversi√≥n para todos los PL / * ser√≠a demasiado. Por defecto, muchos tipos se pasan como cadenas. Pero esto no siempre es conveniente, debe analizar estos t√©rminos. Por supuesto, me gustar√≠a que los datos de Postgres se conviertan inmediatamente en las estructuras Perl apropiadas. Por defecto, esto no sucede, pero a partir de 9.6, apareci√≥ el mecanismo TRANSFORM - la capacidad de definir funciones de conversi√≥n de tipo: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TRANSFORM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para crear TRANSFORMAR, debe escribir dos funciones en C: una convertir√° datos de cierto tipo a un lado y el otro a la inversa. </font><font style="vertical-align: inherit;">Tenga en cuenta que TRANSFORM funciona en cuatro lugares:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al pasar par√°metros a una funci√≥n;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al devolver un valor de funci√≥n;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al pasar par√°metros a una llamada SPI dentro de una funci√≥n;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al recibir el resultado de la llamada SPI dentro de la funci√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TRANSFORM JSONB para Perl y Python, desarrollado por Anton Bykov, apareci√≥ en la 11¬™ versi√≥n de Postgres. </font><font style="vertical-align: inherit;">Ahora no necesita analizar JSONB, entra en Perl de inmediato como la estructura correspondiente. </font><font style="vertical-align: inherit;">Debe crear la extensi√≥n jsonb_plperl, y luego puede usar TRANSFORMAR:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> jsonb_plperl;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> crq2(d <span class="hljs-type">jsonb</span>)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">void</span> <span class="hljs-keyword">LANGUAGE</span> plperl
<span class="hljs-keyword">TRANSFORM</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">TYPE</span> <span class="hljs-type">jsonb</span> <span class="hljs-keyword">AS</span> $$<span class="perl">
     <span class="hljs-keyword">warn</span> Dumper(@_);
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede llamar a esta funci√≥n para verificar que JSONB se haya convertido en un hash de perlas:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> crq2( <span class="hljs-string">'{"a":2,"b":3}'</span>);</code></pre><br>
<pre><code class="plaintext hljs"><font></font>
WARNING:  $VAR1 = {<font></font>
          'a' =&gt; '2',<font></font>
          'b' =&gt; '3'<font></font>
        };<font></font>
 crq2 <font></font>
------<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Un asunto completamente diferente! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El autor de este art√≠culo tambi√©n particip√≥ en el desarrollo de TRANSFORMAS. Result√≥ que un tipo de datos tan simple, como se </font></font><code>boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pasa a PL / Perl en una forma inconveniente, como cadenas de texto </font></font><code>'t'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>'f'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pero en el entendimiento de Perl, la cadena 'f' es verdadera. Para eliminar las molestias, se invent√≥ un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parche que defin√≠a la conversi√≥n para el tipo booleano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este parche lleg√≥ a PostgreSQL 13 y estar√° disponible pronto. Debido a su simplicidad, bool_plperl puede servir como un modelo inicial m√≠nimo para escribir cualquier otra conversi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que alguien desarrolle TRANSFORM para otros tipos de datos (bytea, matrices, fechas, num√©ricos). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos c√≥mo se pasan los par√°metros en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> jsonb_plpython3u;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> pdump(a <span class="hljs-type">int</span>, b <span class="hljs-type">bytea</span>, c <span class="hljs-type">int</span>[], d <span class="hljs-type">jsonb</span> ) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">void</span>
<span class="hljs-keyword">LANGUAGE</span> plpython3u
<span class="hljs-keyword">TRANSFORM</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">TYPE</span> <span class="hljs-type">jsonb</span> <span class="hljs-keyword">AS</span> $$<span class="pgsql">
      plpy.<span class="hljs-built_in">warning</span>(a,b,c,d)
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> pdump(<span class="hljs-number">1</span>,<span class="hljs-string">'abcd'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<span class="hljs-string">'{"a":2,"b":3}'</span>);</code></pre><br>
<pre><code class="plaintext hljs"><font></font>
WARNING:  (1, b'abcd', [1, 2, 3], {'a': Decimal('2'), 'b': Decimal('3')})<font></font>
 pdump <font></font>
-------<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una matriz se convierte en una matriz; esto es bueno (ya que las matrices multidimensionales de la versi√≥n PG10 tambi√©n se transfieren correctamente a Python). </font><font style="vertical-align: inherit;">En Perl, una matriz se convirti√≥ en un objeto de una clase especial. </font><font style="vertical-align: inherit;">Bueno, </font></font><code>jsonb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transformado. </font><font style="vertical-align: inherit;">Sin TRANSFORMAR, jsonb se pasar√° como una cadena. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos de qu√© forma los par√°metros entran en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> jsdump(a <span class="hljs-type">int</span>, b <span class="hljs-type">bytea</span>, c <span class="hljs-type">int</span>[], d <span class="hljs-type">jsonb</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">void</span>
<span class="hljs-keyword">LANGUAGE</span> plv8 <span class="hljs-keyword">AS</span> $$<span class="pgsql">
     plv8.elog(<span class="hljs-built_in">WARNING</span>,a,b,c,d)
$$</span>;</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> jsdump(<span class="hljs-number">1</span>,<span class="hljs-string">'abcd'</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<span class="hljs-string">'{"a":2,"b":3}'</span>);</code></pre><br>
<pre><code class="plaintext hljs"><font></font>
WARNING:  1 97,98,99,100 1,2,3 [object Object]<font></font>
jsdump <font></font>
-------<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JSONB convertido a un objeto JavaScript sin ninguna TRANSFORMACI√ìN! </font><font style="vertical-align: inherit;">Los tipos temporales de Postgres tambi√©n se convierten al tipo Fecha JS. </font><font style="vertical-align: inherit;">Lo mismo con boolean. </font><font style="vertical-align: inherit;">Todas las transformaciones ya est√°n integradas en PL / V8.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajar con infinito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La constante INFINITY no se usa muy a menudo, pero el trabajo descuidado con ella es peligroso. </font><font style="vertical-align: inherit;">En PostgreSQL, Infinity e -Infinity existen como valores especiales para algunos tipos temporales y de punto flotante. </font><font style="vertical-align: inherit;">Pero la transferencia de Infinity a los lenguajes de procedimiento y viceversa debe discutirse en detalle, ya que trabajar con ellos puede depender no solo del idioma, sino tambi√©n de las bibliotecas, el sistema operativo e incluso el hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python tiene un m√≥dulo Numpy que define el infinito num√©rico:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> nm<font></font>
a = nm.inf<font></font>
b = -nm.inf<font></font>
print(a, b)</code></pre><br>
<pre><code class="plaintext hljs">inf -inf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perl tambi√©n tiene infinito, usa una cadena </font></font><code>"infinity"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que se puede acortar </font></font><code>"inf"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por ejemplo, podr√≠as decir:</font></font><br>
<br>
<pre><code class="perl hljs">perl -e <span class="hljs-string">'print 1 * "inf"'</span></code></pre><br>
<pre><code class="plaintext hljs">Inf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o</font></font><br>
<br>
<pre><code class="perl hljs">perl -e <span class="hljs-string">'print 1/"inf"'</span></code></pre><br>
<pre><code class="plaintext hljs">0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En PL / Perl, PL / Python, PL / v8, el infinito num√©rico de Postgres se pasa correctamente, pero una fecha infinita no es del todo correcta. </font><font style="vertical-align: inherit;">Por el contrario, en PL / Perl y PL / Python no hay un tipo de datos incorporado para el tiempo, una cadena llega all√≠. </font><font style="vertical-align: inherit;">En PL / V8, hay una fecha de tipo incorporada, y la fecha habitual de un postgres se convierte en ella. </font><font style="vertical-align: inherit;">Pero el V8 no conoce la fecha sin fin, y cuando se transfiere, se convierte en </font></font><code>Invalid Date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasar par√°metros a solicitudes preparadas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De vuelta a </font></font><code>prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, considere c√≥mo se pasan los par√°metros all√≠. </font><font style="vertical-align: inherit;">Los diferentes idiomas tienen mucho en com√∫n, ya que todos est√°n basados ‚Äã‚Äãen SPI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando prepara una consulta en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , debe determinar el tipo de par√°metros que se transfieren, y al ejecutar la consulta, solo especifica los valores de estos par√°metros (los par√°metros se transfieren a PL / pgSQL de la misma manera).</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plperl $$<span class="perl">
     <span class="hljs-keyword">my</span> $h= spi_prepare(<span class="hljs-string">'SELECT * FROM pg_class WHERE
          relname ~ $1'</span>, <span class="hljs-string">'text'</span> );                     <span class="hljs-comment">#   </span>
     <span class="hljs-keyword">warn</span> Dumper(spi_exec_prepared($h, <span class="hljs-string">'pg_language'</span>)); <span class="hljs-comment">#   </span>
     spi_freeplan($h);
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python, la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esencia es la misma, pero la sintaxis es ligeramente diferente:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plpython3u $$<span class="pgsql">
     h= plpy.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT relname FROM pg_class WHERE relname ~ $1'</span>, [<span class="hljs-string">'text'</span>] )
     plpy.<span class="hljs-keyword">notice</span>(.<span class="hljs-keyword">execute</span> ([<span class="hljs-string">'pg_language'</span>]))
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8, las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diferencias son m√≠nimas:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plv8 $$<span class="pgsql">
    var h= plv8.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT relname FROM pg_class WHERE relname ~ $1'</span>, [<span class="hljs-string">'text'</span>] );
    plv8.elog(<span class="hljs-keyword">NOTICE</span>, h.<span class="hljs-keyword">execute</span> ([<span class="hljs-string">'pg_language'</span>]));
    h.free();
$$</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Java,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo es diferente. </font><font style="vertical-align: inherit;">All√≠, SPI claramente no se usa, pero se forma una conexi√≥n pseudo-JDBC a la base de datos. </font><font style="vertical-align: inherit;">Para un programador PL / Java, todo sucede como si estuviera creando una aplicaci√≥n cliente. </font><font style="vertical-align: inherit;">Esto es conveniente, y tambi√©n se podr√≠a abordar el dise√±o de PL / Perl y PL / Python, pero por alguna raz√≥n esto no se hizo (sin embargo, nadie proh√≠be crear un par de implementaciones m√°s de PL / Perl y PL / Python).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabaja con cursor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las funciones SPI que utilizamos cuando fuimos a la base de datos, </font></font><code>spi_exec_query()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y otras, tienen un par√°metro que limita el n√∫mero de filas devueltas. </font><font style="vertical-align: inherit;">Si necesita muchas filas devueltas, no puede prescindir de un cursor para levantarlas un poco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los cursores funcionan en todos estos idiomas. </font><font style="vertical-align: inherit;">En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl,</font></font></b> <br>
<code>spi_exec_query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelve un cursor desde el que puede extraer cadenas de una en una. </font><font style="vertical-align: inherit;">No es necesario cerrar el cursor; se cerrar√° solo. </font><font style="vertical-align: inherit;">Pero si desea redescubrirlo nuevamente, puede cerrarlo expl√≠citamente con un comando </font></font><code>close()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plperl $$<span class="perl">
    <span class="hljs-keyword">my</span> $cursor = spi_query(<span class="hljs-string">'SELECT * FROM pg_class'</span>);
    <span class="hljs-keyword">my</span> $row;
    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">defined</span>($row = spi_fetchrow($cursor))) {
         <span class="hljs-keyword">warn</span> $row-&gt;{relname};
    }
$$</span>;</code></pre><br>
<pre><code class="plaintext hljs">WARNING:  pg_statistic at line 5.<font></font>
WARNING:  pg_toast_2604 at line 5.<font></font>
WARNING:  pg_toast_2604_index at line 5.<font></font>
WARNING:  pg_toast_2606 at line 5.<font></font>
WARNING:  pg_toast_2606_index at line 5.<font></font>
WARNING:  pg_toast_2609 at line 5.<font></font>
WARNING:  pg_toast_2609_index at line 5.<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo es muy similar, pero el cursor se presenta como un objeto que puede recorrer:</font></font><br>
<br>
<pre><code class="pgsql hljs">h = plpy.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT ...'</span>);
<span class="hljs-keyword">cursor</span> = plpy.<span class="hljs-keyword">cursor</span>(h);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">cursor</span>:<font></font>
...<font></font>
<span class="hljs-keyword">cursor</span>.<span class="hljs-keyword">close</span>() //  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / v8,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo tambi√©n es muy similar, pero no olvide liberar el plan de consulta preparado:</font></font><br>
<br>
<pre><code class="pgsql hljs">var h = plv.<span class="hljs-keyword">prepare</span>(<span class="hljs-string">'SELECT ...'</span>);<font></font>
var <span class="hljs-keyword">cursor</span> = h.<span class="hljs-keyword">cursor</span>();<font></font>
var <span class="hljs-keyword">row</span>;
<span class="hljs-keyword">while</span>(<span class="hljs-keyword">row</span> = <span class="hljs-keyword">cursor</span>.<span class="hljs-keyword">fetch</span>()) {<font></font>
...<font></font>
}<font></font>
<span class="hljs-keyword">cursor</span>.<span class="hljs-keyword">close</span>();<font></font>
h.free();</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8: acceso r√°pido a las funciones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En PL / V8, puede llamar a una funci√≥n no desde un SELECT normal, sino encontrarla por su nombre e iniciarla inmediatamente con </font></font><code>plv8.find_function(name);</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pero tenga en cuenta que en JS una funci√≥n no puede ser polim√≥rfica, como en PostgreSQL, en la que pueden coexistir funciones con el mismo nombre pero con diferentes par√°metros. </font><font style="vertical-align: inherit;">En PL / v8, por supuesto, podemos crear funciones polim√≥rficas, pero </font></font><code>find_function</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr√° un error </font><font style="vertical-align: inherit;">al intentar usarlo </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">ERROR:  Error: more than one function named "jsdump"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si una funci√≥n por nombre no es ambigua, entonces se puede invocar sin SPI y conversiones de tipo, es decir </font><font style="vertical-align: inherit;">mucho mas r√°pido. </font><font style="vertical-align: inherit;">Por ejemplo, as√≠:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DO</span> <span class="hljs-keyword">LANGUAGE</span> plv8 $$<span class="ruby">
plv8.find_function(<span class="hljs-string">'jsdump'</span>)(<span class="hljs-number">1</span>, <span class="hljs-string">'abc'</span>);
$$</span>;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postgres 11 se divierte mucho: han aparecido </font><font style="vertical-align: inherit;">procedimientos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reales</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Postgres sol√≠a tener solo caracter√≠sticas. </font><font style="vertical-align: inherit;">La alegr√≠a no solo se debe a la compatibilidad y el cumplimiento del est√°ndar SQL, sino tambi√©n por qu√©: dentro de los procedimientos, puede confirmar y revertir las transacciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / Perl y PL / Python ya tienen funciones SPI para administrar transacciones, mientras que PL / V8 todav√≠a no. </font><font style="vertical-align: inherit;">En PL / Perl, estas funciones se llaman </font></font><code>spi_commit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>spi_rollback()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y un ejemplo de uso se encuentra </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En PL / Python, esto es </font></font><code>plpy.commit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>plpy.rollback()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subtransacci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las subtransacciones son convenientes para el manejo correcto de errores en la l√≥gica compleja de m√∫ltiples niveles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / pgSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de una transacci√≥n, cada bloque con la palabra clave EXCEPTION es una subtransacci√≥n. Puede leer sobre algunos problemas de rendimiento y confiabilidad que pueden surgir en este caso, por ejemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font><font style="vertical-align: inherit;">hay subtransacciones expl√≠citas </font><font style="vertical-align: inherit;">en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Perl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero se pueden simular a trav√©s de savaepoints. Aparentemente, si lo desea, es f√°cil escribir un m√≥dulo perla que implemente subtransacciones de forma expl√≠cita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / Python, las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sub-transacciones aparecieron hace mucho tiempo: desde 9.5 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expl√≠cito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , antes de eso hab√≠a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impl√≠citas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Puede definir una transacci√≥n, envolverla en</font></font><code>try-</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y ejecutar </font><font style="vertical-align: inherit;">Si la subtransacci√≥n se cae, entonces caemos en el bloque </font></font><code>except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, si no se cae, entonces en el bloque </font></font><code>else</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y seguimos adelante.</font></font><br>
<br>
<pre><code class="pgsql hljs">try:
     <span class="hljs-keyword">with</span> plpy.subtransaction():<font></font>
          plpy.<span class="hljs-keyword">execute</span>("...")<font></font>
          plpy.<span class="hljs-keyword">execute</span>("...")
<span class="hljs-keyword">except</span> plpy.SPIError, e:<font></font>
. . .<font></font>
<span class="hljs-keyword">else</span>:<font></font>
. . .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe un dise√±o similar en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PL / V8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , solo en sintaxis JS.</font></font><br>
<br>
<pre><code class="pgsql hljs">try {<font></font>
plv8.subtransaction(<span class="hljs-keyword">function</span>() {<font></font>
plv8.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'UPDATE...'</span>);<font></font>
plv8.<span class="hljs-keyword">execute</span>(<span class="hljs-string">'UPDATE...'</span>);<font></font>
});<font></font>
}<font></font>
catch(e) {<font></font>
...<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intente, pero no abuse :) El conocimiento de PL / * puede traer algunos beneficios. </font><font style="vertical-align: inherit;">Como cualquier herramienta, les encanta ser utilizados para los fines previstos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PL / v8 es muy prometedor, pero a veces se comporta inesperadamente y tiene varios problemas. </font><font style="vertical-align: inherit;">Por lo tanto, es mejor sacar los idiomas de la caja si son adecuados para su tarea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiero agradecer a Igor Levshin (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Igor_Le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), quien me ayud√≥ mucho con la preparaci√≥n del material para el art√≠culo y arroj√≥ algunas ideas √∫tiles, as√≠ como a Yevgeny Sergeyev y Alexey Fadeev por las correcciones que propusieron.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502236/index.html">Modelado de aviones para ni√±os: a un nivel decente</a></li>
<li><a href="../es502246/index.html">¬øQu√© tienen en com√∫n las audaces respuestas de Alice con los drones?</a></li>
<li><a href="../es502248/index.html">Entr√≥ en vigor un nuevo GOST para recursos digitales: todas las plataformas deber√≠an ser accesibles para personas con discapacidad</a></li>
<li><a href="../es502250/index.html">Aviaci√≥n civil hoy: aspectos importantes y desaf√≠os en la capacitaci√≥n</a></li>
<li><a href="../es502252/index.html">Control remoto y drones</a></li>
<li><a href="../es502256/index.html">¬øC√≥mo visualizar un gr√°fico de Spring Integration usando Neo4j?</a></li>
<li><a href="../es502260/index.html">ESP-NOW es un protocolo de comunicaci√≥n alternativo para ESP8266 y ESP32. Conceptos b√°sicos</a></li>
<li><a href="../es502262/index.html">¬øPor qu√© AIOps y monitoreo general para el banco, o en qu√© se basan las relaciones con los clientes?</a></li>
<li><a href="../es502264/index.html">Infraestructura de Clave P√∫blica. Emisi√≥n de certificados en condiciones de autoaislamiento.</a></li>
<li><a href="../es502266/index.html">Aurora en la plataforma Intel. Amanecer de la Era Exaflops</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>