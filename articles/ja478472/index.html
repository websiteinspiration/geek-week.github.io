<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👉🏿 👩‍⚖️ 🤨 Linuxカーネルライブラリ：soまたはdllフォームファクターのLinuxカーネル 🤞🏼 🚡 🍙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="「どこでもどこでも機能するように」ファイルシステムの選択に関する記事を読んだ後、Ext4は素晴らしいファイルシステムであるという不満をもう一度見ましたが、Windowsでは曲線不正確な専有ドライバー。しかし、Habré（当時はGiktaymse）が Libos についてのニュースを飛ばしたもう2年前...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linuxカーネルライブラリ：soまたはdllフォームファクターのLinuxカーネル</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478472/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「どこでもどこでも機能するように」ファイルシステムの選択</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読んだ後</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">、</font></a><font style="vertical-align: inherit;">Ext4は素晴らしいファイルシステムであるという不満をもう一度見ましたが、Windowsでは</font></font><del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">曲線</font></font></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不正確な専有ドライバー。しかし、Habré（当時はGiktaymse）</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Libos </font><font style="vertical-align: inherit;">についてのニュースを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">飛ばし</font></a><font style="vertical-align: inherit;">た</font><font style="vertical-align: inherit;">もう2年前のテープを巻き戻し</font><font style="vertical-align: inherit;">ます。これは、通常のライブラリユーザーモードでLinuxカーネルを変換する試みです。ユーザー空間でのネットワークスタックの削除に重点が置かれました。かつて、私はこのプロジェクトが生きているかどうかを調べてみることに決めました。彼らのブログで、ある種のライバルである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Kernel Library（LKL）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトへのリンクを見つけました</font><font style="vertical-align: inherit;">。実際、これはいわばハードウェアアーキテクチャ「POSIX / Win32ユーザーモードライブラリ」へのカーネルポートです。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深いLKLとは何ですか？</font><font style="vertical-align: inherit;">まず、カーネルのコアコードベースではなくても、彼女が住んでいるという事実によって。</font><font style="vertical-align: inherit;">第二に、カーネルの大部分を自動的に利用可能にする「アーキテクチャ」に対する多かれ少なかれ正直なサポートです。</font><font style="vertical-align: inherit;">また、直接ユーティリティ-例が含まれます：</font></font><code>cptofs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>cpfromfs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>fs2tar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>lklfuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この記事では、ホストLinuxでLKLをテストし、ルートおよび仮想マシンなしでExt4イメージ（Btrfs、XFSなど）を含むファイルを確認し、Windowsでどのように試すことができるかについて簡単に説明します。</font></font></p><a name="habracut"></a><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項1：</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試してみたい-バックアップを作成します。</font><font style="vertical-align: inherit;">重要なデータを含むセクションでこれを行う場合-自分の危険とリスクで。</font><font style="vertical-align: inherit;">ただし、ここでは少なくともドライバーは本当にネイティブです。</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項2：</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライセンスを尊重します。</font><font style="vertical-align: inherit;">LKLリンクは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おそらく</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GPLプログラムを作成します。</font></font></p><br>
<h2 id="pervichnoe-znakomstvo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主な知人</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKLリポジトリ（</font><font style="vertical-align: inherit;">GitHubの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lkl / linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、通常のLinuxカーネルのフォークであり、別のアーキテクチャのサポートが追加されてい</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これは主に</font></font><code>arch/lkl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font><font style="vertical-align: inherit;">ディレクトリにあり</font></font><code>tools/lkl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">リポジトリのクローンを作成し、指示に従ってアセンブルしてみましょう。</font><font style="vertical-align: inherit;">実験では、リポジトリの履歴全体ではなく、指定された数の最近のコミットのみが含まれる浅いクローンを使用します。</font></font></p><br>
<pre><code class="plaintext hljs">$ git clone https://github.com/lkl/linux.git lkl-linux --depth 10<font></font>
$ cd lkl-linux<font></font>
$ patch -p 1 &lt;&lt;EOF<font></font>
diff --git a/tools/lkl/lib/hijack/xlate.c b/tools/lkl/lib/hijack/xlate.c<font></font>
index 03ccc6294..75368dcc2 100644<font></font>
--- a/tools/lkl/lib/hijack/xlate.c<font></font>
+++ b/tools/lkl/lib/hijack/xlate.c<font></font>
@@ -3,6 +3,7 @@<font></font>
 #include &lt;fcntl.h&gt;<font></font>
 #include &lt;sys/ioctl.h&gt;<font></font>
 #include &lt;sys/socket.h&gt;<font></font>
+#include &lt;linux/sockios.h&gt;<font></font>
 #undef st_atime<font></font>
 #undef st_mtime<font></font>
 #undef st_ctime<font></font>
EOF<font></font>
$ make -C tools/lkl -j4</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースを少し修正する必要がありましたが、最終的にはライブラリ</font></font><code>tools/lkl/lib/liblkl.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（そして静的</font><font style="vertical-align: inherit;">ライブラリ</font></font><code>tools/lkl/liblkl.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">も</font><font style="vertical-align: inherit;">取得しました</font><font style="vertical-align: inherit;">。</font></font></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nm -D tools / lkl / lib / liblkl.so</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">                 U __assert_fail<font></font>
                 U bind<font></font>
                 U calloc<font></font>
                 U clock_gettime<font></font>
                 U close<font></font>
                 w __cxa_finalize<font></font>
0000000000063b30 T dbg_entrance<font></font>
0000000000063f30 T dbg_handler<font></font>
                 U __errno_location<font></font>
                 U fcntl<font></font>
                 U fdatasync<font></font>
0000000000639580 D fd_net_ops<font></font>
                 U fgets<font></font>
                 U __fprintf_chk<font></font>
                 U free<font></font>
                 U fwrite<font></font>
                 U getc<font></font>
                 U getenv<font></font>
                 w __gmon_start__<font></font>
                 U if_nametoindex<font></font>
                 U inet_pton<font></font>
                 U ioctl<font></font>
                 U __isoc99_scanf<font></font>
                 w _ITM_deregisterTMCloneTable<font></font>
                 w _ITM_registerTMCloneTable<font></font>
0000000000061750 T jmp_buf_longjmp<font></font>
0000000000061720 T jmp_buf_set<font></font>
0000000000065470 T jsmn_init<font></font>
0000000000065060 T jsmn_parse<font></font>
0000000000065490 T jsmn_strerror<font></font>
00000000000614c0 T lkl_add_gateway<font></font>
0000000000061290 T lkl_add_neighbor<font></font>
00000000000621a0 T lkl_bug<font></font>
000000000005f070 T lkl_closedir<font></font>
0000000000639520 D lkl_dev_blk_ops<font></font>
000000000005fa10 T lkl_dirfd<font></font>
0000000000062640 T lkl_disk_add<font></font>
0000000000062780 T lkl_disk_remove<font></font>
000000000005ec50 T lkl_encode_dev_from_sysfs<font></font>
000000000005f9f0 T lkl_errdir<font></font>
000000000005ef80 T lkl_fdopendir<font></font>
0000000000067f10 T lkl_get_free_irq<font></font>
000000000005f2c0 T lkl_get_virtio_blkdev<font></font>
00000000006395c0 D lkl_host_ops<font></font>
00000000000614b0 T lkl_if_add_gateway<font></font>
00000000000613e0 T lkl_if_add_ip<font></font>
00000000000614a0 T lkl_if_add_linklocal<font></font>
0000000000061520 T lkl_if_add_rule_from_saddr<font></font>
0000000000061480 T lkl_if_del_ip<font></font>
0000000000060d70 T lkl_if_down<font></font>
0000000000060b10 T lkl_ifname_to_ifindex<font></font>
0000000000061400 T lkl_if_set_ipv4<font></font>
0000000000061530 T lkl_if_set_ipv4_gateway<font></font>
0000000000061430 T lkl_if_set_ipv6<font></font>
00000000000615b0 T lkl_if_set_ipv6_gateway<font></font>
0000000000060ef0 T lkl_if_set_mtu<font></font>
0000000000060bf0 T lkl_if_up<font></font>
0000000000061160 T lkl_if_wait_ipv6_dad<font></font>
000000000005fba0 T lkl_iomem_access<font></font>
000000000005fb50 T lkl_ioremap<font></font>
0000000000067730 T lkl_is_running<font></font>
0000000000066150 T lkl_load_config_env<font></font>
0000000000065950 T lkl_load_config_json<font></font>
0000000000066880 T lkl_load_config_post<font></font>
0000000000066510 T lkl_load_config_pre<font></font>
000000000005f470 T lkl_mount_dev<font></font>
000000000005eae0 T lkl_mount_fs<font></font>
00000000000642a0 T lkl_netdev_add<font></font>
00000000000645c0 T lkl_netdev_free<font></font>
0000000000061030 T lkl_netdev_get_ifindex<font></font>
0000000000064e70 T lkl_netdev_macvtap_create<font></font>
0000000000064ed0 T lkl_netdev_pipe_create<font></font>
0000000000064ce0 T lkl_netdev_raw_create<font></font>
00000000000644c0 T lkl_netdev_remove<font></font>
0000000000064c60 T lkl_netdev_tap_create<font></font>
0000000000064a10 T lkl_netdev_tap_init<font></font>
000000000005eea0 T lkl_opendir<font></font>
0000000000062170 T lkl_perror<font></font>
00000000000620b0 T lkl_printf<font></font>
0000000000067f90 T lkl_put_irq<font></font>
0000000000061620 T lkl_qdisc_add<font></font>
0000000000061630 T lkl_qdisc_parse_add<font></font>
000000000005f0f0 T lkl_readdir<font></font>
0000000000063f80 T lkl_register_dbg_handler<font></font>
0000000000064930 T lkl_register_netdev_fd<font></font>
000000000005efe0 T lkl_rewinddir<font></font>
000000000005fa20 T lkl_set_fd_limit<font></font>
00000000000614e0 T lkl_set_ipv4_gateway<font></font>
0000000000061500 T lkl_set_ipv6_gateway<font></font>
0000000000065f60 T lkl_show_config<font></font>
00000000004f51ad T lkl_start_kernel<font></font>
0000000000062080 T lkl_strerror<font></font>
00000000000685f0 T lkl_syscall<font></font>
0000000000062270 T lkl_sysctl<font></font>
0000000000062410 T lkl_sysctl_parse_write<font></font>
0000000000067770 T lkl_sys_halt<font></font>
00000000000680e0 T lkl_trigger_irq<font></font>
000000000005f870 T lkl_umount_dev<font></font>
000000000005edc0 T lkl_umount_timeout<font></font>
0000000000066ed0 T lkl_unload_config<font></font>
00000000008186a0 B lkl_virtio_devs<font></font>
                 U __longjmp_chk<font></font>
                 U lseek64<font></font>
                 U malloc<font></font>
                 U memchr<font></font>
                 U memcpy<font></font>
                 U memset<font></font>
                 U open<font></font>
                 U perror<font></font>
                 U pipe<font></font>
                 U poll<font></font>
0000000000064070 T poll_thread<font></font>
                 U pread64<font></font>
                 U __printf_chk<font></font>
                 U pthread_create<font></font>
                 U pthread_detach<font></font>
                 U pthread_exit<font></font>
                 U pthread_getspecific<font></font>
                 U pthread_join<font></font>
                 U pthread_key_create<font></font>
                 U pthread_key_delete<font></font>
                 U pthread_mutexattr_init<font></font>
                 U pthread_mutexattr_settype<font></font>
                 U pthread_mutex_destroy<font></font>
                 U pthread_mutex_init<font></font>
                 U pthread_mutex_lock<font></font>
                 U pthread_mutex_unlock<font></font>
                 U pthread_self<font></font>
                 U pthread_setspecific<font></font>
                 U puts<font></font>
                 U pwrite64<font></font>
                 U read<font></font>
                 U readv<font></font>
00000000008196a0 B registered_devs<font></font>
000000000005fa90 T register_iomem<font></font>
                 U sem_destroy<font></font>
                 U sem_init<font></font>
                 U sem_post<font></font>
                 U sem_wait<font></font>
                 U _setjmp<font></font>
                 U setsockopt<font></font>
                 U sigaction<font></font>
                 U sigemptyset<font></font>
                 U __snprintf_chk<font></font>
                 U socket<font></font>
                 U __stack_chk_fail<font></font>
                 U stderr<font></font>
                 U stdin<font></font>
                 U stpcpy<font></font>
                 U strchr<font></font>
                 U strcpy<font></font>
                 U __strcpy_chk<font></font>
                 U strdup<font></font>
                 U strerror<font></font>
                 U strlen<font></font>
                 U strncat<font></font>
                 U __strncat_chk<font></font>
                 U strncmp<font></font>
                 U strncpy<font></font>
                 U strrchr<font></font>
                 U strtok<font></font>
                 U strtok_r<font></font>
                 U strtol<font></font>
                 U strtoul<font></font>
                 U syscall<font></font>
                 U timer_create<font></font>
                 U timer_delete<font></font>
                 U timer_settime<font></font>
000000000005fb00 T unregister_iomem<font></font>
                 U usleep<font></font>
0000000000063110 T virtio_dev_cleanup<font></font>
0000000000062ee0 T virtio_dev_setup<font></font>
0000000000063100 T virtio_get_num_bootdevs<font></font>
0000000000062c10 T virtio_process_queue<font></font>
0000000000062af0 T virtio_req_complete<font></font>
0000000000062ec0 T virtio_set_queue_max_merge_len<font></font>
                 U __vsnprintf_chk<font></font>
                 U write<font></font>
                 U writev</code></pre></div></div><br>
<p>    ,  .  ,       <code>lkl_syscall</code>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>syscall</code></a>  LKL.             <code>lkl_sys_&lt;name&gt;</code>.        «»,     ,     «»  ,     libc. ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>getdents</code></a>, … «These are not the interfaces you are interested in.» —     man-.          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>readdir (3)</code></a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>readdir (2)</code></a> —   ,   x86_64   .      LKL    <code>lkl_opendir</code> / <code>lkl_readdir</code> / <code>lkl_closedir</code>.</p><br>
<h2 id="poprobuem-chto-nibud-napisat"> - </h2><br>
<p><strong>,  .  Linux kernel   GPL2,   ,      LKL    —   .</strong></p><br>
<p> ,     . ,   <code>$LKL</code>       LKL.</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"lkl_host.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"lkl.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// lkl_host_ops      </span>
    <span class="hljs-comment">//     "-" : `printk`, `panic`, ...</span>
    <span class="hljs-comment">// ,    --    </span>
    lkl_start_kernel(&amp;lkl_host_ops, <span class="hljs-string">"mem=128M"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>:</p><br>
<pre><code class="plaintext hljs">$ gcc test.c -o test -I$LKL/tools/lkl/include -L$LKL/tools/lkl/lib -llkl</code></pre><br>
<p>  !</p><br>
<pre><code class="plaintext hljs">$ ./test<font></font>
./test: error while loading shared libraries: liblkl.so: cannot open shared object file: No such file or directory<font></font>
$ LD_LIBRARY_PATH=$LKL/tools/lkl/lib ./test<font></font>
[    0.000000] Linux version 5.3.0+ (trosinenko@trosinenko-pc) (gcc version 9.2.1 20191008 (Ubuntu 9.2.1-9ubuntu2)) #1 Tue Dec 3 14:37:02 MSK 2019<font></font>
[    0.000000] memblock address range: 0x7fba8c000000 - 0x7fba93fff000<font></font>
[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 32319<font></font>
[    0.000000] Kernel command line: mem=128M<font></font>
[    0.000000] Dentry cache hash table entries: 16384 (order: 5, 131072 bytes, linear)<font></font>
[    0.000000] Inode-cache hash table entries: 8192 (order: 4, 65536 bytes, linear)<font></font>
[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off<font></font>
[    0.000000] Memory available: 129044k/131068k RAM<font></font>
[    0.000000] SLUB: HWalign=32, Order=0-3, MinObjects=0, CPUs=1, Nodes=1<font></font>
[    0.000000] NR_IRQS: 4096<font></font>
[    0.000000] lkl: irqs initialized<font></font>
[    0.000000] clocksource: lkl: mask: 0xffffffffffffffff max_cycles: 0x1cd42e4dffb, max_idle_ns: 881590591483 ns<font></font>
[    0.000000] lkl: time and timers initialized (irq1)<font></font>
[    0.000003] pid_max: default: 4096 minimum: 301<font></font>
[    0.000019] Mount-cache hash table entries: 512 (order: 0, 4096 bytes, linear)<font></font>
[    0.000022] Mountpoint-cache hash table entries: 512 (order: 0, 4096 bytes, linear)<font></font>
[    0.003622] random: get_random_bytes called from _etext+0xbcdb/0x14b05 with crng_init=0<font></font>
[    0.003692] printk: console [lkl_console0] enabled<font></font>
[    0.003707] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns<font></font>
[    0.003714] xor: automatically using best checksumming function   8regs<font></font>
[    0.003783] NET: Registered protocol family 16<font></font>
[    0.171647] raid6: int64x8  gen()  4489 MB/s<font></font>
[    0.343119] raid6: int64x8  xor()  3165 MB/s<font></font>
[    0.514836] raid6: int64x4  gen()  4668 MB/s<font></font>
[    0.689529] raid6: int64x4  xor()  3256 MB/s<font></font>
[    0.861155] raid6: int64x2  gen()  6283 MB/s<font></font>
[    1.032668] raid6: int64x2  xor()  3793 MB/s<font></font>
[    1.206752] raid6: int64x1  gen()  5185 MB/s<font></font>
[    1.378219] raid6: int64x1  xor()  2901 MB/s<font></font>
[    1.378225] raid6: using algorithm int64x2 gen() 6283 MB/s<font></font>
[    1.378227] raid6: .... xor() 3793 MB/s, rmw enabled<font></font>
[    1.378229] raid6: using intx1 recovery algorithm<font></font>
[    1.378333] clocksource: Switched to clocksource lkl<font></font>
[    1.378427] NET: Registered protocol family 2<font></font>
[    1.378516] tcp_listen_portaddr_hash hash table entries: 256 (order: 0, 4096 bytes, linear)<font></font>
[    1.378521] TCP established hash table entries: 1024 (order: 1, 8192 bytes, linear)<font></font>
[    1.378527] TCP bind hash table entries: 1024 (order: 1, 8192 bytes, linear)<font></font>
[    1.378532] TCP: Hash tables configured (established 1024 bind 1024)<font></font>
[    1.378596] UDP hash table entries: 128 (order: 0, 4096 bytes, linear)<font></font>
[    1.378618] UDP-Lite hash table entries: 128 (order: 0, 4096 bytes, linear)<font></font>
[    1.379286] workingset: timestamp_bits=62 max_order=16 bucket_order=0<font></font>
[    1.380271] SGI XFS with ACLs, security attributes, no debug enabled<font></font>
[    1.380864] io scheduler mq-deadline registered<font></font>
[    1.380872] io scheduler kyber registered<font></font>
[    1.383396] NET: Registered protocol family 10<font></font>
[    1.383763] Segment Routing with IPv6<font></font>
[    1.383779] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver<font></font>
[    1.384091] Btrfs loaded, crc32c=crc32c-generic<font></font>
[    1.384223] Warning: unable to open an initial console.<font></font>
[    1.384237] This architecture does not have kernel memory protection.<font></font>
[    1.384239] Run /init as init process</code></pre><br>
<p>    timestamp',     «»    ,     <del> </del>.</p><br>
<h2 id="uslozhnyaem-eksperiment"> </h2><br>
<p>   - -    — -   !    user space    Ext4-.  «» !    <code>tools/lkl/cptofs.c</code>      ( ):</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NDEBUG</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"lkl_host.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"lkl.h"</span></span><font></font>
<font></font>
<span class="hljs-comment">//        ,</span>
<span class="hljs-comment">//     --     :)</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * <span class="hljs-keyword">const</span> fsimage = argv[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * <span class="hljs-keyword">const</span> fstype = argv[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * <span class="hljs-keyword">const</span> file_to_dump = argv[<span class="hljs-number">3</span>];<font></font>
<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lkl_disk</span> <span class="hljs-title">disk</span>;</span>
  <span class="hljs-keyword">int</span> disk_id, ret;
  <span class="hljs-keyword">char</span> mpoint[<span class="hljs-number">128</span>];<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-built_in">memset</span>(&amp;disk, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(disk));<font></font>
  disk.fd = open(fsimage, O_RDONLY);<font></font>
  assert(disk.fd &gt;= <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">//     </span><font></font>
  disk_id = lkl_disk_add(&amp;disk);<font></font>
  assert(disk_id &gt;= <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">//  </span>
  lkl_start_kernel(&amp;lkl_host_ops, <span class="hljs-string">"mem=128M"</span>);<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  ret = lkl_mount_dev(disk_id, <span class="hljs-number">0</span> <span class="hljs-comment">/* part */</span>, fstype,<font></font>
                      LKL_MS_RDONLY, <span class="hljs-literal">NULL</span>,<font></font>
                      mpoint, <span class="hljs-keyword">sizeof</span>(mpoint));<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"lkl_mount_dev failed: %s\n"</span>, lkl_strerror(ret));<font></font>
    close(disk.fd);<font></font>
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ,    ...</span>
  <span class="hljs-comment">// ( -libc )</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lkl_dir</span> *<span class="hljs-title">dir</span> = <span class="hljs-title">lkl_opendir</span>(<span class="hljs-title">mpoint</span>, &amp;<span class="hljs-title">ret</span>);</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lkl_linux_dirent64</span> *<span class="hljs-title">dent</span>;</span>
  <span class="hljs-keyword">while</span> ((dent = lkl_readdir(dir)) != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Directory entry: %s\n"</span>, dent-&gt;d_name);<font></font>
  }<font></font>
  <span class="hljs-comment">//     : NULL --     ...</span><font></font>
  lkl_closedir(dir);<font></font>
<font></font>
  <span class="hljs-comment">//   -</span>
  <span class="hljs-comment">//       </span>
  <span class="hljs-keyword">char</span> tmp[<span class="hljs-number">256</span>];
  <span class="hljs-keyword">uint8_t</span> buffer[<span class="hljs-number">65536</span>];
  <span class="hljs-built_in">snprintf</span>(tmp, <span class="hljs-keyword">sizeof</span>(tmp), <span class="hljs-string">"%s/%s"</span>, mpoint, file_to_dump);
  <span class="hljs-keyword">int</span> fd = lkl_sys_open(tmp, LKL_O_RDONLY, <span class="hljs-number">0</span>);
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"fd = %d\n"</span>, fd);<font></font>
  assert(fd &gt;= <span class="hljs-number">0</span>);
  <span class="hljs-keyword">int</span> count = lkl_sys_read(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
  <span class="hljs-comment">/*  */</span> write(STDERR_FILENO, buffer, count);<font></font>
  lkl_sys_close(fd);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
<p>    define'   <code>LKL_</code> (, <code>LKL_O_RDONLY</code>):  Linux- ,  ,   ,   ,      —  .</p><br>
<pre><code class="plaintext hljs">$ mke2fs ext4.img -t ext4 32M<font></font>
$ sudo mount ext4.img /mnt<font></font>
$ echo -e "Hello world\!\nTEST" | sudo tee /mnt/test.txt<font></font>
$ sudo umount /mnt<font></font>
$ LD_LIBRARY_PATH=$LKL/tools/lkl/lib ./read-file ext4.img ext4 test.txt<font></font>
[    0.000000] Linux version 5.3.0+ (trosinenko@trosinenko-pc) (gcc version 9.2.1 20191008 (Ubuntu 9.2.1-9ubuntu2)) #1 Tue Dec 3 14:37:02 MSK 2019<font></font>
// ... //<font></font>
[    1.378960] Warning: unable to open an initial console.<font></font>
[    1.378975] This architecture does not have kernel memory protection.<font></font>
[    1.378977] Run /init as init process<font></font>
[    1.379852] EXT4-fs (vda): mounted filesystem with ordered data mode. Opts:<font></font>
Directory entry: test.txt<font></font>
Directory entry: ..<font></font>
Directory entry: lost+found<font></font>
Directory entry: .<font></font>
fd = 0<font></font>
Hello world\!<font></font>
TEST</code></pre><br>
<p> , !  -  ?</p><br>
<pre><code class="plaintext hljs">$ mksquashfs test.c read-file.c squashfs.img<font></font>
$ LD_LIBRARY_PATH=$LKL/tools/lkl/lib ./read-file squashfs.img squashfs test.c<font></font>
[    0.000000] Linux version 5.3.0+ (trosinenko@trosinenko-pc) (gcc version 9.2.1 20191008 (Ubuntu 9.2.1-9ubuntu2)) #1 Tue Dec 3 14:37:02 MSK 2019<font></font>
// ... //<font></font>
[    1.378472] This architecture does not have kernel memory protection.<font></font>
[    1.378474] Run /init as init process<font></font>
lkl_mount_dev failed: No such device</code></pre><br>
<p>! , ,  , ,      -  SquashFS!</p><br>
<h2 id="nastraivaem-parametry-sborki-lkl">   LKL</h2><br>
<p>      ,    LKL — ,       <code>make defconfig</code>, <code>make menuconfig</code>, <code>make</code>.</p><br>
<pre><code class="plaintext hljs">$ make defconfig ARCH=lkl<font></font>
$ make menuconfig ARCH=lkl<font></font>
////   SquashFS     <font></font>
$ cp .config arch/lkl/configs/defconfig<font></font>
$ make mrproper<font></font>
$ make -C tools/lkl -j4 #    </code></pre><br>
<p> !</p><br>
<pre><code class="plaintext hljs">$ gcc read-file.c -o read-file -I$LKL/tools/lkl/include -L$LKL/tools/lkl/lib -llkl<font></font>
$ LD_LIBRARY_PATH=$LKL/tools/lkl/lib ./read-file squashfs.img squashfs test.c<font></font>
[    0.000000] Linux version 5.3.0+ (trosinenko@trosinenko-pc) (gcc version 9.2.1 20191008 (Ubuntu 9.2.1-9ubuntu2)) #1 Wed Dec 4 12:07:50 MSK 2019<font></font>
// ... //<font></font>
[    1.378346] This architecture does not have kernel memory protection.<font></font>
[    1.378348] Run /init as init process<font></font>
Directory entry: .<font></font>
Directory entry: ..<font></font>
Directory entry: read-file.c<font></font>
Directory entry: test.c<font></font>
fd = 0<font></font>
#include &lt;stdio.h&gt;<font></font>
<font></font>
#include "lkl_host.h"<font></font>
#include "lkl.h"<font></font>
<font></font>
int main()<font></font>
{<font></font>
    lkl_start_kernel(&amp;lkl_host_ops, "mem=128M");<font></font>
<font></font>
    return 0;<font></font>
}</code></pre><br>
<p>  , ,   <code>read-file.c</code>     — - .</p><br>
<h2 id="pozvolte-a-gde-obeschannye-gotovye-programmki">,     ?</h2><br>
<p> ,   <code>tools/lkl</code>  <code>cptofs.c</code>, <code>fs2tar.c</code>    ,    !   Makefile'  ,    <code>Makefile.autoconf</code>,     ,  <code>Makefile.conf</code>,    .</p><br>
<p>-, -  <code>libarchive</code>, - <code>libfuse</code> —   ,  <code>libarchive-dev</code>, <code>libfuse-dev</code> (  Ubuntu)  .    …    <code>Makefile.conf</code>… , !</p><br>
<p>,      ?    <code>tools/lkl</code>    <code>cptofs</code>, <code>fs2tar</code>  <code>lklfuse</code>.</p><br>
<p>   <code>cptofs</code>   <code>cpfromfs</code>:</p><br>
<pre><code class="plaintext hljs">$ $LKL/tools/lkl/cptofs --help<font></font>
Usage: cptofs [OPTION...] -t fstype -i fsimage path... fs_path<font></font>
Copy files to a filesystem image<font></font>
<font></font>
  -i, --filesystem-image=string   path to the filesystem image - mandatory<font></font>
  -p, --enable-printk        show Linux printks<font></font>
  -P, --partition=int        partition number<font></font>
  -s, --selinux=string       selinux attributes for destination<font></font>
  -t, --filesystem-type=string   select filesystem type - mandatory<font></font>
  -?, --help                 Give this help list<font></font>
      --usage                Give a short usage message<font></font>
<font></font>
Mandatory or optional arguments to long options are also mandatory or optional<font></font>
for any corresponding short options.<font></font>
$ cp $LKL/tools/lkl/cp{to,from}fs<font></font>
$ $LKL/tools/lkl/cpfromfs --help<font></font>
Usage: cpfromfs [OPTION...] -t fstype -i fsimage fs_path... path<font></font>
Copy files from a filesystem image<font></font>
<font></font>
  -i, --filesystem-image=string   path to the filesystem image - mandatory<font></font>
  -p, --enable-printk        show Linux printks<font></font>
  -P, --partition=int        partition number<font></font>
  -s, --selinux=string       selinux attributes for destination<font></font>
  -t, --filesystem-type=string   select filesystem type - mandatory<font></font>
  -?, --help                 Give this help list<font></font>
      --usage                Give a short usage message<font></font>
<font></font>
Mandatory or optional arguments to long options are also mandatory or optional<font></font>
for any corresponding short options.</code></pre><br>
<p> , «   ...». ...</p><br>
<pre><code class="plaintext hljs">$ $LKL/tools/lkl/cpfromfs -t ext4 -i ext4.img test.txt .<font></font>
error processing entry /mnt/0000fe00/test.txt, aborting</code></pre><br>
<p>…  … ,       ,  <strong></strong>     ,   .  <code>fs2tar</code>   :</p><br>
<pre><code class="plaintext hljs">$ $LKL/tools/lkl/fs2tar -t ext4 ext4.img ext4.tar<font></font>
$ tar -tf ext4.tar<font></font>
tar:   `/'   <font></font>
/test.txt<font></font>
/lost+found/</code></pre><br>
<p>        —  <code>lklfuse</code>:</p><br>
<pre><code class="plaintext hljs">$ mkdir mountpoint<font></font>
$ $LKL/tools/lkl/lklfuse -o type=ext4 ext4.img mountpoint/<font></font>
$ ls mountpoint/<font></font>
lost+found  test.txt<font></font>
$ mount<font></font>
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)<font></font>
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)<font></font>
...   ,      <font></font>
/dev/fuse on /run/user/1000/doc type fuse (rw,nosuid,nodev,relatime,user_id=1000,group_id=1000)<font></font>
lklfuse on /path/to/mountpoint type fuse.lklfuse (rw,nosuid,nodev,relatime,user_id=1000,group_id=1000)<font></font>
$ echo ABC &gt; mountpoint/ABC.XYZ<font></font>
$ umount mountpoint<font></font>
$ sudo mount ext4.img /mnt<font></font>
$ ls /mnt<font></font>
$ cat /mnt/ABC.XYZ<font></font>
ABC</code></pre><br>
<p>-, :    (     )     FUSE,   ,  —       (  )  ,      .</p><br>
<p> ,  <code>lklfuse</code>          .           .    ,  ,         OS X.</p><br>
<h2 id="nemnogo-pro-kross-platformennost">  -</h2><br>
<p>           ?  OS X, ,  : -   UNIX,    FUSE, , .    ,     .  ,       ,      LKL     <code>LKL_</code>,     .</p><br>
<p> Windows  : -,          UNIX  (,     ). -,  ,       .     —    FUSE. , -   Dokan,   - ,   . ,   LKL  Windows ,   ,    64-  <code>long</code>    64- ,      (  ,     readme ).</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478460/index.html">雨が降らないでください。組み立てモデル。神経技術者＃1工芸品研究所で作られたニューラルネットワークをトレーニングするためのデバイス</a></li>
<li><a href="../ja478462/index.html">暗号通貨 ICO、IEO、STO。鉱業 ブロックチェーン：ロシアの規制。全文：2014-2019</a></li>
<li><a href="../ja478464/index.html">テレメトリー「ベレシタ」を分析、または2019年4月11日に月の近くで何が起こったのか</a></li>
<li><a href="../ja478466/index.html">サイバーセキュリティスマートプラットフォームに1,100万ドルを投資</a></li>
<li><a href="../ja478470/index.html">インテルニューイヤーコンテスト、大賞-インテルNUC</a></li>
<li><a href="../ja478474/index.html">パブロ・エスコバー兄弟も柔軟なスマートフォンをリリースしました</a></li>
<li><a href="../ja478480/index.html">人工知能、ITSM、そして一般的に、LEANはどこにありますか？</a></li>
<li><a href="../ja478482/index.html">開発者は開発者向けにバーを開き、Angular、レイアウト、PHPに関するミーティングをホストします</a></li>
<li><a href="../ja478484/index.html">ラズベリーのSCADA：神話か現実か？</a></li>
<li><a href="../ja478486/index.html">10nmチップの時代-誰がそのようなプロセッサを開発し、将来業界に待ち受けているもの</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>