<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👂🏼 🌗 🎄 バージョン管理されたドキュメントのサンプルサイトを使用した、werfを使用したDockerイメージの動的なアセンブリと展開 🃏 🥞 🍱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="すでにwerf GitOpsツールについて2回以上話しましたが、今回は、サイト構築の経験をプロジェクトドキュメント-werf.io（ロシア語版はru.werf.io）と共有したいと思います。これは通常の静的サイトですが、動的な数のアーティファクトを使用して構築されているため、そのアセンブリは興味深い...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>バージョン管理されたドキュメントのサンプルサイトを使用した、werfを使用したDockerイメージの動的なアセンブリと展開</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/478690/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでにwerf GitOpsツールについて</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2回</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以上話しました</font><font style="vertical-align: inherit;">が、今回は、サイト構築の経験をプロジェクトドキュメント</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-werf.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ロシア語版は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ru.werf.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">共有したい</font></a><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">思い</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これは通常の静的サイトですが、動的な数のアーティファクトを使用して構築されているため、そのアセンブリは興味深いものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m_/ox/od/m_oxod8ckyfsipscttspcn5opd8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイト構造のニュアンスに入ります。すべてのバージョン、リリースに関する情報を含むページなどに共通のメニューを生成します。</font><font style="vertical-align: inherit;">- 我々はしません。</font><font style="vertical-align: inherit;">代わりに、動的アセンブリの問題と機能に焦点を当て、付随するCI / CDプロセスに少し焦点を当てます。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はじめに：サイトの配置方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、werfのドキュメントはそのコードとともに保存されています。</font><font style="vertical-align: inherit;">これにより、一般的にこの記事の範囲を超える特定の開発要件が作成されますが、少なくとも次のように言えます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ドキュメントを更新せずに新しいwerf関数をリリースすることはできません。逆に、ドキュメントの変更は新しいバージョンのwerfのリリースを意味します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> プロジェクトはかなり集中的に開発されています。新しいバージョンが1日に数回出てくる場合があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ドキュメントの新しいバージョンを使用してサイトを手動で展開することは、少なくとも退屈な作業です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このプロジェクトでは、セマンティック</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョニングの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプローチを採用し、</font><font style="vertical-align: inherit;">5チャネルの安定性を実現しました。</font><font style="vertical-align: inherit;">リリースプロセスでは、安定性を向上させるために、バージョンをチャンネルに順次通過させます。</font></font></li>
<li>     ,  «  » (..   )    (.. ) .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「機能するだけ」の機能をユーザーに提供して、この「内部キッチン」をすべてユーザーから隠すために、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別個のwerfインストールおよび更新ツールを</font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">multiwerf</font></a><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">使用する準備ができているリリース番号と安定性チャネルを示すだけで十分です。multiwerfは、チャネルに新しいバージョンがあるかどうかを確認し、必要に応じてダウンロードします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各チャンネルのwerfの最新バージョンは、サイトのバージョン選択メニューから入手できます。</font><font style="vertical-align: inherit;">デフォルトでは</font><font style="vertical-align: inherit;">、最新リリースの最も安定したチャネルのバージョンが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.io/documentationで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開きます-検索エンジンによってインデックスも作成されます。</font><font style="vertical-align: inherit;">チャネルのドキュメントは、個別のアドレスで入手できます（たとえば、</font><font style="vertical-align: inherit;">ベータリリース1.0の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.io/v1.0-beta/documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
合計、サイトには次のバージョンがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ルート（デフォルトで開く）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各リリースのアクティブな更新チャネルごと（たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.io/v1.0-beta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なケースでサイトの特定のバージョンを生成するに</font><font style="vertical-align: inherit;">は、必要なバージョンのGitタグに切り替えた後</font><font style="vertical-align: inherit;">、werfリポジトリ</font><font style="vertical-align: inherit;">ディレクトリで</font><font style="vertical-align: inherit;">対応するコマンド（</font><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">実行して、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jekyll</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールを使用してサイトをコンパイルするだけで十分</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">
それを追加するだけです：</font></font><code>/docs</code><font style="vertical-align: inherit;"></font><code>jekyll build</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ユーティリティ自体（werf）がアセンブリに使用されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CI / CDプロセスはGitLab CIに基づいています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> もちろん、これらすべてがKubernetesで機能します。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、説明されているすべての詳細を考慮に入れてタスクを作成します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新チャネルでwerfのバージョンを変更する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、サイト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">ドキュメントが自動的に更新され</font></b><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発のため</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、サイトの予備バージョン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を時々</font><b><font style="vertical-align: inherit;">表示</font></b><font style="vertical-align: inherit;">できるようにする必要</font><b><font style="vertical-align: inherit;">があります</font></b><font style="vertical-align: inherit;">。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイトの再コンパイルは、対応するGitタグから任意のチャネルのバージョンを変更した後に実行する必要がありますが、イメージを構築する過程で、次の機能が得られます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャネルのバージョンのリストが変更されているため、バージョンが変更されたチャネルのドキュメントを再構成するだけで済みます。</font><font style="vertical-align: inherit;">結局のところ、すべてを再度組み立てることはあまり美しくありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リリースのチャネルのセットは異なる場合があります。</font><font style="vertical-align: inherit;">たとえば、ある時点で、早期アクセス1.1リリースよりも安定しているバージョンがチャネルに存在しない可能性がありますが、時間が経つと表示されます。この場合、手動でアセンブリを変更しないでください。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ことが判明した</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリは、外部データの変更に依存します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプローチの選択</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、Kubernetesの個別のポッドで必要な各バージョンを実行できます。このオプションは、クラスター内のより多くのオブジェクトを意味し、安定したwerfリリースの数の増加に伴って増加します。そして、これはより複雑なサービスを意味します。各バージョンには独自のHTTPサーバーがあり、負荷はわずかです。もちろん、これにはリソースのコストが高くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、必要なすべてのバージョンを1つのイメージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><b><font style="vertical-align: inherit;">まとめる</font></b><font style="vertical-align: inherit;">道を歩みました</font><font style="vertical-align: inherit;">。サイトのすべてのバージョンのコンパイル済み統計はNGINXのコンテナーにあり、対応するDeploymentへのトラフィックはNGINX Ingressを経由します。シンプルな構造-ステートレスアプリケーション-は、Kubernetes自体を使用して（負荷に応じて）Deploymentを簡単にスケーリングできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より正確には、2つの画像を収集します。1つは本番回路用、もう1つは開発回路用です。</font><font style="vertical-align: inherit;">追加のイメージはメインのイメージと一緒にdev-circuitでのみ使用（起動）され、レビューコミットからのサイトバージョンが含まれ、それらの間のルーティングはIngressリソースを使用して実行されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf対gitクローンおよびアーティファクト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、ドキュメントの特定のバージョンのサイトスタティックを生成するには、対応するリポジトリタグに切り替えてビルドする必要があります。リストから適切なタグを選択して、アセンブリ中に毎回リポジトリを複製してこれを行うこともできます。ただし、これはかなりリソースを消費する操作であり、さらに、重要な命令を書く必要があります...もう1つの重大なマイナス-このアプローチでは、アセンブリ中に何かをキャッシュする方法がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでwerfユーティリティが役立ち</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;">ます</font></b></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートキャッシング</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実装し</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部リポジトリの</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用を可能にし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;">ます</font></b></a><font style="vertical-align: inherit;">。 werfを使用してリポジトリからコードを追加すると、次のようにビルドが大幅にスピードアップしますwerfは基本的にリポジトリのクローンを1回実行します。</font></font><i><font style="vertical-align: inherit;"></font></i> <code>fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要な場合</font><i><font style="vertical-align: inherit;">のみ</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">さらに、リポジトリからデータを追加するときは、必要なディレクトリ（この場合は、これはディレクトリ</font></font><code>docs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">しか選択できない</font><font style="vertical-align: inherit;">ため、追加するデータの量が大幅に削減されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jekyllは静的をコンパイルするために設計されたツールであり、最終的なイメージでは必要ないため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werfアーティファクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">コンパイルし</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、コンパイル結果のみを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的なイメージに</font><b><font style="vertical-align: inherit;">インポート</font></b><font style="vertical-align: inherit;">するのが論理的</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.yamlの作成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、各バージョンを別々のwerfアーティファクトにコンパイルすることを決定しました。</font><font style="vertical-align: inherit;">ただし、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリ中にこれらのアーティファクトがいくつになるかはわから</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ないため、固定されたアセンブリ構成を作成することはできません（厳密に言えば、まだ可能ですが、完全には効果的ではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werfを使用すると</font><font style="vertical-align: inherit;">、構成ファイル（</font><font style="vertical-align: inherit;">）で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goテンプレート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用できます。</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これにより</font><font style="vertical-align: inherit;">、外部データ（必要なもの）に応じて</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「オンザフライ」で</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">生成</font></b><font style="vertical-align: inherit;">でき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">この場合、外部のデータは、バージョンおよびリリースの情報は、私たちが人工物、そして得られた2枚の画像の必要な数を集め、それに基づいて、次のとおりです。</font></font><code>werf-doc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして</font></font><code>werf-dev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なる回路上で実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部データは環境変数を介して渡されます。</font><font style="vertical-align: inherit;">以下がその構成です。</font></font><br>
<br>
<ul>
<li> <code>RELEASES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-形式の値のスペースを含むリストの形式で、リリースのリストと対応するwerfの現在のバージョンを含む行</font></font><code>&lt;_&gt;%&lt;_&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例：</font></font><code>1.0%v1.0.4-beta.20</code></li>
<li> <code>CHANNELS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-チャンネルのリストと、対応する現在のバージョンのwerfを含む行</font></font><code>&lt;&gt;%&lt;_&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">形式の値のスペースを含むリストの形式です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例：</font></font><code>1.0-beta%v1.0.4-beta.20 1.0-alpha%v1.0.5-alpha.22</code></li>
<li> <code>ROOT_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-サイトにデフォルトで表示するためのwerfリリースのバージョン（最も高いリリース番号のドキュメントを表示する必要はありません）。</font><font style="vertical-align: inherit;">例：</font></font><code>v1.0.4-beta.20</code></li>
<li> <code>REVIEW_SHA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -テストループのバージョンを作成するレビューコミットのハッシュ。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの変数は、パイプラインのGitLab CIに入力されます。具体的には、以下のとおりです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず第一に、便宜上、</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goテンプレートの変数</font><font style="vertical-align: inherit;">を定義</font><font style="vertical-align: inherit;">し、環境変数からの値を割り当てます：</font></font><br>
<br>
<pre><code class="go hljs">{{ $_ := set . <span class="hljs-string">"WerfVersions"</span> (cat (env <span class="hljs-string">"CHANNELS"</span>) (env <span class="hljs-string">"RELEASES"</span>) | splitList <span class="hljs-string">" "</span>) }}<font></font>
{{ $Root := . }}<font></font>
{{ $_ := set . <span class="hljs-string">"WerfRootVersion"</span> (env <span class="hljs-string">"ROOT_VERSION"</span>) }}<font></font>
{{ $_ := set . <span class="hljs-string">"WerfReviewCommit"</span> (env <span class="hljs-string">"REVIEW_SHA"</span>) }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイトバージョンの静的をコンパイルするためのアーティファクトの説明は、必要なすべてのケースで一般的に同じです（ルートバージョンの生成と開発回路のバージョンを含む）。</font><font style="vertical-align: inherit;">したがって、を</font></font><code>define</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用して後で再利用するために</font><font style="vertical-align: inherit;">、関数を使用して別のブロックに配置</font><font style="vertical-align: inherit;">し</font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">次の引数をテンプレートに渡します。</font></font><br>
<br>
<ul>
<li> <code>Version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -生成されたバージョン（タグ名）;</font></font></li>
<li> <code>Channel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -アーティファクトが生成される更新チャネルの名前。</font></font></li>
<li> <code>Commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -レビューコミット用にアーティファクトが生成された場合は、ハッシュをコミットします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 環境。</font></font></li>
</ul><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーティファクトテンプレートの説明</font></font></b><div class="spoiler_text"><pre><code class="go hljs">{{- define <span class="hljs-string">"doc_artifact"</span> -}}<font></font>
{{- $Root := index . <span class="hljs-string">"Root"</span> -}}<font></font>
artifact: doc-{{ .Channel }}<font></font>
from: jekyll/builder:<span class="hljs-number">3</span><font></font>
mount:<font></font>
- from: build_dir<font></font>
  to: /usr/local/bundle<font></font>
ansible:<font></font>
  install:<font></font>
  - shell: |<font></font>
      export PATH=/usr/jekyll/bin/:$PATH<font></font>
  - name: <span class="hljs-string">"Install Dependencies"</span><font></font>
    shell: bundle install<font></font>
    args:<font></font>
      executable: /bin/bash<font></font>
      chdir: /app/docs<font></font>
  beforeSetup:<font></font>
{{- <span class="hljs-keyword">if</span> .Commit }}<font></font>
  - shell: echo <span class="hljs-string">"Review SHA - {{ .Commit }}."</span><font></font>
{{- end }}<font></font>
{{- <span class="hljs-keyword">if</span> eq .Channel <span class="hljs-string">"root"</span> }}<font></font>
  - name: <span class="hljs-string">"releases.yml HASH: {{ $Root.Files.Get "</span>releases.yml<span class="hljs-string">" | sha256sum }}"</span>
    <span class="hljs-built_in">copy</span>:<font></font>
      content: |<font></font>
{{ $Root.Files.Get <span class="hljs-string">"releases.yml"</span> | indent <span class="hljs-number">8</span> }}<font></font>
      dest:  /app/docs/_data/releases.yml<font></font>
{{- <span class="hljs-keyword">else</span> }}<font></font>
  - file:<font></font>
      path: /app/docs/_data/releases.yml<font></font>
      state: touch<font></font>
{{- end }}<font></font>
  - file:<font></font>
      path: <span class="hljs-string">"{{`{{ item }}`}}"</span><font></font>
      state: directory<font></font>
      mode: <span class="hljs-number">0777</span><font></font>
    with_items:<font></font>
    - /app/main_site/<font></font>
    - /app/ru_site/<font></font>
  - file:<font></font>
      dest: /app/docs/pages_ru/cli<font></font>
      state: link<font></font>
      src: /app/docs/pages/cli<font></font>
  - shell: |<font></font>
      echo -e <span class="hljs-string">"werfVersion: {{ .Version }}\nwerfChannel: {{ .Channel }}"</span> &gt; /tmp/_config_additional.yml<font></font>
      export PATH=/usr/jekyll/bin/:$PATH<font></font>
{{- <span class="hljs-keyword">if</span> and (ne .Version <span class="hljs-string">"review"</span>) (ne .Channel <span class="hljs-string">"root"</span>) }}<font></font>
{{- $_ := set . <span class="hljs-string">"BaseURL"</span> ( printf <span class="hljs-string">"v%s"</span> .Channel ) }}<font></font>
{{- <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ne .Channel <span class="hljs-string">"root"</span> }}<font></font>
{{- $_ := set . <span class="hljs-string">"BaseURL"</span> .Channel }}<font></font>
{{- end }}<font></font>
      jekyll build -s /app/docs  -d /app/_main_site/{{ <span class="hljs-keyword">if</span> .BaseURL }} --baseurl /{{ .BaseURL }}{{ end }} --config /app/docs/_config.yml,/tmp/_config_additional.yml<font></font>
      jekyll build -s /app/docs  -d /app/_ru_site/{{ <span class="hljs-keyword">if</span> .BaseURL }} --baseurl /{{ .BaseURL }}{{ end }} --config /app/docs/_config.yml,/app/docs/_config_ru.yml,/tmp/_config_additional.yml<font></font>
    args:<font></font>
      executable: /bin/bash<font></font>
      chdir: /app/docs<font></font>
git:<font></font>
- url: https:<span class="hljs-comment">//github.com/flant/werf.git</span><font></font>
  to: /app/<font></font>
  owner: jekyll<font></font>
  group: jekyll<font></font>
{{- <span class="hljs-keyword">if</span> .Commit }}<font></font>
  commit: {{ .Commit }}<font></font>
{{- <span class="hljs-keyword">else</span> }}<font></font>
  tag: {{ .Version }}<font></font>
{{- end }}<font></font>
  stageDependencies:<font></font>
    install: [<span class="hljs-string">'docs/Gemfile'</span>,<span class="hljs-string">'docs/Gemfile.lock'</span>]<font></font>
    beforeSetup: <span class="hljs-string">'**/*'</span>
  includePaths: <span class="hljs-string">'docs'</span>
  excludePaths: <span class="hljs-string">'**/*.sh'</span>
{{- end }}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーティファクトの名前は一意である必要があります。これは、たとえば、チャネルの名前（変数値</font></font><code>.Channel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）をアーティファクトの名前のサフィックスとして</font><font style="vertical-align: inherit;">追加することで実現でき</font><font style="vertical-align: inherit;">ます</font></font><code>artifact: doc-{{ .Channel }}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ただし、成果物からインポートする場合は、同じ名前を参照する必要があることを理解する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーティファクトを説明するときは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mount</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのwerf機能</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が使用され</font></a><font style="vertical-align: inherit;">ます。サービスディレクトリでマウントすると、</font></font><code>build_dir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイプラインの実行間でJekyllキャッシュを保存できるため、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再構築</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><b><font style="vertical-align: inherit;">大幅に高速化され</font></b><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ファイルの使用に気づいたかもしれません</font></font><code>releases.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">github.com</font></a><font style="vertical-align: inherit;">からリクエストされたリリースデータを含むYAMLファイルです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（パイプラインを実行することによって取得されるアーティファクト）。これはサイトをコンパイルするときに必要ですが、記事のコンテキストでは</font><font style="vertical-align: inherit;">、サイトバージョンのルート</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーティファクトの1つだけ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がその状態に依存しているという事実に関心があります</font><font style="vertical-align: inherit;">（他のアーティファクトでは不要です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goテンプレートの</font><font style="vertical-align: inherit;">条件演算子と</font></font><code>{{ $Root.Files.Get "releases.yml" | sha256sum }}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構築</font><font style="vertical-align: inherit;">を使用して実装され</font><font style="vertical-align: inherit;">ます。これは次のように機能します。ルートバージョン（変数</font></font><code>.Channel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はequal </font></font><code>root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">アーティファクトをアセンブルする場合</font><font style="vertical-align: inherit;">、ファイルのハッシュは</font></font><code>releases.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansibleジョブの名前のコンポーネント（パラメーター</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">であるため、ステージ全体の署名に影響します</font><font style="vertical-align: inherit;">。したがって、</font><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更する</font><font style="vertical-align: inherit;">と、</font></font><code>releases.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対応するアーティファクトが再構築されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部リポジトリの操作にも注意してください。</font><font style="vertical-align: inherit;">ディレクトリのみが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werfリポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からのアーティファクト</font><font style="vertical-align: inherit;">の</font><font style="vertical-align: inherit;">イメージに</font><font style="vertical-align: inherit;">追加され、</font></font><code>/docs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">渡されたパラメーターに応じて、すぐに必要なタグまたはレビューコミットのデータが追加されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーティファクトテンプレートを使用して、チャネルとリリースの転送されたバージョンのアーティファクトの説明を生成するには、次の変数</font></font><code>.WerfVersions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">サイクルを編成します</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">{{ <span class="hljs-keyword">range</span> .WerfVersions -}}<font></font>
{{ $VersionsDict := splitn <span class="hljs-string">"%"</span> <span class="hljs-number">2</span> . -}}<font></font>
{{ dict <span class="hljs-string">"Version"</span> $VersionsDict._1 <span class="hljs-string">"Channel"</span> $VersionsDict._0 <span class="hljs-string">"Root"</span> $Root | include <span class="hljs-string">"doc_artifact"</span> }}<font></font>
---<font></font>
{{ end -}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜならループはいくつかのアーティファクトを生成します（そうなることを願っています）。アーティファクト間の区切り-シーケンス</font></font><code>---</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（構成ファイルの構文の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を考慮する必要</font><font style="vertical-align: inherit;">があります</font><font style="vertical-align: inherit;">。以前に決定したように、ループでテンプレートを呼び出すと、バージョンパラメータ、URL、およびルートコンテキストが渡されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、ループが既に存在しないため、「特別な場合」のアーティファクトテンプレートを呼び出します。これは、ルートバージョンと、レビューコミットのバージョンの場合です。</font></font><br>
<br>
<pre><code class="go hljs">{{ dict <span class="hljs-string">"Version"</span> .WerfRootVersion <span class="hljs-string">"Channel"</span> <span class="hljs-string">"root"</span> <span class="hljs-string">"Root"</span> $Root  | include <span class="hljs-string">"doc_artifact"</span> }}<font></font>
---<font></font>
{{- <span class="hljs-keyword">if</span> .WerfReviewCommit }}<font></font>
{{ dict <span class="hljs-string">"Version"</span> <span class="hljs-string">"review"</span> <span class="hljs-string">"Channel"</span> <span class="hljs-string">"review"</span> <span class="hljs-string">"Commit"</span> .WerfReviewCommit <span class="hljs-string">"Root"</span> $Root  | include <span class="hljs-string">"doc_artifact"</span> }}<font></font>
{{- end }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数が設定されている場合のみ、レビューコミットのアーティファクトが収集されることに注意してください</font></font><code>.WerfReviewCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーティファクトの準備ができました-インポートする時が来ました！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesで実行するように設計された最後のイメージは、通常のNGINXであり、サーバー構成ファイル</font></font><code>nginx.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とアーティファクトの静的情報が</font><font style="vertical-align: inherit;">追加され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">サイトのルートバージョンのアーティファクトに加えて、変数</font></font><code>.WerfVersions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">介してループを繰り返して</font><font style="vertical-align: inherit;">、チャネルとリリースのバージョンのアーティファクトをインポート</font><font style="vertical-align: inherit;">する必要が</font><font style="vertical-align: inherit;">あります。また、以前に採用したアーティファクトの命名規則を確認します。</font><font style="vertical-align: inherit;">各アーティファクトには2つの言語のサイトのバージョンが保存されているため、構成によって提供される場所にそれらをインポートします。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的なwerf-docイメージの説明</font></font></b><div class="spoiler_text"><pre><code class="go hljs">image: werf-doc<font></font>
from: nginx:stable-alpine<font></font>
ansible:<font></font>
  setup:<font></font>
  - name: <span class="hljs-string">"Setup /etc/nginx/nginx.conf"</span>
    <span class="hljs-built_in">copy</span>:<font></font>
      content: |<font></font>
{{ .Files.Get <span class="hljs-string">".werf/nginx.conf"</span> | indent <span class="hljs-number">8</span> }}<font></font>
      dest: /etc/nginx/nginx.conf<font></font>
  - file:<font></font>
      path: <span class="hljs-string">"{{`{{ item }}`}}"</span><font></font>
      state: directory<font></font>
      mode: <span class="hljs-number">0777</span><font></font>
    with_items:<font></font>
    - /app/main_site/assets<font></font>
    - /app/ru_site/assets<font></font>
<span class="hljs-keyword">import</span>:<font></font>
- artifact: doc-root<font></font>
  add: /app/_main_site<font></font>
  to: /app/main_site<font></font>
  before: setup<font></font>
- artifact: doc-root<font></font>
  add: /app/_ru_site<font></font>
  to: /app/ru_site<font></font>
  before: setup<font></font>
{{ <span class="hljs-keyword">range</span> .WerfVersions -}}<font></font>
{{ $VersionsDict := splitn <span class="hljs-string">"%"</span> <span class="hljs-number">2</span> . -}}<font></font>
{{ $Channel := $VersionsDict._0 -}}<font></font>
{{ $Version := $VersionsDict._1 -}}<font></font>
- artifact: doc-{{ $Channel }}<font></font>
  add: /app/_main_site<font></font>
  to: /app/main_site/v{{ $Channel }}<font></font>
  before: setup<font></font>
{{ end -}}<font></font>
{{ <span class="hljs-keyword">range</span> .WerfVersions -}}<font></font>
{{ $VersionsDict := splitn <span class="hljs-string">"%"</span> <span class="hljs-number">2</span> . -}}<font></font>
{{ $Channel := $VersionsDict._0 -}}<font></font>
{{ $Version := $VersionsDict._1 -}}<font></font>
- artifact: doc-{{ $Channel }}<font></font>
  add: /app/_ru_site<font></font>
  to: /app/ru_site/v{{ $Channel }}<font></font>
  before: setup<font></font>
{{ end -}}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインイメージと一緒に開発回路で起動される追加イメージには、サイトの2つのバージョンのみが含まれます。レビューコミットからのバージョンとサイトのルートバージョンです（一般的なアセットがあり、覚えていればデータをリリースします）。したがって、メインのイメージからの追加のイメージは、インポートセクションのみが異なります（もちろん、名前も異なります）。</font></font><br>
<br>
<pre><code class="plaintext hljs">image: werf-dev<font></font>
...<font></font>
import:<font></font>
- artifact: doc-root<font></font>
  add: /app/_main_site<font></font>
  to: /app/main_site<font></font>
  before: setup<font></font>
- artifact: doc-root<font></font>
  add: /app/_ru_site<font></font>
  to: /app/ru_site<font></font>
  before: setup<font></font>
{{- if .WerfReviewCommit  }}<font></font>
- artifact: doc-review<font></font>
  add: /app/_main_site<font></font>
  to: /app/main_site/review<font></font>
  before: setup<font></font>
- artifact: doc-review<font></font>
  add: /app/_ru_site<font></font>
  to: /app/ru_site/review<font></font>
  before: setup<font></font>
{{- end }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、レビューコミットのアーティファクトは、werfが環境変数setで開始した場合にのみ生成され</font></font><code>REVIEW_SHA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">環境変数がない場合はwerf-devイメージをまったく生成しない可能性があります</font></font><code>REVIEW_SHA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、</font><font style="vertical-align: inherit;">Dockerイメージ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のポリシーに従った</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> werf-devイメージの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">クリーニング</font></a><font style="vertical-align: inherit;">がwerf-devイメージに対して機能するように、ルートバージョンのアーティファクトのみで収集されるようにします（とにかく、すでに組み立て済み）、パイプラインの構造を簡素化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立て完了です！</font><font style="vertical-align: inherit;">CI / CDと重要なニュアンスに移ります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CIのパイプラインと動的アセンブリの機能</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリを開始するとき、で使用される環境変数を設定する必要があります</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、GitHubフックからパイプラインが呼び出されたときに設定するREVIEW_SHA変数には適用されません。</font><font style="vertical-align: inherit;">2つのパイプラインGitLabアーティファクトを生成</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
するBashスクリプトで必要な外部データ</font></font><code>generate_artifacts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を生成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><code>releases.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リリースデータ</font><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">、</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>common_envs.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エクスポートする環境変数を含む</font><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル</font></font><code>generate_artifacts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><font style="vertical-align: inherit;">内容は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例とともにリポジトリにあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">データの取得は記事の主題ではありませんが、ファイル</font></font><code>common_envs.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は私たちにとって重要です。</font><font style="vertical-align: inherit;">werfの動作はそれに依存しています。</font><font style="vertical-align: inherit;">その内容の例：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> RELEASES=<span class="hljs-string">'1.0%v1.0.6-4'</span>
<span class="hljs-built_in">export</span> CHANNELS=<span class="hljs-string">'1.0-alpha%v1.0.7-1 1.0-beta%v1.0.7-1 1.0-ea%v1.0.6-4 1.0-stable%v1.0.6-4 1.0-rock-solid%v1.0.6-4'</span>
<span class="hljs-built_in">export</span> ROOT_VERSION=<span class="hljs-string">'v1.0.6-4'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなスクリプトの出力を使用できます</font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、Bash関数を使用できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、楽しい部分です。ビルドにし、適切に動作するアプリケーションをデプロイすると、あなたはそれを確認しなければなりません</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でした</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少なくとも</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一つのパイプラインで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この条件が満たされていない場合、werfがアセンブリ中に計算するステージのシグネチャ、たとえばデプロイメントは異なります。これにより、デプロイメントエラーが発生します。展開に必要なイメージはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、サイトイメージのアセンブリ中にリリースとバージョンの情報が1つであり、リリース時に新しいバージョンがリリースされ、環境変数の値が異なる場合、デプロイメントはエラーで失敗します。結局、新しいバージョンのアーティファクトはまだ収集されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もし世代が</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部データ（たとえば、今回の場合のように現在のバージョンのリスト）に依存する場合、そのようなデータの構成と値はパイプライン内に記録する必要があります。これは、外部パラメーターが頻繁に変更される場合に特に重要です。</font><font style="vertical-align: inherit;">GitLab（</font><i><font style="vertical-align: inherit;">Prebuild</font></i><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">パイプラインの最初の段階で</font><b><font style="vertical-align: inherit;">外部データ</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受信して記録</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font><b><font style="vertical-align: inherit;">GitLab CIアーティファクト</font></b><font style="vertical-align: inherit;">としてさらに送信し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。これにより、と同じ構成でパイプラインタスク（ビルド、デプロイ、クリーンアップ）を開始および再開できます</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">ビルド前の</font></i><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">
ステージの</font><i><font style="vertical-align: inherit;">内容</font></i><font style="vertical-align: inherit;">：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>werf.yaml</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><code>.gitlab-ci.yml</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">Prebuild:<font></font>
  stage: prebuild<font></font>
  script:<font></font>
    - bash ./generate_artifacts 1&gt; common_envs.sh<font></font>
    - cat ./common_envs.sh<font></font>
  artifacts:<font></font>
    paths:<font></font>
      - releases.yml<font></font>
      - common_envs.sh<font></font>
    expire_in: 2 week</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーティファクトで外部データをキャプチャすることにより、標準のGitLab CIパイプラインステージであるビルドとデプロイを使用してビルドとデプロイを行うことができます。 gerHubリポジトリwerfからのフックによってパイプラインを実行します（つまり、GitHubでリポジトリを変更するとき）。それらのデータは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CI / CD設定-&gt;パイプライントリガーセクション</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のGitLabプロジェクトのプロパティで取得でき</font><font style="vertical-align: inherit;">、GitHubで対応するWebhook（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定-&gt; Webhook</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を作成</font><font style="vertical-align: inherit;">します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立てフェーズは次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">Build:<font></font>
  stage: build<font></font>
  script:<font></font>
    - type multiwerf &amp;&amp; . $(multiwerf use 1.0 alpha --as-file)<font></font>
    - type werf &amp;&amp; source &lt;(werf ci-env gitlab --tagging-strategy tag-or-branch --verbose)<font></font>
    - source common_envs.sh<font></font>
    - werf build-and-publish --stages-storage :local<font></font>
  except:<font></font>
    refs:<font></font>
      - schedules<font></font>
  dependencies:<font></font>
    - Prebuild</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLabは2つのアーティファクトを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prebuild</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージからビルドフェーズ</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">追加する</font><font style="vertical-align: inherit;">ため、コンストラクトを使用して準備された入力で変数をエクスポートします</font></font><code>source common_envs.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。予定通りのパイプラインの立ち上げを除いて、すべてのケースで組立段階を開始します。スケジュールによると、洗浄用のパイプラインが起動されます-この場合、構築する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デプロイメント段階では、YAMLテンプレートを使用して、本番回路と開発回路へのデプロイメントの2つのタスクについて説明します。</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: &amp;base_deploy<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - type multiwerf &amp;&amp; . $(multiwerf use 1.0 alpha --as-file)<font></font>
    - type werf &amp;&amp; source &lt;(werf ci-env gitlab --tagging-strategy tag-or-branch --verbose)<font></font>
    - source common_envs.sh<font></font>
    - werf deploy --stages-storage :local<font></font>
  dependencies:<font></font>
    - Prebuild<font></font>
  except:<font></font>
    refs:<font></font>
      - schedules<font></font>
<font></font>
Deploy to Production:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  variables:<font></font>
    WERF_KUBE_CONTEXT: prod<font></font>
  environment:<font></font>
    name: production<font></font>
    url: werf.io<font></font>
  only:<font></font>
    refs:<font></font>
      - master<font></font>
  except:<font></font>
    variables:<font></font>
      - $REVIEW_SHA<font></font>
    refs:<font></font>
      - schedules<font></font>
<font></font>
Deploy to Test:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  variables:<font></font>
    WERF_KUBE_CONTEXT: dev<font></font>
  environment:<font></font>
    name: test<font></font>
    url: werf.test.flant.com<font></font>
  except:<font></font>
    refs:<font></font>
      - schedules<font></font>
  only:<font></font>
    variables:<font></font>
      - $REVIEW_SHA</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際に割り当てが異なるのは、werf deploy（</font></font><code>WERF_KUBE_CONTEXT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">実行するクラスターの指示と</font><font style="vertical-align: inherit;">、テンプレートHelmチャートで使用される</font><font style="vertical-align: inherit;">インストールパス環境変数（</font></font><code>environment.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>environment.url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">のコンテキストのみ</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">テンプレートの内容は与えられません、なぜなら </font><font style="vertical-align: inherit;">このトピックには興味深いものはありませんが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、記事リポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で見つけることができ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後の仕上げ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werfバージョンはかなり頻繁にリリースされるため、新しいイメージが収集されることが多く、Dockerレジストリーは常に成長し続けます。</font><font style="vertical-align: inherit;">そのため、ポリシーによる画像の自動クリーニングを構成する必要があります。</font><font style="vertical-align: inherit;">とても簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装には次のものが必要です。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に精製ステップを追加し</font></font><code>.gitlab-ci.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 定期的なクリーンアップタスクを追加します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 書き込みアクセストークンで環境変数を設定します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
にクリーニングステップを追加し</font></font><code>.gitlab-ci.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="plaintext hljs">Cleanup:<font></font>
  stage: cleanup<font></font>
  script:<font></font>
    - type multiwerf &amp;&amp; . $(multiwerf use 1.0 alpha --as-file)<font></font>
    - type werf &amp;&amp; source &lt;(werf ci-env gitlab --tagging-strategy tag-or-branch --verbose)<font></font>
    - source common_envs.sh<font></font>
    - docker login -u nobody -p ${WERF_IMAGES_CLEANUP_PASSWORD} ${WERF_IMAGES_REPO}<font></font>
    - werf cleanup --stages-storage :local<font></font>
  only:<font></font>
    refs:<font></font>
      - schedules<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどすべての人がこれをもう少し高くしています。クリーニングする場合にのみ、最初にDockerレジストリ内のイメージを削除する権限を持つトークンでDockerレジストリにログインする必要があります（自動的に発行されるGitLab CIタスクトークンにはそのような権限はありません）。</font><font style="vertical-align: inherit;">トークンは事前にGitLabに入力する必要があり、その値は</font></font><code>WERF_IMAGES_CLEANUP_PASSWORD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクト</font><font style="vertical-align: inherit;">環境変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（CI / CD設定-&gt;変数）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で指定する必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なスケジュールでクリーニングタスクを追加するには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CI / CD-&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スケジュールで行い</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それだけです。Dockerレジストリ内のプロジェクトが、未使用のイメージから絶えず成長することはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際の部分の最後に、記事の完全なリストが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能であることを思い出します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.gitlab-ci.yml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.yaml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果</font></font></h2><br>
<ol>
<li>     :     .</li>
<li>            werf:     .</li>
<li>      .</li>
<li>  , ..    —     werf   GitHub-  review- —        .</li>
<li>       :    werf     Docker Registry.</li>
</ol><br>
<h2></h2><br>
<ul>
<li>  werf         ,        .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部Gitリポジトリを使用することで、毎回完全にリポジトリのクローンを作成したり、トリッキーな最適化ロジックでホイールを再発明したりする必要がなくなります。</font><font style="vertical-align: inherit;">werfはキャッシュを使用してクローン作成を1回</font></font><code>fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">だけ行い、必要な場合にのみ</font><font style="vertical-align: inherit;">それを使用</font><font style="vertical-align: inherit;">します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリ構成ファイルでGoテンプレートを使用する機能</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により、アセンブリを記述でき、その結果は外部データに依存します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> werfでマウントを使用すると、アーティファクトの収集が大幅にスピードアップします。これは、すべてのパイプラインに共通のキャッシュが原因です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> werfを使用すると、クリーニングが簡単になります。これは、動的ビルドの場合に特に当てはまります。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいアプリケーションリリースをKubernetesに配信するプロセスでチームを立ち上げる</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">      werf  GitLab CI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> werf    Helm-</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> werf 1.0 stable:    GitOps,   </a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478672/index.html">AIテストとスタートアップ：Adam Carmi（Applitools）へのインタビュー</a></li>
<li><a href="../ja478678/index.html">まともな社会では、あなたはどれくらい、または彼らは何を話していませんか</a></li>
<li><a href="../ja478680/index.html">なぜ、そして最も重要なのは、人々がITからどこへ行くのか？</a></li>
<li><a href="../ja478684/index.html">SSDの概要。パート2.インターフェース</a></li>
<li><a href="../ja478688/index.html">2019年にデータサイエンスを研究することはどのようなものでしたか</a></li>
<li><a href="../ja478692/index.html">AndroidでのJava 8のサポート方法</a></li>
<li><a href="../ja478694/index.html">iviオンラインシネマの最新カタログをお勧めします（+ Pythonコード）</a></li>
<li><a href="../ja478696/index.html">どのように私はUrban Tech 2019を訪れました。イベントレポート</a></li>
<li><a href="../ja478698/index.html">15分でインタラクティブな地形計画を作成</a></li>
<li><a href="../ja478702/index.html">Kapacitorでのメトリック処理のトリック</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>