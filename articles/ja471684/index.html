<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌞 🌴 🙇🏿 nginxのモジュールを作成する必要がある理由 🖐🏻 🕵🏾 📒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nginxは、何十ものビジネスタスクを解決し、柔軟に構成、スケーリング、およびほぼすべてのOSとプラットフォームで動作するWebサーバーです。箱から出してすぐに解決する機能、機能、および問題のリストは、小さなパンフレットで説明できます。しかし、多くのビジネスタスクは、nginx用の独自のモジュールを...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>nginxのモジュールを作成する必要がある理由</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/471684/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxは、何十ものビジネスタスクを解決し、柔軟に構成、スケーリング、およびほぼすべてのOSとプラットフォームで動作するWebサーバーです。</font><font style="vertical-align: inherit;">箱から出してすぐに解決する機能、機能、および問題のリストは、小さなパンフレットで説明できます。</font><font style="vertical-align: inherit;">しかし、多くのビジネスタスクは、nginx用の独自のモジュールを開発することによってのみ解決できる場合があります。</font><font style="vertical-align: inherit;">これらは、ビジネス指向であり、いくつかのビジネスロジックを含むモジュールであり、一般的なシステムソリューションだけではありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_g/qx/cl/_gqxcl-ni0gc2f2rsr7thf4tici.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、nginxのすべては、かつて誰かが作成したモジュールです。</font><font style="vertical-align: inherit;">したがって、nginxでモジュールを作成することは可能であるだけでなく、必要でもあります。</font><font style="vertical-align: inherit;">これを行う必要がある場合、その理由は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヴァシリーソシニコフ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が教えてくれます</font><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dedokOne</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）いくつかのケースの例について。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cでモジュールを作成する理由、nginxのアーキテクチャとコア、HTTPモジュール、Cモジュール、NJS、Lua、およびnginx.confの構造について説明しましょう。</font><font style="vertical-align: inherit;">これは、nginxで開発する人だけでなく、nginx-configs、Lua、またはnginx内の別の言語を使用する人にも知っておくことが重要です。</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：この記事はVasily Soshnikovのレポートに基づいています。</font><font style="vertical-align: inherit;">レポートは常に更新されています。</font><font style="vertical-align: inherit;">資料の情報は非常に技術的であり、それを最大限に活用するために、読者は平均レベル以上のnginxコードでの作業経験が必要です。</font></font></em><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/82CyWPpjNNY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxについて簡単に</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxで使用するのはモジュールだけ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。 nginx構成の各ディレクティブは、nginxコミュニティの同僚によって慎重に記述された個別のモジュールです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx.confのディレクティブも</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、特定の問題を解決する</font><strong><font style="vertical-align: inherit;">モジュール</font></strong><font style="vertical-align: inherit;">です。したがって、nginxではモジュールがすべてです。 add_header、proxy_pass、任意のディレクティブは、特定のルールに従って機能するモジュールまたはモジュールの組み合わせです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxは、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークとファイルI / O、共有メモリ、構成とスクリプトを備え</font><strong><font style="vertical-align: inherit;">たフレームワーク</font></strong><font style="vertical-align: inherit;">です。これは低レベルのライブラリの巨大なレイヤーであり、ネットワークドライブを操作するために何でも実行できます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxは高速で安定していますが複雑です</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらのnginxの品質を失わないように、このようなコードを記述する必要があります。</font><font style="vertical-align: inherit;">本番環境での不安定なnginxは不満のあるクライアントであり、これから続くのはすべてです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独自のモジュールを作成する理由</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPプロトコルを別のプロトコルに変換します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これが、特定のモジュールの作成を頻繁に動機付ける主な理由です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、memcached_pa​​ssモジュールはHTTPを別のプロトコルに変換し、他の外部システムで作業できます。また、proxy_passモジュールを使用すると、HTTP（s）からHTTP（s）に変換できます。別の良い例はfastcgi_passです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらはすべて、次の形式のディレクティブです。「HTTPなどではないバックエンドに移動します（ただし、proxy_pass HTTPの場合）。」</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的コンテンツ挿入：AdBlockバイパス、広告挿入。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、バックエンドがあり、そこからのコンテンツを変更する必要があります。たとえば、広告挿入コードを分析するAdBlockは、何らかの方法で調整するために対処する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテンツを埋め込むためによくしなければならないもう1つのことは、HLSキャッシングの問題です。パラメーターがHLS内にキャッシュされると、2人のユーザーが同じセッションまたは同じパラメーターを取得できます。何かを追跡する必要がある場合、そこからいくつかのパラメーターをカットまたは追加します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターネット/モバイルメーターからClickstreamデータを収集します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の練習で人気のあるケース。ほとんどの場合、これはnginxで行われますが、access.logでは行われませんが、もう少しインテリジェントです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あらゆる種類のコンテンツの変換。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、のrtmpモジュールを使用すると、rtmpだけでなく、HLSでも作業できます。このモジュールは、ビデオコンテンツで多くのことができます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">汎用認証ポイント：SEPまたはApiゲートウェイ。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、nginxがインフラストラクチャの一部として機能する場合に当てはまります。承認、メトリックの収集、モニタリングとClickStreamへのデータの送信。 Nginxはここでインフラストラクチャハブとして機能します-バックエンドの単一のエントリポイント。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その後のトレースのためのリクエストの充実。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最近のシステムは非常に複雑で、さまざまなチームを構成するいくつかのタイプのバックエンドがあります。原則として、それらはデビューするのが難しく、リクエストがどこから来たのか、どこへ行ったのかさえ理解できない場合もあります。デバッグを簡略化するために、一部の大企業はトリッキーなテクニックを使用しています-彼らはリクエストに特定のデータを追加します。ユーザーには表示されませんが、このデータからシステム内のリクエストパスを簡単に追跡できます。これは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレース</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S3-proxy。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今年は、s3を使用してオブジェクトを操作する人をよく見かけます。</font><font style="vertical-align: inherit;">しかし、Cモジュールでこれを行う必要はありません。インフラストラクチャはnginxでも十分です。</font><font style="vertical-align: inherit;">これらの問題のいくつかを解決するには、Luaを使用できます。NJSで何かが解決されています。</font><font style="vertical-align: inherit;">ただし、Cでモジュールを作成する必要がある場合もあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールを作成する時はいつですか</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時が来たことを理解するための2つの基準があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能の一般化。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の誰かがあなたの製品を必要としていることを理解したら、あなたはそれをオープンソースに密輸し、一般化された機能を作成し、それを投稿して、それを使わせるべきです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネス上の問題を解決します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">企業がnginx用の独自のモジュールを作成することによってのみ満たすことができるような要件を設定する場合。</font><font style="vertical-align: inherit;">たとえば、動的な挿入/コンテンツの変更、ClickStreamコレクションはLuaで実行できますが、通常は正常に動作しません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxアーキテクチャ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は長い間nginxコードを書いてきました。</font><font style="vertical-align: inherit;">私のモジュールの9つは本番環境で稼働しており、そのうちの1つはオープンソースで稼働しており、多くの人が稼働しています。</font><font style="vertical-align: inherit;">したがって、私には経験と理解があります。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxは、すべてがカーネルを中心に構築されている入れ子人形です。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> だから私はnginxを理解しています。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コアはepollのラッパーです。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Epollは、記述子が単なるソケットではないため、ソケットだけでなく任意の記述子ファイルを非同期で操作できるメソッドです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アップストリーム、HTTP、スクリプトはカーネルの上に構築されています。スクリプトとは、NJSではなくnginx.confを意味します。アップストリーム、HTTP、スクリプティングに加えて、HTTPモジュールがすでに構築されています。これについては後で説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d7/b6/ff/d7b6ffhplgm4ddkbvncbfh4umym.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アップストリームとHTTPの典型的な例は、アップストリームサーバー-構成内のディレクティブです。 HTTPのモジュールの例はadd_headerです。スクリプトの例は、設定ファイル自体です。このファイルには、nginxを構成するモジュールが含まれています。これは何らかの方法で解釈され、管理者またはユーザーとして何かを行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コアは考慮しません。上流は、nginx内の別のユニバースであるため、ごく簡単に説明します。</font><font style="vertical-align: inherit;">それらについての物語はいくつかの記事に値する。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPモジュールの構造</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nginx内でCコードを記述せずにそれを使用する場合でも、主な規則を覚えておいてください。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxでは、すべてが責任の連鎖-CORパターンに従います。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これをロシア語に翻訳する方法はわかりませんが、ロジックを説明します。</font><font style="vertical-align: inherit;">リクエストは、場所から始まり、構成されたチェーンモジュールの銀河を通過します。</font><font style="vertical-align: inherit;">これらの各モジュールは結果を返します。</font><font style="vertical-align: inherit;">結果が悪い場合、チェーンは中断されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ky/sf/zj/kysfzj-evntyaf8v8q53ygxgrr4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールを開発するとき、またはNJSとLuaでなんらかのディレクティブを使用するときは、コードがこのチェーンの実行をクラッシュさせる可能性があることを忘れないでください。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Chain of Responsibilityに</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最も近い例</font><font style="vertical-align: inherit;">は、Bashコードの行です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">grep -RI pool nginx | awk -F<span class="hljs-string">":"</span> <span class="hljs-string">'{print $1}'</span> | sort -u | wc -l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードでは、すべてが非常に単純です。AWKが行の途中にある場合、</font></font><code>sort</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のコマンドは実行されません。</font><font style="vertical-align: inherit;">nginxモジュールも同様に動作しますが、真実はnginxにあり、これを回避することができます-コードを再起動します。</font><font style="vertical-align: inherit;">ただし、configで使用するモジュールと同じように、クラッシュして実行する準備ができている必要がありますが、そうではありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPモジュールのタイプ</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPとnginxは、さまざまなPHASEの集まりです。</font></font></blockquote><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フェーズ処理-PHASEハンドラー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィルター-本文/ヘッダーフィルター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このフィルタリングは、ヘッダーまたはリクエスト本文のいずれかです。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">典型的なプロキシモジュールは、proxy_pass、fastcgi_pass、memcached_pa​​ssです。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のロードバランシング用のモジュール-ロードバランサ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは最もねじれていないタイプのモジュールであり、開発されたモジュールはほとんどありません。</font><font style="vertical-align: inherit;">例は、Ketama CHashモジュールです。これにより、nginx内で一貫したハッシュを実行して、リクエストをバックエンドに分散できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの各タイプとその目的について説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フェーズハンドラー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセスフェーズから始まるいくつかのフェーズがあると想像してください。</font><font style="vertical-align: inherit;">各フェーズにはいくつかのモジュールがあります。</font><font style="vertical-align: inherit;">たとえば、ACCESSフェーズは、接続、nginxへのリクエスト、ユーザー認証の検証に分かれています。</font><font style="vertical-align: inherit;">各モジュールはチェーン内のセルです。</font><font style="vertical-align: inherit;">フェーズには、このようなモジュールが無数に存在する可能性があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/6b/t9/pn6bt9m3khwxmsxgnqjvyzwfcb0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の最後のハンドラは、コンテンツがオンデマンドで配信されるCONTENTフェーズです。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法は常にこれです：リクエスト-ハンドラーのチェーン-出力コンテンツ。</font></font></blockquote><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/nginx/nginx/blob/master/src/http/ngx_"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NGINXソース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からモジュールの開発者が利用できるフェーズ</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> {<font></font>
    NGX_HTTP_POST_READ_PHASE = <span class="hljs-number">0</span>,<font></font>
<font></font>
    NGX_HTTP_SERVER_REWRITE_PHASE,<font></font>
<font></font>
    NGX_HTTP_FIND_CONFIG_PHASE,<font></font>
    NGX_HTTP_REWRITE_PHASE,<font></font>
    NGX_HTTP_POST_REWRITE_PHASE,<font></font>
<font></font>
    NGX_HTTP_PREACCESS_PHASE,<font></font>
<font></font>
    NGX_HTTP_ACESS_PHASE,<font></font>
    NGX_HTTP_POST_ACESS_PHASE,<font></font>
<font></font>
    NGX_HTTP_PRECONTENT_PHASE,<font></font>
<font></font>
    NGX_HTTP_CONTENT_PHASE,<font></font>
<font></font>
    NGX_HTTP_LOG_PHASE,<font></font>
} ngx_http_phases;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フェーズは上書きできます。独自のハンドラを追加してください。 nginxコア開発者でない場合、実際にはすべてが必要なわけではありません。したがって、私は各フェーズについてではなく、主に使用したフェーズについてのみ説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主なものは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACCESS_PHASEです。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認をnginxに追加することは特に役立ちます-アクセスに関してリクエストの実行をチェックするため。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私がよく利用する次の重要なフェーズは、事前コンテンツとコンテンツのフェーズです。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PRECONTENT_PHASEを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><strong><font style="vertical-align: inherit;">する</font></strong><font style="vertical-align: inherit;">と、クライアントへの応答として送信されるコンテンツに関するメトリックを収集でき</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONTENT_PHASEを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><strong><font style="vertical-align: inherit;">する</font></strong><font style="vertical-align: inherit;">と、何かに基づいて独自のコンテンツを生成でき</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が頻繁に使用する最後のフェーズは、ロギングフェーズです</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOG_PHASE。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ちなみに、ACCESS_LOGディレクティブはその中で機能します。</font><font style="vertical-align: inherit;">ロギングフェーズには、私を狂わせる最も厳しい制限があります。サブリクエストは使用できず、通常はリクエストを使用できません。</font><font style="vertical-align: inherit;">既にユーザーにコンテンツを残しているため、ハンドラー、ポストハンドラー、およびサブリクエストは実行されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
迷惑な理由を説明します。</font><font style="vertical-align: inherit;">ロギングフェーズでnginxとKafkaを交差させたい場合を考えてみましょう。</font><font style="vertical-align: inherit;">このフェーズでは、すべてが既に完了しています。計算されたコンテンツサイズ、ステータス、すべてのデータがありますが、サブリクエストは実行できません。</font><font style="vertical-align: inherit;">彼らはそこで働きません。</font><font style="vertical-align: inherit;">Kafkaにデータを送信するには、ロギングフェーズでベアソケットに書き込む必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボディ/ヘッダーフィルター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィルターには、ボディフィルターとヘッダーフィルターの2種類があります。</font><strong><font style="vertical-align: inherit;">Bodyフィルター</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の例</font><font style="vertical-align: inherit;">は、gzipフィルターモジュールです。なぜボディフィルターが必要なのですか？特定のproxy_passがあり、なんとかしてコンテンツを変換または分析したいとします。この場合、ボディフィルターを使用する必要があります。</font><font style="vertical-align: inherit;">
それはこのように機能します：多くのチャンクがあなたのところに来て、あなたはそれらを使って何かをし、内容を見て、集計します、など。ただし、フィルタには大きな制限もあります。たとえば、本文を変更する場合（応答本文を挿入または切り取る場合）は、コンテンツテープなどのHTTP属性が置き換えられることに注意してください。制限を設けず、コードに正しく反映しないと、奇妙な影響が生じる可能性があります。</font><strong><font style="vertical-align: inherit;">ヘッダーフィルターの</font></strong><font style="vertical-align: inherit;"> 
例</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-誰もが使用したadd_header。</font><font style="vertical-align: inherit;">アルゴリズムはボディフィルターと同じように機能します。</font><font style="vertical-align: inherit;">クライアントの応答が準備され、add_headerフィルターを使用して、ヘッダーの追加、ヘッダーの削除、ヘッダーの置換、サブリクエストの送信などを実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、ボディフィルターとヘッダーフィルターでサブリクエストを利用できるので、内部のIDを追加の場所に送信することもできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、要求を外部システムにプロキシすることを可能にする、たとえば</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPを別のプロトコルに変換する</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など、最も複雑で論争の的となるタイプのモジュール</font><strong><font style="vertical-align: inherit;">です</font></strong><font style="vertical-align: inherit;">。例：proxy_pass、redis_pass、tnt_pass。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロキシは、プロキシモジュールの作成を容易にするためにnginxコア開発者が提案したインターフェイスです。これが従来の方法で行われる場合、そのようなプロキシのPHASESハンドラー、フィルター、バランサーが実行されます。ただし、HTTPに変換するプロトコルが従来のプロトコルと何らかの形で異なる場合、大きな問題が発生します。 nginxが提供するプロキシAPIは単に適切ではありません。このプロキシモジュールをゼロから作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなモジュールの良い例はpostgres_passです。</font><font style="vertical-align: inherit;">nginxがPostgreSQLと通信できるようにします。</font><font style="vertical-align: inherit;">モジュールはnginxで開発されたインターフェースをまったく使用しません-それは独自のパスを持っています。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシを覚えておいてください。ただし、できません。</font><font style="vertical-align: inherit;">プロキシを作成するには、すべてのnginxを暗記する必要があります。これは非常に長く困難です。</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードバランサー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロードバランサーのタスクは非常に単純です-ラウンドロビンモードで動作します。</font><font style="vertical-align: inherit;">上流セクションがあり、その中にサーバーがいくつかあるとします。重みとバランス方法を指定します。</font><font style="vertical-align: inherit;">これは典型的なロードバランサーです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このモードは常に適切であるとは限りません。</font><font style="vertical-align: inherit;">したがって、Ketama CHashモジュールが開発されました。これにより、一部のサーバーへの一貫したハッシュ要求に条件付きで到達することができます。</font><font style="vertical-align: inherit;">時にはそれは便利です。</font><font style="vertical-align: inherit;">Nginx Luaは、balancer_by_luaを提供しています。</font><font style="vertical-align: inherit;">Luaでは、一般的に任意のバランサーを作成できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cモジュール</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は、Cモジュールの開発に関する私の主観的な意見です。まず第一に-私の主観的なルール。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールはnginx.confディレクティブで始まります。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会社でのみ動作するCモジュールを作成する場合でも、常にディレクティブについて考えてください。これはシステム管理者とのやり取りになるため、これらのモジュールを使用してモジュールの設計を開始します。これは重要です。すべてのニュアンスを彼またはCモジュールを操作する人と調整してください。 NGINXは有名な製品であり、その指令はシステム管理者が知っている特定の法律に従います。したがって、常にそれについて考えてください。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxコードスタイルを使用します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたのモジュールが他の人によってサポートされることを想像してみてください。彼がすでにnginxとそのコードスタイルに精通している場合、彼があなたのコードを読んで理解するのははるかに簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、ドイツの親友が私に彼のnginxコード内のバグに対処するのを手伝ってくれるように頼みました。彼が書いたコードのスタイルはわかりませんが、コードを正常に読み取ることさえできませんでした。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しいメモリプールを使用してください。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nginxの経験が豊富であっても、常にこのことを覚えておいてください。 nginxの初心者Cモジュール開発者の典型的な間違いは、間違ったプールを取得することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し背景：nginxは一般に弱いアロケータのイデオロギーを使用します。そこでmallocを使用できますが、お勧めできません。独自のスラブ、独自のメモリアロケータがあり、使用する必要があります。したがって、各オブジェクトにはそのプールへのリンクがあり、このプールを使用する必要があります。典型的な初心者の間違いは、プールリクエストではなく、ヘッダーフィルターでプール接続を使用することです。これは、キープアライブ接続がある場合、メモリ不足または他の副作用が発生するまでプールが膨張することを意味します。したがって、それは重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、そのようなエラーはデバッグが非常に困難です。 Valgrind（「syshniks」は理解します）はスラブ割り当てでは機能しません-奇妙な画像が表示されます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロッキングI / Oを使用しない</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">外部に何かをより速く適用したい人の典型的な間違いは、ブロッキングI / Oとブロッキングソケットを使用することです。</font><font style="vertical-align: inherit;">nginxではこれを行うことはできません-その中に多くのプロセスがありますが、各プロセスは1つのスレッドを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチスレッドを実行することはできますが、原則として、これは悪化するだけです。</font><font style="vertical-align: inherit;">このようなアーキテクチャでブロッキングI / Oを使用する場合、誰もがこのブロッキング部分を待つことになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の内容を解読します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールはnginx.confディレクティブで始まります</font></font></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクティブがどのospreyに存在するかを決定します：メイン、サーバー、HTTP、場所、場所if。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の場合は場所を避けてください-原則として、これはnginx構成の非常に奇妙な使用につながります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nginxのすべてのディレクティブは、さまざまなコンテキストとスコープにあります。</font><font style="vertical-align: inherit;">add_headerディレクティブは、HTTPレベル、ロケーションレベル、ロケーションIFレベルで機能します。</font><font style="vertical-align: inherit;">これは通常、ドキュメントで説明されています。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクティブが機能するレベル、ディレクティブが実行される場所（フェーズハンドラー、ボディ/ヘッダーフィルター）を理解します。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxでは設定が固定されているため、これは重要です。</font><font style="vertical-align: inherit;">慣例として、add_headerを上記のどこかに書き込むと、この値はすでに配置されている下部のadd_headerで平滑化されます。</font><font style="vertical-align: inherit;">したがって、2つのヘッダーを追加します。</font><font style="vertical-align: inherit;">これはすべてのディレクティブに適用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストポートに何かを示すと、その逆の場合、ソケットプールが上昇します。</font><font style="vertical-align: inherit;">これは一度表示する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、私はマージを禁止します-あなたはそれを必要としません。</font><font style="vertical-align: inherit;">したがって、configまたはディレクティブのセットがどのnginx配列に存在するかを常に明確に判断する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
良い手本：</font></font><br>
<br>
<pre><code class="cpp hljs">location /my_location/ {<font></font>
    add_header “My-Header” “my value”;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでadd_headerは単に場所に追加されます。</font><font style="vertical-align: inherit;">同じadd_headerが上のどこかにある可能性があり、すべてが単純に歪曲されます。</font><font style="vertical-align: inherit;">これは文書化された理解可能な動作です。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指令の実施を妨げる可能性があるものについて考えてください。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたがボディフィルターを開発していると想像してください。</font><font style="vertical-align: inherit;">上で述べたように、nginxはモジュールを共通のチェーンに配置するだけであり、コンパイル時にgzipモジュールがBodyフィルターの前のチェーンに入らなかったという保証はありません。</font><font style="vertical-align: inherit;">この場合、誰かがgzipモジュールをオンにすると、データはgzipのモジュールに送られます。</font><font style="vertical-align: inherit;">これは、コンテンツに対して何もできないことを脅かしています。</font><font style="vertical-align: inherit;">たとえば、再gzipできますが、これはCPUの観点からはあざけりです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じルールがすべてのフェーズハンドラーに適用されます。誰が前に呼び出され、誰が後になるかは保証されていません。</font><font style="vertical-align: inherit;">したがって、後で呼び出される人を尊重し、gzipやその他の何かが予期せず飛んで来る可能性があることを覚えておいてください。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxコードスタイル</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">製品を作成したとき、誰かがそれをサポートすることを覚えておいてください。</font><font style="vertical-align: inherit;">コードスタイルnginxを忘れないでください。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：あなたのnginxのモジュールを書き込む前に、ソースに慣れる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来、nginxモジュールの開発に取り組む場合、nginxのソースコードをよく知っています。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメンテーションがない</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のであなたはそれらを気に入る</font><strong><font style="vertical-align: inherit;">はず</font></strong><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">nginxからモジュールにいくつかの部分を転送する必要がある場合は、nginxのディレクトリ構造をよく学び、Grep（おそらくSed）の使い方を学びます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリプール</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プールは正しく使用する必要があります。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、「r-&gt; connection-&gt; pool！= R-&gt; pool」です。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの処理時にメモリプール構成を使用できない場合は、nginxが再起動するまで膨らみます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトの寿命を理解します。リクエストの再生に、このパイプラインの存続​​期間があると仮定します。このプールにはたくさんのものを置いて、部屋を作ることができます。接続は理論的に無期限に存続することができます-それに本当に重要なものを配置することをお勧めします。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc / freeなどの外部アロケータを使用しないようにしてください</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これは、メモリの断片化に悪影響を及ぼします。大量のデータを操作して多くのmallocを使用する場合、このnginxはかなり遅くなります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valgrindのファンのために</font></font></strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハックがあります</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Valgrindを使用してnginx-poolsをデバッグできるようにします。</font><font style="vertical-align: inherit;">多くのnginx Cコードがある場合、これは重要です。経験豊富なメモリ開発者でも間違いを犯す可能性があるためです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロッキングI / O</font></font></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここではすべてが簡単です。ブロッキングI / Oを使用しないでください。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そうしないと、少なくともキープアライブ接続で問題が発生しますが、最大でも、すべてが非常に長い間動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は人がブロッキングモードでnginx内でQuoraを使用した場合を知っています（理由は尋ねないでください）。</font><font style="vertical-align: inherit;">これにより、キープアライブ接続がアクティビティを放棄し、常にタイムアウトするという事実につながりました。</font><font style="vertical-align: inherit;">nginxは多くのことでタイムアウトを開始するので、これを行わない方が良いです-すべてが長時間非効率的に機能し、100万回のタイムアウトをすぐに変更する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、Cモジュールに代わるもの-NJSとLuaがあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C-モジュールを開発する必要がない場合</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今年は初めてNJSを体験しましたが、NJSに主観的な印象があり、そこに何が欠けているかさえわかったので、すべてが順調でした。</font><font style="vertical-align: inherit;">また、nginxでLuaを使用した経験について話し、さらにLuaに存在する問題を共有したいと思います。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua / LuaJit Essentials</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NginxはLuaではなくLuaJitを使用します。しかし、これはLuaではありません。Luaはすでに2つのバージョンを進めており、LuaJitは過去のどこかに行き詰まっているからです。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">著者は実質的にLuaJitを開発していません-彼はしばしばフォークに住んでいます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新のフォークは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LuaJit2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。これは、同じOpenRestyで奇妙な状況を追加します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガベージコレクタは注意が必要</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。 LuaJitはこの問題を克服できません。いくつかの回避策を考え出してください。負荷が非常に大きいため、クライアントでキープアライブガーベッジコレクターが多数表示され、グラフのエラーと500エラーが発生する場合、Luaでガーベッジコレクターに対処する方法はたくさんあるので、ここではそれらに焦点を当てません。これについてはインターネット上にたくさんの情報があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列の実装はパフォーマンスの問題につながります</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これはLuaJitの悪であり、Luaで修正しました。</font><font style="vertical-align: inherit;">LuaJitでの文字列の実装は、単純にロジックを無視します。</font><font style="vertical-align: inherit;">回線は、内部実装に関連付けられている最もワイルドな方法でスローダウンします。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの既製のライブラリを使用できない</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Luaは最初はブロックしているため、LuaおよびLuaJitのほとんどのライブラリはブロックI / Oを使用します。</font><font style="vertical-align: inherit;">nginxはブロックされていないため、ブロックI / Oを使用するnginx内で既製のライブラリを使用することはできません。</font><font style="vertical-align: inherit;">これはnginxを遅くします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LuaJitを使用する理由は、モジュールを使用する理由と同じです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複雑なモジュールのプロトタイピング;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認のためのHMAC、SHA計算。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バランサー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小さなアプリケーション：ヘッダープロセッサ、リダイレクトのルール。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx.confの計算変数。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LuaJitを使用しない方がよい場合はどこですか？</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主なルール：Luaで巨大なボディを処理しないでください-これは機能しません。</font></font></blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaのコンテンツのハンドラーも機能しません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ロジックを最小限に抑えるようにしてください</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">単純なバランサーは機能しますが、Luaのサイドバーは機能しません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有メモリやガベージコレクタがやってきます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaで共有メモリを使用しないでください-ガーベッジコレクターは、迅速かつ確実に、脳全体を本番環境に移行します。</font><font style="vertical-align: inherit;">多くのキープアライブコンパウンドで</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コルーチン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">使用しないでください</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コルーチンはLuaJitガベージコレクター内にさらに多くのゴミを生成しますが、これは悪いことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LuaJitを既に使用している場合は、次の点に注意してください。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ監視について;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガベージコレクターの作業の監視と最適化について</font></font></li>
<li>   Garbage Collector,   -     LuaJit,      - .</li>
</ul><br>
<h3>NJS</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私がNGINX会議にいたとき、彼らはCでコードを書かないのは素晴らしいことだと私に確信させました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。それは機能し、コードはシンプルで、速度には影響しません-すべてが素晴らしいです。私</font><font style="vertical-align: inherit;">が始めた</font><font style="vertical-align: inherit;">小さな</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトタイプ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、10行のコードです。しかし、これらの10行はs3で承認を行います。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx.confの変数を計算しています。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの変数はNJSを使用して計算できます。 nginxの中では、これはクールです。 Luaにはそのような機能がありますが、ガベージコレクターがあるため、それほどクールではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、すべてがそれほど良いわけではありません。 NJSで本当にクールなことをするために、彼はいくつかのことを逃しています。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有メモリ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。共有メモリにパッチを適用しました。これは私自身のフォークなので、これで十分です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より多くのフェーズをサポートするフィルター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">NJSにはコンテンツフェーズと変数のみがあり、ヘッダーフィルターは非常に不足しています。</font><font style="vertical-align: inherit;">多くのヘッダーを追加するには、松葉杖を書く必要があります。</font><font style="vertical-align: inherit;">複雑なロジックやコンテンツの操作に十分なボディフィルターがありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視とプロファイルの方法に関する情報</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">方法はわかったが、情報源を研究しなければならなかった。</font><font style="vertical-align: inherit;">適切なプロファイリングに関する十分な情報またはツールがありません。</font><font style="vertical-align: inherit;">ある場合は、見つからない場所に隠されています。</font><font style="vertical-align: inherit;">同じ時点で、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NJS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">使用できる場所と使用</font></strong><font style="vertical-align: inherit;">できない場所</font><font style="vertical-align: inherit;">についての十分な情報</font><font style="vertical-align: inherit;">がありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C-モジュール</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">NJSを拡張したいという思いがありました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あとがき</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ独自のモジュールを作成するのですか？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的およびビジネス上の問題を解決するため。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cでモジュールを実装する必要があるのはいつですか？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他に選択肢がない場合。たとえば、高負荷、コンテンツの挿入、ハードウェアの基本的な節約などです。次に、これはCで保証されている必要があります。ほとんどの場合、LuaまたはNJSが適しています。しかし、常に先を考えなければなりません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そしてルアに？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cで記述できない場合。たとえば、巨大なRPSを使用してリクエストの本文を変換する必要はありません。あなたの顧客の数は増えており、ある時点で対処をやめるでしょう-それについて考えてください。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NJS？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LuaJitがガベージコレクターと文字列に完全にうんざりしているとき。</font><font style="vertical-align: inherit;">たとえば、承認によりLuaに多数のガベージオブジェクトが生成されましたが、これは重要ではありませんでした。</font><font style="vertical-align: inherit;">しかし、これは監視と迷惑に反映されました。</font><font style="vertical-align: inherit;">今では私の監視に表示されなくなり、すべてが良くなりました。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++ 2019で、ワシーリーSoshnikovはnginxのモジュールとの話題続ける</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">話を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LuaJitとCとの比較忘れてはならない、よりNJSについての</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全な参照を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一覧</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイト上のレポートや高負荷システムの開発者のための最大の会議で11月7日と8であなたを参照してください。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニュースレター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報チャネル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で私たちの新しいアイデアに従ってください</font><font style="vertical-align: inherit;">。</font></font></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471666/index.html">就労ビザでドイツに移住するiOS開発者を体験する</a></li>
<li><a href="../ja471668/index.html">checkm8エクスプロイトのテクニカル分析</a></li>
<li><a href="../ja471670/index.html">Jetpack Composeを戦闘で試してみませんか？</a></li>
<li><a href="../ja471676/index.html">Телефонные мошенники. Действие второе, в котором я срываюсь и бегу до ближайшего банкомата</a></li>
<li><a href="../ja471678/index.html">オンデマンドでサービスを提供</a></li>
<li><a href="../ja471686/index.html">AWSが回復力のあるサービスを醸造する方法。サーバーとデータベースのスケーリング</a></li>
<li><a href="../ja471688/index.html">AWSが回復力のあるサービスを醸造する方法。ネットワークスケーリング</a></li>
<li><a href="../ja471700/index.html">将来の基盤を備えた技術スタックをどのように選択したか</a></li>
<li><a href="../ja471702/index.html">サイバー拡張Webアプリケーション</a></li>
<li><a href="../ja471704/index.html">本「セルフィ​​ッシュミトコンドリア。健康を維持して老後を動かす方法」</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>