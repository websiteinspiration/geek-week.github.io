<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé§ üõå üçµ „Åü„Å∂„Çì„É¢„Éä„Éâasync„Çí‰ªã„Åó„Å¶C„ÅßÂæÖ„Å§Ôºà„Çø„Çπ„ÇØov„Å™„ÅóÔºÅÔºâ üë∞üèΩ ü§πüèø üéÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="„Ç∏„Çß„Éç„É™„ÉÉ„ÇØÈùûÂêåÊúüÊàª„ÇäÂÄ§Âûã„ÅØCÔºÉ7„ÅßÂ∞éÂÖ•„Åï„Çå„ÅüÊñ∞Ê©üËÉΩ„Åß„ÄÅÈùûÂêåÊúüÔºà async / awaitÔºâ„É°„ÇΩ„ÉÉ„Éâ„ÅÆÊàª„ÇäÂÄ§Âûã„Å®„Åó„Å¶ Task„Å†„Åë„Åß„Å™„Åè„ÄÅÁâπÂÆö„ÅÆË¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åô‰ªñ„ÅÆÂûãÔºà„ÇØ„É©„Çπ„Åæ„Åü„ÅØÊßãÈÄ†Ôºâ„ÇÇ‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ
 

 async/await ‚Äî , . , async/await , , ? , ( ). ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>„Åü„Å∂„Çì„É¢„Éä„Éâasync„Çí‰ªã„Åó„Å¶C„ÅßÂæÖ„Å§Ôºà„Çø„Çπ„ÇØov„Å™„ÅóÔºÅÔºâ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468017/"><p><img src="https://habrastorage.org/webt/3n/zz/tw/3nzztwahkcl-ppecyzowprupvym.jpeg"></p><br>
<p><strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Ç∏„Çß„Éç„É™„ÉÉ„ÇØÈùûÂêåÊúüÊàª„ÇäÂÄ§Âûã</font></font></a></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„ÅØCÔºÉ7„ÅßÂ∞éÂÖ•„Åï„Çå„ÅüÊñ∞Ê©üËÉΩ</font><font style="vertical-align: inherit;">„Åß„ÄÅÈùûÂêåÊúüÔºà</font><strong><font style="vertical-align: inherit;"> async / await</font></strong><font style="vertical-align: inherit;">Ôºâ„É°„ÇΩ„ÉÉ„Éâ</font><font style="vertical-align: inherit;">„ÅÆÊàª„ÇäÂÄ§Âûã„Å®„Åó„Å¶</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Task</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Å†„Åë„Åß„Å™„Åè</font><font style="vertical-align: inherit;">„ÄÅÁâπÂÆö„ÅÆË¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åô‰ªñ„ÅÆÂûãÔºà„ÇØ„É©„Çπ„Åæ„Åü„ÅØÊßãÈÄ†Ôºâ„ÇÇ‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p><br>
<p>    <strong>async/await</strong> ‚Äî          ,      <strong></strong>.  ,     <strong>async/await</strong>   ,      ,      ? ,   (  ). ,      :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> s <span class="hljs-keyword">in</span> <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"1,2"</span>, <span class="hljs-string">"3,7,1"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"1"</span> })<font></font>
  {<font></font>
      <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">await</span> Sum(s).GetMaybeResult();<font></font>
      Console.WriteLine(res.IsNothing ? <span class="hljs-string">"Nothing"</span> : res.GetValue().ToString());<font></font>
  }<font></font>
  <span class="hljs-comment">// 3, 11, Nothing, Nothing</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">async</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Sum</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> input</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">await</span> Split(input);<span class="hljs-comment">//  </span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> arg <span class="hljs-keyword">in</span> args)<font></font>
        result += <span class="hljs-keyword">await</span> Parse(arg);<span class="hljs-comment">//  </span>
    <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
<font></font>
Maybe&lt;<span class="hljs-keyword">string</span>[]&gt; Split(<span class="hljs-keyword">string</span> str)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> parts = str?.Split(<span class="hljs-string">','</span>).Where(s=&gt;!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(s)).ToArray();
  <span class="hljs-keyword">return</span> parts == <span class="hljs-literal">null</span> || parts.Length &lt; <span class="hljs-number">2</span> ? Maybe&lt;<span class="hljs-keyword">string</span>[]&gt;.Nothing() : parts;<font></font>
}<font></font>
<font></font>
<span class="hljs-function">Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Parse</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> str</span>)</span>
    =&gt; <span class="hljs-keyword">int</span>.TryParse(str, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> result) ? result : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing();</code></pre><br>
<p>  ,     ...</p><a name="habracut"></a><br>
<h2 id="obobschennye-asinhronnye-tipy-vozvraschaemyh-znacheniy">    </h2><br>
<p>   ,        (,  <strong>MyAwaitable&lt;T&gt;</strong>)       .  ,     :</p><br>
<ol>
<li><p><strong>GetAwaiter()</strong> ,    ,    <strong>INotifyCompletion</strong>,     <strong>bool IsCompleted</strong>   <strong>T GetResult()</strong> ;</p><br>
</li>
<li><p><strong>[AsyncMethodBuilder(Type)]</strong> ‚Äî a   ,      " " ("<strong>Method Builder</strong>"),  <strong>MyAwaitableTaskMethodBuilder&lt;T&gt;</strong>.       :</p><br>
<ul>
<li>static Create()</li>
<li>Start(stateMachine)</li>
<li>SetResult(result)</li>
<li>SetException(exception)</li>
<li>SetStateMachine(stateMachine)</li>
<li>AwaitOnCompleted(awaiter, stateMachine)</li>
<li>AwaitUnsafeOnCompleted(awaiter, stateMachine)</li>
<li>Task</li>
</ul><br>
</li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">   MyAwaitable  MyAwaitableTaskMethodBuilder</b><div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta">AsyncMethodBuilder(typeof(MyAwaitableTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAwaitable</span>&lt;T&gt; : <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> Action _continuation;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAwaitable</span>(<span class="hljs-params"></span>)</span><font></font>
    { }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAwaitable</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>.Value = <span class="hljs-keyword">value</span>;
        <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> MyAwaitable&lt;T&gt; <span class="hljs-title">GetAwaiter</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">this</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsCompleted { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> T Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> Exception Exception { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetResult</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.IsCompleted) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Not completed"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.Exception != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            ExceptionDispatchInfo.Throw(<span class="hljs-keyword">this</span>.Exception);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.Value;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetResult</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.IsCompleted) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Already completed"</span>);
        <span class="hljs-keyword">this</span>.Value = <span class="hljs-keyword">value</span>;
        <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>._continuation?.Invoke();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetException</span>(<span class="hljs-params">Exception exception</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.Exception = exception;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">void</span> INotifyCompletion.OnCompleted(Action continuation)<font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>._continuation = continuation;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.IsCompleted)<font></font>
        {<font></font>
            continuation();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAwaitableTaskMethodBuilder</span>&lt;T&gt;<font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyAwaitableTaskMethodBuilder</span>(<span class="hljs-params"></span>)</span> 
        =&gt; <span class="hljs-keyword">this</span>.Task = <span class="hljs-keyword">new</span> MyAwaitable&lt;T&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MyAwaitableTaskMethodBuilder&lt;T&gt; <span class="hljs-title">Create</span>(<span class="hljs-params"></span>)</span> 
    =&gt; <span class="hljs-keyword">new</span> MyAwaitableTaskMethodBuilder&lt;T&gt;();<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> Start&lt;TStateMachine&gt;(<span class="hljs-keyword">ref</span> TStateMachine stateMachine) 
        <span class="hljs-keyword">where</span> TStateMachine : IAsyncStateMachine <font></font>
        =&gt; stateMachine.MoveNext();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetStateMachine</span>(<span class="hljs-params">IAsyncStateMachine stateMachine</span>)</span> { }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetException</span>(<span class="hljs-params">Exception exception</span>)</span> 
        =&gt; <span class="hljs-keyword">this</span>.Task.SetException(exception);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetResult</span>(<span class="hljs-params">T result</span>)</span> 
        =&gt; <span class="hljs-keyword">this</span>.Task.SetResult(result);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> AwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;(
        <span class="hljs-keyword">ref</span> TAwaiter awaiter, 
        <span class="hljs-keyword">ref</span> TStateMachine stateMachine) 
        <span class="hljs-keyword">where</span> TAwaiter : INotifyCompletion 
        <span class="hljs-keyword">where</span> TStateMachine : IAsyncStateMachine<font></font>
        =&gt; <span class="hljs-keyword">this</span>.GenericAwaitOnCompleted(<span class="hljs-keyword">ref</span> awaiter, <span class="hljs-keyword">ref</span> stateMachine);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> AwaitUnsafeOnCompleted&lt;TAwaiter, TStateMachine&gt;(
        <span class="hljs-keyword">ref</span> TAwaiter awaiter, 
        <span class="hljs-keyword">ref</span> TStateMachine stateMachine) 
        <span class="hljs-keyword">where</span> TAwaiter : ICriticalNotifyCompletion 
        <span class="hljs-keyword">where</span> TStateMachine : IAsyncStateMachine<font></font>
        =&gt; <span class="hljs-keyword">this</span>.GenericAwaitOnCompleted(<span class="hljs-keyword">ref</span> awaiter, <span class="hljs-keyword">ref</span> stateMachine);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;(
        <span class="hljs-keyword">ref</span> TAwaiter awaiter, 
        <span class="hljs-keyword">ref</span> TStateMachine stateMachine)
        <span class="hljs-keyword">where</span> TAwaiter : INotifyCompletion
        <span class="hljs-keyword">where</span> TStateMachine : IAsyncStateMachine         <font></font>
        =&gt; awaiter.OnCompleted(stateMachine.MoveNext);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> MyAwaitable&lt;T&gt; Task { <span class="hljs-keyword">get</span>; }<font></font>
}<font></font>
</code></pre></div></div><br>
<p>    <strong>MyAwaitable</strong>     :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> MyAwaitable&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">MyAwaitableMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> arg1 = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.GetMyAwaitable(<span class="hljs-number">1</span>);<font></font>
    result += arg1;<font></font>
    <span class="hljs-keyword">int</span> arg2 = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.GetMyAwaitable(<span class="hljs-number">2</span>);<font></font>
    result += arg2;<font></font>
    <span class="hljs-keyword">int</span> arg3 = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.GetMyAwaitable(<span class="hljs-number">3</span>);<font></font>
    result += arg3;<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> MyAwaitable&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">GetMyAwaitable</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> arg</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1</span>);<span class="hljs-comment">//   </span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> MyAwaitable&lt;<span class="hljs-keyword">int</span>&gt;(arg);<font></font>
}</code></pre><br>
<p>  ,        <strong>MyAwaitable</strong>  ,   C#    <strong>MyAwaitableMethod</strong>.    -  .NET- (, dotPeek),  ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> MyAwaitable&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">MyAwaitableMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> stateMachine = <span class="hljs-keyword">new</span> MyAwaitableMethodStateMachine();<font></font>
    stateMachine.Owner = <span class="hljs-keyword">this</span>;<font></font>
    stateMachine.Builder = MyAwaitableTaskMethodBuilder&lt;<span class="hljs-keyword">int</span>&gt;.Create();<font></font>
    stateMachine.State = <span class="hljs-number">0</span>;<font></font>
    stateMachine.Builder.Start(<span class="hljs-keyword">ref</span> stateMachine);
    <span class="hljs-keyword">return</span> stateMachine.Builder.Task;<font></font>
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title">MyAwaitableMethodStateMachine</b><div class="spoiler_text"><p><em>     ,     ,      </em></p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyAwaitableMethodStateMachine</span> : <span class="hljs-title">IAsyncStateMachine</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> State;
    <span class="hljs-keyword">public</span> MyAwaitableTaskMethodBuilder&lt;<span class="hljs-keyword">int</span>&gt; Builder;
    <span class="hljs-keyword">public</span> BuilderDemo Owner;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> _result;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> _arg1;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> _arg2;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> _arg3;
    <span class="hljs-keyword">private</span> MyAwaitableAwaiter&lt;<span class="hljs-keyword">int</span>&gt; _awaiter1;
    <span class="hljs-keyword">private</span> MyAwaitableAwaiter&lt;<span class="hljs-keyword">int</span>&gt; _awaiter2;
    <span class="hljs-keyword">private</span> MyAwaitableAwaiter&lt;<span class="hljs-keyword">int</span>&gt; _awaiter3;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetAwaitCompletion</span>(<span class="hljs-params">INotifyCompletion awaiter</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> stateMachine = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.Builder.AwaitOnCompleted(<span class="hljs-keyword">ref</span> awaiter, <span class="hljs-keyword">ref</span> stateMachine);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">void</span> IAsyncStateMachine.MoveNext()<font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> finalResult;
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            label_begin:<font></font>
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.State)<font></font>
            {<font></font>
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">this</span>._result = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">this</span>._awaiter1 = <span class="hljs-keyword">this</span>.Owner.GetMyAwaitable(<span class="hljs-number">1</span>).GetAwaiter();
                    <span class="hljs-keyword">this</span>.State = <span class="hljs-number">1</span>;<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._awaiter1.IsCompleted)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">this</span>.SetAwaitCompletion(<span class="hljs-keyword">this</span>._awaiter1);
                        <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
                    <span class="hljs-keyword">goto</span> label_begin;<font></font>
<font></font>
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<span class="hljs-comment">// awaiter1   </span>
                    <span class="hljs-keyword">this</span>._arg1 = <span class="hljs-keyword">this</span>._awaiter1.GetResult();
                    <span class="hljs-keyword">this</span>._result += <span class="hljs-keyword">this</span>._arg1;<font></font>
<font></font>
                    <span class="hljs-keyword">this</span>.State = <span class="hljs-number">2</span>;
                    <span class="hljs-keyword">this</span>._awaiter2 = <span class="hljs-keyword">this</span>.Owner.GetMyAwaitable(<span class="hljs-number">2</span>).GetAwaiter();<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._awaiter2.IsCompleted)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">this</span>.SetAwaitCompletion(<span class="hljs-keyword">this</span>._awaiter2);
                        <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
                    <span class="hljs-keyword">goto</span> label_begin;<font></font>
<font></font>
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<span class="hljs-comment">// awaiter2   </span><font></font>
<font></font>
                    <span class="hljs-keyword">this</span>._arg2 = <span class="hljs-keyword">this</span>._awaiter2.GetResult();
                    <span class="hljs-keyword">this</span>._result += <span class="hljs-keyword">this</span>._arg2;<font></font>
<font></font>
                    <span class="hljs-keyword">this</span>.State = <span class="hljs-number">3</span>;
                    <span class="hljs-keyword">this</span>._awaiter3 = <span class="hljs-keyword">this</span>.Owner.GetMyAwaitable(<span class="hljs-number">3</span>).GetAwaiter();<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._awaiter3.IsCompleted)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">this</span>.SetAwaitCompletion(<span class="hljs-keyword">this</span>._awaiter3);
                        <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
                    <span class="hljs-keyword">goto</span> label_begin;<font></font>
<font></font>
                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<span class="hljs-comment">// awaiter3   </span><font></font>
<font></font>
                    <span class="hljs-keyword">this</span>._arg3 = <span class="hljs-keyword">this</span>._awaiter3.GetResult();
                    <span class="hljs-keyword">this</span>._result += <span class="hljs-keyword">this</span>._arg3;<font></font>
<font></font>
                    finalResult = <span class="hljs-keyword">this</span>._result;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception();<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
        {<font></font>
            <span class="hljs-keyword">this</span>.State = <span class="hljs-number">-1</span>;
            <span class="hljs-keyword">this</span>.Builder.SetException(ex);
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.State = <span class="hljs-number">-1</span>;
        <span class="hljs-keyword">this</span>.Builder.SetResult(finalResult);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>  ,  ,  <strong>Method Builder</strong>   :</p><br>
<ol>
<li>   <strong>MoveNext()</strong>        .</li>
<li> ,       (<code>public MyAwaitable&lt;T&gt; Task { get; }</code>)</li>
<li>        : <strong>SetResult</strong>  <strong>SetException</strong>.</li>
</ol><br>
<p> ,   <strong>Method Builder</strong>      ,    ,      ,       ‚Äî    <strong>Maybe</strong>. </p><br>
<p>       ?‚Ä¶   ,          ,      .</p><br>
<h2 id="monada-maybe"> Maybe</h2><br>
<p>,  <strong>Maybe</strong> ‚Äî   ,      ,  -         (,   ).</p><br>
<p>        :</p><br>
<ol>
<li>   </li>
<li></li>
</ol><br>
<p>    ,     :</p><br>
<ol>
<li> ,      : " "  " " ("<strong>Nothing</strong>") ‚Äî   <strong>Maybe</strong></li>
<li>  (  <strong>SelectMany</strong>)   2 :<br>
2.1.   <strong>Maybe</strong><br>
2.2.     .         <strong>Maybe</strong>,    -       <strong>Nothing</strong>,       (,      )</li>
<li> <strong>SelectMany</strong>    <strong>Maybe</strong>      ,               (    ).     <strong>Maybe</strong>    <strong>Nothing</strong>,  <strong>SelectMany</strong>    <strong>Nothing</strong>.</li>
</ol><br>
<p><img src="https://habrastorage.org/webt/f2/zl/3k/f2zl3kmfcocbyyujwqa4wvidxqw.png"></p><br>
<p> C#      :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Maybe&lt;T&gt;<font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> Maybe&lt;T&gt;(T <span class="hljs-keyword">value</span>) =&gt; Value(<span class="hljs-keyword">value</span>);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Maybe&lt;T&gt;  <span class="hljs-title">Value</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span> =&gt; <span class="hljs-keyword">new</span> Maybe&lt;T&gt;(<span class="hljs-literal">false</span>, <span class="hljs-keyword">value</span>);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Maybe&lt;T&gt; Nothing = <span class="hljs-keyword">new</span> Maybe&lt;T&gt;(<span class="hljs-literal">true</span>, <span class="hljs-keyword">default</span>);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Maybe</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> isNothing, T <span class="hljs-keyword">value</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>.IsNothing = isNothing;
        <span class="hljs-keyword">this</span>._value = <span class="hljs-keyword">value</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">bool</span> IsNothing;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> T _value;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetValue</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">this</span>.IsNothing ? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Nothing"</span>) : <span class="hljs-keyword">this</span>._value;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MaybeExtensions</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Maybe&lt;TRes&gt; SelectMany&lt;TIn, TRes&gt;(
        <span class="hljs-keyword">this</span> Maybe&lt;TIn&gt; source, <font></font>
        Func&lt;TIn, Maybe&lt;TRes&gt;&gt; func)<font></font>
<font></font>
        =&gt; source.IsNothing ? <font></font>
            Maybe&lt;TRes&gt;.Nothing : <font></font>
            func(source.GetValue());<font></font>
}<font></font>
</code></pre><br>
<p>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> res = Function1(i).SelectMany(Function2).SelectMany(Function3);<font></font>
        Console.WriteLine(res.IsNothing ? <span class="hljs-string">"Nothing"</span> : res.GetValue().ToString());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function">Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Function1</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> acc</span>)</span> =&gt; acc &lt; <span class="hljs-number">10</span> ? acc + <span class="hljs-number">1</span> : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing;<font></font>
<font></font>
    <span class="hljs-function">Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Function2</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> acc</span>)</span> =&gt; acc &lt; <span class="hljs-number">10</span> ? acc + <span class="hljs-number">2</span> : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing;<font></font>
<font></font>
    <span class="hljs-function">Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Function3</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> acc</span>)</span> =&gt; acc &lt; <span class="hljs-number">10</span> ? acc + <span class="hljs-number">3</span> : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing;<font></font>
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title"> "SelectMany"?</b><div class="spoiler_text"><p>,       : "     "SelectMany"?   ,     ‚Äî  C#    <strong>Select Many</strong>      <strong>Query Notation</strong>, ,  ,  ‚Äú ‚Äù    . (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">       </a>).</p><br>
<p>  ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> res = Function1(i)<font></font>
    .SelectMany(x2 =&gt; <font></font>
        Function2(x2).SelectMany(x3 =&gt; <font></font>
            Function3(x3.SelectMany&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;(x4 =&gt; <font></font>
                x2 + x3 + x4)));</code></pre><br>
<p>       (x2, x3),        .  ,     ,   ,  C#  <strong>Query Notation</strong>         :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> res = <span class="hljs-function"><span class="hljs-keyword">from</span> x2 <span class="hljs-keyword">in</span> <span class="hljs-title">Function1</span>(<span class="hljs-params">i</span>)
    <span class="hljs-keyword">from</span> x3 <span class="hljs-keyword">in</span> <span class="hljs-title">Function2</span>(<span class="hljs-params">x2</span>)
    <span class="hljs-keyword">from</span> x4 <span class="hljs-keyword">in</span> <span class="hljs-title">Function3</span>(<span class="hljs-params">x3</span>)
    <span class="hljs-keyword">select</span> x2 + x3 + x4</span>;</code></pre><br>
<p> ,     ,      <strong>Select Many</strong>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Maybe&lt;TJ&gt; SelectMany&lt;TIn, TRes, TJ&gt;(
    <span class="hljs-keyword">this</span> Maybe&lt;TIn&gt; source, <font></font>
    Func&lt;TIn, Maybe&lt;TRes&gt;&gt; func, <font></font>
    Func&lt;TIn, TRes, TJ&gt; joinFunc)<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (source.IsNothing)
        <span class="hljs-keyword">return</span> Maybe&lt;TJ&gt;.Nothing;<font></font>
<font></font>
    <span class="hljs-keyword">var</span> res = func(source.GetValue());
    <span class="hljs-keyword">return</span> res.IsNothing <font></font>
        ? Maybe&lt;TJ&gt;.Nothing <font></font>
        : joinFunc(source.GetValue(), res.GetValue());<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">       ,      ""  "Maybe"</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> s <span class="hljs-keyword">in</span> <span class="hljs-keyword">new</span>[] {<span class="hljs-string">"1,2"</span>, <span class="hljs-string">"3,7,1"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"1"</span>})<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> res = Sum(s);<font></font>
        Console.WriteLine(res.IsNothing ? <span class="hljs-string">"Nothing"</span> : res.GetValue().ToString());<font></font>
    }<font></font>
<font></font>
    Console.ReadKey();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Sum</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> input</span>)</span>
    =&gt; Split(input).SelectMany(items =&gt; Acc(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, items));<font></font>
<font></font>
<span class="hljs-comment">//       "Maybe"</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Acc</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> res, <span class="hljs-keyword">int</span> index, IReadOnlyList&lt;<span class="hljs-keyword">string</span>&gt; array</span>)</span> <font></font>
    =&gt; index &lt; array.Count <font></font>
        ? Add(res, array[index])<font></font>
            .SelectMany(newRes =&gt; Acc(newRes, index + <span class="hljs-number">1</span>, array)) <font></font>
        : res;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> acc, <span class="hljs-keyword">string</span> nextStr</span>)</span> 
    =&gt; Parse(nextStr).SelectMany&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;(nextNum =&gt; acc + nextNum);<font></font>
<font></font>
<span class="hljs-keyword">static</span> Maybe&lt;<span class="hljs-keyword">string</span>[]&gt; Split(<span class="hljs-keyword">string</span> str)<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> parts = str?.Split(<span class="hljs-string">','</span>)<font></font>
        .Where(s =&gt; !<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(s)).ToArray();
    <span class="hljs-keyword">return</span> parts == <span class="hljs-literal">null</span> || parts.Length &lt; <span class="hljs-number">2</span> ? Maybe&lt;<span class="hljs-keyword">string</span>[]&gt;.Nothing : parts;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Parse</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-keyword">value</span></span>)</span>
    =&gt; <span class="hljs-keyword">int</span>.TryParse(<span class="hljs-keyword">value</span>, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> result) ? result : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing;
</code></pre><br>
<p><em>     ,  C#       ,   ""      . </em></p></div></div><br>
<h2 id="async-maybe">Async Maybe</h2><br>
<p>  <strong>Maybe</strong>      ,    ,   <strong>async/await</strong>.  ,     . -,     <strong>Maybe</strong>    ,    ,   : </p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Maybe</span>&lt;T&gt; : <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    ...<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Maybe&lt;T&gt; <span class="hljs-title">GetAwaiter</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">this</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsCompleted { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCompleted</span>(<span class="hljs-params">Action continuation</span>)</span>{...}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetResult</span>(<span class="hljs-params"></span>)</span> =&gt;...<font></font>
}</code></pre><br>
<p>  ,  ""  <strong>Maybe</strong>      ,     - :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> stateMachine = <span class="hljs-keyword">new</span> StateMachine();<font></font>
        stateMachine.state = <span class="hljs-number">0</span>;<font></font>
        stateMachine.i = i;<font></font>
        stateMachine.MoveNext();<font></font>
<font></font>
        <span class="hljs-keyword">var</span> res = stateMachine.Result;<font></font>
<font></font>
        Console.WriteLine(res.IsNothing ? <span class="hljs-string">"Nothing"</span> : res.GetValue().ToString());<font></font>
    }<font></font>
<font></font>
    Console.ReadKey();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">StateMachine</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> state = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">public</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; Result;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; _f1;
    <span class="hljs-keyword">private</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; _f2;
    <span class="hljs-keyword">private</span> Maybe&lt;<span class="hljs-keyword">int</span>&gt; _f3;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MoveNext</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        label_begin:<font></font>
        <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.state)<font></font>
        {<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                <span class="hljs-keyword">this</span>._f1 = Function1(<span class="hljs-keyword">this</span>.i);
                <span class="hljs-keyword">this</span>.state = Match ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;
                <span class="hljs-keyword">goto</span> label_begin;
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                <span class="hljs-keyword">this</span>._f2 = Function2(<span class="hljs-keyword">this</span>._f1.GetValue());
                <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">this</span>._f2.IsNothing ? <span class="hljs-number">-1</span> : <span class="hljs-number">2</span>;
                <span class="hljs-keyword">goto</span> label_begin;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                <span class="hljs-keyword">this</span>._f3 = Function3(<span class="hljs-keyword">this</span>._f2.GetValue());
                <span class="hljs-keyword">this</span>.state = <span class="hljs-keyword">this</span>._f3.IsNothing ? <span class="hljs-number">-1</span> : <span class="hljs-number">3</span>;
                <span class="hljs-keyword">goto</span> label_begin;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                <span class="hljs-keyword">this</span>.Result = <span class="hljs-keyword">this</span>._f3.GetValue();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:
                <span class="hljs-keyword">this</span>.Result = Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing;
                <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>         C# (.  ¬´MyAwaitableMethodStateMachine¬ª),   ,    <strong>Maybe</strong>    :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">this</span>.Builder.AwaitOnCompleted(<span class="hljs-keyword">ref</span> awaiter, <span class="hljs-keyword">ref</span> stateMachine);</code></pre><br>
<p> <code>ref awaiter</code> ‚Äî    <strong>Maybe</strong>.    ,        "" (-1) ,    ,       ?      .   ,      C#          <strong>INotifyCompletion</strong>, ,      ,          ,        .<br>
     ,        (   )    ,         ,          (   ):</p><br>
<p><img src="https://habrastorage.org/webt/da/v-/vb/dav-vbwfusgtb1degxhxyhafsdk.png"></p><br>
<p>,   -        .    ,   <strong>Method Builder</strong>,        ‚Äî <strong>Task</strong>.          <code>AwaitOnCompleted (ref awaiter)</code>  <strong>awaiter</strong>,     ,     <strong>Maybe</strong>,     <strong>Maybe</strong>      :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Maybe</span>&lt;T&gt; : <span class="hljs-title">IMaybe</span>, <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> IMaybe _parent;<font></font>
<font></font>
    <span class="hljs-keyword">void</span> IMaybe.SetParent(IMaybe parent) =&gt; <span class="hljs-keyword">this</span>._parent = parent;<font></font>
    ...<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MaybeTaskMethodBuilder</span>&lt;T&gt;<font></font>
{<font></font>
    ...<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;(
        <span class="hljs-keyword">ref</span> TAwaiter awaiter,
        <span class="hljs-keyword">ref</span> TStateMachine stateMachine) 
        <span class="hljs-keyword">where</span> TAwaiter : INotifyCompletion 
        <span class="hljs-keyword">where</span> TStateMachine : IAsyncStateMachine<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (awaiter <span class="hljs-keyword">is</span> IMaybe maybe)<font></font>
        {<font></font>
            maybe.SetParent(<span class="hljs-keyword">this</span>.Task);<font></font>
        }<font></font>
        awaiter.OnCompleted(stateMachine.MoveNext);<font></font>
    }  <font></font>
    ...  <font></font>
}</code></pre><br>
<p>    <strong>Maybe</strong>     ,   ,         ( <strong>Exit</strong>)   :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Maybe</span>&lt;T&gt; : <span class="hljs-title">IMaybe</span>, <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> Action _continuation;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> IMaybe _parent;<font></font>
    ...<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCompleted</span>(<span class="hljs-params">Action continuation</span>)</span><font></font>
    {<font></font>
        ...<font></font>
        <span class="hljs-keyword">this</span>._continuation = continuation;<font></font>
        ...<font></font>
    }<font></font>
    ...<font></font>
    <span class="hljs-keyword">void</span> IMaybe.Exit()<font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._parent != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            <span class="hljs-keyword">this</span>._parent.Exit();<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span><font></font>
        {<font></font>
            <span class="hljs-keyword">this</span>._continuation();<font></font>
        }<font></font>
    }<font></font>
    ...<font></font>
}</code></pre><br>
<p> <strong>Exit</strong>  ,            <strong>Maybe</strong>   <strong>Nothing</strong>.   <strong>Maybe</strong>      :</p><br>
<pre><code class="cs hljs"><span class="hljs-function">Maybe&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">Parse</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> str</span>)</span>
    =&gt; <span class="hljs-keyword">int</span>.TryParse(str, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> result) ? result : Maybe&lt;<span class="hljs-keyword">int</span>&gt;.Nothing();</code></pre><br>
<p>   <strong>Maybe</strong>,    :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> MaybeResult<font></font>
{<font></font>
    ...<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> T _value;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">bool</span> IsNothing;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetValue</span>(<span class="hljs-params"></span>)</span> 
        =&gt; <span class="hljs-keyword">this</span>.IsNothing ? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Nothing"</span>) : <span class="hljs-keyword">this</span>._value;<font></font>
}<font></font>
<font></font>
[<span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Maybe</span>&lt;T&gt; : <span class="hljs-title">IMaybe</span>, <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> MaybeResult? _result;<font></font>
    ...<font></font>
    <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-title">Maybe</span>(<span class="hljs-params"></span>)</span> { }<span class="hljs-comment">//Used in async method</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Maybe</span>(<span class="hljs-params">MaybeResult result</span>)</span> =&gt; <span class="hljs-keyword">this</span>._result = result;<span class="hljs-comment">// "" </span><font></font>
    ...<font></font>
}</code></pre><br>
<p>       ( <strong>Method Builder</strong>)  <strong>OnCompleted</strong>    <strong>Maybe</strong>      <strong>Nothing</strong>,     :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCompleted</span>(<span class="hljs-params">Action continuation</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">this</span>._continuation = continuation;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._result.HasValue)<font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>.NotifyResult(<span class="hljs-keyword">this</span>._result.Value.IsNothing);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetResult</span>(<span class="hljs-params">T result</span>)
<span class="hljs-comment">//  "method builder"    </span></span><font></font>
{<font></font>
    <span class="hljs-keyword">this</span>._result = MaybeResult.Value(result);
    <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.NotifyResult(<span class="hljs-keyword">this</span>._result.Value.IsNothing);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyResult</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> isNothing</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">this</span>.IsCompleted = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (isNothing)<font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>._parent.Exit();<span class="hljs-comment">//   </span><font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        <span class="hljs-keyword">this</span>._continuation?.Invoke();<font></font>
    }<font></font>
}</code></pre><br>
<p>     ‚Äî     <strong>Maybe</strong>     (  ,      <strong>Maybe</strong>).        <strong>await</strong>   <strong>Maybe</strong>,    ,   :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Maybe</span>&lt;T&gt; : <span class="hljs-title">IMaybe</span>, <span class="hljs-title">INotifyCompletion</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> MaybeResult? _result;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetResult</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">this</span>._result.Value.GetValue();<font></font>
}<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> MaybeResult<font></font>
{<font></font>
    ...<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">GetValue</span>(<span class="hljs-params"></span>)</span> 
        =&gt; <span class="hljs-keyword">this</span>.IsNothing ? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Nothing"</span>) : <span class="hljs-keyword">this</span>._value;<font></font>
}</code></pre><br>
<p>   ,      <strong>awaiter</strong>,      <strong>MaybeResult</strong> ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> res = <span class="hljs-keyword">await</span> GetResult().GetMaybeResult();<font></font>
<font></font>
<span class="hljs-keyword">if</span>(res.IsNothing){<font></font>
    ...<font></font>
}<font></font>
<span class="hljs-keyword">else</span>{<font></font>
    res.GetValue();<font></font>
    ...<font></font>
};</code></pre><br>
<p>  .       ,       .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>.</p><br>
<p><strong>   </strong>,           ,       ‚Äî     ,      (  <strong>Maybe</strong>),    !    <strong>finally</strong> (    ¬´    <strong>finally</strong>?¬ª),    <strong>using</strong>     ,      .     ,         ,      (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     </a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ôºâ„Åß„Åô„Åå„ÄÅ„Åì„ÅÆ„ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥„Å´„ÅØÊòé„Çâ„Åã„Å´„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÅÆÂà∂Èôê„Åå„ÅÇ„Çä„Åæ„ÅôÔºà„Ç∑„Éä„É™„Ç™„Å´„Çà„Å£„Å¶„ÅØË®±ÂÆπ„Åß„Åç„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ„ÄÇ</font><font style="vertical-align: inherit;">C„Ç≥„É≥„Éë„Ç§„É©„ÅÆÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„Åß„ÅØ„ÄÅÂà•„ÅÆËß£Ê±∫Á≠ñ„ÅØË¶ãÂΩì„Åü„Çä„Åæ„Åõ„Çì„Åå„ÄÅÂ∞ÜÊù•ÁöÑ„Å´„ÅØ„Åì„Çå„Åå„ÅÑ„Å§„ÅãÂ§â„Çè„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Åü„Å†„Åó„ÄÅ„Åì„Çå„Çâ„ÅÆÂà∂Èôê„ÅØ„ÄÅ„Åì„ÅÆË®ò‰∫ã„ÅßË™¨Êòé„Åô„Çã„Åô„Åπ„Å¶„ÅÆÊâãÊ≥ï„ÅåÂÆåÂÖ®„Å´ÂΩπ„Å´Á´ã„Åü„Å™„ÅÑ„Åì„Å®„ÇíÊÑèÂë≥„Åô„Çã„ÇÇ„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„Çπ„É¨„ÉÉ„Éâ„ÅÆÂ§âÊõ¥„ÇíÂøÖË¶Å„Å®„Åó„Å™„ÅÑ‰ªñ„ÅÆ„É¢„Éä„Éâ„ÄÅ„Åü„Å®„Åà„Å∞„Äå„É™„Éº„ÉÄ„Éº„Äç„ÇíÂÆüË£Ö„Åô„Çã„Åü„ÇÅ„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ</font><font style="vertical-align: inherit;">„Åì„ÅÆ„Äå„É™„Éº„ÉÄ„Éº„Äç„É¢„Éä„Éâ„ÇíÂÆüË£Ö„Åô„Çã„Åü„ÇÅ„Å´„Å©„ÅÆ„Çà„ÅÜ„Å´</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÈùûÂêåÊúü/ÂæÖ„Å£„Å¶</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„ÄÅÁßÅ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ê¨°„ÅÆË®ò‰∫ã„Åß</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„ÄÇ</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468005/index.html">Ê†ÑÂÖâ„ÅÆ„Çµ„Éù„Éº„Éà„Å´„Å§„ÅÑ„Å¶‰∏ÄË®ÄÔºà9Êúà24Êó•„ÄÅ„É¢„Çπ„ÇØ„ÉØÔºâ</a></li>
<li><a href="../ja468007/index.html">„Åó„Åã„Åó„ÄÅÁßÅ„ÅØÂÜç„Å≥„Åß„Åü„Çâ„ÇÅ„Çí„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÅãÔºüÂìÅË≥™ÊåáÊ®ô„ÇíÂÆüË£Ö„Åô„ÇãÊñπÊ≥ï„Å®ÁêÜÁî±</a></li>
<li><a href="../ja468009/index.html">KII„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆERP„Ç∑„Çπ„ÉÜ„É†„ÅÆËÑÜÂº±ÊÄß</a></li>
<li><a href="../ja468011/index.html">Êû∂Á©∫„ÅÆ„É≠„Éú„ÉÉ„Éà„ÅÆÁâ©Ë™û</a></li>
<li><a href="../ja468013/index.html">Helm„Åß„Ç´„Éä„É™„Ç¢„Éá„Éó„É≠„Ç§„É°„É≥„Éà„ÇíËá™ÂãïÂåñ„Åô„ÇãÁ∞°Âçò„ÅßÂÆâÂÖ®„Å™ÊñπÊ≥ï</a></li>
<li><a href="../ja468019/index.html">NetCore 3„Å®Blazor„Çí‰ΩøÁî®„Åó„ÅüWebAssembly„Åß„ÅÆWeb„Çµ„Ç§„ÉàÈñãÁô∫</a></li>
<li><a href="../ja468021/index.html">PHP„ÄÅ‰∫∫„ÄÖ„Å´„Å®„Å£„Å¶„Å©„Çå„Å†„ÅëÊäΩË±°Âåñ„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åô„ÅãÔºü</a></li>
<li><a href="../ja468023/index.html">Ê†ºÈóò„Ç≤„Éº„É†Shadow Fight 3„ÅÆ‰∫∫Â∑•Áü•ËÉΩ</a></li>
<li><a href="../ja468025/index.html">Zimbra OSE„ÅßSNI„ÇíÊßãÊàê„Åô„ÇãÊñπÊ≥ï</a></li>
<li><a href="../ja468027/index.html">Redd„ÅÆ„Ç≥„Éº„ÉâÊúÄÈÅ©Âåñ„É°„ÇΩ„ÉÉ„Éâ„ÄÇ„Éë„Éº„Éà2Ôºö„Ç≠„É£„ÉÉ„Ç∑„É•‰∏çÂèØ„É°„É¢„É™„Å®„Éë„É©„É¨„É´„Éê„ÇπÊìç‰Ωú</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>