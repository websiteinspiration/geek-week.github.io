<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüíº üö£üèæ ü§π DEVOXX UK. Kubernetes em produ√ß√£o: implanta√ß√£o azul / verde, dimensionamento autom√°tico e automa√ß√£o de implanta√ß√£o. Parte 2 ‚ùÑÔ∏è üö∂üèø ‚úâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Kubernetes √© uma √≥tima ferramenta para executar cont√™ineres do Docker em um ambiente de produ√ß√£o em cluster. No entanto, existem tarefas que o Kuber...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DEVOXX UK. Kubernetes em produ√ß√£o: implanta√ß√£o azul / verde, dimensionamento autom√°tico e automa√ß√£o de implanta√ß√£o. Parte 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504672/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Kubernetes √© uma √≥tima ferramenta para executar cont√™ineres do Docker em um ambiente de produ√ß√£o em cluster. No entanto, existem tarefas que o Kubernetes n√£o consegue resolver. Com implanta√ß√µes frequentes em um ambiente de produ√ß√£o, precisamos de uma implanta√ß√£o azul / verde totalmente automatizada para evitar o tempo de inatividade nesse processo, que tamb√©m requer solicita√ß√µes HTTP externas e upload de SSL. Isso requer integra√ß√£o com um balanceador de carga, como ha-proxy. Outra tarefa √© o dimensionamento semiautom√°tico do pr√≥prio cluster Kubernetes ao trabalhar na nuvem, por exemplo, redu√ß√£o parcial da escala do cluster √† noite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o Kubernetes n√£o tenha esses recursos prontos para uso, ele fornece uma API que pode ser usada para resolver esses problemas. As ferramentas de implanta√ß√£o e escala automatizadas azul / verde do cluster Kubernetes foram desenvolvidas como parte do projeto de c√≥digo aberto Cloud RTI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta transcri√ß√£o de v√≠deo descreve como configurar o Kubernetes junto com outros componentes de c√≥digo-fonte aberto para obter um ambiente pronto para produ√ß√£o que aceita c√≥digo da confirma√ß√£o de altera√ß√£o de confirma√ß√£o do git sem tempo de inatividade na produ√ß√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/4y/jm/cy4yjm9zwmpfpvtfwhwfigavpkw.jpeg"><a name="habracut"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEVOXX UK. Kubernetes em produ√ß√£o: implanta√ß√£o azul / verde, dimensionamento autom√°tico e automa√ß√£o de implanta√ß√£o. Parte 1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Portanto, depois de acessar seus aplicativos do mundo exterior, voc√™ pode come√ßar a configurar completamente a automa√ß√£o, ou seja, lev√°-la ao est√°gio em que pode executar o git commit e garantir que esse commit do git termine em produ√ß√£o. Naturalmente, na implementa√ß√£o dessas etapas, na implementa√ß√£o da implanta√ß√£o, n√£o queremos enfrentar o tempo de inatividade. Portanto, qualquer automa√ß√£o no Kubernetes come√ßa com uma API.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5q/w4/ng/5qw4ngl2hrnecjzk4sfvhhepx_k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Kubernetes n√£o √© uma ferramenta que pode ser usada ‚Äúpronta para uso‚Äù de maneira produtiva. Obviamente, voc√™ pode fazer isso, usar o kubectl e assim por diante, mas a API ainda √© a coisa mais interessante e √∫til sobre esta plataforma. Usando a API como um conjunto de recursos, voc√™ pode acessar quase tudo o que deseja fazer no Kubernetes. O pr√≥prio Kubectl tamb√©m usa a API REST.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© o REST, portanto, voc√™ pode usar quaisquer idiomas e ferramentas para trabalhar com essa API, mas as bibliotecas de usu√°rios facilitar√£o muito sua vida. Minha equipe escreveu duas dessas bibliotecas: uma para Java / OSGi e uma para Go. O segundo n√£o √© usado com frequ√™ncia, mas, de qualquer forma, essas coisas √∫teis est√£o √† sua disposi√ß√£o. Eles s√£o um projeto de c√≥digo aberto parcialmente licenciado. Existem muitas bibliotecas para diferentes idiomas, para que voc√™ possa escolher a mais adequada.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/bj/ey/ejbjeyepppr2tet3aupem789num.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, antes de iniciar a automa√ß√£o de implanta√ß√£o, voc√™ precisa garantir que esse processo n√£o esteja sujeito a nenhum tempo de inatividade. Por exemplo, nossa equipe realiza a implanta√ß√£o da produ√ß√£o no meio do dia, quando as pessoas tiram o m√°ximo proveito de seus aplicativos, por isso √© muito importante evitar atrasos nesse processo. Para evitar o tempo de inatividade, dois m√©todos s√£o usados: implanta√ß√£o azul / verde ou atualiza√ß√£o sem interrup√ß√£o. Neste √∫ltimo caso, se voc√™ tiver 5 r√©plicas do aplicativo em execu√ß√£o, elas ser√£o atualizadas seq√ºencialmente uma ap√≥s a outra. Esse m√©todo funciona muito bem, mas n√£o funciona se voc√™ estiver executando vers√µes diferentes do aplicativo ao mesmo tempo durante o processo de implanta√ß√£o. Nesse caso, voc√™ pode atualizar a interface do usu√°rio enquanto o back-end funcionar√° com a vers√£o antiga e o aplicativo deixar√° de funcionar.Portanto, do ponto de vista da programa√ß√£o, trabalhar nessas condi√ß√µes √© bastante dif√≠cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse √© um dos motivos pelos quais preferimos usar a implanta√ß√£o azul / verde para automatizar a implanta√ß√£o de nossos aplicativos. Com esse m√©todo, voc√™ deve garantir que, em um determinado momento, apenas uma vers√£o do aplicativo esteja ativa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mecanismo de implanta√ß√£o azul / verde √© o seguinte. Obtemos tr√°fego para nossos aplicativos por meio do ha-proxy, que o direciona para a execu√ß√£o de r√©plicas de aplicativos da mesma vers√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando uma nova implanta√ß√£o √© realizada, usamos o Deployer, que √© fornecido com novos componentes, e ele implementa a nova vers√£o. A implanta√ß√£o de uma nova vers√£o de um aplicativo significa que um novo conjunto de r√©plicas est√° "aumentando", ap√≥s o qual essas r√©plicas da nova vers√£o s√£o iniciadas em um novo pod separado. No entanto, o ha-proxy n√£o sabe nada sobre eles e at√© agora n√£o enviou nenhuma carga de trabalho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, antes de tudo, √© necess√°rio verificar a integridade de novas vers√µes do health cheking para garantir que as r√©plicas estejam prontas para atender √† carga.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dx/qk/vd/dxqkvdwkbon86_g0l0plg-dqezu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os componentes de implanta√ß√£o devem oferecer suporte a algum tipo de integridade. Pode ser uma verifica√ß√£o HTTP muito simples com uma chamada quando voc√™ recebe um c√≥digo com status 200 ou uma verifica√ß√£o mais profunda na qual voc√™ verifica a conex√£o de r√©plicas com o banco de dados e outros servi√ßos, a estabilidade das conex√µes do ambiente din√¢mico, se tudo come√ßa e funciona corretamente. Este processo pode ser bastante complicado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/9t/o4/lr9to4uiafxnxpjfbuyzd3ubtgo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que o sistema verificar que todas as r√©plicas atualizadas est√£o operacionais, o Deployer atualizar√° a configura√ß√£o e passar√° a confd correta, que reconfigurar√° o ha-proxy. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/q1/s7/kwq1s7fkzffaby-ajt6jyrg2vra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Somente depois disso o tr√°fego ser√° direcionado para o under com r√©plicas da nova vers√£o, e a antiga desaparecer√°.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/q5/c6/waq5c6mmixf0j3twtrhetjjdvx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este mecanismo n√£o √© um recurso do Kubernetes. O conceito de implanta√ß√£o azul / verde existe h√° algum tempo e sempre usou um balanceador de carga. Primeiro, voc√™ direciona todo o tr√°fego para a vers√£o antiga do aplicativo e, ap√≥s a atualiza√ß√£o, transfere-o completamente para a nova vers√£o. Este princ√≠pio √© usado n√£o apenas no Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, apresentarei um novo componente de implanta√ß√£o - o Deployer, que executa uma verifica√ß√£o de integridade, reconfigura os proxies e assim por diante. Este √© um conceito que n√£o se aplica ao mundo exterior e existe dentro do Kubernetes. Mostrarei como voc√™ pode criar seu pr√≥prio conceito de Deployer usando ferramentas de c√≥digo aberto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a primeira coisa que o Deployer faz √© criar um controlador de replica√ß√£o RC usando a API Kubernetes. Essa API cria pods e servi√ßos para implanta√ß√£o adicional, ou seja, cria um cluster completamente novo para nossos aplicativos. Depois que o RC verificar que as r√©plicas foram iniciadas, ele verificar√° sua verifica√ß√£o de integridade. Para fazer isso, o Deployer usa o comando GET / health. Ele lan√ßa os componentes de verifica√ß√£o correspondentes e verifica todos os elementos que garantem a opera√ß√£o do cluster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/lr/8u/kmlr8uloqusoeejhd-7dquyzu7q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que todos os pods relataram sua "integridade", o Deployer cria um novo item de configura√ß√£o - o armazenamento distribu√≠do etcd, usado no Kubernetes, inclusive para armazenar a configura√ß√£o do balanceador de carga. N√≥s escrevemos dados no etcd, e uma pequena ferramenta, confd, monitora o etcd para novos dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ele encontrar alguma altera√ß√£o na configura√ß√£o inicial, ele gera um novo arquivo de configura√ß√µes e o passa para o ha-proxy. Nesse caso, o ha-proxy √© reinicializado sem perder nenhuma conex√£o e soluciona a carga com novos servi√ßos que fornecem a nova vers√£o de nossos aplicativos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h2/1k/os/h21kosweevmblkultqa8kspeuri.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, apesar da abund√¢ncia de componentes, n√£o h√° nada complicado. </font><font style="vertical-align: inherit;">Voc√™ s√≥ precisa prestar mais aten√ß√£o √† API e etcd. </font><font style="vertical-align: inherit;">Quero falar sobre o implantador de c√≥digo aberto que n√≥s mesmos usamos - este √© o Amdatu Kubernetes Deployer. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ir/oj/vt/irojvt6tjy6vgckfsizgnycysdm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma ferramenta de orquestra√ß√£o de implanta√ß√£o do Kubernetes com os seguintes recursos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implanta√ß√£o azul / verde</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurando um balanceador de carga externo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciamento do descritor de implanta√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciamento de implanta√ß√£o real</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifica√ß√µes de integridade durante a implanta√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementa√ß√£o de vari√°veis ‚Äã‚Äãde ambiente em pods.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criado na parte superior da API Kubernetes, este Deployer fornece uma API REST para gerenciar descritores e implanta√ß√µes, al√©m de uma API Websocket para logs de fluxo durante a implanta√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele coloca os dados de configura√ß√£o do balanceador de carga no etcd, para que voc√™ n√£o possa usar o ha-proxy com suporte "pronto para uso", mas √© f√°cil usar seu pr√≥prio arquivo de configura√ß√£o do balanceador. O Amdatu Deployer √© escrito em Go, assim como o pr√≥prio Kubernetes, e licenciado pelo Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de usar esta vers√£o do implementador, usei o seguinte descritor de implementa√ß√£o, que especifica os par√¢metros necess√°rios.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/fr/ht/_pfrhtrtusrz0ua6480jo3acqvo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos par√¢metros importantes desse c√≥digo √© ativar o sinalizador "useHealthCheck". Precisamos indicar que uma verifica√ß√£o de integridade √© necess√°ria durante o processo de implanta√ß√£o. Esta op√ß√£o pode ser desativada quando a implanta√ß√£o usa cont√™ineres de terceiros que n√£o precisam ser verificados. Este descritor tamb√©m indica o n√∫mero de r√©plicas e o URL de front-end que o ha-proxy precisa. No final, est√° o sinalizador de especifica√ß√£o para o pod podspec, que chama o Kubernetes para obter informa√ß√µes sobre configura√ß√£o de porta, imagem, etc. Este √© um descritor bastante simples no formato JSON.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra ferramenta que faz parte do projeto de c√≥digo aberto Amdatu √© o Deploymentctl. Ele possui uma interface de usu√°rio para configurar a implanta√ß√£o, armazena o hist√≥rico de implanta√ß√£o e cont√©m webhooks para retornos de chamada de usu√°rios e desenvolvedores de terceiros. Voc√™ n√£o pode usar a interface do usu√°rio, pois o pr√≥prio Amdatu Deployer √© uma API REST, mas essa interface pode facilitar a implanta√ß√£o sem envolver nenhuma API. O Deploymentctl est√° escrito em OSGi / Vertx usando o Angular 2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, demonstrarei o acima na tela usando uma grava√ß√£o pr√©-criada, para que voc√™ n√£o precise esperar. Vamos implantar um aplicativo simples no Go. N√£o se preocupe, se voc√™ n√£o encontrou o Go antes, este √© um aplicativo muito simples, portanto voc√™ deve entender tudo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/rq/ih/adrqihjjsirswywycn8zcm_ypsy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, criamos um servidor HTTP que responde apenas a / health, para que este aplicativo verifique apenas a verifica√ß√£o de sa√∫de e nada mais. Se a verifica√ß√£o for aprovada, a estrutura JSON mostrada abaixo ser√° chamada. Ele cont√©m a vers√£o do aplicativo que ser√° implantada pelo implementador, a mensagem que voc√™ v√™ na parte superior do arquivo e o tipo de dados l√≥gicos booleanos - independentemente de nosso aplicativo estar funcionando ou n√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu trapacei um pouco com a √∫ltima linha, porque coloquei um valor booleano fixo na parte superior do arquivo, que no futuro me ajudar√° a implantar at√© mesmo um aplicativo "n√£o √≠ntegro". N√≥s vamos lidar com isso mais tarde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o vamos come√ßar. Primeiro, verificamos quaisquer pods em execu√ß√£o usando o comando ~ kubectl get pods e, se n√£o houver resposta do URL do front-end, garantimos que nenhuma implanta√ß√£o esteja sendo executada no momento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/vs/kx/qavskxpsjbdy93vis6wd4xp6tas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, na tela, voc√™ v√™ a interface Deploymentctl que mencionei, na qual os par√¢metros de implanta√ß√£o s√£o definidos: namespace, nome do aplicativo, vers√£o de implanta√ß√£o, n√∫mero de r√©plicas, URL de front-end, nome do cont√™iner, imagem, limites de recursos, n√∫mero da porta para verifica√ß√£o de integridade etc. . Os limites de recursos s√£o muito importantes, pois permitem que voc√™ use a quantidade m√°xima poss√≠vel de "ferro". Voc√™ tamb√©m pode ver o log de implanta√ß√£o do log de implanta√ß√£o aqui.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/fk/wb/g_fkwbqrgrbuaii4xmoqhmds3lu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ repetir o comando ~ kubectl get pods agora, poder√° ver que o sistema "congela" por 20 segundos, durante os quais a reconfigura√ß√£o do ha-proxy ocorre. Depois disso, ele inicia em baixo e nossa r√©plica pode ser vista no log de implanta√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/eb/kb/vmebkbw-zpzs2yjjex70jyiz2gg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recortei uma espera de 20 segundos no v√≠deo e agora voc√™ v√™ na tela que a primeira vers√£o do aplicativo foi implantada. Tudo isso foi feito apenas com a ajuda da interface do usu√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/nw/dq/btnwdq4bpxvs3xloqvdfo01nwla.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos tentar a segunda vers√£o. Para fazer isso, altero a mensagem do aplicativo com "Ol√°, Kubernetes!" para ‚ÄúOl√°, Deployer!‚Äù, o sistema cria essa imagem e a coloca no registro do Docker, ap√≥s o qual simplesmente clicamos no bot√£o ‚ÄúDeploy‚Äù na janela Deploymentctl novamente. Nesse caso, o log de implanta√ß√£o √© iniciado automaticamente da mesma maneira que quando a primeira vers√£o do aplicativo foi implantada.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/fb/hx/7ffbhx4jbq_bwxyxskyfbhqg0cy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O comando ~ kubectl get pods mostra que 2 vers√µes do aplicativo est√£o em execu√ß√£o no momento, mas o front-end mostra que ainda estamos executando a vers√£o 1. O </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/xz/xg/guxzxgf4t6g8xxruexeuptcebze.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
balanceador de carga aguarda a </font><font style="vertical-align: inherit;">execu√ß√£o </font><font style="vertical-align: inherit;">da verifica√ß√£o de integridade e redireciona o tr√°fego para a nova vers√£o. Ap√≥s 20 segundos, passamos para o curl e vemos que agora implantamos a vers√£o 2 do aplicativo e a primeira √© removida. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cq/jp/0k/cqjp0kwmkhlufezt-hzs-80fezq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi a implanta√ß√£o de um aplicativo "saud√°vel" - saud√°vel -. Vamos ver o que acontece se, para a nova vers√£o do aplicativo, alterar o valor do par√¢metro Healthy de true para false, ou seja, tentarei implantar um aplicativo n√£o √≠ntegro que n√£o passou na verifica√ß√£o de integridade. Isso pode acontecer se, no est√°gio de desenvolvimento, alguns erros de configura√ß√£o foram cometidos no aplicativo e eles entraram em produ√ß√£o neste formul√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, a implanta√ß√£o segue todas as etapas acima e o ~ kubectl get pods mostra que os dois est√£o em execu√ß√£o. Mas, diferentemente da implanta√ß√£o anterior, o log mostra o estado do tempo limite. Ou seja, devido ao fato da verifica√ß√£o de integridade n√£o ter passado, a nova vers√£o do aplicativo n√£o pode ser implantada. Como resultado, voc√™ v√™ que o sistema voltou a usar a vers√£o antiga do aplicativo e a nova vers√£o foi simplesmente exclu√≠da.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/iv/qz/kqivqzsf3ghxznqksadtfobhzfm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O bom disso √© que, mesmo que voc√™ tenha um grande n√∫mero de solicita√ß√µes simult√¢neas no aplicativo, elas nem perceber√£o o tempo de inatividade durante a implementa√ß√£o do procedimento de implanta√ß√£o. Se voc√™ testar esse aplicativo usando a estrutura Gatling, que envia o n√∫mero m√°ximo poss√≠vel de solicita√ß√µes, nenhuma delas ser√° descartada. Isso significa que nossos usu√°rios nem notar√£o atualiza√ß√µes de vers√£o em tempo real. Se falhar, o trabalho continuar√° na vers√£o antiga; se for bem-sucedido, os usu√°rios mudar√£o para a nova vers√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° apenas uma coisa que pode levar √† falha - se a verifica√ß√£o de integridade foi bem-sucedida e o aplicativo travou assim que recebeu a carga de trabalho, ou seja, o colapso ocorrer√° somente ap√≥s a conclus√£o da implanta√ß√£o. Nesse caso, voc√™ ter√° que reverter manualmente para a vers√£o antiga. Ent√£o, vimos como usar o Kubernetes com suas ferramentas de c√≥digo aberto. O processo de implanta√ß√£o ser√° muito mais simples se voc√™ incorporar essas ferramentas nos pipelines de cria√ß√£o / implanta√ß√£o de pipelines de cria√ß√£o / implanta√ß√£o. Ao mesmo tempo, para iniciar a implanta√ß√£o, voc√™ pode usar a interface do usu√°rio e automatizar totalmente esse processo, aplicando, por exemplo, o compromisso de dominar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/4w/s6/xp4ws6tpk0katzykjamtvd1tuz8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso servidor de compila√ß√£o do Build Server criar√° uma imagem do Docker, colar√° no Docker Hub ou em qualquer outro registro que voc√™ usar. O hub do Docker oferece suporte ao webhook, para que possamos iniciar a implanta√ß√£o remota pelo Deployer, como mostrado acima. Assim, voc√™ pode automatizar totalmente a implanta√ß√£o do aplicativo na produ√ß√£o potencial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos para o pr√≥ximo t√≥pico - dimensionar o cluster Kubernetes. Percebo que o comando kubectl √© um comando de dimensionamento. Com a ajuda de outro, voc√™ pode aumentar facilmente o n√∫mero de r√©plicas em nosso cluster. No entanto, na pr√°tica, geralmente queremos aumentar o n√∫mero de n√≥s, n√£o n√≥s.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/za/t9/ghzat9sqpdai1jdgg3wabhrfeka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, durante o hor√°rio de trabalho, pode ser necess√°rio aumentar e, √† noite, reduzir o custo dos servi√ßos da Amazon, diminuir o n√∫mero de inst√¢ncias em execu√ß√£o do aplicativo. Isso n√£o significa que apenas o n√∫mero de pods ser√° escalado o suficiente, porque mesmo se um dos n√≥s n√£o estiver ocupado, voc√™ ainda precisar√° pagar pela Amazon. Ou seja, junto com o dimensionamento das lareiras, √© necess√°rio dimensionar o n√∫mero de m√°quinas usadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso pode ser complicado porque, independentemente de usarmos a Amazon ou outro servi√ßo em nuvem, o Kubernetes n√£o sabe nada sobre o n√∫mero de m√°quinas usadas. Falta uma ferramenta que permita dimensionar o sistema no n√≠vel dos n√≥s.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h8/6d/js/h86djs8fjx9qwpqos9lwpoknxno.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, teremos que cuidar dos n√≥s e dos pods. Podemos escalar facilmente o lan√ßamento de novos n√≥s usando a API da AWS e as m√°quinas de grupos de dimensionamento para configurar o n√∫mero de n√≥s de trabalho do Kubernetes. Voc√™ tamb√©m pode usar cloud-init ou um script semelhante para registrar n√≥s em um cluster Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A nova m√°quina inicia no grupo Dimensionamento, inicia-se como um n√≥, registra-se no registro do assistente e inicia o trabalho. Depois disso, voc√™ pode aumentar o n√∫mero de r√©plicas para uso nos n√≥s resultantes. Reduzir a escala requer mais esfor√ßo, pois voc√™ precisa garantir que essa etapa n√£o leve √† destrui√ß√£o de aplicativos j√° em execu√ß√£o ap√≥s desligar as m√°quinas "desnecess√°rias". Para evitar esse cen√°rio, voc√™ precisa trazer os n√≥s para o status "n√£o program√°vel". Isso significa que o planejador padr√£o ao planejar pods do DaemonSet ignorar√° esses n√≥s. O agendador n√£o excluir√° nada desses servidores, mas tamb√©m n√£o lan√ßar√° novos cont√™ineres l√°. O pr√≥ximo passo √© deslocar o n√≥ de drenagem, ou seja, transferir os lares de trabalho dele para outra m√°quina ou para outros n√≥s com capacidade suficiente para isso.Ap√≥s verificar se n√£o h√° mais cont√™ineres nesses n√≥s, voc√™ pode remov√™-los do Kubernetes. Depois disso, para os Kubernetes, eles simplesmente deixam de existir. Em seguida, voc√™ precisa usar a API da AWS para desativar n√≥s ou m√°quinas desnecess√°rios.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode usar o Amdatu Scalerd, outra ferramenta de dimensionamento de c√≥digo aberto semelhante √† API da AWS. Ele fornece uma CLI para adicionar ou remover n√≥s em um cluster. Seu recurso interessante √© a capacidade de configurar o planejador usando o seguinte arquivo json. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/0b/8z/e1/0b8ze13eeahulvu7j2cbuu2m8fe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo mostrado reduz pela metade a capacidade do cluster √† noite. √â configurado como o n√∫mero de r√©plicas dispon√≠veis e a capacidade desejada do cluster da Amazon. O uso desse agendador reduzir√° automaticamente o n√∫mero de n√≥s √† noite e aumentar√° de manh√£, economizando o custo do uso de n√≥s de um servi√ßo em nuvem como a Amazon. Esse recurso n√£o est√° embutido no Kubernetes, mas o uso do Scalerd permitir√° que voc√™ dimensione essa plataforma como desejar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quero chamar sua aten√ß√£o para o fato de muitas pessoas me dizerem: "Tudo isso √© bom, mas e o meu banco de dados, que geralmente est√° em estado est√°tico?" Como posso executar algo assim em um ambiente din√¢mico como o Kubernetes? Na minha opini√£o, voc√™ n√£o deve fazer isso, n√£o deve tentar organizar a opera√ß√£o do armaz√©m de dados no Kubernetes. Tecnicamente, isso √© poss√≠vel, e existem manuais na Internet sobre esse assunto, mas isso complicar√° seriamente sua vida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, o conceito de armazenamento persistente existe no Kubernetes e voc√™ pode tentar executar data warehouses como Mongo ou MySQL, mas essa √© uma tarefa bastante demorada. Isso se deve ao fato de que os data warehouses n√£o suportam totalmente a intera√ß√£o com um ambiente din√¢mico. A maioria dos bancos de dados exige ajuste significativo, incluindo a configura√ß√£o manual do cluster, n√£o gosta de dimensionamento autom√°tico e outras coisas semelhantes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, n√£o complique sua vida ao tentar iniciar um data warehouse no Kubernetes. Organize seu trabalho da maneira tradicional usando servi√ßos familiares e apenas d√™ ao Kubernetes a oportunidade de us√°-los.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/ae/w4/jtaew4lftz8i845qgy8pa6bculm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final do t√≥pico, quero apresentar a plataforma Cloud RTI baseada no Kubernetes, na qual minha equipe est√° trabalhando. Ele fornece registro centralizado, aplicativos de monitoramento e clusters e possui muitos outros recursos √∫teis para voc√™. Ele usa v√°rias ferramentas de c√≥digo aberto, como o Grafana, para exibir o monitoramento.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oo/uj/mz/ooujmzx3ukdhlcqyxxwqszgelts.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ec/cd/5j/eccd5j4rch3uhdrqey516jdxnva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quest√£o foi levantada, por que usar o balanceador de carga ha-proxy com o Kubernetes. Boa pergunta, porque atualmente existem 2 n√≠veis de balanceamento de carga. Os servi√ßos Kubernetes ainda est√£o localizados em endere√ßos IP virtuais. Voc√™ n√£o pode us√°-los para portas de host externas, porque se a Amazon reiniciar seu host na nuvem, o endere√ßo mudar√°. √â por isso que colocamos os servi√ßos ha-proxy na frente dos servi√ßos - para criar uma estrutura mais est√°tica para intera√ß√£o de tr√°fego cont√≠nua com o Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra boa pergunta √© como posso cuidar da altera√ß√£o do esquema do banco de dados durante a implanta√ß√£o em azul / verde? </font><font style="vertical-align: inherit;">O fato √© que, independentemente do uso do Kubernetes, alterar o esquema do banco de dados √© uma tarefa complexa. </font><font style="vertical-align: inherit;">√â necess√°rio garantir a compatibilidade do antigo e do novo esquema, ap√≥s o qual voc√™ pode atualizar o banco de dados e, em seguida, atualizar os aplicativos. </font><font style="vertical-align: inherit;">Voc√™ pode trocar o banco de dados a quente e depois atualizar os aplicativos. </font><font style="vertical-align: inherit;">Conhe√ßo pessoas que baixaram um cluster de banco de dados completamente novo com um novo esquema. Essa √© uma op√ß√£o se voc√™ tiver um banco de dados sem restri√ß√µes como o Mongo, mas, de qualquer forma, essa n√£o √© uma tarefa f√°cil. </font><font style="vertical-align: inherit;">Se n√£o houver mais perguntas, obrigado por sua aten√ß√£o!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-Ci4vd4rh4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de publicidade :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado por ficar com a gente. Voc√™ gosta dos nossos artigos? Deseja ver materiais mais interessantes? Ajude-nos fazendo um pedido ou recomendando aos seus amigos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS na nuvem para desenvolvedores a partir de US $ 4,99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anal√≥gico exclusivo de servidores de n√≠vel b√°sico que foi inventado por n√≥s para voc√™: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10 GB DDR4 480 GB SSD 1 Gbps de US $ 19 ou como dividir o servidor?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as op√ß√µes est√£o dispon√≠veis com RAID1 e RAID10, at√© 24 n√∫cleos e at√© 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em Amsterd√£?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Somente n√≥s temos </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na Holanda!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de US $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leia sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como criar um pr√©dio de infraestrutura. </font><font style="vertical-align: inherit;">classe c usando servidores Dell R730xd E5-2650 v4 que custam 9.000 euros por um centavo?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504662/index.html">Desenhar m√∫sica: dan√ßa de caix√£o no Pure Data</a></li>
<li><a href="../pt504664/index.html">Adi√ß√£o inteligente de grupos musicais ao Planilhas Google via API VK, Tampermonkey e Telegram bot</a></li>
<li><a href="../pt504666/index.html">DEVOXX UK. Kubernetes em produ√ß√£o: implanta√ß√£o azul / verde, dimensionamento autom√°tico e automa√ß√£o de implanta√ß√£o. Parte 1</a></li>
<li><a href="../pt504668/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel # 346 (25 a 31 de maio)</a></li>
<li><a href="../pt504670/index.html">Exame de Estado Unificado em Ci√™ncia da Computa√ß√£o ou Sofrimento</a></li>
<li><a href="../pt504674/index.html">Base para um grande SPA modular no Laravel + Vue + ElementUI com gerador CRUD</a></li>
<li><a href="../pt504676/index.html">Adicione uma pitada de aleatoriedade ao seu jogo</a></li>
<li><a href="../pt504678/index.html">ITMO Research_ podcast: como abordar a sincroniza√ß√£o do conte√∫do de RA com o show na escala de todo o est√°dio</a></li>
<li><a href="../pt504680/index.html">Vis√£o geral da biblioteca de PNL da SpaL</a></li>
<li><a href="../pt504682/index.html">Nostalgia Post: j2me, Gravity Defied, 64kb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>