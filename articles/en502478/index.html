<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗯️ ㊙️ ✌🏻 We monitor the PostgreSQL database - who is to blame and what to do 📔 👩🏽‍🍳 ⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I already talked about how we “catch” PostgreSQL problems using mass log monitoring on hundreds of servers at the same time. But besides the logs, thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We monitor the PostgreSQL database - who is to blame and what to do</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/502478/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I already talked about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how we “catch” PostgreSQL problems</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using mass log monitoring on hundreds of servers at the same time. But besides the logs, this DBMS also provides us with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">many tools for analyzing its state</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it’s a sin not to use them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
True, if you just look at them from the console, you can very quickly go round without any benefit, because the amount of data available to us exceeds all reasonable limits.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/za/d-/s1zad-d3claa2klkewtgrj8zdaa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, in order for the situation to remain controllable, we </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developed an add-on for Zabbix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that delivers metrics, forms screens and sets up </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uniform monitoring rules</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for all servers and databases on them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today's article is about what conclusions can be drawn by observing in dynamics the various metrics of PostgreSQL server bases, and where the problem may be hidden.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection status</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The very first thing that all the disassemblies on the topic “what happened to the database / it was bad” begins with is monitoring the summary state of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/zv/9k/azzv9kl_xmnaxjdfgsgjkmikr48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the left graph we see all the connections that are waiting for something, on the right - which are something do. </font><font style="vertical-align: inherit;">Depending on the PG version, the connection status is determined by </font></font><code>pg_stat_activity.state/wait_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and / or the text of the request itself. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to look for</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Too </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">little</font></font><code>idle</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - at some point your application may not have enough connections already open to the database, and when you try to open another one, you will find yourself waiting for the process to initialize to serve a new connection.</font></font></li>
<li> <b> <code>idle</code></b>      «»    ,         <code>max_connections</code>.</li>
<li><b> <code>idle in transaction</code></b> —  ,    -  pgbouncer.            .<br>
<br>
        ,  <b>   </b>  ,     <code>idle_in_transaction_session_timeout</code>.</li>
<li><b> <code>wait</code></b> —   - «»  .       —     .<br>
<br>
     ,  <b>  «» </b>  <code>pg_terminate_backend(pid)</code>.</li>
<li><b> <code>active</code></b> ( max-) ,        «».     -     (, « »)      ,   ,    …<br>
<br>
   —       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">«» </a>.</li>
<li><b><code>maintenance</code></b> —    ,     - :<br>
<br>
<pre><code class="plaintext hljs">query ~* E'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In most cases, there will be the number of autovacuum / autoanalyze working at the same time, the harm of which consists only in using server resources for "extraneous" cases. </font><font style="vertical-align: inherit;">If this is critical for you - twist </font></font><code>autovacuum_max_workers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>autovacuum_naptime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completely turn it off - you should not</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the same time begin to grow </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and</font></font><code>maintenance</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is a chance to see if someone has decided to roll out of the DBA or developer code, for example, blocking half the chance of functional applications.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since it’s important for us to remove not only a lot of metrics, but also to do it as efficiently as possible, we try to shoot some of them synchronously within the framework of one request:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection and lock status</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> event_types(wait_event_type) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'lwlock'</span>)<font></font>
  , (<span class="hljs-string">'lock'</span>)<font></font>
  , (<span class="hljs-string">'bufferpin'</span>)<font></font>
  , (<span class="hljs-string">'client'</span>)<font></font>
  , (<span class="hljs-string">'extension'</span>)<font></font>
  , (<span class="hljs-string">'ipc'</span>)<font></font>
  , (<span class="hljs-string">'timeout'</span>)<font></font>
  , (<span class="hljs-string">'io'</span>)<font></font>
)<font></font>
, <span class="hljs-keyword">events</span>(wait_event) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'walwritelock'</span>)<font></font>
  , (<span class="hljs-string">'wal_insert'</span>)<font></font>
  , (<span class="hljs-string">'buffer_content'</span>)<font></font>
  , (<span class="hljs-string">'buffer_io'</span>)<font></font>
  , (<span class="hljs-string">'lock_manager'</span>)<font></font>
  , (<span class="hljs-string">'relation'</span>)<font></font>
  , (<span class="hljs-string">'extend'</span>)<font></font>
  , (<span class="hljs-string">'page'</span>)<font></font>
  , (<span class="hljs-string">'tuple'</span>)<font></font>
  , (<span class="hljs-string">'transactionid'</span>)<font></font>
  , (<span class="hljs-string">'virtualxid'</span>)<font></font>
  , (<span class="hljs-string">'speculative token'</span>)<font></font>
  , (<span class="hljs-string">'object'</span>)<font></font>
  , (<span class="hljs-string">'userlock'</span>)<font></font>
  , (<span class="hljs-string">'advisory'</span>)<font></font>
  , (<span class="hljs-string">'clientread'</span>)<font></font>
  , (<span class="hljs-string">'datafileextend'</span>)<font></font>
  , (<span class="hljs-string">'datafileread'</span>)<font></font>
  , (<span class="hljs-string">'datafilewrite'</span>)<font></font>
  , (<span class="hljs-string">'slruread'</span>)<font></font>
  , (<span class="hljs-string">'slruwrite'</span>)<font></font>
)<font></font>
, states(state) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'running'</span>)<font></font>
  , (<span class="hljs-string">'maintenance'</span>)<font></font>
  , (<span class="hljs-string">'waiting'</span>)<font></font>
  , (<span class="hljs-string">'transaction'</span>)<font></font>
  , (<span class="hljs-string">'idle'</span>)<font></font>
)<font></font>
, stats <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    pid<font></font>
  , datname<font></font>
  , state<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event_type) wait_event_type<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event) wait_event<font></font>
  , <span class="hljs-keyword">query</span>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_stat_activity<font></font>
  <span class="hljs-keyword">WHERE</span><font></font>
    pid &lt;&gt; pg_backend_pid()<font></font>
)<font></font>
, dbs <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    datname<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_database db<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> db.datistemplate<font></font>
)<font></font>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(s.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , states.state<font></font>
  , <span class="hljs-literal">true</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    states<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">query</span> ~* E<span class="hljs-string">'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'maintenance'</span>
          <span class="hljs-keyword">WHEN</span> wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
            wait_event &lt;&gt; <span class="hljs-string">'clientread'</span> <span class="hljs-keyword">AND</span>
            state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'waiting'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'running'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'idle'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'idle'</span>
          <span class="hljs-keyword">WHEN</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>) <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'transaction'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'fastpath function call'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'fastpath'</span>
          <span class="hljs-keyword">ELSE</span>
            <span class="hljs-string">'disabled'</span>
        <span class="hljs-keyword">END</span> state<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) s<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(t.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , event_types.wait_event_type<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    event_types<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event_type<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) t<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(e.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , events.wait_event<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span>
    <span class="hljs-keyword">events</span>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) e;<font></font>
</code></pre></div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locks</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we touched on blocking monitoring in the previous paragraph, it is worth noting that PostgreSQL likes to overlay them right and left: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/jl/vd/nzjlvdmvxaaqxdotpshnyuhydlo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are most interested in two types of them:</font></font><br>
<br>
<ul>
<li><b><code>Exclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - typically occur when locking on a particular record.</font></font></li>
<li><b><code>AccessExclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - when carrying out maintenance operations on the table.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But do not forget that the total </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of locks is not rubber</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both advisory and regular locks are stored in the shared memory area, the size of which is determined by the configuration parameters </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is important that this memory is sufficient, because </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otherwise the server will not be able to issue </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">any</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Thus, the number of recommended locks that a server can issue is usually limited to tens or hundreds of thousands, depending on the server configuration.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typically, this situation arises if your application “flows” and resources are not released: connections to the database, transaction contexts, or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advisory locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, pay attention to the overall dynamics.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transactions per second (TPS)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get information about changes in the context of the current database, you can use the system view </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But if there are many databases on the server, it is convenient to do this immediately for all of them, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connecting to</font></font><code>postgres</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPS &amp; tuples</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
, datname dbname<font></font>
, pg_stat_get_db_tuples_returned(<span class="hljs-keyword">oid</span>) tup_returned<font></font>
, pg_stat_get_db_tuples_fetched(<span class="hljs-keyword">oid</span>) tup_fetched<font></font>
, pg_stat_get_db_tuples_inserted(<span class="hljs-keyword">oid</span>) tup_inserted<font></font>
, pg_stat_get_db_tuples_updated(<span class="hljs-keyword">oid</span>) tup_updated<font></font>
, pg_stat_get_db_tuples_deleted(<span class="hljs-keyword">oid</span>) tup_deleted<font></font>
, pg_stat_get_db_xact_commit(<span class="hljs-keyword">oid</span>) xact_commit<font></font>
, pg_stat_get_db_xact_rollback(<span class="hljs-keyword">oid</span>) xact_rollback
<span class="hljs-keyword">FROM</span><font></font>
  pg_database<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">NOT</span> datistemplate;
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I want to emphasize separately - do not neglect the output of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max-values ​​of</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> metrics! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ls/yn/yt/lsynyt4rkawj8hvp2pcrnvjiozk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this graph, we can clearly see the situation of a sudden peak increase in the number of conducted ( </font></font><b><code>commit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) transactions. </font><font style="vertical-align: inherit;">This is not one-on-one corresponds to the load on the server and transactions can be of varying complexity, but a 4-fold growth clearly shows that the server </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">should have a certain performance reserve in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> order to survive such a peak without problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the rollback ( </font></font><b><code>rollback</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) of the transaction is an occasion to check whether your application is consciously executing </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or if the server automatically does this as a result of an error.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of operations on records</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, pay attention to the records that we subtract from indexes / tables:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/av/sw/dmavswryoevflquj7krtbykqgtw.png"><br>
<br>
<ul>
<li><b><code>tuples.returned</code></b> —   ,   «»   .</li>
<li><b><code>tuples.fetched</code></b> —   ,     « »   <code>Rows Removed by Filter</code>,   «»   .</li>
<li><b><code>tuples.ratio</code></b> — ,    ,  <b>   1</b>,   —  .   ,  ,       ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you observe a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sharp peak</font></font><code>tuples.ratio</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can be sure that you will find some inefficient request from the category described in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article about recipes for their treatment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> next to the log </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, even if </font></font><code>ratio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ideally equal to 1, but the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peak fell on</font></font><code>returned/fetched</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - also do not expect good. Usually this can mean that there is some kind of trouble in the plan, like:</font></font><br>
<br>
<pre><code class="plaintext hljs">Hash Join<font></font>
  - Hash<font></font>
    - Seq Scan on BIG_TABLE<font></font>
  - Index Scan ...</code></pre><br>
<pre><code class="plaintext hljs">Merge Join<font></font>
  - Index Scan on BIG_INDEX<font></font>
  - Index Scan ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we began to check what is being read there, let's see how it happens. </font><font style="vertical-align: inherit;">That is, how much records we read by indexes, and how much as a result </font></font><b><code>Seq Scan</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/3o/xq/7y3oxqadodpa_zgrhyv0nfxzzua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is clear that here any unplanned growth of indicators should cause suspicion. </font><font style="vertical-align: inherit;">For example, if for some reason you need to read a whole plate of 10M records every night, then the appearance of such a peak during the day is a reason for disassembly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As well as any mass-anomalous inserts / updates / deletes:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/85/pn/dl/85pndlf5hstls4os3jwmtsuserc.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using data cache</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand how the mass proofreading of records really worsens the server’s life, let's look at the server’s work with data pages and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ratio</font></font><code>block.read/hit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In an ideal world, the server should not “read” from the disk ( </font></font><code>shared read</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the plan node) absolutely nothing, everything should already be in memory ( </font></font><code>shared hit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), since </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accessing the disk is always slow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In reality, this is not entirely true, and is the reason for a thorough analysis of requests around peak time:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/ue/xl/btuexl-qt3d384qarrm0n6chlr0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Longest Request / Transaction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For MVCC, long-running queries and transactions in busy systems are a performance disaster. </font><font style="vertical-align: inherit;">Details and pictures about this can be read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - how can you still survive in such conditions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a0/jl/ls/a0jllsvlvmsny6hhyq_mjnhnmli.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catching such villains helps us </font></font><code>pg_stat_activity.query_start/xact_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As our experience shows, a visual representation of these metrics is already enough to roughly represent where to "dig" further:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">look for resource leaks in the application</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimize failed requests</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">put more productive hardware</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... or make sure that the load is correctly spaced in time</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502460/index.html">What to expect at the startup arena of Ukraine in 2020?</a></li>
<li><a href="../en502462/index.html">Digital events in Moscow from May 18 to 24</a></li>
<li><a href="../en502464/index.html">Digital events in St. Petersburg from May 18 to 24</a></li>
<li><a href="../en502466/index.html">New RIT ++ in the new conditions</a></li>
<li><a href="../en502472/index.html">Prometheus monitoring of microservice applications. Vitaly Levchenko</a></li>
<li><a href="../en502480/index.html">What is DHCP Snooping and how does it work?</a></li>
<li><a href="../en502486/index.html">The book "Race with the epidemic. Antibiotics against superbugs "</a></li>
<li><a href="../en502490/index.html">Flashing restrictive beliefs. For what and what does it give</a></li>
<li><a href="../en502492/index.html">Innovations in Zextras Suite and Zimbra OSE</a></li>
<li><a href="../en502494/index.html">7 mistakes of one Black Friday and how Magento Cloud works - video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>