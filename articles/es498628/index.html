<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úä üßôüèª üçº C√≥mo construir un acelerador de cohetes para scripts de PowerCLI¬† üìù ‚õ™Ô∏è üÜì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tarde o temprano, cualquier administrador del sistema VMware puede automatizar las tareas de rutina. Todo comienza desde la l√≠nea de comandos, luego v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥mo construir un acelerador de cohetes para scripts de PowerCLI¬†</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/498628/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarde o temprano, cualquier administrador del sistema VMware puede automatizar las tareas de rutina. </font><font style="vertical-align: inherit;">Todo comienza desde la l√≠nea de comandos, luego viene PowerShell o VMware PowerCLI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponga que ha dominado PowerShell un poco m√°s all√° de iniciar ISE y usar cmdlets est√°ndar de m√≥dulos que funcionan con alg√∫n tipo de magia. </font><font style="vertical-align: inherit;">Cuando comience a contar cientos de m√°quinas virtuales, encontrar√° que las secuencias de comandos que ayudaron en escalas peque√±as funcionan notablemente m√°s lentamente en las grandes.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta situaci√≥n, 2 herramientas ayudar√°n:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell Runspaces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : un enfoque que le permite paralelizar la ejecuci√≥n de procesos en subprocesos separados;&nbsp;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get-View</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una funci√≥n b√°sica de PowerCLI, un an√°logo de Get-WMIObject en Windows. </font><font style="vertical-align: inherit;">Este cmdlet no arrastra objetos relacionados con √©l, sino que recibe informaci√≥n en forma de un objeto simple con tipos de datos simples. </font><font style="vertical-align: inherit;">En muchos casos, sale m√°s r√°pido.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, hablar√© brevemente sobre cada herramienta y mostrar√© ejemplos de uso. </font><font style="vertical-align: inherit;">Analizaremos guiones espec√≠ficos y veremos cu√°ndo uno funciona mejor, cuando el segundo. </font><font style="vertical-align: inherit;">¬°Vamos!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/2q/fe/xp2qfe2m-lyc8feedka2nyhc2sq.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primera etapa: espacio de ejecuci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, Runspace est√° dise√±ado para el procesamiento paralelo de tareas fuera del m√≥dulo principal. </font><font style="vertical-align: inherit;">Por supuesto, puede iniciar otro proceso que consumir√° algo de memoria, procesador, etc. Si su script se ejecuta en un par de minutos y gasta un gigabyte de memoria, probablemente no necesitar√° Runspace. </font><font style="vertical-align: inherit;">Pero para guiones en decenas de miles de objetos es necesario.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede comenzar el desarrollo desde aqu√≠:&nbsp; </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicio del uso de espacios de ejecuci√≥n de PowerShell: Parte 1</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que da uso de Runspace:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">velocidad al limitar la lista de comandos ejecutables,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tareas paralelas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la seguridad.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay un ejemplo de Internet cuando Runspace ayuda:</font></font><br>
<blockquote>¬´    ‚Äì   ,     vSphere.  vCenter     ,      .  ,        PowerShell.<br>
 ,     VMware      vCenter          .&nbsp;&nbsp;<br>
  PowerShell runspaces,    ESXi          Runspace     .   PowerShell   ,        ,     ¬ª. <br>
<br>
<i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">How to Show Virtual Machine I/O on an ESXi Dashboard</a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el siguiente caso, Runspace ya no est√° en el negocio:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúEstoy tratando de escribir un script que recolecte muchos datos de la VM y, si es necesario, escriba nuevos datos. </font><font style="vertical-align: inherit;">El problema es que hay muchas m√°quinas virtuales y una m√°quina tarda entre 5 y 8 segundos ".&nbsp;</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuente: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multithreading PowerCLI con RunspacePool</font></font></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View es necesario aqu√≠, pasemos a ello.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segunda etapa: Get-View</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comprender la utilidad de Get-View, recuerde c√≥mo funcionan los cmdlets en general.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se necesitan cmdlets para obtener informaci√≥n convenientemente sin tener que estudiar los libros de referencia de API y reinventar la rueda. Lo que en los viejos tiempos se escrib√≠a en cien o dos l√≠neas de c√≥digo, PowerShell le permite hacer un comando. Para esta conveniencia pagamos velocidad. Dentro de los cmdlets, no hay magia: el mismo gui√≥n, pero de un nivel inferior, escrito por las h√°biles manos de un maestro de la soleada India. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, para comparar con Get-View, tome el cmdlet Get-VM: accede a la m√°quina virtual y devuelve un objeto compuesto, es decir, le agrega otros objetos relacionados: VMHost, Datastore, etc.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View en su lugar no atornilla nada extra en el objeto devuelto. </font><font style="vertical-align: inherit;">Adem√°s, le permite indicar r√≠gidamente exactamente qu√© informaci√≥n necesitamos, lo que facilitar√° el objeto en la salida. </font><font style="vertical-align: inherit;">En Windows Server en general, y en Hyper-V en particular, el cmdlet Get-WMIObject es un an√°logo directo: la idea es exactamente la misma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View es inconveniente en las operaciones de rutina en las funciones de puntos. </font><font style="vertical-align: inherit;">Pero cuando se trata de miles y decenas de miles de objetos, no tiene precio.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lea m√°s en el blog de VMware: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n a Get-View</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora mostrar√© todo en un caso real.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribimos un script para descargar una VM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez mi colega me pidi√≥ que optimizara su gui√≥n. </font><font style="vertical-align: inherit;">La tarea es una rutina normal: busque todas las m√°quinas virtuales con un par√°metro duplicado cloud.uuid (s√≠, esto es posible al clonar una m√°quina virtual en vCloud Director).&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n obvia que viene a la mente:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenga una lista de todas las m√°quinas virtuales.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De alguna manera analizar la lista.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La versi√≥n original era un gui√≥n tan simple:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID1</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vms</span> = <span class="hljs-built_in">Get-VM</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   ,     2 :    Cloud UUID.</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     PS-   VM  UUID</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vm</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vms</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">select</span> VM,UUID<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.VM = <span class="hljs-variable">$vm</span>.name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.UUID = (<span class="hljs-variable">$vm</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> cloud.uuid).Value<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> += <span class="hljs-variable">$table</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span><font></font>
}<font></font>
<span class="hljs-comment">#     </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es extremadamente simple y claro. Est√° escrito en un par de minutos con un descanso para tomar caf√©. Atornille el filtro y listo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero mida el tiempo: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/xb/i-/izxbi-_-xo9odcuouzqan83vd1o.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/kv/xy/fb/kvxyfb7lj5asvvkm3nuebjljcx0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 minutos 47 segundos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuando procesa casi 10k VM. Una ventaja es la falta de filtros y la necesidad de ordenar manualmente el resultado. Obviamente, el script est√° pidiendo optimizaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los Ransepses son los primeros en acudir al rescate cuando necesita obtener m√©tricas de host con vCenter al mismo tiempo o si necesita procesar decenas de miles de objetos. Veamos qu√© dar√° este enfoque. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activamos la primera velocidad: espacios de ejecuci√≥n de PowerShell</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Lo primero que viene a la mente para este script es ejecutar el ciclo no en serie, sino en subprocesos paralelos, recopilar todos los datos en un objeto y filtrarlo.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hay un problema: PowerCLI no nos permitir√° abrir muchas sesiones independientes en vCenter y arrojar√° un error gracioso:</font></font><br>
<br>
<pre><code class="plaintext hljs">You have modified the global:DefaultVIServer and global:DefaultVIServers system variables. This is not allowed. Please reset them to $null and reconnect to the vSphere server.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolverlo, primero debe pasar la informaci√≥n de la sesi√≥n a la secuencia. </font><font style="vertical-align: inherit;">Recordamos que PowerShell funciona con objetos que se pueden pasar como par√°metro a al menos una funci√≥n, al menos a ScriptBlock. </font><font style="vertical-align: inherit;">Pasemos la sesi√≥n como tal objeto sin pasar por $ global: DefaultVIServers (Connect-VIServer con la tecla -NotDefault):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora implementamos multihilo a trav√©s de Runspace Pools.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo es como sigue:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenga una lista de todas las m√°quinas virtuales.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En hilos paralelos obtenemos cloud.uuid.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recopilamos datos de secuencias en un solo objeto.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filtramos el objeto a trav√©s de la agrupaci√≥n por el valor del campo CloudUUID: aquellos en los que el n√∫mero de valores √∫nicos es superior a 1 y existen las m√°quinas virtuales deseadas.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtenemos el script:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-VMCloudUUID</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span> (<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span><font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Global:AllVMs</span> = <span class="hljs-built_in">Get-VM</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># !</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ISS</span> = [<span class="hljs-type">system.management.automation.runspaces.initialsessionstate</span>]::CreateDefault()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span> = [<span class="hljs-type">runspacefactory</span>]::CreateRunspacePool(<span class="hljs-number">1</span>, <span class="hljs-variable">$MaxThreads</span>, <span class="hljs-variable">$ISS</span>, <span class="hljs-variable">$Host</span>)
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.ApartmentState = <span class="hljs-string">"MTA"</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Open()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
<span class="hljs-comment"># ScriptBlock  !)))</span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$scriptblock</span> = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Param</span> (
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$VM</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Data</span> = <span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-variable">$Data</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#  </span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$VM</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$AllVMs</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span> = [<span class="hljs-type">PowerShell</span>]::Create()
<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddScript(<span class="hljs-variable">$scriptblock</span>)
<span class="hljs-comment">#  ,      </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$ConnectionString</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$VM</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span>.RunspacePool = <span class="hljs-variable">$RunspacePool</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Handle</span> = <span class="hljs-variable">$PowershellThread</span>.BeginInvoke()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">Select-Object</span> Handle, Thread, object
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Handle</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$PowershellThread</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Object = <span class="hljs-variable">$VM</span>.ToString()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> += <span class="hljs-variable">$Job</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">While</span> (<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle <span class="hljs-operator">-ne</span> <span class="hljs-variable">$Null</span>}).count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>}).object)"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">If</span> (<span class="hljs-variable">$Remaining</span>.Length <span class="hljs-operator">-gt</span> <span class="hljs-number">60</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-variable">$Remaining</span>.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">60</span>) + <span class="hljs-string">"..."</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">Write-Progress</span> <span class="hljs-literal">-Activity</span> <span class="hljs-string">"Waiting for Jobs - <span class="hljs-variable">$</span>(<span class="hljs-variable">$MaxThreads</span> - <span class="hljs-variable">$</span>(<span class="hljs-variable">$RunspacePool</span>.GetAvailableRunspaces())) of <span class="hljs-variable">$MaxThreads</span> threads running"</span> <span class="hljs-literal">-PercentComplete</span> ((<span class="hljs-variable">$Jobs</span>.count - <span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$False</span>}).count)) / <span class="hljs-variable">$Jobs</span>.Count * <span class="hljs-number">100</span>) <span class="hljs-literal">-Status</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(@(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>})).count) remaining - <span class="hljs-variable">$remaining</span>"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ForEach</span> (<span class="hljs-variable">$Job</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$True</span>})){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.EndInvoke(<span class="hljs-variable">$Job</span>.Handle)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$Null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Null</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Close() | <span class="hljs-built_in">Out-Null</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Dispose() | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID2</span></span><font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span>(<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span> = <span class="hljs-number">50</span>,<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span>)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$Credential</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span> = <span class="hljs-built_in">Get-Credential</span> <span class="hljs-literal">-Message</span> <span class="hljs-string">"Please enter vCenter credentials."</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   Get-VMCloudUUID,    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$AllCloudVMs</span> = <span class="hljs-built_in">Get-VMCloudUUID</span> <span class="hljs-literal">-vCenters</span> <span class="hljs-variable">$vCenters</span> <span class="hljs-literal">-MaxThreads</span> <span class="hljs-variable">$MaxThreads</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span> = <span class="hljs-variable">$AllCloudVMs</span> | <span class="hljs-built_in">Sort-Object</span> Value | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La belleza de este script es que puede usarse en otros casos similares, simplemente reemplazando el ScriptBlock y los par√°metros que se pasar√°n a la secuencia. Explotalo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Medimos el tiempo: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/hr/ji/d_hrjiq58scxnha1wiknf9jd1zw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">55 segundos.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ya mejor, pero a√∫n m√°s r√°pido.&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasamos a la segunda velocidad: GetView</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Descubrimos qu√© est√° mal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero y obvio: el cmdlet Get-VM tarda mucho tiempo en completarse. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segundo: el cmdlet Get-AdvancedOptions se ejecuta a√∫n m√°s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, tratemos con el segundo.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-AdvancedOptions es conveniente en objetos VM individuales, pero muy lento cuando se trabaja con muchos objetos. </font><font style="vertical-align: inherit;">Podemos obtener la misma informaci√≥n del propio objeto de m√°quina virtual (Get-VM). </font><font style="vertical-align: inherit;">Es solo que est√° bien enterrado en el objeto ExtensionData. </font><font style="vertical-align: inherit;">Armados con filtrado, aceleramos el proceso de obtenci√≥n de los datos necesarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con un movimiento de mu√±eca, esto es:</font></font><br>
<br>
<pre><code class="powershell hljs">
VM | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se convierte en esto:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La conclusi√≥n es la misma que Get-AdvancedOptions, pero funciona muchas veces m√°s r√°pido.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora a Get-VM. No se ejecuta r√°pidamente, ya que trata con objetos complejos. Surge una pregunta l√≥gica: ¬øpor qu√© necesitamos informaci√≥n adicional y un monstruoso PSObject en este caso, cuando solo necesitamos el nombre de la VM, su estado y el valor del atributo complicado?&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, el freno frente a Get-AdvancedOptions ha dejado el gui√≥n. Usar Runspace Pools ahora parece excesivo, ya que ya no hay necesidad de paralelizar una tarea lenta en transmisiones con sentadillas al transferir una sesi√≥n. La herramienta es buena, pero no para este caso.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observamos el resultado de ExtensionData: no es m√°s que un objeto Get-View.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Llamemos a la antigua t√©cnica de los maestros de PowerShell: una l√≠nea que usa filtros, g√©neros y agrupaciones. Todo el horror anterior colapsa elegantemente en una l√≠nea y se ejecuta en una sesi√≥n:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$AllVMs</span> = <span class="hljs-built_in">Get-View</span> <span class="hljs-literal">-viewtype</span> VirtualMachine <span class="hljs-literal">-Property</span> Name,Config.ExtraConfig,summary.runtime.powerstate | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}} | <span class="hljs-built_in">Sort-Object</span> CloudUUID | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Medimos el tiempo: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iy/x4/7q/iyx47qcshcsbjbglrcwi_zzceps.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 segundos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para casi 10k objetos con filtrado seg√∫n la condici√≥n deseada. </font><font style="vertical-align: inherit;">¬°Multa! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En lugar de una conclusi√≥n, un</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
resultado aceptable depende directamente de la elecci√≥n de la herramienta. </font><font style="vertical-align: inherit;">A menudo es dif√≠cil decir con certeza qu√© se debe elegir exactamente para lograrlo. </font><font style="vertical-align: inherit;">Cada uno de los m√©todos de aceleraci√≥n de script enumerados es bueno dentro de los l√≠mites de su aplicabilidad. </font><font style="vertical-align: inherit;">Espero que este art√≠culo lo ayude en la dif√≠cil tarea de comprender los conceptos b√°sicos de la automatizaci√≥n de procesos y su optimizaci√≥n en su infraestructura. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El autor agradece a todos los miembros de la comuna por su ayuda y apoyo en la preparaci√≥n del art√≠culo. </font><font style="vertical-align: inherit;">Incluso aquellos con patas. </font><font style="vertical-align: inherit;">E incluso quien no tiene piernas, como una boa constrictora.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498612/index.html">No decida por el dise√±ador la tarea del dise√±ador</a></li>
<li><a href="../es498614/index.html">An√°lisis de una serie de videos promocionales para el juego Spin Voyage</a></li>
<li><a href="../es498618/index.html">Android en un controlador industrial</a></li>
<li><a href="../es498620/index.html">Tocando el mundo: biomec√°nica del receptor de la piel humana</a></li>
<li><a href="../es498624/index.html">[Instrucci√≥n] Creaci√≥n de pruebas de Google (formularios de Google)</a></li>
<li><a href="../es498630/index.html">Simulaci√≥n f√≠sica de cientos de miles de part√≠culas en Unity + DOTS</a></li>
<li><a href="../es498632/index.html">P√©ptido para una hermosa mulata</a></li>
<li><a href="../es498634/index.html">11 preguntas est√∫pidas a un ortopedista y masajista sobre trabajar en una computadora y no solo</a></li>
<li><a href="../es498636/index.html">Sombreador simple para luces puntuales en niebla</a></li>
<li><a href="../es498638/index.html">Arcade 3D en el navegador: c√≥mo creamos el juego en React + Redux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>