<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî´ üêà üöå So sch√ºtzen Sie Prozesse und Kernel-Erweiterungen unter macOS ü§Ø üë©üèæ‚Äçü§ù‚Äçüë©üèº üöø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Heute m√∂chte ich dar√ºber sprechen, wie Sie Prozesse vor Eindringlingen in macOS sch√ºtzen k√∂nnen. Dies ist beispielsweise f√ºr ein Antiviren...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>So sch√ºtzen Sie Prozesse und Kernel-Erweiterungen unter macOS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acronis/blog/497714/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font><font style="vertical-align: inherit;">Heute m√∂chte ich dar√ºber sprechen, wie Sie Prozesse vor Eindringlingen in macOS sch√ºtzen k√∂nnen. </font><font style="vertical-align: inherit;">Dies ist beispielsweise f√ºr ein Antiviren- oder Sicherungssystem n√ºtzlich, insbesondere angesichts der Tatsache, dass es unter macOS verschiedene M√∂glichkeiten gibt, den Prozess abzubrechen. </font><font style="vertical-align: inherit;">Lesen Sie dar√ºber und √ºber Schutzmethoden unter einer Katze.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/403/e5f/065/403e5f065b7426d384f3c71e8cb3c8a5.jpg" alt="Bild"></a><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der klassische Weg, einen Prozess zu beenden</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der bekannte Weg, einen Prozess zu "t√∂ten", besteht darin, ein Signal √ºber einen SIGKILL-Prozess zu senden. </font><font style="vertical-align: inherit;">Durch Bash k√∂nnen Sie den Standard "kill -SIGKILL PID" oder "pkill -9 NAME" zum T√∂ten aufrufen. </font><font style="vertical-align: inherit;">Der Befehl kill ist seit UNIX bekannt und steht nicht nur unter macOS, sondern auch auf anderen UNIX-√§hnlichen Systemen zur Verf√ºgung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie in UNIX-√§hnlichen Systemen k√∂nnen Sie mit macOS alle Signale f√ºr den Prozess abfangen, mit Ausnahme von zwei - SIGKILL und SIGSTOP. </font><font style="vertical-align: inherit;">In diesem Artikel wird das SIGKILL-Signal in erster Linie als Signal betrachtet, das zum Abbruch eines Prozesses f√ºhrt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOS-Besonderheiten</font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter macOS ruft der Kill-Systemaufruf im XNU-Kernel die Psignal-Funktion (SIGKILL, ...) auf. Versuchen wir herauszufinden, welche anderen Benutzeraktionen im Benutzerbereich die psignal-Funktion aufrufen k√∂nnen. Wir eliminieren Aufrufe der psignal-Funktion in den internen Mechanismen des Kernels (obwohl sie m√∂glicherweise nicht trivial sind, lassen wir sie f√ºr einen anderen Artikel :) - Signatur√ºberpr√ºfung, Speicherfehler, Beenden / Beenden der Verarbeitung, Verletzung des Dateischutzes usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir beginnen die √úbersicht mit der Funktion und dem entsprechenden Systemaufruf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminate_with_payload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist ersichtlich, dass es zus√§tzlich zum klassischen Kill-Aufruf einen alternativen Ansatz gibt, der spezifisch f√ºr das MacOS-Betriebssystem ist und in BSD nicht zu finden ist. </font><font style="vertical-align: inherit;">Die Funktionsprinzipien beider Systemaufrufe sind ebenfalls eng. </font><font style="vertical-align: inherit;">Sie sind direkte Aufrufe der Psignal-Kernelfunktion. </font><font style="vertical-align: inherit;">Beachten Sie auch, dass vor dem Beenden eines Prozesses eine "Cansignal" -Pr√ºfung durchgef√ºhrt wird. Ob der Prozess ein Signal an einen anderen Prozess senden kann, l√§sst das System beispielsweise keine Anwendung zum Beenden von Systemprozessen zu.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">terminate_with_payload_internal</span><span class="hljs-params">(struct proc *cur_proc, <span class="hljs-keyword">int</span> target_pid, <span class="hljs-keyword">uint32_t</span> reason_namespace,
				<span class="hljs-keyword">uint64_t</span> reason_code, <span class="hljs-keyword">user_addr_t</span> payload, <span class="hljs-keyword">uint32_t</span> payload_size,
				<span class="hljs-keyword">user_addr_t</span> reason_string, <span class="hljs-keyword">uint64_t</span> reason_flags)</span>
</span>{<font></font>
...<font></font>
	target_proc = proc_find(target_pid);<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (!cansignal(cur_proc, cur_cred, target_proc, SIGKILL)) {<font></font>
		proc_rele(target_proc);<font></font>
		<span class="hljs-keyword">return</span> EPERM;<font></font>
	}<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (target_pid == cur_proc-&gt;p_pid) {
		<span class="hljs-comment">/*
		 * psignal_thread_with_reason() will pend a SIGKILL on the specified thread or
		 * return if the thread and/or task are already terminating. Either way, the
		 * current thread won't return to userspace.
		 */</span><font></font>
		psignal_thread_with_reason(target_proc, current_thread(), SIGKILL, signal_reason);<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		psignal_with_reason(target_proc, SIGKILL, signal_reason);<font></font>
	}<font></font>
...<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launchd</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Standardmethode zum Erstellen von D√§monen beim Systemstart und zum Steuern ihrer Lebensdauer ist das Starten. </font><font style="vertical-align: inherit;">Ich m√∂chte darauf hinweisen, dass der Quellcode f√ºr die alte Version von launchctl vor macOS 10.10 ist. Codebeispiele werden zur Veranschaulichung angegeben. </font><font style="vertical-align: inherit;">Das moderne launchctl sendet launchd-Signale √ºber XPC, die Logik von launchctl wird darauf √ºbertragen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Betrachten wir, wie die Anwendung gestoppt wird. </font><font style="vertical-align: inherit;">Vor dem Senden eines SIGTERM-Signals versuchen sie, die Anwendung mithilfe des Systemaufrufs proc_terminate zu stoppen.</font></font><br>
<br>
<pre><code class="cpp hljs">&lt;launchctl src/core.c&gt;<font></font>
...<font></font>
	error = proc_terminate(j-&gt;p, &amp;sig);<font></font>
	<span class="hljs-keyword">if</span> (error) {<font></font>
		job_log(j, LOG_ERR | LOG_CONSOLE, <span class="hljs-string">"Could not terminate job: %d: %s"</span>, error, strerror(error));<font></font>
		job_log(j, LOG_NOTICE | LOG_CONSOLE, <span class="hljs-string">"Using fallback option to terminate job..."</span>);<font></font>
		error = kill2(j-&gt;p, SIGTERM);<font></font>
		<span class="hljs-keyword">if</span> (error) {<font></font>
			job_log(j, LOG_ERR, <span class="hljs-string">"Could not signal job: %d: %s"</span>, error, strerror(error));<font></font>
		} <font></font>
...<font></font>
&lt;&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter der Haube kann proc_terminate trotz seines Namens nicht nur ein Signal mit SIGTERM senden, sondern auch SIGKILL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indirekte T√∂tung - Ressourcenlimit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein interessanterer Fall ist in einem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anderen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Systemaufruf </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">process_policy</font></a><font style="vertical-align: inherit;"> zu sehen </font><font style="vertical-align: inherit;">. Die Standardverwendung dieses Systemaufrufs sind Anwendungsressourcenbeschr√§nkungen. Beispielsweise gibt es f√ºr den Indexer eine Begrenzung der Prozessorzeit und des Speicherkontingents, sodass das System aufgrund von Datei-Caching-Aktionen nicht wesentlich langsamer wird. Wenn die Anwendung das Ressourcenlimit erreicht hat, wie aus der Funktion proc_apply_resource_actions ersichtlich, wird das SIGKILL-Signal an den Prozess gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obwohl dieser Systemaufruf m√∂glicherweise einen Prozess beenden k√∂nnte, hat das System die Rechte des Prozesses, der den Systemaufruf verursacht hat, nicht angemessen √ºberpr√ºft. In der </font><font style="vertical-align: inherit;">Tat, eine Pr√ºfung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bestanden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber es ist genug , </font><font style="vertical-align: inherit;">um die alternative Flagge PROC_POLICY_ACTION_SET zu umgehen diese Bedingung zu verwenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie also das CPU-Nutzungskontingent durch die Anwendung ‚Äûbegrenzen‚Äú (z. B. nur 1 ns ausf√ºhren lassen), k√∂nnen Sie jeden Prozess im System beenden. </font><font style="vertical-align: inherit;">Die Malware kann also jeden Prozess auf dem System beenden, einschlie√ülich des Antivirenprozesses. </font><font style="vertical-align: inherit;">Interessant ist auch der Effekt, der auftritt, wenn ein Prozess mit pid 1 (launchctl) beendet wird - Kernel-Panik beim Versuch, ein SIGKILL-Signal zu verarbeiten :)</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/91e/fea/a49/91efeaa490ffd57580d2e5f4a59b4988.png" alt="Bild"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie l√∂se ich das Problem?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der einfachste Weg, um zu verhindern, dass ein Prozess abgebrochen wird, besteht darin, den Funktionszeiger in der Systemaufruftabelle zu ersetzen. Leider ist diese Methode aus vielen Gr√ºnden nicht trivial </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Erstens ist das Symbol, das f√ºr die Position von sysent im Speicher verantwortlich ist, nicht nur ein privates Symbol des XNU-Kernels, sondern kann auch nicht in Kernelsymbolen gefunden werden. Sie m√ºssen heuristische Suchmethoden verwenden, z. B. die dynamische Zerlegung einer Funktion und die Suche nach einem Zeiger darin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens h√§ngt die Struktur der Eintr√§ge in der Tabelle von den Flags ab, mit denen der Kernel erstellt wurde. Wenn das Flag CONFIG_REQUIRES_U32_MUNGING deklariert ist, wird die Gr√∂√üe der Struktur ge√§ndert - ein zus√§tzliches Feld </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">sy_arg_munge32</font></a><font style="vertical-align: inherit;"> wird hinzugef√ºgt</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist erforderlich, eine zus√§tzliche √úberpr√ºfung des Flags durchzuf√ºhren, mit dem der Kernel kompiliert wurde. Optional k√∂nnen Zeiger auf Funktionen mit bekannten verglichen werden.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysent</span> {</span>         <span class="hljs-comment">/* system call table */</span>
        <span class="hljs-keyword">sy_call_t</span>       *sy_call;       <span class="hljs-comment">/* implementing function */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> CONFIG_REQUIRES_U32_MUNGING || (__arm__ &amp;&amp; (__BIGGEST_ALIGNMENT__ &gt; 4))</span>
        <span class="hljs-keyword">sy_munge_t</span>      *sy_arg_munge32; <span class="hljs-comment">/* system call arguments munger for 32-bit process */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">int32_t</span>         sy_return_type; <span class="hljs-comment">/* system call return types */</span>
        <span class="hljs-keyword">int16_t</span>         sy_narg;        <span class="hljs-comment">/* number of args */</span>
        <span class="hljs-keyword">uint16_t</span>        sy_arg_bytes;   <span class="hljs-comment">/* Total size of arguments in bytes for
                                         * 32-bit system calls
                                         */</span><font></font>
};<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gl√ºcklicherweise bietet Apple in modernen Versionen von macOS eine neue API f√ºr die Arbeit mit Prozessen. </font><font style="vertical-align: inherit;">Mit der Endpoint Security-API k√∂nnen Clients viele Anforderungen f√ºr andere Prozesse autorisieren. </font><font style="vertical-align: inherit;">Sie k√∂nnen also alle Signale f√ºr Prozesse blockieren, einschlie√ülich des SIGKILL-Signals, indem Sie die oben genannte API verwenden.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bsm/libbsm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;EndpointSecurity/EndpointSecurity.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>{
    <span class="hljs-keyword">es_client_t</span>* cli = <span class="hljs-literal">nullptr</span>;<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> res = es_new_client(&amp;cli, ^(<span class="hljs-keyword">es_client_t</span> * client, <span class="hljs-keyword">const</span> <span class="hljs-keyword">es_message_t</span> * message) {
            <span class="hljs-keyword">switch</span> (message-&gt;event_type) {
                <span class="hljs-keyword">case</span> ES_EVENT_TYPE_AUTH_SIGNAL:<font></font>
                {<font></font>
                    <span class="hljs-keyword">auto</span>&amp; msg = message-&gt;event.signal;
                    <span class="hljs-keyword">auto</span> target = msg.target;
                    <span class="hljs-keyword">auto</span>&amp; token = target-&gt;audit_token;
                    <span class="hljs-keyword">auto</span> pid = audit_token_to_pid(token);
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"signal '%d' sent to pid '%d'\n"</span>, msg.sig, pid);<font></font>
                    es_respond_auth_result(client, message, pid == getpid() ? ES_AUTH_RESULT_DENY : ES_AUTH_RESULT_ALLOW, <span class="hljs-literal">false</span>);<font></font>
                }<font></font>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        });<font></font>
    }<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">es_event_type_t</span> evs[] = { ES_EVENT_TYPE_AUTH_SIGNAL };<font></font>
        es_subscribe(cli, evs, <span class="hljs-keyword">sizeof</span>(evs) / <span class="hljs-keyword">sizeof</span>(*evs));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, getpid());<font></font>
    sleep(<span class="hljs-number">60</span>); <span class="hljs-comment">// could be replaced with other waiting primitive</span><font></font>
<font></font>
    es_unsubscribe_all(cli);<font></font>
    es_delete_client(cli);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ebenso k√∂nnen Sie die MAC-Richtlinie im Kernel registrieren, der eine Signalschutzmethode (Richtlinie proc_check_signal) bereitstellt, die API wird jedoch nicht offiziell unterst√ºtzt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernel-Erweiterungsschutz</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben dem Schutz von Prozessen im System ist auch der Schutz der Kernel-Erweiterung selbst (kext) erforderlich. macOS bietet Entwicklern ein Framework zur bequemen Entwicklung von IOKit-Ger√§tetreibern. IOKit bietet nicht nur Tools f√ºr die Arbeit mit Ger√§ten, sondern auch Treiberstapelmethoden mit Instanzen von C ++ - Klassen. Eine Anwendung im Userspace kann eine registrierte Instanz der Klasse "finden", um eine Kernel-Userspace-Verbindung herzustellen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Anzahl der Klasseninstanzen im System zu ermitteln, ist das Dienstprogramm ioclasscount vorhanden.</font></font><br>
<br>
<pre><code class="cpp hljs">my_kext_ioservice = <span class="hljs-number">1</span>
my_kext_iouserclient = <span class="hljs-number">1</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Kernel-Erweiterung, die sich auf dem Treiberstapel registrieren m√∂chte, muss eine von IOService geerbte Klasse deklarieren, z. B. my_kext_ioservice. Durch das Verbinden von Benutzeranwendungen wird eine neue Instanz der Klasse erstellt, die von IOUserClient erbt, im Beispiel my_kext_iouserclient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Versuch, den Treiber vom System zu entladen (Befehl kextunload), wird die virtuelle Funktion "bool terminate (IOOptionBits options)" aufgerufen. </font><font style="vertical-align: inherit;">Es reicht aus, beim Aufruf der Terminate-Funktion false zur√ºckzugeben, wenn versucht wird, kextunload zu deaktivieren.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Kext::terminate</span><span class="hljs-params">(IOOptionBits options)</span>
</span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!IsUnloadAllowed)<font></font>
  {<font></font>
    <span class="hljs-comment">// Unload is not allowed, returning false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> super::<span class="hljs-built_in">terminate</span>(options);<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das IsUnloadAllowed-Flag kann von IOUserClient beim Booten gesetzt werden. </font><font style="vertical-align: inherit;">Wenn das Laden begrenzt ist, gibt der Befehl kextunload die folgende Ausgabe zur√ºck:</font></font><br>
<br>
<pre><code class="cpp hljs">admin@admins-Mac drivermanager % sudo kextunload ./test.kext<font></font>
Password:<font></font>
(kernel) Can<span class="hljs-number">'</span>t remove kext my.kext.test; services failed to <span class="hljs-built_in">terminate</span> - <span class="hljs-number">0xe00002c7</span>.<font></font>
Failed to unload my.kext.test - (iokit/common) unsupported function.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein √§hnlicher Schutz muss f√ºr IOUserClient durchgef√ºhrt werden. </font><font style="vertical-align: inherit;">Klasseninstanzen k√∂nnen mit der Userspace-Funktion IOKitLib "IOCatalogueTerminate (mach_port_t, Flag uint32_t, Beschreibung io_name_t);" entladen werden. </font><font style="vertical-align: inherit;">Sie k√∂nnen bei einem Aufruf des Befehls "Beenden" false zur√ºckgeben, bis der Benutzerbereich der Anwendung beendet ist, dh die Funktion clientDied wird nicht aufgerufen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dateischutz</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Schutz von Dateien reicht es aus, die Kauth-API zu verwenden, mit der Sie den Zugriff auf Dateien einschr√§nken k√∂nnen. Apple informiert Entwickler √ºber verschiedene Ereignisse im Bereich. Die Operationen KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA und KAUTH_VNODE_DELETE_CHILD sind f√ºr uns wichtig. Der einfachste Weg, den Zugriff auf Dateien einzuschr√§nken, besteht darin, mithilfe der API ‚Äûvn_getpath‚Äú den Pfad zur Datei abzurufen und das Pfadpr√§fix zu vergleichen. Beachten Sie, dass das System nicht den Zugriff auf jede Datei autorisiert, sondern nur auf den Ordner selbst, der umbenannt wurde, um die Umbenennung der Ordnerpfade mit Dateien zu optimieren. Es ist notwendig, den √ºbergeordneten Pfad zu vergleichen und KAUTH_VNODE_DELETE daf√ºr einzuschr√§nken.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6e2/ab5/2fb/6e2ab52fb8c17ea8adfe8b63bcf8f611.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Nachteil dieses Ansatzes kann eine geringe Leistung mit zunehmender Anzahl von Pr√§fixen sein. Damit der Vergleich nicht gleich O (Pr√§fix * L√§nge) ist, wobei Pr√§fix die Anzahl der Pr√§fixe und L√§nge die L√§nge der Zeichenfolge ist, k√∂nnen Sie eine deterministische Finite-State-Machine (DFA) verwenden, die aus Pr√§fixen besteht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úberlegen Sie, wie Sie einen DFA f√ºr diesen Satz von Pr√§fixen erstellen k√∂nnen. Wir initialisieren die Cursor am Anfang jedes Pr√§fixes. Wenn alle Cursor auf dasselbe Zeichen zeigen, erh√∂hen wir jeden Cursor um ein Zeichen und denken daran, dass die L√§nge derselben Zeile um eins gr√∂√üer ist. Wenn sich zwei Cursor mit unterschiedlichen Symbolen befinden, teilen wir die Cursor durch das Symbol, auf das sie zeigen, in Gruppen ein und wiederholen den Algorithmus f√ºr jede Gruppe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im ersten Fall (alle Zeichen unter den Cursorn sind gleich) erhalten wir den DFA-Status, der nur einen √úbergang in derselben Zeile enth√§lt. </font><font style="vertical-align: inherit;">Im zweiten Fall erhalten wir eine √úbergangstabelle der Gr√∂√üe 256 (Anzahl der Zeichen und maximale Anzahl der Gruppen) in den nachfolgenden Zust√§nden, die durch rekursives Aufrufen der Funktion erhalten werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Betrachten Sie ein Beispiel. </font><font style="vertical-align: inherit;">F√ºr eine Reihe von Pr√§fixen ("/ foo / bar / tmp /", "/ var / db / foo /", "/ foo / bar / aba /", "foo / bar / aac /") k√∂nnen Sie den folgenden DFA erhalten. </font><font style="vertical-align: inherit;">Die Abbildung zeigt nur √úberg√§nge, die zu anderen Zust√§nden f√ºhren. Andere √úberg√§nge sind nicht endg√ºltig. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/190/d0f/5ec/190d0f5ec1fdd8c03df23387d83db44a.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Durchlaufen der DKA-Staaten kann es 3 F√§lle geben.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Endzustand wurde erreicht - der Pfad ist gesch√ºtzt, wir beschr√§nken die Operationen KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA und KAUTH_VNODE_DELETE_CHILD</font></font></li>
<li>    ,   ‚Äú‚Äù (  -) ‚Äî   ,   KAUTH_VNODE_DELETE. ,   vnode  ,     ‚Äò/‚Äô,         ‚Äú/foor/bar/t‚Äù,  .</li>
<li>    ,   .       ,   .</li>
</ol><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ziel der entwickelten Sicherheitsl√∂sungen ist es, das Sicherheitsniveau des Benutzers und seiner Daten zu erh√∂hen. Dieses Ziel wird zum einen durch die Entwicklung eines Acronis-Softwareprodukts sichergestellt, das Schwachstellen abdeckt, bei denen das Betriebssystem selbst ‚Äûschwach‚Äú ist. Andererseits sollten wir die Verbesserung der Sicherheitsaspekte, die auf der Betriebssystemseite verbessert werden k√∂nnen, nicht vernachl√§ssigen, zumal das Schlie√üen solcher Schwachstellen unsere eigene Stabilit√§t als Produkt erh√∂ht. Die Sicherheitsanf√§lligkeit wurde vom Apple Product Security Team gemeldet und in macOS 10.14.5 (https://support.apple.com/en-gb/HT210119) behoben.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e27/604/c24/e27604c248d5405276235cf613319754.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All dies ist nur m√∂glich, wenn Ihr Dienstprogramm offiziell im Kernel installiert wurde. </font><font style="vertical-align: inherit;">Das hei√üt, es gibt keine solchen L√ºcken f√ºr externe und unerw√ºnschte Software. </font><font style="vertical-align: inherit;">Wie Sie sehen, m√ºssen Sie jedoch hart arbeiten, um legitime Programme wie Antiviren- und Sicherungssysteme zu sch√ºtzen. </font><font style="vertical-align: inherit;">Jetzt bieten neue Acronis-Produkte f√ºr macOS zus√§tzlichen Schutz vor dem Entladen aus dem System.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de497688/index.html">Wie die Kubernetes Abendschule funktioniert</a></li>
<li><a href="../de497696/index.html">Wie funktioniert Ryuk Ransomware, die Unternehmen angreift?</a></li>
<li><a href="../de497700/index.html">W√∂chentliche Online-Mitaps zu Backing und DevOps, Sicherheit und Robotern ab dem 17. April</a></li>
<li><a href="../de497702/index.html">F√ºnf Trends in der Datenspeicherung, auf die Sie 2020 achten sollten</a></li>
<li><a href="../de497708/index.html">Wir laden Sie zu einer Reihe von Fujitsu-Webinaren im April und Mai ein</a></li>
<li><a href="../de497724/index.html">Vorbereiten eines Servers f√ºr die Ver√∂ffentlichung einer Web-App in Python</a></li>
<li><a href="../de497726/index.html">Skalieren von Android-Tests bei Odnoklassniki</a></li>
<li><a href="../de497728/index.html">Die Gefahren des "Verbrennens" von Chips</a></li>
<li><a href="../de497730/index.html">Praktische BDD: SpecFlow + TFS</a></li>
<li><a href="../de497736/index.html">√úberpr√ºfung von 10 neuen Verbrennungsmotoren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>