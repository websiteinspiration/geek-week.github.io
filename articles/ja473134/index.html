<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☔️ 💬 🏪 FFmpegをWebAssembly（= ffmpeg.js）にコンパイル：パート2-Emscriptenを使用したコンパイル 🧑🏿‍🤝‍🧑🏿 ⏹️ 🤞🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="シリーズの翻訳された部分のリスト：
 

1. 料理
2. Emscriptenを使用したコンパイル（ここにあります）
3. aviをmp4に変換する
 

この部分から始めると、資料はより複雑になります。何が起こっているのか理解していない場合は、読んでいる間、遠慮なくグーグルしてください。
 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FFmpegをWebAssembly（= ffmpeg.js）にコンパイル：パート2-Emscriptenを使用したコンパイル</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473134/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/899/a0b/a50/899a0ba50105cb44cf23fe8cc40b8e42.png" width="640" height="360"></div><br>
<br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリーズの翻訳された部分のリスト：</font></font></p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">料理</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscriptenを使用したコンパイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ここにあります）</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aviをmp4に変換する</font></font></a></li>
</ol><br>
<hr><blockquote><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この部分から始めると、資料はより複雑になります。何が起こっているのか理解していない場合は、読んでいる間、遠慮なくグーグルしてください。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに、設定を使用してライブラリをコンパイルできるように、考えられる問題の解決策を文書化します。</font></font></p></blockquote><br>
<p>    :</p><br>
<ol>
<li>    Emscripten  Docker</li>
<li> <b>emconfigure</b>  <b>emmake</b>&nbsp;</li>
<li>  ,    FFmpeg  Emscripten</li>
</ol><br>
<a name="habracut"></a><hr><br>
<h1>    Emscripten  Docker</h1><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   FFmpeg  gcc         emscripten.</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">trzeci/emscripten</a>  1.38.45:</p><br>
<pre><code class="plaintext hljs">$ docker pull trzeci/emscripten:1.38.45</code></pre><br>
<blockquote><p>     1 ,     .</p></blockquote><br>
<p>      FFmpeg  emscripten    ,        .    emscripten    FFmpeg   <b>/src</b>.</p><br>
<pre><code class="plaintext hljs"># ,      FFmpeg<font></font>
$ docker run -it \<font></font>
  -v $PWD:/src \<font></font>
  trzeci/emscripten:1.38.45 \<font></font>
  /bin/bash</code></pre><br>
<p>   <b>ls --color</b>,   - :</p><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8c3/47c/87c/8c347c87c6b34354a3429ef2f1bc0681.png" width="799" height="143"></div><br>
<h1> <b>emconfigure</b>  <b>emmake</b>.   ,   </h1><br>
<p>  .      <b>./configure --disable-x86asm</b>,  emscripten    <b>emconfigure ./configure --disable-x86asm</b>. (  emconfigure  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)</p><br>
<pre><code class="plaintext hljs">$ emconfigure ./configure --disable-x86asm</code></pre><br>
<p>      ,    <b>emmake make -j4</b> &nbsp;   FFmpeg.js?  , .       <b>emconfigure</b>    gcc  emcc ( g++  em++),    <b>./configure</b>    gcc.</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emconfigure ./configure --disable-x86asm                                                                 <font></font>
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --cflags                            <font></font>
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --libs                               <font></font>
install prefix            /usr/local                                                                                                   <font></font>
source path               .                                                                                                                <font></font>
C compiler                gcc             #    emcc                                                                                             <font></font>
C library                 glibc                                                                                                           <font></font>
ARCH                      x86 (generic)                                                                                                     <font></font>
big-endian                no                                                                                                            <font></font>
runtime cpu detection     yes                                                                                                         <font></font>
standalone assembly       no                                                                                                            <font></font>
x86 assembler             nasm</code></pre><br>
<p>         ,  ,     .  ,   -    :</p><br>
<pre><code class="plaintext hljs">$ ./configure --help</code></pre><br>
<p>  <b>Toolchain options</b>       .</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# ./configure --help<font></font>
Usage: configure [options]<font></font>
Options: [defaults in brackets after descriptions]Help options:<font></font>
...<font></font>
Toolchain options:                                                                                                             <font></font>
...<font></font>
  --nm=NM                  use nm tool NM [nm -g]<font></font>
  --ar=AR                  use archive tool AR [ar]<font></font>
  --as=AS                  use assembler AS []<font></font>
  --ln_s=LN_S              use symbolic link tool LN_S [ln -s -f]<font></font>
  --strip=STRIP            use strip tool STRIP [strip]<font></font>
  --windres=WINDRES        use windows resource compiler WINDRES [windres]<font></font>
  --x86asmexe=EXE          use nasm-compatible assembler EXE [nasm]<font></font>
  --cc=CC                  use C compiler CC [gcc]<font></font>
  --cxx=CXX                use C compiler CXX [g++]<font></font>
  --objcc=OCC              use ObjC compiler OCC [gcc]<font></font>
  --dep-cc=DEPCC           use dependency generator DEPCC [gcc]<font></font>
  --nvcc=NVCC              use Nvidia CUDA compiler NVCC [nvcc]<font></font>
  --ld=LD                  use linker LD []<font></font>
...</code></pre><br>
<p>    emscripten</p><br>
<pre><code class="plaintext hljs">$ emconfigure ./configure \<font></font>
  --disable-x86asm \<font></font>
  --nm="llvm-nm -g" \<font></font>
  --ar=emar \<font></font>
  --cc=emcc \<font></font>
  --cxx=em++ \<font></font>
  --objcc=emcc \<font></font>
  --dep-cc=emcc</code></pre><br>
<p>  <b>./configure</b>   ,      emcc.</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emconfigure ...                                                                                                                                                                        <font></font>
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --cflags                            <font></font>
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --libs                                     <font></font>
install prefix            /usr/local                                                                                                   <font></font>
source path               .                                                                                                         <font></font>
C compiler                emcc         # emcc                                                                                       <font></font>
C library                                                                                                                          <font></font>
ARCH                      x86 (generic)                                                                                                     <font></font>
big-endian                no                                                                                                              <font></font>
runtime cpu detection     yes                                                                                                             <font></font>
standalone assembly       no</code></pre><br>
<p>,   .</p><br>
<pre><code class="plaintext hljs">$ emmake make -j4</code></pre><br>
<p>  …</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emmake make -j4<font></font>
...<font></font>
./libavutil/x86/timer.h:39:24: error: invalid output constraint '=a' in asm<font></font>
                     : "=a" (a), "=d" (d));<font></font>
                       ^</code></pre><br>
<p>  ,   -   asm.  <b>./libavutil/x86/timer.h</b>  ,      x86,    WebAssembly,    .</p><br>
<pre><code class="plaintext hljs">$ emconfigure ./configure \<font></font>
  --disable-x86asm \<font></font>
  --disable-inline-asm \    #   asm<font></font>
  --nm="llvm-nm -g" \<font></font>
  --ar=emar \<font></font>
  --cc=emcc \<font></font>
  --cxx=em++ \<font></font>
  --objcc=emcc \<font></font>
  --dep-cc=emcc</code></pre><br>
<p>  .</p><br>
<pre><code class="plaintext hljs">$ emmake make -j4</code></pre><br>
<p>    </p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emmake make -j4<font></font>
...<font></font>
AR      libavdevice/libavdevice.a<font></font>
AR      libavfilter/libavfilter.a<font></font>
AR      libavformat/libavformat.a<font></font>
AR      libavcodec/libavcodec.a<font></font>
AR      libswresample/libswresample.a<font></font>
AR      libswscale/libswscale.a<font></font>
AR      libavutil/libavutil.a<font></font>
HOSTLD  doc/print_options<font></font>
GENTEXI doc/avoptions_format.texi<font></font>
/bin/sh: 1: doc/print_options: Exec format error<font></font>
doc/Makefile:59: recipe for target 'doc/avoptions_format.texi' failed<font></font>
make: *** [doc/avoptions_format.texi] Error 2<font></font>
make: *** Waiting for unfinished jobs....</code></pre><br>
<p>-    ,     ,     .</p><br>
<pre><code class="plaintext hljs">$ emconfigure ./configure \<font></font>
  --disable-x86asm \<font></font>
  --disable-inline-asm \<font></font>
  --disable-doc \    #   <font></font>
  --nm="llvm-nm -g" \<font></font>
  --ar=emar \<font></font>
  --cc=emcc \<font></font>
  --cxx=em++ \<font></font>
  --objcc=emcc \<font></font>
  --dep-cc=emcc</code></pre><br>
<p> .</p><br>
<pre><code class="plaintext hljs">$ emmake make -j4</code></pre><br>
<p>     strip.</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emmake make -j4<font></font>
...<font></font>
STRIP   ffmpeg<font></font>
STRIP   ffprobe<font></font>
strip:ffmpeg_g: File format not recognized<font></font>
strip:ffprobe_g: File format not recognized<font></font>
Makefile:101: recipe for target 'ffmpeg' failed<font></font>
make: *** [ffmpeg] Error 1<font></font>
make: *** Waiting for unfinished jobs....<font></font>
Makefile:101: recipe for target 'ffprobe' failed<font></font>
make: *** [ffprobe] Error 1</code></pre><br>
<p>       WebAssembly,   .</p><br>
<pre><code class="plaintext hljs">$ emconfigure ./configure \<font></font>
  --disable-x86asm \<font></font>
  --disable-inline-asm \<font></font>
  --disable-doc \<font></font>
  --disable-stripping \    #  strip<font></font>
  --nm="llvm-nm -g" \<font></font>
  --ar=emar \<font></font>
  --cc=emcc \<font></font>
  --cxx=em++ \<font></font>
  --objcc=emcc \<font></font>
  --dep-cc=emcc</code></pre><br>
<p> .</p><br>
<pre><code class="plaintext hljs">$ emmake make -j4</code></pre><br>
<p>-    .        <b>ffmpeg</b>,   ,     js  ( wasm ).   js ,    <b>-o ffmpeg.js </b>  emcc,     :</p><br>
<ol>
<li> <b>Makefile</b>  FFmpeg</li>
<li>  /</li>
</ol><br>
<p>   ,        FFmpeg -   .      <b>ffmpeg</b>   make.    make    (dry-run).</p><br>
<pre><code class="plaintext hljs">$ emmake make -n</code></pre><br>
<p>  .</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emmake make -n<font></font>
...<font></font>
printf "LD\t%s\n" ffmpeg_g; emcc -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample -Wl,--as-needed -Wl,-z,noexecstack -Wl,--warn-common -Wl,-rpath-link=libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample -Qunused-arguments   -o ffmpeg_g fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil  -lm -pthread -lm -lm -pthread -lm -lm -lm -pthread -lm<font></font>
printf "CP\t%s\n" ffmpeg; cp -p ffmpeg_g ffmpeg<font></font>
...</code></pre><br>
<p>  ,       (     ),     <b>ffmpeg_g</b> &nbsp;<b>ffmpeg.js</b>.</p><br>
<pre><code class="plaintext hljs">$ emcc \<font></font>
  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \<font></font>
  -Qunused-arguments \<font></font>
  -o ffmpeg.js fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \<font></font>
  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm -pthread</code></pre><br>
<p>  ,       .</p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# emcc ...<font></font>
shared:ERROR: Memory is not large enough for static data (11794000) plus the stack (5242880), please increase TOTAL_MEMORY (16777216) to at least 17037904</code></pre><br>
<p>  TOTAL_MEMORY     (33554432 Bytes := 32 MB).</p><br>
<pre><code class="plaintext hljs">$ emcc \<font></font>
  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \<font></font>
  -Qunused-arguments \<font></font>
  -o ffmpeg.js fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \<font></font>
  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm -pthread \<font></font>
  -s TOTAL_MEMORY=33554432</code></pre><br>
<p>-   &nbsp; js  wasm </p><br>
<pre><code class="plaintext hljs">root@57ab95def750:/src# ls ffmpeg*   <font></font>
ffmpeg  ffmpeg.js  ffmpeg.js.mem  ffmpeg.wasm  ffmpeg.worker.js  ffmpeg_g</code></pre><br>
<p> <b>test.html</b>   FFmpeg.js&nbsp;</p><br>
<pre><code class="plaintext hljs">&lt;!DOCTYPE html&gt;<font></font>
&lt;html lang="en"&gt;<font></font>
&lt;head&gt;<font></font>
  &lt;meta charset="UTF-8"&gt;<font></font>
  &lt;title&gt;&lt;/title&gt;<font></font>
  &lt;script src="./ffmpeg.js"&gt;&lt;/script&gt;<font></font>
&lt;/head&gt;<font></font>
&lt;body&gt;<font></font>
&lt;/body&gt;<font></font>
&lt;/html&gt;</code></pre><br>
<p>   ( <b>python2 -m SimpleHTTPServer</b>)     (<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:8000/test.html</a></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">)</a>,    Chrome DevTools.</p><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6d/054/b03/b6d054b03a00813a5bfc12c4d41ffa83.png" width="1366" height="490"></div><br>
<p>   , FFmpeg    ,        ffmpeg.js.</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なビルドスクリプトは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このリポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（build-with-docker.shおよびbuild-js.sh）にあります。</font></font></p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473118/index.html">Siemens Digital Industries Softwareが電気システム設計アプローチを変更</a></li>
<li><a href="../ja473120/index.html">開発者はスタートアップに行きたがっています。雇用主に何をすべきか？</a></li>
<li><a href="../ja473124/index.html">ソリューションの評価とバグの発見にマルコフチェーンを使用する方法。Pythonスクリプトを使用</a></li>
<li><a href="../ja473128/index.html">FutureVSNovel-＃X5TechFutureNightで</a></li>
<li><a href="../ja473130/index.html">ビデオプロセッサーの歴史：1976-1995</a></li>
<li><a href="../ja473136/index.html">StarLineドローンプロジェクトの仮想シミュレーション</a></li>
<li><a href="../ja473140/index.html">Habr Weekly＃24 /電話詐欺を行う方法、800k forのロボット、ほとんどロシアのSSD、Habréで作者のコンテスト</a></li>
<li><a href="../ja473144/index.html">4人の "en"またはソビエトノストラダムスを持つ男</a></li>
<li><a href="../ja473154/index.html">フレンドリーなオープンスペースJS：クライアント側のレンダリングとラッパーの作成</a></li>
<li><a href="../ja473156/index.html">実際に知識をテストする方法、修士課程への入学および就職への招待の特典を受ける方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>