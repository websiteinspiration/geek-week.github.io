<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃🏼 ✋🏼 🤟🏻 Lispのような言語で書かれた現代のNESゲーム 🤴🏼 🤱🏼 👃🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="残りは、エミュレーターで実行される無料のROMとして2019年3月にリリースされた、NES 8ビットビデオゲームコンソールの物語アドベンチャーゲームです。それは断続的に2年間ヨウ素ダイナミクスの小さなチームによって作成されました。現時点では、ゲームはハードウェアの実装段階にあります。リサイクルされた...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lispのような言語で書かれた現代のNESゲーム</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467125/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">残りは</font><font style="vertical-align: inherit;">、エミュレーターで実行される無料のROMとして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2019年3月</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にリリースされた、NES 8ビットビデオゲームコンソールの物語アドベンチャーゲームです</font><font style="vertical-align: inherit;">。それは断続的に2年間ヨウ素ダイナミクスの小さなチームによって作成されました。現時点では、ゲームはハードウェアの実装段階にあります。リサイクルされたパーツから限定されたカートリッジセットを作成します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db4/d1a/663/db4d1a6633208845a7e7ce5d670d82ac.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームには6つのレベルがあり、プレーヤーは4方向スクロールカードでいくつかのシーンを歩き、NPCと通信し、手がかりを収集し、彼らの世界を知り、ミニゲームをプレイし、簡単なパズルを解きます。</font><font style="vertical-align: inherit;">私はプロジェクトのチーフエンジニアだったので、チームのビジョンを実現するのに多くの困難に直面しました。</font><font style="vertical-align: inherit;">NES機器の深刻な制限を考えると、そのゲームを作成するのは非常に困難です。言うまでもなく、「何が残っているか」と同じくらいのコンテンツを持つプロジェクトは言うまでもありません。</font><font style="vertical-align: inherit;">この複雑さを隠して管理できるように作成された便利なサブシステムのおかげで、チームとして作業してゲームを完了することができました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/956/a4d/921/956a4d9217a209643bb35b68e25694b5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、ゲームエンジンの個々のパーツの技術的な詳細について説明します。</font><font style="vertical-align: inherit;">他の開発者がそれらを有用または少なくとも好奇心をそそられることを望んでいます。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NES機器</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを開始する前に、使用する機器の仕様について少しお話します。 NESは、1983年にリリースされたゲームコンソールです（日本、1985-アメリカ）。内部には、周波数1.79 MHzの8ビットCPU 6502 [1]があります。コンソールは1秒あたり60フレームを生成するため、フレームごとに約30千のCPUサイクルが割り当てられます。これは、メインのゲームプレイサイクルで発生するすべてを計算するには非常に小さいものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、コンソールには合計2048バイトのRAMがあります（追加のRAMを使用して、10,240バイトに拡張できますが、これは行っていません）。また、一度に32 KBのROMをアドレス指定でき、バンクを切り替えることで拡張できます（Remainsは512 KBのROMを使用します）。バンクの切り替えは、現代のプログラマーが扱っていない複雑なトピック[2]です。つまり、CPUが使用できるアドレス空間は、ROMに含まれているデータよりも少なくなります。つまり、手動で切り替えると、メモリブロック全体にアクセスできなくなります。いくつかの関数を呼び出しましたか？バンク切り替えコマンドを呼び出してバンクを交換するまではありません。これを行わないと、関数が呼び出されたときにプログラムがクラッシュします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、NES向けのゲームを開発する際に最も難しいことは、これらすべてを同時に考慮することです。</font><font style="vertical-align: inherit;">メモリ使用量など、コードの1つの側面を最適化すると、CPUパフォーマンスなど、他の何かに影響を与えることがよくあります。</font><font style="vertical-align: inherit;">コードは効果的であると同時にサポートに便利でなければなりません。</font><font style="vertical-align: inherit;">通常、ゲームはアセンブリ言語でプログラミングされていました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Co2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私たちの場合、そうではありませんでした。代わりに、ゲームとのタンデムが独自の言語を開発したでしょう。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Co2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ラケットスキームに基づいて構築され、アセンブラー6502にコンパイルされたLispに似た言語です。最初、この言語は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dave Griffiths</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって</font><font style="vertical-align: inherit;">What Remainsデモを構築するため</font><font style="vertical-align: inherit;">に作成され</font><font style="vertical-align: inherit;">、プロジェクト全体で使用することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Co2では、必要に応じて組み込みアセンブラコードを記述できますが、一部のタスクを簡略化する高度な機能も備えています。 RAM消費量とアクセス速度の両方の点で効果的なローカル変数を実装します[2]。非常にシンプルなマクロシステムがあり、読み取り可能で効率的なコードを記述できます[3]。最も重要なのは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ホモコニシティのため</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lispは、ソースでのデータの直接表示を大幅に簡素化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自のツールを作成することはゲーム開発ではかなり広まっていますが、プログラミング言語全体を作成することはあまり一般的ではありません。</font><font style="vertical-align: inherit;">しかし、私たちはそれをしました。</font><font style="vertical-align: inherit;">Co2の開発とサポートの複雑さがそれ自体証明されたかどうかはあまり明確ではありませんが、確かに私たちに役立つ利点がありました。</font><font style="vertical-align: inherit;">記事では、Co2の動作については詳しく触れません（これは別の記事に値します）が、その使用は開発プロセスとかなり密接に絡み合っているため、常に触れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のサンプルCo2コードは、淡色表示される前に読み込まれたばかりのシーンの背景を描画します。</font></font><br>
<br>
<pre><code class="lisp hljs"><span class="hljs-comment">; Render the nametable for the scene at the camera position</span>
(<span class="hljs-name">defsub</span> (<span class="hljs-name">create-initial-world</span>)<font></font>
  (<span class="hljs-name">camera-assign-cursor</span>)<font></font>
  (<span class="hljs-name">set!</span> camera-cursor (<span class="hljs-name">+</span> camera-cursor <span class="hljs-number">60</span>))<font></font>
  (<span class="hljs-name">let</span> ((<span class="hljs-name">preserve-camera-v</span>))<font></font>
    (<span class="hljs-name">set!</span> preserve-camera-v camera-v)<font></font>
    (<span class="hljs-name">set!</span> camera-v <span class="hljs-number">0</span>)<font></font>
    (<span class="hljs-name">loop</span> i <span class="hljs-number">0</span> <span class="hljs-number">60</span>
          (<span class="hljs-name">set!</span> delta-v <span class="hljs-number">#xff</span>)<font></font>
          (<span class="hljs-name">update-world-graphics</span>)<font></font>
          (<span class="hljs-name">when</span> render-nt-span-has<font></font>
            (<span class="hljs-name">set!</span> render-nt-span-has #f)<font></font>
            (<span class="hljs-name">apply-render-nt-span-buffer</span>))<font></font>
          (<span class="hljs-name">when</span> render-attr-span-has<font></font>
            (<span class="hljs-name">set!</span> render-attr-span-has #f)<font></font>
            (<span class="hljs-name">apply-render-attr-span-buffer</span>)))<font></font>
    (<span class="hljs-name">set!</span> camera-v preserve-camera-v))<font></font>
  (<span class="hljs-name">camera-assign-cursor</span>))</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンティティシステム</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee6/d87/ad4/ee6d87ad406879dbc9433c61fa4e3a5b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テトリスよりも複雑なリアルタイムゲームは、本質的に「エンティティのシステム」です。これは、さまざまな独立したアクターが同時に行動し、自分の状態に責任を持つことができる機能です。 What Remainsは決してアクティブなゲームではありませんが、複雑な動作をする多くの独立したアクターが存在します。彼らはアニメーション化してレンダリングし、衝突をチェックしてダイアログを引き起こします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装は非常に一般的です。大きな配列にはシーン内のエンティティのリストが含まれ、各レコードにはエンティティ関連のデータとタイプラベルが含まれます。メインのゲームプレイサイクルの更新機能は、すべてのエンティティをバイパスし、それらのタイプに応じて対応する動作を実装します。</font></font><br>
<br>
<pre><code class="lisp hljs"><span class="hljs-comment">; Called once per frame, to update each entity</span>
(<span class="hljs-name">defsub</span> (<span class="hljs-name">update-entities</span>)<font></font>
  (<span class="hljs-name">when</span> (<span class="hljs-name">not</span> entity-npc-num)<font></font>
    (<span class="hljs-name">return</span>))<font></font>
  (<span class="hljs-name">loop</span> k <span class="hljs-number">0</span> entity-npc-num<font></font>
        (<span class="hljs-name">let</span> ((<span class="hljs-name">type</span>))<font></font>
          (<span class="hljs-name">set!</span> type (<span class="hljs-name">peek</span> entity-npc-data (<span class="hljs-name">+</span> k entity-field-type)))<font></font>
          (<span class="hljs-name">when</span> (<span class="hljs-name">not</span> (<span class="hljs-name">eq</span>? type <span class="hljs-number">#xff</span>))<font></font>
            (<span class="hljs-name">update-single-entity</span> k type)))))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンティティデータを保存する方法はより興味深いものです。</font><font style="vertical-align: inherit;">一般に、ゲームには非常に多くの固有のエンティティーがあるため、問題は多数のROMの使用である可能性があります。</font><font style="vertical-align: inherit;">ここでCo2はその力を示し、シーンの各エッセンスを簡潔ですが読みやすい形式で、キーと値のペアのストリームとして提示できます。</font><font style="vertical-align: inherit;">初期位置などのデータに加えて、ほとんどすべてのキーはオプションであり、必要な場合にのみエンティティに宣言できます。</font></font><br>
<br>
<pre><code class="lisp hljs">(<span class="hljs-name">bytes</span> npc-diner-a <span class="hljs-number">172</span> <span class="hljs-number">108</span>
       prop-palette <span class="hljs-number">1</span><font></font>
       prop-hflip<font></font>
       prop-picture picture-smoker-c<font></font>
       prop-animation simple-cycle-animation<font></font>
       prop-anim-limit <span class="hljs-number">6</span>
       prop-head hair-flip-head-tile <span class="hljs-number">2</span><font></font>
       prop-dont-turn-around<font></font>
       prop-dialog-a (<span class="hljs-number">2</span> progress-stage-4 on-my-third my-dietician)<font></font>
       prop-dialog-a (<span class="hljs-number">2</span> progress-stage-3 have-you-tried-the-pasta the-real-deal)<font></font>
       prop-dialog-a (<span class="hljs-number">2</span> progress-diner-is-clean omg-this-cherry-pie<font></font>
                        its-like-a-party)<font></font>
       prop-dialog-a (<span class="hljs-number">2</span> progress-stage-1 cant-taste-food puff-poof)<font></font>
       prop-dialog-b (<span class="hljs-number">1</span> progress-stage-4 tea-party-is-not)<font></font>
       prop-dialog-b (<span class="hljs-number">1</span> progress-stage-3 newspaper-owned-by-dnycorp)<font></font>
       prop-dialog-b (<span class="hljs-number">1</span> progress-stage-2 they-paid-a-pr-guy)<font></font>
       prop-dialog-b (<span class="hljs-number">1</span> progress-stage-1 it-seems-difficult)<font></font>
       prop-customize (<span class="hljs-name">progress-stage-2</span> stop-smoking)
       <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードで</font></font><code>prop-palette</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、エンティティに使用されるカラーパレットを</font></font><code>prop-anim-limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定し、アニメーションのフレーム数を設定し</font></font><code>prop-dont-turn-around</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プレイヤーが反対側から話しかけようとした場合にNPCを回転させません。</font><font style="vertical-align: inherit;">また、プレーヤーがゲームを渡すプロセスでエンティティの動作を変更する条件のフラグのペアを設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この種類のプレゼンテーションは、ROMへの保存には非常に効果的ですが、実行時にアクセスすると非常に遅くなり、ゲームプレイには非効率的です。</font><font style="vertical-align: inherit;">したがって、プレーヤーが新しいシーンに入ると、このシーンのすべてのエンティティがRAMに読み込まれ、初期状態に影響する可能性のあるすべての条件が処理されます。</font><font style="vertical-align: inherit;">ただし、使用可能なRAMより多くのRAMを消費するため、各エンティティの詳細をダウンロードすることはできません。</font><font style="vertical-align: inherit;">エンジンは、各エンティティに最も必要なものだけをロードし、さらにダイアログボックスの処理などの状況では逆参照されるROM内のその完全な構造へのポインタをロードします。</font><font style="vertical-align: inherit;">この特定の妥協案により、十分なレベルのパフォーマンスを提供できました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポータル</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c41/9dd/b90/c419ddb90349fbfb890c935e15bdfb95.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームWhat Remainsにはさまざまな場所があり、路上にはスクロールマップがあり、部屋には多くのシーンが静止しています。プレーヤーを別の場所に移動するには、プレーヤーが出口に到達したことを確認し、新しいシーンをロードして、プレーヤーを目的の場所に配置する必要があります。開発の初期段階では、このような遷移は、「最初の都市」と「カフェ」などの2つの接続されたシーンと、各シーンのドアの場所に関するifステートメントのデータとして独自の方法で説明されていました。シーンを変更した後にプレーヤーを配置する場所を決定するには、プレーヤーがどこからどこに向かっているかを確認し、対応する出口の隣にプレーヤーを配置するだけで済みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、2つの異なる場所で最初の都市に接続する「第2の都市」シーンを埋め始めたとき、そのようなシステムは崩壊し始めました。そのペアは</font></font><code>(_, _)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もはや適切で</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">ない</font><font style="vertical-align: inherit;">ことが突然判明し</font><font style="vertical-align: inherit;">ました。これについて考えた後、ゲームコード内で「ポータル」と呼ばれる接続自体が非常に重要であることがわかりました。これらの変更を説明するために、エンジンが書き直されました。それは私たちを実体のような状況に導きました。ポータルは、キーと値のペアのリストを格納し、シーンの最初にロードできます。ポータルに入るとき、離れるときと同じ位置情報を使用できます。さらに、エンティティの条件と同様に、条件の追加が簡素化されました。ゲームの特定の時点で、ドアを開くまたは閉じるなど、ポータルを変更できます。</font></font><br>
<br>
<pre><code class="lisp hljs"><span class="hljs-comment">; City A</span>
(<span class="hljs-name">bytes</span> city-a-scene <span class="hljs-number">#x50</span> <span class="hljs-number">#x68</span> look-up<font></font>
       portal-customize (<span class="hljs-name">progress-stage-5</span> remove-self)
       <span class="hljs-comment">; to Diner</span>
       diner-scene <span class="hljs-number">#xc0</span> <span class="hljs-number">#xa0</span> look-down<font></font>
       portal-width <span class="hljs-number">#x20</span>
       <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、シネマティックインサートでよく使用される「テレポーテーションポイント」を追加するプロセスも簡素化されました。プレーヤーは、プロットで何が起こっているかに応じて、シーン内で別の場所に移動する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レベル3の最初のテレポーテーションは次のようになります。</font></font><br>
<br>
<pre><code class="lisp hljs"><span class="hljs-comment">; Jenny's home</span>
(<span class="hljs-name">bytes</span> jenny-home-scene <span class="hljs-number">#x60</span> <span class="hljs-number">#xc0</span> look-up<font></font>
       portal-teleport-only jenny-back-at-home-teleport<font></font>
       <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"></font><code>look-up</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このポータルへの「入口」の方向を示す</font><font style="vertical-align: inherit;">
値に注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ポータルを離れるとき、プレイヤーは別の方向に目を向けます。</font><font style="vertical-align: inherit;">この場合、ジェニー（ゲームの主人公）が見下ろしながら家にいます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストブロック</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストブロックのレンダリングは、プロジェクト全体で最も複雑なコードフラグメントの1つであることが判明しました。ファミコンに行くことを余儀なくされたNESのグラフィック制限。まず、NESにはグラフィックデータ用のレイヤーが1つしかありません。つまり、テキストブロック用にスペースを解放するには、背景に対してマップの一部を消去し、テキストブロックを閉じた後でマップを復元する必要があります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b8/7a5/d6f/6b87a5d6f4f44f8eb4fa9cf3b3242392.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、個々のシーンのパレットには、テキストをレンダリングするための黒と白の色が含まれている必要があり、これはアーティストに追加の制限を課します。残りの背景との色の矛盾を回避するには、テキストブロックを16×16グリッドに揃えます[5]。部屋のあるシーンでのテキストブロックのレンダリングは、カメラが移動できる通りよりもはるかに簡単です。この場合、垂直および水平方向にスクロールするグラフィックバッファーを考慮する必要があるためです。最後に、一時停止画面のメッセージはわずかに変更された標準のダイアログボックスです。これは、異なる情報を表示しますが、ほぼ同じコードを使用するためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バグの多いバージョンのコードが無数にある後、私はようやく作業を2つの段階に分割するソリューションを見つけることができました。</font><font style="vertical-align: inherit;">まず、すべての境界ケースの処理コードを含め、テキストブロックを描画する場所と方法を決定するすべての計算が実行されます。</font><font style="vertical-align: inherit;">したがって、これらすべての困難は1つの場所にもたらされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、状態を保持するテキストブロックが1行ずつ描画され、コードが複雑にならないように、最初のステージからの計算が使用されます。</font></font><br>
<br>
<pre><code class="lisp hljs"><span class="hljs-comment">; Called once per frame as the text box is being rendered</span>
(<span class="hljs-name">defsub</span> (<span class="hljs-name">text-box-update</span>)<font></font>
  (<span class="hljs-name">when</span> (<span class="hljs-name">or</span> (<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">0</span>) (<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">#xff</span>))<font></font>
    (<span class="hljs-name">return</span> #f))<font></font>
  (<span class="hljs-name">cond</span>
   [(<span class="hljs-name">in-range</span> tb-text-mode <span class="hljs-number">1</span> <span class="hljs-number">4</span>)<font></font>
      (<span class="hljs-name">if</span> (<span class="hljs-name">not</span> is-paused)
          <span class="hljs-comment">; Draw text box for dialog.</span>
          (<span class="hljs-name">text-box-draw-opening</span> (<span class="hljs-name">-</span> tb-text-mode <span class="hljs-number">1</span>))
          <span class="hljs-comment">; Draw text box for pause.</span>
          (<span class="hljs-name">text-box-draw-pausing</span> (<span class="hljs-name">-</span> tb-text-mode <span class="hljs-number">1</span>)))<font></font>
      (<span class="hljs-name">inc</span> tb-text-mode)]<font></font>
   [(<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">4</span>)
      <span class="hljs-comment">; Remove sprites in the way.</span>
      (<span class="hljs-name">remove-sprites-in-the-way</span>)<font></font>
      (<span class="hljs-name">inc</span> tb-text-mode)]<font></font>
   [(<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">5</span>)<font></font>
      (<span class="hljs-name">if</span> (<span class="hljs-name">not</span> is-paused)
          <span class="hljs-comment">; Display dialog text.</span>
          (<span class="hljs-name">when</span> (<span class="hljs-name">not</span> (<span class="hljs-name">crawl-text-update</span>))<font></font>
            (<span class="hljs-name">inc</span> tb-text-mode)<font></font>
            (<span class="hljs-name">inc</span> tb-text-mode))
          <span class="hljs-comment">; Display paused text.</span>
          (<span class="hljs-name">do</span> (<span class="hljs-name">create-pause-message</span>)<font></font>
              (<span class="hljs-name">inc</span> tb-text-mode)))]<font></font>
   [(<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">6</span>)
      <span class="hljs-comment">; This state is only used when paused. Nothing happens, and the caller</span>
      <span class="hljs-comment">; has to invoke `text-box-try-exiting-pause` to continue.</span><font></font>
      #t]<font></font>
   [(<span class="hljs-name">and</span> (<span class="hljs-name">&gt;=</span> tb-text-mode <span class="hljs-number">7</span>) (<span class="hljs-name">&lt;</span> tb-text-mode <span class="hljs-number">10</span>))
      <span class="hljs-comment">; Erase text box.</span>
      (<span class="hljs-name">if</span> (<span class="hljs-name">is-scene-outside</span> scene-id)<font></font>
          (<span class="hljs-name">text-box-draw-closing</span> (<span class="hljs-name">-</span> tb-text-mode <span class="hljs-number">7</span>))<font></font>
          (<span class="hljs-name">text-box-draw-restoring</span> (<span class="hljs-name">-</span> tb-text-mode <span class="hljs-number">7</span>)))<font></font>
      (<span class="hljs-name">inc</span> tb-text-mode)]<font></font>
   [(<span class="hljs-name">eq</span>? tb-text-mode <span class="hljs-number">10</span>)
      <span class="hljs-comment">; Reset state to return to game.</span>
      (<span class="hljs-name">set!</span> text-displaying #f)<font></font>
      (<span class="hljs-name">set!</span> tb-text-mode <span class="hljs-number">0</span>)])<font></font>
  (<span class="hljs-name">return</span> #t))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lispスタイルに慣れれば、コードは非常に便利に読み取られます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スプライトZレイヤー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、ゲームプレイに特に影響を及ぼさない細かい部分について話しますが、私が誇りに思っている素晴らしいタッチを追加します。 NESには2つのグラフィックコンポーネントしかありません。静的およびグリッドに配置された背景に使用される名前テーブルと、スプライトは任意の場所に配置できる8x8ピクセルのオブジェクトです。プレーヤーのキャラクターやNPCなどの要素は、名前テーブルのグラフィックの上にある場合、通常はスプライトとして作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、NES機器は、名前テーブルの下に完全に配置できるスプライトの一部を指定する機能も提供します。これにより、クールな3D効果を簡単に実現できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c6/4e0/c48/1c64e0c481f82d2b6569aa6326ea00a1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは次のように機能します。現在のシーンに使用されているパレットは、位置0の色を特別な方法で処理します。これは、グローバル背景色です。</font><font style="vertical-align: inherit;">名前テーブルがその上に描画され、Zレイヤーを持つスプライトが他の2つのレイヤーの間に描画されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがこのシーンのパレットです：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23c/2c6/391/23c2c6391ae6301f9b527259250ee0e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、左端の濃い灰色がグローバル背景色として使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レイヤーの効果は次のように機能します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d30/0ae/f89/d300aef890a928421a48d94968a263f9.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のほとんどのゲームでは、これで終わりですが、Wh​​at Remainsはもう一歩前進しています。</font><font style="vertical-align: inherit;">ゲームはジェニーを名前の表の前または下に完全に配置しません-彼女のキャラクターは正しい方法でそれらの間で分割されます。</font><font style="vertical-align: inherit;">ご覧のとおり、スプライトのサイズは8x8ユニットで、キャラクター全体のグラフィックはいくつかのスプライト（アニメーションフレームに応じて3〜6）で構成されています。</font><font style="vertical-align: inherit;">各スプライトは独自のZレイヤーを設定できます。つまり、一部のスプライトは名前テーブルの前にあり、他のスプライトはその後ろにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この効果の例を次に示します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86b/3a3/ae5/86b3a3ae58931ef34d44640d7ff4c449.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この効果を実装するためのアルゴリズムはかなりトリッキーです。</font><font style="vertical-align: inherit;">最初に、プレーヤー全体の衝突データ、特にキャラクター全体が描画される可能性のあるタイルが調べられます。</font><font style="vertical-align: inherit;">この図では、塗りつぶされたタイルは赤い正方形で示され、黄色のタイルはZレイヤーのあるパーツを示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10d/162/38c/10d16238cc137b14b8719479624f7245.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまなヒューリスティックを使用して、これらを組み合わせて「参照ポイント」と4ビットのビットマスクを作成します。</font><font style="vertical-align: inherit;">参照ポイントを基準にした4つの象限は4ビットに対応します。0は、プレーヤーが名前のテーブルの前にいる必要があることを意味し、1はその後ろにあります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccb/3a4/ff9/ccb3a4ff911243e0e771c3bd64e10134.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレーヤーをレンダリングするために個々のスプライトを配置するとき、それらの位置が参照ポイントと比較され、この特定のスプライトのZレイヤーが決定されます。</font><font style="vertical-align: inherit;">それらのいくつかは表層にあり、他は裏層にあります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ee/f36/273/0eef362737679bb6483465264ada9ba4.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいモダンレトロゲームの内部構造のさまざまな側面について簡単に説明しました。</font><font style="vertical-align: inherit;">コードベースにはもっと興味深いものがありますが、ゲームが機能するための重要な部分を概説しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトから学んだ最も重要な教訓は、データ駆動型エンジンから得られるメリットです。</font><font style="vertical-align: inherit;">いくつかのユニークなロジックを数回テーブルとミニインタープリターで置き換えることに成功しました。これのおかげで、コードがよりシンプルで読みやすくなりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はあなたが記事を楽しんだことを望みます！</font></font><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[1]厳密には、NESにはRicoh 2A03と呼ばれる一種のCPU 6502が搭載されていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[2]実際、このプロジェクトは、バンクの切り替え/ ROMの管理が特定のサイズを超えるすべてのNESプロジェクトの主な制限であることを確信しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[3]このため、組み込みシステムのプログラミングで使用される概念である「コンパイル済みスタック」に感謝する必要がありますが、それについての文献はほとんど見つかりませんでした。つまり、プロジェクト呼び出しの完全なグラフを作成し、それをリーフノードからルートに並べ替え、各ノードにそのニーズ+子ノードの最大数に等しいメモリを割り当てる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[4]マクロは開発のかなり遅い段階で追加されましたが、率直に言って、マクロを特別に利用することはできませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[5] NESグラフィックの詳細については</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私のシリーズの記事を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">色の矛盾は、最初の部分で説明されている属性が原因で発生します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467109/index.html">QAがプロジェクトのテスト自動化を整理する方法。1つの実用的な方法</a></li>
<li><a href="../ja467111/index.html">お使いの携帯電話にかかる時間を減らす方法に関する抜本的なヒント</a></li>
<li><a href="../ja467115/index.html">非定型「ls」-Habrエディション</a></li>
<li><a href="../ja467117/index.html">写本は燃えません：紀元前250年まで遡る死海の巻物の寿命の秘密</a></li>
<li><a href="../ja467119/index.html">BadooエンジニアとITエイリアスをプレイする</a></li>
<li><a href="../ja467127/index.html">PostmanとExcelを使用したAPIのテスト</a></li>
<li><a href="../ja467129/index.html">認知矯正2：錯覚と歪みを学ぶ</a></li>
<li><a href="../ja467131/index.html">CLRium＃6：ロックフリーに関するペアレポート、多くの理論と実践的な知識</a></li>
<li><a href="../ja467135/index.html">コンピュータを切り替えるためのUSBペダル</a></li>
<li><a href="../ja467137/index.html">複雑な企業ネットワークでのZextrasチームの信頼できる運用の確保</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>