<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶á üíØ üëäüèΩ JOOQ and his rabbit hole. How to survive without hibernate üë®üèø‚Äçü§ù‚Äçüë®üèΩ üëéüèø ü§¶üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will not drown for JOOQ. I prefer Hibernate and all the Spring Data JPA power behind it. But the article will not be about them. 
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>JOOQ and his rabbit hole. How to survive without hibernate</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488522/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article I will not drown for JOOQ. </font><font style="vertical-align: inherit;">I prefer Hibernate and all the Spring Data JPA power behind it. </font><font style="vertical-align: inherit;">But the article will not be about them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wt/-0/co/wt-0condklmkd6zkb2ag_a46vb4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we use Hibernate and Spring Data JPA, we don‚Äôt need to think about internal processes - know the annotations and write the correct method names in the repository - these two monsters will do the rest for you. </font><font style="vertical-align: inherit;">In the case of JOOQ, unfortunately for many, it will take a little effort and write more than </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findAllByUserId (Long userId)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a JOOQ?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's write a simple SQL query:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> countries c <span class="hljs-keyword">where</span> c.population &gt; <span class="hljs-number">10000000</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can execute this request in the console. </font><font style="vertical-align: inherit;">Okay </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We don‚Äôt feel like in the console. </font><font style="vertical-align: inherit;">We want our application to send this request. </font><font style="vertical-align: inherit;">That it was not a one-time script and that it was validated at least for syntax. </font><font style="vertical-align: inherit;">We do this through Spring Data JPA:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllByPopulationAfter</span><span class="hljs-params">(Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same request is executed as above, but by Spring. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What are the clear advantages of this approach? </font><font style="vertical-align: inherit;">It is performed by a powerful framework; it also validates a request for errors. </font><font style="vertical-align: inherit;">But the query management takes care of the framework. </font><font style="vertical-align: inherit;">And we want to completely manage the request, but at the same time, so that the request is completely validated. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Query</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Query("select c from Country c where c.population &gt; :amount")</span>
<span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllPopulationGreaterThan</span><span class="hljs-params">(<span class="hljs-meta">@Param("amount")</span> Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a trade-off between SQL and DSL is also good. </font><font style="vertical-align: inherit;">But if we do not want to mess with SQL, we will be pleased to see something like:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several libraries are suitable for this: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QueryDSL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speedment</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
About QueryDSL I </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote a</font></font></u></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> couple of years ago. </font><font style="vertical-align: inherit;">I didn‚Äôt dig Speedment, but it seems to be something more than a simple DSL generator, plus I‚Äôll have to learn the methods by which they encrypted SQL query commands. </font><font style="vertical-align: inherit;">In general, today we‚Äôll talk about JOOQ.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOOQ Queries</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, we have already seen one of these queries above:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What else are there? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, a simple get request:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Or insert request:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, everything is clear, nothing more. </font><font style="vertical-align: inherit;">But this is only at first glance. </font><font style="vertical-align: inherit;">Finding out how deep this rabbit hole can take several weeks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But let's start from the beginning.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes it will be maven</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I prefer Gradle. </font><font style="vertical-align: inherit;">But for some reason, JOOQ developers pay less attention to Gradle, offering to go for third-party plugins. </font><font style="vertical-align: inherit;">Okay, the training project will be on Maven. </font><font style="vertical-align: inherit;">But if you, dear reader, rummaged as it should in the depths of the github and are ready to reveal a fully customized project on Gradle - write to me and you will become a co-author of this article. </font><font style="vertical-align: inherit;">The same applies to H2 (the training project will be on PostgreSQL).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why I didn‚Äôt succeed with Gradle and H2</font></font></b><div class="spoiler_text">    ,      Gradle.           jooq-generator .          H2,  ¬´  ¬ª   H2         ,   ,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necessary Maven dependencies:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Spring Starters --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Database --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flywaydb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flyway-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Helpers --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${commons.lang3.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!--Test --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- JOOQ Generator --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-meta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring already has a JOOQ starter that will self-configure the DataSource according to the specified settings from application.yml. </font><font style="vertical-align: inherit;">But for the full work of JOOQ, this is not enough. </font><font style="vertical-align: inherit;">Entities must be generated. </font><font style="vertical-align: inherit;">Yes, yes, we do not write entities, but generate them. </font><font style="vertical-align: inherit;">The so-called table-first approach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The usual structure of the application with a focus on working with the database looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c-/pz/tp/c-pztpdxbkn5kxot-s_08tzlzbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Until the service layer, the data travels through the application in the form of a flat model (DTO). </font><font style="vertical-align: inherit;">Further, when the service needs to work with the database, it converts the DTO into an entity, sends it to the repository, and it already saves it to the database. </font><font style="vertical-align: inherit;">JOOQ developers see everything differently: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/wy/4b/vvwy4bbp1ox57f4j0edmulfe7ni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we can see, JOOQ seriously revised the standard pattern and decided to go their own way. </font><font style="vertical-align: inherit;">The differences are significant:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conversion of DTO into an entity occurs already in the repository. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We do not write an entity as such. </font><font style="vertical-align: inherit;">It is written for us by the JOOQ generator.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Already this is enough to conclude that JOOQ is not so simple. </font><font style="vertical-align: inherit;">A highly customizable generated entity, incomprehensible mapping in DTO and other difficulties will frighten away many. </font><font style="vertical-align: inherit;">But in cases where there is nowhere to go, a focused study of these aspects of JOOQ can seriously carry away and take days, or even weeks. </font><font style="vertical-align: inherit;">I am sure my post will significantly save your time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will cover the following aspects of working with JOOQ:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entity Generation. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing CRUD Queries. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimization of CRUD requests. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And another CRUD request optimization. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping entities using the standard JOOQ library. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and discuss why all this is necessary. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's go.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we write?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our project will have two entities: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Country:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Country</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> GovernmentForm governmentForm;
    <span class="hljs-keyword">private</span> Integer population;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> List&lt;City&gt; cities;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
City:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">City</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long countryId;
    <span class="hljs-keyword">private</span> String name;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One-to-many relationship. </font><font style="vertical-align: inherit;">Country contains many related City. </font><font style="vertical-align: inherit;">City contains countryId. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flyway migration looks like this:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> countries<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>              bigserial primary <span class="hljs-keyword">key</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    government_form <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    population      <span class="hljs-built_in">int</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cities<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>         bigserial primary <span class="hljs-keyword">key</span>,<font></font>
    country_id <span class="hljs-built_in">bigint</span>,
    <span class="hljs-keyword">name</span>       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>)<font></font>
);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with entity generation.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entities, as I said, are generated separately. </font><font style="vertical-align: inherit;">There are two ways to do this.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Through the Maven plugin. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Java code. </font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generating Entities in Maven</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the project builds, Maven starts the generator and generates entities. </font><font style="vertical-align: inherit;">And you can call the generator at any convenient time and generate entities. </font><font style="vertical-align: inherit;">This is required in those moments when, say, the structure of the base has changed. </font><font style="vertical-align: inherit;">The plugin in Maven looks like this:</font></font><br>
<br>
<pre><code class="xml hljs">            <span class="hljs-comment">&lt;!-- JOOQ Generator Plugin --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen-maven<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>generate-sources<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>generate<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">jdbc</span>&gt;</span>  <span class="hljs-comment">&lt;!--    --&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">driver</span>&gt;</span>${db.driver}<span class="hljs-tag">&lt;/<span class="hljs-name">driver</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>${db.url}<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>${db.username}<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>${db.password}<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">jdbc</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">generator</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">database</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>.*<span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span><font></font>
                                flyway_schema_history<font></font>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">inputSchema</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">inputSchema</span>&gt;</span>  <span class="hljs-comment">&lt;!--  --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">database</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">generate</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">records</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">records</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">generate</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--      --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">packageName</span>&gt;</span>ru.xpendence.jooqexample.domain<span class="hljs-tag">&lt;/<span class="hljs-name">packageName</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--  .    target. --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>target/generated-sources/jooq<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">generator</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you did everything correctly, update Maven and among the plugins you will see jooq-codegen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/ch/pv/1nchpvafnxml7qle_dfsq1zsuje.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run it. It will generate entities for you. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/kf/la/cskfla2pzxfkm-vkot_dcggqoia.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are the very entities that you will use to access the database. The first nuisance: they are immutable. That is, they are mutable, but the type change occurs in such a contrived way that this process description will be pulled to a separate article. Therefore, try to think over data types at the stage of table generation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entities look peculiar. Here, for example, is the signature of the CountriesRecord class:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountriesRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UpdatableRecordImpl</span>&lt;<span class="hljs-title">CountriesRecord</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Record4</span>&lt;<span class="hljs-title">Long</span>, <span class="hljs-title">String</span>, <span class="hljs-title">String</span>, <span class="hljs-title">Integer</span>&gt; </span>{
    <span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we can see, CountriesRecord implements Record4, which is typed by 4 types. </font><font style="vertical-align: inherit;">The countries table has 4 columns, therefore Record4. </font><font style="vertical-align: inherit;">There are 3 columns in cities, so Record3. </font><font style="vertical-align: inherit;">Why this was invented, I do not know. </font><font style="vertical-align: inherit;">There are 22 such records in the JOOQ library, Record1 ... Record22. </font><font style="vertical-align: inherit;">From which we can conclude that the capabilities of JOOQ are limited to processing tables with a maximum of 22 columns, but this is not so. </font><font style="vertical-align: inherit;">I have tables with dozens of columns, and JOOQ just immediately implements Record. </font><font style="vertical-align: inherit;">Well, that ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generating JOOQ entities in Java code looks like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterStartupApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ContextRefreshedEvent</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.driver-class-name}")</span>
    <span class="hljs-keyword">private</span> String driver;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.url}")</span>
    <span class="hljs-keyword">private</span> String url;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.username}")</span>
    <span class="hljs-keyword">private</span> String username;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.password}")</span>
    <span class="hljs-keyword">private</span> String password;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.name}")</span>
    <span class="hljs-keyword">private</span> String databaseName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-includes}")</span>
    <span class="hljs-keyword">private</span> String databaseWithIncludes;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-input-schema}")</span>
    <span class="hljs-keyword">private</span> String databaseWithInputSchema;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.package-name}")</span>
    <span class="hljs-keyword">private</span> String targetPackageName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.directory}")</span>
    <span class="hljs-keyword">private</span> String targetDirectory;<font></font>
<font></font>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent contextRefreshedEvent)</span> </span>{
        <span class="hljs-keyword">new</span> GenerationTool().run(configureGenerator());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Configuration <span class="hljs-title">configureGenerator</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Configuration()<font></font>
                .withJdbc(<span class="hljs-keyword">new</span> Jdbc()<font></font>
                        .withDriver(driver)<font></font>
                        .withUrl(url)<font></font>
                        .withUser(username)<font></font>
                        .withPassword(password))<font></font>
                .withGenerator(<span class="hljs-keyword">new</span> Generator()<font></font>
                        .withDatabase(<span class="hljs-keyword">new</span> Database()<font></font>
                                .withName(databaseName)<font></font>
                                .withIncludes(databaseWithIncludes)<font></font>
                                .withExcludes(<span class="hljs-string">""</span>)<font></font>
                                .withInputSchema(databaseWithInputSchema))<font></font>
                        .withTarget(<span class="hljs-keyword">new</span> Target()<font></font>
                                .withPackageName(targetPackageName)<font></font>
                                .withDirectory(targetDirectory)));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, the generator starts after a full start of the application, when all new migrations are rolled up and the database is up to date. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have models, we have entities, we have a base. </font><font style="vertical-align: inherit;">It's time to create a repository and write queries.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create Repository</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All requests go through DslContext. </font><font style="vertical-align: inherit;">Repeat the DslContext.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Repository</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The repository is ready.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing CRUD Queries</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insert</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we used SQL, the request to add another country would be:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> countries(<span class="hljs-keyword">name</span>, government_form, population)
<span class="hljs-keyword">values</span> (<span class="hljs-string">' -'</span>, <span class="hljs-string">'UNITARY'</span>, <span class="hljs-number">100500</span>) <span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In JOOQ, a query is as close as possible to SQL syntax:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertValues</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)  <span class="hljs-comment">//insert into countries</span>
                .values(country.getId(), country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))  <span class="hljs-comment">//values (? ? ? ?)</span>
                .returning()  <span class="hljs-comment">//returning</span>
                .fetchOne()  <span class="hljs-comment">//*</span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we see, nothing complicated. </font><font style="vertical-align: inherit;">However, such a request does not suit us, because in our case the ID is generated in the database and we must take this into account. </font><font style="vertical-align: inherit;">If we write something like:</font></font><br>
<br>
<pre><code class="java hljs">.values(<span class="hljs-keyword">null</span>, country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
we'll get </font></font><br>
<br>
<pre><code class="java hljs">org.postgresql.util.PSQLException: :     <span class="hljs-string">"id"</span>   NOT NULL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, if we generated the ID on the application side, such a request would be a ride. </font><font style="vertical-align: inherit;">We will have to rewrite the request, giving each field a specific value. </font><font style="vertical-align: inherit;">So you can:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne()<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we manually set the object in the field. </font><font style="vertical-align: inherit;">This option is quite working, but there is better. </font><font style="vertical-align: inherit;">It would be ideal to send the whole object for saving, as is done in Spring Data JPA:</font></font><br>
<br>
<pre><code class="java hljs">repository.save(country);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Could be so. </font><font style="vertical-align: inherit;">To do this, we need to map our model into the extends Record entity and send it for saving:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))  <span class="hljs-comment">//   </span><font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This method is the simplest and most understandable for those cases when we do not need to configure mapping. </font><font style="vertical-align: inherit;">But the setting of mapping will be lower. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we noticed, this query returns the whole entity. </font><font style="vertical-align: inherit;">You can determine what exactly you need to return in the fetch () method. </font><font style="vertical-align: inherit;">It looks like this:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">insertAndReturnId</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .returning(Countries.COUNTRIES.ID) <span class="hljs-comment">//  Record    - id</span><font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .get(Countries.COUNTRIES.ID); <span class="hljs-comment">// id</span>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A little cumbersome, but, again, with what to compare. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will write the rest of the CRUD methods.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL query:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">update</span> countries
<span class="hljs-keyword">set</span> <span class="hljs-keyword">name</span>            = <span class="hljs-string">''</span>,<font></font>
    government_form = <span class="hljs-string">'CONFEDERATE'</span>,<font></font>
    population      = <span class="hljs-number">100500</span>
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">1</span>
<span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ request:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">update</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.update(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .where(Countries.COUNTRIES.ID.eq(country.getId()))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error updating entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Select</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A query in SQL would be:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> *
<span class="hljs-keyword">from</span> countries c
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = ?;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In JOOQ, the query will look accordingly:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES) <span class="hljs-comment">//select * from countries</span>
                .where(Countries.COUNTRIES.ID.eq(id))  <span class="hljs-comment">//where id = ?</span>
                .fetchAny()  <span class="hljs-comment">// ,    </span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are requests in which we have nothing to return. </font><font style="vertical-align: inherit;">Such queries return the number of rows affected. </font><font style="vertical-align: inherit;">In delete, we have nothing to return, but the information we receive will still be useful to us.</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">delete</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.deleteFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .execute() == <span class="hljs-number">1</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We delete one line. </font><font style="vertical-align: inherit;">So the SQL query will return something like:</font></font><br>
<br>
<pre><code class="sql hljs">1 row affected in 5 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having received such an answer, we know for sure that the row has been deleted. </font><font style="vertical-align: inherit;">This will be enough to declare the operation successful.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was not a fairy tale. </font><font style="vertical-align: inherit;">It was just a lubricant. </font><font style="vertical-align: inherit;">Using a regular maper for thin mapping of an entity in Record and vice versa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúOkay,‚Äù you say, reader, ‚Äúwhere is one-to-many, emoe?‚Äù Something I did not see the moment in which Country grows with a multitude of City. ‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And you will be right. This is not Hibernate; here you have to manually. All you need to do is get a list of City for which id = country.getId (). I have already shown the into () method, which uses a regular mapper to map Record into an entity. But JOOQ has an additional map () method that allows us to do whatever we want with Record. Let's look at its functionality and add the addition of cities:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; {<font></font>
                    Country country = r.into(Country.class);<font></font>
                    country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
                    <span class="hljs-keyword">return</span> country;<font></font>
                });<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we see, now we first map the Record in Country, and then we make another request in cities, we get all City for this Country and set them into essence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there can be dozens of such sets, which means there can be dozens of requests. </font><font style="vertical-align: inherit;">And to describe these requests directly in the method is like that. </font><font style="vertical-align: inherit;">The correct solution is to write a separate mapper and put all these requests there.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordMapper</span>&lt;<span class="hljs-title">CountriesRecord</span>, <span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CityRepository cityRepository;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">map</span><span class="hljs-params">(CountriesRecord record)</span> </span>{<font></font>
        Country country = record.into(Country.class);<font></font>
        country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
        <span class="hljs-keyword">return</span> country;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The query will now look like this:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">findWithCustomMapper</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; countryRecordMapper.map((CountriesRecord) r));<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is more concise, and does not contain additional logic.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ok, we learned how to map Record into an entity, but what about fine-tuning the mapping of an entity in Record?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far we have this design:</font></font><br>
<br>
<pre><code class="java hljs">.set(dsl.newRecord(Countries.COUNTRIES, country))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Already good, but what if we need to specifically map a field? </font><font style="vertical-align: inherit;">For example, we have LocalDateTime there, and a generator for PostgreSQL like Timestamp generated an OffsetDateTime. </font><font style="vertical-align: inherit;">In this case, the field simply will not be mapped and not recorded in the database. </font><font style="vertical-align: inherit;">For such cases, we will need another mapper who will do the same, but in the opposite direction.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, for every mapper we have unmapper</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He is called that. </font><font style="vertical-align: inherit;">Let's write his heir.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordUnmapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordUnmapper</span>&lt;<span class="hljs-title">Country</span>, <span class="hljs-title">CountriesRecord</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CountriesRecord <span class="hljs-title">unmap</span><span class="hljs-params">(Country country)</span> <span class="hljs-keyword">throws</span> MappingException </span>{<font></font>
        CountriesRecord record = dsl.newRecord(Countries.COUNTRIES, country);<font></font>
        record.setPopulation(-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> record;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insert with its application will look like this:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertWithUnmapper</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(countryRecordUnmapper.unmap(country))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we see, also quite.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions and Conclusions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personally, I like Hibernate more. </font><font style="vertical-align: inherit;">Probably, for 90 +% of applications its use will be more justified. </font><font style="vertical-align: inherit;">But if you, the reader, want to control every request, JOOQ or another similar library is more suitable for you. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As always, I post the training project. </font><font style="vertical-align: inherit;">He is lying </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488504/index.html">We connect a production calendar in Zabbix</a></li>
<li><a href="../en488514/index.html">Android Remote Debugger - remote debugging Android applications</a></li>
<li><a href="../en488516/index.html">Comprehensive iframe tag guide</a></li>
<li><a href="../en488518/index.html">Comparative review of e-books ONYX BOOX Livingstone and Amazon Kindle Paperwhite (2018)</a></li>
<li><a href="../en488520/index.html">Bloopers and squiggles. 2</a></li>
<li><a href="../en488528/index.html">Using PKCS # 11 cryptographic token mechanisms on the Android platform</a></li>
<li><a href="../en488530/index.html">What is reactivity?</a></li>
<li><a href="../en488534/index.html">DIY UV lamp 400-405 nm for polymerization of 3D photopolymer models</a></li>
<li><a href="../en488536/index.html">Think carefully before using Docker-in-Docker for CI or test environment.</a></li>
<li><a href="../en488540/index.html">Gauss gun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>