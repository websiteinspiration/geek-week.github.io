<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥œ ğŸ„ ğŸ¦• åŠ é€Ÿå®ä½“æ¡†æ¶æ ¸å¿ƒ ğŸ›¬ â™»ï¸ â†”ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åˆ«è´ªå¿ƒï¼
 é€‰æ‹©æ•°æ®æ—¶ï¼Œæ‚¨ä¸€æ¬¡éœ€è¦é€‰æ‹©çš„æ•°é‡å®Œå…¨ç›¸åŒã€‚åˆ‡å‹¿ä»è¡¨ä¸­æ£€ç´¢æ‰€æœ‰æ•°æ®ï¼
 
 é”™è¯¯ï¼š
 
 

using var ctx = new EFCoreTestContext(optionsBuilder.Options); // ID , ! ctx.FederalDistricts.Sele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>åŠ é€Ÿå®ä½“æ¡†æ¶æ ¸å¿ƒ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487734/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ«è´ªå¿ƒï¼</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€‰æ‹©æ•°æ®æ—¶ï¼Œæ‚¨ä¸€æ¬¡éœ€è¦é€‰æ‹©çš„æ•°é‡å®Œå…¨ç›¸åŒã€‚</font><font style="vertical-align: inherit;">åˆ‡å‹¿ä»è¡¨ä¸­æ£€ç´¢æ‰€æœ‰æ•°æ®ï¼</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é”™è¯¯ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);                
<span class="hljs-comment">//    ID  ,       !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.ID, x.Name, x.ShortName }).ToList();
</code></pre> <br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®åœ°ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);  
<span class="hljs-comment">//     ID     !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.Name, x.ShortName }).ToList();<font></font>
ctx.FederalDistricts.Select(x =&gt; <span class="hljs-keyword">new</span> MyClass { Name = x.Name, ShortName = x.ShortName }).ToList();
</code></pre><br>
<a name="habracut"></a><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é”™è¯¯ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blog.ToList(); <span class="hljs-comment">//       . ?</span>
<span class="hljs-comment">//     ?</span>
<span class="hljs-keyword">var</span> somePost = blogs.FirstOrDefault(x=&gt;x.Title.StartWidth(â€œHello world!â€));
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®åœ°ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> somePost = context.Blog.FirstOrDefault(x=&gt;x.Title.StartWidth(â€œHello world!â€));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æŸ¥è¯¢è¿”å›ä¸€äº›è®°å½•æ—¶ï¼Œå¯ä»¥æ‰§è¡Œé›†æˆæ•°æ®éªŒè¯ã€‚</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é”™è¯¯ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">StandardizeUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> url</span>)</span><font></font>
{<font></font>
    url = url.ToLower();<font></font>
    <span class="hljs-keyword">if</span> (!url.StartsWith(<span class="hljs-string">"http://"</span>))<font></font>
    {<font></font>
        url = <span class="hljs-keyword">string</span>.Concat(<span class="hljs-string">"http://"</span>, url);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> url;<font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®åœ°ï¼š</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsEnumerable().Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
 <font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; blog.Contains(<span class="hljs-string">"dotnet"</span>))<font></font>
    .OrderByDescending(blog =&gt; blog.Rating)<font></font>
    .Select(blog =&gt; <span class="hljs-keyword">new</span><font></font>
    {<font></font>
        Id = blog.BlogId,<font></font>
        Url = StandardizeUrl(blog.Url)<font></font>
    })<font></font>
    .ToList();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å“‡ï¼Œå“‡ï¼Œå“‡ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨è¯¥åˆ·æ–°ä¸€ä¸‹æ‚¨å¯¹LINQæŠ€æœ¯çš„çŸ¥è¯†äº†ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList </font></font></i><i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsEnumerable</font></font></i></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AsQueryable </font><font style="vertical-align: inherit;">ä¹‹é—´çš„åŒºåˆ«</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‰€ä»¥è¦</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ—å‡º</font></font></i><br>
<br>
<ul>
<li>  .</li>
<li> <i>.ToList()</i>           (lazy loading),            .</li>
</ul><br>
<i>AsEnumerable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li> : <i>Func &lt;TSource, bool&gt;</i></li>
<li>          (   <b>Where/Take/Skip</b>   , ,   select * from Table1, </li>
<li>    ,    N )</li>
<li>    : <i>Linq-to-SQL + Linq-to-Object</i>.</li>
<li> <i>IEnumerable </i>          (lazy loading).</li>
</ul><br>
<i>AsQueryable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  :</a> <pre><code class="cs hljs">AsQueryable(IEnumerable)  AsQueryable&lt;TElement&gt;(IEnumerable&lt;TElement&gt;) </code></pre><br>
</li>
<li> Expression  T-SQL (   ),         .</li>
<li>  DbSet ( Entity Framework)    AsQueryable    .</li>
<li>   ,   <b>Take(5)</b>     <b>Â«select top 5 * SQLÂ»</b>   .  ,       SQL  ,     .  <i>AsQueryable()</i>   ,  <i>AsEnumerable()</i>     T-SQL      Linq  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœå¸Œæœ›åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œä¹‹å‰å¯ä»¥æ”¹å–„æ•°æ®åº“æŸ¥è¯¢ï¼Œ</font><font style="vertical-align: inherit;">è¯·ä½¿ç”¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsQueryable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ä½¿ç”¨AsQueryableçš„ç¤ºä¾‹ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;EmailView&gt; <span class="hljs-title">GetEmails</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> <span class="hljs-keyword">int</span> totalRecords, Guid? deviceWorkGroupID,
                DateTime? timeStart, DateTime? timeEnd, <span class="hljs-keyword">string</span> search, <span class="hljs-keyword">int</span>? confirmStateID, <span class="hljs-keyword">int</span>? stateTypeID, <span class="hljs-keyword">int</span>? limitOffset, <span class="hljs-keyword">int</span>? limitRowCount, <span class="hljs-keyword">string</span> orderBy, <span class="hljs-keyword">bool</span> desc</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> List&lt;EmailView&gt;();<font></font>
<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> GJobEntities())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> query = db.Emails.AsQueryable();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (timeStart != <span class="hljs-literal">null</span> &amp;&amp; timeEnd != <span class="hljs-literal">null</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.Created &gt;= timeStart &amp;&amp; p.Created &lt;= timeEnd);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (stateTypeID != <span class="hljs-literal">null</span> &amp;&amp; stateTypeID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.EmailStates.OrderByDescending(x =&gt; x.AtTime).FirstOrDefault().EmailStateTypeID == stateTypeID);<font></font>
                }<font></font>
<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (confirmStateID != <span class="hljs-literal">null</span> &amp;&amp; confirmStateID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> boolValue = confirmStateID == <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<font></font>
                    query = query.Where(p =&gt; p.IsConfirmed == boolValue);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrEmpty(search))<font></font>
                {<font></font>
                    search = search.ToLower();<font></font>
                    query = query.Where(p =&gt; (p.Subject + <span class="hljs-string">" "</span> + p.CopiesEmails + <span class="hljs-string">" "</span> + p.ToEmails + <span class="hljs-string">" "</span> + p.FromEmail + <span class="hljs-string">" "</span> + p.Body)<font></font>
                                        .ToLower().Contains(search));<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (deviceWorkGroupID != Guid.Empty)<font></font>
                {<font></font>
                    query = query.Where(x =&gt; x.SCEmails.FirstOrDefault().SupportCall.Device.DeviceWorkGroupDevices.FirstOrDefault(p =&gt; p.DeviceWorkGroupID == deviceWorkGroupID) != <span class="hljs-literal">null</span>);<font></font>
                }<font></font>
<font></font>
                totalRecords = query.Count();<font></font>
                query = query.OrderByDescending(p =&gt; p.Created);<font></font>
                <span class="hljs-keyword">if</span> (limitOffset.HasValue)<font></font>
                {<font></font>
                    query = query.Skip(limitOffset.Value).Take(limitRowCount.Value);<font></font>
                }<font></font>
                <span class="hljs-keyword">var</span> items = query.ToList(); <span class="hljs-comment">//    </span><font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">new</span> EmailView<font></font>
                    {<font></font>
                        ID = item.ID,<font></font>
                        SentTime = item.SentTime,<font></font>
                        IsConfirmed = item.IsConfirmed,<font></font>
                        Number = item.Number,<font></font>
                        Subject = item.Subject,<font></font>
                        IsDeleted = item.IsDeleted,<font></font>
                        ToEmails = item.ToEmails,<font></font>
                        Created = item.Created,<font></font>
                        CopiesEmails = item.CopiesEmails,<font></font>
                        FromEmail = item.FromEmail,<font></font>
                    };<font></font>
<font></font>
                    <span class="hljs-comment">//     - </span><font></font>
<font></font>
                    r.Add(n);<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> r;<font></font>
        }<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç®€å•é˜…è¯»çš„é­”åŠ›</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœä¸éœ€è¦æ›´æ”¹æ•°æ®ï¼Œåªéœ€ä½¿ç”¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AsNoTrackingï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•</font><font style="vertical-align: inherit;">æ˜¾ç¤º</font><i><font style="vertical-align: inherit;">å³å¯</font></i><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡‡æ ·ç¼“æ…¢</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.ToList();</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¿«é€Ÿè·å–ï¼ˆåªè¯»ï¼‰</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsNoTracking().ToList();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ„Ÿè§‰æ‚¨å·²ç»é¢„çƒ­äº†ä¸€ç‚¹ï¼Ÿ </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠ è½½ç›¸å…³æ•°æ®çš„ç±»å‹</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºé‚£äº›å¿˜è®°äº†</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‡’æƒ°åŠ è½½çš„äºº</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å»¶è¿ŸåŠ è½½</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆLazy loadingï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æŒ‡è®¿é—®å¯¼èˆªå±æ€§æ—¶ä»æ•°æ®åº“é€æ˜åŠ è½½çš„å…³è”æ•°æ®ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿™é‡Œ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é˜…è¯»æ›´å¤š</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒæ—¶ï¼Œè®©æˆ‘æé†’æ‚¨å…¶ä»–ç±»å‹çš„åŠ è½½ç›¸å…³æ•°æ®ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ´»åŠ¨åŠ è½½</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç§¯æ</font><i><font style="vertical-align: inherit;">åŠ è½½ï¼‰</font></i><font style="vertical-align: inherit;">æ˜¯æŒ‡ä½œä¸ºåˆå§‹è¯·æ±‚çš„ä¸€éƒ¨åˆ†ä»æ•°æ®åº“ä¸­åŠ è½½å…³è”çš„æ•°æ®ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blogs = context.Blogs<font></font>
        .Include(blog =&gt; blog.Posts)<font></font>
            .ThenInclude(post =&gt; post.Author)<font></font>
                .ThenInclude(author =&gt; author.Photo)<font></font>
        .Include(blog =&gt; blog.Owner)<font></font>
            .ThenInclude(owner =&gt; owner.Photo)<font></font>
        .ToList();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ³¨æ„ï¼</font><font style="vertical-align: inherit;">ä»ç‰ˆæœ¬EF Core 3.0.0å¼€å§‹ï¼Œæ¯ä¸ªIncludeéƒ½ä¼šå°†ä¸€ä¸ªé™„åŠ çš„</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ·»åŠ </font><font style="vertical-align: inherit;">åˆ°å…³ç³»æä¾›ç¨‹åºç”Ÿæˆçš„SQLæŸ¥è¯¢ä¸­ï¼Œè€Œä»¥å‰çš„ç‰ˆæœ¬ä¼šç”Ÿæˆé™„åŠ çš„SQLæŸ¥è¯¢ã€‚</font><font style="vertical-align: inherit;">æ— è®ºæ˜¯å¥½æ˜¯åï¼Œè¿™éƒ½ä¼šå¤§å¤§æ”¹å˜æŸ¥è¯¢çš„æ€§èƒ½ã€‚</font><font style="vertical-align: inherit;">ç‰¹åˆ«æ˜¯ï¼ŒåŒ…å«å¤§é‡åŒ…å«è¯­å¥çš„LINQæŸ¥è¯¢å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå•ç‹¬çš„LINQæŸ¥è¯¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ˜¾å¼åŠ è½½</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆExplicit loadingï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¡¨ç¤ºä»¥åä»æ•°æ®åº“æ˜¾å¼åŠ è½½çš„å…³è”æ•°æ®ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blog = context.Blogs<font></font>
        .Single(b =&gt; b.BlogId == <span class="hljs-number">1</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> goodPosts = context.Entry(blog)<font></font>
        .Collection(b =&gt; b.Posts)<font></font>
        .Query()<font></font>
        .Where(p =&gt; p.Rating &gt; <span class="hljs-number">3</span>)<font></font>
        .ToList();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ··è›‹å’Œçªç ´ï¼</font><font style="vertical-align: inherit;">ç»§ç»­ï¼Ÿ</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡†å¤‡åŠ å¿«é€Ÿåº¦äº†å—ï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†åœ¨ä»å…³ç³»æ•°æ®åº“ä¸­è·å–ç»“æ„å¤æ‚ç”šè‡³å¼‚å¸¸çš„æ•°æ®æ—¶æ˜¾ç€æé«˜é€Ÿåº¦ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼šä½¿ç”¨ç´¢å¼•è§†å›¾ï¼ˆ1ï¼‰æˆ–æ›´å¥½åœ°ä»¥ç®€å•çš„å¹³é¢å½¢å¼é¢„å…ˆå‡†å¤‡ï¼ˆè®¡ç®—ï¼‰çš„æ•°æ®è¿›è¡Œæ˜¾ç¤ºï¼ˆ2ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆ1ï¼‰</font><font style="vertical-align: inherit;">MS SQL Serverä¸Šä¸‹æ–‡ä¸­çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç´¢å¼•è§†å›¾</font></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç´¢å¼•è§†å›¾å…·æœ‰å”¯ä¸€çš„èšé›†ç´¢å¼•ã€‚</font><font style="vertical-align: inherit;">å”¯ä¸€çš„èšé›†ç´¢å¼•å­˜å‚¨åœ¨SQL Serverä¸­ï¼Œå¹¶ä¸”åƒå…¶ä»–ä»»ä½•èšé›†ç´¢å¼•ä¸€æ ·è¿›è¡Œæ›´æ–°ã€‚</font><font style="vertical-align: inherit;">ç´¢å¼•è§†å›¾æ¯”æ ‡å‡†è§†å›¾æ›´é‡è¦ï¼Œæ ‡å‡†è§†å›¾åŒ…æ‹¬å¤§é‡è¡Œçš„å¤æ‚å¤„ç†ï¼Œä¾‹å¦‚ï¼Œèšåˆå¤§é‡æ•°æ®æˆ–åˆå¹¶å¤šè¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæŸ¥è¯¢ä¸­ç»å¸¸å¼•ç”¨æ­¤ç±»è§†å›¾ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸ºè§†å›¾åˆ›å»ºå”¯ä¸€çš„èšé›†ç´¢å¼•æ¥æé«˜æ€§èƒ½ã€‚å¯¹äºæ ‡å‡†è§†å›¾ï¼Œç»“æœé›†æœªå­˜å‚¨åœ¨æ•°æ®åº“ä¸­;è€Œæ˜¯ä¸ºæ¯ä¸ªæŸ¥è¯¢è®¡ç®—ç»“æœé›†ï¼Œä½†æ˜¯å¯¹äºèšé›†ç´¢å¼•è€Œè¨€ï¼Œç»“æœé›†ä»¥ä¸å…·æœ‰èšé›†ç´¢å¼•çš„è¡¨ç›¸åŒçš„æ–¹å¼å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚æ²¡æœ‰ä¸“é—¨ä½¿ç”¨ç´¢å¼•è§†å›¾çš„æŸ¥è¯¢ç”šè‡³å¯èƒ½å—ç›Šäºè¯¥è§†å›¾ä¸­å­˜åœ¨èšé›†ç´¢å¼•ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°±æ€§èƒ½è€Œè¨€ï¼Œæå‡ºç´¢å¼•å…·æœ‰ä¸€å®šçš„æˆæœ¬ã€‚å¦‚æœåˆ›å»ºç´¢å¼•è§†å›¾ï¼Œåˆ™æ¯æ¬¡æ›´æ”¹åŸºè¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒSQL Serverä¸ä»…å¿…é¡»æ”¯æŒè¿™äº›è¡¨ä¸­çš„ç´¢å¼•è®°å½•ï¼Œè€Œä¸”è¿˜å¿…é¡»æ”¯æŒè§†å›¾ä¸­çš„ç´¢å¼•è®°å½•ã€‚åœ¨é¢å‘å¼€å‘äººå‘˜å’Œä¼ä¸šçš„SQL Serverç‰ˆæœ¬ä¸­ï¼Œä¼˜åŒ–å™¨å¯ä»¥ä½¿ç”¨è§†å›¾ç´¢å¼•æ¥ä¼˜åŒ–æœªæŒ‡å®šç´¢å¼•è§†å›¾çš„æŸ¥è¯¢ã€‚ä½†æ˜¯ï¼Œåœ¨å…¶ä»–ç‰ˆæœ¬çš„SQL Serverä¸­ï¼ŒæŸ¥è¯¢å¿…é¡»åŒ…æ‹¬ç´¢å¼•è§†å›¾å¹¶æä¾›NOEXPANDæç¤ºä»¥åˆ©ç”¨è§†å›¾ä¸­çš„ç´¢å¼•ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆ2ï¼‰å¦‚æœæ‚¨éœ€è¦å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚æ˜¾ç¤ºä¸‰å±‚ä»¥ä¸Šæˆ–æ›´å¤šçš„ç›¸å…³è¡¨ï¼Œå¹¶ä¸”</font><b><font style="vertical-align: inherit;">CRUD</font></b><font style="vertical-align: inherit;">å¢åŠ </font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠ è½½æ—¶ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯å®šæœŸè®¡ç®—ç»“æœé›†ï¼Œå°†å…¶ä¿å­˜åœ¨è¡¨æ ¼ä¸­å¹¶ç”¨äºæ˜¾ç¤ºã€‚</font><font style="vertical-align: inherit;">å°†åœ¨å…¶ä¸­å­˜å‚¨æ•°æ®çš„ç»“æœè¡¨åº”å…·æœ‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸»é”®ï¼Œå¹¶åœ¨LINQçš„æœç´¢å­—æ®µä¸Š</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…·æœ‰</font><b><font style="vertical-align: inherit;">ç´¢å¼•</font></b><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼‚æ­¥å‘¢ï¼Ÿ</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ˜¯! </font><font style="vertical-align: inherit;">æˆ‘ä»¬ä¼šå°½å¯èƒ½ä½¿ç”¨å®ƒï¼</font><font style="vertical-align: inherit;">è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Do</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> myTask = GetFederalDistrictsAsync ();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> myTask.Result)<font></font>
    {<font></font>
         <span class="hljs-comment">// </span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
    optionsBuilder.UseSqlServer(conn);<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.ToListAsync();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ˜¯çš„ï¼Œæ‚¨æ˜¯å¦å¿˜äº†å¢åŠ ç”Ÿäº§ç‡çš„ä»»ä½•äº‹æƒ…ï¼Ÿ</font><font style="vertical-align: inherit;">umï¼</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.&lt;b&gt;AsNoTracking()&lt;/b&gt;.ToListAsync();</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ³¨æ„ï¼š</font><font style="vertical-align: inherit;">æ·»åŠ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doï¼ˆï¼‰</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•</font><font style="vertical-align: inherit;">ä»…ç”¨äºæ¼”ç¤ºç›®çš„ï¼Œä»¥æŒ‡ç¤º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetFederalDistrictsAsyncï¼ˆï¼‰</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•çš„å¯æ“ä½œæ€§</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ­£å¦‚æˆ‘çš„åŒäº‹æ­£ç¡®æŒ‡å‡ºçš„é‚£æ ·ï¼Œè¿˜éœ€è¦å¦ä¸€ä¸ªçº¯å¼‚æ­¥çš„ä¾‹å­ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘åŸºäº</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASP .NET Coreä¸­çš„è§†å›¾ç»„ä»¶</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æ¦‚å¿µ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">æ¥</font></a><font style="vertical-align: inherit;">ç»™å‡ºå®ƒ</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PopularPosts</span> : <span class="hljs-title">ViewComponent</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IStatsRepository _statsRepository;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PopularPosts</span>(<span class="hljs-params">IStatsRepository statsRepository</span>)</span><font></font>
        {<font></font>
            _statsRepository = statsRepository;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
           <span class="hljs-comment">//         -</span>
            <span class="hljs-keyword">var</span> federalDistricts = <span class="hljs-keyword">await</span> _statsRepository.GetFederalDistrictsAsync(); 
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> TablePageModel()<font></font>
            {<font></font>
                FederalDistricts = federalDistricts,<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">return</span> View(model);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">// </span><font></font>
    <font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span>  -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span>
        <span class="hljs-function">IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
	<span class="hljs-comment"><span class="hljs-doctag">///</span> !!!</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><font></font>
        Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync();<font></font>
    }	<font></font>
	<font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StatsRepository</span> : <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;<font></font>
            optionsBuilder = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfigurationRoot configurationRoot;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StatsRepository</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            IConfigurationBuilder configurationBuilder = <span class="hljs-keyword">new</span> ConfigurationBuilder()<font></font>
                    .SetBasePath(Environment.CurrentDirectory)<font></font>
                    .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">true</span>, reloadOnChange: <span class="hljs-literal">true</span>);<font></font>
            configurationRoot = configurationBuilder.Build();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToListAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> ctx.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToList();<font></font>
        }<font></font>
    }<font></font>
<font></font>
   <span class="hljs-comment">//         Home\Index </span>
    &lt;div id=<span class="hljs-string">"tableContainer"</span>&gt;<font></font>
            @await Component.InvokeAsync(<span class="hljs-string">"PopularPosts"</span>)<font></font>
     &lt;/div&gt;<font></font>
  <span class="hljs-comment">//   HTML      Shared\Components\PopularPosts\Default.cshtml</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘æé†’æ‚¨ä½•æ—¶åœ¨Entity Framework Coreä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è°ƒç”¨LINQè¯­å¥æ—¶ï¼Œæ‚¨åªéœ€åœ¨å†…å­˜ä¸­åˆ›å»ºæŸ¥è¯¢è§†å›¾ã€‚</font><font style="vertical-align: inherit;">ä»…åœ¨å¤„ç†ç»“æœä¹‹åï¼Œè¯¥è¯·æ±‚æ‰å‘é€åˆ°æ•°æ®åº“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹æ˜¯å¯¼è‡´å°†è¯·æ±‚å‘é€åˆ°æ•°æ®åº“çš„æœ€å¸¸è§æ“ä½œã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨forå¾ªç¯ä¸­éå†ç»“æœã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨è¿ç®—ç¬¦ï¼Œä¾‹å¦‚ToListï¼ŒToArrayï¼ŒSingleï¼ŒCountã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®ç»‘å®šåˆ°ç”¨æˆ·ç•Œé¢ã€‚</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•æ ¹æ®åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ç»„ç»‡EF Coreä»£ç ï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆ1ï¼‰ä»åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨éœ€è¦ç¡®ä¿å¯¹æ•°æ®åº“çš„è®¿é—®ä»£ç æ˜¯åœ¨æ˜ç¡®å®šä¹‰çš„ä½ç½®ï¼ˆéš”ç¦»ï¼‰ä¸­éš”ç¦»/åˆ†éš”çš„ã€‚</font><font style="vertical-align: inherit;">è¿™ä½¿æ‚¨å¯ä»¥æŸ¥æ‰¾å½±å“æ€§èƒ½çš„æ•°æ®åº“ä»£ç ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆ2ï¼‰è¯·å‹¿å°†æ•°æ®åº“çš„è®¿é—®ä»£ç ä¸åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ï¼ˆä¾‹å¦‚ç”¨æˆ·ç•Œé¢æˆ–APIï¼‰æ··åˆä½¿ç”¨ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå¯ä»¥æ›´æ”¹æ•°æ®åº“è®¿é—®ä»£ç ï¼Œè€Œä¸å¿…æ‹…å¿ƒä¸æ•°æ®åº“æ— å…³çš„å…¶ä»–é—®é¢˜ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•ä½¿ç”¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveChanges</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®ä¸”å¿«é€Ÿåœ°ä¿å­˜æ•°æ®</font><font style="vertical-align: inherit;">ï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ’å…¥çš„è®°å½•ç›¸åŒï¼Œåˆ™å¯¹æ‰€æœ‰è®°å½•ä½¿ç”¨ä¸€ä¸ªä¿å­˜æ“ä½œæ˜¯æœ‰æ„ä¹‰çš„ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é”™è¯¯</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
    <span class="hljs-comment">//   1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1);<font></font>
<font></font>
  <span class="hljs-comment">//          db.SaveChanges();</span><font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®åœ°</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
   <span class="hljs-comment">//  1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1); <font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
   <span class="hljs-comment">//    N </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è§„åˆ™æ€»æ˜¯æœ‰ä¾‹å¤–ã€‚</font><font style="vertical-align: inherit;">å¦‚æœäº‹åŠ¡ä¸Šä¸‹æ–‡å¾ˆå¤æ‚ï¼Œå³ç”±å‡ ä¸ªç‹¬ç«‹çš„æ“ä½œç»„æˆï¼Œåˆ™å¯ä»¥åœ¨æ¯ä¸ªæ“ä½œä¹‹åè¿›è¡Œä¿å­˜ã€‚</font><font style="vertical-align: inherit;">è€Œä¸”åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨å¼‚æ­¥å­˜å‚¨æ›´ä¸ºæ­£ç¡®ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddDepositToHousehold</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> householdId, DepositRequestModel model</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> transaction = <span class="hljs-keyword">await</span> Context.Database.BeginTransactionAsync(IsolationLevel.Snapshot))<font></font>
    {<font></font>
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            <span class="hljs-comment">//     </span>
            <span class="hljs-keyword">var</span> deposit = <span class="hljs-keyword">this</span>.Mapper.Map&lt;Deposit&gt;(model);
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Deposits.AddAsync(deposit);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//    </span>
               <span class="hljs-keyword">var</span> debtsToPay = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Debts.Where(d =&gt; d.HouseholdId == householdId &amp;&amp; !d.IsPaid).OrderBy(d =&gt; d.DateMade).ToListAsync();<font></font>
<font></font>
            debtsToPay.ForEach(d =&gt; d.IsPaid = <span class="hljs-literal">true</span>);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//   </span>
            <span class="hljs-keyword">var</span> household = <span class="hljs-keyword">this</span>.Context.Households.FirstOrDefaultAsync(h =&gt; h.Id == householdId);<font></font>
<font></font>
            household.Balance += model.DepositAmount;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            transaction.Commit();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.Ok();<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span><font></font>
        {<font></font>
            transaction.Rollback();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.BadRequest();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§¦å‘å™¨ï¼Œè®¡ç®—å­—æ®µï¼Œè‡ªå®šä¹‰å‡½æ•°å’ŒEF Core</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†å‡è½»åŒ…å«EF Coreçš„åº”ç”¨ç¨‹åºçš„è´Ÿæ‹…ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„è®¡ç®—å­—æ®µå’Œæ•°æ®åº“è§¦å‘å™¨ï¼Œä½†æœ€å¥½ä¸è¦ä»‹å…¥ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯èƒ½ä¼šé€ æˆå¾ˆå¤§çš„æ··ä¹±ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ç”¨æˆ·å®šä¹‰çš„å‡½æ•°å¯èƒ½éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨è·å–æ“ä½œæœŸé—´ï¼</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EF Coreä¸­çš„å¹¶å‘</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœè¦å¹¶è¡ŒåŒ–æ‰€æœ‰å†…å®¹ä»¥åŠ å¿«é€Ÿåº¦ï¼Œè¯·ä¸­æ–­ï¼šEF Coreä¸æ”¯æŒåœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡å®ä¾‹ä¸­æ‰§è¡Œå¤šä¸ªå¹¶è¡Œæ“ä½œã€‚</font><font style="vertical-align: inherit;">ç­‰å¾…ä¸€ä¸ªæ“ä½œå®Œæˆï¼Œç„¶åå†å¼€å§‹ä¸‹ä¸€ä¸ªæ“ä½œã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œé€šå¸¸éœ€è¦åœ¨æ¯ä¸ªå¼‚æ­¥æ“ä½œä¸­æŒ‡å®šawaitå…³é”®å­—ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EF Coreä½¿ç”¨å¼‚æ­¥æŸ¥è¯¢æ¥é¿å…åœ¨æ•°æ®åº“ä¸­æ‰§è¡ŒæŸ¥è¯¢æ—¶é˜»å¡æµç¨‹ã€‚</font><font style="vertical-align: inherit;">å¼‚æ­¥è¯·æ±‚å¯¹äºç¡®ä¿èƒ–å®¢æˆ·ç«¯ä¸­çš„å¿«é€Ÿç”¨æˆ·ç•Œé¢å“åº”éå¸¸é‡è¦ã€‚</font><font style="vertical-align: inherit;">å®ƒä»¬è¿˜å¯ä»¥æé«˜Webåº”ç”¨ç¨‹åºä¸­çš„ååé‡ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­é‡Šæ”¾çº¿ç¨‹ä»¥å¤„ç†å…¶ä»–è¯·æ±‚ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Blog&gt;&gt; GetBlogsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.Blogs.ToListAsync();<font></font>
    }<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯¹LINQç¼–è¯‘æŸ¥è¯¢äº†è§£å¤šå°‘ï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨Entity Frameworkä¸­é‡å¤æ‰§è¡Œç»“æ„ä¸Šç›¸ä¼¼çš„æŸ¥è¯¢ï¼Œåˆ™é€šå¸¸å¯ä»¥é€šè¿‡ä¸€æ¬¡ç¼–è¯‘æŸ¥è¯¢å¹¶ä½¿ç”¨ä¸åŒçš„å‚æ•°å¤šæ¬¡æ‰§è¡ŒæŸ¥è¯¢æ¥æé«˜æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦å¸å¼•ç‰¹å®šåŸå¸‚çš„æ‰€æœ‰å®¢æˆ·ã€‚ç”¨æˆ·åœ¨è¿è¡Œæ—¶åœ¨è¡¨æ ¼ä¸­æŒ‡ç¤ºåŸå¸‚ã€‚ LINQ to Entitiesæ”¯æŒä¸ºæ­¤ç›®çš„ä½¿ç”¨ç¼–è¯‘æŸ¥è¯¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä».NET Framework 4.5å¼€å§‹ï¼ŒLINQæŸ¥è¯¢å°†è‡ªåŠ¨ç¼“å­˜ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæ‚¨ä»ç„¶å¯ä»¥ä½¿ç”¨å·²ç¼–è¯‘çš„LINQæŸ¥è¯¢æ¥å‡å°‘åç»­è¿è¡Œçš„æˆæœ¬ï¼Œå¹¶ä¸”å·²ç¼–è¯‘çš„æŸ¥è¯¢æ¯”è‡ªåŠ¨ç¼“å­˜çš„LINQæŸ¥è¯¢æ›´æœ‰æ•ˆã€‚</font><font style="vertical-align: inherit;">è¯·æ³¨æ„ï¼Œå°†Enumerable.Containsè¿ç®—ç¬¦åº”ç”¨äºå†…å­˜ä¸­é›†åˆçš„LINQ to EntitiesæŸ¥è¯¢ä¸ä¼šè‡ªåŠ¨ç¼“å­˜ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œä¸å…è®¸åœ¨å·²ç¼–è¯‘çš„LINQæŸ¥è¯¢ä¸­å¯¹å†…å­˜ä¸­çš„é›†åˆè¿›è¡Œå‚æ•°åŒ–ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™é‡Œ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥æ‰¾åˆ°è®¸å¤šç¤ºä¾‹</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸è¦åˆ›å»ºå¤§å‹DbContextä¸Šä¸‹æ–‡ï¼</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ€»çš„æ¥è¯´ï¼Œæˆ‘çŸ¥é“ä½ ä»¬ä¸­çš„è®¸å¤šäººï¼ˆå³ä½¿ä¸æ˜¯å‡ ä¹å…¨éƒ¨ï¼‰éƒ½æ˜¯æ‡’æƒ°çš„f_u__c_k__e_r__sä»¥åŠæ•´ä¸ªæ•°æ®åº“ï¼Œå®ƒä»¬éƒ½æ”¾åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå°¤å…¶æ˜¯å¯¹äºæ•°æ®åº“ä¼˜å…ˆæ–¹æ³•è€Œè¨€ï¼Œè¿™æ˜¯å…¸å‹çš„ã€‚</font><font style="vertical-align: inherit;">è€Œä¸”å¾’åŠ³åœ°åšåˆ°äº†ï¼</font><font style="vertical-align: inherit;">ä»¥ä¸‹æ˜¯å¦‚ä½•åˆ’åˆ†ä¸Šä¸‹æ–‡çš„ç¤ºä¾‹ã€‚</font><font style="vertical-align: inherit;">å½“ç„¶ï¼Œä¸Šä¸‹æ–‡ä¹‹é—´çš„è¿æ¥è¡¨å°†å¿…é¡»é‡å¤ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡å·ã€‚</font><font style="vertical-align: inherit;">ä¸€ç§æˆ–å¦ä¸€ç§æ–¹å¼ï¼Œå¦‚æœä¸Šä¸‹æ–‡ä¸­çš„è¡¨è¶…è¿‡50ä¸ªï¼Œåˆ™æœ€å¥½è€ƒè™‘å¯¹å…¶è¿›è¡Œåˆ’åˆ†ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ä¸Šä¸‹æ–‡åˆ†ç»„ï¼ˆæ± åŒ–DdContextï¼‰</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
æ± çš„å«ä¹‰</font><font style="vertical-align: inherit;">æ˜¯å…è®¸é‡ç”¨</font><font style="vertical-align: inherit;">è¯¥æ± ä¸­</font><font style="vertical-align: inherit;">çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ä¾‹</font><font style="vertical-align: inherit;">ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ç›¸æ¯”ï¼Œå®ƒå¯ä»¥å¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚</font><font style="vertical-align: inherit;">è¿™ä¹Ÿæ˜¯åœ¨ADO.NETä¸­åˆ›å»ºè¿æ¥æ± çš„ä¸»è¦åŸå› ï¼Œå°½ç®¡ç”±äºè¿æ¥é€šå¸¸æ˜¯æ›´éš¾çš„èµ„æºï¼Œæ‰€ä»¥è¿æ¥çš„æ€§èƒ½æå‡å°†æ›´ä¸ºæ˜¾ç€ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Demos</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Blog</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> BlogId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Url { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BloggingContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> InstanceCount;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BloggingContext</span>(<span class="hljs-params">DbContextOptions options</span>)
            : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span>
            =&gt; Interlocked.Increment(<span class="hljs-keyword">ref</span> InstanceCount);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Blog&gt; Blogs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BlogController</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> BloggingContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BlogController</span>(<span class="hljs-params">BloggingContext context</span>)</span> =&gt; _context = context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ActionAsync</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> _context.Blogs.FirstAsync();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> ConnectionString<font></font>
            = <span class="hljs-string">@"Server=(localdb)\mssqllocaldb;Database=Demo.ContextPooling;Integrated Security=True;ConnectRetryCount=0"</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            services.AddDbContext&lt;BloggingContext&gt;(c =&gt; c.UseSqlServer(ConnectionString));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Threads = <span class="hljs-number">32</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Seconds = <span class="hljs-number">10</span>;<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> _requestsProcessed;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> serviceCollection = <span class="hljs-keyword">new</span> ServiceCollection();
            <span class="hljs-keyword">new</span> Startup().ConfigureServices(serviceCollection);
            <span class="hljs-keyword">var</span> serviceProvider = serviceCollection.BuildServiceProvider();<font></font>
<font></font>
            SetupDatabase(serviceProvider);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> stopwatch = <span class="hljs-keyword">new</span> Stopwatch();<font></font>
<font></font>
            MonitorResults(TimeSpan.FromSeconds(Seconds), stopwatch);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> Task.WhenAll(<font></font>
                Enumerable<font></font>
                    .Range(<span class="hljs-number">0</span>, Threads)<font></font>
                    .Select(_ =&gt; SimulateRequestsAsync(serviceProvider, stopwatch)));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetupDatabase</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> context = serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (context.Database.EnsureCreated())<font></font>
                {<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Dog Blog"</span>, Url = <span class="hljs-string">"http://sample.com/dogs"</span> });<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Cat Blog"</span>, Url = <span class="hljs-string">"http://sample.com/cats"</span> });<font></font>
                    context.SaveChanges();<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SimulateRequestsAsync</span>(<span class="hljs-params">IServiceProvider serviceProvider, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.IsRunning)<font></font>
            {<font></font>
                <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
                {<font></font>
                    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> BlogController(serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;()).ActionAsync();<font></font>
                }<font></font>
<font></font>
                Interlocked.Increment(<span class="hljs-keyword">ref</span> _requestsProcessed);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MonitorResults</span>(<span class="hljs-params">TimeSpan duration, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> lastInstanceCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastRequestCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastElapsed = TimeSpan.Zero;<font></font>
<font></font>
            stopwatch.Start();<font></font>
<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.Elapsed &lt; duration)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">1</span>));<font></font>
<font></font>
                <span class="hljs-keyword">var</span> instanceCount = BloggingContext.InstanceCount;
                <span class="hljs-keyword">var</span> requestCount = _requestsProcessed;
                <span class="hljs-keyword">var</span> elapsed = stopwatch.Elapsed;
                <span class="hljs-keyword">var</span> currentElapsed = elapsed - lastElapsed;
                <span class="hljs-keyword">var</span> currentRequests = requestCount - lastRequestCount;<font></font>
<font></font>
                Console.WriteLine(<font></font>
                    <span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now:HH:mm:ss.fff}</span>] "</span>
                    + <span class="hljs-string">$"Context creations/second: <span class="hljs-subst">{instanceCount - lastInstanceCount}</span> | "</span>
                    + <span class="hljs-string">$"Requests/second: <span class="hljs-subst">{Math.Round(currentRequests / currentElapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
                lastInstanceCount = instanceCount;<font></font>
                lastRequestCount = requestCount;<font></font>
                lastElapsed = elapsed;<font></font>
            }<font></font>
<font></font>
            Console.WriteLine();<font></font>
            Console.WriteLine(<span class="hljs-string">$"Total context creations: <span class="hljs-subst">{BloggingContext.InstanceCount}</span>"</span>);<font></font>
            Console.WriteLine(<font></font>
                <span class="hljs-string">$"Requests per second:     <span class="hljs-subst">{Math.Round(_requestsProcessed / stopwatch.Elapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
            stopwatch.Stop();<font></font>
        }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•é¿å…EF Coreä¸­çš„CRUDé€ æˆä¸å¿…è¦çš„é”™è¯¯ï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ‡å‹¿åœ¨åŒä¸€ä»£ç ä¸­æ’å…¥è®¡ç®—ã€‚</font><font style="vertical-align: inherit;">å§‹ç»ˆå°†å¯¹è±¡çš„å½¢æˆ/å‡†å¤‡åŠå…¶æ’å…¥/æ›´æ–°åˆ†å¼€ã€‚</font><font style="vertical-align: inherit;">åªéœ€æŒ‰åŠŸèƒ½è¿›è¡Œä¼ æ’­å³å¯ï¼šæ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„æ•°æ®ï¼Œè®¡ç®—å¿…è¦çš„åˆæ­¥æ•°æ®ï¼Œæ˜ å°„æˆ–åˆ›å»ºå¯¹è±¡ä»¥åŠå®é™…çš„CRUDæ“ä½œã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“åº”ç”¨ç¨‹åºæ€§èƒ½çœŸçš„ä¸å¥½æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å•¤é…’åœ¨è¿™é‡Œç»å¯¹æ— æµäºäº‹ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œè¿™å°†æœ‰åŠ©äºåœ¨åº”ç”¨ç¨‹åºä½“ç³»ç»“æ„ä¸­è¿›è¡Œè¯»å†™åˆ†ç¦»ï¼Œç„¶ååœ¨å¥—æ¥å­—ä¸Šåˆ†é…è¿™äº›æ“ä½œã€‚</font><font style="vertical-align: inherit;">è€ƒè™‘ä½¿ç”¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘½ä»¤å’ŒæŸ¥è¯¢è´£ä»»éš”ç¦»ï¼ˆCQRSï¼‰æ¨¡å¼</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå¹¶å°è¯•å°†è¡¨æ‹†åˆ†ä¸ºæ’å…¥å¹¶åœ¨ä¸¤ä¸ªæ•°æ®åº“ä¹‹é—´è¯»å–ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘æ‚¨ï¼Œæœ‹å‹å’ŒåŒäº‹ä»¬åŠ é€Ÿåº”ç”¨ç¨‹åºï¼</font></font></i></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487716/index.html">å®Œç¾çš„SASTã€‚è§£æå™¨</a></li>
<li><a href="../zh-CN487720/index.html">å…³äºç«äº‰æ€§çš„ç™½ç—´ç—‡ï¼ˆä»¥ååº”æ€§ç¼–ç¨‹ä¸ºä¾‹ï¼‰</a></li>
<li><a href="../zh-CN487724/index.html">BlazingPizzaï¼šBlazoråº”ç”¨ç¨‹åºä»å¤´åˆ°å°¾ã€‚ç¬¬2éƒ¨åˆ†ã€‚æ·»åŠ ç»„ä»¶</a></li>
<li><a href="../zh-CN487728/index.html">@Pythonetcæ±‡ç¼–ï¼Œ2020å¹´1æœˆ</a></li>
<li><a href="../zh-CN487730/index.html">è‡ªç„¶è¯­è¨€å¤„ç†ã€‚2019å¹´ä¸šç»©å’Œ2020å¹´è¶‹åŠ¿</a></li>
<li><a href="../zh-CN487738/index.html">SCADAä¸­çš„æ¨¡å¼åŠ¨ç”»</a></li>
<li><a href="../zh-CN487740/index.html">ç»„è£…ä¾¿æºå¼ç£åŠ›è®¡</a></li>
<li><a href="../zh-CN487742/index.html">å¥—åˆ©äº¤æ˜“ï¼ˆBellman-Fordç®—æ³•ï¼‰</a></li>
<li><a href="../zh-CN487744/index.html">FAROæ¨å‡ºFOCUS S 70æ¿€å…‰3Dæ‰«æä»ª</a></li>
<li><a href="../zh-CN487746/index.html">æ°¸æ’</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>