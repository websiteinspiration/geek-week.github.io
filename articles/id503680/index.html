<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶é üë®üèæ‚Äçüî¨ ‚òØÔ∏è DBA: dalam mengejar kunci terbang üß§ üîì ü•ó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam artikel sebelumnya, di mana saya berbicara tentang pemantauan database PostgreSQL , ada ungkapan seperti itu:
 Grow wait- aplikasi telah "berist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: dalam mengejar kunci terbang</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/503680/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam artikel sebelumnya, di mana saya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berbicara tentang pemantauan database PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ada ungkapan seperti itu:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grow </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- aplikasi telah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"beristirahat" di kunci</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seseorang </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jika ini adalah anomali satu kali yang lalu - suatu kesempatan untuk memahami alasan aslinya.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Situasi ini adalah salah satu yang paling tidak menyenangkan untuk DBA:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada pandangan pertama, pangkalan berfungsi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak ada sumber daya server yang habis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... tetapi beberapa permintaan "melambat"</font></font></li>
</ul><img src="https://habrastorage.org/webt/jy/wa/sk/jywaskrftah-9f7d9xwp3jvkn_q.png" align="right"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemungkinan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menangkap kunci "saat ini"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sangat kecil, dan mereka hanya dapat bertahan beberapa detik, tetapi memperburuk waktu eksekusi yang direncanakan dari permintaan tersebut puluhan kali. </font><font style="vertical-align: inherit;">Tetapi Anda hanya tidak ingin duduk dan menangkap apa yang sedang terjadi secara online, tetapi dalam lingkungan yang tenang untuk mencari tahu fakta </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari pengembang</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mana yang </font><s><font style="vertical-align: inherit;">menghukum</font></s><font style="vertical-align: inherit;"> apa sebenarnya masalahnya - siapa, dengan siapa dan karena sumber daya mana dari basis data itu mengalami konflik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi bagaimana caranya? </font><font style="vertical-align: inherit;">Memang, tidak seperti permintaan dengan rencananya, yang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda untuk memahami secara terperinci</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apa yang terjadi dengan sumber daya dan berapa lama, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kuncinya tidak meninggalkan jejak yang jelas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kecuali entri log pendek: </font><font style="vertical-align: inherit;">Tapi mari kita coba menangkapnya!</font></font><code><blockquote>process ... <b>still waiting for</b> ...</blockquote></code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menangkap kunci dalam log</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi bahkan untuk setidaknya baris ini muncul di log, server harus dikonfigurasi dengan benar:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">log_lock_waits</a> = <b>'on'</b></code></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... dan menetapkan batas minimum untuk analisis kami:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">deadlock_timeout</a> = <b>'100ms'</b></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika parameter diaktifkan </font></font><code>log_lock_waits</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, parameter ini juga menentukan setelah waktu berapa pesan tentang menunggu pemblokiran akan ditulis ke log server. </font><font style="vertical-align: inherit;">Jika Anda mencoba menyelidiki penundaan yang disebabkan oleh kunci, masuk akal untuk menguranginya dibandingkan dengan nilai biasanya </font></font><code>deadlock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semua kebuntuan yang tidak punya waktu untuk "melepaskan" selama waktu ini akan robek. </font><font style="vertical-align: inherit;">Dan di sini adalah kunci "biasa" - dibuang ke log oleh beberapa entri:</font></font><br>
<blockquote><i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> still waiting for ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 100.047 ms</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest DETAIL: <b>Process holding the lock: 38154. Wait queue: <font color="red">38162</font>.</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest CONTEXT: SQL statement <code>"SELECT pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer )"<br>
 PL/pgSQL function inline_code_block line 2 at PERFORM</code><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest STATEMENT: <code> DO $$ BEGIN<br>
 PERFORM pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer );<br>
 EXCEPTION<br>
 WHEN query_canceled THEN RETURN;<br>
 END; $$;</code><br>
‚Ä¶<br>
<br>
<i>2019-03-27 00:06:46.077</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> <font color="green">acquired</font> ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 150.741 ms</b></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh ini menunjukkan bahwa kita </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya memiliki 50 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari saat kunci muncul di log hingga saat resolusi. </font><font style="vertical-align: inherit;">Hanya dalam interval ini kita dapat memperoleh setidaknya beberapa informasi tentangnya, dan semakin cepat kita dapat melakukan ini, semakin banyak kunci yang dapat kita analisis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini informasi paling penting bagi kami adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PID dari proses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang menunggu kunci. </font><font style="vertical-align: inherit;">Di atasnya kita dapat membandingkan informasi antara log dan keadaan database. </font><font style="vertical-align: inherit;">Dan pada saat yang sama untuk mengetahui seberapa bermasalah kunci tertentu - yaitu, berapa lama "tergantung". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, kita hanya perlu beberapa RegExp pada </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catatan </font><font style="vertical-align: inherit;">konten </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> RE_lock_detect = <span class="hljs-regexp">/^process (\d+) still waiting for (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> RE_lock_acquire = <span class="hljs-regexp">/^process (\d+) acquired (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//   </span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kita sampai ke log</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, ini tetap sedikit - untuk mengambil log, belajar bagaimana memonitor dan meresponsnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami sudah memiliki segalanya untuk ini - parser log online dan koneksi basis data yang sudah diaktifkan, yang saya bicarakan dalam sebuah artikel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tentang sistem pemantauan PostgreSQL kami</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<img src="https://habrastorage.org/webt/tc/pv/oq/tcpvoqmeliadskfh2rpnffg7uwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika Anda tidak memiliki sistem serupa yang digunakan, maka tidak apa-apa, kami akan melakukan semuanya ‚ÄúLangsung dari konsol‚Äù! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika versi PostgreSQL 10 yang diinstal dan yang lebih tinggi beruntung, karena muncul fungsi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_logfile ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang secara eksplisit memberikan nama file log saat ini. </font><font style="vertical-align: inherit;">Mendapatkannya dari konsol akan cukup mudah:</font></font><br>
<br>
<pre><code class="bash hljs">psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) &lt;&gt; '/' THEN current_setting('data_directory') ELSE '' END || '/' || pg_current_logfile()"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika versi ini tiba-tiba lebih muda - semuanya akan berubah, tetapi sedikit lebih rumit:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami </font></font><code>tail -f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendapatkan </font><font style="vertical-align: inherit;">nama file lengkap, yang kami berikan </font><font style="vertical-align: inherit;">dan akan menangkap penampilan di sana </font></font><code>'still waiting for'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nah, begitu sesuatu muncul di utas ini, kami menyebutnya ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan Parsing</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya, objek pemblokiran dalam log bukan berarti selalu sumber daya yang menyebabkan konflik. </font><font style="vertical-align: inherit;">Misalnya, jika Anda mencoba membuat indeks dengan nama yang sama secara paralel, hanya akan ada sesuatu seperti itu di log </font></font><code>still waiting for ExclusiveLock on transaction 12345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena itu, kami harus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menghapus status semua kunci dari basis data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk proses yang menarik bagi kami. </font><font style="vertical-align: inherit;">Dan informasi hanya tentang sepasang proses (yang memasang kunci / siapa yang mengharapkannya) tidak cukup, karena sering kali ada "rantai" harapan dari sumber daya yang berbeda antara transaksi:</font></font><br>
<br>
<pre><code class="plaintext hljs">tx1 [resA] -&gt; tx2 [resA]<font></font>
tx2 [resB] -&gt; tx3 [resB]<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klasik: "Kakek untuk lobak, nenek untuk kakek, cucu untuk nenek, ..." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, kami akan menulis permintaan yang akan memberi tahu kami dengan tepat siapa yang menjadi akar penyebab masalah di sepanjang seluruh rantai kunci untuk PID tertentu:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> lm <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- lock modes</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    rn<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">THEN</span> row_number() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rn)
    <span class="hljs-keyword">END</span> rx<font></font>
  , lm || <span class="hljs-string">'Lock'</span> lm
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
      row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
    , lm<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">unnest</span>(
        <span class="hljs-built_in">ARRAY</span>[
          <span class="hljs-string">'AccessShare'</span>
        , <span class="hljs-string">'RowShare'</span>
        , <span class="hljs-string">'RowExclusive'</span>
        , <span class="hljs-string">'ShareUpdateExclusive'</span>
        , <span class="hljs-string">'Share'</span>
        , <span class="hljs-string">'ShareRowExclusive'</span>
        , <span class="hljs-string">'Exclusive'</span>
        , <span class="hljs-string">'AccessExclusive'</span><font></font>
        ]<font></font>
      ) T(lm)<font></font>
  ) T<font></font>
)<font></font>
<span class="hljs-comment">-- lock types</span>
, lt <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
  , lt<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(
      <span class="hljs-built_in">ARRAY</span>[
        <span class="hljs-string">'relation'</span>
      , <span class="hljs-string">'extend'</span>
      , <span class="hljs-string">'page'</span>
      , <span class="hljs-string">'tuple'</span>
      , <span class="hljs-string">'transactionid'</span>
      , <span class="hljs-string">'virtualxid'</span>
      , <span class="hljs-string">'object'</span>
      , <span class="hljs-string">'userlock'</span>
      , <span class="hljs-string">'advisory'</span>
      , <span class="hljs-string">''</span><font></font>
      ]<font></font>
    ) T(lt)<font></font>
)<font></font>
<span class="hljs-comment">-- lock modes conflicts</span>
, lmx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    lr.rn lrn<font></font>
  , lr.rx lrx<font></font>
  , lr.lm lr<font></font>
  , ld.rn ldn<font></font>
  , ld.rx ldx<font></font>
  , ld.lm ld<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    lm lr<font></font>
  <span class="hljs-keyword">JOIN</span>
    lm ld <span class="hljs-keyword">ON</span>
      ld.rx &gt; (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rx) <span class="hljs-keyword">FROM</span> lm) - lr.rx <span class="hljs-keyword">OR</span><font></font>
      (<font></font>
        (lr.rx = ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
        (lr.rx, ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span>
        ld.rn &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rn) <span class="hljs-keyword">FROM</span> lm) - lr.rn<font></font>
      )<font></font>
)<font></font>
<span class="hljs-comment">-- locked targets/pids</span>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) target<font></font>
  , ld.pid  ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid  lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks ld<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_locks lr <span class="hljs-keyword">ON</span>
      lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
      (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (ld.locktype, ld.database, ld.relation, ld.page, ld.tuple, ld.virtualxid, ld.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, ld.classid, ld.objid, ld.objsubid) <span class="hljs-keyword">AND</span>
      (lr.granted, ld.granted) = (<span class="hljs-literal">TRUE</span>, <span class="hljs-literal">FALSE</span>)
  <span class="hljs-keyword">JOIN</span>
    lmx <span class="hljs-keyword">ON</span><font></font>
      (lmx.lr, lmx.ld) = (lr.mode, ld.mode)<font></font>
  <span class="hljs-keyword">WHERE</span>
    (ld.pid, ld.granted) = ($<span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span>, <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">-- PID</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span>          <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span>         <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span>    <span class="hljs-keyword">THEN</span> regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-string">"locked"</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, (lc.locktype, lc.database, lc.relation, lc.page, lc.tuple, lc.virtualxid, lc.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lc.classid, lc.objid, lc.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-string">"conflict"</span>
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span>
  pg_locks lc <span class="hljs-keyword">ON</span>
    lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah # 1 - Mulai Lambat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang dapat Anda lihat pada contoh dari log, di sebelah baris yang memberi tanda terjadinya kunci ( </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), ada 3 baris lagi ( </font></font><code>DETAIL, CONTEXT, STATEMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) yang melaporkan informasi tambahan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami menunggu pembentukan "paket" lengkap dari semua 4 entri dan hanya setelah itu kami beralih ke database. </font><font style="vertical-align: inherit;">Tetapi kita dapat menyelesaikan pembentukan paket hanya ketika Rekaman berikutnya (sudah ke-5!) Tiba, dengan rincian proses lain, atau dengan batas waktu. </font><font style="vertical-align: inherit;">Jelas bahwa kedua opsi memancing menunggu yang tidak perlu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghilangkan penundaan ini, kami beralih ke </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aliran memproses catatan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kunci. </font><font style="vertical-align: inherit;">Yaitu, sekarang kita </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beralih ke database target</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> segera setelah kami mengurutkan catatan pertama, dan menyadari bahwa itu adalah kunci yang dijelaskan di sana.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah # 2 - permintaan lambat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi tetap saja, beberapa kunci tidak punya waktu untuk dianalisis. </font><font style="vertical-align: inherit;">Mereka mulai menggali lebih dalam - dan menemukan bahwa di beberapa server permintaan analisis kami dijalankan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selama 15-20 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alasannya ternyata biasa - jumlah kunci aktif di pangkalan, mencapai beberapa ribu:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/sp/ex/lkspexwtgdfrqhmh3siwsnx_s30.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini harus dicatat bahwa kunci di PostgreSQL tidak "disimpan" di mana saja, tetapi disajikan hanya dalam tampilan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sistem pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang merupakan refleksi langsung dari fungsi tersebut </font></font><code>pg_lock_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dan dalam permintaan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami, kami membacanya tiga kali</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Sementara itu, kami membaca ribuan contoh kunci ini, dan membuang yang tidak terkait dengan PID kami, kunci itu sendiri berhasil "menyelesaikan" ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusinya adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mematerialisasikan" keadaan pg_locks di CTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - setelah itu Anda dapat menjalankannya sebanyak yang Anda inginkan, itu sudah tidak berubah. </font><font style="vertical-align: inherit;">Selain itu, setelah duduk di algoritma, adalah mungkin untuk mengurangi semuanya menjadi hanya dua pemindaiannya.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dinamika Berlebihan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan bahkan jika sedikit melihat lebih dekat pada query di atas, kita dapat melihat bahwa CTE </font></font><code>lm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>lmx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak dengan cara apa pun terkait dengan data, tetapi hanya menghitung selalu definisi "statis" matriks yang sama dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konflik antara mode pemblokiran</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jadi mari kita atur sebagai kualitas </font></font><code>VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah # 3 - tetangga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi sebagian dari kunci masih dilewati. Biasanya ini terjadi sesuai dengan skema berikut - seseorang memblokir sumber daya populer, dan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa proses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan cepat dan cepat berlari ke dalamnya atau sepanjang rantai lebih lanjut </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, kami menangkap PID pertama, pergi ke basis target (dan agar tidak membebani itu, kami hanya menyimpan satu koneksi), apakah analisis, kembali dengan hasilnya, mengambil PID berikutnya ... Tapi hidup tidak sepadan di pangkalan, dan PID mengunci # 2 sudah hilang! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, mengapa kita perlu membuka database untuk setiap PID secara terpisah, jika kita masih memfilter kunci dari daftar umum dalam permintaan? Mari kita </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segera</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mengambil </font><b><font style="vertical-align: inherit;">seluruh daftar proses yang saling bertentangan langsung dari database</font></b><font style="vertical-align: inherit;"> dan mendistribusikan kunci mereka di semua PID yang jatuh selama pelaksanaan permintaan:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> lm(ld, lr) <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'AccessShareLock'</span>, <span class="hljs-string">'{AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowShareLock'</span>, <span class="hljs-string">'{ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowExclusiveLock'</span>, <span class="hljs-string">'{ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareUpdateExclusiveLock'</span>, <span class="hljs-string">'{ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareRowExclusiveLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ExclusiveLock'</span>, <span class="hljs-string">'{RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'AccessExclusiveLock'</span>, <span class="hljs-string">'{AccessShareLock,RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
)<font></font>
, locks <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    (<font></font>
      locktype<font></font>
    , <span class="hljs-keyword">database</span><font></font>
    , relation<font></font>
    , page<font></font>
    , tuple<font></font>
    , virtualxid<font></font>
    , transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span><font></font>
    , classid<font></font>
    , objid<font></font>
    , objsubid<font></font>
    ) target<font></font>
  , *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks<font></font>
)<font></font>
, ld <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> granted<font></font>
)<font></font>
, lr <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    target::<span class="hljs-built_in">text</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        target::<span class="hljs-built_in">text</span>
      <span class="hljs-keyword">FROM</span><font></font>
        ld<font></font>
    )) <span class="hljs-keyword">AND</span><font></font>
    granted<font></font>
)<font></font>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
    lr.target<font></font>
  , ld.pid ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    ld<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    lr<font></font>
      <span class="hljs-keyword">ON</span> lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
        lr.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> ld.target<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span> <span class="hljs-keyword">THEN</span>
      regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-keyword">as</span> <span class="hljs-keyword">locked</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, lc.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-keyword">as</span> conflict
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span><font></font>
  locks lc<font></font>
    <span class="hljs-keyword">ON</span> lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita punya waktu untuk menganalisis bahkan kunci yang ada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya 1-2 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> setelah masuk ke log.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analisa ini</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, mengapa kami mencoba begitu lama? </font><font style="vertical-align: inherit;">Apa yang ini memberi kita sebagai hasilnya? ..</font></font><br>
<br>
<pre><code class="plaintext hljs">type     | target                  | locked | pid    | mode        | granted | conflict<font></font>
---------------------------------------------------------------------------------------<font></font>
relation | {225388639}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {423576026}             | f      | 216547 | AccessShare | t       | f<font></font>
advisory | {225386226,194303167,2} | t      |  24964 | Exclusive   | f       | t<font></font>
relation | {341894815}             | t      |  24964 | AccessShare | t       | f<font></font>
relation | {416441672}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {225964322}             | f      | 216547 | AccessShare | t       | f<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam lempeng ini, nilai </font></font><code>target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan tipe </font><font style="vertical-align: inherit;">berguna bagi kami </font></font><code>relation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, karena setiap nilai tersebut adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OID dari tabel atau indeks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sekarang hanya ada sedikit yang tersisa - untuk belajar menginterogasi database OID yang masih belum diketahui oleh kami, untuk menerjemahkannya ke dalam bentuk yang dapat dibaca manusia:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>::<span class="hljs-keyword">oid</span>::regclass;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang, mengetahui "matriks" penuh dari kunci dan semua objek di mana mereka ditumpangkan oleh masing-masing transaksi, kita dapat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menyimpulkan "apa yang terjadi sama sekali"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan sumber daya apa yang menyebabkan konflik, bahkan jika permintaan diblokir, kita tidak tahu. </font><font style="vertical-align: inherit;">Ini dapat dengan mudah terjadi, misalnya, ketika waktu eksekusi permintaan pemblokiran tidak cukup lama untuk sampai ke log, tetapi transaksi aktif setelah selesai dan menciptakan masalah untuk waktu yang lama. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/4m/j7/4m4mj7nqgpeoxe13qoldzrmhhr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi tentang ini - di artikel lain.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Semua dengan sendirinya"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sementara itu, kami akan mengumpulkan versi lengkap "pemantauan", yang secara otomatis akan menghapus status kunci untuk arsip kami segera setelah sesuatu yang mencurigakan muncul di log:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span> \<font></font>
  | xargs -l -I{} tail -f {} \<font></font>
  | stdbuf -o0 grep <span class="hljs-string">'still waiting for'</span> \<font></font>
  | xargs -l -I{} date <span class="hljs-string">'+%Y%m%d-%H%M%S.%N'</span> \<font></font>
  | xargs -l -I{} psql -U postgres postgres -f detect-lock.sql -o {}-lock.log<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan selanjutnya untuk </font></font><code>detect-lock.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menempatkan permintaan terakhir. </font><font style="vertical-align: inherit;">Jalankan - dan dapatkan banyak file dengan konten yang diinginkan di dalamnya:</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat 20200526-181433.331839375-lock.log<font></font>
     type      |     target     | locked |  pid   |     mode     | granted | conflict<font></font>
---------------+----------------+--------+--------+--------------+---------+----------<font></font>
 relation      | {279588430}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | t      | 136325 | RowExclusive | t       | f<font></font>
 virtualxid    | {110,12171420} | t      | 136325 | Exclusive    | t       | f<font></font>
 relation      | {279588430}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | f      |  39339 | RowExclusive | t       | f<font></font>
 virtualxid    | {360,11744113} | f      |  39339 | Exclusive    | t       | f<font></font>
 virtualxid    | {638,4806358}  | t      |  80553 | Exclusive    | t       | f<font></font>
 advisory      | {1,1,2}        | t      |  80553 | Exclusive    | f       | t<font></font>
 advisory      | {1,1,2}        | f      |  80258 | Exclusive    | t       | t<font></font>
 transactionid | {3852607686}   | t      | 136325 | Exclusive    | t       | f<font></font>
 extend        | {279588422}    | t      | 136325 | Exclusive    | f       | t<font></font>
 extend        | {279588422}    | f      |  39339 | Exclusive    | t       | t<font></font>
 transactionid | {3852607712}   | f      |  39339 | Exclusive    | t       | f<font></font>
(15 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nah, lalu - duduk dan menganalisis ...</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id503668/index.html">Lingkaran Kuadrat: Bukti Visual</a></li>
<li><a href="../id503670/index.html">Apakah Mac OS melambat? - Catalina memeriksa kode yang tidak ditandatangani melalui Internet saat startup</a></li>
<li><a href="../id503672/index.html">Di sisi mana Anda berada: Tekan dan Tarik dalam Konfigurasi Status yang Diinginkan</a></li>
<li><a href="../id503676/index.html">Tiga proyek geek untuk Geek Pride Day</a></li>
<li><a href="../id503678/index.html">Vuex memecah enkapsulasi</a></li>
<li><a href="../id503682/index.html">Snom Exchange A hingga Z</a></li>
<li><a href="../id503688/index.html">Joel Spolsky: Apa Artinya Menjadi Pengembang Perangkat Lunak (Pengantar Coder ke Pengembang)</a></li>
<li><a href="../id503690/index.html">Praktik terbaik Kubernetes. Upgrade Kubernetes Zero Downtime Cluster</a></li>
<li><a href="../id503696/index.html">Gears of war: ketika komputer analog mekanis menguasai laut</a></li>
<li><a href="../id503698/index.html">Akuntansi jarak jauh - sebagai manfaat bisnis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>