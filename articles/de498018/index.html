<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚§µÔ∏è ‚úåüèΩ üò¢ Online-Analyse in der Microservice-Architektur: Hilfe und Vorschlag Postgres FDW –∏ –∏ Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂—Ç –∏—åÃ∂ üöÜ üëè üé™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Microservice-Architektur hat wie alles auf dieser Welt ihre Vor- und Nachteile. Einige Prozesse damit werden einfacher, andere komplizierter. Und ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Online-Analyse in der Microservice-Architektur: Hilfe und Vorschlag Postgres FDW –∏ –∏ Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂—Ç –∏—åÃ∂</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Microservice-Architektur hat wie alles auf dieser Welt ihre Vor- und Nachteile. Einige Prozesse damit werden einfacher, andere komplizierter. Und im Interesse der √Ñnderungsgeschwindigkeit und der besseren Skalierbarkeit m√ºssen Opfer gebracht werden. Eine davon ist die Komplikation der Analytik. Wenn in einem Monolithen alle betrieblichen Analysen f√ºr ein analytisches Replikat auf SQL-Abfragen reduziert werden k√∂nnen, hat in einer Multiservice-Architektur jeder Dienst seine eigene Basis, und es scheint, dass auf eine Abfrage nicht verzichtet werden kann (oder kann auf sie verzichtet werden?). F√ºr diejenigen, die daran interessiert sind, wie wir das Problem der operativen Analyse in unserem Unternehmen gel√∂st haben und wie wir gelernt haben, mit dieser L√∂sung zu leben - willkommen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mein Name ist Pavel Sivash. In DomKlik arbeite ich in einem Team, das f√ºr die Wartung des analytischen Data Warehouse verantwortlich ist. Herk√∂mmlicherweise k√∂nnen unsere Aktivit√§ten auf das Datum des Engineering zur√ºckgef√ºhrt werden, aber tats√§chlich ist das Aufgabenspektrum viel breiter. Es gibt ETL / ELT-Standards f√ºr das Date Engineering, die Unterst√ºtzung und Anpassung von Tools f√ºr die Datenanalyse und die Entwicklung eigener Tools. Insbesondere f√ºr die operative Berichterstattung haben wir beschlossen, so zu tun, als h√§tten wir einen Monolithen, und den Analysten eine Basis zu geben, auf der sie alle ben√∂tigten Daten haben.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen haben wir verschiedene Optionen in Betracht gezogen. Es war m√∂glich, ein vollwertiges Repository zu erstellen - wir haben es sogar versucht, aber um ehrlich zu sein, haben wir es nicht geschafft, Freunde zu finden, die h√§ufig genug √Ñnderungen an der Logik vorgenommen haben, und zwar mit einem ziemlich langsamen Prozess, ein Repository zu erstellen und √Ñnderungen daran vorzunehmen (wenn jemand erfolgreich war, schreiben Sie in die Kommentare, wie). Man k√∂nnte den Analysten sagen: ‚ÄûLeute, lernt Python und geht zu analytischen Hinweisen‚Äú, aber dies ist eine zus√§tzliche Voraussetzung f√ºr die Einstellung von Mitarbeitern, und es schien, dass dies nach M√∂glichkeit vermieden werden sollte. Wir haben uns entschlossen, die FDW-Technologie (Foreign Data Wrapper) zu verwenden: Tats√§chlich ist dies der Standard-Dblink, der im SQL-Standard enthalten ist, aber √ºber eine wesentlich bequemere Benutzeroberfl√§che verf√ºgt. Auf dieser Grundlage haben wir eine Entscheidung getroffen, die sich schlie√ülich beruhigt hat. Wir haben damit aufgeh√∂rt. Seine Details sind Gegenstand eines separaten Artikels oder vielleicht auch nicht eines.weil ich viel dar√ºber reden m√∂chte: von der Synchronisation von Datenbankschemata √ºber die Zugriffskontrolle bis hin zur Anonymisierung personenbezogener Daten. Sie m√ºssen auch reservieren, dass diese L√∂sung keinen Ersatz f√ºr echte analytische Datenbanken und Repositorys darstellt, sondern nur ein bestimmtes Problem l√∂st.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf h√∂chster Ebene sieht es so aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine PostgreSQL-Datenbank, in der Benutzer ihre Arbeitsdaten speichern k√∂nnen, und vor allem sind analytische Replikate aller Dienste √ºber FDW mit dieser Datenbank verbunden. </font><font style="vertical-align: inherit;">Auf diese Weise k√∂nnen Sie eine Abfrage in mehrere Datenbanken schreiben, unabh√§ngig davon, um was es sich handelt: PostgreSQL, MySQL, MongoDB oder etwas anderes (Datei, API, wenn pl√∂tzlich kein geeigneter Wrapper vorhanden ist, k√∂nnen Sie Ihren eigenen schreiben). </font><font style="vertical-align: inherit;">Nun, alles scheint super zu sein! </font><font style="vertical-align: inherit;">Sind wir nicht einverstanden? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn alles so schnell und einfach geendet h√§tte, h√§tte es wahrscheinlich keinen Artikel gegeben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist wichtig zu verstehen, wie Postgres Anforderungen an Remoteserver verarbeitet. </font><font style="vertical-align: inherit;">Dies scheint logisch, wird jedoch h√§ufig nicht beachtet: postgres unterteilt die Anforderung in Teile, die unabh√§ngig voneinander auf Remote-Servern ausgef√ºhrt werden, sammelt diese Daten und die endg√ºltigen Berechnungen werden von selbst ausgef√ºhrt, sodass die Geschwindigkeit der Anforderung stark davon abh√§ngt, wie sie geschrieben wird. </font><font style="vertical-align: inherit;">Es sollte auch beachtet werden: Wenn Daten von einem Remote-Server stammen, haben sie keine Indizes mehr, es gibt nichts, was dem Scheduler helfen kann, daher k√∂nnen nur wir selbst helfen und sie vorschlagen. </font><font style="vertical-align: inherit;">Und ich m√∂chte Ihnen mehr dar√ºber erz√§hlen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfache Anfrage und planen Sie damit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu zeigen, wie postgres eine Abfrage in einer 6-Millionen-Zeilentabelle auf einem Remote-Server ausf√ºhrt, sehen wir uns einen einfachen Plan an.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit der Anweisung VERBOSE k√∂nnen Sie die Anforderung anzeigen, die an den Remote-Server gesendet wird und deren Ergebnisse wir zur weiteren Verarbeitung erhalten (RemoteSQL-Zeile). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns etwas weiter gehen und unserer Abfrage mehrere Filter hinzuf√ºgen: einen nach dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Booleschen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Feld, einen nach dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeitstempel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Intervall und einen nach </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier liegt der Moment, auf den Sie beim Schreiben von Abfragen achten m√ºssen. </font><font style="vertical-align: inherit;">Filter wurden nicht auf den Remote-Server √ºbertragen, was bedeutet, dass der Postgres zur Ausf√ºhrung alle 6 Millionen Zeilen erweitert, nur um dann lokal zu filtern (Filterzeile) und eine Aggregation durchzuf√ºhren. </font><font style="vertical-align: inherit;">Der Schl√ºssel zum Erfolg besteht darin, eine Anforderung zu schreiben, damit die Filter auf den Remotecomputer √ºbertragen werden und nur die erforderlichen Zeilen empfangen und aggregiert werden.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ist ein Bl√∂dsinn</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit booleschen Feldern ist alles einfach. </font><font style="vertical-align: inherit;">In der urspr√ºnglichen Anfrage war das Problem auf die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Anweisung zur√ºckzuf√ºhren </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn wir es durch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ersetzen </font><font style="vertical-align: inherit;">, erhalten wir das folgende Ergebnis:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen k√∂nnen, flog der Filter zu einem Remote-Server und die Laufzeit wurde von 27 auf 19 Sekunden reduziert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist anzumerken, dass sich der Operator </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is vom</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Operator </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= dadurch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> unterscheidet, </font><font style="vertical-align: inherit;">dass er mit dem Nullwert arbeiten kann. </font><font style="vertical-align: inherit;">Dies bedeutet, dass </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht wahr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Filter False und Null hinterl√§sst, w√§hrend </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nur False hinterl√§sst. </font><font style="vertical-align: inherit;">Wenn Sie den </font><font style="vertical-align: inherit;">Operator </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is not</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ersetzen </font><font style="vertical-align: inherit;">, sollten daher zwei Bedingungen mit dem Operator OR an den Filter √ºbergeben werden, z. B. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE (col! = True) OR (col ist null)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fahren Sie mit sortiertem Booleschen Wert fort. </font><font style="vertical-align: inherit;">Setzen Sie in der Zwischenzeit den Filter nach Booleschem Wert auf seine urspr√ºngliche Form zur√ºck, um die Auswirkungen anderer √Ñnderungen unabh√§ngig zu ber√ºcksichtigen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamptz? </font><font style="vertical-align: inherit;">hz</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen muss man oft experimentieren, wie eine Abfrage geschrieben wird, an der Remoteserver beteiligt sind, und erst dann nach einer Erkl√§rung suchen, warum dies geschieht. Sehr wenig Informationen dazu finden Sie im Internet. In Experimenten haben wir festgestellt, dass der Filter nach einem festen Datum mit einem Knall zum Remote-Server fliegt. Wenn wir das Datum jedoch dynamisch einstellen m√∂chten, z. B. jetzt () oder CURRENT_DATE, geschieht dies nicht. In unserem Beispiel haben wir einen Filter hinzugef√ºgt, sodass die Spalte "created_at" Daten f√ºr genau 1 Monat in der Vergangenheit enth√§lt (ZWISCHEN CURRENT_DATE - INTERVALL '7 Monate' UND CURRENT_DATE - INTERVALL '6 Monate'). Was haben wir in diesem Fall getan?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben den Scheduler aufgefordert, das Datum in der Unterabfrage im Voraus zu berechnen und die vorgefertigte Variable an den Filter zu √ºbergeben. </font><font style="vertical-align: inherit;">Und dieser Hinweis gab uns ein hervorragendes Ergebnis, die Abfrage wurde fast sechsmal schneller! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier ist es wichtig, vorsichtig zu sein: Der Datentyp in der Unterabfrage muss mit dem Feld √ºbereinstimmen, nach dem wir filtern. Andernfalls entscheidet der Scheduler, dass die Daten unterschiedlich sind, und Sie m√ºssen zuerst alle Daten abrufen und lokal filtern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setzen Sie den Filter nach Datum auf seinen urspr√ºnglichen Wert zur√ºck.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Freddy vs. </font><font style="vertical-align: inherit;">Jsonb</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen haben boolesche Felder und Daten unsere Abfrage bereits beschleunigt, es gab jedoch noch einen weiteren Datentyp. </font><font style="vertical-align: inherit;">Der Kampf mit der Filterung ist offen gesagt immer noch nicht vorbei, obwohl es Erfolge gibt. </font><font style="vertical-align: inherit;">So haben wir es geschafft, den Filter nach </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Feld an den Remote-Server zu √ºbergeben.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anstatt Operatoren zu filtern, m√ºssen Sie den Operator verwenden, ein </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in einem anderen zu haben. </font><font style="vertical-align: inherit;">7 Sekunden statt der ersten 29. Bisher ist dies die einzige erfolgreiche Option zum √úbertragen von Filtern √ºber </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf einen Remote-Server. Es ist jedoch wichtig, eine Einschr√§nkung zu ber√ºcksichtigen: Wir verwenden die Datenbankversion 9.6, planen jedoch, die neuesten Tests abzuschlie√üen und bis Ende April auf Version 12 </font><b><font style="vertical-align: inherit;">umzusteigen</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">W√§hrend wir aktualisieren, werden wir schreiben, wie sich dies auswirkt, da es viele √Ñnderungen gibt, f√ºr die es viele Hoffnungen gibt: json_path, neues CTE-Verhalten, Push-Down (vorhanden ab Version 10). </font><font style="vertical-align: inherit;">Ich w√ºrde es gerne bald versuchen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mach ihn fertig</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben einzeln gepr√ºft, wie sich jede √Ñnderung auf die Geschwindigkeit der Anfrage auswirkt. </font><font style="vertical-align: inherit;">Nun wollen wir sehen, was passiert, wenn alle drei Filter richtig geschrieben sind.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja, die Anfrage sieht komplizierter aus, es ist ein erzwungenes Board, aber die Ausf√ºhrungsgeschwindigkeit betr√§gt 2 Sekunden, was mehr als zehnmal schneller ist! </font><font style="vertical-align: inherit;">Und wir sprechen von einer einfachen Abfrage f√ºr einen relativ kleinen Datensatz. </font><font style="vertical-align: inherit;">Auf reale Anfragen haben wir bis zu mehreren hundert Mal Wachstum erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusammenfassend: Wenn Sie PostgreSQL mit FDW verwenden, √ºberpr√ºfen Sie immer, ob alle Filter an den Remote-Server gesendet wurden, und Sie werden zufrieden sein ... Zumindest bis Sie zu den Verkn√ºpfungen zwischen Tabellen von verschiedenen Servern gelangen. </font><font style="vertical-align: inherit;">Aber das ist die Geschichte f√ºr einen anderen Artikel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank f√ºr Ihre Aufmerksamkeit! </font><font style="vertical-align: inherit;">Ich w√ºrde mich freuen, Fragen, Kommentare sowie Geschichten √ºber Ihre Erfahrungen in den Kommentaren zu h√∂ren.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498002/index.html">Taschenanleitung zum Z3</a></li>
<li><a href="../de498004/index.html">Workstation in einem Docker-Container</a></li>
<li><a href="../de498006/index.html">Wahl eines Patentanwalts</a></li>
<li><a href="../de498012/index.html">Mikrotik RouterOS in Docker mit Qemu</a></li>
<li><a href="../de498014/index.html">PyDERASN: Als ich Big-Data-Unterst√ºtzung hinzuf√ºgte</a></li>
<li><a href="../de498020/index.html">Etwa ein Indikator f√ºr die visuelle Beurteilung schnell wachsender Funktionen</a></li>
<li><a href="../de498022/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 341 (vom 13. bis 19. April)</a></li>
<li><a href="../de498024/index.html">St√§dte mit einem Mausklick mit Houdini und Python bauen</a></li>
<li><a href="../de498026/index.html">FOSS News Nr. 12 - √úberpr√ºfung der kostenlosen und Open Source-Nachrichten f√ºr den 13. bis 19. April 2020</a></li>
<li><a href="../de498028/index.html">Python COVID-19-Pandemiesimulation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>