<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙌🏽 🤘 🧝🏻 Windows通知機能：最も文書化されていない攻撃面 👩🏿‍🔧 😖 ✋🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="カットの下には、BlackHat 2018カンファレンスでAlex IonescuとGabrielle Vialaが発表したプレゼンテーション「The Windows Notification Facility：The Most Undocumented Kernel Attack Surface ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windows通知機能：最も文書化されていない攻撃面</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459626/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カットの下には</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、BlackHat 2018カンファレンス</font></a><font style="vertical-align: inherit;">で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Alex Ionescu</font></a><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Gabrielle Viala</font></a><font style="vertical-align: inherit;">が</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発表し</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た</font><strong><font style="vertical-align: inherit;">プレゼンテーション</font></strong><font style="vertical-align: inherit;">「The Windows Notification Facility：The Most Undocumented Kernel Attack Surface Yet」の</font><font style="vertical-align: inherit;">翻訳があり</font><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<img src="https://habrastorage.org/webt/ja/q7/pl/jaq7plcphybdtfljwzxxdryln8q.png"> <img src="https://habrastorage.org/webt/fi/sw/fe/fiswfev1j4ndustfitqdyvruxis.jpeg"></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版物で議論されること</font></font></b><div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Windows Notification Facility (WNF)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  (State Names) WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> API   (ntdll)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> API   (Ex)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     WNF</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a></li>
</ul></div></div><a name="habracut"></a><br>
<a name="what"></a><br>
<h3 id="chto-takoe-windows-notification-facility-wnf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows通知機能（WNF）とは</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windowsの通知機能の上に構築されています（カーネルとユーザーモードの両方で利用可能）通知メカニズム、ある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版社、加入者</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデル</font><font style="vertical-align: inherit;">（</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のpubsub</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パブリッシャー/サブスクライバー）。</font><font style="vertical-align: inherit;">このメカニズムはWindows 8で追加されました。一部は、OSの長期にわたる設計上の制限を解決するためですが、iOS / Androidと同様のプッシュ通知の実装の基礎としても機能するはずでした。</font></font></p><br>
<p>    ,   <em></em> (  —  ) ,      .   ,         ,      .   ,   ,   ""  .</p><br>
<p>    :</p><br>
<ul>
<li>   </li>
<li>   </li>
<li>   ( 4- )   </li>
<li>      (thread-pool)     </li>
<li> ,            <abbr title="随意アクセス制御リスト">DACL</abbr> / <abbr title="システムアクセス制御リスト">SACL</abbr></li>
</ul><br>
<a name="why"></a><br>
<h3 id="pochemu-poyavilsya-wnf">  WNF</h3><br>
<p>  :  ,     ,          .    , Autochk ( <abbr title="ファイルシステムの整合性チェック">fsck</abbr>  Windows)      VolumesSafeForWriteAccess.           .</p><br>
<p>    ,  Autochk    ,     ,   .  :     sleep(),   ,      —  .</p><br>
<p>     Windows    .      ,  .       ?</p><br>
<p> WNF    ,       ,   - ,   Autochk  ,     ,        .</p><br>
<a name="state_name"></a><br>
<h3 id="imena-sostoyaniy-state-names-wnf">  (State Names) WNF</h3><br>
<p>  WNF   —  64-  .    —      .    <em></em>, <em> </em>, <em> </em>, <em>  </em>  <em>  </em>.</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">WNF_STATE_NAME_INTERNAL</span>
{</span>
    ULONG64 Version:<span class="hljs-number">4</span>;<font></font>
    ULONG64 NameLifetime:<span class="hljs-number">2</span>;<font></font>
    ULONG64 DataScope:<span class="hljs-number">4</span>;<font></font>
    ULONG64 PermanentData:<span class="hljs-number">1</span>;<font></font>
    ULONG64 Unique:<span class="hljs-number">53</span>;<font></font>
} WNF_STATE_NAME_INTERNAL, *PWNF_STATE_NAME_INTERNAL;</code></pre><br>
<p>    ,    -XOR' 64-     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WNF_STATE_KEY 0x41C64E6DA3BC0074</span></code></pre><br>
<a name="lifetime"></a><br>
<h4 id="vremya-zhizni-lifetime-imeni-sostoyaniya">  (Lifetime)  </h4><br>
<p>  WNF   (WNF_STATE_NAME_LIFETIME):</p><br>
<ul>
<li> (well-known)</li>
<li> (permanent)</li>
<li> (persistent)</li>
<li> (temporary)</li>
</ul><br>
<p>       ,      :</p><br>
<ul>
<li>    HKLM\SYSTEM\CurrentControlSet\Control\Notifications</li>
<li>    HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Notifications</li>
<li>    HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\VolatileNotifications</li>
</ul><br>
<p>     :   .            .           SeCreatePermanentPrivilege (    ).      -,      .</p><br>
<a name="scope"></a><br>
<h4 id="oblast-vidimosti-scope-dannyh">  (Scope) </h4><br>
<p>          WNF,          .      :</p><br>
<ul>
<li></li>
<li></li>
<li> </li>
<li></li>
<li></li>
</ul><br>
<p>   ,   WNF             .  (       )     .  TCB    (cross-scope)     WNF.</p><br>
<p>  ""    ""    .      (    ).        ID   (session ID).         SID  .          EPROCESS.</p><br>
<a name="sequence"></a><br>
<h4 id="poryadkovye-nomera-sequence-numbers">  (Sequence Numbers)</h4><br>
<p>  ,      51-  .  (well-known)       4-  ,   21      .         "SequenceNumber".        ,     .          (per-silo)    PspHostSiloGlobals-&gt;WnfSiloState.</p><br>
<p> Microsoft   WNF  "" ,    ,           .  —  nt!WNF_BOOT_DIRTY_SHUTDOWN,    0x1589012fa3bc0875.  XOR'    <abbr title="0x41C64E6DA3BC0074">WNF_STATE_KEY</abbr>   0x544f4f4200000801,     :</p><br>
<pre><code class="plaintext hljs">BOOT1, Well-Known Lifetime, System Scope, Version 1</code></pre><br>
<a name="syscall"></a><br>
<h3 id="sistemnye-vyzovy-dlya-raboty-s-wnf">     WNF</h3><br>
<p>         WNF,       WNF,        WNF.</p><br>
<a name="register"></a><br>
<h4 id="registraciya-imeni-sostoyaniya-wnf">   WNF</h4><br>
<p>    (   ),   WNF       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">NTSTATUS
<span class="hljs-title">ZwCreateWnfStateName</span> <span class="hljs-params">(
    _Out_ PWNF_STATE_NAME StateName,
    _In_ WNF_STATE_NAME_LIFETIME NameLifetime,
    _In_ WNF_DATA_SCOPE DataScope,
    _In_ BOOLEAN PersistData,
    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="hljs-comment">//     </span>
    _In_ ULONG MaximumStateSize, <span class="hljs-comment">//   4- </span>
    _In_ PSECURITY_DESCRIPTOR SecurityDescriptor <span class="hljs-comment">// **  </span>
)</span></span>;</code></pre><br>
<p>    ZwDeleteWnfStateName         ( ,  ).</p><br>
<a name="publishing"></a><br>
<h4 id="publikaciya-dannyh-sostoyaniya-wnf">   WNF</h4><br>
<p>       WNF,     ZwUpdateWnfStateData:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">NTSTATUS
<span class="hljs-title">ZwUpdateWnfStateData</span> <span class="hljs-params">(
    _In_ PCWNF_STATE_NAME StateName,
    _In_reads_bytes_opt_(Length) <span class="hljs-keyword">const</span> VOID* Buffer,
    _In_opt_ ULONG Length, <span class="hljs-comment">//   ,   MaximumSize,   </span>
    _In_opt_ PCWNF_TYPE_ID TypeId, <span class="hljs-comment">//     </span>
    _In_opt_ <span class="hljs-keyword">const</span> PVOID ExplicitScope, <span class="hljs-comment">//  , SID ,  (ID) </span>
    _In_ WNF_CHANGE_STAMP MatchingChangeStamp, <span class="hljs-comment">//    </span>
    _In_ LOGICAL CheckStamp <span class="hljs-comment">//        </span>
)</span></span>;</code></pre><br>
<p>  ()    WNF     ZwDeleteWnfStateData.</p><br>
<a name="consuming"></a><br>
<h4 id="poluchenie-dannyh-sostoyaniya-wnf">   WNF</h4><br>
<p> ,       WNF      (    Update):</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">NTSTATUS
<span class="hljs-title">ZwQueryWnfStateData</span> <span class="hljs-params">(
    _In_ PCWNF_STATE_NAME StateName,
    _In_opt_ PCWNF_TYPE_ID TypeId,
    _In_opt_ <span class="hljs-keyword">const</span> VOID* ExplicitScope,
    _Out_ PWNF_CHANGE_STAMP ChangeStamp,
    _Out_writes_bytes_to_opt_(*BufferSize, *BufferSize) PVOID Buffer,
    _Inout_ PULONG BufferSize <span class="hljs-comment">//   0,      </span>
)</span></span>;</code></pre><br>
<p>    ,  API- Update  Query     <u></u>   WNF.       (      ),        !</p><br>
<a name="notifications"></a><br>
<h4 id="uvedomleniya-wnf"> WNF</h4><br>
<p>    ,   ,     .    <em> </em>,       (     -).</p><br>
<p>-,       ZwSetWnfProcessNotificationEvent.     ZwSubscribeWnfStateChange,   ,       .     :</p><br>
<ul>
<li>   (data notifications):<br>
<ul>
<li>0x01 —  </li>
<li>0x10 —  </li>
</ul></li>
<li>- (meta metanotifications)<br>
<ul>
<li>0x02 —  ,     (Data Subscriber)</li>
<li>0x04 —  ,  - (Meta Subscriber)</li>
<li>0x08 —  ,      - (Generic Subscriber)</li>
</ul></li>
</ul><br>
<p>   ,   .   ,    ,    ZwGetCompleteWnfStateSubscription,   WNF_DELIVERY_DESCRIPTOR.</p><br>
<p>    API-   ( Gabi   ):         .</p><br>
<a name="rtl"></a><br>
<h3 id="vysokourovnevoe-api-polzovatelskogo-rezhima-ntdll"> API   (ntdll)</h3><br>
<p>    ,  ,  Rtl-  ntdll.dll    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">NTSTATUS
<span class="hljs-title">RtlSubscribeWnfStateChangeNotification</span> <span class="hljs-params">(
    _Outptr_ PWNF_USER_SUBSCRIPTION* Subscription,
    _In_ WNF_STATE_NAME StateName,
    _In_ WNF_CHANGE_STAMP ChangeStamp,
    _In_ PWNF_USER_CALLBACK Callback,
    _In_opt_ PVOID CallbackContext,
    _In_opt_ PCWNF_TYPE_ID TypeId,
    _In_opt_ ULONG SerializationGroup,
    _In_opt_ ULONG Unknown
)</span></span>;</code></pre><br>
<p>,      :     ntdll.dll  .</p><br>
<p>   WNF_DELIVERY_DESCRIPTOR     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span> <span class="hljs-params">(*PWNF_USER_CALLBACK)</span> <span class="hljs-params">(
    _In_ WNF_STATE_NAME StateName,
    _In_ WNF_CHANGE_STAMP ChangeStamp,
    _In_opt_ PWNF_TYPE_ID TypeId,
    _In_opt_ PVOID CallbackContext,
    _In_ PVOID Buffer,
    _In_ ULONG BufferSize)</span></span>;</code></pre><br>
<p>     ,    ,      RtlpWnfProcessSubscriptions.       WNF_NAME_SUBSCRIPTION,    LIST_ENTRY.   WNF_NAME_SUBSCRIPTION,   ,     LIST_ENTRY     WNF_USER_SUBSCRIPTION     .</p><br>
<a name="kernel"></a><br>
<h3 id="vysokourovnevoe-api-urovnya-yadra-ex"> API   (Ex)</h3><br>
<p>WNF          (    ):     ,     API-     (Ex-).</p><br>
<p> ExSubscribeWnfStateChange     ,        + ,    .      ,  ,  ,      .</p><br>
<p> ExQueryWnfStateData        . ,     ,    ExQueryWnfStateData,   ,   .</p><br>
<p>    ,      WNF (  )    WNF_SUBSCRIPTION.         ,  Callback  Context,           ntdll.dll.</p><br>
<a name="data"></a><br>
<h3 id="struktury-dannyh-wnf">  WNF</h3><br>
<p><img src="https://habrastorage.org/webt/sj/wk/ne/sjwknenp1z89s3xldzz5jlvzidi.jpeg"><br>
<u><em> </em></u>:   .</p><br>
<a name="analyze"></a><br>
<h3 id="utility-analiza-wnf">  WNF</h3><br>
<p><u><em> </em></u>:    ,      Alex',    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Gabrielle Viala</a>.  ,       WnfCom.   Gabrielle      WNF (    ).    ,  ,   pdf  (   )    . :</p><br>
<ul>
<li>       : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Windows Notification Facility: Peeling the Onion of the Most Undocumented Kernel Attack Surface Yet</a> (  Gabrielle ~19:27).  (  )    ,       !wnf ( — ,   The NT Insider — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Fixing Broken Debugger Extensions</a>)</li>
<li> Gabrielle     (,     ) — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Playing with the Windows Notification Facility (WNF)</a>,        .</li>
</ul><br>
<p><u><em>   </em></u>:  -       Gabrielle          — welcome.   /        github (     ).</p><br>
<a name="wnfcom"></a><br>
<h4 id="wnfcom">WnfCom</h4><br>
<p>WnfCom  python- (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   github</a>),      WNF.  :</p><br>
<ul>
<li> /    </li>
<li>     (  <em></em>)</li>
<li>    <em></em> ,         </li>
</ul><br>
<p> :</p><br>
<pre><code class="python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> wnfcomimport Wnfcom
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfserver = Wnfcom()
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfserver.CreateServer()<font></font>
[SERVER] StateNamecreated: <span class="hljs-number">41</span>c64e6da5559945
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfserver.Write(<span class="hljs-string">b"potatosoup"</span>)<font></font>
Encoded Name: <span class="hljs-number">41</span>c64e6da5559945, Clear Name: <span class="hljs-number">6e99931</span>
    Version: <span class="hljs-number">1</span>, Permanent: No, Scope: Machine, Lifetime: Temporary, Unique: <span class="hljs-number">56627</span>
State update: <span class="hljs-number">11</span> bytes written</code></pre><br>
<pre><code class="python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> wnfcomimport Wnfcom
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfclient = Wnfcom()
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfclient.SetStateName(<span class="hljs-string">"41c64e6da5559945"</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>wnfclient.Listen()<font></font>
[CLIENT] Event registered: <span class="hljs-number">440</span>
[CLIENT] Timestamp: <span class="hljs-number">0x1</span> Size: <span class="hljs-number">0xb</span>
    Data:<span class="hljs-number">00000000</span>: <span class="hljs-number">70</span> <span class="hljs-number">6</span>F <span class="hljs-number">74</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">6</span>F <span class="hljs-number">20</span> <span class="hljs-number">73</span>  <span class="hljs-number">6</span>F <span class="hljs-number">75</span> <span class="hljs-number">70</span>                 potato soup</code></pre><br>
<a name="wnfdump"></a><br>
<h4 id="wnfdump">WnfDump</h4><br>
<p>WnfDump    ,   C.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/ionescu007/wnfun</a>,  -  .           WNF:</p><br>
<ul>
<li>-d (<u>D</u>ump)     WNF      .   :<br>
<ul>
<li>-v (<u>V</u>erbose)  ,         WNF;</li>
<li>-s (<u>S</u>ecurity)   — SDDL-    WNF.</li>
</ul></li>
<li>-b (<u>B</u>rute-force)      WNF (      )</li>
<li>-i (<u>I</u>nformation)        WNF</li>
<li>-r (<u>R</u>ead)      WNF</li>
<li>-w (<u>W</u>rite)       WNF</li>
<li>-n (<u>N</u>otification)        WNF (       Edge)</li>
</ul><br>
<a name="surface"></a><br>
<h3 id="poverhnost-ataki-na-wnf">   WNF</h3><br>
<p>   (  )          WNF.</p><br>
<a name="disclosure"></a><br>
<h4 id="raskrytie-privelegirovannyh-dannyh">  </h4><br>
<p>    WNF,   ,   ,     .     ,          .</p><br>
<p>    ,      ,     ,    .   /    MSRC  ,     (  ). :   WNF_AUDC*  4  !</p><br>
<p>    ,        j00ro, taviso,  .    WNF         / .      .<br>
<u><em> </em></u>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Detecting Kernel Memory Disclosure with x86 Emulation and Taint Tracking  Mateusz Jurczyk aka j00ro</a>.</p><br>
<a name="discovering"></a><br>
<h4 id="obnaruzhenie-imen-sostoyaniy-i-razresheniy">    </h4><br>
<p>    ,      ,      .   (well-known),  (permanent)   (persistent)       .         (  ,     :))</p><br>
<p>         ( ,     ).    :      ,    .         ,   <em></em>  .</p><br>
<a name="temporary"></a><br>
<h4 id="obnaruzhenie-vremennyh-imen-sostoyaniy-i-ih-razresheniy">      </h4><br>
<p>   (temporary)      :    .           (!wnf).          (brute force):</p><br>
<ul>
<li>    1</li>
<li>  (lifetime)    WnfTemporaryStateName</li>
<li> permanent   (       )</li>
<li>  (scope)     4- </li>
</ul><br>
<p>,      51 ! …    ,     .        0   . ,       :       (  0)  ZwQueryWnfStateNameInformation     WnfInfoStateNameExist (,        ).      ,    .</p><br>
<p>    (     )    .      —  !wnf    .   :</p><br>
<ul>
<li>        .</li>
<li>       .   ,     0   ,        .    :       (change stamp).     0xFFFFFFFF:       ,        .</li>
</ul><br>
<p>      ,          -         (Low IL/User/Admin/SYSTEM).</p><br>
<a name="subscribers"></a><br>
<h4 id="perechislenie-podpischikov"> </h4><br>
<p>  WNF_PROCESS_CONTEXT       (LIST_ENTRY)    .      WNF_SUBSCRIPTION.</p><br>
<p>  ,  ,   System.      !list      ,   WNF_SUBSCRIPTION  System.   ,        (CEA.SYS),          .</p><br>
<p>         ,    (Callback)  NULL,      .        ,   RtlpWnfProcessSubscriptions,      WNF_USER_SUBSCRIPTION,        (Callback).  ,    ,  ,      ,     .      (   CEA.SYS  ),          (EventAggregation.dll),       .</p><br>
<a name="sensitive"></a><br>
<h3 id="interesnye-i-chuvstvitelnye-imena-sostoyaniy-wnf">     WNF</h3><br>
<p>       ,     WNF    .</p><br>
<a name="system_state"></a><br>
<h4 id="opredelenie-sostoyaniya-sistemy-i-povedeniya-polzovatelya-s-pomoschyu-wnf">        WNF</h4><br>
<p>  WNF          :</p><br>
<ul>
<li>WNF_WIFI_CONNECTION_STATUS – c  </li>
<li>WNF_BLTH_BLUETOOTH_STATUS — ,   Bluetooth ( WNF_TETH_TETHERING_STATE)</li>
<li>WNF_UBPM_POWER_SOURCE —    (   )</li>
<li>WNF_SEB_BATTERY_LEVEL —    </li>
<li>WNF_CELL_* —  Windows Phone   : , ,  , EDGE  3G, ...</li>
</ul><br>
<p>  WNF         :</p><br>
<ul>
<li>WNF_AUDC_CAPTURE/RENDER —   ( PID),   / </li>
<li>WNF_TKBN_TOUCH_EVENT —    ,      </li>
<li>WNF_SEB_USER_PRESENT/WNF_SEB_USER_PRESENCE_CHANGED —    Windows</li>
</ul><br>
<a name="avoiding"></a><br>
<h4 id="alternativy-standartnym-api-uvedomleniy">  API </h4><br>
<p>  ,        API  ,  API , ,      /.     WNF     . ,  ,   WNF      .</p><br>
<p>: WNF_SHEL_(DESKTOP)_APPLICATION_(STARTED/TERMINATED)      modern- (   ,   )  DCOM,       Win32.      —       ShellExecute:    Explorer,   cmd.exe, ...</p><br>
<p>  ,  WNF    API  ,      :</p><br>
<ul>
<li>WNF_SHEL_LOCKSCREEN_ACTIVE —    </li>
<li>WNF_EDGE_LAST_NAVIGATED_HOST —   URL,    ( )  Edge</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">   :      Edge</b><div class="spoiler_text"><p><img src="https://habrastorage.org/webt/6x/mw/uh/6xmwuhsm2ngnwcg6kpp5htsoxby.gif"></p></div></div><br>
<a name="effect"></a><br>
<h4 id="vozdeystvie-na-sistemu-s-ispolzovaniem-wnf">     WNF</h4><br>
<p>   WNF,        . : WNF_FSRL_OPLOCK_BREAK — ,    (/),  PID'    !</p><br>
<p>      WNF     ,       . : WNF_SHEL_DDC_(WNS/SMS)_COMMAND –   4 ,         .</p><br>
<p> ,     WNF,      . : WNF_CERT_FLUSH_CACHE_TRIGGER (  ), WNF_BOOT_MEMORY_PARTITIONS_RESTORE, WNF_RTDS_RPC_INTERFACE_TRIGGER_CHANGED, ...</p><br>
<a name="inject"></a><br>
<h3 id="vnedrenie-v-process-s-ispolzovaniem-wnf">     WNF</h3><br>
<p>         :</p><br>
<ul>
<li>WriteProcessMemory —   </li>
<li>  ( ) —              </li>
<li>  (Atom) —           </li>
<li>   —  ,   WM_COPYDATA  DDE,      </li>
<li>GUI  —    (   )  ,      </li>
</ul><br>
<p> WNF         :</p><br>
<ul>
<li>      WNF,      (,        )</li>
<li>     Rtl/ZwQueryWnfStateData    WNF</li>
</ul><br>
<p> ,            :</p><br>
<ul>
<li><abbr title="非同期手続き呼び出し">APC</abbr>s</li>
<li>      (Remote Threads)</li>
<li>        (Changing Thread Context)</li>
<li> "<em>window long</em>" —  ,     ,     </li>
</ul><br>
<p>       WNF_USER_SUBSCRIPTION   (     WNF_NAME_SUBSCRIPTION,    RtlpWnfProcessSubscriptions).      ( <abbr title="制御フローガード">CFG</abbr>),         ( 5  6    ).</p><br>
<p>      ,      :    , ,   ,     -.</p><br>
<a name="future"></a><br>
<h3 id="napravleniya-dlya-dalneyshih-issledovaniy">   </h3><br>
<p>   WNF   SEB_,       (<u>S</u>ystem <u>E</u>vents <u>B</u>roker). SystemEventsBrokerServer.dll  SystemEventsBrokerClient.dll   API  . ,      SEB     SEB,     .</p><br>
<p>           CEA.SYS  EventAggregation.dll.    "  " (Event Aggregation Library),     ,      :     ,      ,   WNF             ,         .        WNF,     .        .</p><br>
<hr><br>
<p><u><em> </em></u>:              .</p><br>
<hr><br>
<a name="before"></a><br>
<h3 id="do-prezentacii"> </h3><br>
<p>  ,   Windows Notification Facility     Alex'  Gabrielle.    ( )    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">redp</a>.</p><br>
<p><img src="https://habrastorage.org/webt/kv/jx/xp/kvjxxppelx9k4zjkqbweh8ukkre.jpeg"></p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   WNF</a> (  )   <em>    </em>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">wincheck</a>.  ,      Gabrielle Viala  ,       redp,     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://redplait.blogspot.com/search/label/wnf</a>.</p><br>
<a name="after"></a><br>
<h3 id="posle-prezentacii"> </h3><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PoC</a> (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> github</a>)   explorer (  —  notepad). <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">modexp</a>         :   Callback  WNF_USER_SUBSCRIPTION.      :</p><br>
<ul>
<li>   explorer.exe</li>
<li>   WNF_USER_SUBSCRIPTION</li>
<li>   RWX-     ,  WriteProcessMemory (,     VirtualAllocEx + WriteProcessMemory)</li>
<li>    WNF_USER_SUBSCRIPTION (    WriteProcessMemory)</li>
<li> ntdll!NtUpdateWnfStateData(...)   ,       </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元のハンドラーをWNF_USER_SUBSCRIPTIONに復元し、割り当てられたリソースを解放する</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459616/index.html">MIPTがコンピューターサイエンスとソフトウェアエンジニアリングのロシア初の上級修士プログラムを開始</a></li>
<li><a href="../ja459618/index.html">あまり知られていないdocker-compose機能</a></li>
<li><a href="../ja459620/index.html">TDDx2、BDD、DDD、FDD、MDDおよびPDD、または駆動開発について知りたいこと</a></li>
<li><a href="../ja459622/index.html">セガサターンのゲームは1995年に書かれたので</a></li>
<li><a href="../ja459624/index.html">軍用ドローン</a></li>
<li><a href="../ja459628/index.html">オープンインベンションネットワークには、3,000を超えるライセンシーがいます-オープンソースソフトウェアにとってそれは何を意味しますか</a></li>
<li><a href="../ja459630/index.html">Tic Tac Toeパート2：ステートレスの取り消し/やり直し</a></li>
<li><a href="../ja459638/index.html">バッテリーに関するグローバルな知識ベースを作成する</a></li>
<li><a href="../ja459640/index.html">コードとしてのドキュメント。パート1：更新を自動化する</a></li>
<li><a href="../ja459642/index.html">効率を犠牲にすることなくC ++のレジスタフィールドに安全にアクセス（例としてCortexMを使用）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>