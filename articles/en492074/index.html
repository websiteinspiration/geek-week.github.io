<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî¥ üß° üîØ Gotta go fast. Fast IMAP Email Sync üññüèæ üòÄ ü§ΩüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I'm Ilya. Two years ago, I joined the IMAP mobile client. Earlier versions of the application downloaded the list of letters for a long time an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gotta go fast. Fast IMAP Email Sync</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! I'm Ilya. Two years ago, I joined the IMAP mobile client. Earlier versions of the application downloaded the list of letters for a long time and spent a lot of traffic for updating the mailbox. The question arose about optimizing the work with the protocol and about the capabilities of this protocol in general. I did not know anything about the protocol and plunged into reading the documentation. It turns out that all this time the client used the protocol without a break and did not at all take into account the implementation features. These features helped speed up mail downloads by 2 to 3 times. About what IMAP is and what are the chips for optimizing it later in my article.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not dive into the protocol too deeply. </font><font style="vertical-align: inherit;">An article rather from the category ‚ÄúI would like to read this article two years ago.‚Äù </font><font style="vertical-align: inherit;">IMAP gurus are unlikely to find new information for themselves. </font><font style="vertical-align: inherit;">This article relies on the protocol description from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server connection</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP is a stateful protocol. </font><font style="vertical-align: inherit;">This was a discovery for me, before that I had not seen or worked with such protocols. </font><font style="vertical-align: inherit;">Consider the scheme of working with the server.&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's go in order, and most importantly, with examples. </font><font style="vertical-align: inherit;">First you need to create a connection to the server. </font><font style="vertical-align: inherit;">To do this, use the openSSL library.</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, the connection is established and you can observe the OK response with a line that starts with the CAPABILITY response</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a convenient </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cheat sheet for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each of CAPABILITY </font><font style="vertical-align: inherit;">, where all possible CAPABILITY values ‚Äã‚Äãare written with links to the RFC. </font><font style="vertical-align: inherit;">For example, IMAP4rev1 tells the client that the server is working according to the IMAP4 standard, and IDLE signals that you can subscribe to changes that occur in the mailbox.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server authorization</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After connecting to the server, you need to go to your mailbox. </font><font style="vertical-align: inherit;">This is done using the LOGIN command.</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, stop, login, I understand, and a1 what is this? </font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perhaps you ask. </font><font style="vertical-align: inherit;">And this is the team tag. </font><font style="vertical-align: inherit;">In the interests of the client, the tags should be different, since the response arrives with the same tag as the request, which means that it can be matched for parsing between teams. </font><font style="vertical-align: inherit;">The server can also return a response with an asterisk at the beginning, such as * OK, this is called an untagged response. </font><font style="vertical-align: inherit;">Basically, such an answer is returned for teams that expect several entities in the response, for example, LIST.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folder List Request</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To request a list of letters in a folder, you must first find out these folders. </font><font style="vertical-align: inherit;">This is done by the LIST command. </font><font style="vertical-align: inherit;">This command returns a list of folders on the server.</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST ¬´¬ª *<font></font>
* LIST (\HasNoChildren \Trash) ¬´/¬ª Trash<font></font>
* LIST (\HasNoChildren \Sent) ¬´/¬ª Sent<font></font>
* LIST (\HasNoChildren \Drafts) ¬´/¬ª Drafts<font></font>
* LIST (\HasNoChildren \Junk) ¬´/¬ª Junk<font></font>
* LIST (\HasNoChildren) ¬´/¬ª INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first parameter in the command is namespace. If the server supports namespace, then its values ‚Äã‚Äãcan be requested using the NAMESPACE query. The standard namespace looks like an empty string. Next, the wildcards parameter comes into play. With it, we can tell the server which folders we need to return. For example, we can get: a folder tree branch, only roots, or just everything, as in the example above. It‚Äôs better not to do this, because who knows how many folders the user has in the box. The authors of the protocol recommend using ‚Äú%‚Äù - in this case you will get all the top-level folders from the mailbox.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the answer, we understand that this is an untagged answer where each line is your folder in the box. </font><font style="vertical-align: inherit;">First, there are flags by which we read the folder‚Äôs meta-information, for example, in the example all folders have no descendants and some special-purpose folders (such as Trash, Junk, etc.). </font><font style="vertical-align: inherit;">Next comes the folder separator character. </font><font style="vertical-align: inherit;">This symbol is used for subfolders. </font><font style="vertical-align: inherit;">For example, for a descendant of the Trash folder, the name would look like ‚ÄúTrash / New Folder‚Äù. </font><font style="vertical-align: inherit;">After all the folders, the server will return OK to us with the tag that we assigned to the command and the execution time of this command.&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folder selection</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further according to the scheme, we must select a folder from which we will tighten our messages. </font><font style="vertical-align: inherit;">This is done using the SELECT command.</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you select a folder, all information about it is returned. </font><font style="vertical-align: inherit;">Let's go in order.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Answer with flags that are allowed inside the folder for letters.&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Answer with flags that the client can change forever</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reply with the number of letters in the folder</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The answer is with the number of recent letters, that is, those that we received between the folder selections</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reply with the number of unread messages</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, for now, let's dwell on this. </font><font style="vertical-align: inherit;">The rest of the information we do not need.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request letters</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the most interesting thing is the request for letters. </font><font style="vertical-align: inherit;">You have to be extremely careful here, especially on mobile clients. </font><font style="vertical-align: inherit;">Agree, it is unlikely that when you enter the application you will receive thousands of messages from the server to your database. </font><font style="vertical-align: inherit;">Moreover, it makes no sense to download the entire letter, since it may not be practical to display, for example, a list of all letters. </font><font style="vertical-align: inherit;">For example, to quickly show the user letters, we will only ask for an "envelope". </font><font style="vertical-align: inherit;">In this envelope we want to see: sender, recipient, subject of the letter and date of sending. </font><font style="vertical-align: inherit;">We will load the first 10 posts.</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The colon enumerates the segment of the numbers of letters that we want to receive, and in parentheses what we want to read from these letters, in this case, the envelope of the letter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will give the answer in abbreviated form:</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is clear that nothing is clear. </font><font style="vertical-align: inherit;">And the thing is that the envelope format is dictated by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 2822.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will not consider it in this article. </font><font style="vertical-align: inherit;">This envelope has all the necessary information: date of receipt of the letter, subject of the letter, sender, recipient, and even messageId. </font><font style="vertical-align: inherit;">His clients use to display a conversation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we were able to show the user basic information about the letter, but what about the body? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can immediately download the entire body of the letter, regardless of its size, this is of course not for long but nonetheless costly over the network and memory. </font><font style="vertical-align: inherit;">By the way, this is done with the same FETCH command.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Try such a command on your inbox, and you will understand what I meant by ‚Äúcostly‚Äù, even with 10 messages we get a fairly voluminous response with absolutely all information about the letter. Speaking of her. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How often did you download the source of the letter in any client you know to see how it looks in its original form? If not, let's get a test letter out of it. In it, I added a picture directly to the letter and a picture as an attachment. Save it in eml format, and then open it with any text editor. Depending on the client, you will receive different sources of the letter, but in general they will be similar.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the email header:</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=¬ª--=_Part_722_554093397.1567975288¬ª<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All meta-information is described in the header of the letter, from whom, to whom, when, type of message content, subject and priority of the letter. </font><font style="vertical-align: inherit;">The boundary field indicates the boundary of the letter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further understand what this means.</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=¬ª--=_Part_583_946112260.1567975288¬ª<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=¬ª--=_Part_881_599167713.1567975288¬ª<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=¬´utf-8¬ª<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=¬´utf-8¬ª<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D¬´font-family: XO Tahion; font-size: 16px; direction: ltr¬ª&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=¬´2018-09-04 22.46.36.jpg¬ª<font></font>
Content-Disposition: inline; filename=¬´2018-09-04 22.46.36.jpg¬ª<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each boundary is the usual border of a piece of writing. </font><font style="vertical-align: inherit;">They begin with two hyphens "-". </font><font style="vertical-align: inherit;">The closing border has these two hyphens at the end. </font><font style="vertical-align: inherit;">It is described in more detail in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC1341.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This can be called the main part of the letter, parts of the letter and their MIME types are described here.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About MIME Types</font></font></b><div class="spoiler_text">MIME-   ,     MIME (<i>Multipurpose Internet Mail Extensions) </i>     email .&nbsp;<br>
<br>
<ul>
<li>multipart/mixed         ,             .&nbsp;</li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We do not have simple text here, so it‚Äôs more logical to take an html representation. In this html-representation there is just a picture, with the parameter Content-Disposition: inline, that is, it is located directly in the body of the letter, and not in the attached documents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The link to this picture is not quite simple. It is described by the Content-ID parameter, which is equal to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is a link to the next part of the letter - a picture that is encoded in base-64. To save my nerves, I did not include all the base-64 code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last part of the letter has the form&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=¬´2018-07-02 11.08.23 pm.png¬ª<font></font>
Content-Disposition: attachment; filename=¬´2018-07-02 11.08.23 pm.png¬ª<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
which already has Content-Disposition not inline, like the image above, but attachment. </font><font style="vertical-align: inherit;">This image should just go to the file attachment panel, by the way it is also encoded in base-64 and has a large size. </font><font style="vertical-align: inherit;">Here it becomes clear that you should not once again load the entire body of the letter if we want to show only basic information.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Back to the protocol</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After working on the letters, you need to close the selected folder and say goodbye to the server. </font><font style="vertical-align: inherit;">To close the folder, we need to enter the CLOSE command. </font><font style="vertical-align: inherit;">Yes, it‚Äôs so simple</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, if you worked with the console in parallel with me and read the article, then a not-so-pleasant event could have happened, the server could close your connection by timeout. </font><font style="vertical-align: inherit;">This is completely normal, and each server has its own timeout, for example, we have 30 minutes.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, it is recommended to do the NOOP command in the background</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It literally does nothing, but allows you to keep the connection without a timeout as much as we need. </font><font style="vertical-align: inherit;">If you currently select a folder, NOOP can work as a periodic request for changes to this folder&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here in the response we are notified of two deleted messages, one new and that the number of messages in this folder is 16 472. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I also note that you can work with only one selected folder, there is no parallel work here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, in the end, close the session with the server and we will say goodbye to it.</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see the sad untagged BYE answer, which means it's time to finish the job.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quick sync with CONDSOTORE and QRESYNC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can use the NOOP operation to track changes in a box in a selected folder. But what if we want to find out what has changed in the folder while we were working with another? The most obvious option is to sort through all the letters in the local storage, whether it be a cache or a database, and compare with what the server will return. On the one hand, this is indeed a solution, and on some servers it will be literally the only true one. On the other hand, we want to show letters as fast as the protocol generally allows. Fortunately, our server supports protocol extensions such as CONDSTORE and QRESYNC, which were added to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The first one adds a special 63-bit number to the message and folder, called the mod-sequence, which increases with each operation on this letter. The highest mod-sequence among all messages is added to the folder. As a result, each time you connect to a folder on a server that supports CONDSTORE, we can easily find out if something has changed or not, simply by comparing the mod-sequence values ‚Äã‚Äãfor the local and server folders. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, this extension adds additional parameters for the STORE and FETCH commands - CHANGEDSINCE mod-sequence and UNCHANGEDSINCE mod-sequence, which allow you to perform an operation if the mod-sequence of transmitted messages is larger and smaller than this, respectively. Let's look at an example.</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I simulated a situation in which we go into the mailbox and did not know anything about it before, that is, our local mod-sequence is 0. As you can see, the server returns to us generally all the messages that are in the mailbox, since before that we did not receive anything and don‚Äôt know anything about the box. In response to a request for UID letters from CHANGEDSINCE, an untagged response OK also comes with a HIGHESTMODESEQ which we will now save, and for each message our MODSEQ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will </font><font style="vertical-align: inherit;">carry </font><font style="vertical-align: inherit;">out some operations with the mailbox: add new letters, change the flags. Let's make a new request but with the previous mod-sequence</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and we already see the difference, instead of outputting 20 old and new communities that just arrived (asterisk in 17221: * means to take letters from number 17221 to the maximum possible) we receive letters whose MODSEQ is greater than the previous one. This helps quite well to synchronize a folder in which we have not been for some time and get a sort of cast of the changed letters, instead of trying all possible ones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem, much better? But QRESYNC makes the synchronization operation even faster, it allows you to specify the MODSEQ parameters and the message UIDs known to us right during the folder selection. Let's explain with an example. First, QRESYNC must be enabled with the ENABLE command.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
since we did not know anything about the folder before that, the server returns only information about the folder to us, without a nugget of its changes. Suppose we asked the first twenty messages and remembered their UID and also HIGHESTMODESEQ. We leave the folder, send ourselves a message, delete the message, change the flags and return with the past information about the folder</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, when choosing a changed folder, we immediately get a nugget of changes, in the form of a response VANISHED (EARLIER) for messages that were deleted, and FETCH for messages that were added or changed. Now it‚Äôs even easier to synchronize the folder if the user has not visited it for a long time. This is a very cool way if you have a bunch of messages stored locally in the cache and you don‚Äôt want to compare them with messages on the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first parameter of this request is UIDVALIDITY, which is essentially used to verify that the uid that you received previously did not change in the folder. This can happen if the server changes session uid from session to session for all messages or the folder was deleted and a folder with the same name was created in its place.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second parameter is the HIGHESTMODSEQ known to us and the last is the interval of known UIDs, they can be written as a colon, if the interval is continuous, or separated by a comma.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my example, I came across a situation where ignorance of the subject area leads to incorrect and suboptimal operation of the application. </font><font style="vertical-align: inherit;">I did not cover all possible options for using the protocol with this article. </font><font style="vertical-align: inherit;">But I hope for the next developer of the IMAP client the information above will be useful. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP has a ton of interesting stuff. </font><font style="vertical-align: inherit;">Commands for quick synchronization is just the beginning, in fact, you can further optimize different IMAP commands, depending on the capabilities of the server, and make working with mail faster, more economical on network and memory, and generally more pleasant. </font><font style="vertical-align: inherit;">But I will talk about this later.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492058/index.html">ROS2 vs ROS1. Installing ROS2 on Ubuntu 18.04</a></li>
<li><a href="../en492060/index.html">How to solve? "ECONNREFUSED - connection refused by server"</a></li>
<li><a href="../en492062/index.html">Golang backend server template - part 1 (HTTP server)</a></li>
<li><a href="../en492066/index.html">Why Event Sourcing is the antipattern for microservices interaction</a></li>
<li><a href="../en492068/index.html">S7 Group opens a department ‚ÄúInformation Technologies in Aviation‚Äù at MIPT</a></li>
<li><a href="../en492076/index.html">An example of hexagonal architecture in Java</a></li>
<li><a href="../en492078/index.html">The most important and useful materials on the coronavirus COVID-19</a></li>
<li><a href="../en492082/index.html">How to simplify the management of home devices and secure them (share ideas about Kauri Safe Smart Home)</a></li>
<li><a href="../en492086/index.html">Coronavirus vs Russian IT-business: are companies ready to transfer employees to a remote location?</a></li>
<li><a href="../en492088/index.html">Testing the Amazon Lumberyard game engine. Approaches and Tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>