<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃🏻 🧝🏾 🧚🏿 Fonctionne avec la carte SD via l'interface SPI. Implémentation VHDL 👩🏽‍🔬 ☠️ 🚴🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Habr! Une fois au travail, j'ai eu la tâche d'évaluer la possibilité d'implémenter le stockage de données sur une carte SD lors de sa connexion ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fonctionne avec la carte SD via l'interface SPI. Implémentation VHDL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salut Habr! </font><font style="vertical-align: inherit;">Une fois au travail, j'ai eu la tâche d'évaluer la possibilité d'implémenter le stockage de données sur une carte SD lors de sa connexion à un FPGA. </font><font style="vertical-align: inherit;">L'utilisation de SPI a été supposée comme interface d'interaction, car elle est plus facile à mettre en œuvre. </font><font style="vertical-align: inherit;">Je voudrais partager l'expérience acquise.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/qw/p6/gaqwp6tekmw-myhnjrsmwo5cam8.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que l'espace sur la carte de circuit imprimé est toujours limité, la prise en compte des cartes SD sera effectuée sur l'exemple des cartes au format microSD.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Spécifications de lecture </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 Informations générales </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialisation </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Effacement des informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Lecture des informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Lecture d'un bloc de données </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Lecture de plusieurs blocs de données </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Écriture d'informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Écriture d'un bloc de données </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Écriture de plusieurs blocs de données </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Mise en œuvre de l'algorithme en matériel </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Composante de la couche physique </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Composante du niveau de commande </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Composante de communication avec le monde extérieur </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Vérification matérielle </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Résultats</font></font></a><br>
<br>
<a name="SpecRead"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Spécifications de lecture</font></font></h2><br>
<a name="GeneralInformation"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 Général</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une lecture rapide de la spécification nous indique les options de carte SD suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le transfert de données vers la carte SD s'effectue sur une seule ligne; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la lecture des données d'une carte SD s'effectue sur une seule ligne; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mode SPI, la puissance ne peut être que de + 3,3 V; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fréquence d'horloge en mode d'initialisation dans la plage de 100 à 400 kHz;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fréquence d'horloge après l'initialisation - 25 MHz.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela implique immédiatement le point sur la bande passante de crête théorique: 25 MHz * 1 bit = 25 Mb / s, ce qui est </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un peu</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> petit. </font><font style="vertical-align: inherit;">La seconde moins l'utilisation de cartes SD, puissance + 3,3V. </font><font style="vertical-align: inherit;">Sur la carte de circuit imprimé sur laquelle il était prévu d'installer la carte SD, il n'y a pas une telle tension. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes au format MicroSD peuvent être divisées en 3 catégories par capacité:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDSC </font><font style="vertical-align: inherit;">Capacité de la carte jusqu'à 2 Go inclus. </font><font style="vertical-align: inherit;">L'adresse à l'intérieur de la carte est un octet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDHC. </font><font style="vertical-align: inherit;">La capacité de la carte est supérieure à 2 Go et jusqu'à 32 Go inclus. </font><font style="vertical-align: inherit;">L'adresse à l'intérieur de la carte indique un bloc de 512 octets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDXC. </font><font style="vertical-align: inherit;">La capacité de la carte est supérieure à 32 Go et jusqu'à 128 To inclus. </font><font style="vertical-align: inherit;">L'adresse à l'intérieur de la carte indique un bloc de 512 octets.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vue générale de la carte est illustrée dans la figure ci-dessous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/qo/4d/wpqo4dulzwlonas-3evcspttvra.png"><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numéro de contact</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nom</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un type</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La description</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non utilisé</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sélection de jetons</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DI</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de données de l'appareil maître (MOSI)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tension d'alimentation</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCLK</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vss</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terre</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FAIRE</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de données vers le périphérique maître (MISO)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non utilisé</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion s'effectue selon le schéma ci-dessous: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/jl/xj/eyjlxjhgg_iucbvd0ms-gzmjinu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les résistances doivent être calibrées à 50 kOhm</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Après la mise sous tension, la carte SD est en mode SDIO. </font><font style="vertical-align: inherit;">Pour passer en mode SPI, vous devez effectuer l'initialisation. </font><font style="vertical-align: inherit;">Le protocole pour travailler avec la carte implique l'utilisation d'un schéma de contrôle pour le transfert correct des données et des commandes sous la forme d'un algorithme CRC. </font><font style="vertical-align: inherit;">En fonctionnement en mode SPI, la vérification CRC est désactivée par défaut. </font><font style="vertical-align: inherit;">Ainsi, la première commande envoyée à la carte pour faire passer la carte en mode SPI doit contenir la valeur CRC correcte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les commandes transmises via l'interface SPI ont une taille de 48 bits. </font><font style="vertical-align: inherit;">Format de commande:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 47 (le plus à gauche) contient toujours la valeur 0. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 46 contient toujours la valeur 1.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les bits 45 à 40 contiennent l'index de commande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bits 39..8 contiennent les arguments de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bits 7..1 contiennent le CRC des bits précédents. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 0 contient toujours la valeur 1.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les bits 47 et 46 donnent à la carte la possibilité de suivre sans ambiguïté le début d'une transaction, car le bus MOSI au repos est égal à un. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/ap/8n/ddap8nsdyqcbqezjudom42bzfx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les commandes utilisées lors de l'utilisation de la carte SD recevront des réponses telles que R1, R3, R7. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/xq/ce/btxqcevcwggh9qgt6pxznanb0pc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une réponse de type R1, taille 8 bits. </font></font></sub><font style="vertical-align: inherit;"><sub><font style="vertical-align: inherit;">Type de réponse R3, taille 40 bits. </font></sub><sub><font style="vertical-align: inherit;">Type de réponse R7, taille 40 bits. </font></sub><font style="vertical-align: inherit;">
Toutes les commandes et leurs réponses sont détaillées dans la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">spécification simplifiée de la couche physique.</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/mu/dg/yb/mudgybpndrbrqpsz5icwgkb1prk.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/s-/vq/a8/s-vqa83la-g6k3bwgvvmmfoawms.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<a name="Init"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialisation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme d'initialisation:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après la mise sous tension, attendez au moins 1 ms.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Générez un minimum de 74 commutations d'horloge pour la carte. </font><font style="vertical-align: inherit;">Les lignes CS et MOSI doivent être à l'état d'unité logique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Générez la commande CMD0. </font><font style="vertical-align: inherit;">La commande CMD0 réinitialise la carte SD.</font></font></li>
<li>    CMD0.     R1.  ,   R1    16   ,    3.   R1   ,     0x01 (     ),    3,     5. </li>
<li>  CMD8.            . </li>
<li>    CMD8.     R7.  ,     ,    ,    7, ,           ,    17,    13. </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    7,    9. </li>
<li>  ACMD41.  ACMD41  ,    SDSC ( 0x00000000)    . </li>
<li>    ACMD41.     R1.      ,    ,    11. ,    0x00 ( )    14,       7.</li>
<li>  CMD1.  CMD1   ACMD41.</li>
<li>    CMD1.     R1.       ,    ,    13, ,    0x00 ( ),    14,       11.</li>
<li> .   ,   .      . </li>
<li>  CMD16.          ,  512 . </li>
<li>    CMD16.     R1.  ,    0x00 (  )    16,    13. </li>
<li>   .       .   . </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    17,    19. </li>
<li>  ACMD41.   ACMD41.  ACMD41  ,    SDHC ( 0x40000000)    .</li>
<li>    ACMD41.     R1.      ,    ,    13. ,    0x00 ( )    21,       17. </li>
<li>  CMD58.    . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une réponse à la commande CMD58. </font><font style="vertical-align: inherit;">La réponse est une réponse de type R3. </font><font style="vertical-align: inherit;">Si un bit est défini dans la réponse que la carte fonctionne avec des adresses de bloc de 512 octets, passez à l'étape 16, sinon à l'étape 14.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois l'initialisation terminée, la carte peut être exploitée par blocs de 512 octets avec une fréquence d'horloge de 25 MHz. </font><font style="vertical-align: inherit;">Il s'agit de la version complète de l'algorithme d'initialisation, qui couvre tous les types de cartes. </font><font style="vertical-align: inherit;">Dans mon cas, lors de l'utilisation d'une carte de 16 Go, l'algorithme d'initialisation consistait en les étapes 1-6, 17-22, 16.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/vp/di/pw/vpdipwdy4umv4iahsea1g2snruu.png"></a></div>
                    </div><br>
<a name="Erase"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Effacement des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes micro SD format prennent en charge les commandes d'effacement. </font><font style="vertical-align: inherit;">Après la commande d'effacement, la valeur des adresses d'effacement spécifiées sera remplie par la valeur 0xFF ou 0x00, selon la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme d'effacement des informations</font></font><br>
<br>
<ol>
<li>  CMD32.        .</li>
<li>    CMD32.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,     . </li>
<li>  CMD33.        .        ,        CMD32. </li>
<li>    CMD33.     R1.       0x00 ( -    ),    3,    6 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD38. </font><font style="vertical-align: inherit;">La commande pour effacer les informations des blocs sélectionnés. </font><font style="vertical-align: inherit;">4 octets doivent être envoyés comme argument, à l'exception des valeurs 0x00000001, 0x00000002.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une réponse à la commande CMD38. </font><font style="vertical-align: inherit;">La réponse est une réponse de type R1b. </font><font style="vertical-align: inherit;">Il s'agit d'une version étendue de la réponse lorsque la carte génère une réponse R1, puis dessine la ligne MISO à zéro, indiquant que la puce est occupée. </font><font style="vertical-align: inherit;">Il faut attendre que la valeur unitaire apparaisse sur la ligne MISO. </font><font style="vertical-align: inherit;">Si la réponse n'est pas 0x00 (il y a eu une erreur lors de l'exécution de la commande), passez à l'étape 3, sinon à l'étape 8</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Achèvement de l'algorithme d'effacement. </font></font></li>
</ol><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/hm/qs/cq/hmqscqj62emd9yp30prqqasyjjm.png"></a></div>
                    </div><br>
<a name="Read"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Lecture des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lecture des informations d'une carte SD via SPI est possible de deux manières.</font></font><br>
<br>
<a name="ReadOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Lecture d'un seul bloc de données</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la lecture d'un bloc de données, le dispositif maître génère une commande pour que la carte SD lise un bloc de données, attend une réponse indiquant que la commande a été traitée et attend un paquet contenant des données de la carte. </font><font style="vertical-align: inherit;">Après avoir reçu un paquet contenant des données de la carte, la transaction de lecture se termine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/oe/q_/g_oeq_mpttrajxmeltmmb5hpl28.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue générale d'une transaction lisant un bloc de données. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, une telle option a été mise en œuvre, mais la vitesse résultante a été très contrariée (les comparaisons de vitesse seront plus faibles).</font></font><br>
<br>
<a name="ReadMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Lecture de plusieurs blocs de données</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la lecture de plusieurs blocs de données, le périphérique maître génère une commande pour que la carte SD lise plusieurs blocs de données, attend une réponse indiquant que la commande a été traitée et attend un paquet de données de la carte. </font><font style="vertical-align: inherit;">Après avoir envoyé un paquet de données, la carte envoie le prochain paquet de données. </font><font style="vertical-align: inherit;">Cela continuera jusqu'à ce qu'une commande soit reçue du périphérique maître pour terminer la lecture. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/ed/tz/aiedtzc1nfh__byzfhuozjnstjc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue générale d'une transaction lisant de nombreux blocs de données. </font></font></sub><br>
<br>
<img src="https://habrastorage.org/webt/i8/ko/9l/i8ko9lasfzqwjehte6q6yg8bs1w.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure des paquets de données</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Où:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton de données </font><font style="vertical-align: inherit;">La commande de lecture utilise la valeur 0xFE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloc de données. </font><font style="vertical-align: inherit;">Contient des données lues sur la carte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contient la somme de contrôle des champs précédents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une erreur s'est produite lors de la lecture, la carte au lieu du jeton de données renvoie un jeton d'erreur. </font><font style="vertical-align: inherit;">Erreur La taille du jeton est de 1 octet. </font><font style="vertical-align: inherit;">Les bits 7..5 contiennent une valeur de zéro, les bits 4..0 codent le type d'erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme de lecture de plusieurs blocs de données:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD18. </font><font style="vertical-align: inherit;">La commande indique à la carte que plusieurs blocs seront lus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une réponse à la commande CMD18. </font><font style="vertical-align: inherit;">La réponse est une réponse de type R1. </font><font style="vertical-align: inherit;">Si la réponse n'est pas 0x00 (il y a eu une erreur lors de l'exécution de la commande), passez à l'étape 3, sinon à l'étape 4.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'erreur. </font><font style="vertical-align: inherit;">La lecture a échoué, en quittant l'algorithme de lecture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'un jeton de la carte. </font><font style="vertical-align: inherit;">Si un jeton d'erreur est reçu de la carte, passez à l'étape 3, sinon passez à l'étape 5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez d'une carte de bloc de données une taille de 512 octets. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez de la carte un champ CRC de 2 octets. </font></font></li>
<li>    .     ,    8,    4. </li>
<li>  CMD12.       .  ,       Data Packet,   . </li>
<li>     CMD12.     R1b.     R1,         MISO  ,   .      MISO  ,      .       0x00 ( -    ),    3,    10.</li>
<li>  . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une légère nuance dans l'algorithme de lecture. </font><font style="vertical-align: inherit;">Le signal de sélection de puce (CS) doit être mis à zéro logique avant de générer la commande CMD18 et mis à un logique après avoir reçu une réponse à la commande CMD12.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/ht/8f/uf/ht8fufwcf9qq-bdrif-4chjd5cg.png"></a></div>
                    </div><br>
<a name="Write"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Enregistrement des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'écriture d'informations sur la carte SD via l'interface SPI est possible en deux versions.</font></font><br>
<br>
<a name="WriteOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Écriture d'un seul bloc de données</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'enregistrement d'un bloc de données, l'appareil maître génère une commande pour que la carte SD écrive un bloc de données, attend une réponse de la carte indiquant que la commande a été traitée, transmet un paquet de données à enregistrer sur la carte, attend une réponse de la carte que les données sont écrites, termine la transaction. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/j5/7f/u1j57f-xmwqesdk1yzw_fenwvmi.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue générale d'une transaction d'écriture d'un bloc de données. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pour la lecture, un enregistrement d'un bloc de données a été initialement mis en œuvre. </font><font style="vertical-align: inherit;">Les résultats de vitesse n'étaient pas satisfaisants.</font></font><br>
<br>
<a name="WriteMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Écriture de plusieurs blocs de données</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'enregistrement de plusieurs blocs de données, le dispositif maître génère une commande pour enregistrer plusieurs blocs de données, attend une réponse de la carte indiquant que la commande a été traitée, transmet un paquet de données à enregistrer sur la carte, attend une réponse de la carte que les données sont enregistrées. </font><font style="vertical-align: inherit;">Après avoir reçu une réponse principale, l'appareil transmet un paquet avec les données suivantes pour l'enregistrement sur la carte. </font><font style="vertical-align: inherit;">Cela continuera jusqu'à ce que l'appareil maître envoie un jeton de données d'arrêt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/l7/fz/-pl7fz2rfyuv5akb7ksrcwdipsy.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue générale d'une transaction d'écriture pour plusieurs blocs de données. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure du paquet de données est similaire à la structure du paquet de données lors de la lecture des données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton de données </font><font style="vertical-align: inherit;">Pour la commande d'écriture, la valeur 0xFC est utilisée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloc de données. </font><font style="vertical-align: inherit;">Contient des données écrites sur la carte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contient la somme de contrôle des champs précédents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le jeton Stop Tran utilisé pour exécuter la commande d'écriture a une taille de 1 octet et est égal à 0xFD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après que le dernier bit du paquet de données a été inséré dans la carte, la carte répond à l'horloge suivante avec l'état de l'enregistrement de données - Réponse de données. </font><font style="vertical-align: inherit;">La réponse des données a une taille de 1 octet, les bits 7..5 peuvent être quelconques, le bit 4 est toujours nul, le bit 0 est toujours égal à un, les bits 3..1 codent l'état de l'enregistrement de données. </font><font style="vertical-align: inherit;">Une fois que la carte a renvoyé le paquet de données, la carte trace la ligne MISO à zéro, indiquant que la carte est occupée. </font><font style="vertical-align: inherit;">Une fois que le niveau d'unité logique est sur la ligne MISO, vous pouvez transférer le prochain paquet de données sur la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme d'enregistrement de plusieurs blocs de données:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD25. </font><font style="vertical-align: inherit;">La commande indique à la carte que plusieurs blocs seront écrits.</font></font></li>
<li>    CMD25.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,   . </li>
<li>   . </li>
<li>   512   . </li>
<li>    CRC  2 . </li>
<li> Data Response  .       ,    3,    8. </li>
<li>   .     ,    9,    4. </li>
<li> Stop Tran Token.   ,     . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une réponse de la carte. </font><font style="vertical-align: inherit;">La carte sur le jeton Stop Tran trace la ligne MISO à zéro, indiquant que la carte est occupée. </font><font style="vertical-align: inherit;">Il faut attendre sur la ligne MISO la valeur unitaire qui indiquera la fin de la commande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'achèvement de l'algorithme d'enregistrement. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi une petite nuance dans l'algorithme d'enregistrement. </font><font style="vertical-align: inherit;">Le signal de sélection de puce (CS) doit être mis à zéro logique avant de générer la commande CMD25 et mis à un logique après avoir reçu une réponse au jeton Stop Tran</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/_9/kt/ts/_9kttsrffln_gmvgw-l4ch0ekva.png"></a></div>
                    </div><br>
<a name="Hardware"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Implémentation de l'algorithme dans le matériel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de la lecture de la spécification, nous obtenons certaines caractéristiques de l'algorithme qui doivent être implémentées dans le matériel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modes de fonctionnement possibles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formation de fréquence initiale. </font><font style="vertical-align: inherit;">Les lignes CS et MOSI doivent être à l'état d'unité logique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transférez les données sur une carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez des données d'une carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente de l'achèvement de l'équipe. </font><font style="vertical-align: inherit;">Il est utilisé lorsque, après avoir généré une réponse, la carte SD ramène la ligne MISO à zéro afin d'attendre l'apparition d'une unité.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez la réponse lors de l'écriture des données. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendre un jeton lors de la lecture des données. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modes d'horloge possibles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge à initialiser. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge pour le travail. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De mon point de vue, l'algorithme est implémenté de manière optimale en utilisant trois composants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le composant de la couche physique, qui est connecté directement à la carte SD, génère des signaux SCLK, CS, DI, lit avec DO. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un composant de niveau commande qui prépare toutes les données pour un composant de la couche physique. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un composant de communication avec le monde extérieur qui cache tout le dispositif interne et fournit une interface pour les commandes (lecture, écriture, effacement) et les données.</font></font></li>
</ul><br>
<a name="HwPhy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Composante de la couche physique</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SDPhy <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Control bus</span>
			iPhyTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">9</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyMode	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">4</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyTxWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>; 
			<span class="hljs-comment">-- Out Data</span>
			oPhyRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>); <font></font>
			oPhyRxWrite	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyCmdEnd	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> ); 
<span class="hljs-keyword">end</span> SDPhy;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où:</font></font><br>
<br>
<ul>
<li> iPhyTxData    ,  iPhyMode  ,    . </li>
<li>iPhyTxWrite ,    iPhyTxData  iPhyMode . </li>
<li>oPhyTxReady ,      .     FULL FIFO,    .</li>
<li>oPhyRxData   ,   SD-.</li>
<li>oPhyRxWrite ,     oPhyRxData . </li>
<li>oPhyCmdEnd ,     .</li>
<li>oSdCS    (CS)  SD-. </li>
<li>oSdClk    SD-.</li>
<li>oSdMosi     SD-.</li>
<li>oSdMosiT        SD-.</li>
<li>iSdMiso     SD-. </li>
<li>sclk      SD- (50 ).</li>
<li>pclk  ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premier signal de réinitialisation, niveau un actif.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les FPGA, il existe des unités spéciales pour travailler avec un signal d'horloge (PLL, MMCM), cependant, la réception d'un signal d'horloge inférieur à 5 MHz de leur sortie est problématique. </font><font style="vertical-align: inherit;">En conséquence, la couche physique fonctionne à une fréquence de 50 MHz. </font><font style="vertical-align: inherit;">Avec chaque donnée du signal iPhyMode, un bit est reçu qui indique à quelle fréquence ces données doivent être transférées sur la carte SD (ou reçues de celle-ci). </font><font style="vertical-align: inherit;">Selon le bit de vitesse, des signaux d'activation d'horloge sont générés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux automates sont implémentés dans le composant de la couche physique, pour transférer des données vers une carte SD et recevoir des données de celle-ci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code machine pour le transfert de données: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état SDummy fournit une mise en forme de fréquence initiale, 128 commutations. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le statut STxBits permet le transfert de données vers la carte SD. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de la machine pour recevoir des données: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état sRxBits assure la réception des données de la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état sBusy garantit que la carte SD est prête (la carte libère la ligne MISO au niveau de l'unité). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état sResp implémente la lecture de la réponse lors de l'écriture de données. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état sToken implémente une attente de jeton lors de la lecture des données. </font></font></li>
</ul><br>
<a name="HwCmd"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Composant de niveau commande</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdCommand <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Command from host</span>
			oSdInitComp	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStartErase	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartRead	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdCmdFinish	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdhcPresent	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Data</span>
			oSdReadData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdDataR	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdWriteData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdDataW	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">32</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitComp signe la fin de l'initialisation de la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signe oSdInitFail de l'échec de l'initialisation. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adresse iSdAddress sur la carte SD pour exécuter la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartErase démarre l'exécution de la commande d'effacement. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartRead démarre la lecture de l'exécution de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartWrite démarre l'exécution de la commande d'écriture. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'achèvement de l'équipe oSdCmdFinish. </font><font style="vertical-align: inherit;">Le bit zéro est égal à un, la commande s'est terminée avec succès. </font><font style="vertical-align: inherit;">Le premier bit est un, la commande s'est terminée avec une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicateur de détection de carte SDHC / SDXC oSdhcPresent. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdReadData Lire les données à écrire sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Données iSdDataR pour l'écriture sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau oSdWriteData pour écrire les données lues sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Données oSdDataW lues sur une carte SD.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les signaux restants coïncident avec les signaux de la couche physique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le composant dispose de 5 machines automatiques.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdInit ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - initialisation de la carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdErase ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - efface les données d'une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdRead ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - lire les données d'une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdWrite ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - écrire des données sur une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdCommand ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - sur la base des fonctionnalités générées prépare les données pour la couche physique de toutes les machines précédentes.</font></font></li>
</ul><br>
<a name="HwHost"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Composante de communication avec le monde extérieur</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdHost <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Sd Host command</span>
			iSdCommand	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">2</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStart	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdStatus	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Write data to card</span>
			iSdTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdTxValid	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdTxLast	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Read data from card</span>
			oSdRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdRxValid	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdRxLast	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdRxReady	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de commande iSdCommand à exécuter. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdAddress est l'adresse pour exécuter la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécution de la commande de démarrage iSdStart. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'achèvement de l'équipe oSdStatus. </font><font style="vertical-align: inherit;">Le bit zéro est égal à un - la commande est terminée. </font><font style="vertical-align: inherit;">Le premier bit est un - la commande s'est terminée avec une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signe oSdInitFail de l'échec de l'initialisation. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxData. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour écrire des données sur une carte SD. </font><font style="vertical-align: inherit;">Port avec données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxValid. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour écrire des données sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signal d'écriture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxLast. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour écrire des données sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe du dernier dw dans les données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdTxReady. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour écrire des données sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe de disponibilité pour recevoir des données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxData. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les données d'une carte SD. </font><font style="vertical-align: inherit;">Port avec données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxValid. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les données d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signal d'écriture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxLast. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les données d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe du dernier dw dans les données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdRxReady. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les données d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe de disponibilité pour recevoir des données.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les signaux restants coïncident avec les signaux de la couche physique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le composant implémente une machine smSdControl ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">État ralenti. </font><font style="vertical-align: inherit;">En attente d'initialisation et de fin de commande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'état de sWaitCmd. </font><font style="vertical-align: inherit;">Vérification du type de commande.</font></font></li>
<li>sReadCmd.    FIFO,   ,     SD-      . </li>
<li>sWriteCmd. ,   FIFO      SD-,      . </li>
<li>sEraseCmd.     . </li>
<li>sWaitEnd.       . </li>
<li>sFinish.   ,  . </li>
</ul><br>
<a name="RealTest"></a><h2>3.   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme est écrit, vérifié dans le simulateur. </font><font style="vertical-align: inherit;">Il faut vérifier maintenant en fer. </font><font style="vertical-align: inherit;">A partir de ce qui était disponible, la carte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zybo de Digilent est arrivée,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
elle dispose de bornes FPGA gratuites dans une banque avec une tension de + 3,3V, à laquelle vous pouvez facilement connecter un appareil externe. </font><font style="vertical-align: inherit;">Oui, et le type de FPGA utilisé est le Zynq-7000, ce qui signifie qu'il y a un cœur de processeur. </font><font style="vertical-align: inherit;">Vous pouvez écrire un test en C, ce qui simplifiera la tâche de test. </font><font style="vertical-align: inherit;">
Ainsi, nous connectons l'algorithme implémenté au cœur du processeur via le port GP (un fonctionnement sur 4 octets est possible, similaire à </font><abbr title="Programmed input/output"><font style="vertical-align: inherit;">PIO</font></abbr><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Nous ne nous soucierons pas des interruptions; nous mettons en œuvre un sondage temporisé. </font><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme d'enregistrement des données sera le suivant:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/oe/oy/nj/oeoynjbbxwco9wrihj-f3unb3cs.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><abbr title="Entrée / sortie programmée"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez le code de commande 2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écrivez les données dans un tampon situé en logique programmable. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réinitialiser l'état d'achèvement de l'équipe.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test implémenté:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress ++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data write to %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Write data to PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		Xil_Out32(<span class="hljs-number">0x43c00014</span>, cntrData);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationWrite += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxWrite )<font></font>
	{<font></font>
		MaxWrite = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la question de savoir pourquoi la limite extérieure de 1024 est utilisée dans la boucle. Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de blocs est fixé à 8. La</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> taille d'un bloc est de 512 octets. </font><font style="vertical-align: inherit;">La taille totale de 8 blocs de données est de 8 * 512 octets = 4096 octets. </font><font style="vertical-align: inherit;">Le bus entre le module processeur et la logique programmable a une taille de 4 octets. </font><font style="vertical-align: inherit;">Il s'avère que pour envoyer 4096 octets de 4 octets du module processeur à la logique programmable, il est nécessaire d'effectuer 4096/4 = 1024 opérations d'écriture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme de lecture des données sera le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez le code de commande 1. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réinitialiser l'état d'achèvement de l'équipe.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lire les données du tampon en logique programmable. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test implémenté:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data read from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			 <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in read \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	 <span class="hljs-comment">/** Duration operation */</span><font></font>
	 durationRead += cntrDuration;<font></font>
<font></font>
	 <span class="hljs-keyword">if</span> (cntrDuration &gt; MaxRead )<font></font>
	 {<font></font>
		 MaxRead = cntrDuration;<font></font>
	 }<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Read data from PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c0001c</span>);
		<span class="hljs-keyword">if</span> (DataR != cntrData)<font></font>
		{<font></font>
			xil_printf(<span class="hljs-string">"Data corrupt! \n\r"</span>);<font></font>
		}<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c00020</span>);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme d'effacement des données sera le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définissez le code de commande 4. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réinitialiser l'état d'achèvement de l'équipe.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test implémenté:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data erase from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">4</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write! \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationErase += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxErase )<font></font>
	{<font></font>
		MaxErase = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testez complètement sur github.</font></font></a><br>
<br>
<a name="Results"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Résultats</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quantité de données</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En train de lire </font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Record</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effacer </font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 bloc (512 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,7 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,36 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,58 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 blocs (4096 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15,4 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6,38 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,66 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 blocs (8192 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18,82 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,26 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9,79 Mbps</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une carte de 16 Go a été utilisée. </font><font style="vertical-align: inherit;">Pendant le test, 2 Go de données ont été enregistrés, 2 Go de données ont été lus et 2 Go de données ont été effacés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les conclusions sont décevantes. </font><font style="vertical-align: inherit;">Lorsque vous utilisez FPGA, cela n'a aucun sens d'utiliser la carte SD en mode SPI, sauf dans le cas où il est très nécessaire de stocker de grandes quantités de données sans présenter de contraintes de vitesse.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495388/index.html">Émission de télévision des années 1970 qui est devenue un ancêtre de l'eSport</a></li>
<li><a href="../fr495390/index.html">STM32CubeMonitor mérite un essai</a></li>
<li><a href="../fr495392/index.html">Comment rechercher des bugs sur le front-end: 4 étapes principales</a></li>
<li><a href="../fr495396/index.html">Première impression de concepts</a></li>
<li><a href="../fr495398/index.html">Ro.Ri.Re</a></li>
<li><a href="../fr495402/index.html">L'année dernière, nous avons finalement photographié un trou noir. Maintenant quoi?</a></li>
<li><a href="../fr495404/index.html">Les stocks affaissés sont-ils prometteurs? Analysons avec python</a></li>
<li><a href="../fr495408/index.html"># 02 - Et un octet entier ne suffit pas ... | La croix des changements</a></li>
<li><a href="../fr495412/index.html">Norbert Wiener. Une personne intéressante. Collègues, ennemis, lutte pour l'indépendance</a></li>
<li><a href="../fr495414/index.html">Conséquences de la peur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>