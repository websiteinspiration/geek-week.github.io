<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèª üßùüèæ üßöüèø Fonctionne avec la carte SD via l'interface SPI. Impl√©mentation VHDL üë©üèΩ‚Äçüî¨ ‚ò†Ô∏è üö¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Habr! Une fois au travail, j'ai eu la t√¢che d'√©valuer la possibilit√© d'impl√©menter le stockage de donn√©es sur une carte SD lors de sa connexion ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fonctionne avec la carte SD via l'interface SPI. Impl√©mentation VHDL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salut Habr! </font><font style="vertical-align: inherit;">Une fois au travail, j'ai eu la t√¢che d'√©valuer la possibilit√© d'impl√©menter le stockage de donn√©es sur une carte SD lors de sa connexion √† un FPGA. </font><font style="vertical-align: inherit;">L'utilisation de SPI a √©t√© suppos√©e comme interface d'interaction, car elle est plus facile √† mettre en ≈ìuvre. </font><font style="vertical-align: inherit;">Je voudrais partager l'exp√©rience acquise.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/qw/p6/gaqwp6tekmw-myhnjrsmwo5cam8.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que l'espace sur la carte de circuit imprim√© est toujours limit√©, la prise en compte des cartes SD sera effectu√©e sur l'exemple des cartes au format microSD.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Sp√©cifications de lecture </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 Informations g√©n√©rales </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialisation </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Effacement des informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Lecture des informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Lecture d'un bloc de donn√©es </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Lecture de plusieurs blocs de donn√©es </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 √âcriture d'informations </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 √âcriture d'un bloc de donn√©es </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 √âcriture de plusieurs blocs de donn√©es </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Mise en ≈ìuvre de l'algorithme en mat√©riel </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Composante de la couche physique </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Composante du niveau de commande </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Composante de communication avec le monde ext√©rieur </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. V√©rification mat√©rielle </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. R√©sultats</font></font></a><br>
<br>
<a name="SpecRead"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Sp√©cifications de lecture</font></font></h2><br>
<a name="GeneralInformation"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 G√©n√©ral</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une lecture rapide de la sp√©cification nous indique les options de carte SD suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le transfert de donn√©es vers la carte SD s'effectue sur une seule ligne; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la lecture des donn√©es d'une carte SD s'effectue sur une seule ligne; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mode SPI, la puissance ne peut √™tre que de + 3,3 V; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fr√©quence d'horloge en mode d'initialisation dans la plage de 100 √† 400 kHz;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fr√©quence d'horloge apr√®s l'initialisation - 25 MHz.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela implique imm√©diatement le point sur la bande passante de cr√™te th√©orique: 25 MHz * 1 bit = 25 Mb / s, ce qui est </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un peu</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> petit. </font><font style="vertical-align: inherit;">La seconde moins l'utilisation de cartes SD, puissance + 3,3V. </font><font style="vertical-align: inherit;">Sur la carte de circuit imprim√© sur laquelle il √©tait pr√©vu d'installer la carte SD, il n'y a pas une telle tension. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes au format MicroSD peuvent √™tre divis√©es en 3 cat√©gories par capacit√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDSC </font><font style="vertical-align: inherit;">Capacit√© de la carte jusqu'√† 2 Go inclus. </font><font style="vertical-align: inherit;">L'adresse √† l'int√©rieur de la carte est un octet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDHC. </font><font style="vertical-align: inherit;">La capacit√© de la carte est sup√©rieure √† 2 Go et jusqu'√† 32 Go inclus. </font><font style="vertical-align: inherit;">L'adresse √† l'int√©rieur de la carte indique un bloc de 512 octets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDXC. </font><font style="vertical-align: inherit;">La capacit√© de la carte est sup√©rieure √† 32 Go et jusqu'√† 128 To inclus. </font><font style="vertical-align: inherit;">L'adresse √† l'int√©rieur de la carte indique un bloc de 512 octets.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vue g√©n√©rale de la carte est illustr√©e dans la figure ci-dessous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/qo/4d/wpqo4dulzwlonas-3evcspttvra.png"><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Num√©ro de contact</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nom</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un type</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La description</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non utilis√©</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lection de jetons</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DI</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de donn√©es de l'appareil ma√Ætre (MOSI)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tension d'alimentation</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCLK</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contribution</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vss</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terre</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FAIRE</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de donn√©es vers le p√©riph√©rique ma√Ætre (MISO)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non utilis√©</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion s'effectue selon le sch√©ma ci-dessous: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/jl/xj/eyjlxjhgg_iucbvd0ms-gzmjinu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les r√©sistances doivent √™tre calibr√©es √† 50 kOhm</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Apr√®s la mise sous tension, la carte SD est en mode SDIO. </font><font style="vertical-align: inherit;">Pour passer en mode SPI, vous devez effectuer l'initialisation. </font><font style="vertical-align: inherit;">Le protocole pour travailler avec la carte implique l'utilisation d'un sch√©ma de contr√¥le pour le transfert correct des donn√©es et des commandes sous la forme d'un algorithme CRC. </font><font style="vertical-align: inherit;">En fonctionnement en mode SPI, la v√©rification CRC est d√©sactiv√©e par d√©faut. </font><font style="vertical-align: inherit;">Ainsi, la premi√®re commande envoy√©e √† la carte pour faire passer la carte en mode SPI doit contenir la valeur CRC correcte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les commandes transmises via l'interface SPI ont une taille de 48 bits. </font><font style="vertical-align: inherit;">Format de commande:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 47 (le plus √† gauche) contient toujours la valeur 0. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 46 contient toujours la valeur 1.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les bits 45 √† 40 contiennent l'index de commande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bits 39..8 contiennent les arguments de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bits 7..1 contiennent le CRC des bits pr√©c√©dents. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bit 0 contient toujours la valeur 1.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les bits 47 et 46 donnent √† la carte la possibilit√© de suivre sans ambigu√Øt√© le d√©but d'une transaction, car le bus MOSI au repos est √©gal √† un. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/ap/8n/ddap8nsdyqcbqezjudom42bzfx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les commandes utilis√©es lors de l'utilisation de la carte SD recevront des r√©ponses telles que R1, R3, R7. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/xq/ce/btxqcevcwggh9qgt6pxznanb0pc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une r√©ponse de type R1, taille 8 bits. </font></font></sub><font style="vertical-align: inherit;"><sub><font style="vertical-align: inherit;">Type de r√©ponse R3, taille 40 bits. </font></sub><sub><font style="vertical-align: inherit;">Type de r√©ponse R7, taille 40 bits. </font></sub><font style="vertical-align: inherit;">
Toutes les commandes et leurs r√©ponses sont d√©taill√©es dans la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">sp√©cification simplifi√©e de la couche physique.</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/mu/dg/yb/mudgybpndrbrqpsz5icwgkb1prk.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/s-/vq/a8/s-vqa83la-g6k3bwgvvmmfoawms.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<a name="Init"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialisation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme d'initialisation:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s la mise sous tension, attendez au moins 1 ms.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rez un minimum de 74 commutations d'horloge pour la carte. </font><font style="vertical-align: inherit;">Les lignes CS et MOSI doivent √™tre √† l'√©tat d'unit√© logique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rez la commande CMD0. </font><font style="vertical-align: inherit;">La commande CMD0 r√©initialise la carte SD.</font></font></li>
<li>    CMD0.     R1.  ,   R1    16   ,    3.   R1   ,     0x01 (     ),    3,     5. </li>
<li>  CMD8.            . </li>
<li>    CMD8.     R7.  ,     ,    ,    7, ,           ,    17,    13. </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    7,    9. </li>
<li>  ACMD41.  ACMD41  ,    SDSC ( 0x00000000)    . </li>
<li>    ACMD41.     R1.      ,    ,    11. ,    0x00 ( )    14,       7.</li>
<li>  CMD1.  CMD1   ACMD41.</li>
<li>    CMD1.     R1.       ,    ,    13, ,    0x00 ( ),    14,       11.</li>
<li> .   ,   .      . </li>
<li>  CMD16.          ,  512 . </li>
<li>    CMD16.     R1.  ,    0x00 (  )    16,    13. </li>
<li>   .       .   . </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    17,    19. </li>
<li>  ACMD41.   ACMD41.  ACMD41  ,    SDHC ( 0x40000000)    .</li>
<li>    ACMD41.     R1.      ,    ,    13. ,    0x00 ( )    21,       17. </li>
<li>  CMD58.    . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une r√©ponse √† la commande CMD58. </font><font style="vertical-align: inherit;">La r√©ponse est une r√©ponse de type R3. </font><font style="vertical-align: inherit;">Si un bit est d√©fini dans la r√©ponse que la carte fonctionne avec des adresses de bloc de 512 octets, passez √† l'√©tape 16, sinon √† l'√©tape 14.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois l'initialisation termin√©e, la carte peut √™tre exploit√©e par blocs de 512 octets avec une fr√©quence d'horloge de 25 MHz. </font><font style="vertical-align: inherit;">Il s'agit de la version compl√®te de l'algorithme d'initialisation, qui couvre tous les types de cartes. </font><font style="vertical-align: inherit;">Dans mon cas, lors de l'utilisation d'une carte de 16 Go, l'algorithme d'initialisation consistait en les √©tapes 1-6, 17-22, 16.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/vp/di/pw/vpdipwdy4umv4iahsea1g2snruu.png"></a></div>
                    </div><br>
<a name="Erase"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Effacement des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes micro SD format prennent en charge les commandes d'effacement. </font><font style="vertical-align: inherit;">Apr√®s la commande d'effacement, la valeur des adresses d'effacement sp√©cifi√©es sera remplie par la valeur 0xFF ou 0x00, selon la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme d'effacement des informations</font></font><br>
<br>
<ol>
<li>  CMD32.        .</li>
<li>    CMD32.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,     . </li>
<li>  CMD33.        .        ,        CMD32. </li>
<li>    CMD33.     R1.       0x00 ( -    ),    3,    6 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD38. </font><font style="vertical-align: inherit;">La commande pour effacer les informations des blocs s√©lectionn√©s. </font><font style="vertical-align: inherit;">4 octets doivent √™tre envoy√©s comme argument, √† l'exception des valeurs 0x00000001, 0x00000002.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une r√©ponse √† la commande CMD38. </font><font style="vertical-align: inherit;">La r√©ponse est une r√©ponse de type R1b. </font><font style="vertical-align: inherit;">Il s'agit d'une version √©tendue de la r√©ponse lorsque la carte g√©n√®re une r√©ponse R1, puis dessine la ligne MISO √† z√©ro, indiquant que la puce est occup√©e. </font><font style="vertical-align: inherit;">Il faut attendre que la valeur unitaire apparaisse sur la ligne MISO. </font><font style="vertical-align: inherit;">Si la r√©ponse n'est pas 0x00 (il y a eu une erreur lors de l'ex√©cution de la commande), passez √† l'√©tape 3, sinon √† l'√©tape 8</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ach√®vement de l'algorithme d'effacement. </font></font></li>
</ol><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/hm/qs/cq/hmqscqj62emd9yp30prqqasyjjm.png"></a></div>
                    </div><br>
<a name="Read"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Lecture des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lecture des informations d'une carte SD via SPI est possible de deux mani√®res.</font></font><br>
<br>
<a name="ReadOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Lecture d'un seul bloc de donn√©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la lecture d'un bloc de donn√©es, le dispositif ma√Ætre g√©n√®re une commande pour que la carte SD lise un bloc de donn√©es, attend une r√©ponse indiquant que la commande a √©t√© trait√©e et attend un paquet contenant des donn√©es de la carte. </font><font style="vertical-align: inherit;">Apr√®s avoir re√ßu un paquet contenant des donn√©es de la carte, la transaction de lecture se termine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/oe/q_/g_oeq_mpttrajxmeltmmb5hpl28.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue g√©n√©rale d'une transaction lisant un bloc de donn√©es. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, une telle option a √©t√© mise en ≈ìuvre, mais la vitesse r√©sultante a √©t√© tr√®s contrari√©e (les comparaisons de vitesse seront plus faibles).</font></font><br>
<br>
<a name="ReadMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Lecture de plusieurs blocs de donn√©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la lecture de plusieurs blocs de donn√©es, le p√©riph√©rique ma√Ætre g√©n√®re une commande pour que la carte SD lise plusieurs blocs de donn√©es, attend une r√©ponse indiquant que la commande a √©t√© trait√©e et attend un paquet de donn√©es de la carte. </font><font style="vertical-align: inherit;">Apr√®s avoir envoy√© un paquet de donn√©es, la carte envoie le prochain paquet de donn√©es. </font><font style="vertical-align: inherit;">Cela continuera jusqu'√† ce qu'une commande soit re√ßue du p√©riph√©rique ma√Ætre pour terminer la lecture. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/ed/tz/aiedtzc1nfh__byzfhuozjnstjc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue g√©n√©rale d'une transaction lisant de nombreux blocs de donn√©es. </font></font></sub><br>
<br>
<img src="https://habrastorage.org/webt/i8/ko/9l/i8ko9lasfzqwjehte6q6yg8bs1w.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure des paquets de donn√©es</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O√π:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton de donn√©es </font><font style="vertical-align: inherit;">La commande de lecture utilise la valeur 0xFE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloc de donn√©es. </font><font style="vertical-align: inherit;">Contient des donn√©es lues sur la carte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contient la somme de contr√¥le des champs pr√©c√©dents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une erreur s'est produite lors de la lecture, la carte au lieu du jeton de donn√©es renvoie un jeton d'erreur. </font><font style="vertical-align: inherit;">Erreur La taille du jeton est de 1 octet. </font><font style="vertical-align: inherit;">Les bits 7..5 contiennent une valeur de z√©ro, les bits 4..0 codent le type d'erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithme de lecture de plusieurs blocs de donn√©es:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD18. </font><font style="vertical-align: inherit;">La commande indique √† la carte que plusieurs blocs seront lus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une r√©ponse √† la commande CMD18. </font><font style="vertical-align: inherit;">La r√©ponse est une r√©ponse de type R1. </font><font style="vertical-align: inherit;">Si la r√©ponse n'est pas 0x00 (il y a eu une erreur lors de l'ex√©cution de la commande), passez √† l'√©tape 3, sinon √† l'√©tape 4.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'erreur. </font><font style="vertical-align: inherit;">La lecture a √©chou√©, en quittant l'algorithme de lecture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'un jeton de la carte. </font><font style="vertical-align: inherit;">Si un jeton d'erreur est re√ßu de la carte, passez √† l'√©tape 3, sinon passez √† l'√©tape 5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez d'une carte de bloc de donn√©es une taille de 512 octets. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez de la carte un champ CRC de 2 octets. </font></font></li>
<li>    .     ,    8,    4. </li>
<li>  CMD12.       .  ,       Data Packet,   . </li>
<li>     CMD12.     R1b.     R1,         MISO  ,   .      MISO  ,      .       0x00 ( -    ),    3,    10.</li>
<li>  . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une l√©g√®re nuance dans l'algorithme de lecture. </font><font style="vertical-align: inherit;">Le signal de s√©lection de puce (CS) doit √™tre mis √† z√©ro logique avant de g√©n√©rer la commande CMD18 et mis √† un logique apr√®s avoir re√ßu une r√©ponse √† la commande CMD12.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/ht/8f/uf/ht8fufwcf9qq-bdrif-4chjd5cg.png"></a></div>
                    </div><br>
<a name="Write"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Enregistrement des informations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©criture d'informations sur la carte SD via l'interface SPI est possible en deux versions.</font></font><br>
<br>
<a name="WriteOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 √âcriture d'un seul bloc de donn√©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'enregistrement d'un bloc de donn√©es, l'appareil ma√Ætre g√©n√®re une commande pour que la carte SD √©crive un bloc de donn√©es, attend une r√©ponse de la carte indiquant que la commande a √©t√© trait√©e, transmet un paquet de donn√©es √† enregistrer sur la carte, attend une r√©ponse de la carte que les donn√©es sont √©crites, termine la transaction. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/j5/7f/u1j57f-xmwqesdk1yzw_fenwvmi.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue g√©n√©rale d'une transaction d'√©criture d'un bloc de donn√©es. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pour la lecture, un enregistrement d'un bloc de donn√©es a √©t√© initialement mis en ≈ìuvre. </font><font style="vertical-align: inherit;">Les r√©sultats de vitesse n'√©taient pas satisfaisants.</font></font><br>
<br>
<a name="WriteMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 √âcriture de plusieurs blocs de donn√©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'enregistrement de plusieurs blocs de donn√©es, le dispositif ma√Ætre g√©n√®re une commande pour enregistrer plusieurs blocs de donn√©es, attend une r√©ponse de la carte indiquant que la commande a √©t√© trait√©e, transmet un paquet de donn√©es √† enregistrer sur la carte, attend une r√©ponse de la carte que les donn√©es sont enregistr√©es. </font><font style="vertical-align: inherit;">Apr√®s avoir re√ßu une r√©ponse principale, l'appareil transmet un paquet avec les donn√©es suivantes pour l'enregistrement sur la carte. </font><font style="vertical-align: inherit;">Cela continuera jusqu'√† ce que l'appareil ma√Ætre envoie un jeton de donn√©es d'arr√™t. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/l7/fz/-pl7fz2rfyuv5akb7ksrcwdipsy.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue g√©n√©rale d'une transaction d'√©criture pour plusieurs blocs de donn√©es. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure du paquet de donn√©es est similaire √† la structure du paquet de donn√©es lors de la lecture des donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton de donn√©es </font><font style="vertical-align: inherit;">Pour la commande d'√©criture, la valeur 0xFC est utilis√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloc de donn√©es. </font><font style="vertical-align: inherit;">Contient des donn√©es √©crites sur la carte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contient la somme de contr√¥le des champs pr√©c√©dents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le jeton Stop Tran utilis√© pour ex√©cuter la commande d'√©criture a une taille de 1 octet et est √©gal √† 0xFD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s que le dernier bit du paquet de donn√©es a √©t√© ins√©r√© dans la carte, la carte r√©pond √† l'horloge suivante avec l'√©tat de l'enregistrement de donn√©es - R√©ponse de donn√©es. </font><font style="vertical-align: inherit;">La r√©ponse des donn√©es a une taille de 1 octet, les bits 7..5 peuvent √™tre quelconques, le bit 4 est toujours nul, le bit 0 est toujours √©gal √† un, les bits 3..1 codent l'√©tat de l'enregistrement de donn√©es. </font><font style="vertical-align: inherit;">Une fois que la carte a renvoy√© le paquet de donn√©es, la carte trace la ligne MISO √† z√©ro, indiquant que la carte est occup√©e. </font><font style="vertical-align: inherit;">Une fois que le niveau d'unit√© logique est sur la ligne MISO, vous pouvez transf√©rer le prochain paquet de donn√©es sur la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme d'enregistrement de plusieurs blocs de donn√©es:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de la commande CMD25. </font><font style="vertical-align: inherit;">La commande indique √† la carte que plusieurs blocs seront √©crits.</font></font></li>
<li>    CMD25.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,   . </li>
<li>   . </li>
<li>   512   . </li>
<li>    CRC  2 . </li>
<li> Data Response  .       ,    3,    8. </li>
<li>   .     ,    9,    4. </li>
<li> Stop Tran Token.   ,     . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente d'une r√©ponse de la carte. </font><font style="vertical-align: inherit;">La carte sur le jeton Stop Tran trace la ligne MISO √† z√©ro, indiquant que la carte est occup√©e. </font><font style="vertical-align: inherit;">Il faut attendre sur la ligne MISO la valeur unitaire qui indiquera la fin de la commande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'ach√®vement de l'algorithme d'enregistrement. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi une petite nuance dans l'algorithme d'enregistrement. </font><font style="vertical-align: inherit;">Le signal de s√©lection de puce (CS) doit √™tre mis √† z√©ro logique avant de g√©n√©rer la commande CMD25 et mis √† un logique apr√®s avoir re√ßu une r√©ponse au jeton Stop Tran</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme graphique</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/_9/kt/ts/_9kttsrffln_gmvgw-l4ch0ekva.png"></a></div>
                    </div><br>
<a name="Hardware"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Impl√©mentation de l'algorithme dans le mat√©riel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la suite de la lecture de la sp√©cification, nous obtenons certaines caract√©ristiques de l'algorithme qui doivent √™tre impl√©ment√©es dans le mat√©riel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modes de fonctionnement possibles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formation de fr√©quence initiale. </font><font style="vertical-align: inherit;">Les lignes CS et MOSI doivent √™tre √† l'√©tat d'unit√© logique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transf√©rez les donn√©es sur une carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez des donn√©es d'une carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente de l'ach√®vement de l'√©quipe. </font><font style="vertical-align: inherit;">Il est utilis√© lorsque, apr√®s avoir g√©n√©r√© une r√©ponse, la carte SD ram√®ne la ligne MISO √† z√©ro afin d'attendre l'apparition d'une unit√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez la r√©ponse lors de l'√©criture des donn√©es. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendre un jeton lors de la lecture des donn√©es. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modes d'horloge possibles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge √† initialiser. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signal d'horloge pour le travail. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De mon point de vue, l'algorithme est impl√©ment√© de mani√®re optimale en utilisant trois composants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le composant de la couche physique, qui est connect√© directement √† la carte SD, g√©n√®re des signaux SCLK, CS, DI, lit avec DO. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un composant de niveau commande qui pr√©pare toutes les donn√©es pour un composant de la couche physique. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un composant de communication avec le monde ext√©rieur qui cache tout le dispositif interne et fournit une interface pour les commandes (lecture, √©criture, effacement) et les donn√©es.</font></font></li>
</ul><br>
<a name="HwPhy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Composante de la couche physique</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SDPhy <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Control bus</span>
			iPhyTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">9</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyMode	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">4</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyTxWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>; 
			<span class="hljs-comment">-- Out Data</span>
			oPhyRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>); <font></font>
			oPhyRxWrite	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyCmdEnd	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> ); 
<span class="hljs-keyword">end</span> SDPhy;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π:</font></font><br>
<br>
<ul>
<li> iPhyTxData    ,  iPhyMode  ,    . </li>
<li>iPhyTxWrite ,    iPhyTxData  iPhyMode . </li>
<li>oPhyTxReady ,      .     FULL FIFO,    .</li>
<li>oPhyRxData   ,   SD-.</li>
<li>oPhyRxWrite ,     oPhyRxData . </li>
<li>oPhyCmdEnd ,     .</li>
<li>oSdCS    (CS)  SD-. </li>
<li>oSdClk    SD-.</li>
<li>oSdMosi     SD-.</li>
<li>oSdMosiT        SD-.</li>
<li>iSdMiso     SD-. </li>
<li>sclk      SD- (50 ).</li>
<li>pclk  ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premier signal de r√©initialisation, niveau un actif.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les FPGA, il existe des unit√©s sp√©ciales pour travailler avec un signal d'horloge (PLL, MMCM), cependant, la r√©ception d'un signal d'horloge inf√©rieur √† 5 MHz de leur sortie est probl√©matique. </font><font style="vertical-align: inherit;">En cons√©quence, la couche physique fonctionne √† une fr√©quence de 50 MHz. </font><font style="vertical-align: inherit;">Avec chaque donn√©e du signal iPhyMode, un bit est re√ßu qui indique √† quelle fr√©quence ces donn√©es doivent √™tre transf√©r√©es sur la carte SD (ou re√ßues de celle-ci). </font><font style="vertical-align: inherit;">Selon le bit de vitesse, des signaux d'activation d'horloge sont g√©n√©r√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux automates sont impl√©ment√©s dans le composant de la couche physique, pour transf√©rer des donn√©es vers une carte SD et recevoir des donn√©es de celle-ci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code machine pour le transfert de donn√©es: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat SDummy fournit une mise en forme de fr√©quence initiale, 128 commutations. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le statut STxBits permet le transfert de donn√©es vers la carte SD. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de la machine pour recevoir des donn√©es: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat sRxBits assure la r√©ception des donn√©es de la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat sBusy garantit que la carte SD est pr√™te (la carte lib√®re la ligne MISO au niveau de l'unit√©). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat sResp impl√©mente la lecture de la r√©ponse lors de l'√©criture de donn√©es. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat sToken impl√©mente une attente de jeton lors de la lecture des donn√©es. </font></font></li>
</ul><br>
<a name="HwCmd"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Composant de niveau commande</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdCommand <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Command from host</span>
			oSdInitComp	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStartErase	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartRead	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdCmdFinish	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdhcPresent	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Data</span>
			oSdReadData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdDataR	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdWriteData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdDataW	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">32</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitComp signe la fin de l'initialisation de la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signe oSdInitFail de l'√©chec de l'initialisation. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adresse iSdAddress sur la carte SD pour ex√©cuter la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartErase d√©marre l'ex√©cution de la commande d'effacement. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartRead d√©marre la lecture de l'ex√©cution de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartWrite d√©marre l'ex√©cution de la commande d'√©criture. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'ach√®vement de l'√©quipe oSdCmdFinish. </font><font style="vertical-align: inherit;">Le bit z√©ro est √©gal √† un, la commande s'est termin√©e avec succ√®s. </font><font style="vertical-align: inherit;">Le premier bit est un, la commande s'est termin√©e avec une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicateur de d√©tection de carte SDHC / SDXC oSdhcPresent. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdReadData Lire les donn√©es √† √©crire sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donn√©es iSdDataR pour l'√©criture sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau oSdWriteData pour √©crire les donn√©es lues sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donn√©es oSdDataW lues sur une carte SD.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les signaux restants co√Øncident avec les signaux de la couche physique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le composant dispose de 5 machines automatiques.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdInit ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - initialisation de la carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdErase ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - efface les donn√©es d'une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdRead ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - lire les donn√©es d'une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdWrite ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - √©crire des donn√©es sur une carte SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdCommand ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - sur la base des fonctionnalit√©s g√©n√©r√©es pr√©pare les donn√©es pour la couche physique de toutes les machines pr√©c√©dentes.</font></font></li>
</ul><br>
<a name="HwHost"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Composante de communication avec le monde ext√©rieur</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdHost <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Sd Host command</span>
			iSdCommand	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">2</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStart	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdStatus	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Write data to card</span>
			iSdTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdTxValid	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdTxLast	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Read data from card</span>
			oSdRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdRxValid	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdRxLast	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdRxReady	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de commande iSdCommand √† ex√©cuter. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdAddress est l'adresse pour ex√©cuter la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cution de la commande de d√©marrage iSdStart. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut d'ach√®vement de l'√©quipe oSdStatus. </font><font style="vertical-align: inherit;">Le bit z√©ro est √©gal √† un - la commande est termin√©e. </font><font style="vertical-align: inherit;">Le premier bit est un - la commande s'est termin√©e avec une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signe oSdInitFail de l'√©chec de l'initialisation. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxData. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour √©crire des donn√©es sur une carte SD. </font><font style="vertical-align: inherit;">Port avec donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxValid. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour √©crire des donn√©es sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signal d'√©criture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxLast. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour √©crire des donn√©es sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe du dernier dw dans les donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdTxReady. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour √©crire des donn√©es sur une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe de disponibilit√© pour recevoir des donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxData. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les donn√©es d'une carte SD. </font><font style="vertical-align: inherit;">Port avec donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxValid. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les donn√©es d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signal d'√©criture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxLast. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les donn√©es d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe du dernier dw dans les donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdRxReady. </font><font style="vertical-align: inherit;">Interface Axi-Stream pour lire les donn√©es d'une carte SD. </font><font style="vertical-align: inherit;">Port avec un signe de disponibilit√© pour recevoir des donn√©es.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les signaux restants co√Øncident avec les signaux de la couche physique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le composant impl√©mente une machine smSdControl ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtat ralenti. </font><font style="vertical-align: inherit;">En attente d'initialisation et de fin de commande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat de sWaitCmd. </font><font style="vertical-align: inherit;">V√©rification du type de commande.</font></font></li>
<li>sReadCmd.    FIFO,   ,     SD-      . </li>
<li>sWriteCmd. ,   FIFO      SD-,      . </li>
<li>sEraseCmd.     . </li>
<li>sWaitEnd.       . </li>
<li>sFinish.   ,  . </li>
</ul><br>
<a name="RealTest"></a><h2>3.   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme est √©crit, v√©rifi√© dans le simulateur. </font><font style="vertical-align: inherit;">Il faut v√©rifier maintenant en fer. </font><font style="vertical-align: inherit;">A partir de ce qui √©tait disponible, la carte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zybo de Digilent est arriv√©e,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
elle dispose de bornes FPGA gratuites dans une banque avec une tension de + 3,3V, √† laquelle vous pouvez facilement connecter un appareil externe. </font><font style="vertical-align: inherit;">Oui, et le type de FPGA utilis√© est le Zynq-7000, ce qui signifie qu'il y a un c≈ìur de processeur. </font><font style="vertical-align: inherit;">Vous pouvez √©crire un test en C, ce qui simplifiera la t√¢che de test. </font><font style="vertical-align: inherit;">
Ainsi, nous connectons l'algorithme impl√©ment√© au c≈ìur du processeur via le port GP (un fonctionnement sur 4 octets est possible, similaire √† </font><abbr title="Programmed input/output"><font style="vertical-align: inherit;">PIO</font></abbr><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Nous ne nous soucierons pas des interruptions; nous mettons en ≈ìuvre un sondage temporis√©. </font><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme d'enregistrement des donn√©es sera le suivant:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/oe/oy/nj/oeoynjbbxwco9wrihj-f3unb3cs.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><abbr title="Entr√©e / sortie programm√©e"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez le code de commande 2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcrivez les donn√©es dans un tampon situ√© en logique programmable. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©initialiser l'√©tat d'ach√®vement de l'√©quipe.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test impl√©ment√©:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress ++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data write to %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Write data to PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		Xil_Out32(<span class="hljs-number">0x43c00014</span>, cntrData);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationWrite += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxWrite )<font></font>
	{<font></font>
		MaxWrite = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la question de savoir pourquoi la limite ext√©rieure de 1024 est utilis√©e dans la boucle. Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de blocs est fix√© √† 8. La</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> taille d'un bloc est de 512 octets. </font><font style="vertical-align: inherit;">La taille totale de 8 blocs de donn√©es est de 8 * 512 octets = 4096 octets. </font><font style="vertical-align: inherit;">Le bus entre le module processeur et la logique programmable a une taille de 4 octets. </font><font style="vertical-align: inherit;">Il s'av√®re que pour envoyer 4096 octets de 4 octets du module processeur √† la logique programmable, il est n√©cessaire d'effectuer 4096/4 = 1024 op√©rations d'√©criture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme de lecture des donn√©es sera le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez le code de commande 1. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©initialiser l'√©tat d'ach√®vement de l'√©quipe.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lire les donn√©es du tampon en logique programmable. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test impl√©ment√©:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data read from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			 <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in read \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	 <span class="hljs-comment">/** Duration operation */</span><font></font>
	 durationRead += cntrDuration;<font></font>
<font></font>
	 <span class="hljs-keyword">if</span> (cntrDuration &gt; MaxRead )<font></font>
	 {<font></font>
		 MaxRead = cntrDuration;<font></font>
	 }<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Read data from PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c0001c</span>);
		<span class="hljs-keyword">if</span> (DataR != cntrData)<font></font>
		{<font></font>
			xil_printf(<span class="hljs-string">"Data corrupt! \n\r"</span>);<font></font>
		}<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c00020</span>);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous travaillez sur le module processeur, l'algorithme d'effacement des donn√©es sera le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez l'adresse sur la carte SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez le code de commande 4. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez la fin de la commande. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©initialiser l'√©tat d'ach√®vement de l'√©quipe.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test impl√©ment√©:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data erase from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">4</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write! \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationErase += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxErase )<font></font>
	{<font></font>
		MaxErase = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testez compl√®tement sur github.</font></font></a><br>
<br>
<a name="Results"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. R√©sultats</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quantit√© de donn√©es</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En train de lire </font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Record</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effacer </font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 bloc (512 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,7 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,36 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,58 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 blocs (4096 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15,4 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6,38 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,66 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 blocs (8192 octets)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18,82 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,26 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9,79 Mbps</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une carte de 16 Go a √©t√© utilis√©e. </font><font style="vertical-align: inherit;">Pendant le test, 2 Go de donn√©es ont √©t√© enregistr√©s, 2 Go de donn√©es ont √©t√© lus et 2 Go de donn√©es ont √©t√© effac√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les conclusions sont d√©cevantes. </font><font style="vertical-align: inherit;">Lorsque vous utilisez FPGA, cela n'a aucun sens d'utiliser la carte SD en mode SPI, sauf dans le cas o√π il est tr√®s n√©cessaire de stocker de grandes quantit√©s de donn√©es sans pr√©senter de contraintes de vitesse.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495388/index.html">√âmission de t√©l√©vision des ann√©es 1970 qui est devenue un anc√™tre de l'eSport</a></li>
<li><a href="../fr495390/index.html">STM32CubeMonitor m√©rite un essai</a></li>
<li><a href="../fr495392/index.html">Comment rechercher des bugs sur le front-end: 4 √©tapes principales</a></li>
<li><a href="../fr495396/index.html">Premi√®re impression de concepts</a></li>
<li><a href="../fr495398/index.html">Ro.Ri.Re</a></li>
<li><a href="../fr495402/index.html">L'ann√©e derni√®re, nous avons finalement photographi√© un trou noir. Maintenant quoi?</a></li>
<li><a href="../fr495404/index.html">Les stocks affaiss√©s sont-ils prometteurs? Analysons avec python</a></li>
<li><a href="../fr495408/index.html"># 02 - Et un octet entier ne suffit pas ... | La croix des changements</a></li>
<li><a href="../fr495412/index.html">Norbert Wiener. Une personne int√©ressante. Coll√®gues, ennemis, lutte pour l'ind√©pendance</a></li>
<li><a href="../fr495414/index.html">Cons√©quences de la peur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>