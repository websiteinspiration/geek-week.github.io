<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍⚖️ 👩🏽‍🤝‍👨🏿 🔗 OpenwrtルーターでOpenVPNを高速化します。はんだごてとハードな過激主義のない代替バージョン 🧑🏾‍🤝‍🧑🏾 👨🏾‍🚒 🌈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="皆さん、こんにちは。最近、ルーターでOpenVPNを高速化し、暗号化を別のハードウェアに転送する方法に関する長年の記事を読みました。著者と同様のケースがあります。128MBのRAMを備えたTP-Link WDR3500と、トンネルの暗号化に対応できない貧弱なプロセッサです。ただし、はんだごてを使って...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>OpenwrtルーターでOpenVPNを高速化します。はんだごてとハードな過激主義のない代替バージョン</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485876/"><img src="https://habrastorage.org/webt/ua/za/wl/uazawliq9mctkaeu0sra7g-_y8y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
皆さん、こんにちは。最近</font><font style="vertical-align: inherit;">、ルーターでOpenVPNを高速化し、暗号化を別のハードウェアに転送する方法に関する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長年の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">読みました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">著者と同様のケースがあります。128MBのRAMを備えたTP-Link WDR3500と、トンネルの暗号化に対応できない貧弱なプロセッサです。</font><font style="vertical-align: inherit;">ただし、はんだごてを使ってルーターに登りたくはありませんでした。</font><font style="vertical-align: inherit;">カットの下では、事故の場合にOpenVPNをルーターの冗長性を備えた別のハードウェアに移動した私の経験。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TP-Link WDR3500ルーターとOrange Pi Zero H2があります。</font><font style="vertical-align: inherit;">Orange Piが通常モードでトンネルの暗号化を実行するようにして、何かが彼に発生した場合、VPN処理はルーターに返されます。</font><font style="vertical-align: inherit;">ルータのすべてのファイアウォール設定は以前と同様に機能するはずです。</font><font style="vertical-align: inherit;">一般に、一般的に、追加のハードウェアの追加は誰にとっても透過的で見えないものでなければなりません。</font><font style="vertical-align: inherit;">OpenVPNは、ブリッジモード（サーバーブリッジ）のTAPアダプターであるTCPを介して動作します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">決定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USB経由で接続する代わりに、ルーターの1つのポートを使用して、Orange PiでVPNブリッジが存在するすべてのサブネットを取得することにしました。</font><font style="vertical-align: inherit;">鉄片がルーター上のVPNサーバーと同じネットワークに物理的にぶら下がっていることがわかります。</font><font style="vertical-align: inherit;">その後、まったく同じサーバーをOrange Piにレイズし、ルーターに何らかのプロキシを構成して、すべての着信接続を外部サーバーに送信し、Orange Piが停止しているか利用できない場合は、内部フォールバックサーバーに送信します。</font><font style="vertical-align: inherit;">私はHAProxyを取った。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようになります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お客様が来ます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部サーバーが利用できない場合-以前のように、接続は内部サーバーに行きます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能な場合、クライアントはOrange Piを受け入れます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orange Pi上のVPNがパケットを復号化し、それらをルーターに吐き返す</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーターはそれらをどこかにルーティングしています</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装例</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ルーター上にメイン（1）とゲスト（2）の2つのネットワークがあるとします。それぞれに、外部から接続するためのOpenVPNサーバーがあります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク設定</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのポートを介して両方のネットワークを転送する必要があるため、2つのVLANを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルーターの[ネットワーク/スイッチ]セクションで、VLAN（たとえば1と2）を作成し、目的のポートでタグ付きモードで有効にして、新しく作成したeth0.1とeth0.2を対応するネットワークに追加します（たとえば、brigdeに追加）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Orange Piに2つのVLANインターフェイスを作成します（私はArchlinux ARM + netctlを使用しています）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / netctl / vlan-main</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">Description='Main VLAN on eth0'<font></font>
Interface=vlan-main<font></font>
Connection=vlan<font></font>
BindsToInterfaces=eth0<font></font>
VLANID=1<font></font>
IP=no<font></font>
</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / netctl / vlan-guest</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">Description='Guest VLAN on eth0'<font></font>
Interface=vlan-guest<font></font>
Connection=vlan<font></font>
BindsToInterfaces=eth0<font></font>
VLANID=2<font></font>
IP=no<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてすぐに、2つのブリッジを作成します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / netctl / br-main</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">Description="Main Bridge connection"<font></font>
Interface=br-main<font></font>
Connection=bridge<font></font>
BindsToInterfaces=(vlan-main)<font></font>
IP=dhcp<font></font>
</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / netctl / br-guest</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">Description="Guest Bridge connection"<font></font>
Interface=br-guest<font></font>
Connection=bridge<font></font>
BindsToInterfaces=(vlan-guest)<font></font>
IP=dhcp<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4つのプロファイルすべてで自動起動を有効にします（netctl enable）。</font><font style="vertical-align: inherit;">これで、再起動後、Orange Piは必要な2つのネットワークでハングします。</font><font style="vertical-align: inherit;">Orange Piのインターフェイスアドレスは、ルーターの静的リースで構成されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip addr show</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">4: vlan-main@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-main state UP group default qlen 1000<font></font>
    link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff<font></font>
    inet6 fe80::42:f0ff:fef8:23c8/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
<font></font>
5: vlan-guest@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-guest state UP group default qlen 1000<font></font>
    link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff<font></font>
    inet6 fe80::42:f0ff:fef8:23c8/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
<font></font>
6: br-main: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<font></font>
    link/ether 52:c7:0f:89:71:6e brd ff:ff:ff:ff:ff:ff<font></font>
    inet 192.168.1.3/24 brd 192.168.1.255 scope global dynamic noprefixroute br-main<font></font>
       valid_lft 29379sec preferred_lft 21439sec<font></font>
    inet6 fe80::50c7:fff:fe89:716e/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
<font></font>
7: br-guest: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<font></font>
    link/ether ee:ea:19:31:34:32 brd ff:ff:ff:ff:ff:ff<font></font>
    inet 192.168.2.3/24 brd 192.168.2.255 scope global br-guest<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 fe80::ecea:19ff:fe31:3432/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
</code></pre></div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPNセットアップ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、OpenVPNの設定とキーをルーターからコピーします。</font><font style="vertical-align: inherit;">通常、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><i><font style="vertical-align: inherit;">/tmp/etc/openvpn*.confで</font></i><font style="vertical-align: inherit;">取得でき</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。デフォルトでは、openvpnはTAPモードで実行され、server-bridgeはそのインターフェースを非アクティブのままにします。</font><font style="vertical-align: inherit;">これを機能させるには、接続がアクティブになったときに実行されるスクリプトを追加する必要があります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/openvpn/main.conf</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">dev vpn-main<font></font>
dev-type tap<font></font>
<font></font>
client-to-client<font></font>
persist-key<font></font>
persist-tun<font></font>
ca /etc/openvpn/main/ca.crt<font></font>
cert /etc/openvpn/main/main.crt<font></font>
cipher AES-256-CBC<font></font>
comp-lzo yes<font></font>
dh /etc/openvpn/main/dh2048.pem<font></font>
ifconfig-pool-persist /etc/openvpn/ipp_main.txt<font></font>
keepalive 10 60<font></font>
key /etc/openvpn/main/main.key<font></font>
port 443<font></font>
proto tcp<font></font>
push "redirect-gateway"<font></font>
push "dhcp-option DNS 192.168.1.1"<font></font>
server-bridge 192.168.1.3 255.255.255.0 192.168.1.200 192.168.1.229<font></font>
status /tmp/openvpn.main.status<font></font>
verb 3<font></font>
<font></font>
setenv profile_name main<font></font>
script-security 2<font></font>
up /etc/openvpn/vpn-up.sh<font></font>
</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/openvpn/vpn-up.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
ifconfig vpn-<span class="hljs-variable">${profile_name}</span> up<font></font>
brctl addif br-<span class="hljs-variable">${profile_name}</span> vpn-<span class="hljs-variable">${profile_name}</span>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、接続が発生するとすぐに、vpn-mainインターフェイスがbr-mainに追加されます。</font><font style="vertical-align: inherit;">ゲストグリッドについては、server-bridgeのインターフェース名とアドレスまで同じです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部のルーティングとプロキシ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、Orange Piは既に接続を受け入れて、クライアントを必要なネットワークに入れることができます。</font><font style="vertical-align: inherit;">ルーターの着信接続のプロキシを構成するために残ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルーターVPNサーバーを他のポートに転送し、HAProxyルーターに配置して構成します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/haproxy.cfg</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">global<font></font>
        maxconn 256<font></font>
        uid 0<font></font>
        gid 0<font></font>
        daemon<font></font>
<font></font>
defaults<font></font>
        retries 1<font></font>
        contimeout 1000<font></font>
        option splice-auto<font></font>
<font></font>
listen guest_vpn<font></font>
        bind :444<font></font>
        mode tcp<font></font>
        server 0-orange 192.168.2.3:444 check<font></font>
        server 1-local  127.0.0.1:4444 check backup<font></font>
<font></font>
listen main_vpn<font></font>
        bind :443<font></font>
        mode tcp<font></font>
        server 0-orange 192.168.1.3:443 check<font></font>
        server 1-local  127.0.0.1:4443 check backup<font></font>
</code></pre></div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">楽しい</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが計画どおりに進んだ場合、顧客はOrange Piに向けて出発し、ルーターのプロセッサは熱くならず、VPN速度が大幅に向上します。</font><font style="vertical-align: inherit;">この場合、ルーターに登録されているすべてのネットワークルールは引き続き有効です。</font><font style="vertical-align: inherit;">Orange Piで事故が発生した場合、それは落ち、HAProxyはローカルサーバー上のクライアントをラップします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご清聴ありがとうございました。提案や修正は大歓迎です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485866/index.html">Zimbra Open-Source Editionとエンタープライズポータルの統合</a></li>
<li><a href="../ja485868/index.html">教室や教室の照明</a></li>
<li><a href="../ja485870/index.html">サハリンにGameDevはありますか？2.V</a></li>
<li><a href="../ja485872/index.html">そしゃくロジスティック回帰</a></li>
<li><a href="../ja485874/index.html">「Pythonの学習：ゲームプログラミング、データの視覚化、Webアプリケーション」という本。第三版</a></li>
<li><a href="../ja485878/index.html">JetCalcプラットフォームで管理会計を整理するための一連のステップ</a></li>
<li><a href="../ja485882/index.html">このリストをどのように分類するのですか？</a></li>
<li><a href="../ja485884/index.html">中国のレビトロンを設定する方法</a></li>
<li><a href="../ja485886/index.html">Yandex.DirectおよびGoogle広告からの競合他社のキーと広告を無料で解析する方法（および理由）</a></li>
<li><a href="../ja485888/index.html">サーバー要求偽造、ブラインドSSRF操作</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>