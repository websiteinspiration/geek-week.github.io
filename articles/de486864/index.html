<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🏭 👨🏿‍🔧 🙉 Migration von OpenVPN zu WireGuard, um Netzwerke zu einem L2-Netzwerk zusammenzuführen 🎓 👐 💿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich möchte die Erfahrung der Kombination von Netzwerken in drei geografisch abgelegenen Wohnungen teilen, in denen Router mit OpenWRT jeweils als Gate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Migration von OpenVPN zu WireGuard, um Netzwerke zu einem L2-Netzwerk zusammenzuführen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte die Erfahrung der Kombination von Netzwerken in drei geografisch abgelegenen Wohnungen teilen, in denen Router mit OpenWRT jeweils als Gateway zu einem gemeinsamen Netzwerk verwendet werden. </font><font style="vertical-align: inherit;">Bei der Auswahl einer Methode zum Kombinieren von Netzwerken zwischen L3 mit dem Routing von Subnetzen und L2 mit Bridging, wenn sich alle Knoten des Netzwerks im selben Subnetz befinden, wurde die zweite Methode bevorzugt, die schwieriger zu konfigurieren war, aber mehr Möglichkeiten bot, da das Netzwerk transparente Technologien verwenden sollte Wake-on-Lan und DLNA.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 1: Hintergrund</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPN wurde ursprünglich als Protokoll für die Implementierung dieser Aufgabe ausgewählt, da zum einen ein Tap-Gerät erstellt werden kann, das problemlos zur Bridge hinzugefügt werden kann, und zum anderen unterstützt OpenVPN den TCP-Protokollbetrieb, was ebenfalls wichtig war, da Keine der Wohnungen hatte eine dedizierte IP-Adresse, und ich konnte STUN nicht verwenden, da mein Provider aus irgendeinem Grund eingehende Verbindungen über UDP aus ihren Netzwerken blockiert, während TCP es mir ermöglichte, den Port des VPN-Servers an weiterzuleiten geleaste VPS mit SSH. Ja, dieser Ansatz ist sehr belastend, da die Daten zweimal verschlüsselt werden. Ich wollte jedoch kein VPS in mein privates Netzwerk eingeben, da das Risiko bestand, dass Dritte die Kontrolle darüber erlangenEin solches Gerät im Heimnetzwerk zu haben, war äußerst unerwünscht und es wurde beschlossen, die Sicherheit mit einem hohen Overhead zu bezahlen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Port auf dem Router weiterzuleiten, auf dem der Server bereitgestellt werden sollte, wurde das Programm sshtunnel verwendet. Ich werde die Feinheiten seiner Konfiguration nicht beschreiben - dies ist recht einfach, ich stelle nur fest, dass seine Aufgabe darin bestand, den TCP-Port 1194 vom Router an VPS weiterzuleiten. Als nächstes wurde der OpenVPN-Server auf dem tap0-Gerät konfiguriert, das in der br-lan-Brücke landete. Nachdem ich die Verbindung zu dem Server überprüft hatte, den Sie gerade vom Laptop aus erstellt hatten, wurde klar, dass sich die Idee der Portweiterleitung ausgezahlt hatte und mein Laptop Mitglied des Routernetzwerks wurde, obwohl ich physisch nicht dort war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Angelegenheit blieb klein: Es war notwendig, IP-Adressen in verschiedenen Wohnungen zu verteilen, damit sie nicht in Konflikt gerieten, und Router als OpenVPN-Clients zu konfigurieren. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgenden Router-IP-Adressen und DHCP-Serverbereiche wurden ausgewählt:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einem Bereich von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für den Server</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einem Bereich von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für den Router in Wohnung Nr. 2</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einem Bereich von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für den Router in Wohnung Nr. 3</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Adressen mussten auch den Client-Routern des OpenVPN-Servers zugewiesen werden, indem der Konfiguration die folgenden Zeilen hinzugefügt wurden:</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
und Hinzufügen der folgenden Zeilen zur Datei /etc/openvpn/ipp.txt:</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dabei sind flat1_id und flat2_id die Gerätenamen, die beim Erstellen von Zertifikaten für die Verbindung mit OpenVPN angegeben werden</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes wurden OpenVPN-Clients auf den Routern konfiguriert, tap0-Geräte auf beiden wurden der br-lan-Brücke hinzugefügt. Zu diesem Zeitpunkt schien alles in Ordnung zu sein, da sich alle drei Netzwerke sehen und als Ganzes arbeiten. Es stellte sich jedoch als nicht sehr angenehmes Detail heraus: Manchmal konnten Geräte keine IP-Adresse von ihrem Router erhalten, was alle Konsequenzen hatte. Aus irgendeinem Grund hatte der Router in einigen Apartments keine Zeit, rechtzeitig auf DHCPDISCOVER zu antworten, und das Gerät erhielt seine Adresse nicht. Ich erkannte, dass ich solche Anforderungen in tap0 auf jedem der Router filtern muss, aber wie sich herausstellte, können iptables nicht mit dem Gerät funktionieren, wenn es Teil der Bridge ist und ebtables mir helfen sollten. Leider war es nicht in meiner Firmware und ich musste die Images für jedes Gerät neu erstellen.Nachdem dies geschehen war und solche Zeilen zu /etc/rc.local jedes Routers hinzugefügt wurden, wurde das Problem gelöst:</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Konfiguration dauerte drei Jahre.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 2: Einführung in WireGuard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor kurzem wurde im Internet immer mehr über WireGuard gesprochen, wobei die Einfachheit der Konfiguration, die hohe Übertragungsgeschwindigkeit und der niedrige Ping-Wert bei vergleichbarer Sicherheit bewundert wurden. Die Suche nach zusätzlichen Informationen über ihn machte deutlich, dass sie weder die Arbeit als Mitglied der Bridge noch die Arbeit mit dem TCP-Protokoll unterstützten, was mich glauben ließ, dass es für mich immer noch keine Alternativen zu OpenVPN gab. Also habe ich es verschoben, WireGuard kennenzulernen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor einigen Tagen wurde über die Ressourcen, die auf die eine oder andere Weise mit der IT verbunden sind, bekannt, dass WireGuard ab Version 5.6 endlich im Linux-Kernel enthalten sein wird. Nachrichtenartikel lobten wie immer WireGuard. Ich machte mich erneut auf die Suche nach Möglichkeiten, das gute alte OpenVPN zu ersetzen. Diesmal bin ich auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diesen Artikel gestoßen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es ging um den Bau eines Ethernet-Tunnels über L3 mit GRE. Dieser Artikel gab mir Hoffnung. Es blieb unklar, was mit dem UDP-Protokoll zu tun ist. Die Suche führte mich zu Artikeln über die Verwendung von socat in Verbindung mit einem SSH-Tunnel zum Weiterleiten eines UDP-Ports. Sie stellten jedoch fest, dass dieser Ansatz nur im Einzelverbindungsmodus funktioniert, dh die Arbeit mehrerer VPN-Clients wäre unmöglich. Ich hatte die Idee, einen VPN-Server auf VPS zu erstellen und GRE für Clients einzurichten. Wie sich jedoch herausstellte, unterstützt GRE keine Verschlüsselung, was dazu führt, dass beim Zugriff Dritter auf den Server der gesamte Datenverkehr zwischen meinen Netzwerken in ihren Händen liegt das passte mir grundsätzlich nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier wurde die Entscheidung zugunsten einer übermäßigen Verschlüsselung getroffen, indem ein VPN über ein VPN gemäß dem folgenden Schema verwendet wurde:</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN der ersten Ebene: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einer internen Adresse von 192.168.30.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS- </font><i><font style="vertical-align: inherit;">Client</font></i><font style="vertical-align: inherit;"> mit einer internen Adresse von 192.168.30.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS- </font><i><font style="vertical-align: inherit;">Client</font></i><font style="vertical-align: inherit;"> mit einer internen Adresse von 192.168.30.3 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS- </font><i><font style="vertical-align: inherit;">Client</font></i><font style="vertical-align: inherit;"> mit einer internen Adresse von 192.168.30.3 </font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;"> ist </font><i><font style="vertical-align: inherit;">ein </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN der zweiten Ebene: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einer externen Adresse 192.168.30.2 und einer internen Adresse 192.168.31.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS- </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">Client</font></i><font style="vertical-align: inherit;"> mit einer Adresse von 192.168.30.2 und einer internen IP 192.168.31.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein </font></font></i> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">MS- </font></b><i><font style="vertical-align: inherit;">Client</font></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit der Adresse 192.168.30.2 und einer internen IP 192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Router-Server in Wohnung 1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Router in Wohnung 2, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Router in Wohnung 3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Gerätekonfigurationen werden im Spoiler am Ende des Artikels veröffentlicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn also Pings zwischen den Knoten des Netzwerks 192.168.31.0/24 losgehen, ist es an der Zeit, mit dem Einrichten des GRE-Tunnels fortzufahren. Um den Zugriff auf die Router nicht zu verlieren, sollten zuvor SSH-Tunnel eingerichtet werden, um 22 Ports auf dem VPS weiterzuleiten, sodass beispielsweise der Router aus Apartment 2 auf dem 10022. VPS-Port und auf dem 11122. Port der VPS verfügbar ist Der Router stammt aus Apartment 3. Es ist am besten, die Weiterleitung mit demselben Sshtunnel zu konfigurieren, da er den Tunnel wiederherstellt, wenn er herunterfällt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Tunnel konfiguriert ist, können Sie über den weitergeleiteten Port eine Verbindung zu SSH herstellen:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deaktivieren Sie als Nächstes OpenVPN:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurieren Sie nun den GRE-Tunnel auf dem Router von Apartment 2 aus:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und fügen Sie die erstellte Schnittstelle zur Bridge hinzu:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden ein ähnliches Verfahren auf dem Router-Server durchführen:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie der Bridge außerdem die erstellte Schnittstelle hinzu:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ab diesem Moment gehen Pings erfolgreich in das neue Netzwerk und ich werde mit Zufriedenheit Kaffee trinken. </font><font style="vertical-align: inherit;">Um zu bewerten, wie das Netzwerk am anderen Ende des Kabels funktioniert, versuche ich, eine Verbindung über SSH zu einem der Computer in Wohnung 2 herzustellen, aber der SSH-Client friert ein, ohne nach einem Kennwort zu fragen. </font><font style="vertical-align: inherit;">Ich versuche, über Telnet eine Verbindung zu diesem Computer mit Port 22 herzustellen, und ich sehe eine Zeile, aus der hervorgeht, dass die Verbindung hergestellt wird. Der SSH-Server antwortet, bietet mir jedoch aus irgendeinem Grund nicht an, mich anzumelden.</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich versuche, eine Verbindung über VNC herzustellen, und sehe einen schwarzen Bildschirm. Ich versichere mir, dass es sich um einen Remotecomputer handelt, da ich von dieser Wohnung aus unter der internen Adresse problemlos eine Verbindung zum Router herstellen kann. Ich entscheide mich jedoch, über einen Router eine Verbindung zum SSH dieses Computers herzustellen, und bin überrascht, dass die Verbindung erfolgreich ist und der Remotecomputer ordnungsgemäß funktioniert, aber auch keine Verbindung zu meinem Computer herstellen kann.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich entferne das grelan0-Gerät von der Bridge und starte OpenVPN auf dem Router in Apartment 2 und stelle sicher, dass das Netzwerk wieder wie erwartet funktioniert und die Verbindungen nicht unterbrochen werden. Wenn ich suche, stoße ich auf Foren, in denen sich Leute über dieselben Probleme beschweren und denen geraten wird, die MTU zu erhöhen. Ich konnte die MTU für das VPN der ersten Ebene (wg0) jedoch nicht erhöhen: Bei MTUs über 1420, die automatisch eingestellt werden, beginnen die Pausen, aber gleichzeitig funktionierte das VPN der zweiten Ebene wg1, das über wg0 arbeitet, ordnungsgemäß mit der MTU 1600. Dies reicht für die Installation aus Die MTU für das Gretap-Gerät beträgt 1500, sodass diese Schnittstelle den gleichen MTU-Wert hat wie die br-lan-Brücke, zu der Gretap hinzugefügt werden soll. So wie ich es verstehe, setzt die Bridge die MTU gleich dem kleineren der verfügbaren Werte auf allen Geräten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe eine ähnliche Konfiguration auf dem Router aus Apartment 3 vorgenommen, mit dem einzigen Unterschied, dass der Server auf dem Router eine zweite Gretap-Schnittstelle namens grelan1 hinzugefügt hat, die auch der br-lan-Brücke hinzugefügt wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles arbeitet. </font><font style="vertical-align: inherit;">Jetzt können Sie die Gretap-Baugruppe beim Start platzieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen </font><font style="vertical-align: inherit;">Sie dazu folgendermaßen vor: </font><font style="vertical-align: inherit;">Setzen Sie diese Zeilen in /etc/rc.local auf den Router in Apartment 2:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies wurde zu /etc/rc.local auf dem Router in Apartment 3 hinzugefügt:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und auf dem Server-Router:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Neustart der Client-Router stellte ich fest, dass sie aus irgendeinem Grund keine Verbindung zum Server herstellten. </font><font style="vertical-align: inherit;">Nachdem eine Verbindung zu ihrem SSH hergestellt wurde (zum Glück habe ich sshtunnel dafür vorkonfiguriert), wurde festgestellt, dass WireGuard aus irgendeinem Grund eine Route für den Endpunkt erstellt hat, diese war jedoch falsch. </font><font style="vertical-align: inherit;">Für 192.168.30.2 gab die Routentabelle die Route über die pppoe-wan-Schnittstelle an, dh über das Internet, obwohl die Route dorthin über die wg0-Schnittstelle hätte geroutet werden müssen. </font><font style="vertical-align: inherit;">Nach dem Löschen dieser Route wurde die Verbindung wiederhergestellt. </font><font style="vertical-align: inherit;">Ich konnte nirgendwo Anweisungen finden, wie WireGuard diese Routen nicht erstellen kann. </font><font style="vertical-align: inherit;">Außerdem habe ich nicht einmal verstanden, dass eine Funktion OpenWRT oder WireGuard selbst ist. </font><font style="vertical-align: inherit;">Ohne mich lange mit diesem Problem befassen zu müssen, habe ich diesem Router eine Zeile zu dem Skript hinzugefügt, das von einem Timer zur Timer-Schleife durchgeschleift wurde:</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe OpenVPN noch nicht vollständig abgelehnt, da ich manchmal von einem Laptop oder Telefon aus eine Verbindung zu einem neuen Netzwerk herstellen muss und das Einrichten eines Gretap-Geräts auf diesen im Allgemeinen unmöglich ist. Trotzdem habe ich einen Vorteil bei der Datenübertragungsgeschwindigkeit zwischen Wohnungen und zum Beispiel verursacht die Verwendung von VNC jetzt keine Unannehmlichkeiten. </font><font style="vertical-align: inherit;">Der Ping nahm leicht ab, wurde jedoch stabiler: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei Verwendung von OpenVPN:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei Verwendung von WireGuard:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist stärker von dem hohen Ping vor VPS betroffen, der ungefähr 61,5 ms beträgt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Geschwindigkeit hat sich jedoch erheblich erhöht. </font><font style="vertical-align: inherit;">In einer Wohnung mit einem Router-Server habe ich eine Internetverbindungsgeschwindigkeit von 30 Mbit / s und in anderen Wohnungen 5 Mbit / s. </font><font style="vertical-align: inherit;">Gleichzeitig konnte ich bei Verwendung von OpenVPN laut iperf keine Datenübertragungsrate zwischen Netzwerken von mehr als 3,8 Mbit / s erreichen, während WireGuard diese auf die gleichen 5 Mbit / s „pumpte“.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard-Konfiguration auf VPS</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard-Konfiguration auf MS (hinzugefügt zu / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard-Konfiguration auf MK2 (hinzugefügt zu / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard-Konfiguration auf MK3 (hinzugefügt zu / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den beschriebenen Konfigurationen für das VPN der zweiten Ebene gebe ich den 51821-Port für WireGuard-Clients an. Im Prinzip ist dies nicht erforderlich, da der Client eine Verbindung von jedem freien, nicht privilegierten Port herstellt, aber ich habe es so gemacht, dass ich alle eingehenden Verbindungen auf den wg0-Schnittstellen aller Router außer blockieren kann eingehende UDP-Verbindungen zu Port 51821. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dieser Artikel ist für jemanden nützlich. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Außerdem möchte ich mein Skript freigeben, das mir eine PUSH-Benachrichtigung auf dem Telefon an die WirePusher-Anwendung sendet, wenn ein neues Gerät in meinem Netzwerk angezeigt wird. </font><font style="vertical-align: inherit;">Hier ist der Link zum Skript: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OpenVPN-Server und -Clients konfigurieren</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN-Server</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN-Client</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Generieren von Zertifikaten verwendet easy-rsa</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de486864/">https://habr.com/ru/post/de486864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de486844/index.html">Die Entwicklung der Facebook-Webhook-Verarbeitung: von null auf 25.000 pro Sekunde</a></li>
<li><a href="../de486850/index.html">Neuer reservierter Sitzplatz - wie ein Kapselhotel</a></li>
<li><a href="../de486858/index.html">Erstellen eines vollwertigen Viberbot. Teil zwei - erster Kontakt oder "convert_started"</a></li>
<li><a href="../de486860/index.html">ATX12VO - Essen auf eine neue Art und Weise</a></li>
<li><a href="../de486862/index.html">5 Gründe, warum Motion Design Ihnen hilft, mit Menschen in Kontakt zu treten</a></li>
<li><a href="../de486866/index.html">Synchroner Fuete: Biologische Motoren in der Nanotechnologie</a></li>
<li><a href="../de486868/index.html">Warum und für wen wir Slime Agile machen</a></li>
<li><a href="../de486870/index.html">Wie wir Betrug aus der Hütte genommen haben</a></li>
<li><a href="../de486872/index.html">Linux Tastatur-Setup</a></li>
<li><a href="../de486874/index.html">Coronavirus 2019-nCoV: niedrige Mortalität, hohe Mortalität</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>