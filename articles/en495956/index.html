<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚ÄçüöÄ ü•Ä üè™ Gotta go fast. Optimizing IMAP email content requests üë®üèΩ‚Äçüåæ üë©üèª‚Äçü§ù‚Äçüë®üèº üíå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! In a previous article, I talked about how you can quickly synchronize the contents of a box in the local cache. Here I want to talk ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gotta go fast. Optimizing IMAP email content requests</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495956/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a previous article,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I talked about how you can quickly synchronize the contents of a box in the local cache. </font><font style="vertical-align: inherit;">Here I want to talk about the features of requesting the contents of letters and how best to request content without fear for a large consumption of traffic.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kk/4w/8a/kk4w8ac2scl3dawogln5zyvg7fg.jpeg" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's quickly remember what we learned in the last article:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMAP is a stateful protocol</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To see the contents of the inbox, you must first select it with the SELECT command</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To quickly synchronize the box we are in, you can use the NOOP command</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order not to sort messages from the local storage to update the mailbox we have already left, you can use CONDSTORE and QRESYNC, provided that your server supports the protocol extension data</font></font></li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enough!</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me remind you the command to request the letter body:</font></font><br>
<br>
<pre><code class="bash hljs">1 FETCH number (BODY[])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will create a request to get the whole body of the letter and all attachments. </font><font style="vertical-align: inherit;">Just see how long it takes to get a message in 42 paragraph of Lorem Ipsum and with a picture of 2 megabytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, ask the size of the message on the server. </font><font style="vertical-align: inherit;">This is done by the command:</font></font><br>
<br>
<pre><code class="bash hljs">1 FETCH 18871 (RFC822.SIZE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RFC822.SIZE returns the size of the message in bytes:</font></font><br>
<br>
<pre><code class="bash hljs">* 18871 FETCH (RFC822.SIZE 3937793)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, as a result, our message takes up almost 4 megabytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, nevertheless, we will use the request for the full body of the letter and take a look at the time:</font></font><br>
<br>
<pre><code class="bash hljs">1 OK Fetch completed (0.007 + 3.265 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.3 seconds! </font><font style="vertical-align: inherit;">And this is only one message with the attachment, and imagine them such will be the whole box. </font><font style="vertical-align: inherit;">Then it will take more than a minute to download at least the twenty first ones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You must admit that the business of a client who in 2020 cannot synchronize mail faster than in a minute is bad. </font><font style="vertical-align: inherit;">But what to do?</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Give me a bite once</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rustle RFC3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in clause </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.5.4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which describes the possible parameters for the FETCH command, you will notice an interesting request:</font></font><br>
<br>
<pre><code class="bash hljs">BODY[&lt;section&gt;]&lt;&lt;partial&gt;&gt;
</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">section - which part of the letter to get</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partial - the size of this part</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How is partial built? </font><font style="vertical-align: inherit;">And it‚Äôs very easy. </font><font style="vertical-align: inherit;">First, the byte from which you need to start reading is written through the point, and then how many bytes in general should be read:</font></font><br>
<br>
<pre><code class="bash hljs">BODY[&lt;section&gt;]&lt;&lt;0.1024&gt;&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we request the part of the letter from zero byte to 1024. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Okay, what is section? </font><font style="vertical-align: inherit;">First, I‚Äôll talk about such a useful parameter in a FETCH query as BODYSTRUCTURE:</font></font><br>
<br>
<pre><code class="bash hljs">1 FETCH 18871 (BODYSTRUCTURE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This parameter, as you probably understood from the signature, returns the structure of the letter in the form described in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIME-IMB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="bash hljs">* 18871 FETCH (BODYSTRUCTURE (((<span class="hljs-string">"text"</span> <span class="hljs-string">"plain"</span> (<span class="hljs-string">"charset"</span> <span class="hljs-string">"utf-8"</span>) NIL NIL <span class="hljs-string">"quoted-printable"</span> 25604 337 NIL NIL NIL NIL)(<span class="hljs-string">"text"</span> <span class="hljs-string">"html"</span> (<span class="hljs-string">"charset"</span> <span class="hljs-string">"utf-8"</span>) NIL NIL <span class="hljs-string">"quoted-printable"</span> 29593 390 NIL NIL NIL NIL) <span class="hljs-string">"alternative"</span> (<span class="hljs-string">"boundary"</span> <span class="hljs-string">"--=_Part_763_774309787.1586268692"</span>) NIL NIL NIL)(<span class="hljs-string">"image"</span> <span class="hljs-string">"jpeg"</span> (<span class="hljs-string">"name"</span> <span class="hljs-string">"IMG_20200217_000236.jpg"</span>) NIL NIL <span class="hljs-string">"base64"</span> 3880726 NIL (<span class="hljs-string">"attachment"</span> (<span class="hljs-string">"filename"</span> <span class="hljs-string">"IMG_20200217_000236.jpg"</span>)) NIL NIL) <span class="hljs-string">"mixed"</span> (<span class="hljs-string">"boundary"</span> <span class="hljs-string">"--=_Part_210_297656922.1586268692"</span>) NIL NIL NIL))
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just a look at this structure, and your head is spinning? </font><font style="vertical-align: inherit;">Do not be afraid, now we‚Äôll figure it out. </font><font style="vertical-align: inherit;">Compare the opening and closing brackets.</font></font><br>
<br>
<pre><code class="bash hljs">(<font></font>
BODYSTRUCTURE&nbsp;<font></font>
(<font></font>
[1] (<font></font>
[1.1] (<span class="hljs-string">"text"</span> <span class="hljs-string">"plain"</span> (<span class="hljs-string">"charset"</span> <span class="hljs-string">"utf-8"</span>) NIL NIL <span class="hljs-string">"quoted-printable"</span> 25604 337 NIL NIL NIL NIL)<font></font>
[1.2] (<span class="hljs-string">"text"</span> <span class="hljs-string">"html"</span> (<span class="hljs-string">"charset"</span> <span class="hljs-string">"utf-8"</span>) NIL NIL <span class="hljs-string">"quoted-printable"</span> 29593 390 NIL NIL NIL NIL) <span class="hljs-string">"alternative"</span> (<span class="hljs-string">"boundary"</span> <span class="hljs-string">"--=_Part_763_774309787.1586268692"</span>) NIL NIL NIL<font></font>
)<font></font>
[2] (<span class="hljs-string">"image"</span> <span class="hljs-string">"jpeg"</span> (<span class="hljs-string">"name"</span> <span class="hljs-string">"IMG_20200217_000236.jpg"</span>) NIL NIL <span class="hljs-string">"base64"</span> 3880726 NIL (<span class="hljs-string">"attachment"</span> (<span class="hljs-string">"filename"</span> <span class="hljs-string">"IMG_20200217_000236.jpg"</span>)) NIL NIL) <span class="hljs-string">"mixed"</span> (<span class="hljs-string">"boundary"</span> <span class="hljs-string">"--=_Part_210_297656922.1586268692"</span>) NIL NIL NIL<font></font>
)<font></font>
)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may notice that I put numbers near some brackets. </font><font style="vertical-align: inherit;">This is section. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to calculate them? </font><font style="vertical-align: inherit;">The first bracket must be skipped, because it simply contains the answer to the request, then each opening bracket must be numbered according to the rule as the headings in the documents are numbered:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We number each opening bracket taking into account the previous section</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the section is nested, then the current one through the point is added to the previous number</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the section is not nested, increase its number by one</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in this case, in the first part that ends with ‚Äúalternative‚Äù (that is, this is the part of the multipart / alternative letter, where we are free to choose which of the parts to display for the user), there are two sections that are numbered through a dot. </font><font style="vertical-align: inherit;">I met a server where there may be three-level nesting (that is, [1.1.1], [1.1.2], etc). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's analyze the part [1.1] looking at the structure of all this stuff in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIME-IMB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> document </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Judging by it, the Content-Type header is first. </font><font style="vertical-align: inherit;">It includes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIME type, here it is text / plain</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encoding (charset = utf8)</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following are two parameters that are written as NIL. </font><font style="vertical-align: inherit;">Frankly, I did not understand what it was, but so far I have not needed it, so I will miss it. </font><font style="vertical-align: inherit;">I apologize for such frivolity. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next is the Content-Transfer-Encoding header, it is included in it, which describes the encoding mechanism, here it is quoted-printable.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following two numbers describe the size of the part in bytes and the number of lines, if possible. </font><font style="vertical-align: inherit;">With their help, we can calculate how many bytes to take to display a certain number of lines. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following lines that are not in this part:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content-Id, which is used in the inline of the letter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content-Description, a line that describes what this part is</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the other two parameters, I could not find a definite answer what it is, but one of these parameters may contain MD5 parts, which can sometimes be useful. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For part [2], everything is the same, except that it is an image, an attachment with a name, and base64 encoding. If it‚Äôs still not completely clear what is happening here, then </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on this site it‚Äôs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perfectly laid out exactly how to calculate section. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What does it give? And the fact that at the stage of displaying the letter we can already request only the top part of the content and not load the attachments until the user himself enters the message and clicks the "download" button. All information for displaying attachments comes to us in BODYSCTRUCTURE so that the name, format and size can be displayed without loading the attachment itself.&nbsp;</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to practice. </font><font style="vertical-align: inherit;">We‚Äôll ask for one kilobyte of message content without attachments, just to know what they sent us.</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 18871 (body[1.1]&lt;0.1024&gt;)<font></font>
* 18871 FETCH (BODY[1.1]&lt;0&gt; {1024}<font></font>
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus consecte=<font></font>
tur enim <span class="hljs-keyword">in</span> nisi venenatis, id varius tellus viverra. Praesent et enim te=<font></font>
llus. Nunc vestibulum diam tortor, id posuere turpis tempor luctus. Vivam=<font></font>
us molestie non nunc nec placerat. Cras finibus ut erat et tristique. Cur=<font></font>
abitur vitae commodo risus. Etiam sed scelerisque erat. Quisque cursus bl=<font></font>
andit finibus. Nullam ac lectus accumsan, molestie quam non, mollis urna.=<font></font>
&nbsp;Nulla at arcu <span class="hljs-keyword">in</span> libero condimentum mollis ut non velit. Vestibulum sed =<font></font>
risus et magna congue iaculis. Vestibulum nec interdum elit, ut commodo m=<font></font>
auris. Nulla ipsum leo, vestibulum nec ligula non, elementum ullamcorper =<font></font>
risus. Nunc et malesuada sem, id venenatis massa. Integer dolor ante, max=<font></font>
imus <span class="hljs-keyword">in</span> eleifend nec, ultricies ut risus. Mauris posuere eget tortor at p=<font></font>
orttitor.=0AIn porta elementum ornare. Suspendisse aliquam, tortor sed al=<font></font>
iquam bibendum, nulla ante rhoncus elit, placerat accumsan augue nibh non=<font></font>
&nbsp;est. Duis finibus vel tortor finibu)<font></font>
1 OK Fetch completed (0.073 + 0.000 + 0.072 secs).</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some 100 milliseconds and we already see some of the content of the letter! </font><font style="vertical-align: inherit;">This is just an excellent result, given that previously it took us almost 4 seconds to download the content of one letter. </font><font style="vertical-align: inherit;">Then you can simply load the entire content of the letter in the background stream, from the outside it will seem that the letters are loaded instantly. </font><font style="vertical-align: inherit;">All that was required was to look at the structure of the letter and download only what is required for a quick display.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one moment. </font><font style="vertical-align: inherit;">This request will make the message on the server appear as read. </font><font style="vertical-align: inherit;">But you can fix this by adding only PEEK to the body request</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 18871 (BODY.PEEK[1.1]&lt;0.1024&gt;)<font></font>
* 18871 FETCH (BODY[1.1]&lt;0&gt; {1024}<font></font>
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus consecte=<font></font>
tur enim <span class="hljs-keyword">in</span> nisi venenatis, id varius tellus viverra. Praesent et enim te=<font></font>
llus. Nunc vestibulum diam tortor, id posuere turpis tempor luctus. Vivam=<font></font>
us molestie non nunc nec placerat. Cras finibus ut erat et tristique. Cur=<font></font>
abitur vitae commodo risus. Etiam sed scelerisque erat. Quisque cursus bl=<font></font>
andit finibus. Nullam ac lectus accumsan, molestie quam non, mollis urna.=<font></font>
&nbsp;Nulla at arcu <span class="hljs-keyword">in</span> libero condimentum mollis ut non velit. Vestibulum sed =<font></font>
risus et magna congue iaculis. Vestibulum nec interdum elit, ut commodo m=<font></font>
auris. Nulla ipsum leo, vestibulum nec ligula non, elementum ullamcorper =<font></font>
risus. Nunc et malesuada sem, id venenatis massa. Integer dolor ante, max=<font></font>
imus <span class="hljs-keyword">in</span> eleifend nec, ultricies ut risus. Mauris posuere eget tortor at p=<font></font>
orttitor.=0AIn porta elementum ornare. Suspendisse aliquam, tortor sed al=<font></font>
iquam bibendum, nulla ante rhoncus elit, placerat accumsan augue nibh non=<font></font>
&nbsp;est. Duis finibus vel tortor finibu)<font></font>
1 OK Fetch completed (0.001 + 0.000 secs).</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And voila! </font><font style="vertical-align: inherit;">The letter remains unread and some of the content we received. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything becomes even easier if the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">PREVIEW</font></a><font style="vertical-align: inherit;"> request feature is implemented on your server.&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<pre><code class="bash hljs">1 fetch 18871 (PREVIEW)<font></font>
* 18871 FETCH (PREVIEW (FUZZY <span class="hljs-string">"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus consectetur enim in nisi venenatis, id varius tellus viverra. Praesent et enim tellus. Nunc vestibulum diam tortor, id posuere turpis t"</span>))<font></font>
1 OK Fetch completed (0.001 + 0.000 secs).</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we don‚Äôt spend time on querying the structure at all and we get the message preview instantly. </font><font style="vertical-align: inherit;">But do not forget that the query structure is useful for defining attachments so that they are not loaded into the idle.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wait</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost any mail client implements the ‚Äúrefresh‚Äù button if the user wants to receive new letters right now. </font><font style="vertical-align: inherit;">But somehow this is not cool for our time, where there are notifications both in devices and in browsers. </font><font style="vertical-align: inherit;">What does IMAP say about this? </font><font style="vertical-align: inherit;">And he says </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDLE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This operation holds the connection to the folder and notifies you of changes to the folder. </font><font style="vertical-align: inherit;">Please note, not the mailbox, but the folders. </font><font style="vertical-align: inherit;">To do this, you need the server to implement the IDLE feature.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, select the folder for which the server will send alerts, and then enable IDLE</font></font><br>
<br>
<pre><code class="bash hljs">1 SELECT Inbox<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 18872 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 18685] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 20155] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 26338] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.002 + 0.000 + 0.001 secs).<font></font>
1 IDLE<font></font>
+ idling</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The answer "+ idling" notifies about the inclusion of the idle on the folder. </font><font style="vertical-align: inherit;">What happens if a new letter arrives?</font></font><br>
<br>
<pre><code class="bash hljs">* 18873 EXISTS<font></font>
* 1 RECENT</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I sent myself the same letter, and Idle informed me that I should request letter 18873, that there were 18873 letters in the folder, and that one letter had just arrived. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, I will request this letter in another connection, we are interested in the letter with the answer EXISTS.</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 18873 (BODY.PEEK[1.1]&lt;0.1024&gt;)<font></font>
* 18873 FETCH (BODY[1.1]&lt;0&gt; {1024}<font></font>
---- Original Message ---- Tue, Apr 7, 2020, 17:11=0ASubject=<font></font>
: Lorem Ipsum=0A&nbsp; Lorem ipsum dolor sit amet, consectetur adipiscing elit=<font></font>
. Vivamus consectetur enim <span class="hljs-keyword">in</span> nisi venenatis, id varius tellus viverra. P=<font></font>
raesent et enim tellus. Nunc vestibulum diam tortor, id posuere turpis te=<font></font>
mpor luctus. Vivamus molestie non nunc nec placerat. Cras finibus ut erat=<font></font>
‚Ä¶</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is very important to understand. </font><font style="vertical-align: inherit;">IDLE requires a separate connection, so you cannot receive changes and request messages in the same session. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What else can IDLE do? </font><font style="vertical-align: inherit;">He is able to notify about deleted letters and letters whose flags have changed. </font><font style="vertical-align: inherit;">Let‚Äôs look at the letter for the sake of example, thereby putting the ‚Äú/ seen‚Äù flag on it and delete the letter.</font></font><br>
<br>
<pre><code class="bash hljs">* 18873 FETCH (FLAGS (\Seen \Recent))<font></font>
* OK Still here<font></font>
* OK Still here<font></font>
* 18873 EXPUNGE<font></font>
* 18871 EXPUNGE<font></font>
* 0 RECENT</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I deleted the conversation (18873, 18871) and looked at another letter (FETCH response). </font><font style="vertical-align: inherit;">Why did this letter become 18871? </font><font style="vertical-align: inherit;">Because IMAP recounts the letter number if something has changed. </font><font style="vertical-align: inherit;">Since it became the top one, its number also changed.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With IDLE, we can quickly synchronize the state of the box, but it is unpleasant that it requires a separate connection. </font><font style="vertical-align: inherit;">Could it be better? </font><font style="vertical-align: inherit;">That is why I am here.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yell how do you do</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What if I tell you that there is a feature that allows you to receive notifications from the server in the same connection, and even specially configured for mailboxes, and more than one. </font><font style="vertical-align: inherit;">It sounds like a fairy tale, but don‚Äôt go crazy, this is a real capability </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOTIFY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">He knows a lot, for example:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure specific folders from which we expect notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listen to folder status changes (read letters, new letters)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the notification format, that is, what we want to see when changing the folder</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listen to folder name changes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listen to folder metadata changes</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at an example of how we can listen to folder status changes</font></font><br>
<br>
<pre><code class="bash hljs">1 notify <span class="hljs-built_in">set</span> (inboxes (MessageNew FlagChange MessageExpunge))<font></font>
1 OK NOTIFY completed (0.001 + 0.000 secs).</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the server will send us notifications with folder statuses, for example, I will add a couple of messages to different folders</font></font><br>
<br>
<pre><code class="bash hljs">* STATUS INBOX/Ozon (MESSAGES 312 UIDNEXT 321 UNSEEN 48)<font></font>
* STATUS <span class="hljs-string">"INBOX/Company News"</span> (MESSAGES 178 UIDNEXT 179 UNSEEN 1)<font></font>
* STATUS <span class="hljs-string">"INBOX/Company News"</span> (MESSAGES 177 UIDNEXT 179 UNSEEN 0)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will analyze the command: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First comes the NOTIFY SET command. </font><font style="vertical-align: inherit;">Next, in brackets, we select which folders we will listen to:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inboxes - for all folders that you can select</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personal - folders that are in the user's namespace</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subscribed - folders the user is subscribed to</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subtree - subtree of the folder to be specified</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mailboxes - here you can list the folders to listen to.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selected - alert only for selected folders</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the parameters that are responsible for the alert filter:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageNew - if a new message arrives</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FlagChange - if the flag has changed</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageExpunge - if the message was deleted or moved</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But with such a command, we cannot receive the parameters of a new, changed or deleted message. </font><font style="vertical-align: inherit;">To do this, select the Selected parameter and specify what exactly to return. </font><font style="vertical-align: inherit;">We can add another alert without deleting the previous one.</font></font><br>
<br>
<pre><code class="bash hljs">1 notify <span class="hljs-built_in">set</span> status (selected (MessageNew (uid preview) MessageExpunge))
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here inside MessageNew we specify the parameters that the notification should return. </font><font style="vertical-align: inherit;">I will choose Inbox and again I will throw to myself lorem ipsum.</font></font><br>
<br>
<pre><code class="bash hljs">* 18868 FETCH (UID 20157 PREVIEW (FUZZY <span class="hljs-string">"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus consectetur enim in nisi venenatis, id varius tellus viverra. Praesent et enim tellus. Nunc vestibulum diam tortor, id posuere turpis t"</span>))</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do you like it? </font><font style="vertical-align: inherit;">For the idle, we need to keep two connections, one of which also requests messages that the idle returned to us. </font><font style="vertical-align: inherit;">Immediately they bring us everything on a silver platter.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so we can listen to folder name changes</font></font><br>
<br>
<pre><code class="bash hljs">1 notify <span class="hljs-built_in">set</span> (inboxes (MailboxName))</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rename some folder and see the result.</font></font><br>
<br>
<pre><code class="bash hljs">* LIST () <span class="hljs-string">"/"</span> 1111 (<span class="hljs-string">"OLDNAME"</span> (aaaa))</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now we know that there was a folder ‚Äúaaaa‚Äù, and became ‚Äú1111‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can listen to the change of flags and the removal of messages. </font><font style="vertical-align: inherit;">To do this, use the FlagChange parameter</font></font><br>
<br>
<pre><code class="bash hljs">1 notify <span class="hljs-built_in">set</span> (selected (MessageNew (uid) FlagChange MessageExpunge))</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when you change the message flags and delete, we get</font></font><br>
<br>
<pre><code class="bash hljs">* 18865 EXPUNGE<font></font>
* 18864 FETCH (FLAGS ())<font></font>
* 18864 FETCH (FLAGS (\Answered))</code></pre><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What's next</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All these features help the mail client to work as quickly and conveniently as possible for the user. </font><font style="vertical-align: inherit;">IDLE and NOTIFY notify the user of changes in folders, requesting part of the letter speeds up its loading.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the final article, I would like to talk about the search mechanism in IMAP and how it can be accelerated and reduce the load on the network. </font><font style="vertical-align: inherit;">Thank you for reading to the end.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495942/index.html">Save time, nerves and man hours</a></li>
<li><a href="../en495944/index.html">Updated TOP50 (rating of CIS supercomputers): dynamics and trends</a></li>
<li><a href="../en495946/index.html">Norbert Wiener: the distracted father of cybernetics</a></li>
<li><a href="../en495948/index.html">Rust Embedded. Development for Cortex-M3 processors using the STM32F103C8T6 (Black Pill) debug board</a></li>
<li><a href="../en495954/index.html">How has Cisco been operating in remote access mode and an absent perimeter for 20 years?</a></li>
<li><a href="../en495960/index.html">Just AH-ny Wi-Fi. Or how we built a Wi-Fi 6 (AX) network in an educational institution</a></li>
<li><a href="../en495962/index.html">Udalenka: how in X5 they planned to switch to a remote format of work</a></li>
<li><a href="../en495966/index.html">Absurd code or "how not to write"</a></li>
<li><a href="../en495970/index.html">Tools for remote team work: from time tracking to finance</a></li>
<li><a href="../en495974/index.html">Photographic observations of meteors, Perseids 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>