<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤣 💦 🤢 Otentikasi dua faktor VPN / Mikrotik - sederhana dan dapat diskalakan 👩🏼‍⚕️ 🤹 🧔🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo! 
 
 Untuk penulisan artikel ini, saya diminta untuk membaca konten yang mirip dari artikel penggunankusnetsov. Jumlah pandangan menunjukkan bahw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Otentikasi dua faktor VPN / Mikrotik - sederhana dan dapat diskalakan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506708/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk penulisan artikel ini, saya diminta untuk membaca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konten yang mirip dari artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengguna</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nkusnetsov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jumlah pandangan menunjukkan bahwa komunitas tertarik pada topik ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, saya memutuskan untuk berbagi dengan Anda solusi saya sendiri, yang sebelumnya diterapkan oleh saya dan dalam bentuk dasarnya memiliki:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tingkat entri yang rendah dan kesederhanaan kode (untuk pemahaman / debugging oleh karyawan lain)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skrip ROS sederhana tidak membuat beban apa pun dan bahkan bekerja di hAP Lite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skalabilitas - kemampuan untuk menghubungkan sejumlah besar gateway VPN untuk mengurangi beban atau distribusi geografis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemampuan untuk menggunakan Mikrotik CHR sebagai server VPN</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"1xN" - 1 SMS gateway untuk jumlah router yang tidak terbatas dengan kemungkinan ekspansi dengan meningkatnya beban</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemampuan untuk mengikat router terpisah ke modem "spesifik" (untuk apa? - lebih lanjut tentang itu nanti)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hanya menggunakan satu skrip php di server jauh</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak masalah perangkat mana yang memulai koneksi VPN, otorisasi oleh tautan dari SMS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemampuan untuk mencatat otorisasi karyawan di server</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tingkatkan toleransi kesalahan dan kurangi beban sistem dengan mengirim SMS secara acak dari beberapa modem</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD 1.0 - kode php diperbarui. </font><font style="vertical-align: inherit;">Sekarang ini termasuk mencatat semua permintaan ke skrip dan mengirim pesan secara acak melalui beberapa gateway jika lebih dari satu ditentukan.</font></font><br>
<br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pernyataan masalah dan solusi</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam proses pengembangan solusi ini, tugas ditetapkan untuk meminimalkan jumlah modem usb - mengurangi biaya kepemilikan, menyederhanakan administrasi, melokalisasi modem di satu tempat dan dengan demikian meningkatkan pemeliharaan sistem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diputuskan untuk menggunakan satu router yang diinstal pada "saluran andal" sebagai gateway SMS dasar. </font><font style="vertical-align: inherit;">Satu-satunya hal yang saya tidak tahu adalah beban pada sistem, modem akan mengatasinya dan apakah operator akan memblokirnya. </font><font style="vertical-align: inherit;">Oleh karena itu, saya memungkinkan untuk menghubungkan beberapa modem dan selanjutnya membagi sistem menjadi beberapa kelompok. </font><font style="vertical-align: inherit;">Selain itu, modem tambahan dapat dihubungkan ke gateway dasar melalui usb-hub sederhana. </font><font style="vertical-align: inherit;">Tetapi untuk berfungsi penuh, dengan fungsionalitas minimal, Anda memerlukan satu modem, terlepas dari jumlah router.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyediakan kemungkinan penggunaan kartu SIM lokal di area pemasangan router. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh: jaringan cabang yang luas dengan beberapa toko di Kazakhstan. </font><font style="vertical-align: inherit;">Mengirim pesan SMS dari Federasi Rusia akan sangat mahal. </font><font style="vertical-align: inherit;">Solusi ini memungkinkan karyawan dari Kazakhstan untuk menerima sms dari nomor lokal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi dalam proses refleksi, ternyata solusinya telah ditemukan dan diimplementasikan dalam Tugas 1.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otorisasi terowongan dari perangkat seluler tanpa harus secara fisik berada di perangkat yang diotorisasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuannya adalah kemampuan untuk mengotorisasi tidak hanya terowongan pengguna, tetapi juga koneksi vpn apa pun: Mikrotik-&gt; Mikrotik, Server-&gt; Mikrotik, dll. Dalam hal ini, pengguna yang bertanggung jawab atas terowongan ini hanya perlu mengikuti tautan dari pesan SMS, di mana juga terowongan mana yang ingin login ditampilkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengaktifkan otorisasi dengan cara ini, menjadi perlu untuk mentransfer skrip ke sumber daya eksternal - server dapat diakses dari mana saja dan menggunakan kode otorisasi untuk menandai daftar alamat di firewall dan membuka kunci berikutnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi untuk masalah ini sudah jelas menyiratkan penggunaan API RouterOS (atau SSH). </font><font style="vertical-align: inherit;">API menang sebagai opsi termudah.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logika</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengguna masuk dengan nama pengguna dan kata sandi yang sudah ditambahkan sebelumnya</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gateway VPN menempatkan ip-nya di daftar tunggu alamat dan mengirimkan permintaan POST ke server</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server menerima data, memeriksa, membuat kode otorisasi dan mengirim SMS ke nomor kontak dari formulir: "Untuk autorize koneksi pengguna 79001112233 terbuka - http_: //synome.ru/? Ruid = vrG7yYMbZ6 &amp; auth = YU6zc"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengguna mengikuti tautan dari perangkat apa pun</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server membuat permintaan ke router, memeriksa keberadaan di daftar alamat entri dengan kode otorisasi dalam komentar. </font><font style="vertical-align: inherit;">Jika catatan ditemukan, hapus, dan pengguna menampilkan halaman login yang berhasil</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam semua kasus lain, jika sesuatu tidak lulus tes, pengguna akan menerima kesalahan Permintaan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan dan kode</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita beralih dari bagian konseptual ke pengaturan Mikrotik, kode dan deskripsinya </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penjelasan: skrip dan kode php ini berfungsi untuk semua jenis server VPN. </font><font style="vertical-align: inherit;">Memilih jenis server (PPP / L2TP / SSTP), mengatur profil dan terowongan - Anda memilih "sesuai selera Anda", tetapi saya akan memberikan contoh umum pengaturan cepat.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambahkan ke Mikrotik:</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pastikan untuk membuat daftar sumber daya yang diizinkan, di antaranya: memiliki alamat MT, DNS publik apa pun, alamat server tempat otorisasi akan dilakukan</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ip firewall address-list<font></font>
add address=10.10.0.1 list=Allow-list<font></font>
add address=8.8.8.8 list=Allow-list<font></font>
add address=synome.ru list=Allow-list</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambahkan aturan yang memblokir lalu lintas pengguna VPN dari daftar tunggu ke host lain selain yang diizinkan</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ip firewall raw<font></font>
add action=drop chain=prerouting dst-address-list=!Allow-list src-address-list=VPN-blocked disabled=no</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profil PPP</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat profil tempat kami menyetel batas waktu koneksi idle. </font><font style="vertical-align: inherit;">Waktu harus kurang dari yang ditentukan dalam skrip On Up berikut, jika tidak, jika otorisasi belum dilakukan, maka setelah menghapus daftar dari daftar-alamat, pengguna akan mendapatkan akses untuk waktu yang sama dengan perbedaan (idle timeout dikurangi address-list timeout)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambahkan profil</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ppp profile<font></font>
add dns-server=10.10.0.1 idle-timeout=59m local-address=10.10.1.1 name=2F-VPN use-compression=no use-encryption=no use-mpls=no</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, pada tab terakhir dari Skrip tambahkan:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diatas</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">:global ruid "#ROUTERLOGIN#";<font></font>
:global pass "#ROUTER_PASSWORD#";<font></font>
:local userip [/ppp active get [find name=$user] address];<font></font>
# if phone number stored in comment<font></font>
#:local userphone [/ppp secret get [find name=$user] comment];<font></font>
# if phone number = username<font></font>
:local userphone $user;<font></font>
<font></font>
:local authkey [/tool fetch http-method=post http-data="ruid=$ruid&amp;pass=$pass&amp;tel=$userphone" url="https://yourwebsite.ru/" mode=https as-value output=user];<font></font>
<font></font>
/ip firewall address-list remove [find address=$userip];<font></font>
/ip firewall address-list add address=$userip list=VPN-blocked timeout=1h comment=($authkey-&gt;"data");<font></font>
<font></font>
:log info message="User connect:";<font></font>
:log info message=$userphone;<font></font>
:log info message=$userip;<font></font>
:log info message=($authkey-&gt;"data");</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sedang turun</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">:local userip [/ppp secret get [find name=$user] remote-address];<font></font>
/ip firewall address-list remove [find address=$userip];<font></font>
:log info message="User disconnect:";<font></font>
:log info message=$user;<font></font>
:log info message=$userip;</code></pre><br>
</div>
                    </div><br>
<i> <br>
<br>
 :         ,     .        (      )   ip-.  POST-        .  ip-  address-list VPN-blocked       -  1     .    .<br>
<br>
 :  ip- ,    address-list  .    .</i><br>
<br>
<h4>PPP Secrets</h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ppp secret<font></font>
add comment="70001112233" name=70001112233 password=testuser profile=2F-VPN remote-address=10.10.1.100</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nomor telepon dapat ditentukan secara langsung dalam nama, tetapi jika kami ingin dapat menentukan satu nomor untuk beberapa akun (untuk otorisasi beberapa terowongan), kami menunjukkan nomor dalam komentar, sedangkan dalam skrip On Up Anda perlu mengubah komentar pada baris</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubah (buka yang kedua, tutup yang keempat)</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># if phone number stored in comment<font></font>
:local userphone [/ppp secret get [find name=$user] comment];<font></font>
# if phone number = username<font></font>
#:local userphone $user;</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nah dan yang paling penting, nyalakan server PPTP atau L2TP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentang ini dengan Mikrotik pekerjaan selesai.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP backend</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di bawah ini adalah kode. </font><font style="vertical-align: inherit;">Dia berkomentar dengan cukup detail, jadi saya tidak akan menulis teks tambahan. </font><font style="vertical-align: inherit;">Yang paling penting adalah mengganti data dalam $ host dan $ ruid_data dengan milik Anda.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-comment">// ------------------------------------------------------------------------------</span>
<span class="hljs-comment">//   Copyright () 2020</span>
<span class="hljs-comment">//  Author: Dmitri Agababaev, d.agababaev@duncat.net</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Copyright by authors for used RouterOS PHP API class in the source code files</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Redistributions and use of source code, with or without modification, are</span>
<span class="hljs-comment">//  permitted that retain the above copyright notice</span>
<span class="hljs-comment">// ------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">require_once</span>(<span class="hljs-string">'routeros_api.class.php'</span>);<font></font>
<font></font>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// BASE SETTINGS</span>
<span class="hljs-comment">// -------------------------</span><font></font>
<font></font>
$uselog = <span class="hljs-literal">true</span>; <span class="hljs-comment">// //  ? | Use log? true | false</span>
$log_path = <span class="hljs-string">'mt2Fvpn.log'</span>; <span class="hljs-comment">//     | Log file path</span>
$host = <span class="hljs-string">'https://yourwebsite.com/'</span>; <span class="hljs-comment">//       | Full address that this script awalible</span><font></font>
<font></font>
<span class="hljs-comment">//    /VPN- | ROUTERS DATA ARRAY USED AS VPN-SERVERS</span>
$ruid_data = <span class="hljs-keyword">array</span>(
    <span class="hljs-comment">//   md5,  ip-,    , , SMS-     SMS</span>
    <span class="hljs-comment">// password in md5, global ip-address, mikrotik login, password, SMS-gateway-key will be use to send sms</span>
    <span class="hljs-string">'#ROUTERLOGIN#'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'mdpass'</span> =&gt; <span class="hljs-string">'#ROUTER_MD5_PASSWORD#'</span>,
                          <span class="hljs-string">'ip'</span> =&gt; <span class="hljs-string">'XXX.XXX.X.X'</span>,
                          <span class="hljs-string">'login'</span> =&gt; <span class="hljs-string">'#ROSAPI_LOGIN#'</span>,
                          <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'#PASSWORD#'</span>,
                          <span class="hljs-string">'smsgw'</span> =&gt; <span class="hljs-keyword">array</span>(
                                           <span class="hljs-comment">//    SMS     (   )</span>
                                           <span class="hljs-comment">// If you want send SMS randomly from any SMS-gateways, add one here (low modem load)</span>
                                           <span class="hljs-number">0</span> =&gt; <span class="hljs-string">'SMS_gw1'</span>)<font></font>
                          )<font></font>
    );<font></font>
<font></font>
<span class="hljs-comment">//       SMS- | ROUTERS DATA ARRAY WILL BE USED TO SEND AUTHERIZATION SMS</span>
$SMS_gateway = <span class="hljs-keyword">array</span>(
    <span class="hljs-comment">// ip-  (        ), , ,  USB-,  USB-</span>
    <span class="hljs-comment">// ip-address (global or local if used in one local network with server), login, password, USB-modem port, USB-modem channel</span>
    <span class="hljs-string">'SMS_gw1'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'ip'</span> =&gt; <span class="hljs-string">'XXX.XXX.X.X'</span>, <span class="hljs-string">'login'</span> =&gt; <span class="hljs-string">'#ROSAPI_LOGIN#'</span>, <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'#PASSWORD#'</span>, <span class="hljs-string">'port'</span> =&gt; <span class="hljs-string">'#USB_PORT#'</span>, <span class="hljs-string">'channel'</span> =&gt; <span class="hljs-string">'#USB_CHANNEL#'</span>)<font></font>
    );<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// INPUT DATA CHECK</span>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-keyword">if</span> (!$_REQUEST) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//    –  | if request free - reset</span>
<span class="hljs-keyword">if</span> (!$_REQUEST[<span class="hljs-string">'ruid'</span>]) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//    ruid -  | if ruid not isset – reset</span>
<span class="hljs-keyword">if</span> (!array_key_exists($_REQUEST[<span class="hljs-string">'ruid'</span>], $ruid_data)) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//     –  | if router does not exist – reset</span>
<span class="hljs-keyword">if</span> ($_REQUEST[<span class="hljs-string">'auth'</span>]) autorize(); <span class="hljs-comment">//    ,        | if auth request allow without password</span>
<span class="hljs-keyword">if</span> (!ruid_auth()) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//      SMS | check ruid password</span>
<span class="hljs-keyword">if</span> ($_REQUEST[<span class="hljs-string">'tel'</span>]) send_authcode(); <span class="hljs-comment">//    ,  SMS | if phone number isset – sending SMS</span><font></font>
<font></font>
<span class="hljs-comment">//          </span>
<span class="hljs-comment">// CHECK FOR ROUTER (ruid) IS IN ALLOWED LIST</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ruid_auth</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-keyword">if</span> (!$_REQUEST[<span class="hljs-string">'pass'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//     –  | if password not set - reset</span>
  <span class="hljs-comment">//  md5-  | check password md5-hash</span>
  <span class="hljs-keyword">if</span> (md5($_REQUEST[<span class="hljs-string">'pass'</span>]) == $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'mdpass'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ---------------------------------------------------------</span>
<span class="hljs-comment">//        ROS API</span>
<span class="hljs-comment">// SEND AUTHERIZATION SMS VIA ROS API FUNCTION</span>
<span class="hljs-comment">// ---------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send_authcode</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-keyword">global</span> $host;<font></font>
<font></font>
  <span class="hljs-comment">//    | Get random SMS-gateway</span>
  $sms_gw = $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'smsgw'</span>][array_rand($ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'smsgw'</span>], <span class="hljs-number">1</span>)]; <span class="hljs-comment">//  sms-</span>
  <span class="hljs-comment">//         | Generate auth-code and add to REQUEST array</span>
  $_REQUEST[<span class="hljs-string">'authcode'</span>] = substr(str_shuffle(<span class="hljs-string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNPQRSTUVWXYZ123456789'</span>), <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
  <span class="hljs-comment">//   | connect class</span>
  $API = <span class="hljs-keyword">new</span> RouterosAPI();
  <span class="hljs-comment">//     –  eng  </span>
  <span class="hljs-comment">// Create message that will be sent to user</span>
  $message = <span class="hljs-string">'To autorize user '</span>.$_REQUEST[<span class="hljs-string">'tel'</span>].<span class="hljs-string">' connection open – '</span>.$host.<span class="hljs-string">'?ruid='</span>.$_REQUEST[<span class="hljs-string">'ruid'</span>].<span class="hljs-string">'&amp;auth='</span>.$auth_code;
  <span class="hljs-comment">//    SMS | if connected successfully - sending message</span>
  <span class="hljs-keyword">if</span> ($API-&gt;connect($SMS_gateway[$sms_gw][<span class="hljs-string">'ip'</span>], $SMS_gateway[$sms_gw][<span class="hljs-string">'login'</span>], $SMS_gateway[$sms_gw][<span class="hljs-string">'password'</span>])) {
      <span class="hljs-comment">//   SMS | SMS send command</span>
      $ARRAY = $API-&gt;comm(<span class="hljs-string">"/tool/sms/send"</span>, <span class="hljs-keyword">array</span>(
      <span class="hljs-string">"port"</span>=&gt;$SMS_gateway[$sms_gw][<span class="hljs-string">'port'</span>],
      <span class="hljs-string">"channel"</span>=&gt;$SMS_gateway[$sms_gw][<span class="hljs-string">'channel'</span>],
      <span class="hljs-string">"phone-number"</span>=&gt;$_REQUEST[<span class="hljs-string">'tel'</span>],
      <span class="hljs-string">"message"</span>=&gt;<span class="hljs-string">"To autorize user "</span>.$_REQUEST[<span class="hljs-string">'tel'</span>].<span class="hljs-string">" connection open – "</span>.$host.<span class="hljs-string">"?ruid="</span>.$_REQUEST[<span class="hljs-string">'ruid'</span>].<span class="hljs-string">"&amp;auth="</span>.$_REQUEST[<span class="hljs-string">'authcode'</span>],));
      <span class="hljs-comment">//        ,     usb   </span>
      <span class="hljs-comment">// Checking if send failed and error message return, will make usb power-reset to restart modem</span>
      <span class="hljs-keyword">if</span>($ARRAY[<span class="hljs-string">'!trap'</span>]) {<font></font>
        $API-&gt;comm(<span class="hljs-string">"/system/routerboard/usb/power-reset"</span>);
        <span class="hljs-comment">//   | save log</span>
        <span class="hljs-comment">//       | Add error to array and save all array to log</span>
        $_REQUEST[<span class="hljs-string">'ERROR'</span>] = $ARRAY[<span class="hljs-string">'!trap'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'message'</span>];<font></font>
        writelog(<span class="hljs-string">'MODEM ERROR'</span>);
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'Stop with error: '</span>.$ARRAY[<span class="hljs-string">'!trap'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'message'</span>].<span class="hljs-string">' Making power reset of usb-port'</span>);}<font></font>
  }<font></font>
<font></font>
  $API-&gt;disconnect();<font></font>
  <span class="hljs-comment">//   | save log</span>
  writelog(<span class="hljs-string">'SEND AUTH CODE'</span>);
  <span class="hljs-keyword">die</span>($_REQUEST[<span class="hljs-string">'authcode'</span>]);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// --------------------------------------------------------------------</span>
<span class="hljs-comment">//    ROS API –   ADDRESS-LIST</span>
<span class="hljs-comment">// AUTHERIZATION USING ROS API FUNCTION – DELETE LIST FROM ADDRESS-LIST</span>
<span class="hljs-comment">// --------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">autorize</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-comment">//   | connect class</span>
  $API = <span class="hljs-keyword">new</span> RouterosAPI();
  <span class="hljs-keyword">if</span> ($API-&gt;connect($ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'ip'</span>], $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'login'</span>], $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'password'</span>])) {
    <span class="hljs-comment">//     | if connected successfully - sending command</span>
    $API-&gt;write(<span class="hljs-string">'/ip/firewall/address-list/print'</span>, <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'?comment='</span>.$_REQUEST[<span class="hljs-string">'auth'</span>], <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'=.proplist=.id'</span>);
    <span class="hljs-comment">//   | get response</span><font></font>
    $ARRAYS = $API-&gt;read();<font></font>
    <span class="hljs-comment">//      - - </span>
    <span class="hljs-comment">// IF NO RECORD IN FIREWALL ADDRESS_LIST – RESET</span>
    <span class="hljs-keyword">if</span> (!$ARRAYS[<span class="hljs-number">0</span>]) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>);
    <span class="hljs-comment">//   | delete firewall address-list</span>
    $API-&gt;write(<span class="hljs-string">'/ip/firewall/address-list/remove'</span>, <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'=.id='</span> . $ARRAYS[<span class="hljs-number">0</span>][<span class="hljs-string">'.id'</span>]);<font></font>
    $READ = $API-&gt;read();<font></font>
  }<font></font>
  $API-&gt;disconnect();<font></font>
  <span class="hljs-comment">//   | save log</span>
  writelog(<span class="hljs-string">'AUTHERIZATION'</span>);<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-comment">// SHOW SUCCESS PAGE TO USER</span>
  <span class="hljs-keyword">die</span>(<span class="hljs-string">'
      &lt;!DOCTYPE html&gt;
      &lt;html lang="ru"&gt;
      &lt;meta http-equiv="Content-Type" content="charset=utf-8" /&gt;
      &lt;body style="font-family: Verdana, Arial, Helvetica, sans-serif; background-color: #282c34; color: #fff; height: 100vh; display: flex;"&gt;
        &lt;div style="margin: auto; max-width: 50%;"&gt;
          &lt;p style="font-size: 24pt; font-weight: bold; margin: -300px 0 50px;"&gt;
            VPN-   ,   
          &lt;/p&gt;
          &lt;p style="font-size: 14pt; color: #aaa;"&gt;
                     &lt;br/&gt;
          &lt;/p&gt;
        &lt;/div&gt;
      &lt;/body&gt;
      &lt;/html&gt;
    '</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// SAVE LOG FUNCTION</span>
<span class="hljs-comment">// ------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writelog</span>(<span class="hljs-params">$type</span>) </span>{
  <span class="hljs-keyword">global</span> $uselog;
  <span class="hljs-keyword">global</span> $log_path;
  <span class="hljs-comment">//  $uselog == false – </span>
  <span class="hljs-keyword">if</span> (!$uselog) <span class="hljs-keyword">return</span>;
  <span class="hljs-comment">//   | save log</span>
  $fp = fopen($log_path, <span class="hljs-string">'a'</span>);<font></font>
  fputs($fp, <span class="hljs-string">"\n\nDate = "</span> . date(<span class="hljs-string">"Y-m-d H:i:s"</span>).<span class="hljs-string">"\n"</span>);<font></font>
  fputs($fp, $type.<span class="hljs-string">"\n"</span>);<font></font>
  fputs($fp, print_r($_REQUEST, <span class="hljs-literal">true</span>));<font></font>
  fclose($fp);<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RouterOS API kelas PHP yang digunakan dalam kode dapat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diambil di GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih atas perhatian Anda. </font><font style="vertical-align: inherit;">Saya akan senang dengan komentar apa pun.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id506698/index.html">Requiem untuk "Sea Launch"</a></li>
<li><a href="../id506700/index.html">Kami mengonfigurasi Tindakan GitHub untuk Android dengan penerapan berikutnya di PlayMarket</a></li>
<li><a href="../id506702/index.html">HDD yang paling andal menurut Backblaze Q1 2020</a></li>
<li><a href="../id506704/index.html">Mengapa menulis dalam PHP pada tahun 2020? Holivarim adalah podcast interaktif di Youtube Kamis ini</a></li>
<li><a href="../id506706/index.html">Kinerja Java modern ketika bekerja dengan sejumlah besar data, bagian 1</a></li>
<li><a href="../id506710/index.html">Kelola beberapa buku alamat di Edisi Terbuka Sumber-Sumber Zimbra Collaboration</a></li>
<li><a href="../id506716/index.html">Daftar Lini Multithreaded: Masalah Keberadaan Elemen, Peningkatan Kinerja, dan Hubungan STL</a></li>
<li><a href="../id506726/index.html">Pengalaman dalam menggunakan teknologi Rutoken untuk registrasi dan otorisasi pengguna dalam sistem (bagian 2)</a></li>
<li><a href="../id506730/index.html">Mendengus atau Suricata. Bagian 1: pilih IDS / IPS gratis untuk melindungi jaringan perusahaan</a></li>
<li><a href="../id506732/index.html">Penggunaan kembali komponen UI di seluruh organisasi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>