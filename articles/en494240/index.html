<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò© üèπ üè© Sandbox customization: why you need it right now üì∑ üôè üåù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The issue of customizing sandbox images has been relevant since their inception. The first versions of such programs were internal solutions of inform...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sandbox customization: why you need it right now</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/494240/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/w0/kd/as/w0kdasxxfgrntuq6bpubjtse6ym.png"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The issue of customizing sandbox images has been relevant since their inception. </font><font style="vertical-align: inherit;">The first versions of such programs were internal solutions of information security companies, but even then there was a need for painstaking tuning of isolated machines. </font><font style="vertical-align: inherit;">And it was not only the installation of auxiliary software for monitoring the state of the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even 10 years ago, the logic of collecting and processing environmental characteristics was embedded in malicious samples: username and computer, home or corporate domain, administrator rights, language layout, number of processor cores, version of the operating system, the presence of antivirus software, signs of virtualization, and even the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presence of updates in system</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To date, the number of parameters and methods for obtaining them has only increased.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sandbox Bypass Malware Techniques</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, the approach was fairly straightforward: if the malware checks the user with the name test, then we‚Äôll call him John; if we use the registry key SYSTEM \ CurrentControlSet \ Enum \ SCSI \ Disk &amp; Ven_VMware_ &amp; Prod_VMware_Virtual_S to find out if we are in a virtual environment, then (if possible) we will replace the key or the returned results by intercepting the call. As a result of numerous studies, a certain knowledge base of detection bypass methods was recruited, which was then used to set up the environment. Years passed, virus writers ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and not only</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) increasingly began to use this knowledge in their work, which ultimately led to the following.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The question "Is this a research environment?" </font><font style="vertical-align: inherit;">was replaced by "Is the environment interesting?" </font><font style="vertical-align: inherit;">And the interest is not in finding traces of some FTP client for subsequent data theft. </font><font style="vertical-align: inherit;">Now, if this is the machine of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an accounting employee</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> who uses specific software, then another thing. </font><font style="vertical-align: inherit;">There are other approaches: infect the user with a lightweight bootloader that collects all the necessary information about the system, sends it to the management server and ... does not receive the payload in response. </font><font style="vertical-align: inherit;">Unknown server logic has decided that this victim is not of interest.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we see: sandboxes configured by default are not an effective business solution. </font><font style="vertical-align: inherit;">Attackers are increasingly relying not on self-defense against detection, but on narrowing the range of search for interesting targets for the further development of the attack.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we fight them?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In simple words, we offer to make a unique image of an isolated environment. </font><font style="vertical-align: inherit;">The goal is to recreate an environment that is as similar as possible to an employee‚Äôs workstation with attractive access for attackers: a finance department, a build server for continuous integration during development, a web server, a domain administrator‚Äôs machine, and, finally, a CEO‚Äôs station.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, for such a task, you can release a number of blanks with the appropriate software ‚Äúon board‚Äù, but then you need to start them with specific data that corresponds to a particular organization: the domain name, the resources or applications used, the names and contents of working documents - the more nuances, the better . </font><font style="vertical-align: inherit;">Sometimes the environment needs to be finely tuned, up to system update versions and patches. </font><font style="vertical-align: inherit;">In the simplest case, the image can be made simply "full of holes." </font><font style="vertical-align: inherit;">However, if your IT infrastructure park is not older than certain versions, this can also be taken into account and eliminated a lot of irrelevant penetration vectors using a certain number of vulnerabilities.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get an image that is unknown to virus writers, is really of interest to them, and thereby greatly increase the likelihood of detecting a targeted attack.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do I need to emulate the work of a "live" computer? </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Emulation of user actions is a must-have, without which the sandbox loses its effectiveness. </font><font style="vertical-align: inherit;">In some cases, the absence of actions will lead to detection of the presence in the sandbox: for example, if the mouse cursor does not change its position for a long time, new windows do not appear, applications are not terminated or they are launched too little, if new files do not appear in temporary directories, no network activity. </font><font style="vertical-align: inherit;">In other situations, this will affect the operation of the malware itself: for example, to run it, the user‚Äôs consent to include macros in the office document is required, or the Trojan will show an intermediate dialog box in which it will be necessary to agree with something (or from something refuse) to continue his work.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes insignificant actions are simply necessary: ‚Äã‚Äãthe user must open some document and write something down or copy the password to the clipboard for further input - it is precisely at such moments that a spy trojan can work, which will intercept important data and send it to its author‚Äôs server.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is this done with us?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our solution is gradually being replenished with new actions that emulate the work of a living user. </font><font style="vertical-align: inherit;">Of course, the predefined sequences of planned events of any complexity can never be compared with the variety of real use. </font><font style="vertical-align: inherit;">We continue to research and improve this side of the product, increasing its effectiveness.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the functions described above, it is worth noting a fundamental feature: our sandbox belongs to the class of agentless ones. In most solutions, there is an auxiliary agent inside the virtual machine that is responsible for managing the state of the system, receiving and transmitting interesting events and artifacts to the host server. Despite the advantages in monitoring and the clear principle of interaction between the host and guest machines, this solution has a significant drawback: the need to hide and protect objects associated with the agent from malware. In the case when there is no event provider, the question arises: how, then, to get information about what is happening inside the virtual machine? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this we use the technology </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extended Page Table</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(EPT) Intel Corporation. </font><font style="vertical-align: inherit;">It is an intermediate memory page that sits between the guest physical memory and the host physical memory. </font><font style="vertical-align: inherit;">In short, this allows you to do the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">examine the display of the guest‚Äôs memory pages;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">highlight interesting sections (for example, containing addresses or code of nuclear functions);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mark the selected pages so that the access rights to the memory pages in the EPT do not coincide with the access rights to the pages in the guest machine;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to catch the appeal to the marked up sections of memory (at this moment an access error (#PF) will occur, as a result the guest machine will be suspended)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyze the state, extract the necessary information about the event;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">re-layout the memory page in the correct state;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore the guest machine.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitoring everything that happens is carried out outside the isolated machine. The malware that is inside cannot detect the fact of observation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Running a sample in the sandbox and analyzing its behavior is just one of the components of a complex product. After starting, the process memory is scanned for malicious code, network activity is recorded, which is then analyzed using more than 5000 detection rules. In addition, it is possible to decrypt secure interactions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All indicators of compromise (IOC), which were able to identify during the study, are checked by reputation lists. </font><font style="vertical-align: inherit;">Before undergoing dynamic analysis, the sample is sent for static processing: it is prefiltered on several antiviruses and scanned by our own engine with detection rules from experts of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expert security center</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (PT Expert Security Center). </font><font style="vertical-align: inherit;">We use a comprehensive examination, including to identify anomalies in meta-information and embedded artifacts of the sample.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What tasks does PT Sandbox do best and why?</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PT Sandbox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> combines the knowledge and experience of several teams and products to counter targeted attacks. </font><font style="vertical-align: inherit;">Despite the fact that the product can be used in the mode of countering threats (prevention), it is still primarily a means of monitoring (detection) the security of IT systems. </font><font style="vertical-align: inherit;">The key difference from the classic endpoint protection solutions is that PT Sandbox's task is to pay attention to anomalies and register a previously unknown threat. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Posted by</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alexey Vishnyakov, Senior Specialist, Threat Technologies Research Group, Positive Technologies</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494228/index.html">3D printing in the creation of the Boeing 777</a></li>
<li><a href="../en494230/index.html">AI vs. COVID-19: Hubei and Florida Experience</a></li>
<li><a href="../en494232/index.html">Why are there bugs in the brain?</a></li>
<li><a href="../en494234/index.html">A selection of VR helmets for industrial applications</a></li>
<li><a href="../en494238/index.html">Lessons learned in 3 years of remote work so as to remain in a sober mind and bright memory</a></li>
<li><a href="../en494242/index.html">Bayesian Ninja</a></li>
<li><a href="../en494244/index.html">Exchange and risk management: 5 tips for diversifying your investment portfolio</a></li>
<li><a href="../en494252/index.html">3D printing: three and a half houses in four days</a></li>
<li><a href="../en494254/index.html">OpenShift as an enterprise version of Kubernetes</a></li>
<li><a href="../en494256/index.html">Who else needs Selenium? Does anyone use BDD in 2020? Machine Learning at Selenium</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>