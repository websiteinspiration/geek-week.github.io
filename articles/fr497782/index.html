<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèø üë©üèΩ‚Äç‚úàÔ∏è üçù Toutes les √©tapes de la cr√©ation d'un robot pour suivre la ligne, ou comment collecter tous les r√¢teaux avec STM32 üë≥ ‚òùüèæ üë©üèª‚Äçü§ù‚Äçüë®üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Cette publication discutera de mon exp√©rience dans la cr√©ation d'un robot pour les comp√©titions, √† savoir suivre la ligne. Je vais ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Toutes les √©tapes de la cr√©ation d'un robot pour suivre la ligne, ou comment collecter tous les r√¢teaux avec STM32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497782/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette publication discutera de mon exp√©rience dans la cr√©ation d'un robot pour les comp√©titions, √† savoir suivre la ligne. </font><font style="vertical-align: inherit;">Je vais essayer de raconter toutes les √©tapes de la conception des circuits et de la commande d'une carte de circuit imprim√© √† un algorithme et un programme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La course des robots le long de la ligne a longtemps √©t√© un test de base pour la robotique d√©butante. </font><font style="vertical-align: inherit;">Presque toutes les comp√©titions r√©gionales et internationales incluent cette direction, donc en faisant un robot, vous pouvez participer presque partout. </font><font style="vertical-align: inherit;">En premi√®re ann√©e d'universit√©, c'√©tait la t√¢che suivante apr√®s le premier clignotement de la LED.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation du probl√®me</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d√©veloppement commence par une mission technique, dans notre cas, les r√®gles de comp√©tition des comp√©titions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robofinist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont utilis√©es comme savoirs traditionnels </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous sommes int√©ress√©s par les exigences de dimensions (pas plus de 25x25x25 cm) et le poids du robot (pas plus de 1 kg), ainsi que la forme de la piste et sa largeur de 1,5 cm. Selon la complexit√© de la piste, un seuil est fix√© pour le temps minimum de passage (60 sec. ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che est claire, nous avons besoin d'un robot capable de d√©tecter une ligne et de la suivre du d√©but √† la fin en un minimum de temps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concept de design</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le c≈ìur du robot est le microcontr√¥leur STM32F103C8T6, il lit les informations de piste √† l'aide de capteurs optiques QRE1113 et contr√¥le les moteurs via le pilote A3906. Pour plus de clart√©, les capteurs re√ßoivent chacun leur propre LED, d√®s que le capteur "voit" la ligne noire, la LED s'allume, ce qui simplifie consid√©rablement le processus de d√©bogage. Comme source d'alimentation, une batterie Li-po de type 18650 avec une tension de 3,7 V et une puce de charge LTC4054ES5 ont √©t√© choisies. Mais pour le bon fonctionnement des moteurs, au moins 6 V sont n√©cessaires, j'ai donc install√© le convertisseur √©l√©vateur DC-DC LM2577 et le LM1117 lin√©aire 3,3 V pour alimenter la partie logique.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/aa5/0a0/ddf/aa50a0ddf75671c4ee28137f1fbf8c47.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est temps de parler des premi√®res erreurs. Inattentivement m√©lang√© une paire de broches d'alimentation de microcontr√¥leur et au d√©marrage a pass√© plusieurs heures √† chercher un probl√®me, en cons√©quence j'ai d√ª les mordre. Ensuite, le probl√®me est survenu que tous les capteurs n'ont pas r√©agi √† la ligne, ma premi√®re r√©action a √©t√© que j'ai br√ªl√© le microcontr√¥leur ou que les jambes cass√©es de l'alimentation √† la derni√®re √©tape n'√©taient pas du tout superflues, ou que j'ai mal soud√© les contacts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant un oscilloscope, j'ai trouv√© que le probl√®me √©tait dans les capteurs eux-m√™mes, sur 10 capteurs 4 ne fonctionnaient pas, en les rempla√ßant par de nouveaux, le probl√®me suivant est apparu - trois LED d'indication PB3, PB4 et PA15 ne fonctionnaient pas. Apr√®s avoir r√©√©crit et parcouru tout mon code, je n'ai trouv√© aucune diff√©rence dans l'initialisation des ports non fonctionnels et fonctionnels partout o√π Push Pull, 10 MHz et horloge √©taient activ√©s. Apr√®s avoir regard√© l'oscillogramme, j'ai remarqu√© qu'une broche √©tait attir√©e par le plus et m√™me en mode d√©bogage, elle ne s'est pas r√©initialis√©e du tout, j'ai r√©alis√© que le microcontr√¥leur √©tait br√ªl√©. En fermant la fiche technique, j'ai remarqu√© que par une √©trange co√Øncidence, ces broches sont utilis√©es pour JTAG, et j'utilise SWD, mais ayant d√©cid√© que cela n'empirerait pas, j'ai commenc√© √† chercher comment d√©sactiver JTAG et cela a vraiment aid√© (voir ci-dessous).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mini conclusion, v√©rifiez la bonne nutrition √† toutes les √©tapes afin de ne pas penser que quelque chose a br√ªl√© plus tard ou que cela ne fonctionne pas pour d'autres raisons.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qui doit √™tre am√©lior√© dans le sch√©ma</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai devin√© de mettre la puce de charge, mais j'ai oubli√© la d√©charge, bien qu'elle ne soit pas moins importante, et en 2020 j'ai mis un mini USB au lieu du type C.J'aimerais utiliser le microcontr√¥leur pour surveiller la charge de la batterie, mais il n'y avait plus de broches ADC. </font><font style="vertical-align: inherit;">Lors du choix d'un pilote, je me suis appuy√© sur les caract√©ristiques du moteur 6 V et 700 mA, mais je n'ai pas tenu compte du fait que sa tension maximale est de 9 V, mais j'aimerais 12 V.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conception de PCB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, il a √©t√© d√©cid√© de d√©terminer la taille et la forme du PP et de la plateforme √† temps partiel du robot. Nous rappelons que selon la r√©glementation, les dimensions ne doivent pas d√©passer 25x25 cm, mais il convient √©galement de consid√©rer que lors de la commande de logiciels dans une usine (PCBWay) en Chine, les planches de plus de 10x10 cm augmentent de mani√®re significative en prix. Je pense que le choix des dimensions est √©vident. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez r√©partir les capteurs sym√©triquement (au bas de la carte), en tenant compte de la largeur de la ligne, puis des √©l√©ments les plus lourds, tels que les moteurs et la batterie. Les LED sont mont√©es sur le m√™me axe que les capteurs correspondants, du c√¥t√© oppos√© de la carte. Pour plus de commodit√©, nous installons un interrupteur d'alimentation et un connecteur de charge de batterie √† l'arri√®re de la plate-forme. Les √©l√©ments restants sont plac√©s plus pr√®s du centre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir coup√© les bords vides de la planche au lieu d'un carr√©, une image compl√®tement d√©cente de la plate-forme du robot est obtenue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tableau s'est av√©r√© assez simple en raison du petit nombre d'√©l√©ments uniques. </font><font style="vertical-align: inherit;">Total 2 couches d'√©paisseur minimale de voie 0,25 mm. </font><font style="vertical-align: inherit;">Apr√®s avoir enregistr√© la carte m√®re au format Gerber, je l'ai envoy√©e √† l'usine en s√©lectionnant la couleur blanche du masque, puis je n'ai eu aucun probl√®me particulier. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/57e/f74/2c8/57ef742c8e35e324720908b0758200cc.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et une vue 3D de la planche avec les √©l√©ments. </font><font style="vertical-align: inherit;">La photo en direct sera √† la fin.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/37f/a8b/65d/37fa8b65d80595744c2e2436490b304e.jpg" alt="image"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qui doit √™tre finalis√© dans le tableau</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai install√© certains √©l√©ments trop pr√®s du bo√Ætier en plastique de la batterie et il √©tait difficile de les souder, et encore plus difficile √† souder. </font><font style="vertical-align: inherit;">J'ai oubli√© de signer le brochage du connecteur de programmation SWD, UART et des moteurs, par cons√©quent, je dois regarder dans le circuit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Achat de composants</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le d√©veloppement de tout ce qui est nouveau n√©cessite les co√ªts relatifs par unit√© de marchandise les plus √©lev√©s, vous pouvez et devez essayer d'√©conomiser, mais dans des limites raisonnables, donc en commandant des capteurs de ligne pour Aliexpress 4,5 fois moins cher que dans un magasin d'√©lectronique, j'ai pay√© le fait qu'environ 40% d'entre eux se sont av√©r√©s √™tre ne fonctionne pas, et c'est le moment de trouver et de corriger les erreurs. </font><font style="vertical-align: inherit;">En revanche, je ne voulais pas acheter la puce LM2577 pour 460 roubles, alors que le module avec tout le cerclage co√ªte 100 roubles. </font><font style="vertical-align: inherit;">J'ai command√© une partie des pi√®ces √† Ali, une autre pi√®ce dans un magasin local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici mes co√ªts de composants estim√©s:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moteurs et roues - 800 roubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batterie et bo√Ætier - 400 roubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chargeur - 300 roubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontr√¥leur et pilote - 200 roubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stabilisateurs - 400 roubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frais 10 unit√©s avec livraison 2400/10 = 240 roubles par unit√©;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le reste du harnais - 150 roubles.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4650 roubles co√ªt total pour les composants, ou 2490 si vous soustrayez le prix des neuf cartes inutilis√©es restantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: J'ai commenc√© √† calculer le co√ªt de l'installation des cartes et des composants et par lot de 10 unit√©s. </font><font style="vertical-align: inherit;">le prix est pass√© √† 16 000 roubles. </font><font style="vertical-align: inherit;">Il y a des id√©es pour optimiser mais c'est une autre fois.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme impl√©ment√© le plus simple, si la ligne s'est av√©r√©e √™tre, par exemple, du c√¥t√© droit, alors le moteur droit commencera √† ralentir et plus la ligne sera proche du bord, plus le moteur fonctionnera lentement jusqu'√† ce qu'il s'arr√™te compl√®tement, tandis que le moteur gauche fonctionnera √† la vitesse maximale essayant de se tourner vers la ligne. </font><font style="vertical-align: inherit;">Une situation similaire si la ligne est du c√¥t√© gauche. </font><font style="vertical-align: inherit;">Ainsi, le robot essaie de se stabiliser, renvoyant la ligne aux capteurs centraux.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22b/07d/9ab/22b07d9ab0c0795c33cda8c42236e18f.jpg" alt="image"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithme en images</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ae3/234/6c5/ae32346c5611292cf0b7fc155317da5a.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b47/403/545/b47403545480435eed6c7b362dbad0bd.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5d8/55b/68c/5d855b68c11937aa1196d6d281c5c939.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/481/545/42c4815453ca35de5c6dc32570e09506.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/587/7ee/4db/5877ee4db1610d2aab5ace1af4cd27b3.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √©galement n√©cessaire de pr√©voir d'autres situations, par exemple, si tous les capteurs ont d√©tect√© une ligne, cela signifie tr√®s probablement que nous traversons l'intersection et que nous devons tr√®s probablement aller plus loin. </font><font style="vertical-align: inherit;">Ou si seuls les capteurs extr√™mes ont d√©tect√© la ligne, nous sommes arriv√©s √† la ligne d'arriv√©e et nous devons nous arr√™ter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce stade, vous devez obtenir un tambourin et le battre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âcrit dans Atollic True Studio utilis√© uniquement CMSIS et FreeRTOS. A pass√© une demi-semaine pour lancer FreeRTOS, a tout fait conform√©ment aux instructions, mais a d√©tect√© des erreurs pendant le processus de compilation, le correctif 1, 63 est apparu, ou il n'y a pas eu d'erreurs, mais le contr√¥leur s'est √©cras√©. √Ä un moment donn√©, j'ai r√©alis√© que le niveau de ma main ... atteignait des sommets sans pr√©c√©dent et qu'il √©tait temps de penser √† ce que je faisais et √† ce que je faisais. Gr√¢ce aux camarades de la communaut√©, j'ai commenc√© √† creuser dans la bonne direction et √† partir de nombreuses sources redessin√©es, j'en ai trouv√© plusieurs qui m'ont aid√© (voir ci-dessous). En cons√©quence, j'ai r√©ussi √† vaincre FreeRTOS et jusqu'√† pr√©sent, je l'ai utilis√© √† 0%, car j'ai tout bourr√© dans une seule t√¢che. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et cet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m'ont le plus aid√© </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le syst√®me de chronom√©trage, ici, je ne sais toujours pas s'il fonctionne comme il se doit. Apr√®s avoir r√©gl√© la fr√©quence du syst√®me via la PLL √† 48 MHz, j'ai vu 24 MHz (/ 2) au pied de l'AGC, non, j'ai vu un signal de 22-25 MHz ressemblant √† distance √† un sinus. Dans le m√™me temps, j'ai d√©fini 48 MHz dans la configuration FreeRTOS et d√©fini le d√©lai √† 500 ms et l'ai ex√©cut√©, j'ai vu que mes 500 ms se transformaient en 300, j'ai parcouru tous les param√®tres possibles, j'ai remarqu√© que j'obtenais la cible de 500 ms uniquement lorsque le g√©n√©rateur interne √©tait cadenc√© √† 8 MHz et la valeur de fr√©quence La configuration de FreeRTOS n'a pas affect√© du tout, r√©gl√©e √† la fois sur 1 Hz et 48 GHz. J'ai d√©cid√© de renvoyer 48 MHz et de travailler avec 300 ms, apr√®s quoi j'ai accidentellement red√©marr√© True Studio et cela a fonctionn√© √† merveille comme je le pensais, et d√®s le d√©but, j'ai d√©j√† indiqu√© tous les chemins de fichiers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me des JTAG et des LED, d√©crit ci-dessus, la solution a √©t√© trouv√©e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et il vous suffit de le d√©sactiver, lib√©rant ainsi l'acc√®s aux broches PB3, PB4 et PA15.</font></font><br>
<br>
<pre><code class="cpp hljs">AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure du projet est approximativement la suivante:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beaucoup de code</font></font></b>
                        <div class="spoiler_text">1.   ;<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{						<span class="hljs-comment">// Quartz 16 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLXTPRE;	<span class="hljs-comment">// PLLXTPRE set divider (/2) = 8 MHz</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_HSEON;			<span class="hljs-comment">// On HSE</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_HSERDY)) {<font></font>
	};<font></font>
<font></font>
	RCC-&gt;CFGR |= (RCC_CFGR_PLLMULL6);     <span class="hljs-comment">// Setup PLLMULL set multiplier (x6) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLSRC;		<span class="hljs-comment">// PLLSRC set HSE</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_PLLON;			<span class="hljs-comment">// ON PLL</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_PLLRDY)) {<font></font>
	};<font></font>
<font></font>
	FLASH-&gt;ACR &amp;= ~FLASH_ACR_LATENCY;	<span class="hljs-comment">// Setup FLASH</span><font></font>
	FLASH-&gt;ACR |= FLASH_ACR_LATENCY_1;<font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_HPRE_DIV1; 	<span class="hljs-comment">// Set not divider (AHB) = 48 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE1_DIV2; 	<span class="hljs-comment">// Set divider (/2) (APB1) = 24 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE2_DIV1; 	<span class="hljs-comment">// Set not divider (APB2) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR &amp;= ~RCC_CFGR_SW; 		<span class="hljs-comment">// Setup SW, select PLL</span><font></font>
	RCC-&gt;CFGR |= RCC_CFGR_SW_PLL;<font></font>
<font></font>
<span class="hljs-comment">//	RCC-&gt;CFGR |= RCC_CFGR_MCO_SYSCLK;</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
2.  ,      ,     ,      Push Pull;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GPIO_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB2ENR |=	(RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN); <span class="hljs-comment">// Enable clock portA, portB and Alternative function</span><font></font>
<font></font>
	AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;	<span class="hljs-comment">// Disable JTAG for pins B3,B4 and A15</span><font></font>
<font></font>
	<span class="hljs-comment">//---------------LED: (B3 to B9; A11, A12, A15); Output mode: Push Pull, max 10 MHz---------------//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE3_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE4_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup B4 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE5_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup B5 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE6_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup B6 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE7_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);	<span class="hljs-comment">// Setup B7 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF9 | GPIO_CRH_MODE9);	<span class="hljs-comment">// Setup B8 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE9_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF11 | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup A11 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE11_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);	<span class="hljs-comment">// Setup A12 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE12_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF15 | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup A15 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE15_0;<font></font>
<font></font>
	<span class="hljs-comment">//--Motors: (A8 to A10; B12 to B15); Output and input (B12, B13) mode: Alternative function, PWM - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);		<span class="hljs-comment">// Setup B12 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13);		<span class="hljs-comment">// Setup B13 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF14   | GPIO_CRH_MODE14);	<span class="hljs-comment">// Setup B14 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  GPIO_CRH_MODE14_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF15   | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup B15 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF15_1 | GPIO_CRH_MODE15_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF9    | GPIO_CRH_MODE9);		<span class="hljs-comment">// Setup A9 pins PP, AF, 10MHz</span><font></font>
	GPIOA-&gt;CRH |=  (GPIO_CRH_CNF9_1  | GPIO_CRH_MODE9_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF10 | GPIO_CRH_MODE10);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE10_0;<font></font>
<font></font>
	<span class="hljs-comment">//--UART3: (B10 - TX; B11 - RX); Output mode: Alternative function, UART - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10   | GPIO_CRH_MODE10);	<span class="hljs-comment">// Setup B10 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF10_1 | GPIO_CRH_MODE10_0);<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF11   | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup B11 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF11_1 | GPIO_CRH_MODE11_0);<font></font>
<font></font>
	<span class="hljs-comment">//--Optical sensors: (B0, B1, A0 - A7); Input mode: Analog--//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup B0 pins analog input</span>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup B1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup A0 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup A1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF2 | GPIO_CRL_MODE2);	<span class="hljs-comment">// Setup A2 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup A3 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup A4 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup A5 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup A6 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup A7 pins analog input</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
3.       DMA,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ADC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	 RCC-&gt;AHBENR |= RCC_AHBENR_DMA1EN;<font></font>
	 DMA1_Channel1-&gt;CPAR = (<span class="hljs-keyword">uint32_t</span>) &amp;ADC1-&gt;DR;		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CMAR = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>) adc_buf;   	<span class="hljs-comment">//    </span><font></font>
<font></font>
	 DMA1_Channel1-&gt;CNDTR = <span class="hljs-number">10</span>;			  				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;			   		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MSIZE_0;		  		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_PSIZE_0;		 		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MINC;			  	<span class="hljs-comment">// memory increment mode</span><font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_CIRC;<font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_TCIE;				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;				  	<span class="hljs-comment">//  </span>
	 NVIC_SetPriority(DMA1_Channel1_IRQn, <span class="hljs-number">10</span>);<font></font>
	 NVIC_EnableIRQ(DMA1_Channel1_IRQn);<font></font>
<font></font>
	 RCC-&gt;CFGR &amp;= ~RCC_CFGR_ADCPRE;<font></font>
	 RCC-&gt;CFGR |= RCC_CFGR_ADCPRE_DIV8;<font></font>
	 RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN;<font></font>
<font></font>
	 ADC1-&gt;SQR3 = <span class="hljs-number">0</span>;			<span class="hljs-comment">// 1</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 2     </span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 3</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 4</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">20</span>;		<span class="hljs-comment">// 5</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">5</span> &lt;&lt; <span class="hljs-number">25</span>;		<span class="hljs-comment">// 6</span>
	 ADC1-&gt;SQR2 = <span class="hljs-number">6</span>;			<span class="hljs-comment">// 7</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">7</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 8</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 9</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 10</span><font></font>
<font></font>
	 ADC1-&gt;CR2 = ADC_CR2_EXTSEL_0 | ADC_CR2_EXTSEL_1 | ADC_CR2_EXTSEL_2<font></font>
	 | ADC_CR2_EXTTRIG;<font></font>
	 ADC1-&gt;SMPR1 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//   </span>
	 ADC1-&gt;SMPR2 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//</span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 0,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">1</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 1,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">2</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 2,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">3</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 3,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">4</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 4,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 5,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">6</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 6,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">7</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 7,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">8</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 8,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">9</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 9,   6 </span>
	 ADC1-&gt;SMPR1 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 10,   6 </span><font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_RSTCAL;<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_RSTCAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_CAL;<font></font>
<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_CAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;SQR1 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">20</span>;						<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR1 |= ADC_CR1_SCAN;					<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR2 |= ADC_CR2_DMA;				  	<span class="hljs-comment">// DMA on</span>
	 <span class="hljs-comment">// ADC1-&gt;CR2 |= ADC_CR2_CONT;</span><font></font>
<font></font>
	 <span class="hljs-comment">//  ADC1-&gt;CR2 |= ADC_CR2_SWSTART;</span><font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
}<font></font>
</code></pre><br>
4.        ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM1_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	<span class="hljs-comment">/*************** Enable TIM1 (CH1) ***************/</span><font></font>
	RCC-&gt;APB2ENR |= RCC_APB2ENR_TIM1EN;<font></font>
	TIM1-&gt;CCER = <span class="hljs-number">0</span>;										<span class="hljs-comment">//  CCER ( )</span>
	TIM1-&gt;ARR = <span class="hljs-number">1000</span>; 									<span class="hljs-comment">//  ,     </span>
	TIM1-&gt;PSC = <span class="hljs-number">48</span> - <span class="hljs-number">1</span>;                					<span class="hljs-comment">// </span>
	TIM1-&gt;BDTR |= TIM_BDTR_MOE;     					<span class="hljs-comment">//     </span><font></font>
<font></font>
	TIM1-&gt;CCR2 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= (TIM_CCER_CC2P |TIM_CCER_CC2E); 		<span class="hljs-comment">//        </span>
														<span class="hljs-comment">//   -   3</span>
	TIM1-&gt;CCR3 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= TIM_CCER_CC3NE; 						<span class="hljs-comment">//        </span><font></font>
	TIM1-&gt;CCER &amp;= ~TIM_CCER_CC3NP;<font></font>
<font></font>
	TIM1-&gt;CR1 |= TIM_CR1_CEN;<font></font>
}<font></font>
</code></pre><br>
5.  UART  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> </a>     ;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB1ENR |= RCC_APB1ENR_USART3EN;<font></font>
<font></font>
	USART3-&gt;BRR = <span class="hljs-number">0xD0</span>;						<span class="hljs-comment">// Speed = 115200; (24 000 000 + (115200 / 2)) / 115200 = 208 -&gt; 0xD0</span><font></font>
<font></font>
	USART3-&gt;CR1 |= USART_CR1_TE | USART_CR1_RE | USART_CR1_UE;<font></font>
<font></font>
<span class="hljs-comment">//	USART3-&gt;CR1 |= USART_CR1_RXNEIE;</span>
<span class="hljs-comment">//	NVIC_EnableIRQ(USART3_IRQn);</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send</span><span class="hljs-params">(<span class="hljs-keyword">char</span> chr)</span> </span>{
	<span class="hljs-keyword">while</span> (!(USART3-&gt;SR &amp; USART_SR_TC))<font></font>
		;<font></font>
	USART3-&gt;DR = chr;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_String</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* str)</span> </span>{
	<span class="hljs-keyword">uint8_t</span> i = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (str[i])<font></font>
		UART3_Send(str[i++]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_Number_Float</span><span class="hljs-params">(<span class="hljs-keyword">float</span> data)</span></span>{<font></font>
<font></font>
	<span class="hljs-keyword">char</span> str[<span class="hljs-number">100</span>];<font></font>
<font></font>
	<span class="hljs-keyword">char</span> *tmpSign = (data &lt; <span class="hljs-number">0</span>) ? <span class="hljs-string">"-"</span> : <span class="hljs-string">""</span>;
	<span class="hljs-keyword">float</span> tmpVal = (data &lt; <span class="hljs-number">0</span>) ? -data : data;<font></font>
<font></font>
	<span class="hljs-keyword">int</span> tmpInt1 = tmpVal;                  <span class="hljs-comment">// Get the integer (678).</span>
	<span class="hljs-keyword">float</span> tmpFrac = tmpVal - tmpInt1;      <span class="hljs-comment">// Get fraction (0.0123).</span>
	<span class="hljs-keyword">int</span> tmpInt2 = trunc(tmpFrac * <span class="hljs-number">10</span>);  <span class="hljs-comment">// Turn into integer (123).	int tmpInt2 = trunc(tmpFrac * 10000)</span><font></font>
<font></font>
	<span class="hljs-comment">// Print as parts, note that you need 0-padding for fractional bit.</span><font></font>
<font></font>
	<span class="hljs-built_in">sprintf</span> (str, <span class="hljs-string">"%s%d.%01d"</span>, tmpSign, tmpInt1, tmpInt2);<font></font>
<font></font>
	UART3_Send_String(str);<font></font>
}<font></font>
</code></pre><br>
6.     FreeRtos config<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*
 * FreeRTOS Kernel V10.3.1
 * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * http://www.FreeRTOS.org
 * http://aws.amazon.com/freertos
 *
 * 1 tab == 4 spaces!
 */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> FREERTOS_CONFIG_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREERTOS_CONFIG_H</span><font></font>
<font></font>
<span class="hljs-comment">/* Library includes. */</span>
<span class="hljs-comment">//#include "stm32f10x_lib.h"</span>
<span class="hljs-comment">/*-----------------------------------------------------------
 * Application specific definitions.
 *
 * These definitions should be adjusted for your particular hardware and
 * application requirements.
 *
 * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE
 * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE. 
 *
 * See http://www.freertos.org/a00110.html
 *----------------------------------------------------------*/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler		<span class="hljs-comment">// fix problem</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortPendSVHandler PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortSysTickHandler SysTick_Handler</span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_PREEMPTION		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_IDLE_HOOK			0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TICK_HOOK			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configCPU_CLOCK_HZ			( ( unsigned long ) 48000000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTICK_RATE_HZ			( ( TickType_t ) 1000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_PRIORITIES		( 5 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMINIMAL_STACK_SIZE	( ( unsigned short ) 32 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTOTAL_HEAP_SIZE		( ( size_t ) ( 17 * 1024 ) )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_TASK_NAME_LEN		( 16 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TRACE_FACILITY	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_16_BIT_TICKS		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configIDLE_SHOULD_YIELD		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_MUTEXES			1</span><font></font>
<font></font>
<span class="hljs-comment">/* Co-routine definitions. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_CO_ROUTINES 		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES ( 2 )</span><font></font>
<font></font>
<span class="hljs-comment">/* Set the following definitions to 1 to include the API function, or zero
 to exclude the API function. */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskPrioritySet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_uxTaskPriorityGet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelete				1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskCleanUpResources	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskSuspend			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelayUntil			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelay				1</span><font></font>
<font></font>
<span class="hljs-comment">/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255
 (lowest) to 0 (1?) (highest). */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configKERNEL_INTERRUPT_PRIORITY 		255</span>
<span class="hljs-comment">/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!!
 See http://www.FreeRTOS.org/RTOS-Cortex-M3-M4.html. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY 	191 <span class="hljs-comment">/* equivalent to 0xb0, or priority 11. */</span></span><font></font>
<font></font>
<span class="hljs-comment">/* This is the value being used as per the ST library which permits 16
 priority values, 0 to 15.  This must correspond to the
 configKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowest
 NVIC value of 255. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configLIBRARY_KERNEL_INTERRUPT_PRIORITY	15</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* FREERTOS_CONFIG_H */</span></span><font></font>
<font></font>
</code></pre><br>
7.    main;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"main.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//define      typedef enum :)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorLeft		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorRight		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveBack		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveForward		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MaxSpeedMotor	1000</span><font></font>
<font></font>
<span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];				<span class="hljs-comment">// Buffer DMA ADC sensors</span>
<span class="hljs-keyword">uint16_t</span> SensWhiteOrBlack[<span class="hljs-number">10</span>];		<span class="hljs-comment">// Buffer sensors white or black</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC_Init();<font></font>
	GPIO_Init();<font></font>
	TIM1_Init();<font></font>
	UART3_Init();<font></font>
	ADC_Init();<font></font>
<font></font>
	xTaskCreate(vTaskUART2, <span class="hljs-string">"UART"</span>, <span class="hljs-number">512</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
	xTaskCreate(vTaskConvADC, <span class="hljs-string">"ADC"</span>, <span class="hljs-number">128</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	UART3_Send_String(<span class="hljs-string">"Start program\r\n"</span>);<font></font>
<font></font>
	GPIOA-&gt;BSRR |= GPIO_BSRR_BS10;	<span class="hljs-comment">// Motor enable</span><font></font>
<font></font>
	vTaskStartScheduler();<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">/*************************************Tasks***************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
<span class="hljs-comment">//-------------------Read sensors from buff DMA ADC, and print to UART3-------------//</span><font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (adc_buf[i] &lt;= <span class="hljs-number">300</span>)		<span class="hljs-comment">// value sens is white</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">0</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">0</span>;<font></font>
			} <span class="hljs-keyword">else</span>						<span class="hljs-comment">// else value sens is black</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">1</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">1</span>;<font></font>
			}<font></font>
<font></font>
<span class="hljs-comment">//			UART3_Send_Number_Float(SensWhiteOrBlack[i]);</span>
<span class="hljs-comment">//			UART3_Send_String("\t");</span><font></font>
		}<font></font>
<span class="hljs-comment">///		UART3_Send_String("\r\n");</span><font></font>
<font></font>
<span class="hljs-comment">//-----------------------------------------Move-----------------------------------------//</span><font></font>
<font></font>
<font></font>
		<span class="hljs-comment">//----Normal mode----//</span>
		<span class="hljs-keyword">float</span> devMotorLeft  = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">float</span> devMotorRight = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">uint32_t</span> flagSizeBuf = <span class="hljs-number">0</span>;<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">6</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">6</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">7</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">8</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">9</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">5</span>; i &gt;= <span class="hljs-number">0</span>; i--)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span>(SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">3</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">2</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">if</span>(!flagSizeBuf)<font></font>
		{<font></font>
			devMotorLeft  = <span class="hljs-number">0</span>;<font></font>
			devMotorRight = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
<font></font>
		Motor(MotorRight, (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorRight), MoveForward);<font></font>
		Motor(MotorLeft,  (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorLeft),  MoveForward);<font></font>
<font></font>
<font></font>
<span class="hljs-comment">/*
		if (adc_buf[0] &gt; 1000)
		{
			Motor(MotorLeft, 500, MoveBack);
		}
		else if (adc_buf[0] &lt;= 1000)
		{
			Motor(MotorLeft, 0, MoveForward);
		}

		if (adc_buf[9] &gt; 1000)
		{
			Motor(MotorRight, 500, MoveBack);//Motor(0, 500, 1);	MotorRight	MoveBack
		}
		else if (adc_buf[9] &lt;= 1000)
		{
			Motor(MotorRight, 0, MoveForward);
		}
*/</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">50</span>);<font></font>
	}<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
		<span class="hljs-comment">// just void :)</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">5000</span>);<font></font>
	}<font></font>
<font></font>
}<font></font>
<span class="hljs-comment">/**********************************Function*************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS11;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR11;<font></font>
	}<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (which == <span class="hljs-number">0</span>)	<span class="hljs-comment">//Right motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\t"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR3 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">0</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BS14;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR3 = <span class="hljs-number">0</span>;<font></font>
			GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (which == <span class="hljs-number">1</span>)	<span class="hljs-comment">//left motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\r\n"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR2 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">1</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR2 = <span class="hljs-number">0</span>;<font></font>
			GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*************************************IRQ***************************************/</span>
<span class="hljs-comment">/*
 void USART2_IRQHandler(void) {

 if (USART2-&gt;SR &amp; USART_CR1_RXNEIE) {

 USART2-&gt;SR &amp;= ~USART_CR1_RXNEIE;

 if (USART2-&gt;DR == '0') {
 UART2_Send_String("OFF\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BS13;
 } else if (USART2-&gt;DR == '1') {
 UART2_Send_String("ON\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 } else if (USART2-&gt;DR == '2') {
 uint16_t d0 = ADC1-&gt;DR;
 float Vdd = 1.2 * 4069 / d0;
 UART2_Send(Vdd);
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 }
 }
 }
 */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DMA1_Channel1_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	DMA1-&gt;IFCR = DMA_IFCR_CGIF1 | DMA_IFCR_CTCIF1;	<span class="hljs-comment">// clear DMA interrupt flags</span>
	DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;					<span class="hljs-comment">//  </span>
	<span class="hljs-comment">/*
	 * Code
	 */</span>
	DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;			   <span class="hljs-comment">//  </span><font></font>
	ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parle un peu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce projet est suspendu √† mes plans depuis plusieurs ann√©es et a √©t√© repouss√© tout le temps, mais maintenant il arrive vraiment √† sa conclusion logique, que je suis tr√®s heureux de terminer, je voudrais le rendre partiellement ouvert et le vendre comme une autre plate-forme / constructeur, si possible, puis le robot du sumoist n'est pas loin, et l√† d'autres iront. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'√©tait pas pr√©vu d'√©crire un article, mais la participation au concours l'exige. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai presque oubli√© la photo, certains composants ne sont pas encore arriv√©s, et la date limite du concours est demain, j'ai donc d√ª utiliser le bricolage pas dans ses meilleures performances.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Photo de robot</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/961/400/6f6961400a8062733354fd8ac85b41a0.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici une mini vid√©o de test</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hk-FURUHLvc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497764/index.html">Comment pr√©parer le jeu pour le portage sur PC et console</a></li>
<li><a href="../fr497768/index.html">Automatisation de la d√©sinfection</a></li>
<li><a href="../fr497770/index.html">Pr√©sentation de PyCaret: une biblioth√®que ouverte d'apprentissage automatique en Python Low-Code</a></li>
<li><a href="../fr497772/index.html">D√©veloppement chez Wargaming - r√©union avec Maxim Baryshnikov, chef de plate-forme (partie II)</a></li>
<li><a href="../fr497780/index.html">Trois ans en Am√©rique latine: comment je suis parti pour un r√™ve et que je suis revenu apr√®s une ¬´r√©initialisation¬ª totale</a></li>
<li><a href="../fr497784/index.html">Solution HiDC pour la construction d'une infrastructure TIC moderne de centres de donn√©es bas√©e sur l'√©quipement Huawei Enterprise</a></li>
<li><a href="../fr497786/index.html">Maintenant un cordonnier avec des bottes, ou comment nous avons obtenu notre propre guide de style</a></li>
<li><a href="../fr497788/index.html">Top 10 des extensions Chrome pour les concepteurs</a></li>
<li><a href="../fr497790/index.html">Nous vous invitons √† DINS QA EVENING: parler de Postman et tester les m√©thodes d'√©valuation de la couverture</a></li>
<li><a href="../fr497792/index.html">Outils d'un investisseur d√©butant: acc√®s test, tarif de d√©part, terminal de trading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>