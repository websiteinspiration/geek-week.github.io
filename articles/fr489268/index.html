<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📰 🤟🏽 ⛏️ Mise en œuvre du processus de téléchargement d'un fichier depuis un conteneur avec un navigateur vers un framework de test 👨🏿‍💼 💨 🔓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automatisation des tests End-2-End d'un système d'information intégré 
 Partie 2-2. Implémentation du processus de téléchargement d'un fichier depuis ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mise en œuvre du processus de téléchargement d'un fichier depuis un conteneur avec un navigateur vers un framework de test</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489268/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatisation des tests End-2-End d'un système d'information intégré </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partie 2-2. </font><font style="vertical-align: inherit;">Implémentation du processus de téléchargement d'un fichier depuis un conteneur avec un navigateur vers un framework de test. </font><font style="vertical-align: inherit;">Recherchez le nom du fichier téléchargé par le navigateur</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auteur: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/us/users/anrad</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hubs: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tags: #autotest, #selenium, #selenoid, #headlessbrowser, #download</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Lorsque nous développions des </font><i><font style="vertical-align: inherit;">autotests</font></i><font style="vertical-align: inherit;"> End-2-End pour l'interface utilisateur, nous étions confrontés à la question «Comment obtenir le nom du dernier chargé navigateur de fichiers de WebDriver? ", Google n’a rien obtenu rapidement. Par conséquent, j'ai écrit cet article, qui a en même temps dit ce que nous avions exactement un problème et comment nous l'avons résolu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cet article, nous continuons une série de publications sur la façon dont nous avons automatisé le processus de test manuel (ci-après dénommé auto-tests) d'un grand système d'information (ci-après dénommé Systèmes) dans l'un des principaux projets LANIT et ce qui en est ressorti. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/wz/lk/9wwzlkncoqwymqxqltqhcxatig0.jpeg" alt="image"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la source</font></font></i></a><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article lui-même complète le cycle, ci-dessous est un lien vers toutes les parties précédentes: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partie 1. Organisationnelle et managériale. Pourquoi avions-nous besoin d'automatisation. Organisation du processus de développement et de gestion. Organisation de l'utilisation </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partie 2. Technique. Architecture et pile technique. Détails de mise en œuvre et surprises techniques </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partie 2-1. Implémentation de la classe de base pour tous les tests et JUnit RuleChain. </font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'était il y a un an. Aujourd'hui, cela n'est peut-être pas pertinent. Écrivez dans les commentaires si vous savez comment traiter efficacement des fichiers avec plusieurs serveurs de grille sélénoïde.</font></font></i></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Lors du développement des «autotests», nous avons eu la tâche de télécharger (télécharger) des fichiers à partir du système avec une analyse ultérieure de leur contenu. Pour «télécharger» des fichiers à partir du système testé, nous utilisons les solutions suivantes:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le mode de lancement "local" (lancement directement sur le PC de travail) - lorsque le navigateur "local" est initialisé, le nom du dossier local temporaire lui est transmis en paramètre. </font><font style="vertical-align: inherit;">Ensuite, le fichier est lu directement à partir du dossier local pour une analyse ultérieure;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le mode "à distance" (via Bamboo) - le fichier a été "extrait" du conteneur avec le navigateur via la fonction de serveur Solenoid: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} / {FILE_NAME}</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les détails sont décrits dans la documentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les deux modes, pour accéder au fichier, il fallait connaître son nom. </font><font style="vertical-align: inherit;">Ce fut une surprise. </font><font style="vertical-align: inherit;">Le problème du manque de données sur le nom du fichier «download» était le suivant:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">après avoir «cliqué» sur le bouton «télécharger le fichier», le navigateur a téléchargé le fichier dans le dossier local approprié dans le conteneur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans ce cas, le nom du fichier a été formé dynamiquement et, comment le déterminer à l'avance, nous n'avons pas pu le trouver. </font><font style="vertical-align: inherit;">C'était une caractéristique de notre système de test;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En outre, ce fichier doit être «retiré» du conteneur et une vérification commerciale de son contenu doit être effectuée;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour «extraire» le fichier, vous devez connaître son nom, mais nous ne connaissions pas le nom, car le nom était généré dynamiquement et il n'y avait aucune valeur dans le lien.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la situation était aggravée par le fait qu'en raison de la grande complexité de certains tests, plusieurs fichiers pouvaient être déchargés pendant le test dans le cadre de différents scripts de test indépendants de la composition du test lui-même. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La meilleure solution pour nous était la méthode selon laquelle nous avons déterminé le dernier fichier téléchargé. </font><font style="vertical-align: inherit;">Il y avait plusieurs façons de procéder:</font></font><br>
<ul>
<li>        .        .   ,    ;</li>
<li>    Google Chrome   javascript  chrome://downloads/,      html-.       .<br>
</li>
</ul><br>
<br>
<h3>      <br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyse de la composition des fichiers chargés par le navigateur pour le mode local est une tâche triviale. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le mode distant, vous devez utiliser la fonction «non documenté» du serveur selenoid: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} affiche une liste de tous les fichiers téléchargés avec succès, où SESSION_ID est un ID de session selenoid. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, le schéma fonctionne bien à une exception près: nous Vous devez attendre un certain temps jusqu'à ce que le fichier soit téléchargé et apparaisse dans la liste. L'attente peut être définie via un cycle de temporisation, cependant, de cette façon, nous ne pouvons pas obtenir d'informations sur une éventuelle erreur de téléchargement de fichier. Nous pouvons seulement déterminer que le fichier n'a pas été chargé dans ce circuit. Par conséquent, à la fin, nous avons opté pour la méthode de détermination du nom de fichier via la page chrome: // Downloads /.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenir le nom du fichier via le chrome: // téléchargements / page</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette méthode fonctionne aussi bien en mode local que distant. </font><font style="vertical-align: inherit;">Le schéma de travail est assez simple:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécutez le script java pour ouvrir la fenêtre chrome: // téléchargements /;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traiter les données dans la fenêtre de la manière habituelle. </font><font style="vertical-align: inherit;">Attendez que le premier fichier de la liste soit chargé et déterminez son nom;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fermez la fenêtre chrome: // Downloads / et retournez le nom du fichier que vous recherchez.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons recherché sur Google l’idée d’utiliser chrome: // Downloads / et, à mon grand regret, je ne peux pas fournir de lien vers la source, car elle n’était pas conservée. </font><font style="vertical-align: inherit;">L'implémentation réelle de la classe pour obtenir le nom de fichier est donnée ci-dessous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Classe pour obtenir le nom du fichier téléchargé via chrome: // téléchargements /</font></font><br>
<pre><code class="java hljs">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> DOWNLOADS_PAGE_LOAD_TIMEOUT = <span class="hljs-number">5_000</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> MAX_GET_FILE_NAME_ATTEMPT = <span class="hljs-number">5</span>;<font></font>
 <font></font>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getLastDownloadedFilename</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> DownloaderException </span>{<font></font>
        String[] filename = <span class="hljs-keyword">new</span> String[<span class="hljs-number">1</span>];<font></font>
        Exception[] ex = <span class="hljs-keyword">new</span> Exception[<span class="hljs-number">1</span>];<font></font>
        WebDriver driver = WebDriverRunner.getWebDriver();<font></font>
        JavascriptExecutor executor = (JavascriptExecutor) driver;<font></font>
        Utils.driver.openNewTabCheckAndClose(<font></font>
                () -&gt; {<font></font>
                    executor.executeScript(<span class="hljs-string">"window.open('','_blank');"</span>);<font></font>
                },<font></font>
                () -&gt; {<font></font>
                    driver.get(<span class="hljs-string">"chrome://downloads/"</span>);<font></font>
 <font></font>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_GET_FILE_NAME_ATTEMPT; i++) {<font></font>
                    	ex[<span class="hljs-number">0</span>] = <span class="hljs-keyword">null</span>;<font></font>
                        sleep();<font></font>
                    	<span class="hljs-keyword">try</span> {<font></font>
                        	WebElement element = (WebElement) executor.executeScript(<font></font>
                                    <span class="hljs-string">"return document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('file-link')"</span>);<font></font>
                        	filename[<span class="hljs-number">0</span>] = element.getText();<font></font>
                            LOGGER.info(<span class="hljs-string">"Attempt get file name "</span> + i + <span class="hljs-string">". Name = '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'"</span>);<font></font>
                    	} <span class="hljs-keyword">catch</span> (WebDriverException e) {<font></font>
                        	ex[<span class="hljs-number">0</span>] = e;<font></font>
                            LOGGER.info(<span class="hljs-string">"Failed attempt "</span>+ i + <span class="hljs-string">" to get filename text: "</span> + e.getMessage());
                        	<span class="hljs-keyword">continue</span>;<font></font>
                    	}<font></font>
                    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
                        	 <span class="hljs-comment">//             </span><font></font>
                         	executor.executeScript(<font></font>
                                    <span class="hljs-string">"document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('remove').click()"</span>);
                        	<span class="hljs-keyword">break</span>;<font></font>
                    	}<font></font>
                    }<font></font>
                }<font></font>
    	);<font></font>
 <font></font>
    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
            <span class="hljs-keyword">return</span> filename[<span class="hljs-number">0</span>];<font></font>
    	}<font></font>
 <font></font>
    	String message = <span class="hljs-string">"Timeout. Can not get last downloaded file name from chrome://downloads/. File name is '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'. Exception: "</span> + ex[<span class="hljs-number">0</span>].getMessage();<font></font>
        LOGGER.warning(message);<font></font>
    	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DownloaderException(message, ex[<span class="hljs-number">0</span>]);<font></font>
	}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489254/index.html">Yandex aide-t-il à propager des logiciels malveillants?</a></li>
<li><a href="../fr489256/index.html">Systèmes d'automatisation Foundation Fieldbus</a></li>
<li><a href="../fr489258/index.html">Comment les nombres entiers très longs sont-ils implémentés en Python?</a></li>
<li><a href="../fr489260/index.html">Comment concevoir un système automatisé à grande échelle pour une grande entreprise en sept étapes</a></li>
<li><a href="../fr489262/index.html">Pourquoi il n'est pas facile de donner aux développeurs la liberté de choix</a></li>
<li><a href="../fr489270/index.html">WebAuthn dans la vraie vie</a></li>
<li><a href="../fr489272/index.html">Yeux, cerveau, qualité vidéo: réflexions sur 120fps, 8K, HDR, baguettes, cônes et «effet feuilleton»</a></li>
<li><a href="../fr489274/index.html">Affirmer des messages dans les tests</a></li>
<li><a href="../fr489276/index.html">Test sanguin pour le fer - comment contrôler le niveau, diagnostiquer les raisons pour lesquelles il est important</a></li>
<li><a href="../fr489280/index.html">Envoyez un ping à tous les hôtes IPv6 sur le canal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>