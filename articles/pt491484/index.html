<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèæ üôá üö™ Stas Afanasyev. Juno. Pipelines baseados em io.Reader / io.Writer. Parte 1 üîã üì≥ üê°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No relat√≥rio, falaremos sobre o conceito de io.Reader / io.Writer, por que eles s√£o necess√°rios, como implement√°-los corretamente e que armadilhas exi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Stas Afanasyev. Juno. Pipelines baseados em io.Reader / io.Writer. Parte 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/491484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No relat√≥rio, falaremos sobre o conceito de io.Reader / io.Writer, por que eles s√£o necess√°rios, como implement√°-los corretamente e que armadilhas existem a esse respeito, bem como sobre a constru√ß√£o de pipelines com base em implementa√ß√µes padr√£o e personalizadas de io.Reader / io.Writer .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/nv/uj/rdnvujcjwsukejxq_6a9syayawu.jpeg"><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stanislav Afanasyev (a seguir - SA):</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Boa tarde! Meu nome √© Stas. Eu vim de Minsk, da empresa Juno. Obrigado por ter vindo neste dia chuvoso, tendo encontrado for√ßas para sair de casa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, quero falar com voc√™ sobre um t√≥pico como a constru√ß√£o de pipelines, com base nas interfaces io.Reader / io.Writer. O que falarei hoje √©, em geral, o conceito de interfaces io.Reader / io.Writer, por que elas s√£o necess√°rias, como us√°-las corretamente e, mais importante, como implement√°-las corretamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m falaremos sobre a constru√ß√£o de pipelines com base em v√°rias implementa√ß√µes dessas interfaces. Vamos falar sobre m√©todos existentes, discutir seus pr√≥s e contras. Vou mencionar v√°rias armadilhas (isso ser√° em abund√¢ncia).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßarmos, devemos responder √† pergunta: por que essas interfaces s√£o necess√°rias? </font><font style="vertical-align: inherit;">Levante as m√£os, que trabalha com o Go com for√ßa (todos os dias, todos os dias) ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/pd/f4/d2pdf4kdwdjk_vxkqz6fwckqrgk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ìtimo! </font><font style="vertical-align: inherit;">Ainda temos uma comunidade Go. </font><font style="vertical-align: inherit;">Eu acho que muitos de voc√™s trabalharam com essas interfaces, pelo menos j√° ouviram falar delas. </font><font style="vertical-align: inherit;">Voc√™ pode nem saber sobre eles, mas certamente deveria ter ouvido algo sobre eles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de tudo, essas interfaces s√£o uma abstra√ß√£o da opera√ß√£o de entrada e sa√≠da em todas as suas manifesta√ß√µes. </font><font style="vertical-align: inherit;">Em segundo lugar, √© uma API muito conveniente que permite criar pipelines, como um construtor a partir de cubos, sem realmente pensar nos detalhes internos da implementa√ß√£o. </font><font style="vertical-align: inherit;">Pelo menos isso foi originalmente planejado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma interface muito simples. Consiste em apenas um m√©todo - o m√©todo Read. Conceitualmente, a implementa√ß√£o da interface io.Reader pode ser uma conex√£o de rede - por exemplo, onde ainda n√£o h√° dados, mas eles podem aparecer l√°: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n-/4n/dc/n-4ndcbxpoxkul6h227ue7hruli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pode ser um buffer na mem√≥ria onde os dados j√° existem e podem ser lidos inteiramente. Tamb√©m pode ser um descritor de arquivo - podemos ler esse arquivo em partes, se for muito grande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementa√ß√£o conceitual da interface io.Reader √© o acesso a alguns dados. Todos os casos que escrevi s√£o suportados pelo m√©todo Read. Ele tem apenas um argumento - este √© um byte de fatia.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ponto a ser destacado aqui. Aqueles que vieram recentemente ao Go ou vieram de alguma outra tecnologia em que n√£o havia API semelhante (eu sou um deles), essa assinatura √© um pouco confusa. O m√©todo Read parece, de alguma forma, ler esta fatia. De fato, o oposto √© verdadeiro: a implementa√ß√£o da interface Reader l√™ os dados internos e preenche essa fatia com os dados que essa implementa√ß√£o possui.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quantidade m√°xima de dados que podem ser lidos mediante solicita√ß√£o pelo m√©todo Read √© igual ao tamanho dessa fatia. </font><font style="vertical-align: inherit;">Uma implementa√ß√£o regular retorna o m√°ximo de dados poss√≠vel no momento da solicita√ß√£o ou a quantidade m√°xima que se encaixa nessa fatia. </font><font style="vertical-align: inherit;">Isso sugere que o Reader pode ser lido em peda√ßos: pelo menos, byte, pelo menos dez - como voc√™ quiser. </font><font style="vertical-align: inherit;">E o cliente que chama o Reader, de acordo com os valores de retorno do m√©todo Read, pensa em como viver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo Read retorna dois valores:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√∫mero de bytes subtra√≠dos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um erro se ocorreu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses valores influenciam o comportamento adicional do cliente. </font><font style="vertical-align: inherit;">H√° um gif no slide que mostra, exibe esse processo, que acabei de descrever:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ww/sf/siwwsf6u8mb1nkztg0ltnumkckw.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/p1/hk/mb/p1hkmbpfp8-twtnznjj2ihireaa.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Io.Reader - Como?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem exatamente duas maneiras de seus dados satisfazerem a interface do Reader. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l0/fm/e7/l0fme7quz_tqzilkfiuiddpgjk4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro √© o mais simples. Se voc√™ possui algum tipo de fatia de byte e deseja satisfaz√™-la com a interface do Reader, pode implementar a biblioteca padr√£o que j√° satisfaz essa interface. Por exemplo, Reader do pacote de bytes. No slide acima, voc√™ pode ver a assinatura de como este leitor √© criado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe uma maneira mais complicada - de implementar voc√™ mesmo a interface do Reader. Existem aproximadamente 30 linhas na documenta√ß√£o com regras complicadas, restri√ß√µes que devem ser seguidas. Antes de falarmos sobre todos eles, ficou interessante para mim: ‚ÄúE em que casos n√£o h√° implementa√ß√µes padr√£o suficientes (biblioteca padr√£o)? Quando √© o momento em que precisamos implementar a interface do Reader?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para responder a essa pergunta, peguei os milhares de reposit√≥rios mais populares no Github (pelo n√∫mero de estrelas), os adicionei e encontrei todas as implementa√ß√µes da interface do Reader l√°. </font><font style="vertical-align: inherit;">No slide, tenho algumas estat√≠sticas (categorizadas) de quando as pessoas implementam essa interface.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A categoria mais popular s√£o as conex√µes. </font><font style="vertical-align: inherit;">Esta √© uma implementa√ß√£o de protocolos propriet√°rios e wrappers para tipos existentes. </font><font style="vertical-align: inherit;">Portanto, Brad Fitzpatrick tem um projeto Camlistore - h√° um exemplo na forma de statTrackingConn, que, em geral, √© um Wrapper comum sobre o tipo con do pacote net (adiciona m√©tricas a esse tipo).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda categoria mais popular s√£o os buffers personalizados. </font><font style="vertical-align: inherit;">Aqui gostei do primeiro exemplo: dataBuffer do pacote x / net. </font><font style="vertical-align: inherit;">Sua peculiaridade √© que ele armazena dados cortados em peda√ßos e, ao subtra√≠-los, passa por esses peda√ßos. </font><font style="vertical-align: inherit;">Se os dados no peda√ßo terminarem, eles passar√£o para o pr√≥ximo peda√ßo. </font><font style="vertical-align: inherit;">Ao mesmo tempo, ele leva em considera√ß√£o o comprimento, o local em que pode preencher a fatia transmitida.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra categoria s√£o todos os tipos de barras de progresso, contando o n√∫mero de bytes subtra√≠dos com o envio de m√©tricas ...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nesses dados, podemos dizer que a necessidade de implementar a interface io.Reader ocorre com bastante frequ√™ncia. </font><font style="vertical-align: inherit;">Vamos ent√£o come√ßar a falar sobre as regras que est√£o na documenta√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regras de documenta√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como eu disse, a lista de regras e, em geral, a documenta√ß√£o √© bastante grande, massiva. 30 linhas √© suficiente para uma interface que consiste em apenas tr√™s linhas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira regra mais importante diz respeito ao n√∫mero de bytes retornados. Ele deve ser estritamente maior ou igual a zero e menor ou igual ao comprimento da fatia enviada. Por que isso √© importante? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/kp/xh/1kkpxhahoiicme8z8vbdbq5ajbm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como esse √© um contrato bastante rigoroso, o cliente pode confiar na quantia proveniente da implementa√ß√£o. Existem Wrappers na biblioteca padr√£o (por exemplo, bytes.Buffer e bufio). Existe um momento na biblioteca padr√£o: algumas implementa√ß√µes confiam em leitores embrulhados, outras n√£o (n√≥s falaremos sobre isso mais tarde).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bufio n√£o confia em nada - verifica absolutamente tudo. </font><font style="vertical-align: inherit;">Bytes.Buffer confia absolutamente tudo o que chega at√© ele. </font><font style="vertical-align: inherit;">Agora vou demonstrar o que est√° acontecendo em conex√£o com isso ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos agora considerar tr√™s casos poss√≠veis - esses s√£o tr√™s leitores implementados. </font><font style="vertical-align: inherit;">Eles s√£o bastante sint√©ticos, √∫teis para a compreens√£o. </font><font style="vertical-align: inherit;">Leremos todos esses leitores usando o auxiliar ReadAll. </font><font style="vertical-align: inherit;">Sua assinatura √© apresentada na parte superior do slide:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ib/c1/7b/ibc17bdqyrimk3xce2khqwera4w.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Leitor # 1. </font><font style="vertical-align: inherit;">Exemplo 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ReadAll √© um auxiliar que utiliza algum tipo de implementa√ß√£o da interface do Reader, l√™ tudo e retorna os dados que leu, al√©m de um erro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso primeiro exemplo √© o Reader, que sempre retornar√° -1 e nulo como um erro, ou seja, um NegativeReader. Vamos execut√°-lo e ver o que acontece: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/3h/l-/7n3hl-2vdvmgvmw80eljlorapiw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como voc√™ sabe, o p√¢nico sem motivo √© um sinal de tolice. Mas quem neste caso √© um tolo - eu ou byte.Buffer - depende do ponto de vista. Quem escreve este pacote e o segue tem pontos de vista diferentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que aconteceu aqui? O Bytes.Buffer aceitou um n√∫mero negativo de bytes, n√£o verificou se era negativo e tentou cortar o buffer interno ao longo do limite superior que ele recebeu - e sa√≠mos dos limites da fatia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem dois problemas neste exemplo. A primeira √© que a assinatura n√£o √© proibida para retornar n√∫meros negativos e a documenta√ß√£o √© proibida. Se a assinatura tivesse Uint, obter√≠amos um estouro cl√°ssico (quando um n√∫mero assinado for interpretado como n√£o assinado). E esse √© um bug muito complicado, que certamente acontecer√° na sexta √† noite, quando voc√™ j√° estiver em casa. Portanto, o p√¢nico neste caso √© a op√ß√£o preferida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo "ponto" √© que o rastreamento da pilha n√£o entende o que aconteceu. √â claro que fomos al√©m dos limites da fatia - e da√≠? Quando voc√™ possui um canal com v√°rias camadas e ocorre um erro, n√£o fica claro imediatamente o que aconteceu. Portanto, o bufio da biblioteca padr√£o tamb√©m entra em p√¢nico nessa situa√ß√£o, mas o faz de maneira mais bonita. Ele imediatamente escreve: ‚ÄúSubtra√≠ um n√∫mero negativo de bytes. N√£o farei mais nada - n√£o sei o que fazer com isso. "</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E bytes.Buffer est√° em p√¢nico o melhor que pode. </font><font style="vertical-align: inherit;">Publiquei um problema no Golang pedindo que eu adicionasse um erro humano. </font><font style="vertical-align: inherit;">No terceiro dia, discutimos as perspectivas dessa decis√£o. </font><font style="vertical-align: inherit;">A raz√£o √© a seguinte: historicamente aconteceu que pessoas diferentes, em momentos diferentes, tomaram decis√µes descoordenadas diferentes. </font><font style="vertical-align: inherit;">E agora temos o seguinte: em um caso, n√£o confiamos na implementa√ß√£o (verificamos tudo) e no outro, confiamos completamente, n√£o obtemos o que vem da√≠. </font><font style="vertical-align: inherit;">Este √© um problema n√£o resolvido, e falaremos mais sobre isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Leitor # 1. </font><font style="vertical-align: inherit;">Exemplo 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguinte situa√ß√£o: nosso Reader sempre retornar√° 0 e nulo como resultados. </font><font style="vertical-align: inherit;">Do ponto de vista dos contratos, tudo √© legal aqui - n√£o h√° problemas. </font><font style="vertical-align: inherit;">A √∫nica ressalva: a documenta√ß√£o diz que as implementa√ß√µes n√£o s√£o recomendadas para retornar os valores 0 e nulo, al√©m do caso, quando o comprimento da fatia enviada for zero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na vida real, esse leitor pode causar muitos problemas. </font><font style="vertical-align: inherit;">Ent√£o, voltando √† pergunta, devemos confiar no Reader? </font><font style="vertical-align: inherit;">Por exemplo, uma verifica√ß√£o √© incorporada ao bufio: ele l√™ sequencialmente o Reader exatamente 100 vezes - se esse par de valores √© retornado 100 vezes, ele simplesmente retorna NoProgress. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° nada como isso em bytes.Buffer. </font><font style="vertical-align: inherit;">Se executarmos este exemplo, obteremos apenas um loop infinito (ReadAll usa bytes.Buffer sob o cap√¥, n√£o o pr√≥prio Reader):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/br/zu/xhbrzuvnof4dxubt2d26i6q4l_q.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Leitor # 1. </font><font style="vertical-align: inherit;">Exemplo 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais um exemplo. </font><font style="vertical-align: inherit;">Tamb√©m √© bastante sint√©tico, mas √∫til para a compreens√£o: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/pe/xp/gapexpzfyhd6za09ss_uuwbrmlk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aqui sempre retornamos 1 e zero. </font><font style="vertical-align: inherit;">Parece que tamb√©m n√£o h√° problemas aqui - tudo √© legal do ponto de vista do contrato. </font><font style="vertical-align: inherit;">H√° uma nuance: se eu executar este exemplo no meu computador, ele congelar√° ap√≥s 30 segundos ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso ocorre porque o cliente que l√™ este Reader (ou seja, bytes.Buffer) nunca recebe um sinal do final dos dados - ele l√™, subtrai ... Al√©m disso, ele recebe um byte subtra√≠do a cada vez. </font><font style="vertical-align: inherit;">Para ele, isso significa que, em algum momento, o buffer reposicionado termina, ele ainda corre - a situa√ß√£o se repete e corre para o infinito at√© explodir.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Leitor # 2. </font><font style="vertical-align: inherit;">Retorno de erro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chegamos √† segunda regra importante para implementar a interface do Reader - este √© um retorno de erro. </font><font style="vertical-align: inherit;">A documenta√ß√£o indica tr√™s erros que a implementa√ß√£o deve retornar. </font><font style="vertical-align: inherit;">O mais importante deles √© EOF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EOF √© o pr√≥prio sinal do final dos dados, que a implementa√ß√£o deve retornar sempre que os dados acabarem. </font><font style="vertical-align: inherit;">Conceitualmente, isso geralmente n√£o √© um erro, mas √© um erro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° outro erro chamado UnexpectedEOF. </font><font style="vertical-align: inherit;">Se de repente, ao ler o Reader, n√£o puder mais ler os dados, pensou-se que retornaria UnexpectedEOF. </font><font style="vertical-align: inherit;">Mas, na verdade, esse erro √© usado apenas em um local da biblioteca padr√£o - na fun√ß√£o ReadAtLeast.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-c/og/la/-coglawtrylyakbq0kxlc0ob9rs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro erro √© o NoProgress, sobre o qual j√° conversamos. </font><font style="vertical-align: inherit;">A documenta√ß√£o diz o seguinte: este √© um sinal de que a interface est√° implementada √© uma porcaria.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Io.Reader # 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A documenta√ß√£o estipula um conjunto de casos sobre como retornar corretamente o erro. </font><font style="vertical-align: inherit;">Abaixo, voc√™ pode ver tr√™s casos poss√≠veis: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m1/ef/si/m1efsipabh8oypgch-7_ni2syc8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos retornar um erro com o n√∫mero de bytes subtra√≠dos e separadamente. </font><font style="vertical-align: inherit;">Mas, de repente, seus dados acabam no Reader, e voc√™ n√£o pode retornar o EOF [sinal final] agora (muitas implementa√ß√µes da biblioteca padr√£o funcionam assim), pressup√µe-se que voc√™ retornar√° o EOF para a pr√≥xima chamada consecutiva (ou seja, voc√™ deve liberar) cliente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o cliente, isso significa que n√£o h√° mais dados - n√£o me procure mais. </font><font style="vertical-align: inherit;">Se voc√™ retornar nulo e o cliente precisar de dados, ele dever√° procur√°-lo novamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader. </font><font style="vertical-align: inherit;">Erros</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, segundo o Reader, essas eram as principais regras importantes. </font><font style="vertical-align: inherit;">Ainda existe um conjunto de pequenos, mas eles n√£o s√£o t√£o importantes e n√£o levam a uma situa√ß√£o assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xv/iu/az/xviuazv5segzzd5ganrbinp8xli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
antes de analisarmos tudo relacionado ao Reader, precisamos responder √† pergunta: √© importante, geralmente ocorrem erros em implementa√ß√µes personalizadas? </font><font style="vertical-align: inherit;">Para responder a essa pergunta, eu virei para o meu spool para 1000 reposit√≥rios (e l√° temos cerca de 550 implementa√ß√µes personalizadas). </font><font style="vertical-align: inherit;">Eu olhei atrav√©s dos primeiros cem com meus olhos. </font><font style="vertical-align: inherit;">Claro, isso n√£o √© superan√°lise, mas o que √© ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
identifiquei os dois erros mais populares:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nunca retorna EOF;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muita confian√ßa no leitor embrulhado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Novamente, este √© um problema do meu ponto de vista. </font><font style="vertical-align: inherit;">E daqueles que est√£o assistindo o pacote io, isso n√£o √© um problema. </font><font style="vertical-align: inherit;">Vamos falar sobre isso novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gostaria de voltar a uma nuance. </font><font style="vertical-align: inherit;">Consulte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/3h/9q/te3h9q46okeg22rijrfyxrmi4da.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cliente nunca deve interpretar o par 0 e zero como EOF. </font><font style="vertical-align: inherit;">Isso √© erro! </font><font style="vertical-align: inherit;">Para o Reader, esse valor √© apenas uma oportunidade de liberar o cliente. </font><font style="vertical-align: inherit;">Ent√£o, os dois erros que mencionei parecem insignificantes, mas √© suficiente imaginar que voc√™ tem um pipeline de v√°rias camadas no produto e um pequeno e astuto "bagul" apareceu no meio, ent√£o a "batida subterr√¢nea" n√£o vai demorar muito - garantida! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segundo o Reader, basicamente tudo. </font><font style="vertical-align: inherit;">Essas eram as regras b√°sicas de implementa√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Writer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No outro extremo dos pipelines, temos o io.Writer, que √© onde costumamos escrever dados. </font><font style="vertical-align: inherit;">Uma interface muito semelhante: tamb√©m consiste em um m√©todo (Write), sua assinatura √© semelhante. </font><font style="vertical-align: inherit;">Do ponto de vista da sem√¢ntica, a interface do Writer √© mais compreens√≠vel: eu diria que, ao ser ouvida, est√° escrita. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fq/ya/ls/fqyalshoz2lwp48cs5u8oa9ymdk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo Write pega um byte de fatia e o grava por inteiro. </font><font style="vertical-align: inherit;">Ele tamb√©m tem um conjunto de regras que devem ser seguidas.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro deles diz respeito ao n√∫mero retornado de bytes gravados. </font><font style="vertical-align: inherit;">Eu diria que n√£o √© t√£o rigoroso, porque n√£o encontrei um √∫nico exemplo quando isso levaria a algumas consequ√™ncias cr√≠ticas - por exemplo, entrar em p√¢nico. </font><font style="vertical-align: inherit;">Isso n√£o √© muito rigoroso porque existe a seguinte regra ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A implementa√ß√£o do Writer √© necess√°ria para retornar um erro sempre que a quantidade de dados gravados for menor que o que foi enviado. </font><font style="vertical-align: inherit;">Ou seja, a grava√ß√£o parcial n√£o √© suportada. </font><font style="vertical-align: inherit;">Isso significa que n√£o √© muito importante quantos bytes foram gravados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais uma regra: o Writer n√£o deve modificar a fatia enviada, porque o cliente ainda trabalhar√° com essa fatia.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Writer n√£o deve conter essa fatia (o Reader tem a mesma regra). </font><font style="vertical-align: inherit;">Se voc√™ precisar de dados em sua implementa√ß√£o para algumas opera√ß√µes, basta copiar este slide e pronto.</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iy/tx/qe/iytxqemg1nabcwxyfzxtgszmjxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por Reader e Writer, √© isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dendrograma</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especialmente para este relat√≥rio, gerei um gr√°fico de implementa√ß√£o e o projetei na forma de um dendograma. </font><font style="vertical-align: inherit;">Quem quiser agora pode seguir este c√≥digo QR: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/zp/pq/r2zppqu-0snqu80oqyxxpxakkpc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este dendrograma tem todas as implementa√ß√µes de todas as interfaces do pacote io. </font><font style="vertical-align: inherit;">Esse dendrograma √© necess√°rio para simplesmente entender: o que e com o que voc√™ pode colar nos pipelines, onde e o que voc√™ pode ler, onde pode escrever. </font><font style="vertical-align: inherit;">Ainda vou fazer refer√™ncia a ele no decorrer do meu relat√≥rio, portanto, consulte o c√≥digo QR.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tubula√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Falamos sobre o que √© o Reader, io.Writer. Agora vamos falar sobre a API que existe na biblioteca padr√£o para constru√ß√£o de pipelines. Vamos come√ßar com o b√°sico. Talvez nem seja interessante para ningu√©m. No entanto, isso √© muito importante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leremos os dados do fluxo de entrada padr√£o (da Stdin): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/tq/4m/zqtq4mfocqntafmpk5m_scirhcm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stdin √© representado em Go por uma vari√°vel global do tipo file do pacote os. Se voc√™ der uma olhada no dendograma, notar√° que o tipo de arquivo tamb√©m implementa as interfaces Reader e Writer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No momento, estamos interessados ‚Äã‚Äãno Reader. Estaremos lendo o Stdin usando o mesmo auxiliar ReadAll que j√° usamos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma nuance em rela√ß√£o a esse auxiliar √© digna de nota: ReadAll l√™ o Reader at√© o fim, mas determina o final pelo EOF, de acordo com o sinal do final do qual falamos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, limitaremos a quantidade de dados que lemos do Stdin. Para fazer isso, h√° uma implementa√ß√£o do LimitedReader na biblioteca padr√£o: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/dm/hn/qqdmhnj73dfyxpdlrpoffwzimgq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gostaria que voc√™ prestasse aten√ß√£o em como o LimitedReader limita o n√∫mero de bytes a serem lidos. Algu√©m poderia pensar que esta implementa√ß√£o, este Wrapper, subtrai tudo o que est√° no Reader, o qual envolve, e depois fornece o quanto queremos. Mas tudo funciona um pouco diferente ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LimitedReader corta a fatia fornecida como um argumento ao longo do limite superior. </font><font style="vertical-align: inherit;">E ele passa essa fatia cortada para o Reader, que a envolve. </font><font style="vertical-align: inherit;">Esta √© uma demonstra√ß√£o clara de como o comprimento dos dados lidos √© regulado nas implementa√ß√µes da interface io.Reader.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erro ao retornar final do arquivo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro ponto interessante: observe como essa implementa√ß√£o retorna um erro de EOF! </font><font style="vertical-align: inherit;">Os valores nomeados retornados s√£o usados ‚Äã‚Äãaqui e s√£o atribu√≠dos pelos valores que obtemos do Reader empacotado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E se houver mais dados no Reader empacotado do que o necess√°rio, atribu√≠mos os valores do Reader empacotado - por exemplo, 10 bytes e nulo - porque ainda existem dados no Reader empacotado. </font><font style="vertical-align: inherit;">Mas a vari√°vel n, que diminui (na pen√∫ltima linha), diz que chegamos ao "fundo" - o fim do que precisamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na pr√≥xima itera√ß√£o, o cliente deve voltar novamente - na primeira condi√ß√£o, ele receber√° EOF. </font><font style="vertical-align: inherit;">Este √© o caso que eu mencionei. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para continuar em breve ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kuyjuGk1USY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de publicidade :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado por ficar com a gente. Voc√™ gosta dos nossos artigos? Deseja ver materiais mais interessantes? Ajude-nos fazendo um pedido ou recomendando aos seus amigos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS na nuvem para desenvolvedores a partir de US $ 4,99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anal√≥gico exclusivo de servidores de n√≠vel b√°sico que foi inventado por n√≥s para voc√™: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10 GB DDR4 480 GB SSD 1 Gbps de US $ 19 ou como dividir o servidor?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as op√ß√µes est√£o dispon√≠veis com RAID1 e RAID10, at√© 24 n√∫cleos e at√© 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em Amsterd√£?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Somente n√≥s temos </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na Holanda!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leia sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como criar um pr√©dio de infraestrutura. </font><font style="vertical-align: inherit;">classe c usando servidores Dell R730xd E5-2650 v4 que custam 9.000 euros por um centavo?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491462/index.html">Leitura de fim de semana: 12 podcasts, esta√ß√µes de r√°dio FM da era do p√¥r do sol e aplicativos de medita√ß√£o</a></li>
<li><a href="../pt491476/index.html">Aceler√¥metros, magnet√¥metros e √¢ngulos de orienta√ß√£o MEMS</a></li>
<li><a href="../pt491478/index.html">Um novo implante para cegos se conecta diretamente ao c√©rebro</a></li>
<li><a href="../pt491480/index.html">Projeto CoVirus MVP - um mapa on-line de infec√ß√£o por coronav√≠rus ou um "bot√£o vermelho" na sua m√£o</a></li>
<li><a href="../pt491482/index.html">Apresentando o PowerShell 7.0</a></li>
<li><a href="../pt491486/index.html">Script personalizado ao fechar a tampa do laptop e bloquear a tela sem dormir</a></li>
<li><a href="../pt491488/index.html">O que significa ser √°gil?</a></li>
<li><a href="../pt491490/index.html">Como o Gitlab-CI herda vari√°veis ‚Äã‚Äãde ambiente?</a></li>
<li><a href="../pt491494/index.html">O golpe grandioso da ci√™ncia sovi√©tica: por que um navio orbital reutiliz√°vel acabou por ser uma s√≥ vez</a></li>
<li><a href="../pt491496/index.html">Dicas e truques do IntelliJ IDEA: 1. Comparando arquivos e pastas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>