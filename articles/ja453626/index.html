<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕍 ↙️ 🚇 別のスレッドでの冒険。Yandexレポート ✍🏽 🐾 🐐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="スムーズなUIを維持しながら、クライアントで画像を処理する方法は？インターフェース開発者のPavel Smirnovは、市場での写真検索の開発経験に基づいてこれについて話しました。レポートから、Web WorkersとOffscreenCanvasを正しく使用する方法を学ぶことができます。 -この3...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>別のスレッドでの冒険。Yandexレポート</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453626/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スムーズなUIを維持しながら、クライアントで画像を処理する方法は？インターフェース開発者のPavel Smirnovは、市場での写真検索の開発経験に基づいてこれについて話しました。レポートから、Web WorkersとOffscreenCanvasを正しく使用する方法を学ぶことができます。</font><font style="vertical-align: inherit;">
-この30分間は、冒険について話します。私の冒険についてお話しします。私のレポートがあなたに刺激を与え、あなたが家で同じことをするようになることを本当に願っています。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/t_/ku/-u/t_ku-uoatzm936x50sn7rzjab5w.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初に、私たちのブラウザーが私たちにクールなことをさせることを可能にするいくつかの新しいテクノロジーまたはそれほど新しいものではないテクノロジーについて話したかったです。しかし、誰もがMDNに行って何かを読むことができるので、これはそれほど楽しくないように思えます。したがって、私はマーケットチームで行った1つの機能の話をします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まずは自己紹介をしましょう。私はパシャです。マーケットチームのインターフェースデベロッパーです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bc/vy/s_/bcvys_xxtyt4hekvl26k-9zdlga.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は主にモバイルインターフェイスを扱います-地図検索、オファーカード。また、コードを古いスタックから新しいスタックに書き換え、次に新しいスタックからさらに新しいスタックに書き換えます。そして、私は自分のインターフェースを良いものにしようとしています。ここで、優れたインターフェースとは何かを言う価値があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
優れたインターフェースにはさまざまな特性があります。 1つ目は便利、2つ目は美しい、3つ目は手頃な価格です。しかし、今日お話ししたい特徴の1つはスピードです。そして、スピードはしばしば彼の仕事の滑らかさに現れます。小さなフリーズでも、インターフェイスのユーザーエクスペリエンスを大幅に変えることができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p-/ww/kw/p-wwkw03iuh5yrgyfc-fjvubma8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日の会話の計画に移りましょう。最初に、私が行ったタスク、つまり市場での写真の検索について説明します。次に、この機能を実装するために解決しなければならない問題について説明します。ここでは、ブラウザーでスクリプトがどのように機能するかを少し思い出し、私を助けたテクノロジーを調べます。小さなネタバレ：これらはWeb WorkersとOffscreenCanvasです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクに戻りましょう。数か月前、私たちの製品マネージャーであるルバが私に近づきました。 Lyubaは、市場で製品を選択する際の問題を扱います。今、私たちは商品を見つけるためのいくつかのオプションがあります。その1つは、検索バーに何かを入力することです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ul/m6/tn/ulm6tnl0vt8kdewxzrr1ofgfch0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、「サマラで赤いiPhone Xを購入する」などです。そして、私たちは何かを見つけるでしょう。または、カタログツリーを使用することもできます。このカタログには、カテゴリとサブカテゴリがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それが何と呼ばれているのかわからないまま、市場で何かを見つけたいのですが、私はこのものの写真を持っているか、誰かのパーティーでそれを見た場合はどうなりますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hz/0t/ne/hz0tnecdwmrqd4slxosbd4ghtgs.jpeg"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際の事例をお話しします。友達と一緒にカフェに行ったことがあります。そういう水差しでレモネードを注文しましたが、この水差しには奇妙なものがありました。私も写真をつけました。レモネードをグラスに注ぐときに氷が入らないようにするためのものです。クールなことだと思っていましたが、それが何と呼ばれているのか、一般的には何を意図しているのかについて、意見が異なりました。したがって、Yandex.Picturesで見つかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私はこのことを検索するだけでなく、すぐに購入するか、少なくとも価格を調べ、レビューや機能などを読むことができれば素晴らしいと思いました。この時点で、私たちの夢はAnyと一致し、市場でそのような機能を作ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能はどのようなものですか？それはユーザーが写真や写真をアップロードすることを可能にし、あなたはすぐに写真を撮ってそれを市場に送ることさえできます。 Yandex検索テクノロジーを使用してこの写真を分析し、その上で製品を見つけて、これらの製品での結果をユーザーに示します。簡単そうに聞こえますが、あまりにも単純なら報告はしません。これがどんな機能なのかわかるように見せてあげます。</font><font style="vertical-align: inherit;">
私がプロダクションで示す</font></font><br>
<br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のデモ</font></font></a></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">見てください</font></a></i><font style="vertical-align: inherit;">。まず、私たちが探していたものをアップロードして、何が起こるかを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはいくつかの商品、特にこれを見つけました。これをストレーナーといいます。何か他のものを見つけるために、私は昨日同僚の机で1冊の本を撮影しました、それを探しましょう。ここにそのような本があります、おそらく誰かがそれを読みました。 「パーフェクトコード」と呼ばれています。彼はまた、どういうわけか、何らかの理由で18歳以上に制限されていることに気付きました。これはおそらく少し奇妙です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レポートに戻りましょう。どのような問題が発生しましたか？最初の問題は、ユーザーが巨大な画像を含むあらゆるものをダウンロードし始めることです。たとえば、私の携帯電話は3から4メガバイトのサイズの写真を撮ります。そのような写真をバックエンドに送信することは非効率的です。分析に時間がかかり、分析に時間がかかるため、何かをする必要があります。しかし、ここではすべてが簡単です。この写真をクライアントでトリミング、圧縮、サイズ変更します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gs/qm/fo/gsqmfoelkfhdlcmhijbrpl1u3b8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをどのように行いますか？ファイルがあります。そして、どういうわけかこのファイルを読みます。 FileReader APIを使用して読み取ります。簡単に説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ii/c0/ip/iic0ipw8vjdg5mpre0x6yw3ye_q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ダウンロードしたファイルを読み取って何かを実行できるようにするブラウザーAPIです。あなたはさまざまな方法で読むことができます、私たちはそれを今見ていきます。ここにその機能があり、changeイベントによって入力から返されたある種のオブジェクトがあります。読んでみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/t6/ya/ddt6yaay0twlpecj1rkwxhzob1w.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは次のようになります。ここではまだ複雑なことは何もありません。 FileReaderコンストラクターから作成されたReaderオブジェクトがあり、その上でloadイベントの開発者をハングさせます。次に、このファイルをDataURLとして読み取ります。 DataURL-Base64を介してエンコードされたファイルのコンテンツを表す文字列。私たちが読んだように、何とかそれをカットする必要があります。まず、すべてを画像に読み込みます。タグまたはimg要素があり、そこにそれをロードします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/38/fo/oe/38fooeukiuqzgzmprkjqvpelgfw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは次のようになります。 img要素を作成し、load Readerイベントによってラインをsrc属性にロードします。ラインがimgへのロードが完了すると、さらに何でもします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像をトリミングして、やりたいことを行います。それを圧縮します。Canvasのようなものは非常に強力なツールです。多くのことができます。ただし、ここではこのCanvasに画像を描画するだけであり、画像のサイズが最大許容値を超えている場合は、少しはめ込みます。希望の圧縮率のCanvasでこの写真を撮ることもできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/if/zs/ny/ifzsnym6-fi7xyx8evc-_dvv4ni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのように。もう1つの小さな免責事項：ここのコードは大幅に簡略化されているため、すべてを指定するわけではありません。エラー処理などがありますが、すべてがスライドに収まり、レポートで明確かつ理解できるように、一部の詳細は省略しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像のサイズがあります。見ているだけです。いくつかの定数が許可されています。写真のサイズが定数を超える場合は、それらをトリミングして、キャンバスをこれらのサイズに設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、このキャンバスに絵を描きます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3n/c1/gr/3nc1gr71oyygkviglnhv9hwfzeg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2Dコンテキストを取得し、2D画像が必要であり、drawImageメソッドを使用して描画してみます。 DrawImageは、私が誤っていない場合でも、9つのパラメーターを受け入れる興味深いメソッドです。ただし、すべてが必須というわけではなく、5つだけを使用します。画像とそれらの2つのゼロを取得します。これは、画像のオフセットまたはインデントです。左上のポイントが必要です。必要な寸法で描画します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このCanvasから、DataURLエンコードされたBase64文字列をまったく同じ方法で取得し、サーバーに送信するのに便利な特殊オブジェクトであるblobに変換します。それがすべてのようです。すべてが機能しています。画像がトリミングされ、送信され、画像が認識されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかしそれから私は何かに気づき始めました。このソリューションをテストしたとき、特に弱いデバイスで写真をアップロードすると、インターフェイスの速度が少し低下しました。ボタンが押されなかったか、要素がスクロールしませんでした。あなたのコードは99％のケースで機能し、うまく機能していると感じましたか？そして、あなたはそれをテストのために与えることができ、おそらく誰も気付かないでしょう。特にユーザーは、特に弱いデバイスでは気付かないでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは私には一度も起こらなかったため、修正することにしました。これは問題であることが判明しました。画像が大きい場合、切り抜き、圧縮の操作中に少し時間がかかり、このわずかな時間で、インターフェースが応答しなくなりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、なぜこれが起こるのかを理解しました。ここで、ブラウザでJavaScriptがどのように機能するかを覚えておく価値があります。詳細には触れませんが、これは大きなレポートのトピックです。いくつかのポイントを覚えておいてください。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rx/bq/-n/rxbq-nzhacdcemzt89xme0h331w.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScriptを単一のスレッドで実行しているので、それをメインと呼びましょう。そして、ブラウザにはイベントループのようなものがあります。ここで、これはモデルであるとすぐに言います。一部のブラウザでは、イベントループの構成が異なりますが、名前が示すように、一般にループです。キュー内の特定のタスクを順番に処理します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不愉快な瞬間：1つのタスクを処理するまで、彼は次のタスクに進みません。私が見たデモを見せます、彼女はそれを見せます。彼女は定番です。</font></font><br>
<br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目のデモ</font></font></a></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を見ると、GIFイメージとCSSアニメーションがさまざまな方法で行われています。1つはtranslatexを使用し、もう1つは位置：相対的な左を使用し、3番目はJavaScript、つまりrequestAnimationFrameを使用しています。これはハリネズミが回転しているところです。何をしたらいいでしょう？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインスレッドを5秒間ブロックします。ご存知のように、たいていタフな人はn番目のフィボナッチ数を計算しますが、私は5秒の休憩で無限ループを作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が起こるか？ハリネズミが回転を停止し、translatexを使用してアニメーション化された下の猫も乗馬を停止したことにすぐに気付きました。しかし、Safariなどの別のブラウザーで同じデモを見てみましょう。 GIF猫の実行が停止しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜすべてを表示しているのですか？まず、ブラウザは異なります。これを考慮する必要があります。第二に、私たちの流れが何かによってブロックされると、いくつかのものが機能しなくなります。例-JavaScriptアニメーション。または、テキストが目立たなくなり、ボタンが押されなくなることを示しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは非常に抽象的な例です。 5秒間フローをブロックしないで、タスクを実行して、写真をアップロードし、トリミングし、絞り、ここに描画します。私たちはそれをどこにも送りません、それはあまり明らかにされません。</font></font><br>
<br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3番目のデモを見る</font></font></a></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はここに強力なMacBookを持っています。すべてをより説得力のあるものにするために、プロセッサを6倍遅くします。これにより、DevToolsを実行できます。写真をアップロードしてください。完璧なコードは私たちを再び助けます。見てのとおり、メインスレッドをブロックするときと同じことが起こります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、タスクに戻って、これにどう対処するかを考えてみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/us/bk/y1/usbky1tcsqcmijlpm7yvhzqejxu.jpeg"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、プロファイラーを見るとわかります。赤いフレームには、メインスレッドをブロックするマイクロタスクがあります。彼がそれをほぼ5秒間ブロックしていることがわかります。それはかなり強力なコンピュータ上にあり、より弱いデバイス上ではさらに目立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションに移りましょう。私が何を使ったか、何をしたかをすぐに言い、それからこれらすべてを分析します。まず、Webワーカーを使用しました。これらにより、別のスレッドでいくつかのタスクを実行できます。 2番目に、Webワーカーのコンテキストでは、DOMは利用できません。この状況に対処するために、他のツールを使用します。画像は使用できなくなり、クラシックCanvasが使用可能になるため、Canvasとその他のいくつかのトリックを使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fy/vw/f1/fyvwf1psmu5-m4szo28ffv7qykm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
労働者とは何か、何のためにあるのかをすぐに思い出しましょう。主にではなく、別のスレッドでJavaScriptを実行できます。また、ワーカーストリームはメインインターフェイスのレンダリングフローを妨げません。したがって、インターフェースを遅くすることなく、いくつかの複雑な計算タスクを実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーに何かを転送し、ワーカーから何かを返すことができるツールがあります。例を見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/3n/gt/tl3ngt03saazi4u4c-jrw2qpsjs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、コンストラクタを使用してワーカーを作成します。そこで、ファイルへのパスを転送する必要があります。 blobを渡すこともできます。そして、Messageイベントハンドラがあります。この場合、画面に何かを表示するだけです。次に、データをワーカーに送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/d4/zq/dzd4zq9kr9xsjub1pznwor1m0cy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サポートとは何ですか？ここですべてが良いです。 Workersはよく知られたツールであり、新しいものではありませんが、私の友人の多くは、常にサポートされているわけではないと考えています。本当じゃない。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/0p/iq/qq0piq8knelh8flsttmdu3nvmxc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、OffscreenCanvasを見てみましょう。すでに見てきたように、Canvasは非常に強力なツールですが、残念ながらWeb Workersのコンテキストでは使用できないため、代替手段を使用します。これはOffscreenCanvasと呼ばれるかなり新しいものです。 Canvasとほぼ同じことを、画面外、つまりWebワーカーのコンテキストでのみ行うことができます。もちろん、これはウィンドウのコンテキストで行うことができますが、今はできません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g4/26/zz/g426zzs7plg7015gze3pivfyedc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サポートには何がありますか？ご覧のとおり、赤がたくさんあります。通常、OffscreenCanvasはChromeでのみサポートされています。 Firefoxにもオプションがありますが、これまでのところフラグがあり、CanvasはWebGLコンテキストでのみ機能します。ここであなたは尋ねることができます-なぜ私はどこでも機能しないOffscreenCanvasのようなクールなことについて話しているのですか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/pg/po/utpgpozecg0ufn847t-jpfuleqe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し余談です。マーケットでは、いくつかのレベルのブラウザがサポートされています。そして、2つの数量があります。 1つの値はブラウザーを特徴付けますが、これはサポートされていません。これはブラウザの人気の約半分の割合です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして2番目の数量があります。サポート対象のブラウザが含まれますが、重要な機能のみが含まれます。ここでは、ワーカーなしですべての検索機能が動作しますが、小さなフリーズがあります。大丈夫だと思います。私たちのチームは大丈夫だと信じています。これを実装する方法を見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eo/p7/0l/eop70llp8tzton82fokyhi9c17e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが私たちがすることの図です。 FileReaderで読み取るファイルもあります。しかし、メインストリームでは、それをWeb Workersに送信します。そこでWebワーカーは切り取られ、圧縮されて返送されます。また、既にサーバーに送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uq/zx/x_/uqzxx_ifbctkux0m1o1ogw5pauu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーのコードを見てみましょう。まず、必要な幅と高さのOffscreenCanvasインスタンスを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、先ほど述べたように、WorkersコンテキストではImage要素を使用できないため、ここではcreateImageBitmapメソッドを使用します。これにより、画像を特徴付けるデータ構造が作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おもしろいから：私たちはここに自分自身を見ます。 Webワーカーに慣れていない人は、これは実行コンテキストを指します。ここでも、ウィンドウでも、これでもかまいません。私たちは自己を使用します。このメソッドは非同期で、コンパクトさと利便性のためにここで待機しましたが、なぜですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、同じ画像を取得し、以前と同じことを行います。キャンバスに描画して戻ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シンプルから。以前はDataURLを使用して、すべてをblobに変換していました。ただし、ここでは、convertToBlobメソッドをすぐに使用できます。以前に使用したことがないのはなぜですか？サポートが悪かったからです。しかし、ここまでずっと行ってOffscreenCanvasを使用していたので、convertToBlobを使用できないのはなぜですか。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a2/c-/bs/a2c-bssaaa8knh26p10fdta__zc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このblobは基本的にストリームを返し、そこからサーバーに送信します。または、デモのように描画します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、メインスレッドでワーカーを作成し、そこからのメッセージをリッスンして、サーバーに描画または送信します。ここで重要なことは何もありません。労働者は私たちのファイルを受け入れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デモに戻りましょう。</font></font><br>
<br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4番目のデモを見る</font></font></a></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべて同じデモ、同じ3匹の猫とハリネズミ。再度スロットルをオンにして、プロセッサを6倍遅くします。同じ写真をアップロードします。ご覧のように、絵が描かれた時点では、アニメーションは停止せず、ハリネズミが回転し続け、インターフェースが残っていて、私たちが望むものを達成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、この決定を改善できるでしょうか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sc/jo/x0/scjox0apap-ojlx03_gfvauava8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、ここはプロファイラーです。ここでは、前に見た5秒間の巨大なマイクロタスクは表示されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
改善-できます。 Transferableオブジェクトの使用。ここでもう一度戻る価値があります。 DataURLまたはblobをpostMessageメカニズムに渡したときに、このデータをコピーしました。これはおそらくあまり効果的ではありません。それを避けるのはクールです。したがって、パッケージ内にあるかのようにWebワーカーにデータを転送できるメカニズムがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ「いいね」と言うのですか？このデータをワーカーに転送すると、メインストリームでワーカーを制御できなくなります。ワーカーとやり取りすることはできません。ここには2つ目の制限があります。すべてのデータタイプをWebワーカーに転送することはできません。これは文字列では実行できません。別の方法で実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7s/ai/ml/7saimltvcz1_i2iwgxbfeoyqaxq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを見てみましょう。まず、データの送信方法が少し異なります。これが私たちのpostMessageです。ご覧のとおり、loadEvent.target.resultを使用したそのような配列があります。このようなインターフェースを使用すると、データをTransferableオブジェクトとして転送し、それらを制御できなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、Rustで書く人なら誰でも、なじみのあるものを聞くでしょう。そして、ファイルを文字列としてではなく、ArrayBufferとして読み取ります。これは、直接アクセスできないLIDARバイナリデータのストリームです。したがって、私たちは彼らと別のことをする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/o6/t8/5jo6t8mnnnnlquvzvnsnluqs__4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ImageWorkersに戻ります。ここでそれははるかに面白くなりました。まず、バッファーを取得して、Uint8ClampedArrayなどのひどいことを行います。これは型付き配列です。名前が示すように、その中のデータは符号番号、つまり、画像のピクセルを表す0〜255の数値です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の引数は、幅に高さを乗算し、4を乗算したものです。なぜ正確に4つなのですか？まさに、RGBA。色ごとに3つの値とアルファチャネルごとに1つの値があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、この配列からImageDataを作成します。これは、キャンバスに簡単に描画できる特別なデータ型です。ここで興味深いことは何もありません。単に配列を取り、それをコンストラクタに渡します。さらに、キャンバスに画像を描画するのと同じ方法で、ImageDataの下で別のメソッドを使用します。さらに、すべてが以前と同じです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論に移りましょう。今日私はあなたがずっと前に私がしなかった一つの仕事についてあなたに話しました。私はそれに気付きましたか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0l/ay/mp/0laympqckrdgl8mbdfc7zozrgfa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェースの滑らかさは非常に重要です。ユーザーが少し遅れると、少しフリーズし、ボタンが押されないため、UXが大幅に低下する可能性があります。ブラウザーの動作は異なります。 SafariとYandex.Browserを使った球状の例を見てみました。 1つのブラウザーでインターフェースの滑らかさを確認した場合は、他のブラウザーも確認する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長時間続く場合は、ブロッキングスクリプトで何かをする必要があります。私の場合、それをWebワーカーに配置しました。しかし、おそらく他のアプローチがあるでしょう、あなたはどういうわけかそれらをより小さいものに分割することができます、ここであなたは考えなければなりません。また、これらすべての問題を解決するのに役立つ、Webワーカーなど、最新のツールまたはそれほど近代的ではないツールのセットがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は何？すべてのインターフェースの滑らかさをチェックすることをお勧めします。それは非常に重要です。そして、弱いデバイスについて覚えておいてください。私たちは20万人がラップトップを使ってコーヒーやスムージーを飲んで座っており、一般的な電話でのインターフェイスの動作を常に見ているわけではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、Web Workersの使用を妨げるものはありません。サポートは非​​常に優れており、テクノロジーは新しいものではなく、実証済みであり、インターフェースのフリーズのいくつかの問題をかなり解決します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの関連リンク：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザーのしくみ：最新のWebブラウザーの舞台裏</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OffscreenCanvasとWebワーカーを使用したWebGL / Three.jsの高速化</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OffscreenCanvas-WebワーカーでCanvasオペレーションを高速化</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうもありがとう。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453612/index.html">雲の中のサッカー-ファッションか必需品か？</a></li>
<li><a href="../ja453614/index.html">ローカル（オフライン）npmリポジトリ</a></li>
<li><a href="../ja453616/index.html">連邦法「電子署名について」（63-FZ）の何が問題になっており、どのように修正しますか</a></li>
<li><a href="../ja453618/index.html">アイデアの取り扱い方とLANBIXの誕生</a></li>
<li><a href="../ja453622/index.html">G-Shieldチッププログラマー：製造段階でチップにデジタル証明書を書き込む</a></li>
<li><a href="../ja453628/index.html">あなたは20年で何を支払いますか？</a></li>
<li><a href="../ja453634/index.html">システム分析のアルファ銀行学校</a></li>
<li><a href="../ja453642/index.html">単語で書かれた数のスマートパーサー</a></li>
<li><a href="../ja453644/index.html">インタビュー-Swiftに関する10の質問。パート3</a></li>
<li><a href="../ja453650/index.html">F-35ユニファイドストライクファイターソフトウェアオンボードサイバーインフラストラクチャ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>