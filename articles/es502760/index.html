<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼 🍼 🏊 ¿Qué es MagicString y estas líneas son tan mágicas? 🍍 🤸🏽 👩🏿‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MagicString es una biblioteca poco conocida. A pesar de esto, resuelve uno de los problemas más acuciantes: cambiar el código fuente utilizando su est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>¿Qué es MagicString y estas líneas son tan mágicas?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502760/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagicString es una biblioteca poco conocida. </font><font style="vertical-align: inherit;">A pesar de esto, resuelve uno de los problemas más acuciantes: cambiar el código fuente utilizando su estructura (AST - árbol de sintaxis abstracta). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este artículo aprenderemos qué es MagicString y si estas líneas son realmente "mágicas". </font><font style="vertical-align: inherit;">Esto nos ayudará a comprender el próximo artículo en el que explicaré cómo logramos traducir la documentación angular tan rápidamente, y cómo ayudará con la creación de un traductor universal para Markdown y archivos de cualquier otro formato.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/vs/2s/tevs2snderlng8i4ucqdjp6q2t8.jpeg"><br>
<br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace 2 semanas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publiqué la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> documentación en idioma ruso de Angular ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">angular24.ru</font></a><font style="vertical-align: inherit;"> ). Durante este tiempo, se agregaron 35 problemas con correcciones en el texto y 2 solicitudes de extracción. Dudo sinceramente que el sistema en el que selecciona el texto, ofrezca una traducción y emita automáticamente en GitHub funcionará. ¡Pero el crowdsourcing funciona! :) Puedes aprender más sobre esto en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este artículo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después del lanzamiento, una de las preguntas más frecuentes fue: "¿Por qué?". La pregunta es absolutamente correcta, pero para responderla, primero debe comprender qué es MagicString, cómo funciona y cómo es útil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que tenemos un código fuente simple:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queremos reemplazar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La solución más simple es reemplazar const con var con el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String.prototype.replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> habitual </font><font style="vertical-align: inherit;">. Y para esta tarea, esta es probablemente la solución más correcta. Pero, ¿qué sucede si necesitamos reemplazar const con var solo en el ámbito global? ¿Pero no los reemplaza dentro de las funciones? Por supuesto, puede encontrar una regularidad más compleja o escribir código complicado, pero hay una forma más escalable y flexible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos usar los analizadores para obtener AST - Árbol de sintaxis abstracta. Si está interesado en qué es AST, vaya a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astexplorer.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En esencia, es un árbol que muestra con precisión la estructura de su código. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, cada uno de los nodos en este AST tiene un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comienzo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font><font style="vertical-align: inherit;">índices </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finales que</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indican las posiciones de estos elementos en el código fuente. Conociendo estas coordenadas y teniendo a mano la estructura del documento, podemos hacer reemplazos y permutaciones complejas con la preservación de la estructura del documento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/ox/o-/sroxo-of0k9wyxj-e8zdd-3rebe.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo general, el reemplazo se realiza utilizando el diseño de patrón de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visitante</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y varios </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ayudantes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que generalmente se envuelven en una sola biblioteca, que se puede llamar la "API del transformador". Cada analizador tiene su propia "API de transformador". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dichas bibliotecas son muy fáciles de usar, pero tienen varios problemas. Uno de ellos es el rendimiento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como cada nodo (bueno, casi todos) en el árbol AST contiene coordenadas, al cambiar 1 nodo a menudo necesitamos actualizar las coordenadas para el resto del árbol. Aquí puede argumentar que puede hacerlo con poca sangre: no actualice las coordenadas en todas partes, sino que simplemente devuelva el AST al texto según la estructura. Pero hay un problema: perderá inmediatamente el formato del texto original, lo que contradice nuestra tarea: reemplazar const con var en la línea existente. De hecho, obtenemos una nueva línea con un nuevo formato. Y si esto no es un problema para una línea pequeña, imagine un archivo de 1000 líneas en el que el formato ha cambiado completamente debido a la sustitución de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Eso no suena muy bien.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/f4/0c/9cf40cjrgwepibssksrrwry2dw8.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aquí viene la magia de MagicString. La primera vez que supe de su existencia fue </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gracias al</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proyecto Rich Harris, que se llamaba </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">butternut</font></a><font style="vertical-align: inherit;"> . Butternut es un minificador de JavaScript. Se dijo que Butternutt era </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> más rápido que UglifyJS </font><font style="vertical-align: inherit;">y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-15 veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> más rápido que Babili </font><font style="vertical-align: inherit;">. Seguiré adelante y diré que el proyecto se cubrió con una cuenca de cobre hace al menos 3 años. Pero incluso entonces, estaba intrigado por el secreto de su desempeño. Fue un MagicString. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo al trabajo con MagicString:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> MagicString = <span class="hljs-built_in">require</span>( <span class="hljs-string">'magic-string'</span> );
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> MagicString( <span class="hljs-string">'const a = 1; const b = 2;'</span> );<font></font>
<font></font>
s.overwrite( <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'var'</span> );<font></font>
s.toString(); <span class="hljs-comment">// 'var a = 1; const b = 2;'</span><font></font>
<font></font>
<span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo de MagicString es muy simple: envolvemos la cadena original en un objeto en el que no aplicamos directamente los cambios a la cadena, pero agregamos las coordenadas y lo que debe hacerse en una matriz para el futuro. </font><font style="vertical-align: inherit;">Y solo cuando alguien quiere obtener la fila resultante, comenzamos 1 a 1 para realizar las operaciones acumuladas. </font><font style="vertical-align: inherit;">Por ejemplo:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reemplazamos const por var, comenzando en el índice 0 y terminando en el índice 5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sabemos que todos los reemplazos posteriores deben tener un índice menor que 2 (var menos que constante por 2 caracteres, una línea más corta)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizamos las coordenadas de todas las operaciones.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicamos la siguiente operación, etc.</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/fy/us/kz/fyuskzc54fgvtkxeuwbldzpp2xq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo se ve bastante simple. Pero, ¿por qué MagicString es más rápido? La respuesta es bastante simple: la cantidad de operaciones que realizamos en nuestro árbol es mucho menor que la cantidad de nodos AST. Sin mencionar la cantidad de memoria necesaria para el AST y el hecho de que Tree Traversal (viajar a través de un árbol) no es una operación libre, sino O (n + m)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b8/5b/jw/b85bjw9enaiibwd0vo3mbmbk198.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Y si estoy listo para esperar media hora extra? Y aquí viene la segunda ventaja de MagicString. Cada analizador inventa su propia API para la transformación. Y esto sigue siendo muy bueno, si existe una API de este tipo (no todos los analizadores lo proporcionan), muy a menudo nos quedamos sin la capacidad de reemplazar normalmente el texto fuente usando AST. Pero MagicString es una única API universal para cambiar la cadena de origen. No importa qué analizador o combinación de analizadores haya utilizado. Con MagicString, puede trabajar igualmente bien con cualquier AST. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/63/7v/jf/637vjfnual-mzplhm5ligr1u3bs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que estés interesado en MagicString. En el próximo artículo hablaré sobre el doble MagicString y cómo hacer un traductor universal de documentos Markdown. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suscríbase a mi canal de Telegram </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@obenjiro_notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obenjiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para no perderse los siguientes artículos sobre el tema y muchas otras cosas interesantes.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502740/index.html">¿Cómo desinfectar aviones en la era de covid-19?</a></li>
<li><a href="../es502742/index.html">Te invitamos a DINS DevOps EVENING (en línea): la evolución de Prometheus y Zabbix y el procesamiento de registros de Nginx en ClickHouse</a></li>
<li><a href="../es502744/index.html">10 grandes repositorios de desarrolladores de Github (Parte 2)</a></li>
<li><a href="../es502746/index.html">Productividad y motivación a distancia: las empresas de TI rusas comparten 2 meses de experiencia de forma aislada</a></li>
<li><a href="../es502752/index.html">3 trampas en las que los científicos de datos principiantes caen</a></li>
<li><a href="../es502762/index.html">Diferentes formas de pasar datos a componentes angulares</a></li>
<li><a href="../es502768/index.html">El título de este artículo fue inventado por una computadora.</a></li>
<li><a href="../es502770/index.html">Revelamos ProLock: análisis de las acciones de los nuevos operadores de ransomware utilizando la matriz MITER ATT & CK</a></li>
<li><a href="../es502772/index.html">Cómo crear un servidor PostgreSQL en Google Cloud Platform SQL</a></li>
<li><a href="../es502782/index.html">Joel Spolsky: Nivel de abstracción para desarrolladores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>