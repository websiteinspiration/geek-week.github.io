<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💑 💂🏼 🈯️ Vusbライブラリの発明 👩🏿‍🔧 🧑🏾‍🤝‍🧑🏼 💇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 

名前を読んだ後、論理的な質問が発生する可能性があります。ハードウェアモジュールを備えた安価なコントローラーがたくさんあるのに、なぜ今日は低速USBのソフトウェア実装を研究するのでしょうか。事実、ハードウェアモジュールは論理レベルの交換レベルを隠しており、USBプロトコルを一種の魔法に変...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Vusbライブラリの発明</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460815/"><h2 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前を読んだ後、論理的な質問が発生する可能性があります。ハードウェアモジュールを備えた安価なコントローラーがたくさんあるのに、なぜ今日は低速USBのソフトウェア実装を研究するのでしょうか。</font><font style="vertical-align: inherit;">事実、ハードウェアモジュールは論理レベルの交換レベルを隠しており、USBプロトコルを一種の魔法に変えます。</font><font style="vertical-align: inherit;">この「魔法」がどのように機能するかを感じるには、最低レベルから始めて、最初からそれを再現することよりも優れた方法はありません。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この目的のために、ATmega8コントローラに基づいて、USB-HIDを装ったデバイスを作成しようとします。広く普及している文献とは異なり、理論から実践、最低レベルから最高、論理電圧から結論まで、コードが期待どおりに機能するかどうかをチェックする各ステップの後に、同じVusbの「発明」で終わりません。これとは別に、私はこのライブラリに代わるものを発明するのではなく、ソースコードを一貫して複製し、元の構造と名前をできるだけ維持して、このセクションまたはそのセクションが機能する理由を説明します。しかし、私のコードを書く通常のスタイルは、vusb作者のスタイルとは異なります。私は正直に認めます利他的な興味（他の人に難しいトピックを伝えるため）に加えて、私には利己的な興味があります。自分でトピックを研究し、説明を通じて、自分にとって最大の微妙な点をとらえることです。また、いくつかの重要なポイントを逃したり、一部のトピックが完全に開示されていない可能性もあります。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードをよりよく理解するために、変更されたセクションをコメントで強調表示し、前述のセクションからそれらを削除しようとしました。</font><font style="vertical-align: inherit;">実際には、ソースコードが主な情報源となり、テキストは何が行われたか、その理由、および期待される結果を説明します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言及しなくても、より高速な品種を区別するものは、低速USBのみが考慮されることにも注意します。</font></font></p><a name="habracut"></a><br>
<h2 id="shag-0-zhelezo-i-prochaya-podgotovka"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ0.アイロンとその他の準備</font></font></h2><br>
<p>         ATmega8   12 .    ,    (.   vusb),    ,    .     D+  PD2,  D- PD3,     PD4.  ,        ,         .</p><br>
<p>  USB   5 ,        3.6  (      ).      ,      .    ,       .</p><br>
<p>   «» ,    ,      ,     -  .        PD6, PD7 ,  , UART  PD0, PD1,   115200,          screen       COM-:</p><br>
<pre><code class="bash hljs">$ screen /dev/ttyUSB0 115200</code></pre><br>
<p>     USB  wireshark    (, ,     « »,               ).</p><br>
<p>          , makefile`  ,      .          ,    USB.  -      , ,  ,     USB  ?</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">      Github</a></p><br>
<h2 id="shag-1-prinimaem-hot-chto-to"> 1.   -</h2><br>
<p> , USB    ,   AVR    : 1.5   .        .        D-   3.3     1.5 ,        +5 ,    .    12       8 . ,         ,     drvasm.S.           . ,   ,   USB,  , SYNC,       ,  .            64   (     ),     ,    USB  .</p><br>
<p>       usbconfig.h.     ,   USB,    ,   .</p><br>
<blockquote><strong>  </strong><br>
   USB       .       SYNC,  0b10000000,  — -  PID.          (   ,   vusb   ,    )    NRZI.     ,         ,    — -.  ,     (    ,   )    :        ,         ,     ,    .       8  9 .<br>
    ,     USB ,     D+  ,  D-   (  K-)   (J-).        . ,   :    (  SE0)        (D+ = D- = 0).    ,     D+  ,   D- ,    .    (     )   Idle,   ,    —  .</blockquote><p>,     ,     SE0,      .      USB    , D+  D-.   ,   , ,      D-.</p><br>
<p>       SYNC   Idle`.  Idle  .1   D- (  J-),   SYNC  0b100000,        ,     NRZI,       ,   —   .    D-  :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th>Idle</th>
<th>SYNC</th>
<th>PID</th>
</tr>
</thead>
<tbody>
<tr>
<td>USB</td>
<td>1..1</td>
<td>00000001</td>
<td>????????</td>
</tr>
<tr>
<td>D-</td>
<td>1..1</td>
<td>01010100</td>
<td>????????</td>
</tr>
</tbody>
</table></div><br>
<p>       ,     .                ?         ,   SYNC   .        ,        ,   -,      . ,  «-»  —   ,         ,          .    SYNC  :          (  K-).     . ,   drvasm.S         foundK.        ,     ,         ,     .      ,       .   8  (   nop')    .    ,     SYNC'       .</p><br>
<p>,              UART.     SE0       .</p><br>
<p>      ,      .     :</p><br>
<pre><code class="plaintext hljs">4E 55 00 00 4E 55 00 00 4E 55 00 00 4E 55 00 00 4E 55 00 00 </code></pre><br>
<p>,    ,       NRZI.   ,    :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>4E</td>
<td></td>
</tr>
<tr>
<td>NRZI</td>
<td>01001110</td>
<td>0 (. )</td>
</tr>
<tr>
<td></td>
<td>00101101</td>
<td></td>
</tr>
<tr>
<td></td>
<td>2D</td>
<td></td>
</tr>
</tbody>
</table></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>55</td>
<td></td>
</tr>
<tr>
<td>NRZI</td>
<td>01010101</td>
<td>0 (. )</td>
</tr>
<tr>
<td></td>
<td>00000000</td>
<td></td>
</tr>
<tr>
<td></td>
<td>00</td>
<td></td>
</tr>
</tbody>
</table></div><br>
<p>    ,  16        .</p><br>
<p> ,    ,     ,    .</p><br>
<h2 id="shag-2-demo-versiya-nrzi"> 2. - NRZI</h2><br>
<p>   ,     :  XOR   ,  ,      ,       :</p><br>
<pre><code class="plaintext hljs">mov temp, shift<font></font>
lsl shift<font></font>
eor temp, shift<font></font>
com temp<font></font>
rcall uart_hex</code></pre><br>
<p>  :</p><br>
<pre><code class="bash hljs">2D 00 FF FF 2D 00 FF FF 2D 00 FF FF 2D 00 FF FF 2D 00 FF FF</code></pre><br>
<h2 id="shag-3-izbavlyaemsya-ot-cikla-priema-bayta"> 3.     </h2><br>
<p>             .     nop`,       .        NRZI,    .</p><br>
<p>     .</p><br>
<h2 id="shag-4-chitaem-v-bufer"> 4.   </h2><br>
<p>    , ,   ,      ,     ,  -  .        ,      .<br>
 </p><br>
<p>   USB      :  SYNC,  PID+CHECK (2   4 ),   ( 11 ,     8- )   CRC    5 ( 11-  ),  16 ( ) .      (EOP) —   ,     .</p><br>
<p>       ,   nop`      .           ,      ,       ,   rxbit2.    .  ,       8  .    PID  CRC16,    11 .  SYNC   EOP   .        ,      ,      .        ,      ,     .</p><br>
<h2 id="shag-5-rabotaem-s-buferom-po-chelovecheski"> 5.    -</h2><br>
<p>     ,   ,    ,      .      .<br>
   :</p><br>
<pre><code class="bash hljs">&gt;03 2D 00 10 &gt;01 FF &gt;03 2D 00 10 &gt;01 FF &gt;03 2D 00 10 &gt;01 FF &gt;03 2D 00 10 &gt;01 FF &gt;03 2D 00 10 &gt;01 FF</code></pre><br>
<h2 id="shag-6-dobavlyaem-dobavku-dobavochnyh-nuley"> 6.    </h2><br>
<p>-         .  ,      —  ,       .           ,     ,    .      :</p><br>
<pre><code class="plaintext hljs">unstuff0:                   ;1 (  breq)<font></font>
    andi    x3, ~(1&lt;&lt;0)     ;1 [15]  0-  .    <font></font>
    mov     x1, x2          ;1 [16]      ()<font></font>
    in      x2, USBIN       ;1 [17] &lt;-- 1-   .    <font></font>
    ori     shift, (1&lt;&lt;0)   ;1 [18]  0-   .1     <font></font>
    rjmp    didUnstuff0     ;2 [20]<font></font>
;&lt;---//---&gt;<font></font>
rxLoop:<font></font>
    eor     shift, x3       ;1 [0]<font></font>
    in      x1, USBIN       ;1 [1]<font></font>
    st      y+, shift       ;2 [3]<font></font>
    ldi     x3, 0xFF        ;1 [4]<font></font>
    nop                     ;1 [5]<font></font>
    eor     x2, x1          ;1 [6]<font></font>
    bst     x2, USBMINUS    ;1 [7]     0-   shift<font></font>
    bld     shift, 0        ;1 [8]<font></font>
    in      x2, USBIN       ;1 [9] &lt;--  1- (, )<font></font>
    andi    x2, USBMASK     ;1 [10]<font></font>
      breq  se0             ;1 [11]<font></font>
    andi    shift, 0xF9     ;1 [12]<font></font>
didUnstuff0:<font></font>
      breq  unstuff0        ;1 [13]<font></font>
    eor     x1, x2          ;1 [14];<font></font>
    bst     x1, USBMINUS    ;1 [15]     1-   shift<font></font>
    bld     shift, 1        ;1 [16]<font></font>
rxbit2:<font></font>
    in      x1, USBIN       ;1 [17] &lt;--  2-  (, )<font></font>
    andi    shift, 0xF3     ;1 [18]<font></font>
      breq  unstuff1        ;1 [19]<font></font>
didUnstuff1:</code></pre><br>
<p>          .  ,       ,     .       rxLoop,         [0, 3].    [1]    D-,  XOR'      NRZI (,   XOR   ,        x3,   0xFF)    0-   shift [7,8].     —        .  ,   D-    (  !      , XOR')  .        0, 7, 6, 5, 4, 3 .      ,         .    ,     [12],    1    : 0b11111001 = 0xF9.        ,          unstuff0.      [17]   ,     ,  [9].         x1, x2.   ,         ,   XOR`  ,     . ,         .   ,     shift   ,   ,  ,     [18].    ,          ,      ,            .  ,   shift    (  ),   — .        ,      XOR'   0xFF [0],   0xFE,   ,        0 , ,    .     [15]    .</p><br>
<p>     1-5. , 1-    1, 0, 7, 6, 5, 4,    2, 3 .    0xF3.<br>
   6  7  :</p><br>
<pre><code class="plaintext hljs">didUnstuff5:<font></font>
    andi    shift, 0x3F     ;1 [45]   5-0<font></font>
      breq  unstuff5        ;1 [46]<font></font>
;&lt;---//---&gt;<font></font>
    bld     shift, 6        ;1 [52]<font></font>
didUnstuff6:<font></font>
    cpi     shift, 0x02     ;1 [53]   6-1<font></font>
      brlo  unstuff6        ;1 [54]<font></font>
;&lt;---//---&gt;<font></font>
    bld     shift, 7        ;1 [60]<font></font>
didUnstuff7:<font></font>
    cpi     shift, 0x04     ;1 [61]   7-2<font></font>
      brsh  rxLoop          ;3 [63]<font></font>
unstuff7:</code></pre><br>
<p>  6-    0b01111110 (0x7E),      shift ,    0- ,      .  ,   [45]    ,  7 . ,    ,   1-6  ,  0-   .       0  1,     «,  2» [53, 54].</p><br>
<p>     7- :    0xFC    «,  4» [61, 63].</p><br>
<h2 id="shag-7-sortiruem-pakety"> 7.  </h2><br>
<p>         (PID),  0x2D (SETUP),   . ,      0x2D SETUP',     ACK?   ,    USB          ,   ,     .   , PID,   4 ,     4  CHECK,     PID.  ,      PID+CHECK,  , CHECK+PID. ,   ,     ,     .       usbconfig.h  ,    .</p><br>
<p>      PID', ,      (   ),       ,     .         asmcommon.inc,     ,    .     .<br>
     </p><br>
<blockquote><strong> </strong><br>
    USB   .        -,    ,       :  (SETUP),   (OUT)    (IN).   -      .     (DATA0  DATA1),      ,   ,    -.           — HANDSHAKE,   (ACK, NAK, STALL,     ).<br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>SETUP</th>
<th></th>
<th>DATA0</th>
<th></th>
<th>Handshake</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-&gt;device</td>
<td>pause</td>
<td>host-&gt;device</td>
<td>pause</td>
<td>device-&gt;host</td>
</tr>
</tbody>
</table></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>OUT</th>
<th></th>
<th>DATA0/DATA1</th>
<th></th>
<th>Handshake</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-&gt;device</td>
<td>pause</td>
<td>host-&gt;device</td>
<td>pause</td>
<td>device-&gt;host</td>
</tr>
</tbody>
</table></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>IN</th>
<th></th>
<th>DATA0/DATA1</th>
<th></th>
<th>Handshake</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-&gt;device</td>
<td>pause</td>
<td>device-&gt;host</td>
<td>pause</td>
<td>host-&gt;device</td>
</tr>
</tbody>
</table></div><br>
<br>
        ,          . ,       ,       -,      - .</blockquote><p>,     ,   .     PID   .                ACK,         .     IN   .       SETUP  OUT,         .</p><br>
<p> ,       , -  main.</p><br>
<p>  ,            :</p><br>
<pre><code class="bash hljs">2D|80|06|00|01|00|00|40|00 <font></font>
C3|80|06|00|01|00|00|40|00 <font></font>
2D|80|06|00|01|00|00|40|00 <font></font>
C3|80|06|00|01|00|00|40|00</code></pre><br>
<p>   —   . ,  SETUP  OUT  .</p><br>
<h2 id="shag-8-chitaem-adres-na-konverte"> 8.    </h2><br>
<blockquote><strong> </strong><br>
- (SETUP, IN, OUT)     ,   ,    ,                .     ,      .      ,     . ,     USB-COM,    —          (  )          ().          .   ,            ( RTS, DTR  )    (,  ).        .  , ,       .   ,    USB-COM     3  .  , ,  -…<br>
   ,     ,            .      USB-.     «»        ,    .     ,    .<br>
 ,   ,       -.     :<br>
<br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th>SYNC</th>
<th>addr</th>
<th>endpoint</th>
<th>CRC</th>
<th>EOP</th>
</tr>
</thead>
<tbody>
<tr>
<td> USB</td>
<td>0-7</td>
<td>0123456</td>
<td>0123</td>
<td>01234</td>
<td>01</td>
</tr>
<tr>
<td> </td>
<td></td>
<td>0123456</td>
<td>7012</td>
<td>34567</td>
<td></td>
</tr>
</tbody>
</table></div><br>
<br>
     ,    -   ( -  PID = SETUP  OUT)   (IN)  ,     .</blockquote><p>    ,       (-)     (Handshake) :</p><br>
<ul>
<li> :     ,     ,  NAK  </li>
<li> -:   SETUP  OUT,  ,  IN — , </li>
<li>  .   ,              ,        ,       </li>
</ul><br>
<p>      « —  »    .         PID',      ,     .     «PID»  .       usbCurrentTok.   PID'   (DATA0, DATA1)   ,      .      ,   ?  :    ,    ( 0   usbCurrentTok     ),    ,     .       ( SE0)      ,  -  ,     D+, D- .        ,       SYNC,   . ,             ,          .    «»    ,        .          .</p><br>
<p>       ,         .       x3,          (,     ,     ,         ).</p><br>
<p>   ,   USB    ,      ,              .     ,  ,     ,          CRC (      ).      ,      [21].       0-    .      ,    [26]. ,        CRC,        .</p><br>
<h2 id="shag-9-bezotkaznyy-priem"> 9.  </h2><br>
<p>      ,       ,    « »,   ACK.         NAK',     (    cnt —         ).   USB     ,   ,            SYNC  PID.       Y,           cnt (         ).     ,        — ACK.       x3      —    1 ,           .     x3 (  r20)    20.</p><br>
<p>       (     SETUP,     ),   ACK'  ,    ,        ,      . ,              .</p><br>
<p>  ,       D+, D- (      ),    — .      XOR  ,      , ,  ,    -  .</p><br>
<p> ,     ,     ,      ,   . ,    ,        ,           .        .   vusb   :  txBitloop   2    ([00], [08]).    3 ,  6 .       ,             .      1    3    :      171.       (    171,        11 ,    ),    — ,    .    cnt=4:</p><br>
<p>4 — 171 = -167 = (   ) 89 (+ )<br>
89 — 171 = -82 = (   ) 174 (+ )<br>
174 — 171 = 3.     ,    <br>
      ,      .</p><br>
<p> ,   3 ,      1.      6       ,    ,      x4.        D+, D-   ,     .&nbsp;.<br>
         :</p><br>
<pre><code class="bash hljs">2D|80|06|00|01|00|00|40|00 <font></font>
69|00|10|00|01|00|00|40|00</code></pre><br>
<p>   C3 .  ,       ,      UART   . ,  ,       IN ,       . ,    .</p><br>
<h2 id="shag-10-posylaem-hosta-nak"> 10.   NAK</h2><br>
<p>   NAK    ,       .      ,      .       ,  -       .</p><br>
<p>     ,      .    ,  ,   -    ,     .        usbRxBuf,    .        ,   —  ,     USB_BUFSIZE.        usbInputBufOffset,            .        .</p><br>
<p>  NAK    handleData      ,        [22].            (usbRxLen),     - .       (   —    ),       usbRxLen,  ,      —  usbRxToken,   SETUP  OUT - .   :        ,     ,   ACK .</p><br>
<p>                 .   ,     ,     -    ,  -,    .         ?    ,   ,    ,   ,    -    .</p><br>
<p> ,    </p><br>
<pre><code class="bash hljs">2D|80|06|00|01|00|00|40|00</code></pre><br>
<p>    ,    NAK`,    ,     .</p><br>
<h2 id="shag-11-obrabatyvaem-zaprosy"> 11.  </h2><br>
<p>    , ,        .       —         .     ,      ,     , ,  ,     .            .        .         ,    USB,           usbPoll.  —      ,     .    —     .      SETUP ,     PID  CRC,    SETUP  5-  ,     16-.      3 «» . «»   PID      usbRxToken,  CRC   ,         ,  .        usbProcessRx,      ,       .</p><br>
<p> ,   ,        —  ,     SE0.   ,     USB      .</p><br>
<p>    .        SETUP,           .        .  SETUP    usbRequest_t    8 .      :  (    USB-)  ,     - .         ,     .           .<br>
     , ,  ,  .</p><br>
<h2 id="shag-12-podrobnosti-setupa"> 12.  SETUP'</h2><br>
<p>,  ,      .     .     usbDriverSetup,         . ,      . ,      (    ,     ,            )   . ,           : ACK  NAK,        .</p><br>
<h2 id="shag-13-otpravlyaem-otvet"> 13.  </h2><br>
<p>   ,      SETUP + DATAx,    DATAx   8 .        IN      DATAx,     .         ,     .        ,      ACK  NAK.           ,       .   —    usbTxBuf,   ,   usbTxLen   .  low-speed USB          8  ( PID,    CRC),    usbTxLen      11.      PID,   ,      . ,     16,   , 0x0F,   .    PID      ,       .        IN,   ,       (handshake    ,    ).</p><br>
<p>     :<br>
  SETUP + DATAx,    ACK  NAK      . , ,  usbPoll,   ,        (       PID=DATA1 (  DATA0  DATA1   ,     ,     DATA1).   CRC  .       ,    ,   -   .           — 4 .  ,    3 ,   4.   ,   SYNC       .          «   IN   NAK?»     NAK.      ,     , DATA1   .</p><br>
<p>     ,     — USBRQ_SET_ADDRESS (   ,    ).          .          (drvsdm.S,  make SE0).     ,              ,   ,      DATA1    ,  ,          . ,   ,           ,    ,           ,        .       ,         ,      .</p><br>
<h2 id="shag-14-sortiruem-standartnye-zaprosy"> 14.   </h2><br>
<p>   ,        .   ,    USBRQ_GET_DESCRIPTOR  USBRQ_SET_ADDRESS, ,    .    usbDriverDescriptor,    .        ,   USBRQ_GET_DESCRIPTOR.  ,    , :</p><br>
<p>USBDESCR_DEVICE —   :   USB (1.1   ),  , ,    .&nbsp;.<br>
USBDESCR_CONFIG — ,     ,    .&nbsp;.<br>
USBDESCR_STRING —   ,   .<br>
,   ,       USBDESCR_DEVICE,  ,        .</p><br>
<h2 id="shag-15-zapolnyaem-anketnye-dannye"> 15.   </h2><br>
<p>      . -,     .      ,   - - , , HID,      ,        .     Vendor ID  Product ID,      USB,     .  ,  vusb            .</p><br>
<p>    , , - .    ,       ,    ,        (, )      usbMsgPtr,   —   len,     usbMsgLen.      (     )  18 ,       8. ,    ,  3 .       - ,  STALL.</p><br>
<p>          usbDeviceRead.   ,       memcpy_P,             ,  , .</p><br>
<p>  ,      ,  ,      .    ,      ,        .</p><br>
<p>      ,     ,  .</p><br>
<blockquote><strong> </strong><br>
 PID'  DATA0  DATA1       .  PID'     ,          ,  -       .</blockquote><p>      ,  DATA0 / DATA1    (        ),     , ,   3 ,    .     XOR    PID',   .      ,        ,   XOR'    .     PID  DATA1,   XOR    PID   ,   XOR  DATA0    .</p><br>
<p>     ,    ,     USBDESCR_CONFIG.</p><br>
<h2 id="shag-16-nakonec-to-ustroystvo"> 16. - !</h2><br>
<p>  USBDESCR_CONFIG      USBDESCR_DEVICE.     (   ,        )  .   , -     USB-,     ,   D+, D-.</p><br>
<p>       ,      : , ,   .    ,        (    ,    ).  ,      UTF-16,       .     USB     UTF-8  .</p><br>
<p>  vusb       ,     lsusb    .    VID, PID      ,        .         ,        VID, PID,     —      .</p><br>
<p>,         ,      (    ).       SETUP:   ,        ,     .   0,       ,    —      . ,     ,       ,  .<br>
       .</p><br>
<h2 id="shag-17-ustroystvo-stanovitsya-chelovechnee-hid"> 17.    (HID)</h2><br>
<blockquote><strong> </strong><br>
HID — human interface device,   ,       ,     .    HID   ,       .  ,      ,   , , ,       .    «»     .      HID     ( low-speed      800   ),        .</blockquote><p>    HID     ,     USBDESCR_HID_REPORT.          vusb,      . ,   usbDriverSetup ( )   usbFunctionSetup ( ).  ,      SETUP,         OUT.      ,         , ,   usbFunctionWrite.</p><br>
<p>    ,  usbDeviceRead  usbFunctionRead,           .   ,    ,   usbFunctionSetup  (  ,   )   USB_FLG_USE_USER_RW,   usbDriverSetup   .</p><br>
<p>   —      —    usbFunctionWrite  usbFunctionRead.          .   —      ,       .</p><br>
<p>      usbDriverSetup.</p><br>
<h2 id="shag-18-obschaemsya-s-zhelezkoy"> 18.   </h2><br>
<p> ,      ,        .     HID,    ,   ,      (        udev  - ).  ,        ,   .        ,   ,   ,     .<br>
UPD:   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link">ramzes2</a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">HIDAPI</a></p><br>
<p>          .</p><br>
<h2 id="shag-19-sravnivaem-s-vusb"> 19.   vusb</h2><br>
<p>    vusb              ,   .</p><br>
<p>drvasm.S   - usbdrvasm.S  asmcommon.inc,   -,   , usbdrvasm12.inc — usbdrvasm20.inc.</p><br>
<p>main.c    main.c ( )  usbdrv.c (  vusb)<br>
usbconfig.h      (     ),   ,  ,   usbconfig.h.</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>     vusb,            ,   ,    .  ,    ,      .&nbsp;. ,     ,     ,    USB-HID.   ,   ,  ,            vusb,     ,  , ,      .</p><br>
<h2 id="ispolzovannaya-literatura-i-poleznye-ssylki">    </h2><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.obdev.at/products/vusb/index.html（vusb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Webサイトの）</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://microsin.net/programming/arm-working-with-usb/usb-in-a-nutshell-part1。 html</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Agurov P.V. </font><font style="vertical-align: inherit;">USBインターフェース：</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//radiohlam.ru/tag/usb/ </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">http://we.easyelectronics.ru/electro-and-pc/usb-dlya-avr-chast-1-vvodnaya.html </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http： //usb.fober.net/cat/teoriya/</font></font></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSローカルテーブルエディターの特殊性（おそらく私はそれをよく理解していなかったため）のため、彼らは私が望んだよりもはるかに有益ではないように見えます</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460803/index.html">夏の読書：技術者向けの本</a></li>
<li><a href="../ja460805/index.html">マイクロコントローラー間で100 Mbpsでデータを転送する方法</a></li>
<li><a href="../ja460807/index.html">7回測定し、一度BIツールを実装する</a></li>
<li><a href="../ja460811/index.html">異なるチームによる共通のコンポーネント。Yandexレポート</a></li>
<li><a href="../ja460813/index.html">ボロノイ図を使用してAIを制御する方法</a></li>
<li><a href="../ja460819/index.html">WorldSkills：オリンピアードの参加者によるレビュー</a></li>
<li><a href="../ja460821/index.html">モバイル開発者向けの興味深い資料の要約＃307（7月15〜21日）</a></li>
<li><a href="../ja460823/index.html">7月22日から28日までのモスクワでのデジタルイベント</a></li>
<li><a href="../ja460825/index.html">Screen Capture APIの概要-ブラウザでQRコードをスキャンする</a></li>
<li><a href="../ja460827/index.html">PGPの問題</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>