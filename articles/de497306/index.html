<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👸🏿 🚌 🙏 DLL-Spoofing (DLL-Hijacking) 👩‍🎨 👼🏽 😼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen. Derzeit hat OTUS ein Set für den Start des aktualisierten Reverse Engineering- Kurses im April geöffnet . Im Vorfeld des Kursbegi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DLL-Spoofing (DLL-Hijacking)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/497306/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen. </font><font style="vertical-align: inherit;">Derzeit hat OTUS ein Set für den Start des aktualisierten </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reverse Engineering-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kurses im April geöffnet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Im Vorfeld des Kursbeginns haben wir traditionell eine Übersetzung von interessantem Material vorbereitet.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/hb/vt/zh/hbvtzhxt8n3pklbvenpcr72xxdq.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Windows-Betriebssystem suchen Anwendungen und Dienste beim Start nach den DLLs, die für deren ordnungsgemäße Funktion erforderlich sind. </font><font style="vertical-align: inherit;">Wenn diese DLLs nicht gefunden werden oder ihr Laden auf unsichere Weise implementiert wird (DLLs werden aufgerufen, ohne den vollständigen Pfad zu verwenden), können Sie die Berechtigungen erhöhen, indem Sie die Anwendung zwingen, eine schädliche DLL-Datei herunterzuladen und auszuführen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist zu beachten, dass die Suche in der folgenden Reihenfolge ausgeführt wird, wenn die Anwendung die DLL herunterladen muss:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Verzeichnis, aus dem die Anwendung heruntergeladen wird</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows \ System32</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows \ System</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C: \ Windows</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktuelles Arbeitsverzeichnis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verzeichnisse in der Umgebungsvariablen PATH des Benutzers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verzeichnisse in der Umgebungsvariablen PATH</font></font></li>
</ul><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schritt 1 - Prozesse mit fehlenden DLLs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Schritt besteht darin, Prozesse zu finden, die auf SYSTEM ausgeführt werden, und zu versuchen, die fehlende DLL zu laden. </font><font style="vertical-align: inherit;">Dies kann mithilfe von </font><font style="vertical-align: inherit;">Sysinternals </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Monitor erfolgen,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indem der unten </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8c/2l/i-/8c2li-1qfj3csw3bfytkej1bzri.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aufgeführte Filter angewendet wird</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><i><font style="vertical-align: inherit;">Procmon-Filter zur Suche nach Prozessen,</font></i><font style="vertical-align: inherit;"> die fehlende DLLs </font><i><font style="vertical-align: inherit;">herunterladen </font></i></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> identifiziert die fehlenden DLLs, die die Anwendung zu laden versucht, und zeigt den tatsächlichen Pfad an, nach dem diese DLL gesucht wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bk/gl/0_/bkgl0_q1eomsgzemfqprbkcfqfg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Prozess mit einer fehlenden DLL</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In diesem Beispiel verfügt ein Prozess </font></font><code>Bginfo.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht über mehrere DLL-Dateien, mit denen Berechtigungen erhöht werden können.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schritt 2 - Ordnerberechtigungen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Software </font></font><code>C:\</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stattdessen </font><font style="vertical-align: inherit;">im Verzeichnis installiert ist </font></font><code>C:\Program Files</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, haben authentifizierte Benutzer standardmäßig Schreibzugriff auf dieses Verzeichnis. </font><font style="vertical-align: inherit;">Außerdem wird der PATH-Variablen normalerweise Software wie Perl, Python, Ruby usw. hinzugefügt. </font><font style="vertical-align: inherit;">Dies ermöglicht es, die Berechtigungen zu erhöhen, da der Benutzer eine schädliche DLL in dieses Verzeichnis schreiben kann, die beim nächsten Start des Prozesses geladen wird und die Rechte für diesen Prozess erhält. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8x/am/4k/8xam4k5sv5rcxouitfhoerzqjni.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schwache Ordnerberechtigungen</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schritt 3 - DLL ersetzen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Metasploit können Sie eine Payload-DLL als Sitzung mit Dienstberechtigungen generieren. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s3/kk/ap/s3kkapxllhprqdd9mk8fveeywgi.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generierung bösartiger DLLs</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Der Prozess wird </font></font><code>Bginfo.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unter SYSTEM gestartet. Nach dem Neustart verfügt die böswillige DLL daher über dieselben Berechtigungen, da die DLL von diesem Prozess geladen und ausgeführt wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wq/w7/xz/wqw7xz-pd3l_8r8axlnbt_yitss.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Prozess wird unter SYSTEM gestartet.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wie oben angegeben, kann der Prozess nicht gefunden </font></font><code>Riched32.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werden. </font></font><code>pentestlab.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie müssen ihn </font><font style="vertical-align: inherit;">daher </font><font style="vertical-align: inherit;">in umbenennen </font></font><code>Riched32.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dies verwirrt die Anwendung und versucht, die DLL zu laden, da sie glaubt, dass es sich um eine legitime DLL handelt. Die schädliche DLL muss in einem der Ordner abgelegt werden, in denen Windows nach DLL-Dateien sucht. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/la/ms/snlamsjl0ixkfbzvibb8i3tpcsy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schädliche DLL umbenannt und gehostet</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie unten sehen können, wird beim Neustart des Dienstes mithilfe der Spoofing-DLL eine Meterpreter-Sitzung mit SYSTEM-Berechtigungen geöffnet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/j_/r9/baj_r9sstyxrajtkimosaxgvwgo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metasploit - Eskalation von Berechtigungen durch Spoofing von DLL</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Powersploit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ersetzen von DLLs kann über PowerSploit erfolgen. In drei Modulen können Sie Dienste mit fehlenden DLLs suchen, Ordner mit Änderungsrechten suchen und DLLs generieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Modul </font></font><code>Find-ProcessDLLHijack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findet alle Prozesse im System, die versuchen, die fehlende DLL zu laden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gy/hg/dv/gyhgdveyv97iumk-g5h7jgif6w8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerSploit - Erkennen von Prozessen mit fehlenden DLLs</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Der nächste Schritt besteht darin, die Ordner zu identifizieren, in denen der Benutzer den Inhalt ändern kann. </font><font style="vertical-align: inherit;">Es werden Ordner gefunden, in denen schädliche DLLs abgelegt werden sollen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/ui/3h/j7ui3hwcu2v-syisqovozbz9z4g.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchen von Ordnern mit Änderungsrechten</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Der letzte Schritt besteht darin, eine schädliche DLL in einem der </font><i><font style="vertical-align: inherit;">Ordner mit den Berechtigungen "Ändern"</font></i><font style="vertical-align: inherit;"> (M) zu erstellen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1a/il/s9/1ails9hsqecemlskuuuefzov8ak.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie eine DLL in einem Ordner mit schwachen Berechtigungen</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Berechtigungen durch eine Spoofing-DLL erhöhen zu können, müssen die folgenden Bedingungen erfüllt sein:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berechtigungen zum Schreiben in den Systemordner</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren der Software in einem anderen Verzeichnis als dem Standardverzeichnis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Dienst, der unter SYSTEM ausgeführt wird und versucht, eine fehlende DLL zu laden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neustart des Dienstes</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Auffinden von Anwendungen, in denen nicht installiert </font></font><code>Program Files</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist, ist nicht schwierig, da sich neben Anwendungen von Drittanbietern, die nicht auf diesem Pfad installiert werden müssen, verschiedene benutzerdefinierte Softwareprogramme außerhalb dieser geschützten Ordner befinden. </font><font style="vertical-align: inherit;">Darüber hinaus gibt es eine Reihe von Windows-Diensten wie IKEEXT (IKE- und AuthIP-IPSec-Schlüsselmodule) mit fehlenden DLLs ( </font></font><code>wlbsctrl.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), die entweder manuell oder automatisch verwendet werden können. </font><font style="vertical-align: inherit;">Es gibt ein spezielles Metasploit-Modul für IKEEXT:</font></font><br>
<br>
<pre><code class="plaintext hljs">exploit/windows/local/ikeext_service</code></pre><br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   .</a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de497290/index.html">Verbessern der Leistung mithilfe des UOP-Cache auf Sandy Bridge +</a></li>
<li><a href="../de497292/index.html">Technologie-Stapel-Shiro-Spiele</a></li>
<li><a href="../de497296/index.html">Beliebte Fehler in Englisch bei IT-Fachleuten. Teil 2: Aussprache</a></li>
<li><a href="../de497302/index.html">Autonome Navigation eines mobilen Roboters</a></li>
<li><a href="../de497304/index.html">Intercepter-NG 2.5 für Android veröffentlicht</a></li>
<li><a href="../de497308/index.html">Kann künstliche Intelligenz Kunst machen?</a></li>
<li><a href="../de497310/index.html">Bipolare morphologische Netzwerke: ein Neuron ohne Multiplikation</a></li>
<li><a href="../de497312/index.html">Frage zu CAN FD</a></li>
<li><a href="../de497314/index.html">Wie tief der Challenger Abyss ist: Tiefe messen</a></li>
<li><a href="../de497316/index.html">Eigener Server oder öffentliche Cloud?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>