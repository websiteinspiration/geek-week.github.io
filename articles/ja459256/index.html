<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈚️ 🚥 👩‍🎤 テーマ病院をさまざまなプラットフォームに最適化した方法 👌 🕵️ 🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Project Hospitalは、病院の建物の管理に関するゲームであり、UIシステムによって展開される、プレーヤーによって作成された動的なシーン、多くのアクティブなキャラクターやオブジェクトなど、ジャンルのすべての標準的な側面を備えています。さまざまな機器でゲームを機能させるには、多くの努力をしな...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>テーマ病院をさまざまなプラットフォームに最適化した方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459256/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d81/165/b28/d81165b28ad475a63a06e9d674be2bd7.png" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Project Hospitalは、病院の建物の管理に関するゲームであり、UIシステムによって展開される、プレーヤーによって作成された動的なシーン、多くのアクティブなキャラクターやオブジェクトなど、ジャンルのすべての標準的な側面を備えています。</font><font style="vertical-align: inherit;">さまざまな機器でゲームを機能させるには、多くの努力をしなければなりませんでした。これは、悪名高い「千カットからの死」の非常に具体的な例でした。非常に具体的な問題とプロファイリングに費やされた多くの時間を解決する多くの小さなステップです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスのレベル：達成したかったこと</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発の初期段階で、主要なパラメーターであるシーンの最大サイズ、パフォーマンスのレベル、システム要件を決定しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、1つの画面で少なくとも100のアクティブで完全にアニメーション化されたキャラクター、合計で300のアクティブキャラクター、タイルマップがおよそ100x100、建物の4フロアまでのサポートを提供するタスクを設定しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
統合されたグラフィックカードでも、ゲームは1080pで適切なフレームレートで動作するはずであり、この目標自体はそれほど難しくはありませんでした。主な制限要因はCPUであり、特に病院のボリュームが増加した場合です。最新の統合グラフィックスカードでは、約2560 x 1440の解像度でのみ問題が発生し始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
modのサポートを簡略化するために、ほとんどのデータがオープンになりました。つまり、ファイルをパッキングすることで達成されるパフォーマンスを犠牲にする必要がありましたが、ダウンロード時間がわずかに長いことを除いて、これは特に大きな影響はありませんでした。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラフィックアート</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Project Hospitalは「クラシック」なアイソメトリック2Dゲームなので、すべてが前面から背面にレンダリングされることを理解できます。Unityでは、これは、個々のグラフィックオブジェクトのZ軸（またはカメラまでの距離）に沿って適切な値を設定することによって行われます。</font><font style="vertical-align: inherit;">可能であれば、相互に作用しないオブジェクトはレイヤーに配置されます。たとえば、床はオブジェクトやキャラクターから独立しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/951/079/8a59510793f4c7eb1be7b2dd206c1c17.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイソメトリックレンダリングされたシーンのすべてのジオメトリはC＃で動的に作成されるため、グラフィックスパフォーマンスの2つの最も重要な側面の1つは、ジオメトリの再構築の頻度です。</font><font style="vertical-align: inherit;">2番目の側面は、描画呼び出しの数です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電話をかける</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単純さに関係なく、1つのフレームに描画される個々のオブジェクトの数は、特に貧弱な機器での主な制限です（さらに、Unityエンジン自体が過剰なリソース消費を追加します）。</font><font style="vertical-align: inherit;">明白な解決策は、できるだけ多くのグラフィックオブジェクトを1つの描画呼び出しにグループ化（バッチ）することです。</font><font style="vertical-align: inherit;">たとえば、カメラから同じ距離にあるオブジェクトをグループ化して、残りのグラフィックがオブジェクトの後ろまたは前に正しくレンダリングされるようにするなど、かなり興味深い結果を得ることができます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fde/96e/f3d/fde96ef3dd1e2f0f4b6972e8b947654b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下にいくつかの数値を示します。理論的には、9216オブジェクトを96 x 96タイルに配置できます。これには、9216ドローコールが必要になります。バッチ処理後、この数は192に減少します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、実際には、同じテクスチャのオブジェクトのみをグループ化できるため、結果の最適性がやや低くなるため、すべてが少し複雑になりますが、システムは非常にうまく機能します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/306/134/93d3061341005108c6638c2ad67f17bd.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのバッチは、結果を制御するために手動で行われます。</font><font style="vertical-align: inherit;">さらに、最後の手段として、Unityの動的バッチ処理も使用しますが、これは両刃の剣です。これは、実際には描画呼び出しの数を減らすのに役立ちますが、各フレームで不要なリソースにつながり、場合によっては予測できないことがあります。</font><font style="vertical-align: inherit;">たとえば、異なるフレームでカメラから同じ距離にある2つの重ね合わされたスプライトは、異なる順序でレンダリングされる可能性があり、これによりちらつきが発生し、手動でバッチ処理したときに表示されません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多階</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレイヤーは複数のフロアで建物を建てることができ、これにより複雑さが増しますが、驚くべきことにパフォーマンスが向上します。</font><font style="vertical-align: inherit;">アクティブなフロアとストリートのキャラクターのみをレンダリングしてアニメーション化する必要があり、病院の他のフロアのすべてを非表示にできます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェーダー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Project Hospitalは、カラースワップなどの小さなトリックを備えた比較的単純な自己記述型シェーダーを使用しています。</font><font style="vertical-align: inherit;">キャラクターシェーダーが最大5色（シェーダーコードの条件に応じて異なる）を置き換えることができるため、非常にコストがかかると仮定します。ただし、文字が画面領域の多くを占めることはほとんどないため、これによって問題が発生することはありません。</font><font style="vertical-align: inherit;">シェーダーはそれに投資した努力を正当化しました、なぜなら無限の数の衣服の色を使用する能力はキャラクターと環境の変動性を非常に増やすことができるからです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、シェーダーパラメーターの指定を回避するために十分迅速に学習し、可能な限り頂点カラーを使用しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テクスチャ品質</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深い事実-Project Hospitalでは、テクスチャ圧縮を使用していません。グラフィックはベクタースタイルで行われ、一部のテクスチャでは圧縮が非常に悪く見えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 GB未満のシステムでCPUメモリを節約するために、ゲーム内テクスチャのサイズを自動的に半分の解像度に減らします（ユーザーインターフェイステクスチャを除く）。これは、オプションの「テクスチャ品質：低」パラメータを確認することで理解できます。</font><font style="vertical-align: inherit;">UIテクスチャは元の解像度を保持します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPUパフォーマンスの最適化-マルチスレッド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unityスクリプトロジックは基本的にシングルスレッドですが、C＃で直接複数のスレッドを実行する機能は常にあります。おそらく、このアプローチはゲームロジックには適していないかもしれませんが、タスクシステムを編成することにより、別のスレッドで実行できるタイムクリティカルなタスクがしばしばあります。私たちの場合、ストリームは2つの機能に使用されました</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1.パスを見つけるタスク、特に混乱を招く配置の大きなマップでは、数百ミリ秒かかる場合があるため、これがメインストリームからの転送の主要な候補でした。並列タスクは、マシンのハードウェアスレッドの数を考慮に入れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.照明カードは、別のストリームで更新することもできますが、一度に1フロアのみです。これは重要なシステムではなく、部屋の自動ランプは、まれな更新で十分な速度で消灯します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アニメーション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんど開発の初期段階で、2次元の骨格アニメーションシステムを使用することにしました。さまざまな最新のアニメーションプログラムを検討した結果、数年前に作成したシンプルなシステム（基本的には趣味のプロジェクト）を変更し、Project Hospitalのニーズに合わせて調整することにしました。これは、キャラクターバリエーションの作成を直接サポートするシンプルなSpineに似ています。 Spineと同様に、C＃ランタイムを使用します。これは、ネイティブコードよりも明らかにコストがかかるため、開発プロセス中にいくつかの最適化サイクルを実行しました。幸い、私たちのリグは非常にシンプルで、キャラクターあたりのボーン数は約20です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
奇妙な事実：個々のボーンの変換へのアクセスを最適化する上で最も有用な改善は、マップ検索から配列の単純なインデックス付けへの移行であることが判明しました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/f1e/440/462f1e440f6dbc3f7e77f4ff42986966.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カメラの外でキャラクターがアニメーション化されないという事実に加えて、別のトリックがあります。メインUIのウィンドウの後ろに隠れているキャラクターもアニメーション化する必要はありません。</font><font style="vertical-align: inherit;">残念ながら、ゲームの最終バージョンでは半透明のUIに切り替えたため、使用できませんでした。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可能な限り、値に影響を与える変更のみを使用して、最もコストのかかる計算を実行しようとします。</font><font style="vertical-align: inherit;">これの最も良い例は部屋とエレベーターです。プレイヤーがエレベーターを設置するか壁を構築するとき、私たちはエレベーターと部屋が利用できるタイルをマークする塗りつぶしアルゴリズムを実行します。</font><font style="vertical-align: inherit;">これにより、その後のパスの検索が高速化され、どの部屋がまだ利用できないかをプレーヤーに示すために使用できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散更新と遅延更新</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合によっては、特定の更新を部分的にのみ実行することが論理的です。いくつかの例を次に示し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。たとえば、一部の更新はキャラクターの一部のみに対して各フレームで実行できます。たとえば、患者の半分の行動スクリプトは奇数フレームでのみ更新され、後半-偶数フレームで更新されます（アニメーションと動きはスムーズに実行されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の状況では、特にキャラクターがスタンバイモードであるが、コードの高価な部分を呼び出す場合（たとえば、従業員が記入する必要のあるものを確認し、空いている機器を探すなど）、操作は特定の間隔（たとえば1秒に1回）でのみ実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も費用がかかると同時に一般的な課題の1つは、各患者がどの検査を利用できるかを確認することです。</font><font style="vertical-align: inherit;">同時に、多くの要因を評価する必要があります。たとえば、現在、部署の担当者のうちどれが忙しいか、どの機器が予約されているかなどです。</font><font style="vertical-align: inherit;">さらに、この情報は、割り当てられた医師や話す能力などの影響を受けるため、すべての患者に共通するわけではありません。</font><font style="vertical-align: inherit;">利用可能な数十種類の分析をチェックする必要があるため、1つのフレームで更新は一部に対してのみ実行され、次のフレームで続行されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1a6/e24/0141a6e2458e7edb58a0d96072faab8e.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの相互作用部分を持つゲームマネージャーの最適化は、長いプロセスであることが証明されています。私は定期的にUnityプロファイラーを使用して最も明白な問題を修正する必要がありましたが、これは開発プロセスの不可欠な部分になりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、改善の余地は常にありますが、結果には非常に満足しています。ゲームは私たちのタスクに対応し、プレイヤーは常にそのためのmodを作成し、キャラクター数の元の制限を大幅に超えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、私が取り組んだいくつかのAAAゲームと比較した場合でも、Project Hospitalでは実際に最も複雑なゲームロジックに出会ったため、問題の多くはこのプロジェクトに固有のものでした。</font><font style="vertical-align: inherit;">それでも、ゲームの複雑さに応じて、最適化のために十分な時間をプロジェクトに残すことをお勧めします。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459246/index.html">サイトコンバージョンが減少しているのはなぜですか？60のデザインとユーザビリティエラーの例</a></li>
<li><a href="../ja459248/index.html">7月9日から7月14日までのモスクワでのデジタルイベント</a></li>
<li><a href="../ja459250/index.html">PostgreSQLのWAL：2.事前記録ログ</a></li>
<li><a href="../ja459252/index.html">セキュリティウィーク28：スマートホームのハッキング</a></li>
<li><a href="../ja459254/index.html">さらに良いジップボム</a></li>
<li><a href="../ja459258/index.html">フックしない14,000マイル</a></li>
<li><a href="../ja459262/index.html">22歳で引退</a></li>
<li><a href="../ja459264/index.html">Tarantoolネットワークから抜け出す。トラフィックをフィルタリングする際のノードの同期</a></li>
<li><a href="../ja459272/index.html">Reactコンポーネント用のAPIを作成する、パート1：競合する小道具を作成しない</a></li>
<li><a href="../ja459274/index.html">Astra Linux Special Edition（スモレンスク）の画面ロックの脆弱性</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>