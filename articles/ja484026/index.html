<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤗 🍟 👉 パート6：MemTest86 +からRISC-Vへの移植 🖕🏼 🙇🏼 👨🏽‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Memtest86 +が何であるかを説明する必要のあるITスペシャリストはほとんどいないでしょう-多分、それはPCでRAMをテストする際の標準になっています。前のパートの 1つで、ボードにバンドルされている壊れたメモリバーに遭遇したとき、それは（DDR2対応のネットブックと共に）明白な解決策のように...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>パート6：MemTest86 +からRISC-Vへの移植</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memtest86 +が何であるかを説明する必要のあるITスペシャリストはほとんどいないでしょう-多分、それはPCでRAMをテストする際の標準になっています。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前のパートの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1つで</font><font style="vertical-align: inherit;">、ボードにバンドルされている壊れたメモリバーに遭遇した</font><font style="vertical-align: inherit;">とき</font><font style="vertical-align: inherit;">、それは（DDR2対応のネットブックと共に）明白な解決策のように見えました。別の問題は、原則として、システムの不安定な動作が肉眼で見えるということです。よりトリッキーなケースでは、メモリセルを無限に「タップ」することに加えて、このツールはDDR動作のエラーが検出される可能性が高いいくつかの特別なデータパターンを使用すると聞きました。一般に、すばらしいことですが、その名前が86-「x86互換システムのみ」と言っているのは残念です。か否か？</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カットの下に、MemTest86 + v5.1をRISC-Vに移植しようとする私の試みと小計が表示されます。</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スポイラー：動く！</font></font></em></p><a name="habracut"></a><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項：結果として得られたプロジェクトは、特定のボード上の特定のRocketChipアセンブリについて、私が特に最小限にテストしたものです。</font><font style="vertical-align: inherit;">精度と安全性（特に他のシステム）は保証されません。</font><font style="vertical-align: inherit;">自己責任。</font><font style="vertical-align: inherit;">特に、現在予約されているメモリ領域は、RAMの範囲内にある場合は処理されません。</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに言ったように、少し前に、AliExpressでCyclone IVマザーボードを購入しましたが、そのメモリはバギーでした。幸いにも、このボードの重要な機能の1つは、通常のDDR2 SO-DIMMモジュールを使用することでした-私の古いネットブックと同じです。それにもかかわらず、いわば、メモリモジュール（および実際にはコントローラ）をテストするための自己ホスト型ソリューションを取得することは興味深いでしょう。死んだメモリの状態での私の間違いをデバッグする見込みは、どういうわけかまったく気に入らなかった。特に、迅速な解決策を望んでおらず、別のアセンブラでの完全な書き換えを無期限に延期する準備を精神的に準備していないため、Memtest86 +に関するWikipediaの記事を開いたところ、カードに「W：Written in：C and assembly」と表示されました。うーん、つまり、彼は「... 86」ですが、完全にアセンブラーで書かれていませんか？これは励みになります。関係を理解するだけです。</font></font></p><br>
<p>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">memtest.org</a>    5.01  GPL2.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>   GitHub.  ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">README.background</a>, </p><br>
<blockquote>The Anatomy &amp; Physiology of Memtest86-SMP</blockquote><p>    (      ASCII-art)    .       <em>Binary layout</em>,   <code>bootsect.o</code>, <code>setup.o</code>, <code>head.o</code>   <code>memtest_shared</code>.  ,          .   ,     C! , ...</p><br>
<p>    <code>Makefile</code>  <code>Makefile.arch</code>    ,    ,  .   , ,    RISC-V, ,  ,         .       32- ,   ,     64- ,        <code>riscv64-</code>.</p><br>
<p><em> :</em> ,       32-  64- .        ISA (Instruction Set Architecture)    <code>1.3 RISC-V ISA Overview</code> :</p><br>
<blockquote>The main advantage of explicitly separating base ISAs is that each base ISA can be optimized for its needs without requiring to support all the operations needed for other base ISAs. For example, RV64I can omit instructions and CSRs that are only needed to cope with the narrower registers in RV32I. The RV32I variants can use encoding space otherwise reserved for instructions only required by wider address-space variants.</blockquote><p>  ,     <code>riscv64-</code>      32-       —   .</p><br>
<p>         :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">The RISC-V Instruction Set Manual Volume I: Unprivileged ISA</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">The RISC-V Instruction Set Manual Volume II: Privileged Architecture</a></li>
<li>    - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">SiFive FU540-C000 Manual</a> —   ,    -,      </li>
</ul><br>
<h2 id="nastroyka-sborki"> </h2><br>
<p>  :   ,      ,   x86  RISC-V.     -        x86.</p><br>
<p>    :    : <code>bootsect.S</code>, <code>setup.S</code>  <code>head.S</code>.      ,           .   ,     « »,        .     ELF,      ,   ..  ,     PIC (Position Independent Code) —    :    freestanding (   , libc  ..),     .</p><br>
<p>,  Makefile'   ,  : <code>-march=i486</code>, <code>-m32</code>  .     -  , <del>    </del>.     RISC-V    :   <code>rv32</code>  <code>rv64</code> (,     embedded     <code>rv128</code>,      ),   ISA      ,  : <code>i</code> —    , <code>m</code> —    ,… ,    <code>rv64i</code>,       Memtest86    . ,      «»   ,         (    ,        - ).</p><br>
<p>   ABI.  ,  calling convention     <code>Volume I</code>   «RISC-V Assembly Programmer’s Handbook»,    - </p><br>
<pre><code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help<font></font>
riscv64-linux-gnu-gcc-9: error: unrecognized argument in option ‘-mabi=help’<font></font>
riscv64-linux-gnu-gcc-9: note: valid arguments to ‘-mabi=’ are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f<font></font>
riscv64-linux-gnu-gcc-9: fatal error: no input files<font></font>
compilation terminated.</code></pre><br>
<p>  ,  <code>lp64</code>. <em>  ,    ABI       ,   <code>lp64f</code>,  ARCH «»  <code>rv64imf</code>.  ,         floating point.</em></p><br>
<p>    - - -   —      <em>   ld</em>,      <code>head.S</code>,       <code>memtest_shared.arch.lds</code>.           (-,       Makefile'),     <code>DISCARD</code>  ,     ,       . <em>( :   ,   <code>.rela</code>  )</em>  ,  x86-     64k —  ,    -        RISC-V   .   ,    ,  shared object  PIC,      ,     .</p><br>
<p>…        <code>reloc.c</code> — , -,   - <code>ld-linux.so</code>     Global Offset Table  ..    calling conventions  x86. ,           .  -  RISC-V — -      PIC,    <code>reloc.c</code>.     ,   .  ,            C,    (       ,   )  - -,       ()  ( - ,  CPUID  ..). ,      <code>rdtsc</code>,         -         RISC-V.</p><br>
<p>    <code>arch/i386</code>,       PCI,    , -  memory-mapped   ..      <code>test_start</code>,     <code>setup.S</code>    C.  ,  ,         RISC-V ,    ( <code>setup.S</code>         SiFive),    <code>arch/riscv</code>,    - .</p><br>
<p>   ,         ,   <em></em>      « ». ,        ,           <em>( ,   )</em>.   ,    .</p><br>
<h2 id="zapusk-na-zheleze">  </h2><br>
<p>         «»  Raspberry Pi,     .   UART, JTAG    SD-.      RV64-   DDR2.     ,  «»,     SSH-,     3333  TCP   gdb  OpenOCD.      minicom,    UART,   — openocd,      JTAG.    —       ,      SD.</p><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">riscv64-unknown-elf-gdb \<font></font>
    -ex 'target remote 127.0.0.1:3333' \<font></font>
    -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \<font></font>
    -ex 'add-symbol-file /path/to/memtest_shared 0x80010000'<font></font>
    -ex 'set $pc=0x80010000'</code></pre><br>
<p> <code>-ex</code>  gdb  ,       :</p><br>
<ul>
<li>    OpenOCD</li>
<li>        </li>
<li>  gdb,         <em> </em> ,   ,      <em> </em>  (  ,     )<br>
<ul>
<li> :     ELF-,   «» </li>
</ul></li>
<li>,         </li>
</ul><br>
<p> ,     ,        ,      — .   ,   gdb    <code>p &amp;global_var</code>, , ,         (  — <code>0x0</code>),      <code>add-symbol-file</code>.  ,    ,       <code>0x80010000</code>       <code>x/x 0xADDR</code>. -,          -,  <em>  </em>       <em>  </em>.</p><br>
<h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah">    </h2><br>
<p>,    -  — .  .   ,        <code>switch_to_main_stack</code> — ,  -       ,   .</p><br>
<p>                  PIC:</p><br>
<p><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="一部のRISC-V疑似命令"></p><br>
<p> ,    ,        ,      ,   <code>add</code>   .         </p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vars</span> * <span class="hljs-title">const</span> <span class="hljs-title">v</span> = &amp;<span class="hljs-title">variables</span>;</span></code></pre><br>
<p>    RISC-V ELF psABI  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>   -   <code>reloc.c</code>.   ,   , ,    - .          <code>ElfW(Addr)</code>,   <code>Elf32_Addr</code>  <code>Elf64_Addr</code>.  , ,   ,       (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> — -  RISC-V       ,     ).</p><br>
<p>  <code>switch_to_main_stack</code>   (  -  , ).        .    :(</p><br>
<h2 id="opredelenie-oborudovaniya"> </h2><br>
<p>,             ,        memtest —         .    «   ».  ,  RISC-V ( ,     ) ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Device Tree Blob</a>,    DTS-  :</p><br>
<div class="spoiler"><b class="spoiler_title">zeowaa-1gb.dts</b><div class="spoiler_text"><pre><code class="plaintext hljs">/dts-v1/;<font></font>
<font></font>
/ {<font></font>
        #address-cells = ^_^ltgt^_^;<font></font>
        #size-cells = ^_^ltgt^_^;<font></font>
        compatible = "freechips,rocketchip-unknown-dev";<font></font>
        model = "freechips,rocketchip-unknown";<font></font>
        chosen {<font></font>
        bootargs = "console=ttySIF0,125200 debug loglevel=7";<font></font>
    };<font></font>
        firmware {<font></font>
        sifive,uboot = "YYYY-MM-DD";<font></font>
    };<font></font>
    L16: aliases {<font></font>
        serial0 = &amp;L8;<font></font>
    };<font></font>
        L15: cpus {<font></font>
                #address-cells = ^_^ltgt^_^;<font></font>
                #size-cells = ^_^lt�gt^_^;<font></font>
                timebase-frequency = ^_^lt󴉀gt^_^;<font></font>
                L5: cpu@0 {<font></font>
                        device_type = "cpu";<font></font>
                        clock-frequency = ^_^lt�gt^_^;<font></font>
                        compatible = "sifive,rocket0", "riscv";<font></font>
                        d-cache-block-size = ^_^ltgt^_^;<font></font>
                        d-cache-sets = ^_^lt@gt^_^;<font></font>
                        d-cache-size = ^_^ltကgt^_^;<font></font>
                        d-tlb-sets = ^_^ltgt^_^;<font></font>
                        d-tlb-size = ^_^lt gt^_^;<font></font>
                        i-cache-block-size = ^_^ltgt^_^;<font></font>
                        i-cache-sets = ^_^lt@gt^_^;<font></font>
                        i-cache-size = ^_^ltကgt^_^;<font></font>
                        i-tlb-sets = ^_^ltgt^_^;<font></font>
                        i-tlb-size = ^_^lt gt^_^;<font></font>
                        mmu-type = "riscv,sv39";<font></font>
                        next-level-cache = &lt;&amp;L10&gt;;<font></font>
                        reg = &lt;0x0&gt;;<font></font>
                        riscv,isa = "rv64imafdc";<font></font>
                        status = "okay";<font></font>
                        timebase-frequency = ^_^lt󴉀gt^_^;<font></font>
                        tlb-split;<font></font>
                        L3: interrupt-controller {<font></font>
                                #interrupt-cells = ^_^ltgt^_^;<font></font>
                                compatible = "riscv,cpu-intc";<font></font>
                                interrupt-controller;<font></font>
                        };<font></font>
                };<font></font>
        };<font></font>
        L10: ram@80000000 {<font></font>
                device_type = "memory";<font></font>
        reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;;<font></font>
        reg-names = "mem";<font></font>
    };<font></font>
        L14: soc {<font></font>
                #address-cells = ^_^ltgt^_^;<font></font>
                #size-cells = ^_^ltgt^_^;<font></font>
                compatible = "freechips,rocketchip-unknown-soc", "simple-bus";<font></font>
                ranges;<font></font>
                L1: clint@2000000 {<font></font>
                        compatible = "riscv,clint0";<font></font>
                        interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;;<font></font>
                        reg = &lt;0x2000000 0x10000&gt;;<font></font>
                        reg-names = "control";<font></font>
                };<font></font>
                L2: debug-controller@0 {<font></font>
                        compatible = "sifive,debug-013", "riscv,debug-013";<font></font>
                        interrupts-extended = &lt;&amp;L3 65535&gt;;<font></font>
                        reg = &lt;0x0 0x1000&gt;;<font></font>
                        reg-names = "control";<font></font>
                };<font></font>
                L9: gpio@64002000 {<font></font>
                        #gpio-cells = ^_^ltgt^_^;<font></font>
                        #interrupt-cells = ^_^ltgt^_^;<font></font>
                        compatible = "sifive,gpio0";<font></font>
                        gpio-controller;<font></font>
                        interrupt-controller;<font></font>
                        interrupt-parent = &lt;&amp;L0&gt;;<font></font>
                        interrupts = &lt;3 4 5 6 7 8&gt;;<font></font>
                        reg = &lt;0x64002000 0x1000&gt;;<font></font>
                        reg-names = "control";<font></font>
                };<font></font>
                L0: interrupt-controller@c000000 {<font></font>
                        #interrupt-cells = ^_^ltgt^_^;<font></font>
                        compatible = "riscv,plic0";<font></font>
                        interrupt-controller;<font></font>
                        interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;;<font></font>
                        reg = &lt;0xc000000 0x4000000&gt;;<font></font>
                        reg-names = "control";<font></font>
                        riscv,max-priority = ^_^ltgt^_^;<font></font>
                        riscv,ndev = ^_^ltgt^_^;<font></font>
                };<font></font>
                L6: rom@10000 {<font></font>
                        compatible = "sifive,maskrom0";<font></font>
                        reg = &lt;0x10000 0x2000&gt;;<font></font>
                        reg-names = "mem";<font></font>
                };<font></font>
                L8: serial@64000000 {<font></font>
                        compatible = "sifive,uart0";<font></font>
                        interrupt-parent = &lt;&amp;L0&gt;;<font></font>
                        clocks = &lt;&amp;tlclk&gt;;<font></font>
                        interrupts = ^_^ltgt^_^;<font></font>
                        reg = &lt;0x64000000 0x1000&gt;;<font></font>
                        reg-names = "control";<font></font>
                };<font></font>
                L7: spi@64001000 {<font></font>
                        #address-cells = ^_^ltgt^_^;<font></font>
                        #size-cells = ^_^lt�gt^_^;<font></font>
                        compatible = "sifive,spi0";<font></font>
                        interrupt-parent = &lt;&amp;L0&gt;;<font></font>
                        interrupts = ^_^ltgt^_^;<font></font>
                        reg = &lt;0x64001000 0x1000&gt;;<font></font>
                        clocks = &lt;&amp;tlclk&gt;;<font></font>
                        reg-names = "control";<font></font>
                        L12: mmc@0 {<font></font>
                                compatible = "mmc-spi-slot";<font></font>
                                disable-wp;<font></font>
                                reg = &lt;0x0&gt;;<font></font>
                                spi-max-frequency = ^_^lt�gt^_^;<font></font>
                                voltage-ranges = &lt;3300 3300&gt;;<font></font>
                        };<font></font>
                };<font></font>
                tlclk: tlclk {<font></font>
                        #clock-cells = ^_^lt�gt^_^;<font></font>
                        clock-frequency = ^_^lt�gt^_^;<font></font>
                        clock-output-names = "tlclk";<font></font>
                        compatible = "fixed-clock";<font></font>
                };<font></font>
        };<font></font>
};</code></pre></div></div><br>
<p>-    ELF-,    FDT (flat device tree)  :  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>  <em>  </em> <del>( ,      !)</del>     (  ,      )    .   :      -,  magic number <code>0xd00dfeed</code>    .      « » <code>off_dt_struct</code>    <code>off_dt_strings</code>. -,    <code>off_mem_rsvmap</code>,   ,     .     (    ),  <strong>   </strong>.</p><br>
<p> ,     :          . <em></em>  :</p><br>
<ul>
<li><code>FDT_BEGIN_NODE</code> —  extra data,    ,       - .     </li>
<li><code>FDT_END_NODE</code> —  ,    </li>
<li><code>FDT_PROP</code> —   :    ,    len  extra data.   «»    <code>nameoff</code>  string table<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
<span class="hljs-keyword">uint32_t</span> len;
<span class="hljs-keyword">uint32_t</span> nameoff;<font></font>
}</code></pre></li>
</ul><br>
<p>,  ,  :    ,      4 .  ,  :   FDT   big endian ,    </p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">uint32_t</span> <span class="hljs-title">be32</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> x)</span>
</span>{
    <span class="hljs-keyword">return</span> (x &lt;&lt; <span class="hljs-number">24</span>) | (x &gt;&gt; <span class="hljs-number">24</span>) | ((x &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">8</span>) | ((x &amp; <span class="hljs-number">0xff00</span>) &lt;&lt; <span class="hljs-number">8</span>);<font></font>
}</code></pre><br>
<p>   <code>riscv_entry</code>     FDT,   <code>head.S</code>,      <code>riscv_entry</code>,   </p><br>
<pre><code class="plaintext hljs">    .globl startup_32<font></font>
#  --    ...<font></font>
startup_32:<font></font>
    lla sp, boot_stack_top<font></font>
<font></font>
    mv s0, a0 # s0, s1 -- callee-saved<font></font>
    mv s1, a1<font></font>
<font></font>
# ...  .bss<font></font>
<font></font>
#  <font></font>
    jal _dl_start<font></font>
#     <font></font>
    mv a0, s0<font></font>
    mv a1, s1<font></font>
    j riscv_entry</code></pre><br>
<p>  <code>a0</code>   hart id (hart —  -      RISC-V) —     ,      .  <code>a1</code>     FDT.     <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code>.</p><br>
<p>,    FDT   ,     :</p><br>
<ul>
<li> </li>
<li>  U-Boot</li>
<li>   ,    FDT.  ,   <code>/chosen/bootargs</code>    .  ,     FDT —  RAM,  UART,… —    ,  <br>
<pre><code class="plaintext hljs">run fdtsetup<font></font>
fdt set /chosen bootargs "console=ttyS0 btrace"</code></pre></li>
<li>   <code>fdt addr</code>    FDT,    </li>
</ul><br>
<p>   gdb  </p><br>
<ul>
<li><code>-ex 'set $a1=0xfdtaddr'</code></li>
</ul><br>
<h2 id="vyvod-informacii-na-ekran">   </h2><br>
<p> ,         .  <code>SCREEN_ADR</code> ( ,   <code>D</code>),    ,  ,    .     ,      ,    ,  <code>#if HAS_SCREEN</code>,     .      -       ,    ,        escape-    . ,     ,      —   ,   (, -)   minicom'! (   HAS_SCREEN    —     <code>dummy_con</code>,      .)</p><br>
<h2 id="otladka-na-qemu">  QEMU</h2><br>
<p>       ,     —   .      JTAG — !  ,        ,         QEMU.      - ,       :</p><br>
<pre><code class="plaintext hljs">$ qemu-system-riscv64 -M help<font></font>
Supported machines are:<font></font>
none                 empty machine<font></font>
sifive_e             RISC-V Board compatible with SiFive E SDK<font></font>
sifive_u             RISC-V Board compatible with SiFive U SDK<font></font>
spike_v1.10          RISC-V Spike Board (Privileged ISA v1.10) (default)<font></font>
spike_v1.9.1         RISC-V Spike Board (Privileged ISA v1.9.1)<font></font>
virt                 RISC-V VirtIO Board (Privileged ISA v1.10)</code></pre><br>
<p>,     QEMU.   <code>sifive_u</code>- .</p><br>
<pre><code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace  <font></font>
$ ls -l on<font></font>
-rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on<font></font>
$ dtc -I dtb &lt; on &gt; on.dts #  <font></font>
$ vim on.dts #  bootargs<font></font>
$ dtc &lt; on.dts &gt; on.dtb<font></font>
&lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference<font></font>
&lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code></pre><br>
<p>    «» device tree blob. <strong>   </strong> (!), :</p><br>
<pre><code class="plaintext hljs">qemu-system-riscv64 \<font></font>
    -M sifive_u -m 1g \<font></font>
    -serial stdio \<font></font>
    -s -S</code></pre><br>
<p><code>-serial stdio</code>     ,     escape-.  <code>-s -S</code>  gdbserver   VM  , .         <code>loader</code>,     QEMU  .</p><br>
<p>   </p><br>
<pre><code class="plaintext hljs">riscv64-unknown-elf-gdb \<font></font>
    -ex 'target remote 127.0.0.1:1234' \<font></font>
    -ex 'restore /path/to/on.dtb binary 0x80100000' \<font></font>
    -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \<font></font>
    -ex 'add-symbol-file memtest_shared 0x80100000' \<font></font>
    -ex 'set $a1=0x80020000' \<font></font>
    -ex 'set $pc=0x80100000'</code></pre><br>
<p>    ,  !</p><br>
<h2 id="obschiy-princip-raboty">  </h2><br>
<p>, ,  ,   Memtest86+   <code>btrace</code>,        ,      (  ,     QEMU):</p><br>
<p><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="btraceモード"></p><br>
<p> ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  «»   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   — <code>mepc</code> (?),   — <code>mtval</code> (    ?),    .</p><br>
<p><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="違法な指示"></p><br>
<p>  ,      :</p><br>
<p><strong>head.S:</strong></p><br>
<pre><code class="plaintext hljs">#      <font></font>
#   = 0 ---   ,  <font></font>
#  ,    ,     ...<font></font>
    lla t1, _trap_entry<font></font>
    csrw mtvec, t1<font></font>
# ...<font></font>
_trap_entry:<font></font>
    csrr a0, mcause<font></font>
    csrr a1, mepc<font></font>
    csrr a2, mtval<font></font>
    jal riscv_trap_entry</code></pre><br>
<p> ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code>:</p><br>
<p><strong>arch.c:</strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *errors[] = {
    <span class="hljs-string">"Instruction address misaligned"</span>,
    <span class="hljs-string">"Instruction access fault"</span>,
    <span class="hljs-string">"Illegal instruction"</span>,
    <span class="hljs-string">"Breakpoint"</span>,
    <span class="hljs-string">"Load address misaligned"</span>,
    <span class="hljs-string">"Load access fault"</span>,
    <span class="hljs-string">"Store/AMO address misaligned"</span>,
    <span class="hljs-string">"Store/AMO access fault"</span>,<font></font>
    ^_^quotquot^_^, ^_^quot	quot^_^, ^_^quot<font></font>
quot^_^, ^_^quotquot^_^,<font></font>
    <span class="hljs-string">"Instruction page fault"</span>,
    <span class="hljs-string">"Load page fault"</span>,<font></font>
    ^_^quotquot^_^,<font></font>
    <span class="hljs-string">"Store/AMO page fault"</span>,<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">riscv_trap_entry</span><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span>
</span>{
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">32</span>];<font></font>
<font></font>
    cprint(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"EXCP:                                  "</span>);
    <span class="hljs-keyword">if</span> (cause &lt; <span class="hljs-keyword">sizeof</span>(errors) / <span class="hljs-keyword">sizeof</span>(errors[<span class="hljs-number">0</span>])) {<font></font>
        cprint(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>, errors[cause]);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        itoa(buf, cause);<font></font>
        cprint(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>, buf);<font></font>
    }<font></font>
<font></font>
    cprint(<span class="hljs-number">13</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"PC:                                    "</span>);<font></font>
    hprint3(<span class="hljs-number">13</span>, <span class="hljs-number">8</span>, epc, <span class="hljs-number">8</span>);<font></font>
<font></font>
    cprint(<span class="hljs-number">14</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Addr:                                  "</span>);<font></font>
    hprint3(<span class="hljs-number">14</span>, <span class="hljs-number">8</span>, tval, <span class="hljs-number">8</span>);<font></font>
<font></font>
    HALT();<font></font>
}</code></pre><br>
<p>       —    « »   .   ,   «»    ,  ,      ,  .</p><br>
<p>        :     .       ,  memtest  :    : «       ,   ,    .        ».    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       —    «» ,    memtest.       ,    <code>run_at</code>,    memtest  <code>_start</code>  <code>_end</code>    (   «»  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      «»    ,    «».</p><br>
<p>     ,    <strong> </strong>  <code>bss</code>    —    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code>.</p><br>
<p>  ,  Memtest86+ — ,         <code>barrier_s</code>    .       ,          . ,   ,       .</p><br>
<h2 id="podvodnye-kamni"> </h2><br>
<p>   ,   :   .   :           .    <em></em>: ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,   load/store  x86   ,     — .    ,    QEMU    ,  «  ,      ».</p><br>
<p>,     ,  <em>  </em> —   unaligned access  ..</p><br>
<p>,   ,     RocketChip,   — QEMU,   ,  ,   RocketChip — unaligned access trap,  QEMU  «  ».<br>
  «misaligned»            ,  </p><br>
<blockquote>Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated.</blockquote><p> , ,  —   ,  user-mode code   ,             .     .   , ,   .   ,       — -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped .</p><br>
<p>   :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    … ,     —   : <code>head.S</code>       <code>initial_load_addr</code>,    <code>riscv_entry</code>    <code>move_to_correct_addr</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">move_to_correct_addr</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">uintptr_t</span> cur_start = (<span class="hljs-keyword">uintptr_t</span>)&amp;_start;
    <span class="hljs-keyword">uintptr_t</span> cur_end   = (<span class="hljs-keyword">uintptr_t</span>)&amp;_end;
    <span class="hljs-keyword">if</span> (cur_start == low_test_addr || cur_start == high_test_adr) {
        <span class="hljs-comment">//  ,    </span>
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (cur_start == initial_load_addr &amp;&amp;<font></font>
        (cur_start - low_test_addr) &lt; (cur_end - cur_start)<font></font>
    ) {<font></font>
        <span class="hljs-comment">//   " ":   ,</span>
        <span class="hljs-comment">//          </span>
        <span class="hljs-comment">//     ,    ,  </span>
        <span class="hljs-comment">//     ...</span>
        serial_echo_print(<span class="hljs-string">"FIRST STARTUP RELOCATION...\n"</span>);
        <span class="hljs-keyword">void</span> *temp_addr = (((<span class="hljs-keyword">uintptr_t</span>)&amp;_end &gt;&gt; <span class="hljs-number">12</span>) + <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">12</span>;<font></font>
        run_at(temp_addr, <span class="hljs-number">0</span>);<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// ,    --- ,  .</span>
        serial_echo_print(<span class="hljs-string">"FINAL STARTUP RELOCATION...\n"</span>);<font></font>
        run_at(low_test_addr, <span class="hljs-number">0</span>);<font></font>
    }<font></font>
}</code></pre><br>
<p>,     —   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code>.</p><br>
<p>    ,   «» ,    -,   —  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code>),   32- x86   <code>uint32_t</code>,    « 64 »   <code>uint64_t</code>.       «!!! Good: ffffffff Real: ffffffff Bad bits: 00000000».   ?       - -1,  32    1.   ,         ,        0…  ,     : ,  <code>ulong</code>      (<code>uint32_t</code>),          (<code>uintptr_t</code>). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    —    UB. <del>    memtest  UBSan.</del>  ,  ,  UBSan   trap-on-error        JTAG.</p><br>
<h2 id="upakovyvaem-dlya-zagruzchika">  </h2><br>
<p>,  memtest -  ,    ,          U-Boot.</p><br>
<p>      :    <code>mkimage</code>   U-Boot   <em>  Linux</em>:</p><br>
<pre><code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \<font></font>
    -a 0x80000000 -e 0x80000000 \<font></font>
    -n memtest -d memtest.bin memtest.uboot</code></pre><br>
<p>     SD-     </p><br>
<pre><code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code></pre><br>
<p>(   ,   <code>run</code>     —        ).</p><br>
<p>     :       FDT: <code>0xbffb7c80</code>. ,  :    <code>ffffffff</code>,     .     ,         (     ),    :   HiFive_U-Boot      :</p><br>
<pre><code class="cpp hljs">    theKernel(machid, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)images-&gt;ft_addr);</code></pre><br>
<p>   ,    </p><br>
<pre><code class="cpp hljs">    <span class="hljs-keyword">void</span>    (*theKernel)(<span class="hljs-keyword">int</span> arch, uint params);</code></pre><br>
<p> ,     , ,  ,  32        ,     <code>head.S</code> :</p><br>
<pre><code class="plaintext hljs">    li t0, 0xffffffffL<font></font>
    and a1, a1, t0</code></pre><br>
<h2 id="promezhutochnyy-itog"> </h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり、ロードされ、何かをテストしていますが、これはファイナルというよりはスタートの段階であることは明らかです。</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリx86を修正する必要があります。</font><font style="vertical-align: inherit;">これまでのところ、これは注文のためのものです-とにかく、私は実際のハードウェアでの徹底的なレビューとテストなしにそれを起動することはあえてせず、私は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたに助言しません</font></font></strong></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-VコードにSMPサポートを追加する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まだ残っ</font></font><code>arch/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">いる</font><font style="vertical-align: inherit;">プラットフォーム依存のコードを</font><font style="vertical-align: inherit;">より徹底的に削除し</font><font style="vertical-align: inherit;">ます</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>test.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-Vの下</font><font style="vertical-align: inherit;">からアセンブラーインサートを再実装</font><font style="vertical-align: inherit;">します（オプションで明示的にアセンブルされます</font></font><code>-O0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！）</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484010/index.html">Microsoft Exchange Onlineでの商業情報？それはあなたの権利によるものですか？そうであれば、何によるものですか？</a></li>
<li><a href="../ja484012/index.html">ブロックノートブックの書き込みプロセスを合理化する</a></li>
<li><a href="../ja484016/index.html">デバッグオートエンコーダーの例に関するディープラーニングの基礎、パート1</a></li>
<li><a href="../ja484018/index.html">ヨットのIT技術面</a></li>
<li><a href="../ja484020/index.html">締め切りを印象づけようとしているのは誰ですか？</a></li>
<li><a href="../ja484028/index.html">ホースシューベンド-折りたたみ式ディスプレイを備えたコンバーチブルタブレット</a></li>
<li><a href="../ja484030/index.html">Typescriptのランタイムタイプセーフティ（ランタイムでの便利なタイプチェックが可能）</a></li>
<li><a href="../ja484034/index.html">倉庫会計ユニット「1C Integrated Automation 2」に基づく商品の住所保管の作業スキームの実装</a></li>
<li><a href="../ja484036/index.html">新しい業界グループがスマートホームのユニバーサルスタンダードを作成</a></li>
<li><a href="../ja484048/index.html">PHPと正規表現：初心者のための基本</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>