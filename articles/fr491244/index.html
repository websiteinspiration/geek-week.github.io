<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🏫 🐃 ☝️ Ableton n'est pas nécessaire: connectez Ableton Push 2 au rack VCV 🎭 🙀 🙍🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La création de musique, ces derniers temps, ressemble beaucoup à une photographie il y a 10 ans: chacun a son propre compte DSLR et instagram. L'indus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ableton n'est pas nécessaire: connectez Ableton Push 2 au rack VCV</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491244/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/vm/8j/qkvm8jnnid3kb_8kybxztptlbfu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La création de musique, ces derniers temps, ressemble beaucoup à une photographie il y a 10 ans: chacun a son propre compte DSLR et instagram. L'industrie de la musique en est très heureuse, car un tel intérêt rapporte beaucoup d'argent. Chaque jour, de nouveaux plugins VST et appareils analogiques apparaissent, le nombre de cours thématiques augmente rapidement, les blogs dédiés à la production musicale remontent sur le top youtube. Dans ce contexte, les projets open source semblent très intéressants, permettant à quiconque veut s'essayer en tant que producteur sans dépenser une tonne d'argent à ce sujet. L'un de ces projets est VCV Rack, qui vise à rendre la classe d'instruments de musique la plus chère - les synthétiseurs modulaires analogiques - accessible à tous. Récemment, quand j'ai eu l'idée d'un morceau,et à portée de main il n'y avait qu'un ordinateur portable Linux, je voulais faire toute la piste en VCV. Et en cours de route, il y avait un désir de contrôler les synthétiseurs à l'aide du contrôleur midi de manière à ce que l'utilisation des modules disponibles ne fonctionne pas. Au final, j'ai décidé d'écrire un plugin pour connecter Ableton Push 2 au VCV Rack. Nous parlerons de ce qui en est résulté et comment écrire nos propres modules pour VCV dans cet article.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Référence rapide</font></font></b><div class="spoiler_text">VCV Rack — open source ,   .  VCV  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  </a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
Ableton Push 2 —    midi-  Ableton,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> DAW</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">API    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0CdMvkBOUgs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API VCV Rack</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque module dans VCV se compose de deux parties - audio et graphique. </font><font style="vertical-align: inherit;">La partie audio hérite de la classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la méthode de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , appelée pour chaque échantillon, c'est-à-dire avec une fréquence d'échantillonnage. </font><font style="vertical-align: inherit;">Soit dit en passant, la fréquence d'échantillonnage dans VCV peut varier de 44,1 kHz standard à 768 kHz, ce qui permet d'émuler plus précisément des synthétiseurs modulaires en présence d'une puissance de calcul suffisante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les objets de type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ModuleWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont responsables des graphiques </font><font style="vertical-align: inherit;">, qui héritent de la méthode de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dessin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la structure de base </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">VCV utilise la bibliothèque de graphiques vectoriels nanovg. </font><font style="vertical-align: inherit;">Dessin à l'intérieur de la méthode de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dessin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il peut se produire à la fois à l'intérieur des limites du module (l'excès est coupé par le moteur), et par exemple dans le framebuffer, que nous utilisons toujours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, que faut-il pour écrire votre module pour VCV?</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de l'environnement et installation du SDK en rack</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première étape est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bien décrite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la documentation et ne pose pas de difficultés (au moins sous linux), donc nous ne nous attarderons pas dessus.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Générer un modèle de plugin</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe un script helper.py pour cela dans le SDK de rack. </font><font style="vertical-align: inherit;">Il doit dire createplugin, puis spécifier le nom du plugin et, éventuellement, des informations à son sujet.</font></font><br>
<br>
<pre><code class="bash hljs">&lt;Rack SDK folder&gt;/helper.py createplugin MyPlugin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le modèle de plugin est créé, il peut être compilé et installé avec la commande</font></font><br>
<br>
<pre><code class="bash hljs">RACK_DIR=&lt;Rack SDK folder&gt; make install</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dessinez le frontend du module</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque plugin peut contenir plusieurs modules, et pour chacun des modules, vous devez dessiner un panneau principal. Pour cela, la documentation VCV nous propose d'utiliser Inkscape ou tout autre éditeur vectoriel. Étant donné que les modules en VCV sont montés sur un support Eurorack virtuel, leur hauteur est toujours de 128,5 mm et la largeur doit être un multiple de 5,08 mm. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les éléments d'interface de base, tels que les prises CV / Gate, les boutons et les ampoules peuvent être marqués sous forme vectorielle. Pour ce faire, dessinez à leur place des cercles des couleurs correspondantes ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus de détails ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), afin que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py génère</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ensuite du </font><font style="vertical-align: inherit;">code pour ce balisage. Personnellement, il me semble que ce n'est pas une fonctionnalité très pratique et qu'il est plus facile de placer des éléments directement à partir du code. Lorsque l'image et la mise en page sont prêtes, vous devez réexécuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour créer un modèle de module et l'associer au panneau avant.</font></font><br>
<br>
<pre><code class="bash hljs">helper.py createmodule MyModule res/MyModule.svg src/MyModule.cpp</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous connectons les boutons et les torsions</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/oz/wq/z_/ozwqz_ss4sqqdci_q7dxbarbfve.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En dehors de l'écran, Ableton Push 2 est considéré par l'ordinateur comme un périphérique USB-MIDI standard, ce qui facilite l'établissement d'une connexion entre celui-ci et VCV Rack. </font><font style="vertical-align: inherit;">Pour ce faire, créez une file d'attente midi d'entrée et un port midi de sortie dans la classe du module.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code d'initialisation</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AbletonPush2</span> :</span> Module {<font></font>
    midi::Output midiOutput;<font></font>
    midi::InputQueue midiInput;<font></font>
<font></font>
    <span class="hljs-keyword">bool</span> inputConnected;
    <span class="hljs-keyword">bool</span> outputConnected;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons de trouver Ableton Push parmi les appareils midi connectés et connectons-nous. </font><font style="vertical-align: inherit;">Étant donné que le module est conçu pour fonctionner exclusivement avec Ableton Push, nous n'avons pas besoin de charger l'utilisateur d'un choix d'appareil et vous pouvez simplement le trouver par son nom.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de connexion du contrôleur</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">connectPush</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> in_devs = midiInput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; in_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiInput.getDeviceName(in_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiInput.setDeviceId(in_devs[i]);<font></font>
            inputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
		<font></font>
    <span class="hljs-keyword">auto</span> out_devs = midiOutput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; out_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiOutput.getDeviceName(out_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiOutput.setDeviceId(out_devs[i]);<font></font>
            outputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, dans la méthode de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">vous pouvez vérifier périodiquement si le contrôleur est connecté et demander à la file d'attente midi si des messages sont arrivés. </font><font style="vertical-align: inherit;">Ici, il convient de mentionner quoi et comment est généralement codé dans le standard midi. </font><font style="vertical-align: inherit;">En fait, il existe deux principaux types de messages, ceux-ci sont Note ON / OFF, transmettant le numéro de note et appuyant sur la force, et CC - Command Control, transmettant la valeur numérique d'un paramètre variable. </font><font style="vertical-align: inherit;">Vous trouverez plus d'informations sur midi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code d'interrogation de file d'attente MIDI</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ProcessArgs &amp;args)</span> <span class="hljs-keyword">override</span> </span>{
    <span class="hljs-keyword">if</span> (sampleCounter &gt; args.sampleRate / updateFrequency) {<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((!inputConnected) &amp;&amp; (!outputConnected)) {<font></font>
            connectPush();<font></font>
        }<font></font>
<font></font>
	midi::Message msg;<font></font>
	<span class="hljs-keyword">while</span> (midiInput.shift(&amp;msg)) {<font></font>
	    processMidi(msg);<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je veux apprendre aux pads de contrôleur à briller de différentes couleurs, afin qu'il soit plus pratique de les parcourir. Pour ce faire, nous devrons lui envoyer la commande midi appropriée. Considérez, par exemple, le pad numéro 36 (c'est le pad le plus bas à gauche). Si vous cliquez dessus, le contrôleur enverra la commande 0x90 (note activée), suivie du numéro de note (36) et d'un nombre de 0 à 127, ce qui signifie la force de la presse. Et lorsque, au contraire, l'ordinateur envoie la même commande 0x90 et le même numéro de note 36 au contrôleur, alors le troisième chiffre indiquera la couleur avec laquelle le pavé inférieur gauche doit briller. Les numéros des boutons et des pads sont indiqués dans la figure ci-dessus. Push a plusieurs possibilités pour travailler avec la couleur, les palettes, l'animation et d'autres paramètres de rétro-éclairage. Je ne suis pas entré dans les détails et j'ai simplement apporté toutes les couleurs possibles de la palette par défaut aux pads et j'ai choisi celles que j'aimais.Mais dans le cas général, la conversion des commandes midi en valeurs PWM sur les LED, selon la documentation, ressemble à ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/at/zq/8oatzqvwy_gwqvgu4cmjgjpbknm.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de contrôle du rétroéclairage</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note, <span class="hljs-keyword">int</span> color)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(color);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x9</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOff</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(<span class="hljs-number">0</span>);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x8</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous connectons l'écran</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/os/yl/kv/osylkvou5ba8_aoa3rwhst94uiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour connecter l'écran, vous devez travailler avec USB. </font><font style="vertical-align: inherit;">Le contrôleur lui-même ne sait rien dessiner et ne sait rien des graphiques. </font><font style="vertical-align: inherit;">Tout ce qu'il veut, c'est envoyer un cadre de 160x960 pixels au moins toutes les 2 secondes. </font><font style="vertical-align: inherit;">Tout le rendu a lieu sur le côté de l'ordinateur. </font><font style="vertical-align: inherit;">Pour démarrer, connectez et ouvrez le périphérique USB, comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décrit dans la documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code de connexion</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _MSC_VER</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span><font></font>
<font></font>
<span class="hljs-comment">// see following link for a discussion of the</span>
<span class="hljs-comment">// warning suppression:</span>
<span class="hljs-comment">// http://sourceforge.net/mailarchive/forum.php?</span>
<span class="hljs-comment">// thread_name=50F6011C.2020000%40akeo.ie&amp;forum_name=libusbx-devel</span><font></font>
<font></font>
<span class="hljs-comment">// Disable: warning C4200: nonstandard extension used:</span>
<span class="hljs-comment">// zero-sized array in struct/union</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(disable:4200)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __linux__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libusb-1.0/libusb.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"libusb.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ABLETON_VENDOR_ID 0x2982</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_PRODUCT_ID  0x1967</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> libusb_device_handle* <span class="hljs-title">open_push2_device</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> result;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> ((result = libusb_init(<span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%d] could not initilialize usblib\n"</span>, result);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_set_debug(<span class="hljs-literal">NULL</span>, LIBUSB_LOG_LEVEL_ERROR);<font></font>
<font></font>
  libusb_device** devices;<font></font>
  <span class="hljs-keyword">ssize_t</span> count;<font></font>
  count = libusb_get_device_list(<span class="hljs-literal">NULL</span>, &amp;devices);
  <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%ld] could not get usb device list\n"</span>, count);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_device* device;<font></font>
  libusb_device_handle* device_handle = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
  <span class="hljs-keyword">char</span> ErrorMsg[<span class="hljs-number">128</span>];<font></font>
<font></font>
  <span class="hljs-comment">// set message in case we get to the end of the list w/o finding a device</span>
  <span class="hljs-built_in">sprintf</span>(ErrorMsg, <span class="hljs-string">"error: Ableton Push 2 device not found\n"</span>);<font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; (device = devices[i]) != <span class="hljs-literal">NULL</span>; i++)<font></font>
  {<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">libusb_device_descriptor</span> <span class="hljs-title">descriptor</span>;</span>
    <span class="hljs-keyword">if</span> ((result = libusb_get_device_descriptor(device, &amp;descriptor)) &lt; <span class="hljs-number">0</span>)<font></font>
    {<font></font>
      <span class="hljs-built_in">sprintf</span>(ErrorMsg,
        <span class="hljs-string">"error: [%d] could not get usb device descriptor\n"</span>, result);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (descriptor.bDeviceClass == LIBUSB_CLASS_PER_INTERFACE<font></font>
      &amp;&amp; descriptor.idVendor == ABLETON_VENDOR_ID<font></font>
      &amp;&amp; descriptor.idProduct == PUSH2_PRODUCT_ID)<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ((result = libusb_open(device, &amp;device_handle)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not open Ableton Push 2 device\n"</span>, result);<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((result = libusb_claim_interface(device_handle, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not claim interface 0 of Push 2 device\n"</span>, result);<font></font>
        libusb_close(device_handle);<font></font>
        device_handle = <span class="hljs-literal">NULL</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// successfully opened</span><font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (device_handle == <span class="hljs-literal">NULL</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(ErrorMsg);<font></font>
  }<font></font>
<font></font>
  libusb_free_device_list(devices, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> device_handle;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close_push2_device</span><span class="hljs-params">(libusb_device_handle* device_handle)</span>
</span>{<font></font>
  libusb_release_interface(device_handle, <span class="hljs-number">0</span>);<font></font>
  libusb_close(device_handle);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour transmettre une trame, vous devez d'abord envoyer un en-tête de 16 octets, puis 160 lignes de 960 nombres de 16 bits chacune. </font><font style="vertical-align: inherit;">Dans le même temps, selon la documentation, les chaînes ne devraient pas être transmises en 1920 octets, mais en paquets de 2048 octets, complétés par des zéros.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de transfert de trame</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Push2Display</span> :</span> FramebufferWidget {<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frame_header[<span class="hljs-number">16</span>] = {
          <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x88</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> <font></font>
    };<font></font>
<font></font>
    libusb_device_handle* device_handle;<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* image;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendDisplay</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * image)</span> </span>{
        <span class="hljs-keyword">int</span> actual_length;<font></font>
     <font></font>
        libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, frame_header, <span class="hljs-keyword">sizeof</span>(frame_header), &amp;actual_length, TRANSFER_TIMEOUT);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">160</span>; i++)<font></font>
            libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, &amp;image[(<span class="hljs-number">159</span> - i)*<span class="hljs-number">1920</span>], <span class="hljs-number">2048</span>, &amp;actual_length, TRANSFER_TIMEOUT);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, il ne reste plus qu'à dessiner et écrire une image dans le tampon. </font><font style="vertical-align: inherit;">Pour ce faire, utilisez la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramebufferWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classe </font><font style="vertical-align: inherit;">qui implémente la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drawFramebuffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> méthode </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">VCV Rack </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prêt à</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">emploi</font></a><font style="vertical-align: inherit;"> utilise la bibliothèque </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">nanovg</font></a><font style="vertical-align: inherit;"> , il est donc assez facile d'écrire des graphiques ici. </font><font style="vertical-align: inherit;">Nous apprenons le contexte graphique actuel à partir de la variable globale APP et enregistrons son état. </font><font style="vertical-align: inherit;">Ensuite, créez un cadre vide de 160 x 960 et dessinez-le avec la méthode de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dessin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Après cela, copiez le framebuffer dans le tableau qui sera envoyé via USB et retournez l'état du contexte. </font><font style="vertical-align: inherit;">À la fin, définissez le drapeau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sale</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour qu'à la prochaine itération du rendu, le moteur VCV n'oublie pas de mettre à jour notre widget.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de rendu d'image</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">drawFramebuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{<font></font>
<font></font>
    NVGcontext* vg = APP-&gt;window-&gt;vg;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (display_connected) {<font></font>
        nvgSave(vg);<font></font>
	glViewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>);<font></font>
        glClearColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
        glClear(GL_COLOR_BUFFER_BIT|GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
	nvgBeginFrame(vg, <span class="hljs-number">960</span>,  <span class="hljs-number">160</span>, <span class="hljs-number">1</span>);<font></font>
        draw(vg);<font></font>
        nvgEndFrame(vg);<font></font>
<font></font>
        glReadPixels(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>, GL_RGB, GL_UNSIGNED_SHORT_5_6_5, image); <font></font>
<font></font>
        <span class="hljs-comment">//  XOR   ,  </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>*<span class="hljs-number">960</span>; i ++){<font></font>
            image[i * <span class="hljs-number">4</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] ^= <span class="hljs-number">0xF3</span>;<font></font>
            image[i * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] ^= <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
	    	<font></font>
	sendDisplay(image);<font></font>
<font></font>
	nvgRestore(vg);<font></font>
    }<font></font>
<font></font>
    dirty = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logique d'interaction et cartographie des paramètres</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ma tâche, je voulais pouvoir changer de motif enregistré dans des séquenceurs, et en même temps contrôler un certain ensemble de paramètres, le mien pour chaque groupe de motifs. </font><font style="vertical-align: inherit;">En mappant, je comprends la liaison du paramètre d'un module avec le paramètre d'un autre module ou contrôleur midi. </font><font style="vertical-align: inherit;">J'ai trouvé très peu d'informations sur la façon de rendre le mappage magnifique, alors j'ai pris la plupart du code qui l'implémente du module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI Map</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intégré dans VCV </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En bref, pour chaque groupe de paramètres, un objet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ParamHandle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> spécial </font><i><font style="vertical-align: inherit;">y</font></i><font style="vertical-align: inherit;"> est </font><i><font style="vertical-align: inherit;">créé</font></i><font style="vertical-align: inherit;"> , qui </font><font style="vertical-align: inherit;">indique au moteur à l' </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aide de béquilles</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce qui est connecté à quoi.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un module que j'ai finalement obtenu. </font><font style="vertical-align: inherit;">En plus de la conversion standard de midi en CV, il vous permet de grouper les pads, de leur assigner des couleurs et d'associer des paramètres arbitraires de modules aux encodeurs Push, en affichant leurs noms et valeurs sur l'écran du contrôleur. </font><font style="vertical-align: inherit;">Dans la vidéo ci-dessous, vous pouvez voir son aperçu, et dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cette vidéo, vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pouvez voir en action.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OhdxXv6uHF0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code complet est disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons réussi à le tester uniquement sous Linux (Ubuntu 18.04), sur MacOS l'affichage ne se connectait pas en raison des spécificités de libusb et il y avait d'étranges retards dans l'interface midi. </font><font style="vertical-align: inherit;">Malgré cela, VCV Rack a laissé une très bonne impression à la fois en tant que framework et en tant que DAW modulaire, j'espère que VCV continuera à se développer, et cet article aidera quelqu'un d'autre à écrire ses propres modules pour cela.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491232/index.html">RPA + Machine Learning = automatisation intelligente</a></li>
<li><a href="../fr491234/index.html">Trois astuces pour travailler avec SOLIDWORKS pour la modélisation de pièces pour l'impression 3D</a></li>
<li><a href="../fr491236/index.html">Programmation asynchrone dans .NET: meilleures pratiques</a></li>
<li><a href="../fr491238/index.html">Analyse du code génétique II</a></li>
<li><a href="../fr491240/index.html">La route vers les nuages: hier et aujourd'hui Adobe</a></li>
<li><a href="../fr491246/index.html">Conférence DEFCON 27. Votre voiture est ma voiture. Partie 2</a></li>
<li><a href="../fr491250/index.html">Lampes à LED Gauss Basic</a></li>
<li><a href="../fr491252/index.html">5 fonctionnalités peu connues de JSON.stringify ()</a></li>
<li><a href="../fr491256/index.html">Développement du module sur iMX8 à partir de NXP. Caractéristiques du transfert de trace DDR</a></li>
<li><a href="../fr491258/index.html">IT girls, d'où venez-vous? Construisons une carte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>