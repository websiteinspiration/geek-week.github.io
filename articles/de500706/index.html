<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌖 💝 💪🏽 Upgrade von MySQL (Percona Server) von 5.7 auf 8.0 ⚛️ 🥅 🤹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Fortschritt steht nicht still, daher werden die Gründe für das Upgrade auf die neuesten Versionen von MySQL immer wichtiger. Vor nicht allzu lange...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Upgrade von MySQL (Percona Server) von 5.7 auf 8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Fortschritt steht nicht still, daher werden die Gründe für das Upgrade auf die neuesten Versionen von MySQL immer wichtiger. </font><font style="vertical-align: inherit;">Vor nicht allzu langer Zeit war es in einem unserer Projekte an der Zeit, gemütliche Percona Server 5.7-Cluster auf Version 8 zu aktualisieren. </font><font style="vertical-align: inherit;">All dies geschah auf der Ubuntu Linux 16.04-Plattform. </font><font style="vertical-align: inherit;">Lesen Sie diesen Artikel, um einen ähnlichen Vorgang mit minimalen Ausfallzeiten durchzuführen und auf welche Probleme beim Upgrade gestoßen ist.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausbildung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Aktualisierung des Datenbankservers ist höchstwahrscheinlich mit der Migration der Datenbank verbunden: Änderungen der Anforderungen an die Begrenzung der Systemressourcen und die Korrektur der Datenbankkonfigurationen, die von veralteten Anweisungen befreit werden müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor dem Update werden wir uns definitiv der offiziellen Dokumentation zuwenden:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versionshinweise zu MySQL 8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade-Handbuch von MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade-Handbuch von Percona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL-Tutorial zum Aktualisieren von Replikaten und Assistenten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und machen Sie einen Aktionsplan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Korrigieren Sie Konfigurationsdateien, indem Sie veraltete Anweisungen entfernen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Überprüfen Sie die Kompatibilität mit Dienstprogrammen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktualisieren Sie die Slave-Datenbanken, indem Sie das Paket installieren </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aktualisieren Sie den Assistenten, indem Sie dasselbe Paket einfügen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden jeden Punkt im Plan analysieren und sehen, was schief gehen kann. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WICHTIG! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Galera-basierte MySQL-Cluster-Upgrade-Verfahren verfügt über eigene Feinheiten, die im Artikel nicht beschrieben werden. </font><font style="vertical-align: inherit;">Sie sollten diese Anweisung in diesem Fall nicht verwenden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 1: Überprüfen von Konfigurationen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Version 8 wurde MySQL entfernt </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tatsächlich wurde es </font><font style="vertical-align: inherit;">in Version 5.7 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für veraltet erklärt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber jetzt ist es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vollständig gelöscht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dementsprechend müssen die entsprechenden Richtlinien entfernt werden. </font><font style="vertical-align: inherit;">Zum Zwischenspeichern von Abfragen können Sie jetzt externe Tools verwenden, z. B. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch veraltete Pro-Direktiven wurden in der Konfiguration gefunden </font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn in MySQL 5.7 das InnoDB-Format ausgewählt werden konnte, funktioniert die 8. Version bereits </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur mit dem Barracuda-Format</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Ergebnis ist die Streichung der folgenden Richtlinien:</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und </font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Überprüfung verwenden wir das Docker-Image von Percona Server. </font><font style="vertical-align: inherit;">Wir werden die Serverkonfiguration in das Verzeichnis stellen </font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und als Nächstes die Verzeichnisse für Daten und Protokolle erstellen. </font><font style="vertical-align: inherit;">Beispiel für einen Percona-Server-Konfigurationstest:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ergebnis: Entweder in den Docker-Protokollen oder im Verzeichnis mit den Protokollen - abhängig von Ihren Konfigurationen - wird eine Datei angezeigt, in der die Problemanweisungen beschrieben werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Folgendes hatten wir:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher mussten wir uns immer noch mit Codierungen befassen und die veraltete Richtlinie ersetzen </font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 2: Überprüfen laufender Installationen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Update-Dokumentation finden Sie zwei Dienstprogramme zum Überprüfen der Datenbank auf Kompatibilität. </font><font style="vertical-align: inherit;">Ihre Verwendung hilft dem Administrator, die Kompatibilität der vorhandenen Datenstruktur zu überprüfen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit dem klassischen Dienstprogramm mysqlcheck. </font><font style="vertical-align: inherit;">Einfach ausführen:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn keine Probleme festgestellt werden, wird das Dienstprogramm mit dem Code 0 beendet: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus </font><font style="vertical-align: inherit;">ist das Dienstprogramm </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in modernen Versionen von MySQL verfügbar </font><font style="vertical-align: inherit;">(im Fall von Percona ist dies ein Paket </font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Es ist ein Ersatz für den klassischen MySQL-Client und kombiniert die Funktionen des Clients, des SQL-Editors und der MySQL-Verwaltungstools. Um den Server vor dem Update zu überprüfen, können Sie die folgenden Befehle ausführen:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier sind die Kommentare, die wir erhalten haben: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen nichts Kritisches - nur Warnungen vor Codierungen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(siehe unten)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Das Gesamtergebnis der Implementierung: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben beschlossen, dass das Update ohne Probleme verlaufen soll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Hinweis zu den obigen Warnungen, der auf Codierungsprobleme hinweist. </font><font style="vertical-align: inherit;">Tatsache ist, dass UTF-8 in MySQL bis vor kurzem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kein „echtes“ UTF-8 war</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da es nur 3 statt 4 Bytes speicherte. In MySQL 8 beschlossen sie schließlich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es zu beheben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Der Alias </font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird bald zur Codierung führen </font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und die alten Die Spalten in den Tabellen werden </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In Zukunft wird die Codierung </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gelöscht, jedoch nicht in dieser Version. </font><font style="vertical-align: inherit;">Aus diesem Grund haben wir uns entschlossen, die Codierungen, die bereits in einer funktionierenden Installation des DBMS vorhanden sind, nach der Aktualisierung zu korrigieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 3: Server-Updates</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was kann schief gehen, wenn es einen so schicken Plan gibt? Da wir uns bewusst sind, dass die Nuancen immer auftreten, haben wir das erste Experiment mit dem MySQL-Entwicklungscluster durchgeführt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie bereits erwähnt, wird in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offiziellen Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> das Problem der Aktualisierung von MySQL-Servern mit Replikaten hervorgehoben. Unter dem Strich lohnt es sich zunächst, alle Replikate (Slaves) zu aktualisieren, da MySQL 8 vom Assistenten der Version 5.7 replizieren kann. Einige Schwierigkeiten liegen in der Tatsache, dass wir den </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master &lt;-&gt; Master-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modus verwenden, wenn sich der Remote-Master im </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schreibgeschützten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modus befindet </font><font style="vertical-align: inherit;">. Das heißt, der Kampfverkehr gelangt in ein Rechenzentrum, und das zweite ist die Sicherung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Topologie lautet wie folgt: Das </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upgrade sollte mit </font><i><font style="vertical-align: inherit;">MySQL-Replikat-DC 2-</font></i><font style="vertical-align: inherit;"> Replikaten beginnen</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und am Ende mit dem mysql master dc 1. Server. Für eine bessere Zuverlässigkeit haben wir die virtuellen Maschinen gestoppt, sie als Snapshots erstellt und die Replikation mit dem Befehl kurz vor dem Update gestoppt </font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Der Rest des Updates sieht folgendermaßen aus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeder Replik Neustart Hinzufügen der Konfigurationsoption 3: </font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tatsache ist, dass beim Aktualisieren der Datenbank binäre Protokolle mit aktualisierten Systemtabellen generiert werden. </font><font style="vertical-align: inherit;">Diese Anweisungen garantieren, dass keine Änderungen an den Anwendungsdaten in der Datenbank vorgenommen werden und Informationen zum Aktualisieren der Systemtabellen nicht in die Binärprotokolle gelangen. </font><font style="vertical-align: inherit;">Dadurch werden Probleme beim Fortsetzen der Replikation vermieden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren Sie das Paket </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist wichtig zu beachten, dass Sie in MySQL 8 </font><font style="vertical-align: inherit;">den Befehl </font><font style="vertical-align: inherit;">nach dem Aktualisieren des Servers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausführen müssen </font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Starten Sie den Server nach einem erfolgreichen Start erneut - bereits ohne die im ersten Absatz hinzugefügten Parameter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir stellen sicher, dass die Replikation erfolgreich funktioniert: Wir überprüfen, </font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ob die Tabellen mit Zählern in der Anwendungsdatenbank aktualisiert werden.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das alles sieht ganz einfach aus: Das Entwickler-Update war erfolgreich. </font><font style="vertical-align: inherit;">Ok, Sie können sicher ein Upgrade über Nacht für die Produktion planen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gab keine Traurigkeit - wir haben das Produkt aktualisiert</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erfolgreiche Entwicklung der Entwicklererfahrung auf die Produktion war jedoch nicht ohne Überraschungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Glücklicherweise beginnt der Aktualisierungsprozess selbst mit Replikaten. Nachdem wir auf Schwierigkeiten gestoßen sind, haben wir die Arbeit eingestellt und das Replikat aus dem Snapshot wiederhergestellt. Die Problemstudie wurde am nächsten Morgen verschoben. Die folgenden Einträge wurden in den Protokollen angezeigt:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine Untersuchung der Archive verschiedener Mailinglisten bei Google ergab, dass ein solches Problem aufgrund eines </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL-Fehlers auftritt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Obwohl es eher ein Utility-Bug ist </font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellt sich heraus, dass MySQL die Darstellung von Daten für Dezimalfelder (int, tinyint usw.) geändert hat, sodass eine andere Möglichkeit zum Speichern in MySQL-Servern verwendet wird. Wenn Ihre Datenbank </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ursprünglich</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Version 5.5 oder 5.1 war und Sie dann auf 5.7 aktualisiert haben, müssen Sie möglicherweise </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einige Tabellen </font><font style="vertical-align: inherit;">erstellen </font><font style="vertical-align: inherit;">. Anschließend aktualisiert MySQL die Datendateien und überträgt sie in das aktuelle Speicherformat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können dies auch mit dem Dienstprogramm überprüfen </font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn </font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie 0 haben, wird der alte Typ in der Tabelle verwendet - dies muss durchgeführt werden </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Wenn der Wert jedoch 246 ist, haben Sie bereits einen neuen Typ. Weitere Informationen zu den Typen finden Sie im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus </font><font style="vertical-align: inherit;">berücksichtigt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieser Fehler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> den zweiten möglichen Grund, der uns umgangen hat - das Fehlen von InnoDB-Tabellen in der Systemtabelle </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wenn diese Tabellen in Version 5.1 erstellt wurden. Um Probleme während des Upgrades zu vermeiden, können Sie das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angehängte SQL-Skript verwenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum hatten wir solche Probleme bei dev nicht? Die Basis wird dort regelmäßig aus der Produktion kopiert - somit werden die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabellen neu erstellt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider funktioniert es in einer wirklich funktionierenden großen Datenbank nicht nur, die allgegenwärtige Datenbank zu übernehmen und auszuführen </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das Percona-Toolkit hilft hier: Das Dienstprogramm pt-online-schema-change eignet sich hervorragend für den Online-OPTIMIZE-Vorgang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der aktualisierte Plan lautete wie folgt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimieren Sie alle Tabellen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Führen Sie ein Datenbank-Upgrade durch.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies zu überprüfen und gleichzeitig die Aktualisierungszeit herauszufinden, haben wir eines der Replikate deaktiviert und für alle Tabellen den folgenden Befehl ausgeführt:</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Tabellen werden ohne lange Sperren aktualisiert, da das Dienstprogramm eine neue temporäre Tabelle erstellt, in die die Daten aus der Haupttabelle kopiert werden. </font><font style="vertical-align: inherit;">In dem Moment, in dem beide Tabellen identisch sind, wird die ursprüngliche Tabelle gesperrt und durch eine neue ersetzt. </font><font style="vertical-align: inherit;">In unserem Fall ergab ein Testlauf, dass das Aktualisieren aller Tabellen etwa einen Tag dauern würde, das Kopieren der Daten jedoch zu viel Belastung der Festplatten verursachte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies zu vermeiden, haben wir bei der Produktion dem Befehl ein Argument </font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit dem Wert 10 </font><font style="vertical-align: inherit;">hinzugefügt. </font><font style="vertical-align: inherit;">Dieser Parameter steuert die Wartezeit nach der Übertragung eines Datenpakets in eine neue Tabelle. </font><font style="vertical-align: inherit;">Auf diese Weise können Sie die Last reduzieren, wenn eine wirklich ausgeführte Anwendung eine Antwortzeit benötigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach Durchführung der Optimierung war das Update erfolgreich.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... aber nicht ganz!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine halbe Stunde nach dem Update hatte der Client ein Problem. </font><font style="vertical-align: inherit;">Die Basis funktionierte sehr seltsam: In regelmäßigen Abständen begannen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbindungsabbrüche</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">So sah es bei der Überwachung aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Sägezahndiagramm ist im Screenshot sichtbar, da ein Teil der Threads des MySQL-Servers regelmäßig mit einem Fehler herunterfiel. </font><font style="vertical-align: inherit;">In der Anwendung sind Fehler aufgetreten:</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine schnelle Überprüfung der Protokolle ergab, dass der mysqld-Daemon die erforderlichen Ressourcen nicht vom Betriebssystem erhalten konnte. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beim Umgang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit Fehlern haben wir in den </font><b><font style="vertical-align: inherit;">Apparmor-Richtliniendateien</font></b><font style="vertical-align: inherit;"> des Systems </font><b><font style="vertical-align: inherit;">Folgendes gefunden</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Dateien wurden während des Upgrades auf MySQL 5.7 vor einigen Jahren erstellt und gehören zum Remote-Paket. </font><font style="vertical-align: inherit;">Das Löschen von Dateien und das Neustarten des Apparmor-Dienstes lösten das Problem:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschließend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder, auch der einfachste Vorgang, kann zu unerwarteten Problemen führen. </font><font style="vertical-align: inherit;">Und selbst ein gut durchdachter Plan garantiert nicht immer das erwartete Ergebnis. </font><font style="vertical-align: inherit;">In allen Update-Plänen umfasst unser Team jetzt auch die obligatorische Bereinigung zusätzlicher Dateien, die aufgrund der jüngsten Aktionen auftreten können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und mit dieser nicht so professionellen Grafik möchte ich Percona für ihre großartigen Produkte danken!</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie auch in unserem Blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenbanken und Kubernetes (Überprüfung und Videobericht)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipps und Tricks von Kubernetes: Beschleunigen des Bootstraps großer Datenbanken</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 praktische Geschichten aus unserem SRE-Alltag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">    Redis  K8s  -      </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  MongoDB  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500694/index.html">68 unaufgeforderte Tipps</a></li>
<li><a href="../de500696/index.html">Wie Laufschuhe versuchen, sich an den weiblichen Fuß anzupassen</a></li>
<li><a href="../de500698/index.html">Evgeny Katyshev: "OpenStreetMap ist für keine Informationen geeignet"</a></li>
<li><a href="../de500700/index.html">Unterstützung für TLS1.3 und Erweiterung Ihres persönlichen Kontos: Was wurde für das erste Quartal 2020 getan?</a></li>
<li><a href="../de500704/index.html">Einhörner (Airbnb, Uber, Lyft, Careem) entließen Tausende von Mitarbeitern aufgrund von Problemen während der Coronavirus-Pandemie</a></li>
<li><a href="../de500708/index.html">Sicherheit und DBMS: Was Sie bei der Auswahl von Schutzwerkzeugen beachten müssen</a></li>
<li><a href="../de500712/index.html">Digital Coronavirus - Eine Kombination aus Ransomware und Infostealer</a></li>
<li><a href="../de500718/index.html">EPAM im Remote-Modus: wie es funktioniert</a></li>
<li><a href="../de500720/index.html">Neue Standards für Informationssicherheit: Machen Sie Angreifern das Leben schwerer</a></li>
<li><a href="../de500722/index.html">"Backen bis fertig": Wer speichert seltene Tonbandaufnahmen auf so ungewöhnliche Weise</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>