<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰🏻 🚵🏼 ✒️ Protobuf atau protokol komunikasi front-end JSON terstruktur? ❕ 🈳 🛌🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam proyek baru di tim kami, kami memilih kerangka kerja frontend VUE untuk produk baru, backend ditulis dalam PHP, dan telah bekerja dengan sukses ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Protobuf atau protokol komunikasi front-end JSON terstruktur?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489916/"><img src="https://habrastorage.org/getpro/habr/post_images/b3b/a64/22e/b3ba6422e0fb8cefb21ac424135de8b2.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam proyek baru di tim kami, kami memilih kerangka kerja frontend VUE untuk produk baru, backend ditulis dalam PHP, dan telah bekerja dengan sukses selama 17 tahun sekarang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika kode mulai tumbuh, saya harus berpikir tentang menyederhanakan pertukaran data dengan server, yang akan saya bicarakan.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang backend</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proyek ini cukup besar, dan fungsinya sangat membingungkan, oleh karena itu, kode yang ditulis dalam DDD memiliki struktur data tertentu, mereka kompleks dan produktif untuk beberapa universalitas dalam proyek secara keseluruhan.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang frontend</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 bulan </font><font style="vertical-align: inherit;">pengembangan bagian depan, kami menggunakan JSON sebagai respons dari server, diunggah ke State Vuex dalam format yang nyaman bagi kami. </font><font style="vertical-align: inherit;">Tetapi untuk kembali ke server, kami harus mengonversi dalam arah yang berlawanan, sehingga server dapat membaca dan memetakan objek DTO-nya (mungkin tampak aneh, tetapi seharusnya begitu :))</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya tidak ada apa-apa, mereka bekerja dengan apa yang ada, negara tumbuh menjadi benda besar. </font><font style="vertical-align: inherit;">Mereka mulai memecah menjadi modul yang lebih kecil, masing-masing memiliki negara sendiri, mutasi, dll ... API mulai berubah setelah tugas baru dari manajer, dan itu menjadi semakin sulit untuk mengelola semua ini, kemudian dipetakan salah, kemudian bidang berubah ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di sini kita berada mulai berpikir tentang struktur data universal di server dan depan untuk menghilangkan kesalahan dalam parsing, pemetaan, dll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah beberapa pencarian, kami menemukan dua opsi:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffer protokol</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pembuatan server JS DTO sisi-server untuk front, dengan pemrosesan JSON lebih lanjut dalam DTO ini.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mencoba pena, sudah biasa menggunakan Protobuf dari google. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan itulah kenapa:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sudah ada fungsional yang mengkompilasi struktur yang dijelaskan untuk banyak platform, termasuk untuk PHP dan untuk JS.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada generator dokumentasi untuk struktur yang dibuat .proto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat dengan mudah mengacaukan beberapa versi untuk struktur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pencarian objek difasilitasi saat refactoring dalam PHP dan JS.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan chip lain seperti gRPC, dll. Jika perlu.</font></font></li>
</ol><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berhenti bicara, mari kita lihat bagaimana tampilannya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya tidak akan menjelaskan tampilannya di sisi PHP, semuanya hampir sama di sana, objeknya sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan menunjukkan kepada Anda contoh klien JS sederhana dan server mini di Node.js. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami menggambarkan struktur data yang kami butuhkan. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produk.proto</font></font></b><br>
<br>
<pre><code class="plaintext hljs">syntax = "proto3";<font></font>
<font></font>
package api;<font></font>
<font></font>
import "price.proto";<font></font>
<font></font>
message Product {<font></font>
    message Id {<font></font>
        uint32 value = 1;<font></font>
    }<font></font>
    Id id = 1;<font></font>
    string name = 2;<font></font>
    string text = 3;<font></font>
    string url = 4;<font></font>
    Price price = 5;<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">harga</font></font></b><br>
<br>
<pre><code class="plaintext hljs">syntax = "proto3";<font></font>
package api;<font></font>
<font></font>
message Price {<font></font>
    float value = 1;<font></font>
    uint32 tax = 2;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service.proto</font></font></b><br>
<br>
<pre><code class="plaintext hljs">syntax = "proto3";<font></font>
<font></font>
package api;<font></font>
<font></font>
import "product.proto";<font></font>
<font></font>
service ApiService {<font></font>
    rpc getById (Product.Id) returns (Product);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan menjelaskan sedikit tentang layanan ini, mengapa itu diperlukan, jika bahkan tidak digunakan. </font><font style="vertical-align: inherit;">Layanan ini dijelaskan hanya demi dokumentasi dalam kasus kami, apa yang diterimanya dan apa yang diberikannya, sehingga kami dapat mengganti objek yang diperlukan. </font><font style="vertical-align: inherit;">Ini hanya diperlukan untuk gRPC. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kode </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">diunduh</font></a><font style="vertical-align: inherit;"> berdasarkan struktur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan perintah generasi berjalan di bawah JS.</font></font><br>
<br>
<pre><code class="plaintext hljs">./protoc --proto_path=/Users/user/dev/habr_protobuf/public/proto --js_out=import_style=commonjs,binary:/Users/user/dev/habr_protobuf/src/proto/ /Users/user/dev/habr_protobuf/public/proto/*.proto</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih detail di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah generasi, 3 file JS muncul, di mana semuanya direduksi menjadi objek, dengan fungsionalitas serialisasi ke buffer dan deserialization dari buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
price_pb.js </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
product_pb.js </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
service_pb.js </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya kita menggambarkan kode JS.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Product } <span class="hljs-keyword">from</span> <span class="hljs-string">'../proto/product_pb'</span>;<font></font>
<font></font>
<span class="hljs-comment">//         Product.Id</span>
<span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> Product.Id().setValue(<span class="hljs-number">12345</span>);
<span class="hljs-keyword">let</span> message = instance.serializeBinary();<font></font>
<font></font>
<span class="hljs-keyword">let</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">'http://localhost:3008/api/getById'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: message<font></font>
});<font></font>
<font></font>
<span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> response.arrayBuffer();<font></font>
<font></font>
<span class="hljs-comment">//     Product,   ,    , </span>
<span class="hljs-comment">//      .</span>
<span class="hljs-keyword">const</span> data = Product.deserializeBinary(result);
<span class="hljs-built_in">console</span>.log(data.toObject());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada prinsipnya, klien siap. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami Ekspres di server</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();<font></font>
app.use(cors());<font></font>
<font></font>
<span class="hljs-comment">//           .</span>
<span class="hljs-keyword">const</span> Product = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./src/proto/product_pb'</span>).Product;
<span class="hljs-keyword">const</span> Price = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./src/proto/price_pb'</span>).Price;<font></font>
<font></font>
<span class="hljs-comment">//    , .     .</span>
app.use (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">let</span> data = [];<font></font>
  req.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>{<font></font>
    data.push(chunk);<font></font>
  });<font></font>
  req.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (data.length &lt;= <span class="hljs-number">0</span> ) <span class="hljs-keyword">return</span> next();<font></font>
    data = Buffer.concat(data);<font></font>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Received buffer'</span>, data);<font></font>
    req.raw = data;<font></font>
    next();<font></font>
  })<font></font>
});<font></font>
<font></font>
app.post(<span class="hljs-string">'/api/getById'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-comment">//     Product.Id,   </span>
  <span class="hljs-keyword">const</span> prId = Product.Id.deserializeBinary(req.raw);
  <span class="hljs-keyword">const</span> id = prId.toObject().value;<font></font>
<font></font>
  <span class="hljs-comment">//   " "      </span>
  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">new</span> Product();<font></font>
  product.setId(<span class="hljs-keyword">new</span> Product.Id().setValue(id));<font></font>
  product.setName(<span class="hljs-string">'Sony PSP'</span>);<font></font>
  product.setUrl(<span class="hljs-string">'http://mysite.ru/product/psp/'</span>);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> price = <span class="hljs-keyword">new</span> Price();<font></font>
  price.setValue(<span class="hljs-number">35500.00</span>);<font></font>
  price.setTax(<span class="hljs-number">20</span>);<font></font>
<font></font>
  product.setPrice(price);<font></font>
<font></font>
  <span class="hljs-comment">//       Product</span><font></font>
  res.send(Buffer.from(product.serializeBinary()));<font></font>
});<font></font>
<font></font>
app.listen(<span class="hljs-number">3008</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Example app listening on port 3008!'</span>);<font></font>
});<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang kita miliki secara total</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Satu titik kebenaran dalam bentuk objek yang dihasilkan berdasarkan pada struktur yang digambarkan satu kali untuk banyak platform.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada kebingungan, ada dokumentasi yang jelas baik dalam bentuk HTML yang dihasilkan secara otomatis dan hanya melihat file .proto.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di mana-mana, pekerjaan sedang dilakukan dengan entitas tertentu, tanpa modifikasi mereka, dll. (Dan kita semua tahu bahwa frontend suka muntah :))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operasi protokol ini sangat nyaman dipertukarkan melalui soket web.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentu saja ada minus kecil, ini adalah kecepatan serialisasi dan deserialisasi, di sini adalah contohnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mengambil lorem ipsum selama 10 paragraf, ternyata data 5.5kb, dengan mempertimbangkan objek yang diisi Harga, Produk. </font><font style="vertical-align: inherit;">Dan saya mengendarai data di Protobuf dan JSON (semua sama, hanya mengisi skema JSON, bukan objek Protobuf)</font></font><br>
<br>
<pre><code class="plaintext hljs">   <font></font>
<font></font>
Protobuf parsing<font></font>
<font></font>
client<font></font>
2.804999ms<font></font>
1.8150000ms<font></font>
0.744999ms<font></font>
server<font></font>
1.993ms<font></font>
0.495ms<font></font>
0.412ms<font></font>
<font></font>
JSON<font></font>
<font></font>
client<font></font>
0.654999ms<font></font>
0.770000ms<font></font>
0.819999ms<font></font>
<font></font>
server<font></font>
0.441ms<font></font>
0.307ms<font></font>
0.242ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih atas perhatiannya :)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id489902/index.html">Cara mengukur efektivitas portofolio investasi: 3 pendekatan praktis</a></li>
<li><a href="../id489904/index.html">Mengapa dan bagaimana kami menguji pembaruan</a></li>
<li><a href="../id489906/index.html">Ruang pas virtual di OpenCV</a></li>
<li><a href="../id489912/index.html">Rasa sakit dan penderitaan saat men-debug layanan mikro dalam pengembangan web</a></li>
<li><a href="../id489914/index.html">Pengelompokan dalam Proxmox VE</a></li>
<li><a href="../id489918/index.html">Bagaimana kami menerapkan proyek kartu bahan bakar virtual</a></li>
<li><a href="../id489920/index.html">Situs, buka IPv6, dua</a></li>
<li><a href="../id489924/index.html">Di mana Elasticsearch memulai</a></li>
<li><a href="../id489926/index.html">Black Friday: melihat beban melalui mata pengembang</a></li>
<li><a href="../id489928/index.html">Masker medis tidak lagi menyimpan pengenalan wajah</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>