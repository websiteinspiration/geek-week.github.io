<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛌 👨🏽‍✈️ 🍢 Flattern + Arduino Nano 33 BLE sense = sehr einfacher BLE Sensor 💆🏻 🤳🏽 🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel möchte ich erklären, wie man eine sehr einfache Bluetooth-Wetterstation erstellt (wo ohne sie :) und eine mobile Anwendung auf Flutt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Flattern + Arduino Nano 33 BLE sense = sehr einfacher BLE Sensor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492404/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Artikel möchte ich erklären, wie man eine sehr einfache Bluetooth-Wetterstation erstellt (wo ohne sie :) und eine mobile Anwendung auf Flutter dafür schreibt.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ep/ad/j7/epadj7tyxlocbup948zmgsyafdc.jpeg"><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betrachten Sie am Anfang den Sensor selbst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Wiederholung benötigen Sie ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino nano 33 BLE Sense</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Board </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Board ist auf nrf52840 aufgebaut. </font><font style="vertical-align: inherit;">Wir installieren es über den Board Manager in Arduino. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/ry/nl/gorynl7zdxmfbzidptj5g-p7wtm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie sofort die erforderlichen Bibliotheken:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino ble</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino HTS221</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino LPS22HB</font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Bibliotheken werden für Sensoren benötigt, die bereits auf der Platine selbst gelötet sind.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Theorie und dann die praktische Umsetzung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hauptidee war nicht, ein Plug-In-Gerät zu erstellen, sondern Broadcast-Nachrichten mit allen darin enthaltenen Informationen zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der übliche Bluetooth-Tag-Modus wurde verwendet, jedoch mit der Änderung ManufacturerData. Dieses Paket kann in jedem Werbepaket übertragen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Gesamtgröße eines Werbepakets beträgt 31 Byte. Dies beinhaltet alle notwendigen Informationen: Gerätename, Systemdaten, Benutzerdaten. In seiner reinen Form beträgt der Benutzer in ManufacturerData ungefähr 20 Bytes. Dies reicht aus, um Wetterstationsdaten zu übertragen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Vorteile dieser Methode der Datenübertragung bei geringerem Stromverbrauch, keine ständige Verbindung zum Gerät aufrechtzuerhalten, werden übertragen. Eine solche Nachricht kann eine unbegrenzte Anzahl von Empfängern im Empfangsradius erfassen.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManufacturerData wird vor Beginn der Werbung installiert.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und jetzt der praktische Teil</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Arduino-Code geben wir die Art der Arbeit des BLE-Teils an und legen die Start-ManufacturerData fest. Der Einfachheit halber gebe </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ich auch den Namen des Geräts an, der in der Anwendung leichter zu finden ist.</font></font><br>
<br>
<pre><code class="cpp hljs">BLE.setLocalName(<span class="hljs-string">"nrf52840.ru"</span>);<font></font>
BLE.setConnectable(<span class="hljs-literal">false</span>);<font></font>
byte data[<span class="hljs-number">8</span>] = { <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x08</span>};<font></font>
BLE.setManufacturerData(data, <span class="hljs-number">8</span>);
<span class="hljs-comment">// start advertising</span><font></font>
BLE.advertise();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Anfangsdaten werden als Satz von Bytes angegeben, um das Array zu füllen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt machen wir im Hauptcode eine Werbeunterbrechung, stoppen das Radio, messen die erforderlichen Daten und füllen ManufacturerData mit realen Daten aus und beginnen dann mit der Rücksendung. </font><font style="vertical-align: inherit;">Dieser Vorgang wird alle 2 Sekunden ausgeführt.</font></font><br>
<br>
<pre><code class="cpp hljs">BLE.stopAdvertise();
<span class="hljs-comment">// read all the sensor values</span><font></font>
---------------------<font></font>
       <font></font>
---------------------<font></font>
byte data[<span class="hljs-number">8</span>] = { <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, t1, t2, h1, h2, p1, p2}; <span class="hljs-comment">// t -  (2 ), h -  (2 ), p -  (2 )</span>
BLE.setManufacturerData(data, <span class="hljs-number">8</span>);<font></font>
BLE.advertise();<font></font>
<span class="hljs-comment">// wait 2 second to print again</span>
delay(<span class="hljs-number">2000</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit ist die Arbeit mit dem Sensor abgeschlossen. </font><font style="vertical-align: inherit;">Der Sensor sendet alle 100 ms und alle 2 Sekunden aktualisiert er die Daten auf die aktuellen. </font><font style="vertical-align: inherit;">Das Ergebnis war ein sehr einfacher Wettercode und Implementierungssensor.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betrachten Sie nun die mobile Anwendung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde sofort eine Reservierung vornehmen: Ich bin kein Entwickler mobiler Anwendungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Arbeit habe ich VSCode mit dem Flutter-Plugin verwendet. </font><font style="vertical-align: inherit;">Diese Umgebung scheint einfacher zu sein als Android Studio, wie ich dachte. </font><font style="vertical-align: inherit;">Für die Arbeit mit BLE wurde die Bibliothek </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flutter_blue verwendet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , wodurch die Verbindung des Geräts erheblich vereinfacht wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Logik der Anwendung ist ebenfalls recht einfach. </font><font style="vertical-align: inherit;">Unser Sensor sendet im normalen Beacon-Modus, sodass Sie nur einige Aktionen ausführen müssen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Broadcast scannen - Suchen Sie das Gerät mit dem angegebenen Namen. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Analysieren Sie die Herstellerdaten, um Daten auf dem Bildschirm anzuzeigen. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, wie das gemacht wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Start der Anwendung wird regelmäßig ein Timer gestartet, der die Bluetooth-Geräte 2 Sekunden lang alle 10 Sekunden scannt. </font><font style="vertical-align: inherit;">Es macht keinen Sinn, öfter und länger zu scannen, der Batterieverbrauch steigt und der Sensor sendet im Allgemeinen alle 100 ms.</font></font><br>
<br>
<pre><code class="java hljs">DeviceScanner() {<font></font>
   _subscribeToScanEvents();<font></font>
   _timer = <span class="hljs-keyword">new</span> Timer.periodic(<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">Duration</span><span class="hljs-params">(seconds: <span class="hljs-number">10</span>)</span>, startScan)</span>;<font></font>
 }<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">startScan</span><span class="hljs-params">(Timer timer)</span> </span>{<font></font>
   FlutterBlue.instance.startScan(timeout: Duration(seconds: <span class="hljs-number">2</span>));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Nächstes beginnen wir mit der Analyse der Scanergebnisse, prüfen, ob ein Gerät mit dem angegebenen Namen in der Scanliste enthalten ist. In diesem Fall analysieren wir das Paket und zeigen das Ergebnis dem Benutzer an.</font></font><br>
<br>
<pre><code class="java hljs">
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_subscribeToScanEvents</span><span class="hljs-params">()</span> </span>{<font></font>
    FlutterBlue.instance.scanResults.listen((scanResults) {<font></font>
      <span class="hljs-keyword">for</span> (ScanResult scanResult in scanResults) {
        <span class="hljs-keyword">if</span> (scanResult.device.name.toString() == <span class="hljs-string">"nrf52840.ru"</span>) {
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> rssi = scanResult.rssi;
          <span class="hljs-keyword">final</span> String name = scanResult.device.name;
          <span class="hljs-keyword">final</span> String mac = scanResult.device.id.toString();
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> temp = scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>]<font></font>
                  [<span class="hljs-number">0</span>] +<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">1</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> humm = scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>]<font></font>
                  [<span class="hljs-number">2</span>] +<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">3</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> press =<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">4</span>] +<font></font>
                  scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">5</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> SensorData sensorData = <span class="hljs-keyword">new</span> SensorData(<font></font>
              name: name,<font></font>
              rssi: rssi,<font></font>
              mac: mac,<font></font>
              temperature: temp,<font></font>
              humidity: humm,<font></font>
              pressure: press);<font></font>
          _streamController.add(sensorData);<font></font>
          print(<font></font>
              <span class="hljs-string">'Manufacturer data ${scanResult.advertisementData.manufacturerData}'</span>);<font></font>
          FlutterBlue.instance.stopScan();<font></font>
        }<font></font>
<font></font>
        print(<font></font>
            <span class="hljs-string">'${scanResult.device.name} found! mac: ${scanResult.device.id} rssi: ${scanResult.rssi}'</span>);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine kleine Nuance. </font><font style="vertical-align: inherit;">Die Bluetooth-Bibliothek für Flutter mag seltsam erscheinen, sie empfängt die Daten in Form eines int-Arrays, und in Arduino bilden wir ein Paket aus Bytes. Deshalb habe ich ein Paket im Sensor gebildet, um die Analyse zu vereinfachen. </font><font style="vertical-align: inherit;">Die Temperatur von 25,85 Grad ist in zwei Werte 25 und 85 unterteilt, die als separate Bytewerte gesendet und auf die gleiche Weise erfasst werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Endergebnis ist eine solche Anwendung. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/27/6z/on/276zonw0i_fms8koszpnnrqwifs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Projektquellcode kann von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> heruntergeladen werden </font><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de492378/index.html">Reactjs, Material-UI mit JSS. Kurzanleitung</a></li>
<li><a href="../de492384/index.html">Hack The Box - Postbote Walkthrough Redis und WebMin</a></li>
<li><a href="../de492386/index.html">Wie der IT-Sektor der Welt hilft, weniger Lebensmittel zu werfen</a></li>
<li><a href="../de492390/index.html">Krieg auf den Bremsen. Optimieren der Anzahl der Komponenten-Renderings in React Native</a></li>
<li><a href="../de492398/index.html">Wir konfigurieren unsere Geräte für Remote-Arbeit, Podcasting, Video und Streaming</a></li>
<li><a href="../de492406/index.html">Podcasts für den Geek: einige bewährte Programme zu Projektmanagement, Technologieanalyse und GTD</a></li>
<li><a href="../de492408/index.html">Die Besucherzahlen für Yandex-Desktops sind gesunken: Was ist im Jahr 2019 passiert und wie wird es sich im Jahr 2020 auswirken?</a></li>
<li><a href="../de492410/index.html">C ++ ist schneller und sicherer als Rust, Yandex hat Messungen durchgeführt</a></li>
<li><a href="../de492414/index.html">Anatomie des NSI-Systems</a></li>
<li><a href="../de492420/index.html">Wechat oder eine wirklich umfassende Anwendung. Was kann ein Entwickler damit machen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>