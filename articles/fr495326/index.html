<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí≤ üêΩ üëµüèΩ Comment avons-nous fait le c≈ìur de l'activit√© d'investissement d'Alfa-Bank bas√©e sur Tarantool üï¥üèª üíª üõÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un clich√© du film ¬´Notre univers secret: la vie cach√©e de la cellule¬ª. L'
 
 investissement est l'un des domaines les plus difficiles du monde bancair...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment avons-nous fait le c≈ìur de l'activit√© d'investissement d'Alfa-Bank bas√©e sur Tarantool</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/495326/"><img src="https://habrastorage.org/webt/tc/or/26/tcor26cmqrsph9b0nioj_ic4cwa.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un clich√© du film ¬´Notre univers secret: la vie cach√©e de la cellule¬ª. L'</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
investissement est l'un des domaines les plus difficiles du monde bancaire, car il n'y a pas seulement des pr√™ts, des pr√™ts et des d√©p√¥ts, mais aussi des titres, des devises, des biens, des d√©riv√©s et toutes sortes de difficult√©s sous forme de produits structurels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©cemment, nous avons constat√© une augmentation de la litt√©ratie financi√®re de la population. De plus en plus de personnes sont impliqu√©es dans le trading sur les march√©s des valeurs mobili√®res. Les comptes d'investissement individuels sont apparus il n'y a pas si longtemps. Ils vous permettent de n√©gocier sur les march√©s des valeurs mobili√®res et en m√™me temps, de recevoir des d√©ductions fiscales ou de ne pas payer d'imp√¥ts. Et tous les clients qui viennent chez nous veulent g√©rer leur portefeuille et voir des rapports en temps r√©el. De plus, le plus souvent, ce portefeuille est multi-produits, c'est-√†-dire que les gens sont des clients de divers secteurs d'activit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les exigences des r√©gulateurs, russes et √©trangers, augmentent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©pondre aux besoins actuels et jeter les bases de futures mises √† niveau, nous avons d√©velopp√© le c≈ìur de l'activit√© d'investissement bas√© sur Tarantool.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques statistiques. </font><font style="vertical-align: inherit;">L‚Äôactivit√© d‚Äôinvestissement d‚ÄôAlfa-Bank fournit des services de courtage aux particuliers et aux personnes morales offrant la possibilit√© de n√©gocier sur divers march√©s de valeurs mobili√®res, des services de garde pour le stockage de titres, des services de gestion de fiducie pour les particuliers √† capital priv√© et important, des services d‚Äô√©mission de titres pour les autres entreprises. </font><font style="vertical-align: inherit;">L‚Äôactivit√© d‚Äôinvestissement d‚ÄôAlfa-Bank repr√©sente plus de 3 000 devis par seconde, qui sont t√©l√©charg√©s √† partir de diverses plateformes de trading. </font><font style="vertical-align: inherit;">Au cours de la journ√©e de travail, plus de 300 000 transactions sont conclues sur les march√©s pour le compte de la banque ou de ses clients. </font><font style="vertical-align: inherit;">Sur les plateformes externes et internes, jusqu'√† 5 000 ordres sont ex√©cut√©s par seconde. </font><font style="vertical-align: inherit;">En m√™me temps, tous les clients, internes et externes, souhaitent voir leurs positions en temps r√©el.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque part depuis le d√©but des ann√©es 2000, nos domaines d'investissement se sont d√©velopp√©s de mani√®re ind√©pendante: le trading de change, les services de courtage, le trading de devises, le trading de gr√© √† gr√© de titres et divers d√©riv√©s. En cons√©quence, nous sommes tomb√©s dans le pi√®ge des puits fonctionnels. Ce que c'est? Chaque secteur d'activit√© a ses propres syst√®mes qui dupliquent les fonctions des autres. Chaque syst√®me a son propre mod√®le de donn√©es, bien qu'ils fonctionnent sur les m√™mes concepts: transactions, instruments, contreparties, devis et plus encore. Et puisque chaque syst√®me s'est d√©velopp√© ind√©pendamment, un zoo diversifi√© de technologies a vu le jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la base de code des syst√®mes est d√©j√† d√©pass√©e, car certains produits sont originaires du milieu des ann√©es 90. Et dans certains domaines, cela a ralenti le processus de d√©veloppement, il y avait des probl√®mes de productivit√©.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouvelles exigences de solution</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les entreprises ont r√©alis√© que le d√©veloppement technologique est vital pour le d√©veloppement futur. </font><font style="vertical-align: inherit;">On nous a confi√© les t√¢ches:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collectez toutes les donn√©es d'entreprise dans un seul stockage rapide et dans un mod√®le de donn√©es unique. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne devons pas perdre ou modifier ces informations. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est n√©cessaire de mettre √† jour les donn√©es, car √† tout moment le r√©gulateur peut demander des statistiques pour les ann√©es pr√©c√©dentes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne devons pas simplement apporter de nouveaux SGBD √† la mode, mais cr√©er une plate-forme pour r√©soudre les probl√®mes commerciaux. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nos architectes fixent leurs conditions: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La nouvelle solution devrait √™tre de classe entreprise, c'est-√†-dire qu'elle devrait d√©j√† √™tre test√©e dans certaines grandes entreprises. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le mode de fonctionnement de la solution doit √™tre critique pour la mission. </font><font style="vertical-align: inherit;">Cela signifie que nous devons √™tre pr√©sents en m√™me temps dans plusieurs centres de donn√©es et exp√©rimenter calmement la d√©connexion d'un centre de donn√©es.</font></font></li>
<li>    .   ,        ,       -    .   ,         . </li>
<li>    ,     . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons suivi la voie standard: formul√© des exigences et contact√© le service des achats. De l√†, nous avons obtenu une liste d'entreprises qui, en g√©n√©ral, sont pr√™tes pour nous √† le faire. Ils ont parl√© de la t√¢che √† tout le monde et six d'entre eux ont re√ßu une √©valuation des solutions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la banque, nous ne croyons pas la parole de qui que ce soit, nous aimons tout tester par nous-m√™mes. Par cons√©quent, une condition pr√©alable √† notre appel d'offres √©tait de r√©ussir des tests de r√©sistance. Nous avons formul√© des t√¢ches de test pour la charge, et d√©j√† trois entreprises sur six ont accept√© √† leurs propres frais de mettre en ≈ìuvre un prototype de la solution bas√©e sur des technologies en m√©moire pour la tester.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne dirai pas comment nous avons tout test√© et combien de temps cela a pris, je r√©sumerai seulement: les meilleures performances dans les tests de charge ont √©t√© d√©montr√©es par le prototype de la solution bas√©e sur Tarantool de l'√©quipe de d√©veloppement du groupe Mail.ru </font><font style="vertical-align: inherit;">Nous avons sign√© un contrat et commenc√© le d√©veloppement. </font><font style="vertical-align: inherit;">Quatre personnes venaient du groupe Mail.ru et d'Alfa-Bank, il y avait trois d√©veloppeurs, trois analystes syst√®me, un architecte de solution, un propri√©taire de produit et un Scrum master. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, je vais parler de la fa√ßon dont notre syst√®me a grandi, comment il a √©volu√©, ce que nous avons fait et pourquoi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©veloppement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous nous sommes demand√© comment obtenir des donn√©es de nos syst√®mes actuels. Nous avons d√©cid√© que HTTP nous convenait tout √† fait, car tous les syst√®mes actuels communiquent entre eux, envoyant XML ou JSON via HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons le serveur HTTP Tarantool int√©gr√©, car nous n'avons pas besoin de mettre fin aux sessions SSL, et ses performances nous suffisent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai d√©j√† dit, nous avons tous les syst√®mes vivant dans diff√©rents mod√®les de donn√©es, et √† l'entr√©e, nous devons apporter l'objet au mod√®le que nous d√©crirons √† la maison. Un langage √©tait n√©cessaire pour transformer les donn√©es. Nous avons choisi l'imp√©ratif Lua. Nous ex√©cutons tout le code pour la conversion des donn√©es dans le bac √† sable - c'est un endroit s√ªr, au-del√† duquel le code en cours ne va pas au-del√†. Pour ce faire, il suffit de faire une cha√Æne de chargement du code n√©cessaire, en cr√©ant un environnement avec des fonctions qui ne peuvent rien bloquer ou supprimer quelque chose.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e3/04c/45f/4e304c45ff56974d624be577ebb8258d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s la conversion, la conformit√© des donn√©es avec le mod√®le que nous cr√©ons doit √™tre v√©rifi√©e. </font><font style="vertical-align: inherit;">Nous avons longuement discut√© de ce que devrait √™tre un mod√®le, du langage √† utiliser pour le d√©crire. </font><font style="vertical-align: inherit;">Nous nous sommes arr√™t√©s chez Apache Avro, car le langage est simple et il a le support de Tarantool. </font><font style="vertical-align: inherit;">De nouvelles versions du mod√®le et du code utilisateur peuvent √™tre mises en service plusieurs fois par jour, m√™me sous charge, m√™me sans, √† tout moment de la journ√©e, et s'adapter tr√®s rapidement aux changements.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d28/172/bea/d28172beab19e37ef1fd30597d21d321.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s v√©rification, les donn√©es doivent √™tre enregistr√©es. </font><font style="vertical-align: inherit;">Nous le faisons avec vshard (nous avons des r√©pliques g√©o-espac√©es de fragments).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5a/619/7b4/d5a6197b44b2d8f1f43b33004241f221.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les sp√©cificit√©s sont telles que pour la plupart des syst√®mes qui nous envoient des donn√©es, peu importe que nous les ayons re√ßues ou non. Par cons√©quent, d√®s le d√©but, nous avons mis en ≈ìuvre la ligne de r√©paration. Ce que c'est? Si, pour une raison quelconque, l'objet n'a pas r√©ussi la transformation ou la v√©rification des donn√©es, nous confirmons toujours la r√©ception, mais en m√™me temps, nous enregistrons l'objet dans la file d'attente de r√©paration. Il est coh√©rent, situ√© dans le r√©f√©rentiel principal avec les donn√©es d'entreprise. Nous avons imm√©diatement √©crit une interface d'administration pour cela, diverses mesures et alertes. En cons√©quence, nous ne perdons pas de donn√©es. M√™me si quelque chose a chang√© dans la source, si le mod√®le de donn√©es a chang√©, nous le trouverons imm√©diatement et nous pourrons nous adapter.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ad/2a7/c23/7ad2a7c235467068ccec89b9eb025b12.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant apprendre √† r√©cup√©rer des donn√©es stock√©es. Nous avons soigneusement analys√© nos syst√®mes et constat√© que sur la pile classique de Java et Oracle, il existe toujours une sorte d'ORM qui convertit les donn√©es d'une vue relationnelle en une vue objet. Alors pourquoi ne pas donner imm√©diatement des objets aux syst√®mes sous forme de graphe? Par cons√©quent, nous avons volontiers pris GraphQL, qui r√©pondait √† tous nos besoins. Il vous permet de recevoir des donn√©es sous forme de graphiques, de ne retirer que ce dont vous avez besoin en ce moment. Vous pouvez m√™me versionner l'API avec suffisamment de flexibilit√©.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d90/636/a7a/d90636a7ac34c91eefd299a88d902d44.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque imm√©diatement, nous avons r√©alis√© que les donn√©es extraites n'√©taient pas suffisantes pour nous. </font><font style="vertical-align: inherit;">Nous avons cr√©√© des fonctions qui peuvent √™tre attach√©es aux objets du mod√®le - en fait, des champs calcul√©s. </font><font style="vertical-align: inherit;">Autrement dit, nous attachons une certaine fonction au champ, qui, par exemple, consid√®re le prix moyen d'un devis. </font><font style="vertical-align: inherit;">Et le consommateur externe qui demande les donn√©es ne sait m√™me pas que ce champ est calcul√©.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f77/51f/ce9/f7751fce9a424fa80aba0c701cb9295e.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Impl√©mentation d'un syst√®me d'authentification. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/768/d24/2f7/768d242f7825460594a79ff0c3e07449.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, ils ont remarqu√© que plusieurs r√¥les se sont cristallis√©s dans notre solution. </font><font style="vertical-align: inherit;">Un r√¥le est une sorte d'agr√©gateur de fonctions. </font><font style="vertical-align: inherit;">En r√®gle g√©n√©rale, les r√¥les ont diff√©rents profils d'utilisation de l'√©quipement:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T-Connect: g√®re les connexions entrantes, limit√©es par le processeur, consomme peu de m√©moire, ne stocke pas l'√©tat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IB-Core: transforme les donn√©es qu'il re√ßoit via le protocole Tarantool, c'est-√†-dire qu'il fonctionne avec des tablettes. </font><font style="vertical-align: inherit;">Ne stocke pas non plus l'√©tat et peut √™tre mis √† l'√©chelle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage: enregistre uniquement les donn√©es, n'utilise aucune logique. </font><font style="vertical-align: inherit;">Les interfaces les plus simples sont impl√©ment√©es dans ce r√¥le. </font><font style="vertical-align: inherit;">Evolutif gr√¢ce √† vshard.</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/66e/613/29266e613da2a34c5df9463884873267.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est-√†-dire qu'avec l'aide de r√¥les, nous avons d√©tach√© les uns des autres diff√©rentes parties du cluster qui peuvent √™tre mises √† l'√©chelle ind√©pendamment les unes des autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc cr√©√© un enregistrement asynchrone d'un flux de donn√©es transactionnelles et une file d'attente de r√©paration avec une interface administrateur. </font><font style="vertical-align: inherit;">L'enregistrement est asynchrone d'un point de vue commercial: si nous avons la garantie de nous enregistrer des donn√©es, peu importe o√π, nous le confirmerons. </font><font style="vertical-align: inherit;">Si ce n'est pas confirm√©, alors quelque chose s'est mal pass√©, les donn√©es doivent √™tre envoy√©es. </font><font style="vertical-align: inherit;">Il s'agit d'un enregistrement asynchrone.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s le d√©but du projet, il a √©t√© d√©cid√© d'essayer d'inculquer un d√©veloppement pilot√© par les tests. Nous √©crivons des tests unitaires en Lua en utilisant le framework tarantool / tap, des tests d'int√©gration en Python en utilisant le framework pytest. Dans le m√™me temps, les d√©veloppeurs et les analystes participent √† la r√©daction des tests d'int√©gration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment appliquer le d√©veloppement pilot√© par les tests? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voulons une nouvelle fonctionnalit√©, nous essayons d'abord d'√©crire un test pour cela. Apr√®s avoir d√©couvert le bogue, nous devons d'abord √©crire dans le test, puis le corriger. Au d√©but, c'est difficile de travailler comme √ßa, il y a un malentendu de la part des employ√©s, m√™me du sabotage: "Corrigeons-le rapidement, faisons quelque chose de nouveau, puis couvrons-le avec des tests." Seul ce ¬´plus tard¬ª ne se produit presque jamais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, vous devez d'abord vous forcer √† √©crire des tests, demander aux autres de le faire. Croyez-moi, le d√©veloppement pilot√© par les tests est b√©n√©fique m√™me √† court terme. Vous sentirez qu'il est devenu plus facile pour vous de vivre. Selon nos sentiments, 99% du code est actuellement couvert par des tests. Cela semble beaucoup, mais nous n'avons aucun probl√®me: les tests sont ex√©cut√©s √† chaque commit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous aimons avant tout les tests de r√©sistance, nous les consid√©rons comme les plus importants et les effectuons r√©guli√®rement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous raconter une courte histoire sur la fa√ßon dont nous avons effectu√© la premi√®re √©tape du test de charge d'une des premi√®res versions. Nous avons plac√© le syst√®me sur l'ordinateur portable du d√©veloppeur, allum√© la charge et re√ßu 4 000 transactions par seconde. Bon r√©sultat pour un ordinateur portable. Nous avons install√© un support de charge virtuel de quatre serveurs, plus faible qu'en production. D√©ploy√© au minimum. Nous le d√©marrons et nous obtenons un r√©sultat pire que sur un ordinateur portable dans un seul thread. Contenu choquant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©tions tr√®s tristes. Nous regardons la charge du serveur, et ils se r√©v√®lent inactifs.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0b/eba/0fa/a0beba0fad0ba7e8f0cf333ef8366948.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appelons les d√©veloppeurs, et ils nous expliquent, des gens qui sont venus du monde Java, que Tarantool est monofil. </font><font style="vertical-align: inherit;">Il peut √™tre utilis√© efficacement par un seul c≈ìur de processeur sous charge. </font><font style="vertical-align: inherit;">Ensuite, nous avons d√©ploy√© le nombre maximal possible d'instances Tarantool sur chaque serveur, activ√© la charge et re√ßu d√©j√† 14,5 mille transactions par seconde.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/67f/8ca/e14/67f8cae14bea588f5018d4406f99c23c.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais l'expliquer √† nouveau. </font><font style="vertical-align: inherit;">En raison de la division en r√¥les qui utilisent les ressources diff√©remment, nos r√¥les qui √©taient responsables du traitement des connexions et de la transformation des donn√©es n'ont charg√© que le processeur, et c'√©tait strictement proportionnel √† la charge.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9d1/822/cb3/9d1822cb3dcacd91f3f9fd7dbb7c9f7c.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f0/566/1b4/1f05661b4e5b7806867849b060dc23b7.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la m√©moire n'√©tait utilis√©e que pour le traitement des connexions entrantes et des objets temporaires.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/16e/e79/f9f/16ee79f9fbfd6157c7df6edd66b90535.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au contraire, sur les serveurs de stockage, la charge du processeur a augment√©, mais beaucoup plus lentement que sur les serveurs qui g√®rent les connexions. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18b/0ad/d2d/18b0add2da6deda36388ca9b0f07594b.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la consommation de m√©moire a augment√© en proportion directe de la quantit√© de donn√©es charg√©e. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e21/697/e05/e21697e0521f54530aa7c50227297af1.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prestations de service</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©velopper notre nouveau produit sp√©cifiquement en tant que plate-forme d'application, nous avons cr√©√© un composant pour y d√©ployer des services et des biblioth√®ques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les services ne sont pas seulement de petits morceaux de code qui fonctionnent dans certains domaines. </font><font style="vertical-align: inherit;">Il peut s'agir de structures assez grandes et complexes qui font partie du cluster, v√©rifient les donn√©es de r√©f√©rence, d√©forment la logique m√©tier et donnent des r√©ponses. </font><font style="vertical-align: inherit;">Nous exportons √©galement le sch√©ma de service vers GraphQL, et le consommateur re√ßoit un point d'acc√®s aux donn√©es universel, avec introspection dans tout le mod√®le. </font><font style="vertical-align: inherit;">C'est tr√®s confortable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que les services contiennent beaucoup plus de fonctions, nous avons d√©cid√© qu'il devrait y avoir des biblioth√®ques dans lesquelles nous supprimerons le code fr√©quemment utilis√©. </font><font style="vertical-align: inherit;">Nous les avons ajout√©s √† un environnement s√ªr, apr√®s avoir v√©rifi√© que cela ne nous brise rien. </font><font style="vertical-align: inherit;">Et maintenant, nous pouvons d√©finir des fonctions pour des environnements suppl√©mentaires sous forme de biblioth√®ques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulions que nous ayons une plate-forme non seulement pour le stockage, mais aussi pour l'informatique. </font><font style="vertical-align: inherit;">Et puisque nous avions d√©j√† un tas de r√©pliques et de fragments, nous avons impl√©ment√© un semblant d'informatique distribu√©e et l'avons appel√© map r√©duire, car il s'est av√©r√© √™tre comme la carte originale r√©duire.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anciens syst√®mes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous nos anciens syst√®mes ne peuvent pas nous appeler via HTTP et utiliser GraphQL, bien qu'ils prennent en charge ce protocole. </font><font style="vertical-align: inherit;">Par cons√©quent, nous avons cr√©√© un m√©canisme pour r√©pliquer les donn√©es sur ces syst√®mes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5d/6e5/e33/f5d6e5e33b10e605cf7c6c5befd4aa07.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si quelque chose change pour nous, des d√©clencheurs particuliers fonctionnent dans le r√¥le de stockage et le message avec les modifications tombe dans la file d'attente de traitement. </font><font style="vertical-align: inherit;">Il est envoy√© √† un syst√®me externe √† l'aide d'un r√¥le de r√©plicateur distinct. </font><font style="vertical-align: inherit;">Ce r√¥le ne stocke pas l'√©tat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De nouvelles am√©liorations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous vous en souvenez, d'un point de vue commercial, nous avons fait un enregistrement asynchrone. </font><font style="vertical-align: inherit;">Mais ensuite, ils ont r√©alis√© que ce ne serait pas suffisant, car il existe une classe de syst√®mes qui doivent recevoir imm√©diatement une r√©ponse sur l'√©tat de l'op√©ration. </font><font style="vertical-align: inherit;">Par cons√©quent, nous avons √©tendu notre GraphQL et ajout√© des mutations. </font><font style="vertical-align: inherit;">Ils s'inscrivent organiquement dans le paradigme existant de l'utilisation des donn√©es. </font><font style="vertical-align: inherit;">Nous avons un seul point de lecture et d'√©criture pour une autre classe de syst√®mes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/395/562/ef7/395562ef7191842f4dc9526dae8c0661.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©galement r√©alis√© que les services seuls ne seraient pas suffisants pour nous, car il y a des rapports assez lourds qui doivent √™tre √©labor√©s une fois par jour, une semaine, un mois. Cela peut prendre du temps et les rapports peuvent m√™me bloquer la boucle d'√©v√©nement Tarantool. Par cons√©quent, nous avons cr√©√© des r√¥les distincts: planificateur et coureur. Les coureurs ne stockent pas l'√©tat. Ils lancent des t√¢ches difficiles que nous ne pouvons pas compter √† la vol√©e. Et le r√¥le de planificateur surveille le calendrier de lancement de ces t√¢ches, qui est d√©crit dans la configuration. Les t√¢ches elles-m√™mes sont stock√©es au m√™me endroit que les donn√©es d'entreprise. Lorsque le bon moment arrive, le planificateur prend la t√¢che, la donne √† un coureur, il la consid√®re et enregistre le r√©sultat.</font></font><br>
 <br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb1/bbf/123/fb1bbf12343d40bab27a87b5f1021f0d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les t√¢ches ne doivent pas √™tre ex√©cut√©es dans les d√©lais. </font><font style="vertical-align: inherit;">Certains rapports doivent √™tre lus sur demande. </font><font style="vertical-align: inherit;">D√®s que cette exigence arrive, une t√¢che est form√©e dans le bac √† sable et envoy√©e au runner pour ex√©cution. </font><font style="vertical-align: inherit;">Apr√®s un certain temps, l'utilisateur re√ßoit une r√©ponse asynchrone indiquant que tout a √©t√© calcul√©, le rapport est pr√™t.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13f/27e/db0/13f27edb0711b735602d77c7c54c4d38.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, nous avons adh√©r√© au paradigme de la sauvegarde de toutes les donn√©es, de la gestion des versions et de leur suppression. </font><font style="vertical-align: inherit;">Mais dans la vie, de temps en temps, vous devez toujours supprimer quelque chose, principalement des informations brutes ou interm√©diaires. </font><font style="vertical-align: inherit;">Bas√© sur expirationd, nous avons cr√©√© un m√©canisme pour nettoyer le stockage des donn√©es obsol√®tes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d9/1aa/e8d/4d91aae8daf9c27437ca9ed57574e349.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous comprenons √©galement que t√¥t ou tard, une situation se produira lorsqu'il n'y aura pas assez d'espace pour stocker des donn√©es en m√©moire, mais n√©anmoins les donn√©es doivent √™tre stock√©es. </font><font style="vertical-align: inherit;">√Ä ces fins, nous allons bient√¥t faire du stockage sur disque.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13a/10e/7da/13a10e7da6c77907d88504ee20fbb62c.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commenc√© par charger les donn√©es dans un mod√®le unique, nous avons pass√© trois mois sur son d√©veloppement. Nous avions six syst√®mes de fournisseurs de donn√©es. L'ensemble du code de transformation en un seul mod√®le repr√©sente environ 30 000 lignes en Lua. Et la plupart du travail reste √† venir. Parfois, il y a un manque de motivation pour les √©quipes voisines, ce qui complique beaucoup le travail des circonstances. Si jamais vous rencontrez un probl√®me similaire, alors le temps que vous pensez normal pour sa mise en ≈ìuvre, multipliez par trois, voire quatre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas non plus que les probl√®mes existants dans les processus m√©tier ne peuvent pas √™tre r√©solus √† l'aide d'un nouveau SGBD, m√™me s'il est tr√®s productif. Ce que je veux dire? Au d√©but de notre projet, nous avons cr√©√© une impression parmi les clients que nous allons maintenant apporter une nouvelle base de donn√©es rapide et en direct! Les processus iront plus vite, tout ira bien. En fait, la technologie ne r√©sout pas les probl√®mes qui existent dans les processus m√©tier, car les processus m√©tier sont des personnes. Et vous devez travailler avec les gens, pas avec la technologie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le d√©veloppement par des tests dans les √©tapes initiales peut √™tre douloureux et prendre du temps. Mais son effet positif sera perceptible m√™me √† court terme, lorsque vous n'aurez rien √† faire pour effectuer des tests de r√©gression.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est extr√™mement important d'effectuer des tests de charge √† toutes les √©tapes du d√©veloppement. Plus t√¥t vous remarquerez une sorte de faille dans l'architecture, plus il sera facile de la corriger, cela vous fera gagner beaucoup de temps √† l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a rien de mal avec Lua. Tout le monde peut apprendre √† √©crire dessus: un d√©veloppeur Java, un d√©veloppeur JavaScript, un d√©veloppeur Python, un front-end ou un back-end. Nous avons m√™me des analystes qui y √©crivent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous parlons du fait que nous n‚Äôavons pas SQL, cela terrifie les gens. "Comment obtenir des donn√©es sans SQL?" Est-ce possible? " Bien s√ªr. Sur un syst√®me de classes OLTP, SQL n'est pas n√©cessaire. Il existe une alternative sous la forme d'un langage qui vous renvoie imm√©diatement une vue orient√©e document. Par exemple, GraphQL. Et il existe une alternative sous la forme de calcul distribu√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous comprenez que vous devrez √©voluer, concevez imm√©diatement votre solution sur Tarantool afin qu'elle puisse fonctionner en parall√®le sur des dizaines d'instances Tarantool. </font><font style="vertical-align: inherit;">Sinon, ce sera difficile et douloureux, car Tarantool ne peut utiliser efficacement qu'un seul c≈ìur de processeur.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495310/index.html">Visite virtuelle: biom√©trie et multiformat</a></li>
<li><a href="../fr495312/index.html">S√©curit√© du p√©rim√®tre - l'avenir est maintenant</a></li>
<li><a href="../fr495314/index.html">Comment filtrer la d√©sinformation si elle provient de sources officielles?</a></li>
<li><a href="../fr495316/index.html">R√®gles de vie de l'√©quipe Carri√®re Habr Quarantaine</a></li>
<li><a href="../fr495324/index.html">√âcrire un g√©n√©rateur de stock al√©atoire de Mosbirzhe en JavaScript</a></li>
<li><a href="../fr495328/index.html">Comment ranger l'historique de vos commits dans Git</a></li>
<li><a href="../fr495330/index.html">Une popularit√© m√©rit√©e en chiffres</a></li>
<li><a href="../fr495332/index.html">Quatuor 9: Allegro | Manuscrit</a></li>
<li><a href="../fr495336/index.html">Discord en tant que messager d'entreprise et pas seulement</a></li>
<li><a href="../fr495338/index.html">Meilleures pratiques et directives pour le lancement de conteneurs et de Kubernetes dans des environnements de production</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>