<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💲 🐽 👵🏽 Comment avons-nous fait le cœur de l'activité d'investissement d'Alfa-Bank basée sur Tarantool 🕴🏻 💻 🛁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un cliché du film «Notre univers secret: la vie cachée de la cellule». L'
 
 investissement est l'un des domaines les plus difficiles du monde bancair...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment avons-nous fait le cœur de l'activité d'investissement d'Alfa-Bank basée sur Tarantool</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/495326/"><img src="https://habrastorage.org/webt/tc/or/26/tcor26cmqrsph9b0nioj_ic4cwa.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un cliché du film «Notre univers secret: la vie cachée de la cellule». L'</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
investissement est l'un des domaines les plus difficiles du monde bancaire, car il n'y a pas seulement des prêts, des prêts et des dépôts, mais aussi des titres, des devises, des biens, des dérivés et toutes sortes de difficultés sous forme de produits structurels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Récemment, nous avons constaté une augmentation de la littératie financière de la population. De plus en plus de personnes sont impliquées dans le trading sur les marchés des valeurs mobilières. Les comptes d'investissement individuels sont apparus il n'y a pas si longtemps. Ils vous permettent de négocier sur les marchés des valeurs mobilières et en même temps, de recevoir des déductions fiscales ou de ne pas payer d'impôts. Et tous les clients qui viennent chez nous veulent gérer leur portefeuille et voir des rapports en temps réel. De plus, le plus souvent, ce portefeuille est multi-produits, c'est-à-dire que les gens sont des clients de divers secteurs d'activité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les exigences des régulateurs, russes et étrangers, augmentent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour répondre aux besoins actuels et jeter les bases de futures mises à niveau, nous avons développé le cœur de l'activité d'investissement basé sur Tarantool.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques statistiques. </font><font style="vertical-align: inherit;">L’activité d’investissement d’Alfa-Bank fournit des services de courtage aux particuliers et aux personnes morales offrant la possibilité de négocier sur divers marchés de valeurs mobilières, des services de garde pour le stockage de titres, des services de gestion de fiducie pour les particuliers à capital privé et important, des services d’émission de titres pour les autres entreprises. </font><font style="vertical-align: inherit;">L’activité d’investissement d’Alfa-Bank représente plus de 3 000 devis par seconde, qui sont téléchargés à partir de diverses plateformes de trading. </font><font style="vertical-align: inherit;">Au cours de la journée de travail, plus de 300 000 transactions sont conclues sur les marchés pour le compte de la banque ou de ses clients. </font><font style="vertical-align: inherit;">Sur les plateformes externes et internes, jusqu'à 5 000 ordres sont exécutés par seconde. </font><font style="vertical-align: inherit;">En même temps, tous les clients, internes et externes, souhaitent voir leurs positions en temps réel.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque part depuis le début des années 2000, nos domaines d'investissement se sont développés de manière indépendante: le trading de change, les services de courtage, le trading de devises, le trading de gré à gré de titres et divers dérivés. En conséquence, nous sommes tombés dans le piège des puits fonctionnels. Ce que c'est? Chaque secteur d'activité a ses propres systèmes qui dupliquent les fonctions des autres. Chaque système a son propre modèle de données, bien qu'ils fonctionnent sur les mêmes concepts: transactions, instruments, contreparties, devis et plus encore. Et puisque chaque système s'est développé indépendamment, un zoo diversifié de technologies a vu le jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la base de code des systèmes est déjà dépassée, car certains produits sont originaires du milieu des années 90. Et dans certains domaines, cela a ralenti le processus de développement, il y avait des problèmes de productivité.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouvelles exigences de solution</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les entreprises ont réalisé que le développement technologique est vital pour le développement futur. </font><font style="vertical-align: inherit;">On nous a confié les tâches:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collectez toutes les données d'entreprise dans un seul stockage rapide et dans un modèle de données unique. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne devons pas perdre ou modifier ces informations. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est nécessaire de mettre à jour les données, car à tout moment le régulateur peut demander des statistiques pour les années précédentes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne devons pas simplement apporter de nouveaux SGBD à la mode, mais créer une plate-forme pour résoudre les problèmes commerciaux. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nos architectes fixent leurs conditions: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La nouvelle solution devrait être de classe entreprise, c'est-à-dire qu'elle devrait déjà être testée dans certaines grandes entreprises. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le mode de fonctionnement de la solution doit être critique pour la mission. </font><font style="vertical-align: inherit;">Cela signifie que nous devons être présents en même temps dans plusieurs centres de données et expérimenter calmement la déconnexion d'un centre de données.</font></font></li>
<li>    .   ,        ,       -    .   ,         . </li>
<li>    ,     . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons suivi la voie standard: formulé des exigences et contacté le service des achats. De là, nous avons obtenu une liste d'entreprises qui, en général, sont prêtes pour nous à le faire. Ils ont parlé de la tâche à tout le monde et six d'entre eux ont reçu une évaluation des solutions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la banque, nous ne croyons pas la parole de qui que ce soit, nous aimons tout tester par nous-mêmes. Par conséquent, une condition préalable à notre appel d'offres était de réussir des tests de résistance. Nous avons formulé des tâches de test pour la charge, et déjà trois entreprises sur six ont accepté à leurs propres frais de mettre en œuvre un prototype de la solution basée sur des technologies en mémoire pour la tester.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne dirai pas comment nous avons tout testé et combien de temps cela a pris, je résumerai seulement: les meilleures performances dans les tests de charge ont été démontrées par le prototype de la solution basée sur Tarantool de l'équipe de développement du groupe Mail.ru </font><font style="vertical-align: inherit;">Nous avons signé un contrat et commencé le développement. </font><font style="vertical-align: inherit;">Quatre personnes venaient du groupe Mail.ru et d'Alfa-Bank, il y avait trois développeurs, trois analystes système, un architecte de solution, un propriétaire de produit et un Scrum master. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, je vais parler de la façon dont notre système a grandi, comment il a évolué, ce que nous avons fait et pourquoi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous nous sommes demandé comment obtenir des données de nos systèmes actuels. Nous avons décidé que HTTP nous convenait tout à fait, car tous les systèmes actuels communiquent entre eux, envoyant XML ou JSON via HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons le serveur HTTP Tarantool intégré, car nous n'avons pas besoin de mettre fin aux sessions SSL, et ses performances nous suffisent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai déjà dit, nous avons tous les systèmes vivant dans différents modèles de données, et à l'entrée, nous devons apporter l'objet au modèle que nous décrirons à la maison. Un langage était nécessaire pour transformer les données. Nous avons choisi l'impératif Lua. Nous exécutons tout le code pour la conversion des données dans le bac à sable - c'est un endroit sûr, au-delà duquel le code en cours ne va pas au-delà. Pour ce faire, il suffit de faire une chaîne de chargement du code nécessaire, en créant un environnement avec des fonctions qui ne peuvent rien bloquer ou supprimer quelque chose.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e3/04c/45f/4e304c45ff56974d624be577ebb8258d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après la conversion, la conformité des données avec le modèle que nous créons doit être vérifiée. </font><font style="vertical-align: inherit;">Nous avons longuement discuté de ce que devrait être un modèle, du langage à utiliser pour le décrire. </font><font style="vertical-align: inherit;">Nous nous sommes arrêtés chez Apache Avro, car le langage est simple et il a le support de Tarantool. </font><font style="vertical-align: inherit;">De nouvelles versions du modèle et du code utilisateur peuvent être mises en service plusieurs fois par jour, même sous charge, même sans, à tout moment de la journée, et s'adapter très rapidement aux changements.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d28/172/bea/d28172beab19e37ef1fd30597d21d321.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après vérification, les données doivent être enregistrées. </font><font style="vertical-align: inherit;">Nous le faisons avec vshard (nous avons des répliques géo-espacées de fragments).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5a/619/7b4/d5a6197b44b2d8f1f43b33004241f221.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les spécificités sont telles que pour la plupart des systèmes qui nous envoient des données, peu importe que nous les ayons reçues ou non. Par conséquent, dès le début, nous avons mis en œuvre la ligne de réparation. Ce que c'est? Si, pour une raison quelconque, l'objet n'a pas réussi la transformation ou la vérification des données, nous confirmons toujours la réception, mais en même temps, nous enregistrons l'objet dans la file d'attente de réparation. Il est cohérent, situé dans le référentiel principal avec les données d'entreprise. Nous avons immédiatement écrit une interface d'administration pour cela, diverses mesures et alertes. En conséquence, nous ne perdons pas de données. Même si quelque chose a changé dans la source, si le modèle de données a changé, nous le trouverons immédiatement et nous pourrons nous adapter.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ad/2a7/c23/7ad2a7c235467068ccec89b9eb025b12.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant apprendre à récupérer des données stockées. Nous avons soigneusement analysé nos systèmes et constaté que sur la pile classique de Java et Oracle, il existe toujours une sorte d'ORM qui convertit les données d'une vue relationnelle en une vue objet. Alors pourquoi ne pas donner immédiatement des objets aux systèmes sous forme de graphe? Par conséquent, nous avons volontiers pris GraphQL, qui répondait à tous nos besoins. Il vous permet de recevoir des données sous forme de graphiques, de ne retirer que ce dont vous avez besoin en ce moment. Vous pouvez même versionner l'API avec suffisamment de flexibilité.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d90/636/a7a/d90636a7ac34c91eefd299a88d902d44.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque immédiatement, nous avons réalisé que les données extraites n'étaient pas suffisantes pour nous. </font><font style="vertical-align: inherit;">Nous avons créé des fonctions qui peuvent être attachées aux objets du modèle - en fait, des champs calculés. </font><font style="vertical-align: inherit;">Autrement dit, nous attachons une certaine fonction au champ, qui, par exemple, considère le prix moyen d'un devis. </font><font style="vertical-align: inherit;">Et le consommateur externe qui demande les données ne sait même pas que ce champ est calculé.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f77/51f/ce9/f7751fce9a424fa80aba0c701cb9295e.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implémentation d'un système d'authentification. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/768/d24/2f7/768d242f7825460594a79ff0c3e07449.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, ils ont remarqué que plusieurs rôles se sont cristallisés dans notre solution. </font><font style="vertical-align: inherit;">Un rôle est une sorte d'agrégateur de fonctions. </font><font style="vertical-align: inherit;">En règle générale, les rôles ont différents profils d'utilisation de l'équipement:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T-Connect: gère les connexions entrantes, limitées par le processeur, consomme peu de mémoire, ne stocke pas l'état.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IB-Core: transforme les données qu'il reçoit via le protocole Tarantool, c'est-à-dire qu'il fonctionne avec des tablettes. </font><font style="vertical-align: inherit;">Ne stocke pas non plus l'état et peut être mis à l'échelle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage: enregistre uniquement les données, n'utilise aucune logique. </font><font style="vertical-align: inherit;">Les interfaces les plus simples sont implémentées dans ce rôle. </font><font style="vertical-align: inherit;">Evolutif grâce à vshard.</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/66e/613/29266e613da2a34c5df9463884873267.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est-à-dire qu'avec l'aide de rôles, nous avons détaché les uns des autres différentes parties du cluster qui peuvent être mises à l'échelle indépendamment les unes des autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc créé un enregistrement asynchrone d'un flux de données transactionnelles et une file d'attente de réparation avec une interface administrateur. </font><font style="vertical-align: inherit;">L'enregistrement est asynchrone d'un point de vue commercial: si nous avons la garantie de nous enregistrer des données, peu importe où, nous le confirmerons. </font><font style="vertical-align: inherit;">Si ce n'est pas confirmé, alors quelque chose s'est mal passé, les données doivent être envoyées. </font><font style="vertical-align: inherit;">Il s'agit d'un enregistrement asynchrone.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dès le début du projet, il a été décidé d'essayer d'inculquer un développement piloté par les tests. Nous écrivons des tests unitaires en Lua en utilisant le framework tarantool / tap, des tests d'intégration en Python en utilisant le framework pytest. Dans le même temps, les développeurs et les analystes participent à la rédaction des tests d'intégration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment appliquer le développement piloté par les tests? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voulons une nouvelle fonctionnalité, nous essayons d'abord d'écrire un test pour cela. Après avoir découvert le bogue, nous devons d'abord écrire dans le test, puis le corriger. Au début, c'est difficile de travailler comme ça, il y a un malentendu de la part des employés, même du sabotage: "Corrigeons-le rapidement, faisons quelque chose de nouveau, puis couvrons-le avec des tests." Seul ce «plus tard» ne se produit presque jamais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, vous devez d'abord vous forcer à écrire des tests, demander aux autres de le faire. Croyez-moi, le développement piloté par les tests est bénéfique même à court terme. Vous sentirez qu'il est devenu plus facile pour vous de vivre. Selon nos sentiments, 99% du code est actuellement couvert par des tests. Cela semble beaucoup, mais nous n'avons aucun problème: les tests sont exécutés à chaque commit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous aimons avant tout les tests de résistance, nous les considérons comme les plus importants et les effectuons régulièrement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous raconter une courte histoire sur la façon dont nous avons effectué la première étape du test de charge d'une des premières versions. Nous avons placé le système sur l'ordinateur portable du développeur, allumé la charge et reçu 4 000 transactions par seconde. Bon résultat pour un ordinateur portable. Nous avons installé un support de charge virtuel de quatre serveurs, plus faible qu'en production. Déployé au minimum. Nous le démarrons et nous obtenons un résultat pire que sur un ordinateur portable dans un seul thread. Contenu choquant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous étions très tristes. Nous regardons la charge du serveur, et ils se révèlent inactifs.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0b/eba/0fa/a0beba0fad0ba7e8f0cf333ef8366948.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appelons les développeurs, et ils nous expliquent, des gens qui sont venus du monde Java, que Tarantool est monofil. </font><font style="vertical-align: inherit;">Il peut être utilisé efficacement par un seul cœur de processeur sous charge. </font><font style="vertical-align: inherit;">Ensuite, nous avons déployé le nombre maximal possible d'instances Tarantool sur chaque serveur, activé la charge et reçu déjà 14,5 mille transactions par seconde.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/67f/8ca/e14/67f8cae14bea588f5018d4406f99c23c.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais l'expliquer à nouveau. </font><font style="vertical-align: inherit;">En raison de la division en rôles qui utilisent les ressources différemment, nos rôles qui étaient responsables du traitement des connexions et de la transformation des données n'ont chargé que le processeur, et c'était strictement proportionnel à la charge.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9d1/822/cb3/9d1822cb3dcacd91f3f9fd7dbb7c9f7c.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f0/566/1b4/1f05661b4e5b7806867849b060dc23b7.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la mémoire n'était utilisée que pour le traitement des connexions entrantes et des objets temporaires.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/16e/e79/f9f/16ee79f9fbfd6157c7df6edd66b90535.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au contraire, sur les serveurs de stockage, la charge du processeur a augmenté, mais beaucoup plus lentement que sur les serveurs qui gèrent les connexions. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18b/0ad/d2d/18b0add2da6deda36388ca9b0f07594b.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la consommation de mémoire a augmenté en proportion directe de la quantité de données chargée. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e21/697/e05/e21697e0521f54530aa7c50227297af1.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prestations de service</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour développer notre nouveau produit spécifiquement en tant que plate-forme d'application, nous avons créé un composant pour y déployer des services et des bibliothèques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les services ne sont pas seulement de petits morceaux de code qui fonctionnent dans certains domaines. </font><font style="vertical-align: inherit;">Il peut s'agir de structures assez grandes et complexes qui font partie du cluster, vérifient les données de référence, déforment la logique métier et donnent des réponses. </font><font style="vertical-align: inherit;">Nous exportons également le schéma de service vers GraphQL, et le consommateur reçoit un point d'accès aux données universel, avec introspection dans tout le modèle. </font><font style="vertical-align: inherit;">C'est très confortable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que les services contiennent beaucoup plus de fonctions, nous avons décidé qu'il devrait y avoir des bibliothèques dans lesquelles nous supprimerons le code fréquemment utilisé. </font><font style="vertical-align: inherit;">Nous les avons ajoutés à un environnement sûr, après avoir vérifié que cela ne nous brise rien. </font><font style="vertical-align: inherit;">Et maintenant, nous pouvons définir des fonctions pour des environnements supplémentaires sous forme de bibliothèques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulions que nous ayons une plate-forme non seulement pour le stockage, mais aussi pour l'informatique. </font><font style="vertical-align: inherit;">Et puisque nous avions déjà un tas de répliques et de fragments, nous avons implémenté un semblant d'informatique distribuée et l'avons appelé map réduire, car il s'est avéré être comme la carte originale réduire.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anciens systèmes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous nos anciens systèmes ne peuvent pas nous appeler via HTTP et utiliser GraphQL, bien qu'ils prennent en charge ce protocole. </font><font style="vertical-align: inherit;">Par conséquent, nous avons créé un mécanisme pour répliquer les données sur ces systèmes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5d/6e5/e33/f5d6e5e33b10e605cf7c6c5befd4aa07.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si quelque chose change pour nous, des déclencheurs particuliers fonctionnent dans le rôle de stockage et le message avec les modifications tombe dans la file d'attente de traitement. </font><font style="vertical-align: inherit;">Il est envoyé à un système externe à l'aide d'un rôle de réplicateur distinct. </font><font style="vertical-align: inherit;">Ce rôle ne stocke pas l'état.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De nouvelles améliorations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous vous en souvenez, d'un point de vue commercial, nous avons fait un enregistrement asynchrone. </font><font style="vertical-align: inherit;">Mais ensuite, ils ont réalisé que ce ne serait pas suffisant, car il existe une classe de systèmes qui doivent recevoir immédiatement une réponse sur l'état de l'opération. </font><font style="vertical-align: inherit;">Par conséquent, nous avons étendu notre GraphQL et ajouté des mutations. </font><font style="vertical-align: inherit;">Ils s'inscrivent organiquement dans le paradigme existant de l'utilisation des données. </font><font style="vertical-align: inherit;">Nous avons un seul point de lecture et d'écriture pour une autre classe de systèmes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/395/562/ef7/395562ef7191842f4dc9526dae8c0661.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons également réalisé que les services seuls ne seraient pas suffisants pour nous, car il y a des rapports assez lourds qui doivent être élaborés une fois par jour, une semaine, un mois. Cela peut prendre du temps et les rapports peuvent même bloquer la boucle d'événement Tarantool. Par conséquent, nous avons créé des rôles distincts: planificateur et coureur. Les coureurs ne stockent pas l'état. Ils lancent des tâches difficiles que nous ne pouvons pas compter à la volée. Et le rôle de planificateur surveille le calendrier de lancement de ces tâches, qui est décrit dans la configuration. Les tâches elles-mêmes sont stockées au même endroit que les données d'entreprise. Lorsque le bon moment arrive, le planificateur prend la tâche, la donne à un coureur, il la considère et enregistre le résultat.</font></font><br>
 <br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb1/bbf/123/fb1bbf12343d40bab27a87b5f1021f0d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les tâches ne doivent pas être exécutées dans les délais. </font><font style="vertical-align: inherit;">Certains rapports doivent être lus sur demande. </font><font style="vertical-align: inherit;">Dès que cette exigence arrive, une tâche est formée dans le bac à sable et envoyée au runner pour exécution. </font><font style="vertical-align: inherit;">Après un certain temps, l'utilisateur reçoit une réponse asynchrone indiquant que tout a été calculé, le rapport est prêt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13f/27e/db0/13f27edb0711b735602d77c7c54c4d38.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, nous avons adhéré au paradigme de la sauvegarde de toutes les données, de la gestion des versions et de leur suppression. </font><font style="vertical-align: inherit;">Mais dans la vie, de temps en temps, vous devez toujours supprimer quelque chose, principalement des informations brutes ou intermédiaires. </font><font style="vertical-align: inherit;">Basé sur expirationd, nous avons créé un mécanisme pour nettoyer le stockage des données obsolètes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d9/1aa/e8d/4d91aae8daf9c27437ca9ed57574e349.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous comprenons également que tôt ou tard, une situation se produira lorsqu'il n'y aura pas assez d'espace pour stocker des données en mémoire, mais néanmoins les données doivent être stockées. </font><font style="vertical-align: inherit;">À ces fins, nous allons bientôt faire du stockage sur disque.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13a/10e/7da/13a10e7da6c77907d88504ee20fbb62c.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commencé par charger les données dans un modèle unique, nous avons passé trois mois sur son développement. Nous avions six systèmes de fournisseurs de données. L'ensemble du code de transformation en un seul modèle représente environ 30 000 lignes en Lua. Et la plupart du travail reste à venir. Parfois, il y a un manque de motivation pour les équipes voisines, ce qui complique beaucoup le travail des circonstances. Si jamais vous rencontrez un problème similaire, alors le temps que vous pensez normal pour sa mise en œuvre, multipliez par trois, voire quatre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas non plus que les problèmes existants dans les processus métier ne peuvent pas être résolus à l'aide d'un nouveau SGBD, même s'il est très productif. Ce que je veux dire? Au début de notre projet, nous avons créé une impression parmi les clients que nous allons maintenant apporter une nouvelle base de données rapide et en direct! Les processus iront plus vite, tout ira bien. En fait, la technologie ne résout pas les problèmes qui existent dans les processus métier, car les processus métier sont des personnes. Et vous devez travailler avec les gens, pas avec la technologie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le développement par des tests dans les étapes initiales peut être douloureux et prendre du temps. Mais son effet positif sera perceptible même à court terme, lorsque vous n'aurez rien à faire pour effectuer des tests de régression.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est extrêmement important d'effectuer des tests de charge à toutes les étapes du développement. Plus tôt vous remarquerez une sorte de faille dans l'architecture, plus il sera facile de la corriger, cela vous fera gagner beaucoup de temps à l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a rien de mal avec Lua. Tout le monde peut apprendre à écrire dessus: un développeur Java, un développeur JavaScript, un développeur Python, un front-end ou un back-end. Nous avons même des analystes qui y écrivent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous parlons du fait que nous n’avons pas SQL, cela terrifie les gens. "Comment obtenir des données sans SQL?" Est-ce possible? " Bien sûr. Sur un système de classes OLTP, SQL n'est pas nécessaire. Il existe une alternative sous la forme d'un langage qui vous renvoie immédiatement une vue orientée document. Par exemple, GraphQL. Et il existe une alternative sous la forme de calcul distribué.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous comprenez que vous devrez évoluer, concevez immédiatement votre solution sur Tarantool afin qu'elle puisse fonctionner en parallèle sur des dizaines d'instances Tarantool. </font><font style="vertical-align: inherit;">Sinon, ce sera difficile et douloureux, car Tarantool ne peut utiliser efficacement qu'un seul cœur de processeur.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495310/index.html">Visite virtuelle: biométrie et multiformat</a></li>
<li><a href="../fr495312/index.html">Sécurité du périmètre - l'avenir est maintenant</a></li>
<li><a href="../fr495314/index.html">Comment filtrer la désinformation si elle provient de sources officielles?</a></li>
<li><a href="../fr495316/index.html">Règles de vie de l'équipe Carrière Habr Quarantaine</a></li>
<li><a href="../fr495324/index.html">Écrire un générateur de stock aléatoire de Mosbirzhe en JavaScript</a></li>
<li><a href="../fr495328/index.html">Comment ranger l'historique de vos commits dans Git</a></li>
<li><a href="../fr495330/index.html">Une popularité méritée en chiffres</a></li>
<li><a href="../fr495332/index.html">Quatuor 9: Allegro | Manuscrit</a></li>
<li><a href="../fr495336/index.html">Discord en tant que messager d'entreprise et pas seulement</a></li>
<li><a href="../fr495338/index.html">Meilleures pratiques et directives pour le lancement de conteneurs et de Kubernetes dans des environnements de production</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>