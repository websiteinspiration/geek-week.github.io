<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝️ ✔️ 😯 Routing in komplexen Chatbots mit dem Hobot-Framework 👕 🚵 🔊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nachdem ich vor einigen Jahren mit der Entwicklung von Bots für Telegram begonnen hatte, entdeckte ich die Leistung, Einfachheit und Flexibilität der ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Routing in komplexen Chatbots mit dem Hobot-Framework</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/actualizebot/blog/489008/"><img src="https://habrastorage.org/webt/op/j7/ip/opj7ipookzxpfhtdfi1x_8cln2w.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich vor einigen Jahren mit der Entwicklung von Bots für Telegram begonnen hatte, entdeckte ich die Leistung, Einfachheit und Flexibilität der Arbeit mit ihnen als Sonderfall der Befehlszeilenschnittstelle. </font><font style="vertical-align: inherit;">Diese Eigenschaften, die vielen heute zur Verfügung stehen, sind größtenteils auf das beliebte telegraf.js-Framework und dergleichen zurückzuführen, das vereinfachte Methoden für die Arbeit mit der Telegramm-API bietet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig liegt die Architektur des Projekts vollständig auf den Schultern des Entwicklers, und gemessen an der bescheidenen Anzahl komplexer und multifunktionaler Bots haben wir in dieser Hinsicht noch Raum für Wachstum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel möchte ich über ein kleines Chatbot-Routing-Framework sprechen, ohne das die Entwicklung unseres Projekts unmöglich wäre.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einige grundlegende Informationen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Chatbots und CLIs besteht die Ausführung einer logischen Aktion häufig aus mehreren Verfeinerungsschritten oder Verzweigungsschritten. Dazu muss das Programm eine bestimmte Koordinate speichern, um sich zu merken, wo sich der Benutzer im Fluss befindet, und seinen Befehl gemäß dieser Koordinate ausführen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die einfachste Darstellung ist die Ausführung des Befehls </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">npm init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bei dem Sie vom Programm aufgefordert werden, nacheinander die einen oder anderen Daten für package.json anzugeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im ersten Schritt teilt sie dem Benutzer mit, dass sie auf die Texteingabe des Paketnamens wartet - und was der Benutzer ihr mit dem nächsten Befehl sendet, wird dank der Variablen, in die diese Wartezeit geschrieben ist, als Paketname gespeichert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir nennen diesen variablen Pfad - den Pfad, an den dieser oder jener Code logisch angehängt ist. </font><font style="vertical-align: inherit;">Es wird immer benötigt, wenn der Bot in wenigen Schritten über eine Navigation oder Befehle verfügt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die heutige Praxis in der Bot-Architektur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Ansatz , </font><font style="vertical-align: inherit;">dass ich zum </font><font style="vertical-align: inherit;">ersten Mal auf von anderen Entwicklern sah sah wie folgt aus </font><font style="vertical-align: inherit;">: für jedes Update vom Benutzer kommt, wird </font><font style="vertical-align: inherit;">eine Liste von Schecks für einen bestimmten Wert des </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pfad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Variable geschrieben </font><font style="vertical-align: inherit;">und Geschäftslogik und die </font><font style="vertical-align: inherit;">weitere Navigation innerhalb dieser Überprüfungen in der elementarsten Form gelegt:</font></font><br>
<br>
<pre><code class="javascript hljs">onUserInput(ctx, input) {
    <span class="hljs-keyword">switch</span>(ctx.session.path) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'firstPath'</span>:
	    <span class="hljs-keyword">if</span> (input === <span class="hljs-string">'!'</span>) {
               <span class="hljs-comment">// -  </span>
	        ctx.reply(<span class="hljs-string">'!'</span>);<font></font>
	        ctx.session.path = <span class="hljs-string">'secondPath'</span>;<font></font>
	    } <span class="hljs-keyword">else</span> {<font></font>
	        ctx.reply(<span class="hljs-string">' "!"'</span>);<font></font>
	    }<font></font>
	    <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'...'</span>:
       	    <span class="hljs-comment">//   </span><font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie nur ein paar Teams und ein paar Schritte für jedes Team haben, ist diese Lösung optimal. </font><font style="vertical-align: inherit;">Erreichen Sie das dritte und das siebte Team, wenn Sie glauben, dass etwas schief geht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In einem der Bots, mit denen wir zu einem späten Zeitpunkt arbeiten konnten, bestand der Kern der Funktion aus einem Blatt mit 4000 Zeilen und ~ 70 Bedingungen nur der obersten Ebene, die aus zwei Wenns hervorgegangen waren, mit einer Überprüfung dessen, was uns zu Herzen ging - manchmal Pfade, manchmal Befehle, manchmal Pfade und Befehle. </font><font style="vertical-align: inherit;">Alle diese Bedingungen wurden für jede Benutzeraktion überprüft und auf Hilfsfunktionen von einem benachbarten Blattobjekt zugegriffen, das ebenfalls aus mehreren Zeilen wuchs. </font><font style="vertical-align: inherit;">Muss ich sagen, wie langsam und wattig dieses Projekt ging?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hobot-Rahmen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Starten von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ActualizeBot haben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir uns bereits vorgestellt, wie groß es sein würde, und unsere erste Aufgabe bestand darin, die Erweiterbarkeit und Geschwindigkeit der Entwicklung beizubehalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zweck haben wir die Client-Logik in Controller unterteilt, die den Pfaden zugewiesen sind, und eine kleine Abstraktion geschrieben, um zwischen diesen Controllern zu navigieren und die vom Benutzer in ihnen empfangenen Nachrichten zu verarbeiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All dies, basierend auf großen Projekten, wurde in TypeScript geschrieben und erhielt den eleganten Namen Hobot, was natürlich auf Navigationspipelines anspielt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Controller ist ein einfaches Objekt mit drei Eigenschaften:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pfad</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Zeichenfolgenkennung des Pfads, der zum Initialisieren und Navigieren der initialisierten Pfade verwendet wird</font></font></li>
<li><b>get</b> — ,  ,           <i>hobot.gotoPath(ctx, path, data?)</i>.             —   <i>data</i>   ,            </li>
<li><b>post</b> —  .   ,      ,    .     updateType —    ,    : <i>text</i>, <i>callback_query</i>   . updateType     <i>ctx</i>     </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Controller-Beispiel:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> anotherController = {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'firstPath'</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">async</span> (ctx, data) =&gt; 
        <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">'Welcome to this path! Say "Hi"'</span>),
    <span class="hljs-attr">post</span>: <span class="hljs-keyword">async</span> (ctx, updateType) =&gt; {
        <span class="hljs-comment">//     : text / callback_query / etc...</span>
        <span class="hljs-keyword">if</span> (updateType === updateTypes.text &amp;&amp; ctx.update.message.text === <span class="hljs-string">'Hi'</span>) {
            <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">"Thank you!"</span>);
            <span class="hljs-comment">// hobot       this:</span>
            <span class="hljs-keyword">this</span>.hobot.gotoPath(ctx, <span class="hljs-string">'secondPath'</span>, { <span class="hljs-attr">userJustSaid</span>: <span class="hljs-string">"Hi"</span> });<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//     ,       </span>
            <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">'We expect "Hi" text message here'</span>);<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht etwas komplizierter aus als am Anfang, aber die Schwierigkeit bleibt gleich, wenn Sie 100 oder 200 Pfade haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die interne Logik ist trivial </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und es ist überraschend, dass dies noch niemand getan hat</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Controller werden einem Objekt hinzugefügt, dessen Schlüssel die Werte der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pfadeigenschaft sind,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und werden von diesen Schlüsseln während Benutzeraktionen oder beim Navigieren mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hobot.gotoPath (ctx, path, data? )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Navigation wird in einer separaten Methode zugewiesen, um den variablen Pfad und die Navigationslogik nicht zu berühren, sondern nur an die Geschäftslogik zu denken, obwohl Sie ctx.session.path jederzeit mit Ihren Händen ändern können, was natürlich nicht empfohlen wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles, was Sie tun müssen, um Ihren neuen Bot mit unzerstörbarer Struktur zum Laufen zu bringen, ist, einen regulären Telegraf-Bot zu starten und ihn und das Konfigurationsobjekt an den Hobot-Konstruktor zu übergeben. </font><font style="vertical-align: inherit;">Das Konfigurationsobjekt besteht aus den Controllern, die Sie initialisieren möchten, dem Standardpfad und den Befehls- / Controller-Paaren.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   telegraf-</span>
<span class="hljs-keyword">const</span> bot = <span class="hljs-keyword">new</span> Telegraf(<span class="hljs-string">'_'</span>);<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hobot = <span class="hljs-keyword">new</span> Hobot(bot, {
    <span class="hljs-attr">defaultPath</span>: <span class="hljs-string">'firstPath'</span>,
    <span class="hljs-attr">commands</span>: [
        <span class="hljs-comment">//  ,     </span>
        <span class="hljs-comment">// get    :</span>
        { <span class="hljs-attr">command</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'firstPath'</span> }<font></font>
    ],<font></font>
    <span class="hljs-attr">controllers</span>: [
        <span class="hljs-comment">// -,    </span><font></font>
        startController,<font></font>
        nextController<font></font>
    ]<font></font>
});<font></font>
<font></font>
<span class="hljs-comment">// C telegraf-,       </span><font></font>
bot.launch();<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschließend</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implizite Vorteile der Aufteilung eines Blattes in Controller:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Möglichkeit, isolierte Funktionen, Methoden und Schnittstellen, die an die Logik dieses Controllers gebunden sind, in separaten Dateien in der Nähe der Controller abzulegen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deutlich reduziertes Risiko, versehentlich alles zu beschädigen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modularität: Ein- / Ausschalten / Geben eines bestimmten Teils des Publikums Diese oder jene Logik kann einfach durch Hinzufügen und Entfernen von Controllern zum Array erfolgen, einschließlich durch Aktualisieren der Konfiguration ohne Programmierung - dafür müssen wir natürlich ein paar Buchstaben schreiben, da wir dies noch nicht getan haben erreicht</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Fähigkeit, dem Benutzer klar zu sagen, was genau von ihm erwartet wird, wenn er (was häufig vorkommt) am Ende der Verarbeitung nach der Methode etwas falsch macht - und dies dort, wo dies der Ort ist</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere Pläne</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel beschreibt das grundlegende Skript für die Arbeit mit Hobot für Textnachrichten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn sich das Thema als relevant herausstellt, werden wir in zukünftigen Artikeln weitere technische Feinheiten des Frameworks und unsere Beobachtungen aus der Praxis der Entwicklung und Verwendung von Telegramm-Bots teilen. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Links</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Die </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation des Bots sieht folgendermaßen aus: </font></font><code>npm i -s hobot</code><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit exemplarischer Anleitung in README.MD und dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sandbox </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready-Bot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der in der Produktion auf der Basis von Hobot arbeitet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank für Ihre Aufmerksamkeit. Ich freue mich über Ihre Fragen, Vorschläge oder Ideen für neue Bots!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de488994/index.html">DDR5? Ja, wir haben DDR4 kaum getroffen</a></li>
<li><a href="../de488998/index.html">Warum KI-Anforderungen die Sache nur noch schlimmer machen können</a></li>
<li><a href="../de489000/index.html">So montieren Sie einen coolen Mitap: 16 Tipps von drei „Serien-Mitapern“. Leader-IT-Veranstaltungen # 1</a></li>
<li><a href="../de489002/index.html">Verteilte Radsatzregistrierung: Erfahrung mit Hyperledger Fabric</a></li>
<li><a href="../de489004/index.html">Handy mit Disc Dialer</a></li>
<li><a href="../de489010/index.html">Wir teilen die größte Datenschicht in Russland zum Online-Lernen mit Projekten in den Bereichen Linguistik, Personalisierung, Peddesign, ML</a></li>
<li><a href="../de489012/index.html">Google Cloud Spanner: gut, schlecht, böse</a></li>
<li><a href="../de489014/index.html">Das Buch „Perfekter Algorithmus. Gierige Algorithmen und dynamische Programmierung »</a></li>
<li><a href="../de489016/index.html">German Gref: „Wir haben versucht, eine Diskussion über die AGI zu organisieren, und kein einziger Wissenschaftler mit Selbstachtung ist dazu gekommen.“</a></li>
<li><a href="../de489020/index.html">Das Studium eines böswilligen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>