<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏨 📞 🦐 Kein Tag ohne Sport: Neuprogrammierung eines chinesischen Herzfrequenzmessers 🤱 😹 🤘🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Hören Sie, welche Herzfrequenz sollten Sie beim Joggen haben?" 
 - Nun, ich weiß nicht - 150 Treffer. 
 - Ja? Warum habe ich 840? 
 - 840 pro Minute ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kein Tag ohne Sport: Neuprogrammierung eines chinesischen Herzfrequenzmessers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493384/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hören Sie, welche Herzfrequenz sollten Sie beim Joggen haben?" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Nun, ich weiß nicht - 150 Treffer. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Ja? Warum habe ich 840? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- 840 pro Minute ?! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Und was musste man in einer Minute überlegen oder was? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Was haben Sie gedacht?" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Nun, ich habe nur gezählt, bis ich mich verlaufen habe ... Also, okay, ich habe nachgezählt." </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(Film "Wahltag") </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast genau über den chinesischen Herzfrequenzmesser. Wie das Sprichwort sagt, wenn Sie etwas gut machen wollen, dann machen Sie es selbst. Und wenn das Gerät nicht so funktioniert, wie es benötigt wird, kann es dann möglicherweise verbessert werden?</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fe/pp/23/fepp230sxqy_lyvvcnoihcc1_ey.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viele Sportinteressierte überwachen ihre Herzfrequenz während des Trainings. </font><font style="vertical-align: inherit;">Hierzu werden Herzfrequenzmesser verwendet. </font><font style="vertical-align: inherit;">Es ist nicht die Aufgabe dieses Artikels, alle ihre Typen zu berücksichtigen, aber einer der zuverlässigsten und bewährten sind Brustpulssensoren, die elektrische Signale vom Herzen empfangen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Zusammenhang mit meiner stark erhöhten körperlichen Aktivität wurde auch der </font><font style="vertical-align: inherit;">Kyto 2809- </font></font><abbr title="Pulsschlag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Herzfrequenzmesser</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erworben </font><font style="vertical-align: inherit;">. Der Puls ist gut, aber es bestand Bedarf an einer genauen Messung der RR-Intervalle. </font><font style="vertical-align: inherit;">Der Herzfrequenzmesser unterstützt zwei Protokolle: ANT + und BLE. </font><font style="vertical-align: inherit;">Gemäß den Spezifikationen übertragen beide zusätzlich zur direkten Herzfrequenz die Dauer der RR-Intervalle.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was sind RR-Intervalle?</font></font></b><div class="spoiler_text">RR  –     R    .<br>
<br>
<img src="https://habrastorage.org/webt/yd/in/ea/ydineadtr4darurwgdkucttqlse.png"><br>
 RR   ,  .     .        ,   (.    «  RR »   « »).         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Daten von beiden Kanälen aufzuzeichnen, wurde eine Android-Anwendung geschrieben, die Ihren Anforderungen mit einem Datenprotokoll für Textdateien entspricht. </font><font style="vertical-align: inherit;">Ein analoger Herzfrequenzmesser wurde als mehr oder weniger adäquater Standard gesendet und sendete ein Signal mit einer Frequenz von 5,3 kHz, das über ein Arduino direkt mit einem PC verbunden war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Vergleich war etwas traurig.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kf/yp/xw/kfypxwjqzbjd1jif9yp-dh9kto0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das „Gerät“ für einen echten Herzschlag zeigte 4-5 nicht vorhanden (auf der blauen Grafik sehen Sie eine Fülle von Punkten). </font><font style="vertical-align: inherit;">Der Puls leuchtet selbst unter Berücksichtigung der möglichen Mittelung nicht genau. </font><font style="vertical-align: inherit;">Über das Messen von RR-Sprachintervallen geht das überhaupt nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Kommunikation mit dem Hersteller brachte keine Ergebnisse. </font><font style="vertical-align: inherit;">Zusätzlich zu mehreren Videos, Versuchen, mich davon zu überzeugen, dass alles in Ordnung ist, und Sätzen: "KYTO2809-Herzfrequenzdaten sind korrekt!", Habe ich nichts von ihnen bekommen. </font><font style="vertical-align: inherit;">Dann fiel sein Blick mit Schraubenziehern auf die Schachtel. </font><font style="vertical-align: inherit;">Als ich das Gehäuse öffnete, entdeckte ich den nRF51422-Chip.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/au/wi/0b/auwi0bchg8cuiqj74jaz-elv49g.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ich wusste, dass es ein SDK für diese MKs gibt, beschloss ich, es erneut zu flashen. </font><font style="vertical-align: inherit;">Dort wird das einfachste Programm benötigt: Vom elektrischen Signalverstärker des Herzens (ein schwarzer Tropfen auf dem Foto) geht das Signal zum MK-Eingang, und dann ist es eine technische Angelegenheit, dass wir die Impulse durch Interrupts abfangen, die Zeit zwischen ihnen messen und all dies über BLE und ANT + ausgeben. </font><font style="vertical-align: inherit;">Alles ist einfach, aber anscheinend ist bei den chinesischen Programmierern etwas schief gelaufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Chips werden über SWD programmiert. </font><font style="vertical-align: inherit;">Die native Firmware war vor dem Lesen geschützt. </font><font style="vertical-align: inherit;">Daher wurde ohne zu zögern der Befehl </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Format c:"</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "--eraseall" ausgeführt. </font><font style="vertical-align: inherit;">Die Karte zeigt sogar die entsprechenden Kontakte an. </font><font style="vertical-align: inherit;">Eingang vom Verstärker der elektrischen Signale des Herzens P0.07. </font><font style="vertical-align: inherit;">Die Pinbelegung des BLE-Moduls selbst lautet (von oben nach unten):</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.30</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.00</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.01</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.02</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.03</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.04</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.05</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.06</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.07</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.08</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das SDK enthält viele Beispiele, die ausreichen, um Ihre eigene Firmware zu schreiben. Der Chip ist ziemlich alt und das SDK dafür ist ebenfalls veraltet, Version 10. Mit ihnen wurden die BLE-Dienste auf dem Herzfrequenzmesser erhöht: Geräteinformationen, Batteriedienst, Herzfrequenz. Für ANT + wurde ein HeartRate-Profil hinzugefügt. Wir messen RR-Intervalle mit einem Timer und senden Daten an die Profile BLE und ANT +. Um bei Abwesenheit externer Reize (innerhalb von 5 Sekunden) Ladung zu sparen, wird der Herzfrequenzmesser in den Schlafmodus versetzt. Wenn ein Impuls auftritt (Unterbrechungen am Eingang), wacht der MK auf. In der Firmware des Herstellers übertrug Kyto2809 ständig Werbepakete über BLE, d. H. Wenn nur der ANT + -Kanal verwendet wurde, sendete BLE weiterhin Pakete und leerte den Akku. Ich habe die Werbezeit auf 5 Minuten begrenzt, was sich positiv auf die Rentabilität auswirken dürfte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tests haben gezeigt, dass es für den Parameter "Berechnete Herzfrequenz" besser ist, eine Filterung (absichtlich ungenaue Daten verwerfen, d. H. Einen Impuls unter 30 und über 240) und eine Mittelwertbildung mit einem gleitenden Durchschnitt einzuführen. Der endgültige Vergleich mit dem analogen Herzfrequenzmesser unten. Unterschiede in den Messungen von RR-Intervallen von 0-2 ms, was durchaus akzeptabel ist.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aa/rw/qw/aarwqwkdl2sg16sbflzjv2itsw0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Von nützlichen Funktionen wurde die Möglichkeit zum Aktualisieren der OTA-Firmware (ursprünglicher Name DFU OTA) hinzugefügt. </font><font style="vertical-align: inherit;">Nachdem Sie den OTA-Bootloader vernäht haben, können Sie die Firmware jetzt problemlos aktualisieren, wenn Sie etwas im Code ändern möchten. </font><font style="vertical-align: inherit;">Die Firmware wird vom Smartphone über das proprietäre Dienstprogramm nRFConnect erstellt. </font><font style="vertical-align: inherit;">Wenn ich mich nicht irre, können Sie OTA-Unterstützung in Ihrer Android-Anwendung vornehmen. Dafür gibt es Bibliotheken. </font><font style="vertical-align: inherit;">Um den Bootloader im Speicher zu füllen, müssen Sie leider eine Verbindung über SWD herstellen, weil </font><font style="vertical-align: inherit;">OTA wurde ursprünglich nicht vom Hersteller bereitgestellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firmware-Reihenfolge:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir nähen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SoftDevice310</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es ist BLE und ANT + ein Stapel von Nordic;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir nähen Kyto_DFU_bootloader.hex (der Fall kann zusammengebaut werden);</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Füllen Sie über nRFConnect das fertige Paket kyto_hr_dfu.zip</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die letzten beiden Dateien sind </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es gibt auch Firmware ohne OTA (KytoHR.hex).</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493374/index.html">Coronavirus - praktische Tipps und ein bisschen Theorie</a></li>
<li><a href="../de493376/index.html">The Big Initiative Theory - Russische Erfahrung in der digitalen Transformation von Industrieunternehmen</a></li>
<li><a href="../de493378/index.html">Steam hat Sie: Wie die digitale Verbreitung unsere Spiele wegnimmt</a></li>
<li><a href="../de493380/index.html">Julia und Quantencomputer</a></li>
<li><a href="../de493382/index.html">.NET Core Windows Forms Designer-Updates</a></li>
<li><a href="../de493386/index.html">Wie wird Coronavirus behandelt?</a></li>
<li><a href="../de493390/index.html">Einführung in .NET 5 Vorschau 1</a></li>
<li><a href="../de493392/index.html">Maschinelles Lernen in Kasan oder wie Fachkräfte für maschinelles Lernen in Tatarstan ausgebildet werden</a></li>
<li><a href="../de493394/index.html">Gottes Syndrom: Die Geschichte, wie sich der Hauptspezialist für Infektionskrankheiten des Coronavirus Stavropol Territory verbreitete (a) *</a></li>
<li><a href="../de493396/index.html">Zusammenfassung zu Prognosemethoden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>