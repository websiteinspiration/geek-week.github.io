<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏂🏿 ⏹️ 🤚 CSE：vCloudのすべてのユーザーのためのKubernetes 👷🏻 👨🏾‍🎤 🧑🏿‍🤝‍🧑🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは！
 
 偶然ではありませんが、最近のことは言うまでもなく、私たちの小規模な開発チームが急成長し、一部の（そして長期的にはすべての）製品をKubernetesに移行するようになりました。
 
 これには多くの理由がありましたが、私たちの話はホリバーについてではありません。
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CSE：vCloudのすべてのユーザーのためのKubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/linxdatacenter/blog/472752/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/pk/0v/u9/pk0vu9vp36lten5zgvswrtyzpl8.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みなさん、こんにちは！</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
偶然ではありませんが、最近のことは言うまでもなく、私たちの小規模な開発チームが急成長し、一部の（そして長期的にはすべての）製品をKubernetesに移行するようになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これには多くの理由がありましたが、私たちの話はホリバーについてではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャーに関しては、私たちにはほとんど選択肢がありませんでした。 vCloud DirectorおよびvCloud Director。新しいバージョンを選択し、開始することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、「ハードな方法」を調べたところ、昨日、少なくとも基本的なプロセス（展開やサイジングなど）を自動化するツールが必要であるという結論に至りました。 Googleに深く没頭すると、VMware Container Service Extension（CSE）などの製品が明らかになりました。これは、vCloudでのk8sクラスターの作成とサイジングを自動化できるオープンソース製品です。</font></font><a name="habracut"></a><br>
<blockquote>Disclaimer: CSE   ,       .      ,       open-source,       :)</blockquote><br>
<h2>  CSE</h2><br>
<ol>
<li>        vCloud    routed-  . <i><b>:</b>          ,    Firewall/NAT.</i><br>
<br>
   .     10.0.240.0/24:<br>
<br>
<img src="https://habrastorage.org/webt/lz/3i/0e/lz3i0euak9ln8kfp1fmbwuobcdi.png"><br>
<blockquote>       - ,   VPN     .    SSL-VPN,   Edge Gateway  .</blockquote></li>
<li>   CSE  ,      k8s.         <s> </s> ,   . <br>
<br>
    Python  3.7.3      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">vcd-cli</a>,      .<br>
<br>
<pre><code class="bash hljs">pip3 install vcd-cli<font></font>
<font></font>
pip3 install container-service-extension<font></font>
</code></pre></li>
<li>    CSE   :<br>
<br>
<pre><code class="plaintext hljs"># vcd cse version<font></font>
Error: No such command "cse".<font></font>
</code></pre><br>
,  .</li>
<li> , CSE      vcd-cli.<br>
     vcd-cli   :<br>
 <br>
<pre><code class="plaintext hljs"># vcd login MyCloud.provider.com org-dev admin<font></font>
Password: <font></font>
admin logged in, org: 'org-dev', vdc: 'org-dev_vDC01'<font></font>
</code></pre></li>
<li>  vcd-cli    <i>~/.vcd-cli/profiles.yaml</i><br>
     :<br>
<br>
<pre><code class="plaintext hljs">extensions:<font></font>
  - container_service_extension.client.cse<font></font>
</code></pre></li>
<li>   :<br>
<br>
<pre><code class="plaintext hljs"># vcd cse version<font></font>
CSE, Container Service Extension for VMware vCloud Director, version 2.5.0<font></font>
</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントのインストールフェーズが完了しました。</font><font style="vertical-align: inherit;">最初のクラスターをデプロイしてみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタの導入</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CSEにはいくつかの使用パラメーターのセットがあり、そのすべてを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a><font style="vertical-align: inherit;">で表示でき</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初に、将来のクラスターにパスワードなしでアクセスするためのキーを作成します。</font><font style="vertical-align: inherit;">デフォルトでは、ノードのパスワード入力は無効になるため、この点は重要です。</font><font style="vertical-align: inherit;">また、キーを指定しない場合、仮想マシンコンソールを介して多くの作業を行うことができますが、これは便利なことではありません。</font></font><br>
<br>
<pre><code class="plaintext hljs"># ssh-keygen<font></font>
Generating public/private rsa key pair.<font></font>
Enter file in which to save the key (/root/.ssh/id_rsa): <font></font>
Created directory '/root/.ssh'.<font></font>
Enter passphrase (empty for no passphrase): <font></font>
Enter same passphrase again: <font></font>
Your identification has been saved in /root/.ssh/id_rsa.<font></font>
Your public key has been saved in /root/.ssh/id_rsa.pub.<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターの作成を開始します。</font></font><br>
<br>
<pre><code class="bash hljs">vcd cse cluster create MyCluster --network k8s_cluster_net --ssh-key ~/.ssh/id_rsa.pub --nodes 3 --<span class="hljs-built_in">enable</span>-nfs</code></pre></li>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーが発生した</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合</font><i><font style="vertical-align: inherit;">：セッションの有効期限が切れているか、ユーザーがログインしていません。</font></i><i><font style="vertical-align: inherit;">再度ログインしてください。</font></i><font style="vertical-align: inherit;">-上記のようにvcd-cliをvCloudに再度ログインし、再試行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回は、すべて問題なく、クラスターを作成するタスクが開始されました。</font></font><br>
<br>
<pre><code class="bash hljs">cluster operation: Creating cluster vApp <span class="hljs-string">'MyCluster'</span> (38959587-54f4-4a49-8f2e-61c3a3e879e0) from template <span class="hljs-string">'photon-v2_k8-1.12_weave-2.3.0'</span> (revision 1)
</code></pre></li>
<li>     20 .      .<br>
<blockquote><ul>
<li>--network —    .</li>
<li>--ssh-key —   ,      .</li>
<li>--nodes n —  Worker  .    ,   CSE.</li>
<li>--enable-nfs —     NFS   persistent volumes.   ,   ,   ,    .</li>
</ul><br>
</blockquote></li>
<li>   vCloud      .<br>
<br>
<img src="https://habrastorage.org/webt/x0/ni/qk/x0niqksfidmbunupuflf61u7qww.png"></li>
<li>     ,    .</li>
<li>    <i>vcd cse cluster info MyCluster</i>.<br>
<br>
<img src="https://habrastorage.org/webt/fx/4m/tj/fx4mtj6uzscxl3pns7shd8lni6a.png"></li>
<li>        <i>kubectl</i>.<br>
<br>
<pre><code class="plaintext hljs"># vcd cse cluster config MyCluster &gt; ./.kube/config
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、それを使用してクラスターのステータスを確認できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/1k/58/vu1k58dcahsedsulmu_vixrstge.png"></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それほど単純ではない</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、クラスターは、永続的なボリュームがあるストーリーではないとしても、条件付きで動作していると見なすことができます。</font><font style="vertical-align: inherit;">私たちはvCloudにいるので、vSphereプロバイダーの使用は失敗します。</font><font style="vertical-align: inherit;">オプション</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--enable-nfs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこの問題を解決するように設計されていますが、最後まで機能しませんでした。</font><font style="vertical-align: inherit;">手動調整が必要です。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開始するには、ノードでvCloudに個別の独立ディスクを作成する必要があります。</font><font style="vertical-align: inherit;">これにより、データが削除されても、クラスターとともにデータが消えないようになります。</font><font style="vertical-align: inherit;">また、ドライブをNFSに接続します。</font></font><br>
<br>
<pre><code class="plaintext hljs"># vcd disk create nfs-shares-1 100g --description 'Kubernetes NFS shares'<font></font>
# vcd vapp attach mycluster nfsd-9604 nfs-shares-1<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その後、sshを実行します（実際にキーを作成しましたか？）NFSノードに接続し、最後にディスクを接続します。</font></font><br>
<br>
<pre><code class="plaintext hljs">root@nfsd-9604:~# parted /dev/sdb<font></font>
(parted) mklabel gpt<font></font>
Warning: The existing disk label on /dev/sdb will be destroyed and all data on<font></font>
this disk will be lost. Do you want to continue?<font></font>
Yes/No? yes<font></font>
(parted) unit GB<font></font>
(parted) mkpart primary 0 100<font></font>
(parted) print<font></font>
Model: VMware Virtual disk (scsi)<font></font>
Disk /dev/sdb: 100GB<font></font>
Sector size (logical/physical): 512B/512B<font></font>
Partition Table: gpt<font></font>
Disk Flags:<font></font>
<font></font>
Number  Start   End    Size   File system  Name     Flags<font></font>
 1      0.00GB  100GB  100GB               primary<font></font>
<font></font>
(parted) quit<font></font>
root@nfsd-9604:~# mkfs -t ext4 /dev/sdb1<font></font>
Creating filesystem with 24413696 4k blocks and 6111232 inodes<font></font>
Filesystem UUID: 8622c0f5-4044-4ebf-95a5-0372256b34f0<font></font>
Superblock backups stored on blocks:<font></font>
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,<font></font>
	4096000, 7962624, 11239424, 20480000, 23887872<font></font>
<font></font>
Allocating group tables: done<font></font>
Writing inode tables: done<font></font>
Creating journal (32768 blocks): done<font></font>
Writing superblocks and filesystem accounting information: done<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ用のディレクトリを作成し、そこに新しいセクションをマウントします。</font></font><br>
<br>
<pre><code class="plaintext hljs">mkdir /export<font></font>
echo '/dev/sdb1  /export   ext4  defaults   0 0' &gt;&gt; /etc/fstab<font></font>
mount -a<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5つのテストセクションを作成し、クラスター用に共有します。</font></font><br>
<br>
<pre><code class="bash hljs">&gt;<span class="hljs-built_in">cd</span> /<span class="hljs-built_in">export</span><font></font>
&gt;mkdir vol1 vol2 vol3 vol4 vol5<font></font>
&gt;vi /etc/exports<font></font>
<span class="hljs-comment">#    </span>
/<span class="hljs-built_in">export</span>/vol1 *(rw,sync,no_root_squash,no_subtree_check)<font></font>
/<span class="hljs-built_in">export</span>/vol2 *(rw,sync,no_root_squash,no_subtree_check)<font></font>
/<span class="hljs-built_in">export</span>/vol3 *(rw,sync,no_root_squash,no_subtree_check)<font></font>
/<span class="hljs-built_in">export</span>/vol4 *(rw,sync,no_root_squash,no_subtree_check)<font></font>
/<span class="hljs-built_in">export</span>/vol5 *(rw,sync,no_root_squash,no_subtree_check)
<span class="hljs-comment">#:wq! ;)</span>
<span class="hljs-comment"># -  </span><font></font>
&gt;exportfs -r<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このすべての魔法の後、次のように私たちのクラスターでPVとPVCを作成できます：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PV</font></font></b><br>
<br>
<pre><code class="bash hljs">cat &lt;&lt;EOF | kubectl apply -f -<font></font>
apiVersion: v1<font></font>
kind: PersistentVolume<font></font>
metadata:<font></font>
  name: nfs-vol1<font></font>
spec:<font></font>
  capacity:<font></font>
    storage: 10Gi<font></font>
  accessModes:<font></font>
    - ReadWriteMany<font></font>
  nfs:<font></font>
    <span class="hljs-comment"># Same IP as the NFS host we ssh'ed to earlier.</span><font></font>
    server: 10.150.200.22<font></font>
    path: <span class="hljs-string">"/export/vol1"</span><font></font>
EOF<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">塩ビ</font></font></b><br>
<br>
<pre><code class="bash hljs">cat &lt;&lt;EOF | kubectl apply -f -<font></font>
apiVersion: v1<font></font>
kind: PersistentVolumeClaim<font></font>
metadata:<font></font>
  name: nfs-pvc<font></font>
spec:<font></font>
  accessModes:<font></font>
    - ReadWriteMany<font></font>
  storageClassName: <span class="hljs-string">""</span><font></font>
  resources:<font></font>
    requests:<font></font>
      storage: 10Gi<font></font>
EOF<font></font>
</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、1つのクラスターの作成のストーリーが終了し、そのライフサイクルの履歴が始まります。</font><font style="vertical-align: inherit;">おまけとして、時々</font><font style="vertical-align: inherit;">リソース</font><font style="vertical-align: inherit;">を節約できるかどう</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かにかかわらず</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、さらに2つの便利なCSEコマンドがあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#    8  </span><font></font>
&gt;cse cluster resize MyCluster --network k8s_cluster_net --nodes 8<font></font>
<font></font>
<span class="hljs-comment">#        </span><font></font>
&gt;vcd cse node delete MyCluster node-1a2v node-6685 --yes<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご質問がある場合は、コメントをお寄せください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472738/index.html">既存のプロジェクトをASP.NET MVCからASP.NET Coreにアップグレードする方法。実用ガイド</a></li>
<li><a href="../ja472744/index.html">MRPが機能しない...代替手段は何ですか？</a></li>
<li><a href="../ja472746/index.html">管理者用のターミナルサーバー。単一のSSHギャップではない</a></li>
<li><a href="../ja472748/index.html">セマンティックブラウザまたはサイトのない生活</a></li>
<li><a href="../ja472750/index.html">OK、本当にKubernetesが必要ですか？</a></li>
<li><a href="../ja472754/index.html">月に英語を話す方法。9つの簡単で実績のあるステップ</a></li>
<li><a href="../ja472758/index.html">提案：try-組み込みのエラーチェック機能</a></li>
<li><a href="../ja472760/index.html">計算時間を数年から数分に短縮します。量子機械学習について</a></li>
<li><a href="../ja472766/index.html">py.testのファイルからのパラメーター化</a></li>
<li><a href="../ja472768/index.html">採用、解雇、管理から開発に戻る方法：Badoo Techleads Meetup＃5のビデオ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>