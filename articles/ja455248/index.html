<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔊 🎋 👩🏼‍🤝‍👨🏿 PostgreSQLを使用する際の開発ミスのトップ 🕜 🗽 🐨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++は長い間存在しており、PostgreSQLを定期的に使用することについて話し合っています。しかし、開発者は月ごと、年ごとに同じ問題を抱えています。 DBAがいない状態の小規模な企業でデータベースの操作にエラーが発生した場合、これは当然のことです。大企業もデータベースを必要とし、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLを使用する際の開発ミスのトップ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/455248/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は長い間存在しており、PostgreSQLを定期的に使用することについて話し合っています。しかし、開発者は月ごと、年ごとに同じ問題を抱えています。 DBAがいない状態の小規模な企業でデータベースの操作にエラーが発生した場合、これは当然のことです。大企業もデータベースを必要とし、デバッグされたプロセスを使用しても、エラーが発生し、データベースが機能しなくなります。会社の規模は関係ありません。エラーが引き続き発生し、データベースが定期的にクラッシュします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k7/dz/pb/k7dzpbs_rg2wat7ac4awvar2h-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これは決して起こりませんが、チェックリストを確認することは難しくありません。将来の神経を節約することは非常に適切です。猫の下に、PostgreSQLを操作する際に開発者が犯す典型的な間違いをリストし、なぜこれを行う必要がないのかを見て、その方法を見つけます。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HjLnY0aPQZo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">講演者について：アレクセイレソフスキー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レソフスキー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）Linuxシステム管理者として開始。</font><font style="vertical-align: inherit;">仮想化と監視システムのタスクから徐々にPostgreSQLに来ました。</font><font style="vertical-align: inherit;">現在</font><font style="vertical-align: inherit;">&nbsp;、多数の異なるプロジェクトで作業し、繰り返し発生する問題の多くの例を見ているコンサルティング会社、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Egretの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PostgreSQL DBA&nbsp; </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、</font><font style="vertical-align: inherit;">HighLoad ++ 2018でのレポートのプレゼンテーションへの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題はどこから来ますか</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウォームアップのために、エラーが発生する方法に関するいくつかのストーリー。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史1.特徴</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題の1つは、同社がPostgreSQLを操作するときに使用する機能です。</font><font style="vertical-align: inherit;">すべてはシンプルに始まります：PostgreSQL、データセット、JOINによるシンプルなクエリ。</font><font style="vertical-align: inherit;">データを取得してSELECTを実行します-すべてが簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、PostgreSQLの追加機能を使用し始め、新しい関数や拡張機能を追加します。</font><font style="vertical-align: inherit;">機能が大きくなっています。</font><font style="vertical-align: inherit;">ストリーミングレプリケーション、シャーディングを接続します。</font><font style="vertical-align: inherit;">周りにはさまざまなユーティリティとボディキットがあります-pgbouncer、pgpool、patroni。</font><font style="vertical-align: inherit;">そのように。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_i/kr/an/_ikran7pf4ni9e4hyxiwptuhwy4.png"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各キーワードは、エラーが表示される理由です。</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史2.データ保存</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの保存方法もエラーの原因です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトが最初に登場したとき、そこにはかなりの数のデータとテーブルがあります。</font><font style="vertical-align: inherit;">データを受信して​​記録するには、単純なクエリで十分です。</font><font style="vertical-align: inherit;">しかし、テーブルはますます増えています。</font><font style="vertical-align: inherit;">データはさまざまな場所から選択され、JOINが表示されます。</font><font style="vertical-align: inherit;">クエリは複雑で、CTEコンストラクト、SUBQUERY、INリスト、LATERALが含まれます。</font><font style="vertical-align: inherit;">ミスをして、カーブクエリを作成する方がはるかに簡単になります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ff9/37e/620/ff937e6202947bba4393531475868c74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これは氷山の一角に過ぎません-側のどこかに、別の400のテーブル、パーティションがあり、そこからデータが時々読み込まれます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史3.ライフサイクル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
製品がどのようにフォローされているかについてのストーリー。データは常にどこかに保存する必要があるため、常にデータベースが存在します。製品が開発されると、データベースはどのように開発されますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方で、</font><font style="vertical-align: inherit;">プログラミング言語で忙しい</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">者がいます。彼らは、サービスに注意を払うことなく、アプリケーションを作成し、ソフトウェア開発の分野でスキルを開発します。多くの場合、彼らはKafkaやPostgreSQLがどのように機能するかに興味がありません-彼らはアプリケーションの新機能を開発し、残りは気にしません。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/056/1c3/00a/0561c300abe5623898768ad7d334a334.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理者</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。彼らはベアメタルで新しいAmazonインスタンスを発生させ、自動化で忙しくしています：彼らはレイアウトがうまく機能するようにデプロイメントをセットアップし、サービスが互いにうまく相互作用するように設定します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/961/3f5/8fb/9613f58fb950f69b235d5b80cc29e1b4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンポーネントとデータベースのシンチューニングを行う時間や欲求がない場合があります。</font><font style="vertical-align: inherit;">データベースはデフォルトの設定で動作しますが、「設定は機能します。触れないでください」ということを忘れてしまいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、熊手はさまざまな場所に散らばっており、時々開発者の額に飛び込んでいます。</font><font style="vertical-align: inherit;">この記事では、これらすべてのレーキを1つの小屋に集めて、それらについて理解し、PostgreSQLで作業するときに攻撃しないようにします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">計画と監視</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、私たちが新しいプロジェクトを持っていると想像してください-それは常にアクティブな開発、仮説テスト、新機能の実装です。</font><font style="vertical-align: inherit;">アプリケーションが登場して開発が進んでいる現時点では、トラフィック、ユーザー、顧客はほとんどなく、すべて少量のデータを生成しています。</font><font style="vertical-align: inherit;">データベースには、迅速に処理される単純なクエリがあります。</font><font style="vertical-align: inherit;">大量のデータをドラッグする必要はなく、問題はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、より多くのユーザーがいると、トラフィックが発生します。新しいデータが表示され、データベースが増大し、古いクエリが機能しなくなります。</font><font style="vertical-align: inherit;">インデックスを完成させ、クエリを書き直して最適化する必要があります。</font><font style="vertical-align: inherit;">パフォーマンスの問題があります。</font><font style="vertical-align: inherit;">これらはすべて、午前4時に警告を発し、管理者のストレスと管理者の不満につながります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どうしましたか？</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の経験では、ほとんどの場合、十分なディスクがありません。</font></font></blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の例</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ディスク使用率を監視するスケジュールを開くと、ディスクの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空き領域が不足し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ていることがわかり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/65b/245/c83/65b245c834e20a94ed7e698b08cfabaf.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのくらいのスペースと何が消費されるかを調べます。pg_xlogディレクトリがあることがわかります。</font></font><br>
<br>
<pre><code class="plaintext hljs">$&nbsp;du -csh -t 100M /pgdb/9.6/main/*<font></font>
15G	/pgdb/9.6/main/base<font></font>
58G	/pgdb/9.6/main/pg_xlog<font></font>
72G	</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベース管理者は通常、このディレクトリが何であるかを知っており、彼らはそれに触れません-それは存在し、存在します。</font><font style="vertical-align: inherit;">しかし、開発者、特にステージングを見る場合、頭を</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かいて</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考えます：</font><i><font style="vertical-align: inherit;">-ある種のログ... pg_xlogを削除しましょう！</font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクトリを削除すると、データベースは動作を停止します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">トランザクションログを削除した後、すぐにデータベースを上げる方法をグーグルする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2b8/1af/30c/2b81af30c865d529e6f7ff3fd66339ce.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目の例</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">繰り返しになりますが、監視を開くと十分なスペースがないことがわかります。</font><font style="vertical-align: inherit;">今度はその場所はある種の基地で占められています。</font></font><br>
<br>
<pre><code class="plaintext hljs">$&nbsp;du -csh -t 100M /pgdb/9.6/main/*<font></font>
70G	/pgdb/9.6/main/base<font></font>
2G	/pgdb/9.6/main/pg_xlog<font></font>
72G	</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのデータベースが最も多くのスペースを占めているか、どのテーブルとインデックスかを探しています。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d88/ffc/4e9/d88ffc4e98ca1fd4648ac7aea1c8d019.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは履歴ログを含むテーブルであることがわかります。履歴ログは必要ありませんでした。それらは念のため書かれており、その場所に問題がなければ、誰もが再来まで見ないでしょう：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-すべてを片付けましょう、mm ... 10月より古いです！</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
更新リクエストを作成して実行すると、機能し、一部の行が削除されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">=# DELETE FROM history_log<font></font>
-# WHERE created_at &lt; «2018-10-01»;<font></font>
DELETE 165517399<font></font>
Time: 585478.451&nbsp;ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリは10分間実行されますが、テーブルは依然として同じ量のスペースを占有します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLはテーブルから行を削除します-すべてが正しいですが、オペレーティングシステムに場所を返しません。 PostgreSQLのこの動作は、ほとんどの開発者には知られておらず、非常に驚​​くべきことです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3番目の例</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。たとえば、ORMは興味深いリクエストを出しました。通常、全員がORMを非難して、いくつかのテーブルを読み取る「悪い」クエリを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複数のスレッドでテーブルを並列に読み取るいくつかのJOIN操作があるとします。</font><font style="vertical-align: inherit;">PostgreSQLはデータ操作を並列化し、複数のスレッドでテーブルを読み取ることができます。</font><font style="vertical-align: inherit;">しかし、複数のアプリケーションサーバーがある場合、このクエリはすべてのテーブルを1秒あたり数千回読み取ります。</font><font style="vertical-align: inherit;">データベースサーバーが過負荷になっていて、ディスクが処理できないこと</font><font style="vertical-align: inherit;">がわかりました。</font><font style="vertical-align: inherit;">これにより</font><font style="vertical-align: inherit;">、バックエンドからの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">502 Bad Gateway</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーが発生</font><font style="vertical-align: inherit;">します-データベースは利用できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それだけではありません。</font><font style="vertical-align: inherit;">PostgerSQLの他の機能を呼び出すことができます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBMSバックグラウンドプロセスのブレーキ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-PostgreSQLには、あらゆる種類のチェックポイント、バキューム、レプリケーションがあります。</font></font><br>
</li>
<li><b>  &nbsp;</b>.    &nbsp; , &nbsp;&nbsp;      , &nbsp;   &nbsp;.<br>
</li>
<li><b> &nbsp;  NoName</b>,    &nbsp; &nbsp;   ,  ,     ,  .  .<br>
</li>
<li><b> </b>.    :  ,  &nbsp;  &nbsp;— , &nbsp;&nbsp;  .  &nbsp;,    PostgreSQL   ,  <b> &nbsp;  </b>.  , , &nbsp;    &nbsp;  , &nbsp;  ,   .<br>
</li>
</ul><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの場合、PostgreSQLにはディスク容量またはディスクパフォ​​ーマンスのいずれかがありません。</font><font style="vertical-align: inherit;">幸いなことに、プロセッサ、メモリ、ネットワークでは、原則として、すべてが多かれ少なかれ秩序です。</font></font></blockquote> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
になる方法 </font><font style="vertical-align: inherit;">監視と計画が必要です！</font><font style="vertical-align: inherit;">当たり前のように見えるかもしれませんが、何らかの理由で、ほとんどの場合、誰もベースを計画していません。また、PostgreSQLの運用中に監視する必要があるすべてを監視することはできません。</font><font style="vertical-align: inherit;">「ランダム」ではなく、すべてが適切に機能する一連の明確なルールがあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">企画</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSDでデータベースをためらうことなくホストします</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 SSDは長い間、信頼性、安定性、生産性が向上しています。エンタープライズSSDモデルは何年も前から存在しています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常にデータスキーマを計画します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。何が必要であるかを疑うデータベースに書き込まないでください-不要であることが保証されています。簡単な例は、顧客の1人を少し変更したテーブルです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9e1/56f/9ec/9e156f9ec534a11c5e80180c1c72a987.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、jsonタイプのデータ列があるログテーブルです。比較的言えば、このコラムには何でも書ける。このテーブルの最後のレコードから、ログが8 MBを占めていることがわかります。 PostgreSQLは、この長さのレコードを保存しても問題ありません。 PostgreSQLには、そのような記録を噛む非常に優れたストレージがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、問題は、アプリケーションサーバーがこのテーブルからデータを読み取るときに、ネットワーク帯域幅全体を簡単に詰まらせ、他の要求が影響を受けることです。これは、データスキーマの計画の問題です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2年以上保存する必要があるストーリーのヒントには、パーティションを使用します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。パーティショニングは時々複雑に思われます-パーティションを作成する関数を使用して、トリガーに悩まされる必要があります。 PostgreSQLの新しいバージョンでは、状況が改善され、パーティション化の設定がはるかに簡単になりました-一度実行すれば機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10分でデータを削除するという考えられる例では、データを</font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">置き換えることができ</font></font><code>DROP TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。同様の状況でのこのような操作には数ミリ秒しかかかりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データがパーティションでソートされると、パーティションは文字どおり数ミリ秒で削除され、OSはすぐに置き換えられます。</font><font style="vertical-align: inherit;">履歴データの管理はより簡単、簡単、そして安全です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニタリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
監視は別の大きなトピックですが、データベースの観点からは、記事の1つのセクションに当てはまる推奨事項があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、多くの監視システムがプロセッサ、メモリ、ネットワーク、ディスク容量の監視を提供しますが、原則として、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスクデバイスの処分はありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ディスクの負荷に関する情報、現在ディスク上にある帯域幅、および待機時間の値を常に監視に追加する必要があります。</font><font style="vertical-align: inherit;">これにより、ドライブのロード方法をすばやく評価できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLの監視オプションはたくさんあります。</font><font style="vertical-align: inherit;">存在しなければならないいくつかのポイントはここにあります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続されているクライアント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">どのステータスを使用しているかを監視し、データベースに悪影響を与える「有害な」顧客をすばやく見つけて、それらをオフにする必要があります。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">データベースがどのように機能するかを監視するには、エラーを監視する必要があります。エラーなし-すばらしい、エラーが表示されました-ログを見て、何が問題なのかを理解し始める理由。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト（ステートメント）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リクエストの量的および質的特性を監視して、遅い、長い、またはリソースを大量に消費するリクエストがあるかどうかを大まかに評価します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
詳細については、</font><font style="vertical-align: inherit;">HighLoad ++ Siberiaを使用し</font><font style="vertical-align: inherit;">た</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「PostgreSQLモニタリングの基本」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポート</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">PostgreSQL Wikiの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニタリング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページを参照</font><font style="vertical-align: inherit;">して</font><font style="vertical-align: inherit;">ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを計画し、監視で「自分自身を覆った」とき、まだいくつかの問題に遭遇する可能性があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、開発者は構成にデータベース行を表示します。</font><font style="vertical-align: inherit;">彼は、それが内部でどのように配置されているか、つまりチェックポイント、レプリケーション、スケジューラがどのように機能するかに特に関心がありません。</font><font style="vertical-align: inherit;">開発者はすでにやるべきことを持っています-todoには、彼が試してみたい面白いことがたくさんあります。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「基地の住所を教えてください、それから私自身です。」</font><font style="vertical-align: inherit;">©匿名の開発者。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この件名を知らないと、開発者がこのデータベースで機能するクエリを書き始めると、非常に興味深い結果がもたらされます。クエリを作成するときの幻想は、驚くべき効果をもたらすことがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションには2つのタイプがあります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OLTPトランザクション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;は高速で、短く、軽量で、数ミリ秒しかかかりません。彼らは非常に速く運動し、それらの多くがあります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OLAP-分析クエリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-遅く、長く、重い、テーブルの大きな配列を読み取り、統計を読み取ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
過去2〜3年は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTAP-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;ハイブリッドトランザクション/分析処理または</font><b><font style="vertical-align: inherit;">ハイブリッドトランザクション分析処理と</font></b><font style="vertical-align: inherit;">略されることが多い</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 OLAPおよびOLTPリクエストのスケーリングと多様性について考える時間がない場合は、「HTAPがあります！」しかし、経験とエラーの痛みは、長いOLAP要求が軽いOLTP要求をブロックするため、結局のところ、異なるタイプの要求が互いに別々に存在する必要があることを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ですから、負荷を分散するためにPostgreSQLをどのようにスケーリングするかという問題に行き、誰もが満足しました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミングレプリケーション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。最も簡単なオプションは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミングレプリケーション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。アプリケーションがデータベースと連携する場合、いくつかのレプリカをこのデータベースに接続し、負荷を分散します。記録は引き続きマスターベースに送られ、レプリカに読み取られます。この方法を使用すると、非常に広範囲にスケーリングできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、より多くのレプリカを個々のレプリカに接続して、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスケードレプリケーション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。読み取り分析などの個別のユーザーグループまたはアプリケーションは、個別のレプリカに移動できます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7f4/5b3/2d7/7f45b32d7eeb8dfcd7e19cfb38210134.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">論理的なパブリケーション、サブスクリプション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-論理的なパブリケーションとサブスクリプションのメカニズムは、別個のデータベースとテーブルのセットを持ついくつかの独立したPostgreSQLサーバーの存在を意味します。これらのテーブルのセットは、隣接するデータベースに接続でき、通常使用できるアプリケーションに表示されます。つまり、ソースで発生したすべての変更が宛先ベースに複製され、そこに表示されます。 PostgreSQL 10で最適に動作します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/13a/4aa/068/13a4aa06893b4ae9f1a1b7523c407b06.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部テーブル、宣言型パーティション-宣言型パーティションと外部テーブル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">複数のPostgreSQLを使用して、目的のデータ範囲を格納するテーブルのセットをいくつか作成できます。</font><font style="vertical-align: inherit;">これは、特定の年のデータまたは任意の範囲で収集されたデータです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/109/929/cb9/109929cb936d0c040651ad30c130258b.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部テーブルのメカニズムを使用して、これらすべてのデータベースをパーティションテーブルとして別のPostgreSQLに組み合わせることができます。</font><font style="vertical-align: inherit;">アプリケーションはすでにこのパーティションテーブルで動作している可能性がありますが、実際にはリモートパーティションからデータを読み取ります。</font><font style="vertical-align: inherit;">データボリュームが単一サーバーの機能を超える場合、これはシャーディングです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/446/d13/a39/446d13a394143b988ec04f60e645ea21.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてを組み合わせてさまざまなPostgreSQLレプリケーショントポロジを作成することができますが、すべてがどのように機能し、それを管理する方法は、別のレポートのトピックです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どこから始めますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も簡単なオプションは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レプリケーション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。最初のステップは、読み取りと書き込みの負荷を分散することです。つまり、マスターに書き込み、レプリカから読み取ります。したがって、負荷をスケーリングし、ウィザードからの読み取りを実行します。さらに、アナリストのことを忘れないでください。分析クエリは長時間機能します。長い分析クエリが他のクエリに干渉しないように、個別の設定を持つ個別のレプリカが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のステップは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バランシング</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。設定には、開発者が操作するのと同じ行がまだあります。彼は、彼が読み書きする場所を必要としています。ここにはいくつかのオプションがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理想的- </font><b><font style="vertical-align: inherit;">アプリケーションレベルの</font></b><font style="vertical-align: inherit;">バランスを実装</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション自体がどこからデータを読み取るかを知っていて、レプリカの選択方法を知っているとき。</font><font style="vertical-align: inherit;">アカウント残高は常に最新の状態で必要であり、マスターから読み取る必要があるとします。製品の写真やそれに関する情報を少し遅れて読み取ることができ、レプリカから実行できます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の意見では、</font><b><font style="vertical-align: inherit;">DNSラウンドロビン</font></b><font style="vertical-align: inherit;">は、非常に便利な実装ではありません。フェイルオーバーが発生した場合に、サーバー間でウィザードの役割を切り替えるときに長時間動作し、必要な時間が与えられないためです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より興味深いオプションは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KeepalivedとHAProxy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用すること</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">マスターセットとレプリカセットの仮想アドレスはHAProxyサーバー間でスローされ、HAProxyはすでにトラフィックを分散しています。</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の意見では、Patroni </font><b><font style="vertical-align: inherit;">、DCS</font></b><font style="vertical-align: inherit;">、ZooKeeperなどの何かと組み合わせたConsul-最も興味深いオプションです。</font><font style="vertical-align: inherit;">つまり、サービスディスカバリは、誰が現在マスターで誰がレプリカであるかという情報に責任があります。</font><font style="vertical-align: inherit;">PatroniはPostgreSQL'ovのクラスターを管理し、切り替えを実行します。トポロジが変更された場合、この情報はサービスディスカバリに表示され、アプリケーションは現在のトポロジをすばやく見つけることができます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、レプリケーションには微妙なニュアンスがあり、その最も一般的なものは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レプリケーションラグ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">あなたはGitLabのようにそれを行うことができ、ラグが蓄積したら、ベースをドロップするだけです。</font><font style="vertical-align: inherit;">しかし、私たちは包括的な監視を行っています。それを見て、長いトランザクションを確認します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/619/9a0/fae/6199a0fae7ed88fb1646e232cc1f2953.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションとDBMSトランザクション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、低速でアイドル状態のトランザクションは、次の結果になります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生産性の低下</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-鋭いけいれん発作ではなく、滑らかに;</font></font><br>
</li>
<li><b> &nbsp;</b>,       &nbsp; &nbsp;   ;<br>
</li>
<li><b> HTTP 50*&nbsp; </b>, &nbsp; &nbsp;  - .<br>
</li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題がどのように発生するか、そして長時間のアイドル状態のトランザクションのメカニズムが有害である理由についての小さな理論を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLにはMVCCがあります。比較的、データベースエンジンです。これにより、顧客は互いに干渉せずにデータを競争的に処理できます。リーダーはリーダーに干渉せず、ライターはライターに干渉しません。もちろん、いくつかの例外がありますが、この場合は重要ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つの行のデータベースでは、さまざまなトランザクションに対して複数のバージョンが存在する可能性があることがわかりました。クライアントは接続し、データベースはそれらにデータのスナップショットを提供し、これらのスナップショット内に同じ行の異なるバージョンが存在する場合があります。したがって、データベースのライフサイクルでは、トランザクションがシフトされ、相互に置き換えられ、行のバージョンは誰も必要としないように見えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そう発生します</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガベージコレクターの必要性は自動真空</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">長いトランザクションが存在し、自動バキュームが不要な行バージョンを消去するのを防ぎます。</font><font style="vertical-align: inherit;">このジャンクデータは、メモリからディスクへ、ディスクからメモリへと移動し始めます。</font><font style="vertical-align: inherit;">このゴミを保存するために、CPUとメモリのリソースが浪費されます。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションが長くなるほど、迷惑メールが増え、パフォーマンスが低下します。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「だれが責任を負うのか」という観点からすると、このアプリは長いトランザクションの出現を非難することになります。データベースが単独で存在する場合、何もしないトランザクションはどこからも取得されません。実際には、アイドルトランザクションの表示には次のオプションがあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「外部ソースに行きましょう</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">」</font></b><font style="vertical-align: inherit;">アプリケーションはトランザクションを開き、データベースで何かを実行してから、MemcachedやRedisなどの外部ソースを使用して、データベースに戻り、作業を続行してトランザクションを閉じることを決定します。ただし、外部ソースでエラーが発生した場合、アプリケーションはクラッシュし、トランザクションは誰かがそれに気づいて強制終了するまで閉じられたままになります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー処理なし</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。一方、エラーの処理に問題がある可能性があります。再び、アプリケーションがトランザクションを開き、データベースの問題を解決し、コード実行に戻り、トランザクションでの作業を継続して閉じるために、いくつかの関数と計算を実行しました。これらの計算でアプリケーションの操作がエラーで中断された場合、コードはサイクルの最初に戻り、トランザクションは再び開いたままでした。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒューマンファクター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。たとえば、管理者、開発者、アナリストは、いくつかのpgAdminまたはDBeaverで作業します-トランザクションを開いて、その中で何かを行います。その後、その人は気が散り、別のタスクに切り替え、次に3番目のタスクに切り替え、トランザクションを忘れて週末に向けて行ったが、トランザクションはハングし続けた。基本的なパフォーマンスが低下します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのケースで何をすべきか見てみましょう。</font></font><br>
<br>
<ul>
<li>&nbsp;  , ,  <b> &nbsp;</b>.  ,     &nbsp; &nbsp;&nbsp;—  ,   , &nbsp;,  &nbsp;.</li>
<li> &nbsp;— <b>     &nbsp;</b> (pg_terminate_backend(pid))   &nbsp; PostgreSQL.    &nbsp;10-30&nbsp;,     .</li>
<li><b> </b>. &nbsp;,  ,   idle ,    &nbsp;  .</li>
</ul><br>
<blockquote>    ,       &nbsp;  .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
保留中のタスクが表示されると、すべてがさらに面白くなります。たとえば、単位を慎重に計算する必要があります。</font><font style="vertical-align: inherit;">そして、自転車の建設の問題に行きます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自転車建設</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不愉快なトピック。アプリケーション側のビジネスは、イベントのバックグラウンド処理を実行する必要があります。たとえば、集計を計算するには：最小値、最大値、平均値、ユーザーへの通知の送信、顧客への請求、登録後のユーザーアカウントの設定、または近隣サービスへの登録-処理の遅延。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなタスクの本質は同じです-彼らは後で延期されます。キューを実行するだけのテーブルがデータベースに表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ef4/bfa/f20/ef4bfaf20634c6d43941c9c8325a09ff.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、タスクの識別子、タスクが作成された時刻、更新されたとき、それを取得したハンドラー、完了の試行回数です。このテーブルにリモートで類似しているテーブルがある場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自己書き込みキューがあります</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長いトランザクションが表示されるまで、これはすべて正常に機能します。その後、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューで機能するテーブルのサイズは大きくなり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。常に新しいジョブが追加され、古いジョブが削除され、更新が行われます-集中的に記録されたテーブルが取得されます。パフォーマンスが低下しないように、古いバージョンの文字列から定期的に削除する必要があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理時間が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;長くなります-長いトランザクションは古いバージョンの行をロックするか、バキュームがそれをクリーニングするのを妨げます。テーブルのサイズが大きくなると、ガベージで多くのページを読み取る必要があるため、処理時間も増加します。時間は増加し、&nbsp; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある時点でキューはまったく機能しなくなります</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、キューを持っていたお客様のトップの例です。すべてのリクエストはキューに関連しています。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/344/203/7ac/3442037ac837daec02ee89a83bd53dd7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのリクエストの実行時間に注意してください-1つを除くすべてが20秒以上動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題を解決するために</font><font style="vertical-align: inherit;">&nbsp;、PostgreSQLのキューマネージャである</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skytools PgQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が古くから発明されました</font><font style="vertical-align: inherit;">。自転車を再発明しないでください-PgQを取り、一度セットアップして、ラインのことを忘れてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに、彼には特徴もあります。 Skytools PgQには</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><b><font style="vertical-align: inherit;">ほとんど</font></b><font style="vertical-align: inherit;">あり</font><b><font style="vertical-align: inherit;">ません</font></b><font style="vertical-align: inherit;">。公式ページを読んだところ、何もわからなかった気がします。何かしようとすると気持ちが高まります。すべてが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能しますが</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、&nbsp; </font><b><font style="vertical-align: inherit;">どのように機能するかは明確ではありません</font></b><font style="vertical-align: inherit;">。ジェダイの魔法のようなもの。しかし、多くの情報は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メーリングリスト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これはあまり便利な形式ではありませんが、興味深いことがたくさんあり、これらのシートを読む必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
短所にもかかわらず、Skytools PgQは「セットアップして忘れる」という原則に基づいて機能します。</font><font style="vertical-align: inherit;">変更を受け取りたいテーブルに掛けられているトリガー関数が作成され、すべてが確実に機能します。</font><font style="vertical-align: inherit;">キューに別のテーブルを追加する必要があるときは、PgQについてほとんど覚えています。</font><font style="vertical-align: inherit;">PgQの使用は、個々のブローカーのサポートと設定よりも安価です。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰かが遭遇した可能性が最も高いタスクに直面している場合は、すでに発明されたツールを探してください。</font><font style="vertical-align: inherit;">これは特にキューに当てはまります。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの練習では、多くの自己記述型バーストを確認し、それらをPgQに置き換えました。</font><font style="vertical-align: inherit;">もちろん、PostgreSQLの大規模なインストールがあります。たとえば、PgQの機能では不十分なAvitoなどです。</font><font style="vertical-align: inherit;">ただし、これらは個別に決定される単一のケースです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オートメーション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動化の管理者は、インスタンスをロールアウトして、介入がなくてもデプロイが機能し、構成が即座にロールアウトできるようにしたいと考えています。そして、開発者は、いくつかの変更をコミットするとすぐに、自分自身を引き上げ、テストし、流出させ、すべてがうまくいくような方法で、デプロイメントが機能することを望んでいます。もちろん、手動で介入することなく移行をロールバックしたいので、サーバーにログインして手で変更を実行する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは一緒に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動フェイルオーバー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を望ん</font><font style="vertical-align: inherit;">&nbsp;でいます-PostgreSQLクラスターの操作中に突然何らかの障害が発生した場合、ウィザードの役割は自動的に別のサーバーに転送され、それについて何も知りませんでした。しかし、自動フェイルオーバーの使用を妨げるいくつかの非常に深刻な問題があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スプリットブレイン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。マスターと複数のレプリカを持つ通常のPostgreSQLクラスターでは、書き込みは1つのサーバーに行われ、レプリカから読み取られます。障害が発生した場合、サーバーはシャットダウンします。しかし、PostgreSQLには、すぐに使用できるフェンシングメカニズムはありません。また、多くの場合、Kubernetsでも、個別に構成する必要があります。アプリケーションがクラッシュした場合でも、古いマスターに書き込むことができ、新しいスイッチングアプリケーションが新しいマスターへの書き込みを開始します。スプリットブレインの状況があります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/327/239/97e/32723997e13e8427e4cddc59ea7c964f.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一貫性を回復しようとすることは非常に困難であり、多くの神経を必要とします。 GitHubがスプリットブレインと衝突したとき、バックアップからベースを復元する必要がありました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスケードフェイルオーバー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。マスターといくつかのレプリカがあるとします。マスターがドロップし、負荷が新しいマスターと残りのレプリカに切り替わります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ea9/864/d63/ea9864d63b7cebd46ff8b185ddb5d639.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古いマスターには再初期化してレプリカになる時間がありませんでした。その時点で別のマスターが落ちました。数秒ですべての負荷が単一のサーバーにかかります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81d/243/fc1/81d243fc1500011f0f3c24576f81786a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは負荷に対応せず、失敗します-カスケードフェイルオーバーになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでも自動フェイルオーバーを実行する場合は、次の方法があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bashスクリプト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;は、常にテストおよびデバッグする必要がある脆弱なソリューションです。 1人の管理者が去り、もう1人が来て、それを使用する方法がわかりません。突然何かが壊れた場合、何が起こったかを見つけるのは非常に困難です。このソリューションでは、常に改良が必要です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansibleプレイブック</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-ステロイドのbashスクリプト。また、すべてが機能することを常に確認し、テストクラスターで実行する必要があります。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パトロニ</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;-私の意見では、最高の製品の1つです。自動フェイルオーバーがあり、クラスターのステータスを監視し、さらにクラスタートポロジをサービスディスカバリに戻す機能があるからです。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAF</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pacemakerに基づいてい</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">また、PostgreSQLでの自動フェイルオーバーのための興味深いツールですが、すでにより複雑で、Pacemakerの知識が必要です。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stolonは</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウド</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;">コンピューティング</font></b></a><font style="vertical-align: inherit;">向けです。</font><font style="vertical-align: inherit;">たとえば、Kubernetesの場合。</font><font style="vertical-align: inherit;">StolonはPatroniよりも複雑ですが、互換性があり、どちらかを選択できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナーとオーケストレーション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
近年、DockerとKubernetesが成長しています。これらは動的に開発されている技術であり、多くの新しいものが登場します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b99/aba/8c4/b99aba8c4f9c959cd96840bfcd3359b2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古いバージョンは機能しなくなる可能性がありますが、新しいバージョンごとに多くの興味深い機能が追加されます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Kubernetesにベースをデプロイするとどうなる...」では、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな驚くべきストーリーが始まります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベースは常にステートフルで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、どこかに保存する必要があります。どこ？耐障害性のあるネットワークストレージが思い浮かびます。オープンソースのソリューション：CEPH、GlusterFS、LinStor DRBD。基本的な問題は、すべての動作が非常に遅く、おそらく速く動作しないことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おまけとして、追加の頭痛の種- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタ化されたファイルシステムをサポートする必要性</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、Kubernetesにのみ精通している場合は、CEPHを深く学習する必要があります。</font><font style="vertical-align: inherit;">これは、多くの問題を抱えた複雑なシステムです。専門知識を増やす必要があります。</font><font style="vertical-align: inherit;">ネットワーク接続ストレージとその中のデータベースについて一般的に言えば、これは3つの要件が満たされている間に機能します。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースのサイズは小さく</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ノード間でGBおよび数十GBのデータを転送する必要はありません。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスや遅延の要件はありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">レイテンシが数十または数百ミリ秒に増加する場合、これは完全に機能しないソリューションです。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを失うことは怖くない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">Kubernetesは開発中ですが、いくつかのバグが見つかっています。</font><font style="vertical-align: inherit;">Kubernetesの共有ストレージを可能にするエンジンも開発されており、そこにもバグが見つかります。</font><font style="vertical-align: inherit;">ある時点で、バグに遭遇してすべてを失う可能性があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、ステージングサーバー、開発サーバー、または仮説テストの段階で、データベースにKubernetesとDockerを使用するのが適切であるという事実につながります。しかし、私の考えでは、高負荷の場合、Kubernetesと共有ストレージはあまり良くありません。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b04/8dd/fd0/b048ddfd0b6212ef2d1eb49eda02386b.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、本当に必要な場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルボリューム-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有ファイルシステムを使用しない</font><b><font style="vertical-align: inherit;">ローカルストレージ</font></b><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミングレプリケーション-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを同期する&nbsp; </font><b><font style="vertical-align: inherit;">ネイティブストリーミングレプリケーション</font></b><font style="vertical-align: inherit;">、およびボタンのようなものを提供する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLオペレーター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -をクリックすると、それが機能します。 ：2つのなどの演算子まだあり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zalando</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クランチが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これはすべて動的に発展していることを覚えておく価値があります。</font><font style="vertical-align: inherit;">問題とプルリクエストの数を見てください。</font><font style="vertical-align: inherit;">新機能が表示され、エラーがそれらに隠されている可能性があるため、狂信のないコンテナ化を実装します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">計画と監視を行うときは、SSDを節約しないでください。SSD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;は比較的安価であり、パフォーマンスの問題を1年以上遅らせます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてをデータベースに書き込まないでください</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 8 MBのJSONを作成する習慣はよくありません。それはできません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視が必要</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。デフォルトの状態のままにしないでください。 PostgreSQLを監視し、監視を拡張します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷を分散します-Postgresの準備が整いました</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 1つの場所からデータを読み書きしないようにしてください。 PostgreSQLは非常に適切にスケーリングし、あらゆる好みに合わせてスケーリングするためのオプションがあります。負荷をスケーリングするには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミングレプリケーションを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用し</font><b><font style="vertical-align: inherit;">ます。出版物、サブスクリプション。外国のテーブル;宣言的なパーティション分割</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何もしないでください</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。彼らはパフォーマンスを低下させ、非常にゆっくりとしかし確実にベースを殺します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他の人がすでに必要としているかもしれないことをしているなら、周りを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見回して</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ください- </font><b><font style="vertical-align: inherit;">おそらくすべてがすでにそこにあり</font></b><font style="vertical-align: inherit;">ます。これはキューに直接関係します。自己作成の行を作成しないでください。SkytoolsPgQを使用してください！</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesのベースが本当に必要な場合は、ローカルボリューム、ストリーミングレプリケーション、PostgreSQLオペレーターを使用してください</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。何とかしてこれで作業できますが、狂信的ではありません。すべてが非常に速く変化するためです。</font></font><br>
<br>
<blockquote>              .     ,   24  25   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">HighLoad++ Siberia</a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  ,    ,           .   38    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> —     !</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja455236/index.html">Comodoは理由もなく証明書を取り消す</a></li>
<li><a href="../ja455240/index.html">拒否された不良率を使用してエラー報告を改善する</a></li>
<li><a href="../ja455242/index.html">マイナスの耳、またはゲームのサウンドを最初から損なわないようにする方法</a></li>
<li><a href="../ja455244/index.html">コミック「はんだ付けは簡単」更新版（2019）</a></li>
<li><a href="../ja455246/index.html">サンクトペテルブルクのカスタマーエクスペリエンスデーの登録は6月20日に始まります</a></li>
<li><a href="../ja455256/index.html">Habr Weekly＃4 / Computex、Appleをベータ版にする方法、Durovは飢えている、BadComedian猫、ニューラルネットワークがポルノ俳優を探した理由</a></li>
<li><a href="../ja455258/index.html">6月21〜22日にモスクワで開催されるDevConfXの記念日のバックエンドセクションのレポートへの投票が始まりました。</a></li>
<li><a href="../ja455260/index.html">マークルツリー：錆びて速い</a></li>
<li><a href="../ja455264/index.html">ムンクのように、または技術的な義務について一言</a></li>
<li><a href="../ja455268/index.html">それがすべて始まった方法：柔軟で折りたたみ式のディスプレイ-「人」の出現と退去の物語</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>