<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>โช๏ธ ๐๏ธ ๐ Postgres: ุงูููุฎ ุ pg_repack ูุงููููุฏ ุงููุคุฌูุฉ ๐ฉโโ๏ธ ๐ โน๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุฅู ุชุฃุซูุฑ ุงูุฌุฏุงูู ูุงูููุงุฑุณ ุงูููุชูุฎุฉ (ุงูููุฎ) ูุนุฑูู ุนูู ูุทุงู ูุงุณุน ููุง ููุฌุฏ ููุท ูู Postgres. ููุงู ุทุฑู ููุชุนุงูู ูุนูุง "ุฎุงุฑุฌ ุงูุตูุฏูู" ูุซู VACUUM FULL ุฃู CLUST...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Postgres: ุงูููุฎ ุ pg_repack ูุงููููุฏ ุงููุคุฌูุฉ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/499444/"><img src="https://habrastorage.org/webt/vf/eu/y5/vfeuy53s9e1md_jhdwxbkkmr-8e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฅู ุชุฃุซูุฑ ุงูุฌุฏุงูู ูุงูููุงุฑุณ ุงูููุชูุฎุฉ (ุงูููุฎ) ูุนุฑูู ุนูู ูุทุงู ูุงุณุน ููุง ููุฌุฏ ููุท ูู Postgres. </font><font style="vertical-align: inherit;">ููุงู ุทุฑู ููุชุนุงูู ูุนูุง "ุฎุงุฑุฌ ุงูุตูุฏูู" ูุซู VACUUM FULL ุฃู CLUSTER ุ ููููุง ุชุญุฌุจ ุงูุฌุฏุงูู ุฃุซูุงุก ุงูุชุดุบูู ูุจุงูุชุงูู ูุง ูููู ุงุณุชุฎุฏุงููุง ุฏุงุฆููุง. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุณุชุญุชูู ุงูููุงูุฉ ุนูู ุงููููู ูู ุงููุธุฑูุฉ ุญูู ููููุฉ ุญุฏูุซ ุงูุงูุชูุงุฎ ุ ูููููุฉ ุงูุชุนุงูู ูุนู ุ ุญูู ุงููููุฏ ุงููุคุฌูุฉ ูุงููุดุงูู ุงูุชู ุชุฌูุจูุง ูุงุณุชุฎุฏุงู ุงูุชุฏุงุฏ pg_repack.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุชุณุชูุฏ ูุฐู ุงูููุงูุฉ ุนูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุนุฑุถู ุงูุชูุฏููู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูู PgConf.Russia 2020.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8vaVeCKuz6M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงุฐุง ูุญุฏุซ ุณุฎุงู</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุนุชูุฏ Postgres ุนูู ูููุฐุฌ ูุชุนุฏุฏ ุงูุฅุตุฏุงุฑุงุช ( </font></font><abbr title="ุงูุชุญูู ูู ุงูุชุฒุงูู ูุชุนุฏุฏ ุงูุฅุตุฏุงุฑุงุช"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVCC</font></font></a></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). ุฌููุฑู ูู ุฃู ูู ุตู ูู ุงูุฌุฏูู ูููู ุฃู ูููู ูู ุนุฏุฉ ุฅุตุฏุงุฑุงุช ุ ูู ุญูู ุฃู ุงููุนุงููุงุช ูุง ุชุฑู ุฃูุซุฑ ูู ูุงุญุฏ ูู ูุฐู ุงูุฅุตุฏุงุฑุงุช ุ ูููู ููุณ ุจุงูุถุฑูุฑุฉ ููุณ ุงูุฅุตุฏุงุฑ. ูุฐุง ูุณูุญ ููุนุงููุงุช ูุชุนุฏุฏุฉ ููุนูู ูู ููุช ูุงุญุฏ ูููุณ ููุง ุฃู ุชุฃุซูุฑ ูุนูููุง ุนูู ุจุนุถูุง ุงูุจุนุถ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุงุถุญ ุฃูู ูุฌุจ ุชุฎุฒูู ูู ูุฐู ุงูุฅุตุฏุงุฑุงุช. ูุนูู Postgres ูุน ุงูุฐุงูุฑุฉ ุตูุญุฉ ุจุตูุญุฉ ุ ูุงูุตูุญุฉ ูู ุงูุญุฏ ุงูุฃุฏูู ูู ุงูุจูุงูุงุช ุงูุชู ูููู ูุฑุงุกุชูุง ูู ุงููุฑุต ุฃู ูุชุงุจุชูุง. ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ูุซุงู ุตุบูุฑ ูููู ููู ูุญุฏุซ ูุฐุง.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููุชุฑุถ ุฃู ูุฏููุง ุฌุฏูู ุฃุถููุง ููู ุนุฏุฉ ุณุฌูุงุช. ูู ุงูุตูุญุฉ ุงูุฃููู ูู ุงูููู ุญูุซ ุชู ุชุฎุฒูู ุงูุฌุฏูู ุ ุธูุฑุช ุจูุงูุงุช ุฌุฏูุฏุฉ. ูุฐู ูู ุฅุตุฏุงุฑุงุช ูุจุงุดุฑุฉ ูู ุงูุณูุงุณู ุงููุชููุฑุฉ ูููุนุงููุงุช ุงูุฃุฎุฑู ุจุนุฏ ุงูุงูุชุฒุงู (ููุชุจุณูุท ุ ุณููุชุฑุถ ุฃู ูุณุชูู ุงูุนุฒู ูุฑุงุกุฉ ููุชุฒู). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pb/ep/av/pbepavyhm5_alpqup33j8vfcocm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุซู ูููุง ุจุชุญุฏูุซ ุฃุญุฏ ุงูุฅุฏุฎุงูุงุช ูุจุงูุชุงูู ูุถุน ุนูุงูุฉ ุนูู ุงูุฅุตุฏุงุฑ ุงููุฏูู ุนูู ุฃูู ุบูุฑ ุฐู ุตูุฉ. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/tr/tg/natrtgitck2f7ymtdalnr_coecu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฎุทูุฉ ุจุฎุทูุฉ ุ ุชุญุฏูุซ ูุญุฐู ูุณุฎุฉ ูู ุงูุณุทูุฑ ุ ุญุตููุง ุนูู ุตูุญุฉ ูููู ูููุง ุญูุงูู ูุตู ุงูุจูุงูุงุช "ุงูููุงูุฉ". ูุฐู ุงูุจูุงูุงุช ุบูุฑ ูุฑุฆูุฉ ูุฃู ูุนุงููุฉ. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/8d/ji/_j8djifah3idpuohxwseop01xcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุญุชูู Postgres ุนูู ุขููุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุฑุงุบ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุ ุงูุฐู ููุธู ุงูุฅุตุฏุงุฑุงุช ุบูุฑ ุฐุงุช ุงูุตูุฉ ููููุฑ ุงููุณุงุญุฉ ููุจูุงูุงุช ุงูุฌุฏูุฏุฉ. ูููู ุฅุฐุง ูู ูุชู ุชูููููุง ุจููุฉ ูุงููุฉ ุฃู ุฃููุง ูุดุบููุฉ ุจุงูุนูู ูู ุฌุฏุงูู ุฃุฎุฑู ุ ูุณุชุจูู "ุงูุจูุงูุงุช ุบูุฑ ุงููุฑุบูุจ ูููุง" ุ ูุนูููุง ุงุณุชุฎุฏุงู ุตูุญุงุช ุฅุถุงููุฉ ููุจูุงูุงุช ุงูุฌุฏูุฏุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐุง ูู ูุซุงููุง ุ ูู ููุช ูุง ุ ุณูุชุฃูู ุงูุฌุฏูู ูู ุฃุฑุจุน ุตูุญุงุช ุ ูููู ูู ูููู ููุงู ุณูู ูุตู ุงูุจูุงูุงุช ุงูุญูุฉ ููู. ููุชูุฌุฉ ูุฐูู ุ ุนูุฏ ุงููุตูู ุฅูู ุงูุฌุฏูู ุ ุณููุฑุฃ ุจูุงูุงุช ุฃูุซุฑ ุจูุซูุฑ ูู ุงููุงุฒู. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/ni/rn/nznirnw2kenpvkn7kv7hqwi1k08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุญุชู ูู ุญุฐู VACUUM ุงูุขู ุฌููุน ุงูุฅุตุฏุงุฑุงุช ุบูุฑ ุฐุงุช ุงูุตูุฉ ูู ุงูุณูุงุณู ุ ููู ูุชุญุณู ุงููุถุน ุจุดูู ูุจูุฑ. ุณูููู ูุฏููุง ูุณุงุญุฉ ุฎุงููุฉ ูู ุงูุตูุญุงุช ุฃู ุญุชู ุตูุญุงุช ูุงููุฉ ููุฎุทูุท ุงูุฌุฏูุฏุฉ ุ ููููุง ุณูุณุชูุฑ ูู ูุฑุงุกุฉ ุจูุงูุงุช ุฃูุซุฑ ูู ุงููุงุฒู.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุจุงูููุงุณุจุฉ ุ ุฅุฐุง ูุงูุช ููุงู ุตูุญุฉ ูุงุฑุบุฉ ุชูุงููุง (ุงูุซุงููุฉ ูู ูุซุงููุง) ูู ููุงูุฉ ุงูููู ุ ูุฅู VACUUM ูููู ุฃู ููุทุนูุง. </font><font style="vertical-align: inherit;">ููููุง ุงูุขู ูู ุงููุณุท ุ ูุฐูู ูุง ูููู ูุนู ุฃู ุดูุก ูุนูุง. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fy/ix/rq/fyixrqdxzpivbooplfjoqpeyc-q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุนูุฏูุง ูุตุจุญ ุนุฏุฏ ูุฐู ุงูุตูุญุงุช ุงููุงุฑุบุฉ ุฃู ุงููุณุทุญุฉ ูุจูุฑูุง ุ ูุงูุฐู ูุณูู ุงูููุฎ ุ ูุฅูู ูุจุฏุฃ ูู ุงูุชุฃุซูุฑ ุนูู ุงูุฃุฏุงุก. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ูุง ูู ููุถุญ ุฃุนูุงู ูู ุขููุงุช ุญุฏูุซ ุงูููุฎ ูู ุงูุฌุฏุงูู. </font><font style="vertical-align: inherit;">ูู ุงูููุงุฑุณ ุ ูุญุฏุซ ูุฐุง ุจููุณ ุงูุทุฑููุฉ ุชูุฑูุจูุง.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ูุฏู ุงูุชูุงุฎุ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุงู ุนุฏุฉ ุทุฑู ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฏูู ุงูุชูุงุฎ. ุงูููุฑุฉ ุงูุฃููู ูู ุงุณุชุฎุฏุงู ุฅุญุตุงุฆูุงุช Postgres ุงูุฏุงุฎููุฉ ุ ูุงูุชู ุชุญุชูู ุนูู ูุนูููุงุช ุชูุฑูุจูุฉ ุญูู ุนุฏุฏ ุงูุตููู ูู ุงูุฌุฏุงูู ุ ูุนุฏุฏ ุงูุตููู "ุงูุญูุฉ" ุ ููุง ุฅูู ุฐูู. ุนูู ุงูุฅูุชุฑูุช ุ ููููู ุงูุนุซูุฑ ุนูู ุงูุนุฏูุฏ ูู ุงูุฃุดูุงู ุงููุฎุชููุฉ ูููุตูุต ุงูุฌุงูุฒุฉ. ููุฏ ุงุชุฎุฐูุง ูุฃุณุงุณ ุจุฑูุงูุฌ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุตู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูู ุฎุจุฑุงุก PostgreSQL ุ ูุงูุฐู ููููู ุชูููู ุฌุฏุงูู ุงูุงูุชูุงุฎ ุฌูุจูุง ุฅูู ุฌูุจ ูุน ููุงุฑุณ ุงูุฎุจุฒ ุงููุญูุต ูููุชูุฎ. ูู ุชุฌุฑุจุชูุง ุ ุฎุทุฃูุง ูู 10-20ูช. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุทุฑููุฉ ุฃุฎุฑู ูู ุงุณุชุฎุฏุงู ููุญู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgstattuple</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ูุงูุฐู ูุณูุญ ูู ุจุงููุธุฑ ุฏุงุฎู ุงูุตูุญุงุช ูุงูุญุตูู ุนูู ููู </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;">ุงูููุฎ</font></a><font style="vertical-align: inherit;"> ุงูููุฏุฑุฉ ูุงูุฏูููุฉ. ูููู ูู ุงูุญุงูุฉ ุงูุซุงููุฉ ุ ูุฌุจ ุนููู ูุณุญ ุงูุฌุฏูู ุจุฃูููู.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููุฉ ุณุฎุงู ุตุบูุฑุฉ ุ ุชุตู ุฅูู 20ูช ุ ูุนุชุจุฑูุง ููุจููุฉ. </font><font style="vertical-align: inherit;">ููููู ุฃู ูุนุชุจุฑ ุงูุชูุงุธุฑูุฉ ูู fillfactor ุนู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุฌุฏุงูู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูููุงุฑุณ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ุนูุฏ 50ูช ููุง ููู ุ ูุฏ ุชุจุฏุฃ ูุดุงูู ุงูุฃุฏุงุก.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุทุฑู ุงูุชุนุงูู ูุน ุงูููุฎ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุงู ุนุฏุฉ ุทุฑู ููุชุนุงูู ูุน ุงูุงูุชูุงุฎ ุฎุงุฑุฌ ุงูุตูุฏูู ูู Postgres ุ ููููุง ุจุนูุฏุฉ ุนู ุฃู ุชููู ููุงุณุจุฉ ููุฌููุน ุฏุงุฆููุง. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุถุจุท AUTOVACUUM ุจุญูุซ ูุง ูุญุฏุซ ุงูุงูุชูุงุฎ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . ูุจุดูู ุฃูุซุฑ ุฏูุฉ ุ ููุญูุงุธ ุนูู ูุณุชูู ููุจูู ูู. ุชุจุฏู ูุฐู ูุตูุญุฉ "ุงููุจุทุงู" ุ ูููู ูู ุงููุงูุน ููุณ ูู ุงูุณูู ุฏุงุฆููุง ุชุญููู ุฐูู. ุนูู ุณุจูู ุงููุซุงู ุ ุฃูุช ุชุนูู ุจูุดุงุท ุนูู ุชุทููุฑ ุชุบููุฑุงุช ููุชุธูุฉ ูู ูุฎุทุท ุงูุจูุงูุงุช ุฃู ุญุฏูุซ ููุน ูู ุชุฑุญูู ุงูุจูุงูุงุช. ููุชูุฌุฉ ูุฐูู ุ ูููู ุฃู ูุชุบูุฑ ููู ุชุนุฑูู ุงูุชุญููู ุจุดูู ูุชูุฑุฑ ุ ูููุงุนุฏุฉ ุนุงูุฉ ุ ูููู ุฃู ูููู ูุฎุชูููุง ููุฌุฏุงูู ุงููุฎุชููุฉ. ูุฐุง ูุนูู ุฃูู ุจุญุงุฌุฉ ุฅูู ุงูุนูู ุจุงุณุชูุฑุงุฑ ููููุงู ูุจู ุงูููุญูู ูุถุจุท AUTOVACUUM ุนูู ุงููุถุน ุงููุชุบูุฑ ููู ุฌุฏูู. ููู ูู ุงููุงุถุญ ุฃู ูุฐุง ููุณ ุจุงูุฃูุฑ ุงูุณูู.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุณุจุจ ุขุฎุฑ ุดุงุฆุน ุฃู AUTOVACUUM ููุณ ูุฏููุง ุงูููุช ุงููุงูู ููุนุงูุฌุฉ ุงูุฌุฏุงูู ูู ูุฌูุฏ ูุนุงููุงุช ุทูููุฉ ุชููุนู โโูู ูุณุญ ุงูุจูุงูุงุช ูุธุฑูุง ูุฃููุง ูุชุงุญุฉ ููุฐู ุงููุนุงููุงุช. ุงูุชูุตูุฉ ููุง ูุงุถุญุฉ ุฃูุถูุง - ุชุฎูุต ูู ุงููุนุงููุงุช ุงููุนููุฉ ูุชูููู ููุช ุงููุนุงููุงุช ุงููุดุทุฉ. ูููู ุฅุฐุง ูุงู ุงูุญูู ุนูู ุงูุชุทุจูู ุงูุฎุงุต ุจู ุนุจุงุฑุฉ ุนู ูุฒูุฌ ูู OLAP ู OLTP ุ ูููููู ูู ุงูููุช ููุณู ุงูุญุตูู ุนูู ุงูุนุฏูุฏ ูู ุงูุชุญุฏูุซุงุช ุงููุชูุฑุฑุฉ ูุงูุทูุจุงุช ุงููุตูุฑุฉ ุ ุจุงูุฅุถุงูุฉ ุฅูู ุงูุนูููุงุช ุงูุทูููุฉ - ุนูู ุณุจูู ุงููุซุงู ุ ุฅูุดุงุก ุชูุฑูุฑ. ูู ูุซู ูุฐู ุงูุญุงูุฉ ุ ูุฌุฏุฑ ุงูุชูููุฑ ูู ุชูุฒูุน ุงูุญูู ุนูู ููุงุนุฏ ูุฎุชููุฉ ุ ููุง ุณูุณูุญ ุจุถุจุท ุฃุฏู ููู ูููุง.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุซุงู ุขุฎุฑ - ุญุชู ูู ูุงู ููู ุงูุชุนุฑูู ููุญุฏูุง ุ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุญุช ุญูููุฉ ุนุงููุฉ ุฌุฏูุง ุ ุญุชู AUTOVACUUM ุงูุฃูุซุฑ ุนุฏูุงููุฉ ูุฏ ูุง ูุชุฃููู ุ ูุณูุญุฏุซ ุณุฎุงู. ุงูุชุญุฌูู (ุงูุฑุฃุณู ุฃู ุงูุฃููู) ูู ุงูุญู ุงููุญูุฏ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ูุงุฐุง ุนู ุงููููู ุนูุฏูุง ููุช ุจุชูููู AUTOVACUUM ุ ูููู ุงูุงูุชูุงุฎ ูุณุชูุฑ ูู ุงูููู. </font><b><font style="vertical-align: inherit;">ุงููุฑุงุบ ุงููุงูู</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ุงูููุงุฏุฉ</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุนูุฏ ุจูุงุก ูุญุชููุงุช ุงูุฌุฏุงูู ูุงูููุงุฑุณ ููุชุฑู ููุท ุงูุจูุงูุงุช ุฐุงุช ุงูุตูุฉ ุจูุง. ููุชุฎูุต ูู ุงูุงูุชูุงุฎ ุ ูุนูู ุจุดูู ูุซุงูู ุ ูููู ุฃุซูุงุก ุชูููุฐู ุ ูุชู ุงูุชูุงุท ููู ุญุตุฑู ุนูู ุงูุทุงููุฉ (AccessExclusiveLock) ุ ูุงูุฐู ูู ูุณูุญ ุจุงูุงุณุชุนูุงูุงุช ุฅูู ูุฐุง ุงูุฌุฏูู ุ ุญุชู ุฅูู ูุญุฏุฏ. ุฅุฐุง ููุช ุชุณุชุทูุน ุฅููุงู ุฎุฏูุชู ุฃู ุฌุฒุก ูููุง ููุชุฑุฉ (ูู ุนุดุฑุงุช ุงูุฏูุงุฆู ุฅูู ุนุฏุฉ ุณุงุนุงุช ุ ุงุนุชูุงุฏูุง ุนูู ุญุฌู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุฃุฌูุฒุฉ ุงูุฎุงุตุฉ ุจู) ุ ูุฅู ูุฐุง ุงูุฎูุงุฑ ูู ุงูุฃูุถู. ูุณูุก ุงูุญุธ ุ ููุณ ูุฏููุง ููุช ูุชุดุบูู VACUUM FULL ุฃุซูุงุก ุงูุตูุงูุฉ ุงููุฌุฏููุฉ ุ ูุฐุง ูุฅู ูุฐู ุงูุทุฑููุฉ ูุง ุชูุงุณุจูุง. </font><b><font style="vertical-align: inherit;">ุงูุนูููุฏูุฉ</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ุงูููุงุฏุฉ</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุง ุฃูู ูุนูุฏ ุจูุงุก ูุญุชููุงุช ุงูุฌุฏุงูู ุ ููุง ููุนู VACUUM FULL ุ ูู ููุณ ุงูููุช ูุณูุญ ูู ุจุชุญุฏูุฏ ุงูููุฑุณ ุงูุฐู ุณูุชู ุจููุฌุจู ุชุฑุชูุจ ุงูุจูุงูุงุช ูุนูููุง ุนูู ุงููุฑุต (ูููู ูู ุงููุณุชูุจู ูุง ูุชู ุถูุงู ุงูุทูุจ). ูู ุญุงูุงุช ูุนููุฉ ุ ูุนุฏ ูุฐุง ุชุญุณูููุง ุฌูุฏูุง ูุนุฏุฏ ูู ุงูุงุณุชุนูุงูุงุช - ูุน ูุฑุงุกุฉ ุงูุนุฏูุฏ ูู ุงูุณุฌูุงุช ุญุณุจ ุงูููุฑุณ. ุนููุจ ุงูุฃูุฑ ูู ููุณู VACUUM FULL - ูุคูู ุงูุฌุฏูู ุฃุซูุงุก ุงูุนูููุฉ. </font><font style="vertical-align: inherit;">ูุดุจู </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุฃูุฑ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REINDEX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุงุซููู ุงูุณุงุจููู ุ ูููู ูุนูุฏ ุจูุงุก ููุฑุณ ูุนูู ุฃู ูู ุงูููุงุฑุณ ุนูู ุงูุฌุฏูู. ุงูุฃููุงู ุฃุถุนู ููููุงู: ShareLock ุนูู ุงูุทุงููุฉ (ูููุน ุงูุชุนุฏููุงุช ุ ููู ูุณูุญ ุจุงูุชุญุฏูุฏ) ู AccessExclusiveLock ุนูู ููุฑุณ ูุงุจู ูุฅุนุงุฏุฉ ุงูุจูุงุก (ูููุน ุงูุทูุจุงุช ุจุงุณุชุฎุฏุงู ูุฐุง ุงูููุฑุณ). ููุน ุฐูู ุ ูู ุงูุฅุตุฏุงุฑ 12 ูู Postgres ุ ุงููุนููุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONCURRENTLY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุ ุงูุฐู ูุณูุญ ูู ุจุฅุนุงุฏุฉ ุจูุงุก ุงูููุฑุณ ุฏูู ููุน ุฅุถุงูุฉ ุฃู ุชุนุฏูู ุฃู ุญุฐู ุงูุณุฌูุงุช ุจุดูู ูุชูุงุฒ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ ูู Postgres ุ ููููู ุชุญููู ูุชูุฌุฉ ูุดุงุจูุฉ ูู REINDEX ุจุงูุชูุงูู ูุน </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE INDEX CONCURRENTLY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . ูุณูุญ ูู ุจุฅูุดุงุก ููุฑุณ ุฏูู ุญุธุฑ ุตุงุฑู (ShareUpdateExclusiveLock ุ ุงูุฐู ูุง ูุชุฏุงุฎู ูุน ุงูุงุณุชุนูุงูุงุช ุงููุชูุงุฒูุฉ) ุ ุซู ุงุณุชุจุฏู ุงูููุฑุณ ุงููุฏูู ุจููุฑุณ ุฌุฏูุฏ ูุญุฐู ุงูููุฑุณ ุงููุฏูู. ูุฐุง ูุฒูู ููุงุฑุณ ุงูุงูุชูุงุฎ ุฏูู ุงูุชุฏุฎู ูู ุงูุชุทุจูู ุงูุฎุงุต ุจู. ูู ุงูููู ูุฑุงุนุงุฉ ุฃูู ุนูุฏ ุฅุนุงุฏุฉ ุจูุงุก ุงูููุงุฑุณ ุณูููู ููุงู ุชุญููู ุฅุถุงูู ุนูู ุงููุธุงู ุงููุฑุนู ูููุฑุต. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุจุงูุชุงูู ุ ุฅุฐุง ูุงูุช ููุงู ุทุฑู ูููุงุฑุณ ูููุถุงุก ุนูู ุงูุงูุชูุงุฎ "ุงูุณุงุฎู" ุ ููุง ุชูุฌุฏ ุฌุฏุงูู. ููุง ุชุฏุฎู ุงูุนุฏูุฏ ูู ุงูููุญูุงุช ุงูุฎุงุฑุฌูุฉ: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_repack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ุณุงุจููุง pg_reorg) ู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgcompact</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgcompacttable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุบูุฑูุง. </font><font style="vertical-align: inherit;">ูู ุฅุทุงุฑ ูุฐู ุงูููุงูุฉ ุ ูู ุฃูุงุฑููุง ูุณุฃุชุญุฏุซ ููุท ุนู pg_repack ุ ุงูุชู ูุณุชุฎุฏููุง ูู ุงูููุฒู ุจุนุฏ ุจุนุถ ุงูุชุญุณููุงุช.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููู ูุนูู pg_repack</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5j/bp/ng/5jbpng5ietzdlekjqc32gdf_5cs.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููุชุฑุถ ุฃู ูุฏููุง ุฌุฏูููุง ุนุงุฏููุง ุฌุฏูุง ูุฃููุณูุง - ูุน ุงูููุงุฑุณ ูุงููููุฏ ุ ูููุฃุณู ุ ูุน ุณุฎุงู. ุงูุฎุทูุฉ ุงูุฃููู ูู pg_repack ุฅูุดุงุก ุฌุฏูู ุณุฌู ูุชุฎุฒูู ุงูุจูุงูุงุช ุญูู ุฌููุน ุงูุชุบููุฑุงุช ุฃุซูุงุก ุงูุนูููุฉ. ุณูุนูู ุงููุดุบู ุนูู ุชูุฑุงุฑ ูุฐู ุงูุชุบููุฑุงุช ูู ูู ุฅุฏุฑุงุฌ ูุชุญุฏูุซ ูุญุฐู. ุซู ูุชู ุฅูุดุงุก ุฌุฏูู ูุดุงุจู ููุฃุตู ูู ุงููููู ุ ูููู ุจุฏูู ููุงุฑุณ ููููุฏ ุ ุญุชู ูุง ุชุจุทุฆ ุนูููุฉ ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุจุนุฏ ุฐูู ุ ุชููู pg_repack ุจููู ุงูุจูุงูุงุช ูู ุงูุฌุฏูู ุงููุฏูู ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ ุ ูุชุตููุฉ ุฌููุน ุงูุตููู ุบูุฑ ุฐุงุช ุงูุตูุฉ ุชููุงุฆููุง ุ ุซู ุฅูุดุงุก ููุงุฑุณ ููุฌุฏูู ุงูุฌุฏูุฏ. ุฃุซูุงุก ุชูููุฐ ูู ูุฐู ุงูุนูููุงุช ุ ูุชู ุชุฌููุน ุงูุชุบููุฑุงุช ูู ุฌุฏูู ุงูุณุฌู.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ููู ุงูุชุบููุฑุงุช ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ. </font><font style="vertical-align: inherit;">ูุชู ุชูููุฐ ุงูุชุฑุญูู ูู ุงูุนุฏูุฏ ูู ุงูุชูุฑุงุฑุงุช ุ ูุนูุฏูุง ูุจูู ุฃูู ูู 20 ุฅุฏุฎุงู ูู ุฌุฏูู ุงูุณุฌู ุ ููุชูุท pg_repack ููููุง ุตุงุฑููุง ุ ููููู ุฃุญุฏุซ ุงูุจูุงูุงุช ููุณุชุจุฏู ุงูุฌุฏูู ุงููุฏูู ุจุงูุฌุฏูู ุงูุฌุฏูุฏ ูู ุฌุฏุงูู ูุธุงู Postgres. </font><font style="vertical-align: inherit;">ูุฐู ูู ุงูููุทุฉ ุงููุญูุฏุฉ ูุงููุตูุฑุฉ ููุบุงูุฉ ูู ุงูููุช ุงูุฐู ูุง ููููู ููู ุงูุนูู ูุน ุงูุฌุฏูู. </font><font style="vertical-align: inherit;">ุจุนุฏ ุฐูู ุ ูุชู ุญุฐู ุงูุฌุฏูู ุงููุฏูู ูุงูุฌุฏูู ุงูุฐู ูุญุชูู ุนูู ุงูุณุฌูุงุช ููุชู ุชุญุฑูุฑ ูุณุงุญุฉ ูู ูุธุงู ุงููููุงุช. </font><font style="vertical-align: inherit;">ุงูุชูุงู ุงูุนูููุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ูู ุดูุก ูุจุฏู ุฑุงุฆุนูุง ุ ูุงุฐุง ูู ุงููุงูุนุ </font><font style="vertical-align: inherit;">ุงุฎุชุจุฑูุง pg_repack ุจุฏูู ุชุญููู ูุชุญุช ุงูุญูู ุ ุชุญูููุง ูู ุชุดุบููู ูู ุญุงูุฉ ุงูุชููู ุงููุจูุฑ (ุจุนุจุงุฑุฉ ุฃุฎุฑู ุ Ctrl + C). </font><font style="vertical-align: inherit;">ูุงูุช ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุฅูุฌุงุจูุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฐูุจูุง ุฅูู ููุฒ - ุซู ุญุฏุซ ูู ุดูุก ุนูู ุงููุญู ุงููุชููุน.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃูู ูุทูุฑุฉ ุนูู ููุฒ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุฌููุนุฉ ุงูุฃููู ุ ุชููููุง ุฎุทุฃ ุญูู ุงูุชูุงู ุชูููุฏ ูุฑูุฏ:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span><font></font>
DETAIL:  Key (id, index)=(100500, 42) already exists.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุญุชูู ูุฐุง ุงูุชูููุฏ ุนูู index_16508 ุงุณู ุชู ุฅูุดุงุคู ุชููุงุฆููุง - ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ pg_repack. </font><font style="vertical-align: inherit;">ูู ุฎูุงู ุงูุณูุงุช ุงููุฏุฑุฌุฉ ูู ุชููููู ุ ูุฑุฑูุง ุชูููุฏ "ูุฏููุง" ุ ุงูุฐู ูุชูุงูู ูุนู. </font><font style="vertical-align: inherit;">ุชุญููุช ุงููุดููุฉ ุฅูู ุฃู ูุฐุง ููุณ ุชูููุฏูุง ุนุงุฏููุง ุชูุงููุง ุ ููููู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฏ ูุคุฌู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ุฃู </font><font style="vertical-align: inherit;">ูุชู ุชูููุฐ ุงูุชุญูู ููู ูู ููุช ูุงุญู ูู ุงูุฃูุฑ sql ุ ููุง ูุคุฏู ุฅูู ุนูุงูุจ ุบูุฑ ูุชููุนุฉ.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููููุฏ ุงููุคุฌูุฉ: ููุงุฐุง ูู ุจุญุงุฌุฉ ุฅูููุง ูููู ูุนูููู</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงููููู ูู ุงููุธุฑูุฉ ุญูู ุงููููุฏ ุงููุคุฌูุฉ. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุฃุฎุฐ ูุซุงูุงู ุจุณูุทูุง: ูุฏููุง ุฌุฏูู ูุฑุฌุนู ููุณูุงุฑุฉ ุจู ุตูุชุงู - ุงุณู ูุชุฑุชูุจ ุงูุณูุงุฑุฉ ูู ุงูุฏููู.</font></font><br>
<img src="https://habrastorage.org/webt/n8/1s/td/n81stdw9kie5wll03ylnel18aie.png" align="right"><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cars<font></font>
(<font></font>
  <span class="hljs-type">name</span> <span class="hljs-type">text</span> <span class="hljs-keyword">constraint</span> pk_cars <span class="hljs-keyword">primary key</span>,<font></font>
  ord <span class="hljs-type">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">constraint</span> uk_cars <span class="hljs-keyword">unique</span><font></font>
);<font></font>
</code></pre><br>
<br clear="all"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููุชุฑุถ ุฃููุง ุจุญุงุฌุฉ ุฅูู ุชุจุฏูู ุงูุณูุงุฑุชูู ุงูุฃููู ูุงูุซุงููุฉ. </font><font style="vertical-align: inherit;">ุงูุญู "ูู ุงูุฌุจูุฉ" ูู ุชุญุฏูุซ ุงููููุฉ ุงูุฃููู ุฅูู ุงูุซุงููุฉ ุ ูุงูุซุงููุฉ ุฅูู ุงูุฃููู:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">begin</span>;
  <span class="hljs-keyword">update</span> cars <span class="hljs-keyword">set</span> ord = <span class="hljs-number">2</span> <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> = <span class="hljs-string">'audi'</span>;
  <span class="hljs-keyword">update</span> cars <span class="hljs-keyword">set</span> ord = <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> = <span class="hljs-string">'bmw'</span>;
<span class="hljs-keyword">commit</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ุนูุฏ ุชูููุฐ ูุฐุง ุงูุฑูุฒ ุ ูุชููุน ุญุฏูุซ ุงูุชูุงู ููููุฏ ุ ูุฃู ุชุฑุชูุจ ุงูููู ูู ุงูุฌุฏูู ูุฑูุฏ:</font></font><br>
<br>
<pre><code class="bash hljs">[23305] ERROR: duplicate key value violates unique constraint โuk_carsโ<font></font>
Detail: Key (ord)=(2) already exists.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููู ุชูุนู ุฐูู ุจุดูู ูุฎุชููุ ุงูุฎูุงุฑ ุงูุฃูู: ุฅุถุงูุฉ ุงุณุชุจุฏุงู ุฅุถุงูู ูููููุฉ ุจุฃูุฑ ูุถูู ุนุฏู ูุฌูุฏู ูู ุงูุฌุฏูู ุ ุนูู ุณุจูู ุงููุซุงู ุ "-1". ูู ุงูุจุฑูุฌุฉ ุ ูุณูู ูุฐุง "ุชุจุงุฏู ููู ูุชุบูุฑูู ูู ุฎูุงู ุงููุชุบูุฑ ุงูุซุงูุซ". ุงูุนูุจ ุงููุญูุฏ ููุฐู ุงูุทุฑููุฉ ูู ุงูุชุญุฏูุซ ุงูุฅุถุงูู. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุฎูุงุฑ ุงูุซุงูู: ุฅุนุงุฏุฉ ุชุตููู ุงูุฌุฏูู ูุงุณุชุฎุฏุงู ููุน ุจูุงูุงุช ูุงุตูุฉ ุนุงุฆูุฉ ููููุฉ ุงูุฃูุฑ ุจุฏูุงู ูู ุงูุฃุนุฏุงุฏ ุงูุตุญูุญุฉ. ูุจุนุฏ ุฐูู ุ ุนูุฏ ุชุญุฏูุซ ุงููููุฉ ูู 1 ุ ุนูู ุณุจูู ุงููุซุงู ุ ุฅูู 2.5 ุ "ุณูููู" ุงูุณุฌู ุงูุฃูู ุชููุงุฆููุง "ุงููููู" ุจูู ุงูุซุงูู ูุงูุซุงูุซ. ูุนูู ูุฐุง ุงูุญู ุ ูููู ููุงู ููุนุงู ูู ุงููููุฏ. ุฃููุงู ุ ูู ุชุนูู ูู ุฅุฐุง ุชู ุงุณุชุฎุฏุงู ุงููููุฉ ูู ููุงู ูุง ูู ุงููุงุฌูุฉ. ุซุงูููุง ุ ุจูุงุกู ุนูู ุฏูุฉ ููุน ุงูุจูุงูุงุช ุ ุณูููู ูุฏูู ุนุฏุฏ ูุญุฏูุฏ ูู ุงูุฅุฏุฎุงูุงุช ุงููุญุชููุฉ ูุจู ุฅุนุงุฏุฉ ุญุณุงุจ ููู ุฌููุน ุงูุณุฌูุงุช.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุฎูุงุฑ ุงูุซุงูุซ: ุฌุนู ุงูููุฏ ูุคุฌููุง ุจุญูุซ ูุชู ุงูุชุญูู ููู ููุท ูู ููุช ุงูุงูุชุฒุงู:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cars<font></font>
(<font></font>
  <span class="hljs-type">name</span> <span class="hljs-type">text</span> <span class="hljs-keyword">constraint</span> pk_cars <span class="hljs-keyword">primary key</span>,<font></font>
  ord <span class="hljs-type">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">constraint</span> uk_cars <span class="hljs-keyword">unique</span> <span class="hljs-keyword">deferrable</span> <span class="hljs-keyword">initially</span> <span class="hljs-keyword">deferred</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุธุฑูุง ูุฃู ููุทู ุทูุจูุง ุงูุฃููู ูุถูู ุฃู ุฌููุน ุงูููู ูุฑูุฏุฉ ูู ููุนูุง ูู ููุช ุงูุงูุชุฒุงู ุ ูุณุชูุฌุญ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงููุซุงู ุฃุนูุงู ูู ุจุงูุทุจุน ุงูุงุตุทูุงุนูุฉ ููุบุงูุฉ ุ ูููู ููุดู ุนู ุงูููุฑุฉ. </font><font style="vertical-align: inherit;">ูู ุชุทุจูููุง ุ ูุณุชุฎุฏู ูููุฏูุง ูุคุฌูุฉ ูุชูููุฐ ุงูููุทู ุงููุณุคูู ุนู ุญู ุงูุชุนุงุฑุถุงุช ูุน ุงูุนูู ูู ุงูููุช ููุณู ูุน ูุงุฆูุงุช ุนูุงุตุฑ ูุงุฌูุฉ ุงูุชุนุงูู ุงูุดุงุฆุนุฉ ุนูู ุงูููุญุฉ. </font><font style="vertical-align: inherit;">ูุณูุญ ููุง ุงุณุชุฎุฏุงู ูุซู ูุฐู ุงููููุฏ ุจุฌุนู ุฑูุฒ ุงูุชุทุจูู ุฃุณูู ููููุงู. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุจุดูู ุนุงู ุ ุงุนุชูุงุฏูุง ุนูู ููุน ุงูููุฏ ูู Postgres ุ ููุงู ุซูุงุซุฉ ูุณุชููุงุช ูู ุงูุฏูุฉ ููุชุญูู ูููุง: ูุณุชูู ุงูุตู ูุงููุนุงููุฉ ูุงูุชุนุจูุฑ. </font></font><br>
<img src="https://habrastorage.org/webt/vn/bw/qq/vnbwqqmhgjpnd7kb8dtxpixb8xi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงููุตุฏุฑ: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">begriffs</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฏุงุฆููุง ูุง ูุชู ุงูุชุญูู ูู CHECK ู NOT NULL ุนูู ูุณุชูู ุงูุตู ุ ููููุฏ ุฃุฎุฑู ุ ููุง ูููู ุฑุคูุชู ูู ุงูุฌุฏูู ุ ููุงู ุฎูุงุฑุงุช ูุฎุชููุฉ. </font><font style="vertical-align: inherit;">ุงูุฑุฃ ุงููุฒูุฏ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุง</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุชูุฎูุต ุจุฅูุฌุงุฒ ุ ุชุนุทู ุงููููุฏ ุงููุนููุฉ ูู ุจุนุถ ุงูููุงูู ุฑูุฒูุง ุฃูุซุฑ ูุงุจููุฉ ูููุฑุงุกุฉ ูุฃูุงูุฑ ุฃูู. </font><font style="vertical-align: inherit;">ููุน ุฐูู ุ ูุฌุจ ุนููู ุงูุฏูุน ููุงุจู ุฐูู ุนู ุทุฑูู ุชุนููุฏ ุนูููุฉ ุงูุชุตุญูุญ ุ ุญูุซ ุฅู ูุญุธุฉ ุญุฏูุซ ุงูุฎุทุฃ ููุญุธุฉ ุงูุชุดุงูู ูู ูุชู ูุตููุง ูู ุงูููุช ุงูููุงุณุจ. </font><font style="vertical-align: inherit;">ูุดููุฉ ุฃุฎุฑู ูุญุชููุฉ ูู ุฃู ุงููุฌุฏูู ูุง ููููู ุฏุงุฆููุง ุจูุงุก ุงูุฎุทุฉ ุงููุซูู ุฅุฐุง ูุงู ููุงู ููุฏ ูุคุฌู ูู ุงูุทูุจ.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุตูู pg_repack</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุฏ ุงูุชุดููุง ูุง ูู ุงููููุฏ ุงููุนููุฉ ุ ูููู ููู ุชุฑุชุจุท ุจูุดููุชูุงุ </font><font style="vertical-align: inherit;">ุชุฐูุฑ ุงูุฎุทุฃ ุงูุฐู ุชููููุงู ุณุงุจููุง:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span>
DETAIL:  Key (id, index)=(100500, 42) already exists.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุญุฏุซ ูู ููุช ูุณุฎ ุงูุจูุงูุงุช ูู ุฌุฏูู ุงูุณุฌู ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ. ูุจุฏู ุบุฑูุจุง ูุฃูู ูุชู ุงูุงูุชุฒุงู ุจุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ุฌุฏูู ุงูุณุฌู ูุน ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ุงูุฌุฏูู ุงูุฃุตูู. ุฅุฐุง ุงุณุชูููุง ูููุฏ ุงูุฌุฏูู ุงูุฃุตูู ุ ูููู ูููููู ุงูุชูุงู ููุณ ุงููููุฏ ูู ุงูุฌุฏูู ุงูุฌุฏูุฏุ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุง ุงุชุถุญ ุ ูุฅู ุฌุฐุฑ ุงููุดููุฉ ูููู ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ ูู pg_repack ุ ุงูุชู ุชูุดุฆ ุงูููุงุฑุณ ููุท ุ ูููุณ ุงููููุฏ: ุงูุฌุฏูู ุงููุฏูู ูุงู ูู ูููุฏ ูุฑูุฏุฉ ุ ูุงูุฌุฏูุฏ ุฃูุดุฃ ููุฑุณูุง ูุฑูุฏูุง ุจุฏูุงู ูู ุฐูู.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_y/da/fc/_ydafcxizllawi1jo3o5ai-x-kg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงูููู ุฃู ููุงุญุธ ููุง ุฃูู ุฅุฐุง ูุงู ุงูุชูููุฏ ุนุงุฏููุง ููู ูุชู ุชุฃุฌููู ุ ูุฅู ุงููุคุดุฑ ุงููุฑูุฏ ุงูุฐู ุชู ุฅูุดุงุคู ุจุฏูุงู ููู ูุนุงุฏู ูุฐุง ุงูุชูููุฏ ุ ูุฃู </font><font style="vertical-align: inherit;">ูุชู ุชูููุฐ ูููุฏ Postgres ุงููุฑูุฏุฉ ูู ุฎูุงู ุฅูุดุงุก ููุฑุณ ูุฑูุฏ. </font><font style="vertical-align: inherit;">ูููู ูู ุญุงูุฉ ุงูููุฏ ุงููุคุฌู ุ ูุฅู ุงูุณููู ููุณ ูู ููุณู ุ ูุฃูู ูุง ูููู ุชุฃุฌูู ุงูููุฑุณ ููุชู ูุญุตู ุฏุงุฆููุง ูู ููุช ุชูููุฐ ุงูุฃูุฑ sql. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุจุงูุชุงูู ุ ูุฅู ุฌููุฑ ุงููุดููุฉ ูููู ูู "ุชุฃุฌูู" ุงูุดูู: ูู ุงูุฌุฏูู ุงูุฃุตูู ูุญุฏุซ ูู ููุช ุงูุงูุชุฒุงู ุ ููู ุงูุฌุฏูู ุงูุฌุฏูุฏ - ูู ููุช ุชูููุฐ ุงูุฃูุฑ sql. </font><font style="vertical-align: inherit;">ูุฐุง ูุญุชุงุฌ ุฅูู ุงูุชุฃูุฏ ูู ุฃู ุนูููุงุช ุงููุญุต ุชุชู ุจููุณ ุงูุทุฑููุฉ ูู ููุชุง ุงูุญุงูุชูู: ุฅูุง ูุคุฌูุฉ ุฏุงุฆููุง ุ ุฃู ุฏุงุฆููุง ุนูู ุงูููุฑ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุง ุงูุฃููุงุฑ ุงูุชู ูุฏููุงุ</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅูุดุงุก ููุฑุณ ูุดุงุจู ุงููุคุฌู</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูููุฑุฉ ุงูุฃููู ูู ุฅุฌุฑุงุก ููุง ุงููุญุตูู ูู ุงููุถุน ุงูููุฑู. ูุฏ ูุคุฏู ูุฐุง ุฅูู ุงูุนุฏูุฏ ูู ุงููุญูุฒุงุช ุงูุฅูุฌุงุจูุฉ ุงููุงุฐุจุฉ ููุชูููุฏ ุ ูููู ุฅุฐุง ูุงู ููุงู ุนุฏุฏ ูููู ูููุง ุ ููุง ููุจุบู ุฃู ูุคุซุฑ ุฐูู ุนูู ุนูู ุงููุณุชุฎุฏููู ุ ูุฃู ูุซู ูุฐู ุงููุฒุงุนุงุช ุชุนุชุจุฑ ุญุงูุฉ ุทุจูุนูุฉ. ุชุญุฏุซ ุ ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏูุง ูุจุฏุฃ ูุณุชุฎุฏูุงู ุชุญุฑูุฑ ููุณ ุงูุฃุฏุงุฉ ูู ููุณ ุงูููุช ุ ููุง ูุชููุฑ ูุฏู ุนููู ุงููุณุชุฎุฏู ุงูุซุงูู ุงูููุช ููุญุตูู ุนูู ูุนูููุงุช ุชููุฏ ุจุฃู ุงูุฃุฏุงุฉ ููููุฉ ุจุงููุนู ูุชุญุฑูุฑูุง ุจูุงุณุทุฉ ุงููุณุชุฎุฏู ุงูุฃูู. ูู ูุฐู ุงูุญุงูุฉ ุ ูุฑูุถ ุงูุฎุงุฏู ุงููุณุชุฎุฏู ุงูุซุงูู ุ ููุนูุฏ ุนูููู ุงูุชุบููุฑุงุช ููุนูุฏ ุงูุฃุฏุงุฉ. ุจุนุฏ ุฐูู ุจูููู ุ ุนูุฏูุง ููุชูู ุงููุณุชุฎุฏู ุงูุฃูู ูู ุงูุชุญุฑูุฑ ุ ุณูุชููู ุงูุซุงูู ูุนูููุงุช ุชููุฏ ุจุฃู ุงูุฃุฏุงุฉ ูู ุชุนุฏ ูุคููุฉ ุ ูุณูููู ูุงุฏุฑูุง ุนูู ุชูุฑุงุฑ ุนูููุง.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dw/oq/jw/dwoqjwhuqva3veavihajfcd5t4c.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุชุฃูุฏ ูู ุฃู ุนูููุงุช ุงููุญุต ุฏุงุฆููุง ูู ูุถุน ุงูุทูุงุฑุฆ ุ ุฃูุดุฃูุง ููุฑุณูุง ุฌุฏูุฏูุง ูุดุงุจููุง ููููุฏ ุงููุคุฌู ุงูุฃุตูู:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> uk_tablename__immediate <span class="hljs-keyword">ON</span> tablename (id, <span class="hljs-keyword">index</span>);
<span class="hljs-comment">-- run pg_repack</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> uk_tablename__immediate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุจูุฆุฉ ุงูุงุฎุชุจุงุฑ ุ ุชููููุง ููุท ุจุนุถ ุงูุฃุฎุทุงุก ุงููุชููุนุฉ. ูุฌุงุญ! ุฃุทูููุง ูุฑุฉ ุฃุฎุฑู pg_repack ุนูู ููุฒ ูุญุตููุง ุนูู 5 ุฃุฎุทุงุก ูู ุงููุฌููุนุฉ ุงูุฃููู ูู ุณุงุนุฉ ุนูู. ูุฐู ูุชูุฌุฉ ููุจููุฉ. ููุน ุฐูู ุ ูู ุงููุฌููุนุฉ ุงูุซุงููุฉ ุจุงููุนู ุ ุฒุงุฏ ุนุฏุฏ ุงูุฃุฎุทุงุก ุนุฏุฉ ูุฑุงุช ูุงุถุทุฑุฑูุง ุฅูู ุฅููุงู pg_repack. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุงุฐุง ุญุตู ูุฐุงุ ูุนุชูุฏ ุงุญุชูุงู ุญุฏูุซ ุฎุทุฃ ุนูู ุนุฏุฏ ุงููุณุชุฎุฏููู ุงูุฐูู ูุนูููู ูู ููุช ูุงุญุฏ ูุน ููุณ ุงูุฃุฏูุงุช. ุนูู ูุง ูุจุฏู ุ ูู ุชูู ุงููุญุธุฉ ูุน ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูู ุงููุฌููุนุฉ ุงูุฃููู ุ ูุงูุช ููุงู ุชุบููุฑุงุช ุชูุงูุณูุฉ ุฃูู ุจูุซูุฑ ูู ุจููุฉ ุงูุจูุงูุงุช ุ ุฃู ููุง ููุท "ูุญุธูุธูู". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุชูุฌุญ ุงูููุฑุฉ. ูู ุชูู ุงููุญุธุฉ ุ ุฑุฃููุง ุฎูุงุฑูู ุขุฎุฑูู ููุญู: ุฅุนุงุฏุฉ ูุชุงุจุฉ ุฑูุฒ ุงูุชุทุจูู ุงูุฎุงุต ุจูุง ููุชุฎูู ุนู ุงููููุฏ ุงููุนููุฉ ุ ุฃู "ุชุนููู" pg_repack ููุนูู ูุนูู. ููุฏ ุงุฎุชุฑูุง ุงูุซุงูู.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุณุชุจุฏู ุงูููุงุฑุณ ูู ุฌุฏูู ุฌุฏูุฏ ุจูููุฏ ูุคุฌูุฉ ูู ุฌุฏูู ุงููุตุฏุฑ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุงู ุงูุบุฑุถ ูู ุงููุฑุงุฌุนุฉ ูุงุถุญูุง - ุฅุฐุง ูุงู ุงูุฌุฏูู ุงูุฃุตูู ูุญุชูู ุนูู ููุฏ ูุคุฌู ุ ูุนูุฏุฆุฐู ููุฌุฏูู ุงูุฌุฏูุฏ ุชุญุชุงุฌ ุฅูู ุฅูุดุงุก ูุซู ูุฐุง ุงูููุฏ ุ ูููุณ ุงูููุฑุณ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุงุฎุชุจุงุฑ ุชุบููุฑุงุชูุง ุ ูุชุจูุง ุงุฎุชุจุงุฑูุง ุจุณูุทูุง:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฌุฏูู ูุน ูููุฏ ูุคุฌูุฉ ูุณุฌู ูุงุญุฏ ุ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู ุงูุญููุฉ ุงูุชู ุชุชุนุงุฑุถ ูุน ุงูุณุฌู ุงูุญุงูู ุ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฌุฑุงุก ุชุญุฏูุซ - ูู ุชุนุฏ ุงูุจูุงูุงุช ุชุชุนุงุฑุถ ุ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุฑุชูุงุจ ุงูุชุบููุฑ.</font></font></li>
</ul><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test_table<font></font>
(<font></font>
  id <span class="hljs-type">serial</span>,<font></font>
  val <span class="hljs-type">int</span>,
  <span class="hljs-keyword">constraint</span> uk_test_table__val <span class="hljs-keyword">unique</span> (val) <span class="hljs-keyword">deferrable</span> <span class="hljs-keyword">initially</span> <span class="hljs-keyword">deferred</span> <font></font>
);<font></font>
</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table (val) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">0</span>);
<span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.10000</span> <span class="hljs-keyword">LOOP</span>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">0</span>) <span class="hljs-keyword">RETURNING</span> id <span class="hljs-keyword">INTO</span> v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id;
    <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุชุนุทูุช ุงููุณุฎุฉ ุงูุฃุตููุฉ ูู pg_repack ุฏุงุฆููุง ุนูุฏ ุงูุฅุฏุฎุงู ุงูุฃูู ุ ุนููุช ุงููุณุฎุฉ ุงููููุญุฉ ุฏูู ุฃุฎุทุงุก. </font><font style="vertical-align: inherit;">ุบุฑุงูุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐูุจ ุฅูู prod ููุฑุฉ โโุฃุฎุฑู ูุญุตู ุนูู ุฎุทุฃ ูู ููุณ ุงููุฑุญูุฉ ูู ูุณุฎ ุงูุจูุงูุงุช ูู ุฌุฏูู ุงูุณุฌู ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span>
DETAIL:  Key (id, index)=(100500, 42) already exists.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงููุถุน ุงูููุงุณููู: ูู ุดูุก ูุนูู ูู ุจูุฆุงุช ุงูุงุฎุชุจุงุฑ ุ ูููู ููุณ ุนูู ููุฒ ุ!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APPLY_COUNT ูุงูููุตู ูู ุฏูุนุชูู</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุจุฏุฃูุง ูู ุชุญููู ุงูุดูุฑุฉ ุญุฑููุงู ุณุทุฑุงู ุจุณุทุฑ ููุฌุฏูุง ููุทุฉ ูููุฉ: ูุชู ููู ุงูุจูุงูุงุช ูู ุฌุฏูู ุงูุณุฌู ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ ูุน ุฏูุนุงุช ุ ูุดูุฑ ุซุงุจุช APPLY_COUNT ุฅูู ุญุฌู ุงูุฏูุนุงุช:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">for</span> (;;)<font></font>
{<font></font>
num = apply_log(connection, table, APPLY_COUNT);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (num &gt; MIN_TUPLES_BEFORE_SWITCH)
     <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">/* there might be still some tuples, repeat. */</span><font></font>
...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุชููู ุงููุดููุฉ ูู ุฃู ุจูุงูุงุช ุงููุนุงููุฉ ุงูุฃุตููุฉ ุ ุงูุชู ูููู ุฃู ุชูุชูู ูููุง ุนุฏุฉ ุนูููุงุช ุงูููุฏ ุ ูููู ููููุง ุฅูู ููุตู ุฏูุนุชูู ุฃุซูุงุก ุงูุชุญููู - ุณูุชู ุชุฎุตูุต ูุตู ุงููุฑู ูู ุงููุจุงุฑุงุฉ ุงูุฃููู ูุงููุตู ุงูุขุฎุฑ ูู ุงูุซุงููุฉ. ูุฅููู ููู ูุญุธูุธ: ุฅุฐุง ูู ุชูุชูู ุงููุฑู ูู ุงูุฏูุนุฉ ุงูุฃููู ุฃู ุดูุก ุ ูุฅู ูู ุดูุก ุนูู ูุง ูุฑุงู ุ ูููู ุฅุฐุง ุงูุชูููุง - ูุญุฏุซ ุฎุทุฃ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APPLY_COUNT ูุณุงูู 1000 ุฅุฏุฎุงู ุ ููู ูุง ููุณุฑ ุณุจุจ ูุฌุงุญ ุงุฎุชุจุงุฑุงุชูุง - ูู ูุบุทููุง ุญุงูุฉ "ุชูุงุทุน ุงูุฏููุนุงุช". ุงุณุชุฎุฏููุง ุฃูุฑูู - ุฅุฏุฑุงุฌ ูุชุญุฏูุซ ุ ูุฐูู ุชู ูุถุน 500 ูุนุงููุฉ ุจุงูุถุจุท ููุฑูููู ุฏุงุฆููุง ูู ุงูุฏูุนุฉ ููู ููุงุฌู ูุดุงูู. ุจุนุฏ ุฅุถุงูุฉ ุงูุชุญุฏูุซ ุงูุซุงูู ุ ุชููู ุงูุชุญุฑูุฑ ุนู ุงูุนูู:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.10000</span> <span class="hljs-keyword">LOOP</span>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>) <span class="hljs-keyword">RETURNING</span> id <span class="hljs-keyword">INTO</span> v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id; <span class="hljs-comment">-- one more update</span>
    <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐุง ุ ูุฅู ุงููููุฉ ุงูุชุงููุฉ ูู ุงูุชุฃูุฏ ูู ุฃู ุงูุจูุงูุงุช ูู ุงูุฌุฏูู ุงููุตุฏุฑ ุงูุชู ุชุบูุฑุช ูู ูุนุงููุฉ ูุงุญุฏุฉ ุชูุน ูู ุงูุฌุฏูู ุงูุฌุฏูุฏ ุฃูุถูุง ุฏุงุฎู ููุณ ุงููุนุงููุฉ.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฑูุถ ุงูุฌุฒุงุฑ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุฑุฉ ุฃุฎุฑู ูุงู ูุฏููุง ุญูุงู. </font><font style="vertical-align: inherit;">ุฃููุงู: ุฏุนูุง ูุชุฎูู ุชูุงููุง ุนู ุงูุชุฌููุน ููููู ุจููู ุงูุจูุงูุงุช ูู ูุนุงููุฉ ูุงุญุฏุฉ. </font><font style="vertical-align: inherit;">ูุตุงูุญ ูุฐุง ุงูุญู ูุงูุช ุจุณุงุทุชู - ูุงูุช ุงูุชุบููุฑุงุช ุงูุจุฑูุฌูุฉ ุงููุทููุจุฉ ุถุฆููุฉ (ุจุงูููุงุณุจุฉ ุ ูู ุงูุฅุตุฏุงุฑุงุช ุงููุฏููุฉ ุซู ุนููุช pg_reorg ุจูุฐู ุงูุทุฑููุฉ). </font><font style="vertical-align: inherit;">ููู ููุงู ูุดููุฉ - ูุญู ููุดุฆ ุตููุฉ ุทูููุฉ ุ ููุฐุง ุ ููุง ููู ุณุงุจููุง ุ ูุดูู ุชูุฏูุฏูุง ูุธููุฑ ููุชูุฎ ุฌุฏูุฏ.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุญู ุงูุซุงูู ุฃูุซุฑ ุชุนููุฏูุง ุ ูููู ุฑุจูุง ูููู ุฃูุซุฑ ุตุญุฉ: ูู ุจุฅูุดุงุก ุนููุฏ ูู ุฌุฏูู ุงูุณุฌู ุจูุนุฑู ุงููุนุงููุฉ ุงูุฐู ุฃุถุงู ุงูุจูุงูุงุช ุฅูู ุงูุฌุฏูู. ุจุนุฏ ุฐูู ุ ุนูุฏ ูุณุฎ ุงูุจูุงูุงุช ุ ุณูุชููู ูู ุชุฌููุนูุง ุญุณุจ ูุฐู ุงูุณูุฉ ูุงูุชุฃูุฏ ูู ููู ุงูุชุบููุฑุงุช ุฐุงุช ุงูุตูุฉ ูุนูุง. ุณูุชู ุชุดููู ุงูุฏูุนุฉ ูู ุนุฏุฉ ูุนุงููุงุช (ุฃู ูุงุญุฏุฉ ูุจูุฑุฉ) ูุณูุฎุชูู ุญุฌููุง ุงุนุชูุงุฏูุง ุนูู ููุฏุงุฑ ุงูุจูุงูุงุช ุงูุชู ุชู ุชุบููุฑูุง ูู ูุฐู ุงููุนุงููุงุช. ูู ุงูููู ููุงุญุธุฉ ุฃูู ูุธุฑูุง ูุฃู ุจูุงูุงุช ุงููุนุงููุงุช ุงููุฎุชููุฉ ุชูุน ูู ุฌุฏูู ุงูุณุฌู ุจุชุฑุชูุจ ุนุดูุงุฆู ุ ููู ูููู ูู ุงููููู ูุฑุงุกุชูุง ุจุงูุชุณูุณู ุ ููุง ูุงู ูู ูุจู. ุฅู seqscan ููู ุทูุจ ุชูุช ุชุตููุชู ุจูุงุณุทุฉ tx_id ุจุงูุธ ุงูุซูู ุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู ููุฑุณ ุ ููููู ุณูุจุทุฆ ุงูุทุฑููุฉ ุจุณุจุจ ุงููููุงุช ุงูุนุงูุฉ ูุชุญุฏูุซู. ุจุดูู ุนุงู ุ ููุง ูู ุงูุญุงู ุฏุงุฆููุง ุ ุชุญุชุงุฌ ุฅูู ุงูุชุถุญูุฉ ุจุดูุก ูุง.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐุง ุ ูุฑุฑูุง ุงูุจุฏุก ุจุงูุฎูุงุฑ ุงูุฃูู ูุฎูุงุฑ ุฃุจุณุท. ุฃููุงู ุ ูุงู ูู ุงูุถุฑูุฑู ููู ูุง ุฅุฐุง ูุงูุช ุงูุตููุฉ ุงูุทูููุฉ ุณุชููู ูุดููุฉ ุญููููุฉ. ูุธุฑูุง ูุฃู ุงูููู ุงูุฑุฆูุณู ููุจูุงูุงุช ูู ุงูุฌุฏูู ุงููุฏูู ุฅูู ุงูุฌุฏูู ุงูุฌุฏูุฏ ูุญุฏุซ ุฃูุถูุง ูู ูุนุงููุฉ ูุงุญุฏุฉ ุทูููุฉ ุ ููุฏ ุชุญูู ุงูุณุคุงู ุฅูู "ูู ุณูุฒูุฏ ูุฐู ุงููุนุงููุฉุ" ุชุนุชูุฏ ูุฏุฉ ุงููุนุงููุฉ ุงูุฃููู ุจุดูู ุฃุณุงุณู ุนูู ุญุฌู ุงูุฌุฏูู. ุชุนุชูุฏ ูุฏุฉ ุงูุชุบููุฑ ุงูุฌุฏูุฏ ุนูู ุนุฏุฏ ุงูุชุบููุฑุงุช ุงููุชุฑุงููุฉ ูู ุงูุฌุฏูู ุฃุซูุงุก ููู ุงูุจูุงูุงุช ุ ุฃู ูู ุดุฏุฉ ุงูุญูู. ุญุฏุซ ุชุดุบูู pg_repack ุฃุซูุงุก ุงูุญุฏ ุงูุฃุฏูู ููุญูู ุนูู ุงูุฎุฏูุฉ ุ ููุงู ููุฏุงุฑ ุงูุชุบููุฑ ุตุบูุฑูุง ุจุดูู ูุง ููุงุฑู ููุงุฑูุฉ ุจุญุฌู ุงูุฌุฏูู ุงูุฃุตูู. ูุฑุฑูุง ุฃูู ูููููุง ุฅููุงู ููุช ุงููุนุงููุฉ ุงูุฌุฏูุฏุฉ (ููููุงุฑูุฉ ุ ูุฐุง ูุชูุณุท โโุณุงุนุฉ ูุงุญุฏุฉ ู 2-3 ุฏูุงุฆู).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุงูุช ุงูุชุฌุงุฑุจ ุฅูุฌุงุจูุฉ. ูุนูู ุนูู ููุฒ ุฃูุถุง. ููุชูุถูุญ ุ ุตูุฑุฉ ุจุญุฌู ุฅุญุฏู ุงูููุงุนุฏ ุจุนุฏ ุงูุชุดุบูู: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z4/ps/gu/z4psgu_s8jsbhwnxst2pogfcsfa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุธุฑูุง ูุฃู ูุฐุง ุงูุญู ููุงุณุจูุง ุชูุงููุง ุ ูุฅููุง ูู ูุญุงูู ุชูููุฐ ุงูุซุงููุฉ ุ ูููููุง ูููุฑ ูู ููุงูุดุชูุง ูุน ูุทูุฑู ุงูุฅุถุงูุฉ. ูุณูุก ุงูุญุธ ุ ูุฅู ูุฑุงุฌุนุชูุง ุงูุญุงููุฉ ููุณุช ุฌุงูุฒุฉ ูููุดุฑ ุจุนุฏ ุ ูุฃููุง ูู ูุญู ุงููุดููุฉ ุฅูุง ูู ุฎูุงู ูููุฏ ูุนููุฉ ูุฑูุฏุฉ ุ ููู ุฃุฌู ุชุตุญูุญ ูุงูู ุ ูู ุงูุถุฑูุฑู ุชูุฏูู ุงูุฏุนู ูุฃููุงุน ุฃุฎุฑู. ูุฃูู ุฃู ูููู ูุงุฏุฑูู ุนูู ุงูููุงู ุจุฐูู ูู ุงููุณุชูุจู.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฑุจูุง ูุฏูู ุณุคุงู ุ ููุงุฐุง ุดุงุฑููุง ูู ูุฐู ุงููุตุฉ ูุน ุงูุงูุชูุงุก ูู pg_repack ุ ููู ูุณุชุฎุฏู ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุธุงุฆุฑูุงุ </font><font style="vertical-align: inherit;">ูู ูุฑุญูุฉ ูุง ุ ููุฑูุง ุฃูุถูุง ูู ุฐูู ุ ููู ุงูุชุฌุฑุจุฉ ุงูุฅูุฌุงุจูุฉ ูุงุณุชุฎุฏุงูู ูู ููุช ุณุงุจู ุ ุนูู ุทุงููุงุช ุฏูู ูููุฏ ูุนููุฉ ุ ุญูุฒุชูุง ุนูู ูุญุงููุฉ ููู ุฌููุฑ ุงููุดููุฉ ูุฅุตูุงุญูุง. </font><font style="vertical-align: inherit;">ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุงุณุชุฎุฏุงู ุญููู ุฃุฎุฑู ุ ูุณุชุบุฑู ุงูุฃูุฑ ุฃูุถูุง ููุชูุง ูุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑุงุช ุ ูุฐูู ูุฑุฑูุง ุฃููุงู ุฃููุง ุณูุญุงูู ุฅุตูุงุญ ุงููุดููุฉ ูููุง ุ ูุฅุฐุง ุฃุฏุฑููุง ุฃูู ูุง ูููููุง ุงูููุงู ุจุฐูู ูู ูุชุฑุฉ ุฒูููุฉ ูุนูููุฉ ุ ูุณูุจุฏุฃ ูู ุงูุชูููุฑ ูู ูุธุงุฆุฑูุง.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูููุฌูุฏุงุช</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุง ูููู ุฃู ููุตู ุจู ุจูุงุกู ุนูู ุชุฌุฑุจุชูุง ุงูุฎุงุตุฉ:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฑุงูุจ ุงูุชูุงุฎู. </font><font style="vertical-align: inherit;">ุงุณุชูุงุฏูุง ุฅูู ุจูุงูุงุช ุงููุฑุงูุจุฉ ุ ููููู ููู ูุฏู ุฌูุฏุฉ ุชูููู ุงููุฑุงุบ ุงูุชููุงุฆู.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุถุจุท AUTOVACUUM ููุญูุงุธ ุนูู ุงูุงูุชูุงุฎ ุนูุฏ ูุณุชูู ูุนููู.</font></font></li>
<li>   bloat           โ โ,     .  โ   .</li>
<li>        โ        ,     .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar499434/index.html">ููููุฉ ุชูููุฐ ุฅุฏุงุฑุฉ ุงููุนุฑูุฉ: ุงูุงุณุชูุงุฏุฉ ูู "ุงูุญูุงุฆุจ" ุ ู "ุบุฑุงูุงุช ุงูุจุจุบุงุก" ูุงูุชูููุฑ ูููุจ</a></li>
<li><a href="../ar499436/index.html">ูุนูู ุงูุฅูุฒูู ุงูุฐู ูุชู ุงูุชุญูู ููู ุนู ุจูุนุฏ ุนูู ุชุณุฑูุน ุนูุงุฌ ุงูุณูุชุงุช ุงูุฏูุงุบูุฉ ูุฅุตุงุจุงุช ุงูุนููุฏ ุงูููุฑู</a></li>
<li><a href="../ar499438/index.html">ุฏูู ูููุฎุชุจุฑูู ูููุณ ููุท</a></li>
<li><a href="../ar499440/index.html">ููุง ูุชุจูุง ุฃุฑูุน ุทูุงุฑ ุขูู ูู ุงูุนุงูู ูููุงุทุฑุฉ ุงููุชุญููุฉ</a></li>
<li><a href="../ar499442/index.html">ุฅูุดุงุก ูุนุจุฉ ุณุจุงู Pseudo-3D: ุชูููุฐ ุงูุชูุงู ูุฅููุงุก ุงููุนุจุฉ</a></li>
<li><a href="../ar499446/index.html">ุงุฎุชุจุงุฑ ูุญูู ุฅููุงุน ุชูุณูู STEP ูู VR</a></li>
<li><a href="../ar499448/index.html">ุชุทุจูู SOLID ูุงูุนูุงุฑุฉ ุฐุงุช ุงูุทุจูุงุช ูู Node.js ุจุงุณุชุฎุฏุงู TypeScript ู InversifyJS</a></li>
<li><a href="../ar499450/index.html">ุงุฎุชูุงุฑ ุงููุนุฏุงุช ูุนุจุฉ ุงููุงุฑุณูุฉ ุจุงุณุชุฎุฏุงู ุนูู ุงููุฑุงุซุฉ / ุงูุชุทูุฑ ูู ุจูุซูู</a></li>
<li><a href="../ar499452/index.html">ุงูุญูุงุฉ ุงูููููุฉ ูุทุจูุจ ุงูุนููู ูู ุงูุนูุงุฏุฉ: ุนูุฏูุง ูููู ุงูุฃุทุจุงุก ุบูุฑ ูุงูููู</a></li>
<li><a href="../ar499454/index.html">ููุฏูู ูุจุงุดุฑ! ููุงุก ุชูุทูู Badoo ูู 21 ุฃุจุฑูู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>