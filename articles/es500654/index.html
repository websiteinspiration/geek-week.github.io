<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥üèæ üï¢ üë®üèª‚Äç‚úàÔ∏è WebRTC en Android: c√≥mo habilitar la codificaci√≥n de hardware en m√∫ltiples dispositivos ü§Ω üêÜ üê®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para las videollamadas en Badoo, utilizamos el est√°ndar WebRTC y el c√≥dec H.264. Si cree en la documentaci√≥n, este c√≥dec deber√≠a funcionar sin problem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebRTC en Android: c√≥mo habilitar la codificaci√≥n de hardware en m√∫ltiples dispositivos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/500654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para las videollamadas en Badoo, utilizamos el est√°ndar WebRTC y el c√≥dec H.264. </font><font style="vertical-align: inherit;">Si cree en la documentaci√≥n, este c√≥dec deber√≠a funcionar sin problemas en cualquier dispositivo Android desde Android 5.0. </font><font style="vertical-align: inherit;">Pero en la pr√°ctica, todo result√≥ no ser as√≠. </font><font style="vertical-align: inherit;">En este art√≠culo, hablar√© sobre las caracter√≠sticas de implementar la codificaci√≥n de hardware para el c√≥dec H.264 en WebRTC y c√≥mo hacer que funcione en m√°s dispositivos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tu/lt/w1/tultw1tnly1q-hovglpxdkzaax8.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© H.264?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se conecta a trav√©s de WebRTC, todos los dispositivos que participan en la sesi√≥n transmiten varios par√°metros de comunicaci√≥n, incluidos los c√≥decs de audio y video. Si los dispositivos admiten m√∫ltiples c√≥decs (por ejemplo, VP8 y H.264), los c√≥decs de prioridad para la plataforma se enumeran primero. Estos datos se usan en la etapa de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconciliaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en WebRTC, despu√©s de lo cual solo quedan los c√≥decs compatibles con todos los dispositivos. Un ejemplo de tales datos con descifrado se puede ver en este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documento</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso de las videollamadas, si uno de los dispositivos no admite el c√≥dec H.264, ambos dispositivos pueden cambiar, por ejemplo, al c√≥dec VP8, que es independiente de la implementaci√≥n de hardware en el dispositivo. </font><font style="vertical-align: inherit;">Pero nuestra aplicaci√≥n est√° disponible en una variedad de dispositivos, incluidos los tel√©fonos inteligentes de generaciones anteriores. </font><font style="vertical-align: inherit;">Por lo tanto, para las comunicaciones de video, quer√≠amos utilizar la codificaci√≥n de hardware siempre que sea posible: reduce la carga en el procesador y no consume tanta bater√≠a, lo cual es cr√≠tico para los dispositivos obsoletos. </font><font style="vertical-align: inherit;">El soporte de codificaci√≥n de hardware H.264 se implementa en una gran cantidad de dispositivos, a diferencia del mismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VP8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte H.264 en Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cree que la descripci√≥n del soporte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para formatos multimedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la decodificaci√≥n del perfil de l√≠nea base H.264 deber√≠a funcionar en todos los dispositivos Android y la codificaci√≥n, comenzando con Android 3.0. En Badoo, admitimos dispositivos que comienzan con Android 5.0, por lo que no deber√≠amos tener ning√∫n problema. Pero no fue tan simple: incluso en dispositivos con la quinta versi√≥n, encontramos una gran cantidad de caracter√≠sticas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øCon qu√© se puede conectar? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como sabe, al desarrollar un nuevo dispositivo en Android, cualquier fabricante debe pasar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paquete de pruebas de compatibilidad</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Se ejecuta en una PC conectada al dispositivo, y sus resultados deben enviarse a Google para confirmar que el dispositivo cumple con los requisitos del sistema operativo Android de la versi√≥n especificada. Solo despu√©s de eso, el gadget se puede lanzar al mercado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos interesados ‚Äã‚Äãen pruebas multimedia en este conjunto de pruebas y, m√°s espec√≠ficamente, en pruebas de codificaci√≥n y decodificaci√≥n de video. Decid√≠ detenerme en las pruebas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncodeDecodeTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DecoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ya que est√°n presentes en todas las versiones de Android desde 4.3. El gr√°fico del n√∫mero de l√≠neas de c√≥digo en estas pruebas se ve as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/td/g_/4p/tdg_4prrdcocytay8z7df_igw0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de la versi√≥n 4.3, la mayor√≠a de estas pruebas simplemente no exist√≠an, y su aumento significativo cay√≥ en las versiones 5 y 7. Por lo tanto, podemos decir que antes de la versi√≥n Android 4.3 Google no verific√≥ el cumplimiento de los dispositivos con sus especificaciones para codificar y decodificar video, sino en la versi√≥n 5.0 mejor√≥ enormemente esta verificaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que esto indica que a partir de la versi√≥n 5.0 con la codificaci√≥n, todo deber√≠a estar en orden. Pero, dada mi experiencia previa con la decodificaci√≥n de transmisi√≥n de video en Android, estaba seguro de que no era as√≠. Fue suficiente para ver la cantidad de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre codificaci√≥n en el grupo de Google </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debate-webrtc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los archivos fuente de WebRTC, que son de dominio p√∫blico, nos ayudaron a buscar dificultades. Consideremos con m√°s detalle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte H.264 en WebRTC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HardwareVideoEncoderFactory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un m√©todo con el nombre parlante isHardwareSupportedInCurrentSdkH264:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHardwareSupportedInCurrentSdkH264</span><span class="hljs-params">(MediaCodecInfo info)</span> </span>{
  <span class="hljs-comment">// First, H264 hardware might perform poorly on this model.</span>
  <span class="hljs-keyword">if</span> (H264_HW_EXCEPTION_MODELS.contains(Build.MODEL)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
  }<font></font>
  String name = info.getName();<font></font>
  <span class="hljs-comment">// QCOM H264 encoder is supported in KITKAT or later.</span>
  <span class="hljs-keyword">return</span> (name.startsWith(QCOM_PREFIX) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)
      <span class="hljs-comment">// Exynos H264 encoder is supported in LOLLIPOP or later.</span><font></font>
      || (name.startsWith(EXYNOS_PREFIX)<font></font>
             &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como podemos ver, el soporte para la codificaci√≥n de hardware en Android se implementa solo para los conjuntos de chips Qualcomm y Exynos. ¬øPor qu√© no hay soporte para otros conjuntos de chips en la implementaci√≥n est√°ndar de WebRTC? Lo m√°s probable es que esto se deba a las peculiaridades de la implementaci√≥n de los fabricantes de c√≥decs de hardware. Y a menudo es posible identificar estas caracter√≠sticas solo en producci√≥n, ya que no siempre es posible encontrar dispositivos particulares. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las descripciones de c√≥decs en el dispositivo se almacenan en el archivo media_codecs.xml. Aqu√≠, por ejemplo, est√° este archivo para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pixel XL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HUAWEI P8 lite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cuando recibe una lista de c√≥decs utilizando el m√©todo getCodecInfos () del objeto MediaCodecList, este archivo se analiza y se devuelven los c√≥decs almacenados en √©l. Esta operaci√≥n y el llenado correcto de este archivo por parte del fabricante est√°n cubiertos en la prueba CTS.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecListTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que tambi√©n aument√≥ de 160 l√≠neas de c√≥digo en Android 4.3 a 740 l√≠neas en Android 10. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Badoo, cambiamos el c√≥digo del m√©todo isHardwareSupportedInCurrentSdkH264, rechazando la lista de c√≥dec "blanco" y reemplaz√°ndolo con una lista "negra" de prefijos de c√≥dec de programa que se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enumeran</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en WebRTC:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] SOFTWARE_IMPLEMENTATION_PREFIXES = {<span class="hljs-string">"OMX.google."</span>, <span class="hljs-string">"OMX.SEC."</span>};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no puede simplemente tomar e implementar el soporte para todos los c√≥decs sin prestar atenci√≥n a las caracter√≠sticas de los fabricantes. </font><font style="vertical-align: inherit;">Por los nombres de los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dedicados a la codificaci√≥n de hardware en Android en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grupo discusion-webrtc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , podemos entender que en este caso definitivamente encontraremos errores. </font><font style="vertical-align: inherit;">B√°sicamente, aparecen en la etapa de configuraci√≥n del c√≥dec.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opciones de configuraci√≥n de c√≥dec</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La inicializaci√≥n del c√≥dec para codificar es la siguiente:</font></font><br>
<br>
<pre><code class="java hljs">MediaCodec mediaCodec = createByCodecName(codecName);<font></font>
MediaFormat format = MediaFormat.createVideoFormat(mime, width, height);<font></font>
format.setInteger(MediaFormat.KEY_BIT_RATE, targetBitrateBps);<font></font>
format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateConstant);<font></font>
format.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);<font></font>
format.setInteger(MediaFormat.KEY_FRAME_RATE, targetFps);<font></font>
format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, keyFrameIntervalSec);<font></font>
mediaCodec.configure(format, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es f√°cil cometer un error en algunos de estos par√°metros, lo que generar√° una excepci√≥n durante la configuraci√≥n del c√≥dec e interrumpir√° la aplicaci√≥n. </font><font style="vertical-align: inherit;">Adem√°s, cuando trabaje con un c√≥dec, es posible que deba ajustar su velocidad de bits dependiendo de varios factores, ya que el c√≥dec lo hace mal. </font><font style="vertical-align: inherit;">Para esto, en WebRTC, la clase </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">responsable</font></a><font style="vertical-align: inherit;"> , que tiene dos descendientes:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DynamicBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ajusta la tasa de bits seg√∫n la cantidad de datos</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramerateBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ajusta la velocidad de bits en funci√≥n de la velocidad de fotogramas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consecuencia, para cada c√≥dec, debe elegir su propio mecanismo de ajuste de velocidad de bits. </font><font style="vertical-align: inherit;">Consideremos con m√°s detalle las caracter√≠sticas de establecer par√°metros de inicializaci√≥n para c√≥decs de hardware.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resoluci√≥n de la corriente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de recibir el objeto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecInfo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el c√≥dec, </font><font style="vertical-align: inherit;">puede examinar el c√≥dec con m√°s detalle obteniendo sus capacidades en la clase </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CodecCapabilities</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A partir de ellos, puede averiguar si el c√≥dec admite la resoluci√≥n y la velocidad de fotogramas seleccionadas. </font><font style="vertical-align: inherit;">Si admite estos par√°metros, se pueden configurar de forma segura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, a veces esta regla no funciona. </font><font style="vertical-align: inherit;">Nos enfrentamos al hecho de que los c√≥decs con el prefijo "OMX.MARVELL". </font><font style="vertical-align: inherit;">codificado incorrectamente, mostrando franjas verdes en los bordes de la pantalla si la resoluci√≥n de la transmisi√≥n fue diferente de 4: 3. </font><font style="vertical-align: inherit;">Al mismo tiempo, el c√≥dec mismo afirm√≥ que la resoluci√≥n seleccionada y la velocidad de cuadros son compatibles.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo de velocidad de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El modo est√°ndar para todos los c√≥decs de video es una tasa de bits constante. </font><font style="vertical-align: inherit;">Sin embargo, una vez que tuvimos que usar una tasa de bits variable:</font></font><br>
<br>
<pre><code class="java hljs">format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateVariable);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto sucedi√≥ en un dispositivo Lenovo A1000 con el chipset Spreadtrum (ahora Unisoc) comenzando con el prefijo "OMX.sprd". </font><font style="vertical-align: inherit;">Una b√∫squeda en Internet nos llev√≥ a una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publicaci√≥n de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seis a√±os en Firefox OS que describe este problema y c√≥mo resolverlo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formato de color</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al usar el c√≥dec en modo byte-buffer, debe seleccionar el formato correcto. </font><font style="vertical-align: inherit;">Esto generalmente se hace usando una funci√≥n de la siguiente forma:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Nullable</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> Integer <span class="hljs-title">selectColorFormat</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] supportedColorFormats, CodecCapabilities capabilities)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> supportedColorFormat : supportedColorFormats) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> codecColorFormat : capabilities.colorFormats) {
      <span class="hljs-keyword">if</span> (codecColorFormat == supportedColorFormat) {
        <span class="hljs-keyword">return</span> codecColorFormat;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En t√©rminos generales, siempre se selecciona el primero de los formatos de color admitidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, en el caso de los c√≥decs HUAWEI que comienzan con los prefijos "OMX.IMG.TOPAZ.", "OMX.hisi". </font><font style="vertical-align: inherit;">y "OMX.k3.", no funcion√≥, y despu√©s de una larga b√∫squeda encontramos una soluci√≥n: no importa qu√© formato devuelvan estos c√≥decs, debe usar el formato </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLOR_FormatYUV420SemiPlanar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hilo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos ayud√≥ a </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;">resolver esto</font></a><font style="vertical-align: inherit;"> en un foro chino.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajuste de tasa de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo est√°ndar de WebRTC contiene lo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siguiente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> BitrateAdjuster <span class="hljs-title">createBitrateAdjuster</span><span class="hljs-params">(VideoCodecMimeType type, String codecName)</span> </span>{
  <span class="hljs-keyword">if</span> (codecName.startsWith(EXYNOS_PREFIX)) {
    <span class="hljs-keyword">if</span> (type == VideoCodecMimeType.VP8) {
        <span class="hljs-comment">// Exynos VP8 encoders need dynamic bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DynamicBitrateAdjuster();<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Exynos VP9 and H264 encoders need framerate-based bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FramerateBitrateAdjuster();<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">// Other codecs don't need bitrate adjustment.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseBitrateAdjuster();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver en este c√≥digo, para todos los conjuntos de chips, excepto Exynos, el ajuste de velocidad de bits est√° desactivado. Pero esto solo se aplica a Qualcomm, ya que solo Exynos y Qualcomm son compatibles con el c√≥digo est√°ndar. Despu√©s de experimentar con varios valores de esta configuraci√≥n, y tambi√©n busc√≥ en Internet, descubrimos que para los c√≥decs con prefijos "OMX.MTK". Tambi√©n necesita ser encendido. Tambi√©n es necesario hacer esto para los c√≥decs HUAWEI que comienzan con el prefijo "OMX.IMG.TOPAZ.", "OMX.hisi". o "OMX.k3". Esto se debe al hecho de que estos c√≥decs no usan marcas de tiempo de cuadros para ajustar la tasa de bits, suponiendo que todos los cuadros vengan con el mismo conjunto de frecuencias al configurar el c√≥dec.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusi√≥n, dar√© una lista de c√≥decs que recibimos para dispositivos con Android 5.0 y 5.1. </font><font style="vertical-align: inherit;">Nos interesaron principalmente porque en las versiones m√°s recientes de Android la situaci√≥n est√° mejorando y los c√≥decs no est√°ndar son cada vez m√°s peque√±os. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto se puede ver en el siguiente gr√°fico. </font><font style="vertical-align: inherit;">La escala logar√≠tmica para mostrar mejor los casos raros. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/ng/ws/lengwsark1w8mgc0jmg95pptv_k.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como podemos ver, la mayor√≠a de los dispositivos ten√≠an chipsets Spreadtrum, MediaTek, HUAWEI y MARVELL, por lo que nuestros cambios ayudaron a activar la codificaci√≥n de hardware en estos dispositivos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque asumimos que algunos dispositivos tendr√≠an problemas para trabajar con H.264, Android nuevamente pudo sorprendernos. Como podemos ver en las estad√≠sticas de usuarios de Badoo, todav√≠a hay bastantes dispositivos en manos de los usuarios en 2014-2016, que no quieren o no pueden actualizar. Y aunque la situaci√≥n con el lanzamiento de actualizaciones de Android para nuevos dispositivos ya es mucho mejor que hace unos a√±os, la proporci√≥n de dispositivos de la generaci√≥n anterior est√° disminuyendo muy lentamente y tendr√° que mantenerse durante bastante tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora WebRTC est√° siendo desarrollado activamente por Google debido a su uso en el proyecto Stadia (aqu√≠ est√° el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con detalles sobre este tema), por lo que ser√° cada vez mejor y, lo m√°s probable, se convertir√° en el est√°ndar para implementar comunicaciones de video. </font><font style="vertical-align: inherit;">Espero que este art√≠culo lo ayude a comprender las caracter√≠sticas de trabajar con H.264 en WebRTC y usarlo en sus proyectos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es500640/index.html">C√≥mo hacer una empresa exitosa de outsourcing</a></li>
<li><a href="../es500642/index.html">Igrostroy: umbral para ingresar a la industria, especialidades y posibles ingresos</a></li>
<li><a href="../es500644/index.html">Random Coffee Habr Edition: redes para la comunidad de TI</a></li>
<li><a href="../es500646/index.html">Cocinar bytecode en la cocina JVM</a></li>
<li><a href="../es500648/index.html">¬øQu√© es un modelo arquitect√≥nico de madurez de la empresa?</a></li>
<li><a href="../es500656/index.html">Registro jer√°rquico de la aplicaci√≥n en la base de datos.</a></li>
<li><a href="../es500660/index.html">Una historia simplificada y muy breve del desarrollo de "nubes"</a></li>
<li><a href="../es500666/index.html">Certificaci√≥n en l√≠nea de Microsoft: usted, su espacio y su computadora</a></li>
<li><a href="../es500668/index.html">Control de motor inal√°mbrico de Lego usando Steam Controller</a></li>
<li><a href="../es500670/index.html">C√≥mo creamos nuestro producto. Primera parte, investigaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>