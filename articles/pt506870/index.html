<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚óºÔ∏è ü§æ ü§ûüèª Como desativar o aviso sobre os perigos de ouvir muito tempo o √°udio (Android) #‚É£ üï∞Ô∏è ü§ó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Provavelmente, muitos que ouvem m√∫sica (e n√£o apenas) de um dispositivo Android se deparam com este aviso:
 
 
 Neste artigo, veremos por que e quando...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como desativar o aviso sobre os perigos de ouvir muito tempo o √°udio (Android)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506870/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente, muitos que ouvem m√∫sica (e n√£o apenas) de um dispositivo Android se deparam com este aviso:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_i/gk/oa/_igkoaiik88g5pr8eooiezni-i8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, veremos por que e quando esse aviso ocorre e como garantir que ele n√£o ocorra mais.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparece apenas ao ouvir √°udio atrav√©s de um dispositivo externo (fones de ouvido / alto-falantes). Para quem n√£o encontrou isso, uma pequena explica√ß√£o: imagine que voc√™ est√° ouvindo m√∫sica com fones de ouvido, bem alto. De repente, o som fica mais baixo. Voc√™ est√° tentando aumentar o volume usando os bot√µes do estojo, mas n√£o d√° certo. Tirando o dispositivo do bolso e destrancando, voc√™ ver√° esse aviso. Somente ap√≥s acordo com ele ser√° poss√≠vel aumentar o volume novamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, o aviso √© razo√°vel, mas aparece em um momento imprevis√≠vel, √†s vezes o mais inadequado: quando voc√™ est√° em transporte p√∫blico / dirigindo / no inverno na rua / quando est√° com as m√£os sujas etc. </font><font style="vertical-align: inherit;">√â inconveniente remover o dispositivo, soltar a trava, aceitar o aviso, colocar o dispositivo novamente nesses casos. </font><font style="vertical-align: inherit;">E se os alto-falantes estiverem conectados, e n√£o os fones de ouvido, a mensagem n√£o ser√° totalmente apropriada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que surge</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este aviso n√£o √© uma iniciativa dos autores da plataforma. </font><font style="vertical-align: inherit;">O fato √© que existe um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">padr√£o WHO-ETU para</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúescuta segura‚Äù (escuta segura). </font><font style="vertical-align: inherit;">Na Europa e em alguns outros pa√≠ses, sua implementa√ß√£o √© obrigat√≥ria. </font><font style="vertical-align: inherit;">O padr√£o descreve quanto tempo voc√™ pode ouvir o √°udio, dependendo do volume, com risco m√≠nimo de perda auditiva. </font><font style="vertical-align: inherit;">Por exemplo, para um adulto, a "dose" segura semanal de som √© de 1,6 Pa </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h, o que equivale a 20 horas de audi√ß√£o a um volume de 83 dB.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lf/lm/xx/lflmxxcutic2hsnxzyh2i_mepyg.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dependendo do mcc (c√≥digo do pa√≠s m√≥vel), o modo de escuta segura pode ser ativado ou desativado. Isso √© determinado pelo valor do recurso </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o modo estiver ativado, o sistema calcula o tempo de audi√ß√£o em um volume n√£o seguro (acima de 85 dB) e armazena periodicamente o valor em uma vari√°vel </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Quando o valor atinge 20 horas, um aviso √© exibido. Depois de aceitar o aviso, o valor √© redefinido e a contagem come√ßa novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa implementa√ß√£o √© bastante simples e n√£o leva em conta, por exemplo, quanto tempo o usu√°rio ouviu essas 20 horas: talvez em alguns dias, ou talvez por 6-7 minutos por seis meses (de acordo com o padr√£o, isso n√£o √© uma amea√ßa para a audi√ß√£o). ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A l√≥gica de escuta segura est√° concentrada na classe de classe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioService.java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, voc√™ pode ver os campos correspondentes:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// mMusicActiveMs is the cumulative time of music activity since safe volume was disabled.</span>
<span class="hljs-comment">// When this time reaches UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX, the safe media volume is re-enabled</span>
<span class="hljs-comment">// automatically. mMusicActiveMs is rounded to a multiple of MUSIC_ACTIVE_POLL_PERIOD_MS.</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mMusicActiveMs;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX = (<span class="hljs-number">20</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 20 hours</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MUSIC_ACTIVE_POLL_PERIOD_MS = <span class="hljs-number">60000</span>;  <span class="hljs-comment">// 1 minute polling interval</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O campo </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cont√©m o n√∫mero de milissegundos ouvidos pelo usu√°rio em um volume inseguro desde a √∫ltima confirma√ß√£o do di√°logo. </font><font style="vertical-align: inherit;">O valor inicial √© carregado a partir da vari√°vel </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Na mesma vari√°vel, um novo valor de mMusicActiveMs √© gravado a cada minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° tamb√©m um campo </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que cont√©m o estado atual do sistema de escuta segura:</font></font><br>
<br>
<ul>
<li><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: fora</font></font></li>
<li><code>ACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: ativado e o limite de audi√ß√£o foi atingido, o que significa que voc√™ n√£o pode permitir que o usu√°rio aumente o volume at√© que ele concorde com o aviso</font></font></li>
<li><code>INACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: on, o limite ainda n√£o foi atingido</font></font></li>
</ul><br>
<pre><code class="java hljs">
<span class="hljs-comment">// mSafeMediaVolumeState indicates whether the media volume is limited over headphones.</span>
<span class="hljs-comment">// It is SAFE_MEDIA_VOLUME_NOT_CONFIGURED at boot time until a network service is connected</span>
<span class="hljs-comment">// or the configure time is elapsed. It is then set to SAFE_MEDIA_VOLUME_ACTIVE or</span>
<span class="hljs-comment">// SAFE_MEDIA_VOLUME_DISABLED according to country option. If not SAFE_MEDIA_VOLUME_DISABLED, it</span>
<span class="hljs-comment">// can be set to SAFE_MEDIA_VOLUME_INACTIVE by calling AudioService.disableSafeMediaVolume()</span>
<span class="hljs-comment">// (when user opts out).</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_NOT_CONFIGURED = <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_DISABLED = <span class="hljs-number">1</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_INACTIVE = <span class="hljs-number">2</span>;  <span class="hljs-comment">// confirmed</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_ACTIVE = <span class="hljs-number">3</span>;  <span class="hljs-comment">// unconfirmed</span>
<span class="hljs-keyword">private</span> Integer mSafeMediaVolumeState;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo para verificar o excesso do limite se parece com o seguinte:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCheckMusicActive</span><span class="hljs-params">(String caller)</span> </span>{
   <span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeState) {
       <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_INACTIVE) {
           <span class="hljs-keyword">int</span> device = getDeviceForStream(AudioSystem.STREAM_MUSIC);<font></font>
<font></font>
           <span class="hljs-keyword">if</span> ((device &amp; mSafeMediaVolumeDevices) != <span class="hljs-number">0</span>) {<font></font>
               sendMsg(mAudioHandler,<font></font>
                   MSG_CHECK_MUSIC_ACTIVE,<font></font>
                   SENDMSG_REPLACE,<font></font>
                   <span class="hljs-number">0</span>,
                   <span class="hljs-number">0</span>,<font></font>
                   caller,<font></font>
                   MUSIC_ACTIVE_POLL_PERIOD_MS);<font></font>
               <span class="hljs-keyword">int</span> index = mStreamStates[AudioSystem.STREAM_MUSIC].getIndex(device);
               <span class="hljs-keyword">if</span> (AudioSystem.isStreamActive(AudioSystem.STREAM_MUSIC, <span class="hljs-number">0</span>) &amp;&amp;<font></font>
                   (index &gt; safeMediaVolumeIndex(device))) {<font></font>
                   <span class="hljs-comment">// Approximate cumulative active music time</span><font></font>
                   mMusicActiveMs += MUSIC_ACTIVE_POLL_PERIOD_MS;<font></font>
                   <span class="hljs-keyword">if</span> (mMusicActiveMs &gt; UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX) {<font></font>
                       setSafeMediaVolumeEnabled(<span class="hljs-keyword">true</span>, caller);<font></font>
                       mMusicActiveMs = <span class="hljs-number">0</span>;<font></font>
                   }<font></font>
                   saveMusicActiveMs();<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como desativar um aviso</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desativar a escuta segura, voc√™ precisa garantir que a vari√°vel </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receba um valor durante a fase de configura√ß√£o </font></font><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver onde o valor √© definido inicialmente:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onConfigureSafeVolume</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> force, String caller)</span> </span>{<font></font>
   ...<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeEnabled =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.force"</span>, <span class="hljs-keyword">false</span>)<font></font>
                   || mContext.getResources().getBoolean(<font></font>
                 com.android.internal.R.bool.config_safe_media_volume_enabled);<font></font>
<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeBypass =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.bypass"</span>, <span class="hljs-keyword">false</span>);<font></font>
<font></font>
   <span class="hljs-keyword">int</span> persistedState;
   <span class="hljs-keyword">if</span> (safeMediaVolumeEnabled &amp;&amp; !safeMediaVolumeBypass) {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_ACTIVE;<font></font>
       <span class="hljs-comment">/*  ,  mSafeMediaVolumeState   ACTIVE,  INACTIVE */</span><font></font>
...<font></font>
   } <span class="hljs-keyword">else</span> {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
       mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que, al√©m do valor do recurso </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, existem duas propriedades que habilitam / desabilitam o sistema de escuta segura: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.force</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desativar o aviso, voc√™ precisa configurar o valor de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass = true</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo system / build.properties</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mas isso requer direitos de root. </font><font style="vertical-align: inherit;">Se n√£o estiverem, voc√™ precisar√° entender melhor e procurar outro caminho.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como desativar o aviso sem raiz</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que acontece quando voc√™ fecha a caixa de di√°logo de aviso clicando em OK e tente reproduzir isso:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-keyword">int</span> which)</span> </span>{<font></font>
        mAudioManager.disableSafeMediaVolume();<font></font>
    } </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo da </font></font><code>disableSafeMediaVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inst√¢ncia </font><font style="vertical-align: inherit;">√© chamado </font></font><code>AudioManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
* Only useful for volume controllers.
* <span class="hljs-doctag">@hide</span>
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disableSafeMediaVolume</span><span class="hljs-params">()</span> </span>{ ‚Ä¶ }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° marcado com uma anota√ß√£o </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Isso significa que o m√©todo n√£o ser√° inclu√≠do na API p√∫blica, apesar do modificador p√∫blico. </font><font style="vertical-align: inherit;">Antes do Android 9, isso poderia ser facilmente contornado usando reflex√£o. </font><font style="vertical-align: inherit;">Agora, no entanto, esse m√©todo ainda pode ser chamado, mas com a ajuda de um truque chamado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reflex√£o dupla</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> audioManager = getSystemService(Context.AUDIO_SERVICE) <span class="hljs-keyword">as</span> AudioManager
<span class="hljs-keyword">val</span> getDeclaredMethod = Class::<span class="hljs-keyword">class</span>.java.getDeclaredMethod(<span class="hljs-string">"getDeclaredMethod"</span>, String::<span class="hljs-keyword">class</span>.java, arrayOf&lt;Class&lt;*&gt;&gt;()::<span class="hljs-keyword">class</span>.java)
<span class="hljs-keyword">val</span> disableSafeMediaVolumeMethod = getDeclaredMethod.invoke(AudioManager::<span class="hljs-keyword">class</span>.java, <span class="hljs-string">"disableSafeMediaVolume"</span>, arrayOf&lt;Class&lt;*&gt;&gt;()) <span class="hljs-keyword">as</span> Method<font></font>
disableSafeMediaVolumeMethod.invoke(audioManager)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chamada termina com uma exce√ß√£o </font></font><br>
<code>java.lang.SecurityException: Only SystemUI can disable the safe media volume: Neither user 10307 nor current process has android.permission.STATUS_BAR_SERVICE.</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
: a permiss√£o STATUS_BAR_SERVICE possui protectionLevel = "signature | privilegied", mas n√£o funcionar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, ent√£o tente isso. </font><font style="vertical-align: inherit;">Monitoraremos a vari√°vel </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na qual o valor atual √© armazenado periodicamente </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Quando o valor come√ßar a se aproximar de 20 horas, n√≥s o redefiniremos. </font><font style="vertical-align: inherit;">Ent√£o voc√™ precisar√° fazer com que o AudioService leia o novo valor nas configura√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode </font><font style="vertical-align: inherit;">ler o valor </font><font style="vertical-align: inherit;">assim:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> unsafeMs = Settings.Secure.getInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A mesma coisa usando adb:</font></font><br>
<br>
<pre><code class="bash hljs"> adb shell settings get secure unsafe_volume_music_active_ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E para escrever o valor, o aplicativo precisar√° de permiss√£o </font></font><code>android.permission.WRITE_SECURE_SETTINGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Possui protectionLevel = "signature | privilegiado | </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", o que significa que ele pode ser retornado ao aplicativo usando adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell pm grant com.example.app android.permission.WRITE_SECURE_SETTINGS</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O valor em si pode ser escrito assim:</font></font><br>
<br>
<pre><code class="kotlin hljs">Settings.Secure.putInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>
, <span class="hljs-number">1</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode fazer o mesmo com o adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â melhor redefinir para 1, como √© feito no AudioManager, mas n√£o para 0. Como 0 corresponde ao estado ATIVO. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ precisa do AudioService para ler o novo valor e atualizar o valor da vari√°vel local </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe um m√©todo adequado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioManager.java</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
*  <span class="hljs-doctag">@hide</span>
*  Reload audio settings. This method is called by Settings backup
*  agent when audio settings are restored and causes the AudioService
*  to read and apply restored settings.
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reloadAudioSettings</span><span class="hljs-params">()</span> </span>{<font></font>
   ‚Ä¶<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele inicia uma chamada de m√©todo </font></font><code>readAudioSettings </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><code>AudioService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qual o carregamento </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das configura√ß√µes </font><font style="vertical-align: inherit;">ocorre </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readAudioSettings</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> userSwitch)</span> </span>{<font></font>
...<font></font>
<span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeStateLock) {<font></font>
        mMusicActiveMs = MathUtils.constrain(Settings.Secure.getIntForUser(mContentResolver,<font></font>
                Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS, <span class="hljs-number">0</span>, UserHandle.USER_CURRENT),
                <span class="hljs-number">0</span>, UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX);
        <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_ACTIVE) {<font></font>
            enforceSafeMediaVolume(TAG);<font></font>
        }<font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo est√° marcado com anota√ß√£o </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sua chamada usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reflex√£o dupla</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gera uma exce√ß√£o: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
java.lang.SecurityException: Permission Denial: a configura√ß√£o get / set do usu√°rio solicita a execu√ß√£o como usu√°rio -2, mas est√° chamando do usu√°rio 0; isso requer android.permission.INTERACT_ACROSS_USERS_FULL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, a anota√ß√£o </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui tamb√©m n√£o √© acidental. Obviamente, n√£o podemos obter essa permiss√£o. Possui protectionLevel = "signature | installer". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainda existe uma maneira de fazer com que o AudioService leia o novo valor - reiniciando-o. Voc√™ n√£o pode simplesmente reiniciar o servi√ßo do sistema. Voc√™ precisa reiniciar o dispositivo ou alternar para outro usu√°rio e depois voltar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora √© a hora de testar a teoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instalar</font></font><code>unsafe_volume_music_active_ms = 71 990 000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (10 segundos restantes, durante os quais voc√™ pode ouvir m√∫sica em volume alto)</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 71990000</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos o dispositivo (voc√™ pode alternar para outro usu√°rio e depois retornar):</font></font><br>
<br>
<pre><code class="bash hljs">adb reboot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectamos os fones de ouvido, ligamos a m√∫sica mais alto. </font><font style="vertical-align: inherit;">Um di√°logo aparece dentro de um minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora repetimos as mesmas a√ß√µes, mas atribu√≠mos unsafe_volume_music_active_ms = 1. Ligue a m√∫sica, aguarde um minuto. </font><font style="vertical-align: inherit;">A caixa de di√°logo n√£o aparece.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desativar o aviso, voc√™ pode fazer o seguinte: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ possui direitos de root</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Defina o valor de audio.safemedia.bypass = true no sistema de arquivos / build.properties </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem direitos de root</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ precisa monitorar o valor </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e impedir que ele ultrapasse </font><font style="vertical-align: inherit;">72.000.000 </font><font style="vertical-align: inherit;">(20 horas) ) </font><font style="vertical-align: inherit;">Ap√≥s redefinir o valor, voc√™ precisa reiniciar o dispositivo (ou alternar para outro usu√°rio e, em seguida, retornar). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu escrevi o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo para um aplicativo simples</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que faz esse trabalho e me lembra a necessidade de reiniciar o dispositivo / fazer login.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualizar</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os fabricantes de dispositivos podem fazer altera√ß√µes no c√≥digo da plataforma e, a julgar pelos coment√°rios, alguns deles atenuam o comportamento padr√£o. </font><font style="vertical-align: inherit;">Por exemplo, um aviso pode aparecer uma vez e n√£o ocorrer mais at√© a pr√≥xima reinicializa√ß√£o.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt506852/index.html">Como o messenger de criptografia de sinal resiste com √™xito √†s escutas telef√¥nicas pelas autoridades dos EUA</a></li>
<li><a href="../pt506860/index.html">23 de junho - NX Analyst Meetup # 3. Discutiremos entrevistas com clientes e trabalharemos com clientes complexos.</a></li>
<li><a href="../pt506864/index.html">Pr√≥xima vers√£o Linux 5.8: milh√µes de linhas de novo c√≥digo e 14.000 altera√ß√µes</a></li>
<li><a href="../pt506866/index.html">Base √önica de Seguros - Sistema para trabalhar com seguradoras</a></li>
<li><a href="../pt506868/index.html">Sam Altman: Gerando id√©ias</a></li>
<li><a href="../pt506872/index.html">Book Spring Boot 2: pr√°ticas recomendadas para profissionais</a></li>
<li><a href="../pt506874/index.html">Da vida de um programador: pessoas de neg√≥cios</a></li>
<li><a href="../pt506880/index.html">Joel Spolsky: como come√ßou a era do Stack Overflow</a></li>
<li><a href="../pt506886/index.html">Life hack para bits</a></li>
<li><a href="../pt506888/index.html">Classifica√ß√£o de dicas para Data Science</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>