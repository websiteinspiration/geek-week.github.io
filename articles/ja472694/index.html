<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏼 ❄️ 💩 Ceph以外：MCS Block Cloud Storage 🍏 🍏 🔌</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="「Flying Cart」、Afu Chan
 
 私は Mail.ru Cloud Solutonsで、私のクラウドを含め、アーキテクトおよび開発者として働いています。分散型クラウドインフラストラクチャには生産的なブロックストレージが必要であり、PaaSサービスとそれらを使用して構築されたソリュー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ceph以外：MCS Block Cloud Storage</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/472694/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wx/av/di/wxavdimhgftb4rj-bjzsjjbdwts.jpeg"></div><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Flying Cart」、Afu Chan</font></font></a></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mail.ru Cloud Solutonsで、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のクラウドを含め、アーキテクトおよび開発者</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">として働いてい</font></a><font style="vertical-align: inherit;">ます。分散型クラウドインフラストラクチャには生産的なブロックストレージが必要であり、PaaSサービスとそれらを使用して構築されたソリューションの運用が依存することが知られています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、このようなインフラストラクチャを展開するときにCephのみを使用していましたが、徐々にブロックストレージが進化しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ファイルストレージ、さまざまなサービスが最大のパフォーマンスで機能すること</font><font style="vertical-align: inherit;">を望んでいた</font><font style="vertical-align: inherit;">ため、ローカライズされたストレージを追加し、高度なCephモニタリングをセットアップしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それがどうだったかをお話しします-この話、私たちが遭遇した問題、そして私たちの解決策は、Cephを使用している人たちにも役立つでしょう。</font><font style="vertical-align: inherit;">ちなみに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このレポートの動画版です。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DevOpsプロセスから独自のクラウドへ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DevOpsプラクティスは、製品をできるだけ早く展開することを目的としています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスの自動化-ライフサイクル全体：組み立て、テスト、テストへの配信、生産。</font><font style="vertical-align: inherit;">小さなステップから始めて、プロセスを徐々に自動化します。</font></font><br>
</li>
<li>   — ,        .   ,      ,    .       ,  «»  —    ,   .       ,      —   «  ».<br>
</li>
<li>   —   ,  ,       ,        .<br>
</li>
</ul><br>
<img src="https://habrastorage.org/webt/wz/im/rw/wzimrwndijvqdzrmn6pjlunr_ci.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての仮想環境のアーキテクチャは類似しています。コンテナ、アプリケーション、パブリックネットワークとプライベートネットワーク、ストレージを備えたゲストマシン。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
徐々に、ますます多くのサービスがDevOpsプロセスに組み込まれた仮想インフラストラクチャに展開され、仮想環境はテスト（開発とテストに使用）だけでなく、生産性も高まっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、初期段階では、最も単純な基本的な自動化ツールによってバイパスされます。しかし、新しいツールが引き寄せられるようになると、遅かれ早かれ、Terraformのような最も高度なツールを使用するために、本格的なクラウドプラットフォームを展開する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、「ハイパーバイザ、ネットワーク、ストレージ」の仮想インフラストラクチャは、プロセスを調整するための開発されたツールとコンポーネントを備えた本格的なクラウドインフラストラクチャに変わります。次に、独自のクラウドが表示され、既存のサービスに対する更新のテストと自動配信のプロセス、および新しいサービスの展開が行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自のクラウドへの2番目の方法は、外部リソースと外部サービスプロバイダーに依存しない、つまり、独自のサービスに技術的な独立性を提供する必要がないことです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5y/wb/pm/5ywbpmuwrruww-bfep4f34p4eja.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のクラウドは、仮想インフラストラクチャ（ハイパーバイザ（1つまたは複数）、コンテナを備えた仮想マシン、共有ストレージ）のように見えます。独自のソリューションを使用せずにクラウドを構築する場合、通常はCephまたはDRBDです。</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プライベートクラウドの復元力とパフォーマンス</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドは成長しており、ビジネスはますますクラウドに依存しており、同社はより高い信頼性を要求し始めています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、分散がプライベートクラウドに追加され、分散クラウドインフラストラクチャが表示されます。機器が配置されている追加のポイントです。</font><font style="vertical-align: inherit;">クラウドは、フォールトトレラントソリューションを提供するために構築された2つ、3つ、またはそれ以上のインストールを管理します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、すべてのサイトからのデータが必要であり、問​​題があります。1つのサイト内ではデータ転送に大きな遅延はありませんが、サイト間でのデータ転送はより遅くなります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q6/__/3m/q6__3mcgjw-wsknmxy-etas8oky.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設置場所と共通保管場所。</font><font style="vertical-align: inherit;">赤い長方形はネットワークレベルでのボトルネックです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理ネットワークまたはパブリックネットワークの観点から見たインフラストラクチャの外部部分はそれほどビジーではありませんが、内部ネットワークでは転送されるデータ量がはるかに大きくなります。そして、分散システムでは、長いサービス時間で表される問題が始まります。クライアントがストレージノードの1つのグループに来る場合、変更が失われないように、データは2番目のグループに即座に複製される必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くのプロセスでは、データレプリケーションのレイテンシは許容範囲内ですが、トランザクション処理などの場合、トランザクションが失われることはありません。非同期レプリケーションが使用されている場合、ストレージシステム（データストレージシステム）の「テール」の1つに障害が発生すると、データの一部が失われる可能性があるタイムラグが発生します。同期レプリケーションを使用すると、サービス時間が増加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ストレージでの操作の待機時間が増加すると、データベースの速度が低下し、対処しなければならない悪影響があるのも当然です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドでは、信頼性とパフォーマンスを維持するためのバランスの取れたソリューションを求めています。最も簡単な手法は、データをローカライズすることです。その後、ローカライズされたCephクラスターを追加しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/_g/k3/qf_gk33i3esefh0xgnjuhegczia.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">緑色は、ローカライズされた追加のCephクラスターを示します。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような複雑なアーキテクチャの利点は、高速なデータ入力/出力を必要とするユーザーがローカライズされたストレージを使用できることです。</font><font style="vertical-align: inherit;">2つのサイト内で完全な可用性が重要なデータは、分散クラスターにあります。</font><font style="vertical-align: inherit;">動作は遅くなりますが、その中のデータは両方のサイトに複製されます。</font><font style="vertical-align: inherit;">パフォーマンスが十分でない場合は、ローカライズされたCephクラスターを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのパブリッククラウドとプライベートクラウドは、要件に応じて負荷がさまざまな種類のストレージ（さまざまな種類のディスク）に展開されると、最終的にほぼ同じ作業パターンになります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceph診断：モニタリングを構築する方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャを展開して立ち上げたとき、その機能を確保し、時間と障害の数を最小限に抑えるときがきました。したがって、インフラストラクチャ開発の次のステップは、診断と監視の構築でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全体を通して監視タスクを検討してください。仮想クラウド環境には、アプリケーション、ゲストオペレーティングシステム、ブロックデバイス、ハイパーバイザー上のこのブロックデバイスのドライバー、ストレージネットワーク、および実際のストレージシステム（ストレージシステム）のアプリケーションのスタックがあります。そして、これらすべてはまだ監視によってカバーされていません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z1/nk/nk/z1nknkrnannwnfn2fa7jwf6w0jq.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視対象外の要素。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
監視はいくつかの段階で実装され、ディスクから始めます。読み取り/書き込み操作の数、ある程度の正確さ、サービス時間（メガバイト/秒）、キューの深さ、その他の特性を取得し、ディスクの状態に関するSMARTも収集します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2m/b_/7s/2mb_7s2vda6qq6dtem9iwsnlup8.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の段階：ディスクの監視について説明します。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
システムで何が行われているのかを完全に把握するには、ディスク監視だけでは不十分です。そのため、インフラストラクチャの重要な要素であるストレージシステムのネットワークを監視することにします。実際には2つあります。内部クラスターと、ストレージクラスターをハイパーバイザーに接続するクライアントです。ここでは、データパケット転送速度（1秒あたりのメガバイト数、1秒あたりのパケット数）、ネットワークキュー、バッファー、および場合によってはデータパスのサイズを取得します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/dd/wu/pnddwuxah0r9sngg8awzcxhzlom.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2段階：ネットワークの監視。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らはしばしばこれで止まりますが、ほとんどのインフラストラクチャが監視によってまだ閉じられていないため、これは実行できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パブリッククラウドとプライベートクラウドで使用されるすべての分散ストレージは、SDS、ソフトウェア定義ストレージです。それらは特定のベンダーのソリューション、オープンソースソリューションに実装でき、おなじみのテクノロジーのスタックを使用して自分で何かを行うことができます。ただし、これは常にSDSであり、これらのソフトウェアパーツの動作を監視する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mt/o5/cb/mto5cbnz456tvs6mg_6i-b5lm8o.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ3：ストレージデーモンの監視。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのCephオペレーターは、Ceph監視および制御デーモン（モニターおよびマネージャー、別名mgr）から収集されたデータを使用します。最初は同じ方法で進みましたが、この情報では不十分であることがすぐにわかりました。リクエストのハングに関する警告が遅れて表示されます。リクエストが30秒間ハングした後、それを確認しました。モニタリングに関しては、モニタリングがアラームを発している間、少なくとも3分が経過します。最良の場合、これは、ストレージとアプリケーションの一部が3分間アイドル状態になることを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然、監視を拡張することを決定し、Cephの主要な要素であるOSDデーモンにまで行きました。 Object Storageデーモンの監視から、OSDが認識したおおよその操作時間と、ハングしたリクエストの統計-誰が、いつ、どのPGでどのくらいの期間かを取得します。</font></font><br>
<br>
<h2>  Ceph       </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cephだけではいくつかの理由で十分ではありません。たとえば、データベースプロファイルを持つクライアントがあります。彼はすべてのデータベースをオールフラッシュクラスターに展開し、そこで発行されたレイテンシは問題ありませんでしたが、ダウンタイムに関する不満がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
監視システムでは、仮想環境クライアント内で何が起こっているかを確認することはできません。その結果、問題を特定するために、彼の仮想マシンからblktraceユーティリティを使用して要求された高度な分析を使用しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/ch/vk/ujchvkl3ozoarbjooedieuqzf80.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拡張分析の結果。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
分析結果には、フラグWおよびWSでマークされた操作が含まれます。 Wフラグはレコード、WSフラグは同期レコードで、デバイスが操作を完了するのを待機しています。データベースで作業する場合、ほとんどすべてのSQLデータベースにボトルネックがある-WAL（先読みログ）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースは常に最初にデータをログに書き込み、フラッシュバッファを使用してディスクから確認を受け取り、次にデータベース自体にデータを書き込みます。バッファリセットの確認を受け取っていない場合、彼女は電源リセットがクライアントによって確認されたトランザクションを消去できると信じています。これはデータベースでは受け入れられないため、「write SYNC / FLUSH」と表示されてからデータが書き込まれます。ログがいっぱいになると、ログの切り替えが発生し、ページキャッシュに入ったものもすべて強制的にフラッシュされます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加：画像自体にはリセットはありません。つまり、プレフラッシュフラグを使用した操作です。 FWS-プレフラッシュ+書き込み+同期またはFWSF-プレフラッシュ+書き込み+同期+ FUAのように見えます</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントに多数の小さなトランザクションがある場合、そのI / Oのほぼすべてが、書き込み-フラッシュ-書き込み-フラッシュの順次チェーンに変わります。データベースを使用して何かを行うことはできないため、ストレージシステムを使用して作業を開始します。現時点では、Cephの機能では不十分であることを理解しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちにとって、この段階での最良の解決策は、Cephを使用して実装されていない小さくて高速なローカルストレージを追加することでした（基本的にはその機能を使い果たしました）。そして、クラウドストレージをCeph以外のものに変えています。今回のケースでは、多くのローカルストーリーを追加しました（ハイパーバイザーではなく、データセンターの観点から見てローカル）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4o/hh/rr/4ohhrre0loyyk4gmxijlpwy6pry.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加のローカライズされたリポジトリターゲットAおよびB。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなローカルストレージのサービス時間は、ストリームあたり約0.3 msです。別のデータセンターにある場合は、動作が遅くなります。パフォーマンスは約0.7 msです。これは、1.2ミリ秒を生成し、データセンターに分散される2ミリ秒のCephと比較して大幅な増加です。ダース以上のそのような小さな工場のパフォーマンスは、モジュールあたり約10万、レコードあたり10万IOPSです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなインフラストラクチャの変更後、私たちのクラウドは、書き込みで100万IOPS、またはすべてのクライアントで合計約200万から300万IOPSを</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hw/zq/aj/hwzqajyzsmewq-s2h6iw8mnf4bk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
絞り出します。このタイプのストレージは主な拡張方法ではないことに注意してください。Cephに焦点を当てていますが、高速ストレージは、ディスクの応答時間を必要とするサービスでのみ重要です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいイテレーション：コードとインフラストラクチャの改善 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのストーリーは共有リソースです。</font><font style="vertical-align: inherit;">このようなインフラストラクチャでは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、サービスレベルポリシー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">実装する</font></b><font style="vertical-align: inherit;">必要があります。特定のレベルのサービスを提供し、ストレージを無効にすることで、あるクライアントが偶然または故意に別のクライアントに干渉できないようにする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、ファイナライズと重要なロールアウト（生産性への反復配信）を行う必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このロールアウトは通常のDevOpsプラクティスとは異なり、すべてのプロセス（アセンブリ、テスト、コードのロールアウト、必要に応じてサービスの再起動、ボタンのクリックから開始すると、すべてが機能します）。</font><font style="vertical-align: inherit;">DevOpsプラクティスをインフラストラクチャに展開すると、最初のエラーが発生するまで継続されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、「フルオートメーション」がインフラストラクチャチームに特に根付いたわけではありません。もちろん、テストと配信の自動化には特定のアプローチがありますが、それは常に制御され、配信はクラウドチームのSREエンジニアによって開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cinderバックエンド、Cinderフロントエンド（Cinderクライアント）、Novaサービスなど、いくつかのサービスで変更をロールアウトしました。変更は複数の反復で適用されました-一度に1つの反復。 3回目の反復の後、適切な変更がクライアントのゲストマシンに適用されました。誰かが移行した、誰かがVMを再起動した（ハードリブート）、または計画された移行でハイパーバイザーにサービスを提供しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に発生した問題は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、書き込み速度のジャンプです</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ネットワーク接続ストレージを使用する場合、デフォルトのハイパーバイザーはネットワークが低速であると見なすため、すべてのデータをキャッシュします。彼は数十メガバイトまですばやく書き込み、次にキャッシュのフラッシュを開始します。そのようなジャンプのために多くの不快な瞬間がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシュを有効にするとSSDのパフォーマンスが15％低下し、キャッシュをオフにするとHDDのパフォーマンスが35％低下することがわかりました。キャッシュが各タイプのディスクに明示的に割り当てられると、別の開発が必要になり、マネージドキャッシュ管理がロールアウトされました。これにより、キャッシュなしのSSDとキャッシュ付きのHDDをドライブできるようになり、その結果、パフォーマンスの低下が止まりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
製品に開発を提供する慣習は似ています-反復。コードをロールアウトし、デーモンを再起動してから、必要に応じて、ゲスト仮想マシンを再起動または移行します。これらは変更される可能性があります。 HDDから移行されたクライアントVM、そのキャッシュがオン-すべてが機能する、または逆に、SSDで移行されたクライアント、そのキャッシュがオフ-すべてが機能する。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の問題は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GOLDイメージからHDDにデプロイされた仮想マシンの誤動作</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くのそのようなクライアントがあり、状況の特異性は、VMの作業がそれ自体で調整されたことです。問題はデプロイ中に発生することが保証されていましたが、クライアントがテクニカルサポートに達したときに解決されました。最初は、VMが安定するまで30分待つようにお客様にお願いしましたが、その後、サービスの品質に取り組み始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
調査の過程で、監視インフラストラクチャの機能がまだ十分ではないことに気付きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bl/tj/ft/bltjftnwasbvxd_iep-wwfsepkw.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニタリングによって青い部分が閉じられ、問題はインフラストラクチャの上部にあり、モニタリングではカバーされませんでした。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
監視の対象外だったインフラストラクチャの部分で何が起こっているのかを理解し始めました。これを行うために、高度なCeph診断（または、Cephクライアントの一種であるlibrbd）を使用しました。彼らは、自動化ツールを使用して、Cephクライアント構成に変更を加え、Unixドメインソケットを介して内部データ構造にアクセスし、ハイパーバイザー上のCephクライアントから統計情報を取得し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何を見た？ Cephクラスター/ OSD /クラスターの統計は表示されませんでしたが、ディスクがCephにあるクライアント仮想マシンの各ディスクの統計、つまりデバイスに関連付けられた統計が表示されました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/us/hr/5j/ushr5jfx40pvedrcqwpvj9ai-qy.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高度なモニタリング統計結果。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
問題が他のディスクから複製されたディスクでのみ発生することを明らかにしたのは、拡張統計でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、操作、特に読み書き操作の統計を調べました。上位レベルのイメージの負荷は比較的小さく、クローンの元となる最初のイメージの負荷は大きいが、平衡状態ではない：まったく記録されていない大量の読み取りであることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題はローカライズされていますが、ソリューションが必要です-コードまたはインフラストラクチャ？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cephコードでは何もできません。「ハード」です。</font><font style="vertical-align: inherit;">さらに、顧客データの安全性はそれに依存しています。</font><font style="vertical-align: inherit;">しかし、問題があり、それを解決する必要があり、リポジトリのアーキテクチャを変更しました。</font><font style="vertical-align: inherit;">HDDクラスターがハイブリッドクラスターに変わりました。一定量のSSDがHDDに追加された後、OSDデーモンの優先度が変更され、SSDが常に優先され、配置グループ（PG）内のプライマリOSDになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、クライアントがクローンディスクから仮想マシンを展開すると、その読み取り操作はSSDに移ります。</font><font style="vertical-align: inherit;">その結果、ディスクからのリカバリが速くなり、元のイメージ以外のクライアントデータのみがHDDに書き込まれました。</font><font style="vertical-align: inherit;">ほぼ無料で（インフラストラクチャの初期コストに比べて）生産性が3倍に向上しました。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラの監視が重要な理由</font></font></h1><br>
<ol>
<li>        ,       .   ,     ,        ,       .<br>
</li>
<li>  ,     «»    .      ,    Ceph —  ,      ( 500   ),    .              .<br>
</li>
<li>      ,     - .   :     ,           ,   —     ,        .<br>
</li>
<li>  —     .   ,   .   —     ,      .        ,   .             —    ,   ,      .<br>
</li>
<li> MCS Cloud Solutions —  ,            .             .<br>
</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472682/index.html">C. elegansの薬物シナジーによる老化の減速</a></li>
<li><a href="../ja472684/index.html">fsync（）PostgreSQLへのサプライズ</a></li>
<li><a href="../ja472686/index.html">I486ベースのビデオスタジオ</a></li>
<li><a href="../ja472688/index.html">3Dゲームレンダリングのしくみ：頂点処理</a></li>
<li><a href="../ja472690/index.html">Zabbix 4.4の新機能</a></li>
<li><a href="../ja472702/index.html">JH Rainwater「猫の放牧方法」：プログラマーの品種とその育種の特徴</a></li>
<li><a href="../ja472708/index.html">ImpervaがCloud WAFハックの技術的詳細を明らかにした</a></li>
<li><a href="../ja472714/index.html">フロントランナーが仕事を探すためにどこに落ちないか：電報、スラック、そして</a></li>
<li><a href="../ja472716/index.html">サードパーティのアプリケーションコンテキストからSpring Beanを正しく取得する</a></li>
<li><a href="../ja472720/index.html">ERPが機能しない...代替手段は何ですか？時間通りに。ロシアは？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>