<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👨🏼 🤭 👶🏿 Portage d'API vers TypeScript comme solutionneur de problèmes 📧 🤴🏼 🤓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le frontend React du programme Execute a été converti de JavaScript en TypeScript. Mais le backend, écrit en Ruby, n'a pas touché. Cependant, les prob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Portage d'API vers TypeScript comme solutionneur de problèmes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499664/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le frontend React du programme Execute a été </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">converti</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de JavaScript en TypeScript. Mais le backend, écrit en Ruby, n'a pas touché. Cependant, les problèmes associés à ce backend ont amené les développeurs du projet à penser à passer de Ruby à TypeScript. La traduction du matériel que nous publions aujourd'hui est consacrée à l'histoire du portage du backend Execute Program de Ruby à TypeScript et aux problèmes que cela a permis de résoudre.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/hu/xl/8o/huxl8onleza7_5gvfndf7s-6sxm.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant le backend Ruby, nous oublions parfois que certaines propriétés API stockent un tableau de chaînes, pas une simple chaîne. Parfois, nous avons changé un fragment d'API accessible à différents endroits, mais nous avons oublié de mettre à jour le code dans l'un de ces endroits. Ce sont les problèmes habituels d'un langage dynamique qui sont caractéristiques de tout système dont le code n'est pas couvert à 100% par des tests. (Ceci, bien que moins courant, se produit lorsque le code est entièrement couvert par des tests.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En même temps, ces problèmes ont disparu du frontend depuis que nous l'avons basculé en TypeScript. J'ai plus d'expérience en programmation serveur qu'en client, mais malgré cela, j'ai fait plus d'erreurs en travaillant avec le backend, et non avec le frontend. Tout cela a indiqué que le backend devrait également être converti en TypeScript.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai porté le backend de Ruby vers TypeScript en mars 2019 en environ 2 semaines. Et tout a fonctionné comme il se doit! Nous avons déployé un nouveau code en production le 14 avril 2019. C'était une version bêta disponible pour un nombre limité d'utilisateurs. Après cela, rien ne s'est cassé. Les utilisateurs n'ont même rien remarqué. Voici un graphique illustrant l'état de notre base de code avant et immédiatement après la transition. L'axe des x représente le temps (en jours), l'axe des y représente le nombre de lignes de code.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b26/90c/6a7/b2690c6a794a02298ad7b124c812d9d5.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduction du frontend de JavaScript en TypeScript, et traduction du backend de Ruby en TypeScript</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pendant le processus de portage, j'ai écrit une grande quantité de code auxiliaire. Nous avons donc notre propre outil pour effectuer des tests avec un volume de 200 lignes. Nous avons une bibliothèque de 120 lignes pour travailler avec la base de données, ainsi qu'une plus grande bibliothèque de routage pour l'API, reliant le code frontal et principal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre propre infrastructure, la chose la plus intéressante à parler est le routeur. Il s'agit d'un wrapper pour Express, garantissant l'application correcte des types utilisés dans le code client et serveur. Cela signifie que lorsqu'une partie de l'API change, l'autre ne compile même pas sans y apporter de modifications pour éliminer les différences.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un gestionnaire d'arrière-plan qui renvoie une liste de billets de blog. </font><font style="vertical-align: inherit;">C'est l'un des fragments de code similaires les plus simples du système:</font></font><br>
<br>
<pre><code class="javascript hljs">router.handleGet(api.blog, <span class="hljs-keyword">async</span> () =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">return</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">posts</span>: blog.posts,<font></font>
&nbsp;&nbsp;}<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous changeons le nom </font></font><code>posts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font><font style="vertical-align: inherit;">la clé </font><font style="vertical-align: inherit;">en </font></font><code>blogPosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous obtenons une erreur de compilation, dont le texte est affiché ci-dessous (ici, par souci de concision, les informations sur les types d'objets sont omises.)</font></font><br>
<br>
<pre><code class="javascript hljs">Property <span class="hljs-string">'posts'</span> is missing <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span> but required <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span>.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque point de terminaison est défini par un objet de vue </font></font><code>api.someNameHere</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cet objet est partagé par le client et le serveur. </font><font style="vertical-align: inherit;">Notez que les types ne sont pas directement mentionnés dans la déclaration du gestionnaire. </font><font style="vertical-align: inherit;">Ils sont tous déduits de l'argument </font></font><code>api.blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche fonctionne pour les points de terminaison simples, tels que le point de terminaison décrit ci-dessus </font></font><code>blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais il convient aux points finaux plus complexes. </font><font style="vertical-align: inherit;">Par exemple, une API de noeud final pour travailler avec des leçons a une clé profondément imbriquée de type logique </font></font><code>.lesson.steps[index].isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Grâce à tout cela, il est désormais impossible de faire les erreurs suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous essayons d'accéder </font></font><code>isinteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au client, ou essayons de renvoyer une telle clé à partir du serveur, le code ne sera pas compilé. </font><font style="vertical-align: inherit;">Le nom de la clé doit ressembler </font></font><code>isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, avec une majuscule </font></font><code>I</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li>     <code>isInteractive</code>  —   .</li>
<li>    <code>isInteractive</code>    <code>number</code>,  , ,  .</li>
<li>     API, ,  <code>isInteractive</code> —  ,    , ,   ,           , , ,  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que tout cela inclut la génération de code. Cela se fait en utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io-ts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et quelques centaines de lignes de code provenant de notre propre routeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La déclaration des types d'API nécessite un travail supplémentaire, mais le travail est simple. Lors du changement de la structure de l'API, nous devons savoir comment la structure du code change. Nous apportons des modifications aux déclarations de l'API, puis le compilateur nous indique tous les endroits où le code doit être corrigé.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est difficile d'apprécier l'importance de ces mécanismes avant de les utiliser pendant un certain temps. Nous pouvons déplacer de gros objets d'un endroit dans l'API à un autre, renommer les clés, nous pouvons diviser de gros objets en parties, fusionner de petits objets en un seul objet, diviser ou fusionner des points de terminaison entiers. Et nous pouvons faire tout cela sans nous soucier du fait que nous avons oublié d'apporter les modifications appropriées au code client ou serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un vrai exemple. J'ai récemment passé environ 20 heures sur quatre jours de repos pour repenser le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">programme d'exécution d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> API </font><font style="vertical-align: inherit;">. Toute la structure de l'API a changé. Lors de la comparaison du nouveau code client et serveur avec l'ancien, des dizaines de milliers de changements de ligne ont été enregistrés. J'ai repensé le code de routage côté serveur (comme ci-dessus</font></font><code>handleGet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) J'ai réécrit toutes les déclarations de type pour l'API, apportant pour beaucoup d'entre elles d'énormes changements structurels. De plus, j'ai réécrit toutes les parties du client dans lesquelles les API modifiées ont été appelées. Au cours de ce travail, 246 des 292 fichiers source ont été modifiés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la plupart de ces travaux, je ne comptais que sur un système de type. Dans la dernière heure de ce cas de 20 heures, j'ai commencé à exécuter des tests qui, pour la plupart, se sont terminés avec succès. À la toute fin, nous avons effectué une série complète de tests et trouvé trois petites erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont toutes des erreurs logiques: des conditions qui ont accidentellement conduit le programme au mauvais endroit. En règle générale, un système de saisie n'aide pas à trouver de telles erreurs. Il a fallu plusieurs minutes pour corriger ces erreurs. Cette API repensée a été déployée il y a quelques mois. Lorsque vous lisez quelque chose sur</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est cette API qui publie les documents pertinents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ne signifie pas que le système de type statique garantit que le code sera toujours correct. Ce système ne permet pas de se passer de tests. Mais cela simplifie considérablement le refactoring. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous parler de la génération automatique de code. À savoir, nous utilisons des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schémas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour générer des définitions de type à partir de la structure de notre base de données. Le système se connecte à la base de données Postgres, analyse les types de colonnes et écrit les définitions de type TypeScript correspondantes dans le fichier normal </font></font><code>.d.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisé par l'application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un fichier avec les types de schéma de base de données est tenu à jour par notre script de migration à chaque lancement. Pour cette raison, nous n'avons pas à prendre en charge manuellement ces types. Les modèles utilisent des définitions de types de base de données pour garantir que le code d'application accède correctement à tout ce qui est stocké dans la base de données. Il n'y a ni tables manquantes, ni colonnes manquantes, ni entrées </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les colonnes non </font><font style="vertical-align: inherit;">prises </font><font style="vertical-align: inherit;">en charge </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous nous souvenons de traiter correctement </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les colonnes supportant </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Et tout cela est vérifié statiquement au moment de la compilation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela ensemble crée une chaîne fiable de transfert d'informations de type statique, s'étendant de la base de données aux propriétés des composants React dans le frontend:</font></font><br>
<br>
<ul>
<li>      ,     (    API)     ,          .</li>
<li>     API    ,   API,      (     )  .</li>
<li>  React-   ,   API,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En travaillant sur ce matériel, je ne pouvais pas me souvenir d'un seul cas d'incohérence dans le code associé à l'API qui a réussi la compilation. Nous n'avons pas eu d'échecs de production car le code client et serveur lié à l'API avait des idées différentes sur le formulaire de données. Et tout cela n'est pas le résultat de tests automatisés. Pour l'API elle-même, nous n'écrivons pas de tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela nous place dans une position extrêmement agréable: nous pouvons nous concentrer sur les parties les plus importantes de l'application. Je passe très peu de temps à faire des conversions de types. Beaucoup moins que ce que j'ai dépensé pour identifier les causes d'erreurs déroutantes qui ont traversé des couches de code écrites en Ruby ou JavaScript, puis ont provoqué d'étranges exceptions quelque part très loin de la source de l'erreur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici à quoi ressemble le projet après avoir traduit le backend en TypeScript. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir, beaucoup de code a été écrit depuis la transition. </font><font style="vertical-align: inherit;">Nous avons eu suffisamment de temps pour évaluer les conséquences de la décision.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/298/9b7/9ba/2989b79ba9dc2a646b7ebeac3ba834bd.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TypeScript est utilisé sur le frontend et le backend du projet.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici, nous n'avons pas soulevé la question habituelle pour de telles publications, qui est d'obtenir les mêmes résultats non pas en tapant, mais en utilisant des tests. </font><font style="vertical-align: inherit;">De tels résultats ne peuvent être obtenus en utilisant uniquement des tests. </font><font style="vertical-align: inherit;">Nous, très probablement, en parlerons davantage. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chers lecteurs! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avez-vous traduit des projets écrits dans d'autres langages en TypeScript?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499652/index.html">Y a-t-il une vie en développement après le décret</a></li>
<li><a href="../fr499654/index.html">Comment implémenter CRM sur un site distant et gagner?</a></li>
<li><a href="../fr499656/index.html">Simulation de régulateur de température PID</a></li>
<li><a href="../fr499658/index.html">Un ouvrier au lieu d'un testeur? Vaut-il la peine d'étudier le sélénium en 2020?</a></li>
<li><a href="../fr499662/index.html">Racine de confiance pour l'IoT et les autres tendances de sécurité IoT</a></li>
<li><a href="../fr499666/index.html">PEP 572 (expressions d'affectation en python 3.8)</a></li>
<li><a href="../fr499668/index.html">Dépendances JavaScript de Road to Hell</a></li>
<li><a href="../fr499670/index.html">Я перехожу на JavaScript</a></li>
<li><a href="../fr499674/index.html">Une autre étape vers les ordinateurs optiques</a></li>
<li><a href="../fr499676/index.html">Plus de 90 outils utiles pour Kubernetes: déploiement, gestion, surveillance, sécurité et plus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>