<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅 🏳️‍🌈 💅🏻 Desfoque da imagem de fundo do Unity 💢 👨🏿‍💻 ↕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma das tarefas que um desenvolvedor de aplicativos Unity pode encontrar é colocar a imagem atual em segundo plano para chamar a atenção do usuário pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Desfoque da imagem de fundo do Unity</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493452/"><img src="https://habrastorage.org/webt/jb/sq/go/jbsqgovdy74rajkik0r_o24tre8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das tarefas que um desenvolvedor de aplicativos Unity pode encontrar é colocar a imagem atual em segundo plano para chamar a atenção do usuário para algo novo, como um menu ou mensagem que aparece. O artigo fala sobre a experiência de resolver esse problema por um desenvolvedor que possui conhecimentos básicos no Unity, sem usar recursos externos ou uma licença adicional do Unity. Espero que este material seja útil para aqueles que enfrentaram um problema semelhante e não encontraram soluções eficazes em diferentes estágios do mesmo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Destacar elementos importantes da interface (e remover elementos desnecessários) é uma das principais ferramentas para melhorar a experiência do usuário. Isso é especialmente pronunciado ao trabalhar com aplicativos móveis. Essa troca de atenção pode ser feita de diferentes maneiras - afastando suavemente os botões além das bordas da tela, escurecendo o fundo, o comportamento dinâmico, etc. Isso inclui desfocar a imagem. Esse efeito, por um lado, reduz o contraste dos elementos do plano de fundo e fica mais difícil para os olhos perceberem. Por outro lado, o desfoque tem um efeito subconsciente quando a imagem fica desfocada, e a percebemos de maneira diferente. Essa abordagem é freqüentemente usada em jogos e, a partir de exemplos conhecidos de jogos no Unity, podemos nomear os momentos em que escolhemos o menu de missões de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hearthstone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou em</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tela de conclusão do duelo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora imagine que queremos fazer o mesmo ou semelhante em nosso aplicativo favorito. </font><font style="vertical-align: inherit;">Também não temos orçamento e pouca experiência com o Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte Um - Shader</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro pensamento que surgiu foi que tudo já deveria ser realizado. </font><font style="vertical-align: inherit;">Certamente usando um shader. </font><font style="vertical-align: inherit;">E certamente deve estar na caixa Unity. </font><font style="vertical-align: inherit;">Uma tentativa rápida de pesquisa e instalação mostrou que existe um sombreador no Unity, mas, como se vê, ele faz parte do Standard Assets e não está disponível para uma licença gratuita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso é borrão! </font><font style="vertical-align: inherit;">Um efeito básico que é matematicamente simples e também deve ser facilmente implementado e integrado ao projeto. </font><font style="vertical-align: inherit;">Mesmo se não soubermos nada sobre shaders. </font><font style="vertical-align: inherit;">Em seguida, acesse a Internet e a pesquisa mostrou rapidamente que existem códigos-fonte de shaders prontos para o efeito e até diferentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a primeira implementação, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esse shader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foi utilizado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para testá-lo, basta adicionar o sombreador como um arquivo de origem ao projeto, associá-lo ao material, vincular o material à imagem.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte Dois - Interface do Usuário</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se nos preocupamos com o usuário do aplicativo, é necessário prestar a devida atenção à interface do usuário. Se você apenas adicionar um efeito de desfoque ao fundo e esquecê-lo, isso nem tudo será consistente com os princípios internos da criação de um produto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, para ações posteriores, você precisa tocar no que aconteceu e, em seguida, pensar e ajustar de forma a causar a percepção necessária do usuário. Este ponto é altamente sensível ao contexto. Dependendo do contraste da imagem, a variedade de cores e outros fatores, vários valores e ferramentas adicionais podem ser selecionados. No nosso caso, nesse estágio, foi obtido um bom resultado com um raio de desfoque de 25 (parâmetro shader) e um Transparente adicional de 70% (fora do shader através de uma imagem separada). No entanto, esta é apenas a imagem de fundo final. A transição em si, de acordo com os sentimentos no telefone, foi muito acentuada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sombreador instalado na imagem é calculado em cada quadro e, portanto, para fazer uma alternância suave, basta alterar dinamicamente o parâmetro do raio de desfoque e a transparência. </font><font style="vertical-align: inherit;">Você pode organizar isso de maneiras diferentes, mas, em essência, o processamento é uma atualização nos manipuladores de atualizações, dependendo do horário. </font><font style="vertical-align: inherit;">A transição em si na versão final do aplicativo é de 0,2 segundos, mas, como se vê, é importante para a percepção do usuário.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte Três - Produtividade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos últimos meses, ouvi reclamações de vários usuários diferentes (nem mesmo de programadores) de que os programas de jogos costumam usar todos os recursos de computador disponíveis ociosos e sem freios. Por exemplo, isso pode ser expresso no uso máximo da placa de vídeo no caso de um programa minimizado na bandeja ou independentemente de tudo e do carregamento constante de um segmento do processador. As razões para isso são intuitivas - a renda do desenvolvedor ou editor não depende da otimização (as pessoas não prestam atenção a essas coisas ao comprar), e os desenvolvedores comuns provavelmente estão mais preocupados com os KPIs locais e com a necessidade de atraso. No entanto, na prática, eu não gostaria de entrar nessa categoria.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de concluir o estágio anterior no próximo lançamento com um efeito de desfoque de fundo, depois de segurar o telefone na mão por algum tempo, surgiu uma sensação de aquecimento. Se você passa mais tempo no menu, tudo fica muito pior. E mesmo que o usuário no menu presumivelmente e provavelmente não gaste muito tempo, eu não gostaria de deixar a bateria cair. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A análise mostrou que o sombreador escolhido acima tem complexidade assintótica </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dependendo do raio selecionado. Em outras palavras, o número de cálculos por ponto se torna 625 vezes maior se você aumentar o raio de desfoque de 1 para 25. Nesse caso, os cálculos ocorrem em cada quadro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro passo na solução foi a ideia de que nem todos os sombreadores são igualmente úteis e o efeito de desfoque pode ser implementado de diferentes maneiras. Para fazer isso, você pode fazer um desfoque separado, cuja essência é desfocar primeiro apenas as linhas horizontalmente e depois apenas as linhas verticalmente. Como resultado, obtemos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e ceteris paribus, a complexidade cai em uma ordem de magnitude. Uma maneira adicional seria usar um mipmap menor, que já ocupa parte do trabalho de desfoque. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Esse shader</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
foi tomado como base</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No entanto, seu efeito de desfoque acabou sendo insuficiente e, com alto contraste do gráfico, a imagem ficou "lascada". </font><font style="vertical-align: inherit;">Para obter melhores efeitos, a distribuição foi alterada (elementos GRABPIXEL). </font><font style="vertical-align: inherit;">Se no sombreador, de 0,18 a 0,05, raio 4, em nossa versão, de 0,14 a 0,03, raio 6 (ess, mas a soma de todos deve ser 1). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, a complexidade do processamento foi reduzida em 1-2 ordens de magnitude. </font><font style="vertical-align: inherit;">Mas isso não é necessário parar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte Quatro - Fundo Estático</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, se deixarmos o sombreador na imagem existente, ela estará constantemente em funcionamento, fazendo os mesmos cálculos em cada quadro. </font><font style="vertical-align: inherit;">Se algo acontecer em segundo plano, precisamos fazer isso. </font><font style="vertical-align: inherit;">Mas isso é completamente opcional se o fundo for estático. </font><font style="vertical-align: inherit;">Assim, após o desfoque dinâmico, você pode se lembrar do resultado, colocá-lo no fundo e desligar o sombreador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, vamos tentar com trechos de código. </font><font style="vertical-align: inherit;">A preparação da textura de destino para a tela inteira pode ficar assim:</font></font><br>
<br>
<pre><code class="cs hljs">_width = Screen.width / <span class="hljs-number">2</span>;<font></font>
_height = Screen.height / <span class="hljs-number">2</span>;<font></font>
_texture = <span class="hljs-keyword">new</span> Texture2D(_width, _height);<font></font>
<font></font>
<span class="hljs-keyword">var</span> fillColor = Color.white;
<span class="hljs-keyword">var</span> fillColorArray = _texture.GetPixels();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fillColorArray.Length; ++i)<font></font>
{<font></font>
	fillColorArray[i] = fillColor;<font></font>
}<font></font>
_texture.SetPixels(fillColorArray);<font></font>
_texture.Apply();<font></font>
<font></font>
_from.GetComponent&lt;Image&gt;().sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, aqui é preparada uma textura 2 vezes menor horizontal e verticalmente da tela. </font><font style="vertical-align: inherit;">Isso pode ser feito quase sempre, pois sabemos que o tamanho da tela dos dispositivos é múltiplo de 2 e, se feito, isso reduzirá o tamanho da textura e facilitará a desfocagem.</font></font><br>
<br>
<pre><code class="cs hljs">RenderTexture temp = RenderTexture.GetTemporary(_width, _height);<font></font>
Graphics.Blit(_from_image.mainTexture, temp, _material);<font></font>
RenderTexture.active = temp;<font></font>
<font></font>
_texture.ReadPixels(<span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, temp.width, temp.height), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
_texture.Apply();<font></font>
<font></font>
_to_image.sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));<font></font>
RenderTexture.ReleaseTemporary(temp);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para capturar uma imagem com mainTexture usando um sombreador (no _material) Graphics.Blit é usado. Em seguida, memorizamos o resultado na textura preparada e o colocamos na imagem de destino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo ficaria bem; na prática, ele se deparou com um efeito que, dependendo do dispositivo, a imagem de fundo fica de cabeça para baixo. A razão após um estudo sobre o problema e a depuração se torna clara - a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diferença nos sistemas de coordenadas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct3D e OpenGL, que o Unity não pode ocultar. Ao mesmo tempo, nosso shader detecta os UV e os processa corretamente, e a inversão já ocorre no ambiente Unity (ReadPixels). Existem muitas dicas na rede, como "se você virou de cabeça para baixo, vire-se" ou "altere o sinal UV". O uso da macro UNITY_UV_STARTS_AT_TOP não ajudou a obter uma boa generalização para todos os dispositivos em teste. Além disso, por exemplo, encontramos um caso como esse: se você preparar a montagem para emulação no Xcode no iPhone e o Unity não usar o Metal, mas apenas o OpenGLES, será necessário interceptar esses casos, como a emulação de um dispositivo em execução em outro software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de experimentar várias opções, optei por dois tablets. O primeiro está </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forçando a renderização da câmera</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(definindo forceIntoRenderTexture no momento da captura da imagem). </font><font style="vertical-align: inherit;">O segundo é a determinação do tipo de sistema gráfico em tempo real através do SystemInfo.graphicsDeviceType, que permite definir como OpenGL ou Direct3D (o primeiro grupo é OpenGLES2, OpenGLES3, OpenGLCore e Vulkan). </font><font style="vertical-align: inherit;">Além disso, em nossa implementação para Direct3D-like, precisamos virar, o que é feito processualmente (por exemplo, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este artigo seja útil para alguém superar um rake desconhecido, melhorar a vida dos usuários e entender o Unity. </font><font style="vertical-align: inherit;">Se você olhar para o efeito no uso do combate, então na Unidade parece que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Na aplicação, as sensações são um pouco diferentes, mas essa animação pode dar uma idéia suficiente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493442/index.html">Lembrete de EPI</a></li>
<li><a href="../pt493444/index.html">O projeto "Glass". Copos descartáveis ​​de chá / café de eficiência energética</a></li>
<li><a href="../pt493446/index.html">Leitura de fim de semana: 10 histórias sonoras incomuns - de jogos com espiões e teorias da conspiração a ASMR relaxante</a></li>
<li><a href="../pt493448/index.html">Roteamento eficiente por mola</a></li>
<li><a href="../pt493450/index.html">Como um investidor iniciante pode legalmente reduzir impostos: 4 métodos de trabalho</a></li>
<li><a href="../pt493458/index.html">Liberte seu Android - Alaverdi</a></li>
<li><a href="../pt493462/index.html">Banho ultrassonico. Parte 2</a></li>
<li><a href="../pt493468/index.html">Não tenha medo de respirar profundamente</a></li>
<li><a href="../pt493470/index.html">Cientistas encontram novos planetas pequenos fora de Netuno</a></li>
<li><a href="../pt493478/index.html">Corte a caixa - floresta do procedimento. Torrefação AS-REP, DCSync e ataques Pass-The-Hash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>