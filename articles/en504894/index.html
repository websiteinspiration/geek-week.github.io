<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê§ üí∞ ü•Ç GUI in Russian, or VKS terminal do it yourself üîí ü§∞üèø üö´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Experience in developing a C ++ GUI for the Russian videoconferencing system (VKS). The synthesis of modern technology and certification requirements....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GUI in Russian, or VKS terminal do it yourself</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/protei/blog/504894/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Experience in developing a C ++ GUI for the Russian videoconferencing system (VKS). </font><font style="vertical-align: inherit;">The synthesis of modern technology and certification requirements. </font><font style="vertical-align: inherit;">The main "rake" of development and ways to get around them. </font><font style="vertical-align: inherit;">What do the GUI and Russian ballet have in common. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing that the user of the videoconferencing system sees is the interface. </font><font style="vertical-align: inherit;">And in most cases, it is by its appearance and functionality that they judge the system. </font><font style="vertical-align: inherit;">An inconvenient or sprawling interface will not allow to evaluate either the high system performance or wide functionality. </font><font style="vertical-align: inherit;">Technically, a ‚Äúbeautiful‚Äù system should be wrapped in an attractive and stable working shell. </font><font style="vertical-align: inherit;">Therefore, at the start of the development of the domestic VKS system, this moment was immediately taken into account.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mq/zf/vr/mqzfvrwj1mk6anlm3rjpjg44ngw.png" alt="image"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who will be the user of the Russian videoconferencing system?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the spring of 2020, the answer to the question of the advisability of developing a full-fledged VKS-system has become obvious. Officials, commercial companies, hospitals and schools need modern means of communication with a certain level of productivity and security. You can talk in Zoom, but is it worth it to use for serious commercial negotiations or an operational meeting of managers?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For various tasks of Russian companies, it became necessary to create a domestic videoconferencing system. </font><font style="vertical-align: inherit;">Moreover, a system consisting not only of a software component, but also a full-fledged hardware. </font><font style="vertical-align: inherit;">Among world famous vendors, at least 5 companies offer multifunctional videoconferencing systems. </font><font style="vertical-align: inherit;">But in Russia, the concept of import substitution is gradually starting to work. </font><font style="vertical-align: inherit;">Plus, security issues for many have become more important than the country of origin of the product, and the price at current exchange rates is not in last place. </font><font style="vertical-align: inherit;">And the "beauty" of the interface turned out to be quite realistic to develop from scratch.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI on start</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main requirements for modern interfaces are speed of implementation, up-to-date appearance and full usability. </font><font style="vertical-align: inherit;">Thus, the first task of the developers of the graphical user interface (GUI) was a clear definition of the software functionality for the videoconferencing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the point of view of the GUI, the following requirements were formulated:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Making outgoing video / audio calls;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Accept / reject incoming calls;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Auto answer an incoming call at a custom time interval;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Switch between two audio devices (headset / speakerphone) both during and outside the call;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Turn on / off the microphone and camera both during and outside the call;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DTMF dialing during a call;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conference gathering at the terminal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Management of PTZ cameras, saving PTZ presets and their application;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The ability to output video to several different windows;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Control mouse, keyboard, remote control;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The ability to remotely control the terminal from the Web interface.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This list of functions allows you to solve the problem of developing an interface in various ways. </font><font style="vertical-align: inherit;">Moreover, the choice of a specific type of implementation was affected by limitations of the type of programming languages ‚Äã‚Äã(for example, Java was categorically not suitable for certification reasons, CSS / HTML - according to the functionality), specialization of developers, and timing. </font><font style="vertical-align: inherit;">Collectively, the choice was made in favor of C ++ and the use of the Qt5 framework, since, for example, the more modern QML technology does not allow rendering video using an arbitrary OpenGL context, and this was necessary according to the ToR for VKS terminals.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f6/gd/lr/f6gdlr-u2n2ncctyiqjss5zloty.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quickly and efficiently</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first GUI prototype was created for Qt's softphone and used many open source libraries. </font><font style="vertical-align: inherit;">For example, for the SIP protocol, eXosip / oSIP libraries were used, ffmpeg for encoding / decoding video and audio, and PortAudio for working with audio devices. </font><font style="vertical-align: inherit;">This softphone worked under Linux, Windows, MacOS and was a technology demonstrator, and not a real device. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later, an abstract softphone was transformed into a real videophone project, and the first version of the software for it should have been created 2 months after the start. </font><font style="vertical-align: inherit;">To solve this problem in such a short time, the phone software was divided into modules and distributed among several groups of developers in accordance with competencies. </font><font style="vertical-align: inherit;">Such an organization of the process helped to quickly and efficiently develop the videophone project.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Core and front</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For unification and the possibility of using existing GUI developments in other devices from an existing project, the common code base is in a separate module - the GUI backend, or the GUI core module. </font><font style="vertical-align: inherit;">And directly representations, which are different for different devices, implement in separate GUI front modules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This architecture of the GUI-modules turned out to be advantageous and led to the desired result: the development of interfaces for the new components of the VKS system itself has become relatively fast and high-quality. </font><font style="vertical-align: inherit;">After all, now the interfaces for VKS terminals did not need to be rewritten from scratch.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Torment and Victory</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the way to creating any software, naturally, there are difficulties and problems. </font><font style="vertical-align: inherit;">Creating a GUI for the videoconferencing was no exception. </font><font style="vertical-align: inherit;">Regardless of the specific purpose of the system, they can be repeated in any command. </font><font style="vertical-align: inherit;">Difficulties and victories on the development path are interesting for colleagues, and perhaps they will prompt effective solutions without our ‚Äúrake‚Äù.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forever consistency</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historically, the very first interesting problem that arose during the development of the GUI for various types of VKS terminals was the problem of consistency, that is, the coordinated state of all modules. </font><font style="vertical-align: inherit;">During operation, the GUI interacts with several other modules: a module for interacting with hardware, a call management subsystem, a media processing module (MCU), and a user interaction subsystem.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/xp/5b/csxp5bydmvx6vi9eviyuxg8-d3k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, the GUI worked with all these modules as independent, that is, it could send requests to 2 different modules at the same time. This turned out to be wrong and sometimes led to problems, since these modules themselves were not independent and actively interacted with each other. The solution to the problem was the creation of a special work scheme, which ensured strictly sequential execution of requests within all modules.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were 2 difficulties adding: firstly, some (but not all) requests require a response, in anticipation of which the terminal, in fact, is in an inconsistent state, so other requests cannot be performed. However, blocking the user interface while waiting for responses is also undesirable. Secondly, responses to GUI requests from modules, as well as requests from modules to the GUI, come in their own threads, different from the GUI, but the GUI must implement all state changes in its thread (for some actions Qt requires this, but in in some cases, this avoids unnecessary difficulties in ensuring thread synchronization).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution was found and consisted of two parts. First, all requests / responses from other modules were redirected to the GUI stream using the Qt signal-slot mechanism in conjunction with QueuedConnection, that is, using the global QApplication event loop. Then, to ensure consistent processing of all requests, a Transitions system was developed with its own queue and processing cycle (TransitionLoop).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, when the user presses some action button in the GUI (for example, the call button), a corresponding Transition is created, which is placed in the transition queue. After that, a signal is generated for the transition processing cycle. TransitionLoop, upon receiving a signal, looks to see if there is any transition in progress now. If there is, then the waiting for the completion of the current transition continues; if not, the next Transition is retrieved from the transition queue and launched. When a response is received from another TransitionLoop module using the same signal, the completion of the current transition is notified and TransitionLoop can start the next transition from the queue.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The important thing here is that all transition processing is done in a GUI thread. </font><font style="vertical-align: inherit;">This is ensured by the use of the Qt signal-slot mechanism in the QueuedConnection variant, in which an event is generated for each signal and placed in the main EventLoop of the application.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenGL rendering on low-power hardware</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another difficulty that we had to deal with was the problem of rendering video. Qt provides for OpenGL rendering a special QOpenGLWidget class and related helper classes, which was originally used for rendering video. The data for rendering (decoded video frames) themselves is provided by the media processing module (MCU), which, among other things, implements hardware decoding of the video stream (on the GPU). On low-power processors, ‚Äúslowing down" the rendering of FullHD video was found. The direct solution was to replace the processor, but this would require serious processing of the already finished components of the videoconferencing system and would increase the cost of the devices themselves. Therefore, the entire rendering process was carefully analyzed to find more beautiful ways to solve the problem.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With standard OpenGL rendering and hardware decoding, the following occurs: data with encoded video comes from the network, it is stored in RAM, then this data from RAM is transferred to video memory on the GPU, where it is decoded. Then, decoded data having a significantly larger volume than encoded data is transferred again to the RAM. Next, a rendering code comes into play, which transfers this data from RAM back to the GPU directly for rendering. Thus, rather large amounts of data are pumped back and forth through the memory bus, and the bus simply cannot do this.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In modern versions of OpenGL, there are special extensions that allow you to specify for rendering data that is already in the GPU memory, and not data in the main RAM, as usual. This mechanism excluded the movement of data of hardware-decoded frames from the GPU to RAM, and then back. Thus, the problem of rendering on low-power processors was almost solved.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ta/gx/rr/tagxrr-ydgiw9vlbucxyvli2jni.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another major problem was the OpenGL contexts supported in Qt. They do not allow you to use the necessary OpenGL extension, that is, you cannot use QOpenGLWidget with this option. The solution was to use a regular QWidget, but turned off the Qt rendering pipeline. Such an opportunity exists in Qt. However, a question arose here, because in this option the GUI is fully responsible for all rendering in the area of ‚Äã‚Äãthis widget, Qt does not help us. This is normal for displaying video, but for using widgets on top of video, regular Qt tools cannot be used, since, for example, an additional pop-up menu must be displayed on top of the video.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This problem was solved as follows: from the existing widget, its image is obtained (QWidget has a grab () method for this), the resulting image is converted to OpenGL texture and the latter is rendered on top of the video using OpenGL tools. </font><font style="vertical-align: inherit;">By adding the appropriate environment, a universal mechanism was implemented that can be used to display any standard widgets on top of the video in such a non-standard way.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kiosks and widgets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task of managing displays and distributing fragments of the user interface in the ‚Äúkiosk‚Äù mode was not an easy one. VKS terminal can operate in 2 modes - window mode, that is, like any other window application in the desktop environment of the operating system, and ‚Äúkiosk mode‚Äù (that is, the operating system runs only one application with a graphical interface - VKST - and there is no environment desktop).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In windowed mode, everything is relatively simple: the window is controlled by the window manager of the desktop environment, the application creates a second window if necessary, and the user distributes the windows on the displays as he needs. But in the ‚Äúkiosk‚Äù mode, everything is much more complicated, since the system does not have a window manager and there can only be one window, and the user does not have the ability to move it. Therefore, the task of automatically detecting an event, for example, connecting / disconnecting a display, appeared. When this event occurred, it was necessary to automatically configure the displays and correctly place fragments of the user interface on them.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-x/dm/w_/-xdmw_fvqpxs-frj0pl04wszabg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The answer came from the LINUX Xrandr OS system library, which is responsible for working with displays. There is very little documentation on it on the Internet, so the implementation was carried out using examples from the Internet, including from Habr. In addition, it was necessary to come up with an algorithm for distributing interface fragments among displays, as well as integrate two different windows into one single one. The latter was implemented as follows: what are windows in windowed mode, in ‚Äúkiosk‚Äù mode are widgets inside one large window, which stretches over 2 displays (if there are 2 of them). In this case, it is necessary to configure the positions of the displays so that a continuous virtual space is created (this is done using the XRandr library), and then set the geometry of the internal widgets inside a single global window so thatso that everyone gets on their display.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create Russian</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The whole way of creating the Russian videoconferencing system consisted and consists of many stages, and the GUI is only the tip of the iceberg. </font><font style="vertical-align: inherit;">The most noticeable and not the most difficult. </font><font style="vertical-align: inherit;">However, the complexity of the solution, the combination of software and hardware and software components, and the desire to make a technically and aesthetically ‚Äúbeautiful‚Äù system created many difficulties along the way. </font><font style="vertical-align: inherit;">New tasks gave rise to non-standard solutions and helped create a product that is not ashamed to show not only in Russia but also abroad.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Russian developments have long proven their performance, and in a beautiful shell and competitiveness. </font><font style="vertical-align: inherit;">Our life hacks will be useful to everyone who is seriously involved in GUI development, and we hope that they will help other developers speed up and simplify the process of creating modern shells for new Russian software products. </font><font style="vertical-align: inherit;">We believe that Russian decisions will be valued in the world no less than Russian ballet or black caviar.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504880/index.html">Development, optimization and release of Synthety games on Unity</a></li>
<li><a href="../en504884/index.html">Dangerous Peripherals: Understanding Thunderspy</a></li>
<li><a href="../en504886/index.html">Selenium WebDriver at the service of the developer</a></li>
<li><a href="../en504888/index.html">"Calm, only calm!" or less worry</a></li>
<li><a href="../en504890/index.html">Return value from powershell invoke-command to SQL-Server Agent</a></li>
<li><a href="../en504902/index.html">Top 9 Trends in Automated Testing in 2020</a></li>
<li><a href="../en504906/index.html">PHP - what is the niche of the language and will PHP8 help solve pressing problems (spoiler: IMHO not)</a></li>
<li><a href="../en504908/index.html">PyTrace - Time Travel Debugger for Python</a></li>
<li><a href="../en504912/index.html">HackTheBox endgame. Passage of the laboratory Professional Offensive Operations. Pentest Active Directory</a></li>
<li><a href="../en504918/index.html">The most effective online lesson services for students and teachers: the top five</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>