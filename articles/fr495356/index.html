<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£ üè† üßò Impl√©mentation de l'algorithme de consensus RAFT pour le stockage KV distribu√© en Java üéº ‚öæÔ∏è üôä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rebonjour. Il y a quelques jours, la formation a commenc√© dans un nouveau groupe sur le cours ¬´Architecte logiciel¬ª , et nous aimerions aujourd'hui pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Impl√©mentation de l'algorithme de consensus RAFT pour le stockage KV distribu√© en Java</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/495356/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rebonjour. Il y a quelques jours, la formation a commenc√© dans un nouveau groupe sur le cours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Architecte logiciel¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et nous aimerions aujourd'hui partager un article √©crit par l'un des √©tudiants du cours, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Pleshakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (responsable du d√©veloppement chez Program Logistics et co-fondateur de Clusterra).</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/pb/5h/qq/pb5hqqeunfv8gkvyvspmegwuj4w.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actuellement, les syst√®mes de microservices distribu√©s sont devenus pratiquement la norme de l'industrie, et pas seulement dans le monde de l'entreprise. Les avantages de l'utilisation de syst√®mes distribu√©s ont √©t√© d√©crits et discut√©s plus d'une fois. Les avantages des microservices sont connus de tous depuis longtemps: technologies pour la t√¢che, composabilit√©, √©volutivit√©, √©volutivit√© du d√©veloppement, r√©duction du TTM, etc. Il est √©vident que le d√©veloppement d'applications distribu√©es offre plus d'options pour une r√©ponse rapide aux demandes croissantes des entreprises et la num√©risation de tout ce qui l'entoure.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √©galement important de noter qu'√† l'heure actuelle, un facteur tr√®s important affectant le choix d'une strat√©gie de d√©veloppement en faveur des microservices est la disponibilit√© de toutes sortes de solutions d'infrastructure pr√™tes √† l'emploi qui r√©solvent les probl√®mes li√©s aux co√ªts suppl√©mentaires d'exploitation d'un syst√®me distribu√©. Nous parlons de syst√®mes d'orchestration de conteneurs, de pur√©e de service, de moyens de tra√ßage distribu√©, de surveillance, de journalisation, etc. On peut affirmer avec certitude que la plupart des facteurs mentionn√©s pr√©c√©demment comme les inconv√©nients de l'approche microservice aujourd'hui n'ont pas autant d'influence qu'il y a quelques ann√©es.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base des r√©alit√©s modernes, la plupart des d√©veloppeurs cherchent √† la premi√®re occasion de passer d'une structure monolithique √† une structure microservice. L'une des premi√®res √©tapes qui peuvent √™tre prises sans recourir au refactoring total et √† une d√©composition s√©rieuse est de parvenir √† un syst√®me d'√©volutivit√© horizontale. Autrement dit, pour transformer votre application monolithique en un cluster, peut-√™tre m√™me compos√© des m√™mes monolithes, mais vous permettant de faire varier dynamiquement leur nombre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l'on cherche √† atteindre une √©volutivit√© horizontale, la question de la synchronisation des donn√©es au sein d'un cluster se pose tr√®s rapidement et de mani√®re tr√®s aigu√´. Heureusement, tous les SGBD modernes prennent en charge la r√©plication des donn√©es entre les n≈ìuds d'une mani√®re ou d'une autre. Le d√©veloppeur a juste besoin de s√©lectionner le SGBD pour la t√¢che et de d√©cider quelles propri√©t√©s du syst√®me (selon le th√©or√®me CAP) il a besoin, CP ou AP, et le probl√®me est r√©solu. Dans le cas o√π CP est requis et les exigences de coh√©rence sont √©lev√©es, l'une des m√©thodes pour r√©soudre le probl√®me de synchronisation des donn√©es consiste √† utiliser un cluster qui prend en charge l'algorithme de consensus RAFT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet algorithme assez nouveau (d√©velopp√© en 2012) offre une grande garantie de coh√©rence et est tr√®s populaire. J'ai d√©cid√© de comprendre comment cela fonctionne et j'ai √©crit mon impl√©mentation d'un r√©f√©rentiel de valeurs-cl√©s coh√©rent en Java (Spring Boot).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est-il judicieux d'impl√©menter vous-m√™me un algorithme distribu√©? Il est clair que vous pouvez prendre une impl√©mentation pr√™te √† l'emploi d'un algorithme distribu√©, et avec le plus haut degr√© de probabilit√©, cette impl√©mentation sera meilleure qu'un ¬´v√©lo¬ª fait maison. Par exemple, vous pouvez utiliser un SGBD qui maintient le niveau de coh√©rence requis. Ou vous pouvez d√©ployer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou vous pouvez trouver un cadre adapt√© √† votre langue. Pour java, il y a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui r√©sout parfaitement les probl√®mes de synchronisation des donn√©es distribu√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais de l'autre c√¥t√©. Si vous prenez une solution cl√© en main, l'utilisation d'une application externe ajoute g√©n√©ralement un point de d√©faillance suppl√©mentaire √† votre syst√®me. Et les frameworks peuvent √™tre redondants ou difficiles √† utiliser et √† apprendre, ou ils peuvent ne pas exister du tout pour votre langage de programmation. De plus, l'impl√©mentation ind√©pendante de l'algorithme de consensus est une t√¢che d'ing√©nierie extr√™mement int√©ressante qui √©largit vos horizons et vous permet de comprendre comment r√©soudre les probl√®mes qui surviennent lorsque les services interagissent dans un cluster en utilisant la m√©thode la plus optimale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que la sp√©cification de l'algorithme contient un ensemble de mesures pour maintenir l'int√©grit√© des donn√©es, vous pouvez utiliser les connaissances acquises et m√™me utiliser l'algorithme dans son int√©gralit√©. N'importe quelle partie de l'algorithme peut √™tre utile dans la vie r√©elle. Supposons que vous disposiez d'un ensemble de travailleurs pour analyser les fichiers en parall√®le. Les travailleurs sont √©quivalents, mais vous souhaitez d√©signer l'un des travailleurs en tant que coordinateur, et lorsque le travailleur coordinateur tombe, affectez tout autre travailleur libre en tant que coordinateur. La premi√®re moiti√© de l'algorithme RAFT, qui d√©crit comment choisir un leader parmi des n≈ìuds √©quivalents, vous y aidera. Ou par exemple, si vous n'avez que deux n≈ìuds par rapport √† ma√Ætre-esclave, vous pouvez tr√®s bien utiliser les r√®gles de r√©plication d√©crites dans la sp√©cification RAFT pour organiser l'√©change de donn√©es dans votre cas le plus simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article est essentiellement un guide pratique sur la fa√ßon d'impl√©menter RAFT vous-m√™me. </font><font style="vertical-align: inherit;">L'algorithme lui-m√™me et les aspects th√©oriques de son travail ne seront pas compris. </font><font style="vertical-align: inherit;">Vous pouvez lire une br√®ve description ici dans cet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellent article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou √©tudier la sp√©cification compl√®te </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous y trouverez une visualisation tr√®s claire de l'algorithme.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description g√©n√©rale de la solution</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La partie du code directement li√©e √† la mise en ≈ìuvre de l'algorithme est analys√©e dans l'article. </font><font style="vertical-align: inherit;">√Ä la fin de l'article, il y a un lien vers le r√©f√©rentiel, o√π vous pouvez voir tout le code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che √©tait la suivante. </font><font style="vertical-align: inherit;">D√©veloppez un syst√®me distribu√© qui vous permet de stocker des donn√©es dans une base de donn√©es de valeurs-cl√©s. </font><font style="vertical-align: inherit;">Les donn√©es de chaque n≈ìud doivent √™tre coh√©rentes, √† savoir si les donn√©es sont entr√©es dans la base de donn√©es d'un n≈ìud et que la plupart des n≈ìuds ont confirm√© qu'ils avaient √©galement re√ßu ces donn√©es, alors t√¥t ou tard ces donn√©es seront dans la base de donn√©es de chaque n≈ìud. </font><font style="vertical-align: inherit;">Lorsqu'une partie du cluster est d√©connect√©e et lorsqu'elle est reconnect√©e, les n≈ìuds qui se trouvaient en dehors du cluster doivent rattraper le cluster principal et se synchroniser. </font><font style="vertical-align: inherit;">Chaque n≈ìud fournit une API REST pour √©crire et lire les donn√©es de la base de donn√©es. </font><font style="vertical-align: inherit;">Le syst√®me se compose de deux modules pour deux types de n≈ìuds: client et serveur. </font><font style="vertical-align: inherit;">Ci-dessous, nous consid√©rons les caract√©ristiques de la mise en ≈ìuvre du serveur lui-m√™me. </font><font style="vertical-align: inherit;">Le code client est dans le r√©f√©rentiel. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un n≈ìud de serveur peut fonctionner dans trois √©tats:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suiveur (suiveur). </font><font style="vertical-align: inherit;">Accepte les demandes de lecture du client. </font><font style="vertical-align: inherit;">Prend un battement de coeur du leader</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Candidat (candidat). </font><font style="vertical-align: inherit;">Accepte les demandes de lecture du client. </font><font style="vertical-align: inherit;">Envoie des demandes de vote √† d'autres n≈ìuds</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef </font><font style="vertical-align: inherit;">Accepte les demandes de lecture et d'√©criture. </font><font style="vertical-align: inherit;">Envoie des requ√™tes de pulsation √† d'autres n≈ìuds. </font><font style="vertical-align: inherit;">Envoie des donn√©es de demande d'ajout √† d'autres n≈ìuds.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La p√©riode de ¬´leadership¬ª de l'un des n≈ìuds s'appelle la ronde (terme). </font><font style="vertical-align: inherit;">Un nouveau candidat ouvre un nouveau tour.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage de donn√©es</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque n≈ìud donne acc√®s au r√©f√©rentiel du journal des op√©rations, dans lequel les op√©rations de modification des donn√©es sont enregistr√©es s√©quentiellement.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/operations/OperationsLog.java<br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OperationsLog</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(Operation operation)</span></span>;
   <span class="hljs-function">Operation <span class="hljs-title">get</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">List&lt;Operation&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function">Long <span class="hljs-title">getTerm</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">Integer <span class="hljs-title">getLastIndex</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">Long <span class="hljs-title">getLastTerm</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">removeAllFromIndex</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newOperationIndex)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque op√©ration, en plus des donn√©es et du type (ins√©rer, modifier, supprimer), contient le num√©ro du cycle dans lequel elle a √©t√© cr√©√©e. De plus, chaque op√©ration a un index qui augmente s√©quentiellement. Il est important que toutes les op√©rations soient ins√©r√©es dans les journaux des suiveurs dans le m√™me ordre dans lequel elles sont ins√©r√©es dans le journal du leader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque n≈ìud a acc√®s √† une base de donn√©es dans laquelle les donn√©es sont stock√©es directement.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/storage/Storage.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Storage</span> </span>{
   <span class="hljs-function">List&lt;Entry&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(Long key)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Long key)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'impl√©mentation actuelle, des solutions int√©gr√©es en m√©moire sont utilis√©es √† la fois pour le journal et pour la base de donn√©es (liste et carte concurrentes ordinaires). Si n√©cessaire, vous pouvez simplement impl√©menter l'interface appropri√©e pour prendre en charge d'autres types de stockage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'application des op√©rations du journal √† la base de donn√©es est effectu√©e par une machine √† √©tats distribu√©e. Une machine √† √©tats est un tel m√©canisme qui est charg√© de changer l'√©tat d'un cluster, de restreindre l'utilisation de modifications incorrectes (op√©rations hors service ou n≈ìud d√©connect√© qui se consid√®re comme un leader). Pour que les modifications soient consid√©r√©es comme valides et pour qu'elles soient appliqu√©es √† la base de donn√©es, elles doivent passer une s√©rie de v√©rifications et r√©pondre √† certains crit√®res, c'est pr√©cis√©ment ce que fournit la machine d'√©tat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour un leader, une op√©ration est appliqu√©e √† la base de donn√©es si la plupart des n≈ìuds ont confirm√© le fait que l'op√©ration est √©galement r√©pliqu√©e dans leur journal. </font><font style="vertical-align: inherit;">Pour une adepte, l'op√©ration est appliqu√©e √† la base de donn√©es si un signal est re√ßu du chef de file qu'elle est entr√©e dans sa base de donn√©es.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minuteries </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque n≈ìud assure l'√©change de donn√©es avec d'autres n≈ìuds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux types de requ√™tes sont pris en charge:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voter lors d'un tour de scrutin</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajouter, alias battement de c≈ìur (s'il n'y a pas de donn√©es), pour r√©pliquer les donn√©es du journal aux abonn√©s et pour emp√™cher le d√©but d'un nouveau tour de scrutin.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait du d√©but d'un √©v√©nement est d√©termin√© par le temporisateur. </font><font style="vertical-align: inherit;">Deux types de temporisateurs sont lanc√©s sur le n≈ìud:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voter. </font><font style="vertical-align: inherit;">Pour commencer un tour de scrutin. </font><font style="vertical-align: inherit;">Chaque n≈ìud a son propre intervalle, apr√®s quoi il essaiera de commencer un nouveau vote. </font><font style="vertical-align: inherit;">Le compte √† rebours recommence lorsque vous recevez un battement de c≈ìur du leader.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">battement de coeur. </font><font style="vertical-align: inherit;">Pour envoyer une demande aux abonn√©s par le leader de l'ajout. </font><font style="vertical-align: inherit;">Si le n≈ìud ne re√ßoit pas de battement de c≈ìur et que le d√©lai de vote a expir√©, il devient candidat et d√©clenche des √©lections, augmente le nombre de tours de scrutin et envoie des demandes de vote √† d'autres n≈ìuds. </font><font style="vertical-align: inherit;">Si le n≈ìud recueille la majorit√© des votes, il devient le leader et commence √† envoyer des battements de c≈ìur.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat actuel du n≈ìud</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque n≈ìud stocke des donn√©es sur l'√©tat actuel.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/context/Context.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Context</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">State <span class="hljs-title">getState</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//: , ,  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getVotedFor</span><span class="hljs-params">()</span></span>; 
               <span class="hljs-comment">//          </span>
   <span class="hljs-function">Long <span class="hljs-title">getCurrentTerm</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getCommitIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">List&lt;Peer&gt; <span class="hljs-title">getPeers</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//      </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un n≈ìud leader stocke √©galement des m√©tadonn√©es pour les n≈ìuds vers lesquels il r√©plique les donn√©es.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/node/peers/Peer.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Peer</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getNextIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  ,    </span>
   <span class="hljs-function">Integer <span class="hljs-title">getMatchIndex</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//   </span>
   <span class="hljs-function">Boolean <span class="hljs-title">getVoteGranted</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//     </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les m√©tadonn√©es des n≈ìuds sont mises √† jour par le responsable lors de la r√©ception des r√©ponses des abonn√©s. </font><font style="vertical-align: inherit;">Ils sont utilis√©s pour d√©terminer par le leader quelle prochaine op√©ration d'index le suiveur est pr√™t √† accepter et quelles op√©rations ont d√©j√† √©t√© ajout√©es au journal du suiveur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vote</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">ElectionService</font></a><font style="vertical-align: inherit;"> est responsable du vote</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ElectionService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processElection</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO requestVoteDTO)</span></span>;<font></font>
} </code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi d'une demande de vote </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le n≈ìud est un suiveur et ne re√ßoit pas de battement de c≈ìur pendant la p√©riode d√©finie pour l'attente, il augmente son tour en cours, se d√©clare candidat et commence √† envoyer des demandes de vote √† d'autres n≈ìuds. </font><font style="vertical-align: inherit;">S'il parvient √† r√©unir un quorum et que la plupart des n≈ìuds votent, il deviendra le nouveau chef. </font><font style="vertical-align: inherit;">En termes RAFT, le quorum repr√©sente plus de la moiti√© de tous les n≈ìuds (51%). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysons la m√©thode de </font></font><code>processElection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est appel√©e par le temporisateur de vote lorsque le vote expire et envoie aux n≈ìuds une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande de vote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-comment">//1</span><font></font>
context.setState(CANDIDATE); <font></font>
Long term = context.incCurrentTerm(); <font></font>
context.setVotedFor(context.getId()); <font></font>
<font></font>
List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<span class="hljs-keyword">long</span> voteGrantedCount = <span class="hljs-number">1L</span>;
<span class="hljs-keyword">long</span> voteRevokedCount = <span class="hljs-number">0L</span>;<font></font>
<font></font>
<span class="hljs-comment">//2</span>
<span class="hljs-keyword">while</span> (checkCurrentElectionStatus(term)) {<font></font>
   List&lt;AnswerVoteDTO&gt; answers = getVoteFromAllPeers(term, peersIds);<font></font>
   peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   <span class="hljs-keyword">for</span> (AnswerVoteDTO answer : answers) {
       <span class="hljs-comment">//3</span>
       <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
           <span class="hljs-comment">//4</span>
           <span class="hljs-keyword">if</span> (answer.getTerm()&gt;context.getCurrentTerm()) {<font></font>
               context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
               <span class="hljs-keyword">return</span>;<font></font>
           }<font></font>
           <span class="hljs-keyword">if</span> (answer.isVoteGranted()) {
               <span class="hljs-comment">//5 </span>
               context.getPeer(answer.getId()).setVoteGranted(<span class="hljs-keyword">true</span>);<font></font>
               voteGrantedCount++;<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-comment">//6 </span><font></font>
               voteRevokedCount++;<font></font>
       } <span class="hljs-keyword">else</span> {<font></font>
          peersIds.add(answer.getId());<font></font>
       }<font></font>
   }<font></font>
  <span class="hljs-comment">//7</span>
  <span class="hljs-keyword">if</span> (voteGrantedCount &gt;= context.getQuorum()) {<font></font>
       winElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (voteRevokedCount &gt;= context.getQuorum()) {<font></font>
       loseElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } </code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez le statut de ¬´Candidat¬ª. </font><font style="vertical-align: inherit;">Augmentez le nombre de tours et votez pour nous-m√™mes.</font></font></li>
<li>  ,       (    ).  -  ,        ,           heartbeat                 .</li>
<li> -  ,    .    ,      ,     -. </li>
<li>       ,                            .     ,      heartbeat     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le n≈ìud a vot√© pour nous! </font><font style="vertical-align: inherit;">Nous augmentons le nombre de n≈ìuds votant pour nous et corrigeons que ce n≈ìud a vot√© pour nous.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vot√© non pour nous, nous croyons aussi.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le quorum est collect√© et que le n≈ìud a remport√© l'√©lection, nous √©tablissons le statut de ¬´Leader¬ª. </font><font style="vertical-align: inherit;">Sinon, nous devenons un suiveur et attendons.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient √©galement de noter que lorsqu'un n≈ìud devient un leader, l'index suivant est d√©fini pour chaque n≈ìud dans la liste des n≈ìuds stock√©s par le leader, qui est √©gal au dernier index du journal du leader plus 1. √Ä partir de cet index, le leader tentera de mettre √† jour les journaux du suiveur. </font><font style="vertical-align: inherit;">En fait, cet indice stock√© par le leader peut ne pas correspondre √† l'indice r√©el du journal du suiveur et la valeur r√©elle ne sera obtenue que lors de l'√©change de donn√©es avec le suiveur et sera ajust√©e. </font><font style="vertical-align: inherit;">Mais un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point de d√©part est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√©cessaire </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">winElection</span><span class="hljs-params">(Long term)</span> </span>{<font></font>
       context.setState(LEADER);<font></font>
       context.getPeers().forEach(peer -&gt;<font></font>
               peer.setNextIndex(operationsLog.getLastIndex()+<span class="hljs-number">1</span>)<font></font>
<font></font>
       );<font></font>
   }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement des demandes de vote </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du vote, chaque n≈ìud re√ßoit une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'un candidat </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">comme ceci</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestVoteDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer candidateId; <span class="hljs-comment">//  </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer lastLogIndex; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long lastLogTerm; <span class="hljs-comment">//       </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons maintenant la proc√©dure de </font></font><code>vote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, elle traite la demande de vote du candidat et retourne une d√©cision concernant sa candidature au poste de leader.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/election/ElectionServiceImpl.java#L178 <br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO dto)</span> </span>{<font></font>
   <font></font>
       <span class="hljs-keyword">boolean</span> termCheck;
       <span class="hljs-comment">//1</span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm())
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>);
       <span class="hljs-keyword">else</span> <span class="hljs-comment">//2</span>
       <span class="hljs-keyword">if</span> (dto.getTerm().equals(context.getCurrentTerm())) {<font></font>
           termCheck = (context.getVotedFor() == <span class="hljs-keyword">null</span>||<font></font>
                          context.getVotedFor().equals(dto.getCandidateId()));<font></font>
       }<font></font>
       <span class="hljs-keyword">else</span>
       {   <span class="hljs-comment">//3</span>
           termCheck = <span class="hljs-keyword">true</span>;<font></font>
             context.setTermGreaterThenCurrent(dto.getTerm());<font></font>
       }<font></font>
<font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">boolean</span> logCheck = !((operationsLog.getLastTerm() &gt; dto.getLastLogTerm()) ||<font></font>
               ((operationsLog.getLastTerm().equals(dto.getLastLogTerm())) &amp;&amp;<font></font>
                       (operationsLog.getLastIndex() &gt; dto.getLastLogIndex())));<font></font>
<font></font>
<font></font>
       <span class="hljs-keyword">boolean</span> voteGranted = termCheck&amp;&amp;logCheck;<font></font>
<font></font>
       <span class="hljs-comment">//5</span>
       <span class="hljs-keyword">if</span> (voteGranted) {<font></font>
           context.setVotedFor(dto.getCandidateId());<font></font>
       }<font></font>
       <span class="hljs-comment">//6   </span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),voteGranted);<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la r√©ception d'une demande d'un candidat, le n≈ìud effectue deux v√©rifications: v√©rifie la ronde du candidat et la longueur de son journal. </font><font style="vertical-align: inherit;">Si le tour du candidat est plus √©lev√© et son journal est plus long ou √©gal, alors le n≈ìud donne √† son n≈ìud un vote pour le candidat</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le tour du n≈ìud actuel est plus grand que le tour du candidat, nous refusons, car il s'agit d'une demande de n≈ìud en retard, qui, apparemment, √©tait en dehors du cluster depuis un certain temps et a commenc√© la proc√©dure √©lectorale parce qu'il n'a pas vu le chef actuel. </font></font></li>
<li>   ,   , ,           ,        ,     ,       ;       .              ‚Äî    .</li>
<li>     ,     </li>
<li> .                   ,            ,  ,        ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec un r√©sultat positif, nous corrigeons le fait que le n≈ìud a particip√© aux √©lections et a vot√© pour le candidat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renvoyer le r√©sultat au candidat</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certes, les conditions auraient pu √™tre √©crites un peu plus courtes et plus √©l√©gantes, mais j'ai laiss√© une option tellement ¬´na√Øve¬ª afin de ne pas m'embrouiller et de ne d√©router personne. </font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La r√©plication </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le responsable du minuteur envoie des suiveurs de pulsations √† tous les n≈ìuds pour r√©initialiser leurs minuteurs de vote. Puisque le leader stocke dans ses index de m√©tadonn√©es les derni√®res op√©rations de tous les suiveurs, il peut √©valuer si l'envoi de l'op√©ration aux n≈ìuds est n√©cessaire. Si le journal des op√©rations du leader devient plus long que le journal de n'importe quel suiveur, alors, avec le rythme cardiaque, il lui envoie s√©quentiellement les op√©rations manquantes. Appelez-le ajouter une demande. Si la plupart des n≈ìuds confirment la r√©ception de nouvelles op√©rations, le leader applique ces op√©rations √† sa base de donn√©es et augmente l'index de la derni√®re op√©ration appliqu√©e. Cet index est √©galement envoy√© aux abonn√©s avec une demande de pulsation. Et si l'indice leader est sup√©rieur √† l'indice suiveur, le suiveur applique √©galement des op√©rations √† sa base de donn√©es afin d'√©galiser les indices. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce type de demande d'ajout que le leader envoie au suiveur</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestAppendDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderId; <span class="hljs-comment">//   </span><font></font>
<font></font>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer prevLogIndex;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long prevLogTerm;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderCommit;<span class="hljs-comment">//      </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Operation operation; <span class="hljs-comment">//</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des impl√©mentations dans lesquelles les op√©rations sont transf√©r√©es par lots de plusieurs par demande. </font><font style="vertical-align: inherit;">Dans l'impl√©mentation actuelle, une seule op√©ration peut √™tre transmise par </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
requ√™te. La classe r√©pond √† l'envoi et au traitement de la requ√™te heartbeat-append:</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationService.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReplicationService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO requestAppendDTO)</span></span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soumettre une demande de modification des donn√©es </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez un fragment d'une </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">m√©thode de</font></a></font><code>sendAppendForOnePeer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classe </font></font><code>ReplicationServiceImpl</code><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La m√©thode est responsable de g√©n√©rer une demande au suiveur et de l'envoyer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> CompletableFuture&lt;AnswerAppendDTO&gt; <span class="hljs-title">sendAppendForOnePeer</span><span class="hljs-params">(Integer id)</span> </span>{
   <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
       <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">//1</span><font></font>
           Peer peer = context.getPeer(id);<font></font>
<font></font>
           Operation operation;<font></font>
           Integer prevIndex;<font></font>
           <span class="hljs-comment">//2    </span>
           <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex()) {<font></font>
               operation = operationsLog.get(peer.getNextIndex());<font></font>
               prevIndex = peer.getNextIndex() - <span class="hljs-number">1</span>;<font></font>
           } <span class="hljs-keyword">else</span> 
           <span class="hljs-comment">//3  </span><font></font>
           {<font></font>
               operation = <span class="hljs-keyword">null</span>;<font></font>
               prevIndex = operationsLog.getLastIndex();<font></font>
           }<font></font>
<font></font>
<font></font>
           RequestAppendDTO requestAppendDTO = <span class="hljs-keyword">new</span> RequestAppendDTO(<font></font>
                   context.getCurrentTerm(), <span class="hljs-comment">//   </span>
                   context.getId(), <span class="hljs-comment">//  </span>
                   prevIndex,<span class="hljs-comment">//      </span>
                   operationsLog.getTerm(prevIndex),<span class="hljs-comment">//  </span><font></font>
                   context.getCommitIndex(),<font></font>
                               <span class="hljs-comment">//      </span>
                   Operation <span class="hljs-comment">//</span><font></font>
           );<font></font>
<font></font>
...<font></font>
<span class="hljs-comment">/*   http     */</span>
}</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©tadonn√©es du suiveur</font></font></li>
<li>   ,   .             (      ),          ,      ,  ,   .    ,       ,    ,   ,     </li>
<li>   ,    ,       ;        ,     ,       ,  </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, consid√©rez la m√©thode de </font></font><code>appendRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ReplicationServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est responsable de l'envoi de la demande d'ajout et du traitement du r√©sultat √† tous les abonn√©s.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationServiceImpl.java#L109</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span> </span>{<font></font>
       List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<font></font>
       <span class="hljs-comment">//1 </span>
       <span class="hljs-keyword">while</span> (peersIds.size() &gt; <span class="hljs-number">0</span>) {
           <span class="hljs-comment">//2 </span><font></font>
           List&lt;AnswerAppendDTO&gt; answers = sendAppendToAllPeers(peersIds);<font></font>
           peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
           <span class="hljs-keyword">for</span> (AnswerAppendDTO answer : answers) {
               <span class="hljs-comment">//3</span>
               <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
                   <span class="hljs-comment">//4</span>
                   <span class="hljs-keyword">if</span> (answer.getTerm() &gt; context.getCurrentTerm()) {<font></font>
                        context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
                       <span class="hljs-keyword">return</span>;<font></font>
                   }<font></font>
                   Peer peer = context.getPeer(answer.getId());<font></font>
                   <span class="hljs-comment">//5     </span>
                   <span class="hljs-keyword">if</span> (answer.getSuccess()) {                      <font></font>
                       peer.setNextIndex(answer.getMatchIndex() + <span class="hljs-number">1</span>);<font></font>
                       peer.setMatchIndex(answer.getMatchIndex());<font></font>
                       <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex())<font></font>
                           peersIds.add(answer.getId());<font></font>
                   <span class="hljs-comment">//6      </span>
                   } <span class="hljs-keyword">else</span> {<font></font>
                       peer.decNextIndex();<font></font>
                       peersIds.add(answer.getId());<font></font>
                   }<font></font>
               }<font></font>
           }<font></font>
           <span class="hljs-comment">//7</span><font></font>
           tryToCommit();<font></font>
       }<font></font>
}<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous r√©p√©tons la demande jusqu'√† ce que nous recevions une r√©ponse de tous les abonn√©s que la r√©plication a r√©ussi. </font><font style="vertical-align: inherit;">√âtant donn√© qu'une op√©ration est envoy√©e par demande, la synchronisation des journaux des abonn√©s peut prendre plusieurs it√©rations.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoyez des demandes √† tous les abonn√©s et obtenez une liste de r√©ponses </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous consid√©rons les r√©ponses uniquement des abonn√©s disponibles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il s'av√®re que le tour d'un des suiveurs est sup√©rieur au tour du leader, nous arr√™tons tout et devenons un suiveur </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le suiveur r√©pond que tout a r√©ussi, nous mettons √† jour les m√©tadonn√©es du suiveur: nous enregistrons le dernier index du journal du suiveur et l'index de la prochaine op√©ration attendue par le suiveur. </font></font></li>
<li>  ,    ,  ,           ,           .  ,                  ,      .     ,         .    ,          .</li>
<li>        ,      .     . </li>
</ol><br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment exactement le suiveur traite la demande d'ajout du leader. </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√©thode de </font></font><code>append</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO dto)</span> </span>{<font></font>
     <font></font>
       <span class="hljs-comment">//1     </span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm()) {
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dto.getTerm() &gt; context.getCurrentTerm()) {
           <span class="hljs-comment">//2 </span><font></font>
           context.setCurrentTerm(dto.getTerm());<font></font>
           context.setVotedFor(<span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
       <span class="hljs-comment">//3  </span>
       applicationEventPublisher.publishEvent(<span class="hljs-keyword">new</span> ResetElectionTimerEvent(<span class="hljs-keyword">this</span>));<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (!context.getState().equals(FOLLOWER)) {<font></font>
           context.setState(FOLLOWER);<font></font>
       }<font></font>
        <font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">if</span> ((dto.getPrevLogIndex() &gt; operationsLog.getLastIndex()) ||                                                                                        !dto.getPrevLogTerm().equals(operationsLog.getTerm(dto.getPrevLogIndex()))) {
                      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
<font></font>
<font></font>
       Operation newOperation = dto.getOperation();<font></font>
       <span class="hljs-keyword">if</span> (newOperation != <span class="hljs-keyword">null</span>) {
           <span class="hljs-keyword">int</span> newOperationIndex = dto.getPrevLogIndex() + <span class="hljs-number">1</span>;<font></font>
           <font></font>
         <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {
               <span class="hljs-comment">//5</span>
               <span class="hljs-keyword">if</span> ((newOperationIndex &lt;= operationsLog.getLastIndex()) &amp;&amp;<font></font>
                      (!newOperation.getTerm().equals(operationsLog.getTerm(newOperationIndex)))){<font></font>
                   operationsLog.removeAllFromIndex(newOperationIndex);<font></font>
               }<font></font>
               <span class="hljs-comment">//6</span>
               <span class="hljs-keyword">if</span> (newOperationIndex &lt;= operationsLog.getLastIndex())<font></font>
               {<font></font>
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>,      operationsLog.getLastIndex());<font></font>
               }<font></font>
               <span class="hljs-comment">//7</span><font></font>
               operationsLog.append(newOperation);<font></font>
           }<font></font>
        }<font></font>
        <span class="hljs-comment">//8 </span>
        <span class="hljs-keyword">if</span> (dto.getLeaderCommit() &gt; context.getCommitIndex()) {<font></font>
           context.setCommitIndex(Math.min(dto.getLeaderCommit(), operationsLog.getLastIndex()));<font></font>
       }<font></font>
<font></font>
                 <font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>, operationsLog.getLastIndex());<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le tour du leader est inf√©rieur au tour du suiveur, alors nous envoyons √† notre chef un tour et un signe que sa demande a √©t√© rejet√©e. </font><font style="vertical-align: inherit;">D√®s que le leader re√ßoit un round plus grand que le sien en r√©ponse, il se transforme en suiveur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le tour du leader est sup√©rieur au tour du suiveur, d√©finissez ce tour sur le suiveur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depuis que la demande a √©t√© re√ßue du leader, qu'il y ait des donn√©es ou non, nous remettons √† z√©ro la minuterie de vote et, si nous n'√©tions pas un suiveur, nous le devenons </font></font></li>
<li>   ,   ,            ,  ,   ,    ,   .        ,    ,      </li>
<li>              ,   .            .   ,     , - ,   ,      ,      ,      .             ,    .</li>
<li>  ,   .  ,    </li>
<li>  ,     </li>
<li>        ,   ,       ,    . </li>
</ol><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'√† comprendre comment le leader applique les op√©rations du journal √† la base de donn√©es. En train d'envoyer des op√©rations aux suiveurs et de traiter les r√©ponses de ceux-ci, le leader met √† jour les m√©tadonn√©es des n≈ìuds. D√®s que le nombre de n≈ìuds dont l'index de la derni√®re op√©ration dans le journal est sup√©rieur √† l'index de la derni√®re op√©ration appliqu√©e √† la base de donn√©es par le leader devient √©gal au quorum, nous pouvons d√©clarer que la plupart des n≈ìuds ont re√ßu l'op√©ration et nous pouvons l'appliquer √† la base de donn√©es du leader. En d'autres termes, si un leader a envoy√© une op√©ration √† des abonn√©s et que la plupart d'entre eux l'ont ins√©r√©e dans son journal et ont r√©pondu au leader, nous pouvons appliquer cette op√©ration √† la base de donn√©es du leader et augmenter l'index de la derni√®re op√©ration appliqu√©e. Cet index avec la prochaine demande append-heartbeat volera vers le suiveur et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appliquera l'op√©ration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec le m√™me index de son journal √† sa base de donn√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysons la m√©thode de </font></font><code>tryToCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryToCommit</span><span class="hljs-params">()</span> </span>{
       <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
           <span class="hljs-comment">//1</span>
           <span class="hljs-keyword">int</span> N = context.getCommitIndex() + <span class="hljs-number">1</span>;
           <span class="hljs-comment">//2</span><font></font>
           Supplier&lt;Long&gt; count = () -&gt;<font></font>
               context.getPeers().stream().map(Peer::getMatchIndex).<font></font>
                       filter(matchIndex -&gt; matchIndex &gt;= N).count() + <span class="hljs-number">1</span>;<font></font>
<font></font>
           <span class="hljs-comment">//3 </span>
           <span class="hljs-keyword">if</span> (operationsLog.getLastIndex() &gt;= N &amp;&amp;<font></font>
                   operationsLog.getTerm(N).equals(context.getCurrentTerm())&amp;&amp;<font></font>
                      count.get()&gt;=context.getQuorum()<font></font>
           )<font></font>
           {<font></font>
               context.setCommitIndex(N);<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-keyword">return</span>;<font></font>
       }<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous obtenons l'index suivant de l'op√©ration appliqu√©e √† la base de donn√©es</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous comptons combien de followers ont une op√©ration avec un tel index dans leurs logs, et n'oubliez pas d'ajouter un leader </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le nombre de ces abonn√©s est le quorum et que l'op√©ration avec un tel index est dans le journal du leader, et que le cycle de cette op√©ration est √©quivalent √† celui en cours, le leader applique l'op√©ration √† la base de donn√©es et augmente l'index de la derni√®re op√©ration appliqu√©e. </font><font style="vertical-align: inherit;">Les op√©rations du cycle pr√©c√©dent ne peuvent pas √™tre appliqu√©es, car un autre chef en √©tait responsable et un conflit pourrait survenir. </font><font style="vertical-align: inherit;">Chaque chef applique des op√©rations uniquement de son tour en cours.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout algorithme distribu√©, dont le repr√©sentant de la famille est RAFT, est une solution int√©gr√©e puissante qui garantit l'obtention du r√©sultat, sous r√©serve de toutes les r√®gles d√©crites dans le cahier des charges. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreux algorithmes distribu√©s et ils sont diff√©rents. Il y a ZAB, qui est impl√©ment√© dans Zookeeper et qui est utilis√©, par exemple, pour synchroniser les donn√©es dans Kafka. Il existe des algorithmes avec des exigences de coh√©rence moins strictes, par exemple, la masse des impl√©mentations du protocole Gossip qui sont utilis√©es dans les syst√®mes AP. Il existe des algorithmes qui suivent les principes de RAFT et utilisent en m√™me temps le protocole Gossip pour √©changer des journaux tels que MOKKA, qui utilise √©galement le cryptage.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je crois qu'essayer de comprendre l'un de ces algorithmes est extr√™mement utile pour tout d√©veloppeur, et comme je l'ai mentionn√© ci-dessus, les solutions peuvent √™tre int√©ressantes √† la fois de mani√®re globale et dans des parties distinctes. </font><font style="vertical-align: inherit;">Et √©videmment, il faut absolument aller dans cette direction vers ceux dont les activit√©s sont li√©es au d√©veloppement de syst√®mes distribu√©s et concernant les probl√®mes de synchronisation des donn√©es, m√™me s'ils utilisent des solutions industrielles standard.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rences</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©p√¥t</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sp√©cification</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Br√®ve description</font></font></a></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous esp√©rons que le mat√©riel vous a √©t√© utile. </font><font style="vertical-align: inherit;">Et si vous voulez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suivre un cours</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous pouvez le faire d√®s maintenant.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495342/index.html">R√®glement des cartes bancaires dans le commerce - cr√©ation d'un jeu de donn√©es ouvert et d'une infographie dans Google Data Studio</a></li>
<li><a href="../fr495344/index.html">Unifier: comment Lamoda rend ses services Go coh√©rents</a></li>
<li><a href="../fr495346/index.html">De l'erreur √† l'alerte avec des actions</a></li>
<li><a href="../fr495350/index.html">Serveur Web domestique ou votre propre h√©bergeur</a></li>
<li><a href="../fr495354/index.html">Comment publier des produits en continu en 20 langues et ne pas mourir?</a></li>
<li><a href="../fr495360/index.html">Comment nous avons automatis√© le portage des produits de C # vers C ++</a></li>
<li><a href="../fr495362/index.html">Auto-isolement et programme: comment ne pas devenir fou √† la maison et passer du temps utilement</a></li>
<li><a href="../fr495364/index.html">Guide de style API, ou ne faites pas r√©fl√©chir les utilisateurs</a></li>
<li><a href="../fr495366/index.html">16 types de programmeurs ou d√©veloppeurs ne sont pas les m√™mes robots</a></li>
<li><a href="../fr495368/index.html">Nous nous auto-enregistrons pour les auto-chiens qui se prom√®nent dans des conditions d'auto-isolement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>