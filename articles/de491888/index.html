<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🚀 🚚 🤵🏼 GitLab CI: 6 Funktionen aus den neuesten Versionen, auf die wir gewartet haben 🚣🏻 🧕🏻 🤹🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Zeitalter des allgegenwärtigen CI / CD stehen wir vor einer Vielzahl verwandter Tools, einschließlich CI-Systemen. Es war jedoch GitLab, das uns am...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GitLab CI: 6 Funktionen aus den neuesten Versionen, auf die wir gewartet haben</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/491888/"><img src="https://habrastorage.org/webt/gw/s2/_l/gws2_lpk_xse3zwysoxi7yhgedi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Zeitalter des allgegenwärtigen CI / CD stehen wir vor einer Vielzahl verwandter Tools, einschließlich CI-Systemen. Es war jedoch GitLab, das uns am nächsten kam, wirklich "native". Er erlangte bemerkenswerte Popularität in der gesamten Branche *. Die Entwickler des Produkts blieben nicht hinter dem wachsenden Interesse an seiner Verwendung zurück und begeisterten regelmäßig die Community der Entwickler und DevOps-Ingenieure mit neuen Versionen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/lp/fl/lelpfl_26qkmpjz5qf5cjq4bbd0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab-Repository-Monat und Tag-Aggregation</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab ist der Fall, wenn die aktive Entwicklung viele neue und interessante Funktionen bringt. Wenn dies für potenzielle Benutzer nur einer der Faktoren bei der Auswahl eines Tools ist, ist die Situation für vorhandene Benutzer wie folgt: Wenn Sie Ihre GitLab-Installation im letzten Monat nicht aktualisiert haben, haben Sie mit hoher Wahrscheinlichkeit etwas Interessantes verpasst. Einschließlich regelmäßig auftretender Sicherheitsupdates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Über die bedeutendsten - d.h. Von unseren DevOps-Ingenieuren und -Kunden gefordert - Innovationen in den neuesten Versionen der Community-Edition von GitLab. Dieser Artikel wird diskutiert.</font></font><a name="habracut"></a><br>
<br>
<i>*   5  ,  «GitLab»,   : «,   GitHub?».     — ,  Google Trends <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  5-    «gitlab»   .     «»  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.     ,   ,     «»   .</i><br>
<br>
<h2>№1: needs</h2><br>
<ul>
<li>     job'.</li>
<li>    GitLab: 12.2.</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gedanke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>dependencies</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- das ist was du brauchst? Wahrscheinlich waren wir nicht die einzigen, die den Fehler gemacht haben, diese Richtlinie zuzuweisen ... Es ist erforderlich, die vorherigen Jobs aufzulisten, deren </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artefakte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erforderlich sein werden. Es handelt sich um Artefakte und nicht um die Abhängigkeit von der Leistung der vorherigen Aufgabe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, es gibt in einer Phase Jobs, die nicht ausgeführt werden müssen, aber aus irgendeinem Grund gibt es keine Möglichkeit oder nur den Wunsch, sie in eine separate Phase zu bringen (Faulheit ist der Motor des Fortschritts, aber lassen Sie sich nicht mitreißen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/sa/k1/_usak1lrpdqpjtxln69r3ktc5ag.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen können, </font><font style="vertical-align: inherit;">enthält </font><font style="vertical-align: inherit;">Stage </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schaltflächen zum Ausrollen von Produktions- und Stage- sowie Job- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium-Tests</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus irgendeinem Grund wird nicht ausgeführt. </font><font style="vertical-align: inherit;">Es ist ganz einfach: Er wartet, bis alle Aufträge aus der vorherigen Phase erfolgreich abgeschlossen wurden. </font><font style="vertical-align: inherit;">Im Rahmen derselben Pipeline müssen wir jetzt keine Phase bereitstellen, um die Tests auszuführen (sie wurde früher abgepumpt, nicht innerhalb des Tags). </font><font style="vertical-align: inherit;">Was ist zu tun? </font><font style="vertical-align: inherit;">Dann kommen Sie </font><font style="vertical-align: inherit;">zu den Rettungs </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bedürfnisse</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir listen nur die erforderlichen vorherigen Jobs auf, um unsere Tests auszuführen:</font></font><br>
<br>
<pre><code class="plaintext hljs">  needs:<font></font>
    - To production (Cluster 1)<font></font>
    - To production (Cluster 2)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... und wir bekommen einen Job, der automatisch aufgerufen wird, nachdem nur die aufgelisteten Jobs ausgeführt wurden: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/9y/8z/jm9y8zesapj3neflq_xmn7er70i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praktisch, richtig? </font><font style="vertical-align: inherit;">Aber einmal hatte ich erwartet, dass die Richtlinie so etwas funktionieren würde </font></font><code>dependencies</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nr. 2: erstreckt sich</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verbesserte YAML-Anker und Aliase.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eingeführt seit GitLab 11.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#extends</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keine Lust mehr auf Rollen </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Fehlt das Prinzip der Code-Wiederverwendung? Dann haben Sie es bereits versucht und wahrscheinlich erfolgreich </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einen Zustand wie diesen gebracht:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: &amp;base_deploy<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Test:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: test.example.com<font></font>
    name: test<font></font>
<font></font>
Deploy Production:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"<font></font>
    MY_VAR: "10"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klingt gut? Wenn Sie genau hinschauen, fällt Ihnen jedoch etwas auf ... Warum haben wir die Produktion nicht nur geändert </font></font><code>variables.CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sondern auch ein zweites Mal verschrieben </font></font><code>variables.MY_VAR=10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Sollte diese Variable entnommen werden </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Es stellt sich heraus, dass dies nicht der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fall sein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sollte: YAML funktioniert so, dass bei einer Neudefinition des vom Anker empfangenen </font><font style="vertical-align: inherit;">Inhalts </font><i><font style="vertical-align: inherit;">der</font></i><font style="vertical-align: inherit;"> Inhalt der übereinstimmenden Felder </font><i><font style="vertical-align: inherit;">nicht erweitert</font></i><font style="vertical-align: inherit;"> , sondern </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ersetzt wird</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Daher sind wir gezwungen, die uns bereits bekannten Variablen im entsprechenden Absatz aufzulisten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja, "Erweitern" ist das richtige Wort: Genau so wird die betreffende Funktion genannt. </font></font><code>Extends</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie ermöglichen es uns nicht nur, das Feld neu zu schreiben, wie es beim Anker geschieht, sondern auch eine intelligente Zusammenführung durchzuführen:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: <font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Production:<font></font>
  extends: .base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier im letzten Job </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy Production gibt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es sowohl eine Variable </font></font><code>MY_VAR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Standardwert als auch eine überschriebene </font></font><code>CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass dies eine Kleinigkeit ist, aber stellen Sie sich vor: Sie haben einen </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und 20 Schaltkreise ähnlich eingesetzt. </font><font style="vertical-align: inherit;">Sie müssen an andere weitergegeben werden </font></font><code>cluster</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>environment.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">während ein bestimmter Satz von Variablen oder andere übereinstimmende Felder erhalten </font><font style="vertical-align: inherit;">bleiben </font><font style="vertical-align: inherit;">... Diese kleine Angenehmheit ermöglichte es uns, die Beschreibung des Einsatzes vieler Entwicklungsschaltungen um das 2-3-fache zu reduzieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nr. 3: einschließen</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir teilen riesige YAML in mehrere und verwenden sie in anderen Projekten wieder.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eingeführt in Core seit Version 11.4.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#include</font></font></a></li>
</ul><br>
<code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es sieht immer noch aus </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie eine Faltanleitung für einen Staubsauger in 20 Sprachen (von denen Sie nur Ihre Muttersprache verstehen). Ist</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es schwierig, sich mit einem seiner Abschnitte zu befassen, ohne sich angesichts unbekannter Aufgaben auf dem Weg zu ändern? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein langjähriger Programmierfreund wird helfen </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">stages:<font></font>
  - test<font></font>
  - build<font></font>
  - deploy<font></font>
<font></font>
variables:<font></font>
  VAR_FOR_ALL: 42<font></font>
<font></font>
include:<font></font>
  - local: .gitlab/ci/test.yml<font></font>
  - local: .gitlab/ci/build.yml<font></font>
  - local: .gitlab/ci/deploy-base.yml<font></font>
  - local: .gitlab/ci/deploy-production.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jene. </font><font style="vertical-align: inherit;">Jetzt bearbeiten wir mutig die Bereitstellung in der Produktion, während Tester damit beschäftigt sind, ihre Datei zu ändern, was wir möglicherweise nicht einmal betrachten. </font><font style="vertical-align: inherit;">Darüber hinaus hilft dies, Zusammenführungskonflikte zu vermeiden: Es macht nicht immer Spaß, den Code eines anderen zu verstehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber was ist, wenn wir die Pipeline unserer 20 Projekte entlang und über kennen, können wir die Logik jedes Jobs daraus erklären? </font><font style="vertical-align: inherit;">Wie wird uns das helfen? </font><font style="vertical-align: inherit;">Für diejenigen, die eine Aufklärung über die Wiederverwendung von Code erreicht haben, und für alle, die viele ähnliche Projekte haben, können Sie:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Include GitLab CI-Dateien aus einem anderen Repository derselben GitLab-Instanz.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: template</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Sammlungen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vorgefertigter GitLab-Vorlagen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: remote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - eine externe Datei (über HTTPS zugänglich).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Dutzend Projekte derselben Art mit unterschiedlichem Code, die jedoch auf dieselbe Weise bereitgestellt wurden - einfach und ohne Aktualisierung des aktuellen CI in allen Repositorys! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Beispiel für die praktische Anwendung </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde auch in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diesem Artikel gegeben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nr. 4: nur / außer refs</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Umfassende Bedingungen, einschließlich Variablen und Dateiänderungen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Da es sich um eine ganze Familie von Funktionen handelt, wurden einige Teile in GitLab 10.0 angezeigt, während andere (z. B. </font></font><code>changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">in </font><font style="vertical-align: inherit;">11.4 angezeigt wurden.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#onlyexcept-advanced</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manchmal scheint es mir, dass dies keine Pipeline ist, die uns zuhört, sondern wir ihn. </font><font style="vertical-align: inherit;">Ein hervorragendes Management-Tool ist </font></font><code>only</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- jetzt integriert. </font><font style="vertical-align: inherit;">Was bedeutet das? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im einfachsten (und vielleicht angenehmsten) Fall überspringen Sie die Phasen:</font></font><br>
<br>
<pre><code class="plaintext hljs">Tests:<font></font>
  only:<font></font>
    - master<font></font>
  except:<font></font>
    refs:<font></font>
    - schedules<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $CI_COMMIT_MESSAGE =~ /skip tests/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Beispieljob wird es nur im Hauptzweig ausgeführt, kann jedoch nicht durch einen Zeitplan oder Trigger ausgelöst werden (GitLab teilt API-Aufrufe und -Trigger, obwohl dies im Wesentlichen dieselbe API ist). </font><font style="vertical-align: inherit;">Der Job wird nicht ausgeführt, wenn </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Festschreibungsnachricht eine Passphrase zum </font><b><font style="vertical-align: inherit;">Überspringen von Tests</font></b><font style="vertical-align: inherit;"> enthält </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Zum Beispiel wurde ein Tippfehler im </font></font><code>README.md</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projekt oder </font><font style="vertical-align: inherit;">in der </font><font style="vertical-align: inherit;">Dokumentation </font><font style="vertical-align: inherit;">behoben </font><font style="vertical-align: inherit;">- warum auf die Testergebnisse warten? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Hey, 2020 ist draußen!" </font><font style="vertical-align: inherit;">Warum sollte ich der Eisenbox jedes Mal erklären, dass beim Ändern der Dokumentation keine Tests durchgeführt werden müssen? “ </font><font style="vertical-align: inherit;">Und wirklich: </font></font><code>only:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können Tests ausführen, wenn Sie Dateien nur in bestimmten Verzeichnissen ändern. </font><font style="vertical-align: inherit;">Zum Beispiel:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
      - master<font></font>
      - merge_requests<font></font>
    changes:<font></font>
      - "front/**/*"<font></font>
      - "jest.config.js"<font></font>
      - "package.json"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und für die umgekehrte Aktion - d.h. </font><font style="vertical-align: inherit;">nicht laufen - ja </font></font><code>except:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nr. 5: Regeln</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Individuelle Jobregeln.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eingeführt in GitLab 12.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#rules</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Anweisung ist den vorherigen sehr ähnlich, </font></font><code>only:*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hat jedoch einen wichtigen Unterschied: Sie ermöglicht die Steuerung des Parameters </font></font><code>when</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Zum Beispiel, wenn Sie die Möglichkeit, einen Job zu starten, nicht vollständig entfernen möchten. </font><font style="vertical-align: inherit;">Sie können einfach die Schaltfläche verlassen, die bei Bedarf unabhängig aufgerufen wird, ohne eine neue Pipeline zu starten oder ohne ein Commit durchzuführen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: Umgebung: auto_stop_in</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stoppen Sie Umgebungen ohne Aktivität.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eingeführt in GitLab 12.8.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#environmentauto_stop_in</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben diese Gelegenheit kurz vor der Veröffentlichung des Artikels kennengelernt und hatten noch nicht genug Zeit, um sie in der Praxis auszuprobieren, aber dies ist definitiv „das Gleiche“, was in mehreren Projekten so erwartet wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können einen Parameter in GitLab-Umgebungen angeben. Dies </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist sehr nützlich, wenn Sie Umgebungen dynamisch erstellen und löschen möchten, z. B. für jeden Zweig. Der mit k gekennzeichnete Job </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird beispielsweise ausgeführt, wenn sich die Zusammenführung von MR im Hauptzweig befindet oder wenn der MR geschlossen wird (oder auch nur durch Klicken auf die Schaltfläche), wodurch die unnötige Umgebung automatisch gelöscht wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles ist bequem, logisch, funktioniert ... wenn nicht für den menschlichen Faktor. Viele Entwickler führen MRs nicht durch Klicken auf eine Schaltfläche in GitLab zusammen, sondern lokal über </font></font><code>git merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sie können sie verstehen: es ist bequem! Aber in diesem Fall die Logik</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es funktioniert nicht, wir haben vergessene Umgebungen angesammelt ... Hier bieten sich die lang erwarteten an </font></font><code>auto_stop_in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: temporäre Hütten, wenn nicht genügend Möglichkeiten vorhanden sind</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz all dieser (und vieler anderer) neuer, nachgefragter Funktionen von GitLab sind die Bedingungen für die Erfüllung eines Auftrags im Rahmen der derzeit verfügbaren Funktionen leider manchmal einfach nicht zu beschreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab ist nicht perfekt, bietet aber die grundlegenden Tools zum Erstellen einer Traum-Pipeline ... wenn Sie bereit sind, über das bescheidene DSL hinauszugehen und in die Welt des Skripts einzutauchen. </font><font style="vertical-align: inherit;">Hier sind einige Lösungen aus unserer Erfahrung, die in keiner Weise vorgeben, ideologisch korrekt oder empfohlen zu sein, sondern eher vorgestellt werden, um verschiedene Möglichkeiten mit einem Mangel an integrierter API-Funktionalität zu demonstrieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemumgehung Nr. 1: Starten Sie zwei Jobs mit einer Schaltfläche</font></font></h3><br>
<pre><code class="plaintext hljs">script:<font></font>
  - &gt; <font></font>
    export CI_PROD_CL1_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 1)")][0] | .id'`<font></font>
  - &gt; <font></font>
    export CI_PROD_CL2_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 2)")][0] | .id'`<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL1_JOB_ID/play"<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL2_JOB_ID/play"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und warum nicht, wenn Sie wirklich wollen?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemumgehung Nr. 2: Übertragung in MR-RB-Dateien für Rubocop im Bild geändert</font></font></h3><br>
<pre><code class="plaintext hljs">Rubocop:<font></font>
  stage: test<font></font>
  allow_failure: false<font></font>
  script:<font></font>
    ...<font></font>
    - export VARFILE=$(mktemp)<font></font>
    - export MASTERCOMMIT=$(git merge-base origin/master HEAD)<font></font>
    - echo -ne 'CHANGED_FILES=' &gt; ${VARFILE}<font></font>
    - if [ $(git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' | wc -w |awk '{print $1}') -gt 0 ]; then<font></font>
        git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' |tr '\n' ' ' &gt;&gt; ${VARFILE} ;<font></font>
      fi<font></font>
    - if [ $(wc -w ${VARFILE} | awk '{print $1}') -gt 1 ]; then<font></font>
        werf --stages-storage :local run rails-dev --docker-options="--rm --user app --env-file=${VARFILE}" -- bash -c /scripts/rubocop.sh ;<font></font>
      fi<font></font>
    - rm ${VARFILE}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da sich kein Bild darin befindet </font></font><code>.git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, musste ich aussteigen, um nur die geänderten Dateien zu überprüfen. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis: Dies ist keine sehr übliche Situation und ein verzweifelter Versuch, viele Bedingungen des Problems zu erfüllen, deren Beschreibung nicht im Umfang dieses Artikels enthalten ist.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemumgehung Nr. 3: Auslöser zum Starten von Jobs aus anderen Repositorys beim Rollout</font></font></h3><br>
<pre><code class="plaintext hljs">  before_script:<font></font>
    - |<font></font>
      echo '### Trigger review: infra'<font></font>
      curl -s -X POST \<font></font>
        -F "token=$REVIEW_TOKEN_INFRA" \<font></font>
        -F "ref=master" \<font></font>
        -F "variables[REVIEW_NS]=$CI_ENVIRONMENT_SLUG" \<font></font>
        -F "variables[ACTION]=auto_review_start" \<font></font>
        https://gitlab.example.com/api/v4/projects/${INFRA_PROJECT_ID}/trigger/pipeline</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass eine so einfache und notwendige Sache (in der Welt der Mikrodienste) darin besteht, einen anderen Mikrodienst als Abhängigkeit in eine neu erstellte Schaltung einzuführen. </font><font style="vertical-align: inherit;">Es ist jedoch kein API-Aufruf und eine bereits bekannte (oben beschriebene) Funktion erforderlich:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $ACTION == "auto_review_start"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anmerkungen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Job on Trigger ist so konzipiert, dass eine Variable an die API übergeben wird, ähnlich wie in Beispiel Nr. 1. </font><font style="vertical-align: inherit;">Es ist logischer, dies auf der API mit dem übergebenen Jobnamen zu implementieren.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ja, die Funktion ist in der kommerziellen (EE) Version von GitLab enthalten, wird jedoch nicht berücksichtigt.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab versucht, mit den Trends Schritt zu halten und schrittweise Funktionen zu implementieren, die von der DevOps-Community angenehm und gefragt sind. </font><font style="vertical-align: inherit;">Sie sind recht einfach zu bedienen und können jederzeit mit Skripten erweitert werden, wenn die grundlegenden Funktionen nicht ausreichen. </font><font style="vertical-align: inherit;">Und wenn wir sehen, dass es sich beim Support nicht so elegant und bequem herausstellt ... bleibt es, auf neue Versionen von GitLab zu warten - oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dem Projekt mit unserem Beitrag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">helfen</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie auch in unserem Blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montage und Bereitstellung der gleichen Art von Microservices mit werf und GitLab CI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JUnit in GitLab CI mit Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werf —    CI/CD  Kubernetes (   )</a>» <i>( ; 27  2019  DevOpsConf)</i>;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">       GitLab CI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitLab CI       production</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de491876/index.html">MosQA # 2 - Materialien von Mitap und Suche nach allen Flaggen der Quest</a></li>
<li><a href="../de491880/index.html">5 Stufen der Unvermeidlichkeit der Annahme der ISO / IEC 27001-Zertifizierung. Zorn</a></li>
<li><a href="../de491882/index.html">Automatisieren Sie die Eingabe in SecureCRT mithilfe von Skripten</a></li>
<li><a href="../de491884/index.html">Ganzheitliches Wissensmanagement in einem IT-Unternehmen</a></li>
<li><a href="../de491886/index.html">KnowledgeConf 2020 Online: Implementierung eines schrittweisen Wissensmanagements</a></li>
<li><a href="../de491890/index.html">Laufwerksanatomie: SSD</a></li>
<li><a href="../de491896/index.html">Wie wir bei Cyan ein Produkt durch User Experience Research verbessern</a></li>
<li><a href="../de491900/index.html">Flexibilität und Automatisierung beim maschinellen Lernen</a></li>
<li><a href="../de491902/index.html">Schreiben eines einfachen WYSIWYG-Editors mit ProseMirror</a></li>
<li><a href="../de491904/index.html">So schreiben Sie sicheren Python-Code. Mahlzeiten Kushal Das</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>