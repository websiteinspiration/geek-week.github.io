<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥕 🤷🏽 🐒 Google App Script、Mikrotik、Telegram、VPNBookがカルテットの演奏を開始 🈚️ 🤙🏽 🙎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今日のプログラム：通常のアイデアが終わったら、他にどこにGoogle Appsスクリプトを適用できますか。私が知らないさまざまな言語のスクリプトのチェーンによるVPNBookでの作業の自動化。Nek-cURL by Mikrotik。ある場所を介して電報を送信し、別の場所に存在しないようにするため、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Google App Script、Mikrotik、Telegram、VPNBookがカルテットの演奏を開始</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475856/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日のプログラム：通常のアイデアが終わったら、他にどこにGoogle Appsスクリプトを適用できますか。</font><font style="vertical-align: inherit;">私が知らないさまざまな言語のスクリプトのチェーンによるVPNBookでの作業の自動化。</font><font style="vertical-align: inherit;">Nek-cURL by Mikrotik。</font><font style="vertical-align: inherit;">ある場所を介して電報を送信し、別の場所に存在しないようにするため、自己監視が可能です。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1.無題</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1年前、</font><font style="vertical-align: inherit;">VPNBookを介して無料のVPNアクセスのためにMikrotikルーターで自動パスワード取得を設定する方法について、「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPNBookパスワードを取得するためのほぼOCR。PHP + Mikrotik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font><font style="vertical-align: inherit;">というメモを書きました</font><font style="vertical-align: inherit;">。物語の始まりはそこにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それ以来、大量の水が流れ、ロシアではVPNBookサイトをブロックしましたが、公開されているパブリックVPNサーバー自体はブロックしていません。パスワードのPNG画像をテキスト文字列にデコードするPHPスクリプトは、トラフィックがブロッキングシステムを通過しないサーバーで起動したときにも機能するようになりました。しかし、少し前に、Google Apps Script（GAS）</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスのscript.google.comを試してみました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私は外部のWebサーバー上のPHPスクリプトを破棄し、Webアプリケーション（Webアプリケーション）として実行されているGASスクリプトで部分的または完全に置き換えることにしました。実行ポリシーとGAS制限を理解していませんでしたが、私がしたことはすべて無料のGoogleアカウントで機能し、まだお金を要求していません。 Google Apps Scriptについて詳しく説明する目標はありません。 GASはJavaScript言語に基づいており、サードパーティのJSライブラリを使用したり、スクリプトをWebアプリケーションとして公開したりすることができ、許可なしに誰でも利用できるようにすることができます。現在のGAS実装の機能では十分ではなかったので、回避して回避策を探す必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、PNG画像のプロキシを作成することにしました。</font><font style="vertical-align: inherit;">このWebスクリプトは、VPNBook Webサイト（パスワードはPNGで公開されたことを思い出します）からパスワード画像を要求し、このスクリプトを呼び出してデコードするクライアントにそれを提供することになっています。</font><font style="vertical-align: inherit;">ロックを回避するためのそのような方法。</font><font style="vertical-align: inherit;">ここで、GASの最初の制限が満たされました。</font><font style="vertical-align: inherit;">スクリプトはMIME画像/ pngをレンダリングできませんが、テキスト形式、JSON、TEXT、XMLなどのみをレンダリングできることがわかりました。</font><font style="vertical-align: inherit;">しかし、これを回避する方法がありました。</font><font style="vertical-align: inherit;">PNGをBase64にエンコードして、テキスト文字列をクライアントに返すことができます。</font><font style="vertical-align: inherit;">インターネット上に同様のスクリプトがあります。例：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">techslides.com/image-proxy-with-google-app-scripts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そのうちの1つを単純化しました。</font><font style="vertical-align: inherit;">画像は1つだけ必要で、Base64文字列のみを出力しました。</font><font style="vertical-align: inherit;">結果は、1つのdoGet関数（応答として文字列を返すGETリクエストハンドラー）のみで構成されるスクリプトです。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doGet</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> response = UrlFetchApp.fetch(<span class="hljs-string">'https://www.vpnbook.com/password.php'</span>);
  <span class="hljs-keyword">var</span> b64 = Utilities.base64Encode(response.getContent());
  <span class="hljs-comment">//var data = 'data:'+type+';base64,'+b64;</span>
  <span class="hljs-keyword">return</span> ContentService.createTextOutput(b64);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブラウザー出力の例： </font></font><br>
<br>
<pre><code class="plaintext hljs">iVBORw0KGgoAAAANSUhEUgAAAGQAAAANAQMAAABl11mFAAAABlBMVEX29vZMTExY89ZbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAVUlEQVQImWNgIBrwSzCw/2ZgOADhSc5gYJCG8wxQedLdCcYFNXcgPHOZsxuSZxx7BuFZzsjdcJi34TBU5Y3cjc3IvM3McJ7kjNxtzDwwffwSIB7UTACt/h52C5DFqQAAAABJRU5ErkJggg==</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、PHPスクリプトが動作します。これは、リソースロックを使用してゾーン内のサーバーに配置できます。</font><font style="vertical-align: inherit;">これは、cURL呼び出しのパラメーターが少し変更されていることを除いて、前の記事のスクリプトに非常に似ています。</font><font style="vertical-align: inherit;">cURLがHTTP / 1.1 302 Moved Temporarilyを通過できるようにする必要があります。</font><font style="vertical-align: inherit;">GASが呼び出されると、Webスクリプトアドレスから動的な一時アドレスにリダイレクトされます。</font></font><br>
<br>
<pre><code class="php hljs">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてBase64デコード：</font></font><br>
<br>
<pre><code class="php hljs">$imgOCR = imagecreatefromstring(base64_decode($output));</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプト自体</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//  </span>
$wchar = <span class="hljs-number">9</span>;<font></font>
$hchar = <span class="hljs-number">13</span>;<font></font>
$strDict = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 '</span>;<font></font>
$imgDict = imagecreatetruecolor(<span class="hljs-number">2</span> + strlen($strDict)* $wchar, $hchar);<font></font>
$bg = imagecolorallocate($imgDict, <span class="hljs-number">0xF6</span>, <span class="hljs-number">0xF6</span>, <span class="hljs-number">0xF6</span>);<font></font>
$textcolor = imagecolorallocate($imgDict, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0x4C</span>);<font></font>
imagefill($imgDict, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, $bg);<font></font>
imagestring($imgDict, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, $strDict, $textcolor);<font></font>
<font></font>
<span class="hljs-comment">//  cURL</span><font></font>
$ch = curl_init();<font></font>
<span class="hljs-comment">//  url,     </span>
<span class="hljs-comment">//curl_setopt($ch, CURLOPT_URL, 'https://www.vpnbook.com/password.php');</span>
curl_setopt($ch, CURLOPT_URL, <span class="hljs-string">'https://script.google.com/macros/s/AKfycbwYPfaZobtjbFv0mSYI8U4NIXPh1Sft_DkGH8QKgg/exec'</span>);
<span class="hljs-comment">//  ,      string</span>
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<font></font>
curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<font></font>
curl_setopt($ch, CURLOPT_BINARYTRANSFER, <span class="hljs-number">1</span>); <span class="hljs-comment">// also, this seems wise considering output is image.</span>
<span class="hljs-comment">//  </span><font></font>
$output = curl_exec($ch);<font></font>
<span class="hljs-comment">//  cURL</span><font></font>
curl_close($ch);<font></font>
<font></font>
<span class="hljs-comment">// echo $output;</span><font></font>
<font></font>
$imgOCR = imagecreatefromstring(base64_decode($output));<font></font>
<span class="hljs-comment">//$imgOCR = imageCreateFromPng('password.png');</span>
<span class="hljs-comment">//      10  . 2 + 10*9 = 92 &lt; 100</span>
$maxchar = floor((imagesx($imgOCR) - <span class="hljs-number">2</span>) / <span class="hljs-number">9</span>);<font></font>
$imgBox = imagecreatetruecolor($wchar, $hchar);<font></font>
$hashDict = <span class="hljs-keyword">Array</span>();<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">for</span> ($k = <span class="hljs-number">0</span>; $k &lt; strlen($strDict) ; $k++) {<font></font>
	imagecopy($imgBox, $imgDict, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> + $k * $wchar, <span class="hljs-number">0</span>, $wchar, $hchar);<font></font>
	$hashStr = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span>($y = <span class="hljs-number">0</span>; $y &lt; $hchar ; $y++)
		<span class="hljs-keyword">for</span>($x = <span class="hljs-number">0</span>; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != <span class="hljs-number">0xF6F6F6</span>)? <span class="hljs-string">'1'</span>: <span class="hljs-string">'0'</span>;<font></font>
	$hashDict[$hashStr] = $strDict[$k];<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">for</span> ($k = <span class="hljs-number">0</span>; $k &lt; $maxchar ; $k++) {<font></font>
	imagecopy($imgBox, $imgOCR, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> + $k * $wchar, <span class="hljs-number">0</span>, $wchar, $hchar);<font></font>
	$hashStr = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span>($y = <span class="hljs-number">0</span>; $y &lt; $hchar ; $y++)
		<span class="hljs-keyword">for</span>($x = <span class="hljs-number">0</span>; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != <span class="hljs-number">0xF6F6F6</span>)? <span class="hljs-string">'1'</span>: <span class="hljs-string">'0'</span>;<font></font>
  $tempchar = $hashDict[$hashStr];<font></font>
  <span class="hljs-keyword">if</span> ($tempchar==<span class="hljs-string">'u'</span> || $tempchar==<span class="hljs-string">'y'</span>) <span class="hljs-comment">//   </span>
    $tempchar = (mt_rand(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>))? <span class="hljs-string">'u'</span>: <span class="hljs-string">'y'</span>;
    <span class="hljs-comment">//$tempchar = (time() / 60 % 60 % 2)? 'u': 'y';</span>
  <span class="hljs-keyword">elseif</span> ($tempchar==<span class="hljs-string">' '</span>) <span class="hljs-keyword">break</span>;
	<span class="hljs-keyword">print</span>($tempchar);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*
header('Content-type: image/png');
imagepng($imgDict);
*/</span><font></font>
<font></font>
<span class="hljs-comment">//var_dump($hashDict);</span><font></font>
imagedestroy($imgDict);<font></font>
imagedestroy($imgOCR);<font></font>
imagedestroy($imgBox);<font></font>
<span class="hljs-meta">?&gt;</span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このPHPスクリプトは、PNGパスワードをデコードし、テキスト文字列として返します。</font><font style="vertical-align: inherit;">さらに、Mikrotikに関する部分の最初の記事と同じです。</font><font style="vertical-align: inherit;">ルータはフェッチを使用してパスワードを取得します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は、ミクロティクの前にある2つの中間サービスのこのような作業計画です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2。GASをプッシュします。</font><font style="vertical-align: inherit;">PHPデコーダースクリプトを取り除く</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GASの実験中に、GASで書き換えることにより、PHPのパスワードデコーダーを破棄するというアイデアが生まれました。そして、ここで大きな問題が発見されました。GoogleスクリプトにはPNG処理関数がありません。実行できる唯一のことは、PNGをバイト配列に変換することです。画像の一部とピクセルを操作することについては何の疑問もありませんでした。 PNGを操作するためのJSライブラリを探してGithubに登ったところ、PNG.js、UPNG.js、pngjsの多くが見つかりました。 PNGピクセル（パスワード付きの画像）の1ビット色深度をサポートしないものもあります。彼らは、さまざまなzlib圧縮ライブラリを採用しました。一般に、すべてが少し扱いに​​くいように思われ、XY座標でピクセルにアクセスする機能を使用して、自分のPNG画像だけをビットマップに変換するプリミティブコンバーターを自分で書くことにしました。次に、PNG形式で完全に没頭しました。16進エディター、読書基準、ネット上の説明の山。そして最後に、ピクセルの配列を含むzlibがパックされたIDATファイルのPNGセクションに遭遇しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
zlibを解凍するための関数が必要でしたが、これはもちろんGASにはありませんでした。驚いたことに、gzip / ungzipとzip / unzipがありますが、zlibはありません。 gzip（PNG形式の後の2番目のレベルのイマージョン）について読んだ後、zlib圧縮はあちこちで使用されていますが、IDATセクションからgzip疑似アーカイブの形式で「自転車」を組み立てることはできないという結論に達しました。なぜなら有効なgzipアーカイブを構築するには、解凍したデータの長さを知る必要があります。解凍したデータは解凍しないと取得できませんでした。結局、私はGithubに目を向けて、素晴らしい解決策を見つけました：Google Apps Scriptライブラリ用のzlib.js（https://github.com/hinimub/zlib.js/blob/develop/README.en.md）。これは、プロジェクトキーライブラリを介してGASプロジェクトに統合するために特別に準備されたものです。その後、パズルは収束し始めました。ピクセル配列の解凍とXYピクセルの座標にアクセスするための関数を書き込んだ後、デコーダースクリプトをPHPからGASに転送することができました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考えられるパスワード文字の辞書のハッシュテーブルを個別に計算しました。</font><font style="vertical-align: inherit;">これは、サードパーティのプログラム（LabVIEWではこんにちは、同僚）で行った1回限りのアクションです。</font><font style="vertical-align: inherit;">画像の各文字は、8ビット（インデントなし）x 10行として割り当てることができます。</font><font style="vertical-align: inherit;">1文字の行の8ピクセルをエンコードするには、1バイトで十分です。</font><font style="vertical-align: inherit;">ピクセルの文字列を整数（バイト）で格納し、文字全体を10バイトのシーケンスとして格納できます。</font><font style="vertical-align: inherit;">文字ごとに10桁の16進数が表示されます。</font><font style="vertical-align: inherit;">次に、GASデコーダーはPHPの元祖を繰り返します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果は、GASで完全に機能するスクリプトです。</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doGet</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next();</span>
  <span class="hljs-comment">//var image = file.getBlob(); </span><font></font>
  <font></font>
  <span class="hljs-keyword">var</span> image = UrlFetchApp.fetch(<span class="hljs-string">'https://www.vpnbook.com/password.php'</span>).getBlob();
  <span class="hljs-keyword">var</span> imageString = image.getDataAsString();
  <span class="hljs-keyword">var</span> imageArray = image.getBytes().map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ <span class="hljs-keyword">return</span> e &amp; <span class="hljs-number">0xff</span>; });
  <span class="hljs-comment">// imageArray = blobToUint8(imageArray);</span><font></font>
  <font></font>
  <span class="hljs-keyword">var</span> chunkIDATStart = imageString.indexOf(<span class="hljs-string">"IDAT"</span>) + <span class="hljs-number">4</span>; <span class="hljs-comment">//   IDAT</span>
  <span class="hljs-keyword">var</span> chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf(<span class="hljs-string">"IDAT"</span>) - <span class="hljs-number">4</span>); <span class="hljs-comment">//   IDAT</span>
  <span class="hljs-keyword">var</span> IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen)<font></font>
   <font></font>
  <span class="hljs-keyword">var</span> inflate = <span class="hljs-keyword">new</span> zlibjs.Inflate(IDATArray); <span class="hljs-comment">//  IDAT   zlib</span>
  <span class="hljs-keyword">var</span> plain = inflate.decompress();<font></font>
<font></font>
  <span class="hljs-keyword">const</span> Width = <span class="hljs-number">100</span>; <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> Height = <span class="hljs-number">13</span>; <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> wchar = <span class="hljs-number">9</span>; <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> hchar = <span class="hljs-number">13</span>; <span class="hljs-comment">//  </span><font></font>
  <font></font>
  <span class="hljs-comment">//Logger.log(typeof(plain));</span>
  <span class="hljs-comment">//Logger.log(plain);</span><font></font>
  <font></font>
  rowlen = (Width / <span class="hljs-number">8</span>) &gt;&gt; <span class="hljs-number">0</span>; <span class="hljs-comment">//   ,   </span>
  <span class="hljs-keyword">if</span> ((Width - rowlen * <span class="hljs-number">8</span>) &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">//   </span>
    rowlen+=<span class="hljs-number">2</span>;  <span class="hljs-comment">// +1 filter byte at the beginning of each row.    PNG</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    rowlen++;<font></font>
  }<font></font>
 <font></font>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getXY</span>(<span class="hljs-params">x, y</span>) </span>{ <span class="hljs-comment">//  : 0/1</span>
    <span class="hljs-keyword">var</span> xbyte = (x / <span class="hljs-number">8</span> &gt;&gt; <span class="hljs-number">0</span>); <span class="hljs-comment">//  ,  </span>
    <span class="hljs-comment">//Logger.log("xbyte: " + xbyte);</span>
    <span class="hljs-keyword">var</span> xbit = x - xbyte * <span class="hljs-number">8</span>; <span class="hljs-comment">//  ,   </span>
    <span class="hljs-comment">//Logger.log("xbit: " + xbit);</span>
    <span class="hljs-keyword">return</span> (plain[xbyte + <span class="hljs-number">1</span> + y * rowlen] &lt;&lt; xbit &amp; <span class="hljs-number">0x80</span>) &gt;&gt; <span class="hljs-number">7</span>;  <span class="hljs-comment">// +1 filter byte at the beginning of each row</span><font></font>
  }<font></font>
  <span class="hljs-comment">// Logger.log("getXY: " + getXY(4, 3));</span>
  <span class="hljs-comment">// - .        8  (  ) x 10 ,        (byte),      10  .</span>
  <span class="hljs-comment">//  10 hex   .</span>
  <span class="hljs-keyword">var</span> hashDict = {<span class="hljs-string">'183C66C3C3C3FFC3C3C3'</span>:<span class="hljs-string">'A'</span>,<span class="hljs-string">'FCC6C3C6FCC6C3C3C6FC'</span>:<span class="hljs-string">'B'</span>,<span class="hljs-string">'3E63C1C0C0C0C0C1633E'</span>:<span class="hljs-string">'C'</span>,<span class="hljs-string">'FCC6C3C3C3C3C3C3C6FC'</span>:<span class="hljs-string">'D'</span>, <span class="hljs-string">'FEC0C0C0FCC0C0C0C0FE'</span>:<span class="hljs-string">'E'</span>,<span class="hljs-string">'FFC0C0C0FCC0C0C0C0C0'</span>:<span class="hljs-string">'F'</span>,<span class="hljs-string">'3E63C0C0C0C7C3C3633E'</span>:<span class="hljs-string">'G'</span>,<span class="hljs-string">'C3C3C3C3FFC3C3C3C3C3'</span>:<span class="hljs-string">'H'</span>, <span class="hljs-string">'7E18181818181818187E'</span>:<span class="hljs-string">'I'</span>,<span class="hljs-string">'1E666666466C38'</span>:<span class="hljs-string">'J'</span>,<span class="hljs-string">'C3C6CCD8F0F0D8CCC6C3'</span>:<span class="hljs-string">'K'</span>,<span class="hljs-string">'C0C0C0C0C0C0C0C0C0FE'</span>:<span class="hljs-string">'L'</span>, <span class="hljs-string">'C3E7FFDBDBDBC3C3C3C3'</span>:<span class="hljs-string">'M'</span>,<span class="hljs-string">'C3E3F3F3DBDBCFC7C7C3'</span>:<span class="hljs-string">'N'</span>,<span class="hljs-string">'3C66C3C3C3C3C3C3663C'</span>:<span class="hljs-string">'O'</span>,<span class="hljs-string">'FEC3C3C3FEC0C0C0C0C0'</span>:<span class="hljs-string">'P'</span>, <span class="hljs-string">'3C66C3C3C3C3DBCF663D'</span>:<span class="hljs-string">'Q'</span>,<span class="hljs-string">'FEC3C3C3FEF8CCC6C3C3'</span>:<span class="hljs-string">'R'</span>,<span class="hljs-string">'7EC3C0C07E333C37E'</span>:<span class="hljs-string">'S'</span>,<span class="hljs-string">'FF181818181818181818'</span>:<span class="hljs-string">'T'</span>, <span class="hljs-string">'C3C3C3C3C3C3C3C3663C'</span>:<span class="hljs-string">'U'</span>,<span class="hljs-string">'C3C3C36666663C3C1818'</span>:<span class="hljs-string">'V'</span>,<span class="hljs-string">'C3C3C3C3DBDBDBFFE7C3'</span>:<span class="hljs-string">'W'</span>,<span class="hljs-string">'C3C3663C18183C66C3C3'</span>:<span class="hljs-string">'X'</span>, <span class="hljs-string">'C3C3663C181818181818'</span>:<span class="hljs-string">'Y'</span>,<span class="hljs-string">'FE66C183060C0C0FE'</span>:<span class="hljs-string">'Z'</span>,<span class="hljs-string">'0003E6337FC3C77B'</span>:<span class="hljs-string">'a'</span>,<span class="hljs-string">'C0C0C0DCE6C3C3C3E6DC'</span>:<span class="hljs-string">'b'</span>, <span class="hljs-string">'0003E63C0C0C0633E'</span>:<span class="hljs-string">'c'</span>,<span class="hljs-string">'3333B67C3C3C3673B'</span>:<span class="hljs-string">'d'</span>,<span class="hljs-string">'0003C66C3FFC0633E'</span>:<span class="hljs-string">'e'</span>,<span class="hljs-string">'1E33333030FC30303030'</span>:<span class="hljs-string">'f'</span>, <span class="hljs-string">'0007DC7C6C67CC07E'</span>:<span class="hljs-string">'g'</span>,<span class="hljs-string">'C0C0C0DCE6C3C3C3C3C3'</span>:<span class="hljs-string">'h'</span>,<span class="hljs-string">'181803818181818187E'</span>:<span class="hljs-string">'i'</span>,<span class="hljs-string">'660E66666C6'</span>:<span class="hljs-string">'j'</span>, <span class="hljs-string">'606060666C78786C6663'</span>:<span class="hljs-string">'k'</span>,<span class="hljs-string">'3818181818181818183C'</span>:<span class="hljs-string">'l'</span>,<span class="hljs-string">'000B6DBDBDBDBDBDB'</span>:<span class="hljs-string">'m'</span>,<span class="hljs-string">'000DCE6C3C3C3C3C3'</span>:<span class="hljs-string">'n'</span>, <span class="hljs-string">'0003C66C3C3C3663C'</span>:<span class="hljs-string">'o'</span>,<span class="hljs-string">'000DCE6C3C3C3E6DC'</span>:<span class="hljs-string">'p'</span>,<span class="hljs-string">'0003B67C3C3C3673B'</span>:<span class="hljs-string">'q'</span>,<span class="hljs-string">'000DE736060606060'</span>:<span class="hljs-string">'r'</span>, <span class="hljs-string">'0007EC3C07E3C37E'</span>:<span class="hljs-string">'s'</span>,<span class="hljs-string">'03030FC30303030331E'</span>:<span class="hljs-string">'t'</span>,<span class="hljs-string">'000C3C3C3C3C3673B'</span>:<span class="hljs-string">'u'</span>,<span class="hljs-string">'000C3C366663C3C18'</span>:<span class="hljs-string">'v'</span>, <span class="hljs-string">'000C3C3DBDBDBFF66'</span>:<span class="hljs-string">'w'</span>,<span class="hljs-string">'000C3663C183C66C3'</span>:<span class="hljs-string">'x'</span>,<span class="hljs-string">'000C3C3C3C3C3673B'</span>:<span class="hljs-string">'y'</span>,<span class="hljs-string">'0007E6C1830607E'</span>:<span class="hljs-string">'z'</span>, <span class="hljs-string">'183C66C3C3C3C3663C18'</span>:<span class="hljs-string">'0'</span>,<span class="hljs-string">'1838781818181818187E'</span>:<span class="hljs-string">'1'</span>,<span class="hljs-string">'3C66C336C183060FF'</span>:<span class="hljs-string">'2'</span>,<span class="hljs-string">'7CC6361C633C67C'</span>:<span class="hljs-string">'3'</span>, <span class="hljs-string">'6E1E3666C6FF666'</span>:<span class="hljs-string">'4'</span>,<span class="hljs-string">'FEC0C0DCE633C3663C'</span>:<span class="hljs-string">'5'</span>,<span class="hljs-string">'3C66C2C0DCE6C3C3663C'</span>:<span class="hljs-string">'6'</span>,<span class="hljs-string">'FF336C183060C0C0'</span>:<span class="hljs-string">'7'</span>, <span class="hljs-string">'3C66C3663C66C3C3663C'</span>:<span class="hljs-string">'8'</span>,<span class="hljs-string">'3C66C3C3673B343663C'</span>:<span class="hljs-string">'9'</span>,<span class="hljs-string">'0000000000'</span>:<span class="hljs-string">' '</span>};<font></font>
<font></font>
  <span class="hljs-comment">//      10  . 2 + 10*9 = 92 &lt; 100</span>
  <span class="hljs-keyword">const</span> maxchar = (Width - <span class="hljs-number">2</span>) / wchar &gt;&gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> password = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> charX = <span class="hljs-number">2</span>; charX &lt; maxchar * wchar + <span class="hljs-number">2</span>; charX+=wchar) { <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">var</span> hash = <span class="hljs-string">''</span>; <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> charY = <span class="hljs-number">3</span>; charY &lt; hchar; charY++) { <span class="hljs-comment">//   Y-</span>
      <span class="hljs-keyword">var</span> charrow = <span class="hljs-number">0</span>; <span class="hljs-comment">//   -  8  </span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> charXbit = <span class="hljs-number">0</span>; charXbit &lt; <span class="hljs-number">8</span>; charXbit++) { <span class="hljs-comment">//   X-</span>
        charrow &lt;&lt;= <span class="hljs-number">1</span>;<font></font>
        charrow |= getXY(charX + charXbit, charY);<font></font>
      }<font></font>
      hash += charrow.toString(<span class="hljs-number">16</span>).toUpperCase();
      <span class="hljs-comment">//Logger.log("charrow: " + charrow.toString(2));</span>
      <span class="hljs-comment">//Logger.log("charrow: " + charrow.toString(16).toUpperCase());</span><font></font>
    }<font></font>
    <span class="hljs-keyword">var</span> tempChar = hashDict[hash];
    <span class="hljs-keyword">if</span> (tempChar === <span class="hljs-string">'u'</span> || tempChar === <span class="hljs-string">'y'</span>) { <span class="hljs-comment">//    </span>
      tempChar = (<span class="hljs-built_in">Date</span>.now() % <span class="hljs-number">2</span>) ? <span class="hljs-string">'u'</span>: <span class="hljs-string">'y'</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (tempChar !== <span class="hljs-string">' '</span>) {<font></font>
      password += tempChar; <font></font>
      <span class="hljs-comment">// Logger.log("hash: " +  hash);</span>
      <span class="hljs-comment">// Logger.log("Char: " +  tempChar);</span><font></font>
    }<font></font>
  }<font></font>
  Logger.log(<span class="hljs-string">"password: "</span> +  password);
  <span class="hljs-keyword">return</span> ContentService.createTextOutput(password);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blobToUint8</span>(<span class="hljs-params">blob</span>) </span>{
  <span class="hljs-keyword">return</span> blob.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>)</span>{
    <span class="hljs-keyword">return</span> e &amp; <span class="hljs-number">0xff</span>;<font></font>
  });<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bytesToUint32</span>(<span class="hljs-params">byteArray, start</span>) </span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = start; i &lt; start + <span class="hljs-number">4</span>; i++) {<font></font>
        value = (value * <span class="hljs-number">256</span>) + (byteArray[i] &amp; <span class="hljs-number">0xff</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> value;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">my2</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> file = DriveApp.getFilesByName(<span class="hljs-string">"password2.png"</span>).next();
  <span class="hljs-comment">// var file = DriveApp.getFilesByName("test.bin").next();</span>
  <span class="hljs-keyword">var</span> image = file.getBlob(); 
  <span class="hljs-comment">//var imageArray = image.getBytes();</span>
  <span class="hljs-comment">//var img = UrlFetchApp.fetch('http://example.com/image.png');</span>
  <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> pngjs.PNGReader(image.getBytes());
  <span class="hljs-keyword">var</span> png = reader.parse(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, png</span>)</span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
	<span class="hljs-keyword">return</span> png;<font></font>
  });<font></font>
  Logger.log(png);<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトはGETメソッドのみを実装します。</font><font style="vertical-align: inherit;">Webアプリとして公開されたこのスクリプトに対してGET要求を実行すると、応答には、デコードされたパスワードが文字列の形式ですぐに含まれます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3. Mikrotikと一時的に移動302</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、外部のWebアプリサーバーで実行されるスクリプトがあり、ロックとは無関係にプレーンテキストのパスワードを返します。そして、それはRouterOS Mikrotikのフェッチコマンドでそれを要求するより簡単なものは何もないようです。しかし、それからまた別の驚きが私を待っていました。要求（実際のアドレスが変更された）に応答して、フェッチは「302 Moved Temporarily」を返します。</font></font><br>
<br>
<pre><code class="bash hljs">[admin@MikroTik] /environment&gt; :put ([/tool fetch url=<span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span> http-method=get output=user as-value]-&gt;<span class="hljs-string">"data"</span>)<font></font>
failure: closing connection: &lt;302 Moved Temporarily <span class="hljs-string">"https://script.googleusercontent.com/macros/echo?user_content_key=....."</span>&gt; 173.194.222.138:443 (4)<font></font>
[admin@MikroTik] /environment&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の冒頭で、私はすでにこれについて書きました。</font><font style="vertical-align: inherit;">Webアプリスクリプトの永続的な既知のURLにアクセスすると、Googleは一時的なURLにリダイレクトし、一時的なURLがリクエストへの応答を返します。</font><font style="vertical-align: inherit;">ただし、PHP cURLとは異なり、fetch RouterOSはリダイレクトの処理方法を認識せず、代わりに失敗を返します。</font><font style="vertical-align: inherit;">しかしforum.mikrotik.comはすぐには対応しませんでしたが、回避策がありました。</font><font style="vertical-align: inherit;">wrapping：executeによって別のタスクで非同期実行を呼び出すことにより、コンソールからの標準のフェッチ出力をファイルにリダイレクトできます。</font><font style="vertical-align: inherit;">その後、リダイレクトURLを取得して、新しいアドレスで再フェッチできます。</font><font style="vertical-align: inherit;">これは以下で行われます。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  . Moved Temporarily 302.  fetch  gasfetchout.txt</span>
:<span class="hljs-built_in">local</span> jobid [:execute script={/tool fetch url=<span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span> output=user as-value} file=gasfetchout.txt]<font></font>
<font></font>
<span class="hljs-comment">#    ,    </span>
:<span class="hljs-keyword">while</span> ([:len [/system script job find .id=<span class="hljs-variable">$jobid</span> ]] &gt; 0) <span class="hljs-keyword">do</span>={ delay 1s }<font></font>
<font></font>
<span class="hljs-comment">#  gasfetchout.txt,  URL </span>
:<span class="hljs-built_in">local</span> fetchOut [/file get gasfetchout.txt contents]<font></font>
:<span class="hljs-built_in">local</span> startURL [:find <span class="hljs-variable">$fetchOut</span> <span class="hljs-string">"http"</span> -1]<font></font>
:<span class="hljs-built_in">local</span> endURL [:find <span class="hljs-variable">$fetchOut</span> <span class="hljs-string">"\"&gt; "</span> startURL]<font></font>
:<span class="hljs-built_in">local</span> moveURL [:pick <span class="hljs-variable">$fetchOut</span> <span class="hljs-variable">$startURL</span> <span class="hljs-variable">$endURL</span>]<font></font>
:global VPNBookPass2 ([/tool fetch url=<span class="hljs-variable">$moveURL</span> output=user as-value]-&gt;<span class="hljs-string">"data"</span>)</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、GAS Webアプリを操作するためのMikrotikスクリプトの全文です。</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"># VPNBookScript v4</span>
:<span class="hljs-built_in">local</span> VPNBookpIfName <span class="hljs-string">"pptp-out1"</span>
:<span class="hljs-built_in">local</span> VPNBookServerAddresses {<span class="hljs-string">"PL226.vpnbook.com"</span>;<span class="hljs-string">"de4.vpnbook.com"</span>;<span class="hljs-string">"us1.vpnbook.com"</span>;<span class="hljs-string">"us2.vpnbook.com"</span>;<span class="hljs-string">"fr1.vpnbook.com "</span>;<span class="hljs-string">"fr8.vpnbook.com "</span>;<span class="hljs-string">"ca222.vpnbook.com "</span>;<span class="hljs-string">"ca198.vpnbook.com"</span>}<font></font>
<font></font>
:<span class="hljs-built_in">local</span> VPNBookErr <span class="hljs-literal">false</span><font></font>
:global VPNBookPass<font></font>
:global VPNBookRun<font></font>
<font></font>
:global VPNBookServerIndex<font></font>
:<span class="hljs-keyword">if</span> ([:typeof <span class="hljs-variable">$VPNBookServerIndex</span>] != <span class="hljs-string">"num"</span>) <span class="hljs-keyword">do</span>={:<span class="hljs-built_in">set</span> VPNBookServerIndex 0}<font></font>
<font></font>
:<span class="hljs-keyword">if</span> ([/interface pptp-client get <span class="hljs-variable">$VPNBookpIfName</span> running]) <span class="hljs-keyword">do</span>={<font></font>
  :<span class="hljs-built_in">set</span> VPNBookRun <span class="hljs-literal">true</span>
} <span class="hljs-keyword">else</span> {<font></font>
  :<span class="hljs-keyword">if</span> (!<span class="hljs-variable">$VPNBookRun</span>) <span class="hljs-keyword">do</span>={<font></font>
    :<span class="hljs-built_in">set</span> VPNBookServerIndex (<span class="hljs-variable">$VPNBookServerIndex</span> + 1)<font></font>
    :<span class="hljs-keyword">if</span> (<span class="hljs-variable">$VPNBookServerIndex</span>&gt;=[:len <span class="hljs-variable">$VPNBookServerAddresses</span>]) <span class="hljs-keyword">do</span>={:<span class="hljs-built_in">set</span> VPNBookServerIndex 0}<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    :<span class="hljs-built_in">set</span> VPNBookRun <span class="hljs-literal">false</span><font></font>
  }<font></font>
  :<span class="hljs-keyword">if</span> (![/interface pptp-client get <span class="hljs-variable">$VPNBookpIfName</span> disabled]) <span class="hljs-keyword">do</span>={/interface pptp-client <span class="hljs-built_in">set</span> <span class="hljs-variable">$VPNBookpIfName</span> disabled=yes}
<span class="hljs-comment">#  :do {:set VPNBookPass ([/tool fetch url="http://serv/vpnbookpass_googlescript.php" output=user as-value]-&gt;"data")} on-error={:set VPNBookErr true}</span>
  :<span class="hljs-keyword">do</span> {
<span class="hljs-comment"># First request with Moved Temporarily. Fetch out to gasfetchout.txt</span>
    :<span class="hljs-built_in">local</span> jobid [:execute script={/tool fetch url=<span class="hljs-string">"https://script.google.com/macros/s/A.....g/exec"</span> output=user as-value} file=gasfetchout.txt]
<span class="hljs-comment"># Wait end job</span>
    :<span class="hljs-keyword">while</span> ([:len [/system script job find .id=<span class="hljs-variable">$jobid</span> ]] &gt; 0) <span class="hljs-keyword">do</span>={ delay 1s }
<span class="hljs-comment"># parse new URL for second fetch</span>
    :<span class="hljs-built_in">local</span> fetchOut [/file get gasfetchout.txt contents]<font></font>
    :<span class="hljs-built_in">local</span> startURL [:find <span class="hljs-variable">$fetchOut</span> <span class="hljs-string">"http"</span> -1]<font></font>
    :<span class="hljs-built_in">local</span> endURL [:find <span class="hljs-variable">$fetchOut</span> <span class="hljs-string">"\"&gt; "</span> startURL]<font></font>
    :<span class="hljs-built_in">local</span> moveURL [:pick <span class="hljs-variable">$fetchOut</span> <span class="hljs-variable">$startURL</span> <span class="hljs-variable">$endURL</span>]<font></font>
    :<span class="hljs-built_in">set</span> VPNBookPass ([/tool fetch url=<span class="hljs-variable">$moveURL</span> output=user as-value]-&gt;<span class="hljs-string">"data"</span>)<font></font>
  } on-error={:<span class="hljs-built_in">set</span> VPNBookErr <span class="hljs-literal">true</span>}<font></font>
  :<span class="hljs-keyword">if</span> (!<span class="hljs-variable">$VPNBookErr</span>) <span class="hljs-keyword">do</span>={<font></font>
    :<span class="hljs-keyword">if</span> ([/interface pptp-client get <span class="hljs-variable">$VPNBookpIfName</span> password] != <span class="hljs-variable">$VPNBookPass</span>) <span class="hljs-keyword">do</span>={/interface pptp-client <span class="hljs-built_in">set</span> <span class="hljs-variable">$VPNBookpIfName</span> password=<span class="hljs-variable">$VPNBookPass</span>}<font></font>
    :<span class="hljs-keyword">if</span> ([/interface pptp-client get <span class="hljs-variable">$VPNBookpIfName</span> connect-to] != <span class="hljs-variable">$VPNBookServerAddresses</span>-&gt;<span class="hljs-variable">$VPNBookServerIndex</span>) <span class="hljs-keyword">do</span>={/interface pptp-client <span class="hljs-built_in">set</span> <span class="hljs-variable">$VPNBookpIfName</span> connect-to=(<span class="hljs-variable">$VPNBookServerAddresses</span>-&gt;<span class="hljs-variable">$VPNBookServerIndex</span>)}<font></font>
    :<span class="hljs-built_in">log</span> info <span class="hljs-string">"VPNBook: Attempt to connect to: <span class="hljs-subst">$($VPNBookServerAddresses-&gt;$VPNBookServerIndex)</span>. Password: <span class="hljs-variable">$VPNBookPass</span>"</span>
    /interface pptp-client <span class="hljs-built_in">set</span> <span class="hljs-variable">$VPNBookpIfName</span> disabled=no<font></font>
  }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート4. Telegram GASプロキシ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この部分を、TelegramサービスをMikrotikに統合する次のイテレーションに充てることにしました。ここでGASを使用することは、ボットがサービスと連携するapi.telegram.orgを含むテレグラムサービスをブロックするという現実がなければ、純粋に学術的な関心事になります。このアイデアは、PNG画像のリクエストをプロキシすることについての記事の最初にあるアイデアを繰り返します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、GAS Webアプリは、Mikrtotikからapi.telegram.orgへのリクエストをプロキシするように作成されています。基本として、manzoorwanijkの既成のスクリプト、WPTelegram Google Script </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gist.github.com/manzoorwanijk/ee9ed032caedf2bb0c83dea73bc9a28eを使用しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このスクリプトは、多くのTelegram APIメソッドをプロキシできます（すべてではありません）。 argsでは、リクエストパラメータを含むJSONオブジェクトを渡すことができます。次に例を示します。</font></font><code>{"chat_id":"123","text":"HelloWorld"}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、RouterOS Mikrtotikからテキストメッセージを送信するという私の仕事のために、実装は複雑に思え、私はそれを簡略化しました。</font><font style="vertical-align: inherit;">最終的には、一般的に、さまざまなTelegram APIメソッドをプロキシするいくつかのWebアプリスクリプトを記述できます。</font><font style="vertical-align: inherit;">これがsendMessageメソッドの実装です。</font><font style="vertical-align: inherit;">呼び出されたsendMessageメソッドの名前、さらにはbot_tokenとchat_idをrequestHandler関数の本体に埋め込むことで、さらに簡素化できます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doGet</span>(<span class="hljs-params">e</span>) </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> e !== <span class="hljs-string">'undefined'</span>){
    <span class="hljs-keyword">return</span> ContentService.createTextOutput(requestHandler(e));<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doPost</span>(<span class="hljs-params">e</span>) </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> e !== <span class="hljs-string">'undefined'</span>){
    <span class="hljs-keyword">return</span> ContentService.createTextOutput(requestHandler(e));<font></font>
  }  <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestHandler</span>(<span class="hljs-params">e</span>)</span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e.parameter.bot_token === <span class="hljs-string">'undefined'</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Error! Bot token not provided'</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e.parameter.method === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Error! Method name not provided'</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e.parameter.chat_id === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Error! Chat id not provide'</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e.parameter.text === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Error! Text not provide'</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/* if(typeof e.parameter.args !== 'undefined'){
    var args = e.parameter.args;
    data.payload = JSON.parse(args);
  } */</span><font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (e.parameter.method === <span class="hljs-string">'sendMessage'</span>) {
    <span class="hljs-keyword">var</span> data = {
      <span class="hljs-string">"method"</span>: <span class="hljs-string">"post"</span>,
      <span class="hljs-string">"muteHttpExceptions"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">payload</span> : <span class="hljs-string">'chat_id='</span> + e.parameter.chat_id + <span class="hljs-string">'&amp;text='</span> + e.parameter.text<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> UrlFetchApp.fetch(<span class="hljs-string">'https://api.telegram.org/bot'</span> + e.parameter.bot_token + <span class="hljs-string">'/'</span> + e.parameter.method, data).getContentText();<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトをWebアプリで公開した後、GETブラウザーでリクエストを実行して次のことを確認できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">https://script.google.com/macros/s/A.....A/exec?bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
またはRouterOS POSTリクエストで：</font></font><br>
<br>
<pre><code class="bash hljs">:<span class="hljs-keyword">do</span> {<font></font>
  /tool fetch url=(<span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span>) keep-result=no http-method=post http-data=(<span class="hljs-string">"bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123"</span>) <font></font>
} on-error={<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、fetchへの最初の呼び出しで例外「Moved Temporarily 302」がスローされ、on-errorハンドラーのないスクリプトがこの時点で停止するため、リクエストはdo-on-errorでラップされます。</font><font style="vertical-align: inherit;">転送せずにフェッチを1回呼び出すだけでメッセージを送信できるため、テレグラムAPIから返されるJSONオブジェクトが不要な場合は、フェッチを2回呼び出す必要はありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート5.最終</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のアプリケーションをGoogle Apps Scriptと他のサービスの接点に持ってきました。</font><font style="vertical-align: inherit;">あなたはもっとたくさん考え出すことができます。</font><font style="vertical-align: inherit;">たとえば、VPNBook（キャッシュサービス）の負荷を軽減するために、VPNBookパスワードとキャッシュ要求で応答するTelegramボットをGASで記述します。これはすべて1つのGASスクリプトに含まれます。</font><font style="vertical-align: inherit;">GASでは、Mikrtotikのロギングシステムやバックアップ構成を記述できます。これらは、GoogleドキュメントやGoogleスプレッドシートファイルなどに配置されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja475840/index.html">Badoo Jira APIクライアント：PHPのJiraの魔法</a></li>
<li><a href="../ja475842/index.html">SIP電話のアクションURLとURIを置き換えるか、Webソケットを介して管理しますか？</a></li>
<li><a href="../ja475848/index.html">Yandex.Market検索の仕組みと、サーバーの1つがクラッシュした場合の動作</a></li>
<li><a href="../ja475850/index.html">まだ経験がない場合に、ITでキャリアを構築する方法</a></li>
<li><a href="../ja475854/index.html">JDBCプールと効率的なファイル処理：12月3日のサンクトペテルブルクでのJava mitap</a></li>
<li><a href="../ja475858/index.html">面白い暗号エネルギー：人のための鉱業の熱と鉱業のための人の熱</a></li>
<li><a href="../ja475860/index.html">Apache NiFi。11月28日Deworkacyレクチャーホール</a></li>
<li><a href="../ja475862/index.html">機械学習をビジネスに導入することについての悪いアドバイス</a></li>
<li><a href="../ja475866/index.html">猫、飛行機、オフィス、ストレス</a></li>
<li><a href="../ja475868/index.html">スマートランプ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>