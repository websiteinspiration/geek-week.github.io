<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå®Ô∏è üßë‚Äçü§ù‚Äçüßë üçÇ Como os pipelines Unix s√£o implementados üí™üèª üå¶Ô∏è üë≥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo descreve a implementa√ß√£o de pipelines no kernel Unix. Fiquei um pouco decepcionado com um artigo recente intitulado " Como os pipelines fu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como os pipelines Unix s√£o implementados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/495484/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/sl/9i/gesl9iqjuhatlmgyrdps28zgje0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo descreve a implementa√ß√£o de pipelines no kernel Unix. </font><font style="vertical-align: inherit;">Fiquei um pouco decepcionado com um artigo recente intitulado " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como os pipelines funcionam no Unix?" </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> era </font><font style="vertical-align: inherit;">sobre o dispositivo interno. </font><font style="vertical-align: inherit;">Fiquei interessado e me enterrei nas fontes antigas para encontrar a resposta.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre o que estamos conversando?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pipelines - "provavelmente a inven√ß√£o mais importante no Unix" - √© a caracter√≠stica definidora da filosofia subjacente do Unix de combinar pequenos programas juntos, bem como a linha de comando familiar:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ echo hello | wc -c<font></font>
6<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa funcionalidade depende da chamada do sistema fornecida pelo kernel </font></font><code>pipe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, descrita nas p√°ginas de documenta√ß√£o do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipe (7)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipe (2)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os transportadores fornecem um canal de comunica√ß√£o entre processos unidirecional. </font><font style="vertical-align: inherit;">O pipeline possui uma entrada (final de grava√ß√£o) e uma sa√≠da (final de leitura). </font><font style="vertical-align: inherit;">Os dados gravados na entrada do pipeline podem ser lidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pipeline √© criado usando uma chamada </font></font><code>pipe(2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que retorna dois descritores de arquivo: um refere-se √† entrada do pipeline e o segundo √† sa√≠da.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resultados do rastreamento do comando acima demonstram a cria√ß√£o de um pipeline e o fluxo de dados atrav√©s dele de um processo para outro:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ strace -qf -e execve,pipe,dup2,read,write \<font></font>
    sh -c 'echo hello | wc -c'<font></font>
<font></font>
execve("/bin/sh", ["sh", "-c", "echo hello | wc -c"], ‚Ä¶)<font></font>
pipe([3, 4])                            = 0<font></font>
[pid 2604795] dup2(4, 1)                = 1<font></font>
[pid 2604795] write(1, "hello\n", 6)    = 6<font></font>
[pid 2604796] dup2(3, 0)                = 0<font></font>
[pid 2604796] execve("/usr/bin/wc", ["wc", "-c"], ‚Ä¶)<font></font>
[pid 2604796] read(0, "hello\n", 16384) = 6<font></font>
[pid 2604796] write(1, "6\n", 2)        = 2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processo pai chama </font></font><code>pipe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para obter os descritores de arquivo anexados. </font><font style="vertical-align: inherit;">Um processo filho grava em um descritor e outro processo l√™ os mesmos dados de outro descritor. </font><font style="vertical-align: inherit;">O wrapper usando dup2 ‚Äúrenomeia‚Äù os descritores 3 e 4 para corresponder a stdin e stdout. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem pipelines, o shell precisaria gravar o resultado de um processo em um arquivo e transferi-lo para outro processo, para que ele lesse os dados do arquivo. </font><font style="vertical-align: inherit;">Como resultado, gastar√≠amos mais recursos e espa√ßo em disco. </font><font style="vertical-align: inherit;">No entanto, os pipelines s√£o bons n√£o apenas porque evitam o uso de arquivos tempor√°rios:</font></font><br>
<br>
<blockquote>      ,  <code>read(2)</code>    ,     .       ,  <code>write(2)</code>    ,           .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o requisito POSIX, esta √© uma propriedade importante: a grava√ß√£o no pipeline de at√© </font></font><code>PIPE_BUF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bytes (pelo menos 512) deve ser at√¥mica para que os processos possam interagir entre si atrav√©s do pipeline da mesma maneira que os arquivos regulares (que n√£o fornecem tais garantias). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar um arquivo regular, um processo pode gravar todos os seus dados de sa√≠da e transferi-los para outro processo. </font><font style="vertical-align: inherit;">Ou os processos podem operar no modo de paraleliza√ß√£o r√≠gida, usando um mecanismo de sinaliza√ß√£o externo (como um sem√°foro) para informar um ao outro sobre a conclus√£o da escrita ou leitura. </font><font style="vertical-align: inherit;">Os transportadores nos poupam todo esse problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que voc√™ est√° procurando?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou explicar nos meus dedos para facilitar a ideia de como o transportador pode funcionar. </font><font style="vertical-align: inherit;">Voc√™ precisar√° alocar um buffer e algum estado na mem√≥ria. </font><font style="vertical-align: inherit;">Voc√™ precisar√° de fun√ß√µes para adicionar e remover dados do buffer. </font><font style="vertical-align: inherit;">Ser√£o necess√°rios alguns meios para chamar fun√ß√µes durante opera√ß√µes de leitura e grava√ß√£o em descritores de arquivo. </font><font style="vertical-align: inherit;">E s√£o necess√°rios bloqueios para implementar o comportamento especial descrito acima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, estamos prontos para interrogar √† luz brilhante das l√¢mpadas o c√≥digo fonte do n√∫cleo para confirmar ou refutar nosso modelo mental vago. </font><font style="vertical-align: inherit;">Mas esteja sempre preparado para o inesperado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para onde estamos olhando?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o sei onde est√° localizada minha c√≥pia do famoso livro " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lions book</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " com o c√≥digo-fonte do Unix 6, mas, gra√ßas √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Unix Heritage Society,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> voc√™ pode procurar online </font><font style="vertical-align: inherit;">vers√µes ainda mais antigas do Unix </font><font style="vertical-align: inherit;">no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo-fonte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vagando pelos arquivos do TUHS √© como visitar um museu. </font><font style="vertical-align: inherit;">Podemos dar uma olhada em nossa hist√≥ria comum e respeito os muitos anos de esfor√ßos para recuperar todos esses materiais, pouco a pouco, de cassetes e impress√µes antigas. </font><font style="vertical-align: inherit;">E tenho plena consci√™ncia dos fragmentos que ainda est√£o faltando. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo satisfeito nossa curiosidade em rela√ß√£o √† hist√≥ria antiga dos transportadores, podemos observar os n√∫cleos modernos para compara√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, </font></font><code>pipe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© um n√∫mero de chamada do sistema 42 na tabela </font></font><code>sysent[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Coincid√™ncia?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫cleos tradicionais do Unix (1970-1974)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o encontrei tra√ßos </font></font><code>pipe(2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PDP-7 Unix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (janeiro de 1970), nem na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeira edi√ß√£o do Unix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (novembro de 1971), nem no c√≥digo fonte incompleto da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segunda edi√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (junho de 1972). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A TUHS alega que a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terceira edi√ß√£o do Unix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (fevereiro de 1973) foi a primeira vers√£o com pipelines:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A terceira edi√ß√£o do Unix era a vers√£o mais recente com um kernel escrito em linguagem assembly, mas a primeira vers√£o com pipelines. </font><font style="vertical-align: inherit;">Durante 1973, estavam em andamento trabalhos para melhorar a terceira edi√ß√£o, o n√∫cleo foi reescrito em C e, portanto, a quarta edi√ß√£o do Unix apareceu.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos leitores encontrou uma digitaliza√ß√£o de um documento no qual Doug McIlroy prop√¥s a id√©ia de "conectar programas pelo princ√≠pio de uma mangueira de jardim".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6c/8c2/c8c/c6c8c2c8c5720d79227246af98c9b8d5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No livro de Brian Kernighan, ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unix: Uma Hist√≥ria e um</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Livro de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Mem√≥rias</font></a><font style="vertical-align: inherit;"> ‚Äù, na hist√≥ria da apar√™ncia de transportadores, este documento tamb√©m √© mencionado: ‚Äú... ficou pendurado na parede do meu escrit√≥rio no Bell Labs por 30 anos‚Äù. Aqui est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma entrevista com McIlroy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e outra hist√≥ria do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabalho</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">McIlroy, escrita em 2014</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote>  Unix,        ,  ,  ,   - ,     ,       .  ,   . ,  ,  ,       .                ?           ¬´¬ª     , , -, : ¬´  !¬ª.<br>
<br>
 .        ,    ,       (    ),     .          .              .      API          ,      .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, o c√≥digo fonte do kernel para a terceira edi√ß√£o do Unix est√° perdido. E embora tenhamos o c√≥digo fonte do kernel da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quarta edi√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escrito em C </font><font style="vertical-align: inherit;">, lan√ßado em novembro de 1973, ele foi lan√ßado alguns meses antes do lan√ßamento oficial e n√£o cont√©m implementa√ß√µes de pipeline. √â uma pena que o c√≥digo fonte da lend√°ria fun√ß√£o Unix seja perdido, possivelmente para sempre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos o texto da documenta√ß√£o </font></font><code>pipe(2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos dois releases, para que voc√™ possa come√ßar pesquisando a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terceira edi√ß√£o da</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> documenta√ß√£o </font><font style="vertical-align: inherit;">(para certas palavras, sublinhado ‚Äúmanualmente‚Äù, uma sequ√™ncia de literais ^ H, seguida de sublinhados!). Este proto √© </font></font><code>pipe(2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escrito no assembler e retorna apenas um descritor de arquivo, mas j√° fornece a funcionalidade b√°sica esperada:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A chamada do sistema de </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tubula√ß√£o</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cria um mecanismo de entrada de sa√≠da chamado de pipeline. </font><font style="vertical-align: inherit;">O descritor de arquivo retornado pode ser usado para opera√ß√µes de leitura e grava√ß√£o. </font><font style="vertical-align: inherit;">Quando algo √© gravado no pipeline, at√© 504 bytes de dados s√£o armazenados em buffer, ap√≥s o qual o processo de grava√ß√£o √© pausado. </font><font style="vertical-align: inherit;">Ao ler a partir de um pipeline, dados em buffer s√£o obtidos.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No ano seguinte, o kernel foi reescrito em C, e o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipe (2) na quarta edi√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> encontrou seu visual moderno com o prot√≥tipo " </font></font><code>pipe(fildes)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">":</font></font><br>
<br>
<blockquote>  <i>pipe</i>    ,   .          .  -   ,   ,   r1 (. fildes[1]),    4096  ,     .     ,   r0 (. fildes[0]),  .<br>
<br>
,      ( )   (   <i>fork</i>)         <i>read</i>  <i>write</i>.<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O shell tem sintaxe para definir uma matriz linear de processos conectados por meio de um pipeline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As chamadas de leitura de um pipeline vazio (sem dados em buffer) que possui apenas uma extremidade (todos os descritores de arquivo de grava√ß√£o est√£o fechados) retornam o "final do arquivo". </font><font style="vertical-align: inherit;">A grava√ß√£o de chamadas em uma situa√ß√£o semelhante √© ignorada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementa√ß√£o de pipeline sobrevivente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mais </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">antiga</font></a><font style="vertical-align: inherit;"> remonta </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† quinta edi√ß√£o do Unix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (junho de 1974), mas √© quase id√™ntica √† que apareceu no pr√≥ximo lan√ßamento. </font><font style="vertical-align: inherit;">Apenas coment√°rios foram adicionados, para que a quinta edi√ß√£o possa ser pulada.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sexta Edi√ß√£o do Unix (1975)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a ler o c√≥digo fonte da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sexta edi√ß√£o do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unix </font><font style="vertical-align: inherit;">(maio de 1975). </font><font style="vertical-align: inherit;">Em grande parte gra√ßas ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lions,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descobrir que √© muito mais f√°cil do que o c√≥digo fonte das vers√µes anteriores:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por muitos anos, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lions tem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sido o √∫nico documento b√°sico do Unix dispon√≠vel fora dos muros do Bell Labs. </font><font style="vertical-align: inherit;">Embora a licen√ßa da sexta edi√ß√£o permitisse que os professores usassem seu c√≥digo-fonte, a licen√ßa da s√©tima edi√ß√£o exclu√≠a essa possibilidade; portanto, o livro foi distribu√≠do na forma de c√≥pias ilegais datilografadas.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje voc√™ pode comprar uma c√≥pia reimpressa do livro, na capa da qual os alunos s√£o mostrados na fotocopiadora. E, gra√ßas a Warren Tumi (que lan√ßou o projeto TUHS), voc√™ pode baixar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo PDF com o c√≥digo-fonte da sexta edi√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Quero dar uma id√©ia de quanto esfor√ßo foi necess√°rio para criar o arquivo:</font></font><br>
<br>
<blockquote> 15       ,   <i>Lions</i>,             . TUHS   ,         .   1988-      9 ,        PDP11.   ,   ,      /usr/src/,       1979- ,     .        PWB,   .<br>
<br>
            .     ,    ,    +=   =+. -  ,  -   ,    .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E hoje podemos ler on-line no TUHS o c√≥digo fonte da sexta edi√ß√£o do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo, ao qual Dennis Richie estava presente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, √† primeira vista, a principal caracter√≠stica do c√≥digo C antes do per√≠odo Kernigan e Richie √© sua </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brevidade</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . N√£o muito frequentemente, consigo incorporar trechos de c√≥digo sem edi√ß√£o extensa para caber em uma √°rea de exibi√ß√£o relativamente estreita no meu site. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No in√≠cio de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/sys/ken/pipe.c,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h√° um coment√°rio explicativo (e sim, tamb√©m existe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ usr / sys / dmr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * Max allowable buffering per pipe.<font></font>
 * This is also the max size of the<font></font>
 * file created to implement the pipe.<font></font>
 * If this size is bigger than 4096,<font></font>
 * pipes will be implemented in LARG<font></font>
 * files, which is probably not good.<font></font>
 */<font></font>
#define    PIPSIZ    4096<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tamanho do buffer n√£o mudou desde a quarta edi√ß√£o. Mas aqui, sem nenhuma documenta√ß√£o p√∫blica, vemos que uma vez que os pipelines usavam arquivos como armazenamento de backup! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto aos arquivos LARG, eles correspondem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ao sinalizador de inode LARG</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , usado pelo "algoritmo de alto endere√ßamento" para processar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocos indiretos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para suportar sistemas de arquivos maiores. Como Ken disse que √© melhor n√£o us√°-los, terei prazer em aceitar sua palavra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° a chamada real do sistema </font></font><code>pipe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * The sys-pipe entry.<font></font>
 * Allocate an inode on the root device.<font></font>
 * Allocate 2 file structures.<font></font>
 * Put it all together with flags.<font></font>
 */<font></font>
pipe()<font></font>
{<font></font>
    register *ip, *rf, *wf;<font></font>
    int r;<font></font>
<font></font>
    ip = ialloc(rootdev);<font></font>
    if(ip == NULL)<font></font>
        return;<font></font>
    rf = falloc();<font></font>
    if(rf == NULL) {<font></font>
        iput(ip);<font></font>
        return;<font></font>
    }<font></font>
    r = u.u_ar0[R0];<font></font>
    wf = falloc();<font></font>
    if(wf == NULL) {<font></font>
        rf-&gt;f_count = 0;<font></font>
        u.u_ofile[r] = NULL;<font></font>
        iput(ip);<font></font>
        return;<font></font>
    }<font></font>
    u.u_ar0[R1] = u.u_ar0[R0]; /* wf's fd */<font></font>
    u.u_ar0[R0] = r;           /* rf's fd */<font></font>
    wf-&gt;f_flag = FWRITE|FPIPE;<font></font>
    wf-&gt;f_inode = ip;<font></font>
    rf-&gt;f_flag = FREAD|FPIPE;<font></font>
    rf-&gt;f_inode = ip;<font></font>
    ip-&gt;i_count = 2;<font></font>
    ip-&gt;i_flag = IACC|IUPD;<font></font>
    ip-&gt;i_mode = IALLOC;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O coment√°rio descreve claramente o que est√° acontecendo aqui. Mas entender o c√≥digo n√£o √© f√°cil, em parte por causa da maneira com a ajuda de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um usu√°rio de estrutura u</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e registra </font></font><code>R0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>R1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfere par√¢metros de chamadas do sistema e valores de retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ialloc () para</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> colocar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inode (inode </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">)</font></a><font style="vertical-align: inherit;"> no disco </font><font style="vertical-align: inherit;">e usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falloc ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para colocar dois </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na mem√≥ria </font><font style="vertical-align: inherit;">. Se tudo der certo, definiremos sinalizadores para definir esses arquivos como as duas extremidades do pipeline, apont√°-los para o mesmo inode (cuja contagem de refer√™ncia ser√° 2) e marcar o inode como alterado e usado. Preste aten√ß√£o √†s chamadas para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iput ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em caminhos de erro para diminuir a contagem de refer√™ncia no novo inode. </font></font><br>
<br>
<code>pipe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deve passar </font></font><code>R0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>R1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar os n√∫meros do descritor de arquivo para leitura e grava√ß√£o. </font></font><code>falloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorna um ponteiro para a estrutura do arquivo, mas tamb√©m ‚Äúretorna‚Äù atrav√©s do </font></font><code>u.u_ar0[R0]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descritor de arquivo. Ou seja, o c√≥digo salva em um </font></font><code>r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descritor de arquivo para leitura e atribui um descritor para grava√ß√£o diretamente </font></font><code>u.u_ar0[R0]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ap√≥s a segunda chamada </font></font><code>falloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sinalizador </font></font><code>FPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que definimos ao criar o pipeline controla o comportamento da fun√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdwr () em sys2.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que chama rotinas de E / S de E / S espec√≠ficas:</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * common code for read and write calls:<font></font>
 * check permissions, set base, count, and offset,<font></font>
 * and switch out to readi, writei, or pipe code.<font></font>
 */<font></font>
rdwr(mode)<font></font>
{<font></font>
    register *fp, m;<font></font>
<font></font>
    m = mode;<font></font>
    fp = getf(u.u_ar0[R0]);<font></font>
        /* ‚Ä¶ */<font></font>
<font></font>
    if(fp-&gt;f_flag&amp;FPIPE) {<font></font>
        if(m==FREAD)<font></font>
            readp(fp); else<font></font>
            writep(fp);<font></font>
    }<font></font>
        /* ‚Ä¶ */<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, a fun√ß√£o </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font></font><code>pipe.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√™ os dados do pipeline. </font><font style="vertical-align: inherit;">Mas rastrear a implementa√ß√£o √© melhor come√ßar </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais uma vez, o c√≥digo ficou mais complicado devido √†s especificidades do contrato de transfer√™ncia de argumentos, mas alguns detalhes podem ser omitidos.</font></font><br>
<br>
<pre><code class="plaintext hljs">writep(fp)<font></font>
{<font></font>
    register *rp, *ip, c;<font></font>
<font></font>
    rp = fp;<font></font>
    ip = rp-&gt;f_inode;<font></font>
    c = u.u_count;<font></font>
<font></font>
loop:<font></font>
    /* If all done, return. */<font></font>
<font></font>
    plock(ip);<font></font>
    if(c == 0) {<font></font>
        prele(ip);<font></font>
        u.u_count = 0;<font></font>
        return;<font></font>
    }<font></font>
<font></font>
    /*<font></font>
     * If there are not both read and write sides of the<font></font>
     * pipe active, return error and signal too.<font></font>
     */<font></font>
<font></font>
    if(ip-&gt;i_count &lt; 2) {<font></font>
        prele(ip);<font></font>
        u.u_error = EPIPE;<font></font>
        psignal(u.u_procp, SIGPIPE);<font></font>
        return;<font></font>
    }<font></font>
<font></font>
    /*<font></font>
     * If the pipe is full, wait for reads to deplete<font></font>
     * and truncate it.<font></font>
     */<font></font>
<font></font>
    if(ip-&gt;i_size1 == PIPSIZ) {<font></font>
        ip-&gt;i_mode =| IWRITE;<font></font>
        prele(ip);<font></font>
        sleep(ip+1, PPIPE);<font></font>
        goto loop;<font></font>
    }<font></font>
<font></font>
    /* Write what is possible and loop back. */<font></font>
<font></font>
    u.u_offset[0] = 0;<font></font>
    u.u_offset[1] = ip-&gt;i_size1;<font></font>
    u.u_count = min(c, PIPSIZ-u.u_offset[1]);<font></font>
    c =- u.u_count;<font></font>
    writei(ip);<font></font>
    prele(ip);<font></font>
    if(ip-&gt;i_mode&amp;IREAD) {<font></font>
        ip-&gt;i_mode =&amp; ~IREAD;<font></font>
        wakeup(ip+2);<font></font>
    }<font></font>
    goto loop;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queremos escrever bytes na entrada do pipeline </font></font><code>u.u_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Primeiro, precisamos bloquear o inode (veja abaixo </font></font><code>plock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>prele</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, verifique a contagem de refer√™ncia do inode. </font><font style="vertical-align: inherit;">Enquanto as duas extremidades do pipeline permanecem abertas, o contador deve ser 2. Mantemos um link (fora </font></font><code>rp-&gt;f_inode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), portanto, se o contador for menor que 2, isso significa que o processo de leitura fechou o final do pipeline. </font><font style="vertical-align: inherit;">Em outras palavras, estamos tentando escrever em um pipeline fechado, e isso √© um erro. </font><font style="vertical-align: inherit;">O c√≥digo </font></font><code>EPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o sinal do </font><font style="vertical-align: inherit;">erro </font></font><code>SIGPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apareceram </font><font style="vertical-align: inherit;">pela primeira </font><font style="vertical-align: inherit;">vez na sexta edi√ß√£o do Unix.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, mesmo que o transportador esteja aberto, ele pode estar cheio. Nesse caso, removemos a trava e dormimos na esperan√ßa de que outro processo seja lido no pipeline e liberemos espa√ßo suficiente nele. Depois de acordar, voltamos ao in√≠cio, novamente bloqueamos a fechadura e iniciamos um novo ciclo de grava√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se houver espa√ßo livre suficiente no pipeline, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gravamos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dados usando </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">writei ()</font></a><font style="vertical-align: inherit;"> . O par√¢metro </font></font><code>i_size1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inode (com um pipeline vazio pode ser 0) indica o final dos dados que ele j√° cont√©m. Se houver espa√ßo de grava√ß√£o suficiente, podemos encher o transportador de </font></font><code>i_size1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at√©</font></font><code>PIPESIZ</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, removemos a trava e tentamos despertar qualquer processo que esteja aguardando a oportunidade de ler a partir do pipeline. Voltamos ao in√≠cio para ver se conseguimos escrever quantos bytes precis√°vamos. Se falhar, iniciamos um novo ciclo de grava√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tipicamente </font></font><code>i_mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um inodo </font><font style="vertical-align: inherit;">par√¢metro √© </font><font style="vertical-align: inherit;">utilizado para armazenar permiss√µes </font></font><code>r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mas no caso de pipelines, sinalizamos que algum processo est√° aguardando para escrever ou ler usando bits </font></font><code>IREAD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, </font></font><code>IWRITE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">respectivamente. Um processo define um sinalizador e chama </font></font><code>sleep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e espera-se que outro processo chame no futuro </font></font><code>wakeup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Magia real acontece em </font></font><code>sleep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>wakeup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Eles s√£o implementados no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">slp.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a fonte do famoso coment√°rio: "Voc√™ n√£o deve entender isso". </font><font style="vertical-align: inherit;">Felizmente, n√£o somos obrigados a entender o c√≥digo, basta ver alguns coment√°rios:</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * Give up the processor till a wakeup occurs<font></font>
 * on chan, at which time the process<font></font>
 * enters the scheduling queue at priority pri.<font></font>
 * The most important effect of pri is that when<font></font>
 * pri&lt;0 a signal cannot disturb the sleep;<font></font>
 * if pri&gt;=0 signals will be processed.<font></font>
 * Callers of this routine must be prepared for<font></font>
 * premature return, and check that the reason for<font></font>
 * sleeping has gone away.<font></font>
 */<font></font>
sleep(chan, pri) /* ‚Ä¶ */<font></font>
<font></font>
/*<font></font>
 * Wake up all processes sleeping on chan.<font></font>
 */<font></font>
wakeup(chan) /* ‚Ä¶ */<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um processo que chama </font></font><code>sleep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para um canal espec√≠fico pode ser acordado posteriormente por outro processo que chamar√° </font></font><code>wakeup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o mesmo canal. </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coordenar suas a√ß√µes por meio de chamadas emparelhadas. </font><font style="vertical-align: inherit;">Observe que </font></font><code>pipe.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sempre d√° prioridade </font></font><code>PPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ao ligar </font></font><code>sleep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, para que todos </font></font><code>sleep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">possam interromper o sinal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos tudo para entender a fun√ß√£o </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">readp(fp)<font></font>
int *fp;<font></font>
{<font></font>
    register *rp, *ip;<font></font>
<font></font>
    rp = fp;<font></font>
    ip = rp-&gt;f_inode;<font></font>
<font></font>
loop:<font></font>
    /* Very conservative locking. */<font></font>
<font></font>
    plock(ip);<font></font>
<font></font>
    /*<font></font>
     * If the head (read) has caught up with<font></font>
     * the tail (write), reset both to 0.<font></font>
     */<font></font>
<font></font>
    if(rp-&gt;f_offset[1] == ip-&gt;i_size1) {<font></font>
        if(rp-&gt;f_offset[1] != 0) {<font></font>
            rp-&gt;f_offset[1] = 0;<font></font>
            ip-&gt;i_size1 = 0;<font></font>
            if(ip-&gt;i_mode&amp;IWRITE) {<font></font>
                ip-&gt;i_mode =&amp; ~IWRITE;<font></font>
                wakeup(ip+1);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        /*<font></font>
         * If there are not both reader and<font></font>
         * writer active, return without<font></font>
         * satisfying read.<font></font>
         */<font></font>
<font></font>
        prele(ip);<font></font>
        if(ip-&gt;i_count &lt; 2)<font></font>
            return;<font></font>
        ip-&gt;i_mode =| IREAD;<font></font>
        sleep(ip+2, PPIPE);<font></font>
        goto loop;<font></font>
    }<font></font>
<font></font>
    /* Read and return */<font></font>
<font></font>
    u.u_offset[0] = 0;<font></font>
    u.u_offset[1] = rp-&gt;f_offset[1];<font></font>
    readi(ip);<font></font>
    rp-&gt;f_offset[1] = u.u_offset[1];<font></font>
    prele(ip);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode achar mais f√°cil ler esta fun√ß√£o de baixo para cima. A ramifica√ß√£o ‚Äúler e retornar‚Äù geralmente √© usada quando h√° alguns dados no pipeline. Nesse caso, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readi () para</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ler o m√°ximo de dados dispon√≠veis a partir da </font></font><code>f_offset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leitura </font><font style="vertical-align: inherit;">atual </font><font style="vertical-align: inherit;">e atualizamos o valor do deslocamento correspondente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas leituras subsequentes, o pipeline ficar√° vazio se o deslocamento da leitura tiver atingido o valor do </font></font><code>i_size1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inode. Redefinimos a posi√ß√£o para 0 e tentamos despertar qualquer processo que ele queira gravar no pipeline. Sabemos que quando o transportador estiver cheio, ele </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adormecer√° </font></font><code>ip+1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. E agora que o pipeline est√° vazio, podemos ativ√°-lo para que ele retome seu ciclo de grava√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se n√£o houver nada para ler, ele </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poder√° definir uma bandeira </font></font><code>IREAD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e adormecer.</font></font><code>ip+2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sabemos o que o despertar√° </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quando ele gravar alguns dados no pipeline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os coment√°rios sobre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readi () e writei ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajudar√£o a entender que, em vez de passar par√¢metros " </font></font><code>u</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">", podemos trat√°-los como fun√ß√µes usuais de E / S que pegam um arquivo, posi√ß√£o, buffer na mem√≥ria e contam o n√∫mero de bytes para ler ou escrever .</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * Read the file corresponding to<font></font>
 * the inode pointed at by the argument.<font></font>
 * The actual read arguments are found<font></font>
 * in the variables:<font></font>
 *    u_base        core address for destination<font></font>
 *    u_offset    byte offset in file<font></font>
 *    u_count        number of bytes to read<font></font>
 *    u_segflg    read to kernel/user<font></font>
 */<font></font>
readi(aip)<font></font>
struct inode *aip;<font></font>
/* ‚Ä¶ */<font></font>
<font></font>
/*<font></font>
 * Write the file corresponding to<font></font>
 * the inode pointed at by the argument.<font></font>
 * The actual write arguments are found<font></font>
 * in the variables:<font></font>
 *    u_base        core address for source<font></font>
 *    u_offset    byte offset in file<font></font>
 *    u_count        number of bytes to write<font></font>
 *    u_segflg    write to kernel/user<font></font>
 */<font></font>
writei(aip)<font></font>
struct inode *aip;<font></font>
/* ‚Ä¶ */<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto ao bloqueio de "conservador", em seguida, </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloco de inode para contanto que terminar um trabalho ou n√£o obter o resultado (ou seja a causa </font></font><code>wakeup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><code>plock()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e eles </font></font><code>prele()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funcionam de maneira simples: usando um conjunto diferente de chamadas </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>wakeup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos permite ativar qualquer processo que precise de um bloqueio que acabamos de remover:</font></font><br>
<br>
<pre><code class="plaintext hljs">/*<font></font>
 * Lock a pipe.<font></font>
 * If its already locked, set the WANT bit and sleep.<font></font>
 */<font></font>
plock(ip)<font></font>
int *ip;<font></font>
{<font></font>
    register *rp;<font></font>
<font></font>
    rp = ip;<font></font>
    while(rp-&gt;i_flag&amp;ILOCK) {<font></font>
        rp-&gt;i_flag =| IWANT;<font></font>
        sleep(rp, PPIPE);<font></font>
    }<font></font>
    rp-&gt;i_flag =| ILOCK;<font></font>
}<font></font>
<font></font>
/*<font></font>
 * Unlock a pipe.<font></font>
 * If WANT bit is on, wakeup.<font></font>
 * This routine is also used to unlock inodes in general.<font></font>
 */<font></font>
prele(ip)<font></font>
int *ip;<font></font>
{<font></font>
    register *rp;<font></font>
<font></font>
    rp = ip;<font></font>
    rp-&gt;i_flag =&amp; ~ILOCK;<font></font>
    if(rp-&gt;i_flag&amp;IWANT) {<font></font>
        rp-&gt;i_flag =&amp; ~IWANT;<font></font>
        wakeup(rp);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, eu n√£o conseguia entender por que </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ele n√£o ligou </font></font><code>prele(ip)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes da liga√ß√£o </font></font><code>wakeup(ip+1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A primeira coisa que </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">causa em seu loop √© que ele </font></font><code>plock(ip)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leva a um impasse se </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ainda n√£o removeu seu bloco; portanto, o c√≥digo deve funcionar de alguma maneira corretamente. Se voc√™ observar </font></font><code>wakeup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fica claro que ele s√≥ marca o processo de suspens√£o como pronto para execu√ß√£o, para que no futuro ele </font></font><code>sched()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realmente o inicie. Por isso </font><font style="vertical-align: inherit;">, </font></font><code>readp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">causa </font></font><code>wakeup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, desbloqueia, define </font></font><code>IREAD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e chama </font></font><code>sleep(ip+2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- tudo isso antes de </font></font><code>writep()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retomar o ciclo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso completa a descri√ß√£o dos transportadores na sexta edi√ß√£o. C√≥digo simples, consequ√™ncias de longo alcance. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©tima Edi√ß√£o do Unix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Janeiro de 1979) foi a nova vers√£o principal (quatro anos depois), na qual muitos novos aplicativos e propriedades do kernel apareceram. </font><font style="vertical-align: inherit;">Al√©m disso, houve mudan√ßas significativas em rela√ß√£o ao uso de convers√£o de tipo, union'ov e ponteiros digitados para estruturas. </font><font style="vertical-align: inherit;">No entanto, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o c√≥digo do pipeline</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o mudou muito. </font><font style="vertical-align: inherit;">Podemos pular esta edi√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xv6, um kernel simples em forma de Unix</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><font style="vertical-align: inherit;">sexta edi√ß√£o do Unix influenciou a </font><font style="vertical-align: inherit;">cria√ß√£o do n√∫cleo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xv6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas foi escrita em C moderno para rodar em processadores x86. O c√≥digo √© f√°cil de ler, √© claro. Al√©m disso, ao contr√°rio das fontes Unix com o TUHS, voc√™ pode compil√°-lo, modific√°-lo e execut√°-lo em outra coisa al√©m do PDP 11/70. Portanto, esse n√∫cleo √© amplamente utilizado nas universidades como material educacional em sistemas operacionais. As fontes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√£o no Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo cont√©m uma implementa√ß√£o clara e bem pensada do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipe.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , apoiada por um buffer na mem√≥ria em vez de inode no disco. Aqui, dou apenas a defini√ß√£o de "pipeline estrutural" e fun√ß√£o </font></font><code>pipealloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">#define PIPESIZE 512<font></font>
<font></font>
struct pipe {<font></font>
  struct spinlock lock;<font></font>
  char data[PIPESIZE];<font></font>
  uint nread;     // number of bytes read<font></font>
  uint nwrite;    // number of bytes written<font></font>
  int readopen;   // read fd is still open<font></font>
  int writeopen;  // write fd is still open<font></font>
};<font></font>
<font></font>
int<font></font>
pipealloc(struct file **f0, struct file **f1)<font></font>
{<font></font>
  struct pipe *p;<font></font>
<font></font>
  p = 0;<font></font>
  *f0 = *f1 = 0;<font></font>
  if((*f0 = filealloc()) == 0 || (*f1 = filealloc()) == 0)<font></font>
    goto bad;<font></font>
  if((p = (struct pipe*)kalloc()) == 0)<font></font>
    goto bad;<font></font>
  p-&gt;readopen = 1;<font></font>
  p-&gt;writeopen = 1;<font></font>
  p-&gt;nwrite = 0;<font></font>
  p-&gt;nread = 0;<font></font>
  initlock(&amp;p-&gt;lock, "pipe");<font></font>
  (*f0)-&gt;type = FD_PIPE;<font></font>
  (*f0)-&gt;readable = 1;<font></font>
  (*f0)-&gt;writable = 0;<font></font>
  (*f0)-&gt;pipe = p;<font></font>
  (*f1)-&gt;type = FD_PIPE;<font></font>
  (*f1)-&gt;readable = 0;<font></font>
  (*f1)-&gt;writable = 1;<font></font>
  (*f1)-&gt;pipe = p;<font></font>
  return 0;<font></font>
<font></font>
 bad:<font></font>
  if(p)<font></font>
    kfree((char*)p);<font></font>
  if(*f0)<font></font>
    fileclose(*f0);<font></font>
  if(*f1)<font></font>
    fileclose(*f1);<font></font>
  return -1;<font></font>
}<font></font>
</code></pre><br>
<code>pipealloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define o estado do restante da implementa√ß√£o, que inclui fun√ß√µes </font></font><code>piperead()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>pipewrite()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>pipeclose()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A chamada do sistema real </font></font><code>sys_pipe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© um wrapper implementado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sysfile.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Eu recomendo a leitura de todo o seu c√≥digo. </font><font style="vertical-align: inherit;">A complexidade est√° no n√≠vel de origem da sexta edi√ß√£o, mas √© muito mais f√°cil e mais agrad√°vel de ler.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux 0.01</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode encontrar o c√≥digo fonte do Linux 0.01. </font><font style="vertical-align: inherit;">Ser√° instrutivo estudar a implementa√ß√£o de gasodutos em seu </font></font><code>fs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>pipe.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Aqui, o inode √© usado para representar o pipeline, mas o pr√≥prio pipeline √© escrito no C. moderno. Se voc√™ passou pelo c√≥digo da sexta edi√ß√£o, aqui n√£o ter√° dificuldades. </font><font style="vertical-align: inherit;">√â assim que a fun√ß√£o se parece </font></font><code>write_pipe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">int write_pipe(struct m_inode * inode, char * buf, int count)<font></font>
{<font></font>
    char * b=buf;<font></font>
<font></font>
    wake_up(&amp;inode-&gt;i_wait);<font></font>
    if (inode-&gt;i_count != 2) { /* no readers */<font></font>
        current-&gt;signal |= (1&lt;&lt;(SIGPIPE-1));<font></font>
        return -1;<font></font>
    }<font></font>
    while (count--&gt;0) {<font></font>
        while (PIPE_FULL(*inode)) {<font></font>
            wake_up(&amp;inode-&gt;i_wait);<font></font>
            if (inode-&gt;i_count != 2) {<font></font>
                current-&gt;signal |= (1&lt;&lt;(SIGPIPE-1));<font></font>
                return b-buf;<font></font>
            }<font></font>
            sleep_on(&amp;inode-&gt;i_wait);<font></font>
        }<font></font>
        ((char *)inode-&gt;i_size)[PIPE_HEAD(*inode)] =<font></font>
            get_fs_byte(b++);<font></font>
        INC_PIPE( PIPE_HEAD(*inode) );<font></font>
        wake_up(&amp;inode-&gt;i_wait);<font></font>
    }<font></font>
    wake_up(&amp;inode-&gt;i_wait);<font></font>
    return b-buf;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo sem examinar as defini√ß√µes de estruturas, voc√™ pode descobrir como o contador de refer√™ncia do inode √© usado para verificar se a opera√ß√£o de grava√ß√£o leva a isso </font></font><code>SIGPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Al√©m do trabalho em bytes, esta fun√ß√£o √© facilmente correlacionada com as id√©ias acima. </font><font style="vertical-align: inherit;">At√© a l√≥gica </font></font><code>sleep_on</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>wake_up</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o parece t√£o estranha.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernels modernos do Linux, FreeBSD, NetBSD, OpenBSD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu rapidamente examinei alguns kernels modernos. Nenhum deles j√° possui uma implementa√ß√£o de disco (n√£o surpreendentemente). O Linux tem sua pr√≥pria implementa√ß√£o. Embora os tr√™s kernels modernos do BSD contenham implementa√ß√µes baseadas no c√≥digo que foi escrito por John Dyson, ao longo dos anos eles se tornaram muito diferentes um do outro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ler </font></font><code>fs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>pipe.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(no Linux) ou </font></font><code>sys</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>sys_pipe.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(* BSD), √© necess√°ria uma verdadeira dedica√ß√£o. O desempenho e o suporte a recursos como vetor e E / S ass√≠ncrona s√£o importantes no c√≥digo atual. E os detalhes da aloca√ß√£o de mem√≥ria, bloqueios e configura√ß√£o do kernel - tudo isso √© muito diferente. N√£o √© isso que as universidades precisam para um curso introdut√≥rio sobre sistemas operacionais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De qualquer forma, foi interessante para mim descobrir v√°rios padr√µes antigos (por exemplo, gerar </font></font><code>SIGPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e retornar </font></font><code>EPIPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ao gravar em um pipeline fechado) em todos esses n√∫cleos modernos t√£o diferentes. </font><font style="vertical-align: inherit;">Provavelmente nunca verei um computador PDP-11 ativo, mas ainda h√° muito a aprender com o c√≥digo que foi escrito alguns anos antes do meu nascimento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrito por Divi Kapoor em 2011, o artigo ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Implementa√ß√£o do Linux Kernel de Pipes e FIFOs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù fornece uma vis√£o geral de como (at√© agora) os pipelines funcionam no Linux. </font><font style="vertical-align: inherit;">E o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recente commit do Linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ilustra um modelo de intera√ß√£o em pipeline cujos recursos excedem os de arquivos tempor√°rios; </font><font style="vertical-align: inherit;">e tamb√©m mostra at√© que ponto os pipelines foram de "bloqueio muito conservador" no kernel Unix da sexta edi√ß√£o.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495472/index.html">Mudar para o vegetarianismo n√£o impedir√° que as pessoas sejam infectadas por doen√ßas como COVID-19</a></li>
<li><a href="../pt495474/index.html">DataGrip 2020.1: inicie configura√ß√µes, exporte para Excel, resulte no editor e muito mais</a></li>
<li><a href="../pt495476/index.html">Por que o sucesso da Atari DeepMind AI √© decepcionante</a></li>
<li><a href="../pt495478/index.html">Testador de dados grandes e pequenos: tend√™ncias, teoria, minha hist√≥ria</a></li>
<li><a href="../pt495480/index.html">Criando liga√ß√µes Python para bibliotecas C / C ++ usando SIP. Parte 1</a></li>
<li><a href="../pt495486/index.html">Novas amea√ßas aos dados confidenciais: Resultados da pesquisa global da Acronis</a></li>
<li><a href="../pt495490/index.html">Se√ß√£o de testes e controle de qualidade na confer√™ncia DUMP 2020. O que esperar este ano? Spoiler: um par de analg√©sicos e cerejas</a></li>
<li><a href="../pt495492/index.html">Funcionalidades de vers√£o do jogo Unreal Engine 4 para iOS</a></li>
<li><a href="../pt495494/index.html">Criando um kube-scheduler adicional com um conjunto personalizado de regras de planejamento</a></li>
<li><a href="../pt495500/index.html">Alexey Klyanin: "At√© 2018, eu usava o OSM apenas como substrato no meu blog"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>