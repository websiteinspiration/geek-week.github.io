<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåØ üê£ üñ§ Spring: looking for context üíä üßû üìé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of months ago, a detailed post on loading classes on the JVM was published in my profile . After this talk, my colleagues asked a good questi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spring: looking for context</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489236/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A couple of months ago, a detailed post </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on loading classes on the JVM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was published in my profile </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">After this talk, my colleagues asked a good question: what mechanism </font><font style="vertical-align: inherit;">does </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use </font><font style="vertical-align: inherit;">to parse configurations and how does it load classes from context?</font></font></p><br>
<img src="https://habrastorage.org/webt/vz/-z/00/vz-z001zifi89ni-1_rxixaxr00.jpeg"><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After many hours of spring source debug, my colleague experimentally got to the very simple and understandable truth.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit of theory</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately determine that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ApplicationContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the main interface in a Spring application that provides application configuration information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before proceeding directly to the demonstration, let‚Äôs take a look at the steps involved in creating an </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ApplicationContext</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vo/co/_d/voco_dc-kmx1qqd04ctg9zpssre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this post we will analyze the first step, since we are interested in reading configurations and creating BeanDefinition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BeanDefinition is an interface that describes a bean, its properties, constructor arguments, and other meta-information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regarding the configuration of the beans themselves, Spring has 4 configuration methods:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xml configuration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ClassPathXmlApplicationContext (‚Äùcontext.xml‚Äù);</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Groovy configuration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - GenericGroovyApplicationContext (‚Äùcontext.groovy‚Äù);</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration via annotations indicating the package for scanning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - AnnotationConfigApplicationContext (‚Äùpackage.name‚Äù);</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaConfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - configuration via annotations indicating the class (or class array) marked with @Configuration - AnnotationConfigApplicationContext (JavaConfig.class).</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xml configuration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We take as a basis a simple project:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringContextTest</span></span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String classFilter = <span class="hljs-string">"film."</span>;<font></font>
   <font></font>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>{<font></font>
        <font></font>
         printLoadedClasses(classFilter);<font></font>
         <span class="hljs-comment">/* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
            All - 5 : 0 - Filtered      /*
        doSomething(MainCharacter.num); doSomething(FilmMaker.class);
        printLoadedClasses(classFilter);
        /* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
               class film.MainCharacter
               class film.FilmMaker
            All - 7 : 2 - Filtered     /*</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you should explain a little what methods and what are used:</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printLoadedClasses (String ... filters)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the method prints to the console the name of the loader and loaded JVM classes from the package passed as a parameter. </font><font style="vertical-align: inherit;">Additionally, there is information on the number of all loaded classes;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doSomething (Object o)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a method that does primitive work, but does not allow to exclude the mentioned classes during optimization during compilation.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect to the Spring project (hereinafter, Spring 4 acts as the test subject):</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-number">11</span> <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringContextTest</span></span>{
<span class="hljs-number">12</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String calssFilter = <span class="hljs-string">"film."</span>;
<span class="hljs-number">13</span>    
<span class="hljs-number">14</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>{
<span class="hljs-number">15</span>        
<span class="hljs-number">16</span>        printLoadedClasses(classFilter);
<span class="hljs-number">17</span>       <span class="hljs-comment">/* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
18           All - 5 : 0 - Filtered      /*
19        doSomething(MainCharacter.num); doSomething(FilmMaker.class);
20        printLoadedClasses(classFilter);
21        /* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
22               class film.MainCharacter
23               class film.FilmMaker
24               All - 7 : 2 - Filtered   /*
25        ApplicationContext context = new ClassPathXmlApplicationContext(
26                  configLocation: "applicationContext.xml");
27        printLoadedClasses(classFilter);</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Line 25 is the declaration and initialization of ApplicationContext through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configuration xml file is as follows:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span> = <span class="hljs-string">"http://www.spingframework.org/schema/beans"</span> <span class="hljs-attr">xmlns:xsi</span> = <span class="hljs-string">"http..."</span>
        &lt;<span class="hljs-attr">bean</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"villain"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"film.Villain"</span> <span class="hljs-attr">lazy-init</span>= <span class="hljs-string">"true"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"name"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"Vasily"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When configuring the bean, we specify a really existing class. </font><font style="vertical-align: inherit;">Pay attention to the specified property </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lazy-init = ‚Äùtrue‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : in this case, the bin will be created only after requesting it from the context. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look at how Spring, when raising the context, will clear up the situation with the classes declared in the configuration file:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringContextTest</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String classFilter = <span class="hljs-string">"film."</span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        <font></font>
           printLoadedClasses(classFilter);<font></font>
        <span class="hljs-comment">/* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
           All - 5 : 0 - Filtered      /*
        doSomething(MainCharacther.num); doSomething(FilmMaker.class);
        printLoadedClasses(classFilter);
        /* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
               class film.MainCharacter
               class film.FilmMaker
            All - 7 : 2 - Filtered     /*
        ApplicationContext context = new ClassPathXmlApplicationContext(
                  configLocation: "applicationContext.xml");
        printLoadedClasses(classFilter);
        /* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
               class film.MainCharacter
               class film.FilmMaker
               class film.Villain

            All - 343 : 3- Filtered     /*</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us examine the details of Xml configuration: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Reading the configuration file has been class </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XmlBeanDefinitionReader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which implements the interface </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanDefinitionReader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XmlBeanDefinitionReader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the input receives an InputStream and loads the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DefaultDocumentLoader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs">Document doc = doLoadDocument(inputSource, resource);
<span class="hljs-keyword">return</span> registerBeanDefinitions(doc, resource);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - After that, each element of this document is processed and, if it is a bin, BeanDefinition is created based on the filled data (id, name, class, alias, init-method, destroy-method, etc.):</font></font><br>
<br>
<pre><code class="java hljs">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, <span class="hljs-string">"bean"</span>)) {
    <span class="hljs-keyword">this</span>.processBeanDefinition(ele, delegate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Each BeanDefinition is placed in a Map, which is stored in the DefaultListableBeanFactory class:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);
<span class="hljs-keyword">this</span>.beanDefinitionNames.add(beanName);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the code, Map looks like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/** Map of bean definition objects, keyed by bean name */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;(<span class="hljs-number">64</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in the same configuration file, add another bean declaration with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">film.BadVillain</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span> = <span class="hljs-string">"http://www.spingframework.org/schema/beans"</span> <span class="hljs-attr">xmlns:xsi</span> = <span class="hljs-string">"http..."</span>
        &lt;<span class="hljs-attr">bean</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"goodVillain"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"film.Villain"</span> <span class="hljs-attr">lazy-init</span>= <span class="hljs-string">"true"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"name"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"Good Vasily"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"badVillain"</span> <span class="hljs-attr">class</span> = <span class="hljs-string">"film.BadVillain"</span> <span class="hljs-attr">lazy-init</span>= <span class="hljs-string">"true"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span> = <span class="hljs-string">"name"</span> <span class="hljs-attr">value</span> = <span class="hljs-string">"Bad Vasily"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äôll see</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> what happens if you print a list of created </font><i><font style="vertical-align: inherit;">BeanDefenitionNames</font></i><font style="vertical-align: inherit;"> and loaded classes:</font></font><br>
<br>
<pre><code class="java hljs">ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<font></font>
        configLocation: <span class="hljs-string">"applicationContext.xml"</span>);<font></font>
System.out.println(Arrays.asList(context.getBeanDefinitionNames()));<font></font>
        <font></font>
printLoadedClasses(calssFilter);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">film.BadVillain</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">specified in the configuration file does not exist, Spring works without errors:</font></font><br>
<br>
<pre><code class="java hljs">ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<font></font>
        configLocation: <span class="hljs-string">"applicationContext.xml"</span>);<font></font>
System.out.println(Arrays.asList(context.getBeanDefinitionNames()));<font></font>
<span class="hljs-comment">//  [goodVillain, badVillain]</span><font></font>
printLoadedClasses(calssFilter);<font></font>
<span class="hljs-comment">/* Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2
               class film.MainCharacter
               class film.FilmMaker
               class film.Villain
    All - 343 : 3- Filtered   /*</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanDefenitionNames list</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains 2 elements; that is, those 2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BeanDefinition configured in our file were created. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configurations of both bins are essentially the same. But, while the existing class loaded, no problems arose. From which we can conclude that there was also an attempt to load a nonexistent class, but a failed attempt did not break anything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to get the beans themselves by their names:</font></font><br>
<br>
<pre><code class="java hljs">ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<font></font>
        configLocation: <span class="hljs-string">"applicationContext.xml"</span>);<font></font>
System.out.println(Arrays.asList(context.getBeanDefinitionNames()));<font></font>
<span class="hljs-comment">//  [goodVillain, badVillain]</span>
System.out.println(context.getBean( name: <span class="hljs-string">"goodVillain"</span>));<font></font>
<font></font>
System.out.println(context.getBean( name: <span class="hljs-string">"badVillain"</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get the following: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s9/ot/wk/s9otwkgtbjbiwazcku5ferzpobm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If in the first case a valid bean was received, then in the second case exception arrived. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pay attention to stack trace: deferred loading of classes worked. All class loaders are crawled in an attempt to find the class they are looking for among previously loaded ones. And after the desired class was not found, by calling the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utils.forName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">, an attempt is made to find a nonexistent class by name, which led to a natural error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When raising the context, only one class was loaded, while an attempt to load a nonexistent file did not lead to an error. Why did it happen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's because we registered </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lazy-init: true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and forbade Spring to create an instance of the bean, where the previously received exception is generated. </font><font style="vertical-align: inherit;">If you remove this property from the configuration or change its value </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lazy-init: false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the error described above will also crash, but the application will not be ignored. </font><font style="vertical-align: inherit;">In our case, the context was initialized, but we could not create an instance of the bean, because </font><font style="vertical-align: inherit;">The specified class was not found.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Groovy configuration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When configuring a context using a Groovy file, you need to generate a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericGroovyApplicationContext</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which receives a string with the context configuration as input. </font><font style="vertical-align: inherit;">In this case, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GroovyBeanDefinitionReader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class is engaged in reading the context </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This configuration works essentially the same as Xml, only with Groovy files. </font><font style="vertical-align: inherit;">In addition, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GroovyApplicationContext</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> works well with the Xml file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example of a simple Groovy configuration file:</font></font><br>
<br>
<pre><code class="xml hljs">beans {<font></font>
    goodOperator(film.Operator){bean - &gt;<font></font>
            bean.lazyInit = 'true' &gt;<font></font>
            name = 'Good Oleg' <font></font>
         }<font></font>
    badOperator(film.BadOperator){bean - &gt;<font></font>
            bean.lazyInit = 'true' &gt;<font></font>
            name = 'Bad Oleg' / &gt;<font></font>
        }<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We try to do the same as with Xml: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ng/qp/zd/ngqpzdgjzxhy_naj3tar3vhtbbs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
error crashes immediately: Groovy, like Xml, creates BeanDefenitions, but in this case the postprocessor immediately gives an error.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration via annotations indicating package for scan or JavaConfig</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This configuration is different from the previous two. </font><font style="vertical-align: inherit;">The configuration through annotations uses 2 options: JavaConfig and annotation over classes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same context is used here: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AnnotationConfigApplicationContext (‚Äúpackage‚Äù /JavaConfig.class)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It works depending on what was passed to the constructor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the context of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AnnotationConfigApplicationContext</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there are 2 private fields:</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private final AnnotatedBeanDefinitionReader reader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (works with JavaConfig);</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private final ClassPathBeanDefinitionScanner scanne</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r (scans the packet).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The peculiarity of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AnnotatedBeanDefinitionReader</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is that it works in several stages:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registration of all </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@Configuration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> files for further parsing;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register a special </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanFactoryPostProcesso</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r, namely </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanDefinitionRegistryPostProcessor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which, using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigurationClassParser</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class, </font><font style="vertical-align: inherit;">parses JavaConfig and creates a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanDefinition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider a simple example:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaConfig</span> </span>{<font></font>
    <font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Lazy</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> MainCharacter <span class="hljs-title">mainCharacter</span><span class="hljs-params">()</span></span>{<font></font>
        MainCharacter mainCharacter = <span class="hljs-keyword">new</span> MainCharacter();<font></font>
        mainCharacter.name = <span class="hljs-string">"Patric"</span>;
        <span class="hljs-keyword">return</span> mainCharacter;        <font></font>
   }<font></font>
}</code></pre><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
<font></font>
     ApplicationContext javaConfigContext = <font></font>
               <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(JavaConfig.class);
     <span class="hljs-keyword">for</span> (String str : javaConfigContext.getBeanDefinitionNames()){<font></font>
          System.out.println(str);<font></font>
     }<font></font>
     printLoadedClasses(classFilter);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create a configuration file with the simplest bin possible. </font><font style="vertical-align: inherit;">We look at what will load: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/ja/lc/dhjalckod1_f10h-vb_scdcali4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If in the case of Xml and Groovy, as many BeanDefinition were loaded as it was announced, then in this case, both declared and additional BeanDefinition are loaded in the process of raising the context. </font><font style="vertical-align: inherit;">In the case of implementation through JavaConfig, all classes are loaded immediately, including the class of JavaConfig itself, since it is itself a bean. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another point: in the case of the Xml and Groovy configurations, 343 files were uploaded, here there was a more ‚Äúheavy‚Äù load of 631 additional files. </font><b><font style="vertical-align: inherit;">ClassPathBeanDefinitionScanner</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
work </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">steps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The specified package determines the list of files for scanning. </font><font style="vertical-align: inherit;">All files fall into directories;</font></font></li>
<li>    ,  InputStream      <i>org.springframework.asm.ClassReader.class</i>;</li>
<li> 3-   ,        <i>org.springframework.core.type.filter.AnnotationTypeFilter</i>.   Spring  ,    <i>Component</i>    ,     <i>Component</i>;</li>
<li>   ,     BeanDefinition.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the ‚Äúmagic‚Äù of working with annotations, as is the case with Xml and Groovy, lies precisely in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClassReader.class</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">springframework.asm</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The specificity of this reader is that it can work with bytecode. </font><font style="vertical-align: inherit;">That is, the reader takes an InputStream from the bytecode, scans it and looks for annotations there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the scanner using a simple example. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create your own annotation to search for the corresponding classes:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">import</span> org.springframework.stereotype.Component
<span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-meta">@Target({ElementType.TYPE})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyBeanLoader{
       <span class="hljs-function">String <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ""</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create 2 classes: one with the standard </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Component</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annotation </font><font style="vertical-align: inherit;">, the second with the custom annotation:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span> 
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainCharacter</span> </span>{
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> num = <span class="hljs-number">1</span>;
      <span class="hljs-meta">@Value("Silence")</span>
      <span class="hljs-keyword">public</span> String name;
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainCharacter</span><span class="hljs-params">()</span> </span>{ }</code></pre><br>
<pre><code class="java hljs">MyBeanLoader(<span class="hljs-string">"makerFilm"</span>)
<span class="hljs-meta">@Lazy</span> 
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilmMaker</span> </span>{
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> staticInt = <span class="hljs-number">1</span>;
      <span class="hljs-meta">@Value("Silence")</span>
      <span class="hljs-keyword">public</span> String filmName;
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FilmMaker</span><span class="hljs-params">()</span></span>{}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the generated BeanDefinition for these classes and successfully loaded classes.</font></font><br>
<br>
<pre><code class="java hljs">ApplicationContext annotationConfigContext =
       <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(...basePackages: <span class="hljs-string">"film"</span>);
<span class="hljs-keyword">for</span> (String str : annotationConfigContext.getBeanDefinitionNames()){<font></font>
     System.out.println(str);<font></font>
}<font></font>
printLoadedClasses(classFilter);</code></pre><br>
<img src="https://habrastorage.org/webt/k4/zz/kf/k4zzkfqlqqz5sprw3i49w59zjdu.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the foregoing, the questions posed can be answered as follows:</font></font><br>
<br>
<ol>
<li>   Spring   ?<br>
<br>
     ,     .    BeanDefinition,     :      ,     BeanDefinition‚Äô    .       BeanDefinition,      ..</li>
<li> Spring    ?<br>
<br>
     Java:            , ,      ,    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS I hope that in this post I was able to ‚Äúopen the veil of secrecy‚Äù and show in detail how the formation of the springing context occurs in the first stage. </font><font style="vertical-align: inherit;">It turns out that not everything is so ‚Äúscary". </font><font style="vertical-align: inherit;">But this is only a small part of a large framework, which means there is still a lot of new and interesting ahead.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489226/index.html">Methods for optimizing LINQ queries in C # .NET</a></li>
<li><a href="../en489228/index.html">Speech bot in the bank - the worst UX ever</a></li>
<li><a href="../en489230/index.html">What is web application performance?</a></li>
<li><a href="../en489232/index.html">Back to the Future of Mobile Phones II</a></li>
<li><a href="../en489234/index.html">How to successfully pass any pentest (bad advice)</a></li>
<li><a href="../en489240/index.html">Features of regional conferences. Why should a speaker leave the MKAD?</a></li>
<li><a href="../en489242/index.html">‚ÄúLook, this is something‚Äù: self-replication of artificial DNA</a></li>
<li><a href="../en489244/index.html">Plugin development for Zabbix Agent 2</a></li>
<li><a href="../en489246/index.html">I am 14 and I decided to develop a game</a></li>
<li><a href="../en489252/index.html">The history of Telegram: from an idea to its own cryptocurrency</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>