<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸšï¸ ğŸ™ğŸ¾ ğŸˆ·ï¸ MSè¿œç¨‹æ¡Œé¢ç½‘å…³ï¼ŒHAProxyå’Œå¯†ç çŒœæµ‹ âœğŸ¾ ğŸ‘¨ğŸ¼â€ğŸš€ ğŸ”—</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å—¨ï¼Œæœ‹å‹ä»¬ï¼
 
 æœ‰è®¸å¤šç§æ–¹æ³•å¯ä»¥ä»å®¶é‡Œè¿æ¥åˆ°åŠå…¬å®¤çš„å·¥ä½œåœºæ‰€ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ä½¿ç”¨Microsoftè¿œç¨‹æ¡Œé¢ç½‘å…³ã€‚è¿™æ˜¯åŸºäºHTTPçš„RDPã€‚æˆ‘ä¸æƒ³è°ˆè®ºRDGWæœ¬èº«çš„é…ç½®ï¼Œæˆ‘ä¸æƒ³è®¨è®ºå®ƒçš„ä¼˜ç¼ºç‚¹ï¼Œè®©æˆ‘ä»¬å°†å…¶è§†ä¸ºè¿œç¨‹è®¿é—®å·¥å…·ä¹‹ä¸€ã€‚æˆ‘æƒ³è°ˆè°ˆä¿æŠ¤RDGWæœåŠ¡å™¨å…å—æ¶æ„Internetæ”»å‡»çš„é—®é¢˜ã€‚è®¾ç½®RDGWæœåŠ¡...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MSè¿œç¨‹æ¡Œé¢ç½‘å…³ï¼ŒHAProxyå’Œå¯†ç çŒœæµ‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å—¨ï¼Œæœ‹å‹ä»¬ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰è®¸å¤šç§æ–¹æ³•å¯ä»¥ä»å®¶é‡Œè¿æ¥åˆ°åŠå…¬å®¤çš„å·¥ä½œåœºæ‰€ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ä½¿ç”¨Microsoftè¿œç¨‹æ¡Œé¢ç½‘å…³ã€‚è¿™æ˜¯åŸºäºHTTPçš„RDPã€‚æˆ‘ä¸æƒ³è°ˆè®ºRDGWæœ¬èº«çš„é…ç½®ï¼Œæˆ‘ä¸æƒ³è®¨è®ºå®ƒçš„ä¼˜ç¼ºç‚¹ï¼Œè®©æˆ‘ä»¬å°†å…¶è§†ä¸ºè¿œç¨‹è®¿é—®å·¥å…·ä¹‹ä¸€ã€‚æˆ‘æƒ³è°ˆè°ˆä¿æŠ¤RDGWæœåŠ¡å™¨å…å—æ¶æ„Internetæ”»å‡»çš„é—®é¢˜ã€‚è®¾ç½®RDGWæœåŠ¡å™¨æ—¶ï¼Œæˆ‘ç«‹å³å¼€å§‹å¿™äºä¿æŠ¤ï¼Œå°¤å…¶æ˜¯å¯†ç ä¿æŠ¤ã€‚ä»¤æˆ‘æ„Ÿåˆ°æƒŠè®¶çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰åœ¨äº’è”ç½‘ä¸Šæ‰¾åˆ°æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œçš„æ–‡ç« ã€‚å¥½å§ï¼Œä½ å¿…é¡»è‡ªå·±åšã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RDGWæœ¬èº«æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚æ˜¯çš„ï¼Œå¯ä»¥å°†è£¸éœ²çš„</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é“è·¯</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥å£</font><font style="vertical-align: inherit;">æš´éœ²</font><font style="vertical-align: inherit;">åœ¨ç™½è‰²çš„ç½‘ä¸­ï¼Œå¹¶ä¸”å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯æ­£ç¡®çš„ç®¡ç†å‘˜æˆ–IB'shnikä¼šå› æ­¤è€Œçƒ¦èºä¸å®‰ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å¯ä»¥é¿å…å› ç–å¿½å¤§æ„çš„å‘˜å·¥åœ¨å®¶ç”¨è®¡ç®—æœºä¸Šè®°ä½å…¬å¸å¸æˆ·çš„å¯†ç ï¼Œç„¶åæ›´æ”¹å…¶å¯†ç è€Œå¯¼è‡´å¸æˆ·è¢«å°é”çš„æƒ…å†µã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¿æŠ¤å†…éƒ¨èµ„æºä¸å—å¤–éƒ¨ç¯å¢ƒå½±å“çš„ä¸€ç§å¥½æ–¹æ³•æ˜¯é€šè¿‡å„ç§ä»£ç†ï¼Œå‘å¸ƒç³»ç»Ÿå’Œå…¶ä»–WAFã€‚å›æƒ³ä¸€ä¸‹ï¼ŒRDGWéƒ½æ˜¯ç›¸åŒçš„httpï¼Œç„¶åå®ƒç›´æ¥ä¹æ±‚åœ¨å†…éƒ¨æœåŠ¡å™¨å’ŒInternetä¹‹é—´ä½¿ç”¨ä¸“é—¨çš„è§£å†³æ–¹æ¡ˆã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘çŸ¥é“æœ‰å¾ˆé…·çš„F5ï¼ŒA10ï¼ŒNetscalerï¼ˆADCï¼‰ã€‚ä½œä¸ºè¿™äº›ç³»ç»Ÿä¹‹ä¸€çš„ç®¡ç†å‘˜ï¼Œæˆ‘ä¼šè¯´ï¼Œè¿˜å¯ä»¥åœ¨è¿™äº›ç³»ç»Ÿä¸Šè®¾ç½®é˜²æ­¢ç ´åçš„ä¿æŠ¤æªæ–½ã€‚æ˜¯çš„ï¼Œè¿™äº›ç³»ç»Ÿå°†ä¿æŠ¤æ‚¨å…å—ä¸€è·¯æ³›æ»¥çš„å¨èƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸ªå…¬å¸éƒ½èƒ½ä¹°å¾—èµ·è¿™æ ·çš„è§£å†³æ–¹æ¡ˆï¼ˆå¹¶æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªç³»ç»Ÿçš„ç®¡ç†å‘˜ï¼šï¼‰ï¼Œä½†æ˜¯å®ƒå¯ä»¥ç¡®ä¿å®‰å…¨ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯ä»¥åœ¨å…è´¹æ“ä½œç³»ç»Ÿä¸Šå®‰è£…HAProxyçš„å…è´¹ç‰ˆæœ¬ã€‚æˆ‘åœ¨ç¨³å®šçš„haproxy 1.8.19ç‰ˆæœ¬çš„Debian 10ä¸Šè¿›è¡Œäº†æµ‹è¯•ã€‚æˆ‘è¿˜ä»æµ‹è¯•åº“ä¸­æ£€æŸ¥äº†ç‰ˆæœ¬2.0.xxã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®¾ç½®debianæœ¬èº«ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚ç®€è¦åœ°è¯´ï¼šåœ¨ç™½è‰²ç•Œé¢ä¸Šï¼Œå…³é—­é™¤443ç«¯å£ä»¥å¤–çš„æ‰€æœ‰å†…å®¹ï¼Œåœ¨ç°è‰²ç•Œé¢ä¸Š-æ ¹æ®æ‚¨çš„ç­–ç•¥ï¼Œä¾‹å¦‚ï¼Œå…³é—­é™¤22ä¸ªç«¯å£ä»¥å¤–çš„æ‰€æœ‰å†…å®¹ã€‚ä»…æ‰“å¼€å·¥ä½œæ‰€éœ€çš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œå¯¹äºæµ®åŠ¨IPï¼ŒVRRPï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘å°†haproxyé…ç½®ä¸ºSSLæ¡¥æ¥æ¨¡å¼ï¼ˆä¹Ÿç§°ä¸ºæ¨¡å¼httpï¼‰ï¼Œå¹¶æ‰“å¼€æ—¥å¿—è®°å½•ä»¥æŸ¥çœ‹RDPå†…éƒ¨çš„å†…å®¹ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œçˆ¬åœ¨ä¸­é—´ã€‚å› æ­¤ï¼Œç¼ºå°‘æœ‰å…³é…ç½®RDGatewayçš„â€œæ‰€æœ‰â€æ–‡ç« ä¸­æŒ‡å®šçš„/ RDWebè·¯å¾„ã€‚é‚£é‡Œåªæœ‰/rpc/rpcproxy.dllå’Œ/ remoteDesktopGateway /ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ä½¿ç”¨æ ‡å‡†çš„GET / POSTè¯·æ±‚ï¼Œå®ƒè‡ªå·±çš„è¯·æ±‚ç±»å‹ä¸ºRDG_IN_DATAï¼ŒRDG_OUT_DATAã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸å¤šï¼Œä½†è‡³å°‘æœ‰ä¸€äº›ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘å¯åŠ¨mstscï¼Œè½¬åˆ°æœåŠ¡å™¨ï¼Œåœ¨æ—¥å¿—ä¸­çœ‹åˆ°å››ä¸ª401é”™è¯¯ï¼ˆæœªç»æˆæƒï¼‰ï¼Œç„¶åè¾“å…¥ç™»å½•å/å¯†ç ï¼Œç„¶åçœ‹åˆ°ç­”æ¡ˆ200ã€‚æˆ‘</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…³é—­ï¼Œå†æ¬¡å¯åŠ¨ï¼Œåœ¨æ—¥å¿—ä¸­çœ‹åˆ°ç›¸åŒçš„å››ä¸ª401é”™è¯¯ã€‚æˆ‘è¾“å…¥äº†é”™è¯¯çš„ç”¨æˆ·å/å¯†ç ï¼Œæˆ‘åˆçœ‹åˆ°äº†å››ä¸ªé”™è¯¯401ã€‚æ‚¨éœ€è¦ä»€ä¹ˆã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦æŠ“ä½çš„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºæ— æ³•ç¡®å®šç™»å½•URLï¼Œæ­¤å¤–ï¼Œæˆ‘ä¸çŸ¥é“å¦‚ä½•åœ¨haproxyä¸­æ•è·401é”™è¯¯ï¼Œå› æ­¤æˆ‘å°†æ•è·ï¼ˆå®é™…ä¸Šä¸æ˜¯æ•è·ï¼Œè€Œæ˜¯è®¡ç®—ï¼‰æ‰€æœ‰4xxé”™è¯¯ã€‚ä¹Ÿä¹äºè§£å†³é—®é¢˜ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¿æŠ¤çš„æœ¬è´¨æ˜¯ï¼Œæˆ‘ä»¬å°†è®¡ç®—æ¯å•ä½æ—¶é—´4xxé”™è¯¯ï¼ˆåœ¨åç«¯ï¼‰çš„æ•°é‡ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šçš„é™åˆ¶ï¼Œåˆ™åœ¨æŒ‡å®šçš„æ—¶é—´å†…æ‹’ç»ï¼ˆåœ¨å‰ç«¯ï¼‰è¯¥IPçš„æ‰€æœ‰å…¶ä»–è¿æ¥ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™ä¸æ˜¯å¯†ç ä¿æŠ¤ï¼Œè€Œæ˜¯4xxé”™è¯¯ä¿æŠ¤ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ç»å¸¸è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„URLï¼ˆ404ï¼‰ï¼Œåˆ™ä¿æŠ¤ä¹Ÿå°†èµ·ä½œç”¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœå‡ºç°äº†å¤šä½™çš„äº‹æƒ…ï¼Œæœ€ç®€å•ï¼Œæœ€å¯è¡Œçš„æ–¹æ³•æ˜¯åœ¨åç«¯è®¡æ•°å¹¶å‡»è´¥ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">frontend fe_rdp_tsc
    <span class="hljs-built_in">bind</span> *:443 ssl crt /etc/haproxy/cert/desktop.example.com.pem<font></font>
    mode http<font></font>
    ...<font></font>
    default_backend be_rdp_tsc<font></font>
<font></font>
<font></font>
backend be_rdp_tsc<font></font>
    ...<font></font>
    mode http<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-comment"># , , 1000 ,   15 ,  -    10 </span>
    stick-table <span class="hljs-built_in">type</span> string len 128 size 1k expire 15s store http_err_rate(10s)
    <span class="hljs-comment"># ip</span><font></font>
    http-request track-sc0 src<font></font>
    <span class="hljs-comment">#  http  429,    10   4 </span>
    http-request deny deny_status 429 <span class="hljs-keyword">if</span> { sc_http_err_rate(0) gt 4 }<font></font>
	<font></font>
	...<font></font>
    server rdgw01 192.168.1.33:443 maxconn 1000 weight 10 ssl check cookie rdgw01<font></font>
    server rdgw02 192.168.2.33:443 maxconn 1000 weight 10 ssl check cookie rdgw02<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤æ‚çš„ä¸æ˜¯ä¸€ä¸ªå¥½é€‰æ‹©ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†ä¾é åç«¯ï¼Œå¹¶å°†å…¶é˜»æ­¢åœ¨å‰ç«¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†å¯¹æ”»å‡»è€…é‡‡å–ç²—é²çš„ä¸¾åŠ¨ï¼Œå°†å…¶ä¸tcpçš„è¿æ¥æ–­å¼€ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">frontend fe_rdp_tsc
    <span class="hljs-built_in">bind</span> *:443 ssl crt /etc/haproxy/cert/ertelecom_ru_2020_06_11.pem<font></font>
    mode http<font></font>
    ...<font></font>
    <span class="hljs-comment">#  ip , 1000 ,   15 ,    </span>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store gpc0
    <span class="hljs-comment"># </span><font></font>
    tcp-request connection track-sc0 src<font></font>
    <span class="hljs-comment"># tcp ,    &gt;0</span>
    tcp-request connection reject <span class="hljs-keyword">if</span> { sc0_get_gpc0 gt 0 }<font></font>
	<font></font>
    ...<font></font>
    default_backend be_rdp_tsc<font></font>
<font></font>
<font></font>
backend be_rdp_tsc<font></font>
    ...<font></font>
    mode http<font></font>
    ...<font></font>
	<font></font>
    <span class="hljs-comment">#  ip , 1000 ,   15 ,  -   10 </span>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store http_err_rate(10s)
    <span class="hljs-comment"># ,  -   10   8</span><font></font>
    acl errors_too_fast sc1_http_err_rate gt 8<font></font>
    <span class="hljs-comment">#     ( )</span><font></font>
    acl mark_as_abuser sc0_inc_gpc0(fe_rdp_tsc) gt 0<font></font>
    <span class="hljs-comment">#  </span><font></font>
    acl clear_as_abuser sc0_clr_gpc0(fe_rdp_tsc) ge 0<font></font>
    <span class="hljs-comment"># </span><font></font>
    tcp-request content track-sc1 src<font></font>
    <span class="hljs-comment">#, ,  </span>
    tcp-request content reject <span class="hljs-keyword">if</span> errors_too_fast mark_as_abuser
    <span class="hljs-comment">#,   </span>
    tcp-request content accept <span class="hljs-keyword">if</span> !errors_too_fast clear_as_abuser<font></font>
	<font></font>
    ...<font></font>
    server rdgw01 192.168.1.33:443 maxconn 1000 weight 10 ssl check cookie rdgw01<font></font>
    server rdgw02 192.168.2.33:443 maxconn 1000 weight 10 ssl check cookie rdgw02<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒæ ·çš„äº‹æƒ…ï¼Œä½†ç¤¼è²Œåœ°ï¼Œæˆ‘ä»¬å°†è¿”å›é”™è¯¯http 429ï¼ˆè¯·æ±‚è¿‡å¤šï¼‰</font></font><br>
<br>
<pre><code class="bash hljs">frontend fe_rdp_tsc<font></font>
    ...<font></font>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store gpc0<font></font>
    http-request track-sc0 src<font></font>
    http-request deny deny_status 429 <span class="hljs-keyword">if</span> { sc0_get_gpc0 gt 0 }<font></font>
    ...<font></font>
    default_backend be_rdp_tsc<font></font>
<font></font>
backend be_rdp_tsc<font></font>
    ...<font></font>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store http_err_rate(10s)<font></font>
    acl errors_too_fast sc1_http_err_rate gt 8<font></font>
    acl mark_as_abuser sc0_inc_gpc0(fe_rdp_tsc) gt 0<font></font>
    acl clear_as_abuser sc0_clr_gpc0(fe_rdp_tsc) ge 0<font></font>
    http-request track-sc1 src<font></font>
    http-request allow <span class="hljs-keyword">if</span> !errors_too_fast clear_as_abuser<font></font>
    http-request deny deny_status 429 <span class="hljs-keyword">if</span> errors_too_fast mark_as_abuser<font></font>
    ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ£€æŸ¥ï¼šè¿è¡Œmstscå¹¶å¼€å§‹éšæœºè¾“å…¥å¯†ç ã€‚ç¬¬ä¸‰æ¬¡å°è¯•åï¼Œå®ƒåœ¨10ç§’å†…å°†æˆ‘è¸¢äº†ï¼Œè€Œmstscç»™å‡ºäº†ä¸€ä¸ªé”™è¯¯ã€‚ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯´æ˜æˆ‘ç¦»haproxyå¤§å¸ˆè¿˜å¾ˆè¿œã€‚æˆ‘ä¸æ˜ç™½ä¸ºä»€ä¹ˆï¼Œä¾‹å¦‚ï¼Œ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœ{sc_http_err_rateï¼ˆ0ï¼‰gt 4} </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…è®¸æ‚¨åœ¨æ“ä½œä¹‹å‰å‡ºé”™çº¦10æ¡</font><font style="vertical-align: inherit;">ï¼Œåˆ™</font><font style="vertical-align: inherit;">http-requestæ‹’ç»deny_status 429 </font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘å¯¹æŸœå°çš„ç¼–å·æ„Ÿåˆ°å›°æƒ‘ã€‚ Haproxyå¤§å¸ˆï¼Œå¦‚æœæ‚¨è¡¥å……æˆ‘ï¼Œçº æ­£æˆ‘ï¼Œåšå¾—æ›´å¥½ï¼Œæˆ‘ä¼šå¾ˆé«˜å…´ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¯„è®ºä¸­ï¼Œæ‚¨å¯ä»¥æå‡ºå…¶ä»–æ–¹æ³•æ¥ä¿æŠ¤RDç½‘å…³ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªæœ‰è¶£çš„ç ”ç©¶ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…³äºWindowsè¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯ï¼ˆmstscï¼‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸æ”¯æŒTLS1.2ï¼ˆè‡³å°‘åœ¨Windows 7ä¸­ï¼‰ï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸ç¦»å¼€TLS1ã€‚</font><font style="vertical-align: inherit;">ä¸æ”¯æŒå½“å‰å¯†ç ï¼Œå› æ­¤æˆ‘ä¹Ÿä¸å¾—ä¸ç¦»å¼€äº†æ—§å¯†ç ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºé‚£äº›</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸äº†è§£ä»»ä½•ä¸œè¥¿ï¼Œ</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åªæ˜¯å­¦ä¹ å¹¶ä¸”å·²ç»æƒ³è¦åšå¾—å¾ˆå¥½çš„äººï¼Œæˆ‘å°†ç»™å‡ºæ•´ä¸ªé…ç½®ã€‚</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">haproxy.conf</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">global
        <span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>    local0
        <span class="hljs-built_in">log</span> /dev/<span class="hljs-built_in">log</span>    local1 notice<font></font>
        chroot /var/lib/haproxy<font></font>
        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners<font></font>
        stats timeout 30s<font></font>
        user haproxy<font></font>
        group haproxy<font></font>
        daemon<font></font>
<font></font>
        <span class="hljs-comment"># Default SSL material locations</span><font></font>
        ca-base /etc/ssl/certs<font></font>
        crt-base /etc/ssl/private<font></font>
<font></font>
        <span class="hljs-comment"># See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span>
        <span class="hljs-comment">#ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE</span><font></font>
-RSA-AES256-GCM-SHA384<font></font>
        ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS<font></font>
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256<font></font>
        <span class="hljs-comment">#ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span><font></font>
        ssl-default-bind-options no-sslv3<font></font>
        ssl-server-verify none<font></font>
<font></font>
<font></font>
defaults<font></font>
        <span class="hljs-built_in">log</span>     global<font></font>
        mode    http<font></font>
        option  httplog<font></font>
        option  dontlognull<font></font>
        timeout connect 5000<font></font>
        timeout client  15m<font></font>
        timeout server  15m<font></font>
        errorfile 400 /etc/haproxy/errors/400.http<font></font>
        errorfile 403 /etc/haproxy/errors/403.http<font></font>
        errorfile 408 /etc/haproxy/errors/408.http<font></font>
        errorfile 500 /etc/haproxy/errors/500.http<font></font>
        errorfile 502 /etc/haproxy/errors/502.http<font></font>
        errorfile 503 /etc/haproxy/errors/503.http<font></font>
        errorfile 504 /etc/haproxy/errors/504.http<font></font>
<font></font>
<font></font>
frontend fe_rdp_tsc<font></font>
    <span class="hljs-built_in">bind</span> *:443 ssl crt /etc/haproxy/cert/dektop.example.com.pem<font></font>
    mode http<font></font>
    capture request header Host len 32<font></font>
    <span class="hljs-built_in">log</span> global<font></font>
    option httplog<font></font>
    timeout client 300s<font></font>
    maxconn 1000<font></font>
<font></font>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store gpc0<font></font>
    tcp-request connection track-sc0 src<font></font>
    tcp-request connection reject <span class="hljs-keyword">if</span> { sc0_get_gpc0 gt 0 }<font></font>
<font></font>
    acl rdweb_domain hdr(host) -i beg dektop.example.com<font></font>
    http-request deny deny_status 400 <span class="hljs-keyword">if</span> !rdweb_domain<font></font>
    default_backend be_rdp_tsc<font></font>
<font></font>
<font></font>
backend be_rdp_tsc<font></font>
    balance <span class="hljs-built_in">source</span><font></font>
    mode http<font></font>
    <span class="hljs-built_in">log</span> global<font></font>
<font></font>
    stick-table <span class="hljs-built_in">type</span> ip size 1k expire 15s store http_err_rate(10s)<font></font>
    acl errors_too_fast sc1_http_err_rate gt 8<font></font>
    acl mark_as_abuser sc0_inc_gpc0(fe_rdp_tsc) gt 0<font></font>
    acl clear_as_abuser sc0_clr_gpc0(fe_rdp_tsc) ge 0<font></font>
    tcp-request content track-sc1 src<font></font>
    tcp-request content reject <span class="hljs-keyword">if</span> errors_too_fast mark_as_abuser<font></font>
    tcp-request content accept <span class="hljs-keyword">if</span> !errors_too_fast clear_as_abuser<font></font>
<font></font>
    option forwardfor<font></font>
    http-request add-header X-CLIENT-IP %[src]<font></font>
<font></font>
    option httpchk GET /<font></font>
    cookie RDPWEB insert nocache<font></font>
    default-server inter 3s    rise 2  fall 3<font></font>
    server rdgw01 192.168.1.33:443 maxconn 1000 weight 10 ssl check cookie rdgw01<font></font>
    server rdgw02 192.168.2.33:443 maxconn 1000 weight 10 ssl check cookie rdgw02<font></font>
<font></font>
<font></font>
frontend fe_stats<font></font>
    mode http<font></font>
    <span class="hljs-built_in">bind</span> *:8080<font></font>
    acl ip_allow_admin src 192.168.66.66<font></font>
    stats <span class="hljs-built_in">enable</span><font></font>
    stats uri /stats<font></font>
    stats refresh 30s<font></font>
    <span class="hljs-comment">#stats admin if LOCALHOST</span>
    stats admin <span class="hljs-keyword">if</span> ip_allow_admin
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºä»€ä¹ˆåç«¯éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼Ÿ</font><font style="vertical-align: inherit;">å› ä¸ºè¿™æ˜¯å¯ä»¥å®ç°å®¹é”™çš„æ–¹å¼ã€‚</font><font style="vertical-align: inherit;">Haproxyä¹Ÿå¯ä»¥ä½¿ç”¨æµ®åŠ¨çš„ç™½è‰²ipæ¥åšä¸¤ä¸ªã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®¡ç®—èµ„æºï¼šæ‚¨å¯ä»¥ä»â€œä¸¤ä¸ªæ¼”å‡ºï¼Œä¸¤ä¸ªå†…æ ¸ï¼Œä¸€å°æ¸¸æˆPCâ€å¼€å§‹ã€‚</font><font style="vertical-align: inherit;">æ ¹æ®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipediaçš„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯´æ³•</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ï¼Œ</font></a><font style="vertical-align: inherit;">è¿™è¶³å¤Ÿäº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é“¾æ¥ï¼š</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»HAProxyé…ç½®rdp-gateway </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">å”¯ä¸€æˆ‘å‘ç°</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">å¯†ç ç ´è§£å›°æ‰°çš„</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–‡ç« </font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503412/index.html">Project Loomï¼šJavaè™šæ‹Ÿçº¿ç¨‹å…³é—­</a></li>
<li><a href="../zh-CN503414/index.html">ç ç®±å­ã€‚æ¼”ç»ƒç»³ç´¢ã€‚PWNã€‚ä½¿ç”¨pwntoolsæ ¼å¼åŒ–å­—ç¬¦ä¸²å’ŒROP</a></li>
<li><a href="../zh-CN503420/index.html">ä½¿å®ƒæ›´å¿«åœ°ç¼©ç¼–ï¼ˆPyMorphy2ï¼ŒPyMystem3å’Œä¸€äº›é­”æœ¯ï¼‰</a></li>
<li><a href="../zh-CN503426/index.html">å…‰çº¤ä¸Šçš„44.2 Tb / s-å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</a></li>
<li><a href="../zh-CN503428/index.html">å¦‚ä½•æé«˜å¯¹å¤–äº¤æµçš„ä¹¦é¢è‹±è¯­ï¼šLinguixå•†ä¸šé¡¹ç›®</a></li>
<li><a href="../zh-CN503432/index.html">C ++ä¸­çš„è·¨å¹³å°å¤šçº¿ç¨‹TCP / IPæœåŠ¡å™¨</a></li>
<li><a href="../zh-CN503446/index.html">2020å¹´ï¼Œæ‚¨åœ¨å“ªé‡Œå¯ä»¥ä¸ºé«˜é£é™©ç±»åˆ«çš„éå±…æ°‘å…¬å¸å¼€è®¾é“¶è¡Œå¸æˆ·ï¼Ÿ</a></li>
<li><a href="../zh-CN503448/index.html">å¦‚æœæ‚¨æ˜¯æ•°æ®ç§‘å­¦å®¶ï¼Œå¦‚ä½•ä¸åŠ å…¥æœ‰æŠ±è´Ÿçš„ä¸“å®¶çš„è¡Œåˆ—</a></li>
<li><a href="../zh-CN503450/index.html">å…³äºæˆ‘åœ¨è·å…°å·¥ä½œçš„æ•…äº‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>