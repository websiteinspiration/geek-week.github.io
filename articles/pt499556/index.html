<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàÇÔ∏è üó≥Ô∏è üë®üèª‚Äçüöí Servidor de jogos no MS Orleans - Parte 3: Resumo üë≤üèæ üè∫ üë©üèΩ‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Continuo estudando o MS Orleans e fazendo um jogo online simples com um cliente e servidor de console trabalhando com gr√£os de Orleans. Dest...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Servidor de jogos no MS Orleans - Parte 3: Resumo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499556/"><img src="https://habrastorage.org/webt/2l/n1/j0/2ln1j0xw4cm-reechlymcdrx86q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√° Habr! </font><font style="vertical-align: inherit;">Continuo estudando o MS Orleans e fazendo um jogo online simples com um cliente e servidor de console trabalhando com gr√£os de Orleans. </font><font style="vertical-align: inherit;">Desta vez, vou lhe contar como tudo terminou e que conclus√µes tirei para mim. </font><font style="vertical-align: inherit;">Para detalhes, bem-vindo ao gato.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, sim, se voc√™ estiver interessado em saber como s√£o criados os servidores de jogos para jogos din√¢micos, e n√£o o meu experimento com o MS Orleans, recomendo que voc√™ analise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este reposit√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (UDP) e leia estes artigos:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/303006</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/328118</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/company/pixonic/blog/499642</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/company/pixonic/blog/420019</font></font></a> </li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte√∫do</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de jogos no MS Orleans - Parte 1: O que s√£o atores</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de jogos no MS Orleans - Parte 2: Fazendo um ponto gerenciado</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de jogos no MS Orleans - Parte 3: Resumo</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fonte</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MsOrleansOnlineGame </font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre o jogo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado foi um simples jogo de tiro. </font><font style="vertical-align: inherit;">Verde # s√£o oponentes. </font><font style="vertical-align: inherit;">Amarelo # √© o seu personagem. </font><font style="vertical-align: inherit;">$ Vermelho √© uma bala. </font><font style="vertical-align: inherit;">As filmagens est√£o na dire√ß√£o para onde voc√™ est√° indo. </font><font style="vertical-align: inherit;">A dire√ß√£o do movimento √© controlada pelos bot√µes ou setas WASD. </font><font style="vertical-align: inherit;">A barra de espa√ßo √© usada para a foto. </font><font style="vertical-align: inherit;">N√£o vejo o objetivo de descrever o c√≥digo do cliente em detalhes porque ele precisa ser substitu√≠do por um c√≥digo normal. </font><font style="vertical-align: inherit;">Gr√°fico.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre atores (gr√£os)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumindo: Meu IMHO de Orleans √© um gRPC com ester√≥ides aperfei√ßoado no Azure, escalando e trabalhando com um memorial. Com um cache, por exemplo. Embora sem um estado, como um RPC comum, ele sabe como trabalhar com Stateless Worker Grains. Grain (Ator) em Orleans pode atuar como um ponto de entrada como Controlador no Asp.Net. Mas, diferentemente do Controller, o gr√£o possui uma √∫nica inst√¢ncia que possui seu pr√≥prio identificador. Os gr√£os s√£o bons quando voc√™ precisa trabalhar com algum estado ao mesmo tempo a partir de v√°rios threads ou de v√°rios usu√°rios. Eles fornecem uma opera√ß√£o segura da rosca.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, aqui est√° um ator para uma cesta de mercadorias. </font><font style="vertical-align: inherit;">Na primeira chamada, ele ser√° criado e ficar√° travado na mem√≥ria, desempenhando o papel de cache. </font><font style="vertical-align: inherit;">Ao mesmo tempo, milhares de usu√°rios de milhares de fluxos diferentes podem fazer solicita√ß√µes simultaneamente para adicionar e remover itens. </font><font style="vertical-align: inherit;">Todo o trabalho com sua condi√ß√£o dentro dele ser√° absolutamente seguro. </font><font style="vertical-align: inherit;">Nesse caso, √© claro, seria √∫til fazer um ator comprar com o m√©todo List GetBaskets () para obter uma lista de todas as cestas dispon√≠veis no sistema. </font><font style="vertical-align: inherit;">Ao mesmo tempo, a loja tamb√©m ficar√° travada na mem√≥ria como um cache e todo o trabalho com ele ser√° seguro para threads.</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBasket</span> : <span class="hljs-title">IGrainWithGuidKey</span><font></font>
    {<font></font>
        <span class="hljs-function">Task <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> item</span>)</span>;
        <span class="hljs-function">Task <span class="hljs-title">Remove</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> item</span>)</span>;<font></font>
        Task&lt;List&lt;<span class="hljs-keyword">string</span>&gt;&gt; GetItems();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BasketGrain</span> : <span class="hljs-title">Grain</span>, <span class="hljs-title">IBasket</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;BasketGrain&gt; _logger;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPersistentState&lt;List&lt;<span class="hljs-keyword">string</span>&gt;&gt; _store;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BasketGrain</span>(<span class="hljs-params">
            ILogger&lt;BasketGrain&gt; logger,
            [PersistentState(<span class="hljs-string">"basket"</span>, <span class="hljs-string">"shopState"</span></span>)] IPersistentState&lt;List&lt;<span class="hljs-keyword">string</span>&gt;&gt; store
        )</span><font></font>
        {<font></font>
            _logger = logger;<font></font>
            _store = store;<font></font>
        }<font></font>
<font></font>
         <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnActivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
             <span class="hljs-keyword">var</span> shop = GrainFactory.GetGrain&lt;IShop&gt;();
           <span class="hljs-comment">//          .</span>
            <span class="hljs-keyword">await</span> shop.AddBasketIfNotContains(<span class="hljs-keyword">this</span>.GetPrimaryKey())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnActivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnDeactivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
          <span class="hljs-comment">//       </span>
         <span class="hljs-comment">//    Asp.Net  . </span>
        <span class="hljs-comment">//           - .</span>
        <span class="hljs-comment">//    -      .</span>
        <span class="hljs-comment">//         .</span>
     <span class="hljs-comment">//        </span>
            <span class="hljs-keyword">await</span> _store.WriteStateAsync();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnDeactivateAsync();<font></font>
        }<font></font>
<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> item</span>)</span><font></font>
        {<font></font>
            _store.State.Add(item);<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Remove</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> item</span>)</span><font></font>
        {<font></font>
            _store.State.Remove(item);<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;<span class="hljs-keyword">string</span>&gt;&gt; GetItems()<font></font>
        {<font></font>
           <span class="hljs-comment">//      .</span>
          <span class="hljs-comment">//        </span>
         <span class="hljs-comment">//           </span>
            <span class="hljs-keyword">return</span> Task.FromResult(<span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;(_store.State));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo de uso em algum aplicativo de console:</font></font><br>
<br>
<pre><code class="cs hljs">         <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DoClientWork</span>(<span class="hljs-params">IClusterClient client, Guid baskeId</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> basket = client.GetGrain&lt;IBasket&gt;(baskeId);
           <span class="hljs-comment">//   gRPC -                </span>
            <span class="hljs-keyword">await</span> basket.Add(<span class="hljs-string">"Apple"</span>);<font></font>
        }<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo do jogo</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mapa no qual os jogadores lutam:</font></font><br>
<br>
<pre><code class="cs hljs">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFrame</span> : <span class="hljs-title">IGrainWithIntegerKey</span><font></font>
    {<font></font>
        <span class="hljs-function">Task <span class="hljs-title">Update</span>(<span class="hljs-params">Frame frame</span>)</span>;
        <span class="hljs-function">Task&lt;Frame&gt; <span class="hljs-title">GetState</span>(<span class="hljs-params"></span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FrameGrain</span> : <span class="hljs-title">Grain</span>, <span class="hljs-title">IFrame</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;FrameGrain&gt; _logger;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPersistentState&lt;Frame&gt; _store;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FrameGrain</span>(<span class="hljs-params">
            ILogger&lt;FrameGrain&gt; logger,
            [PersistentState(<span class="hljs-string">"frame"</span>, <span class="hljs-string">"gameState"</span></span>)] IPersistentState&lt;Frame&gt; store
        )</span><font></font>
        {<font></font>
            _logger = logger;<font></font>
            _store = store;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnActivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"ACTIVATED"</span>);
           <span class="hljs-comment">//    1  1      .</span>
            _store.State.GameId = <span class="hljs-keyword">this</span>.GetPrimaryKeyLong();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnActivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnDeactivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"DEACTIVATED"</span>);
            <span class="hljs-keyword">await</span> _store.WriteStateAsync();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnDeactivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params">Frame frame</span>)</span><font></font>
        {<font></font>
            _store.State = frame;<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;Frame&gt; <span class="hljs-title">GetState</span>(<span class="hljs-params"></span>)</span> =&gt; Task.FromResult(_store.State.Clone());<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gr√£o do jogo que armazena o estado geral do jogo atual e o envia ao cliente 20 vezes por segundo via SignalR.</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IGame</span> : <span class="hljs-title">IGrainWithIntegerKey</span><font></font>
    {<font></font>
        <span class="hljs-function">Task <span class="hljs-title">Update</span>(<span class="hljs-params">Player player</span>)</span>;
        <span class="hljs-function">Task <span class="hljs-title">Update</span>(<span class="hljs-params">Bullet bullet</span>)</span>;<font></font>
        Task&lt;List&lt;Player&gt;&gt; GetAlivePlayers();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameGrain</span> : <span class="hljs-title">Grain</span>, <span class="hljs-title">IGame</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">byte</span> WIDTH = <span class="hljs-number">100</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">byte</span> HEIGHT = <span class="hljs-number">50</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;GameGrain&gt; _logger;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPersistentState&lt;Game&gt; _store;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IHubContext&lt;GameHub&gt; _hub;
        <span class="hljs-keyword">private</span> IDisposable _timer;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameGrain</span>(<span class="hljs-params">
            ILogger&lt;GameGrain&gt; logger,
            [PersistentState(<span class="hljs-string">"game"</span>, <span class="hljs-string">"gameState"</span></span>)] IPersistentState&lt;Game&gt; store,
            IHubContext&lt;GameHub&gt; hub
            )</span><font></font>
        {<font></font>
            _logger = logger;<font></font>
            _store = store;<font></font>
            _hub = hub;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnActivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _store.State.Id = <span class="hljs-keyword">this</span>.GetPrimaryKeyLong();<font></font>
            _store.State.Frame = <span class="hljs-keyword">new</span> Frame(WIDTH, HEIGHT) { GameId = _store.State.Id };
            <span class="hljs-keyword">var</span> frame = GrainFactory.GetGrain&lt;IFrame&gt;(_store.State.Id);
            <span class="hljs-keyword">await</span> frame.Update(_store.State.Frame.Clone());<font></font>
            _logger.LogWarning(<span class="hljs-string">"ACTIVATED"</span>);
            <span class="hljs-comment">//      50      .       .</span>
            _timer = RegisterTimer(Draw, <span class="hljs-literal">null</span>, TimeSpan.FromMilliseconds(<span class="hljs-number">100</span>), TimeSpan.FromMilliseconds(<span class="hljs-number">50</span>));
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnActivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnDeactivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogWarning(<span class="hljs-string">"DEACTIVATED"</span>);<font></font>
            _timer?.Dispose();<font></font>
            _timer = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">await</span> _store.WriteStateAsync();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnDeactivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Draw</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> state = _store.State;<font></font>
            state.Bullets.RemoveAll(b =&gt; !b.IsAlive);<font></font>
            state.Players.RemoveAll(p =&gt; !p.IsAlive);<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> _hub.Clients.All.SendAsync(<span class="hljs-string">"gameUpdated"</span>, state.Clone());<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (Exception e)<font></font>
            {<font></font>
                _logger.LogError(e, <span class="hljs-string">"Error on send s"</span>);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params">Player player</span>)</span><font></font>
        {<font></font>
            _store.State.Players.RemoveAll(x =&gt; x.Id == player.Id);<font></font>
            _store.State.Players.Add(player);<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params">Bullet bullet</span>)</span><font></font>
        {<font></font>
            _store.State.Bullets.RemoveAll(x =&gt; x.Id == bullet.Id);<font></font>
            _store.State.Bullets.Add(bullet);<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Player&gt;&gt; GetAlivePlayers() =&gt;<font></font>
            Task.FromResult(_store.State.Players.Where(p =&gt; p.IsAlive).Select(p =&gt; p.Clone()).ToList());<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SignalR √© o hub atrav√©s do qual nos comunicamos com o cliente. </font><font style="vertical-align: inherit;">Ele atua como um proxy entre o cliente WebGl e Orleans. </font><font style="vertical-align: inherit;">At√© agora, o cliente √© console e ele √© totalmente burro. </font><font style="vertical-align: inherit;">Quero criar um cliente da Web no futuro em um navegador no Three.js e, portanto, preciso de uma conex√£o no soquete da Web do SignalR. </font><font style="vertical-align: inherit;">O pr√≥prio cliente Orleans est√° apenas em C #, diferentemente do gRPC, que est√° dispon√≠vel em v√°rios idiomas, portanto, para o cliente Web, entre o servidor Orleans e os clientes, voc√™ precisa instalar um proxy (n√∫cleo do Gateway asp.net).</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameHub</span> : <span class="hljs-title">Hub</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IGrainFactory _client;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameHub</span>(<span class="hljs-params">IGrainFactory client</span>)</span><font></font>
        {<font></font>
            _client = client;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GameInput</span>(<span class="hljs-params">Input input</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> player = _client.GetGrain&lt;IPlayer&gt;(input.PlayerId);
            <span class="hljs-keyword">await</span> player.Handle(input);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jogador de gr√£os. </font><font style="vertical-align: inherit;">Ele se move automaticamente de acordo com o cron√¥metro e responde aos comandos do usu√°rio. </font><font style="vertical-align: inherit;">Se um comando de tiro chegar, ele cria um gr√£o de bala e define a dire√ß√£o do movimento para ele.</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlayerGrain</span> : <span class="hljs-title">Grain</span>, <span class="hljs-title">IPlayer</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;PlayerGrain&gt; _logger;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPersistentState&lt;Player&gt; _store;
        <span class="hljs-keyword">private</span> IDisposable _timer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Queue&lt;Input&gt; _inputs;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PlayerGrain</span>(<span class="hljs-params">
            ILogger&lt;PlayerGrain&gt; logger,
            [PersistentState(<span class="hljs-string">"player"</span>, <span class="hljs-string">"gameState"</span></span>)] IPersistentState&lt;Player&gt; store
        )</span><font></font>
        {<font></font>
            _logger = logger;<font></font>
            _store = store;<font></font>
            _inputs = <span class="hljs-keyword">new</span> Queue&lt;Input&gt;();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnActivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"ACTIVATED"</span>);
            <span class="hljs-comment">// State   POCO     . Entity Player   </span>
            _store.State.Id = <span class="hljs-keyword">this</span>.GetPrimaryKey();<font></font>
            _timer = RegisterTimer(Update, <span class="hljs-literal">null</span>, TimeSpan.FromMilliseconds(<span class="hljs-number">1</span>), TimeSpan.FromMilliseconds(<span class="hljs-number">200</span>));
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnActivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnDeactivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"ACTIVATED"</span>);<font></font>
            _timer?.Dispose();<font></font>
            _timer = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">await</span> _store.WriteStateAsync();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnDeactivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Handle</span>(<span class="hljs-params">Input input</span>)</span><font></font>
        {<font></font>
            _store.State.GameId = input.GameId;<font></font>
            _inputs.Enqueue(input);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!_store.State.IsAlive)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> _store.ClearStateAsync();
               <span class="hljs-comment">//          .</span>
             <span class="hljs-comment">//       .       .</span><font></font>
                DeactivateOnIdle();<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">while</span> (_inputs.Count &gt; <span class="hljs-number">0</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> input = _inputs.Dequeue();
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> direction <span class="hljs-keyword">in</span> input.Directions.Where(d =&gt; d != Direction.None))<font></font>
                {<font></font>
                    _store.State.Direction = direction;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> command <span class="hljs-keyword">in</span> input.Commands.Where(c =&gt; c != Command.None))<font></font>
                {<font></font>
                    <span class="hljs-keyword">if</span> (command == Command.Shoot)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">var</span> bulletId = Guid.NewGuid();
                        <span class="hljs-keyword">var</span> bullet = GrainFactory.GetGrain&lt;IBullet&gt;(bulletId);
                        <span class="hljs-comment">//  Shot()           .</span>
                        bullet.Update(_store.State.Shot()).Ignore(); <span class="hljs-comment">//Ignore()        </span><font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
            _store.State.Move();<font></font>
            <span class="hljs-keyword">if</span> (_store.State.GameId.HasValue)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> frame = GrainFactory.GetGrain&lt;IFrame&gt;(_store.State.GameId.Value);
                <span class="hljs-keyword">var</span> fs = <span class="hljs-keyword">await</span> frame.GetState();
                <span class="hljs-keyword">if</span> (fs.Collide(_store.State))<font></font>
                    _store.State.MoveBack();<font></font>
                GrainFactory.GetGrain&lt;IGame&gt;(_store.State.GameId.Value)<font></font>
                    .Update(_store.State.Clone())<font></font>
                    .Ignore();<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Die</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _store.State.IsAlive = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (_store.State.GameId.HasValue)
                <span class="hljs-keyword">await</span> GrainFactory.GetGrain&lt;IGame&gt;(_store.State.GameId.Value).Update(_store.State.Clone());
            <span class="hljs-keyword">await</span> _store.ClearStateAsync();<font></font>
            DeactivateOnIdle();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Balas de gr√£os. </font><font style="vertical-align: inherit;">Ele se move automaticamente em um cron√¥metro e, se encontrar um jogador, ordena que ele morra. </font><font style="vertical-align: inherit;">Se ela encontrar um obst√°culo no mapa, ela morre.</font></font><br>
<pre><code class="cs hljs">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBullet</span> : <span class="hljs-title">IGrainWithGuidKey</span><font></font>
    {<font></font>
        <span class="hljs-function">Task <span class="hljs-title">Update</span>(<span class="hljs-params">Bullet dto</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BulletGrain</span> : <span class="hljs-title">Grain</span>, <span class="hljs-title">IBullet</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;BulletGrain&gt; _logger;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPersistentState&lt;Bullet&gt; _store;
        <span class="hljs-keyword">private</span> IDisposable _timer;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BulletGrain</span>(<span class="hljs-params">
            ILogger&lt;BulletGrain&gt; logger,
            [PersistentState(<span class="hljs-string">"bullet"</span>, <span class="hljs-string">"gameState"</span></span>)] IPersistentState&lt;Bullet&gt; store
        )</span><font></font>
        {<font></font>
            _logger = logger;<font></font>
            _store = store;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params">Bullet dto</span>)</span><font></font>
        {<font></font>
            _store.State = dto;<font></font>
            _store.State.Id = <span class="hljs-keyword">this</span>.GetPrimaryKey();
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnActivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"ACTIVATED"</span>);<font></font>
            _timer = <span class="hljs-keyword">this</span>.RegisterTimer(Update, <span class="hljs-literal">null</span>, TimeSpan.FromMilliseconds(<span class="hljs-number">1</span>), TimeSpan.FromMilliseconds(<span class="hljs-number">50</span>));
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.OnActivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnDeactivateAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _logger.LogInformation(<span class="hljs-string">"DEACTIVATED"</span>);<font></font>
            _timer?.Dispose();<font></font>
            _timer = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">await</span> _store.WriteStateAsync();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">base</span>.OnDeactivateAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Update</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!_store.State.IsAlive)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> _store.ClearStateAsync();<font></font>
                DeactivateOnIdle();<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
            _store.State.Move();<font></font>
            <span class="hljs-keyword">if</span> (_store.State.GameId.HasValue)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> frame = GrainFactory.GetGrain&lt;IFrame&gt;(_store.State.GameId.Value);
                <span class="hljs-keyword">var</span> fs = <span class="hljs-keyword">await</span> frame.GetState();
                <span class="hljs-keyword">if</span> (fs.Collide(_store.State))<font></font>
                    _store.State.IsAlive = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (_store.State.Point.X &gt; fs.Width || _store.State.Point.Y &gt; fs.Height)<font></font>
                    _store.State.IsAlive = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">var</span> game = GrainFactory.GetGrain&lt;IGame&gt;(_store.State.GameId.Value);
                <span class="hljs-keyword">var</span> players = <span class="hljs-keyword">await</span> game.GetAlivePlayers();
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> player <span class="hljs-keyword">in</span> players)<font></font>
                {<font></font>
                    <span class="hljs-keyword">if</span> (player.Collide(_store.State))<font></font>
                    {<font></font>
                        _store.State.IsAlive = <span class="hljs-literal">false</span>;<font></font>
                        GrainFactory.GetGrain&lt;IPlayer&gt;(player.Id).Die().Ignore();<font></font>
                        <span class="hljs-keyword">break</span>;<font></font>
                    }<font></font>
                }<font></font>
                game.Update(_store.State.Clone()).Ignore();<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../pt499544/index.html">Aprenda redes neurais no Planilhas Google</a></li>
<li><a href="../pt499546/index.html">Desenvolvimento de firmware para uma c√¢mera de v√≠deo anal√≥gica EVR-Y2022F</a></li>
<li><a href="../pt499548/index.html">M√°scara - cuidar dos outros ou uma ilus√£o de seguran√ßa?</a></li>
<li><a href="../pt499550/index.html">Solu√ß√µes de baixo c√≥digo para ecossistemas</a></li>
<li><a href="../pt499560/index.html">Corretor de layout Xswitcher para linux: etapa dois</a></li>
<li><a href="../pt499562/index.html">Artigo mal sucedido sobre acelera√ß√£o da reflex√£o</a></li>
<li><a href="../pt499564/index.html">Coronav√≠rus em v√≠deos e coment√°rios do YouTube</a></li>
<li><a href="../pt499566/index.html">Aumento em tempo real - uma ferramenta importante no treinamento de redes neurais</a></li>
<li><a href="../pt499570/index.html">O que acontece com o transporte no final de abril e quando esperar pela recupera√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>