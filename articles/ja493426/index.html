<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏽 ⁉️ 👂🏽 マイクロサービスでのコードの編成と六角形のアーキテクチャとDDDを使用する私のアプローチ 🛐 ⏹️ 🧙🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！ Monolithでは、すべてのコードが同じスタイルである必要があり、異なるマイクロサービスでは、異なるアプローチ、プログラミング言語、およびフレームワークを使用できます。 1から2のコントローラーと1から10のアクションを持つ単純なマイクロサービスの場合、抽象化のレイヤーをブロ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マイクロサービスでのコードの編成と六角形のアーキテクチャとDDDを使用する私のアプローチ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493426/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/h6/c_/akh6c_safonprea6vtagzdaoy58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは、ハブル！ Monolithでは、すべてのコードが同じスタイルである必要があり、異なるマイクロサービスでは、異なるアプローチ、プログラミング言語、およびフレームワークを使用できます。 1から2のコントローラーと1から10のアクションを持つ単純なマイクロサービスの場合、抽象化のレイヤーをブロックすることに特別な意味はありません。逆に、さまざまな状態とそれらの間の遷移のロジックを持つ複雑なマイクロサービスの場合、最初は遅延しない方がよいでしょう。コードの整理と、DDD、ポート、およびアダプターのアプローチを両方のケースで使用した経験についてお話ししたいと思います。記事の簡単な要約があります：6月-コントローラーにコードを書き込みます。 Middle-抽象化の束を書きます。シニア-コントローラーにコードを書き込むタイミングと、抽象化が必要なタイミングを知っています。</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで、すぐにIに終止符を打つ必要があります-C＃のポートはインターフェースまたは抽象であり、アダプターは具体的な実装（クラス、構造体）です。</font><font style="vertical-align: inherit;">参考までに、この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD、Hexagonal、Onion、Clean、CQRSの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻訳を読むことをお勧めし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます。すべてをまとめた方法</font></a><font style="vertical-align: inherit;">と、この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean Architectureの誤解</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事を参照してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ここでは、アプローチが大きくて複雑なモノリスについて説明されていることを覚えておいてください。</font><font style="vertical-align: inherit;">マイクロサービスでのこのアプローチのバリエーションについてお話ししたいと思います。その80％はシンプルで、中程度または高度な複雑さです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用語</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1）PrimaryAdapters </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム</font><font style="vertical-align: inherit;">用のユーザーフレンドリーなインターフェースを導入します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">SecondaryApdaptersとLogicを呼び出して使用します。</font><font style="vertical-align: inherit;">彼らはアプリケーションに何かをするように伝えます。</font><font style="vertical-align: inherit;">エントリはコードを指します。</font><font style="vertical-align: inherit;">代表的なもの：ItemsService、CreateItemCommandHandler。</font><font style="vertical-align: inherit;">作業にはLogicとSecondaryAdaptersを使用してください。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2）セカンダリアダプター </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのシステムで使用するのに便利</font><font style="vertical-align: inherit;">
な外部の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出された</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム</font><font style="vertical-align: inherit;">へのインターフェースを提供します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">彼はアプリケーションからコマンドを受け取ります。</font><font style="vertical-align: inherit;">代表的な代表者：ItemsRepository、EmailSender、Logger、DistributedCache。</font><font style="vertical-align: inherit;">彼らはEntityFrameworkのようなライブラリとフレームワークを仕事に使用しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3）ロジック</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1）エンティティ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データとロジックを組み合わせる。</font><font style="vertical-align: inherit;">典型的なOOPオブジェクト。</font><font style="vertical-align: inherit;">アイテム、お金、ユーザー。</font><font style="vertical-align: inherit;">ValueObjectsとEventsもあります。</font><font style="vertical-align: inherit;">Entitiesレイヤーの他のオブジェクトのみが使用されます。</font><font style="vertical-align: inherit;">理論的には、このレイヤーは誰にも依存しないアプリケーションのコアです。</font><font style="vertical-align: inherit;">すべては彼に依存しています。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2）DomainServices</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイキッドコンピューティング。</font><font style="vertical-align: inherit;">特定のエンティティに接続できないロジックに必要です。</font><font style="vertical-align: inherit;">エンティティまたは他のDomainServicesを使用します。</font><font style="vertical-align: inherit;">PrimaryAdapters（常にすべて自分で使用する）とSecondaryAdaptersは使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ないで</font><b><font style="vertical-align: inherit;">ください</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">通常、これはあらゆる種類のAmountCalculator、Validatorなどです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードコールフローは、常に一方向のPrimaryAdapters-&gt; LogicおよびSecondaryAdaptersである必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドメイン</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、システムが開発されている対象分野です。</font><font style="vertical-align: inherit;">たとえば、ドメインオンラインストアの場合、これはeコマースです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">境界コンテキスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoundedContextは、システムを特定の責任を持つ分離された部分に分割するために使用されます。システム設計で成功する方法の1つは、その中のすべてのBoundedContextを見つけて強調表示することです。マイクロサービスアーキテクチャでは、1つのマイクロサービス= 1つのBoundedContext。例：オンラインストアには、注文を処理するBoundedContextショッピングカートとBoundedContext、ファイルを処理するBoundedContextがある場合があります。また、1つの大きなBoundedContextは、内部で小さな部分に分割できます。たとえば、商品バスケットのBoundedContextの場合、商品をバスケットに追加するコンテキストと商品をバスケットから削除するコンテキストに分割できます。モノリス1では、大きなBoundedContextは1つのモジュールです。ここで、すべてのエンティティが特定のコンテキスト内に住んでいることを指摘する必要があります。商品のバスケットのコンテキストからのアイテムと商品のショーケースのコンテキストからのアイテム。これらは、さまざまなフィールドとメソッドを持つさまざまなクラスにすることができます。モノリスでは、互いにマップし、EFがデータベースと連携するために渡すいくつかのItemDtoを使用します。これには、すべてに共通のフィールドがあります。つまり、バスケットのコンテキスト（モジュール）のアイテムにプロパティ1があり、ストアフロントのコンテキストのアイテムがある場合商品のプロパティがProperty2の場合、ItemDtoはProperty1とProperty2の両方を持ちます。各コンテキストには、データベースからこのコンテキストの特徴であるアイテムを引き出す独自のリポジトリがあります。マイクロサービスでは、これは簡単です。それぞれに独自のデータベースと独自の本質があります。各ワールドサービスには独自のクラスがあります。単にモノリスでは、互いにマップし、EFがデータベースと連携するために渡すいくつかのItemDtoを使用します。これには、すべてに共通のフィールドがあります。つまり、バスケットのコンテキスト（モジュール）のアイテムにプロパティ1があり、ストアフロントのコンテキストのアイテムがある場合商品のプロパティがProperty2の場合、ItemDtoはProperty1とProperty2の両方を持ちます。各コンテキストには、データベースからこのコンテキストの特徴であるアイテムを引き出す独自のリポジトリがあります。マイクロサービスでは、これは簡単です。それぞれに独自のデータベースと独自の本質があります。各ワールドサービスには独自のクラスがあります。単にモノリスでは、互いにマップし、EFがデータベースと連携するために渡すいくつかのItemDtoを使用します。これには、すべてに共通のフィールドがあります。つまり、バスケットのコンテキスト（モジュール）のアイテムにプロパティ1があり、ストアフロントのコンテキストのアイテムがある場合商品のプロパティがProperty2の場合、ItemDtoはProperty1とProperty2の両方を持ちます。各コンテキストには、データベースからこのコンテキストの特徴であるアイテムを引き出す独自のリポジトリがあります。マイクロサービスでは、これは簡単です。それぞれに独自のデータベースと独自の本質があります。各ワールドサービスには独自のクラスがあります。単に各コンテキストには、データベースからこのコンテキストの特徴であるアイテムを引き出す独自のリポジトリがあります。マイクロサービスでは、これは簡単です。それぞれに独自のデータベースと独自の本質があります。各ワールドサービスには独自のクラスがあります。単に各コンテキストには、データベースからこのコンテキストの特徴であるアイテムを引き出す独自のリポジトリがあります。マイクロサービスでは、これは簡単です。それぞれに独自のデータベースと独自の本質があります。各ワールドサービスには独自のクラスがあります。単に</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なるBoundedContextのItemとItemsRepositoryは、異なるメソッドとプロパティを持つ異なるオブジェクトである可能性があることを</font><b><font style="vertical-align: inherit;">覚え</font></b><font style="vertical-align: inherit;">て</font><b><font style="vertical-align: inherit;">おい</font></b><font style="vertical-align: inherit;">てください。</font><font style="vertical-align: inherit;">多くの場合、マイクロサービスのBoundedContextは、いくつかの一般的なライブラリの導入によって違反されます。</font><font style="vertical-align: inherit;">その結果、クラスには数十のメソッドまたはプロパティがあり、各マイクロサービスは必要なものだけを使用するため、マイクロサービスの共有ライブラリには注意する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイヤー間の依存関係</font></font></h3><br>
<img src="https://habrastorage.org/webt/yo/ay/pi/yoaypimfxmzy8ltvksli9jn1jdq.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード呼び出しフロー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰が、誰が、どの順番で呼び出すか。</font></font><br>
<img src="https://habrastorage.org/webt/qk/qx/zu/qkqxzuslab41wjvgu5xnhf-4dws.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パレートの法則が80％のシンプルなマイクロサービスのオプション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レイヤーPrimaryAdataptersとSecondaryAdaptersを破棄します。ロジックレイヤーのみを残します。より正確には、私たちが使用する典型的なASP.NETアプリケーションでは、PimaryAdaterはControllerで、SecondaryAdapterはEFのDbContextです。コントローラーが突然大きくなりすぎた場合は、パーシャルを使用してコントローラーを細かく分割します。これは、不必要な抽象化を育ててそれらに時間を費やすよりもはるかに優れています。たとえば、Microsoftは、Dockerコンテナー上のEShopアプリケーションの例で、BasketMicrotserviceに対してこれを行いました。はい、コードをコントローラーに書き込みます。スパゲッティコードは記述しないでください。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロジックレイヤーはそのまま残り、ロジックでエンティティを使用し、計算でDomainServicesを使用します。コントローラーでスパゲッティコードの壁を記述するだけではありません。</font><font style="vertical-align: inherit;">典型的なItemServiceとItemRepositoryを破棄するだけです。</font><font style="vertical-align: inherit;">この精神の古き良きItemValidator、ItemMapper、AmountCalculatorなどはまだ残っています。</font><font style="vertical-align: inherit;">まだLogicレイヤーがあるため、ItemsService、ItemsRepositoryで追加の抽象化をラップすることにより、いつでもより複雑なオプションに切り替えることができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
製品の最終価格を割引価格で計算するサービス。</font><font style="vertical-align: inherit;">理論的には、これはドメインオンラインストアの一部であり、BoundedContext製品カタログを表します。</font><font style="vertical-align: inherit;">簡単にするために、私はすべての検証ロジックをスキップしました。</font><font style="vertical-align: inherit;">これは、ある種のItemValidatorおよびDiscountValidatorで記述できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）ロジックフォルダー：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1）エンティティフォルダー：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割引：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お金：</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">Owned</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Money</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">Apply</span>(<span class="hljs-params">Discount discount</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> amount = Amount * (<span class="hljs-number">1</span> - discount.Value);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Money()<font></font>
            {<font></font>
                Amount = amount<font></font>
            };<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
製品：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Item</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Money Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Money();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2）DomainServicesフォルダー</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割引を含む</font><font style="vertical-align: inherit;">製品</font><font style="vertical-align: inherit;">価格計算機：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function">Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span>;<font></font>
    }<font></font>
<font></font>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PriceCalculator</span>:<span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> discounts.Aggregate(item.Price, (m, d) =&gt; m.Apply(d));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）DbContext </font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ItemsDbContext&gt; options</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
        {<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Item&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Discount&gt; Discounts { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）コントローラ</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">ItemsDbContext context, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _context.Discounts.ToListAsync();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20％の複雑なマイクロサービスとほとんどのモノリスのオプション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、レイヤーを互いに最大限に分離する標準的なアプローチを使用します。</font><font style="vertical-align: inherit;">PrimaryAdapter（ItemService）およびSecondaryAdapter（ItemRepository）のクラスを追加します。</font><font style="vertical-align: inherit;">Logicフォルダーでは、すべてが以前の状態のままです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）SecondaryAdaptersフォルダー</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsRepository</span> : <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">return</span> item;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        Task&lt;List&lt;Discount&gt;&gt; Get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscountsRepository</span> : <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscountsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Discount&gt;&gt; Get()<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _context.Discounts.ToListAsync();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）PrimaryAdaptersフォルダー</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemService</span> : <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemsRepository _items;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDiscountsRepository _discounts;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemService</span>(<span class="hljs-params">IItemsRepository items, IDiscountsRepository discounts, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _items = items;<font></font>
            _discounts = discounts;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _items.Get(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _discounts.Get();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラーはIItemServiceを使用します</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemService _service;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">IItemService service</span>)</span><font></font>
        {<font></font>
            _service = service;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.GetPriceWithDiscount(id);
            <span class="hljs-keyword">return</span> result;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの追加コードを追加しました。代わりに、システムの柔軟性が向上しました。これで、コントローラーと一般にASP.NETコアを別のものに変更したり、DbContextとEntityFrameworkコアを別のものに変更したり、Redisにキャッシュを追加したりするのが簡単になりました。最初のアプローチは、シンプルなマイクロサービスと非常にシンプルで小さなモノリスで勝ちます。他のすべての場合の2つ目は、このコードを1年以上追加して終了する必要がある場合です。 2つ目のアプローチでは、エンティティアイテムと割引に加えて、DbContex EFを使用する個別のDTOと、ASP.NETコントローラーが使用する個別のDTO（モデル）を作成すると便利です。 ItemDtoおよびItemModel。これにより、ドメインモデルがさらに独立します。最後に、2 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">番目のTestRuvds</font></a><font style="vertical-align: inherit;">アプローチを使用して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">記述</font></a><font style="vertical-align: inherit;">した簡単なアプリケーションの例</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">実際、彼はここでは冗長であり、これらすべての抽象化は例としてここにあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装例</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualServersModule</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">謝辞</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感謝 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canxes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> そして </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AndrewDemb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 文法エラーが見つかりました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja493412/index.html">ESP32でWi-Fiを使用するゲーム</a></li>
<li><a href="../ja493416/index.html">IDA Proおよびリバースエンジニアリング技術</a></li>
<li><a href="../ja493418/index.html">機械学習が「合成」データを使用する理由</a></li>
<li><a href="../ja493420/index.html">中学生にPythonを紹介する方法</a></li>
<li><a href="../ja493424/index.html">Pythonコード変換を実装します</a></li>
<li><a href="../ja493428/index.html">「私たちは陰謀論を生じさせません。」科学およびIT企業の人々とのMLカンファレンスについて話し合う</a></li>
<li><a href="../ja493430/index.html">Webアプリケーションのネットアーキテクチャ</a></li>
<li><a href="../ja493432/index.html">IT以外の小さな会社でキャリアを始めてみませんか</a></li>
<li><a href="../ja493436/index.html">Bash上のファイル/ディレクトリ名のアクセス権と登録を変更するためのプログラム</a></li>
<li><a href="../ja493438/index.html">検索結果とパフォーマンスの問題を表示する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>