<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∑ ü¶Ñ üí† Context Switching and a Simple Extrusion Scheduler for CortexM üòµ üçÇ üèÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every year coursework for my students is becoming more voluminous. For example, this year one of the tasks was to develop a weather station, because o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Context Switching and a Simple Extrusion Scheduler for CortexM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506414/"><p><img src="https://habrastorage.org/webt/_y/4d/wb/_y4dwblkg3ul7bzga83il5b9aoq.png" alt="image" align="left"><br>
<br clear="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every year coursework for my students is becoming more voluminous. For example, this year one of the tasks was to develop a weather station, because only the lazy do not make a weather station, and students, by definition, are not lazy, so they must do it. It can be quickly thrown into a Cube or assembled on Arduino, but the course task is not that. The main task is to independently, from scratch, deal with the microcontroller modules, think over the software architecture and, in fact, encode everything in C ++, starting from registers and ending with RTOS tasks. Who cares, here is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="Students creativity" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an example of a report on such a course</font></font></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So there was a small problem, namely, the free IAR allows you to make software no larger than 30 kB. </font><font style="vertical-align: inherit;">And this is right next to the size of the coursework in an unoptimized form. </font><font style="vertical-align: inherit;">An analysis of the students' code revealed that about 1/4 of their application is FreeRtos - about 6 kB, although in order to do a preemptive switching and task management, probably ... yes, byte 500 and along with 3 tasks (LED blinkers).</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article will be devoted to how you can implement the Very Simple Scheduler (aka SST) described in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article already in 2006</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and now supported by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quantum Leaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qp framework</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> product </font><font style="vertical-align: inherit;">.</font></font></p><br>
<p>        ,           (  ),     5    .</p><br>
<p>        .     ,     CortexM0        .</p><br>
<p>         ,    .</p><a name="habracut"></a><br>
<h2 id="nebolshoe-otstuplenie"> </h2><br>
<p>        ""                   CortexM4,       ,      ( ,    ,   ,    ).        :</p><br>
<ul>
<li>  CortexM0,     ARM ,  <br>
<ul>
<li>Thumb  </li>
<li>   </li>
<li>      </li>
</ul></li>
<li>    <em>MSP</em></li>
<li>,       </li>
<li>  </li>
<li>    ( ),   </li>
</ul><br>
<p>          CortexM3    CortexM4 (  <em>FPU</em> ),    ,        <em>PendSV</em>  <em>SVC</em> .</p><br>
<p>       ,  ++17,  , ,       "",     mpile-time,     ,  , -,      .</p><br>
<h2 id="vvedenie"></h2><br>
<p>,             2006 </p><br>
<blockquote>      - ,    ,  ,      .     ,   .                ,     .                .</blockquote><p> RTOS        ,    ,  ,     .</p><br>
<p>  ,   ‚Äî       .         "  "            ‚Äî , ,  ‚Äî  .                   (     ,    (  ,      )),   - ,      switch.</p><br>
<p>    SST            .       ,          (Run to completion),   .</p><br>
<p>      ""     ,     ++  - UB.<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">Dubovik_a</a>  :          volatile ,     UB.</p><br>
<p>   ,    ‚Äî  UB,        , ,   UB    ( ,    ++     UB,  ).</p><br>
<p>    ,      ,     CortexM  ,      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>.    ,         CortexM3      -,   .</p><br>
<p>    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  context switch  STM32</a>.<br>
       ,       .</p><br>
<p>       ,    .           .</p><br>
<h2 id="komandy-cortexm-mikrokontrollerov"> CortexM </h2><br>
<p> CortexM    :</p><br>
<ul>
<li><em>ARM</em> ‚Äî   32   .</li>
<li><em>Thumb</em> ‚Äî   16  .</li>
<li><em>Thumb-2</em> ‚Äî 16  <em>Thumb</em>  +  32  ,   <em>ARM</em>  <em>Thumb</em>,      .</li>
</ul><br>
<p>   CortexM0   <em>Thumb</em> ,       <em>Thumb-2</em>,     .<br>
  , CortexM3  <em>Thumb-2</em> .</p><br>
<h2 id="rezhimy-raboty-processora">  </h2><br>
<p>Cortex-M    :   (<em>Thread</em>)    (<em>Handle</em>):</p><br>
<ul>
<li> <em>Handle</em>    (      ,   ‚Äî    )      <em>MSP</em> </li>
<li> <em>Thread</em>           (<em>MSP</em>)    (<em>PSP</em>)<br>
              .</li>
</ul><br>
<p>    ,       ,      .  ,       <em>MSP</em>.</p><br>
<h2 id="cortexm0-registry">CortexM0 </h2><br>
<p>CortexM0  16   :</p><br>
<p><img src="https://habrastorage.org/webt/u4/0y/o7/u40yo7pftqno8gamefmpdldik3i.png" alt="image" align="left"> </p><br>
<ul>
<li>  (r0-r7)<ul>
<li>  (r8-r12)</li>
<li>   <i>SP</i> (r13)    (r8-r12)</li>
</ul>       <i>MSP</i> (  )  <i>PSP</i> (   ).     ,   <i>MSP</i>.<br>
</li>
<li>  <i>LR</i> (r14)</li>
<li>    <i>PC</i>(r15)</li>
</ul><br>
<p><br clear="left">
    :</p><br>
<ul>
<li>  <em>xPSR</em>,         ,          .         ,      <em>xPSR</em>:<br>
<ul>
<li>   <em>APSR</em>      </li>
<li>   <em>EPSR</em>    </li>
<li>   <em>IPSR</em>          <em>Thumb</em>  <em>ARM</em>,   ,  , <br>
CortexM0     <em>Thumb</em> ,        <em>1</em>,    .</li>
</ul></li>
<li> <em>PRIMASK</em>,     ,      </li>
<li> <em>CONTROL</em>,    (  (   ?    ?,  ,  CortexM0   ,       ))    ( <em>MSP</em>    <em>PSP</em>)</li>
</ul><br>
<h2 id="registr-ukazatelya-steka-r13sp">   (r13/SP)</h2><br>
<p>       ,      .   ,       CortexM     .</p><br>
<ul>
<li>              0.</li>
<li>       .</li>
<li>          <em>POP</em>  <em>PUSH</em>.</li>
<li>        <em>LDR</em>, <em>STR</em>, <em>SUB</em>, <em>ADD</em>   </li>
<li>     :<br>
<ul>
<li><em>MSP</em>(Main Stack Pointer) ‚Äî    ,</li>
<li><em>PSP</em> (Program Stack Pointer) ‚Äî     PSP. </li>
</ul></li>
</ul><br>
<p>         ,      ,          .   <em>Handle</em>  <em>SP</em>    <em>MSP</em>,     <em>Thread</em>        <em>MSP</em>,      <em>PSP</em>.     ,     CONTROL .</p><br>
<p>   <em>Handle</em>              .   .</p><br>
<h2 id="registr-svyazi-r14lr">  (r14/LR)</h2><br>
<p>    .   ‚Äî   :</p><br>
<ul>
<li>          ,   <em>BL</em>.</li>
</ul><br>
<p>    :</p><br>
<ul>
<li>        <em>LR</em>  <em>EXC_RETURN</em> ,             .</li>
</ul><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>EXC_RETURN</th>
<th> </th>
</tr>
</thead>
<tbody>
<tr>
<td>0xFFFFFFF1</td>
<td>  <em>Handle</em> ,    <em>MSP</em></td>
</tr>
<tr>
<td>0xFFFFFFF9</td>
<td>  <em>Thread</em> ,    <em>MSP</em></td>
</tr>
<tr>
<td>0xFFFFFFFD</td>
<td>  <em>Thread</em> ,    <em>PSP</em></td>
</tr>
</tbody>
</table></div><br>
<h2 id="isklyuchenie"></h2><br>
<p>  ARM,   ,      .                  ,   ,      .<br>
    .    .   ,          ‚Äî  .</p><br>
<p>       :</p><br>
<ul>
<li> </li>
</ul><br>
<p>,       ,    </p><br>
<ul>
<li>   </li>
</ul><br>
<p>          ,            .   -            .</p><br>
<p>          ,     ,    .</p><br>
<h3 id="kadr-isklyucheniya"> </h3><br>
<p>  (Exception Frame).  ,   ,               .   :</p><br>
<p><img src="https://habrastorage.org/webt/x4/bd/qw/x4bdqweayrzugslzcs00sdxwfsq.png" alt="image" align="left">      R0-R3, R12  LR, PC, xPSR.<br>
<br clear="left">
</p><br>
<h3 id="vhod-v-isklyuchenie">  </h3><br>
<p>     ,         .<br>
    ,        :</p><br>
<ul>
<li>   <em>Thread</em> </li>
<li>   ,      .          ,      .</li>
</ul><br>
<p>          .      "stacking".    ,    .         .</p><br>
<img src="https://habrastorage.org/webt/c4/lm/fw/c4lmfwmivnjyi-jdkrt6jjgrb6c.png"><br>
<p>    ,      8      .</p><br>
<ul>
<li><p>   8   ( ).</p><br>
</li>
<li><p>      ‚Äî       .       PC     .</p><br>
</li>
</ul><br>
<p>,                "stacking" ,     .          ‚Äî <em>EXC_RETURN</em>   <em>LR</em>,           (<em>MSP</em>  <em>PSP</em>)          .</p><br>
<p>         - ,     .       .</p><br>
<p>         ,      "".   " ".</p><br>
<p> -  ,  ,     .</p><br>
<h3 id="vozvrat-iz-isklyucheniya">  </h3><br>
<p>        <em>Handle</em>       ,   <em>PC</em>   <em>EXC_RETURN</em>  :</p><br>
<ul>
<li><em>POP</em>        <em>PC</em>.</li>
<li><em>BX</em> ,   </li>
</ul><br>
<p>   EXC_RETURN  <em>LR</em>    <br>
     ,       .</p><br>
<p><strong>[31:4]</strong> </p><br>
<ul>
<li><em>EXC_RETURN</em>      0xFFFFFFF.       <em>PC</em>,    ,     ,     .    ""     .</li>
</ul><br>
<p><strong>[3:0]</strong> </p><br>
<ul>
<li><em>EXC_RETURN</em>         .</li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When returning from an exception, the reverse operation occurs - unstacking, which is even more strangely translated into Russian. </font><font style="vertical-align: inherit;">At the same time, the microcontroller loads the </font><font style="vertical-align: inherit;">address of the next instruction from the exception frame </font><font style="vertical-align: inherit;">into the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PC</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and actually switches to its execution.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I tried to draw a sticky picture, it didn‚Äôt work out very well, but the 2-hour work was not in vain.</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stuck picture</font></font></b>
                        <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/qo/v7/gp/qov7gpcgyp0mbzf0g2wxnnd4chs.gif"></p></div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I love statics, so here is the usual picture:</font></font><br>
<img src="https://habrastorage.org/webt/pi/6p/4u/pi6p4uukalg2xaqvcfyblxbixnc.png"><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Context switch</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the whole theory has been studied, there are little things left, actually making a context switch and crowding out multitasking.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the same, I will make a small digression:</font></font></b>
                        <div class="spoiler_text"><p> "" RTOS,       ,  <em>PSP</em>    ,  <em>MSP</em>      .   ,         <em>PSP</em>,      <em>MSP</em>   .</p><br>
<p>     ‚Äî          ,       <em>PSP</em>    <em>MSP</em> .</p><br>
<p>  ,     ,  - ,      ,     ,    .</p></div>
                    </div><br>
<p>,       - .        , ,  ,     UART,   ,     -.         ,       ,       .</p><br>
<p>,       , .   <em>Handle</em>,           <em>Thread</em>.   ?</p><br>
<p>                  <em>PendSV</em>,         :        :</p><br>
<pre><code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnTimerExpired</span><span class="hljs-params">()</span>
 </span>{
    <span class="hljs-comment">//    ,    targerThread</span><font></font>
    Tasker::PostEvent&lt;targetThread&gt;(eventsToPost) ; <font></font>
    <span class="hljs-comment">//   PendSV       </span><font></font>
    Tasker::IsrExit() ;  <font></font>
 }<font></font>
 .....<span class="hljs-comment">// Tasker::IsrExit()</span>
 <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IsrExit</span><span class="hljs-params">()</span>
 </span>{
    <span class="hljs-comment">//   PendSV</span><font></font>
    SCB::ICSR::PENDSVSET::PendingState::Set();  <font></font>
 }<font></font>
</code></pre><br>
<p>..  ,     ,    <em>PendSV</em>        ,     .</p><br>
<p>     ,      ,    <em>PendSV</em> ,   :</p><br>
<ul>
<li>    PendSV</li>
<li>  </li>
<li> </li>
</ul><br>
<p>     ,    ,    ...</p><br>
<h2 id="vyzov-planirovschika"> </h2><br>
<p>      <em>PendSV</em>,       <em>Thread</em>,          <em>PendSV</em>.<br>
      ,        .<br>
          ,    , ..   ,   ,        unstacking. </p><br>
<p>    , ,        ,       . ..       (       ,  )        ,      .</p><br>
<p>     <em>PC</em>    ,  <em>LR</em>     ,   xPSR   1   <em>T</em>,    ,       <em>Thumb</em>,        .</p><br>
<p>          <em>PendSV</em>   :</p><br>
<img src="https://habrastorage.org/webt/76/8l/uk/768lukg3cuum33stnat0u5d5qtw.png"><br>
<h2 id="vozvrat-iz-planirovschika">  </h2><br>
<p>     ,    -,     ,   , -,       . ..      - ,       ,      .      ,     unstacking     .</p><br>
<p>  ,    ,   ,      -   .</p><br>
<img src="https://habrastorage.org/webt/op/tb/3h/optb3hwluqrh_smttbretbu1ptc.png"><br>
<ul>
<li>  <em>SomeTask</em></li>
<li>-   <em>HighPriorityTask</em>     <em>PendSV</em></li>
<li>    ,  stacking,       <em>MSP</em> </li>
<li>   <em>PendSV</em></li>
<li>        -  ,     ,         <em>Thumb</em></li>
<li>  ,   unstacking,       <em>PC</em>, <em>LR</em>  <em>xPSR</em>,        .</li>
<li>       <em>Thread</em> ‚Äî    ,    ‚Äî   ,    <em>Thread</em>,       .</li>
<li>  </li>
<li>    </li>
<li>    ,   <em>SVC</em> </li>
<li>       <em>SVC</em></li>
<li>         ,    <em>PendSV</em>       </li>
<li>  <em>SVC</em>,  unstacking      </li>
</ul><br>
<p>    ‚Ä¶     <del>lisp</del> ( ,     ,    ,    ,      lisp) . </p><br>
<pre><code class="lisp hljs">  RSEG CODE:CODE:NOROOT(<span class="hljs-number">2</span>)<font></font>
<font></font>
  PUBLIC  HandlePendSv<font></font>
  PUBLIC  HandleSvc<font></font>
<font></font>
  EXTERN  Schedule<font></font>
<font></font>
<span class="hljs-comment">;    Handle ,     </span>
<span class="hljs-comment">; Thread .        </span>
<span class="hljs-comment">; Thread          Schedule </span><font></font>
HandlePendSv: <font></font>
  <span class="hljs-comment">;     PendSv,   PendSvClr (#27)  ICSR </span>
  <span class="hljs-comment">;  ICSR(Interrupt Control and State Register)  0xE000ED04</span><font></font>
  LDR     r3,=0xE000ED04<font></font>
  LDR     r1,=1&lt;&lt;27<font></font>
  <span class="hljs-comment">;   </span><font></font>
  CPSID   i<font></font>
  <span class="hljs-comment">;    PendSvClr </span><font></font>
  STR     r1,[r3]<font></font>
  <span class="hljs-comment">;      XPSR   T - bit(1 &lt;&lt; 24), </span>
  <span class="hljs-comment">;  ,    Thumb  ,       , </span>
  <span class="hljs-comment">;    .</span><font></font>
  LDR     r3,=1&lt;&lt;24           <font></font>
  <span class="hljs-comment">;     ,     Schedule,   PC </span>
  <span class="hljs-comment">;     Schedule     </span>
  LDR     r2,=Schedule - <span class="hljs-number">1</span>
  <span class="hljs-comment">;    Schedule      ScheduleReturn</span>
  <span class="hljs-comment">;     LR</span><font></font>
  LDR     r1,=ScheduleReturn<font></font>
  <span class="hljs-comment">;          </span><font></font>
  SUB     sp,sp,#8*4            <font></font>
  ADD     r0,sp,#5*4 <span class="hljs-comment">;       XPSR, PC, LR</span>
  <span class="hljs-comment">;      XPSR, PC, LR ( r3- xPSR, R2 - PC, r1-LR)</span><font></font>
  STM     r0!,{r1-r3}           <font></font>
  <span class="hljs-comment">; r0 = 0xFFFFFFF9 - Thread    MSP </span><font></font>
  LDR     r0,=0xFFFFFFF9              <font></font>
  <span class="hljs-comment">;      0xFFFFFFF9      Schedule</span><font></font>
  BX      r0<font></font>
<font></font>
<span class="hljs-comment">;     Schedule,   </span>
<span class="hljs-comment">;    SVC,     </span><font></font>
ScheduleReturn:<font></font>
  CPSIE   i<font></font>
  <span class="hljs-comment">; SVC     CPSIE,   Cortext M0   .</span>
  <span class="hljs-comment">;       SVC    </span>
  <span class="hljs-comment">;   ,    -     </span>
  <span class="hljs-comment">;   ,      SVC,    Quantum Leaps   </span>
  <span class="hljs-comment">;   NMI,      NMI   </span><font></font>
  SVC #0<font></font>
<font></font>
<span class="hljs-comment">;     SVC   </span><font></font>
HandleSvc:<font></font>
  <span class="hljs-comment">;        PendSV,</span>
  <span class="hljs-comment">;         </span>
  ADD     sp,sp,#(<span class="hljs-number">8</span>*4)<font></font>
<font></font>
;    <font></font>
  BX      lr<font></font>
  END</code></pre><br>
<h2 id="planirovschik"></h2><br>
<p>   ,     .      ‚Äî   ,   :  4  ,       .</p><br>
<img src="https://habrastorage.org/webt/wz/ee/3i/wzee3i2shf78ykm2gi1kbgj3ugw.png"><br>
<p>  ,       <em>Schedule()</em>      .    ,         .  . .,       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">myTasker</span>:</span> Tasker&lt;HighPriorityTask, NormalPriorityTask, LowPriorityTask,  idleTask&gt; {} ;
</code></pre><br>
<p>   ,   HighPriorityTask ‚Äî  ,  idleTask ‚Äî  .         .       .</p><br>
<p>      .</p><br>
<pre><code class="cpp hljs">
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Schedule</span><span class="hljs-params">()</span>
  </span>{
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> preemptedTaskId = activeTaskId; <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">auto</span> nextTaskId = GetFirstActiveTaskId(); <span class="hljs-comment">//     </span><font></font>
<font></font>
      <span class="hljs-comment">//       ,</span>
      <span class="hljs-comment">//         </span>
      <span class="hljs-keyword">while</span> (nextTaskId &lt; activeTaskId)<font></font>
      {<font></font>
        activeTaskId = nextTaskId;<font></font>
        CallTask(nextTaskId); <span class="hljs-comment">//      </span>
        nextTaskId = GetFirstActiveTaskId(); <span class="hljs-comment">//     </span><font></font>
      }<font></font>
      activeTaskId = preemptedTaskId; <span class="hljs-comment">//       </span><font></font>
  }<font></font>
</code></pre><br>
<p>       :</p><br>
<pre><code class="cpp hljs">
<span class="hljs-function">__forceinline  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; task&gt;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CallTaskHelper</span><span class="hljs-params">()</span>
</span>{<font></font>
  task.events = noEvents;   <span class="hljs-comment">//  </span>
  __enable_interrupt() ;    <span class="hljs-comment">//  ,     </span>
  task.OnEvent();           <span class="hljs-comment">//  </span>
  __disable_interrupt() ;   <span class="hljs-comment">//   </span>
}</code></pre><br>
<p> ,     OnEvent().<br>
 ,      ,     ,   .</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; ...tasks&gt;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tasker</span>
{</span><font></font>
...<font></font>
}</code></pre><br>
<p>      , ,    ( )  :</p><br>
<pre><code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">GetFirstActiveTaskId</span><span class="hljs-params">()</span>
 </span>{
   <span class="hljs-keyword">return</span> GetFisrtActiveTask&lt;tasks...&gt;(<span class="hljs-number">0U</span>);<font></font>
 }<font></font>
<font></font>
 <span class="hljs-function">__forceinline <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; task, <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; ...args&gt;
 <span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">GetFisrtActiveTask</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> result)</span>
 </span>{
   <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(<span class="hljs-keyword">sizeof</span>...(args) != <span class="hljs-number">0U</span>)</span>
   </span>{
     <span class="hljs-keyword">if</span> (task.events != noEvents)<font></font>
     {<font></font>
       <span class="hljs-keyword">return</span> result;<font></font>
     }<font></font>
     <span class="hljs-keyword">else</span><font></font>
     {<font></font>
       <span class="hljs-keyword">auto</span> res = result + <span class="hljs-number">1</span> ;
       <span class="hljs-keyword">return</span> GetFisrtActiveTask&lt;args...&gt;(res);<font></font>
     }<font></font>
   }<font></font>
   <span class="hljs-keyword">else</span><font></font>
   {<font></font>
     <span class="hljs-keyword">if</span> (task.events != noEvents)<font></font>
     {<font></font>
       <span class="hljs-keyword">return</span> result;<font></font>
     } <span class="hljs-keyword">else</span><font></font>
     {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>...(tasks); <span class="hljs-comment">//   .</span><font></font>
     }<font></font>
   }<font></font>
 }</code></pre><br>
<p>,     ,            </p><br>
<p>        :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CallTask</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> id)</span>
</span>{
  <span class="hljs-keyword">return</span> CallTaskById&lt;tasks...&gt;(id, <span class="hljs-number">0U</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function">__forceinline <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; task, <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; ...args&gt;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CallTaskById</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> id, <span class="hljs-keyword">size_t</span> result)</span>
</span>{
   <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(<span class="hljs-keyword">sizeof</span>...(args) != <span class="hljs-number">0U</span>)</span>
   </span>{
     <span class="hljs-keyword">if</span> (result == id)<font></font>
     {<font></font>
       CallTaskHelper&lt;task&gt;() ;<font></font>
     }<font></font>
     <span class="hljs-keyword">else</span><font></font>
     {<font></font>
       <span class="hljs-keyword">auto</span> res = result + <span class="hljs-number">1</span> ;<font></font>
       CallTaskById&lt;args...&gt;(id, res);<font></font>
     }<font></font>
   }<font></font>
   <span class="hljs-keyword">else</span><font></font>
   {<font></font>
     <span class="hljs-keyword">if</span> (result == id)<font></font>
     {<font></font>
       CallTaskHelper&lt;task&gt;() ;<font></font>
     }<font></font>
     <span class="hljs-keyword">else</span><font></font>
     {<font></font>
          <span class="hljs-comment">//   ,     ,      </span><font></font>
     }<font></font>
   }<font></font>
}<font></font>
</code></pre><br>
<p>     ,  ,   link layer  -  ( Modbus RTU     3,5   1,5 )        ‚Äî    ‚Äî    ,   , .</p><br>
<pre><code class="cpp hljs">  <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; targetTask&gt;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">PostEvent</span><span class="hljs-params">(<span class="hljs-keyword">const</span> tStateEvents events)</span>
  </span>{
    <span class="hljs-keyword">const</span> CriticalSection cs;<font></font>
    targetTask.events |= events;  <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span> (scheduleLockedCounter == <span class="hljs-number">0U</span>) <span class="hljs-comment">//    </span><font></font>
    {<font></font>
      Schedule(); <span class="hljs-comment">//       </span><font></font>
    }<font></font>
  }</code></pre><br>
<p>   ,          ,     -  ,     ‚Äî       <em>PendSV</em>.</p><br>
<pre><code class="cpp hljs"> <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IsrEntry</span><span class="hljs-params">()</span>
 </span>{<font></font>
   assert(scheduleLockedCounter != <span class="hljs-number">255U</span>);<font></font>
   ++scheduleLockedCounter;<font></font>
 }<font></font>
<font></font>
 <span class="hljs-function">__forceinline <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IsrExit</span><span class="hljs-params">()</span>
 </span>{<font></font>
   assert(scheduleLockedCounter != <span class="hljs-number">0U</span>);<font></font>
   --scheduleLockedCounter;<font></font>
   SCB::ICSR::PENDSVSET::PendingState::Set(); <font></font>
 }</code></pre><br>
<p>      ,      .      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Tasker, <span class="hljs-keyword">typename</span> ...Timers&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TaskerTimerService</span>
{</span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnSystemTick</span><span class="hljs-params">()</span>
  </span>{<font></font>
     Tasker::IsrEntry() ;<font></font>
     (Timers::OnTick(), ...) ;<font></font>
     Tasker::IsrExit() ;<font></font>
  }<font></font>
} ;</code></pre><br>
<p>    </p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">auto</span>&amp; targetThread, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> TimerFrequency, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">uint32_t</span> msPeriod, tStateEvents eventsToPost, <span class="hljs-keyword">typename</span> Tasker&gt;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskerTimer</span>
{</span>
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnTick</span><span class="hljs-params">()</span>
  </span>{<font></font>
    --ticksRemain ;<font></font>
    <span class="hljs-keyword">if</span> (ticksRemain == <span class="hljs-number">0U</span>)<font></font>
    {<font></font>
      ticksRemain = ticksReload ;<font></font>
      Tasker::PostEvent&lt;targetThread&gt;(eventsToPost) ;<font></font>
    }<font></font>
  }<font></font>
...<font></font>
}<font></font>
</code></pre><br>
<h2 id="zadachi"></h2><br>
<p>    <em>TaskBase</em>.      ,       ,     ,         ,  - .</p><br>
<img src="https://habrastorage.org/webt/zr/d7/-y/zrd7-yfltxofsbz1n0afpqw1ep8.png"><br>
<p>    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TargetThread</span>:</span> <span class="hljs-keyword">public</span> TaskBase&lt;TargetThread&gt;<font></font>
{<font></font>
}</code></pre><br>
<p>   <del>3</del>,  4 , 3    ,     ,  ,      .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TargetThread</span>:</span> <span class="hljs-keyword">public</span> TaskBase&lt;TargetThread&gt;<font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEvent</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-comment">//  -  ,   .</span>
      GPIOC::ODR::Toggle(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">8</span>);    <span class="hljs-comment">//  PortC.8</span><font></font>
    }<font></font>
<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> SimpleTasker, <span class="hljs-keyword">auto</span>&amp; threadToSignal&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Thread1</span> :</span> <span class="hljs-keyword">public</span> TaskBase&lt;Thread1&lt;SimpleTasker, threadToSignal&gt;&gt;<font></font>
{<font></font>
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEvent</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{<font></font>
    GPIOC::ODR::Toggle(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">9</span>);  <span class="hljs-comment">// PortC.9</span>
    SimpleTasker::PostEvent&lt;threadToSignal&gt;(<span class="hljs-number">1</span>); <span class="hljs-comment">//   -  </span><font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> SimpleTasker, <span class="hljs-keyword">auto</span>&amp; threadToSignal&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Thread2</span> :</span> <span class="hljs-keyword">public</span> TaskBase&lt;Thread2&lt;SimpleTasker, threadToSignal&gt;&gt;<font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEvent</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
        GPIOC::ODR::Toggle(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>); <span class="hljs-comment">//  PortC.5</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4000000</span>; ++i)  <span class="hljs-comment">//   </span><font></font>
        {<font></font>
        };<font></font>
        SimpleTasker::PostEvent&lt;threadToSignal&gt;(<span class="hljs-number">1</span>); <span class="hljs-comment">//   -  </span><font></font>
        test ++ ;<font></font>
    }<font></font>
 <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">inline</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> test ;<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">myTasker</span>;</span>
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">constexpr</span> TargetThread targetThread;
<span class="hljs-comment">// ,    targetThread</span>
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">constexpr</span> Thread1&lt;myTasker, targetThread&gt; myThread1; 
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">constexpr</span> Thread2&lt;myTasker, targetThread&gt; myThread2;
</code></pre></div>
                    </div><br>
<p>     , ,  -   ,        .       .</p><br>
<pre><code class="cpp hljs">
<span class="hljs-comment">// myThread1,     1001 </span>
<span class="hljs-keyword">using</span> MyThread1Timer = TaskerTimer&lt;myThread1, <span class="hljs-number">1'000U</span>L,
                                   <span class="hljs-number">1001U</span>L, <span class="hljs-comment">// time in ms</span>
                                   <span class="hljs-number">1</span>,<font></font>
                                   myTasker&gt;;<font></font>
<span class="hljs-comment">// myThread2,     1000 </span>
<span class="hljs-keyword">using</span> MyThread2Timer = TaskerTimer&lt;myThread2, <span class="hljs-number">1'000U</span>L,
                                   <span class="hljs-number">1000U</span>L, <span class="hljs-comment">// time in ms</span>
                                   <span class="hljs-number">1</span>,<font></font>
                                   myTasker&gt;;<font></font>
<font></font>
<span class="hljs-keyword">using</span> tRtosTimerService = TaskerTimerService&lt;myTasker, MyThread1Timer, MyThread2Timer&gt;;</code></pre><br>
<p>   ...</p><br>
<img src="https://habrastorage.org/webt/xc/6a/ef/xc6aefhv9reff44di5fyeh6l29m.gif"><br>
<p>.<br>
   Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> </a>.      Clion.</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">     IAR 8.40.2</a></p><br>
<h1 id="zaklyuchenie"></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 tasks of blinking an LED + the scheduler itself takes 564 bytes of code + 14 bytes of constant data and 17 bytes of RAM without optimization.</font></font></p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ro code</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ro data</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rw data</font></font></th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taskerschedule.cpp</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">508</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">17</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrupthandlers.s</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
</tr>
</tbody>
</table></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When optimization is enabled, the code size is reduced by 120 bytes.</font></font></p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ro code</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ro data</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rw data</font></font></th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taskerschedule.cpp</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">388</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eleven</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">17</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrupthandlers.s</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
</tr>
</tbody>
</table></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resources: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build a Super Simple Tasker</font></font></a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARMv6-M Architecture Reference Manual</font></font></a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QuantumLeaps / qpc</font></font></a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multitasking on Cortex-M (0) class MCU</font></font></a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cortex-M0 Technical Reference Manual</font></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506394/index.html">Anycubic Mega X 3D Printer: A Great Printer at a Modest Price</a></li>
<li><a href="../en506396/index.html">Elon Musk: ‚ÄúLidar is a waste of time. All who rely on lidar are doomed ‚Äù</a></li>
<li><a href="../en506398/index.html">Joel Spolsky: ‚ÄúNot Usability Alone‚Äù</a></li>
<li><a href="../en506400/index.html">Basic guide to creating balanced development teams</a></li>
<li><a href="../en506410/index.html">Reflections on the coronavirus epidemic COVID-19</a></li>
<li><a href="../en506432/index.html">How to make a custom web or mobile project from scratch: processes, rules and a little blood</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electr√≥nico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
<li><a href="../es486184/index.html">C√≥mo usar la b√∫squeda de manera efectiva</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>