<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏯️ 🏏 💤 MOXA Nport-インサイドルック 🐦 💤 😚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="シリアルポートデータ収集サーバーMOXA Nportなどは、現在、RS-232、RS-485、およびRS-422インターフェースを介してデータを送受信する建築システムの分野における事実上の標準です。
 
 電気メーター、制御バルブとゲートバルブ、流量計、振動センサー、テレメカニクスデバイス。
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MOXA Nport-インサイドルック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478642/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアルポートデータ収集サーバーMOXA Nportなどは、現在、RS-232、RS-485、およびRS-422インターフェースを介してデータを送受信する建築システムの分野における事実上の標準です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電気メーター、制御バルブとゲートバルブ、流量計、振動センサー、テレメカニクスデバイス。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを生成したり、リモートで制御したりでき、RS-232、RS-485、RS-422インターフェースを備えたすべてのものは、これらのコンバーターを介して動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらの使用の一般的な意味は通常次のとおりです。RS-232、RS-485、およびRS-422インターフェースを既存のローカルネットワーク経由で転送し、シリアルインターフェースの1つを持つデバイスまたはデバイスをイーサネット経由でPC（サーバー、SCADA）に接続し、デバイスに接続します。リモート制御などのためにインターネット経由のシリアルインターフェースを持っている</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのコンバーターの価格はそれほど高くありません。若いモデルは100〜200ドルで借りることができます。しかし、そのようなデバイスの自動化された生産では、何百または何千ものインストールが可能であることを考えると、国内の「輸入代替品」にはかなりのヒントが浮上しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日は彼らを助けようと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは何をしますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、それが内部にどのように配置されているかの理論を理解します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、リアルCOMモードで作業を開始するための（つまり、実際には、仮想COMポートをイーサネット経由でデバイスに転送するための）最小限の機能を分離します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第3に、目的のために、NPort Administration Suiteユーティリティを介してデバイスを検索および構成するためのプロトコルを分析します。</font><font style="vertical-align: inherit;">ネイティブソフトウェアとドライバーから完全なサポートを受けながら、既存のMOXA Nportの代わりに固定できる鉄片のピンツーピンアナログを作成する方法を完全に理解します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に-インド人がMOXAファームウェアコードを書いた人数を計算してみましょう。</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1.はじめに</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、テーブル上にテストサブジェクトがあります（実際には複数あったため、記事に異なるモデル識別子と異なるMACアドレスが表示されても驚かないでください）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zs/bu/co/zsbucoqb74oopd5ld_vkqkqipfc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イーサネットポートと2つのRS-422 / RS-485ポートがあります-これは物理的なものです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ソフトウェアプランでは、デバイスは開いています：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UDPポート4800-デバイス検索パケットをキャッチし、デバイス自体に関するデータを構成ユーティリティに送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPポート4900-デバイス構成コマンドを受信します。デバイスの時間、名前、IPアドレス、動作モード、速度とポートの設定、およびその他の基本的なパラメータは、このポートを介して構成できます。このポートは、NPort Administration Suiteユーティリティのメインインターフェースを介して構成できます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mh/me/79/mhme79fontjiywnsdxgq_wk2sau.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。TCPポート80 — WEBインターフェースの操作を担当します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPポート966、967（および4ポートデバイスの場合は968、969）は伝送制御ポートです。</font><font style="vertical-align: inherit;">コマンドを実行して、対応するCOMポートを開いたり閉じたり、ポート速度を設定したり、データをプッシュしたり、送信/受信バッファーの空き容量を監視したりします。</font><font style="vertical-align: inherit;">ポート966は、それぞれ最初のポートの操作を担当します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPポート（デフォルト）950、951、および4ポートデバイスの952、953は、直接データ転送用のポートです。</font><font style="vertical-align: inherit;">つまり、デバイスのRS-232 / 485/422ポートに直接現れるべきものがデータポートに送信されます。</font><font style="vertical-align: inherit;">このポートのデータフロー制御のみが、それぞれ966、967、968、969ポートに送られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の頭の中のデバイスの動作を理解する全体像が発展してくれることを願っています。</font><font style="vertical-align: inherit;">次のパートに移りましょう：</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2. MOXAをエミュレートする </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに、最小限の構成でMOXA Nportのふりをするためには、2つのポートで独自のハードウェア上にTCPサーバーを上げる必要があることがすでに多くの人に明らかになっています。転送制御用の966と直接データ転送用の950。当然、ポート966でドライバーの要求に正しく応答して処理する必要がありますが、wireshark分析で示されているように、それほど多くの要求はなく、最も単純です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事のテキストに要求と回答を説明する計算で過負荷にならないようにするために、すべての解析された要求、回答、および送信されたパラメーターの説明をpdfファイルの形式で個別に作成して投稿しました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロード：MOXA.pdfを解析するプロトコルの説明</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、この一連の知識により、ネイティブドライバーとペアリングして、MOXAとしてデータを送信できるデバイスを実装できます。</font><font style="vertical-align: inherit;">作業の半分は完了しましたが、1つのポイントがあります-構成を変更する方法は？</font><font style="vertical-align: inherit;">これらの目的には、ネイティブのNPort Administration Suiteユーティリティを使用すると便利です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3.検索して見つける</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の2つの部分では、何を行う必要があるかを説明しましたが、プロトコルの実装のためにデータを取得する方法については何も語られていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この部分では、少し深く掘り下げ、交換自体の分析がどのように行われたかを確認します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UDPポート4800がデバイスで開いていることがわかっているので、デバイスを接続し、NPort Administration Suite、Wiresharkを起動して、ネイティブユーティリティでデバイスを検索するとどうなるかを確認します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/b8/om/fkb8om_d1ieh_2wipyvvglmwzn8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信されたパケット</font></font><br>
<br>
<img src="https://habrastorage.org/webt/av/j7/pg/avj7pgj8udm7ujvvnbs-26eip4i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を確認します。NPortAdministration Suiteはアドレス255.255.255.255にブロードキャストを送信します。つまり、パケットがネットワーク上を飛ぶことを期待しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペイロードパッケージにはデータが含まれています。</font></font><br>
<br>
<pre><code class="plaintext hljs"> 01 00 00 08 00 00 00 00, :<font></font>
01 00 –  <font></font>
00 08 –       Big Endian.<font></font>
00 00 00 00 –  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリクエストは数回送信されますが、少なくともそのうちの1つが目標を達成することを期待しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのMOXがこの要求に応答します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v7/u3/zn/v7u3zn6pil6rw8ijo1mad4caea4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
具体的には、私たちが答えた：</font></font><br>
<br>
<pre><code class="plaintext hljs"> 81 00 00 18 00 00 00 00 12 03 00 80 32 03 00 90 e8 26 4a ab c0 a8 7f fe<font></font>
81 00 –  <font></font>
00 18 –     (24)<font></font>
00 00 00 00 –  <font></font>
12 03 00 80 32 03 –  MOXA Nport device,    NPort 5232.        MOXA Nport device.          NPort Administrator.<font></font>
00 90 e8 26 4a ab – MAC  MOXA Nport device<font></font>
c0 a8 7f fe – IP  MOXA Nport device ( 192.168.127.254 )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが基本的に単純で、デバイスの特定のモデルの解釈を担当する値12 03 00 80 32 03のみを混乱させるようです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、この値は参照参照に対してチェックされるため、どこかに保存する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアディレクトリを少し調べたところ、NPort Administrator Suite v1.22では、これらの値はファイルC：\ Program Files \ NPortAdminSuite \ bin \ dsci.dllに格納されていることがわかりました。Wireshark </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fs/sf/8k/fssf8kgx4iaz45n0fzucjonzkla.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
とデバイスを数日間使用した後、完全な交換ログを取得し、どのコードを理解するか応答する関数。便宜上、見つかったものはすべて同じPDFファイルに記述されており、そのリンクは以前の記事で示されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
絵の完全な理解のために-私は、設定やインストールを必要とするすべてのパラメータがたTCPポート4900の要求を使用して構成されているデバイスに関する主な情報は、UDP 4800を介して受信されていることを思い出させるよ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正しくポート4800と4900のためのすべての着信要求を処理し、我々は完全にふりをすることができますデバイスなので、ネイティブソフトウェアでもキャッチに気づきません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート4.インディアンの数え方*</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトコルの分析中に、交換プロトコルのさまざまな部分がさまざまな人々によって作成され、機能の意味とその解釈があまりにも異なっていると感じました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UDPポート4800の機能コードは次のように始まります。</font></font><br>
<br>
<pre><code class="plaintext hljs"> 01 00 .. .. <font></font>
 81 00 .. ..<font></font>
 10 00 .. ..<font></font>
 90 00 .. ..<font></font>
 16 00 .. ..<font></font>
 96 00 .. ..<font></font>
 29 00 .. ..<font></font>
 a9 00 .. ..</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPポート4900の機能コードは次で始まります：</font></font><br>
<br>
<pre><code class="plaintext hljs"> 00 01 .. ..<font></font>
 00 01 .. ..<font></font>
 02 01 .. ..<font></font>
 02 01 .. ..</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPポート966、967、968、969の機能コードは次で始まります：</font></font><br>
<br>
<pre><code class="plaintext hljs"> 10 .. ..<font></font>
 10 4f 4b<font></font>
 11 .. ..<font></font>
 11 4f 4b</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下のように。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは、一つの機能バイト識別子がすでに使用されており、以前のようではないダブルバイト。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すると、ちなみに面白い瞬間が出てきました。ポート966、967、968、969では、設定パラメーターへの応答は常に3バイトで構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は関数番号で、残りの2つは4f 4bです。または、ASCIIテーブルに「O」「K」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
が表示されていますか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目に見られる機能は、同じ応答内のビッグエンディアンとリトルエンディアンのハッシュです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答例：</font></font><br>
<br>
<pre><code class="plaintext hljs">9a 00 00 24 00 00 00 00 01 52 00 80 9a 52 00 90 e8 3b 89 9c 75 00 04 00<font></font>
01 00 0f 00 09 00 17 00 36 00 00 00<font></font>
9a 00 –  <font></font>
00 24 –     (36)<font></font>
00 00 00 00 –  <font></font>
01 52 00 80 9a 52 –  MOXA Nport device<font></font>
00 90 e8 3b 89 9c - MAC  MOXA Nport device<font></font>
75 00 - : 1900 +   (1900 + 117 = 2017)<font></font>
04 00 - :     1 -    <font></font>
01 00 –  <font></font>
0f 00 –  (15)<font></font>
09 00 –  (9)<font></font>
17 00 –  (23)<font></font>
36 00 –  (36)<font></font>
00 00 –  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パケットサイズは1つの方法でエンコードされ、すべての数値（年、月、日...）は別の方法でエンコードされます。このことから、75 00 04 00 .......から始まるユーザー部分の処理は別のプログラマーによって書かれたと結論付けることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要約すると、少なくとも3人が交換プロトコルを作成し、1人がデータのユーザー部分の処理を作成し、少なくとも1人がWEBインターフェイスハンドラを作成しました。私の計算によると、約5人のプログラマーがプロジェクトに取り組んでいました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたはいくらカウントしましたか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*この場合、「ヒンドゥー」という用語は、特に雇用主企業のグローバルプランを深く掘り下げることなく、食​​事と住宅ローンの義務を果たし、ここから昼食前にコーディングできる従業員を意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSこの記事は2017年に開発された資料に基づいて書かれているため、データの多くには今年の日付が正確に含まれています。</font><font style="vertical-align: inherit;">プロトコルはワーキングドラフトのフレームワーク内で分析されましたが、マインドがマーケティングに勝ち、問題は単一のワーキングプロトタイプの段階を超えていませんでした。</font><font style="vertical-align: inherit;">この情報は開発者コミュニティに役立つと思いますので、このプロジェクトのすべての開発をパブリックドメインで公開します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつものように私</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">個人のブログにある</font></a><font style="vertical-align: inherit;"> PPSオリジナル記事</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478630/index.html">パスカルは囲碁を演じます。アマチュアコンパイラでのメソッドとインターフェイスの実装</a></li>
<li><a href="../ja478634/index.html">機械学習プロジェクト管理の落とし穴</a></li>
<li><a href="../ja478636/index.html">テキストエンコーディングの仕組み。「ワニ」はどこから来たのですか？コーディングの原則。一般化と詳細分析</a></li>
<li><a href="../ja478638/index.html">db-tree：データベースの検索とナビゲーション</a></li>
<li><a href="../ja478640/index.html">オープンソースの自動運転車</a></li>
<li><a href="../ja478646/index.html">JetQuad：垂直離着陸を備えた航空機</a></li>
<li><a href="../ja478650/index.html">ドーン3D</a></li>
<li><a href="../ja478652/index.html">DNSパケット構造</a></li>
<li><a href="../ja478654/index.html">推定分布カウント-ほとんどの場合、ソートを再発明</a></li>
<li><a href="../ja478658/index.html">親切に目を覚ますには？新しい夜明けプラス光目覚まし時計</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>