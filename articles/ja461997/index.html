<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃🏿 👌🏻 ⚪️ PostgreSQLでのクエリパフォーマンスのチューニング 🆒 🆕 👻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="データベースのパフォーマンスのチューニング-開発者は通常、それを気に入っているか、嫌いです。私はこれを楽しんでおり、PostgreSQLで不十分に実行されるクエリを調整するために最近使用したいくつかのメソッドを共有したいと思います。私の方法は網羅的なものではなく、チューニングに悩む人のための教科書で...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLでのクエリパフォーマンスのチューニング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461997/"><img width="40%" align="left" src="https://habrastorage.org/webt/0s/ei/zy/0seizy-vxfjf3uv8g3n_bijcwb0.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースのパフォーマンスのチューニング-開発者は通常、それを気に入っているか、嫌いです。</font><font style="vertical-align: inherit;">私はこれを楽しんでおり、PostgreSQLで不十分に実行されるクエリを調整するために最近使用したいくつかのメソッドを共有したいと思います。</font><font style="vertical-align: inherit;">私の方法は網羅的なものではなく、チューニングに悩む人のための教科書です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅いクエリを検索する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チューニングを開始する最初の明白な方法は、うまく機能しない特定のオペレーターを見つけることです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stats_statements</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stats_statements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
モジュール</font><font style="vertical-align: inherit;">は、始めるのに最適な場所です。</font><font style="vertical-align: inherit;">SQLステートメントの実行統計を追跡するだけで、非効率的なクエリを簡単に見つけることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このモジュールをインストールすると、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">呼ばれるシステムビュー</font><font style="vertical-align: inherit;">がすべてのプロパティとともに利用可能になります。</font><font style="vertical-align: inherit;">彼が十分なデータを収集する機会を得たら、比較的高い</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">total_time</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値を持つクエリを探します</font><i><font style="vertical-align: inherit;">。</font></i><font style="vertical-align: inherit;">最初にこれらの演算子に焦点を当てます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span><font></font>
  pg_stat_statements<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  total_time <span class="hljs-keyword">DESC</span>;</code></pre><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーID</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbid</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queryid</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリ</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出し</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">total_time</font></font></th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16384</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16385</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2948</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT address_1 FROMはINNER JOINの人々をアドレス指定しますp ON a.person_id = p.id WHERE a.state = @state_abbrev;</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">39483</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15224.670</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16384</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16385</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">924</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person_idからSELECT WHERE WHERE name = </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26483</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12225.670</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16384</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16385</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">395</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT _ FROMオーダーWHERE EXISTS（is_featured = trueの製品から_を選択）</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18583</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">224.67</font></font></td>
</tr>
</tbody>
</table></div><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto_explain</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto_explain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
モジュール</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">は</font></a><font style="vertical-align: inherit;">遅いクエリの検索にも役立ち</font><font style="vertical-align: inherit;">ます</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が</font></a><font style="vertical-align: inherit;">、2つの明らかな利点が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">実際の実行プランを登録し、</font><i><font style="vertical-align: inherit;">log_nested_statements</font></i><font style="vertical-align: inherit;">オプションを使用してネストされたステートメントを記録</font><i><font style="vertical-align: inherit;">できるようにし</font></i><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ネストされたステートメントは、関数内で実行されるステートメントです。</font><font style="vertical-align: inherit;">アプリケーションが多くの機能を使用する場合、auto_explainは詳細な実行計画を取得するために非常に重要です。</font><i><font style="vertical-align: inherit;">log_min_duration</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
オプション</font><font style="vertical-align: inherit;">は、実行時間に基づいてログに記録されるクエリ実行プランを制御します。</font><font style="vertical-align: inherit;">たとえば、値を1000に設定すると、1秒以上かかるすべてのレコードが登録されます。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの調整</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう1つの重要な調整戦略は、インデックスが正しく使用されるようにすることです。</font><font style="vertical-align: inherit;">前提条件として、Statistics Collectorを含める必要があります。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgres Statistics Collector</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、あらゆる種類の有用なパフォーマンス統計を収集するファーストクラスのサブシステムです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコレクターを有効にする</font><font style="vertical-align: inherit;">と、すべてのプロパティを含む</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大量のpg_stat _...ビューが表示</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">されます。</font><font style="vertical-align: inherit;">特に、これは欠落したインデックスや未使用のインデックスを見つけるのに特に役立つことがわかりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不足しているインデックス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
欠落しているインデックスは、クエリのパフォーマンスを改善する最も簡単なソリューションの1つです。</font><font style="vertical-align: inherit;">ただし、これらは特効薬ではないため、正しく使用する必要があります（これについては後で詳しく説明します）。</font><font style="vertical-align: inherit;">統計コレクターを有効にしている場合は、次のクエリ（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">実行できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  relname,<font></font>
  seq_scan - idx_scan <span class="hljs-keyword">AS</span> too_much_seq,
  <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span>
      seq_scan - <span class="hljs-keyword">coalesce</span>(idx_scan, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">THEN</span>
      <span class="hljs-string">'Missing Index?'</span>
    <span class="hljs-keyword">ELSE</span>
      <span class="hljs-string">'OK'</span>
  <span class="hljs-keyword">END</span>,<font></font>
  pg_relation_size(relname::regclass) <span class="hljs-keyword">AS</span> rel_size, seq_scan, idx_scan
<span class="hljs-keyword">FROM</span><font></font>
  pg_stat_all_tables<font></font>
<span class="hljs-keyword">WHERE</span>
  schemaname = <span class="hljs-string">'public'</span>
  <span class="hljs-keyword">AND</span> pg_relation_size(relname::regclass) &gt; <span class="hljs-number">80000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  too_much_seq <span class="hljs-keyword">DESC</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリは、インデックススキャンよりも順次スキャン（インデックススキャン）が多いテーブルを検出します。これは、インデックスが役立つことを明確に示しています。</font><font style="vertical-align: inherit;">これは、インデックスを作成する列を通知しないので、もう少し作業が必要になります。</font><font style="vertical-align: inherit;">ただし、どのテーブルがそれらを必要とするかを知ることは、最初のステップとして適切です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未使用のインデックス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのエンティティにインデックスを付けますか？</font><font style="vertical-align: inherit;">未使用のインデックスが書き込みパフォーマンスに悪影響を及ぼす可能性があることをご存知ですか？</font><font style="vertical-align: inherit;">その理由は、インデックスを作成するときに、Postgresが書き込み操作（INSERT / UPDATE / DELETE）の後にこのインデックスを更新するタスクを負担するためです。</font><font style="vertical-align: inherit;">したがって、インデックスを追加すると、データの読み取りを高速化できるため（正しく作成されている場合）、バランスをとることができますが、書き込み操作が遅くなります。</font><font style="vertical-align: inherit;">未使用のインデックスを見つけるには、次のクエリを実行します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  indexrelid::regclass <span class="hljs-keyword">as</span> <span class="hljs-keyword">index</span>,<font></font>
  relid::regclass <span class="hljs-keyword">as</span> <span class="hljs-keyword">table</span>,
  <span class="hljs-string">'DROP INDEX '</span> || indexrelid::regclass || <span class="hljs-string">';'</span> <span class="hljs-keyword">as</span> drop_statement
<span class="hljs-keyword">FROM</span><font></font>
  pg_stat_user_indexes<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_index <span class="hljs-keyword">USING</span> (indexrelid)
<span class="hljs-keyword">WHERE</span>
  idx_scan = <span class="hljs-number">0</span>
  <span class="hljs-keyword">AND</span> indisunique <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発環境統計に関する注意</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカル開発データベースの統計に依存すると、問題が発生する可能性があります。</font><font style="vertical-align: inherit;">理想的には、作業中のマシンから上記の統計を取得するか、復元された作業中のバックアップから生成できます。</font><font style="vertical-align: inherit;">何のために？</font><font style="vertical-align: inherit;">環境上の要因により、Postgresクエリオプティマイザの動作が変わる可能性があります。</font><font style="vertical-align: inherit;">2つの例：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシンのメモリが少ない場合、PostgreSQLはハッシュ結合を実行できない場合があります。そうでない場合は、高速で実行できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルに（開発データベースのように）行数が少ない場合、PostgresSQLは、利用可能なインデックスを使用するよりも、テーブルの順次スキャンを実行することを好む場合があります。</font><font style="vertical-align: inherit;">テーブルサイズが小さい場合、Seq Scanはより高速になります。</font><font style="vertical-align: inherit;">（注：実行できます</font></font><pre><code class="plaintext hljs">SET enable_seqscan = OFF</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シーケンシャルスキャンの方が高速である場合でも、オプティマイザがインデックスの使用を選択できるように、セッション内。</font><font style="vertical-align: inherit;">これは、大量のデータを持たない開発データベースで作業する場合に役立ちます）</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行計画について</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの遅いクエリを見つけたので、楽しみを始めましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明する</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コマンド</font><font style="vertical-align: inherit;">は、クエリを設定するときに必ず必要です。</font><font style="vertical-align: inherit;">彼は本当に何が起こっているのかを教えてくれます。</font><font style="vertical-align: inherit;">これを使用するには、クエリに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を追加して</font><font style="vertical-align: inherit;">実行します。</font><font style="vertical-align: inherit;">PostgreSQLは、使用した実行プランを表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チューニングにEXPLAINを使用する場合、</font><font style="vertical-align: inherit;">より正確な結果が得られる</font><font style="vertical-align: inherit;">ため、常に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ANALYZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション</font><font style="vertical-align: inherit;">（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN ANALYZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">使用することをお勧めします</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ANALYZEオプションは、ステートメントを（単に評価するのではなく）実際に実行してから説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ひと泳ぎして、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の出力を理解してみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に例を示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ee/py/sv/eepysvoeunknfcwr9meuxa9e4y4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結び目</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に理解する必要があるのは、前の「-&gt;」が付いたインデントされた各ブロック（および先頭行）はノードと呼ばれることです。</font><font style="vertical-align: inherit;">ノードは、関連するコストとリードタイムを持つ論理的な作業単位（必要に応じて「ステップ」）です。</font><font style="vertical-align: inherit;">各ノードに提示されるコストと時間は累積的であり、すべての子ノードをまとめます。</font><font style="vertical-align: inherit;">つまり、一番上の行（ノード）は、オペレーター全体の合計コストと実際の時間を示します。</font><font style="vertical-align: inherit;">どのノードがボトルネックであるかを簡単にドリルダウンできるため、これは重要です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">費用</font></font></h3><br>
<pre><code class="plaintext hljs">cost=146.63..148.65</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の数字は初期コスト（最初のレコードを取得するコスト）で、2番目の数字はノード全体を処理するコスト（最初から最後までの合計コスト）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、これは、PostgreSQLがステートメントを実行するために満たす必要があると見積もられるコストです。</font><font style="vertical-align: inherit;">この数は、リクエストを完了するのにかかる時間を意味するものではありませんが、通常、完了するには直接的な関係が必要です。</font><font style="vertical-align: inherit;">コストは、必要な作業を評価するために使用される5つの作業コンポーネントの組み合わせです：順次サンプリング、一貫性のない（ランダム）サンプリング、行処理、処理演算子（関数）、処理インデックスの記録。</font><font style="vertical-align: inherit;">コストは入力/出力とプロセッサの負荷であり、比較的高いコストはPostgresSQLがより多くの作業を行う必要があると信じていることを理解することが重要です。</font><font style="vertical-align: inherit;">オプティマイザは、コストに基づいて、使用する実行プランを決定します。</font><font style="vertical-align: inherit;">オプティマイザは低コストを優先します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際の時間</font></font></h3><br>
<pre><code class="plaintext hljs">actual time=55.009..55.012</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ミリ秒単位で、最初の数値は開始時間（最初のレコードを取得する時間）で、2番目の数値はノード全体の処理に必要な時間（開始から終了までの合計時間）です。</font><font style="vertical-align: inherit;">わかりやすいですよね？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の例では、最初のレコードを取得するのに55.009ミリ秒かかり、ノード全体を完了するのに55.012ミリ秒かかりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行計画の詳細をご覧ください。</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EXPLAINの結果を理解するのに役立つ記事がいくつかあります。</font><font style="vertical-align: inherit;">ここでもう一度説明するのではなく、次の2つのすばらしいリソースにアクセスして、時間をかけて実際に理解することをお勧めします。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.depesz.com/2013/04/16/explaining-the-unexplainable/</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://wiki.postgresql.org/images/4/45/Explaining_EXPLAIN.pdf</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストのチューニング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うまく機能していないオペレーターがわかり、実行プランを確認できるようになったので、今度はクエリを調整してパフォーマンスを向上させましょう。</font><font style="vertical-align: inherit;">ここで、クエリを変更したり、インデックスを追加したりして、より優れた実行計画を取得します。</font><font style="vertical-align: inherit;">ボトルネックから始めて、コストやリードタイムを削減するために行える変更があるかどうかを確認します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データキャッシュとコストノート</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更を加えて実装計画を評価するときは、改善があるかどうかを確認するために、将来の実装が最良の結果をもたらすデータのキャッシュに依存する可能性があることを知ることが重要です。</font><font style="vertical-align: inherit;">リクエストを1回実行する場合は、修正を加えて2回目に実行します。実行プランがそれほど有利ではない場合でも、実行速度ははるかに速くなります。</font><font style="vertical-align: inherit;">これは、PostgreSQLが最初の起動時に使用されたデータをキャッシュし、2番目の起動時にそれを使用できるためです。</font><font style="vertical-align: inherit;">したがって、クエリを少なくとも3回完了し、結果を平均してコストを比較する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が学んだことは、実行計画の改善に役立ちます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指数</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを追加して順次スキャン（Seq Scan）を除外します（テーブルサイズが小さくない場合）</font></font></li>
<li>    ,      ,       — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></li>
<li>  ,       .      .</li>
</ul></li>
<li> <br>
<br>
<ul>
<li> LIKE</li>
<li>     WHERE</li>
<li>   IN()</li>
</ul></li>
<li>JOIN<br>
<br>
<ul>
<li>          ON (.. a.id = b.person_id).        (. . Hash Join,   Nested Loop Join)</li>
<li>    JOIN,   ,        , ,   .</li>
<li>  :    GROUP BY  DISTINCT  ,    ?       JOIN       </li>
<li>    Hash Join,     ,     .  ,     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  (vacuuming strategy )</a></li>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>;      </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">EXISTS</a>       ,      ( ,      )</li>
</ul></li>
<li> <br>
<br>
<ul>
<li>    ;     / (I/O)</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Common Table Expressions</a>   ,      .</li>
<li>  LOOP    SET</li>
<li> COUNT (*),  PostgresSQL      (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   &lt;= 9.1</a>)</li>
<li>   ORDER BY, DISTINCT, GROUP BY, UNION,       </li>
<li>          <i>EXPLAIN</i>.    ,     ,  PostgreSQL      . : <pre><code class="plaintext hljs">Limit (cost=282.37..302.01 rows=93 width=22) (actual time=34.35..49.59 rows=2203 loops=1)</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推定行数は93で、実際の行数は-2203でした。したがって、おそらくこれは計画の悪い決定です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バキューム戦略</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を確認し、ANALYZEが十分な頻度で実行されるようにして</font><font style="vertical-align: inherit;">ください</font><font style="vertical-align: inherit;">。</font></font></li>
</ul></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461983/index.html">特定のクライアント向けに製品を変更する方法</a></li>
<li><a href="../ja461985/index.html">郵便テクノロジー-ロシア郵便をデジタル化する方法</a></li>
<li><a href="../ja461989/index.html">さまざまな画面プロポーション向けのゲームインターフェースの開発</a></li>
<li><a href="../ja461993/index.html">「通常のデザイナー」から食料品になる方法</a></li>
<li><a href="../ja461995/index.html">常駐プロキシーをマーケティングおよびWebサイトのプロモーションに使用する方法</a></li>
<li><a href="../ja461999/index.html">WordPress開発環境の別のバージョン（docker、wp-cli）</a></li>
<li><a href="../ja462003/index.html">Google PlayのSvelteにPWAを投稿した方法</a></li>
<li><a href="../ja462005/index.html">Google PageSpeedの機能：サイトの評価と検索ランキングの改善</a></li>
<li><a href="../ja462007/index.html">堅牢なPythonスクリプトの開発</a></li>
<li><a href="../ja462009/index.html">プログラミングの傾向：2020年に何が期待できるか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>