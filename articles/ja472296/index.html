<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔟 👨🏼‍🏫 ⛓️ 洗濯機の漏れ防止システム 👨🏻‍🎨 👩🏿‍🤝‍👩🏼 👦🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 どの家にも洗濯機があると思います。通常、フレキシブルホースを介して給水に接続されます。しかし、ホースで大きな迷惑が発生する可能性があります。時には破裂し、それがあなたのアパートとあなたの隣人の両方で洪水につながるでしょう。したがって、洗濯機は特別な蛇口を介して給水装置に接続されています。こ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>洗濯機の漏れ防止システム</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472296/"><img src="https://habrastorage.org/webt/7q/2r/xp/7q2rxpr6f9jntwgc-3ai-qwqglo.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どの家にも洗濯機があると思います。通常、フレキシブルホースを介して給水に接続されます。しかし、ホースで大きな迷惑が発生する可能性があります。時には破裂し、それがあなたのアパートとあなたの隣人の両方で洪水につながるでしょう。したがって、洗濯機は特別な蛇口を介して給水装置に接続されています。この蛇口は、洗浄前に開き、その後閉じる必要があります。あなたのことは知りませんが、このクレーンは非常に不便な場所にあります。はい、私は仕事に行く前に洗浄を開始することを好みます。そのため、一日のほとんどの期間、ホースが圧力下にあり、家にいないときに破裂する可能性があります。クレーンが適切なタイミングで開閉するのは素晴らしいことです！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイデアは私にはかなり有能であるように思われ、私はそれを実装することに決めました：マイクロコントローラーと電動バルブを使って。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、開発したシステムの要件を定式化しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洗濯機の状態を監視する：洗濯の初めに開いている水と終わりに閉じている;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バルブを手動で制御する機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッテリーが作動した場合、バッテリーが放電した場合にバルブを閉じる。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">漏れセンサーの存在：漏れが検出された場合は、バルブを閉じます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、洗濯機に設置されているモニターと、モニターからの信号を受信して​​電動バルブを制御するコントローラーとから構成されている部品を見つけました。</font><font style="vertical-align: inherit;">モニターとコントローラー間の通信は、一方向の無線チャネルを介して行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
技術的な作業にはこれで十分のようです。</font><font style="vertical-align: inherit;">始めましょう！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCUの選択</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システム全体が2つのデバイスで構成されるため、2つのマイクロコントローラーが必要です。</font><font style="vertical-align: inherit;">私は根性を解体し、2つのAtmega8を見つけました。1つはDIPパッケージにあり、もう1つはTQFPにあります。</font><font style="vertical-align: inherit;">DIPの1つ-モニターに行き、TQFP-コントローラーに行きました。</font><font style="vertical-align: inherit;">後で、大きくなりすぎたコントローラーファームウェアがAtmega8の8KBに収まらないことが判明したので、完全なアナログであるAtmega328にアップグレードする必要がありましたが、プログラム用に4倍のメモリがあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、そういうプロジェクトをやる動機のひとつは、長年蓄積してきた電子ゴミの処理です。</font><font style="vertical-align: inherit;">確かに、プロジェクトの最後にゴミは小さくなりません。</font><font style="vertical-align: inherit;">さらに大きくなります！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1。</font><font style="vertical-align: inherit;">モニター</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洗濯機との相互作用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の問題：洗濯機が今何をしているかをどのように判断するか？プロジェクトの最初は、タスクのこの部分は非常に単純に思えました。やらなければならないことは、洗濯の始まりと終わりの瞬間を決定することだけでした。機械のフロントパネルには、必要なときに点灯して消灯するLEDがあります。マイクロコントローラーの足でGPIOをはんだ付けするつもりだったので、デバッグの時間はボタンでモニターの必要なイベントをエミュレートしました。私はボタンを押しました-LEDが点灯し、洗浄が始まりました。手放す-反対は本当です。ただし、洗濯機を解析した後、このLEDは動的ディスプレイの一部であることがわかりました。残念ながら、オンかオフかを判断するのはそれほど簡単ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の手でコントロールパネルを回すと（数日）、それがPICコントローラーに実装されていることがわかりました。さらに、ハードウェアI2Cに応答するレッグでメインボードに接続されます。ええ、私はあなたがI2Cバスを盗聴して、今洗濯機をどうするかを決めることができると思いました。インターネットでAtmegaのI2Cスニファーコードを見つけました。もちろん、何かをしなければなりませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
率直に言って、プロトコルを完全に理解することはできませんでした（そして、それをあまり試しませんでした）が、洗浄の開始と終了のパターン（および電源のオンとオフ）を非常に正確に決定することができました。約一週間かかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデル：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャンディGC4 1072 D</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。コンピューターは定期的に一連の5バイトシーケンスを表示ユニットに送信します。最初の4つのシーケンスの形式は次のとおりです。</font></font><br>
<br>
<code>12 A7 00 – NN – X0 X1 X2 X3 X4 X5 X6 X7 – CS</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで：12 A7 00-ヘッダー、NN-シーケンス番号、X [0..7]-8バイトのデータ、CS-チェックサム。 5番目のシーケンスは、さまざまなサイズのゴミの一種であり、その本質は謎のままです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は次のパターンを解決することができました：</font><font style="vertical-align: inherit;">
X [0..7]が0と等しくない場合の</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POWER ON </font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">START</font></b><font style="vertical-align: inherit;"> 
[X [0..3]は任意の数です</font><b><font style="vertical-align: inherit;">STOP</font></b><font style="vertical-align: inherit;"> 
ここでX [0..3]は任意の数</font><font style="vertical-align: inherit;">
です）これは厳密なシーケンス、つまりテンプレートではないため、パーサーをいじる必要がありました。</font></font><br>
<br>
<code>12 A7 00 – 01 – X0 X1 X2 X3 X4 X5 X6 X7 – CS<br>
12 A7 00 – 02 – X0 X1 X2 X3 X4 X5 X6 X7 – CS</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<br>
<code>12 A7 00 – 03 – X0 X1 X2 X3 01 01 01 01 – CS</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<br>
<code>12 A7 00 – 03 – X0 X1 X2 X3 00 00 00 00 – CS</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業のロジックはおおよそ次のとおりです。POWERONシーケンスを取得したが、STARTがない場合は、ステータス0でパケットのブロードキャストを開始します。STARTシーケンスが表示された場合は、ステータスを1に変更します。それ以外の場合、ヘルメットを送信するものはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージと次のステータスについてお話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おかしいですが、I2Cパッケージをスパイしたとき、スニファーコンピューターに接続する機会がありませんでした。</font><font style="vertical-align: inherit;">このラズベリーPi c powerbank'omには、アルミニウムケースが付いていました。</font><font style="vertical-align: inherit;">そこで、この建物が洗濯機のケースに触れるとすぐに、RCDがシールドに引き抜かれ、アパートの電灯が消えて、マツキと一緒に懐中電灯を探し始めました。</font><font style="vertical-align: inherit;">:)なぜそのようなゴミが起こったのか-私にはまだ謎のままです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラジオチャンネル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、洗濯機から来る余分なワイヤーが欲しくありませんでした。つまり、接続はワイヤレスであると想定されていました。ここから、問題に対する3つの可能な解決策がありました：WiFi、Bluetooth、およびArduinoのRFモジュール。私はFS1000Aモジュールを選択することで、後者に落ち着きました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、ハブレには、この選択で私を非難する人がたくさんいます。彼らは、Ali-Expressでは、完全なWiFiを備えたESPモジュールを安価に購入できることを示唆しています。しかし、これはプロジェクトを非常に複雑にするだろうと考え、より単純な行動を取ることにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご存知のように、FS1000A RFモジュールはRS232インターフェースに直接接続できません。ゼロまたは1の長いシーケンスにより、レシーバーの同期が切断されます。 VirtualWireライブラリは、この問題を解決するように設計されています。ただし、このライブラリはArduino用に作成されており、CのAtmegaで排他的にネイティブにプログラムしています。幸い、Arduinoのコードは純粋なCと非常によく似ており、わずかな変更を加えるだけでライブラリは正常に移植されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの困難がありました：最初は、パッケージがレシーバーに到達したくありませんでした。曲がった手をすべてのせいにしましたが、レシーバーとトランスミッターのコントローラーの端子を直接接続することで、すべてがソフトウェア部分で機能することを確信しました。中国に注文した送信機は故障していることが判明した。別のキットを買わなければならなかった。それから私は古いものを修正しました、そして今私は2セットの送受信機を持っています。ゴミの削減について書いたことを覚えていますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データは送信されましたが、このデータには正確に何が含まれていますか？送信されたパケットは次のとおりです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-keyword">uint32_t</span> dst;
    <span class="hljs-keyword">uint32_t</span> src;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WMP_MSG_STATUS_ALIVE    _BV(0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WMP_MSG_STATUS_VALVE    _BV(1)</span>
    <span class="hljs-keyword">uint8_t</span> status;<font></font>
} <span class="hljs-keyword">wmp_msg_t</span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WMP_ADDR_MONITOR        0x4d504d57</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WMP_ADDR_CONTROLLER     0x43504d57</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の2つのダブルワードは、レシーバーとトランスミッターの物理アドレスです。私の場合、それらは厳密に修正されています：0x43504d57-レシーバー（コントローラー）および0x4d504d57-トランスミッター（モニター）。実際、最初の8バイトはこのパケット署名です。重要な情報は最後のバイト（ビットフラグ）にのみあります。このフラグのゼロセットビットは、モニターがオンで動作していることを意味します。常に1である必要があります。最初のビットはバルブのステータスです。0-バルブは閉じている必要があり、1-開いている必要があります。すべて。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モニターは定期的にパケットをコントローラーに送信して、その動作とデータチャネルの保守性を確認する必要があると想定されています。通信チャネルが失われた場合、コントローラーはバルブを緊急に閉じる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VirtualWireライブラリは、CRC32を使用して送信データの完全性を監視します。</font><font style="vertical-align: inherit;">私はこの方向に追加の努力をする必要はありませんでした。</font><font style="vertical-align: inherit;">美しさ！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設計</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構造的には、モニターは小さなボードの形で作られ、洗濯機のフロントパネル内の熱い接着剤「叔父Liao snot」に接着され、ボードはコンピューターとディスプレイボードの間のギャップにコネクターを接続します。</font><font style="vertical-align: inherit;">マシン自体は変更されていません。いつでも元の状態に戻すことができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二部。</font><font style="vertical-align: inherit;">コントローラ。</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラジオチャンネル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすべてが簡単です。FS1000AキットのレシーバーとVirtualWireライブラリの受信部があります。</font><font style="vertical-align: inherit;">パッケージが解析され、そのステータスが出力に送信されます。</font><font style="vertical-align: inherit;">VirtualWireレシーバーは、マイクロコントローラーのTIMER1を占有します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バルブ制御</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
中国のオンラインストアでは、3/4インチの電動バルブが選択され、5ボルトで駆動され、ケーブルに接続されたターミナルセンサーが付いています。このバルブはボールバルブと洗濯機のホースの間に設置されました。バルブを制御するために、同じ中国のサイトで、L9110ドライバーに低電力ステッピングモータードライバーが注文されました。次のようにコントローラーに接続しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0a/dr/h9/0adrh9lsveasvy1hpqc6ogngsac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアの観点からは、特別な問題はありませんでした。入力VALVE_CLOSEおよびVALVE_OPENにより、バルブの現在のステータスを判別します。この状態を変更する必要がある場合は、モーターをオンにして開閉を行い、対応する入力で論理0が確立されるまで待ちます。ただし、開閉には時間がかかるため、その時点ですべてを制御できなくなることはありません。端末。したがって、Atmegaタイマーでは、プリミティブスケジューラが構築され、バルブの制御が特別なタスクに移されました。同時に、特別なWatchDogソフトウェアモジュールがバルブの切り替えにかかる時間を測定し、長すぎると、その誤動作に関する信号が生成されます。その後、このスケジューラには、LEDの点滅やリークセンサーのポーリングなど、他の興味深いことが掛かりました。しかし、それについては後で詳しく説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、3色のステータスLEDと3ポジションの手動制御トグルスイッチがバルブ制御回路に属しています。</font><font style="vertical-align: inherit;">トグルスイッチの中央の位置では、洗濯機やその他のセンサーからの信号に従って自動制御が作動します。</font><font style="vertical-align: inherit;">バルブが故障すると、赤色と緑色が交互に点灯します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LEDとサウンド表示</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LEDを使用すると、すべてが簡単です。制限抵抗を介してI / Oポートに直接接続します。そこの電流は大きくなく、Atmegaのポートは非​​常に強力です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、音はいじくり回さなければなりませんでした。まず、大きくて大きなピエゾエミッタは見つかりませんでした。そんな人たちが自然界にいるようですが、購入に参加した途端、その選択は全く素晴らしいものではないことがわかりました。私がなんとかして得たクールなものはとても静かに聞こえた。レシピのためにネットサーフィンをしなければなりませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのトランジスタと単巻変圧器を備えた回路に落ち着きました。単巻変圧器は、音圧を5Vから50Vにスイングします。そして、それは比較的大声で判明しました。もちろん、すべての周波数ではありませんが、共振に近いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LEDの輝度がわずかに低下したのはサウンドの生成時だけでしたが（パワーとのジャム）、マイクロコントローラーはフリーズせず、制御プログラムは壊れませんでした。これはデバッグレイアウトの機能であり、すべてが最終的なボードで正常に動作すると思いました。私は間違っていました-それは良くなりませんでした。しかし、さらに悪いことです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w8/ca/pb/w8capblzyb0abagztoygcputhsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう1つの問題は、タイマーが不足し、バックグラウンドで音を生成できないことでした。私は眠りのきしむ期間を尋ねなければなりませんでした。したがって、サウンドの生成中、Atmegaは割り込みも無効にする必要があります。それ以外の場合、トーンは明確ではありません。しかし、サウンド出力は、バルブの制御や無線を介したデータの受信など、他の重要なタスクと交差しなかったので、これはそれほど怖くないことがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、スリープ定数をメモに対応するように選択し、「バルブが開いている」、「バルブが閉じている」、「洗浄が完了した」、「リーク」といういくつかの調和のとれた組み合わせを考え出しました。</font><font style="vertical-align: inherit;">「洗浄完了」の信号については、後で個別にお知らせします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リークディテクター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リークディテクタはもともと、マイクロコントローラの内蔵ADCで実行されるように計画されていました。</font><font style="vertical-align: inherit;">実験により、これは完全に機能するソリューションであることがわかっています。</font><font style="vertical-align: inherit;">しかし、接点付きのセンサーにコンデンサーが追加されて接続され、ワイヤーのどこかに断線がない場合は、私はそれに会いました。</font><font style="vertical-align: inherit;">コンデンサの存在を確認（およびその容量を測定）するには、RCチェーン、コンパレータ、クロックを使用します。</font><font style="vertical-align: inherit;">コンパレータとして、従来のGPIO入力が使用され（これも論理入力であり、特定の電圧で0から1に切り替わります）、マイクロコントローラーには十分な時間があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sh/um/rn/shumrnvjljzhpc_m7fdyye9ugwi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時々、ライン上のコンデンサの存在を確認し、ADCを使用してセンサーの接点が水中にあるかどうかを判断することが想定されていました。結局のところ、コンデンサの静電容量のみを測定するだけで十分です。水中でコンデンサを下げると、充電時間が増加し、放電が減少します。さらに、時間は十分な量だけ変化するため、確実に検出できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のシステムでは、充電時間を測定することにしました。コンデンサが接続されていない場合はゼロ、乾燥している場合は比較的小さく、水中にある場合は充電時間が長くなります。正確な値は、水を入れた受け皿と一連の実験を使用して決定されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
漏れ検知器には、独自の赤いインジケータLEDがあります。</font><font style="vertical-align: inherit;">センサーが検出されない場合、センサーが点灯し、バルブを閉じるコマンドが空気に送信されます。</font><font style="vertical-align: inherit;">センサーとの通信を回復するだけで、LEDが消灯し、バルブを開くことができます（もちろん、マシンのみが洗浄状態の場合）。</font><font style="vertical-align: inherit;">もう1つは、センサーが水を検出した場合です。</font><font style="vertical-align: inherit;">この場合、インジケーターが点滅を始め、不快な断続音が鳴り、バルブが強制的に閉じられます。</font><font style="vertical-align: inherit;">しかし、最も重要なのは、コントローラーがこの状態を決して離れないことです。</font><font style="vertical-align: inherit;">漏れは重大な事故と見なされ、デバイスを強制的に再起動するまで給水は再開されません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">栄養</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトでは、食べ物が私にとって最も理解しにくい部分です。</font><font style="vertical-align: inherit;">私がデジタル回路に少し精通している場合は、アナログで、穏やかに言えば-実際にはそうではありません。</font><font style="vertical-align: inherit;">しかし、中国人のおかげで、バッテリー充電コントローラーを備えたDC-DCコンバーター用の既製のモジュールを購入でき、それらに基づいて、何か実行可能なものを考えることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当初から、このデバイスはセルフパワー式であることが計画されていたため、停電が発生した場合は、必ず水を遮断してください。</font><font style="vertical-align: inherit;">さらに、どこかに接続する必要のある9V電源がありました。</font><font style="vertical-align: inherit;">合計、紹介結果は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9Vはネットワークから供給されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.4〜3.7Vはバッテリーから供給されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッテリーを充電するには、5Vが必要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロジックと電源回路に電力を供給するために5Vが必要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主電源電圧に障害が発生した場合は、電源をバッテリーに切り替えます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッテリー充電信号、バッテリー電圧、主電源操作信号をコントローラーに送信する必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図のようにブロック図ができました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7g/ma/5l/7gma5lv_yub5aunjhing_cbnmjw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのショットキーダイオードがスイッチング素子として使用されています。</font><font style="vertical-align: inherit;">充電コントローラーには、CHARGEとSTANDBYの2つのLEDがあります。</font><font style="vertical-align: inherit;">最初の信号はコントローラーのGPIOポートに接続されたため、モニターはバッテリーが充電中であることを認識できました。</font><font style="vertical-align: inherit;">また、最初のDC-DCコンバーターからの信号がマイクロコントローラーポートに適用され、デバイスが電源またはバッテリーで動作しているかどうかを判断します。</font><font style="vertical-align: inherit;">充電レベルを制御するために、バッテリーからの電圧がコントローラーのADCに供給されます。</font><font style="vertical-align: inherit;">電圧が低すぎる場合、モニターはバルブを閉じてスタンバイモードになります。ネットワークの電圧が表示されるまで、コマンドはコマンドに応答しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、ここにはいくつかの妨害がありました。何らかの理由で、バルブモーターがバッテリーからのエネルギーの一部を占めています。</font><font style="vertical-align: inherit;">どうやら、私はネットワークのDC / DCコンバーターの電源またはボード上の電源トラックの厚さに間違いを犯しました。</font><font style="vertical-align: inherit;">その結果、バルブを開閉した後、バッテリーの充電が始まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源状態を監視するために、特別な2色のLEDがあります。</font><font style="vertical-align: inherit;">緑の場合、デバイスはネットワーク上で動作しています。</font><font style="vertical-align: inherit;">赤の場合-バッテリーから。</font><font style="vertical-align: inherit;">緑色でも赤い色が点滅している場合、バッテリーは充電中です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作業ロジック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ええと、私たちはすべてのハードウェアとそのソフトウェアのサポートを持っています。今度は、これらすべてを互いに相互作用させる必要があります。最初は、内部に多数のifを含む大きなループ（メインループと呼ばれるもの）の形で作業ロジックの実装を確認しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その過程で、LEDの点滅、漏れセンサーのポーリング、バルブの切り替え時間の追跡、電源制御など、TIMER0に投稿したような単純なアクションのためのタスクスケジューラが必要でした。スケジューラ自体は、タスクに関連付けられた機能を実行しませんでしたが、同期ビットをタスクに関連付けられた記述子のユニットに設定するだけでした。このタスクはまだメインサイクルで実行されていたため、時間間隔の追跡をなくすことができ、非常にシンプルになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動物園から、コントローラのさまざまなサブシステムのステータスをチェックして決定を下します。バルブの開閉を拒否する必要がありました。</font><font style="vertical-align: inherit;">これをデバッグするのは非常に難しく、混乱するのは非常に簡単です。</font><font style="vertical-align: inherit;">代わりに、D。ヘイザーマンの古代の本のアイデア「ロボットを自分で作る方法」が好きでした。</font><font style="vertical-align: inherit;">本は各モジュールがそれ自身の制御信号を生成することを提案しました：前方、後方、回転など。</font><font style="vertical-align: inherit;">ほぼ同じでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は次のようにブロックに優先順位を付けました：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">漏れブロック</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッテリーコントロールユニット</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動バルブ制御ユニット</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラジコンコントロールユニット</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バルブタイマーWatchDogブロック</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ブロックは3つのコマンドを生成します：UNDEFINED、OPENおよびCLOSE。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リークブロックの優先度は最も高くなりますが、OPENコマンドはありませんが、そのCLOSEコマンドは、他のブロックの内容に関係なく、バルブを確実に閉じます。手動制御ユニットは、ラジオチャネルユニットの任意の信号を中断できます。これにより、洗濯機が何を示しているかに関係なく、バルブを制御できます。まあなど。つまり、理解しやすくデバッグしやすい論理的な階層構造が出現しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、信号に戻りましょう：「洗浄が終了しました。」</font><font style="vertical-align: inherit;">悲しいかな、私の洗濯機のモデルには、音の助けを借りて作業の終了を知らせる機会がありません。キャンディのエンジニアはそのような機会を提供していませんでした。</font><font style="vertical-align: inherit;">一方、私はピエゾエミッタを備えた追加のデバイスを持っていて、いつでも洗濯機が何をしているかを知っています。</font><font style="vertical-align: inherit;">彼に洗濯の終わりを報告させてみませんか？</font><font style="vertical-align: inherit;">さて、バルブが信号を閉じるときに、コントローラーを（共振周波数で）大音量で鳴らします。</font><font style="vertical-align: inherit;">マシンの電源をオン/オフするたびにこのきしみ音が聞こえないように、さらに5分のガードインターバルを追加します。</font><font style="vertical-align: inherit;">バルブは5分間開いています-洗浄が確実に開始されました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発には、約1年のゆったりとした（非常にゆったりとした）作業が必要でした。</font><font style="vertical-align: inherit;">このデバイスは2年間動作しています。</font><font style="vertical-align: inherit;">稼働中、それは非常に満足のいくものであることが判明しました。</font><font style="vertical-align: inherit;">しかし、欠陥がないわけではありません。</font><font style="vertical-align: inherit;">それらを正直にリストしましょう：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は力で何かを台無しにしました：バルブモーターはバッテリーからのエネルギーの一部を占めます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">音発生回路は電源電圧を引き出します。</font><font style="vertical-align: inherit;">サウンドを再生すると、LEDの明るさがどのように変化するかがはっきりとわかります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無線チャネルは非常に安定していません。</font><font style="vertical-align: inherit;">まず、人が洗濯機の近くに立つと信号が消えます。</font><font style="vertical-align: inherit;">第二に、時々信号が自然に悪化します。</font><font style="vertical-align: inherit;">この場合、手動トグルスイッチを使用する必要がありますが、これは非常にまれです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洗濯機のモニターユニットが数回ハングした。</font><font style="vertical-align: inherit;">コントローラーブロックは一度もハングしませんでした。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピエゾエミッタからの音は、ケース内部で非常に消滅しました。</font><font style="vertical-align: inherit;">私はコプロスに穴をあけました：良くなりましたが、実際にはそうではありませんでした。</font><font style="vertical-align: inherit;">基板からエミッタをはんだ付けして、穴の真向かいにあるケースに貼り付ける必要がありました。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、開発は成功し、非常に便利だと思います。</font><font style="vertical-align: inherit;">私は午前中に機械を始動し、落ち着いて仕事に向かいます。適切なときに給水栓がオフになることを知っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトファイルを含むアーカイブは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロードでき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの写真。</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上部カバーを取り外した上面図</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/pk/ac/1q/pkac1q7wwkmwbptyd814mobigx4.jpeg"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コネクタの側面から見た背面図</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/-z/3g/zq/-z3gzqv3s-dwhfuvlco9jkkqbcm.jpeg"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自然の生息地で</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/kc/cv/sx/kccvsxlyr0qtrtirqf_c5hthamq.jpeg"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モーター付きマウントバルブ</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/bg/kh/yy/bgkhyyih1i083nb9omlxrqxo9be.jpeg"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リークセンサー</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/p5/qu/2y/p5qu2ygeapyr_ivwdguhkjmkcxs.jpeg"><br>
</div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexander Ozyumenko </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発エンジニアAuriga LLC</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472280/index.html">静脈スキャナーで手のひらの存在を判断するタスク</a></li>
<li><a href="../ja472288/index.html">開発者向けの9つの便利なブラウザー拡張機能（2020のリスト）</a></li>
<li><a href="../ja472290/index.html">構造体とクラス</a></li>
<li><a href="../ja472292/index.html">コンテンツブロッキング：世界の舞台</a></li>
<li><a href="../ja472294/index.html">YouTubeでゲームやビデオを作成します。私の相互作用実験とこれからの収入</a></li>
<li><a href="../ja472298/index.html">先週フロントエンドの世界からの新鮮な食材のダイジェストNo.385（2019年10月14日〜20日）</a></li>
<li><a href="../ja472300/index.html">バイナリ分類問題における対数損失関数（LogLoss）の確率的勾配降下法（SGD）</a></li>
<li><a href="../ja472304/index.html">NASAがエンジニアを雇って次世代のヒューマノイドロボットを開発</a></li>
<li><a href="../ja472306/index.html">PHPダイジェストNo. 166（2019年10月7-21日）</a></li>
<li><a href="../ja472310/index.html">パスワードとCookieのないサイトでの顧客の識別：標準の申請</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>