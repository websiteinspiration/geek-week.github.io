<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí§ ü§ô üë©üèæ‚Äç‚úàÔ∏è All stages of creating a robot to follow the line, or how to collect all the rakes with STM32 üë©üèº‚Äçü§ù‚Äçüë®üèª üê† ü§∑üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 This publication will discuss my experience in creating a robot for competitions, namely following the line. I will try to tell all t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>All stages of creating a robot to follow the line, or how to collect all the rakes with STM32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497782/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This publication will discuss my experience in creating a robot for competitions, namely following the line. </font><font style="vertical-align: inherit;">I will try to tell all the stages from designing circuitry and ordering a printed circuit board to an algorithm and a program. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The race of robots along the line has long been a basic test for beginner robotics. </font><font style="vertical-align: inherit;">Almost all regional and international competitions include this direction, so making one robot you can participate almost everywhere. </font><font style="vertical-align: inherit;">In the first year of university, this was the next task after the first blinking of the LED.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation of the problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any development begins with a technical assignment, in our case, the competition regulations of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robofinist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> competitions are used as TK </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We are interested in the requirements for dimensions (not more than 25x25x25 cm) and the weight of the robot (not more than 1 kg), as well as the shape of the track and its width 1.5 cm. Depending on the complexity of the track, a threshold is set for the minimum time it takes to pass (60 sec. ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task is clear, we need a robot capable of detecting a line and driving along it from start to finish in a minimum amount of time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concept design</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The core of the robot is the STM32F103C8T6 microcontroller, it reads track information using QRE1113 optical sensors and controls the engines through the A3906 driver. For clarity, the sensors are each assigned their own LED, as soon as the sensor "sees" the black line, the LED lights up, this greatly simplifies the debugging process. As a power source, a Li-po type 18650 battery with a voltage of 3.7 V and a charge chip LTC4054ES5 were chosen. But for the correct operation of the motors, at least 6 V is needed, therefore, I installed the LM2577 DC-DC step-up voltage converter, and the LM1117 linear 3.3 V to supply the logic part.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/aa5/0a0/ddf/aa50a0ddf75671c4ee28137f1fbf8c47.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to talk about the first mistakes. Inattentively, I mixed up one pair of microcontroller power pins and at startup I spent several hours looking for a problem, as a result I had to bite them. Then the problem arose that not all sensors reacted to the line, my first reaction was that I burned the microcontroller or the broken legs of the power supply at the last stage were not at all superfluous, or that I badly soldered the contacts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using an oscilloscope, I found that the problem was in the sensors themselves, out of 10 sensors 4 did not work, replacing them with new ones the following problem appeared - three indicator LEDs PB3, PB4 and PA15 did not work. After rewriting and looking through all my code, I could not find any differences in the initialization of non-working and working ports everywhere was Push Pull, 10 MHz and clock enabled. Having looked at the oscillogram, I noticed that one pin was attracted to the plus and even in debug mode it didn‚Äôt reset at all, I realized that the microcontroller was burned. Closing the datasheet, I noticed that by a strange coincidence, these pins are used for JTAG, and I use SWD, but having decided that it wouldn‚Äôt get worse, I started googling how to disable JTAG and it really helped (see below).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mini conclusion, check the correct nutrition at all stages so that you don‚Äôt think something burned later or it doesn‚Äôt work for other reasons.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What needs to be improved in the scheme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I guessed to put the charge chip, but I forgot about the discharge, although it is no less important, plus in 2020 I put mini USB instead of type C. I would like to use the microcontroller to monitor the battery charge, but it did not have any ADC pins left. </font><font style="vertical-align: inherit;">When choosing a driver, I relied on the characteristics of the 6 V and 700 mA engines, but did not take into account that its maximum voltage is 9 V, but I would like 12 V.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCB design</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, it was decided to determine the size and shape of the PP and part-time platform of the robot. We recall that according to the regulations, the dimensions should not exceed 25x25 cm, but it is also worth considering that when ordering software at a factory (PCBWay) in China, boards over 10x10 cm increase significantly in price. I think the choice of dimensions is obvious. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you should distribute the sensors symmetrically (on the bottom of the board), taking into account the line width, and then the heaviest elements, such as motors and the battery. LEDs are mounted on the same axis as the corresponding sensors, on the opposite side of the board. For convenience, we install a power switch and a battery charge connector in the back of the platform. The remaining elements are set closer to the center.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having cut off the empty edges of the board instead of a square, a completely decent image of the robot platform is obtained. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The board turned out to be quite simple due to the small number of unique elements. </font><font style="vertical-align: inherit;">Total 2 layers minimum track thickness 0.25 mm. </font><font style="vertical-align: inherit;">Having saved the motherboard in the Gerber format, I sent it to the factory by selecting the white color of the mask, then I did not have any special problems. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/57e/f74/2c8/57ef742c8e35e324720908b0758200cc.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And a 3D view of the board with the elements. </font><font style="vertical-align: inherit;">Live photo will be at the end.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/37f/a8b/65d/37fa8b65d80595744c2e2436490b304e.jpg" alt="image"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What needs to be finalized in the board</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I installed some elements too close to the plastic case of the battery and it was difficult to solder them, and even more difficult to solder. </font><font style="vertical-align: inherit;">I forgot to sign the pinout of the programming connector SWD, UART and engines, as a result, I have to look into the circuit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Purchase of components</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The development of everything new requires the highest relative costs per unit of goods, you can and should try to save, but within reasonable limits, so ordering line sensors for Aliexpress 4.5 times cheaper than in an electronics store, I paid for the fact that about 40% of them turned out to be not working, and this is the time to find and fix errors. </font><font style="vertical-align: inherit;">On the other hand, I did not want to buy the LM2577 chip for 460 rubles, while the module with all the strapping costs 100 rubles. </font><font style="vertical-align: inherit;">I ordered part of the parts to Ali, another part at a local store. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are my estimated component costs:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Engines and wheels - 800 rubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battery and case - 400 rubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charger - 300 rubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontroller and driver - 200 rubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stabilizers - 400 rubles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fees 10 units with delivery 2400/10 = 240 rubles per unit;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the harness - 150 rubles.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4650 rubles total costs for components, or 2490 if you subtract the price of the remaining nine unused boards. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: I began to calculate the cost of boards and component installation and per batch of 10 units. </font><font style="vertical-align: inherit;">the price increased to 16,000 rubles. </font><font style="vertical-align: inherit;">There are ideas how to optimize but this is another time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm implemented the simplest, if the line turned out to be, for example, on the right side, then the right engine will start to slow down and the closer the line to the edge, the slower the engine will work, until it stops completely, while the left engine will work at maximum speed trying to turn towards the line. </font><font style="vertical-align: inherit;">A similar situation if the line is on the left side. </font><font style="vertical-align: inherit;">Thus, the robot tries to stabilize, returning the line to the central sensors.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22b/07d/9ab/22b07d9ab0c0795c33cda8c42236e18f.jpg" alt="image"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithm in pictures</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ae3/234/6c5/ae32346c5611292cf0b7fc155317da5a.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b47/403/545/b47403545480435eed6c7b362dbad0bd.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5d8/55b/68c/5d855b68c11937aa1196d6d281c5c939.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/481/545/42c4815453ca35de5c6dc32570e09506.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/587/7ee/4db/5877ee4db1610d2aab5ace1af4cd27b3.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also necessary to provide for other situations, for example, if all the sensors have detected a line, then this most likely means that we are crossing the intersection and most likely we need to go further ahead. </font><font style="vertical-align: inherit;">Or if only the extreme sensors detected the line, then we arrived at the finish line and we need to stop.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programming</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, you need to get a tambourine and beat into it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wrote in Atollic True Studio used only CMSIS and FreeRTOS. Spent half a week to launch FreeRTOS, did everything according to the instructions, but caught errors during the compilation process, fixed 1, 63 appeared, or there were no errors, but the controller crashed. At some point, I realized that the level of my hand ... reached unprecedented heights and it was time to think about what I was doing and what I was doing. Thanks to comrades from the community, I started digging in the right direction and from a lot of redrawn sources I found several that helped me (see below). As a result, I managed to defeat FreeRTOS and so far I have used it at 0%, because I stuffed everything into one task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> helped me the most </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The timing system, here I'm still not sure if it works as it should. Having tuned the system frequency through the PLL to 48 MHz, I saw 24 MHz (/ 2) on the foot of the MCO, no, I saw a 22-25 MHz signal remotely resembling a sine. At the same time, I set 48 MHz in FreeRTOS config and set the delay to 500 ms and ran it, saw that my 500 ms turned into 300, went through all the possible settings, noticed that I get the target 500 ms only when clocked from the internal generator to 8 MHz, and the frequency value FreeRTOS config did not affect at all, set both 1 Hz and 48 GHz. I decided to return 48 MHz and work with 300 ms, after which I accidentally rebooted True Studio and it worked wonderfully as I thought, and from the very beginning I already indicated all the file paths. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem of JTAG and LEDs, described above, the solution was found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and you just need to disable it, thereby freeing up access to the pins PB3, PB4 and PA15.</font></font><br>
<br>
<pre><code class="cpp hljs">AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The structure of the project is approximately as follows:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A lot of code</font></font></b>
                        <div class="spoiler_text">1.   ;<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{						<span class="hljs-comment">// Quartz 16 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLXTPRE;	<span class="hljs-comment">// PLLXTPRE set divider (/2) = 8 MHz</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_HSEON;			<span class="hljs-comment">// On HSE</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_HSERDY)) {<font></font>
	};<font></font>
<font></font>
	RCC-&gt;CFGR |= (RCC_CFGR_PLLMULL6);     <span class="hljs-comment">// Setup PLLMULL set multiplier (x6) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLSRC;		<span class="hljs-comment">// PLLSRC set HSE</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_PLLON;			<span class="hljs-comment">// ON PLL</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_PLLRDY)) {<font></font>
	};<font></font>
<font></font>
	FLASH-&gt;ACR &amp;= ~FLASH_ACR_LATENCY;	<span class="hljs-comment">// Setup FLASH</span><font></font>
	FLASH-&gt;ACR |= FLASH_ACR_LATENCY_1;<font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_HPRE_DIV1; 	<span class="hljs-comment">// Set not divider (AHB) = 48 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE1_DIV2; 	<span class="hljs-comment">// Set divider (/2) (APB1) = 24 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE2_DIV1; 	<span class="hljs-comment">// Set not divider (APB2) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR &amp;= ~RCC_CFGR_SW; 		<span class="hljs-comment">// Setup SW, select PLL</span><font></font>
	RCC-&gt;CFGR |= RCC_CFGR_SW_PLL;<font></font>
<font></font>
<span class="hljs-comment">//	RCC-&gt;CFGR |= RCC_CFGR_MCO_SYSCLK;</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
2.  ,      ,     ,      Push Pull;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GPIO_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB2ENR |=	(RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN); <span class="hljs-comment">// Enable clock portA, portB and Alternative function</span><font></font>
<font></font>
	AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;	<span class="hljs-comment">// Disable JTAG for pins B3,B4 and A15</span><font></font>
<font></font>
	<span class="hljs-comment">//---------------LED: (B3 to B9; A11, A12, A15); Output mode: Push Pull, max 10 MHz---------------//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE3_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE4_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup B4 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE5_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup B5 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE6_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup B6 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE7_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);	<span class="hljs-comment">// Setup B7 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF9 | GPIO_CRH_MODE9);	<span class="hljs-comment">// Setup B8 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE9_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF11 | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup A11 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE11_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);	<span class="hljs-comment">// Setup A12 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE12_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF15 | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup A15 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE15_0;<font></font>
<font></font>
	<span class="hljs-comment">//--Motors: (A8 to A10; B12 to B15); Output and input (B12, B13) mode: Alternative function, PWM - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);		<span class="hljs-comment">// Setup B12 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13);		<span class="hljs-comment">// Setup B13 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF14   | GPIO_CRH_MODE14);	<span class="hljs-comment">// Setup B14 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  GPIO_CRH_MODE14_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF15   | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup B15 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF15_1 | GPIO_CRH_MODE15_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF9    | GPIO_CRH_MODE9);		<span class="hljs-comment">// Setup A9 pins PP, AF, 10MHz</span><font></font>
	GPIOA-&gt;CRH |=  (GPIO_CRH_CNF9_1  | GPIO_CRH_MODE9_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF10 | GPIO_CRH_MODE10);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE10_0;<font></font>
<font></font>
	<span class="hljs-comment">//--UART3: (B10 - TX; B11 - RX); Output mode: Alternative function, UART - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10   | GPIO_CRH_MODE10);	<span class="hljs-comment">// Setup B10 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF10_1 | GPIO_CRH_MODE10_0);<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF11   | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup B11 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF11_1 | GPIO_CRH_MODE11_0);<font></font>
<font></font>
	<span class="hljs-comment">//--Optical sensors: (B0, B1, A0 - A7); Input mode: Analog--//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup B0 pins analog input</span>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup B1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup A0 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup A1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF2 | GPIO_CRL_MODE2);	<span class="hljs-comment">// Setup A2 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup A3 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup A4 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup A5 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup A6 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup A7 pins analog input</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
3.       DMA,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ADC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	 RCC-&gt;AHBENR |= RCC_AHBENR_DMA1EN;<font></font>
	 DMA1_Channel1-&gt;CPAR = (<span class="hljs-keyword">uint32_t</span>) &amp;ADC1-&gt;DR;		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CMAR = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>) adc_buf;   	<span class="hljs-comment">//    </span><font></font>
<font></font>
	 DMA1_Channel1-&gt;CNDTR = <span class="hljs-number">10</span>;			  				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;			   		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MSIZE_0;		  		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_PSIZE_0;		 		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MINC;			  	<span class="hljs-comment">// memory increment mode</span><font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_CIRC;<font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_TCIE;				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;				  	<span class="hljs-comment">//  </span>
	 NVIC_SetPriority(DMA1_Channel1_IRQn, <span class="hljs-number">10</span>);<font></font>
	 NVIC_EnableIRQ(DMA1_Channel1_IRQn);<font></font>
<font></font>
	 RCC-&gt;CFGR &amp;= ~RCC_CFGR_ADCPRE;<font></font>
	 RCC-&gt;CFGR |= RCC_CFGR_ADCPRE_DIV8;<font></font>
	 RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN;<font></font>
<font></font>
	 ADC1-&gt;SQR3 = <span class="hljs-number">0</span>;			<span class="hljs-comment">// 1</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 2     </span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 3</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 4</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">20</span>;		<span class="hljs-comment">// 5</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">5</span> &lt;&lt; <span class="hljs-number">25</span>;		<span class="hljs-comment">// 6</span>
	 ADC1-&gt;SQR2 = <span class="hljs-number">6</span>;			<span class="hljs-comment">// 7</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">7</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 8</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 9</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 10</span><font></font>
<font></font>
	 ADC1-&gt;CR2 = ADC_CR2_EXTSEL_0 | ADC_CR2_EXTSEL_1 | ADC_CR2_EXTSEL_2<font></font>
	 | ADC_CR2_EXTTRIG;<font></font>
	 ADC1-&gt;SMPR1 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//   </span>
	 ADC1-&gt;SMPR2 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//</span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 0,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">1</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 1,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">2</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 2,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">3</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 3,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">4</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 4,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 5,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">6</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 6,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">7</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 7,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">8</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 8,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">9</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 9,   6 </span>
	 ADC1-&gt;SMPR1 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 10,   6 </span><font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_RSTCAL;<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_RSTCAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_CAL;<font></font>
<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_CAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;SQR1 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">20</span>;						<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR1 |= ADC_CR1_SCAN;					<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR2 |= ADC_CR2_DMA;				  	<span class="hljs-comment">// DMA on</span>
	 <span class="hljs-comment">// ADC1-&gt;CR2 |= ADC_CR2_CONT;</span><font></font>
<font></font>
	 <span class="hljs-comment">//  ADC1-&gt;CR2 |= ADC_CR2_SWSTART;</span><font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
}<font></font>
</code></pre><br>
4.        ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM1_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	<span class="hljs-comment">/*************** Enable TIM1 (CH1) ***************/</span><font></font>
	RCC-&gt;APB2ENR |= RCC_APB2ENR_TIM1EN;<font></font>
	TIM1-&gt;CCER = <span class="hljs-number">0</span>;										<span class="hljs-comment">//  CCER ( )</span>
	TIM1-&gt;ARR = <span class="hljs-number">1000</span>; 									<span class="hljs-comment">//  ,     </span>
	TIM1-&gt;PSC = <span class="hljs-number">48</span> - <span class="hljs-number">1</span>;                					<span class="hljs-comment">// </span>
	TIM1-&gt;BDTR |= TIM_BDTR_MOE;     					<span class="hljs-comment">//     </span><font></font>
<font></font>
	TIM1-&gt;CCR2 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= (TIM_CCER_CC2P |TIM_CCER_CC2E); 		<span class="hljs-comment">//        </span>
														<span class="hljs-comment">//   -   3</span>
	TIM1-&gt;CCR3 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= TIM_CCER_CC3NE; 						<span class="hljs-comment">//        </span><font></font>
	TIM1-&gt;CCER &amp;= ~TIM_CCER_CC3NP;<font></font>
<font></font>
	TIM1-&gt;CR1 |= TIM_CR1_CEN;<font></font>
}<font></font>
</code></pre><br>
5.  UART  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> </a>     ;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB1ENR |= RCC_APB1ENR_USART3EN;<font></font>
<font></font>
	USART3-&gt;BRR = <span class="hljs-number">0xD0</span>;						<span class="hljs-comment">// Speed = 115200; (24 000 000 + (115200 / 2)) / 115200 = 208 -&gt; 0xD0</span><font></font>
<font></font>
	USART3-&gt;CR1 |= USART_CR1_TE | USART_CR1_RE | USART_CR1_UE;<font></font>
<font></font>
<span class="hljs-comment">//	USART3-&gt;CR1 |= USART_CR1_RXNEIE;</span>
<span class="hljs-comment">//	NVIC_EnableIRQ(USART3_IRQn);</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send</span><span class="hljs-params">(<span class="hljs-keyword">char</span> chr)</span> </span>{
	<span class="hljs-keyword">while</span> (!(USART3-&gt;SR &amp; USART_SR_TC))<font></font>
		;<font></font>
	USART3-&gt;DR = chr;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_String</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* str)</span> </span>{
	<span class="hljs-keyword">uint8_t</span> i = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (str[i])<font></font>
		UART3_Send(str[i++]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_Number_Float</span><span class="hljs-params">(<span class="hljs-keyword">float</span> data)</span></span>{<font></font>
<font></font>
	<span class="hljs-keyword">char</span> str[<span class="hljs-number">100</span>];<font></font>
<font></font>
	<span class="hljs-keyword">char</span> *tmpSign = (data &lt; <span class="hljs-number">0</span>) ? <span class="hljs-string">"-"</span> : <span class="hljs-string">""</span>;
	<span class="hljs-keyword">float</span> tmpVal = (data &lt; <span class="hljs-number">0</span>) ? -data : data;<font></font>
<font></font>
	<span class="hljs-keyword">int</span> tmpInt1 = tmpVal;                  <span class="hljs-comment">// Get the integer (678).</span>
	<span class="hljs-keyword">float</span> tmpFrac = tmpVal - tmpInt1;      <span class="hljs-comment">// Get fraction (0.0123).</span>
	<span class="hljs-keyword">int</span> tmpInt2 = trunc(tmpFrac * <span class="hljs-number">10</span>);  <span class="hljs-comment">// Turn into integer (123).	int tmpInt2 = trunc(tmpFrac * 10000)</span><font></font>
<font></font>
	<span class="hljs-comment">// Print as parts, note that you need 0-padding for fractional bit.</span><font></font>
<font></font>
	<span class="hljs-built_in">sprintf</span> (str, <span class="hljs-string">"%s%d.%01d"</span>, tmpSign, tmpInt1, tmpInt2);<font></font>
<font></font>
	UART3_Send_String(str);<font></font>
}<font></font>
</code></pre><br>
6.     FreeRtos config<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*
 * FreeRTOS Kernel V10.3.1
 * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * http://www.FreeRTOS.org
 * http://aws.amazon.com/freertos
 *
 * 1 tab == 4 spaces!
 */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> FREERTOS_CONFIG_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREERTOS_CONFIG_H</span><font></font>
<font></font>
<span class="hljs-comment">/* Library includes. */</span>
<span class="hljs-comment">//#include "stm32f10x_lib.h"</span>
<span class="hljs-comment">/*-----------------------------------------------------------
 * Application specific definitions.
 *
 * These definitions should be adjusted for your particular hardware and
 * application requirements.
 *
 * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE
 * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE. 
 *
 * See http://www.freertos.org/a00110.html
 *----------------------------------------------------------*/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler		<span class="hljs-comment">// fix problem</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortPendSVHandler PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortSysTickHandler SysTick_Handler</span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_PREEMPTION		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_IDLE_HOOK			0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TICK_HOOK			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configCPU_CLOCK_HZ			( ( unsigned long ) 48000000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTICK_RATE_HZ			( ( TickType_t ) 1000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_PRIORITIES		( 5 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMINIMAL_STACK_SIZE	( ( unsigned short ) 32 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTOTAL_HEAP_SIZE		( ( size_t ) ( 17 * 1024 ) )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_TASK_NAME_LEN		( 16 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TRACE_FACILITY	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_16_BIT_TICKS		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configIDLE_SHOULD_YIELD		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_MUTEXES			1</span><font></font>
<font></font>
<span class="hljs-comment">/* Co-routine definitions. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_CO_ROUTINES 		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES ( 2 )</span><font></font>
<font></font>
<span class="hljs-comment">/* Set the following definitions to 1 to include the API function, or zero
 to exclude the API function. */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskPrioritySet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_uxTaskPriorityGet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelete				1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskCleanUpResources	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskSuspend			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelayUntil			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelay				1</span><font></font>
<font></font>
<span class="hljs-comment">/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255
 (lowest) to 0 (1?) (highest). */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configKERNEL_INTERRUPT_PRIORITY 		255</span>
<span class="hljs-comment">/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!!
 See http://www.FreeRTOS.org/RTOS-Cortex-M3-M4.html. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY 	191 <span class="hljs-comment">/* equivalent to 0xb0, or priority 11. */</span></span><font></font>
<font></font>
<span class="hljs-comment">/* This is the value being used as per the ST library which permits 16
 priority values, 0 to 15.  This must correspond to the
 configKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowest
 NVIC value of 255. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configLIBRARY_KERNEL_INTERRUPT_PRIORITY	15</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* FREERTOS_CONFIG_H */</span></span><font></font>
<font></font>
</code></pre><br>
7.    main;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"main.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//define      typedef enum :)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorLeft		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorRight		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveBack		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveForward		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MaxSpeedMotor	1000</span><font></font>
<font></font>
<span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];				<span class="hljs-comment">// Buffer DMA ADC sensors</span>
<span class="hljs-keyword">uint16_t</span> SensWhiteOrBlack[<span class="hljs-number">10</span>];		<span class="hljs-comment">// Buffer sensors white or black</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC_Init();<font></font>
	GPIO_Init();<font></font>
	TIM1_Init();<font></font>
	UART3_Init();<font></font>
	ADC_Init();<font></font>
<font></font>
	xTaskCreate(vTaskUART2, <span class="hljs-string">"UART"</span>, <span class="hljs-number">512</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
	xTaskCreate(vTaskConvADC, <span class="hljs-string">"ADC"</span>, <span class="hljs-number">128</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	UART3_Send_String(<span class="hljs-string">"Start program\r\n"</span>);<font></font>
<font></font>
	GPIOA-&gt;BSRR |= GPIO_BSRR_BS10;	<span class="hljs-comment">// Motor enable</span><font></font>
<font></font>
	vTaskStartScheduler();<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">/*************************************Tasks***************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
<span class="hljs-comment">//-------------------Read sensors from buff DMA ADC, and print to UART3-------------//</span><font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (adc_buf[i] &lt;= <span class="hljs-number">300</span>)		<span class="hljs-comment">// value sens is white</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">0</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">0</span>;<font></font>
			} <span class="hljs-keyword">else</span>						<span class="hljs-comment">// else value sens is black</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">1</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">1</span>;<font></font>
			}<font></font>
<font></font>
<span class="hljs-comment">//			UART3_Send_Number_Float(SensWhiteOrBlack[i]);</span>
<span class="hljs-comment">//			UART3_Send_String("\t");</span><font></font>
		}<font></font>
<span class="hljs-comment">///		UART3_Send_String("\r\n");</span><font></font>
<font></font>
<span class="hljs-comment">//-----------------------------------------Move-----------------------------------------//</span><font></font>
<font></font>
<font></font>
		<span class="hljs-comment">//----Normal mode----//</span>
		<span class="hljs-keyword">float</span> devMotorLeft  = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">float</span> devMotorRight = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">uint32_t</span> flagSizeBuf = <span class="hljs-number">0</span>;<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">6</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">6</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">7</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">8</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">9</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">5</span>; i &gt;= <span class="hljs-number">0</span>; i--)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span>(SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">3</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">2</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">if</span>(!flagSizeBuf)<font></font>
		{<font></font>
			devMotorLeft  = <span class="hljs-number">0</span>;<font></font>
			devMotorRight = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
<font></font>
		Motor(MotorRight, (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorRight), MoveForward);<font></font>
		Motor(MotorLeft,  (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorLeft),  MoveForward);<font></font>
<font></font>
<font></font>
<span class="hljs-comment">/*
		if (adc_buf[0] &gt; 1000)
		{
			Motor(MotorLeft, 500, MoveBack);
		}
		else if (adc_buf[0] &lt;= 1000)
		{
			Motor(MotorLeft, 0, MoveForward);
		}

		if (adc_buf[9] &gt; 1000)
		{
			Motor(MotorRight, 500, MoveBack);//Motor(0, 500, 1);	MotorRight	MoveBack
		}
		else if (adc_buf[9] &lt;= 1000)
		{
			Motor(MotorRight, 0, MoveForward);
		}
*/</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">50</span>);<font></font>
	}<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
		<span class="hljs-comment">// just void :)</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">5000</span>);<font></font>
	}<font></font>
<font></font>
}<font></font>
<span class="hljs-comment">/**********************************Function*************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS11;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR11;<font></font>
	}<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (which == <span class="hljs-number">0</span>)	<span class="hljs-comment">//Right motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\t"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR3 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">0</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BS14;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR3 = <span class="hljs-number">0</span>;<font></font>
			GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (which == <span class="hljs-number">1</span>)	<span class="hljs-comment">//left motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\r\n"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR2 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">1</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR2 = <span class="hljs-number">0</span>;<font></font>
			GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*************************************IRQ***************************************/</span>
<span class="hljs-comment">/*
 void USART2_IRQHandler(void) {

 if (USART2-&gt;SR &amp; USART_CR1_RXNEIE) {

 USART2-&gt;SR &amp;= ~USART_CR1_RXNEIE;

 if (USART2-&gt;DR == '0') {
 UART2_Send_String("OFF\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BS13;
 } else if (USART2-&gt;DR == '1') {
 UART2_Send_String("ON\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 } else if (USART2-&gt;DR == '2') {
 uint16_t d0 = ADC1-&gt;DR;
 float Vdd = 1.2 * 4069 / d0;
 UART2_Send(Vdd);
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 }
 }
 }
 */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DMA1_Channel1_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	DMA1-&gt;IFCR = DMA_IFCR_CGIF1 | DMA_IFCR_CTCIF1;	<span class="hljs-comment">// clear DMA interrupt flags</span>
	DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;					<span class="hljs-comment">//  </span>
	<span class="hljs-comment">/*
	 * Code
	 */</span>
	DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;			   <span class="hljs-comment">//  </span><font></font>
	ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talk a little bit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This project has been hanging on my plans for several years and has been put off all the time, but now it really comes to its logical conclusion, which I‚Äôm very happy to finish, I would like to make it partially open and sell it as another platform / constructor, if possible, then the sumoist‚Äôs robot is not far away, and there others will go. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were no plans to write an article, but participation in the competition requires it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I almost forgot about the photo, some components have not yet arrived, and the deadline of the competition is tomorrow so I had to use DIY not in its best performance.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robot photo</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/961/400/6f6961400a8062733354fd8ac85b41a0.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here‚Äôs a mini test video</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hk-FURUHLvc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497764/index.html">How to prepare the game for porting to PC and console</a></li>
<li><a href="../en497768/index.html">Disinfection automation</a></li>
<li><a href="../en497770/index.html">Introducing PyCaret: An Open Low-Code Python Machine Learning Library</a></li>
<li><a href="../en497772/index.html">Development at Wargaming - meeting with Maxim Baryshnikov, Head of Platform (Part II)</a></li>
<li><a href="../en497780/index.html">Three years in Latin America: how I left for a dream and returned after a total ‚Äúreset‚Äù</a></li>
<li><a href="../en497784/index.html">HiDC solution for building a modern ICT infrastructure of data centers based on Huawei Enterprise equipment</a></li>
<li><a href="../en497786/index.html">Now a shoemaker with boots, or How we got our own style guide</a></li>
<li><a href="../en497788/index.html">Top 10 Chrome Extensions for Designers</a></li>
<li><a href="../en497790/index.html">We invite you to DINS QA EVENING: talking about Postman and test coverage assessment methods</a></li>
<li><a href="../en497792/index.html">Tools of a novice stock investor: test access, start tariff, trading terminal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>