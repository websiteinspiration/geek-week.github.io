<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶🏽 😀 🧛🏾 data.tableの周り 😏 👩‍👦 🥡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="このノートは、Rのテーブルデータ処理ライブラリ-data.tableを使用するユーザーにとって興味深いものであり、さまざまな例を使用してアプリケーションの柔軟性を確認できることを嬉しく思います。同僚の
 
 良い例に触発され、すでに彼の記事を読んでいることを期待して、data.tableに基づいてコ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>data.tableの周り</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493132/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このノートは、Rのテーブルデータ処理ライブラリ-data.tableを使用するユーザーにとって興味深いものであり、さまざまな例を使用してアプリケーションの柔軟性を確認できることを嬉しく思います。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">同僚の</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
良い例に触発され、</font><font style="vertical-align: inherit;">すでに彼の記事を読んでいることを期待して、</font><b><font style="vertical-align: inherit;">data.tableに</font></b><font style="vertical-align: inherit;">基づいてコードとパフォーマンスを最適化するためにさらに掘り下げることをお勧めし</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はじめに：data.tableはどこから来たのですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し遠くから、つまりdata.tableオブジェクト（以下、DT）を取得できるデータ構造から、ライブラリを知っておくのが最善です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アレイ</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## arrays ---------</span><font></font>
<font></font>
arrmatr &lt;- array(<span class="hljs-number">1</span>:<span class="hljs-number">20</span>, c(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">typeof</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">array</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">matrix</span>(<span class="hljs-params">arrmatr</span>)

</span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの構造の1つは配列（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？Base :: array</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）です。他の言語と同様に、ここでは配列は多次元です。ただし、たとえば、2次元配列がマトリックスクラス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（？Base ::マトリックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">からプロパティを継承し始め</font><font style="vertical-align: inherit;">、重要な1次元配列がベクトル（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？ベース::ベクトル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">継承しない</font><font style="vertical-align: inherit;">ことが興味深い</font><b><font style="vertical-align: inherit;">です</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファシリティに含まれるデータのタイプは、関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベース:: typeof</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">チェックする必要があることを理解する必要があります</font><b><font style="vertical-align: inherit;">。typeof</font></b><font style="vertical-align: inherit;">は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、R</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の内部記述</font><font style="vertical-align: inherit;">-最初に生まれ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たCに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関連付けられた共通言語プロトコル</font><font style="vertical-align: inherit;">に従って、タイプの内部記述を返します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトのクラスを判別する別のコマンドは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base :: classです。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ベクトルの場合はベクトルタイプを返します（内部名とは異なりますが、データタイプを理解することもできます）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2次元配列から、それは行列</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リスト（</font><b><font style="vertical-align: inherit;">？Base :: list</font></b><font style="vertical-align: inherit;">）に移動できます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## lists ------------------</span><font></font>
<font></font>
mylist &lt;- <span class="hljs-keyword">as</span>.list(arrmatr)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.vector(mylist)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(mylist)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、いくつかのことが同時に起こります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行列の2番目の次元が縮小します。つまり、リストとベクトルの両方が取得されます。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、リストはこれらのクラスを継承します。</font><font style="vertical-align: inherit;">マトリックス配列のセルからの単一の（スカラー）値がリスト項目に対応することを覚えておく必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リストはベクトルでもあるため、ベクトルの一部の関数をリストに適用できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データフレーム</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リスト、行列、またはベクトルから、データフレームに移動できます（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？Base :: data.frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## data.frames ------------</span><font></font>
<font></font>
df &lt;- <span class="hljs-keyword">as</span>.data.frame(arrmatr)<font></font>
df2 &lt;- <span class="hljs-keyword">as</span>.data.frame(mylist)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
df$V6 &lt;- df$V1 + df$V2<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いのは、データフレームがリストから継承されていることです。</font><font style="vertical-align: inherit;">データフレームの列はリストセルです。</font><font style="vertical-align: inherit;">リストに適用される関数を使用する場合、これは将来的に重要になります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ表</font></font></h3><br><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">データフレーム</font></i><font style="vertical-align: inherit;">、リスト、ベクトル、行列</font><font style="vertical-align: inherit;">から</font><font style="vertical-align: inherit;">
DT（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？Data.table :: data.table</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を取得できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、このように（その場で）。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## data.tables -----------------------</span><font></font>
library(data.table)<font></font>
<font></font>
data.table::setDT(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.frame(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.table(df)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データフレームと同様に、DTがリストのプロパティを継承すると便利です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTとメモリ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rベースの他のすべてのオブジェクトとは異なり、DTは参照渡しされます。</font><font style="vertical-align: inherit;">新しいメモリ領域にコピーする必要がある場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data.table :: copy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">が必要か、古いオブジェクトから選択する必要があります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs">df2 &lt;- df<font></font>
<font></font>
df[V1 == <span class="hljs-number">1</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
df2 &lt;- data.table::copy(df)<font></font>
<font></font>
df[V1 == <span class="hljs-number">2</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この紹介で終わります。</font><font style="vertical-align: inherit;">DTは、Rでのデータ構造の開発の続きです。これは、主にデータフレームクラスのオブジェクトで実行される操作の拡張と加速が原因で発生します。</font><font style="vertical-align: inherit;">この場合、他のプリミティブからの継承は保持されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data.tableプロパティの使用例</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リストのように...</font></font></h3><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
言語のループコードは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よりもはるかに遅いため</font><font style="vertical-align: inherit;">、データフレームまたはDTの行を反復処理することはお勧めできません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">列を歩くとき、各列はリストアイテムであり、通常はベクトルが含まれていることに注意してください。</font><font style="vertical-align: inherit;">そして、ベクトルの操作は、言語の基本的な関数でうまくベクトル化されています。</font><font style="vertical-align: inherit;">リストとベクターに固有の選択演算子を使用することもできます：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">`[[`、 `$`</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## operations on data.tables ------------</span><font></font>
<font></font>
<span class="hljs-comment">#using list properties</span><font></font>
<font></font>
df$<span class="hljs-string">'V1'</span>[<span class="hljs-number">1</span>]<font></font>
<font></font>
df[[<span class="hljs-string">'V1'</span>]]<font></font>
<font></font>
df[[<span class="hljs-number">1</span>]][<span class="hljs-number">1</span>]<font></font>
<font></font>
sapply(df, <span class="hljs-class"><span class="hljs-keyword">class</span>)

<span class="hljs-title">sapply</span>(<span class="hljs-params">df, function(<span class="hljs-params">x</span>) sum(<span class="hljs-params">is.na(<span class="hljs-params">x</span>)</span>)</span>)
</span></code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベクトル化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大きなDTの行を通過する必要がある場合は、ベクトル化を使用して関数を作成するのが最善の解決策です。</font><font style="vertical-align: inherit;">ただし、機能しない場合は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DT </font><i><font style="vertical-align: inherit;">内の</font></i><font style="vertical-align: inherit;">サイクル</font><b><font style="vertical-align: inherit;">がC</font></b><font style="vertical-align: inherit;">で実行さ</font><b><font style="vertical-align: inherit;">れる</font></b><font style="vertical-align: inherit;">ため</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、R</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font><font style="vertical-align: inherit;">方がサイクルが速い</font><font style="vertical-align: inherit;">ことに注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
100K行のより大きな例を試してみましょう。</font><font style="vertical-align: inherit;">列ベクトル</font><b><font style="vertical-align: inherit;">wに</font></b><font style="vertical-align: inherit;">含まれる単語から最初の文字を引き出します</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">更新しました</font></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<i><font style="vertical-align: inherit;"></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs">library(magrittr)<font></font>
library(microbenchmark)<font></font>
<font></font>
<span class="hljs-comment">## Bigger example ----</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = sapply(seq_len(rown), function(x) paste(sample(letters, <span class="hljs-number">3</span>, replace = T), collapse = <span class="hljs-string">' '</span>))<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
<span class="hljs-comment"># vectorization</span><font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		, by = <span class="hljs-number">1</span>:nrow(dt)<font></font>
	   ]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># second</span><font></font>
<font></font>
first_l_f &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		do.call(rbind, .) %&gt;%<font></font>
		`[`(,<span class="hljs-number">1</span>)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># third</span><font></font>
<font></font>
first_l_f2 &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		unlist %&gt;%<font></font>
		matrix(nrow = <span class="hljs-number">3</span>) %&gt;%<font></font>
		`[`(<span class="hljs-number">1</span>,)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f2(w))<font></font>
		]<font></font>
})<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の実行は、次の行を反復します。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単位：ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [、 `：=`（first_l、unlist（strsplit（w、split = ""、fixed = T））[1]）、by = 1：nrow（dt）]} 439.6217 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 lq平均中央値uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 451.9998 460.1593 456.2505 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">460.9147</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 621.4042 100</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2回目の実行では、リストを行列に変換し、インデックス1を持つスライスの要素を取得することによってベクトル化が行われます</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（後者は実際にはベクトル化です）</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は回復します：</font><font style="vertical-align: inherit;">入力としてベクトルを取ることができる</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strsplit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数のレベルでのベクトル化</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リストを行列に変換するプロセスは、ベクトル化自体よりもはるかに難しいことがわかりますが、この場合、ベクトル化されていないバージョンよりもはるかに高速です。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単位：ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq平均中央値uq最大ネヴァル</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [、 `：=`（first_l ,.（First_l_f（w）））]} 93.07916 112.1381 161.9267 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">149.6863</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 185.9893 442.5199 100</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
加速の中央値は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3倍</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3回目の実行では、マトリックスへの変換のスキームが変更されます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単位：ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq平均中央値uq最大ネヴァル</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [、 `：=`（first_l ,.（First_l_f2（w）））]} 32.60481 34.13679 40.4544 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35.57115</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 42.11975 222.972 100</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
加速の中央値は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13倍</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたはこの問題を実験しなければなりません、より多く-より良いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストもあるが、実際の条件に近いベクトル化のもう1つの例：単語の長さ、単語数が異なる。</font><font style="vertical-align: inherit;">最初の3ワードを取得する必要があります。</font><font style="vertical-align: inherit;">このように：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i_/sp/y_/i_spy_ok37lu1k5f6syb7db8kw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ベクトルの長さが異なるため、前の関数は機能しません。行列のサイズを設定します。</font><font style="vertical-align: inherit;">インターネットを掘り下げてこれをやり直してください。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># fourth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
first_l_f3 &lt;- function(sd, n)<font></font>
{<font></font>
	l &lt;- strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T)<font></font>
	<font></font>
	maxl &lt;- max(lengths(l))<font></font>
	<font></font>
	sapply(l, <span class="hljs-string">"length&lt;-"</span>, maxl) %&gt;%<font></font>
		`[`(n,) %&gt;%<font></font>
		<span class="hljs-keyword">as</span>.character<font></font>
}<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
		]<font></font>
})<font></font>
<font></font>
dt[<font></font>
	, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
	]<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単位：ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq平均中央値</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{dt [、 `：=`（（paste0（ "w_"、1：3））、strsplit（w、split = ""、fixed = T））]} 851.7623 916.071 1054.5 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1035.199</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
 uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1178.738 1356.816 100</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトは平均1秒の速度で実行されました。</font><font style="vertical-align: inherit;">悪くない。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のより経済的な方法が見つかりました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カブラグ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># fifth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
microbenchmark({<font></font>
	<font></font>
	w_split &lt;- dt[<font></font>
		, data.table::tstrsplit(w, split = <span class="hljs-string">' '</span>, fixed = T, keep = <span class="hljs-number">1L</span>:<span class="hljs-number">3L</span>)<font></font>
		]<font></font>
	<font></font>
	dt[<font></font>
		, `:=` (<font></font>
			w_1 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">1</span>]])<font></font>
			, w_2 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">2</span>]])<font></font>
			, w_3 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">3</span>]])<font></font>
		)<font></font>
		]<font></font>
<font></font>
})<font></font>
</code></pre><br>
</div></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央値186、5倍安い...</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1本のチェーンでつながって......</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェーンを使用してDTオブジェクトを操作できます。</font><font style="vertical-align: inherit;">括弧の構文を右側にフックしているように見えます。実際には、砂糖です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># chaining</span><font></font>
<font></font>
res1 &lt;- dt[a == <span class="hljs-string">'a'</span>][sample(.N, <span class="hljs-number">100</span>)]<font></font>
<font></font>
res2 &lt;- dt[, .N, a][, N]<font></font>
<font></font>
res3 &lt;- dt[, coefficients(lm(e ~ d))[<span class="hljs-number">1</span>], a][, .(letter = a, coef = V1)]<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイプを流れる...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DTだけでなく任意のメソッドを使用できるため、同じ操作をパイピングでも実行できます。見た目は似ていますが、機能は豊富です。</font><font style="vertical-align: inherit;">ディーゼル燃料にいくつかのフィルターを使用して、合成データのロジスティック回帰係数を導出します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># piping</span><font></font>
<font></font>
samplpe_b &lt;- dt[a %<span class="hljs-keyword">in</span>% head(letters), sample(b, <span class="hljs-number">1</span>)]<font></font>
<font></font>
res4 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[a %<span class="hljs-keyword">in</span>% head(letters)] %&gt;%<font></font>
	.[, <font></font>
	  {<font></font>
	  	dt0 &lt;- .SD[<span class="hljs-number">1</span>:<span class="hljs-number">100</span>]<font></font>
	  	<font></font>
	  	quants &lt;- <font></font>
	  		dt0[, c] %&gt;%<font></font>
	  		quantile(seq(<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>), na.rm = T)<font></font>
	  	<font></font>
	  	.(q = quants)<font></font>
	  }<font></font>
	  , .(cond = b &gt; samplpe_b)<font></font>
	  ] %&gt;%<font></font>
	glm(<font></font>
		cond ~ q <span class="hljs-number">-1</span>
		, family = binomial(link = <span class="hljs-string">"logit"</span>)<font></font>
		, data = .<font></font>
	) %&gt;%<font></font>
	summary %&gt;%<font></font>
	.[[<span class="hljs-number">12</span>]]
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DT内の統計、機械学習など</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラムダ関数を使用できますが、それらを個別に作成し、データ分析パイプライン全体を登録してから、DT内で機能する方が良い場合があります。</font><font style="vertical-align: inherit;">この例は、上記のすべての機能に加えて、DTアーセナルからのいくつかの便利なもの（参照によってDT内のDT自体にアクセスするなど、順番に挿入されないこともあります）で強化されています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># function</span><font></font>
<font></font>
rm(lm_preds)<font></font>
<font></font>
lm_preds &lt;- function(<font></font>
	sd, by, n<font></font>
)<font></font>
{<font></font>
	<font></font>
	<span class="hljs-keyword">if</span>(<font></font>
		n &lt; <span class="hljs-number">100</span> | <font></font>
		!by[[<span class="hljs-string">'a'</span>]] %<span class="hljs-keyword">in</span>% head(letters, <span class="hljs-number">4</span>)<font></font>
	   )<font></font>
	{<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = NA<font></font>
				, mean = NA<font></font>
				, high = NA<font></font>
				, coefs = NA<font></font>
			)<font></font>
		<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
		lmm &lt;- <font></font>
			lm(<font></font>
				d ~ c + b<font></font>
				, data = sd<font></font>
			)<font></font>
		<font></font>
		preds &lt;- <font></font>
			stats::predict.lm(<font></font>
				lmm<font></font>
				, sd<font></font>
				, interval = <span class="hljs-string">"prediction"</span><font></font>
				)<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = preds[, <span class="hljs-number">2</span>]<font></font>
				, mean = preds[, <span class="hljs-number">1</span>]<font></font>
				, high = preds[, <span class="hljs-number">3</span>]<font></font>
				, coefs = coefficients(lmm)<font></font>
			)<font></font>
	}<font></font>
<font></font>
	res<font></font>
	<font></font>
}<font></font>
<font></font>
res5 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[e &lt; <span class="hljs-number">0</span>] %&gt;%<font></font>
	.[.[, .I[b &gt; <span class="hljs-number">0</span>]]] %&gt;%<font></font>
	.[, `:=` (<font></font>
		low = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">1</span>]])<font></font>
		, mean = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">2</span>]])<font></font>
		, high = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">3</span>]])<font></font>
		, coef_c = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">1</span>])<font></font>
		, coef_b = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">2</span>])<font></font>
		, coef_int = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">3</span>])<font></font>
	)<font></font>
	, a<font></font>
	] %&gt;%<font></font>
	.[!<span class="hljs-keyword">is</span>.na(mean), -<span class="hljs-string">'e'</span>, <span class="hljs-keyword">with</span> = F]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># plot</span><font></font>
<font></font>
plo &lt;- <font></font>
	res5 %&gt;%<font></font>
	ggplot +<font></font>
	facet_wrap(~ a) +<font></font>
	geom_ribbon(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, ymin = low<font></font>
			, ymax = high<font></font>
			, fill = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">0.1</span>
		, alpha = <span class="hljs-number">0.1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = mean<font></font>
			, color = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = d<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span>
		, color = <span class="hljs-string">'black'</span><font></font>
	) +<font></font>
	theme_minimal()<font></font>
<font></font>
print(plo)<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rクラスからの継承に関連するプロパティから始まり、独自のチップと整頓された要素からの環境で終わるdata.tableのようなオブジェクトの完全な、しかしもちろん、完全ではない画像を作成できたことを願っています。</font><font style="vertical-align: inherit;">これがあなたがこのライブラリをよりよく学び、仕事と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">楽しみの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ために使用するのに役立つことを願っています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fh/xl/km/fhxlkmndxsdm4gcfyiymozut1vg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感謝！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なコード</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## load libs ----------------</span><font></font>
<font></font>
library(data.table)<font></font>
library(ggplot2)<font></font>
library(magrittr)<font></font>
library(microbenchmark)<font></font>
<font></font>
<font></font>
<span class="hljs-comment">## arrays ---------</span><font></font>
<font></font>
arrmatr &lt;- array(<span class="hljs-number">1</span>:<span class="hljs-number">20</span>, c(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">typeof</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">array</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">matrix</span>(<span class="hljs-params">arrmatr</span>)


## <span class="hljs-title">lists</span> ------------------

<span class="hljs-title">mylist</span> &lt;- <span class="hljs-title">as</span>.<span class="hljs-title">list</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">vector</span>(<span class="hljs-params">mylist</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">list</span>(<span class="hljs-params">mylist</span>)


## <span class="hljs-title">data</span>.<span class="hljs-title">frames</span> ------------

<span class="hljs-title">df</span> &lt;- <span class="hljs-title">as</span>.<span class="hljs-title">data</span>.<span class="hljs-title">frame</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">list</span>(<span class="hljs-params">df</span>)

<span class="hljs-title">df</span>$<span class="hljs-title">V6</span> &lt;- <span class="hljs-title">df</span>$<span class="hljs-title">V1</span> + <span class="hljs-title">df</span>$<span class="hljs-title">V2</span>


## <span class="hljs-title">data</span>.<span class="hljs-title">tables</span> -----------------------

<span class="hljs-title">data</span>.<span class="hljs-title">table</span>:</span>:setDT(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.frame(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.table(df)<font></font>
<font></font>
df2 &lt;- df<font></font>
<font></font>
df[V1 == <span class="hljs-number">1</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
df2 &lt;- data.table::copy(df)<font></font>
<font></font>
df[V1 == <span class="hljs-number">2</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
<font></font>
<span class="hljs-comment">## operations on data.tables ------------</span><font></font>
<font></font>
<span class="hljs-comment">#using list properties</span><font></font>
<font></font>
df$<span class="hljs-string">'V1'</span>[<span class="hljs-number">1</span>]<font></font>
<font></font>
df[[<span class="hljs-string">'V1'</span>]]<font></font>
<font></font>
df[[<span class="hljs-number">1</span>]][<span class="hljs-number">1</span>]<font></font>
<font></font>
sapply(df, <span class="hljs-class"><span class="hljs-keyword">class</span>)

<span class="hljs-title">sapply</span>(<span class="hljs-params">df, function(<span class="hljs-params">x</span>) sum(<span class="hljs-params">is.na(<span class="hljs-params">x</span>)</span>)</span>)


## <span class="hljs-title">Bigger</span> <span class="hljs-title">example</span> ----

<span class="hljs-title">rown</span> &lt;- 100000

<span class="hljs-title">dt</span> &lt;- 
	<span class="hljs-title">data</span>.<span class="hljs-title">table</span>(<span class="hljs-params">
		w = sapply(<span class="hljs-params">seq_len(<span class="hljs-params">rown</span>), function(<span class="hljs-params">x</span>) paste(<span class="hljs-params">sample(<span class="hljs-params">letters, <span class="hljs-number">3</span>, replace = T</span>), collapse = <span class="hljs-string">' '</span></span>)</span>)
		, a = sample(<span class="hljs-params">letters, rown, replace = T</span>)
		, b = runif(<span class="hljs-params">rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span></span>)
		, c = runif(<span class="hljs-params">rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span></span>)
		, e = rnorm(<span class="hljs-params">rown</span>)
	</span>) %&gt;%
	.[, <span class="hljs-title">d</span> :</span>= <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
<span class="hljs-comment"># vectorization</span><font></font>
<font></font>
<span class="hljs-comment"># zero - for loop</span><font></font>
<font></font>
microbenchmark({<font></font>
	<span class="hljs-keyword">for</span>(i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nrow(dt))<font></font>
		{<font></font>
		dt[<font></font>
			i<font></font>
			, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		]<font></font>
	}<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># first</span><font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		, by = <span class="hljs-number">1</span>:nrow(dt)<font></font>
	   ]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># second</span><font></font>
<font></font>
first_l_f &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		do.call(rbind, .) %&gt;%<font></font>
		`[`(,<span class="hljs-number">1</span>)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># third</span><font></font>
<font></font>
first_l_f2 &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		unlist %&gt;%<font></font>
		matrix(nrow = <span class="hljs-number">3</span>) %&gt;%<font></font>
		`[`(<span class="hljs-number">1</span>,)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f2(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># fourth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
first_l_f3 &lt;- function(sd, n)<font></font>
{<font></font>
	l &lt;- strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T)<font></font>
	<font></font>
	maxl &lt;- max(lengths(l))<font></font>
	<font></font>
	sapply(l, <span class="hljs-string">"length&lt;-"</span>, maxl) %&gt;%<font></font>
		`[`(n,) %&gt;%<font></font>
		<span class="hljs-keyword">as</span>.character<font></font>
}<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
		]<font></font>
})<font></font>
<font></font>
dt[<font></font>
	, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
	]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># chaining</span><font></font>
<font></font>
res1 &lt;- dt[a == <span class="hljs-string">'a'</span>][sample(.N, <span class="hljs-number">100</span>)]<font></font>
<font></font>
res2 &lt;- dt[, .N, a][, N]<font></font>
<font></font>
res3 &lt;- dt[, coefficients(lm(e ~ d))[<span class="hljs-number">1</span>], a][, .(letter = a, coef = V1)]<font></font>
<font></font>
<span class="hljs-comment"># piping</span><font></font>
<font></font>
samplpe_b &lt;- dt[a %<span class="hljs-keyword">in</span>% head(letters), sample(b, <span class="hljs-number">1</span>)]<font></font>
<font></font>
res4 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[a %<span class="hljs-keyword">in</span>% head(letters)] %&gt;%<font></font>
	.[, <font></font>
	  {<font></font>
	  	dt0 &lt;- .SD[<span class="hljs-number">1</span>:<span class="hljs-number">100</span>]<font></font>
	  	<font></font>
	  	quants &lt;- <font></font>
	  		dt0[, c] %&gt;%<font></font>
	  		quantile(seq(<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>), na.rm = T)<font></font>
	  	<font></font>
	  	.(q = quants)<font></font>
	  }<font></font>
	  , .(cond = b &gt; samplpe_b)<font></font>
	  ] %&gt;%<font></font>
	glm(<font></font>
		cond ~ q <span class="hljs-number">-1</span>
		, family = binomial(link = <span class="hljs-string">"logit"</span>)<font></font>
		, data = .<font></font>
	) %&gt;%<font></font>
	summary %&gt;%<font></font>
	.[[<span class="hljs-number">12</span>]]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># function</span><font></font>
<font></font>
rm(lm_preds)<font></font>
<font></font>
lm_preds &lt;- function(<font></font>
	sd, by, n<font></font>
)<font></font>
{<font></font>
	<font></font>
	<span class="hljs-keyword">if</span>(<font></font>
		n &lt; <span class="hljs-number">100</span> | <font></font>
		!by[[<span class="hljs-string">'a'</span>]] %<span class="hljs-keyword">in</span>% head(letters, <span class="hljs-number">4</span>)<font></font>
	   )<font></font>
	{<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = NA<font></font>
				, mean = NA<font></font>
				, high = NA<font></font>
				, coefs = NA<font></font>
			)<font></font>
		<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
		lmm &lt;- <font></font>
			lm(<font></font>
				d ~ c + b<font></font>
				, data = sd<font></font>
			)<font></font>
		<font></font>
		preds &lt;- <font></font>
			stats::predict.lm(<font></font>
				lmm<font></font>
				, sd<font></font>
				, interval = <span class="hljs-string">"prediction"</span><font></font>
				)<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = preds[, <span class="hljs-number">2</span>]<font></font>
				, mean = preds[, <span class="hljs-number">1</span>]<font></font>
				, high = preds[, <span class="hljs-number">3</span>]<font></font>
				, coefs = coefficients(lmm)<font></font>
			)<font></font>
	}<font></font>
<font></font>
	res<font></font>
	<font></font>
}<font></font>
<font></font>
res5 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[e &lt; <span class="hljs-number">0</span>] %&gt;%<font></font>
	.[.[, .I[b &gt; <span class="hljs-number">0</span>]]] %&gt;%<font></font>
	.[, `:=` (<font></font>
		low = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">1</span>]])<font></font>
		, mean = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">2</span>]])<font></font>
		, high = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">3</span>]])<font></font>
		, coef_c = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">1</span>])<font></font>
		, coef_b = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">2</span>])<font></font>
		, coef_int = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">3</span>])<font></font>
	)<font></font>
	, a<font></font>
	] %&gt;%<font></font>
	.[!<span class="hljs-keyword">is</span>.na(mean), -<span class="hljs-string">'e'</span>, <span class="hljs-keyword">with</span> = F]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># plot</span><font></font>
<font></font>
plo &lt;- <font></font>
	res5 %&gt;%<font></font>
	ggplot +<font></font>
	facet_wrap(~ a) +<font></font>
	geom_ribbon(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, ymin = low<font></font>
			, ymax = high<font></font>
			, fill = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">0.1</span>
		, alpha = <span class="hljs-number">0.1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = mean<font></font>
			, color = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = d<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span>
		, color = <span class="hljs-string">'black'</span><font></font>
	) +<font></font>
	theme_minimal()<font></font>
<font></font>
print(plo)<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja493118/index.html">メモリタグ拡張機能の概要（Armv8.5-A）</a></li>
<li><a href="../ja493122/index.html">バンザイゲームオフィス：モスクワの中心にある日本</a></li>
<li><a href="../ja493124/index.html">日曜大工のベアメタルプロビジョニング、またはゼロからの自動サーバー準備</a></li>
<li><a href="../ja493126/index.html">イベント指向アーキテクチャーのアンチパターン</a></li>
<li><a href="../ja493130/index.html">コロナウイルスを恐れるべきではない理由：神話とCOVID-2019に関するほとんどの真実</a></li>
<li><a href="../ja493136/index.html">Unity StorageのFAST VP：仕組み</a></li>
<li><a href="../ja493138/index.html">私に話しかけてください：今日、音声ボットができること</a></li>
<li><a href="../ja493140/index.html">シポッリーノの冒険：FlantによるITクエストの隔離</a></li>
<li><a href="../ja493142/index.html">「Kubernetesを使いましょう！」8つの問題があります</a></li>
<li><a href="../ja493146/index.html">今日できるエキサイティングなサイドプロジェクト</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>