<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÜ üò≠ üë©üèæ‚Äçüíª How we learned to recommend films and why you shouldn‚Äôt rely only on ratings üë¶ üòæ üíÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine that you want to spend the evening watching a movie, but don‚Äôt know which one to choose. Yandex users often find themselves in the same situat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How we learned to recommend films and why you shouldn‚Äôt rely only on ratings</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/497390/"><img src="https://habrastorage.org/webt/vu/_4/oo/vu_4oolbpa8pde7nsycpg5vpokq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that you want to spend the evening watching a movie, but don‚Äôt know which one to choose. Yandex users often find themselves in the same situation, so our team develops recommendations that can be found on Search and Air. It would seem that this is complicated: we take user ratings, with their help we train the car to find films that are likely to give 5 points, we get a ready-made list of films. But this approach does not work. Why? That's what I‚Äôll tell you about today.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A bit of history. Back in 2006, Netflix launched the Netflix Prize machine learning contest. If you suddenly forgot, then the company has not yet been streaming on the Internet, but rented films on DVD. But even then, it was important for her to predict the user's rating in order to recommend something to him. So, the essence of the competition: to predict viewers ‚Äôratings is 10% better (according to the RMSE metric) than Cinematch, the Netflix recommendation system. This was one of the first mass competitions of this kind. Interest heated up a huge dataset (more than 100 million ratings), as well as a prize of $ 1 million.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The competition ended in 2009. </font><font style="vertical-align: inherit;">The teams of BellKor's Pragmatic Chaos and The Ensemble reached the finish line with the same result (RMSE = 0.8567), but The Ensemble took second place because they sent the solution 20 minutes later than the competitors. </font><font style="vertical-align: inherit;">Results and work can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But the most interesting thing is different. </font><font style="vertical-align: inherit;">If you believe the repeated stories at specialized conferences, the winning algorithms did not appear in production in the video streaming service that was launched soon. </font><font style="vertical-align: inherit;">I can‚Äôt talk about the reasons for other people's decisions, but I‚Äôll tell you why we did the same.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personal rating</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For quite some time now, Yandex users can rate movies they‚Äôve watched. And not only at KinoPoisk, but also in the search results. Over time, we have accumulated hundreds of millions of estimates of tens of millions of people. At some point, we decided to use this data to help users understand how much they would like a movie. In fact, we solved the same problem as at the Netflix Prize contest, that is, we predicted what rating the user would give the film. At that time, KinoPoisk and IMDB ratings already existed, which were built on the basis of people's ratings. We built a personal rating, so we decided to use a separate scale as a percentage in order to avoid visual similarities and confusion.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/tk/h7/ddtkh7i3ud_9q5lmqtvw-4ambgc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, the need to correlate the point scale and the percentage is a separate, unobvious headache, so I will briefly talk about it. </font><font style="vertical-align: inherit;">It would seem that for a 10-point scale, take 10% for each point - and the point is in the hat. </font><font style="vertical-align: inherit;">But no. </font><font style="vertical-align: inherit;">The reason is psychology and habits. </font><font style="vertical-align: inherit;">For example, from the point of view of users, a rating of 8/10 is much better than 80%. </font><font style="vertical-align: inherit;">How to correlate this? </font><font style="vertical-align: inherit;">With crowdsourcing! </font><font style="vertical-align: inherit;">And so we did: we launched the task in Tolok, in which the shooters described the expectations of films with a certain score or percentage of personal rating. </font><font style="vertical-align: inherit;">Based on this markup, we selected a function that translates the prediction of the score from point to percentage so that user expectations are maintained.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sample quests in Tolok</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/fv/ux/twfvuxxkjd7rnkave0yuudmzs5q.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Predicting expectations from the movie is useful, but it would be nice to build recommendations as well. </font><font style="vertical-align: inherit;">That is, immediately show the person a list of good films. </font><font style="vertical-align: inherit;">At that moment, many of you might think: ‚ÄúAnd let's just sort the films that the user has not watched by personal rating.‚Äù </font><font style="vertical-align: inherit;">We thought so too at first. </font><font style="vertical-align: inherit;">But then I had to solve two problems.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tool problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a user searches for a particular movie (or wants to rent a specific DVD), the service must predict the rating of this particular movie. Exactly this problem was solved at the Netflix Prize contest, where the RMSE metric was used. But the recommendations solve a different problem: you need not to guess the grade, but to find a movie that will eventually be watched. And the RMSE metric does a poor job of this. For example, the penalty for predicting a rating of 2 instead of 1 is exactly the same as for 5 instead of 4. But our system should never recommend movies to which the user puts 2! List-based metrics are much more suitable for this task, such as Precision @ K, Recall @ K, MRR, or NDCG. I can‚Äôt help but tell you a little more about them (but if you are not interested in the metrics, just skip the next paragraph). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the metric.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MRR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mean reciprocal rank). We will look at what position in the ranking will be the film with which the user interacted (for example, watched or praised) in the test period. The MRR metric is the user-averaged reverse position of such a movie. I.e</font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>M</mi><mi>R</mi><mi>R</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>U</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>U</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></munderover><mfrac><mn>1</mn><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>u</mi></msub></mrow></mfrac></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.7ex" height="4.259ex" viewBox="0 -1132.2 10204.2 1833.9" role="img" focusable="false" style="vertical-align: -1.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-4D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-52" x="1051" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-52" x="1811" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-3D" x="2848" y="0"></use><g transform="translate(3626,0)"><g transform="translate(397,0)"><rect stroke="none" width="1056" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="496" y="582"></use><g transform="translate(60,-442)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-55" x="278" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="1046" y="0"></use></g></g></g><g transform="translate(5367,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJSZ1-2211" x="0" y="0"></use><g transform="translate(1056,521)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-55" x="278" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="1046" y="0"></use></g><g transform="translate(1056,-308)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-75" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-3D" x="572" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="1351" y="0"></use></g></g><g transform="translate(7833,0)"><g transform="translate(286,0)"><rect stroke="none" width="1964" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="1138" y="582"></use><g transform="translate(60,-403)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-72" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-61" x="451" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6E" x="981" y="0"></use><g transform="translate(1118,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-75" x="737" y="-213"></use></g></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>M</mi><mi>R</mi><mi>R</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>U</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow></mfrac><munderover><mo>‚àë</mo><mrow class="MJX-TeXAtom-ORD"><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>U</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow></munderover><mfrac><mn>1</mn><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>u</mi></msub></mrow></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-1">MRR = \frac{1}{|U|} \sum_{u=1}^{|U|} \frac{1}{rank_u}</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Such a metric, unlike RMSE, evaluates the entire list, but, unfortunately, looks only at the first guessed element. However, it is easy to modify the metric to get rid of this drawback. We can calculate the sum of the reverse positions of all the films with which the user interacted. This metric is called Average Reciprocal Hit Rank. This metric takes into account all the guessed films in the issue. Note that the position k in the payout receives a weight of 1 / k for a guessed movie and a weight of 0 for another movie. Often, 1 / log (k) is used instead of 1 / k: this is more likely to correspond with the probability that the user will scroll to the k position. The result is a DCG metric (discounted cumulative gain)</font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi><mi>C</mi><mi>G</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>U</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>U</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></munderover><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>p</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><mfrac><mrow><mi>g</mi><mi>a</mi><mi>i</mi><msub><mi>n</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><mrow><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>,</mo><mi>log</mi><mo>&amp;#x2061;</mo><mo stretchy=&quot;false&quot;>(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></mrow></mfrac></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="37.927ex" height="4.384ex" viewBox="0 -1186 16329.6 1887.7" role="img" focusable="false" style="vertical-align: -1.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-44" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-43" x="828" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-47" x="1589" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-3D" x="2653" y="0"></use><g transform="translate(3431,0)"><g transform="translate(397,0)"><rect stroke="none" width="1056" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="496" y="582"></use><g transform="translate(60,-442)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-55" x="278" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="1046" y="0"></use></g></g></g><g transform="translate(5172,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJSZ1-2211" x="0" y="0"></use><g transform="translate(1056,521)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-55" x="278" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-7C" x="1046" y="0"></use></g><g transform="translate(1056,-308)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-75" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-3D" x="572" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="1351" y="0"></use></g></g><g transform="translate(7805,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJSZ1-2211" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-4E" x="1494" y="675"></use><g transform="translate(1056,-287)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6F" x="503" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-73" x="989" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-3D" x="1458" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="2237" y="0"></use></g></g><g transform="translate(10897,0)"><g transform="translate(286,0)"><rect stroke="none" width="5025" height="60" x="0" y="220"></rect><g transform="translate(1421,614)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-61" x="480" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-69" x="1010" y="0"></use><g transform="translate(958,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6E" x="0" y="0"></use><g transform="translate(424,-107)"><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6F" x="503" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-73" x="989" y="0"></use></g></g></g><g transform="translate(60,-442)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-6D"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-61" x="833" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-78" x="1334" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-28" x="1862" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-31" x="2252" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-2C" x="2752" y="0"></use><g transform="translate(2143,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-6C"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-6F" x="278" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-67" x="779" y="0"></use></g><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-28" x="4310" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-70" x="4700" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-6F" x="5203" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMATHI-73" x="5689" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-29" x="6158" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/yandex/blog/497390/&amp;usg=ALkJrhjrs1IYFthoiq6pNewdWH1miv4P4w#MJMAIN-29" x="6548" y="0"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>D</mi><mi>C</mi><mi>G</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>U</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow></mfrac><munderover><mo>‚àë</mo><mrow class="MJX-TeXAtom-ORD"><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>U</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow></munderover><munderover><mo>‚àë</mo><mrow class="MJX-TeXAtom-ORD"><mi>p</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>N</mi></mrow></munderover><mfrac><mrow><mi>g</mi><mi>a</mi><mi>i</mi><msub><mi>n</mi><mrow class="MJX-TeXAtom-ORD"><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><mrow><mo movablelimits="true" form="prefix">max</mo><mo stretchy="false">(</mo><mn>1</mn><mo>,</mo><mi>log</mi><mo>‚Å°</mo><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-2">DCG = \frac{1}{|U|} \sum_{u=1}^{|U|} \sum_{pos=1}^{N} \frac{gain_{pos}}{\max(1, \log(pos))}</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But the contribution of different users to the metric is different: for someone we guessed all the films, for someone we did not guess anything. </font><font style="vertical-align: inherit;">Therefore, as a rule, this metric is normalized. </font><font style="vertical-align: inherit;">Divide each user's DCG into the best ranking DCG for that user. </font><font style="vertical-align: inherit;">The resulting metric is called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDCG</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (normalized discounted cumulative gain). </font><font style="vertical-align: inherit;">It is widely used to assess the quality of ranking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, each task has its own metric. </font><font style="vertical-align: inherit;">But the next problem is not so obvious.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem of choice</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's hard enough to describe, but I'll try. It turns out that people give high marks not to the films that they </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usually</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> watch. Rare movie masterpieces, classics, arthouse get the highest marks, but this does not stop people in the evening after work with pleasure to watch a good comedy, a new action movie or a spectacular space opera. Add to this that users on Yandex did not appreciate all the films that they had once and somewhere watched. And if we focus only on the highest ratings, then we run the risk of getting a recommended movie feed that will look logical, users may even recognize its quality, but in the end they won't watch anything.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, this is how my movie feed might look like if we ranged it by personal rating and did not know anything about my views in the past. Great movies. But I don‚Äôt want to review them today.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5y/gz/ot/5ygzotyougvrodtwyb_nlbp03va.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that in the conditions of scattered ratings and a shortage of films with high ratings, it‚Äôs worth looking not only at the rating. Well, then we train the car to predict the viewing of the recommended film, and not the rating. It would seem logical, because the user wants this. What could go wrong? The problem is that the tape will be filled with films, each of which is quite suitable for an easy pastime in the evening, but their personal rating will be low. Users, of course, will pay attention to the fact that there are no ‚Äúmasterpieces‚Äù in the tape, which means that the credibility of the recommendations will be undermined, they will not watch what they would otherwise see. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we came to the understanding that a balance between the two extremes is needed. It is necessary to train the machine so that both the potential for viewing and the perception of the recommendation by a person are taken into account.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How our recommendations work</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our system is part of the Search, so we need to build recommendations very quickly: the response time of the service should be less than 100 milliseconds. </font><font style="vertical-align: inherit;">Therefore, we try to perform as many heavy operations as possible offline, at the stage of data preparation. </font><font style="vertical-align: inherit;">All films and users in the recommendation system are represented by profiles (it is important not to be confused with the account), which include object keys, counters and embeddings (in other words, vectors in a certain space). </font><font style="vertical-align: inherit;">Profiles of films are prepared every day on YT ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read as ‚ÄúYt‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and loaded into the RAM of machines that respond to requests. </font><font style="vertical-align: inherit;">But with users, everything is a little more complicated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every day we also build the main user profile on YT and send it to the Yandex store, from which you can get the profile in a couple of tens of milliseconds. But the data quickly becomes outdated if a person actively watches and evaluates the video. It is not good if the recommendations start to lag. Therefore, we read the stream of user events and form the dynamic part of the profile. When a person enters a request, we combine the profile from the repository with a dynamic profile and get a single profile, which can lag behind reality for only a few seconds.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This happens offline (that is, in advance), and now we go directly to runtime. Here the recommendation system consists of two steps. Ranking the entire database of films is too long, so at the first step we simply select several hundred candidates, that is, we find films that may be of interest to the viewer. This includes both popular paintings and those close to the user in some embeddings. There are several algorithms for quickly finding the nearest neighbors, we use HNSW (Hierarchical Navigable Small World). With it, we find the movies closest to the user in just a few milliseconds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the second step, we extract features (sometimes they are also called factors) by movies, user and user / movie pair and rank candidates using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CatBoost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Let me remind you: we already realized that we need to focus not only on views, but also on other quality characteristics of recommendations, so for ranking we came to a combination of several CatBoost models trained for various targets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To find candidates, we use embeddings from several matrix decompositions: from the classic version of ALS, which predicts assessment, to more complex variations based on SVD ++. </font><font style="vertical-align: inherit;">As features for ranking, both simple user event counters and films, CTRs for various events, as well as more complex pre-trained models are used. </font><font style="vertical-align: inherit;">For example, ALS prediction also acts as a feature. </font><font style="vertical-align: inherit;">One of the most useful models is the Recommender DSSM neural network, which I will probably talk about a little more.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommender DSSM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DSSM is a two-tower neural network. Each tower builds its own embedding, then the cosine distance is considered between the embeddings, this number is the network output. That is, the network learns to evaluate the proximity of objects in the left and right towers. Similar neural networks are used, for example, in a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web search</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to find documents relevant to a query. For the search task, a request is sent to one of the towers, and a document to the other. For our network, the role of the request is played by the user, and films act as documents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The tower of the film builds embedding based on the data about the film: this is the title, description, genre, country, actors, etc. This part of the network is quite similar to the search one. However, for the viewer we want to use his story. To do this, we aggregate the embedding of films from the story with the fade in time since the moment of the event. Then, on top of the total embedding, we apply several layers of the network and as a result we get an embedding of size 400.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lt/3k/v0/lt3kv0xtsbzqiyxq_333j3sgkua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you immediately take into account the entire history of the user in embedding, this will greatly slow down the training. </font><font style="vertical-align: inherit;">Therefore, we go to the trick and learn the network in two stages. </font><font style="vertical-align: inherit;">First, learn the simpler InnerDSSM. </font><font style="vertical-align: inherit;">At the entrance, he receives only the last 50 events from the user's history without dividing into event types (views, ratings ...). </font><font style="vertical-align: inherit;">Then we retrain the resulting InnerDSSM throughout the user's history, but with a breakdown into event types. </font><font style="vertical-align: inherit;">So we get OuterDSSM, which is used in runtime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using a runtime network in the forehead requires quite a lot of computing resources. </font><font style="vertical-align: inherit;">Therefore, we save embeddings from the movie tower in the database, and embeddings according to user history are updated near real-time. </font><font style="vertical-align: inherit;">Thus, during the processing of the request, you need to apply only a small part of OuterDSSM and calculate the cosines, this does not take much time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now our recommendations are already available in our search (for example, by request </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[what to see]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), in the Yandex.Air service, and an adapted version of this technology is also used in Yandex.Stations. </font><font style="vertical-align: inherit;">But this does not mean that we can relax. </font><font style="vertical-align: inherit;">We constantly train new models, apply more and more data, try new approaches to training and new quality metrics. </font><font style="vertical-align: inherit;">In my opinion, the older the area, the more difficult it is to develop. </font><font style="vertical-align: inherit;">But this is the main interest for specialists.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497376/index.html">What to do with red cheeks so that your nose does not grow</a></li>
<li><a href="../en497382/index.html">8 difficulties of Agile teams during the pandemic: ‚ÄúNdagwurugwu nke anya mmiri‚Äù, ·ª•j·ªç, oke iwe, ag·ªçnar, COVID-19</a></li>
<li><a href="../en497384/index.html">How to establish secure access to servers in remote mode</a></li>
<li><a href="../en497386/index.html">VK Fellowship fellows talk about the future of distance learning, discipline and socialization</a></li>
<li><a href="../en497388/index.html">A millionth shooter from scratch: an indie developer path</a></li>
<li><a href="../en497392/index.html">How to grow from a student a software engineer?</a></li>
<li><a href="../en497394/index.html">Ten Resources with Computer Science Courses Available for Free in April</a></li>
<li><a href="../en497396/index.html">Colleagues: neither friend nor foe, but how?</a></li>
<li><a href="../en497398/index.html">AMD EPYC Rome 7x32 Server Processors - Record Single Core Performance</a></li>
<li><a href="../en497402/index.html">How to create a Python programming language?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>