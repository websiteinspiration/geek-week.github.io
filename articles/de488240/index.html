<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕠 🚙 👼🏻 Ein endloser Kreislauf, der nicht war: die Geschichte des Heiligen Grals 🚙 👨‍👩‍👦 💊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es war einmal ein Spiel für GBA namens Hello Kitty Collection: Miracle Fashion Maker. Es war ein süßes Spiel, das auf dem berühmten Sanrio Hello Kitty...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ein endloser Kreislauf, der nicht war: die Geschichte des Heiligen Grals</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488240/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es war einmal ein Spiel für GBA namens Hello Kitty Collection: Miracle Fashion Maker. Es war ein süßes Spiel, das auf dem berühmten Sanrio Hello Kitty-Franchise basiert und von Imagineer entwickelt wurde. Aber unter dem Deckmantel eines scheinbar unschuldigen Namens war dies ein heimtückisches Problem. Aus irgendeinem Grund lief dieses einfache Spiel auf keinem GBA-Emulator. Dies allein würde jedoch nicht ausreichen, um das Problem als Fehler des Heiligen Grals zu bezeichnen. Wie alle Käfer des Heiligen Grals war dieser Käfer selbst völlig verwirrend. Die Erklärung war einfach: Irgendwann in der Startsequenz des Spiels fiel es in einen Zyklus, aus dem es nie </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herauskam</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , und wartete darauf, dass ein bestimmter Wert aus einem Speicher gelesen wurde, den </font><em><font style="vertical-align: inherit;">es nicht gibt</font></em><font style="vertical-align: inherit;"> . Obwohl es in vielen Spielen ähnliche Fehler gibt, zum Beispiel im beliebten Intro</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Legende von Zelda: The Minish Cap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sie beruhen auf speziellem Verhalten, das durch das Lesen ungültiger Speicheradressen verursacht wird. </font><font style="vertical-align: inherit;">Aber dieser Zyklus schien ein solches Verhalten zu verletzen. </font><font style="vertical-align: inherit;">Trotzdem funktionierte das Spiel mit realer Ausrüstung. </font><font style="vertical-align: inherit;">Darüber hinaus trat beim Laden eines Speichers in die Sonic Pinball Party nach einem Kaltstart genau derselbe Fehler auf. </font><font style="vertical-align: inherit;">Könnte die Erwartung dieser ungültigen Speicheradressen irgendwie falsch sein? </font><font style="vertical-align: inherit;">Aber wenn ja, wie?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b0/c85/547/1b0c8554787a8e54e1ac5c21c78d639c.png"></div><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber das ist illegal, oder?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warten Sie eine Minute - wenn Sie versuchen, auf ungültigen Speicher zuzugreifen, muss das Spiel nur abstürzen, oder? Ein ungelöster Vorgang, ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segfault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder ein anderer Fehler </font><font style="vertical-align: inherit;">sollte auftreten </font><font style="vertical-align: inherit;">. Recht? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, es ist eher wie Ja. Aber nicht wirklich. Zumindest nicht auf der GBA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Architektur der ARM-Prozessoren, die in GBA verwendet wurden, wird dieser fehlerhafte Status als Datenabbruch bezeichnet und tritt nur auf, wenn Sie versuchen, auf Speicher zuzugreifen, für den der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speichermanager</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> keine Leseberechtigung </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zugewiesen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">hat</font></a><font style="vertical-align: inherit;"> . Wenn ein Datenabbruch auftritt, schließt der Prozessor seine Arbeit ab und wechselt zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausnahmevektor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausnahmen für Datenabbruch zugewiesen. Dann kann das Betriebssystem eine der Lösungen auswählen: Beenden Sie den aktuellen Prozess, weisen Sie einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seitenfehlerspeicher zu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lassen Sie den Prozess die Situation behandeln, wie es einige Emulatoren JIT mit „fastmem“ tun, oder führen Sie andere Aktionen aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie geht der GBA mit Datenabbruch um? Der Ausnahmevektoreintrag für den Datenabbruch befindet sich im Boot-ROM der GBA-Konsole (oder, wie er auch genannt wird, im BIOS). Wenn der GBA auf einen Datenabbruch stößt, versucht er, zum DACS </font><sup><font style="vertical-align: inherit;">2-</font></sup><font style="vertical-align: inherit;"> Handler zu wechseln</font></font><sup><font style="vertical-align: inherit;"></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn es existiert, tritt andernfalls eine Blockierung auf. </font><font style="vertical-align: inherit;">Kein kommerzielles Spiel hat DACS-Handler. </font><font style="vertical-align: inherit;">Warum friert dieses Spiel nicht ein? </font><font style="vertical-align: inherit;">Alles ist sehr einfach - GBA generiert niemals einen Datenabbruch. </font><font style="vertical-align: inherit;">Es verfügt nicht über einen Speichermanager (MMU) (oder sogar eine Speicherschutzeinheit wie in DS), funktioniert also einfach weiter und liest ungültigen Speicher aus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Speicherbus betritt die Szene.</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f75/dd9/55f/f75dd955f33d3a974b417f401fe054a6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist ein ungültiger Speicher im Allgemeinen? Wie sieht sie aus? Dies ist der Hauptgrund. Dies ist eine schwierige Situation: Was der Code liest, hängt stark davon ab, was die CPU kürzlich oder genauer gesagt, was der </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speicherbus</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kürzlich getan hat </font><font style="vertical-align: inherit;">. Kurz gesagt, beim Zugriff auf einen ungültigen Speicher liest die CPU, was der letzte auf dem Speicherbus war. Um zu verstehen, was daraus folgt, müssen Sie ein wenig über den Speicherbus und dessen Funktionsweise lernen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Speicherbus ist Teil einer elektronischen Schaltung, die die CPU mit allen Speicherkomponenten der Plattform verbindet. Auf dem GBA sind mehrere Geräte an den Speicherbus angeschlossen: Arbeitsspeicher, Videospeicher und Kassettenbus. Wenn die CPU versucht, auf den Speicher zuzugreifen, teilt sie dem Speicherbus mit, auf welche Adresse sie zugreifen muss, und dann wird die dieser Adresse entsprechende Komponente aktiviert. Dann platziert die Komponente den Wert an dieser Adresse auf dem Bus, was mehrere </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zyklen dauern kann </font><font style="vertical-align: inherit;">, und dann kann die CPU schließlich den Wert vom Bus lesen. Wenn im Fall des GBA der Adresse kein Gerät zugeordnet ist, wird kein Wert in den Bus geschrieben, und die CPU liest den </font><em><font style="vertical-align: inherit;">zuletzt</font></em><font style="vertical-align: inherit;"> auf dem Bus platzierten Wert</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die Situation kann auf unterschiedliche Weise variieren, z. B. wenn der Lesevorgang 16-Bit war und die CPU versucht, einen 32-Bit-Lesevorgang durchzuführen. Im Allgemeinen handelt es sich jedoch immer um einen Wert vom Bus. </font><font style="vertical-align: inherit;">Entwickler nennen diese Funktion "Bus öffnen". </font><font style="vertical-align: inherit;">Früher habe ich geschrieben, wie es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">andere Spiele beeinflusst</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, es scheint, dass nicht alles so schlecht aussieht ... Richtig?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können also nur den letzten Speicherzugriff zwischenspeichern? Und dann wieder zurückbringen? Im allgemeinen Fall wird dieser Ansatz funktionieren, es gibt jedoch bestimmte Schwierigkeiten. Zunächst müssen Sie sicherstellen, dass alle Speicherzugriffsvorgänge in der richtigen Reihenfolge ausgeführt werden. Dies ist komplizierter als es sich anhört, da die CPU mit jedem Befehl auf den Speicher zugreift, um den nächsten Befehl in der Pipeline zu erhalten. Tatsächlich ist im allgemeinen Fall * der im Bus stecken gebliebene Speicher der letzte Befehl, der empfangen wurde. Dies vereinfacht den Vorgang, da Sie nur diesen letzten, vorausgewählten Wert erhalten müssen. Da der zuletzt vorgewählte Wert jedoch nur davon abhängt, wo er gerade aus dem Speicher ausgeführt wird, sollte er immer derselbe sein. Auch wenn sich die empfangene Adresse ändert, während sie ungültig ist,Sie erhalten immer den gleichen Speicher.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Äh ... Hör auf. </font><font style="vertical-align: inherit;">Dieser Zyklus existiert jedoch und kann nicht beendet werden, wenn dieser Wert vorausgewählt ist. </font><font style="vertical-align: inherit;">Also, was ist los? </font><font style="vertical-align: inherit;">Wenn er ständig die folgende Anweisung erhält, was passiert dann zwischen diesen Operationen? </font><font style="vertical-align: inherit;">Ich habe versucht, solche Endlosschleifen auf Test-ROMs auszuführen, um zu überprüfen, ob beispielsweise der Wert schlecht werden könnte. </font><font style="vertical-align: inherit;">Dies kann definitiv passieren, wenn der Wert nicht kürzlich aktualisiert wurde, der Wert jedoch in jeder Anweisung aktualisiert wird, sodass keine Zeit für Beschädigungen bleibt. </font><font style="vertical-align: inherit;">Meine Tests haben die Schleife nie verlassen. </font><font style="vertical-align: inherit;">Ich habe etwas anderes gemacht als in diesen Spielen, obwohl ich den Zyklus genau neu erstellt habe. </font><font style="vertical-align: inherit;">Was habe ich falsch gemacht?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pokémon Emerald und ACE kommen nur auf Eisen vor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schneller Vorlauf im Januar 2020. Der Fehlerbericht auf der Sonic Pinball Party war damals etwa dreieinhalb Jahre alt. In anderen Emulatoren war er viele Jahre bekannt. Ich habe keine Arbeitstheorien mehr. Ende dieses Monats ein Benutzer mit dem Spitznamen </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">merrp</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trat der Discord-Community des mGBA-Emulators bei und sagte, dass Pokémon Emerald einen neuen ACE (Arbitrary Code Execution Glitch) hat, der nur auf Hardware funktioniert. Darüber hinaus wird dieser Fehler höchstwahrscheinlich von Speedrunnern verwendet, die den Emulator üben möchten. Offensichtlich ist dieser Fehler ein attraktives Ziel für die Behebung des Fehlers geworden, obwohl es besser wäre, wenn ich ihn vor Version 0.8.0 herausfinden würde. Ich begann den Fehler zu untersuchen und bestätigte die Beobachtung von merrp, dass es nur auf Hardware funktioniert. In allen Emulatoren, die ich ausprobiert habe, hing das Spiel mit einem schwarzen Bildschirm. Aber merrp teilte mir mit, dass es beim Lesen aus einem ungültigen Speicher in einer Schleife hängt, und ich erkannte, dass ich den Fehler höchstwahrscheinlich in naher Zukunft nicht beheben konnte. Dies ist wieder </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der gleiche</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fehler.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Mal gab mir das Erlernen von Schleifenfunktionen einen Vorteil. Dank des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pokeemerald-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dekompilierungsprojekts </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">konnte</font></a><font style="vertical-align: inherit;"> ich leicht gezielte Änderungen an der Funktion vornehmen, um herauszufinden, wie sie es geschafft hat, aus der Schleife herauszukommen. Eine vereinfachte Version dieser Schleife sieht ungefähr so ​​aus:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> type = <span class="hljs-comment">/* ... */</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; table[type][i] != <span class="hljs-number">0xFFFF</span>; ++i) {
	<span class="hljs-keyword">uint16_t</span> value = table[type][i] &amp; <span class="hljs-number">0xFE00</span>;
	<span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0x7E00</span>) {
		<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
	<span class="hljs-comment">/* ... */</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Schleife führt eine ziemlich einfache Aufgabe aus. Es gibt eine zweidimensionale Wertetabelle. In jeder Zeile dieser Spaltentabelle versucht die </font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schleife zunächst festzustellen, ob der Wert ein bestimmter Sentinel-Wert ist. Wenn ja, endet die Schleife. Andernfalls wird eine Maske auf den Wert angewendet und geprüft, ob er größer als der zu prüfende Wert ist. Ansonsten geht es den Zyklus hinunter. In einem bestimmten Fall eines Fehlers </font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überschreitet </font><font style="vertical-align: inherit;">der Wert </font><font style="vertical-align: inherit;">die Grenzen der Tabelle, was zum Auftreten eines ungültigen Zeigers führt. Dies bedeutet, wenn Sie versuchen, darauf zuzugreifen</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf dieses Element dieser nicht vorhandenen Spalte wird immer auf ungültigen Speicher zugegriffen. Obwohl der Tabellenversatz mit jeder Iteration der Schleife zunimmt, bevor zum tatsächlichen Speicher zurückgekehrt wird, sind möglicherweise Hunderte Millionen Wiederholungen erforderlich. Daher ist es offensichtlich, dass er dies nicht tut. Wie kommt ein Programm aus einer Schleife heraus?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies zu untersuchen, habe ich den Zyklus geändert und mir angesehen, was passieren würde, wenn ich sofort aus dem Zyklus ausbrechen würde. </font><font style="vertical-align: inherit;">Alles stellte sich als recht einfach heraus: In diesem Moment arbeitete ACE sowohl an der Hardware als auch am Emulator, und nichts hing. </font><font style="vertical-align: inherit;">Also habe ich stattdessen versucht, die Bildschirmfarbe auf den Wert einzustellen, den das Programm beim Verlassen der Schleife liest und einfriert, damit sich die Farbe nicht ändert. </font><font style="vertical-align: inherit;">Ich habe den Code neu kompiliert und auf einem echten GBA ausgeführt. </font><font style="vertical-align: inherit;">Nach ein paar Sekunden Einfrieren auf einem schwarzen Bildschirm wurde es zu einem wunderschönen blauen Farbton.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/e_/md/eqe_md60cly8igmztq2_kd2yigc.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEHR BLAU</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aber der Emulator hing immer noch auf einem schwarzen Bildschirm. </font><font style="vertical-align: inherit;">Welchen Wert liest er, wenn er den zuvor empfangenen Wert liest? </font><font style="vertical-align: inherit;">Stattdessen wurde es ein dunkles Türkis.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sh/hf/6j/shhf6jyqkem0ulhbpzjuhc9hmi4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fu.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Das heißt, das Programm, bevor es raus aus dem Zyklus verwaltet werden </font><font style="vertical-align: inherit;">, mit </font><font style="vertical-align: inherit;">Sicherheit mindestens einmal vergangen. </font><font style="vertical-align: inherit;">Es stellte sich auch heraus, dass die Zeit, die erforderlich ist, um mit Eisen aus dem Kreislauf zu entkommen, unterschiedlich ist. </font><font style="vertical-align: inherit;">Dies dauerte normalerweise 2 bis 30 Sekunden. </font><font style="vertical-align: inherit;">Was ist los?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neue Arbeitstheorie</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann bemerkte ich den Unterschied zwischen meinem Test-ROM und dem Pokémon Emerald, als es hing. Pokémon spielte Musik. Sonic Pinball Party spielte auch Musik. Hallo Kitty hat keine Musik gespielt, aber es gab mir eine Idee. Was passiert, wenn zwischen Prefetching und Datenladen ein Interrupt auftritt? Beginnt das Programm, den Interrupt-Vektor vorab abzurufen, bevor auf den ungültigen Speicher zugegriffen wird? Ich habe schnell ein Layout für diese Situation in mGBA erstellt, Interrupts im Test-ROM aktiviert und es ist natürlich aus der Schleife geraten. Dann habe ich das gleiche Test-ROM auf Hardware ausprobiert und ... es ist nicht aus der Schleife geraten. Und so entstand die Theorie. Am Ende wurde mir etwas klar. Ich bin mir sicher, dass Sie oben ein Sternchen bemerkt haben. Ja, es kann ein Ereignis zwischen dem Vorabrufen und dem Zugreifen auf den Speicher geben.aber nur, wenn der Speicherbus zwischen dem Prefetch und dem Zugriff auf ungültigen Speicher eine Anforderung nicht an die CPU, sondern an etwas anderes sendet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich sagte, dass der Speicherbus von der CPU gesteuert wird. Dies ist größtenteils der Fall, aber es gibt auch andere wichtige Geräte, die unter Umgehung des Prozessors Zugriff auf den Speicherbus haben. Dieser Vorgang wird als </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">direkter Speicherzugriff bezeichnet</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ich habe in einem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">früheren Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> über DMA gesprochen </font><font style="vertical-align: inherit;">, daher werde ich jetzt nicht auf die Prinzipien seiner Arbeit eingehen. Wenn Sie den Artikel erneut lesen, werden Sie möglicherweise feststellen, dass die Haupt-CPU angehalten wird, während DMA ausgeführt wird. Dies bedeutet, dass während DMA ausgeführt wird, der Wert auf dem Bus jetzt der letzte Zugriff auf den DMA-Speicher ist. Dies ist hauptsächlich wichtig, wenn der DMA über den tatsächlichen Speicher hinaus in einen ungültigen Bereich übergeht. Es dupliziert jedoch den letzten guten Wert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist seit langem bekannt, dass Sie beim Laden eines ungültigen Speichers in DMA den letzten DMA-Wert erhalten, aber ich habe ihn lange in mGBA implementiert und ihn bereits vergessen. Als ich dies im Zugangscode für ungültigen Speicher sah, als ich den Fehler studierte, klickte etwas in meinem Kopf. Was ist, wenn der DMA-Wert für eine Anweisung auf dem Bus verbleibt? Wenn der erste Befehl nach DMA das Laden des ungültigen Speichers beendet, bevor er den nächsten Wert erhält, sollte dies theoretisch zum erneuten Laden des DMA-Werts führen. Darüber hinaus verwendet das Abspielen von Musik in GBA normalerweise DMA, um die Audioausgabe zu übertragen. Für die korrekte Implementierung ist ein taktgenauer Emulator erforderlich, der die CPU während der Befehlsausführung zwischen dem Start des Befehls und dem Speicherzugriff blockieren kann, und die GBA-Konsolenemulation im mGBA-Emulator ist nicht taktgenau.Und das ist etwas für mich.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erinnert sich</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Zum Glück konnte ich dieses Problem umgehen. </font><font style="vertical-align: inherit;">Die Lösung ist unvollständig, aber ich kann jetzt die erwartete CPU-Adresse für den Befehl nach DMA mit der aktuellen CPU-Adresse für eine ungültige Last vergleichen und anstelle des vorgewählten Werts für diesen DMA-Wert eine einzelne Adresse verwenden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die lang erwartete Entscheidung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe die DMA-Operationen für H-Blank im Test-ROM aktiviert und sie mit V-Blank synchronisiert, damit die Timings stabil sind, habe es auf Hardware ausgeführt und ... diesmal hat es funktioniert! Das Test-ROM verließ die Schleife nach der gleichen Anzahl von Iterationen ständig, wenn der DMA-Wert vom Bus gelesen wurde. Ich lag richtig! Für die korrekte Implementierung in mGBA waren mehrere Versuche erforderlich, aber jetzt verlässt das Programm den Zyklus mit den gleichen Ergebnissen wie auf der Hardware. Ich habe endlich einen Blauton auf mGBA bekommen. Hallo Kitty hat gebootet. Das Sparen bei der Sonic Pinball Party hat sich verdient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe es gemacht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies war wahrscheinlich die längste Zeit, die ich mit einem einzelnen Fehler verbracht habe. Im Laufe von drei Jahren habe ich so viel Zeit in das Debuggen investiert, dass ich die Zählung verloren habe, und ich bin sicher, dass auch andere Entwickler in ihren Emulatoren mit ähnlichen Situationen konfrontiert waren. Ohne diese Einsicht hätte ich ein weiteres Jahr oder sogar noch länger brauchen können, aber der schwarze Bildschirm, auf dem nichts anderes passiert ist als Musik zu spielen, wurde zu der Domino-Kachel, die zum Zusammenbruch des gesamten Problems führte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem die Lösung gefunden wurde, kann sie in anderen GBA-Emulatoren implementiert werden, wodurch dieser Fehler behoben wird. Der Fehler wird in mGBA 0.9.0 behoben, das hoffentlich in diesem Jahr veröffentlicht wird und bereits in Testversionen behoben wurde. Sie können endlich Hello Kitty Collection: Miracle Fashion Maker spielen. Es sei denn natürlich, Sie wünschen, es ist nicht meine Aufgabe, Sie zu beurteilen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34c/74c/fce/34c74cfce5ebbb092c5a55c9293ec0cb.png" alt="Bild"></div><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie versuchen, Speicher ohne Ausführungsberechtigungen auszuführen, wird dies als Prefetch-Abbruch bezeichnet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DACS (kurz für Debugging and Communication System) ist Teil des GBA-Entwicklungskits.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Leerlaufzyklen beim Lesen vom Bus werden manchmal als Wartezustände bezeichnet.</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de488224/index.html">Ehemaliger TJ-Chefredakteur über Briefe des FSB: Es wird eine Geschichte über "Durov 2.0" geben, aber Habr wird der Headliner</a></li>
<li><a href="../de488228/index.html">TOP 10 Orte und Ideen für ein Geek-Date am 14. Februar</a></li>
<li><a href="../de488230/index.html">Einführung in SSD. Teil 3. Formfaktor</a></li>
<li><a href="../de488232/index.html">ca. Tech: QATOK # 2</a></li>
<li><a href="../de488234/index.html">Verwenden von QubesOS für Windows 7</a></li>
<li><a href="../de488242/index.html">VueJS + TS Projektintegration mit SonarQube</a></li>
<li><a href="../de488244/index.html">So reduzieren Sie den Overhead beim Behandeln von Ausnahmen in C ++</a></li>
<li><a href="../de488246/index.html">VoiceOver unter iOS: Jedes Steuerelement verhält sich anders</a></li>
<li><a href="../de488250/index.html">Zur Frage von Linux (L)</a></li>
<li><a href="../de488252/index.html">So senken Sie die Kosten für die Entwicklung neuer Produkte mit SLS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>