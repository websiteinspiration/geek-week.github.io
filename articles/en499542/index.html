<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏽 🖌️ 👨🏿‍🎨 Top Fakapov Cyan ✌🏿 ❓ 🕝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good to all! 
 
 My name is Nikita, I am team leader of Cyan engineers. One of my responsibilities at the company is to reduce the number of incidents...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Top Fakapov Cyan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cian/blog/499542/"><img src="https://habrastorage.org/webt/zy/iu/-q/zyiu-qkcptbeezgf_c5adiagete.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good to all!&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Nikita, I am team leader of Cyan engineers. </font><font style="vertical-align: inherit;">One of my responsibilities at the company is to reduce the number of incidents related to the infrastructure on the prod to zero. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will be discussed later has brought us a lot of pain, and the purpose of this article is to prevent other people from repeating our mistakes or at least minimize their impact.&nbsp;</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preamble</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time, when Cyan consisted of monoliths, and there were no hints of microservices yet, we measured the availability of the resource by checking 3-5 pages.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Answer - everything is fine, do not respond for a long time - alert. </font><font style="vertical-align: inherit;">How much time they should not work in order for this to be considered an incident, people decided at meetings. </font><font style="vertical-align: inherit;">A team of engineers has always been involved in the investigation of the incident. </font><font style="vertical-align: inherit;">When the investigation was completed, they wrote a post-mortem - a kind of report to the post office in the format: what was, how long, what they did in the moment, what we will do in the future.&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main pages of the site, or as we understand it, have broken the bottom</font></font></h3>&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to somehow understand the priority of the error, we highlighted the site’s most critical pages for the business functionality. </font><font style="vertical-align: inherit;">According to them, we consider the number of successful / unsuccessful requests and timeouts. </font><font style="vertical-align: inherit;">So we measure uptime.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we find out that there are a number of super important sections of the site that are responsible for the main service - search and submission of announcements. </font><font style="vertical-align: inherit;">If the number of requests that failed is greater than 1%, this is a critical incident. </font><font style="vertical-align: inherit;">If within 15 minutes in prime time the percentage of errors exceeds 0.1%, then this is also considered a critical incident. </font><font style="vertical-align: inherit;">These criteria cover most of the incidents, the rest are beyond the scope of this article.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/mw/k9/otmwk90qyl-jcomorjhkofebrgq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Top best cyan incidents</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we precisely learned to determine the fact that the incident happened.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now each incident in our country is described in detail and reflected in the Jira epic. </font><font style="vertical-align: inherit;">By the way: for this we started a separate project, called it FAIL - only epics can be created in it.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you collect all the fails over the past few years, then the leaders are:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mssql related incidents;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incidents caused by external factors;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">admin errors.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us dwell in more detail on the mistakes of admins, as well as on some other interesting fails.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fifth place - “Putting order in the DNS”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was a rainy Tuesday. We decided to clean up the DNS cluster.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted to transfer the internal dns servers from bind to powerdns, highlighting completely separate servers for it, where there is nothing besides dns.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We placed one dns server in each location of our DCs, and the moment came to move the zones from bind to powerdns and switch the infrastructure to new servers.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the height of the move, of all the servers that were indicated in the local caching bind on all servers, there was only one that was in the data center in St. Petersburg. This DC was initially declared as uncritical for us, but suddenly became a single point of failure.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just during such a period of relocation, the channel between Moscow and St. Petersburg fell. </font><font style="vertical-align: inherit;">We actually remained without DNS for five minutes and got up when the hoster fixed the problems.&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If earlier we neglected external factors during the preparation for work, now they are also included in the list of what we are preparing for. </font><font style="vertical-align: inherit;">And now we strive to ensure that all components are reserved n-2, and for the duration of the work we can lower this level to n-1.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When drawing up an action plan, mark the points where the service may fall, and think over the scenario where everything went “worse than nowhere,” in advance.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Distribute internal DNS servers by different geolocations / data centers / racks / switches / inputs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On each server, put a local caching dns server, which redirects requests to the main dns servers, and if it is unavailable, it will respond from the cache.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fourth place - “Cleaning up Nginx”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One fine day, our team decided that “enough to endure it”, and the process of refactoring nginx configs started. </font><font style="vertical-align: inherit;">The main goal is to bring configs to an intuitive structure. </font><font style="vertical-align: inherit;">Previously, everything was “historically established” and there was no logic in itself. </font><font style="vertical-align: inherit;">Now each server_name has been taken out to the file of the same name and distributed all the configs into folders. </font><font style="vertical-align: inherit;">By the way, the config contains 253949 lines or 7836520 characters and takes up almost 7 megabytes. </font><font style="vertical-align: inherit;">Top level structure:&nbsp;</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx structure</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">├── access<font></font>
│ &nbsp; ├── allow.list<font></font>
...<font></font>
│ &nbsp; └── whitelist.conf<font></font>
├── geobase<font></font>
│ &nbsp; ├── exclude.conf<font></font>
...<font></font>
│ &nbsp; └── geo_ip_to_region_id.conf<font></font>
├── geodb<font></font>
│ &nbsp; ├── GeoIP.dat<font></font>
│ &nbsp; ├── GeoIP2-Country.mmdb<font></font>
│ &nbsp; └── GeoLiteCity.dat<font></font>
├── inc<font></font>
│ &nbsp; ├── error.inc<font></font>
...<font></font>
│ &nbsp; └── proxy.inc<font></font>
├── lists.d<font></font>
│ &nbsp; ├── bot.conf<font></font>
...<font></font>
│ &nbsp; ├── dynamic<font></font>
│ &nbsp; └── geo.conf<font></font>
├── lua<font></font>
│ &nbsp; ├── cookie.lua<font></font>
│ &nbsp; ├── log<font></font>
│ &nbsp; │ &nbsp; └── log.lua<font></font>
│ &nbsp; ├── logics<font></font>
│ &nbsp; │ &nbsp; ├── include.lua<font></font>
│ &nbsp; │ &nbsp; ├── ...<font></font>
│ &nbsp; │ &nbsp; └── utils.lua<font></font>
│ &nbsp; └── prom<font></font>
│ &nbsp; &nbsp; &nbsp; ├── stats.lua<font></font>
│ &nbsp; &nbsp; &nbsp; └── stats_prometheus.lua<font></font>
├── map.d<font></font>
│ &nbsp; ├── access.conf<font></font>
│ &nbsp; ├── ..&nbsp;<font></font>
│ &nbsp; └── zones.conf<font></font>
├── nginx.conf<font></font>
├── robots.txt<font></font>
├── server.d<font></font>
│ &nbsp; ├── cian.ru<font></font>
│ &nbsp; │ &nbsp; ├── cian.ru.conf<font></font>
│ &nbsp; │ &nbsp; ├── ...<font></font>
│ &nbsp; │ &nbsp; └── my.cian.ru.conf<font></font>
├── service.d<font></font>
│ &nbsp; ├── ...<font></font>
│ &nbsp; └── status.conf<font></font>
└── upstream.d<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;├── cian-mcs.conf<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;├── ...<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;└── wafserver.conf</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It became much better, but in the process of renaming and distributing the configs, some of them had the wrong extension and did not fall into the include * .conf directive. </font><font style="vertical-align: inherit;">As a result, part of the hosts became unavailable and returned 301 to the main one. </font><font style="vertical-align: inherit;">Due to the fact that the response code was not 5xx / 4xx, this was not noticed immediately, but only in the morning. </font><font style="vertical-align: inherit;">After that, we started writing tests to test infrastructure components. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Findings:</font></font></b>&nbsp;<br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctly structure configs (not only nginx) and think over the structure at an early stage of the project. </font><font style="vertical-align: inherit;">So you will make them more understandable to the team, which in turn will reduce the TTM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For some infrastructure components, write tests. </font><font style="vertical-align: inherit;">For example: checking that all key server_names return the correct status, + response body. </font><font style="vertical-align: inherit;">It will be enough to have at hand just a few scripts that check the basic functions of the component so that you do not frantically remember at 3 a.m. what else needs to be checked.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Third place - “Suddenly ended place in Cassandra”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data was growing steadily, and everything was fine until the moment when repair of large cases started to fall in the Cassandra cluster, because compaction could not work on them.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On one rainy day, the cluster almost turned into a pumpkin, namely:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">places remained about 20% of the total cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is impossible to fully add nodes, because cleanup does not work after adding a node due to lack of space on partitions;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performance drops slightly, because the compaction does not work;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the cluster is in emergency mode.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/lp/ah/ie/lpahie7bann64sajoibumpqbr5g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exit - added another 5 nodes without cleanup, after which they began to systematically remove from the cluster and re-enter them as empty nodes on which the place ended. </font><font style="vertical-align: inherit;">Time spent much more than we would like. </font><font style="vertical-align: inherit;">There was a risk of partial or complete inaccessibility of the cluster.&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Findings:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All cassandra servers should take up no more than 60% of the space on each partition.&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They should be loaded no more than 50% cpu.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not clog on capacity planning and think through it for each component, based on its specifics.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The more nodes in the cluster, the better. </font><font style="vertical-align: inherit;">Servers containing a small amount of data are migrated faster, and such a cluster is easier to reanimate.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Second place - “Data from consul key-value storage has disappeared”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For service discovery, we, like many, use consul. But here, its key-value is also used for blue-green monolith calculations. It stores information about active and inactive upstream, which change places during the deployment. For this, a deployment service was written that interacted with KV. At some point, the data from KV disappeared. Recovered from memory, but with a number of errors. As a result, during the calculation, the load on the upstream was unevenly distributed, and we got a lot of 502 errors due to overloading the backends on the CPU. As a result, we moved from consul KV to postgres, from where it is not so easy to remove them.&nbsp;&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Findings:</font></font><br>
</b><br>
<ul>
<li>  -           . ,       ES —        ,    ,   ,    action.destructive_requires_name: true.</li>
<li>      . ,    ( , &nbsp;python),      .</li>
</ul><br>
<h4>  — « »&nbsp;</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At some point, we noticed an uneven load distribution on the nginx upstream in cases where there were 10+ servers in the backend. Due to the fact that round-robin sent requests from 1 to the last upstream in order, and each nginx reload started from the beginning, the first upstream always had more requests than the rest. As a result, they worked slower and the whole site suffered. This became more noticeable as the amount of traffic increased. Just updating nginx to enable random did not work - you need to redo a bunch of lua code that did not take off on version 1.15 (at that moment). I had to patch our nginx 1.14.2, introducing random support in it. This solved the problem. This bug wins the "captain non-obviousness" nomination. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It was very interesting and exciting to investigate this bug).&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set up monitoring so that it helps to find such fluctuations quickly. </font><font style="vertical-align: inherit;">For example, you can use ELK to monitor the rps on each backend of each upstream, and monitor their response time from the point of view of nginx. </font><font style="vertical-align: inherit;">In this case, it helped us to identify the problem.&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, most of the fails could have been avoided with a more scrupulous approach to what you are doing. </font><font style="vertical-align: inherit;">You must always remember the Murphy's Law:&nbsp; </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anything that can go wrong will go wrong,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and build components based on it.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499528/index.html">A “stunning” mathematical bridge that extends beyond Fermat’s Great Theorem</a></li>
<li><a href="../en499532/index.html">Words in numbers: free blog analytics habravebinary with Yandex.Metrica</a></li>
<li><a href="../en499534/index.html">Python backend service development guide</a></li>
<li><a href="../en499536/index.html">Growbox as a method of knowing oneself</a></li>
<li><a href="../en499540/index.html">How 3D game rendering works: texturing and texture filtering</a></li>
<li><a href="../en499544/index.html">Learn neural networks in Google Sheets</a></li>
<li><a href="../en499546/index.html">Firmware development for an analog video camera EVR-Y2022F</a></li>
<li><a href="../en499548/index.html">Mask - caring for others or an illusion of security?</a></li>
<li><a href="../en499550/index.html">Ecosystem Low-Code Solutions</a></li>
<li><a href="../en499556/index.html">Game Server on MS Orleans - Part 3: Summary</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>