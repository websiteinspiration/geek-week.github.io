<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🚒 🖐🏿 😷 Akses aman ke rumah pintar tanpa adanya IP publik (bagian 2) ⚾️ 🌦️ 👶🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="pengantar
 Pada bagian pertama, saya menulis tentang pernyataan masalah dan bagaimana Wishlist diubah. Pada akhirnya, saya memutuskan untuk menggunaka...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Akses aman ke rumah pintar tanpa adanya IP publik (bagian 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505412/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada bagian pertama,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saya menulis tentang pernyataan masalah dan bagaimana Wishlist diubah. </font><font style="vertical-align: inherit;">Pada akhirnya, saya memutuskan untuk menggunakan OpenVPN, tetapi, karena saya memutuskan untuk menjalankan semuanya dalam wadah Docker, ternyata tidak sesederhana itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya harus mengatakan segera bahwa nanti saya redid semuanya lagi, akibatnya saya menolak VPS eksternal. </font><font style="vertical-align: inherit;">Namun, karena semuanya ada dalam wadah, dalam prosesnya saya menemukan sejumlah fitur menarik, yang akan dibahas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya hanya akan menjelaskan poin-poin penting.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker</font></font></h3><br>
<pre><code class="plaintext hljs">docker run -d --name iobhost  --net=host -v /opt/iobroker/:/opt/iobroker/ --device=/dev/ttyACM0 --env-file /opt/ioBroker_env.list --restart=always buanet/iobroker:latest
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena saya memiliki MiHome Gateway, sensor terhubung ke sana, bahkan beberapa skenario telah diatur, yang saya belum ingin hancurkan, saya menghubungkan ioBroker ke sana. Dia melihat sensor, dia tidak harus menugaskan kembali ke Zigbee stick (walaupun ada juga, dan beberapa tombol terhubung ke sana). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini, agar ioBroker menghubungi MiHome Gateway, dan memulainya dengan parameter --net = host. Itu ia menggunakan antarmuka host, Anda tidak perlu menentukan port mana yang akan diteruskan ke wadah. Tanpa ini, dia tidak bisa melihat gateway, karena dia bekerja melalui multicast.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter --device = / dev / ttyACM0 diperlukan untuk meneruskan tongkat USB Zigbee ke wadah. </font><font style="vertical-align: inherit;">Juga di /opt/ioBroker_env.list saya harus menambahkan baris USBDEVICES = "/ dev / ttyACM0". </font><font style="vertical-align: inherit;">Adalah penting bahwa baris ini harus ada pada saat peluncuran pertama wadah, ketika melihat direktori kosong dan memulai konfigurasi awal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat mengonfigurasinya nanti, tentu saja, tetapi Anda harus melakukan gerakan tubuh tambahan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server MQTT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada VPS eksternal, ia meluncurkan nyamuk gerhana. </font><font style="vertical-align: inherit;">Pertama-tama saya mengatur TLS untuknya dengan menerbitkan sertifikat Mari enkripsi. </font><font style="vertical-align: inherit;">Kemudian ia memutuskan bahwa klien harus menunjukkan sertifikat, dan hanya kemudian nama dan kata sandi (perlindungan dari bruteforce). </font><font style="vertical-align: inherit;">Jadi saya redid ke ditandatangani sendiri, sehingga klien menulis sertifikat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openvpn</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digunakan gambar populer dengan Docker Hub. </font><font style="vertical-align: inherit;">Untuk server (VPS) kylemanna / openvpn. </font><font style="vertical-align: inherit;">Untuk klien (server rumah tempat ioBroker diinstal) - ekristen / openvpn-client.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kustomisasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini saya harus mengotak-atik. </font><font style="vertical-align: inherit;">Dalam prosesnya, saya merasakan aspek jaringan buruh pelabuhan dengan baik, bekerja dengan iptables, menemukan yang baru, termasuk </font><font style="vertical-align: inherit;">netplan yang saya tidak punya bisnis sebelumnya. </font><font style="vertical-align: inherit;">Sebenarnya, oleh karena itu, saya memutuskan untuk menulis artikel ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server VPS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan instalasi OpenVPN dan konfigurasi, semuanya standar, seperti </font><font style="vertical-align: inherit;">yang tertulis </font><font style="vertical-align: inherit;">di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/r/kylemanna/openvpn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang saya lakukan tambahan adalah untuk meningkatkan loopback tambahan pada VPS dan server rumah. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/netplan/01-netcfg.yaml</font></font></i><br>
<br>
<pre><code class="plaintext hljs">	# This file describes the network interfaces available on your system<font></font>
	# For more information, see netplan(5).<font></font>
	network:<font></font>
	  version: 2<font></font>
	  renderer: networkd<font></font>
	  &lt;b&gt;ethernets:<font></font>
	    lo:<font></font>
	      renderer: networkd<font></font>
	      match:<font></font>
	        name: lo<font></font>
	      addresses:<font></font>
        - 192.168.16.1/32&lt;/b&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bold menyoroti "aditif." Spasi tampaknya tidak ditampilkan, meskipun sangat penting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alamat dalam contoh akan menggunakan 192.168.6.0 untuk jaringan rumah dan 192.168.16.0 untuk loopback. Saya akan berusaha untuk tidak membuat kesalahan di mana pun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openvpn.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditambahkan</font></font><br>
<br>
<pre><code class="plaintext hljs">server 192.168.16.192 255.255.255.192<font></font>
push "dhcp-option DNS 192.168.16.6"<font></font>
push "route 192.168.16.0 255.255.255.128"<font></font>
client-to-client<font></font>
client-config-dir       /etc/openvpn/ccd/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya secara khusus membuat loopback dari 192.168.16.0/25, dan saya memberikan alamat kepada klien dari 192.168.16.128/25, sehingga selanjutnya aturan penyelesaian dalam iptables dapat dikonfigurasikan dengan kisi tunggal 192.168.16.0/24 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, VPS memiliki loopback 192.168.16.1, ia memiliki mqtt di atasnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Server rumah memiliki 192.168.16.6. Ada iobroker, alias dns untuk klien rumah dan mendefinisikan kembali sejumlah nama domain untuk menghubungkan dari jaringan rumah atau melalui VPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada ide di mana-mana untuk mendaftarkan IP "aslinya" dari jaringan. Ketik ccd / iobroker untuk menentukan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iroute 192.168.6.6 255.255.255.255</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi, ternyata dari kenyataan bahwa ini adalah alamat dari jaringan pada antarmuka WiFi dari laptop di rumah, dan dalam banyak kasus itu adalah gateway default, ada gangguan. Termasuk dengan smartphone. Dan saya ingin jaringan rumah bekerja baik dengan klien yang aktif dan tanpa dia. Dan saya tidak perlu panik memutuskan klien, pulang ke rumah untuk mendapatkan akses ke sumber daya lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, saya mengkonfigurasi server ini dan wadahnya untuk selalu berinteraksi dengan loopback, terlepas dari apakah VPN aktif. Dan alamat yang sama sedang dialamatkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi di </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ccd / iobroker</font></font></i><br>
<br>
<pre><code class="plaintext hljs">iroute 192.168.16.6 255.255.255.255</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya, semua klien VPN tahu bahwa jaringan 192.168.16.0/24 dapat diakses melalui VPN. Jika mereka mengirim paket ke 192.168.16.1 (loopback VPS), paket dienkripsi, masuk ke wadah openvpn, didekripsi, rute default menuju 172.17.0.1 (gateway default dalam wadah default), paket itu sampai ke host, semuanya baik-baik saja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi bagaimana saya bisa "ping" klien VPN dari host VPS atau mengakses server rumah dengan alamat 192.168.16.6 (dan bukan IP sementara pada terowongan VPN yang ada di dalam wadah OpenVPN)? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jelas, mesh 192.168.16.0 harus dialihkan ke wadah OpenVPN. Tentu saja, saya dapat melihat bahwa itu adalah 172.17.0.3. Tapi suatu hari itu mungkin berubah.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika OpenVPN digunakan secara langsung di server, dan tidak di dalam wadah, semuanya akan bekerja dengan sendirinya. </font><font style="vertical-align: inherit;">Dan kemudian saya harus melakukannya dengan licik. </font><font style="vertical-align: inherit;">Saya membuat skrip yang dikerjakan oleh yang terbaru dalam sistem, dan memasukkannya ke dalamnya:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' vpn-client)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu </font><font style="vertical-align: inherit;">melalui pemeriksaan buruh pelabuhan, saya menemukan alamat IP dari wadah yang sedang berjalan, dan kemudian saya merutekan grid ke sana dengan cara biasa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak seperti rc.local biasa, saya harus google itu, tapi bagaimana, pada kenyataannya, untuk membuat skrip yang berjalan terakhir. </font><font style="vertical-align: inherit;">Ini adalah instruksi singkat: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit] <font></font>
Description=My Custom Target<font></font>
Requires=multi-user.target<font></font>
After=multi-user.target<font></font>
AllowIsolate=yes<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/last_command.service</font></font></i> <br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=My custom command<font></font>
After=multi-user.target<font></font>
[Service]<font></font>
Type=simple<font></font>
ExecStart=/usr/local/bin/my_last_command.sh<font></font>
[Install]<font></font>
WantedBy=custom.target<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat direktori </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target.wants</font></font></i><br>
<br>
<pre><code class="plaintext hljs">ln -s /etc/systemd/system/last_command.service \   /etc/systemd/system/custom.target.wants/last_command.service<font></font>
systemctl daemon-reload<font></font>
systemctl set-default custom.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda ingin segera memulai, tanpa menunggu reboot: systemctl mengisolasi custom.target </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang, setelah reboot </font><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh yang</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dijelaskan dalam ExecStart </font><font style="vertical-align: inherit;">akan menjadi yang terakhir diluncurkan </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di server mqtt, saya memiliki 2 port yang dinaikkan: 8883 dengan TLS dan otentikasi, dapat diakses dari Internet untuk sensor jarak jauh. Ya, dan saya sendiri dapat menghubungkan MQTT Explorer dan memeriksa apa dan bagaimana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1883 sudah tanpa TLS, hanya membutuhkan nama pengguna dan kata sandi. Dibutuhkan untuk rumah Sonoff rfBridge, yang TLS tidak tahu caranya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini tidak menakutkan, karena lalu lintas dari rumah akan pergi ke server dengan iobroker, yang merupakan gateway default untuk 192.168.16.0, itu akan meneruskan paket ke wadah dengan OpenVPN, dll. Namun, Anda harus mengizinkan akses ke port 1883 hanya dari dalam. Itu iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan standar adalah menolak akses ke port ini dari mana saja, kemudian ikuti aturan yang memungkinkan akses dari jaringan internal.</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I INPUT -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grid ditunjukkan di sini 172.17.0.0, karena dari OpenVPN ke "tetangga" saya akhirnya akan menyembunyikan NAT (yang merupakan wadah iobroker yang rfBridge berasal dari jaringan WiFi), dan bukan dari yang asli. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan itu berhasil. </font><font style="vertical-align: inherit;">Namun ada nuansa. </font><font style="vertical-align: inherit;">Port 1883 saya diteruskan ke wadah mqtt. </font><font style="vertical-align: inherit;">Dan, ternyata, iptables pertama kali memenuhi rantai DOCKER-USER. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artinya, dengan aturan ini, akses ke port 1883 diizinkan _ ke_ aturan pemblokiran. </font><font style="vertical-align: inherit;">Dan dari Internet, Anda juga dapat dengan mudah terhubung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aturan pemblokiran harus dibuat di rantai DOCKER-USER!</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I DOCKR-USER -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi yang lebih rendah, memungkinkan akses dari jaringan internal, untuk beberapa alasan memerlukan INPUT.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server rumah</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian utamanya sama. </font><font style="vertical-align: inherit;">Namun, meskipun ia seorang klien, ia harus merutekan lalu lintas dari jaringan WiFi (rfBridge) ke mqtt di VPS. </font><font style="vertical-align: inherit;">Itu </font><font style="vertical-align: inherit;">pergerakan lalu lintas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rfBridge (192.168.6.8) -&gt; host iobroker (192.168.6.6) -&gt; wadah vpn-klien (172.17.0.?) -&gt; wadah opevpn pada VPS -&gt; loopback VPS (192.168.16.1) -&gt; wadah mqtt (port 1883) Kami </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mengizinkan paket "forward" untuk grid dengan klien dan loopback:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A FORWARD -d 192.168.16.0/24 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan beralih ke wadah khusus.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda ingat, interaksi antara subsistem yang telah saya konfigurasi melalui loopback. </font><font style="vertical-align: inherit;">Itu </font><font style="vertical-align: inherit;">perlu bahwa paket pada 192.168.16.6 dari vpn-client pergi ke host (172.17.0.1), dan tidak ke terowongan VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menjalankan perintah ini dalam wadah yang berjalan, semuanya akan berfungsi. </font><font style="vertical-align: inherit;">Setelah reboot, ini akan dilupakan, tetapi Anda dapat menentukan dalam file konfigurasi iobroker.ovpn </font></font><br>
<code>route 192.168.16.6 255.255.255.255 172.17.0.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan openvpn akan menginstal rute ini ketika kontainer mulai. </font><font style="vertical-align: inherit;">Ini diselesaikan dengan mudah dengan cara standar.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket dari jaringan rumah 192.168.6.0 (misalnya, dari rfBridge) pergi ke host iobroker dan diteruskan ke wadah vpn-client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, saya sengaja tidak memasukkan jaringan 192.168.6.0 dalam domain enkripsi, wadah OpenVPN pada VPS tidak tahu apa yang harus dilakukan dengan jaringan ini. Solusi yang jelas adalah membuat NAT di dalam vpn-client sehingga paket pada VPS berasal dari alamatnya. Namun ada nuansa. Bagaimana cara menyimpan perintah iptables yang diperlukan setelah memulai ulang wadah? Iptables-persistent tidak mudah untuk diletakkan di sana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda bisa, tentu saja, merakit wadah baru dengan aditif. Tapi saya tidak mau, karena prosedur upgrade akan menjadi lebih rumit. Alih-alih "membunuh dan meluncurkan terbaru, dan dia menarik konfigurasi dari folder yang dipasang", akan perlu untuk memulai perakitan ... Bukan untuk itu saya berkomunikasi dengan wadah.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, saya memutuskan "setelah dimulainya wadah, jalankan perintah di dalamnya secara paksa yang memberitahu iptables untuk melakukan NAT." </font><font style="vertical-align: inherit;">Saya menggunakan tim untuk ini </font></font><br>
<code>docker events --filter "container=vpn-client" --filter "event=start"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dia menggantung dan menunggu acara yang ditentukan dalam filter. </font><font style="vertical-align: inherit;">Dalam kasus saya, mulai wadah. </font><font style="vertical-align: inherit;">Setelah itu, melalui docker exec, saya menjalankan perintah yang diperlukan dari host di dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, dengan analogi dengan VPS, saya mengkonfigurasi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh</font></font></i><br>
<br>
<pre><code class="plaintext hljs">#!/bin/bash<font></font>
cont="vpn-client"<font></font>
ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' $cont)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr<font></font>
for (( ; ; ))<font></font>
do<font></font>
  docker events --filter "container=$cont" --filter "event=start"<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.16.0/255.255.255.0 -j MASQUERADE<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.6.0/255.255.255.0 -j MASQUERADE<font></font>
done<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada contoh di mana output dari peristiwa buruh pelabuhan dilewatkan ke input awk, yang mengeksekusi perintah. </font><font style="vertical-align: inherit;">Tapi sepertinya lebih mudah bagi saya untuk "hang" sebelum acara, menjalankan perintah, dan lagi menunggu acara.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jujur, saya tidak ingin menulis posting ini. Saya memperoleh pengalaman yang menarik, tetapi ternyata "tidak indah", terlalu sulit, saya tidak terlalu menyukainya. Jadi sekali lagi saya redid semuanya, tolak VPS pada umumnya. Tetapi karena saya berjanji bagian kedua ... Selain itu, saya terkesan dengan pendekatan dengan acara buruh pelabuhan, saya ingin membagikannya. Saya pikir ini akan berguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada akhirnya, saya memutuskan demikian. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena saya tidak dapat mempublikasikan vis melalui proxy terbalik, dan saya dapat dengan mudah mengambil mqtt dari luar sebagai layanan, saya tidak memerlukan VPS untuk tugas ini. Saya dapat mengunggah firmware untuk pembaruan OTA ke hosting, juga, ada manfaatnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena itu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mqtt mengambil wqtt.ru. </font><font style="vertical-align: inherit;">TLS adalah (kata sandi dikirim dalam bentuk yang aman). </font><font style="vertical-align: inherit;">Kecepatannya luar biasa (10 ms versus 80 ms untuk mymqtthub). </font><font style="vertical-align: inherit;">Topik untuk ditulis ulang ke '$ device / &lt;crazy ID&gt; / events' (seperti Yandex) tidak diperlukan. </font><font style="vertical-align: inherit;">Itu </font><font style="vertical-align: inherit;">dalam hal ini Anda dapat melompat ke suatu tempat dengan mudah. </font><font style="vertical-align: inherit;">Harganya murah (300 rubel per tahun). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memposting firmware untuk OTA yang ada untuk hosting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akses ke vis masih melalui Zerotier. </font><font style="vertical-align: inherit;">Ini sangat sederhana dan nyaman. </font><font style="vertical-align: inherit;">Dan bahkan jika mereka rusak, tidak mungkin untuk melihat tingkat CO2 di rumah saya demi hal itu. </font><font style="vertical-align: inherit;">Dan bahkan jika ini terjadi, itu akan segera menjadi terkenal daripada jika mereka menghancurkan saya secara pribadi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya indah, berfungsi tanpa kegagalan, mudah untuk melakukan perubahan jika perlu, tidak ada server yang tidak perlu yang perlu pemeliharaan, saya puas.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id505394/index.html">Barang Antik: Nokia E90, komunikator terbaru</a></li>
<li><a href="../id505398/index.html">Sisi gelap dan terang bekerja di Yandex</a></li>
<li><a href="../id505400/index.html">Seperti apa modelnya?</a></li>
<li><a href="../id505402/index.html">Menumpangkan tekstur 2d pada objek 3d menggunakan p5.js (bagian 2 - menerapkan pola ke kubus)</a></li>
<li><a href="../id505404/index.html">Cara termudah untuk belajar bahasa Inggris dengan video TED</a></li>
<li><a href="../id505416/index.html">MikroTik dalam mode repeater - sama seperti One-Two-Three</a></li>
<li><a href="../id505418/index.html">[Pertanyaan] Pernahkah Anda melihat orang yang menggunakan langganan konten seluler?</a></li>
<li><a href="../ja504668/index.html">モバイルデベロッパー向けの興味深い資料の要約＃346（5月25〜31日）</a></li>
<li><a href="../ja504670/index.html">コンピュータサイエンスまたは苦痛における統一国家試験</a></li>
<li><a href="../ja504672/index.html">DEVOXX UK。本番環境でのKubernetes：青/緑のデプロイ、自動スケーリング、デプロイの自動化。パート2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>