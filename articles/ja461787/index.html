<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛂 📢 🕋 Androidテキスト表示 🍶 🎺 ⛹🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="テキスト情報の表示は、多くのAndroidアプリケーションでおそらく最も基本的で重要な部分です。この記事では、TextViewについて説明します。「Hello World」から始まるすべての開発者は、常にこのユーザーインターフェイス要素に直面しています。テキストを操作するときは、画面をレンダリングす...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Androidテキスト表示</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/461787/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/2_/_o/mc2__o7rq1m6ex9alol6ivz5vey.png"></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキスト情報の表示は、多くのAndroidアプリケーションでおそらく最も基本的で重要な部分です。</font><font style="vertical-align: inherit;">この記事では、TextViewについて説明します。</font><font style="vertical-align: inherit;">「Hello World」から始まるすべての開発者は、常にこのユーザーインターフェイス要素に直面しています。</font><font style="vertical-align: inherit;">テキストを操作するときは、画面をレンダリングするときに、さまざまなデザインソリューションの実装やパフォーマンスの向上を検討する必要があります。</font></font></p><br>
<p>    TextView      .        Google&nbsp;I/O.</p><a name="habracut"></a><br>
<h1 id="textview-pod-kapotom">TextView  </h1><br>
<p>    Android        .        — java-   :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hb/p0/gg/hbp0ggycnpeisn8v8hwyqkkmvfq.png" width="800"></div><br>
<p>Java-     Android SDK,   ,          support library.</p><br>
<p>  TextView   C++,     support library         .      :</p><br>
<ul>
<li>Minikin     ,      .</li>
<li>ICU   Unicode.</li>
<li>HarfBuzz        ()  .</li>
<li>FreeType    .</li>
<li>Skia –    2D .</li>
</ul><br>
<h2 id="izmerenie-dliny-teksta-i-perenos-strok">     </h2><br>
<p>    Minikin,    TextView,     ,     :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/1o/uk/qt1ouktu4gn9x0wncbgiy2a7qkg.png" width="800"></div><br>
<p>     ,           :   3      <code>ffi</code>.  ,   ,          .</p><br>
<p>          ,        ,          . ,   <strong>Android Q (29)</strong>,      ,   .       :</p><br>
<pre><code class="kotlin hljs">textView.typeface = TypeFace.CustomFallbackBuilder(<font></font>
  FontFamily.Builder(<font></font>
    Font.Builder(assets, “lato.ttf”).build()<font></font>
  ).build()<font></font>
).addCustomFallback(<font></font>
  FontFamily.Builder(<font></font>
    Font.Builder(assets, “kosugi.ttf”).build()<font></font>
  ).build()<font></font>
).build()</code></pre><br>
<p>   <code>CustomFallbackBuilder</code>      SDK    font family  ,      ,      (   <code>setSystemFallback()</code>     font family). <code>CustomFallbackBuilder</code>     font family –     64 .</p><br>
<p> Minikin         .   ,   <strong>Lollipop (21)</strong>,   <abbr title="最近使用されていない">LRU</abbr>   .       :  <code>Paint.measureText()</code>       3%      .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/d2/f1/om/d2f1omfjlqmmfqalip3whmes-1o.png" width="800"></div><br>
<p>      , Minikin       .   <strong>Marshmallow (23)</strong>    ,   TextView   <code>breakStrategy</code>  <code>hyphenationFrequency</code>.</p><br>
<p>  <code>breakStrategy=simple</code>      ,   :     ,     .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/im/lc/cr/imlccruuhjr59qzrtpwjmrf6hhk.png" width="600"></div><br>
<p>  <code>balanced</code>      ,      .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/v5/ys/kc/v5yskcuiwypdyponmrdqep7zaq8.png" width="600"></div><br>
<p><code>high_quality</code>     ,   <code>balanced</code>,     (  :          ,     ).</p><br>
<p> <code>hyphenationFrequency</code>       .  <code>none</code>      , <code>normal</code>    ,  <code>full</code>, ,    .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ng/cr/hs/ngcrhsphklaxxe842klpnx8mhnw.png" width="600"></div><br>
<p>        (  <strong>Android P (28)</strong>):</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tx/5r/33/tx5r339s93s1nq6go8hieqhv6fq.png" width="600"></div><br>
<p>     ,  Google,    <strong>Q (29)</strong>  <strong>AppCompat 1.1.0</strong>,       (<code>hyphenation</code>).      ,      .</p><br>
<p>     ,            .            .</p><br>
<h1 id="stili-teksta"> </h1><br>
<p> Android     :</p><br>
<ul>
<li><strong>  (single style)</strong>,      TextView.</li>
<li><strong> (multi style)</strong> —   ,      ,      .     :<br>
<ul>
<li>   </li>
<li>html-</li>
<li>   – span’</li>
</ul></li>
</ul><br>
<p>      XML-  XML-   TextView.           : TextAppearance,  (Theme),    (Default style),   ,    —   View.</p><br>
<p>  —    , ,  ,        .</p><br>
<p>Html- –    ,    ,      , ,         .     —    <code>Html.fromHtml()</code>,       ,  span’.      ,      html-    CSS .</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> text = <span class="hljs-string">"My text &lt;ul&gt;&lt;li&gt;bullet one&lt;/li&gt;&lt;li&gt;bullet two&lt;/li&gt;&lt;/ul&gt;"</span><font></font>
<font></font>
myTextView.text = Html.fromHtml(text)</code></pre><br>
<p>   TextView  ,         ,      :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/hr/hl/zmhrhluqvvcv77s1b85gkxbtcww.png" width="400"></div><br>
<p>   —     —       : ,      .                   .</p><br>
<h1 id="spans">Spans</h1><br>
<p>     TextView  span’.   span’     ,      ,   ,      ..</p><br>
<p>    span’:</p><br>
<ul>
<li><strong>Character spans</strong> –     .<br>
<ul>
<li><strong>Appearance affecting</strong> –    .</li>
<li><strong>Metric affecting</strong> –   .</li>
</ul></li>
<li><strong>Paragraph spans</strong> –    .</li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zy/os/x2/zyosx2ovroe15y3bd94qridaaou.png"></div><br>
<p> Android        ,     <code>onMeasure()</code>   TextView,     span’      <code>TextPaint</code>  <code>Canvas</code>. Android ,  span, ,     ,    .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fv/do/er/fvdoerpx8zxykjxvt9ru4kigica.png" width="600"></div><br>
<p> android    20+ span’,       ,  ,    SDK .</p><br>
<h3 id="appearance-vs-metric-affecting-spans">Appearance vs metric affecting spans</h3><br>
<p>  span’   ,      :  ,  ,      ..  span’   <code>UpdateAppearance</code>     <code>CharacterStyle</code>,      <code>TextPaint</code>.</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/or/8f/zl/or8fzltp5mvoyhvdey8tz1uoqhg.png"></div><br>
<p>Metric affecting span      layout’,    span’     TextView,    <code>onMeasure()</code>/<code>onLayout()</code>.  span’     <code>MetricAffectingSpan</code>,      <code>CharacterStyle</code>.</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_h/hs/hd/_hhshd0pcadvdievngojmtsqzlu.png"></div><br>
<h2 id="character-vs-paragraph-affecting-spans">Character vs paragraph affecting spans</h2><br>
<p>Paragraph span     :   ,        .  span’     <code>ParagraphStyle</code>           .    ,  span   .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/76/_n/uj/76_nujhr8rrwz-mne8bgq8p2pfu.png"></div><br>
<p> Android    ,     (<code>\n</code>).</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/p1/kq/s1p1kq9esdaakdpwh_rkxdvdygw.png"></div><br>
<h2 id="napisanie-svoih-spanov">  span’</h2><br>
<p>   span’  ,    span,  ,     :</p><br>
<ul>
<li>     → <code>CharacterStyle</code></li>
<li>     → <code>ParagraphStyle</code></li>
<li>   → <code>UpdateAppearance</code></li>
<li>   → <code>UpdateLayout</code></li>
</ul><br>
<p>  span’   :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomTypefaceSpan</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> font: Typeface?) : MetricAffectingSpan() {<font></font>
<font></font>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateMeasureState</span><span class="hljs-params">(textPaint: <span class="hljs-type">TextPaint</span>)</span></span> = update(textPaint)<font></font>
<font></font>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateDrawState</span><span class="hljs-params">(textPaint: <span class="hljs-type">TextPaint</span>)</span></span> = update(textPaint)<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(textPaint: <span class="hljs-type">TextPaint</span>)</span></span> {<font></font>
    textPaint.apply {<font></font>
      <span class="hljs-keyword">val</span> old = typeface
      <span class="hljs-keyword">val</span> oldStyle = old?.style ?: <span class="hljs-number">0</span>
      <span class="hljs-keyword">val</span> font = Typeface.create(font, oldStyle)<font></font>
<font></font>
      typeface = font <span class="hljs-comment">//   </span><font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p>,       span    ,      span –          :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CodeBlockSpan</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> font: Typeface?) : MetricAffectingSpan() {<font></font>
<font></font>
             …<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(textPaint: <span class="hljs-type">TextPaint</span>)</span></span> {<font></font>
    textPaint.apply {<font></font>
      <span class="hljs-comment">//   </span><font></font>
             …<font></font>
      bgColor = lightGray <span class="hljs-comment">//   </span><font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p> span  :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//    span</span>
spannable.setSpan(CodeBlockSpan(typeface), ...)</code></pre><br>
<p>      ,   span’:    <code>CustomTypefaceSpan</code>  <code>BackgroundColorSpan</code>  Android :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//   </span><font></font>
spannable.setSpan(BackgroundColorSpan(lightGray), ...)<font></font>
<font></font>
<span class="hljs-comment">//  </span>
spannable.setSpan(CustomTypefaceSpan(typeface), ...)</code></pre><br>
<p>     .   ,   span’     <code>Parcelable</code>,    .</p><br>
<p>     Intent       span’   .   span’    .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/is/nw/uu/isnwuux9cosllp6h0kgawifcepo.png" width="600"></div><br>
<h2 id="ispolzovanie-spanov-v-tekste"> span’  </h2><br>
<p>       : <code>Spanned</code>  <code>Spannable</code> (     )   : <code>SpannedString</code> ( ), <code>SpannableString</code> ( )  <code>SpannableStringBuilder</code> ( ).</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th> </th>
<th> </th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Spanned</strong>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Spannable</strong>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>SpannableString</strong>Builder</td>
<td></td>
<td></td>
</tr>
</tbody>
</table></div><br>
<p><code>SpannableStringBuilder</code>, ,   <code>EditText</code>,    .</p><br>
<p>  span      :</p><br>
<p><code>setSpan(Object what, int start, int end, int flags)</code></p><br>
<p>    span,      .     ,    span’    :   span   ,       (     ,  span         ).</p><br>
<p>      ,   ,    : <code>SpannedString</code>  <code>SpannableString</code>     span’,  <code>SpannableStringBuilder</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</p><br>
<p>           span',    :      ~250 span’ <code>SpannableString</code>  <code>SpannableStringBuilder</code>     ,       250,  <code>SpannableString</code>  .  ,       - ,        :      .       250 span’,      <code>SpannableStringBuilder</code>.</p><br>
<h2 id="proverka-na-nalichie-spana-v-tekste">   span’  </h2><br>
<p>   ,    spanned   span.   Stackoverflow    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">hasSpan</span><span class="hljs-params">(spanned: <span class="hljs-type">Spanned</span>, clazz: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> {
  <span class="hljs-keyword">val</span> spans: Array&lt;<span class="hljs-keyword">out</span> T&gt; = spanned.getSpans(<span class="hljs-number">0</span>, spanned.length, clazz)
  <span class="hljs-keyword">return</span> spans.isNotEmpty()<font></font>
}</code></pre><br>
<p>   ,   :     span’, ,        ,          ,    .</p><br>
<p>      <code>nextSpanTransition()</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">hasSpan</span><span class="hljs-params">(spanned: <span class="hljs-type">Spanned</span>, clazz: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> {
  <span class="hljs-keyword">val</span> limit = spanned.length
  <span class="hljs-keyword">return</span> spanned.nextSpanTransition(<span class="hljs-number">0</span>, limit, clazz) &lt; limit<font></font>
}</code></pre><br>
<h2 id="razmetka-teksta-v-razlichnyh-yazykovyh-resursah">     </h2><br>
<p>   ,            . ,     <em>“text”</em>     <em>“texto”</em>  :</p><br>
<pre><code class="xml hljs"><span class="hljs-comment">&lt;!-- values-en/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span>&gt;</span>Best practices for text in Android<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><font></font>
<font></font>
<span class="hljs-comment">&lt;!-- values-es/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">”title”</span>&gt;</span>Texto en Android: mejores prácticas<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></code></pre><br>
<p>  - , ,   ,     html- (<code>&lt;b&gt;</code>).  UI        TextView:</p><br>
<pre><code class="kotlin hljs">textView.setText(R.string.title)</code></pre><br>
<p>   -  , ,  ,  html    .      <code>&lt;annotation&gt;</code>.       -  xml-.      ,      span’ <code>Annotation</code>,        .            span’.</p><br>
<p>,       <code>CustomTypefaceSpan</code>.</p><br>
<p>        <em>“font”</em>   –  ,     – <em>“title_emphasis”</em>:<br>
</p><pre><code class="xml hljs"><span class="hljs-comment">&lt;!-- values-en/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span>&gt;</span>Best practices for <span class="hljs-tag">&lt;<span class="hljs-name">annotation</span> <span class="hljs-attr">font</span>=<span class="hljs-string">”title_emphasis”</span>&gt;</span>text<span class="hljs-tag">&lt;/<span class="hljs-name">annotation</span>&gt;</span> in Android<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><font></font>
<font></font>
<span class="hljs-comment">&lt;!-- values-es/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">”title”</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">annotation</span> <span class="hljs-attr">font</span>=<span class="hljs-string">”title_emphasis”</span>&gt;</span>Texto<span class="hljs-tag">&lt;/<span class="hljs-name">annotation</span>&gt;</span> en Android: mejores prácticas<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></code></pre><br>
<p>   ,     <em>“font”</em>   span’:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//      SpannedString,     span’</span>
<span class="hljs-keyword">val</span> titleText = getText(R.string.title) <span class="hljs-keyword">as</span> SpannedString<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">val</span> annotations = titleText.getSpans(<span class="hljs-number">0</span>, titleText.length, Annotation::<span class="hljs-keyword">class</span>.java)<font></font>
<font></font>
//     SpannableString<font></font>
//     <font></font>
<span class="hljs-keyword">val</span> spannableString = SpannableString(titleText)<font></font>
<font></font>
//    <font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">in</span> annotations) {  <font></font>
<font></font>
  //     <span class="hljs-string">"font"</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">annotation</span>.key == <span class="hljs-string">"font"</span>) {
    <span class="hljs-keyword">val</span> fontName = <span class="hljs-keyword">annotation</span>.value<font></font>
<font></font>
    <span class="hljs-comment">//   ,    </span>
    <span class="hljs-keyword">if</span> (fontName == <span class="hljs-string">"title_emphasis"</span>) {
      <span class="hljs-keyword">val</span> typeface = getFontCompat(R.font.permanent_marker)
      <span class="hljs-comment">//  span    ,   </span><font></font>
      spannableString.setSpan(<font></font>
        CustomTypefaceSpan(typeface),<font></font>
        titleText.getSpanStart(<span class="hljs-keyword">annotation</span>),<font></font>
        titleText.getSpanEnd(<span class="hljs-keyword">annotation</span>),<font></font>
        Spannable.SPAN_EXCLUSIVE_EXCLUSIVE<font></font>
      )<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
styledText.text = spannableString<font></font>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yq/62/mm/yq62mmgvajffkxkzk3qntsnxhw4.png" width="600"></div><br>
<p> ,  span’   Android-    <code>Parcelable</code>    Intent.      ,   <code>Parcelable</code>.        Intent      ,   span’.</p><br>
<h1 id="kak-tekst-raspolagaetsya-v-textview">    TextView</h1><br>
<p>TextView     ,   .       .     ,  TextView    Layout,     .   ,    ,       ,      :</p><br>
<ul>
<li><strong>BoringLayout</strong>    ,    , RTL   ,      . TextView  ,     .</li>
<li><strong>StaticLayout</strong>   TextView   .</li>
<li><strong>DynamicLayout</strong>      EditText.</li>
</ul><br>
<p> Layout   ,       :  , baseline,         .. (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)</p><br>
<p>     . ,             ,       span’,       .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/-2/df/8b-2df4-wo4ghk8tkwss6l48bfy.png" width="300"></div><br>
<p>       Layout.   :</p><br>
<p>    ,      .</p><br>
<p>  4 drawable      ,      :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/q4/ry/oj/q4ryojq_lsj3sdyyehvprallpl8.png" width="600"></div><br>
<p>      ,    .          .   Layout    ,     ,    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> startLine = layout.getLineForOffset(spanStartIndex)
<span class="hljs-keyword">val</span> endLine = layout.getLineForOffset(spanEndIndex)</code></pre><br>
<p>      .   ,        ,          .     :</p><br>
<pre><code class="kotlin hljs">...<font></font>
<font></font>
<span class="hljs-keyword">if</span> (startLine == endLine) {
  <span class="hljs-keyword">val</span> lineTop = layout.getLineTop(startLine) <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">val</span> lineBottom = layout.getLineBottom(startLine) <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">val</span> startCoor = layout.getPrimaryHorizontal(spanStartIndex).toInt() <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">val</span> endCoor = layout.getPrimaryHorizontal(spanEndIndex).toInt() <span class="hljs-comment">//   </span><font></font>
<font></font>
  <span class="hljs-comment">//  </span><font></font>
  drawable.setBounds(startCoor, lineTop, endCoor, lineBottom)<font></font>
  drawable.draw(canvas)<font></font>
<font></font>
...<font></font>
</code></pre><br>
<p>    , Layout        ,        .</p><br>
<h1 id="proizvoditelnost-textview"> TextView</h1><br>
<p>TextView,    View,      : <code>onMeasure()</code>, <code>onLayout()</code>  <code>onDraw()</code>.   <code>onMeasure()</code>    ,      :      Layout     .      (,  )     .       ,      <code>onDraw()</code>.   ,         .      ,    <code>onMeasure()</code>    11-16%  ,      .</p><br>
<h2 id="uskorenie-pokaza-teksta">  </h2><br>
<p> 2015   Instagram     ,   .    ,         ,   “”  .     ,     ,          .</p><br>
<p>  <strong>Android P (28)</strong>  Google   API           – <code>PrecomputedText</code> (   API   <strong>Android I (14)</strong> — <code>PrecomputedTextCompat</code>).    API      90% .</p><br>
<p>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">// UI thread</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> params: PrecomputedText.Params = textView.getTextMetricsParams()
<span class="hljs-keyword">val</span> ref = WeakReference(textView)<font></font>
<font></font>
executor.execute {<font></font>
<font></font>
  <span class="hljs-comment">// background thread</span>
  <span class="hljs-keyword">val</span> text = PrecomputedText.create(<span class="hljs-string">"Hello"</span>, params)
  <span class="hljs-keyword">val</span> textView = ref.<span class="hljs-keyword">get</span>()<font></font>
   textView?.post {<font></font>
<font></font>
    <span class="hljs-comment">// UI thread</span>
    <span class="hljs-keyword">val</span> textView = ref.<span class="hljs-keyword">get</span>()<font></font>
    textView?.text = text<font></font>
  }<font></font>
}</code></pre><br>
<h2 id="pokaz-bolshogo-teksta">  </h2><br>
<p>    ,        TextView.          ,         ,    ,  , ,      .       (, )      RecyclerView.          ,  PrecomputedText.</p><br>
<p>   PrecomputedText  RecyclerView  Google    <code>PrecomputedTextCompat.getTextFuture()</code>  <code>AppCompatTextView.setTextFuture()</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(vh: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {<font></font>
<font></font>
  <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = getData(position)<font></font>
  vh.textView.setTextSize(...)<font></font>
  vh.textView.setFontVariationSettings(...)<font></font>
<font></font>
  <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">val</span> future = PrecomputedTextCompat.getTextFuture(
    <span class="hljs-keyword">data</span>.text, vh.textView.getTextMetricsParamsCompat(), myExecutor<font></font>
  )<font></font>
<font></font>
  <span class="hljs-comment">//  future  TextView,      onMeasure()</span><font></font>
  vh.textView.setTextFuture(future)<font></font>
}</code></pre><br>
<p>  RecyclerView      ,     ,              ,     .</p><br>
<p> ,     <code>getTextFuture()</code>     (,   ),     ,   ,    <code>getTextFuture()</code>,     ,    TextView.</p><br>
<h2 id="chto-nuzhno-znat-kogda-ustanavlivaesh-tekst-v-textview">  ,     TextView</h2><br>
<p>   <code>TextView.setText()</code>       :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (type == SPANNABLE || movementMethod != <span class="hljs-keyword">null</span>) {<font></font>
  text = spannableFactory.newSpannable(spannable) <span class="hljs-comment">// </span>
} <span class="hljs-keyword">else</span> {<font></font>
  text = <span class="hljs-keyword">new</span> SpannedString(spannable) <span class="hljs-comment">// </span>
}</code></pre><br>
<p>      span’  TextView,       <code>setText()</code> ,      .</p><br>
<p>   ,      .  TextView    ,  -,   .    ,      .    ,    ,     TextView   <code>spannableFactory</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySpannableFactory</span> : <span class="hljs-type">Spannable.Factory</span></span>() {
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newSpannable</span><span class="hljs-params">(source: <span class="hljs-type">CharSequence</span>)</span></span>: Spannable {
    <span class="hljs-keyword">return</span> source <span class="hljs-keyword">as</span>? Spannable ?: <span class="hljs-keyword">super</span>.newSpannable(source)<font></font>
  }<font></font>
}<font></font>
<font></font>
textView.spannableFactory = MySpannableFactory()</code></pre><br>
<p>        <code>textView.setText(spannable, BufferType.SPANNABLE)</code>,      .</p><br>
<p> Google         span’  RecyclerView,      .</p><br>
<p>     TextView,     span,        <code>setText()</code>.      TextView      span. TextView   spannable-    span’,  :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> spannable = textView.getText() <span class="hljs-keyword">as</span> Spannable
<span class="hljs-keyword">val</span> span = CustomTypefaceSpan(span)<font></font>
<font></font>
spannable.setSpan(span, ...)</code></pre><br>
<p>     span,      TextView,         TextView .       ,   <code>invalidate()</code>,    – <code>requestLayout()</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> spannable = textView.getText() <span class="hljs-keyword">as</span> Spannable
<span class="hljs-keyword">val</span> span = CustomTypefaceSpan(span)<font></font>
<font></font>
spannable.setSpan(span, ...)<font></font>
<font></font>
span.setTypeface(anotherTypeface)<font></font>
<font></font>
textView.requestLayout() <span class="hljs-comment">// re-measure and re-draw</span><font></font>
<font></font>
<span class="hljs-comment">// or</span><font></font>
<font></font>
textView.invalidate() <span class="hljs-comment">// re-draw</span></code></pre><br>
<h2 id="ispolzovanie-autolink"> autoLink</h2><br>
<p> TextView     .         <code>autoLink</code>.   <code>autoLink=”web”</code> TextView          URL          <code>URLSpan</code>.   ,     SDK   <code>setText()</code>:</p><br>
<pre><code class="java hljs">spannable = <span class="hljs-keyword">new</span> SpannableString(string);<font></font>
Matcher m = pattern.matcher(text);<font></font>
<font></font>
<span class="hljs-keyword">while</span> (...) { <span class="hljs-comment">//     </span><font></font>
  String utl = …<font></font>
  URLSpan span = <span class="hljs-keyword">new</span> URLSpan(url);<font></font>
  spannable.setSpan(span, ...);<font></font>
}</code></pre><br>
<p>     UI ,     <code>autoLink=”web”</code>   RecyclerView.          .        <code>LinkifyCompat</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//  ,       background thread</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> spannable = SpannableString(string)<font></font>
LinkifyCompat.addLinks(spannable, Linkify.WEB_URLS)<font></font>
<font></font>
<span class="hljs-comment">//   RecyclerView</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {<font></font>
<font></font>
  holder.textView.setText(spannable, BufferType.SPANNABLE)<font></font>
<font></font>
  <span class="hljs-comment">// ...</span>
}</code></pre><br>
<p> <code>autoLink</code>      <code>map</code> –    (      <code>all</code>).       .   ,        WebView,      !    SDK   <code>Linkify.gatherMapLinks()</code>    ,      :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">while</span> ((address = WebView.findAddress(string)) != <span class="hljs-keyword">null</span>) {<font></font>
        ...<font></font>
}</code></pre><br>
<p>  WebView  TODO   SDK:</p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">findAddress</span><span class="hljs-params">(String addr)</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rewrite this in Java so it is not needed to start up chromium</span>
  <span class="hljs-comment">// Could also be deprecated</span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> getFactory().getStatics().findAddress(addr);<font></font>
}</code></pre><br>
<p>    ?     Smart Linkify,       <strong>Android P (28)</strong>,          ,      .    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">// UI thread</span><font></font>
<font></font>
<span class="hljs-keyword">val</span> text: Spannable = …
<span class="hljs-keyword">val</span> request = TextLinks.Request.Builder(text)
<span class="hljs-keyword">val</span> ref = WeakReference(textView)<font></font>
<font></font>
executor.execute {<font></font>
<font></font>
  <span class="hljs-comment">// background thread</span><font></font>
  TextClassifier.generateLinks(request).apply(text)<font></font>
<font></font>
  <span class="hljs-keyword">val</span> textView = ref.<span class="hljs-keyword">get</span>()<font></font>
  textView?.post {<font></font>
    <span class="hljs-comment">// UI thread</span>
    <span class="hljs-keyword">val</span> textView = ref.<span class="hljs-keyword">get</span>()<font></font>
    textView?.text = text<font></font>
  }<font></font>
}</code></pre><br>
<p>   Linkify,      .        toolbar   ,     Google .</p><br>
<p> Smart Linkify    :  ,    .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/nc/qb/9tncqbkanp8avsnmisd-ax0z7ae.gif" width="300"></div><br>
<h1 id="magnifier">Magnifier</h1><br>
<p>  <strong>Android P (28)</strong>,     – Magnifier,       .           .</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fi/nn/or/finnor2svtuttfn1v-lxwkblgwm.gif" width="400"></div><br>
<p>     TextView, EditText  WebView,            :  API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</p><br>
<h1 id="zaklyuchenie"></h1><br>
<p>         Android   ,   , :</p><br>
<ul>
<li>       </li>
<li>  </li>
<li>  ,   TextView (, EditText)</li>
</ul><br>
<p> -     ,      Google I/O'19 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">“Best Practices for Using Text in Android”</a>.</p><br>
<a name="links"></a><br>
<h1 id="poleznye-ssylki"> </h1><br>
<h2 id="stati"></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Florina Muntenescu. "Spantastic text styling with Spans"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Florina Muntenescu. "Underspanding spans"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Florina Muntenescu. "Styling internationalized text in Android"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Instagram Engineering. "Improving Comment Rendering on Android"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Daniel Lee. "Text rendering on Android"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Mariusz Dąbrowski. "What is new in Android P — PrecomputedText"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Chet Haase. "RecyclerView Prefetch"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Chris Craik. "Prefetch Text Layout in RecyclerView"</a></li>
</ul><br>
<h2 id="doklady"></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Best practices for text on Android (Google I/O '18)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Use Android Text Like a Pro (Android Dev Summit '18)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Best Practices for Using Text in Android (Google I/O'19)</a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461773/index.html">Airtest IDE-モバイルゲームの自動化をテストする新しい方法？</a></li>
<li><a href="../ja461775/index.html">DjangoアプリケーションでCeleryを使用する3つのケース</a></li>
<li><a href="../ja461779/index.html">会社のデータの80％は利用できません。どうする？</a></li>
<li><a href="../ja461781/index.html">「Ycombinator Startup School 2019」。最初の3週間のビデオ</a></li>
<li><a href="../ja461785/index.html">RISC-Vの欠点</a></li>
<li><a href="../ja461793/index.html">Ivan Ponomarevがjug.msk.ruミーティングでKafka Streams APIについて</a></li>
<li><a href="../ja461797/index.html">テイルズオブサービス。深刻な仕事についてのばかげた投稿</a></li>
<li><a href="../ja461801/index.html">DisplayPort-LVDS</a></li>
<li><a href="../ja461803/index.html">データバージョン管理（DVC）：データのバージョン管理と実験の再現性</a></li>
<li><a href="../ja461805/index.html">レンダリングにおけるモンテカルロ統合アプリケーション</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>