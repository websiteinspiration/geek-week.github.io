<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé∞ üìø ‚úäüèª Laravel + Docker + Gitlab. Where to begin üë∂üèª üï≥Ô∏è üëäüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I usually always did without a docker and thought that a docker is needed only for large projects in large companies. But one day I saw how a docker w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Laravel + Docker + Gitlab. Where to begin</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491532/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I usually always did without a docker and thought that a docker is needed only for large projects in large companies. </font><font style="vertical-align: inherit;">But one day I saw how a docker works in tandem with a friend‚Äôs gitlab and realized that I still should study it. </font><font style="vertical-align: inherit;">However, as usually happens, I did not find one suitable article - they were either too complex or incomplete, or implied that you all know by itself. </font><font style="vertical-align: inherit;">I had to look for various sources for a long time, put it all together and in the end I managed to make a simple project and CI / CD for it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All work can be divided into three parts: on the local machine, on the hitlab and on the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, for the implementation of the project, we need a gitlab account and a remote server with KVM or XEN virtualization.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1. Local machine</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the local machine, you need to install docker. </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment</font></font></b><div class="spoiler_text">  . Docker     Linux  ( Ubuntu, ),    Windows  MacOS.   macos     ,     Windows      .   - ,        linux .   - ,           .       VirtualBox.          Ubuntu     <br>
</div></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To install on a Linux environment, you must run the following commands. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Delete old containers:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get remove docker docker-engine docker.io containerd runc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update apt:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the following packages so that you can download docker from the repository via https:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install \<font></font>
    apt-transport-https \<font></font>
    ca-certificates \<font></font>
    curl \<font></font>
    gnupg-agent \<font></font>
    software-properties-common</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add official GPG docker key:</font></font><br>
<br>
<pre><code class="bash hljs">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Make sure the print is correct:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-key fingerprint 0EBFCD88</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Answer:</font></font><br>
<br>
<pre><code class="bash hljs">pub   rsa4096 2017-02-22 [SCEA]<font></font>
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88<font></font>
uid           [ unknown] Docker Release (CE deb) &lt;docker@docker.com&gt;<font></font>
sub   rsa4096 2017-02-22 [S]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download stable version:</font></font><br>
<br>
<pre><code class="bash hljs">sudo add-apt-repository \
   <span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="hljs-subst">$(lsb_release -cs)</span> \
   stable"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update apt again:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the latest docker engine:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install docker-ce docker-ce-cli containerd.io</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check docker operation:</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker run hello-world</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is correct, the download of the Hello World image will begin. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full instructions in the official documentation of the docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also need to install docker-compose. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The official instruction is here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To install it, execute the commands in the terminal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download from repository:</font></font><br>
<br>
<pre><code class="bash hljs">sudo curl -L <span class="hljs-string">"https://github.com/docker/compose/releases/download/1.25.4/docker-compose-<span class="hljs-subst">$(uname -s)</span>-<span class="hljs-subst">$(uname -m)</span>"</span> -o /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adding an exercise right:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Version Check:</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker-compose --version</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We installed the docker, now it is necessary to collect the image. </font><font style="vertical-align: inherit;">To do this, I used the article from the digitalocean website: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.digitalocean.com/community/tutorials/how-to-set-up-laravel-nginx-and-mysql-with-docker-compose-ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There will be a reprint of this article. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Downloading Laravel and installing dependencies</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the first step, we download the latest version of Laravel and install the project dependencies, including Composer, the application-level PHP package manager. </font><font style="vertical-align: inherit;">We will install these dependencies using Docker so as not to perform a global installation of Composer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to your home directory and clone the latest version of Laravel into a directory called laravel-app:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~<font></font>
git <span class="hljs-built_in">clone</span> https://github.com/laravel/laravel.git laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to laravel-app directory:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then mount the composer image from Docker into the directories you need for your Laravel project to avoid the overhead of installing Composer globally:</font></font><br>
<br>
<pre><code class="bash hljs">docker run --rm -v $(<span class="hljs-built_in">pwd</span>):/app composer install</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The -v and --rm flags of the docker run command create a virtual container that binds to the current directory until it is deleted. </font><font style="vertical-align: inherit;">The contents of your ~ / laravel-app directory will be copied to the container, and the contents of the Composer created inside the vendor folder container will be copied to the current directory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, set the permissions level in the project directory so that it is owned by a user without root privileges:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will be important when you write the Dockerfile for the image of your application, as it will allow you to work with the application code and start processes in the container without root privileges. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you have placed the application code and can proceed to the definition of services using Docker Compose. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a Docker Compose File</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Building applications with Docker Compose simplifies the configuration and versioning process in your infrastructure. To customize our Laravel application, we will create a docker-compose file with the definition of web server services, database and application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open the file:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/docker-compose.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Three services are defined in the docker-compose file: app, webserver and db. </font><font style="vertical-align: inherit;">Add the following code to the file, while replacing the root password for MYSQL_ROOT_PASSWORD, defined as the db service environment variable, with a password of your choice:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">version: '3'<font></font>
services:<font></font>
<font></font>
  #PHP Service<font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #Nginx Service<font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "80:80"<font></font>
      - "443:443"<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #MySQL Service<font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "3306:3306"<font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
#Docker Networks<font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following services are included here:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app: This service definition contains the Laravel application and launches the personalized Docker image, digitalocean.com/php. </font><font style="vertical-align: inherit;">It also sets the working_dir parameter in the container to / var / www.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webserver: this service definition takes the nginx: alpine image from Docker and opens ports 80 and 443.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">db: this service definition retrieves the mysql: 5.7.22 image from Docker and defines new environment variables, including the laravel database for your application and the root password for the database. </font><font style="vertical-align: inherit;">You can use any database name you want, you should also replace your_mysql_root_password with your own strong password. </font><font style="vertical-align: inherit;">This service definition also maps host port 3306 to container port 3306.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each container_name property defines a container name corresponding to the service name. </font><font style="vertical-align: inherit;">If you do not define this property, Docker will give each container names consisting of the name of a historical person and a random word, separated by an underscore.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To simplify the interaction between containers, services connect to the connecting network called app-network. The connecting network uses a software bridge that allows containers connected to this network to communicate with each other. The bridge driver automatically sets host rules so that containers on different connecting networks cannot communicate directly with each other. This improves application security because only related services can communicate with each other. It also means that you can specify different networks and services that connect to related functions: for example, client application services can use the frontend network, and server services can use the backend network.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, let's see how to add volumes and bind mounted images to service definitions to permanently save application data. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persistent data storage</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Docker has powerful and convenient means for persistent data storage. </font><font style="vertical-align: inherit;">In our application, we will use volumes and mounted images to permanently save database files, applications, and configurations. </font><font style="vertical-align: inherit;">Volumes provide backup flexibility and preservation upon termination of the container's life cycle, and mountable mountable images make it easy to modify code during development by immediately reflecting changes to host files or directories in containers. </font><font style="vertical-align: inherit;">We use both options.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warning!</font></font></b><div class="spoiler_text">             ,   ,        .      ,       Docker   .       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Define the volume named dbdata in the docker-compose file in the db service definition to persist the MySQL database:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A volume named dbdata is used to permanently save the contents of the / var / lib / mysql folder inside the container. </font><font style="vertical-align: inherit;">This allows you to stop and restart the db service without losing data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add a dbdata volume definition at the end of the file:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#Volumes<font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: local</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this definition, you can use this volume for different services. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then add the mount image binding to the db service for the MySQL configuration files:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This mounted image binds the ~ / laravel-app / mysql / my.cnf file to the /etc/mysql/my.cnf directory in the container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then add the mounted images to the web server service. </font><font style="vertical-align: inherit;">There will be two: one for the application code, and the other for determining the Nginx configuration</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#Nginx Service<font></font>
webserver:<font></font>
  ...<font></font>
  volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
  networks:<font></font>
      - app-network</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first mounted image binds the application code in the ~ / laravel-app directory to the / var / www directory inside the container. The configuration file, added to ~ / laravel-app / nginx / conf.d /, is also mounted in /etc/nginx/conf.d/ in the container, which allows you to add and change the contents of the configuration directory as needed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, add the following mounts of mounted images to the app service for application code and configuration files:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#PHP Service<font></font>
app:<font></font>
  ...<font></font>
  volumes:<font></font>
       - ./:/var/www<font></font>
       - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini<font></font>
  networks:<font></font>
      - app-network<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The app service binds the mounted image of the ~ / laravel-app folder, which contains the application code, to the / var / www folder. This will speed up the development process, since any changes in the local application directory will immediately be reflected in the container. You also attach the PHP configuration file ~ / laravel-app / php / local.ini to the /usr/local/etc/php/conf.d/local.ini file in the container. Later you will create a local PHP configuration file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Your docker-compose file will now look like this:</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="bash hljs">version: <span class="hljs-string">'3'</span><font></font>
services:<font></font>
<font></font>
  <span class="hljs-comment">#PHP Service</span><font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./php/local.ini:/usr/<span class="hljs-built_in">local</span>/etc/php/conf.d/local.ini<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#Nginx Service</span><font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"80:80"</span>
      - <span class="hljs-string">"443:443"</span><font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#MySQL Service</span><font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"3306:3306"</span><font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql/<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
<span class="hljs-comment">#Docker Networks</span><font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge<font></font>
<span class="hljs-comment">#Volumes</span><font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: <span class="hljs-built_in">local</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a Dockerfile</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Docker allows you to define the environment inside individual containers using a Dockerfile. </font><font style="vertical-align: inherit;">Dockerfile allows you to create personalized images. </font><font style="vertical-align: inherit;">which can be used to install the required application software and change the settings as required. </font><font style="vertical-align: inherit;">You can transfer created images to the Docker Hub or any private registry. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Dockerfile will be located in the ~ / laravel-app directory. </font><font style="vertical-align: inherit;">Create a file:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/Dockerfile</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This Dockerfile will specify the base image and the necessary commands and instructions to build the Laravel application image. </font><font style="vertical-align: inherit;">Add the following code to the file:</font></font><br>
<br>
<code>~/laravel-app/php/Dockerfile</code><br>
<br>
<pre><code class="xml hljs">FROM php:7.2-fpm<font></font>
<font></font>
# Copy composer.lock and composer.json<font></font>
COPY composer.lock composer.json /var/www/<font></font>
<font></font>
# Set working directory<font></font>
WORKDIR /var/www<font></font>
<font></font>
# Install dependencies<font></font>
RUN apt-get update &amp;&amp; apt-get install -y \<font></font>
    build-essential \<font></font>
    mysql-client \<font></font>
    libpng-dev \<font></font>
    libjpeg62-turbo-dev \<font></font>
    libfreetype6-dev \<font></font>
    locales \<font></font>
    zip \<font></font>
    jpegoptim optipng pngquant gifsicle \<font></font>
    vim \<font></font>
    unzip \<font></font>
    git \<font></font>
    curl<font></font>
<font></font>
# Clear cache<font></font>
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*<font></font>
<font></font>
# Install extensions<font></font>
RUN docker-php-ext-install pdo_mysql mbstring zip exif pcntl<font></font>
RUN docker-php-ext-configure gd --with-gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/<font></font>
RUN docker-php-ext-install gd<font></font>
<font></font>
# Install composer<font></font>
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer<font></font>
<font></font>
# Add user for laravel application<font></font>
RUN groupadd -g 1000 www<font></font>
RUN useradd -u 1000 -ms /bin/bash -g www www<font></font>
<font></font>
# Copy existing application directory contents<font></font>
COPY . /var/www<font></font>
<font></font>
# Copy existing application directory permissions<font></font>
COPY --chown=www:www . /var/www<font></font>
<font></font>
# Change current user to www<font></font>
USER www<font></font>
<font></font>
# Expose port 9000 and start php-fpm server<font></font>
EXPOSE 9000<font></font>
CMD ["php-fpm"]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, the Dockerfile creates the image on top of the php: 7.2-fpm Docker image. This is an image based on an installed instance of PHP FastCGI PHP-FPM. This file also installs the required packages for Laravel: mcrypt, pdo_mysql, mbstring and imagick with composer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The RUN directive specifies commands for updating, installing, and configuring parameters inside a container, including a dedicated user and a group named www. The WORKDIR statement sets the directory / var / www as the working directory of the application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating a separate user and group with limited access rights reduces the vulnerability when launching Docker containers, which by default run with root privileges. Instead of running this container with root privileges, we created a www user with read and write permissions for the / var / www folder using the COPY command with the --chown flag to copy the permissions of the application folder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The EXPOSE command opens port 9000 in the container for the php-fpm server. CMD indicates the command that should be run after the container is created. Here, CMD indicates the php-fpm command that starts the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you are finished making changes, save the file and close the editor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can move on to defining your PHP configuration. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP setup</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You have defined the infrastructure in the docker-compose file, and now you can configure the PHP service to act as a PHP processor for incoming Nginx requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To configure PHP, you will create a local.ini file in the php folder. </font><font style="vertical-align: inherit;">This is the file that you linked to the /usr/local/etc/php/conf.d/local.ini file in the container above. </font><font style="vertical-align: inherit;">Creating this file will allow you to ignore the default php.ini file that PHP reads at startup. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a php directory:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then open the local.ini file:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/php/local.ini</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To demonstrate PHP setup, we will add the following code to set file upload size limits:</font></font><br>
<br>
<code>~/laravel-app/php/local.ini</code><br>
<br>
<pre><code class="xml hljs">upload_max_filesize=40M<font></font>
post_max_size=40M</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The upload_max_filesize and post_max_size directives set the maximum allowed size of the uploaded files and show how to set php.ini configurations from the local.ini file. You can insert any PHP configuration parameter that you want to ignore in the local.ini file. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Nginx</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When you configure the PHP service, you can modify the Nginx service to use PHP-FPM as a FastCGI server to serve dynamic content. The FastCGI server is based on a binary protocol for the interaction of interactive programs with a web server. Additional information can be found in the article ‚ÄúUnderstanding and Implementing FastCGI Proxies in Nginx‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To configure Nginx, you will create an app.conf file with the services configuration in the ~ / laravel-app / nginx / conf.d / folder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First create the nginx / conf.d / directory:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p ~/laravel-app/nginx/conf.d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then create the app.conf configuration file:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/nginx/conf.d/app.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the following code to the file to configure Nginx:</font></font><br>
<br>
<code>~/laravel-app/nginx/conf.d/app.conf</code><br>
<br>
<pre><code class="xml hljs">server {<font></font>
    listen 80;<font></font>
    index index.php index.html;<font></font>
    error_log  /var/log/nginx/error.log;<font></font>
    access_log /var/log/nginx/access.log;<font></font>
    root /var/www/public;<font></font>
    location ~ \.php$ {<font></font>
        try_files $uri =404;<font></font>
        fastcgi_split_path_info ^(.+\.php)(/.+)$;<font></font>
        fastcgi_pass app:9000;<font></font>
        fastcgi_index index.php;<font></font>
        include fastcgi_params;<font></font>
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<font></font>
        fastcgi_param PATH_INFO $fastcgi_path_info;<font></font>
    }<font></font>
    location / {<font></font>
        try_files $uri $uri/ /index.php?$query_string;<font></font>
        gzip_static on;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server block configures the Nginx web server using the following directives:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listen: this directive defines the port that the server listens for incoming requests.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error_log and access_log: these directives define files for logging.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root: this directive sets the path to the root folder, forming the full path for any requested file in the local file system.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the php location block, the fastcgi_pass directive indicates that the app service is listening on a TCP socket on port 9000. With it, the PHP-FPM server listens on the network, not on the Unix socket. Although the Unix socket provides a slight speed advantage over the TCP socket, it does not have a network protocol and it skips the network stack. In cases where hosts are located on the same system, using a Unix socket may make sense, but if the services are running on different hosts, the TCP socket provides an advantage by allowing you to connect to distributed services. Since our app and webserver containers run on different hosts, it is more efficient to use a TCP socket in our configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you are finished making changes, save the file and close the editor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to the binding created earlier, any changes in the nginx / conf.d / folder are directly reflected in the webserver container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's look at the MySQL parameters. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up MySQL</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After setting up PHP and Nginx, you can activate MySQL as a database for your application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To configure MySQL, you need to create the my.cnf file in the mysql folder. </font><font style="vertical-align: inherit;">This is the file that you attached to the /etc/mysql/my.cnf file inside the container during the database configuration phase. </font><font style="vertical-align: inherit;">Mounting the mounted image allows you to ignore any my.cnf options, if and when required. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To demonstrate how this works, we will add settings to my.cnf that include the general query log and set the log file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a mysql directory:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the my.cnf file:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the following code to the file to activate the query log and set the location of the log file:</font></font><br>
<br>
<code>~/laravel-app/mysql/my.cnf</code><br>
<br>
<pre><code class="xml hljs">[mysqld]<font></font>
general_log = 1<font></font>
general_log_file = /var/lib/mysql/general.log</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The my.cnf file supports logs by setting the general_log parameter to 1, which enables general logs. </font><font style="vertical-align: inherit;">The general_log_file parameter specifies where the logs will be stored. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Starting containers and changing environment settings</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You defined all the services in the docker-compose file and created configuration files for these services. </font><font style="vertical-align: inherit;">Now you can run containers. </font><font style="vertical-align: inherit;">In conclusion, we will create a copy of the .env.example file that Laravel includes by default and name it .env, since Laravel uses such a file to determine the environment:</font></font><br>
<br>
<pre><code class="bash hljs">cp .env.example .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After starting the containers, we will configure specific installation parameters in this file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now all your services are defined in the docker-compose file, and you just need to run one command to start all containers, create volumes and configure and connect networks:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose up -d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first time you launch docker-compose up, all the necessary Docker images will be downloaded, which may take some time. </font><font style="vertical-align: inherit;">After downloading the images and saving them on the local computer, Compose will create your containers. </font><font style="vertical-align: inherit;">The -d flag converts the process into a daemon with which containers remain running in the background. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the process is complete, use the following command to list all running containers:</font></font><br>
<pre><code class="bash hljs">docker ps</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will see the following results with data on the app, webserver and db containers:</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
CONTAINER ID        NAMES               IMAGE                             STATUS              PORTS<font></font>
c31b7b3251e0        db                  mysql:5.7.22                      Up 2 seconds        0.0.0.0:3306-&gt;3306/tcp<font></font>
ed5a69704580        app                 digitalocean.com/php              Up 2 seconds        9000/tcp<font></font>
5ce4ee31d7c0        webserver           nginx:alpine                      Up 2 seconds        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In these results, the CONTAINER ID is a unique identifier for each container, and NAMES lists the service names for each container. </font><font style="vertical-align: inherit;">You can use both of these identifiers to access containers. </font><font style="vertical-align: inherit;">IMAGE defines the image name of each container, and STATUS provides information on the status of the container: started, restarted, or stopped. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can modify the .env file in the app container to add specific parameters to your system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open the file with docker-compose exec, which allows you to run specific commands in containers. </font><font style="vertical-align: inherit;">In this case, you open the file for editing:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app nano .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Locate the block specifying DB_CONNECTION and update it to reflect your system setup. </font><font style="vertical-align: inherit;">You will change the following fields:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_HOST will be your db database container.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_DATABASE will be the laravel database.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_USERNAME will be the username for your database. </font><font style="vertical-align: inherit;">In this case, we will use laraveluser.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_PASSWORD will be a password protected for this user account.</font></font></li>
</ol><br>
<code>/var/www/.env</code><br>
<br>
<pre><code class="xml hljs">DB_CONNECTION=mysql<font></font>
DB_HOST=db<font></font>
DB_PORT=3306<font></font>
DB_DATABASE=laravel<font></font>
DB_USERNAME=laraveluser<font></font>
DB_PASSWORD=your_laravel_db_password</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also necessary to correct the same variables in the .env.example file, since it will be used later when deploying to the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then configure the application key for Laravel with the php artisan key: generate command. </font><font style="vertical-align: inherit;">This command will generate a key and copy it to the .env file, which will protect user sessions and encrypted data:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan key:generate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you have all the necessary environment settings to run the application. </font><font style="vertical-align: inherit;">To cache these settings in a file that speeds up application loading, run the command:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan config:cache</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuration settings will be uploaded to the /var/www/bootstrap/cache/config.php file in the container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, open the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> site in your browser </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The main page of the Laravel application opens. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a MySQL user</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When installing MySQL, by default only an administrative root account is created with unlimited privileges to access the database server. </font><font style="vertical-align: inherit;">Typically, when working with a database, it is best to avoid using an administrative root account. </font><font style="vertical-align: inherit;">Instead, we will create a special database user for our application‚Äôs Laravel database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create a new user, start the bash interactive shell in the db container using the docker-compose exec command:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> db bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside the container, log in to the MySQL root administrative account:</font></font><br>
<br>
<pre><code class="sql hljs">mysql -u root -p</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will be prompted to enter the password specified for the MySQL root account when installed in the docker-compose file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, check for the laravel database defined in the docker-compose file. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the show databases command to verify existing databases:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">show</span> <span class="hljs-keyword">databases</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the results you should see the laravel database:</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
+--------------------+<font></font>
| Database           |<font></font>
+--------------------+<font></font>
| information_schema |<font></font>
| laravel            |<font></font>
| mysql              |<font></font>
| performance_schema |<font></font>
| sys                |<font></font>
+--------------------+<font></font>
5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then create a user account that will be allowed access to this database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use the laraveluser username, but you can replace it with any preferred name. </font><font style="vertical-align: inherit;">Just make sure the username and password match those in the .env file in the previous step:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> laravel.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'laraveluser'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'your_laravel_db_password'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update privileges to notify MySQL server of changes:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Close MySQL:</font></font><br>
<br>
<pre><code class="sql hljs">EXIT;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exit the container:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">exit</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can do the migration to test the database:</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan migrate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results of the migration confirmation are as follows:</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
<font></font>
Migration table created successfully.<font></font>
Migrating: 2014_10_12_000000_create_users_table<font></font>
Migrated:  2014_10_12_000000_create_users_table<font></font>
Migrating: 2014_10_12_100000_create_password_resets_table<font></font>
Migrated:  2014_10_12_100000_create_password_resets_table</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2. Gitlab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Hitlab, you need to create a new project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to save the project in the hitlab repository. </font><font style="vertical-align: inherit;">To do this, call the following commands from the project folder on the local machine:</font></font><br>
<br>
<pre><code class="bash hljs">git init<font></font>
git remote add origin git@gitlab.com:&lt;&gt;/&lt;&gt;  <font></font>
git remote add origin https://gitlab.com/&lt;&gt;/&lt;&gt;      SSH<font></font>
git add .<font></font>
git commit -m <span class="hljs-string">"Initial commit"</span>
git push -u origin master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project should appear in Project Overview -&gt; Details. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make it convenient to immediately get the finished environment, we save the docker image of the environment in the hitlist register. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you must do:</font></font><br>
<br>
<pre><code class="bash hljs">docker login registry.gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And throw the image on gitlab:</font></font><br>
<br>
<pre><code class="bash hljs">docker build -t registry.gitlab.com/&lt;&gt;/&lt;&gt; .<font></font>
docker push registry.gitlab.com/&lt;&gt;/&lt;&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The image will be located in Packages-&gt; Container Registry. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To finish with gitlab, we immediately get the key to gitlab-runner. </font><font style="vertical-align: inherit;">To do this, go to Setting-&gt; CI / CD-&gt; Runner. </font><font style="vertical-align: inherit;">The key is in step 3 in the section Manual configuration (Set up a specific Runner manually).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 3. Server configuration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPS server must be taken with virtualization type KVM or XEN. </font><font style="vertical-align: inherit;">Virtualization like OpenVZ shares the core of the system between all users, so it does not have the ability to change kernel parameters. </font><font style="vertical-align: inherit;">For the test, I took the KVM server with Docker preinstalled. </font><font style="vertical-align: inherit;">However, there may not be a docker on the server. </font><font style="vertical-align: inherit;">In this case, you must install it manually. </font><font style="vertical-align: inherit;">The algorithm is the same as when installing on the local machine. </font><font style="vertical-align: inherit;">It is also necessary to check the php version. </font><font style="vertical-align: inherit;">For Laravel you need at least 7.2. </font><font style="vertical-align: inherit;">I also had to install the extension for php ext-mbstring separately (in my case for php 7.3):</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update<font></font>
sudo apt-get install php7.3-mbstring<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we need to install gitlab-runner. </font><font style="vertical-align: inherit;">Runner is a service that will accept a webhook from a hitlab when receiving a new version and deploy everything on our server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To install gitlab-runner you need to do:</font></font><br>
<br>
<pre><code class="bash hljs">curl -L --output /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After downloading, set permission to execute:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, create the gitlab-runner user and run the gitlab runner service:</font></font><br>
<br>
<pre><code class="bash hljs">sudo useradd --comment <span class="hljs-string">'GitLab Runner'</span> --create-home gitlab-runner --shell /bin/bash<font></font>
sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner<font></font>
sudo gitlab-runner start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register runner. </font><font style="vertical-align: inherit;">To do this, we need the token from part 2 of this article:</font></font><br>
<br>
<pre><code class="bash hljs">sudo gitlab-runner register</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In response, they will ask you for the address of your hitlab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Specify </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gitlab.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )<font></font>
https://gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to enter the token. </font><font style="vertical-align: inherit;">Enter the token from part 2.</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci token <span class="hljs-keyword">for</span> this runner<font></font>
xxx<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, specify a description and tags separated by commas. </font><font style="vertical-align: inherit;">Then we are offered to choose an executor. </font><font style="vertical-align: inherit;">Here you need to select a shell:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
Please enter the executor:<font></font>
shell</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I understand it, the executor is an environment in which the code from the .gitlab-ci.yml file is executed. </font><font style="vertical-align: inherit;">There are bash, ssh, docker, parallels, virtualbox and kubernets to choose from. </font><font style="vertical-align: inherit;">The documentation recommends that if you do not know what to use, use bash. </font><font style="vertical-align: inherit;">This is a universal option that runs on the command line on your server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we need to add the gitlab-runner user to the docker user group.</font></font><br>
<br>
<pre><code class="bash hljs">sudo usermod -aG docker gitlab-runner</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid access errors, add to sudoers</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/sudoers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
line </font></font><br>
<br>
<pre><code class="bash hljs">gitlab-runner ALL=(ALL) NOPASSWD: ALL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can create the .gitlab-ci.yml file. </font><font style="vertical-align: inherit;">It is necessary for the execution of the so-called Pipeline: a sequence of commands for deploying a project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, go to the project repository on the hitlist and click Create a new file. </font><font style="vertical-align: inherit;">Gitlab itself will offer file templates, among them you must select .gitlab-ci.yml. </font><font style="vertical-align: inherit;">After creating a file in gitlab, you can select a template for the contents of the file. </font><font style="vertical-align: inherit;">I chose laravel and redid it a bit for myself:</font></font><br>
<br>
<pre><code class="xml hljs"><font></font>
# This file is a template, and might need editing before it works on your project.<font></font>
# Official framework image. Look for the different tagged releases at:<font></font>
# https://hub.docker.com/r/library/php<font></font>
# .    ,        <font></font>
image: registry.gitlab.com/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>:latest<font></font>
<font></font>
# Pick zero or more services to be used on all builds.<font></font>
# Only needed when using a docker container to run your tests in.<font></font>
# Check out: http://docs.gitlab.com/ce/ci/docker/using_docker_images.html#what-is-a-service<font></font>
services:<font></font>
  - mysql:latest<font></font>
#    <font></font>
variables:<font></font>
  MYSQL_DATABASE: laravel<font></font>
  MYSQL_ROOT_PASSWORD: ***********<font></font>
<font></font>
# This folder is cached between builds<font></font>
# ,      <font></font>
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache<font></font>
cache:<font></font>
  paths:<font></font>
    - vendor/<font></font>
    - node_modules/<font></font>
<font></font>
# This is a basic example for a gem or script which doesn't use<font></font>
# services such as redis or postgres<font></font>
#     <font></font>
before_script:<font></font>
  #   <font></font>
  - sudo apt-get update -yqq<font></font>
  #    nodejs<font></font>
  - sudo apt-get install gnupg -yqq<font></font>
  #  Node   12<font></font>
  - curl -sL https://deb.nodesource.com/setup_12.x | sudo bash -<font></font>
  #  <font></font>
  - sudo apt-get install git nodejs libcurl4-gnutls-dev libicu-dev libmcrypt-dev libvpx-dev libjpeg-dev libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq<font></font>
  #  composer<font></font>
  - curl -sS https://getcomposer.org/installer | php<font></font>
  - php composer.phar install<font></font>
  - composer install<font></font>
  #   Node<font></font>
  - npm install<font></font>
  # Copy over testing configuration.<font></font>
  # Don't forget to set the database config in .env.testing correctly<font></font>
  - DB_HOST=mysql<font></font>
  - DB_DATABASE=laravel<font></font>
  - DB_USERNAME=root<font></font>
  - DB_PASSWORD=*********<font></font>
  #  .env.example    .env<font></font>
  - cp .env.example .env<font></font>
  #  npm build<font></font>
  - npm run dev<font></font>
  #       laravel<font></font>
  - php artisan key:generate<font></font>
  - php artisan config:cache<font></font>
  - php artisan route:clear<font></font>
  - php artisan config:clear<font></font>
  - php artisan cache:clear<font></font>
  #  .<font></font>
  - docker-compose exec app php artisan migrate<font></font>
  #   <font></font>
  #- docker-compose exec app php artisan db:seed<font></font>
<font></font>
#<font></font>
test:<font></font>
  script:<font></font>
    #  <font></font>
    - php vendor/bin/phpunit --coverage-text --colors=never<font></font>
    #  npm<font></font>
    - npm test<font></font>
<font></font>
#       <font></font>
deploying:<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - echo "Deployed"<font></font>
    - docker-compose stop<font></font>
    - docker-compose up -d<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After successfully executing the pipeline (CI / CD-&gt; Pipelines) at the ip address of your server, you should see your laravel page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To configure CI / CD, I used instructions from Sean Bradley:</font></font><br>
<br>
<div class="oembed"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/RV0845KmsNI</font></font></a></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">medium.com/@sean_bradley/auto-devops-with-gitlab-ci-and-docker-compose-f931233f080f</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491520/index.html">Convert xls to xlsx and xml in C #</a></li>
<li><a href="../en491522/index.html">Why do women live longer</a></li>
<li><a href="../en491524/index.html">Stas Afanasyev. Juno. Pipelines based on io.Reader / io.Writer. Part 2</a></li>
<li><a href="../en491528/index.html">My experience is conducting 1000 interviews. Synopsis of the report by Yegor Bugaenko</a></li>
<li><a href="../en491530/index.html">Once again about 433 MHz transmitters and receivers</a></li>
<li><a href="../en491534/index.html">A Brief Guide to Using GDB</a></li>
<li><a href="../en491536/index.html">YouTube - Error. Please try again later. Playback ID: <...></a></li>
<li><a href="../en491538/index.html">Sprawl Lemmas for Regular and Context-Free Languages</a></li>
<li><a href="../en491540/index.html">Networks for a novice IT specialist. Mandatory base</a></li>
<li><a href="../en491542/index.html">Color Transformation: Thinning Table Searches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>