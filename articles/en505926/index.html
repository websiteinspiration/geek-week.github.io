<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¶ üëÜüèΩ ‚ôøÔ∏è –ö –≤–æ–ø—Ä–æ—Å—É –æ–± –ê–ø–æ—Ñ–µ–Ω–∏–∏, –¢–µ–ª–µ–≥–æ–Ω–∏–∏ –∏ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å _ –≤ –Ω–∞—á–∞–ª–µ) üëâ üÜô ‚Ü™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1958 ¬´¬ª ( . apophene ‚Äî , ; , , ), , . . , , . . . ‚Äì .
  . ¬´ ¬ª
 , IT ? ‚Äî , . , . , ‚Ä¶ , ‚Äî , , .
 
  1. ¬´ ¬ª
 -, , - . 34002, , , .
 
 
  
 
 fork, exec, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>–ö –≤–æ–ø—Ä–æ—Å—É –æ–± –ê–ø–æ—Ñ–µ–Ω–∏–∏, –¢–µ–ª–µ–≥–æ–Ω–∏–∏ –∏ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å _ –≤ –Ω–∞—á–∞–ª–µ)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505926/"><blockquote><i> 1958        ¬´¬ª ( . apophene ‚Äî  ,  ;      ,   ,    ),     ,                 .   .     ,           ,   .      .    .    ‚Äì     .</i><br>
<i> . ¬´  ¬ª</i></blockquote><br>
     ,   IT ?            ‚Äî    ,   .     ,                    . ,               ‚Ä¶  ,   ‚Äî   ,   ,   .<br>
<a name="habracut"></a><br>
<h3> 1. ¬´  ¬ª</h3><br>
     -,      ,     - .      34002,     ,          ,        .<br>
<br>
<img src="https://habrastorage.org/webt/tr/mz/kl/trmzklssjskomt-sxqhxfdpbihq.png"><br>
<i>  </i><br>
<br>
        fork,        exec,     .     pid ,         .   ,   ,             stdout  stderr.<br>
<br>
      ‚Äî    (dup2) FD  stdout  stderr,       ;  stderr  stdout   popen;  stdout-  stderr-       .    ,           (    ,    2       pipe),       stdout  stderr.       ‚Äî    stdout  stderr,     open ,       .    open      FD,        :<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> pid = fork();
<span class="hljs-keyword">switch</span> (pid) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span> :
        <span class="hljs-keyword">return</span> BADFORK;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> :
        close(<span class="hljs-built_in">stdout</span>);
        close(<span class="hljs-built_in">stderr</span>);
        open(fileout, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);
        open(fileerr, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);
        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    <span class="hljs-keyword">default</span> :
        <span class="hljs-keyword">return</span> pid;
}</code></pre><br>
<i>     (      ).</i><br>
<br>
 ,      ,       ¬´¬ª .  ?      , ¬´¬ª     (   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>).<br>
<br>
<h3> 2. ¬´¬ª</h3><br>
    :    ,         ,       (    stdout  )    :<br>
<br>
<pre><code class="plaintext hljs">[2020-06-05 16:58:49]      :34002</code></pre><br>
-!         ‚Äî  ,  fork()!  ,      -     !         stdout,     ‚Äî   ,             waitpid?         ?<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _exec_readfile(struct frs_json * target, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * filename) {
    FILE * fp;
    <span class="hljs-keyword">char</span> linebuff[VEN_PIPE_READ_SIZE + <span class="hljs-number">1</span>] = { <span class="hljs-number">0</span> };
    fp = fopen(filename, <span class="hljs-string">"r"</span>);
    <span class="hljs-keyword">if</span> (!fp)
        frs_err(<span class="hljs-string">" \"%s\"    "</span>, filename);
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">while</span>(fgets(linebuff, VEN_PIPE_READ_SIZE, fp))
            frs_json_string(target, <span class="hljs-literal">NULL</span>, bxi_strtrimr(linebuff));
    }
    fclose(fp);
}</code></pre><br>
   ,      (frs_*  ).     fp    ,         ? ,  - ‚Äî    ,   9       ¬´ ¬ª.<br>
<br>
<img src="https://habrastorage.org/webt/9g/pv/c7/9gpvc7fjwrn55pggacmexfxbohm.jpeg"><br>
<i> FD  </i><br>
<br>
Valgrind   ,    .          ,       .   ?      ,   .         ?<br>
<br>
<h3> 3. ¬´ ¬ª</h3><br>
     .      QtCreator (     ,    C)            .      ,     ( ),      .<br>
<br>
<pre><code class="plaintext hljs">^C[2020-06-05 16:58:46]    "Interrupt",   
[2020-06-05 16:58:49]      :34002
[2020-06-05 16:58:49]      :34002
[2020-06-05 16:58:49]      :34002
[2020-06-05 16:58:49]     
[2020-06-05 16:58:50]      </code></pre><br>
     ,    ,     ,  .    ,      . ?  ,   --- !<br>
<br>
     .      ,        :<br>
<br>
<pre><code class="plaintext hljs">[2020-06-06 14:40:12] frs_socket_bind  :34002   ("Address already in use" (98))
[2020-06-06 14:40:12]      :34002
[2020-06-06 14:40:12] ven_server_start     </code></pre><br>
   ?  ?     !<br>
<br>
<pre><code class="plaintext hljs">$ ps aux | grep vento
alex     14144  0.0  0.0 156780  7212 pts/0    Sl+  14:39   0:00 ./vento</code></pre><br>
 .    ?<br>
<br>
<pre><code class="plaintext hljs">kill -9 14144</code></pre><br>
   ,      ,    34002:<br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002
vento     14144 alex    3u  IPv4 12275384      0t0  TCP *:34002 (LISTEN)</code></pre><br>
    ?<br>
<br>
  lsof -i   .<br>
<br>
:<br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002
vento     151640 alex    3u  IPv4 12275384      0t0  TCP *:34002 (LISTEN)</code></pre><br>
,  ,  <s>,  </s>.<br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002
_Postman  25078 alex  104u  IPv4 12885232      0t0  TCP localhost:46154-&gt;localhost:34002 (ESTABLISHED)
vento     27468 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)</code></pre><br>
       - ‚Ä¶<br>
<br>
  ?<br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002
_Postman  25078 alex  104u  IPv4 12885232      0t0  TCP localhost:46154-&gt;localhost:34002 (ESTABLISHED)
vento     27468 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)
vento     27506 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)
vento     27506 alex    4u  IPv4 12890329      0t0  TCP localhost:34002-&gt;localhost:46154 (ESTABLISHED)</code></pre><br>
<img src="https://habrastorage.org/webt/wp/wq/62/wpwq62hwasqdflzz9bxomgjvebq.jpeg"><br>
<i>  #197766:        ¬´ ¬ª</i><br>
<br>
  ?  ,       REUSEPORT.<br>
<br>
<h3> 4. ¬´CLOEXEC¬ª</h3><br>
‚Ä¶       CLOEXEC? <br>
<br>
  :<br>
<br>
<pre><code class="plaintext hljs">$man fork
       *  The child process is created  with  a  single  thread‚Äîthe  one  that
          called  fork().   The  entire virtual address space of the parent is
          replicated in the child, including the states of mutexes,  condition
          variables,  and other pthreads objects; the use of pthread_atfork(3)
          may be helpful for dealing with problems that this can cause.

       *  The child inherits copies of the parent's set of open file  descrip‚Äê
          tors.   Each  file  descriptor  in the child refers to the same open
          file description (see open(2)) as the corresponding file  descriptor
          in  the parent.  This means that the two file descriptors share open
          file status flags, file offset,  and  signal-driven  I/O  attributes
          (see the description of F_SETOWN and F_SETSIG in fcntl(2)).
</code></pre><br>
  fork()             (    UNIX[-like]  ¬´  ¬ª ‚Äî         )<br>
<br>
<pre><code class="plaintext hljs">$man exec
       The exec() family of functions replaces the current process image with a new process image.  The functions described in
       this manual page are front-ends for execve(2).  (See the manual page  for  execve(2)  for  further  details  about  the
       replacement of the current process image.)</code></pre><br>
<pre><code class="plaintext hljs">$man execve
       *  By  default,  file  descriptors  remain open across an execve().  File descriptors that are marked close-on-exec are
          closed; see the description of FD_CLOEXEC in fcntl(2).  (If a file descriptor is closed, this will cause the release
          of  all record locks obtained on the underlying file by this process.  See fcntl(2) for details.)  POSIX.1 says that
          if file descriptors 0, 1, and 2 would otherwise be closed after a successful execve(), and the  process  would  gain
          privilege because the set-user-ID or set-group_ID mode bit was set on the executed file, then the system may open an
          unspecified file for each of these file descriptors.  As a general principle, no portable  program,  whether  privi‚Äê
          leged or not, can assume that these three file descriptors will remain closed across an execve().</code></pre><br>
   ,      ,       FD_CLOEXEC/SOCK_CLOEXEC.<br>
<br>
<i>,   ,    ,   ,      root-,     POSIX-2001,      , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>.</i><br>
<br>
<pre><code class="cpp hljs">server-&gt;socket = socket(AF_INET, SOCK_STREAM | SOCK_CLOEXEC, <span class="hljs-number">0</span>);</code></pre><br>
<pre><code class="cpp hljs">fcntl(client, F_SETFD, FD_CLOEXEC);</code></pre><br>
 ,     .<br>
<br>
   ?   ? -  ?  ,     ,     ?<br>
<br>
           gdb:<br>
<br>
<pre><code class="plaintext hljs">$ sudo gdb -p 27506
GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git
[...]
Reading symbols from /lib/x86_64-linux-gnu/libgcc_s.so.1...(no debugging symbols found)...done.
0x00007f503d50c9f3 in futex_wait_cancelable (private=[optimized out], expected=0, futex_word=0x55f485d383b8)
    at ../sysdeps/unix/sysv/linux/futex-internal.h:88
88	../sysdeps/unix/sysv/linux/futex-internal.h:     .
(gdb) bt
#0  0x00007f503d50c9f3 in futex_wait_cancelable (private=[optimized out], expected=0, futex_word=0x55f485d383b8)
    at ../sysdeps/unix/sysv/linux/futex-internal.h:88
#1  __pthread_cond_wait_common (abstime=0x0, mutex=0x55f485d38368, cond=0x55f485d38390) at pthread_cond_wait.c:502
#2  __pthread_cond_wait (cond=0x55f485d38390, mutex=0x55f485d38368) at pthread_cond_wait.c:655
#3  0x00007f503d948097 in _frs_signal_wait (signal=0x55f485d38340, filename=0x7f503d7315c8 "fen_server.c", fileline=298)
    at ./projects/shared/libforseti/code/thread/frs_signal.c:250
#4  0x00007f503d728044 in _server_wait (server=0x55f485d38270) at ./projects/shared/libfenrir/code/server/fen_server.c:298
#5  0x00007f503d72822d in fen_server_free (server=0x55f485d38270) at ./projects/shared/libfenrir/code/server/fen_server.c:351</code></pre><br>
--,  server_free?     ?       echo!<br>
<br>
   ?<br>
<br>
<h3> 5. ¬´ ¬ª</h3><br>
   echo,    exec      ,       shell-      system.   /bin/echo,  ,   .    ,         exec              ,   , ‚Ä¶<br>
<br>
<pre><code class="cpp hljs">        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);</code></pre><br>
 ,  exit.      ?<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*! \brief   */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _free(<span class="hljs-keyword">void</span>) __attribute__((destructor));
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _free(<span class="hljs-keyword">void</span>) {
    fen_server_free(g_server);
    frs_inf(<span class="hljs-string">"   "</span>);
}</code></pre><br>
     .        ,       :<br>
<br>
<img src="https://habrastorage.org/webt/g0/sk/-s/g0sk-sf74ratdovfkkoqny7ongu.png"><br>
<br>
 ,     .              :<br>
<br>
<b>  </b> ¬´_¬ª   exit:<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> pid = fork();
<span class="hljs-keyword">switch</span> (pid) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span> :
        <span class="hljs-keyword">return</span> BADFORK;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> :
        close(<span class="hljs-built_in">stdout</span>);
        close(<span class="hljs-built_in">stderr</span>);
        open(fileout, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);
        open(fileerr, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);
        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);
        _exit(EXIT_FAILURE);
    <span class="hljs-keyword">default</span> :
        <span class="hljs-keyword">return</span> pid;
}</code></pre><br>
  ?  ,  ,           atexit .    glibc      _exit,     exit_group       .<br>
<br>
 ,   ,    ¬´¬ª, ¬´  ¬ª, ¬´ ¬ª.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>   ,        .</div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505898/index.html">Claude Shannon: jack of all trades, joker and father of information theory</a></li>
<li><a href="../en505900/index.html">Personal addictions: full-sized 40 mm, without wire, for 72 hours for 8000 rubles</a></li>
<li><a href="../en505904/index.html">JUG Ru Group # 5 Online Stream Week</a></li>
<li><a href="../en505906/index.html">Walkthrough Bandit from overthewire.org</a></li>
<li><a href="../en505918/index.html">Sony Phone Interface - Non-Disabled Advertising</a></li>
<li><a href="../en505928/index.html">Why functional programming is so complicated</a></li>
<li><a href="../en505946/index.html">Storing Images Using Django / Django REST</a></li>
<li><a href="../en505954/index.html">Alpine.js - events and global data warehouse</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electr√≥nico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 27 de enero al 2 de febrero de 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>