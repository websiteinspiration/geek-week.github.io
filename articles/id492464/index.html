<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèΩ üò± „Ä∞Ô∏è DBA: kompeten mengatur sinkronisasi dan impor üëèüèª üë©üèø‚Äçü§ù‚Äçüë©üèª ü§∞üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dengan pemrosesan kompleks dari kumpulan data besar ( proses ETL yang berbeda : impor, konversi, dan sinkronisasi dengan sumber eksternal), sering kal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: kompeten mengatur sinkronisasi dan impor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan pemrosesan kompleks dari kumpulan data besar ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proses ETL yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> berbeda </font><font style="vertical-align: inherit;">: impor, konversi, dan sinkronisasi dengan sumber eksternal), sering kali ada kebutuhan untuk </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mengingat" sementara dan segera memproses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sesuatu yang banyak. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas khas semacam ini biasanya terdengar seperti ini: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Di sini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">departemen akuntansi mengunggah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pembayaran yang terakhir diterima </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">dari bank klien</font></a><font style="vertical-align: inherit;"> , kita perlu dengan cepat mengunggahnya ke situs web dan menautkannya ke akun"</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tapi ketika volume "sesuatu" ini mulai diukur dalam ratusan megabita, dan layanan Ini harus terus bekerja dengan basis dalam mode 24x7, ada banyak efek samping yang akan menghancurkan hidup Anda.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengatasinya di PostgreSQL (dan tidak hanya di dalamnya), Anda dapat menggunakan beberapa opsi pengoptimalan yang memungkinkan Anda memproses lebih cepat dan dengan sumber daya yang lebih sedikit.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Kemana harus mengirim?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, mari kita putuskan di mana kita dapat mengunggah data yang ingin kita "proses".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Tabel Sementara (MEJA SEMENTARA)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada prinsipnya, untuk PostgreSQL, yang sementara adalah tabel yang sama dengan yang lainnya. </font><font style="vertical-align: inherit;">Oleh karena itu, takhayul seperti </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"semuanya disimpan di sana hanya dalam memori, tetapi bisa berakhir"</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tidak benar </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tetapi ada beberapa perbedaan yang signifikan.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namespace sendiri untuk setiap koneksi ke database</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika dua koneksi mencoba membuat pada saat yang sama </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka seseorang pasti akan mendapatkan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kesalahan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objek DB yang tidak </font><b><font style="vertical-align: inherit;">unik</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika keduanya mencoba untuk mengeksekusi </font><font style="vertical-align: inherit;">, maka keduanya biasanya akan melakukannya, dan masing-masing akan menerima </font><b><font style="vertical-align: inherit;">salinan</font></b><font style="vertical-align: inherit;"> tabelnya sendiri. </font><font style="vertical-align: inherit;">Dan tidak akan ada kesamaan di antara mereka.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Penghancuran diri" dengan putuskan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika Anda menutup koneksi, semua tabel sementara secara otomatis dihapus, sehingga </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak ada artinya dalam </font><font style="vertical-align: inherit;">mengeksekusi "secara manual" </font><font style="vertical-align: inherit;">, kecuali ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda bekerja melalui </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer dalam mode transaksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , database terus menganggap bahwa koneksi ini masih aktif, dan ini sementara tabelnya masih ada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, upaya untuk membuatnya kembali, dari koneksi lain ke pgbouncer, akan menghasilkan kesalahan. </font><font style="vertical-align: inherit;">Tapi ini bisa dielakkan dengan mengambil keuntungan </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Benar, lebih baik tidak melakukan hal yang sama, karena Anda dapat "tiba-tiba" mencari tahu data yang tersisa dari "pemilik sebelumnya" di sana. </font><font style="vertical-align: inherit;">Alih-alih, jauh lebih baik untuk membaca manual, dan melihat bahwa ketika membuat tabel ada peluang untuk menambahkan</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - yaitu, ketika transaksi selesai, tabel akan dihapus secara otomatis.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non-replikasi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena hanya gabungan tertentu yang termasuk, tabel sementara tidak direplikasi. </font><font style="vertical-align: inherit;">Tetapi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini menghilangkan kebutuhan untuk menulis dua kali data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di heap + WAL, jadi INSERT / UPDATE / DELETE jauh lebih cepat di dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi karena tabel sementara masih merupakan tabel "hampir biasa", itu juga tidak dapat dibuat pada replika. </font><font style="vertical-align: inherit;">Setidaknya untuk saat ini, meskipun tambalan yang sesuai telah ada sejak lama.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Tabel tidak terdaftar (TABEL TIDAK DILOGGED)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi apa yang harus dilakukan, misalnya, jika Anda memiliki semacam proses ETL rumit yang tidak dapat diimplementasikan dalam satu transaksi, dan Anda masih memiliki </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer dalam mode transaksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atau aliran data sangat besar sehingga tidak ada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bandwidth yang cukup per koneksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari basis data (baca, satu proses pada CPU)? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atau bagian dari operasi berjalan secara </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serempak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam koneksi yang berbeda? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hanya ada satu opsi - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk sementara membuat tabel non-temporer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pun, ya. </font><font style="vertical-align: inherit;">Yaitu:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menciptakan "nya" tabel dengan nama acak maksimal agar tidak menyeberang dengan siapa pun</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ekstrak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : menuangkan data dari sumber eksternal ke dalamnya</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transform</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : berubah, diisi bidang pengikatan kunci</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : menuangkan data jadi ke tabel target</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menghapus tabel "saya"</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang - lalat di salep. </font><font style="vertical-align: inherit;">Bahkan, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semua tulisan di PostgreSQL terjadi dua kali</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pertama di WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kemudian di tubuh tabel / indeks. </font><font style="vertical-align: inherit;">Semua ini dilakukan untuk mendukung ACID dan visibilitas data yang benar antara </font><font style="vertical-align: inherit;">transaksi bersarang </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bertingkat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi kami tidak membutuhkan ini! </font><font style="vertical-align: inherit;">Kami memiliki seluruh proses </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atau berhasil dilewati, atau tidak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tidak masalah berapa banyak transaksi perantara yang dikandungnya - kami tidak tertarik untuk "melanjutkan proses dari tengah", terutama ketika tidak jelas di mana itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk ini, pengembang PostgreSQL memperkenalkan versi 9.1 seperti </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabel non-journaled (UNLOGGED)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Singkatnya, itu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan jauh lebih cepat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi jika server database "crash" - itu akan menjadi tidak menyenangkan. </font><font style="vertical-align: inherit;">Tetapi seberapa sering hal ini terjadi, dan apakah proses ETL Anda tahu cara memodifikasinya dengan benar "dari tengah" setelah "revitalisasi" database? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika tidak, dan kasus di atas serupa dengan milik Anda - gunakan </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi jangan pernah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menyertakan atribut ini pada tabel nyata</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> data dari mana Anda sayang.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">ON COMMIT {DELETE ROWS | </font><font style="vertical-align: inherit;">PENURUNAN}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desain ini memungkinkan saat membuat tabel untuk mengatur perilaku otomatis ketika transaksi berakhir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentang </font><font style="vertical-align: inherit;">saya sudah menulis di atas, itu menghasilkan </font><font style="vertical-align: inherit;">, tetapi </font><font style="vertical-align: inherit;">situasinya lebih menarik - ini dia dihasilkan </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Karena seluruh infrastruktur untuk menyimpan deskripsi meta dari tabel sementara persis sama dengan yang biasa, </font><b><font style="vertical-align: inherit;">pembuatan dan penghapusan tabel sementara yang konstan mengarah ke "pembengkakan" yang kuat dari tabel sistem</font></b><font style="vertical-align: inherit;"> pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Sekarang bayangkan Anda memiliki pekerja di telepon menghubungkan ke database, yang setiap detik membuka transaksi baru, membuat, mengisi, memproses, dan menghapus tabel sementara ... Sampah di tabel sistem akan menumpuk berlebih, dan ini adalah rem tambahan selama setiap operasi.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, jangan! </font><font style="vertical-align: inherit;">Dalam hal ini, jauh lebih efisien </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mengeluarkannya dari siklus transaksi - maka pada awal setiap transaksi baru tabel </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tersebut</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sudah </font><b><font style="vertical-align: inherit;">ada</font></b><font style="vertical-align: inherit;"> (simpan panggilan </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tetapi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan kosong</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , terima kasih </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(kami juga menyimpan panggilan) di akhir transaksi sebelumnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4. </font><font style="vertical-align: inherit;">SEPERTI ... TERMASUK ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sebutkan di awal bahwa salah satu kasus penggunaan yang umum untuk tabel sementara adalah berbagai jenis impor - dan pengembang dengan susah payah menyalin-tempel daftar bidang tabel target ke dalam deklarasi sementaranya ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi kemalasan adalah mesin kemajuan! </font><font style="vertical-align: inherit;">Oleh karena itu, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membuat tabel baru "pada model"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bisa menjadi lebih sederhana:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena Anda kemudian dapat menambahkan banyak data ke tabel ini, pencarian di dalamnya tidak akan pernah cepat. Tetapi ada solusi tradisional terhadap ini - indeks! Dan, ya, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabel sementara juga dapat memiliki indeks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena, seringkali, indeks yang diinginkan bertepatan dengan indeks tabel target, Anda cukup menulis </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Jika Anda juga membutuhkan </font><font style="vertical-align: inherit;">-nilai (misalnya, untuk mengisi nilai kunci utama), Anda dapat menggunakan </font><font style="vertical-align: inherit;">. Baik, atau hanya - </font><font style="vertical-align: inherit;">- itu akan menyalin default, indeks, kendala ... </font><font style="vertical-align: inherit;">
Tapi di sini Anda perlu memahami bahwa jika Anda membuat </font><b><font style="vertical-align: inherit;">tabel impor segera dengan indeks, maka data akan diisi lebih lama</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daripada jika Anda mengisi semuanya terlebih dahulu, dan kemudian gulung indeks - lihat sebagai contoh bagaimana </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melakukannya </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara keseluruhan, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Bagaimana cara menulis?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan mengatakan secara sederhana - gunakan </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream alih-alih "paket" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akselerasi pada waktu tertentu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Anda bahkan dapat langsung dari file yang sudah dibentuk sebelumnya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Bagaimana cara menanganinya?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, biarkan pengantar kami terlihat seperti ini:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda memiliki di piring Anda sebuah piring dengan data klien untuk </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catatan 1M</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setiap hari klien mengirimi Anda </font><b><font style="vertical-align: inherit;">"gambar" lengkap</font></b><font style="vertical-align: inherit;"> baru</font></font><b><font style="vertical-align: inherit;"></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari pengalaman Anda tahu bahwa </font><b><font style="vertical-align: inherit;">tidak lebih dari 10 ribu catatan yang berubah</font></b><font style="vertical-align: inherit;"> dari waktu ke waktu</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh klasik dari situasi seperti ini adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">database KLADR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ada banyak alamat, tetapi dalam setiap minggu mengunggah perubahan (penggantian nama pemukiman, asosiasi jalan, penampilan rumah baru) ada sangat sedikit, bahkan secara nasional.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Algoritma sinkronisasi penuh</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk kesederhanaan, katakanlah bahwa Anda bahkan tidak perlu merestrukturisasi data - cukup bawa tabel dalam bentuk yang benar, yaitu:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hapus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semua yang tidak lagi</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perbarui</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semua yang sudah ada, dan Anda perlu memperbarui</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masukkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semua yang belum</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa dalam urutan ini perlu melakukan operasi? </font><font style="vertical-align: inherit;">Karena ini adalah bagaimana ukuran tabel tumbuh minimal ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ingat tentang MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAPUS DARI dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak, tentu saja, Anda hanya dapat melakukan dua operasi:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hapus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) sama sekali</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rekatkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semuanya dari gambar baru</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi pada saat yang sama, berkat MVCC, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ukuran meja akan meningkat tepat dua kali lipat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Dapatkan + 1M catatan gambar di tabel karena pembaruan 10 ribu - redundansi begitu-begitu ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengembang yang lebih berpengalaman tahu bahwa seluruh pelat dapat dibersihkan dengan cukup murah:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jelas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) seluruh tabel</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rekatkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semuanya dari gambar baru</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode ini efektif, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kadang-kadang cukup berlaku</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi ada masalah ... Kami akan menyuntikkan catatan 1M, jadi kami tidak dapat membiarkan meja kosong selama ini (seperti yang akan terjadi tanpa membungkus dalam satu transaksi). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang berarti:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami memulai </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transaksi panjang</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyebabkan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami melakukan penyisipan untuk waktu yang lama, dan semua orang pada saat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini bahkan tidak bisa</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada yang buruk ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENAME ... / DROP TABEL ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai opsi, isi semuanya menjadi tabel baru yang terpisah, dan kemudian cukup ganti namanya ke yang lama. </font><font style="vertical-align: inherit;">Beberapa hal kecil yang jahat:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> juga </font><font style="vertical-align: inherit;">, meskipun jauh lebih sedikit dalam waktu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semua rencana kueri / statistik tabel ini disetel ulang, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perlu untuk mengarahkan ANALYZE</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semua kunci asing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) </font><b><font style="vertical-align: inherit;">pecah</font></b><font style="vertical-align: inherit;"> di atas meja</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada tambalan WIP dari Simon Riggs, yang menyarankan untuk melakukan </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operasi untuk mengganti badan tabel pada tingkat file, tanpa menyentuh statistik dan FK, tetapi tidak mengumpulkan kuorum.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAPUS, PEMBARUAN, INSERT</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, kami berhenti pada versi non-pemblokiran dari tiga operasi. </font><font style="vertical-align: inherit;">Hampir tiga ... Bagaimana melakukan ini paling efektif?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Impor pemrosesan pos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam KLADER yang sama, semua catatan yang diubah harus juga dijalankan melalui proses pasca - normalisasi, sorot kata kunci, dan bawa ke struktur yang diperlukan. </font><font style="vertical-align: inherit;">Tetapi bagaimana Anda tahu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apa yang sebenarnya telah berubah</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tanpa menyulitkan kode sinkronisasi, idealnya tanpa menyentuhnya sama sekali? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika hanya proses Anda yang memiliki akses tulis pada saat sinkronisasi, maka Anda dapat menggunakan pemicu yang akan mengumpulkan semua perubahan untuk kami:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami dapat memaksakan pemicu (atau mengaktifkan melalui </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">sebelum memulai sinkronisasi </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan kemudian diam-diam dari tabel log kita mengekstrak semua perubahan yang kita butuhkan dan menjalankannya melalui penangan tambahan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Impor set terkait</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di atas, kami mempertimbangkan kasus ketika struktur data sumber dan penerima bertepatan. </font><font style="vertical-align: inherit;">Tetapi bagaimana jika pembongkaran dari sistem eksternal memiliki format yang berbeda dari struktur penyimpanan di basis data kami? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambil penyimpanan pelanggan dan akun mereka sebagai contoh, opsi klasik banyak-ke-satu:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi pembongkaran dari sumber eksternal datang kepada kami dalam bentuk "semua dalam satu":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jelas, data pelanggan dapat digandakan dengan cara ini, dan catatan utama adalah "akun":</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk model, cukup masukkan data pengujian kami, tetapi ingat - </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lebih efisien!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami memilih "potongan" yang mengacu pada "fakta" kami. </font><font style="vertical-align: inherit;">Dalam kasus kami, akun merujuk ke pelanggan:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengaitkan akun dengan ID pelanggan dengan benar, kita harus terlebih dahulu mencari tahu atau menghasilkan pengidentifikasi ini. </font><font style="vertical-align: inherit;">Tambahkan bidang untuk mereka:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menggunakan metode sinkronisasi tabel dengan koreksi kecil yang dijelaskan di atas - kami tidak akan memperbarui atau menghapus apa pun di tabel target, karena mengimpor klien adalah "append-only":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, semuanya - </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sekarang kami telah mengisi bidang komunikasi </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang dengannya kami akan memasukkan akun.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id492454/index.html">Kami menjual Arsitektur Refactoring ke klien atau apa masalah pengembang</a></li>
<li><a href="../id492456/index.html">Cara memvisualisasikan dan menghidupkan model (geofisika). Tampilkan data mentah</a></li>
<li><a href="../id492458/index.html">GUI sederhana untuk M5Stack (Arduino)</a></li>
<li><a href="../id492460/index.html">Pemrograman fungsional adalah apa yang Anda (mungkin) diberitahu. Jika kamu mendengarkan</a></li>
<li><a href="../id492462/index.html">Sumber kebenaran: bagaimana seorang analis mengajar manajer dan pengembang untuk bekerja bersama</a></li>
<li><a href="../id492466/index.html">Cara pindah dari penyedia host mana pun dengan cPanel ke Plesk di Rusonix hanya dalam lima langkah</a></li>
<li><a href="../id492468/index.html">Lenovo Thinkserver SE350: pahlawan dari pinggiran</a></li>
<li><a href="../id492474/index.html">Kami menyusun informasi pada kotak Android dan menganalisis apa yang bisa dilakukan oleh awalan normal.</a></li>
<li><a href="../id492478/index.html">Tanpa manajemen pengetahuan itu menyakitkan: 5 konsekuensi utama dari kurangnya sistem</a></li>
<li><a href="../id492480/index.html">Bagaimana kami berjuang dengan epidemi sebelumnya dan apa yang kami lakukan terhadap coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>