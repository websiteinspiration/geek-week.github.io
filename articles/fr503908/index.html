<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèº ü§∂üèΩ üöå Appeler les biblioth√®ques partag√©es de Similink üò∂ üé∑ üë®‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Habr! 
 Je vous pr√©sente la traduction d'un article de mon coll√®gue Mikhail sur les m√©thodes d'invocation des biblioth√®ques partag√©es dans Simu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Appeler les biblioth√®ques partag√©es de Similink</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salut, Habr! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vous pr√©sente la traduction d'un article de mon coll√®gue Mikhail sur les m√©thodes d'invocation des biblioth√®ques partag√©es dans Simulink. Pourquoi a-t-il √©t√© cr√©√©? Le fait est que de nombreuses entreprises ont d√©j√† de nombreux mod√®les h√©rit√©s que nous aimerions r√©utiliser et on nous pose souvent des questions: ¬´Comment puis-je int√©grer l'h√©ritage dans Simulink? Et si mon h√©ritage se pr√©sente sous la forme d'une DLL? " Par cons√©quent, l'article d'origine a √©t√© √©crit. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous le chat, plusieurs fa√ßons d'appeler des biblioth√®ques partag√©es dans Simulink sont discut√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les modifications apport√©es au code ont √©t√© apport√©es avec la permission de Mikhail et faites pour ne pas surcharger l'article.</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article montre comment utiliser les fonctions des biblioth√®ques partag√©es dans les mod√®les Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disons que nous devons int√©grer la biblioth√®que exlib dans Simulink. </font><font style="vertical-align: inherit;">Son code est contenu dans les sources d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il s'agit d'une biblioth√®que tr√®s simple contenant trois fonctions: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_init (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ouvre un fichier pour l'√©criture. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print (float data)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √©crit des donn√©es dans un fichier. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ferme le fichier.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblage de biblioth√®que</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, compilez la biblioth√®que. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette √©tape n'est pas n√©cessaire si la biblioth√®que est pr√©compil√©e et livr√©e sous forme de fichier binaire. Dans ce cas, vous pouvez imm√©diatement passer √† l'√©tape 3, mais n'oubliez pas que pour travailler avec la biblioth√®que, vous devez obtenir le fichier .dll (ou .so pour Linux) et le fichier d'en-t√™te correspondant (.h) aupr√®s du fournisseur de biblioth√®que. Pour Windows, vous aurez √©galement besoin d'un fichier .lib, qui n'est pas une biblioth√®que statique, mais la soi-disant biblioth√®que d'importation. Cette biblioth√®que d'importation est requise pour la liaison implicite. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous utiliserons la commande MATLAB mex, qui appelle le compilateur h√¥te actif actuel pour compiler la biblioth√®que partag√©e (exlib.dll sous Windows et exlib.so sous Linux). Il est important de s'assurer que la commande a √©t√© ex√©cut√©e en premier</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pour s√©lectionner un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilateur pris en charge</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez maintenant mex pour compiler la biblioth√®que:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de construction d'une biblioth√®que</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rification de la biblioth√®que compil√©e</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s la compilation, vous devez vous assurer que la biblioth√®que r√©sultante peut √™tre charg√©e et utilis√©e dans MATLAB:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de v√©rification de la biblioth√®que</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que nous nous sommes assur√©s que tout fonctionne, commen√ßons avec Simulink!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel d'une biblioth√®que partag√©e √† l'aide des fonctions S</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fonctions S vous permettent d'utiliser le code C dans Simulink. </font><font style="vertical-align: inherit;">Cette approche permet √† l'utilisateur de d√©velopper tout code C n√©cessaire pour charger la biblioth√®que et appeler ses fonctions. </font><font style="vertical-align: inherit;">Ensuite, ce code est compil√© dans un fichier binaire reconnu par Simulink et li√© √† une biblioth√®que partag√©e. </font><font style="vertical-align: inherit;">Ce binaire est appel√© fonction S. </font><font style="vertical-align: inherit;">Simulink a un bloc pour appeler cette fonction S. </font><font style="vertical-align: inherit;">Il existe plusieurs approches pour cr√©er des fonctions S dans Simulink.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de l'outil de code h√©rit√©</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re approche consiste √† utiliser l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outil de code h√©rit√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un outil qui vous aide √† cr√©er automatiquement des fonctions S selon les sp√©cifications cr√©√©es √† l'aide de MATLAB. </font><font style="vertical-align: inherit;">Dans cet exemple, la fonction S est li√©e √† la biblioth√®que d'importation (sous Windows, nous avons besoin du fichier * .lib correspondant) et les fonctions de la biblioth√®que sont appel√©es. </font><font style="vertical-align: inherit;">Cette approche est appel√©e liaison implicite. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, vous devez initialiser la structure de l'outil de code h√©rit√©</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code pour initialiser la structure de Legacy Code Tool</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez une fonction S, compilez-la et liez-la:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, cr√©ez le bloc Simulink:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcriture manuelle des fonctions S</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me approche consiste √† √©crire vos propres fonctions S pour charger une biblioth√®que partag√©e et appeler des fonctions √† partir de cette biblioth√®que. </font><font style="vertical-align: inherit;">Cette approche utilisera une liaison explicite, √©galement appel√©e liaison d'ex√©cution. </font><font style="vertical-align: inherit;">La solution la plus simple consiste √† adapter la fonction S qui a √©t√© g√©n√©r√©e automatiquement pr√©c√©demment par l'outil de code h√©rit√©. </font><font style="vertical-align: inherit;">Dans cet exemple, les fonctions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlStart</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">sont </font></i><i><font style="vertical-align: inherit;">modifi√©es</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemblent ces fonctions apr√®s modification:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilez la fonction S r√©sultante:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et lancez la simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de S-Function Builder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre approche consiste √† utiliser le bloc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il s'agit d'une unit√© sp√©ciale qui peut √™tre consid√©r√©e comme un croisement entre l'outil de code h√©rit√© et les fonctions S manuscrites en termes de complexit√©. </font><font style="vertical-align: inherit;">S-Function Builder fournit une interface graphique qui d√©crit les caract√©ristiques de votre fonction S, et la fonction S est cr√©√©e automatiquement. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des limitations de performances et des probl√®mes li√©s √† l'utilisation de S-Function Builder. </font><font style="vertical-align: inherit;">Actuellement, cela est consid√©r√© comme une approche obsol√®te pour cr√©er des fonctions S. </font><font style="vertical-align: inherit;">Il est recommand√© d'utiliser le bloc de fonction C, qui est apparu dans la version de R2020a et est discut√© plus tard.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel d'une biblioth√®que partag√©e √† l'aide de la fonction MATLAB </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bloc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonction MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet d'utiliser le langage MATLAB pour d√©crire un algorithme personnalis√© dans Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour appeler la biblioth√®que partag√©e √† partir de la fonction MATLAB, utilisez la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui ne peut √™tre utilis√©e que dans le corps de la fonction MATLAB (et non MATLAB). </font><font style="vertical-align: inherit;">Coder.ceval ne n√©cessite pas MATLAB Coder pour fonctionner. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code du bloc fonction MATLAB appelant la biblioth√®que partag√©e:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche a un inconv√©nient - le manque d'un bon moyen d'appeler la fonction d'ach√®vement √† la fin de la simulation (par rapport au bloc du syst√®me MATLAB). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez d√©finir la fonction d'ach√®vement du mod√®le en d√©finissant exlib_term (); dans les param√®tres du mod√®le dans la cat√©gorie </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cible de simulation -&gt; Code personnalis√© -&gt; Fonction d'arr√™t</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REMARQUE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si le param√®tre ¬´Importer du code personnalis√©¬ª est d√©fini dans les param√®tres du mod√®le, vous devez sp√©cifier toutes les d√©pendances de code dans le panneau ¬´Cible de simulation¬ª (au lieu d'utiliser </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Si ce param√®tre n'est pas d√©fini, vous pouvez combiner les param√®tres de Simulation Target, coder.cinclude et coder.updateBuildInfo.</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Une autre fa√ßon consiste √† maintenir les d√©pendances √† l'aide</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et appelez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par convention, comme illustr√© dans l'exemple ci-dessus. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel d'une biblioth√®que partag√©e √† partir de Stateflow </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez utiliser les fonctions de biblioth√®que partag√©e dans les diagrammes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ces fonctions doivent √™tre appel√©es directement √† partir de Stateflow. La documentation Stateflow contient des exemples qui montrent comment proc√©der. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel d'une fonction externe dans Stateflow est tr√®s simple - vous devez sp√©cifier le nom de la fonction dans le diagramme Stateflow: </font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En outre, vous devez configurer les param√®tres du mod√®le afin que Stateflow sache o√π chercher ces fonctions externes. Dans les param√®tres de </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Libraries, vous</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devez saisir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.lib (ou exlib.so sous Linux)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cible de simulation -&gt; Code personnalis√© -&gt; Fichier d'en-t√™te, vous</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devez saisir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il est √©galement important de ne pas oublier de sp√©cifier la fonction d'ach√®vement. √Ä</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cible de simulation -&gt; Code personnalis√© -&gt; La fonction de terminaison</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit sp√©cifier</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exlib_term (); </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la simulation:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que les informations contenues </font><font style="vertical-align: inherit;">dans le </font><font style="vertical-align: inherit;">pr√©sent article aux diagrammes Stateflow qui utilisent </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le langage d'action C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si le diagramme Stateflow utilise </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le langage d'action MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alors </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval est requis</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , comme c'est le cas avec la fonction MATLAB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel d'une biblioth√®que partag√©e √† l'aide du bloc syst√®me MATLAB </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bloc syst√®me MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet d'utiliser des objets syst√®me dans Simulink. </font><font style="vertical-align: inherit;">Plus d'informations sur ce bloc peuvent √™tre trouv√©es dans la documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prise en charge des objets syst√®me est apparue dans Simulink dans la version R2013b. </font><font style="vertical-align: inherit;">De nombreuses personnes utilisent des objets syst√®me car ils facilitent la d√©finition des fonctions d'initialisation, de simulation et d'ach√®vement. </font><font style="vertical-align: inherit;">De plus, les objets syst√®me peuvent utiliser le code MATLAB auxiliaire pour ces fonctions - par exemple, pour les donn√©es de pr√©traitement et de post-traitement d'une fonction d'√©tape - le tout sans √©crire de code C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble l'objet syst√®me utilis√© dans le bloc syst√®me MATLAB:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code d'objet syst√®me</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de biblioth√®ques partag√©es √† l'aide du bloc C Caller </font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bloc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet d'appeler des fonctions C directement depuis Simulink. Plus d'informations sur ce bloc peuvent √™tre trouv√©es dans la documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une approche relativement nouvelle qui est apparue pour la premi√®re fois dans MATLAB R2018b. Son objectif principal est de rendre les appels de fonction et les biblioth√®ques C dans Simulink extr√™mement simples. Mais il a des limites, que vous pouvez lire dans la documentation de ce bloc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajout√© √† </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Libraries</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Header</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans les param√®tres du mod√®le, cliquez simplement sur le bouton "Refresh custom code" dans le bloc C Caller, pour voir toutes les fonctions contenues dans la biblioth√®que.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir s√©lectionn√© la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_print</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la bo√Æte de dialogue de sp√©cification de port est remplie automatiquement: </font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et encore une fois, vous devez ajouter les appels de fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† la cible de simulation. </font><font style="vertical-align: inherit;">Vous pouvez √©galement ajouter quelques autres blocs C Caller pour appeler directement les fonctions d'initialisation et de terminaison. </font><font style="vertical-align: inherit;">Ces blocs d'appel C doivent √™tre plac√©s dans les sous-syst√®mes Initialize Function et Terminate Function. </font><font style="vertical-align: inherit;">Vous pouvez √©galement consid√©rer l'exemple suivant de Stateflow: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planifier des sous-syst√®mes √† ex√©cuter √† des moments sp√©cifiques</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ex√©cutez la simulation:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de biblioth√®ques partag√©es √† l'aide du bloc fonction C</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dernier ajout √† l' </font><font style="vertical-align: inherit;">int√©gration de </font><font style="vertical-align: inherit;">code externe dans Simulink est le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Fonction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bloc </font><font style="vertical-align: inherit;">. Il est apparu dans le R2020a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ressemble au bloc C Caller en termes de facilit√© d'utilisation, mais vous permet de cr√©er un wrapper C autour des fonctions import√©es (ainsi, ce bloc ressemble √† S-Function Builder). Mais, tr√®s probablement, le sc√©nario principal pour utiliser le bloc fonction C n'est pas d'appeler les fonctions C existantes, mais d'√©crire de petits morceaux de code C, si un tel code est n√©cessaire dans l'application. Par exemple, vous devrez peut-√™tre acc√©der aux registres mat√©riels ou aux fonctions int√©gr√©es du compilateur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas d'ajouter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux param√®tres </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulation Target -&gt; Libraries"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les param√®tres </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulation Target -&gt; Header file"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans les param√®tres du mod√®le. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, dans les param√®tres du bloc fonction C, vous devez ajouter un caract√®re pour les donn√©es d'entr√©e avec le type de donn√©es unique et sp√©cifier le code de sortie, de d√©but et de fin:</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de biblioth√®ques partag√©es g√©n√©r√©es √† l'aide d'Embedded Coder </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'un des sc√©narios d'utilisation d'Embedded Coder est la g√©n√©ration automatique de code C √† partir du mod√®le Simulink et le conditionnement de ce code dans une biblioth√®que partag√©e. La documentation contient √©galement un exemple qui montre comment g√©n√©rer automatiquement une biblioth√®que partag√©e et l'appeler √† partir d'une application externe √©crite en C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que si vous avez juste besoin d'ex√©cuter l'algorithme ou une partie de l'algorithme en tant que code C dans le m√™me mod√®le Simulink, il est pr√©f√©rable d'utiliser Fonctions S de Simulink Coder ou simulation </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logicielle en boucle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cependant, si la biblioth√®que partag√©e g√©n√©r√©e par le codeur int√©gr√© est utilis√©e pour la mod√©lisation semi-naturelle, vous devrez peut-√™tre int√©grer la m√™me biblioth√®que dans le mod√®le plus grand utilis√© par d'autres d√©veloppeurs et prot√©ger ainsi votre propri√©t√© intellectuelle. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travailler avec une biblioth√®que partag√©e g√©n√©r√©e par Embedded Coder n'est pas diff√©rent de travailler avec une biblioth√®que partag√©e, qui √©tait utilis√©e dans l'article. </font><font style="vertical-align: inherit;">Consid√©rons un mod√®le simple qui a deux entr√©es et une sortie:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir assembl√© le mod√®le, nous obtenons un fichier .dll (.so sous Linux), un fichier .lib (une biblioth√®que d'importation pour .dll) et un fichier .exp (un fichier d'exportation pour communiquer avec .dll).</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioth√®que partag√©e g√©n√©r√©e exporte les caract√®res suivants:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par d√©faut, les entr√©es et les sorties sont export√©es en tant que caract√®res globaux et les fonctions d'initialisation, d'√©tape et d'ach√®vement suivent la convention de d√©nomination du mod√®le. </font><font style="vertical-align: inherit;">Si n√©cessaire, vous pouvez configurer des prototypes de fonctions, des noms de symboles, etc. (une discussion sur ces param√®tres d√©passe le cadre de cet article). </font><font style="vertical-align: inherit;">Dans ce mod√®le, le prototype de la fonction pas √† pas du mod√®le est d√©fini comme </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step (In1, In2)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour appeler ces fonctions, vous devez utiliser l'une des m√©thodes r√©pertori√©es ci-dessus. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez utiliser la fonction MATLAB (pour simplifier, nous appelons uniquement la fonction step):</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la simulation et regardez ses r√©sultats:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©sultats</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article d√©crit diff√©rentes approches pour appeler des biblioth√®ques partag√©es √† partir de mod√®les Simulink. </font><font style="vertical-align: inherit;">Des liens implicites et explicites ont √©t√© pris en compte. </font><font style="vertical-align: inherit;">Toutes les m√©thodes ont leurs avantages et leurs inconv√©nients, et leur pertinence d√©pend du flux de travail, des exigences et des objectifs sp√©cifiques. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L' </font><font style="vertical-align: inherit;">approche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonctionne mieux lors de l'impl√©mentation d'un lien implicite avec une biblioth√®que partag√©e, car dans ce cas, nous pouvons simplement appeler des fonctions directement √† partir de la biblioth√®que, et l'√©diteur de liens se chargera du reste. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bloc syst√®me MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une autre approche qui offre les avantages suivants:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excellente conformit√© au paradigme des fonctions d'initialisation, d'√©tape et d'ach√®vement, vous permettant de maintenir toutes ces fonctions au sein du bloc lui-m√™me, et non √† l'√©chelle du mod√®le</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'inconv√©nient de l'utilisation du bloc fonction MATLAB est que son utilisation peut entra√Æner une surcharge suppl√©mentaire lors de la g√©n√©ration de code. Ainsi, le Legacy Code Tool et les fonctions S sont toujours pr√©f√©r√©s pour g√©n√©rer du code de production. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fonction S manuscrite est la mieux adapt√©e pour impl√©menter un lien explicite vers une biblioth√®que partag√©e. Dans ce cas, vous devez utiliser des fonctions telles que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour pouvoir appeler des fonctions. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bloc C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> introduit dans R2018b est de loin le moyen le plus simple d'appeler des fonctions C, mais il a ses limites. La m√™me chose peut √™tre dite pour le bloc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonction C.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui est le plus r√©cent ajout au R2020a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T√©l√©chargez les sources et les mod√®les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503894/index.html">Annonce de la r√©union en ligne NskTechTalks # 12: o√π le d√©veloppeur front-end peut-il grandir et si rien ne se passe?</a></li>
<li><a href="../fr503898/index.html">Front-end distant d'un jour</a></li>
<li><a href="../fr503902/index.html">Comment amener les voisins √† travailler sur leur projet, ou InnerSource pour une banque</a></li>
<li><a href="../fr503904/index.html">Le monde et n mondes, ou les math√©matiques pour les sciences humaines</a></li>
<li><a href="../fr503906/index.html">LabVIEW NXG - Types de donn√©es simples et coercition de type</a></li>
<li><a href="../fr503910/index.html">Exp√©riences sur des personnes qui sont all√©es √† "udalenka"</a></li>
<li><a href="../fr503916/index.html">Apprendre √† √©changer sur l'√©change. Premi√®re partie: configurer un environnement de test</a></li>
<li><a href="../fr503918/index.html">Gestion des packages avec les modules Go: un guide pragmatique</a></li>
<li><a href="../fr503920/index.html">Comment nous testons les syst√®mes de microphones sur STM32: l'exp√©rience des d√©veloppeurs d'appareils Yandex</a></li>
<li><a href="../fr503922/index.html">Pourquoi l'UE √©radique les murs de cookies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>