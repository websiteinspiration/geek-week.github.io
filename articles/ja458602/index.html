<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛢️ 🤹🏼 🙈 Great Chinese Firewallをどのように貫通したか（パート1） 💪🏽 ♠️ 😢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは！
 

NikitaはSEMrushのシステムエンジニアです。今日は、中国でのsemrush.comサービスの安定性を確保するという課題にどのように直面したか、およびその実装中に発生した問題（米国の東海岸にあるデータセンターの場所を考えると）について説明します。
 

これはい...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Great Chinese Firewallをどのように貫通したか（パート1）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/458602/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みなさん、こんにちは！</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nikitaは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEMrushの</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムエンジニア</font><strong><font style="vertical-align: inherit;">です</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">今日は、中国でのsemrush.comサービスの安定性を確保するという課題にどのように直面したか、およびその実装中に発生した問題（米国の東海岸にあるデータセンターの場所を考えると）について説明します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはいくつかの記事に分かれた素晴らしい話になるでしょう。</font><font style="vertical-align: inherit;">それがすべて私たちでどのように起こったかをお話しします。中国からの完全に壊れたサービスから、アメリカ人向けのアメリカ版のレベルでのサービスのパフォーマンスまで。</font><font style="vertical-align: inherit;">私はそれが面白くて役に立つことを約束します。</font><font style="vertical-align: inherit;">じゃ、行こう。</font></font></p><br>
<img src="https://habrastorage.org/webt/cv/6s/sv/cv6ssvuv-od31op6cjnadtw6xsy.png"><br>
<h2 id="problemy-kitayskogo-interneta"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中国のインターネット問題</font></font></h2><br>
<p>          ,    <strong>  </strong>. ,  , ?    ,       —   .      ,  ,           . , , .  ,         ,   ,         .        .</p><a name="habracut"></a><br>
<p>      .           :</p><br>
<ul>
<li>Google, Facebook, Twitter          .</li>
<li> ,       ,        (   ),     (),   .</li>
<li>     ,    .</li>
<li>VPN-, IPSEC- ,    .</li>
<li>  ,   pass phrase,   / ,      .</li>
</ul><br>
<p>,       :</p><br>
<ul>
<li>Google, Facebook, Twitter       ( ),     Google, ,     (  gstatic.com).   :         ,  , .</li>
<li> ,  ,       delay.    .  ,  ,  GET <em>curl</em>’.      (  ).      ( ,       ).       30-40 .</li>
</ul><br>
<pre><code class="bash hljs">nikita@china-shenzhen:~<span class="hljs-comment"># curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com"</span><font></font>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<font></font>
                                 Dload  Upload   Total   Spent    Left  Speed<font></font>
100  381k    0  381k    0     0  71824      0 --:--:--  0:00:05 --:--:-- 82832<font></font>
time_namelookup:  0.004500<font></font>
time_connect:  0.169342<font></font>
time_appconnect:  0.723189<font></font>
time_pretransfer:  0.723499<font></font>
time_redirect:  0.000000<font></font>
time_starttransfer:  1.532912<font></font>
----------<font></font>
time_total:  5.443407<font></font>
----------<font></font>
size_download:  390968 Bytes<font></font>
speed_download:  71824.000B/s<font></font>
<font></font>
nikita@china-hongkong:~<span class="hljs-comment"># curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com"</span><font></font>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<font></font>
                                 Dload  Upload   Total   Spent    Left  Speed<font></font>
100  319k    0  319k    0     0  2555k      0 --:--:-- --:--:-- --:--:-- 2573k<font></font>
time_namelookup:  0.029366<font></font>
time_connect:  0.030742<font></font>
time_appconnect:  0.047310<font></font>
time_pretransfer:  0.047388<font></font>
time_redirect:  0.000000<font></font>
time_starttransfer:  0.120793<font></font>
----------<font></font>
time_total:  0.124871<font></font>
----------<font></font>
size_download:  326755 Bytes<font></font>
speed_download:  2616740.000B/s</code></pre><br>
<p>   <strong>time_connect</strong>.   ,   :   4  ,   .</p><br>
<ul>
<li>VPN  IPSEC-   .        . VPN-,   ,    (      ). </li>
<li> ,   ,   ,     ,      ,    ,      .    “”        ,  “” ,     ,     .     curl  <em>ifconfig.co</em>   HTTPS  HTTP. </li>
</ul><br>
<pre><code class="bash hljs">curl -o /dev/null -w@curl_time <span class="hljs-string">"https://ifconfig.co/"</span><font></font>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<font></font>
                                 Dload  Upload   Total   Spent    Left  Speed<font></font>
100    13  100    13    0     0      2      0  0:00:06  0:00:05  0:00:01     3<font></font>
time_namelookup:  0.004305<font></font>
time_connect:  0.397465<font></font>
time_appconnect:  5.149305<font></font>
time_pretransfer:  5.149393<font></font>
time_redirect:  0.000000<font></font>
time_starttransfer:  5.568847<font></font>
----------<font></font>
time_total:  5.568893<font></font>
----------<font></font>
size_download:  13 Bytes<font></font>
speed_download:  2.000B/s<font></font>
<font></font>
curl -o /dev/null -w@curl_time <span class="hljs-string">"http://ifconfig.co/"</span><font></font>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<font></font>
                                 Dload  Upload   Total   Spent    Left  Speed<font></font>
100    13  100    13    0     0     28      0 --:--:-- --:--:-- --:--:--    28<font></font>
time_namelookup:  0.004282<font></font>
time_connect:  0.212457<font></font>
time_appconnect:  0.000000<font></font>
time_pretransfer:  0.212484<font></font>
time_redirect:  0.000000<font></font>
time_starttransfer:  0.450565<font></font>
----------<font></font>
time_total:  0.450620<font></font>
----------<font></font>
size_download:  13 Bytes<font></font>
speed_download:  28.000B/s</code></pre><br>
<p>  5      13 .  ,     ,  ,  GET  HTTP        ,      HTTPS     3, 5, 10   17 .    SSL:</p><br>
<p><code>Unknown SSL protocol error in connection to ifconfig.co:443.</code></p><br>
<p>,   :</p><br>
<ul>
<li>,   ,  .</li>
<li>        .</li>
<li>Latency     ,     .   /,  ,      ,   ,     . </li>
<li>      ,  .          ,   .</li>
<li>DNS-         .</li>
</ul><br>
<p>   “”. </p><br>
<p>,    ,     ,   SEMrush     , , ,  ,       .  ,    ,          .</p><br>
<p>     :         ,      ,   //?</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>ICP</strong>-</a>.</p><br>
<h2 id="icp-licenziya">ICP-</h2><br>
<p> ,          (Mainland China)   ,    ICP-  .</p><br>
<p>        Mainland China,        ICP,       /. ,   ICP-   ,   Cloudflare  Alibaba Cloud. ,    ICP-  Cloudflare      ,   “”   Alibaba Cloud    .         .</p><br>
<p> ICP-  ,          .</p><br>
<h2 id="testirovanie-resheniy"> </h2><br>
<p>  ,     ,  ,      ,      ,  ,         .</p><br>
<p>         :</p><br>
<ul>
<li>       ,</li>
<li>    .</li>
</ul><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Catchpoint</a>!         .           100500 .       +   <strong>Backbone</strong>- (-    )  <strong>Lastmile</strong>- (    , aka  ).     .</p><br>
<p>   ( ),     . ,      .  :</p><br>
<ul>
<li>DNS-,</li>
<li>Web- (,  GET/POST,     ..),</li>
<li>  (, ),</li>
<li>API-,</li>
<li>Ping, traceroute, NTP  ..</li>
</ul><br>
<p>  .    ,      ,      .      ,    .        ( ),     :</p><br>
<ul>
<li>Connect, Wait, Load, SSL, DNS time,</li>
<li>TTFB, TTLB, Document complete, Render time, DOM load,</li>
<li>Response (-   Time To First Byte), Webpage Response (-   Time To Last Byte),</li>
<li> percentile, Average, Median time</li>
<li> ..</li>
</ul><br>
<p>,         ,   . ,  ,   <strong>Response, Webpage Response, Median, 75  95 Percentiles</strong>. </p><br>
<p> ,       : <strong>    Catchpoint</strong>?                  -   ,      real user experience?<br>
  ,         ,     .  socks-proxy  ,         ,     ,       curl   GET     .  ,          ,       ,   .</p><br>
<p>       ,  <strong>Catchpoint  ,        .</strong></p><br>
<h2 id="cloudflare-china-network">Cloudflare China Network</h2><br>
<p>     semrush.com    Cloudflare,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">China Network</a>.      Enterprise-       .      ,   ICP-,       Cloudflare.   ,     “ CDN”  Cloudflare —        PoP (Points of Presence) CF,         /   origin. </p><br>
<p>     .</p><br>
<img src="https://habrastorage.org/webt/zk/hw/um/zkhwumkneyyxkij6gdffhzcl6qw.png"><br>
<p>    . ,       CF,     ,   ,      .</p><br>
<p>   ,    :</p><br>
<img src="https://habrastorage.org/webt/cs/wo/hp/cswohpvoexjj3nanyzxloxk2poo.png"><br>
<p>  —   .   — DNS  (resolve timeout).   — .</p><br>
<p><em>Uptime: 86.6<br>
Median: 18s<br>
75 Percentile: 29.3s<br>
95 Percentile: 60s</em></p><br>
<p>,  ,    <em>reCaptcha</em> ( ,   ),   28  18 .      ,  ,      semrush.com ( )   10   95%  ( )      ( + ).</p><br>
<p>       <em>Waterfall</em>     .     ,        :    “ ,  ”, -       -    ,  DNS-   .  ,  <em>PoP</em>  Cloudflare    ,      anycast IP,  DNS-  , -  DNS-    ,    .</p><br>
<p>    CF, ,  <strong> DNS-     </strong>,    —  .</p><br>
<p>     DNS Cloudflare     Cloudflare      “<strong> DNS</strong>”.   ,  Cloudflare     ,  ,   DDoS-, CDN   ,      DNS-. </p><br>
<p>      .       ,  DNS- Cloudflare  .</p><br>
<img src="https://habrastorage.org/webt/ac/w0/r7/acw0r7fgqahq9w2kckq6-myxjky.png"><br>
<p> Catchpoint    GET- ( ),     .       DNS .</p><br>
<img src="https://habrastorage.org/webt/_w/3c/wu/_w3cwuxv8j9tdeuvp20jblktqoi.png"><br>
<p>      <em>dig</em>  ,       ,         <em>SERVFAIL</em>  <em>not found</em>.    ?</p><br>
<pre><code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># host semrushchina.cn</span><font></font>
semrushchina.cn has address 220.170.186.192<font></font>
Host semrushchina.cn not found: 2(SERVFAIL)<font></font>
root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># host semrushchina.cn</span><font></font>
semrushchina.cn has address 220.170.186.192<font></font>
Host semrushchina.cn not found: 2(SERVFAIL)<font></font>
root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># host semrushchina.cn</span><font></font>
semrushchina.cn has address 220.170.186.192<font></font>
Host semrushchina.cn not found: 2(SERVFAIL)<font></font>
root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># host semrushchina.cn</span><font></font>
semrushchina.cn has address 220.170.186.192<font></font>
Host semrushchina.cn not found: 2(SERVFAIL)</code></pre><br>
<p>  NS- Cloudflare    :</p><br>
<pre><code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># for i in `seq 1 2`; do host semrushchina.cn ray.ns.cloudflare.com.; done</span><font></font>
Using domain server:<font></font>
Name: ray.ns.cloudflare.com.<font></font>
Address: 173.245.59.138<span class="hljs-comment">#53</span><font></font>
Aliases: <font></font>
<font></font>
semrushchina.cn has address 220.170.186.192<font></font>
semrushchina.cn has address 220.170.186.192<font></font>
Using domain server:<font></font>
Name: ray.ns.cloudflare.com.<font></font>
Address: 173.245.59.138<span class="hljs-comment">#53</span><font></font>
Aliases: <font></font>
<font></font>
semrushchina.cn has address 220.170.186.192<font></font>
semrushchina.cn has address 220.170.186.192</code></pre><br>
<p>,    “” DNS-   .<br>
  ,  <em>SERVFAIL</em>     <em>AAAA</em>-. </p><br>
<p>,     Cloudflare <em></em>-,    , Cloudflare  <em></em>-,      RFC. -    (<em>x.x.x.x</em>)   ,    <em>SERVFAIL</em>.       :</p><br>
<pre><code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># dig -t AAAA semrushchina.cn @x.x.x.x</span><font></font>
<font></font>
; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @x.x.x.x<font></font>
;; global options: +cmd<font></font>
;; Got answer:<font></font>
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 55467<font></font>
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1<font></font>
<font></font>
;; OPT PSEUDOSECTION:<font></font>
; EDNS: version: 0, flags:; udp: 4096<font></font>
;; QUESTION SECTION:<font></font>
;semrushchina.cn.               IN      AAAA<font></font>
<font></font>
;; Query time: 334 msec<font></font>
;; SERVER: x.x.x.x<span class="hljs-comment">#53(x.x.x.x)</span><font></font>
;; WHEN: Tue Aug 14 23:38:50 CST 2018<font></font>
;; MSG SIZE  rcvd: 44<font></font>
<font></font>
root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"># dig -t AAAA semrushchina.cn @dana.ns.cloudflare.com.</span><font></font>
<font></font>
; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @dana.ns.cloudflare.com.<font></font>
;; global options: +cmd<font></font>
;; Got answer:<font></font>
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 63944<font></font>
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1<font></font>
;; WARNING: recursion requested but not available<font></font>
<font></font>
;; OPT PSEUDOSECTION:<font></font>
; EDNS: version: 0, flags:; udp: 512<font></font>
;; QUESTION SECTION:<font></font>
;semrushchina.cn.               IN      AAAA<font></font>
<font></font>
;; ANSWER SECTION:<font></font>
semrushchina.cn.        300     IN      A       220.170.186.192<font></font>
<font></font>
;; Query time: 185 msec<font></font>
;; SERVER: 173.245.58.105<span class="hljs-comment">#53(173.245.58.105)</span><font></font>
;; WHEN: Tue Aug 14 23:43:03 CST 2018<font></font>
;; MSG SIZE  rcvd: 60<font></font>
</code></pre><br>
<p>  bug- Cloudflare,      - .  :           IPv6,  Cloudflare      IPv6      <em></em>-.     ,    Cloudflare   <em>NODATA</em>   .</p><br>
<p>,  DNS   Catchpoint  ,    .     :</p><br>
<img src="https://habrastorage.org/webt/u5/i7/fj/u5i7fjgo6pb9fl4mddq27uhk9lo.png"><br>
<p>     . </p><br>
<p>    ,      <strong>Alibaba Cloud</strong>,     "" Nginx     PoC (Proof of Concept) ,    Multi-Cloud ,             .</p><br>
<p><strong>Stay tuned!</strong></p><br>
<h3 id="vse-chasti"> </h3><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 2</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 3</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458592/index.html">高CephレイテンシからeBPF / BCCを使用したカーネルパッチまで</a></li>
<li><a href="../ja458594/index.html">L7バランシングで繰り返し要求を使用してクライアントへの応答の可能性を高めることを忘れないでください</a></li>
<li><a href="../ja458596/index.html">ささいな喜び＃6：OpenAIジム-ゲームをプレイしてロボットを操作する</a></li>
<li><a href="../ja458598/index.html">環境マップ上の光源の認識</a></li>
<li><a href="../ja458600/index.html">電動自転車とは（2つのメーカーの5つのモデルの2つの部分でのグループレビュー）、パート1</a></li>
<li><a href="../ja458604/index.html">2つの最大の電子機器メーカーが新しいGPUプロジェクトに力を合わせた理由</a></li>
<li><a href="../ja458606/index.html">DockerでOpenVPNを2秒で実行する</a></li>
<li><a href="../ja458608/index.html">Node.js開発者ツール ジョブキュー</a></li>
<li><a href="../ja458612/index.html">宇宙。7年間</a></li>
<li><a href="../ja458614/index.html">ブラウザ座標を取得および追跡するためのReactive UsePosition（）フックの作成</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>