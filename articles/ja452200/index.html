<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📥 👨🏾‍🎤 👨🏼‍🏫 GOSTIM：GOST暗号化によるP2P F2F E2EE IMの一夜 👩🏽‍🎨 🙎🏿 ☹️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PyGOSTライブラリ（純粋なPythonのGOST暗号プリミティブ）の開発者として、私は膝に最も簡単な安全なメッセージングを実装する方法についてよく質問を受けます。多くの人は、適用された暗号化をかなり単純なものであると考えており、ブロック暗号への.encrypt（）呼び出しは、通信チャネルを介して...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GOSTIM：GOST暗号化によるP2P F2F E2EE IMの一夜</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452200/"><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyGOST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ（純粋なPythonのGOST暗号プリミティブ）の</font><font style="vertical-align: inherit;">開発者として、</font><font style="vertical-align: inherit;">私は膝に最も簡単な安全なメッセージングを実装する方法についてよく質問を受けます。多くの人は、適用された暗号化をかなり単純なものであると考えており、ブロック暗号への.encrypt（）呼び出しは、通信チャネルを介して安全に送信するのに十分です。他の人たちは、適用された暗号化は少数の運命であると信じており、数学オリンピック</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">備えたテレグラムなどの裕福な企業が</font><font style="vertical-align: inherit;">安全なプロトコルを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">実装できない</font></a><font style="vertical-align: inherit;">ことは許容</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">され</font></a><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてから、暗号化プロトコルと安全なIMの実装はそれほど難しい作業ではないことを示すために、この記事を書くように促されました。ただし、独自の認証および鍵合意プロトコルを発明することは、それだけの価値はありません。</font></font><br>
<br>
<div style="text-align:center;"><img alt="聴覚" src="https://habrastorage.org/getpro/habr/post_images/4e2/2bb/f04/4e22bbf0480a8181bcbb2054c6f95815.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事は</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">GOST暗号化アルゴリズムPyGOSTライブラリと排他的に使用</font><font style="vertical-align: inherit;">する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">SIGMA-I</font></a><font style="vertical-align: inherit;">認証と鍵合意プロトコル（どの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">IPsec IKE</font></a><font style="vertical-align: inherit;">が実装されているかに基づく</font><font style="vertical-align: inherit;">）を使用した</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピアツーピア</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレンド</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ツー</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">フレンド</font></a><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドツーエンドの暗号化</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インスタントメッセンジャーで</font><font style="vertical-align: inherit;">作成されます。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">PyDERASN</font></a><font style="vertical-align: inherit;">ライブラリを使用したメッセージのASN.1エンコーディング</font><font style="vertical-align: inherit;">（これについては、すでに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">以前</font></a><font style="vertical-align: inherit;">に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">記述しました</font></a><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">前提条件：夕方（または稼働日）にゼロから作成できるほど単純でなければなりません。そうでない場合、単純なプログラムではなくなります。</font><font style="vertical-align: inherit;">おそらくエラー、不必要な困難、欠点があり、さらにこれはasyncioライブラリを使用する最初のプログラムです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMの設計</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始するには、IMの外観を理解する必要があります。簡単にするために、参加者を発見しないピアツーピアネットワークにします。私たちは、どのアドレスに対面するかを個人的に示します：対談者と通信するために接続するポート。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現時点では、任意の2台のコンピューター間で直接通信が可能であるという前提が、実際のIMの適用性を大きく制限していることを理解しています。しかし、あらゆる種類のNATトラバーサル松葉杖を実装する開発者が増えるほど、IPv4インターネットに留まる時間が長くなり、任意のコンピューター間の通信の可能性が低くなります。ええと、家庭や職場でのIPv6の欠如にどれだけ耐えられますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは友達同士のネットワークを持ちます：可能なすべての対談者は事前に知っておく必要があります。</font><font style="vertical-align: inherit;">第一に、それはすべてを非常に単純化します：自己紹介、名前/キーを見つけた、または見つけなかった、切断された、または作業を続行し、対話者を知っています。</font><font style="vertical-align: inherit;">第二に、一般的なケースでは、安全で多くの攻撃を排除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMインターフェースは</font><font style="vertical-align: inherit;">、私が彼らのミニマリズムとUnix方式の哲学で本当に気に入って</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いる</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">サックレスプロジェクトの</font></a><font style="vertical-align: inherit;">古典的なソリューションに近くなります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">各対話者用のIMプログラムは、3つのUnixドメインソケットを持つディレクトリを作成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in-対談者に送信されたメッセージはその中に記録されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">out-対話者から受信したメッセージがそこから読み取られます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態-そこから読み取ると、対話者が現在接続されているかどうか、接続アドレス/ポートがわかります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、connソケットが作成され、どのホストポートに書き込むかによって、リモートの対話者への接続が開始されます。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|-アリス</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">|-中</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">|-アウト</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">`-状態</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
|-ボブ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">|-中</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">|-アウト</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">`-状態</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
`-conn</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチでは、IMトランスポートとユーザーインターフェイスの独立した実装を行うことができます。味と色に友だちがいないため、誰もが満足できるとは限りません。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tmux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multitail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">して、構文を強調表示したマルチウィンドウインターフェイスを取得できます。そして、で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rlwrap、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたはメッセージを入力するためのGNU Readlineの互換文字列を取得することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、サックレスプロジェクトはFIFOファイルを使用します。個人的には、選択したスレッドから手作りの素材がないと、非同期でファイルをどのように操作できるか理解できませんでした（そのようなものに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言語を長い間使用してきました</font><font style="vertical-align: inherit;">）。そのため、Unixドメインソケットを使用することにしました。残念ながら、これにより、エコー2001：470：デッド::ベイブ6666&gt; connを実行できなくなります。私はこの問題を使用して解決しました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：echo 2001：470：dead :: babe 6666 | </font><font style="vertical-align: inherit;">socat-UNIX-CONNECT：conn、socat READLINE UNIX-CONNECT：alice / in。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全でない初期プロトコル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCPはトランスポートとして使用され、配信とその順序を保証します。 UDPはどちらも保証せず（暗号化が適用されている場合に役立ちます）、</font><font style="vertical-align: inherit;">Pythonでの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポート</font><font style="vertical-align: inherit;">はそのまま使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、TCPにはメッセージの概念はありませんが、バイトのストリームしかありません。そのため、このストリームでメッセージを共有できるように、メッセージの形式を考える必要があります。改行文字の使用に同意することができます。初心者にとっては適切ですが、メッセージの暗号化を開始すると、この記号は暗号文のどこにでも現れる可能性があります。したがって、ネットワークでは、メッセージの長さをバイト単位で最初に送信するプロトコルが一般的です。たとえば、Pythonでは、箱から出してすぐに同様の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XDR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式で作業できるxdrlibがあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCP読み取りでは正しく効率的に機能しません。コードを簡略化します。メッセージ全体をデコードするまで、無限ループでソケットからデータを読み取ります。このアプローチの形式として、XMLでJSONを使用できます。ただし、暗号化を追加する場合は、データに署名して認証する必要があります。これには、JSON / XMLが提供しないオブジェクトのバイト単位の同一の表現が必要になります（ダンプ結果は異なる場合があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
XDRはこのようなタスクに適していますが、</font><font style="vertical-align: inherit;">高レベルのオブジェクトが手元にあるため</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DERS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンコードと</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">PyDERASN</font></a><font style="vertical-align: inherit;">ライブラリー</font><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">備えた</font></a><font style="vertical-align: inherit;"> ASN.1を選択します</font><font style="vertical-align: inherit;">。スキーマ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベン</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">コード</font></a><font style="vertical-align: inherit;">とは異なり</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessagePack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CBOR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ASN.1は、ハードコードされた回路に対してデータを自動的にチェックします。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Msg ::= CHOICE {</span>
<span class="hljs-comment">#       text      MsgText,</span>
<span class="hljs-comment">#       handshake [0] EXPLICIT MsgHandshake }</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Msg</span>(<span class="hljs-params">Choice</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"text"</span>, MsgText()),<font></font>
        (<span class="hljs-string">"handshake"</span>, MsgHandshake(expl=tag_ctxc(<span class="hljs-number">0</span>))),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-comment"># MsgText ::= SEQUENCE {</span>
<span class="hljs-comment">#       text UTF8String (SIZE(1..MaxTextLen))}</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgText</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"text"</span>, UTF8String(bounds=(<span class="hljs-number">1</span>, MaxTextLen))),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-comment"># MsgHandshake ::= SEQUENCE {</span>
<span class="hljs-comment">#       peerName UTF8String (SIZE(1..256)) }</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgHandshake</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"peerName"</span>, UTF8String(bounds=(<span class="hljs-number">1</span>, <span class="hljs-number">256</span>))),<font></font>
    ))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信されたメッセージはMsgです。テキストMsgText（これまでに1つのテキストフィールドを含む）またはハンドシェイクメッセージMsgHandshake（対話者の名前が送信されます）のいずれかです。</font><font style="vertical-align: inherit;">今では複雑すぎるように見えますが、それは将来への挑戦です。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">     ┌─────┐┌─────┐</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     │PeerA││PeerB│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
     └──┬──┘└──┬──┘</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │MsgHandshake（IdA）│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │─────────────────&gt;&gt;│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        ││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │MsgHandshake（IdB）│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │&lt;─────────────────││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        ││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │MsgText（）│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │─────────────────&gt;&gt;│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        ││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │MsgText（）│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        │&lt;─────────────────││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        ││</font></font><font></font>
</pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化なしのIM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、ソケットを使用するすべての操作で、asyncioライブラリが使用されます。</font><font style="vertical-align: inherit;">リリース時に期待することを宣言します。</font></font><br>
<br>
<pre><code class="python hljs">parser = argparse.ArgumentParser(description=<span class="hljs-string">"GOSTIM"</span>)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--our-name"</span>,<font></font>
    required=<span class="hljs-literal">True</span>,<font></font>
    help=<span class="hljs-string">"Our peer name"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--their-names"</span>,<font></font>
    required=<span class="hljs-literal">True</span>,<font></font>
    help=<span class="hljs-string">"Their peer names, comma-separated"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--bind"</span>,<font></font>
    default=<span class="hljs-string">"::1"</span>,<font></font>
    help=<span class="hljs-string">"Address to listen on"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--port"</span>,<font></font>
    type=int,<font></font>
    default=<span class="hljs-number">6666</span>,<font></font>
    help=<span class="hljs-string">"Port to listen on"</span>,<font></font>
)<font></font>
args = parser.parse_args()<font></font>
OUR_NAME = UTF8String(args.our_name)<font></font>
THEIR_NAMES = set(args.their_names.split(<span class="hljs-string">","</span>))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自分の名前を設定します（--our-name alice）。</font><font style="vertical-align: inherit;">カンマは、予想されるすべての対話者をリストします（--their-names bob、eve）。</font><font style="vertical-align: inherit;">対話者のそれぞれについて、Unixソケットを含むディレクトリが作成され、それぞれのin、out、stateのコルーチンが作成されます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">for</span> peer_name <span class="hljs-keyword">in</span> THEIR_NAMES:<font></font>
    makedirs(peer_name, mode=<span class="hljs-number">0o700</span>, exist_ok=<span class="hljs-literal">True</span>)<font></font>
    out_queue = asyncio.Queue()<font></font>
    OUT_QUEUES[peer_name] = out_queue<font></font>
    asyncio.ensure_future(asyncio.start_unix_server(<font></font>
        partial(unixsock_out_processor, out_queue=out_queue),<font></font>
        path.join(peer_name, <span class="hljs-string">"out"</span>),<font></font>
    ))<font></font>
    in_queue = asyncio.Queue()<font></font>
    IN_QUEUES[peer_name] = in_queue<font></font>
    asyncio.ensure_future(asyncio.start_unix_server(<font></font>
        partial(unixsock_in_processor, in_queue=in_queue),<font></font>
        path.join(peer_name, <span class="hljs-string">"in"</span>),<font></font>
    ))<font></font>
    asyncio.ensure_future(asyncio.start_unix_server(<font></font>
        partial(unixsock_state_processor, peer_name=peer_name),<font></font>
        path.join(peer_name, <span class="hljs-string">"state"</span>),<font></font>
    ))<font></font>
asyncio.ensure_future(asyncio.start_unix_server(unixsock_conn_processor, <span class="hljs-string">"conn"</span>))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーからのソケット内のメッセージは、キューIN_QUEUESに送信されます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unixsock_in_processor</span>(<span class="hljs-params">reader, writer, in_queue: asyncio.Queue</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        text = <span class="hljs-keyword">await</span> reader.read(MaxTextLen)
        <span class="hljs-keyword">if</span> text == <span class="hljs-string">b""</span>:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">await</span> in_queue.put(text.decode(<span class="hljs-string">"utf-8"</span>))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
対話者からのメッセージはOUT_QUEUESキューに送信され、そこからデータが出力ソケットに書き込まれます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unixsock_out_processor</span>(<span class="hljs-params">reader, writer, out_queue: asyncio.Queue</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        text = <span class="hljs-keyword">await</span> out_queue.get()<font></font>
        writer.write((<span class="hljs-string">"[%s] %s"</span> % (datetime.now(), text)).encode(<span class="hljs-string">"utf-8"</span>))
        <span class="hljs-keyword">await</span> writer.drain()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状態ソケットから読み取るとき、プログラムは対話者のアドレスをPEER_ALIVE辞書で調べます。</font><font style="vertical-align: inherit;">対話者への接続がまだない場合、空の行が書き込まれます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unixsock_state_processor</span>(<span class="hljs-params">reader, writer, peer_name: str</span>) -&gt; <span class="hljs-keyword">None</span>:</span><font></font>
    peer_writer = PEER_ALIVES.get(peer_name)<font></font>
    writer.write(<font></font>
        <span class="hljs-string">b""</span> <span class="hljs-keyword">if</span> peer_writer <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> (<span class="hljs-string">" "</span>.join([<font></font>
            str(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> peer_writer.get_extra_info(<span class="hljs-string">"peername"</span>)[:<span class="hljs-number">2</span>]<font></font>
        ]).encode(<span class="hljs-string">"utf-8"</span>) + <span class="hljs-string">b"\n"</span>)<font></font>
    )<font></font>
    <span class="hljs-keyword">await</span> writer.drain()<font></font>
    writer.close()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アドレスがconnソケットに書き込まれると、接続の「イニシエーター」の機能が起動します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unixsock_conn_processor</span>(<span class="hljs-params">reader, writer</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    data = <span class="hljs-keyword">await</span> reader.read(<span class="hljs-number">256</span>)<font></font>
    writer.close()<font></font>
    host, port = data.decode(<span class="hljs-string">"utf-8"</span>).split(<span class="hljs-string">" "</span>)
    <span class="hljs-keyword">await</span> initiator(host=host, port=int(port))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イニシエーターを検討してください。</font><font style="vertical-align: inherit;">まず、明らかに彼は指定されたホスト/ポートへの接続を開き、自分の名前でハンドシェイクメッセージを送信します。</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">130</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initiator</span>(<span class="hljs-params">host, port</span>):</span>
 <span class="hljs-number">131</span>     _id = repr((host, port))
 <span class="hljs-number">132</span>     logging.info(<span class="hljs-string">"%s: dialing"</span>, _id)
 <span class="hljs-number">133</span>     reader, writer = <span class="hljs-keyword">await</span> asyncio.open_connection(host, port)
 <span class="hljs-number">134</span>     <span class="hljs-comment"># Handshake message {{{</span>
 <span class="hljs-number">135</span>     writer.write(Msg((<span class="hljs-string">"handshake"</span>, MsgHandshake((
 <span class="hljs-number">136</span>         (<span class="hljs-string">"peerName"</span>, OUR_NAME),
 <span class="hljs-number">137</span>     )))).encode())
 <span class="hljs-number">138</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">139</span>     <span class="hljs-keyword">await</span> writer.drain()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、リモート側からの応答を待ちます。</font><font style="vertical-align: inherit;">Msg ASN.1スキームに従って受信した応答をデコードしようとします。</font><font style="vertical-align: inherit;">メッセージ全体が1つのTCPセグメントによって送信され、.read（）が呼び出されたときにアトミックに受信されると想定しています。</font><font style="vertical-align: inherit;">ハンドシェイクメッセージを正確に受信したことを確認します。</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">141</span>     <span class="hljs-comment"># Wait for Handshake message {{{</span>
 <span class="hljs-number">142</span>     data = <span class="hljs-keyword">await</span> reader.read(<span class="hljs-number">256</span>)
 <span class="hljs-number">143</span>     <span class="hljs-keyword">if</span> data == <span class="hljs-string">b""</span>:
 <span class="hljs-number">144</span>         logging.warning(<span class="hljs-string">"%s: no answer, disconnecting"</span>, _id)
 <span class="hljs-number">145</span>         writer.close()
 <span class="hljs-number">146</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">147</span>     <span class="hljs-keyword">try</span>:
 <span class="hljs-number">148</span>         msg, _ = Msg().decode(data)
 <span class="hljs-number">149</span>     <span class="hljs-keyword">except</span> ASN1Error:
 <span class="hljs-number">150</span>         logging.warning(<span class="hljs-string">"%s: undecodable answer, disconnecting"</span>, _id)
 <span class="hljs-number">151</span>         writer.close()
 <span class="hljs-number">152</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">153</span>     logging.info(<span class="hljs-string">"%s: got %s message"</span>, _id, msg.choice)
 <span class="hljs-number">154</span>     <span class="hljs-keyword">if</span> msg.choice != <span class="hljs-string">"handshake"</span>:
 <span class="hljs-number">155</span>         logging.warning(<span class="hljs-string">"%s: unexpected message, disconnecting"</span>, _id)
 <span class="hljs-number">156</span>         writer.close()
 <span class="hljs-number">157</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">158</span>     <span class="hljs-comment"># }}}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
話している相手の名前がわかっていることを確認します。</font><font style="vertical-align: inherit;">そうでない場合は、接続を切断します。</font><font style="vertical-align: inherit;">私たちは彼との接続がすでに確立されているかどうかを確認し（対話者が再び私たちに接続するコマンドを与えた）、それを閉じます。</font><font style="vertical-align: inherit;">メッセージテキストを含むPython文字列はIN_QUEUESキューに配置されますが、特別な値Noneがあり、これはmsg_senderにコルーチンに信号を送って動作を停止し、古いTCP接続に関連するライターについて忘れるようにします。</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">159</span>     msg_handshake = msg.value
 <span class="hljs-number">160</span>     peer_name = str(msg_handshake[<span class="hljs-string">"peerName"</span>])
 <span class="hljs-number">161</span>     <span class="hljs-keyword">if</span> peer_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> THEIR_NAMES:
 <span class="hljs-number">162</span>         logging.warning(<span class="hljs-string">"unknown peer name: %s"</span>, peer_name)
 <span class="hljs-number">163</span>         writer.close()
 <span class="hljs-number">164</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">165</span>     logging.info(<span class="hljs-string">"%s: session established: %s"</span>, _id, peer_name)
 <span class="hljs-number">166</span>     <span class="hljs-comment"># Run text message sender, initialize transport decoder {{{</span>
 <span class="hljs-number">167</span>     peer_alive = PEER_ALIVES.pop(peer_name, <span class="hljs-literal">None</span>)
 <span class="hljs-number">168</span>     <span class="hljs-keyword">if</span> peer_alive <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
 <span class="hljs-number">169</span>         peer_alive.close()
 <span class="hljs-number">170</span>         <span class="hljs-keyword">await</span> IN_QUEUES[peer_name].put(<span class="hljs-literal">None</span>)
 <span class="hljs-number">171</span>     PEER_ALIVES[peer_name] = writer
 <span class="hljs-number">172</span>     asyncio.ensure_future(msg_sender(peer_name, writer))
 <span class="hljs-number">173</span>     <span class="hljs-comment"># }}}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msg_senderは（ソケットからキューに入れられた）発信メッセージを受け入れ、それらをMsgTextメッセージにシリアル化し、TCP接続を介して送信します。いつでも壊れる可能性があります-明らかに遮断しています。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">msg_sender</span>(<span class="hljs-params">peer_name: str, writer</span>) -&gt; <span class="hljs-keyword">None</span>:</span><font></font>
    in_queue = IN_QUEUES[peer_name]<font></font>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        text = <span class="hljs-keyword">await</span> in_queue.get()
        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">break</span>
        writer.write(Msg((<span class="hljs-string">"text"</span>, MsgText((<font></font>
            (<span class="hljs-string">"text"</span>, UTF8String(text)),<font></font>
        )))).encode())<font></font>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">await</span> writer.drain()
        <span class="hljs-keyword">except</span> ConnectionResetError:
            <span class="hljs-keyword">del</span> PEER_ALIVES[peer_name]
            <span class="hljs-keyword">return</span>
        logging.info(<span class="hljs-string">"%s: sent %d characters message"</span>, peer_name, len(text))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、イニシエーターは、ソケットからメッセージを読み取る無限のサイクルに入ります。</font><font style="vertical-align: inherit;">これがテキストメッセージであるかどうかを確認し、対応する対話者の出力ソケットに送信されるキューをOUT_QUEUESに配置します。</font><font style="vertical-align: inherit;">なぜ.read（）を実行してメッセージをデコードできないのですか？</font><font style="vertical-align: inherit;">ユーザーからのいくつかのメッセージがオペレーティングシステムのバッファに集約され、1つのTCPセグメントによって送信される可能性があるためです。</font><font style="vertical-align: inherit;">最初のものをデコードし、その後、次のものの一部をバッファに残すことができます。</font><font style="vertical-align: inherit;">緊急時には、TCP接続を閉じて、（NoneをOUT_QUEUESキューに送信することにより）msg_senderコルーチンを停止します。</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">174</span>     buf = <span class="hljs-string">b""</span>
 <span class="hljs-number">175</span>     <span class="hljs-comment"># Wait for test messages {{{</span>
 <span class="hljs-number">176</span>     <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
 <span class="hljs-number">177</span>         data = <span class="hljs-keyword">await</span> reader.read(MaxMsgLen)
 <span class="hljs-number">178</span>         <span class="hljs-keyword">if</span> data == <span class="hljs-string">b""</span>:
 <span class="hljs-number">179</span>             <span class="hljs-keyword">break</span>
 <span class="hljs-number">180</span>         buf += data
 <span class="hljs-number">181</span>         <span class="hljs-keyword">if</span> len(buf) &gt; MaxMsgLen:
 <span class="hljs-number">182</span>             logging.warning(<span class="hljs-string">"%s: max buffer size exceeded"</span>, _id)
 <span class="hljs-number">183</span>             <span class="hljs-keyword">break</span>
 <span class="hljs-number">184</span>         <span class="hljs-keyword">try</span>:
 <span class="hljs-number">185</span>             msg, tail = Msg().decode(buf)
 <span class="hljs-number">186</span>         <span class="hljs-keyword">except</span> ASN1Error:
 <span class="hljs-number">187</span>             <span class="hljs-keyword">continue</span>
 <span class="hljs-number">188</span>         buf = tail
 <span class="hljs-number">189</span>         <span class="hljs-keyword">if</span> msg.choice != <span class="hljs-string">"text"</span>:
 <span class="hljs-number">190</span>             logging.warning(<span class="hljs-string">"%s: unexpected %s message"</span>, _id, msg.choice)
 <span class="hljs-number">191</span>             <span class="hljs-keyword">break</span>
 <span class="hljs-number">192</span>         <span class="hljs-keyword">try</span>:
 <span class="hljs-number">193</span>             <span class="hljs-keyword">await</span> msg_receiver(msg.value, peer_name)
 <span class="hljs-number">194</span>         <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> err:
 <span class="hljs-number">195</span>             logging.warning(<span class="hljs-string">"%s: %s"</span>, err)
 <span class="hljs-number">196</span>             <span class="hljs-keyword">break</span>
 <span class="hljs-number">197</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">198</span>     logging.info(<span class="hljs-string">"%s: disconnecting: %s"</span>, _id, peer_name)
 <span class="hljs-number">199</span>     IN_QUEUES[peer_name].put(<span class="hljs-literal">None</span>)
 <span class="hljs-number">200</span>     writer.close()<font></font>
<font></font>
  <span class="hljs-number">66</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">msg_receiver</span>(<span class="hljs-params">msg_text: MsgText, peer_name: str</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
  <span class="hljs-number">67</span>     text = str(msg_text[<span class="hljs-string">"text"</span>])
  <span class="hljs-number">68</span>     logging.info(<span class="hljs-string">"%s: received %d characters message"</span>, peer_name, len(text))
  <span class="hljs-number">69</span>     <span class="hljs-keyword">await</span> OUT_QUEUES[peer_name].put(text)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインコードに戻りましょう。</font><font style="vertical-align: inherit;">すべてのコルーチンを作成した後、プログラムの開始時に、TCPサーバーを起動します。</font><font style="vertical-align: inherit;">確立された接続ごとに、彼はレスポンダーコルーチンを作成します。</font></font><br>
<br>
<pre><code class="python hljs">logging.basicConfig(<font></font>
    level=logging.INFO,<font></font>
    format=<span class="hljs-string">"%(levelname)s %(asctime)s: %(funcName)s: %(message)s"</span>,<font></font>
)<font></font>
loop = asyncio.get_event_loop()<font></font>
server = loop.run_until_complete(asyncio.start_server(responder, args.bind, args.port))<font></font>
logging.info(<span class="hljs-string">"Listening on: %s"</span>, server.sockets[<span class="hljs-number">0</span>].getsockname())<font></font>
loop.run_forever()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レスポンダはイニシエータに似ており、すべて同じアクションをミラーリングしますが、簡単にするために、メッセージを読み取る無限ループがすぐに始まります。</font><font style="vertical-align: inherit;">これで、ハンドシェイクプロトコルは両側から1つのメッセージを送信しますが、将来的には接続のイニシエーターから2つ送信され、その後すぐにテキストメッセージを送信できます。</font></font><br>
<br>
<pre><code class="python hljs">  <span class="hljs-number">72</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">responder</span>(<span class="hljs-params">reader, writer</span>):</span>
  <span class="hljs-number">73</span>     _id = writer.get_extra_info(<span class="hljs-string">"peername"</span>)
  <span class="hljs-number">74</span>     logging.info(<span class="hljs-string">"%s: connected"</span>, _id)
  <span class="hljs-number">75</span>     buf = <span class="hljs-string">b""</span>
  <span class="hljs-number">76</span>     msg_expected = <span class="hljs-string">"handshake"</span>
  <span class="hljs-number">77</span>     peer_name = <span class="hljs-literal">None</span>
  <span class="hljs-number">78</span>     <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
  <span class="hljs-number">79</span>         <span class="hljs-comment"># Read until we get Msg message {{{</span>
  <span class="hljs-number">80</span>         data = <span class="hljs-keyword">await</span> reader.read(MaxMsgLen)
  <span class="hljs-number">81</span>         <span class="hljs-keyword">if</span> data == <span class="hljs-string">b""</span>:
  <span class="hljs-number">82</span>             logging.info(<span class="hljs-string">"%s: closed connection"</span>, _id)
  <span class="hljs-number">83</span>             <span class="hljs-keyword">break</span>
  <span class="hljs-number">84</span>         buf += data
  <span class="hljs-number">85</span>         <span class="hljs-keyword">if</span> len(buf) &gt; MaxMsgLen:
  <span class="hljs-number">86</span>             logging.warning(<span class="hljs-string">"%s: max buffer size exceeded"</span>, _id)
  <span class="hljs-number">87</span>             <span class="hljs-keyword">break</span>
  <span class="hljs-number">88</span>         <span class="hljs-keyword">try</span>:
  <span class="hljs-number">89</span>             msg, tail = Msg().decode(buf)
  <span class="hljs-number">90</span>         <span class="hljs-keyword">except</span> ASN1Error:
  <span class="hljs-number">91</span>             <span class="hljs-keyword">continue</span>
  <span class="hljs-number">92</span>         buf = tail
  <span class="hljs-number">93</span>         <span class="hljs-comment"># }}}</span>
  <span class="hljs-number">94</span>         <span class="hljs-keyword">if</span> msg.choice != msg_expected:
  <span class="hljs-number">95</span>             logging.warning(<span class="hljs-string">"%s: unexpected %s message"</span>, _id, msg.choice)
  <span class="hljs-number">96</span>             <span class="hljs-keyword">break</span>
  <span class="hljs-number">97</span>         <span class="hljs-keyword">if</span> msg_expected == <span class="hljs-string">"text"</span>:
  <span class="hljs-number">98</span>             <span class="hljs-keyword">try</span>:
  <span class="hljs-number">99</span>                 <span class="hljs-keyword">await</span> msg_receiver(msg.value, peer_name)
 <span class="hljs-number">100</span>             <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> err:
 <span class="hljs-number">101</span>                 logging.warning(<span class="hljs-string">"%s: %s"</span>, err)
 <span class="hljs-number">102</span>                 <span class="hljs-keyword">break</span>
 <span class="hljs-number">103</span>         <span class="hljs-comment"># Process Handshake message {{{</span>
 <span class="hljs-number">104</span>         <span class="hljs-keyword">elif</span> msg_expected == <span class="hljs-string">"handshake"</span>:
 <span class="hljs-number">105</span>             logging.info(<span class="hljs-string">"%s: got %s message"</span>, _id, msg_expected)
 <span class="hljs-number">106</span>             msg_handshake = msg.value
 <span class="hljs-number">107</span>             peer_name = str(msg_handshake[<span class="hljs-string">"peerName"</span>])
 <span class="hljs-number">108</span>             <span class="hljs-keyword">if</span> peer_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> THEIR_NAMES:
 <span class="hljs-number">109</span>                 logging.warning(<span class="hljs-string">"unknown peer name: %s"</span>, peer_name)
 <span class="hljs-number">110</span>                 <span class="hljs-keyword">break</span>
 <span class="hljs-number">111</span>             writer.write(Msg((<span class="hljs-string">"handshake"</span>, MsgHandshake((
 <span class="hljs-number">112</span>                 (<span class="hljs-string">"peerName"</span>, OUR_NAME),
 <span class="hljs-number">113</span>             )))).encode())
 <span class="hljs-number">114</span>             <span class="hljs-keyword">await</span> writer.drain()
 <span class="hljs-number">115</span>             logging.info(<span class="hljs-string">"%s: session established: %s"</span>, _id, peer_name)
 <span class="hljs-number">116</span>             peer_alive = PEER_ALIVES.pop(peer_name, <span class="hljs-literal">None</span>)
 <span class="hljs-number">117</span>             <span class="hljs-keyword">if</span> peer_alive <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
 <span class="hljs-number">118</span>                 peer_alive.close()
 <span class="hljs-number">119</span>                 <span class="hljs-keyword">await</span> IN_QUEUES[peer_name].put(<span class="hljs-literal">None</span>)
 <span class="hljs-number">120</span>             PEER_ALIVES[peer_name] = writer
 <span class="hljs-number">121</span>             asyncio.ensure_future(msg_sender(peer_name, writer))
 <span class="hljs-number">122</span>             msg_expected = <span class="hljs-string">"text"</span>
 <span class="hljs-number">123</span>         <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">124</span>     logging.info(<span class="hljs-string">"%s: disconnecting"</span>, _id)
 <span class="hljs-number">125</span>     <span class="hljs-keyword">if</span> msg_expected == <span class="hljs-string">"text"</span>:
 <span class="hljs-number">126</span>         IN_QUEUES[peer_name].put(<span class="hljs-literal">None</span>)
 <span class="hljs-number">127</span>     writer.close()
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全なプロトコル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのコミュニケーションを保護する時が来ました。</font><font style="vertical-align: inherit;">セキュリティとは何ですか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">送信されたメッセージの機密性;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">送信されたメッセージの信頼性と整合性-それらの変更を検出する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リプレイ攻撃に対する保護-メッセージの損失またはリプレイの事実を検出する必要があります（そして、接続を切断することを決定します）;</font></font></li>
<li>         —    ,   friend-to-friend .     ,   ;</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">perfect forward secrecy</a>  (PFS) —              .     ;</li>
<li>/  (  )     TCP-.   /     (    )    ;</li>
<li>       ,     ,    .     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驚いたことに、ほとんどすべての人がこのハンドシェイクプロトコルにこの最小値を設定することを望んでおり、上記のほとんどは「自社開発」プロトコルに対して実行されます。</font><font style="vertical-align: inherit;">だから今私たちは新しいものを発明しません。</font><font style="vertical-align: inherit;">私は間違いなく</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noiseフレームワーク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">プロトコルを構築する</font><font style="vertical-align: inherit;">ことをお勧めし</font><font style="vertical-align: inherit;">ますが、もっと簡単なものを選択しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も一般的なのは2つのプロトコルです。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、バグ、学校、脆弱性、不十分な考え、複雑さ、欠点の長い歴史を持つ複雑なプロトコルです（ただし、これはTLS 1.3にはあまり当てはまりません）。</font><font style="vertical-align: inherit;">しかし、複雑さのためにそれを考慮していません。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPsecの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">持つ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -彼らはまた、単純ではないものの、深刻な暗号化の問題を持っていません。</font><font style="vertical-align: inherit;">IKEv1およびIKEv2について読んだ場合、それらのソースは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ISO / IEC IS 9798-3およびSIGMA（SIGn-and-MAc）プロトコルです-夜間に実装するのに十分なほど単純です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STS / ISOプロトコルの開発における最後のリンクであるSIGMAはどのように役立ちますか？</font><font style="vertical-align: inherit;">それは私たちのすべての要件（対話者の識別子を「隠す」を含む）を満たし、既知の暗号の問題はありません。</font><font style="vertical-align: inherit;">それは最小限のものです-プロトコルメッセージから少なくとも1つの要素を削除すると、その不安につながります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純な自家製プロトコルからSIGMAに移りましょう。</font><font style="vertical-align: inherit;">私たちが興味を持っている最も基本的な操作は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーの交渉です</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：両方の参加者が対称鍵として使用できる同じ値を受け取る出力の関数。</font><font style="vertical-align: inherit;">詳細については説明しません。各当事者は、エフェメラル（同じセッション内でのみ使用）の鍵ペア（公開鍵と秘密鍵）を生成し、公開鍵を交換し、調整関数を呼び出し、その入力に対して、秘密鍵と対話者の公開鍵を転送します。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">┌─────┐┌─────┐</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
│PeerA││PeerB│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
└──┬──┘└──┬──┘</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │IdA、PubA│╔════════════════════╗</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │──────────────&gt;&gt;│rPrvA、PubA = DHgen（）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││╚═══════════════════╝</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │IdB、PubB│╔════════════════════╗</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │&lt;───────────────│║PrvB、PubB = DHgen（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││╚═══════════════════╝</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ────┐╔═══════════════════╗</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       │║Key= DH（PrvA、PubB）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   &lt;───┘╚═══════════════════╝</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰でも途中で公開鍵を自分のものに置き換えることができます-このプロトコルでは対話者の認証はありません。</font><font style="vertical-align: inherit;">長期間有効な鍵を含む署名を追加します。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">┌─────┐┌─────┐</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
│PeerA││PeerB│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
└──┬──┘└──┬──┘</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │IdA、PubA、符号（SignPrvA、（PubA））│╔═══════════════════════╗</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │────ign ign ign ign ign ign ign ign ign ign ign SignPrvA、SignPubA = load（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││║PrvA、PubA = DHgen（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││╚══════╝╝╝╝╝╝╝╝╝╝</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │IdB、PubB、符号（SignPrvB、（PubB））│╔═══════════════════════╗</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │&lt;─────────────────────────────────│ignSignPrvB、SignPubB = load（）│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││║PrvB、PubB = DHgen（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││╚══════╝╝╝╝╝╝╝╝╝╝</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ────┐╔═════════════════════││</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       │║verify（SignPubB、...）║│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   &lt;───┘║Key= DH（PrvA、PubB）║│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │╚═════════════════════╝│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような署名は、特定のセッションに関連付けられていないため機能しません。</font><font style="vertical-align: inherit;">このようなメッセージは、他の参加者とのセッションにも適しています。</font><font style="vertical-align: inherit;">コンテキスト全体を購読する必要があります。</font><font style="vertical-align: inherit;">これにより、Aからの別のメッセージの送信を追加することも必要になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、独自の識別子を署名として追加することが重要です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それ以外の場合は、IdXXXを置き換えて、メッセージを別の既知の対話者のキーで再署名できるためです。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">リフレクション攻撃</font></a><font style="vertical-align: inherit;">を防ぐに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、署名の下の要素は、その意味で明確に定義された場所にある必要があります。Aが（PubA、PubB）に署名する場合、Bは（PubB、PubA）に署名する必要があります。</font><font style="vertical-align: inherit;">これは、シリアル化されたデータの構造と形式を選択することの重要性も示しています。</font><font style="vertical-align: inherit;">たとえば、ASN.1 DERエンコーディングのセットはソートされます。SETOF（PubA、PubB）はSET OF（PubB、PubA）と同じになります。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">┌─────┐┌─────┐</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
│PeerA││PeerB│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
└──┬──┘└──┬──┘</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │IdA、PubA│╔══════════════════════════</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   │──────ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign ign SignPubA = load（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││║PrvA、PubA = DHgen（）║</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   ││╚══════╝╝╝╝╝╝╝╝╝╝</font></font><font></font>
   │IdB, PubB, sign(SignPrvB, (IdB, PubA, PubB)) │ ╔═══════════════════════════╗<font></font>
   │&lt;────────────────────────────────────────────│ ║SignPrvB, SignPubB = load()║<font></font>
   │                                             │ ║PrvB, PubB = DHgen()       ║<font></font>
   │                                             │ ╚═══════════════════════════╝<font></font>
   │     sign(SignPrvA, (IdA, PubB, PubA))       │ ╔═════════════════════╗<font></font>
   │────────────────────────────────────────────&gt;│ ║verify(SignPubB, ...)║<font></font>
   │                                             │ ║Key = DH(PrvA, PubB) ║<font></font>
   │                                             │ ╚═════════════════════╝<font></font>
   │                                             │<font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このセッションで同じ共通キーを開発したことはまだ証明されていません。</font><font style="vertical-align: inherit;">原則として、このステップなしで実行できます。最初のトランスポート接続は無効になりますが、ハンドシェイクが完了したときに、すべてが本当に合意されていることを確認します。</font><font style="vertical-align: inherit;">現在、私たちはISO / IEC IS 9798-3プロトコルを手にしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鍵自体に署名できます。</font><font style="vertical-align: inherit;">使用される署名アルゴリズムにリークがある可能性があるため、これは危険です（署名ごとのビット数をリークしますが、それでもリークします）。</font><font style="vertical-align: inherit;">生成されたキーからのハッシュに署名することは可能ですが、生成されたキーからのハッシュリークでさえ、生成関数へのブルートフォース攻撃に役立ちます。</font><font style="vertical-align: inherit;">SIGMAは、送信者IDを認証するMAC機能を使用します。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">┌─────┐┌─────┐</font></font><font></font>
│PeerA│                                            │PeerB│<font></font>
└──┬──┘                                            └──┬──┘<font></font>
   │                    IdA, PubA                     │ ╔═══════════════════════════╗<font></font>
   │─────────────────────────────────────────────────&gt;│ ║SignPrvA, SignPubA = load()║<font></font>
   │                                                  │ ║PrvA, PubA = DHgen()       ║<font></font>
   │                                                  │ ╚═══════════════════════════╝<font></font>
   │IdB, PubB, sign(SignPrvB, (PubA, PubB)), MAC(IdB) │ ╔═══════════════════════════╗<font></font>
   │&lt;─────────────────────────────────────────────────│ ║SignPrvB, SignPubB = load()║<font></font>
   │                                                  │ ║PrvB, PubB = DHgen()       ║<font></font>
   │                                                  │ ╚═══════════════════════════╝<font></font>
   │                                                  │ ╔═════════════════════╗<font></font>
   │     sign(SignPrvA, (PubB, PubA)), MAC(IdA)       │ ║Key = DH(PrvA, PubB) ║<font></font>
   │─────────────────────────────────────────────────&gt;│ ║verify(Key, IdB)     ║<font></font>
   │                                                  │ ║verify(SignPubB, ...)║<font></font>
   │                                                  │ ╚═════════════════════╝<font></font>
   │                                                  │<font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化として、一時キーを再利用したい場合もあります（もちろん、PFSにはそれが嫌です）。</font><font style="vertical-align: inherit;">たとえば、キーペアを生成して接続を試みましたが、TCPが使用できないか、プロトコルの途中で中断しました。</font><font style="vertical-align: inherit;">エントロピーとプロセッサリソースを新しいペアに費やすのは残念です。</font><font style="vertical-align: inherit;">したがって、一時的な公開鍵を再利用するときに起こり得る偶発的なリプレイ攻撃から保護する、疑似ランダム値と呼ばれるCookieを導入します。</font><font style="vertical-align: inherit;">Cookieとエフェメラル公開鍵の間のバインディングにより、反対側の公開鍵は不要なものとして署名から削除できます。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">┌─────┐┌─────┐</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
│PeerA││PeerB│</font></font><font></font>
└──┬──┘                                                                 └──┬──┘<font></font>
   │                          IdA, PubA, CookieA                           │ ╔═══════════════════════════╗<font></font>
   │──────────────────────────────────────────────────────────────────────&gt;│ ║SignPrvA, SignPubA = load()║<font></font>
   │                                                                       │ ║PrvA, PubA = DHgen()       ║<font></font>
   │                                                                       │ ╚═══════════════════════════╝<font></font>
   │IdB, PubB, CookieB, sign(SignPrvB, (CookieA, CookieB, PubB)), MAC(IdB) │ ╔═══════════════════════════╗<font></font>
   │&lt;──────────────────────────────────────────────────────────────────────│ ║SignPrvB, SignPubB = load()║<font></font>
   │                                                                       │ ║PrvB, PubB = DHgen()       ║<font></font>
   │                                                                       │ ╚═══════════════════════════╝<font></font>
   │                                                                       │ ╔═════════════════════╗<font></font>
   │          sign(SignPrvA, (CookieB, CookieA, PubA)), MAC(IdA)           │ ║Key = DH(PrvA, PubB) ║<font></font>
   │──────────────────────────────────────────────────────────────────────&gt;│ ║verify(Key, IdB)     ║<font></font>
   │                                                                       │ ║verify(SignPubB, ...)║<font></font>
   │                                                                       │ ╚═════════════════════╝<font></font>
   │                                                                       │<font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、受動的なオブザーバーから対話者IDのプライバシーを取得します。</font><font style="vertical-align: inherit;">これを行うために、SIGMAは最初に一時鍵を交換し、認証メッセージを認証するための共通鍵を算出することを提案します。</font><font style="vertical-align: inherit;">SIGMAは2つのオプションについて説明しています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SIGMA-I-アクティブな攻撃からイニシエーターを保護し、受動的な攻撃からレスポンダーを保護します。</font><font style="vertical-align: inherit;">あなたが彼と一緒にアクティブなプロトコルを開始した場合、被告は彼の身元を示します。</font><font style="vertical-align: inherit;">受動的オブザーバーは何も知りません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SIGMA-R-アクティブな攻撃からレスポンダーを保護し、パッシブからイニシエーターを保護します。</font><font style="vertical-align: inherit;">すべてが正反対ですが、このプロトコルではすでに4つのハンドシェイクメッセージが送信されています。</font></font><br>
<br>
<br>
 SIGMA-I     ,     -  :     ,      .      -    .      ,         A     :<br>
<br>
<pre>┌─────┐                                                                        ┌─────┐<font></font>
│PeerA│                                                                        │PeerB│<font></font>
└──┬──┘                                                                        └──┬──┘<font></font>
   │                                PubA, CookieA                                 │ ╔═══════════════════════════╗<font></font>
   │─────────────────────────────────────────────────────────────────────────────&gt;│ ║SignPrvA, SignPubA = load()║<font></font>
   │                                                                              │ ║PrvA, PubA = DHgen()       ║<font></font>
   │                                                                              │ ╚═══════════════════════════╝<font></font>
   │PubB, CookieB, Enc((IdB, sign(SignPrvB, (CookieA, CookieB, PubB)), MAC(IdB))) │ ╔═══════════════════════════╗<font></font>
   │&lt;─────────────────────────────────────────────────────────────────────────────│ ║SignPrvB, SignPubB = load()║<font></font>
   │                                                                              │ ║PrvB, PubB = DHgen()       ║<font></font>
   │                                                                              │ ╚═══════════════════════════╝<font></font>
   │                                                                              │ ╔═════════════════════╗<font></font>
   │       Enc((IdA, sign(SignPrvA, (CookieB, CookieA, PubA)), MAC(IdA)))         │ ║Key = DH(PrvA, PubB) ║<font></font>
   │─────────────────────────────────────────────────────────────────────────────&gt;│ ║verify(Key, IdB)     ║<font></font>
   │                                                                              │ ║verify(SignPubB, ...)║<font></font>
   │                                                                              │ ╚═════════════════════╝<font></font>
   │                                                                              │<font></font>
</pre><br>
<br>
<ul>
<li>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">34.10-2012</a>   256- .</li>
<li>     34.10-2012 VKO.</li>
<li>  MAC  CMAC.       ,     34.13-2015.        — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a> (34.12-2015).</li>
<li>         .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">-256</a> (34.11-2012 256 ).</li>
</ul><br>
<br>
       .         .         :   ,  ,  (MAC)   , .         ,    , .     , ,  ?          .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">KDF</a> (key derivation function).  ,     - : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">HKDF</a>  ,       .  ,    Python   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">hkdf</a> . HKDF   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">HMAC</a>, ,   ,  -.    Python   Wikipedia    .      34.10-2012,   -   -256.         ,      :<br>
<br>
<pre><code class="python hljs">kdf = Hkdf(<span class="hljs-literal">None</span>, key_session, hash=GOST34112012256)<font></font>
kdf.expand(<span class="hljs-string">b"handshake1-mac-identity"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"handshake1-enc"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"handshake1-mac"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"handshake2-mac-identity"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"handshake2-enc"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"handshake2-mac"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"transport-initiator-enc"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"transport-initiator-mac"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"transport-responder-enc"</span>)<font></font>
kdf.expand(<span class="hljs-string">b"transport-responder-mac"</span>)
</code></pre><br>
<h2>/</h2><br>
    ASN.1         :<br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Msg</span>(<span class="hljs-params">Choice</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"text"</span>, MsgText()),<font></font>
        (<span class="hljs-string">"handshake0"</span>, MsgHandshake0(expl=tag_ctxc(<span class="hljs-number">0</span>))),<font></font>
        (<span class="hljs-string">"handshake1"</span>, MsgHandshake1(expl=tag_ctxc(<span class="hljs-number">1</span>))),<font></font>
        (<span class="hljs-string">"handshake2"</span>, MsgHandshake2(expl=tag_ctxc(<span class="hljs-number">2</span>))),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgText</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"payload"</span>, MsgTextPayload()),<font></font>
        (<span class="hljs-string">"payloadMac"</span>, MAC()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgTextPayload</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"nonce"</span>, Integer(bounds=(<span class="hljs-number">0</span>, float(<span class="hljs-string">"+inf"</span>)))),<font></font>
        (<span class="hljs-string">"ciphertext"</span>, OctetString(bounds=(<span class="hljs-number">1</span>, MaxTextLen))),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgHandshake0</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"cookieInitiator"</span>, Cookie()),<font></font>
        (<span class="hljs-string">"pubKeyInitiator"</span>, PubKey()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgHandshake1</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"cookieResponder"</span>, Cookie()),<font></font>
        (<span class="hljs-string">"pubKeyResponder"</span>, PubKey()),<font></font>
        (<span class="hljs-string">"ukm"</span>, OctetString(bounds=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))),<font></font>
        (<span class="hljs-string">"ciphertext"</span>, OctetString()),<font></font>
        (<span class="hljs-string">"ciphertextMac"</span>, MAC()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgHandshake2</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"ciphertext"</span>, OctetString()),<font></font>
        (<span class="hljs-string">"ciphertextMac"</span>, MAC()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HandshakeTBE</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"identity"</span>, OctetString(bounds=(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>))),<font></font>
        (<span class="hljs-string">"signature"</span>, OctetString(bounds=(<span class="hljs-number">64</span>, <span class="hljs-number">64</span>))),<font></font>
        (<span class="hljs-string">"identityMac"</span>, MAC()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HandshakeTBS</span>(<span class="hljs-params">Sequence</span>):</span><font></font>
    schema = ((<font></font>
        (<span class="hljs-string">"cookieTheir"</span>, Cookie()),<font></font>
        (<span class="hljs-string">"cookieOur"</span>, Cookie()),<font></font>
        (<span class="hljs-string">"pubKeyOur"</span>, PubKey()),<font></font>
    ))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cookie</span>(<span class="hljs-params">OctetString</span>):</span> bounds = (<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PubKey</span>(<span class="hljs-params">OctetString</span>):</span> bounds = (<span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MAC</span>(<span class="hljs-params">OctetString</span>):</span> bounds = (<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
</code></pre><br>
HandshakeTBS — ,    (to be signed). HandshakeTBE — ,    (to be encrypted).     ukm  MsgHandshake1. 34.10 VKO,      ,   UKM (user keying material) —   .<br>
<br>
<h2>   </h2><br>
       ,      (  ,     ,       ).<br>
<br>
          ,     -  .    JSON  :<br>
<br>
<pre><code class="python hljs">{
    <span class="hljs-string">"our"</span>: {
        <span class="hljs-string">"prv"</span>: <span class="hljs-string">"21254cf66c15e0226ef2669ceee46c87b575f37f9000272f408d0c9283355f98"</span>,
        <span class="hljs-string">"pub"</span>: <span class="hljs-string">"938c87da5c55b27b7f332d91b202dbef2540979d6ceaa4c35f1b5bfca6df47df0bdae0d3d82beac83cec3e353939489d9981b7eb7a3c58b71df2212d556312a1"</span><font></font>
    },<font></font>
    <span class="hljs-string">"their"</span>: {
        <span class="hljs-string">"alice"</span>: <span class="hljs-string">"d361a59c25d2ca5a05d21f31168609deeec100570ac98f540416778c93b2c7402fd92640731a707ec67b5410a0feae5b78aeec93c4a455a17570a84f2bc21fce"</span>,
        <span class="hljs-string">"bob"</span>: <span class="hljs-string">"aade1207dd85ecd283272e7b69c078d5fae75b6e141f7649ad21962042d643512c28a2dbdc12c7ba40eb704af920919511180c18f4d17e07d7f5acd49787224a"</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
our —   ,     . their —      .        JSON :<br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> pygost <span class="hljs-keyword">import</span> gost3410
<span class="hljs-keyword">from</span> pygost.gost34112012256 <span class="hljs-keyword">import</span> GOST34112012256<font></font>
<font></font>
CURVE = gost3410.GOST3410Curve(<font></font>
    *gost3410.CURVE_PARAMS[<span class="hljs-string">"GostR3410_2001_CryptoPro_A_ParamSet"</span>]<font></font>
)<font></font>
<font></font>
parser = argparse.ArgumentParser(description=<span class="hljs-string">"GOSTIM"</span>)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--keys-gen"</span>,<font></font>
    action=<span class="hljs-string">"store_true"</span>,<font></font>
    help=<span class="hljs-string">"Generate JSON with our new keypair"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--keys"</span>,<font></font>
    default=<span class="hljs-string">"keys.json"</span>,<font></font>
    required=<span class="hljs-literal">False</span>,<font></font>
    help=<span class="hljs-string">"JSON with our and their keys"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--bind"</span>,<font></font>
    default=<span class="hljs-string">"::1"</span>,<font></font>
    help=<span class="hljs-string">"Address to listen on"</span>,<font></font>
)<font></font>
parser.add_argument(<font></font>
    <span class="hljs-string">"--port"</span>,<font></font>
    type=int,<font></font>
    default=<span class="hljs-number">6666</span>,<font></font>
    help=<span class="hljs-string">"Port to listen on"</span>,<font></font>
)<font></font>
args = parser.parse_args()<font></font>
<font></font>
<span class="hljs-keyword">if</span> args.keys_gen:<font></font>
    prv_raw = urandom(<span class="hljs-number">32</span>)<font></font>
    pub = gost3410.public_key(CURVE, gost3410.prv_unmarshal(prv_raw))<font></font>
    pub_raw = gost3410.pub_marshal(pub)<font></font>
    print(json.dumps({<font></font>
        <span class="hljs-string">"our"</span>: {<span class="hljs-string">"prv"</span>: hexenc(prv_raw), <span class="hljs-string">"pub"</span>: hexenc(pub_raw)},
        <span class="hljs-string">"their"</span>: {},<font></font>
    }))<font></font>
    exit(<span class="hljs-number">0</span>)<font></font>
<font></font>
<span class="hljs-comment"># Parse and unmarshal our and their keys {{{</span>
<span class="hljs-keyword">with</span> open(args.keys, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> fd:<font></font>
    _keys = json.loads(fd.read().decode(<span class="hljs-string">"utf-8"</span>))<font></font>
KEY_OUR_SIGN_PRV = gost3410.prv_unmarshal(hexdec(_keys[<span class="hljs-string">"our"</span>][<span class="hljs-string">"prv"</span>]))<font></font>
_pub = hexdec(_keys[<span class="hljs-string">"our"</span>][<span class="hljs-string">"pub"</span>])<font></font>
KEY_OUR_SIGN_PUB = gost3410.pub_unmarshal(_pub)<font></font>
KEY_OUR_SIGN_PUB_HASH = OctetString(GOST34112012256(_pub).digest())<font></font>
<span class="hljs-keyword">for</span> peer_name, pub_raw <span class="hljs-keyword">in</span> _keys[<span class="hljs-string">"their"</span>].items():<font></font>
    _pub = hexdec(pub_raw)<font></font>
    KEYS[GOST34112012256(_pub).digest()] = {<font></font>
        <span class="hljs-string">"name"</span>: peer_name,
        <span class="hljs-string">"pub"</span>: gost3410.pub_unmarshal(_pub),<font></font>
    }<font></font>
<span class="hljs-comment"># }}}</span>
</code></pre><br>
  34.10  —  .  256-  256-  . PyGOST     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,     (urandom(32))    ,  gost3410.prv_unmarshal().      ,  gost3410.public_key().   34.10 —   ,            ,  gost3410.pub_marshal().<br>
<br>
  JSON ,  , ,   ,  gost3410.pub_unmarshal().             ,              . -256   gost34112012256.GOST34112012256(),   hashlib  -.<br>
<br>
   ? ,    :  cookie (128-  ),    34.10,     VKO   .<br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">395</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initiator</span>(<span class="hljs-params">host, port</span>):</span>
 <span class="hljs-number">396</span>     _id = repr((host, port))
 <span class="hljs-number">397</span>     logging.info(<span class="hljs-string">"%s: dialing"</span>, _id)
 <span class="hljs-number">398</span>     reader, writer = <span class="hljs-keyword">await</span> asyncio.open_connection(host, port)
 <span class="hljs-number">399</span>     <span class="hljs-comment"># Generate our ephemeral public key and cookie, send Handshake 0 message {{{</span>
 <span class="hljs-number">400</span>     cookie_our = Cookie(urandom(<span class="hljs-number">16</span>))
 <span class="hljs-number">401</span>     prv = gost3410.prv_unmarshal(urandom(<span class="hljs-number">32</span>))
 <span class="hljs-number">402</span>     pub_our = gost3410.public_key(CURVE, prv)
 <span class="hljs-number">403</span>     pub_our_raw = PubKey(gost3410.pub_marshal(pub_our))
 <span class="hljs-number">404</span>     writer.write(Msg((<span class="hljs-string">"handshake0"</span>, MsgHandshake0((
 <span class="hljs-number">405</span>         (<span class="hljs-string">"cookieInitiator"</span>, cookie_our),
 <span class="hljs-number">406</span>         (<span class="hljs-string">"pubKeyInitiator"</span>, pub_our_raw),
 <span class="hljs-number">407</span>     )))).encode())
 <span class="hljs-number">408</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">409</span>     <span class="hljs-keyword">await</span> writer.drain()
</code></pre><br>
<ul>
<li>     Msg ;</li>
<li>   handshake1;</li>
<li>         ;</li>
<li>      TBE  .</li>
</ul><br>
<pre><code class="python hljs"> <span class="hljs-number">423</span>     logging.info(<span class="hljs-string">"%s: got %s message"</span>, _id, msg.choice)
 <span class="hljs-number">424</span>     <span class="hljs-keyword">if</span> msg.choice != <span class="hljs-string">"handshake1"</span>:
 <span class="hljs-number">425</span>         logging.warning(<span class="hljs-string">"%s: unexpected message, disconnecting"</span>, _id)
 <span class="hljs-number">426</span>         writer.close()
 <span class="hljs-number">427</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">428</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">429</span>     msg_handshake1 = msg.value
 <span class="hljs-number">430</span>     <span class="hljs-comment"># Validate Handshake message {{{</span>
 <span class="hljs-number">431</span>     cookie_their = msg_handshake1[<span class="hljs-string">"cookieResponder"</span>]
 <span class="hljs-number">432</span>     pub_their_raw = msg_handshake1[<span class="hljs-string">"pubKeyResponder"</span>]
 <span class="hljs-number">433</span>     pub_their = gost3410.pub_unmarshal(bytes(pub_their_raw))
 <span class="hljs-number">434</span>     ukm_raw = bytes(msg_handshake1[<span class="hljs-string">"ukm"</span>])
 <span class="hljs-number">435</span>     ukm = ukm_unmarshal(ukm_raw)
 <span class="hljs-number">436</span>     key_session = kek_34102012256(CURVE, prv, pub_their, ukm, mode=<span class="hljs-number">2001</span>)
 <span class="hljs-number">437</span>     kdf = Hkdf(<span class="hljs-literal">None</span>, key_session, hash=GOST34112012256)
 <span class="hljs-number">438</span>     key_handshake1_mac_identity = kdf.expand(<span class="hljs-string">b"handshake1-mac-identity"</span>)
 <span class="hljs-number">439</span>     key_handshake1_enc = kdf.expand(<span class="hljs-string">b"handshake1-enc"</span>)
 <span class="hljs-number">440</span>     key_handshake1_mac = kdf.expand(<span class="hljs-string">b"handshake1-mac"</span>)
</code></pre><br>
UKM  64-  (urandom(8)),       ,  gost3410_vko.ukm_unmarshal(). VKO   34.10-2012 256-  gost3410_vko.kek_34102012256() (KEK — key encryption key).<br>
<br>
     256-   .        HKDF .   GOST34112012256  hashlib ,        Hkdf .  (  Hkdf)   ,     -               . kdf.expand()       256-,     .<br>
<br>
  TBE  TBS   :<br>
<br>
<ul>
<li>   MAC   ;</li>
<li> ;</li>
<li> TBE ;</li>
<li>           ;</li>
<li>   MAC   ;</li>
<li>   TBS ,    cookie        .      .</li>
</ul><br>
<pre><code class="python hljs"> <span class="hljs-number">441</span>     <span class="hljs-keyword">try</span>:
 <span class="hljs-number">442</span>         peer_name = validate_tbe(
 <span class="hljs-number">443</span>             msg_handshake1,
 <span class="hljs-number">444</span>             key_handshake1_mac_identity,
 <span class="hljs-number">445</span>             key_handshake1_enc,
 <span class="hljs-number">446</span>             key_handshake1_mac,
 <span class="hljs-number">447</span>             cookie_our,
 <span class="hljs-number">448</span>             cookie_their,
 <span class="hljs-number">449</span>             pub_their_raw,
 <span class="hljs-number">450</span>         )
 <span class="hljs-number">451</span>     <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> err:
 <span class="hljs-number">452</span>         logging.warning(<span class="hljs-string">"%s: %s, disconnecting"</span>, _id, err)
 <span class="hljs-number">453</span>         writer.close()
 <span class="hljs-number">454</span>         <span class="hljs-keyword">return</span>
 <span class="hljs-number">455</span>     <span class="hljs-comment"># }}}</span><font></font>
<font></font>
 <span class="hljs-number">128</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_tbe</span>(<span class="hljs-params">
 <span class="hljs-number">129</span>         msg_handshake: Union[MsgHandshake1, MsgHandshake2],
 <span class="hljs-number">130</span>         key_mac_identity: bytes,
 <span class="hljs-number">131</span>         key_enc: bytes,
 <span class="hljs-number">132</span>         key_mac: bytes,
 <span class="hljs-number">133</span>         cookie_their: Cookie,
 <span class="hljs-number">134</span>         cookie_our: Cookie,
 <span class="hljs-number">135</span>         pub_key_our: PubKey,
 <span class="hljs-number">136</span> </span>) -&gt; str:</span>
 <span class="hljs-number">137</span>     ciphertext = bytes(msg_handshake[<span class="hljs-string">"ciphertext"</span>])
 <span class="hljs-number">138</span>     mac_tag = mac(GOST3412Kuznechik(key_mac).encrypt, KUZNECHIK_BLOCKSIZE, ciphertext)
 <span class="hljs-number">139</span>     <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> compare_digest(mac_tag, bytes(msg_handshake[<span class="hljs-string">"ciphertextMac"</span>])):
 <span class="hljs-number">140</span>         <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"invalid MAC"</span>)
 <span class="hljs-number">141</span>     plaintext = ctr(
 <span class="hljs-number">142</span>         GOST3412Kuznechik(key_enc).encrypt,
 <span class="hljs-number">143</span>         KUZNECHIK_BLOCKSIZE,
 <span class="hljs-number">144</span>         ciphertext,
 <span class="hljs-number">145</span>         <span class="hljs-number">8</span> * <span class="hljs-string">b"\x00"</span>,
 <span class="hljs-number">146</span>     )
 <span class="hljs-number">147</span>     <span class="hljs-keyword">try</span>:
 <span class="hljs-number">148</span>         tbe, _ = HandshakeTBE().decode(plaintext)
 <span class="hljs-number">149</span>     <span class="hljs-keyword">except</span> ASN1Error:
 <span class="hljs-number">150</span>         <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"can not decode TBE"</span>)
 <span class="hljs-number">151</span>     key_sign_pub_hash = bytes(tbe[<span class="hljs-string">"identity"</span>])
 <span class="hljs-number">152</span>     peer = KEYS.get(key_sign_pub_hash)
 <span class="hljs-number">153</span>     <span class="hljs-keyword">if</span> peer <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
 <span class="hljs-number">154</span>         <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"unknown identity"</span>)
 <span class="hljs-number">155</span>     mac_tag = mac(
 <span class="hljs-number">156</span>         GOST3412Kuznechik(key_mac_identity).encrypt,
 <span class="hljs-number">157</span>         KUZNECHIK_BLOCKSIZE,
 <span class="hljs-number">158</span>         key_sign_pub_hash,
 <span class="hljs-number">159</span>     )
 <span class="hljs-number">160</span>     <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> compare_digest(mac_tag, bytes(tbe[<span class="hljs-string">"identityMac"</span>])):
 <span class="hljs-number">161</span>         <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"invalid identity MAC"</span>)
 <span class="hljs-number">162</span>     tbs = HandshakeTBS((
 <span class="hljs-number">163</span>         (<span class="hljs-string">"cookieTheir"</span>, cookie_their),
 <span class="hljs-number">164</span>         (<span class="hljs-string">"cookieOur"</span>, cookie_our),
 <span class="hljs-number">165</span>         (<span class="hljs-string">"pubKeyOur"</span>, pub_key_our),
 <span class="hljs-number">166</span>     ))
 <span class="hljs-number">167</span>     <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> gost3410.verify(
 <span class="hljs-number">168</span>         CURVE,
 <span class="hljs-number">169</span>         peer[<span class="hljs-string">"pub"</span>],
 <span class="hljs-number">170</span>         GOST34112012256(tbs.encode()).digest(),
 <span class="hljs-number">171</span>         bytes(tbe[<span class="hljs-string">"signature"</span>]),
 <span class="hljs-number">172</span>     ):
 <span class="hljs-number">173</span>         <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"invalid signature"</span>)
 <span class="hljs-number">174</span>     <span class="hljs-keyword">return</span> peer[<span class="hljs-string">"name"</span>]
</code></pre><br>
   , 34.13-2015   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>  34.12-2015.      ,  MAC-.  PyGOST  gost3413.mac().       (     ),   , ,  .   hardcode-  ? 34.12-2015    128-  ,    64- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a> —    28147-89,               .<br>
<br>
  gost.3412.GOST3412Kuznechik(key)      .encrypt()/.decrypt() ,     34.13 . MAC   : gost3413.mac(GOST3412Kuznechik(key).encrypt, KUZNECHIK_BLOCKSIZE, ciphertext).      MAC-     (==)  ,        , ,   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">BEAST</a>   TLS.  Python   hmac.compare_digest   .<br>
<br>
        .   ,      ,    .  34.13-2015  : ECB, CTR, OFB, CBC, CFB.        .   ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a> ( CCM, OCB, GCM  ) —       MAC.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a> (CTR):       ,  ,    ,          (   CBC,      ).<br>
<br>
  .mac(), .ctr()     : ciphertext = gost3413.ctr(GOST3412Kuznechik(key).encrypt, KUZNECHIK_BLOCKSIZE, plaintext, iv).    ,     .           (    ),      .   handshake        .<br>
<br>
  gost3410.verify() :        (      GOSTIM ),    ( ,         ,    ), 34.11-2012     .<br>
<br>
,       handshake2  ,           ,  :      ,  .…<br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">456</span>     <span class="hljs-comment"># Prepare and send Handshake 2 message {{{</span>
 <span class="hljs-number">457</span>     tbs = HandshakeTBS((
 <span class="hljs-number">458</span>         (<span class="hljs-string">"cookieTheir"</span>, cookie_their),
 <span class="hljs-number">459</span>         (<span class="hljs-string">"cookieOur"</span>, cookie_our),
 <span class="hljs-number">460</span>         (<span class="hljs-string">"pubKeyOur"</span>, pub_our_raw),
 <span class="hljs-number">461</span>     ))
 <span class="hljs-number">462</span>     signature = gost3410.sign(
 <span class="hljs-number">463</span>         CURVE,
 <span class="hljs-number">464</span>         KEY_OUR_SIGN_PRV,
 <span class="hljs-number">465</span>         GOST34112012256(tbs.encode()).digest(),
 <span class="hljs-number">466</span>     )
 <span class="hljs-number">467</span>     key_handshake2_mac_identity = kdf.expand(<span class="hljs-string">b"handshake2-mac-identity"</span>)
 <span class="hljs-number">468</span>     mac_tag = mac(
 <span class="hljs-number">469</span>         GOST3412Kuznechik(key_handshake2_mac_identity).encrypt,
 <span class="hljs-number">470</span>         KUZNECHIK_BLOCKSIZE,
 <span class="hljs-number">471</span>         bytes(KEY_OUR_SIGN_PUB_HASH),
 <span class="hljs-number">472</span>     )
 <span class="hljs-number">473</span>     tbe = HandshakeTBE((
 <span class="hljs-number">474</span>         (<span class="hljs-string">"identity"</span>, KEY_OUR_SIGN_PUB_HASH),
 <span class="hljs-number">475</span>         (<span class="hljs-string">"signature"</span>, OctetString(signature)),
 <span class="hljs-number">476</span>         (<span class="hljs-string">"identityMac"</span>, MAC(mac_tag)),
 <span class="hljs-number">477</span>     ))
 <span class="hljs-number">478</span>     tbe_raw = tbe.encode()
 <span class="hljs-number">479</span>     key_handshake2_enc = kdf.expand(<span class="hljs-string">b"handshake2-enc"</span>)
 <span class="hljs-number">480</span>     key_handshake2_mac = kdf.expand(<span class="hljs-string">b"handshake2-mac"</span>)
 <span class="hljs-number">481</span>     ciphertext = ctr(
 <span class="hljs-number">482</span>         GOST3412Kuznechik(key_handshake2_enc).encrypt,
 <span class="hljs-number">483</span>         KUZNECHIK_BLOCKSIZE,
 <span class="hljs-number">484</span>         tbe_raw,
 <span class="hljs-number">485</span>         <span class="hljs-number">8</span> * <span class="hljs-string">b"\x00"</span>,
 <span class="hljs-number">486</span>     )
 <span class="hljs-number">487</span>     mac_tag = mac(
 <span class="hljs-number">488</span>         GOST3412Kuznechik(key_handshake2_mac).encrypt,
 <span class="hljs-number">489</span>         KUZNECHIK_BLOCKSIZE,
 <span class="hljs-number">490</span>         ciphertext,
 <span class="hljs-number">491</span>     )
 <span class="hljs-number">492</span>     writer.write(Msg((<span class="hljs-string">"handshake2"</span>, MsgHandshake2((
 <span class="hljs-number">493</span>         (<span class="hljs-string">"ciphertext"</span>, OctetString(ciphertext)),
 <span class="hljs-number">494</span>         (<span class="hljs-string">"ciphertextMac"</span>, MAC(mac_tag)),
 <span class="hljs-number">495</span>     )))).encode())
 <span class="hljs-number">496</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">497</span>     <span class="hljs-keyword">await</span> writer.drain()
 <span class="hljs-number">498</span>     logging.info(<span class="hljs-string">"%s: session established: %s"</span>, _id, peer_name)
 </code></pre><br>
  ,     (   ,  ,    ),       MAC-:<br>
<br>
<pre><code class="python hljs"> <span class="hljs-number">499</span>     <span class="hljs-comment"># Run text message sender, initialize transport decoder {{{</span>
 <span class="hljs-number">500</span>     key_initiator_enc = kdf.expand(<span class="hljs-string">b"transport-initiator-enc"</span>)
 <span class="hljs-number">501</span>     key_initiator_mac = kdf.expand(<span class="hljs-string">b"transport-initiator-mac"</span>)
 <span class="hljs-number">502</span>     key_responder_enc = kdf.expand(<span class="hljs-string">b"transport-responder-enc"</span>)
 <span class="hljs-number">503</span>     key_responder_mac = kdf.expand(<span class="hljs-string">b"transport-responder-mac"</span>)<font></font>
 ...<font></font>
 <span class="hljs-number">509</span>     asyncio.ensure_future(msg_sender(
 <span class="hljs-number">510</span>         peer_name,
 <span class="hljs-number">511</span>         key_initiator_enc,
 <span class="hljs-number">512</span>         key_initiator_mac,
 <span class="hljs-number">513</span>         writer,
 <span class="hljs-number">514</span>     ))
 <span class="hljs-number">515</span>     encrypter = GOST3412Kuznechik(key_responder_enc).encrypt
 <span class="hljs-number">516</span>     macer = GOST3412Kuznechik(key_responder_mac).encrypt
 <span class="hljs-number">517</span>     <span class="hljs-comment"># }}}</span>
 <span class="hljs-number">519</span>     nonce_expected = <span class="hljs-number">0</span><font></font>
<font></font>
 <span class="hljs-number">520</span>     <span class="hljs-comment"># Wait for test messages {{{</span>
 <span class="hljs-number">521</span>     <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
 <span class="hljs-number">522</span>         data = <span class="hljs-keyword">await</span> reader.read(MaxMsgLen)<font></font>
 ...<font></font>
 <span class="hljs-number">530</span>             msg, tail = Msg().decode(buf)<font></font>
 ...<font></font>
 <span class="hljs-number">537</span>         <span class="hljs-keyword">try</span>:
 <span class="hljs-number">538</span>             <span class="hljs-keyword">await</span> msg_receiver(
 <span class="hljs-number">539</span>                 msg.value,
 <span class="hljs-number">540</span>                 nonce_expected,
 <span class="hljs-number">541</span>                 macer,
 <span class="hljs-number">542</span>                 encrypter,
 <span class="hljs-number">543</span>                 peer_name,
 <span class="hljs-number">544</span>             )
 <span class="hljs-number">545</span>         <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> err:
 <span class="hljs-number">546</span>             logging.warning(<span class="hljs-string">"%s: %s"</span>, err)
 <span class="hljs-number">547</span>             <span class="hljs-keyword">break</span>
 <span class="hljs-number">548</span>         nonce_expected += <span class="hljs-number">1</span>
 <span class="hljs-number">549</span>     <span class="hljs-comment"># }}}</span>
</code></pre><br>
msg_sender    ,    TCP-.      nonce,          .           .<br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">msg_sender</span>(<span class="hljs-params">peer_name: str, key_enc: bytes, key_mac: bytes, writer</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    nonce = <span class="hljs-number">0</span><font></font>
    encrypter = GOST3412Kuznechik(key_enc).encrypt<font></font>
    macer = GOST3412Kuznechik(key_mac).encrypt<font></font>
    in_queue = IN_QUEUES[peer_name]<font></font>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        text = <span class="hljs-keyword">await</span> in_queue.get()
        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">break</span><font></font>
        ciphertext = ctr(<font></font>
            encrypter,<font></font>
            KUZNECHIK_BLOCKSIZE,<font></font>
            text.encode(<span class="hljs-string">"utf-8"</span>),<font></font>
            long2bytes(nonce, <span class="hljs-number">8</span>),<font></font>
        )<font></font>
        payload = MsgTextPayload((<font></font>
            (<span class="hljs-string">"nonce"</span>, Integer(nonce)),<font></font>
            (<span class="hljs-string">"ciphertext"</span>, OctetString(ciphertext)),<font></font>
        ))<font></font>
        mac_tag = mac(macer, KUZNECHIK_BLOCKSIZE, payload.encode())<font></font>
        writer.write(Msg((<span class="hljs-string">"text"</span>, MsgText((<font></font>
            (<span class="hljs-string">"payload"</span>, payload),<font></font>
            (<span class="hljs-string">"payloadMac"</span>, MAC(mac_tag)),<font></font>
        )))).encode())<font></font>
        nonce += <span class="hljs-number">1</span>
</code></pre><br>
    msg_receiver,    :<br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">msg_receiver</span>(<span class="hljs-params">
        msg_text: MsgText,
        nonce_expected: int,
        macer,
        encrypter,
        peer_name: str,
</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    payload = msg_text[<span class="hljs-string">"payload"</span>]
    <span class="hljs-keyword">if</span> int(payload[<span class="hljs-string">"nonce"</span>]) != nonce_expected:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"unexpected nonce value"</span>)<font></font>
    mac_tag = mac(macer, KUZNECHIK_BLOCKSIZE, payload.encode())<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> compare_digest(mac_tag, bytes(msg_text[<span class="hljs-string">"payloadMac"</span>])):
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"invalid MAC"</span>)<font></font>
    plaintext = ctr(<font></font>
        encrypter,<font></font>
        KUZNECHIK_BLOCKSIZE,<font></font>
        bytes(payload[<span class="hljs-string">"ciphertext"</span>]),<font></font>
        long2bytes(nonce_expected, <span class="hljs-number">8</span>),<font></font>
    )<font></font>
    text = plaintext.decode(<span class="hljs-string">"utf-8"</span>)
    <span class="hljs-keyword">await</span> OUT_QUEUES[peer_name].put(text)
</code></pre><br>
<h2></h2><br>
GOSTIM       (    ,  )!      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a> (-256 : 995bbd368c04e50a481d138c5fa2e43ec7c89bc77743ba8dbabee1fde45de120).     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GoGOST</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">PyDERASN</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">NNCP</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GoVPN</a>, GOSTIM   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GPLv3+</a>.<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>, Python/Go-,    « „“.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452186/index.html">最も希少で最も高価なプログラミング言語</a></li>
<li><a href="../ja452188/index.html">Spring BootでのJsonシリアル化ユニットテスト</a></li>
<li><a href="../ja452190/index.html">WebAssembly 20x Webアプリケーションアクセラレーションの使用</a></li>
<li><a href="../ja452192/index.html">これは何ですか？JavaScriptオブジェクトの内部操作</a></li>
<li><a href="../ja452198/index.html">すべてのQAエンジニアがSelenium 4について知っておくべきことは何ですか？</a></li>
<li><a href="../ja452202/index.html">スプリントレビュー：ボトム-ボトム</a></li>
<li><a href="../ja452204/index.html">最初のAIを書いたとき</a></li>
<li><a href="../ja452206/index.html">E-実験。または、科学がインターフェースの設計にどのように役立つか</a></li>
<li><a href="../ja452210/index.html">MySQLを使用したPythonでのVK用ボット、1時間、パート2</a></li>
<li><a href="../ja452212/index.html">スタートアップでアメリカに移動する方法：3つの実際のビザオプション、その機能と統計</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>