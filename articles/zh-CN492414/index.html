<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💪🏼 👎🏿 ⛏️ NSI系统解剖 🏨 📉 👥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文基于真实事件，
 并且其中的所有问题都不是虚构的。 （C）
 
 首先，我想指出的是，本文并不是要展示自行车的发明，因为数据库开发文化中长期以来存在着许多技术。但是，总而言之，分析它们可以解决的问题并说明如何使用它们。尽管参考信息（NSI）不适用于业务逻辑，而是适用于业务逻辑，但仍然存在很多问题...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>NSI系统解剖</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492414/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文基于真实事件，</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 并且其中的所有问题都不是虚构的。 （C）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
首先，我想指出的是，本文并不是要展示自行车的发明，因为数据库开发文化中长期以来存在着许多技术。但是，总而言之，分析它们可以解决的问题并说明如何使用它们。尽管参考信息（NSI）不适用于业务逻辑，而是适用于业务逻辑，但仍然存在很多问题。随着拐杖或费时的改动，绘制另一张盘子来存储目录的标准过程很快就开始增长。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在我的情况下，原来的情况是这样的：该系统已经投入生产了十多年，它是基于相同的原理构建的，如果有必要，我们可以绘制并打开它。因此，创建了几个表来存储各种设备。但是到了第X个小时，这时有必要为新设备添加更多表，同时每个人（包括旧表）都应归入某个组。这意味着在组和所有五种类型的设备之间的交叉表中应包含指向不同表的链接，即，对于其自己的每个字段，在相应表上均具有常量。如果再添加一个，请更改结构。根据填充的字段需要进行处理。因此出现了</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何汇总不同的表格，以便您可以平等地使用它们，并且如果添加另一个表格则不改变结构</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。一个好主意，我们创建了一个单独的标签，该标签旨在存储设备的抽象概念并带有类型指示，然后其余标签通过外键引用其父对象。在这一欢乐的浪潮中，我们将记录从其中一个填充到创建的板中，并尝试为另一个创建。但是出了点问题，主键限制起作用了，为什么呢？事实是，在系统动荡的青年时期来临之际，每个板块都有其自己的序列。当然，随着时间的流逝，这种耻辱得到了纠正，但是旧的键仍然存在。而且，它们与其他表一起起源于外键。我们解决了</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与所有目录的端到端编号相关联</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设备桌的折磨并没有就此结束。因为根据最新要求，设备具有各种特性，而且其数量是可变的，并且一个特性可以具有多个值。因此出现了</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第三个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即能够存储可变数量的记录特征</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
似乎他们可以管理，但是客户时刻保持警惕，他总是准备着一​​些新的东西。然后需求就来了-所有目录都是历史目录（例如，产品名称是一个，然后将其重命名，并根据不同日期的文档，您需要显示当前名称）。要求本身很正常，您什么也不能说。而且，如果开发部门中还有其他人正在经历试用期，那么一切都覆盖在巧克力中，您可能不会注意到这是一个问题。但是，一切都照常进行-进行彻底的细分，然后您仍然需要这样做。我们创建复制对应目录表的板，以便将更改的时间顺序存储在该目录中。但是通过创建这些表，我们也</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自己创建了</font><b><font style="vertical-align: inherit;">第四个问题</font></b><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在在代码中，根据日期，一个人必须引用主表或历史表</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好吧，我们是好伙伴，我们也赢得了胜利。讨论提出了有关如何存储同一记录的版本的问题。我想保留一下该版本不适合历史性表的内容。从历史上看，可以理解的是，直到这样一个日期为止，只有一个名字，而从这个日期开始，另一个名字就变得有意义。在版本控制中，可以理解该记录是首先保存的，但有一个错误，并且在几个小时后就可以理解并更改了该记录，您需要知道该记录的所有状态。首先，应该压碎一段时间，而不仅仅是一天。其次，在摊牌时需要这样的痕迹。例如，他们填写了价格表，犯了一个错误，设法以这样的价格出售商品，然后进行了更正，但最终还是出现了失衡。但是，针对此类情况的决定使我个人感到困扰，因此建议将所有此类更改存储在表本身中。我不会在适当的范围内安排好戏，但对我来说这已经很清楚了</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第五个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即记录更改的存储</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，总结以上内容，我们看到面前有五个重磅耙子。</font><font style="vertical-align: inherit;">现在，我们的任务是确定一种策略，使您能够绕开而不是踩踏它们。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以踩到多少钱，让我们放弃并购买新的</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从头开始设计系统，没有人能够预测其发展路径，因此无法说出将其概括到什么水平，就像在设备示例中所描述的那样。</font><font style="vertical-align: inherit;">因此，立即设置一个分发给所有NSI表的抽象实体是有意义的。</font><font style="vertical-align: inherit;">因此，所有目录将在一个目录中具有原型，并将其划分为多个类型。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_type (<font></font>
    nsi_type_id     <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>           <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    table_name      <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_type_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>       <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    create_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    modif_date  <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    begin_date  <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_nsi_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_type (nsi_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_uk <span class="hljs-keyword">UNIQUE</span>(nsi_type_id, nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SEQUENCE</span> nsi_seq
  <span class="hljs-keyword">MINVALUE</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">INCREMENT</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">CACHE</span> <span class="hljs-number">20</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随着添加新目录，将填充nsi_type系统表。</font><font style="vertical-align: inherit;">nsi表存储密钥和系统字段。</font><font style="vertical-align: inherit;">同时，我们创建自己的序列，从而</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决第二个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还将创建一个包，其中包含用于处理目录的基本功能，并将逐步填充它。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">NONEDITIONABLE</span> <span class="hljs-keyword">PACKAGE</span> <span class="hljs-keyword">BODY</span> pkg_nsi
<span class="hljs-keyword">IS</span><font></font>
<font></font>
    <span class="hljs-comment">/*      
    *  @param p_table_name VARCHAR2 -  
    *  @return nsi.nsi_type_id%TYPE -    nsi_type
    */</span>
    <span class="hljs-keyword">FUNCTION</span> get_type_id(p_table_name <span class="hljs-keyword">IN</span> <span class="hljs-built_in">VARCHAR2</span>) 
    <span class="hljs-keyword">RETURN</span> nsi_type.nsi_type_id%<span class="hljs-keyword">TYPE</span>
    <span class="hljs-keyword">AS</span>
       v_type_id 	nsi_type.nsi_type_id%<span class="hljs-keyword">TYPE</span>; 
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_type_id <span class="hljs-keyword">INTO</span> v_type_id 
        <span class="hljs-keyword">FROM</span> nsi_type
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">TRIM</span>(<span class="hljs-keyword">LOWER</span>(table_name)) = <span class="hljs-keyword">TRIM</span>(<span class="hljs-keyword">LOWER</span>(p_table_name));<font></font>
<font></font>
        RETURN v_type_id;<font></font>
    <span class="hljs-keyword">END</span> get_type_id;<font></font>
<font></font>
    <span class="hljs-comment">/*   id  nsi_seq
    *  @return nsi.nsi_id%TYPE - id  nsi_seq
    */</span><font></font>
    FUNCTION get_nsi_id <font></font>
    RETURN nsi.nsi_id%TYPE<font></font>
    AS<font></font>
       v_id 	nsi.nsi_id%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>    
        <span class="hljs-keyword">SELECT</span> nsi_seq.NEXTVAL <span class="hljs-keyword">INTO</span> v_id <span class="hljs-keyword">FROM</span> DUAL;<font></font>
        RETURN v_id;<font></font>
    <span class="hljs-keyword">END</span> get_nsi_id;<font></font>
<font></font>
    <span class="hljs-comment">/*      
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -    nsi_type 
    *  @return nsi_type.table_name%TYPE -  
    */</span><font></font>
    FUNCTION get_table_name(p_nsi_type_id IN nsi_type.nsi_type_id%TYPE) <font></font>
    RETURN nsi_type.table_name%TYPE<font></font>
    AS<font></font>
       v_table_name nsi_type.table_name%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> table_name <span class="hljs-keyword">INTO</span> v_table_name 
        <span class="hljs-keyword">FROM</span> nsi_type
        <span class="hljs-keyword">WHERE</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        RETURN v_table_name;<font></font>
    <span class="hljs-keyword">END</span> get_table_name;<font></font>
<font></font>
    <span class="hljs-comment">/*        nsi
    *  @param p_nsi_id nsi.nsi_id%TYPE -   
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -   
    *  @return nsi.descr%TYPE - 
    */</span><font></font>
    FUNCTION get_nsi_descr (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi.nsi_type_id%TYPE) <font></font>
    RETURN nsi.descr%TYPE<font></font>
    AS<font></font>
       v_nsi_descr  nsi.descr%TYPE; <font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">descr</span> 
          <span class="hljs-keyword">INTO</span> v_nsi_descr 
          <span class="hljs-keyword">FROM</span> nsi
         <span class="hljs-keyword">WHERE</span> nsi_id = p_nsi_id
           <span class="hljs-keyword">AND</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        RETURN v_nsi_descr;<font></font>
    <span class="hljs-keyword">END</span> get_nsi_descr;<font></font>
...<font></font>
<span class="hljs-keyword">END</span> pkg_nsi;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到目前为止，已经提供了辅助功能以提供必要的基础结构。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，任务是创建组织目录，如果没有该目录，任何公司都将联系第三方组织-这些组织是供应商，客户和合作伙伴。</font><font style="vertical-align: inherit;">立即将相应的类型添加到nsi_type表并定义nsi_organization表。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_organization (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    full_name   <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    inn         <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">12</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_organization_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_organization_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_type (nsi_type_id, <span class="hljs-keyword">name</span>, <span class="hljs-keyword">descr</span>, table_name) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>, <span class="hljs-string">''</span>, <span class="hljs-string">' , , , '</span>, <span class="hljs-string">'nsi_organization'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，在为时已晚之前，您需要记住有关数字“五”的耙子。</font><font style="vertical-align: inherit;">如果我们开始将记录添加到已创建的组织表中，那么此事件需要在某个地方修复。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_log (<font></font>
    nsi_log_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id            <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    table_name        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    oper_num          <span class="hljs-built_in">NUMBER</span>,
    <span class="hljs-keyword">descr</span>             <span class="hljs-keyword">CLOB</span>,<font></font>
    create_date       <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_log_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_log_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_log_oper_num_ch <span class="hljs-keyword">CHECK</span> (oper_num <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>))<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_log <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.nsi_log_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.table_name <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.oper_num <span class="hljs-keyword">IS</span> <span class="hljs-string">'  (1 -  , 2 -  , 3 -  , 4 -  , 5 -  , 6 -  , 7 -   ).'</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.descr <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_log.create_date <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
日志记录功能也已添加到软件包中。</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--  CHECK nsi_log_oper_num_ch</span><font></font>
    NSI_LOG_OPERNUM_INSERT          NUMBER := 1;<font></font>
    NSI_LOG_OPERNUM_UPDATE          NUMBER := 2;<font></font>
    NSI_LOG_OPERNUM_DELETE          NUMBER := 3;<font></font>
    NSI_LOG_OPERNUM_ATTR_INSERT     NUMBER := 4;<font></font>
    NSI_LOG_OPERNUM_ATTR_UPDATE     NUMBER := 5;<font></font>
    NSI_LOG_OPERNUM_ATTR_DELETE     NUMBER := 6;<font></font>
    NSI_LOG_OPERNUM_HISTORY_PUSH    NUMBER := 7;<font></font>
<font></font>
    <span class="hljs-comment">/*    .
    *  @param p_nsi_id nsi.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -  
    *  @param p_oper_num NUMBER -  
    *  @param p_descr VARCHAR2 - 
    */</span><font></font>
    PROCEDURE log_oper (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi_type.nsi_type_id%TYPE,<font></font>
        p_oper_num      IN NUMBER,<font></font>
        p_descr         IN VARCHAR2)<font></font>
    AS<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_log <font></font>
        (nsi_log_id, nsi_id, table_name, oper_num, <span class="hljs-keyword">descr</span>, create_date)
        <span class="hljs-keyword">VALUES</span> 
        (get_nsi_id(), p_nsi_id, get_table_name(p_nsi_type_id), p_oper_num, p_descr, <span class="hljs-keyword">Sysdate</span>);
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第五个问题就解决了</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，现在对于任何NSI记录，您都可以看到发生了什么。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们正在尝试在那里添加一个组织。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (nsi_id, <span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">' "  "'</span>, <span class="hljs-string">'  "  "'</span>, <span class="hljs-string">'11223344'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，我们遇到了nsi_organization_nsi_fk常量。</font><font style="vertical-align: inherit;">因此，所有查找表都应配备必要的触发器改进。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :NEW.name || ''', full_name = ''' || :NEW.full_name || ''', inn = ''' || :NEW.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_update 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">UPDATE</span> nsi
       <span class="hljs-keyword">SET</span> modif_date = Trunc(<span class="hljs-keyword">Sysdate</span>)
     <span class="hljs-keyword">WHERE</span> nsi_id = :NEW.nsi_id
       <span class="hljs-keyword">AND</span> nsi_type_id = v_type_id;<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :NEW.name || ''', full_name = ''' || :NEW.full_name || ''', inn = ''' || :NEW.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_organization_trg_delete 
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> nsi_organization <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_organization'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi
    <span class="hljs-keyword">WHERE</span> nsi_id = :OLD.nsi_id
      <span class="hljs-keyword">AND</span> nsi_type_id = v_type_id;<font></font>
    <font></font>
    v_log_descr := 'name = ''' || :OLD.name || ''', full_name = ''' || :OLD.full_name || ''', inn = ''' || :OLD.inn || ''' ';<font></font>
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
<span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，添加记录将毫无问题地工作（无需指定键）。</font><font style="vertical-align: inherit;">同时，第一条记录将出现在nsi表中，并且此事件也将记录在日志记录表中。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' "  "'</span>, <span class="hljs-string">'  "  "'</span>, <span class="hljs-string">'11223344'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但就目前而言，您仅会注意到创建某种目录表的额外费用，而没有注意到单一方法的优势。</font><font style="vertical-align: inherit;">然后我们回想第四个问题-我们需要将数据的历史性存储在目录的表中，以及检索给定日期的当前状态。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_history (<font></font>
    nsi_history_id  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id          <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id     <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">version</span>         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">content</span>         <span class="hljs-keyword">CLOB</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    note            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    begin_date      <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date        <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,     
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_history_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_nsi_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_type (nsi_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_history_content_json_chk <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">content</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">JSON</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_history <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_history_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.nsi_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.version <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.content <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.note <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_history.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在软件包pkg_nsi中，我们添加了将记录保存到历史表的功能。</font><font style="vertical-align: inherit;">我们将以json格式存储记录，因此该包还将有机会为传输的请求获取json。</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*     json
    *  @param p_query VARCHAR2 - 
    *  @return CLOB -  json
    */</span><font></font>
    FUNCTION get_json(p_query IN VARCHAR2) <font></font>
    RETURN CLOB<font></font>
    AS<font></font>
      v_theCursor       integer default dbms_sql.open_cursor;<font></font>
      v_columnValue     varchar2(4000);<font></font>
      v_status          integer;<font></font>
      v_descTbl         dbms_sql.desc_tab;<font></font>
      v_colCnt          number;<font></font>
      v_res             clob;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        dbms_sql.parse(v_theCursor, p_query, dbms_sql.native);<font></font>
        dbms_sql.describe_columns( v_theCursor, v_colCnt, v_descTbl);<font></font>
<font></font>
        FOR i IN 1 .. v_colCnt LOOP<font></font>
            dbms_sql.define_column(v_theCursor, i, v_columnValue, 4000);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
      <font></font>
        v_status := dbms_sql.execute(v_theCursor);<font></font>
        WHILE ( dbms_sql.fetch_rows(v_theCursor) &gt; 0 ) LOOP<font></font>
            FOR i IN 1 .. v_colCnt LOOP<font></font>
                dbms_sql.column_value( v_theCursor, i, v_columnValue );<font></font>
                IF i &gt; 1 THEN<font></font>
                    v_res := v_res || ', ';<font></font>
                <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
                v_res := v_res || '"' || v_descTbl(i).col_name || '" : "' || <span class="hljs-keyword">replace</span>(v_columnValue, <span class="hljs-string">'"'</span>, <span class="hljs-string">'\"'</span>) || <span class="hljs-string">'"'</span>;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
            <font></font>
            <span class="hljs-comment">--   ,     ,   </span>
            <span class="hljs-comment">--     </span><font></font>
            EXIT;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        RETURN '{' || v_res || '}';<font></font>
      <font></font>
    exception<font></font>
        when others then dbms_sql.close_cursor( v_theCursor ); RAISE;<font></font>
    <span class="hljs-keyword">END</span> get_json;<font></font>
<font></font>
    <span class="hljs-comment">/*       .
    *  @param p_nsi_id nsi.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_type.nsi_type_id%TYPE -  
    *  @param p_end_date nsi_history.end_date%TYPE -     
    *  @param p_note nsi_history.note%TYPE -     
    */</span><font></font>
    PROCEDURE nsi_history_push (<font></font>
        p_nsi_id        IN nsi.nsi_id%TYPE,<font></font>
        p_nsi_type_id   IN nsi_type.nsi_type_id%TYPE,<font></font>
        p_end_date      IN nsi_history.end_date%TYPE,<font></font>
        p_note          IN nsi_history.note%TYPE)<font></font>
    AS<font></font>
        v_table_name VARCHAR2(50);<font></font>
        v_content CLOB;<font></font>
        v_max_ver NUMBER;<font></font>
        v_begin_date DATE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">IF</span> (p_end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">THEN</span><font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                <span class="hljs-string">'[nsi_history_push]     .'</span>); 
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        IF (Trunc(p_end_date) &gt; Trunc(Sysdate) ) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_history_push]       .'); <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> begin_date <span class="hljs-keyword">INTO</span> v_begin_date
          <span class="hljs-keyword">FROM</span> nsi
         <span class="hljs-keyword">WHERE</span> nsi_id = p_nsi_id
           <span class="hljs-keyword">AND</span> nsi_type_id = p_nsi_type_id;<font></font>
<font></font>
        IF (Trunc(p_end_date) &lt; Trunc(v_begin_date) ) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_history_push]            .'); <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        v_table_name := get_table_name(p_nsi_type_id);<font></font>
        v_content := get_json ('<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">' || v_table_name || '</span> <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-string">' || p_nsi_id);
        
        SELECT MAX(version) INTO v_max_ver
          FROM nsi_history
         WHERE nsi_id = p_nsi_id
           AND nsi_type_id = p_nsi_type_id;
          
        IF (v_max_ver IS NULL) THEN
            v_max_ver := 0;
        END IF;

        v_max_ver := v_max_ver + 1;
        
        UPDATE nsi
           SET begin_date = Trunc(p_end_date) + 1
         WHERE nsi_id = p_nsi_id
           AND nsi_type_id = p_nsi_type_id;
           
        INSERT INTO nsi_history
        (nsi_history_id, nsi_id, nsi_type_id, version, content, note, begin_date, end_date)
        VALUES (get_nsi_id, p_nsi_id, p_nsi_type_id, v_max_ver, v_content, p_note, v_begin_date, Trunc(p_end_date));
        
        log_oper(p_nsi_id, p_nsi_type_id, NSI_LOG_OPERNUM_HISTORY_PUSH, v_content);
    END nsi_history_push; 
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，任何目录都可以使用此功能来捕获历史记录中的当前状态。</font><font style="vertical-align: inherit;">很好，至少可以从这种概括中得到一些有用的东西）））要提取目录的当前状态，请将相应的管道函数添加到包中。</font><font style="vertical-align: inherit;">目录条目将以系统字段扩展的类型返回。</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--     nsi_organization     nsi</span><font></font>
    TYPE nsi_organization_rec IS RECORD(<font></font>
        nsi_id          nsi_organization.nsi_id%TYPE, <font></font>
        name            nsi_organization.name%TYPE,<font></font>
        full_name       nsi_organization.full_name%TYPE,<font></font>
        inn             nsi_organization.inn%TYPE,<font></font>
        nsi_type_id     nsi.nsi_type_id%TYPE, <font></font>
        create_date     nsi.create_date%TYPE,<font></font>
        modif_date      nsi.create_date%TYPE,<font></font>
        version         nsi_history.version%TYPE,<font></font>
        begin_date      nsi.begin_date%TYPE,<font></font>
        end_date        nsi_history.end_date%TYPE<font></font>
    );<font></font>
    TYPE nsi_organization_list IS TABLE OF nsi_organization_rec;<font></font>
<font></font>
    <span class="hljs-comment">/*  ,    .
    *     ,    .
    *  @param p_date DATE - ,      
    *  @return nsi_organization_table -    nsi_organization_rec
    */</span><font></font>
    FUNCTION nsi_organization_table(p_date IN DATE := null) <font></font>
    RETURN nsi_organization_list PIPELINED<font></font>
    AS<font></font>
        v_date date;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_date := Trunc(<span class="hljs-keyword">Sysdate</span>);<font></font>
        IF p_date IS NOT NULL THEN<font></font>
            v_date := Trunc(p_date);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> <font></font>
                o.nsi_id, o.name, o.full_name, o.inn,<font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">version</span>, n.begin_date, <span class="hljs-keyword">to_date</span>(<span class="hljs-literal">null</span>) <span class="hljs-keyword">AS</span> end_date
            <span class="hljs-keyword">FROM</span> 
                nsi_organization o <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (o.nsi_id = n.nsi_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                n.begin_date &lt;= v_date<font></font>
            <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
            <span class="hljs-keyword">SELECT</span> <font></font>
                n.nsi_id, <font></font>
                json_value(h.content, <span class="hljs-string">'$.NAME'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <font></font>
                json_value(h.content, <span class="hljs-string">'$.FULL_NAME'</span>) <span class="hljs-keyword">AS</span> full_name,<font></font>
                json_value(h.content, <span class="hljs-string">'$.INN'</span>) <span class="hljs-keyword">AS</span> inn, <font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                h.version, h.begin_date, h.end_date<font></font>
            <span class="hljs-keyword">FROM</span> 
                nsi_history h <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (h.nsi_id = n.nsi_id <span class="hljs-keyword">AND</span> h.nsi_type_id = n.nsi_type_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                    h.begin_date &lt;= v_date<font></font>
                <span class="hljs-keyword">AND</span> h.end_date &gt;= v_date<font></font>
        ) <span class="hljs-keyword">LOOP</span>
            <span class="hljs-keyword">PIPE</span> <span class="hljs-keyword">ROW</span> (rec);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    <span class="hljs-keyword">END</span> nsi_organization_table;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
适用于我们的nsi_organization表。 </font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NSI_TYPE_ID"	"DESCR"	"CREATE_DATE"	"MODIF_DATE"	"BEGIN_DATE"<font></font>
1	1	" ""  """	11.03.20	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">begin</span>
<span class="hljs-comment">--       ,      </span>
    pkg_nsi.nsi_history_push(<span class="hljs-number">202</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">sysdate</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">end</span>;
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi_history;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_HISTORY_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VERSION"	"CONTENT"	"NOTE"	"BEGIN_DATE"	"END_DATE"<font></font>
205	1	1	1	"{""NSI_ID"" : ""1"", ""NAME"" : "" \""  \"""", ""FULL_NAME"" : ""  \""  \"""", ""INN"" : ""11223344""}"	" "	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-comment">--       ,         </span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> nsi <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NSI_TYPE_ID"	"DESCR"	"CREATE_DATE"	"MODIF_DATE"	"BEGIN_DATE"<font></font>
1	1	" ""  """	11.03.20	11.03.20	12.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--        </span>
<span class="hljs-comment">--     inn, version, begin_date, end_date</span>
<span class="hljs-comment">--       0</span>
<span class="hljs-keyword">update</span> nsi_organization <span class="hljs-keyword">set</span> inn=<span class="hljs-string">'99887766'</span> <span class="hljs-keyword">where</span> nsi_id=<span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span>(pkg_nsi.nsi_organization_table(<span class="hljs-keyword">sysdate</span>));
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NAME"	"FULL_NAME"	"INN"	"NSI_TYPE_ID"	"CREATE_DATE"	"MODIF_DATE"	"VERSION"	"BEGIN_DATE"	"END_DATE"<font></font>
1	" ""  """	"  ""  """	"11223344"	1	11.03.20	11.03.20	1	11.03.20	11.03.20<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span>(pkg_nsi.nsi_organization_table(<span class="hljs-keyword">sysdate</span>+<span class="hljs-number">1</span>));
<span class="hljs-comment">---------------------------------------------------------------------------------------</span><font></font>
"NSI_ID"	"NAME"	"FULL_NAME"	"INN"	"NSI_TYPE_ID"	"CREATE_DATE"	"MODIF_DATE"	"VERSION"	"BEGIN_DATE"	"END_DATE"<font></font>
1	" ""  """	"  ""  """	"99887766"	1	11.03.20	11.03.20	0	12.03.20	<font></font>
<span class="hljs-comment">---------------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nsi_organization_table函数非常有用，因为它满足了我们的要求，并最终</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决了第四个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
继续。</font><font style="vertical-align: inherit;">由于引入用于处理所有目录的统一方法具有如此优势，因此我们还将使用它来存储可分配给任何目录中任何条目的其他信息。</font><font style="vertical-align: inherit;">这种机制长期存在，称为EAV模式，我们正在实现它。</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">--  CHECK nsi_attribute_type_ch</span><font></font>
    NSI_ATTRIBUTE_TYPE_STRING   NUMBER := 1;<font></font>
    NSI_ATTRIBUTE_TYPE_INT      NUMBER := 2;<font></font>
    NSI_ATTRIBUTE_TYPE_DOUBLE   NUMBER := 3;<font></font>
    NSI_ATTRIBUTE_TYPE_DATE     NUMBER := 4;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_attribute_type (<font></font>
    nsi_attribute_type_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    value_type              <span class="hljs-built_in">NUMBER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">descr</span>                   <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_ch <span class="hljs-keyword">CHECK</span> (value_type <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_attribute_type <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.nsi_attribute_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.value_type <span class="hljs-keyword">IS</span> <span class="hljs-string">'  (1 - , 2 - , 3 - , 4 - )'</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute_type.descr <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_attribute (<font></font>
    nsi_attribute_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_attribute_type_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_id                  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id             <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    value_1                 <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">100</span>),<font></font>
    value_2_3               <span class="hljs-built_in">NUMBER</span>,<font></font>
    value_4                 <span class="hljs-built_in">DATE</span>,<font></font>
    begin_date              <span class="hljs-built_in">DATE</span>,<font></font>
    end_date                <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_attribute_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_type_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_attribute_type_id) <span class="hljs-keyword">REFERENCES</span> nsi_attribute_type (nsi_attribute_type_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_attribute_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id, nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id, nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_attribute <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_attribute_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_attribute_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.nsi_type_id <span class="hljs-keyword">is</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_1 <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_2_3 <span class="hljs-keyword">IS</span> <span class="hljs-string">'    '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.value_4 <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_attribute.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，在文档的上下文中，在某些情况下必须使用专有名称，因此我们将创建一个包含个人的新表，并类似于组织，添加触发器处理和选择类型。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_person (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    surname         <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    patronymic      <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    birthday        <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_person_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_person_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_person <span class="hljs-keyword">IS</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.surname <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.patronymic <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_person.birthday <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_person_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_person <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_person'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :NEW.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_person_trg_update 
BEFORE UPDATE ON nsi_person FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_person<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :NEW.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_person_trg_delete 
AFTER DELETE ON nsi_person FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_person<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.surname || '''</span> <span class="hljs-keyword">AS</span> surname, <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.patronymic || '''</span> <span class="hljs-keyword">AS</span> patronymic, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">''' || :OLD.birthday || '''</span>, <span class="hljs-string">''</span>dd.mm.yy<span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> birthday <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仍然需要用此表的处理来补充pkg_nsi软件包。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     nsi_person     nsi</span><font></font>
    TYPE nsi_person_rec IS RECORD(<font></font>
        nsi_id          nsi_person.nsi_id%TYPE, <font></font>
        surname         nsi_person.surname%TYPE,<font></font>
        name            nsi_person.name%TYPE,<font></font>
        patronymic      nsi_person.patronymic%TYPE,<font></font>
        birthday        nsi_person.birthday%TYPE,<font></font>
        nsi_type_id     nsi.nsi_type_id%TYPE, <font></font>
        create_date     nsi.create_date%TYPE,<font></font>
        modif_date      nsi.create_date%TYPE,<font></font>
        version         nsi_history.version%TYPE,<font></font>
        begin_date      nsi.begin_date%TYPE,<font></font>
        end_date        nsi_history.end_date%TYPE<font></font>
    );<font></font>
    TYPE nsi_person_list IS TABLE OF nsi_person_rec;<font></font>
<font></font>
    <span class="hljs-comment">/*  ,    .
    *     ,    .
    *  @param p_date DATE - ,      
    *  @return nsi_person_table -    nsi_person_rec
    */</span><font></font>
    FUNCTION nsi_person_table(p_date IN DATE := null) <font></font>
    RETURN nsi_person_list PIPELINED<font></font>
    AS<font></font>
        v_date date;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_date := Trunc(<span class="hljs-keyword">Sysdate</span>);<font></font>
        IF p_date IS NOT NULL THEN<font></font>
            v_date := Trunc(p_date);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> <font></font>
                p.nsi_id, p.surname, p.name, p.patronymic, p.birthday, <font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">version</span>, n.begin_date, <span class="hljs-keyword">to_date</span>(<span class="hljs-literal">null</span>) <span class="hljs-keyword">AS</span> end_date
            <span class="hljs-keyword">FROM</span> 
                nsi_person p <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (p.nsi_id = n.nsi_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                n.begin_date &lt;= v_date<font></font>
            <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
            <span class="hljs-keyword">SELECT</span> <font></font>
                n.nsi_id, <font></font>
                json_value(h.content, <span class="hljs-string">'$.SURNAME'</span>) <span class="hljs-keyword">AS</span> surname, <font></font>
                json_value(h.content, <span class="hljs-string">'$.NAME'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>,<font></font>
                json_value(h.content, <span class="hljs-string">'$.PATRONYMIC'</span>) <span class="hljs-keyword">AS</span> patronymic,
                <span class="hljs-keyword">to_date</span>(json_value(h.content, <span class="hljs-string">'$.BIRTHDAY'</span>)) <span class="hljs-keyword">AS</span> birthday,<font></font>
                n.nsi_type_id, n.create_date, n.modif_date, <font></font>
                h.version, h.begin_date, h.end_date<font></font>
            <span class="hljs-keyword">FROM</span> 
                nsi_history h <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
                <span class="hljs-keyword">ON</span> (h.nsi_id = n.nsi_id <span class="hljs-keyword">AND</span> h.nsi_type_id = n.nsi_type_id)
            <span class="hljs-keyword">WHERE</span> <font></font>
                    h.begin_date &lt;= v_date<font></font>
                <span class="hljs-keyword">AND</span> h.end_date &gt;= v_date<font></font>
        ) <span class="hljs-keyword">LOOP</span>
            <span class="hljs-keyword">PIPE</span> <span class="hljs-keyword">ROW</span> (rec);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    <span class="hljs-keyword">END</span> nsi_person_table;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并将某人添加到此表。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_person<font></font>
(surname, <span class="hljs-keyword">name</span>, patronymic, birthday)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'22.12.70'</span>, <span class="hljs-string">'dd.mm.yy'</span>));
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为最抢手的一般情况创建属性。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute_type (nsi_attribute_type_id, value_type, <span class="hljs-keyword">descr</span>) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'  . '</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在pkg_nsi包中，我们添加了用于处理目录属性的函数。</font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*   id      .
    *  @param p_nsi_attribute_type_id nsi_attribute_type.nsi_attribute_type_id%TYPE -  
    *  @param p_value_type nsi_attribute_type.value_type%TYPE -  
    *  @param p_descr nsi_attribute_type.descr%TYPE -  
    */</span><font></font>
    PROCEDURE get_attribute_type (<font></font>
        p_nsi_attribute_type_id IN nsi_attribute_type.nsi_attribute_type_id%TYPE,<font></font>
        p_value_type            OUT nsi_attribute_type.value_type%TYPE,<font></font>
        p_descr                 OUT nsi_attribute_type.descr%TYPE)<font></font>
    AS<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> value_type, <span class="hljs-keyword">descr</span>
          <span class="hljs-keyword">INTO</span> p_value_type, p_descr
          <span class="hljs-keyword">FROM</span> nsi_attribute_type
         <span class="hljs-keyword">WHERE</span> nsi_attribute_type_id = p_nsi_attribute_type_id;
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE -  
    *  @param p_nsi_id nsi_attribute.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_attribute.nsi_type_id%TYPE -  
    *  @param p_value_1 nsi_attribute.value_1%TYPE -   
    *  @param p_value_2_3 nsi_attribute.value_2_3%TYPE -   
    *  @param p_value_4 nsi_attribute.value_4%TYPE -   
    *  @param p_begin_date nsi_attribute.begin_date%TYPE -    
    *  @param p_end_date nsi_attribute.end_date%TYPE -    
    */</span><font></font>
    PROCEDURE nsi_attribute_insert (<font></font>
        p_nsi_attribute_type_id IN nsi_attribute.nsi_attribute_type_id%TYPE,<font></font>
        p_nsi_id                IN nsi_attribute.nsi_id%TYPE,<font></font>
        p_nsi_type_id           IN nsi_attribute.nsi_type_id%TYPE,<font></font>
        p_value_1               IN nsi_attribute.value_1%TYPE,<font></font>
        p_value_2_3             IN nsi_attribute.value_2_3%TYPE,<font></font>
        p_value_4               IN nsi_attribute.value_4%TYPE,<font></font>
        p_begin_date            IN nsi_attribute.begin_date%TYPE,<font></font>
        p_end_date              IN nsi_attribute.end_date%TYPE)<font></font>
    AS<font></font>
        v_id            NUMBER;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        get_attribute_type(p_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
<font></font>
        IF (v_value_type = NSI_ATTRIBUTE_TYPE_STRING) THEN<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,<font></font>
                    p_value_1, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_1;<font></font>
                    <font></font>
        ELSIF (v_value_type IN (NSI_ATTRIBUTE_TYPE_INT, NSI_ATTRIBUTE_TYPE_DOUBLE)) THEN<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,
                    <span class="hljs-literal">null</span>, p_value_2_3, <span class="hljs-literal">null</span>, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_2_3;<font></font>
                    <font></font>
        ELSE<font></font>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_attribute <font></font>
                (nsi_attribute_id, nsi_attribute_type_id, nsi_id, nsi_type_id, <font></font>
                 value_1, value_2_3, value_4, begin_date, end_date)<font></font>
            <span class="hljs-keyword">VALUES</span> (v_id, p_nsi_attribute_type_id, p_nsi_id, p_nsi_type_id,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, p_value_4, p_begin_date, p_end_date);<font></font>
                    <font></font>
            v_log_descr := p_value_4;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_id, p_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       ' : ' || v_log_descr || <font></font>
                       ' : ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper(p_nsi_id, p_nsi_type_id, NSI_LOG_OPERNUM_ATTR_INSERT, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*      .
    *  @param p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE -  
    *  @param p_value_1 nsi_attribute.value_1%TYPE -   
    *  @param p_value_2_3 nsi_attribute.value_2_3%TYPE -   
    *  @param p_value_4 nsi_attribute.value_4%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_attribute_value (<font></font>
        p_nsi_attribute_id      IN nsi_attribute.nsi_attribute_id%TYPE,<font></font>
        p_value_1               IN nsi_attribute.value_1%TYPE,<font></font>
        p_value_2_3             IN nsi_attribute.value_2_3%TYPE,<font></font>
        p_value_4               IN nsi_attribute.value_4%TYPE)<font></font>
    AS<font></font>
        v_nsi_id            nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id       nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
        v_value_type        nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr             nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id  nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_attribute_type_id, nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_attribute_type_id, v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
          <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
          <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        IF (v_value_type = NSI_ATTRIBUTE_TYPE_STRING) THEN<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = p_value_1,<font></font>
                   value_2_3 = <span class="hljs-literal">null</span>,<font></font>
                   value_4 = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_1;<font></font>
                    <font></font>
        ELSIF (v_value_type IN (NSI_ATTRIBUTE_TYPE_INT, NSI_ATTRIBUTE_TYPE_DOUBLE)) THEN<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = <span class="hljs-literal">null</span>,<font></font>
                   value_2_3 = p_value_2_3,<font></font>
                   value_4 = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_2_3;<font></font>
                    <font></font>
        ELSE<font></font>
            <span class="hljs-keyword">UPDATE</span> nsi_attribute
               <span class="hljs-keyword">SET</span> value_1 = <span class="hljs-literal">null</span>,<font></font>
                   value_2_3 = <span class="hljs-literal">null</span>,<font></font>
                   value_4 = p_value_4<font></font>
            <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
<font></font>
            v_log_descr := p_value_4;<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       '  : ' || v_log_descr;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE -  
    *  @param p_begin_date nsi_attribute.begin_date%TYPE -    
    *  @param p_end_date nsi_attribute.end_date%TYPE -    
    */</span><font></font>
    PROCEDURE nsi_attribute_period (<font></font>
        p_nsi_attribute_id  IN nsi_attribute.nsi_attribute_id%TYPE,<font></font>
        p_begin_date        IN nsi_attribute.begin_date%TYPE,<font></font>
        p_end_date          IN nsi_attribute.end_date%TYPE)<font></font>
    AS<font></font>
        v_nsi_id        nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id   nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id, nsi_attribute_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id, v_nsi_attribute_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
    <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_attribute
           <span class="hljs-keyword">SET</span> begin_date = p_begin_date,<font></font>
               end_date = p_end_date<font></font>
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr || <font></font>
                       '  : ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_attribute_id nsi_person.nsi_attribute_id%TYPE - id  nsi_attribute
    */</span><font></font>
    PROCEDURE nsi_attribute_delete (p_nsi_attribute_id nsi_attribute.nsi_attribute_id%TYPE)<font></font>
    AS<font></font>
        v_nsi_id        nsi.nsi_id%TYPE;<font></font>
        v_nsi_type_id   nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr     nsi_log.descr%TYPE;<font></font>
        v_value_type    nsi_attribute_type.value_type%TYPE;<font></font>
        v_descr         nsi_attribute_type.descr%TYPE;<font></font>
        v_nsi_attribute_type_id nsi_attribute.nsi_attribute_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id, nsi_attribute_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id, v_nsi_attribute_type_id
          <span class="hljs-keyword">FROM</span> nsi_attribute
         <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
    <font></font>
        get_attribute_type(v_nsi_attribute_type_id, v_value_type, v_descr);<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_attribute
        <span class="hljs-keyword">WHERE</span> nsi_attribute_id = p_nsi_attribute_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ' ||<font></font>
                       ' : ' || v_descr;<font></font>
        log_oper(v_nsi_id, v_nsi_type_id, NSI_LOG_OPERNUM_ATTR_DELETE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在分配适当的属性。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_insert(<span class="hljs-number">1</span>, <span class="hljs-number">225</span>, <span class="hljs-number">6</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">sysdate</span>, <span class="hljs-literal">null</span>);<font></font>
    pkg_nsi.nsi_attribute_insert(2, 225, 6, '', null, null, sysdate, null);<font></font>
    pkg_nsi.nsi_attribute_insert(3, 225, 6, '', null, null, sysdate, null);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">--      ,      ,  </span>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			11.03.20	<font></font>
232	2	225	6	""			11.03.20	<font></font>
234	3	225	6	""			11.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_value(<span class="hljs-number">230</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
<span class="hljs-keyword">end</span>;
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			11.03.20<font></font>
232	2	225	6	""			11.03.20	<font></font>
234	3	225	6	""			11.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--       </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_attribute_period(<span class="hljs-number">230</span>, <span class="hljs-keyword">sysdate</span><span class="hljs-number">-1</span>, <span class="hljs-literal">null</span>);<font></font>
    pkg_nsi.nsi_attribute_period(232, sysdate-1, null);<font></font>
    pkg_nsi.nsi_attribute_period(234, sysdate-1, null);<font></font>
<span class="hljs-keyword">end</span>;
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span><font></font>
"NSI_ATTRIBUTE_ID"	"NSI_ATTRIBUTE_TYPE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"VALUE_1"	"VALUE_2_3"	"VALUE_4"	"BEGIN_DATE"	"END_DATE"<font></font>
230	1	225	6	""			10.03.20	<font></font>
232	2	225	6	""			10.03.20	<font></font>
234	3	225	6	""			10.03.20	<font></font>
<span class="hljs-comment">--------------------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将克服第三个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了NSI系统中的参考表外，它们之间的关系也很重要。</font><font style="vertical-align: inherit;">因此，例如，大型组织包括各种单位，分支机构，部门等，它们可以构建为树状结构。</font><font style="vertical-align: inherit;">首先，我们将在我们的系统中创建更多组织，这些组织将隶属于现有的“角逐”。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'1111111111'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'2222222222'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_organization (<span class="hljs-keyword">name</span>, full_name, inn)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'   '</span>, <span class="hljs-string">'   '</span>, <span class="hljs-string">'3333333333'</span>);<font></font>
<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------</span><font></font>
281	1	   	13.03.20	13.03.20	13.03.20<font></font>
283	1	   	13.03.20	13.03.20	13.03.20<font></font>
285	1	   	13.03.20	13.03.20	13.03.20<font></font>
1	1	 "  "	11.03.20	13.03.20	12.03.20<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在有必要表明这些组织之间的关系。</font><font style="vertical-align: inherit;">为此，您需要一个具有树结构的表并指示操作周期，因为所有内容都会随时间变化，因此您需要考虑到这一点。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_structure (<font></font>
    nsi_structure_id    <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_parent_structure_id <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>),<font></font>
    nsi_id              <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_type_id         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    ordnum              <span class="hljs-built_in">NUMBER</span>,<font></font>
    begin_date          <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date            <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_structure_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_structure_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_parent_struct_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_parent_structure_id) <span class="hljs-keyword">REFERENCES</span> nsi_structure (nsi_structure_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_struct_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id, nsi_type_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id, nsi_type_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_structure <span class="hljs-keyword">IS</span> <span class="hljs-string">'.   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.nsi_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.ordnum <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_structure.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，您应该扩展pkg_nsi软件包的功能，以便可以自定义各种表的结构。 </font></font><br>
<br>
<pre><code class="sql hljs">    <span class="hljs-comment">/*   .
    *  @param p_nsi_parent_structure_id nsi_structure.nsi_parent_structure_id%TYPE -  
    *  @param p_nsi_id nsi_structure.nsi_id%TYPE - 
    *  @param p_nsi_type_id nsi_structure.nsi_type_id%TYPE -  
    *  @param p_ordnum nsi_structure.ordnum%TYPE -  
    *  @param p_begin_date nsi_structure.begin_date%TYPE -    
    *  @param p_end_date nsi_structure.end_date%TYPE -    
    */</span><font></font>
    FUNCTION nsi_structure_insert (<font></font>
        p_nsi_parent_structure_id   IN nsi_structure.nsi_parent_structure_id%TYPE,<font></font>
        p_nsi_id                    IN nsi_structure.nsi_id%TYPE,<font></font>
        p_nsi_type_id               IN nsi_structure.nsi_type_id%TYPE,<font></font>
        p_ordnum                    IN nsi_structure.ordnum%TYPE,<font></font>
        p_begin_date                IN nsi_structure.begin_date%TYPE, <font></font>
        p_end_date                  IN nsi_structure.end_date%TYPE)<font></font>
    RETURN nsi_structure.nsi_structure_id%TYPE<font></font>
    AS<font></font>
        v_id        NUMBER;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        v_type_id := get_type_id('nsi_structure');<font></font>
<font></font>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_structure (<font></font>
            nsi_structure_id, nsi_parent_structure_id,<font></font>
            nsi_id, nsi_type_id, ordnum, begin_date, end_date)<font></font>
        <span class="hljs-keyword">VALUES</span> (<font></font>
            v_id, p_nsi_parent_structure_id, <font></font>
            p_nsi_id, p_nsi_type_id, p_ordnum, Trunc(p_begin_date), Trunc(p_end_date));<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_id, p_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (v_id, v_type_id, NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
        <font></font>
        RETURN v_id;<font></font>
    <span class="hljs-keyword">END</span> nsi_structure_insert;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    *  @param p_ordnum nsi_structure.ordnum%TYPE -  
    */</span><font></font>
    PROCEDURE nsi_structure_ordnum (<font></font>
        p_nsi_structure_id  IN nsi_structure.nsi_structure_id%TYPE,<font></font>
        p_ordnum            IN nsi_structure.ordnum%TYPE)<font></font>
    AS<font></font>
        v_nsi_id 		    nsi_structure.nsi_id%TYPE;<font></font>
        v_nsi_type_id 	    nsi_structure.nsi_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_structure
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_structure
           <span class="hljs-keyword">SET</span> ordnum = p_ordnum 
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_ordnum;<font></font>
        log_oper (p_nsi_structure_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    *  @param p_begin_date nsi_structure.begin_date%TYPE -   
    *  @param p_end_date nsi_structure.end_date%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_structure_period (<font></font>
        p_nsi_structure_id  IN nsi_structure.nsi_structure_id%TYPE,<font></font>
        p_begin_date        IN nsi_structure.begin_date%TYPE, <font></font>
        p_end_date          IN nsi_structure.end_date%TYPE)<font></font>
    AS<font></font>
        v_nsi_id 		    nsi_structure.nsi_id%TYPE;<font></font>
        v_nsi_type_id 	    nsi_structure.nsi_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_id, nsi_type_id
          <span class="hljs-keyword">INTO</span> v_nsi_id, v_nsi_type_id
          <span class="hljs-keyword">FROM</span> nsi_structure
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_structure
           <span class="hljs-keyword">SET</span> begin_date = Trunc(p_begin_date),<font></font>
               end_date = Trunc(p_end_date) <font></font>
         <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_nsi_id, v_nsi_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (p_nsi_structure_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_structure_id nsi_structure.nsi_structure_id%TYPE -  nsi_structure
    */</span><font></font>
    PROCEDURE nsi_structure_delete (p_nsi_structure_id IN nsi_structure.nsi_structure_id%TYPE)<font></font>
    AS<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_structure'</span>);<font></font>
        <font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> nsi_structure_id, nsi_parent_structure_id,<font></font>
                    nsi_id, nsi_type_id, ordnum, begin_date, end_date<font></font>
            <span class="hljs-keyword">FROM</span> nsi_structure
            <span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> nsi_structure_id = p_nsi_structure_id
            <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">PRIOR</span> nsi_structure_id = nsi_parent_structure_id<font></font>
        )<font></font>
        <span class="hljs-keyword">LOOP</span>
            v_log_descr := <span class="hljs-string">'['</span> || pkg_nsi.get_nsi_descr(rec.nsi_id, rec.nsi_type_id) || <span class="hljs-string">'] '</span>;<font></font>
            v_log_descr := v_log_descr || ' ' || rec.begin_date || ' - ' || rec.end_date;<font></font>
            pkg_nsi.log_oper (rec.nsi_structure_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_structure
        <span class="hljs-keyword">WHERE</span> nsi_structure_id = p_nsi_structure_id;
    <span class="hljs-keyword">END</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种手段问世之后，人们就可以安全地建立组织之间的关系。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span>
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">number</span>;<font></font>
    root_id number;<font></font>
<span class="hljs-keyword">begin</span>
    root_id := pkg_nsi.nsi_structure_insert(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'13.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-literal">null</span>);<font></font>
    id := pkg_nsi.nsi_structure_insert(root_id, 281, 1, null, to_date('13.02.20', 'dd.mm.yy'), to_date('15.02.20', 'dd.mm.yy'));<font></font>
    id := pkg_nsi.nsi_structure_insert(root_id, 283, 1, null, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    id := pkg_nsi.nsi_structure_insert(id, 285, 1, null, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id);
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
318	316	281	1		13.02.20	15.02.20<font></font>
320	316	283	1		13.02.20	<font></font>
322	320	285	1		13.02.20	<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_structure_ordnum(<span class="hljs-number">320</span>, <span class="hljs-number">1</span>);<font></font>
    pkg_nsi.nsi_structure_ordnum(318, 2);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
320	316	283	1	1	13.02.20	<font></font>
322	320	285	1		13.02.20	<font></font>
318	316	281	1	2	13.02.20	15.02.20<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">begin</span>
    pkg_nsi.nsi_structure_period(<span class="hljs-number">320</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'14.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'14.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>));
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316		1	1		13.02.20	<font></font>
320	316	283	1	1	14.02.20	14.02.20<font></font>
322	320	285	1		13.02.20	<font></font>
318	316	281	1	2	13.02.20	15.02.20<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于目录与结构是分开的，因此每次都要考虑到组织之间的关系变得麻烦时，因此我们可以简化我们的工作。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">VIEW</span> V_NSI_ORGANIZATION <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <font></font>
    s.nsi_structure_id, s.nsi_parent_structure_id,<font></font>
    s.ordnum, s.begin_date, s.end_date,<font></font>
    s.nsi_id, s.nsi_type_id, o.name, o.full_name, o.inn<font></font>
<span class="hljs-keyword">FROM</span> nsi_structure s <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi_organization o
    <span class="hljs-keyword">ON</span> (s.nsi_id = o.nsi_id)
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_parent_structure_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> v_nsi_organization;
<span class="hljs-comment">-----------------------------------------------------------------------------------</span><font></font>
316			13.02.20		1	1	 "  "	  "  "	99887766<font></font>
320	316	1	14.02.20	14.02.20	283	1	   	   	2222222222<font></font>
322	320		13.02.20		285	1	   	   	3333333333<font></font>
318	316	2	13.02.20	15.02.20	281	1	   	   	1111111111<font></font>
<span class="hljs-comment">-----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们正在构建一棵树的事实非常棒，但是该树的所有节点都属于一个实体，我们的任务是实现在不同实体之间建立关系。</font><font style="vertical-align: inherit;">这也不是问题，因为该结构没有绑定到任何特定的参考书，而是作为一个整体在整个NSI系统上起作用。</font><font style="vertical-align: inherit;">例如，我们将为国家公务员职位构造一个分类器，为市政府职位构造一个分类器。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_classifier (<font></font>
    nsi_id      <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    code        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">name</span>        <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_classifier_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_classifier_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_classifier <span class="hljs-keyword">IS</span> <span class="hljs-string">'. '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.code <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_classifier.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_classifier_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_classifier <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_classifier'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_classifier_trg_update 
BEFORE UPDATE ON nsi_classifier FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_classifier<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :NEW.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_classifier_trg_delete 
AFTER DELETE ON nsi_classifier FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_classifier<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code || '''</span> <span class="hljs-keyword">AS</span> code <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post_group (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_group_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_group_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post_group <span class="hljs-keyword">is</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_group.nsi_id <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_group.name <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_group_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post_group <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post_group'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_group_trg_update 
BEFORE UPDATE ON nsi_post_group FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_group<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_group_trg_delete 
AFTER DELETE ON nsi_post_group FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_group<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post_category (<font></font>
    nsi_id   <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span>     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_category_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_category_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post_category <span class="hljs-keyword">is</span> <span class="hljs-string">'.  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_category.nsi_id <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post_category.name <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_category_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post_category <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post_category'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_category_trg_update 
BEFORE UPDATE ON nsi_post_category FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_category<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :NEW.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_category_trg_delete 
AFTER DELETE ON nsi_post_category FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post_category<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_post (<font></font>
    nsi_id          <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    code_OKPDTR     <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">10</span>),
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">VARCHAR2</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_post_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_post <span class="hljs-keyword">IS</span> <span class="hljs-string">'. '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.nsi_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.code_OKPDTR <span class="hljs-keyword">IS</span> <span class="hljs-string">' '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_post.name <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">TRIGGER</span> nsi_post_trg_insert 
<span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> nsi_post <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">DECLARE</span>
    v_type_id 	nsi.nsi_type_id%<span class="hljs-keyword">TYPE</span>;<font></font>
    v_log_descr nsi_log.descr%TYPE;<font></font>
    v_log_query VARCHAR(4000);<font></font>
<span class="hljs-keyword">BEGIN</span>
    v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_post'</span>);<font></font>
    :NEW.nsi_id := pkg_nsi.get_nsi_id();<font></font>
<font></font>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi (nsi_id, nsi_type_id, <span class="hljs-keyword">descr</span>, create_date, modif_date, begin_date)
    <span class="hljs-keyword">VALUES</span> (:NEW.nsi_id, v_type_id, :NEW.name, Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>), Trunc(<span class="hljs-keyword">Sysdate</span>));<font></font>
    <font></font>
    v_log_query := '<span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_INSERT, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_trg_update 
BEFORE UPDATE ON nsi_post FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post<span class="hljs-string">');

    UPDATE nsi
       SET modif_date = Trunc(Sysdate)
     WHERE nsi_id = :NEW.nsi_id
       AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:NEW.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_UPDATE, v_log_descr);
END;

CREATE OR REPLACE TRIGGER nsi_post_trg_delete 
AFTER DELETE ON nsi_post FOR EACH ROW
DECLARE
    v_type_id 	nsi.nsi_type_id%TYPE;
    v_log_descr nsi_log.descr%TYPE;
    v_log_query VARCHAR(4000);
BEGIN
    v_type_id := pkg_nsi.get_type_id('</span>nsi_post<span class="hljs-string">');

    DELETE FROM nsi_history 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi_attribute 
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;

    DELETE FROM nsi
    WHERE nsi_id = :OLD.nsi_id
      AND nsi_type_id = v_type_id;
    
    v_log_query := '</span><span class="hljs-keyword">SELECT</span> <span class="hljs-string">''' || :OLD.name || '''</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>, <span class="hljs-string">''' || :OLD.code_OKPDTR || '''</span> <span class="hljs-keyword">AS</span> code_OKPDTR <span class="hljs-keyword">FROM</span> DUAL<span class="hljs-string">';
    v_log_descr := pkg_nsi.get_json(v_log_query);
    pkg_nsi.log_oper (:OLD.nsi_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);
END;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它仅用于填写和收集必要的分类器。</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_classifier (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'  '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_classifier (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'  '</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_group (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' ()'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post_category (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">' '</span>);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'24742'</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26480'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'23509'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'20419'</span>, <span class="hljs-string">' '</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26541'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_post (code_OKPDTR, <span class="hljs-keyword">name</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'26544'</span>, <span class="hljs-string">' 2 '</span>);<font></font>
<font></font>
<span class="hljs-keyword">commit</span>;<font></font>
<font></font>
<span class="hljs-keyword">declare</span>
    post_id <span class="hljs-built_in">number</span>;<font></font>
    classif_id number;<font></font>
    categ_id number;<font></font>
    group_id number;<font></font>
<span class="hljs-keyword">begin</span>
    <span class="hljs-comment">--   </span>
    classif_id := pkg_nsi.nsi_structure_insert(<span class="hljs-literal">null</span>, <span class="hljs-number">331</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">to_date</span>(<span class="hljs-string">'13.02.20'</span>, <span class="hljs-string">'dd.mm.yy'</span>), <span class="hljs-literal">null</span>);
    <span class="hljs-comment">-- </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 347, 4, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 335, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  ()</span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 349, 4, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 337, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 351, 4, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 355, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 341, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 361, 3, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  </span><font></font>
    categ_id := pkg_nsi.nsi_structure_insert(classif_id, 353, 4, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 357, 3, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 359, 3, 2, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 361, 3, 3, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">-- </span><font></font>
    group_id := pkg_nsi.nsi_structure_insert(categ_id, 363, 3, 4, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
    <span class="hljs-comment">--  2 </span><font></font>
    post_id := pkg_nsi.nsi_structure_insert(group_id, 345, 2, 1, to_date('13.02.20', 'dd.mm.yy'), null);<font></font>
<font></font>
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> nsi_structure s
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (nsi_id = <span class="hljs-number">331</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;
<span class="hljs-comment">----------------------------------------------------------------------------------</span><font></font>
"NSI_STRUCTURE_ID"	"NSI_PARENT_STRUCTURE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"ORDNUM"	"BEGIN_DATE"	"END_DATE"<font></font>
385		331	5		13.02.20	<font></font>
387	385	347	4	1	13.02.20	<font></font>
389	387	355	3	1	13.02.20	<font></font>
391	387	357	3	2	13.02.20	<font></font>
393	391	335	2	1	13.02.20	<font></font>
395	387	359	3	3	13.02.20	<font></font>
397	385	349	4	2	13.02.20	<font></font>
399	397	355	3	1	13.02.20	<font></font>
401	397	357	3	2	13.02.20	<font></font>
403	397	359	3	3	13.02.20	<font></font>
405	403	337	2	1	13.02.20	<font></font>
407	385	351	4	3	13.02.20	<font></font>
409	407	355	3	1	13.02.20	<font></font>
411	407	357	3	2	13.02.20	<font></font>
413	407	359	3	3	13.02.20	<font></font>
415	413	341	2	1	13.02.20	<font></font>
417	407	361	3	4	13.02.20	<font></font>
419	385	353	4	4	13.02.20	<font></font>
421	419	357	3	1	13.02.20	<font></font>
423	419	359	3	2	13.02.20	<font></font>
425	419	361	3	3	13.02.20	<font></font>
427	419	363	3	4	13.02.20	<font></font>
429	427	345	2	1	13.02.20	<font></font>
<span class="hljs-comment">----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
哦，它的可读性！</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">VIEW</span> V_NSI_CLASSIFIRE_GGS <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <font></font>
    s.nsi_structure_id, s.nsi_parent_structure_id,<font></font>
    s.ordnum, s.begin_date, s.end_date,<font></font>
    n.nsi_id, n.nsi_type_id, n.descr<font></font>
<span class="hljs-keyword">FROM</span> nsi_structure s <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> nsi n
    <span class="hljs-keyword">ON</span> (s.nsi_id = n.nsi_id)
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> (s.nsi_id = <span class="hljs-number">331</span>)
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span> (nsi_parent_structure_id = <span class="hljs-keyword">PRIOR</span> nsi_structure_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span> ordnum;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> V_NSI_CLASSIFIRE_GGS ;
<span class="hljs-comment">----------------------------------------------------------------------------------</span><font></font>
"NSI_STRUCTURE_ID"	"NSI_PARENT_STRUCTURE_ID"	"NSI_ID"	"NSI_TYPE_ID"	"ORDNUM"	"BEGIN_DATE"	"END_DATE"<font></font>
385			13.02.20		331	5	  <font></font>
387	385	1	13.02.20		347	4	<font></font>
389	387	1	13.02.20		355	3	<font></font>
391	387	2	13.02.20		357	3	<font></font>
393	391	1	13.02.20		335	2	 <font></font>
395	387	3	13.02.20		359	3	<font></font>
397	385	2	13.02.20		349	4	 ()<font></font>
399	397	1	13.02.20		355	3	<font></font>
401	397	2	13.02.20		357	3	<font></font>
403	397	3	13.02.20		359	3	<font></font>
405	403	1	13.02.20		337	2	<font></font>
407	385	3	13.02.20		351	4	<font></font>
409	407	1	13.02.20		355	3	<font></font>
411	407	2	13.02.20		357	3	<font></font>
413	407	3	13.02.20		359	3	<font></font>
415	413	1	13.02.20		341	2	 <font></font>
417	407	4	13.02.20		361	3	<font></font>
419	385	4	13.02.20		353	4	 <font></font>
421	419	1	13.02.20		357	3	<font></font>
423	419	2	13.02.20		359	3	<font></font>
425	419	3	13.02.20		361	3	<font></font>
427	419	4	13.02.20		363	3	<font></font>
429	427	1	13.02.20		345	2	 2 <font></font>
<span class="hljs-comment">----------------------------------------------------------------------------------</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不应忘记，除了包含关系（包括树形关系）之外，还存在相交关系，即交叉表。</font><font style="vertical-align: inherit;">这增加了检查时间交点的附加条件。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> nsi_cross (<font></font>
    nsi_cross_id        <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_main_id         <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_main_type_id    <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_detail_id       <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    nsi_detail_type_id  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    begin_date          <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
    end_date            <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_pk PRIMARY <span class="hljs-keyword">KEY</span> (nsi_cross_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_main_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_main_type_id, nsi_main_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_type_id, nsi_id),
    <span class="hljs-keyword">CONSTRAINT</span> nsi_cross_detail_nsi_fk <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (nsi_detail_type_id, nsi_detail_id) <span class="hljs-keyword">REFERENCES</span> nsi (nsi_type_id, nsi_id)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLE</span> nsi_cross <span class="hljs-keyword">IS</span> <span class="hljs-string">'. - '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_cross_id <span class="hljs-keyword">IS</span> <span class="hljs-string">''</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_main_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_main_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_detail_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.nsi_detail_type_id <span class="hljs-keyword">IS</span> <span class="hljs-string">'   '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.begin_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;
<span class="hljs-keyword">COMMENT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COLUMN</span> nsi_cross.end_date <span class="hljs-keyword">IS</span> <span class="hljs-string">'  '</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*        -.
    *  @param p_nsi_main_id nsi_cross.nsi_main_id%TYPE -   
    *  @param p_nsi_main_type_id nsi_cross.nsi_main_type_id%TYPE -    
    *  @param p_nsi_detail_id nsi_cross.nsi_detail_id%TYPE -   
    *  @param p_nsi_detail_type_id nsi_cross.nsi_detail_type_id%TYPE -    
    *  @param p_begin_date DATE -    
    *  @param p_end_date DATE -    
    */</span><font></font>
    PROCEDURE nsi_cross_check_period (<font></font>
        p_nsi_cross_id          IN nsi_cross.nsi_cross_id%TYPE,<font></font>
        p_begin_date            IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date              IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_cnt NUMBER;<font></font>
        v_nsi_main_id           nsi_cross.nsi_main_id%TYPE;<font></font>
        v_nsi_main_type_id      nsi_cross.nsi_main_type_id%TYPE;<font></font>
        v_nsi_detail_id         nsi_cross.nsi_detail_id%TYPE;<font></font>
        v_nsi_detail_type_id    nsi_cross.nsi_detail_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">IF</span> (p_end_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (Trunc(p_begin_date) &gt; Trunc(p_end_date)) <span class="hljs-keyword">THEN</span><font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                <span class="hljs-string">'[nsi_cross_check_period]         '</span> || Trunc(p_begin_date) || <span class="hljs-string">' - '</span> || Trunc(p_end_date)); 
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MIN</span>(nsi_main_id), <span class="hljs-keyword">MIN</span>(nsi_main_type_id),
               <span class="hljs-keyword">MIN</span>(nsi_detail_id), <span class="hljs-keyword">MIN</span>(nsi_detail_type_id) 
          <span class="hljs-keyword">INTO</span> v_nsi_main_id, v_nsi_main_type_id,<font></font>
               v_nsi_detail_id, v_nsi_detail_type_id <font></font>
          <span class="hljs-keyword">FROM</span> nsi_cross
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
         <font></font>
        v_cnt := 0;<font></font>
        <font></font>
        IF (v_nsi_main_id IS NOT NULL) THEN<font></font>
        <font></font>
            IF (p_end_date IS NOT NULL) THEN<font></font>
                <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
                  <span class="hljs-keyword">INTO</span> v_cnt
                  <span class="hljs-keyword">FROM</span> nsi_cross
                 <span class="hljs-keyword">WHERE</span> nsi_main_id = v_nsi_main_id
                   <span class="hljs-keyword">AND</span> nsi_main_type_id = v_nsi_main_type_id
                   <span class="hljs-keyword">AND</span> nsi_detail_id = v_nsi_detail_id
                   <span class="hljs-keyword">AND</span> nsi_detail_type_id = v_nsi_detail_type_id
                   <span class="hljs-keyword">AND</span> nsi_cross_id &lt;&gt; p_nsi_cross_id
                   <span class="hljs-keyword">AND</span> begin_date &lt;= Trunc(p_end_date)
                   <span class="hljs-keyword">AND</span> ((end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span> (end_date &gt;= Trunc(p_end_date)));<font></font>
            ELSE<font></font>
                <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
                  <span class="hljs-keyword">INTO</span> v_cnt
                  <span class="hljs-keyword">FROM</span> nsi_cross
                 <span class="hljs-keyword">WHERE</span> nsi_main_id = v_nsi_main_id
                   <span class="hljs-keyword">AND</span> nsi_main_type_id = v_nsi_main_type_id
                   <span class="hljs-keyword">AND</span> nsi_detail_id = v_nsi_detail_id
                   <span class="hljs-keyword">AND</span> nsi_detail_type_id = v_nsi_detail_type_id
                   <span class="hljs-keyword">AND</span> nsi_cross_id &lt;&gt; p_nsi_cross_id
                   <span class="hljs-keyword">AND</span> ((<font></font>
                        (end_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (end_date &gt;= Trunc(p_begin_date))<font></font>
                        ) <span class="hljs-keyword">OR</span> (end_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)<font></font>
                        );<font></font>
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<font></font>
<font></font>
        IF (v_cnt &gt; 0) THEN<font></font>
            RAISE_APPLICATION_ERROR (NSI_ERROR_CODE, <font></font>
                '[nsi_cross_check_period]     ' || p_begin_date || ' - ' || p_end_date);    <font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_main_id nsi_cross.nsi_main_id%TYPE -   
    *  @param p_nsi_main_type_id nsi_cross.nsi_main_type_id%TYPE -    
    *  @param p_nsi_detail_id nsi_cross.nsi_detail_id%TYPE -   
    *  @param p_nsi_detail_type_id nsi_cross.nsi_detail_type_id%TYPE -    
    *  @param p_begin_date DATE -    
    *  @param p_end_date DATE -    
    */</span><font></font>
    PROCEDURE nsi_cross_insert (<font></font>
        p_nsi_main_id           IN nsi_cross.nsi_main_id%TYPE,<font></font>
        p_nsi_main_type_id      IN nsi_cross.nsi_main_type_id%TYPE,<font></font>
        p_nsi_detail_id         IN nsi_cross.nsi_detail_id%TYPE,<font></font>
        p_nsi_detail_type_id    IN nsi_cross.nsi_detail_type_id%TYPE,<font></font>
        p_begin_date            IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date              IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_id        NUMBER;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span><font></font>
        v_id := get_nsi_id;<font></font>
        v_type_id := get_type_id('nsi_cross');<font></font>
<font></font>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> nsi_cross (<font></font>
            nsi_cross_id, nsi_main_id, nsi_main_type_id,<font></font>
            nsi_detail_id, nsi_detail_type_id, <font></font>
            begin_date, end_date)<font></font>
        <span class="hljs-keyword">VALUES</span> (<font></font>
            v_id, p_nsi_main_id, p_nsi_main_type_id,<font></font>
            p_nsi_detail_id, p_nsi_detail_type_id, <font></font>
            Trunc(p_begin_date), Trunc(p_end_date));<font></font>
<font></font>
        nsi_cross_check_period (v_id, p_begin_date, p_end_date);<font></font>
<font></font>
        v_log_descr := '[' || get_nsi_descr(p_nsi_main_id, p_nsi_main_type_id) || ' &lt;=&gt; ' || get_nsi_descr(p_nsi_detail_id, p_nsi_detail_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (v_id, v_type_id, NSI_LOG_OPERNUM_INSERT, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span> nsi_cross_insert;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*     .
    *  @param p_nsi_cross_id nsi_cross.nsi_cross_id%TYPE -  nsi_cross
    *  @param p_begin_date nsi_cross.begin_date%TYPE -   
    *  @param p_end_date nsi_cross.end_date%TYPE -   
    */</span><font></font>
    PROCEDURE nsi_cross_period (<font></font>
        p_nsi_cross_id  IN nsi_cross.nsi_cross_id%TYPE,<font></font>
        p_begin_date    IN nsi_cross.begin_date%TYPE, <font></font>
        p_end_date      IN nsi_cross.end_date%TYPE)<font></font>
    AS<font></font>
        v_main_id 		    nsi_cross.nsi_main_id%TYPE;<font></font>
        v_main_type_id 	    nsi_cross.nsi_main_type_id%TYPE;<font></font>
        v_detail_id 		nsi_cross.nsi_detail_id%TYPE;<font></font>
        v_detail_type_id 	nsi_cross.nsi_detail_type_id%TYPE;<font></font>
        v_type_id 	        nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr         nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := get_type_id(<span class="hljs-string">'nsi_cross'</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">SELECT</span> nsi_main_id, nsi_main_type_id,<font></font>
               nsi_detail_id, nsi_detail_type_id<font></font>
          <span class="hljs-keyword">INTO</span> v_main_id, v_main_type_id,<font></font>
               v_detail_id, v_detail_type_id<font></font>
          <span class="hljs-keyword">FROM</span> nsi_cross
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
<font></font>
        nsi_cross_check_period (p_nsi_cross_id, p_begin_date, p_end_date);<font></font>
<font></font>
        <span class="hljs-keyword">UPDATE</span> nsi_cross
           <span class="hljs-keyword">SET</span> begin_date = Trunc(p_begin_date),<font></font>
               end_date = Trunc(p_end_date) <font></font>
         <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;<font></font>
         <font></font>
        v_log_descr := '[' || get_nsi_descr(v_main_id, v_main_type_id) || ' &lt;=&gt; ' || get_nsi_descr(v_detail_id, v_detail_type_id) || '] ';<font></font>
        v_log_descr := v_log_descr || ' ' || p_begin_date || ' - ' || p_end_date;<font></font>
        log_oper (p_nsi_cross_id, v_type_id, NSI_LOG_OPERNUM_UPDATE, v_log_descr);<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">/*   .
    *  @param p_nsi_cross_id nsi_cross.nsi_cross_id%TYPE -  nsi_cross
    */</span><font></font>
    PROCEDURE nsi_cross_delete (p_nsi_cross_id IN nsi_cross.nsi_cross_id%TYPE)<font></font>
    AS<font></font>
        v_type_id 	nsi.nsi_type_id%TYPE;<font></font>
        v_log_descr nsi_log.descr%TYPE;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        v_type_id := pkg_nsi.get_type_id(<span class="hljs-string">'nsi_cross'</span>);<font></font>
        <font></font>
        FOR rec IN (<font></font>
            <span class="hljs-keyword">SELECT</span> nsi_cross_id, nsi_main_id, nsi_main_type_id,<font></font>
                    nsi_detail_id, nsi_detail_type_id,<font></font>
                    begin_date, end_date<font></font>
            <span class="hljs-keyword">FROM</span> nsi_cross
            <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id<font></font>
        )<font></font>
        <span class="hljs-keyword">LOOP</span>
            v_log_descr := <span class="hljs-string">'['</span> || pkg_nsi.get_nsi_descr(rec.nsi_main_id, rec.nsi_main_type_id) || <span class="hljs-string">' &lt;=&gt; '</span> || pkg_nsi.get_nsi_descr(rec.nsi_detail_id, rec.nsi_detail_type_id) || <span class="hljs-string">'] '</span>;<font></font>
            v_log_descr := v_log_descr || ' ' || rec.begin_date || ' - ' || rec.end_date;<font></font>
            pkg_nsi.log_oper (rec.nsi_cross_id, v_type_id, pkg_nsi.NSI_LOG_OPERNUM_DELETE, v_log_descr);<font></font>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> nsi_cross
        <span class="hljs-keyword">WHERE</span> nsi_cross_id = p_nsi_cross_id;
    <span class="hljs-keyword">END</span>;
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就是这样，现在我们可以自信地说我们已经</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决了第一个问题</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，您可以尝试将很多东西附加到该系统上，但是我认为我已经在本文开头完成了任务，其余部分可以在讨论过程中考虑到。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管在版本12中已经提供了对json格式的本机支持，但该材料是在Oracle 18c版上编写的。这是</font><font style="vertical-align: inherit;">脚本档案</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">链接</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN492398/index.html">我们为远程工作，播客，视频和流媒体配置设备</a></li>
<li><a href="../zh-CN492404/index.html">Flutter + Arduino Nano 33 BLE感应=非常简单的BLE传感器</a></li>
<li><a href="../zh-CN492406/index.html">极客播客：关于项目管理，技术分析和GTD的一系列成熟程序</a></li>
<li><a href="../zh-CN492408/index.html">Yandex桌面出席人数下降：2019年发生了什么以及对2020年的影响</a></li>
<li><a href="../zh-CN492410/index.html">Yandex进行了测量，C ++比Rust更快更安全</a></li>
<li><a href="../zh-CN492420/index.html">微信或真正全面的应用程序。开发人员可以做什么</a></li>
<li><a href="../zh-CN492422/index.html">Escobar Fold 2-骗局继续</a></li>
<li><a href="../zh-CN492424/index.html">Angular：另一种退订方式</a></li>
<li><a href="../zh-CN492426/index.html">如何绕开信息技术的地雷</a></li>
<li><a href="../zh-CN492432/index.html">FastText：代码配方</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>