<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßúüèª ‚ùå ü¶ã We write an operating system. Part 1. Loader üôÜüèº üå∏ üë©‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! Today we will write a bootloader that will output ‚ÄúHello World‚Äù and run it on VirtualBox. We will write in assembler FASM. You can dow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We write an operating system. Part 1. Loader</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504634/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font><font style="vertical-align: inherit;">Today we will write a bootloader that will output ‚ÄúHello World‚Äù and run it on VirtualBox. </font><font style="vertical-align: inherit;">We will write in assembler FASM. </font><font style="vertical-align: inherit;">You can download it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We will also need </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UltraISO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Before writing code, we will understand how operating systems load.</font></font><br>
<br>
<p></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, when we press the large power button on our computer, the system starts, which is on any computer - BIOS (Basic Input / Output System or basic input / output system). </font><font style="vertical-align: inherit;">The BIOS task is:</font></font></p><p></p><a name="habracut"></a><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detect all connected devices and check their operability. </font><font style="vertical-align: inherit;">The POST program (Power On Self Test, power-on self-test) is responsible for this. </font><font style="vertical-align: inherit;">If vital iron is not detected, then the system speaker (if any) will squeak something incomprehensible and the download will not go further.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Provide the operating system with functions for working with hardware. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read the very first sector of the boot device into the zero segment of RAM at offset 0x7C00h and transfer control there. </font><font style="vertical-align: inherit;">1 sector on the disk is 512 bytes. </font><font style="vertical-align: inherit;">Therefore, our bootloader should not exceed 512 bytes. </font><font style="vertical-align: inherit;">The BIOS determines that the sector is bootable by the presence of 0x55 and 0xAA in its last two bytes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can start writing code. </font><font style="vertical-align: inherit;">Run the file FASMW.EXE, which is located in the archive with FASM, and insert the following code there:</font></font><br>
<br>
<pre><code class="actionscript hljs">org <span class="hljs-number">7</span>C00h<font></font>
<font></font>
 start:<font></font>
    cli              ;  (   )<font></font>
    xor ax, ax       ;  ax<font></font>
    mov ds, ax       ; dataSegment   <font></font>
    mov es, ax       ;  es   <font></font>
    mov ss, ax       ; StackSegment   <font></font>
    mov sp, <span class="hljs-number">07</span>C00h   ;    <font></font>
    sti              ; <font></font>
<font></font>
  ; <font></font>
  mov ax, <span class="hljs-number">3</span>
  int <span class="hljs-number">10</span>h<font></font>
<font></font>
  mov ah, <span class="hljs-number">2</span>h<font></font>
  mov dh, <span class="hljs-number">0</span>
  mov dl, <span class="hljs-number">0</span><font></font>
  xor bh, bh<font></font>
  int <span class="hljs-number">10</span>h<font></font>
<font></font>
  ; <font></font>
  mov ax, <span class="hljs-number">1301</span>h<font></font>
  mov bp, message<font></font>
  mov cx, <span class="hljs-number">12</span>
  mov bl, <span class="hljs-number">02</span>h<font></font>
  int <span class="hljs-number">10</span>h<font></font>
<font></font>
  jmp $<font></font>
<font></font>
message db <span class="hljs-string">'Hello World!'</span>,<span class="hljs-number">0</span><font></font>
<font></font>
times <span class="hljs-number">510</span> - ($ - $$) db <span class="hljs-number">0</span> ;     <span class="hljs-number">510</span>- <font></font>
db <span class="hljs-number">0x55</span>, <span class="hljs-number">0xAA</span> ;   
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code requires a little explanation. </font><font style="vertical-align: inherit;">The team</font></font><br>
<br>
<pre><code class="plaintext hljs">org 7C00h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 we say that the code needs to be loaded into RAM at 0x7C00. </font><font style="vertical-align: inherit;">In lines</font></font><br>
<br>
<pre><code class="plaintext hljs">  mov ax, 3<font></font>
  int 10h<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
we set the video mode to 80x25 (80 characters per line and 25 lines) and thereby clear the screen.</font></font><br>
<br>
<pre><code class="plaintext hljs">  mov ah, 2h<font></font>
  mov dh, 0<font></font>
  mov dl, 0<font></font>
  xor bh, bh<font></font>
  int 10h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we set the cursor. </font><font style="vertical-align: inherit;">The 2h interrupt 10h function is responsible for this. </font><font style="vertical-align: inherit;">In the register dh we put the coordinate of the cursor in Y, and in the register dl in X.</font></font><br>
<br>
<pre><code class="plaintext hljs">  mov ax, 1301h<font></font>
  mov bp, message<font></font>
  mov cx, 12<font></font>
  mov bl, 02h<font></font>
  int 10h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We print a line. </font><font style="vertical-align: inherit;">The 13h interrupt 10h function is responsible for this. </font><font style="vertical-align: inherit;">In the bp register we put the string itself, in the cx register the number of characters in the string, in the bl register the attribute, in our case the color, it will be green. </font><font style="vertical-align: inherit;">The first 4 bits affect the background color, the second 4 bits affect the text color. </font><font style="vertical-align: inherit;">Below is the color chart</font></font><br>
<br>
<pre><code class="plaintext hljs">0 - , 1 - , 2 - , 3 - , 4 - , 5 - , 6 - , 7 - -, 8 - -, 9 - -, A - -, B - -, C - -, D- -, E - -, F ‚Äì .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In line</font></font><br>
<br>
<pre><code class="plaintext hljs">jmp $</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program freezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We compile the code by pressing Ctrl + F9 and save the resulting file as boot.bin.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Launch UltraISO and drag our binary into a special area (marked with a red arrow). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/92/bm/cj/92bmcjm-xj4clxo-jeonckqpyp0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, right-click on the binarink and press the button with the following inscription: ‚ÄúInstall as boot file‚Äù. Next, save our file in ISO format. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open VIrtualBox and create a new virtual machine (if you don‚Äôt know how to do this, click </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). So, after you have created the virtual machine, click ‚ÄúConfigure, select the‚Äú Media ‚Äùitem, click on‚Äú Empty ‚Äù, where‚Äú Drive ‚Äùis the optical disk icon. We click on it and select ‚ÄúSelect Optical Disk Image‚Äù, look for our ISO file, click ‚ÄúOpen‚Äù. We save all the settings and start the virtual machine. Our ‚ÄúHello World!‚Äù Appears on the screen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x3/m8/qh/x3m8qhqve5i2larphfrcec6sz6g.jpeg"><br>
<br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this, the first issue comes to an end. </font><font style="vertical-align: inherit;">In the next part, we will teach our bootloader to read disk sectors and boot up its first kernel!</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504600/index.html">What awaits the airline after the crisis: Warren Buffett's opinion</a></li>
<li><a href="../en504602/index.html">Telemetr√≠a ‚Üí voltage free metrics</a></li>
<li><a href="../en504604/index.html">What is happening in the video services market today?</a></li>
<li><a href="../en504612/index.html">You May Not Need Svelte To Reduce Your JavaScript</a></li>
<li><a href="../en504622/index.html">What makes Rust a universal programming language</a></li>
<li><a href="../en504638/index.html">Shopify: who interviewed me for the Staff Engineer position? Junior?</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electr√≥nico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
<li><a href="../es486184/index.html">C√≥mo usar la b√∫squeda de manera efectiva</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>