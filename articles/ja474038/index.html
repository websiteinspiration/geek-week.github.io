<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖍️ 🖐🏼 ✊ 定期的なデータ更新 ‼️ 🔍 👨🏼‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私のコードが.NET Frameworkの仮想環境（マシン）で実行され、その結果、汎用オペレーティングシステムで実行されることをすぐに確認したいので、1〜2ミリ秒以内でも精度については触れません。それにもかかわらず、時間的な正確さを高めるために、私たちは自分の力であらゆることをしようとします。
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>定期的なデータ更新</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474038/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のコードが.NET Frameworkの仮想環境（マシン）で実行され、その結果、汎用オペレーティングシステムで実行されることをすぐに確認したいので、1〜2ミリ秒以内でも精度については触れません。それにもかかわらず、時間的な正確さを高めるために、私たちは自分の力であらゆることをしようとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、私たちのプログラムでは、特定の時間間隔で一部の情報を更新する必要があります。私の場合、それはIPカメラからのスナップショット（画像）の更新でした。多くの場合、アプリケーションのビジネスロジックは、データ更新の頻度に特定の制限を設定します。今回は1秒です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
額の解決策は、スナップショット要求の後にThread.Sleep（1000）/Task.Await（1000）をインストールすることです。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Getsnapshot</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> rnd = <span class="hljs-keyword">new</span> Random()
  <span class="hljs-keyword">var</span> sleepMs = rnd.Next(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);<font></font>
  Console.WriteLine(<span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now.ToString(<span class="hljs-string">"mm:ss.ff"</span>)}</span>] DoSomethink <span class="hljs-subst">{sleepMs}</span> ms"</span>);<font></font>
  Thread.Sleep(sleepMs);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
{<font></font>
  Getsnapshot();<font></font>
  Thread.Sleep(<span class="hljs-number">1000</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私たちの操作の期間は非決定的な量です。</font><font style="vertical-align: inherit;">したがって、スナップショットの模倣は次のようになります。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムを実行して出力を実行します</font></font><br>
<br>
<pre><code class="plaintext hljs">[15:10.39] DoSomethink 974 ms<font></font>
[15:12.39] DoSomethink 383 ms<font></font>
[15:13.78] DoSomethink 99 ms<font></font>
[15:14.88] DoSomethink 454 ms<font></font>
[15:16.33] DoSomethink 315 ms<font></font>
[15:17.65] DoSomethink 498 ms<font></font>
[15:19.15] DoSomethink 708 ms<font></font>
[15:20.86] DoSomethink 64 ms<font></font>
[15:21.92] DoSomethink 776 ms<font></font>
[15:23.70] DoSomethink 762 ms<font></font>
[15:25.46] DoSomethink 123 ms<font></font>
[15:26.59] DoSomethink 36 ms<font></font>
[15:27.62] DoSomethink 650 ms<font></font>
[15:29.28] DoSomethink 510 ms<font></font>
[15:30.79] DoSomethink 257 ms<font></font>
[15:32.04] DoSomethink 602 ms<font></font>
[15:33.65] DoSomethink 542 ms<font></font>
[15:35.19] DoSomethink 286 ms<font></font>
[15:36.48] DoSomethink 673 ms<font></font>
[15:38.16] DoSomethink 749 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見てわかるように、ラグが蓄積するため、アプリケーションのビジネスロジックに違反します。 </font></font><br>
<br>
<pre><code class="plaintext hljs">,      60   1      49.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
平均偏差を減らすことで、平均ラグを測定し、スリープ時間を減らすことができますが、この場合、ビジネスロジックが必要とするよりも多くのリクエストを取得できます。</font><font style="vertical-align: inherit;">要求が最大1秒まで完了すること、つまり必要な更新期間を確保するために何ミリ秒待つ必要があるかを知っているため、予測することはできません。</font></font><br>
<br>
<pre><code class="plaintext hljs">,      60   1     62.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明白な解決策はそれ自体を示唆しています。</font><font style="vertical-align: inherit;">手術前後の時間を測定します。</font><font style="vertical-align: inherit;">そして、それらの違いを計算します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
{<font></font>
   <span class="hljs-keyword">int</span> sleepMs = <span class="hljs-number">1000</span>; 
   <span class="hljs-keyword">var</span> watch = Stopwatch.StartNew();<font></font>
   watch.Start();<font></font>
   Getsnapshot();<font></font>
   watch.Stop();<font></font>
   <span class="hljs-keyword">int</span> needSleepMs = (<span class="hljs-keyword">int</span>)(sleepMs - watch.ElapsedMilliseconds);<font></font>
   Thread.Sleep(needSleepMs);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今すぐプログラムを実行してください。</font><font style="vertical-align: inherit;">運が良ければ、次のようなものが表示されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">[16:57.25] DoSomethink 789 ms<font></font>
[16:58.05] Need sleep 192 ms<font></font>
<font></font>
[16:58.25] DoSomethink 436 ms<font></font>
[16:58.68] Need sleep 564 ms<font></font>
<font></font>
[16:59.25] DoSomethink 810 ms<font></font>
[17:00.06] Need sleep 190 ms<font></font>
<font></font>
[17:00.25] DoSomethink 302 ms<font></font>
[17:00.55] Need sleep 697 ms<font></font>
<font></font>
[17:01.25] DoSomethink 819 ms<font></font>
[17:02.07] Need sleep 181 ms<font></font>
<font></font>
[17:02.25] DoSomethink 872 ms<font></font>
[17:03.13] Need sleep 128 ms<font></font>
<font></font>
[17:03.25] DoSomethink 902 ms<font></font>
[17:04.16] Need sleep 98 ms<font></font>
<font></font>
[17:04.26] DoSomethink 717 ms<font></font>
[17:04.97] Need sleep 282 ms<font></font>
<font></font>
[17:05.26] DoSomethink 14 ms<font></font>
[17:05.27] Need sleep 985 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ私は運が良かったのですか？ Watch.Start（）はDoSomethink（）の前に実行され、watch.Stop（）はDoSomethink（）の後に実行されるためです。これらの操作は瞬間的なものではありません+ランタイム環境自体はプログラム実行時間（x）の正確性を保証しません。したがって、オーバーヘッドが発生します。 DoSomethink（）関数は0〜1000ミリ秒（y）で実行されます。したがって、そのような場合にx + y&gt; 1000の場合に状況が発生する可能性があります</font></font><br>
<br>
<pre><code class="plaintext hljs"> int needSleepMs = (int)(sleepMs - watch.ElapsedMilliseconds);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thread.Sleep（）メソッドは負の値をとってはならないので、負の値を取り、ArgumentOutOfRangeExceptionを受け取ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような場合、needSleepMs時間を0に設定することは理にかなっています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、実際には、DoSomethink（）関数は必要なだけ実行でき、intにキャストすると変数オーバーフローが発生します。次に、睡眠時間</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
がsleepMsを超える場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは次のように修正できます。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> needSleepMs = sleepMs - watch.ElapsedMilliseconds;
<span class="hljs-keyword">if</span> (needSleepMs &gt; <span class="hljs-number">0</span> &amp;&amp; watch.ElapsedMilliseconds &lt;= sleepMs)<font></font>
{<font></font>
   needSleepMs = (<span class="hljs-keyword">int</span>)needSleepMs;<font></font>
}<font></font>
<span class="hljs-keyword">else</span><font></font>
{<font></font>
  needSleepMs = <span class="hljs-number">0</span>; <font></font>
}<font></font>
Thread.Sleep(needSleepMs);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、すべての準備が整っています。</font><font style="vertical-align: inherit;">ただし、このアプローチを1か所でも使用すると、プログラマーの目に不快感を与えます。</font><font style="vertical-align: inherit;">そして、プログラムにそのような場所が数十ある場合、コードは読み取り不可能なヒープになります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この状況を修正するために、コードを関数にカプセル化します。</font><font style="vertical-align: inherit;">ここでは、別のクラスに配置するか、クラスの通常のメソッドとしてGlobalを使用して静的（マイバージョン）として使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、簡単にするためにそのままにして、Programクラスに残します</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">NeedWaitMs</span>(<span class="hljs-params">Action before, <span class="hljs-keyword">int</span> sleepMs</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> watch = Stopwatch.StartNew();<font></font>
  watch.Start();<font></font>
  before();<font></font>
  watch.Stop();<font></font>
  <span class="hljs-keyword">var</span> needSleepMs = sleepMs - watch.ElapsedMilliseconds;
  <span class="hljs-keyword">if</span> (needSleepMs &gt; <span class="hljs-number">0</span> &amp;&amp; watch.ElapsedMilliseconds &lt;= sleepMs) 
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>) needSleepMs;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
 }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入力関数は、実行する関数へのリンクと、待機時間を受け入れます。</font><font style="vertical-align: inherit;">そして、プログラムがスリープする時間を返します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使いやすくするために、匿名のラムダ関数を関数に渡すこともできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムの完全なリストを以下に示します。</font></font><br>
 <br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Threading;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">ConsoleApp2</span><font></font>
{<font></font>
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Getsnapshot</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> rnd = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-keyword">var</span> sleepMs = rnd.Next(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);<font></font>
            Console.WriteLine(<span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now.ToString(<span class="hljs-string">"mm:ss.ff"</span>)}</span>] DoSomethink <span class="hljs-subst">{sleepMs}</span> ms"</span>);<font></font>
            Thread.Sleep(sleepMs);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> sleepMs = NeedWaitMs(Getsnapshot, <span class="hljs-number">1000</span>);<font></font>
                Console.WriteLine(<span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now.ToString(<span class="hljs-string">"mm:ss.ff"</span>)}</span>] Need sleep <span class="hljs-subst">{sleepMs}</span> ms <span class="hljs-subst">{Environment.NewLine}</span>"</span>);<font></font>
                Thread.Sleep(sleepMs);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">NeedWaitMs</span>(<span class="hljs-params">Action before, <span class="hljs-keyword">int</span> sleepMs</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> watch = Stopwatch.StartNew();<font></font>
            before();<font></font>
            watch.Stop();<font></font>
            <span class="hljs-keyword">var</span> needSleepMs = sleepMs - watch.ElapsedMilliseconds;
            <span class="hljs-keyword">return</span> needSleepMs &gt; <span class="hljs-number">0</span> ? (<span class="hljs-keyword">int</span>) needSleepMs : <span class="hljs-number">0</span>;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja474024/index.html">私たちはロボット掃除機を普遍的な兵士に変えます</a></li>
<li><a href="../ja474026/index.html">消費者物語、アソスは雑誌とTikTokを放棄</a></li>
<li><a href="../ja474028/index.html">開発者にはどのようなソフトスキルが必要ですか？Yandexからの意見</a></li>
<li><a href="../ja474032/index.html">標準セルの配置（部外者からのメモ）</a></li>
<li><a href="../ja474036/index.html">テキスト編集も嫌い</a></li>
<li><a href="../ja474040/index.html">プレイボーイインタビュー：スティーブジョブズ、パート1</a></li>
<li><a href="../ja474042/index.html">コンテスト！サーバーのちらつきに照らしたストーリー...</a></li>
<li><a href="../ja474046/index.html">クラウドサービス、AI、ブロックチェーン、データサイエンス、マイクロサービスに関するワークショップ：現在モスクワとサンクトペテルブルクで</a></li>
<li><a href="../ja474048/index.html">HILDACRYPT：新しいランサムウェアがバックアップシステムとアンチウイルスソリューションを攻撃します</a></li>
<li><a href="../ja474050/index.html">音楽業界のスターである場合、アプリケーションを取得して実行することはできません</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>