<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌳 🙋🏿 🚋 Asynchrone Jobs in Django mit Sellerie ✈️ 🎆 🚽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor Beginn des Python Web Developer- Kurses wurde eine Übersetzung des Artikels erstellt .
 
 
 Wenn Ihre Anwendung einen längeren Prozess hat, können...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Asynchrone Jobs in Django mit Sellerie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/503380/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vor Beginn des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Web Developer-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kurses wurde eine Übersetzung des Artikels erstellt </font><font style="vertical-align: inherit;">.</font></font></b></i><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Wenn Ihre Anwendung einen längeren Prozess hat, können Sie ihn nicht im Standard-Anforderungs- / Antwort-Stream, sondern im Hintergrund verarbeiten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Ihrer Anwendung muss der Benutzer beispielsweise ein Miniaturbild senden (das höchstwahrscheinlich bearbeitet werden muss) und die E-Mail-Adresse bestätigen. Wenn Ihre Anwendung das Bild verarbeitet und dann eine E-Mail zur Bestätigung im Anforderungshandler sendet, muss der Endbenutzer aus irgendeinem Grund warten, um beide Aufgaben auszuführen, bevor er die Seite neu lädt oder schließt. Stattdessen können Sie diese Vorgänge in die Aufgabenwarteschlange übertragen und sie einem separaten Prozess zur Verarbeitung überlassen, um sofort eine Antwort an den Benutzer zu senden. In diesem Fall kann der Endbenutzer während der Verarbeitung im Hintergrund andere Aufgaben auf der Clientseite ausführen. In diesem Fall kann Ihre Anwendung auch frei auf Anfragen anderer Benutzer und Clients reagieren.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute werden wir über den Prozess des Einrichtens und Konfigurierens von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sellerie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und Redis </font><font style="vertical-align: inherit;">sprechen </font><font style="vertical-align: inherit;">, um lang laufende Prozesse in einer Django-Anwendung zu handhaben und solche Probleme zu lösen. </font><font style="vertical-align: inherit;">Wir werden auch Docker und Docker Compose verwenden, um alle Teile zusammenzufügen und zu sehen, wie Sellerie-Jobs mit Unit- und Integrationstests getestet werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende dieses Handbuchs werden wir lernen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrieren Sie Sellerie in Django, um Hintergrundjobs zu erstellen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pack Django, Sellerie und Redis mit Docker.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Führen Sie Prozesse im Hintergrund mit einem separaten Workflow aus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speichern Sie Sellerieprotokolle in einer Datei.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Richten Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flower ein</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um Selleriejobs und -arbeiter zu überwachen und zu verwalten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testen Sie Sellerie-Jobs mit Unit- und Integrationstests.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrundaufgaben</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Benutzererfahrung zu verbessern, sollten lange Prozesse im Hintergrund außerhalb des normalen HTTP-Anforderungs- / Antwortstroms ausgeführt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden von Briefen zur Bestätigung;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web-Scaping und Crawlen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenanalyse;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bildverarbeitung;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berichterstellung.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen Sie beim Erstellen einer Anwendung, Aufgaben, die während der Laufzeit der Anforderung / Antwort ausgeführt werden sollen, z. B. CRUD-Vorgänge, von Aufgaben zu trennen, die im Hintergrund ausgeführt werden sollen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Arbeitsprozess</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Ziel ist es, eine Django-Anwendung zu entwickeln, die Sellerie verwendet, um langwierige Prozesse außerhalb des Anforderungs- / Antwortzyklus abzuwickeln. </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Endbenutzer generiert einen neuen Job, indem er eine POST-Anforderung an den Server sendet. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In dieser Ansicht wird der Job zur Warteschlange hinzugefügt und die Job-ID an den Client zurückgesendet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit AJAX fragt der Client den Server weiterhin ab, um den Status des Jobs zu überprüfen, während der Job selbst im Hintergrund ausgeführt wird. </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/b2/y6/yg/b2y6ygxu5tpveo-d-3e0xe0vki4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projekterstellung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Klonen Sie </font><font style="vertical-align: inherit;">das Projekt aus der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">django-Sellerie - </font><font style="vertical-align: inherit;">Repository</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und macht eine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kasse</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v1</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Tag </font><font style="vertical-align: inherit;">in dem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Zweig </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs">$ git clone https://github.com/testdrivenio/django-celery --branch v1 --single-branch<font></font>
$ cd django-celery<font></font>
$ git checkout v1 -b master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Da wir insgesamt mit drei Prozessen arbeiten müssen (Django, Redis, Worker), verwenden wir Docker, um die Arbeit zu vereinfachen und sie zu verbinden, sodass wir alles mit einem Befehl in einem Terminalfenster ausführen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie im Projektstamm Bilder und starten Sie Docker-Container:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Wenn der Build abgeschlossen ist, gehen Sie zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1337: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mh/-_/7v/mh-_7vconirpvd-wvqjn0jtsxu4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Stellen Sie sicher, dass die Tests erfolgreich bestanden wurden:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose <span class="hljs-keyword">exec</span> web python -m pytest<font></font>
<font></font>
======================================== test session starts ========================================<font></font>
platform linux -- Python <span class="hljs-number">3.8</span><span class="hljs-number">.2</span>, pytest<span class="hljs-number">-5.4</span><span class="hljs-number">.1</span>, py<span class="hljs-number">-1.8</span><span class="hljs-number">.1</span>, pluggy<span class="hljs-number">-0.13</span><span class="hljs-number">.1</span>
django: settings: core.settings (<span class="hljs-keyword">from</span> ini)<font></font>
rootdir: /usr/src/app, inifile: pytest.ini<font></font>
plugins: django<span class="hljs-number">-3.8</span><span class="hljs-number">.0</span>
collected <span class="hljs-number">1</span> item<font></font>
<font></font>
tests/test_tasks.py .                                                                         [<span class="hljs-number">100</span>%]<font></font>
<font></font>
========================================= <span class="hljs-number">1</span> passed <span class="hljs-keyword">in</span> <span class="hljs-number">0.47</span>s =========================================</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns die Struktur des Projekts an, bevor wir fortfahren:</font></font><br>
<br>
<pre><code class="python hljs">├── .gitignore<font></font>
├── LICENSE<font></font>
├── README.md<font></font>
├── docker-compose.yml<font></font>
└── project<font></font>
    ├── Dockerfile<font></font>
    ├── core<font></font>
    │   ├── __init__.py<font></font>
    │   ├── asgi.py<font></font>
    │   ├── settings.py<font></font>
    │   ├── urls.py<font></font>
    │   └── wsgi.py<font></font>
    ├── entrypoint.sh<font></font>
    ├── manage.py<font></font>
    ├── pytest.ini<font></font>
    ├── requirements.txt<font></font>
    ├── static<font></font>
    │   ├── bulma.min.css<font></font>
    │   ├── jquery<span class="hljs-number">-3.4</span><span class="hljs-number">.1</span>.min.js<font></font>
    │   ├── main.css<font></font>
    │   └── main.js<font></font>
    ├── tasks<font></font>
    │   ├── __init__.py<font></font>
    │   ├── apps.py<font></font>
    │   ├── migrations<font></font>
    │   │   └── __init__.py<font></font>
    │   ├── templates<font></font>
    │   │   └── home.html<font></font>
    │   └── views.py<font></font>
    └── tests<font></font>
        ├── __init__.py<font></font>
        └── test_tasks.py<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jobstart</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Ereignishandler ist </font></font><code>project/static/main.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">per Knopfdruck abonniert. </font><font style="vertical-align: inherit;">Durch einen </font><font style="vertical-align: inherit;">Klick auf dem Server sendet eine AJAX - </font><font style="vertical-align: inherit;">POST-Anfrage mit dem entsprechenden Auftragstyp: </font></font><code>1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder </font></font><code>3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs">$(<span class="hljs-string">'.button'</span>).on(<span class="hljs-string">'click'</span>, function() {<font></font>
  $.ajax({<font></font>
    url: <span class="hljs-string">'/tasks/'</span>,<font></font>
    data: { type: $(this).data(<span class="hljs-string">'type'</span>) },<font></font>
    method: <span class="hljs-string">'POST'</span>,<font></font>
  })<font></font>
  .done((res) =&gt; {<font></font>
    getStatus(res.task_id);<font></font>
  })<font></font>
  .fail((err) =&gt; {<font></font>
    console.log(err);<font></font>
  });<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Serverseite wurde bereits eine Ansicht konfiguriert, um die Anforderung zu verarbeiten in </font></font><code>project/tasks/views.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_task</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-keyword">if</span> request.POST:<font></font>
        task_type = request.POST.get(<span class="hljs-string">"type"</span>)
        <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"task_type"</span>: task_type}, status=<span class="hljs-number">202</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt beginnt der Spaß: Wir binden Sellerie!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sellerie-Setup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit dem Hinzufügen von Sellerie und Redis zur Datei </font></font><code>project/requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs">celery==<span class="hljs-number">4.4</span><span class="hljs-number">.1</span>
Django==<span class="hljs-number">3.0</span><span class="hljs-number">.4</span>
redis==<span class="hljs-number">3.4</span><span class="hljs-number">.1</span><font></font>
<font></font>
pytest==<span class="hljs-number">5.4</span><span class="hljs-number">.1</span>
pytest-django==<span class="hljs-number">3.8</span><span class="hljs-number">.0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Celery verwendet einen </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachrichtenbroker</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS Simple Queue Service (SQS)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -, um die Kommunikation zwischen Celery Worker und Webanwendung zu vereinfachen. </font><font style="vertical-align: inherit;">Nachrichten werden an den Broker gesendet und dann vom Mitarbeiter verarbeitet. </font><font style="vertical-align: inherit;">Danach werden die Ergebnisse an das Backend gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis wird sowohl ein Broker als auch ein Backend sein. </font><font style="vertical-align: inherit;">Fügen Sie der Datei Redis und Celery Worker </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie folgt hinzu:</font></font><br>
<br>
<pre><code class="python hljs">version: <span class="hljs-string">'3.7'</span><font></font>
<font></font>
services:<font></font>
  web:<font></font>
    build: ./project<font></font>
    command: python manage.py runserver <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8000</span><font></font>
    volumes:<font></font>
      - ./project:/usr/src/app/<font></font>
    ports:<font></font>
      - <span class="hljs-number">1337</span>:<span class="hljs-number">8000</span><font></font>
    environment:<font></font>
      - DEBUG=<span class="hljs-number">1</span>
      - SECRET_KEY=dbaa1_i7%*<span class="hljs-number">3</span>r9-=z-+_mz4r-!qeed@(-a_r(g@k8jo8y3r27%m<font></font>
      - DJANGO_ALLOWED_HOSTS=localhost <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> [::<span class="hljs-number">1</span>]<font></font>
      - CELERY_BROKER=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span>
      - CELERY_BACKEND=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span><font></font>
    depends_on:<font></font>
      - redis<font></font>
<font></font>
  celery:<font></font>
    build: ./project<font></font>
    command: celery worker --app=core --loglevel=info<font></font>
    volumes:<font></font>
      - ./project:/usr/src/app<font></font>
    environment:<font></font>
      - DEBUG=<span class="hljs-number">1</span>
      - SECRET_KEY=dbaa1_i7%*<span class="hljs-number">3</span>r9-=z-+_mz4r-!qeed@(-a_r(g@k8jo8y3r27%m<font></font>
      - DJANGO_ALLOWED_HOSTS=localhost <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> [::<span class="hljs-number">1</span>]<font></font>
      - CELERY_BROKER=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span>
      - CELERY_BACKEND=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span><font></font>
    depends_on:<font></font>
      - web<font></font>
      - redis<font></font>
<font></font>
  redis:<font></font>
    image: redis:<span class="hljs-number">5</span>-alpine</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Achten Sie auf </font></font><code>celery worker --app=core --loglevel=info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ol>
<li><code>celery worker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verwendet, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um Sellerie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arbeiter </font><font style="vertical-align: inherit;">zu </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">starten</font></a><font style="vertical-align: inherit;"> ;</font></font></li>
<li><code>--app=core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird verwendet, um </font></font><code>core</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sellerie- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Anwendung</font></a><font style="vertical-align: inherit;"> zu starten </font><font style="vertical-align: inherit;">(die wir in Kürze definieren werden);</font></font></li>
<li><code>--loglevel=info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bestimmt den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grad der</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Informationsprotokollierung.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie dem Projekteinstellungsmodul Folgendes hinzu, damit Celery Redis als Broker und Backend verwendet: </font></font><br>
<br>
<pre><code class="python hljs">CELERY_BROKER_URL = os.environ.get(<span class="hljs-string">"CELERY_BROKER"</span>, <span class="hljs-string">"redis://redis:6379/0"</span>)<font></font>
CELERY_RESULT_BACKEND = os.environ.get(<span class="hljs-string">"CELERY_BROKER"</span>, <span class="hljs-string">"redis://redis:6379/0"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie dann die Datei </font></font><code>sample_tasks.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>project/tasks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
Hier haben </font><font style="vertical-align: inherit;">wir </font><font style="vertical-align: inherit;">mit dem Dekorator </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;">shared_task</font></i></a><font style="vertical-align: inherit;"> eine neue Sellerie- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;">Taskfunktion</font></i></a><font style="vertical-align: inherit;"> namens definiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Denken Sie daran, dass die Aufgabe selbst nicht vom Django-Prozess ausgeführt wird, sondern vom Sellerie-Arbeiter. </font><font style="vertical-align: inherit;">
Fügen Sie nun die Datei hinzu </font><font style="vertical-align: inherit;">zu </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<code># project/tasks/sample_tasks.py<br>
<br>
import time<br>
<br>
from celery import shared_task<br>
<br>
@shared_task<br>
def create_task(task_type):<br>
 time.sleep(int(task_type) * 10)<br>
 return True</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;"></font></i></a><font style="vertical-align: inherit;"></font><code>create_task</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>celery.py</code><font style="vertical-align: inherit;"></font><code>"project/core"</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> os<font></font>
<font></font>
<span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery<font></font>
<font></font>
<font></font>
os.environ.setdefault(<span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span>, <span class="hljs-string">"core.settings"</span>)<font></font>
app = Celery(<span class="hljs-string">"core"</span>)<font></font>
app.config_from_object(<span class="hljs-string">"django.conf:settings"</span>, namespace=<span class="hljs-string">"CELERY"</span>)<font></font>
app.autodiscover_tasks()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist denn hier los?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zuerst müssen Sie den Standardwert für die Umgebung festlegen, </font></font><code>DJANGO_SETTINGS_MODULE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">damit Sellerie weiß, wie das Django-Projekt gefunden wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann haben wir eine Instanz von Sellerie mit einem Namen erstellt </font></font><code>core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und in eine Variable eingefügt </font></font><code>app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann haben wir Sellerie-Konfigurationswerte aus dem Einstellungsobjekt von geladen </font></font><code>django.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir haben </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namespace = "CELERY" verwendet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um Konflikte mit anderen Django-Einstellungen zu vermeiden. </font><font style="vertical-align: inherit;">Daher müssen alle Konfigurationseinstellungen für Sellerie mit einem Präfix beginnen </font></font><code>CELERY_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zuletzt </font></font><code>app.autodiscover_tasks()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weist Celery an, nach Jobs in den in definierten Anwendungen zu suchen </font></font><code>settings.INSTALLED_APPS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ändern Sie dies </font></font><code>project/core/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so, dass die Sellerie-Anwendung beim Starten von Django automatisch importiert wird:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> .celery <span class="hljs-keyword">import</span> app <span class="hljs-keyword">as</span> celery_app<font></font>
<font></font>
<font></font>
__all__ = (<span class="hljs-string">"celery_app"</span>,)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jobstart</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie die Ansicht, um den Job zu starten und die ID zu senden:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@csrf_exempt</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_task</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-keyword">if</span> request.POST:<font></font>
        task_type = request.POST.get(<span class="hljs-string">"type"</span>)<font></font>
        task = create_task.delay(int(task_type))<font></font>
        <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"task_id"</span>: task.id}, status=<span class="hljs-number">202</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht, die Aufgabe zu importieren:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> tasks.sample_tasks <span class="hljs-keyword">import</span> create_task</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sammeln Sie Bilder und stellen Sie neue Container bereit:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie wie folgt vor, um eine neue Aufgabe zu starten: </font></font><br>
<br>
<pre><code class="python hljs">$ curl -F type=<span class="hljs-number">0</span> http://localhost:<span class="hljs-number">1337</span>/tasks/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie werden so etwas sehen:</font></font><br>
<br>
<pre><code class="python hljs">{
  <span class="hljs-string">"task_id"</span>: <span class="hljs-string">"6f025ed9-09be-4cbb-be10-1dce919797de"</span>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beruflicher Status</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zurück zum clientseitigen Ereignishandler:</font></font><br>
<br>
<pre><code class="python hljs">$(<span class="hljs-string">'.button'</span>).on(<span class="hljs-string">'click'</span>, function() {<font></font>
  $.ajax({<font></font>
    url: <span class="hljs-string">'/tasks/'</span>,<font></font>
    data: { type: $(this).data(<span class="hljs-string">'type'</span>) },<font></font>
    method: <span class="hljs-string">'POST'</span>,<font></font>
  })<font></font>
  .done((res) =&gt; {<font></font>
    getStatus(res.task_id);<font></font>
  })<font></font>
  .fail((err) =&gt; {<font></font>
    console.log(err);<font></font>
  });<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Antwort von der AJAX-Anfrage zurückkommt, senden wir </font></font><code>getStatus()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jede Sekunde von der Job-ID:</font></font><br>
<br>
<pre><code class="python hljs">function getStatus(taskID) {<font></font>
  $.ajax({<font></font>
    url: `/tasks/${taskID}/`,<font></font>
    method: <span class="hljs-string">'GET'</span><font></font>
  })<font></font>
  .done((res) =&gt; {<font></font>
    const html = `<font></font>
      &lt;tr&gt;<font></font>
        &lt;td&gt;${res.task_id}&lt;/td&gt;<font></font>
        &lt;td&gt;${res.task_status}&lt;/td&gt;<font></font>
        &lt;td&gt;${res.task_result}&lt;/td&gt;<font></font>
      &lt;/tr&gt;`<font></font>
    $(<span class="hljs-string">'#tasks'</span>).prepend(html);<font></font>
<font></font>
    const taskStatus = res.task_status;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (taskStatus === <span class="hljs-string">'SUCCESS'</span> || taskStatus === <span class="hljs-string">'FAILURE'</span>) <span class="hljs-keyword">return</span> false;<font></font>
    setTimeout(function() {<font></font>
      getStatus(res.task_id);<font></font>
    }, <span class="hljs-number">1000</span>);<font></font>
  })<font></font>
  .fail((err) =&gt; {<font></font>
    console.log(err)<font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Antwort Ja lautet, wird der DOM-Tabelle eine neue Zeile hinzugefügt. </font><font style="vertical-align: inherit;">Aktualisieren Sie die Ansicht </font></font><code>get_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um den Status zurückzugeben:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@csrf_exempt</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_status</span>(<span class="hljs-params">request, task_id</span>):</span><font></font>
    task_result = AsyncResult(task_id)<font></font>
    result = {<font></font>
        <span class="hljs-string">"task_id"</span>: task_id,
        <span class="hljs-string">"task_status"</span>: task_result.status,
        <span class="hljs-string">"task_result"</span>: task_result.result<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> JsonResponse(result, status=<span class="hljs-number">200</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Import </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncResult</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> celery.result <span class="hljs-keyword">import</span> AsyncResult</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Container aktualisieren:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie eine neue Aufgabe aus:</font></font><br>
<br>
<pre><code class="python hljs">$ curl -F type=<span class="hljs-number">1</span> http://localhost:<span class="hljs-number">1337</span>/tasks/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Extrahieren Sie dann </font></font><code>task_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus der Antwort und rufen Sie aktualisiert </font></font><code>get_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an, um den Status anzuzeigen:</font></font><br>
<br>
<pre><code class="python hljs">$ curl http://localhost:<span class="hljs-number">1337</span>/tasks/<span class="hljs-number">25278457</span><span class="hljs-number">-0957</span><span class="hljs-number">-4</span>b0b-b1da<span class="hljs-number">-2600525</span>f812f/<font></font>
<font></font>
{<font></font>
    <span class="hljs-string">"task_id"</span>: <span class="hljs-string">"25278457-0957-4b0b-b1da-2600525f812f"</span>,
    <span class="hljs-string">"task_status"</span>: <span class="hljs-string">"SUCCESS"</span>,
    <span class="hljs-string">"task_result"</span>: true<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können die gleichen Informationen im Browser sehen:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/an/cp/mi/ancpmi-ui-ijtjvl3h5ldomoh9a.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokolle Sellerie</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie </font><font style="vertical-align: inherit;">den Dienst </font></font><code>celery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Weise , </font><font style="vertical-align: inherit;">dass Sellerie in einer separaten Datei abmeldet:</font></font><br>
<br>
<pre><code class="python hljs">celery:<font></font>
  build: ./project<font></font>
  command: celery worker --app=core --loglevel=info --logfile=logs/celery.log<font></font>
  volumes:<font></font>
    - ./project:/usr/src/app<font></font>
  environment:<font></font>
    - DEBUG=<span class="hljs-number">1</span>
    - SECRET_KEY=dbaa1_i7%*<span class="hljs-number">3</span>r9-=z-+_mz4r-!qeed@(-a_r(g@k8jo8y3r27%m<font></font>
    - DJANGO_ALLOWED_HOSTS=localhost <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> [::<span class="hljs-number">1</span>]<font></font>
    - CELERY_BROKER=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span>
    - CELERY_BACKEND=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span><font></font>
  depends_on:<font></font>
    - web<font></font>
    - redis<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Projekt"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ein neues Verzeichnis hinzu </font><font style="vertical-align: inherit;">und nennen Sie es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Protokolle"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Fügen Sie dann die Datei in dieses neue Verzeichnis ein </font></font><code>celery.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie sollten sehen, wie die Protokolldatei nach dem Einstellen des </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volumes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lokal gefüllt wird </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs">[<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-25</span> <span class="hljs-number">19</span>:<span class="hljs-number">42</span>:<span class="hljs-number">29</span>,<span class="hljs-number">586</span>: INFO/MainProcess] Connected to redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span>
[<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-25</span> <span class="hljs-number">19</span>:<span class="hljs-number">42</span>:<span class="hljs-number">29</span>,<span class="hljs-number">599</span>: INFO/MainProcess] mingle: searching <span class="hljs-keyword">for</span> neighbors<font></font>
[<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-25</span> <span class="hljs-number">19</span>:<span class="hljs-number">42</span>:<span class="hljs-number">30</span>,<span class="hljs-number">635</span>: INFO/MainProcess] mingle: all alone<font></font>
[<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-25</span> <span class="hljs-number">19</span>:<span class="hljs-number">42</span>:<span class="hljs-number">30</span>,<span class="hljs-number">664</span>: WARNING/MainProcess]<font></font>
    /usr/local/lib/python3<span class="hljs-number">.8</span>/site-packages/celery/fixups/django.py:<span class="hljs-number">202</span>:<font></font>
    UserWarning: Using settings.DEBUG leads to a memory<font></font>
    leak, never use this setting <span class="hljs-keyword">in</span> production environments!<font></font>
    warnings.warn(<span class="hljs-string">'''Using settings.DEBUG leads to a memory
[2020-03-25 19:42:30,667: INFO/MainProcess] celery@6d060151bfeb ready.
[2020-03-25 19:43:07,103: INFO/MainProcess]
    Received task: tasks.sample_tasks.create_task[632792bb-5030-4f03-a0d8-e91979279729]
[2020-03-25 19:43:17,099: INFO/ForkPoolWorker-2]
    Task tasks.sample_tasks.create_task[632792bb-5030-4f03-a0d8-e91979279729]
    succeeded in 10.027462100006233s: True</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blumen-Dashboard </font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flower</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein leichtes webbasiertes Tool zur Überwachung von Sellerie in Echtzeit. </font><font style="vertical-align: inherit;">Sie können beispielsweise laufende Aufgaben verfolgen, den Mitarbeiterpool vergrößern oder verkleinern, Diagramme und Statistiken anzeigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie es hinzu </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs">celery==<span class="hljs-number">4.4</span><span class="hljs-number">.1</span>
Django==<span class="hljs-number">3.0</span><span class="hljs-number">.4</span>
flower==<span class="hljs-number">0.9</span><span class="hljs-number">.3</span>
redis==<span class="hljs-number">3.4</span><span class="hljs-number">.1</span><font></font>
<font></font>
pytest==<span class="hljs-number">5.4</span><span class="hljs-number">.1</span>
pytest-django==<span class="hljs-number">3.8</span><span class="hljs-number">.0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie dann den neuen Dienst hinzu zu </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs">dashboard:<font></font>
  build: ./project<font></font>
  command:  flower -A core --port=<span class="hljs-number">5555</span> --broker=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span><font></font>
  ports:<font></font>
    - <span class="hljs-number">5555</span>:<span class="hljs-number">5555</span><font></font>
  environment:<font></font>
    - DEBUG=<span class="hljs-number">1</span>
    - SECRET_KEY=dbaa1_i7%*<span class="hljs-number">3</span>r9-=z-+_mz4r-!qeed@(-a_r(g@k8jo8y3r27%m<font></font>
    - DJANGO_ALLOWED_HOSTS=localhost <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> [::<span class="hljs-number">1</span>]<font></font>
    - CELERY_BROKER=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span>
    - CELERY_BACKEND=redis://redis:<span class="hljs-number">6379</span>/<span class="hljs-number">0</span><font></font>
  depends_on:<font></font>
    - web<font></font>
    - redis<font></font>
    - celery</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und testen:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 5555, um das Dashboard anzuzeigen. </font><font style="vertical-align: inherit;">Sie sollten einen Mitarbeiter sehen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tk/pt/8s/tkpt8s4bzsfr1wbfdxzprkxzl4a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie einige weitere Aufgaben aus, um das Dashboard zu testen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ew/nt/hv/ewnthv7zl61ltov-7-tf0xnupi0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie weitere Mitarbeiter hinzu und sehen Sie, wie sich dies auf die Leistung auswirkt:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up -d --build --scale celery=<span class="hljs-number">3</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit dem einfachsten Test:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_task</span>():</span>
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">3</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie den obigen Testfall hinzu </font></font><code>project/tests/test_tasks.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und fügen Sie den folgenden Import hinzu:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> tasks <span class="hljs-keyword">import</span> sample_tasks</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie diesen Test aus:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose <span class="hljs-keyword">exec</span> web python -m pytest -k <span class="hljs-string">"test_task and not test_home"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Test dauert ungefähr eine Minute:</font></font><br>
<br>
<pre><code class="python hljs">======================================== test session starts ========================================<font></font>
platform linux -- Python <span class="hljs-number">3.8</span><span class="hljs-number">.2</span>, pytest<span class="hljs-number">-5.4</span><span class="hljs-number">.1</span>, py<span class="hljs-number">-1.8</span><span class="hljs-number">.1</span>, pluggy<span class="hljs-number">-0.13</span><span class="hljs-number">.1</span>
django: settings: core.settings (<span class="hljs-keyword">from</span> ini)<font></font>
rootdir: /usr/src/app, inifile: pytest.ini<font></font>
plugins: django<span class="hljs-number">-3.8</span><span class="hljs-number">.0</span>, celery<span class="hljs-number">-4.4</span><span class="hljs-number">.1</span>
collected <span class="hljs-number">2</span> items / <span class="hljs-number">1</span> deselected / <span class="hljs-number">1</span> selected<font></font>
<font></font>
tests/test_tasks.py .                                                                         [<span class="hljs-number">100</span>%]<font></font>
<font></font>
============================ <span class="hljs-number">1</span> passed, <span class="hljs-number">1</span> deselected <span class="hljs-keyword">in</span> <span class="hljs-number">62.43</span>s (<span class="hljs-number">0</span>:<span class="hljs-number">01</span>:<span class="hljs-number">02</span>) =============================</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist erwähnenswert, dass wir in den obigen Aussagen </font></font><code>.run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stattdessen </font><font style="vertical-align: inherit;">die Methode </font><font style="vertical-align: inherit;">verwendet haben </font></font><code>.delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um Aufgaben direkt zu starten, ohne Sellerie-Arbeiter zu verwenden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Möchten Sie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mock-Plugins verwenden</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um die Dinge zu beschleunigen?</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@patch('tasks.sample_tasks.create_task.run')</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_mock_task</span>(<span class="hljs-params">mock_run</span>):</span>
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">1</span>)<font></font>
    sample_tasks.create_task.run.assert_called_once_with(<span class="hljs-number">1</span>)<font></font>
<font></font>
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run.call_count == <span class="hljs-number">2</span><font></font>
<font></font>
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run(<span class="hljs-number">3</span>)
    <span class="hljs-keyword">assert</span> sample_tasks.create_task.run.call_count == <span class="hljs-number">3</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Importieren:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch, call</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prüfung:</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose <span class="hljs-keyword">exec</span> web python -m pytest -k <span class="hljs-string">"test_mock_task"</span><font></font>
<font></font>
======================================== test session starts ========================================<font></font>
platform linux -- Python <span class="hljs-number">3.8</span><span class="hljs-number">.2</span>, pytest<span class="hljs-number">-5.4</span><span class="hljs-number">.1</span>, py<span class="hljs-number">-1.8</span><span class="hljs-number">.1</span>, pluggy<span class="hljs-number">-0.13</span><span class="hljs-number">.1</span>
django: settings: core.settings (<span class="hljs-keyword">from</span> ini)<font></font>
rootdir: /usr/src/app, inifile: pytest.ini<font></font>
plugins: django<span class="hljs-number">-3.8</span><span class="hljs-number">.0</span>, celery<span class="hljs-number">-4.4</span><span class="hljs-number">.1</span>
collected <span class="hljs-number">3</span> items / <span class="hljs-number">2</span> deselected / <span class="hljs-number">1</span> selected<font></font>
<font></font>
tests/test_tasks.py .                                                                         [<span class="hljs-number">100</span>%]<font></font>
<font></font>
================================== <span class="hljs-number">1</span> passed, <span class="hljs-number">2</span> deselected <span class="hljs-keyword">in</span> <span class="hljs-number">1.13</span>s ==================================</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sehen? </font><font style="vertical-align: inherit;">Jetzt viel schneller! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist mit vollständigen Integrationstests?</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_task_status</span>(<span class="hljs-params">client</span>):</span>
    response = client.post(reverse(<span class="hljs-string">"run_task"</span>), {<span class="hljs-string">"type"</span>: <span class="hljs-number">0</span>})<font></font>
    content = json.loads(response.content)<font></font>
    task_id = content[<span class="hljs-string">"task_id"</span>]
    <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">202</span>
    <span class="hljs-keyword">assert</span> task_id<font></font>
<font></font>
    response = client.get(reverse(<span class="hljs-string">"get_status"</span>, args=[task_id]))<font></font>
    content = json.loads(response.content)<font></font>
    <span class="hljs-keyword">assert</span> content == {<span class="hljs-string">"task_id"</span>: task_id, <span class="hljs-string">"task_status"</span>: <span class="hljs-string">"PENDING"</span>, <span class="hljs-string">"task_result"</span>: <span class="hljs-literal">None</span>}
    <span class="hljs-keyword">assert</span> response.status_code == <span class="hljs-number">200</span><font></font>
<font></font>
    <span class="hljs-keyword">while</span> content[<span class="hljs-string">"task_status"</span>] == <span class="hljs-string">"PENDING"</span>:<font></font>
        response = client.get(reverse(<span class="hljs-string">"get_status"</span>, args=[task_id]))<font></font>
        content = json.loads(response.content)<font></font>
    <span class="hljs-keyword">assert</span> content == {<span class="hljs-string">"task_id"</span>: task_id, <span class="hljs-string">"task_status"</span>: <span class="hljs-string">"SUCCESS"</span>, <span class="hljs-string">"task_result"</span>: <span class="hljs-literal">True</span>}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, dass dieser Test denselben Broker und dasselbe Backend wie in der Entwicklung verwendet. </font><font style="vertical-align: inherit;">Sie können eine neue Instanz von Sellerie zum Testen erstellen:</font></font><br>
<br>
<pre><code class="python hljs">app = celery.Celery(<span class="hljs-string">'tests'</span>, broker=CELERY_TEST_BROKER, backend=CELERY_TEST_BACKEND)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Import hinzufügen:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und stellen Sie sicher, dass die Tests erfolgreich sind.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute haben wir die Grundkonfiguration von Sellerie eingeführt, um langfristige Aufgaben in einer Anwendung auf Django auszuführen. </font><font style="vertical-align: inherit;">Sie sollten alle Prozesse an die Verarbeitungswarteschlange senden, die den Code auf der Benutzerseite verlangsamen könnten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sellerie kann auch verwendet werden, um sich wiederholende Aufgaben auszuführen und komplexe ressourcenintensive Aufgaben zu zerlegen, um die Rechenlast auf mehrere Maschinen zu verteilen und die Ausführungszeit und die Last auf der Maschine zu reduzieren, die Clientanforderungen verarbeitet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie finden den gesamten Code in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diesem Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Steig in den Kurs ein</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503358/index.html">3D ML. Teil 1: 3D-Datenpräsentationsformulare</a></li>
<li><a href="../de503364/index.html">HandsAppMVP: iOS-Architektur für das Outsourcing der Studioentwicklung</a></li>
<li><a href="../de503366/index.html">Warum wird ein Bindestrich zur Frage? Oder Probleme beim Codieren von Daten in SQL</a></li>
<li><a href="../de503368/index.html">Gigantomania: Warum wiegen moderne Spiele so viel?</a></li>
<li><a href="../de503372/index.html">Ethereum 2.0 kann aufgrund von Fehlern, Problemen und Konkurrenten erneut verzögert werden</a></li>
<li><a href="../de503382/index.html">Gehen Sie auf einem sauberen Feld spazieren oder sammeln Sie MAC-Adressen von Wi-Fi-Geräten in der Nähe</a></li>
<li><a href="../de503386/index.html">Agile Coach gesunde Person</a></li>
<li><a href="../de503388/index.html">Digitalisierung der Panik: DIT von Moskau gegen Moskauer - ein runder Tisch am 23. Mai</a></li>
<li><a href="../de503390/index.html">Warum setzt Intel auf die Chipentwicklung für das Genie von Jim Keller?</a></li>
<li><a href="../de503394/index.html">Erfahrung in Aktieninvestitionen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>