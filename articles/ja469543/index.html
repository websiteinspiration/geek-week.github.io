<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😗 🚄 🔼 DirectumRXサービスのRedisのスケーラビリティとフェイルオーバー 🤹🏾 🧛🏾 😠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Redisは、完全にRAMに配置されたNoSQLクラスのデータベース管理システム（非リレーショナルDBMS）です。データにアクセスするには、「キー」-「値」モデルを使用します。このようなDBMSは、画像や小さなデータを格納するために、キャッシュをスケーラブルなサービスに格納するためによく使用されます...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DirectumRXサービスのRedisのスケーラビリティとフェイルオーバー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/469543/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisは、完全にRAMに配置されたNoSQLクラスのデータベース管理システム（非リレーショナルDBMS）です。</font><font style="vertical-align: inherit;">データにアクセスするには、「キー」-「値」モデルを使用します。</font><font style="vertical-align: inherit;">このようなDBMSは、画像や小さなデータを格納するために、キャッシュをスケーラブルなサービスに格納するためによく使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis DBMSは、次の理由により広く使用されました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速、なぜなら </font><font style="vertical-align: inherit;">すべてのデータはRAMに保存されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロスプラットフォーム。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSDライセンスに基づく配布（オープンソースソフトウェアに適用）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisの配布と適用範囲の広さは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プロジェクトの公式Webサイトに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あるあらゆる種類のケースに関する膨大な量のドキュメントによって推定できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DirectumRXサービスの水平スケーリングを使用する場合は、Redisフェイルセーフインストールを使用して、DirectumRXストレージサービスおよびDirectumRX Webアクセスサービスを正しく機能させる必要があります。</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/740/12b/060/74012b060e74628af35c33d4fa96b3bb.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisは、スケーリングモードのサービスが動作するために必要な運用データ、キャッシュ、およびその他の情報を保存するため、ユーザーがシステムと対話するプロセスは、現在作業しているインストールに依存しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisは機密データを保存せず、高負荷になりません。</font><font style="vertical-align: inherit;">ただし、Redisの障害が発生した場合、ユーザーがインストールを切り替えるときに多くのエラーが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisの公式Webサイトでは、水平スケーリングとフォールトトレランスを確保する方法が2つあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Sentielの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisのクラスタを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのオプションのカスタマイズを検討してください。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Sentielを設定する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis Sentiel（Redis Tracking Node）を使用するバリアントはRedis 2.4で実装され、追加のRedis Sentielサービスを使用してウィザードの可用性を監視します。また、ウィザードが失敗した場合に備えて、レプリカノードを構成します。どのスレーブノードがマスターになるかを決定し、外出先で再構成を実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは古典的なスキームを実装し</font></font><br>
<br>
<img width="467" src="https://habrastorage.org/getpro/habr/post_images/093/10e/efb/09310eefbd3eb3c05d23b9e227bb5d7a.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます</font><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">多数のスレーブノード</font><font style="vertical-align: inherit;">が存在</font><font style="vertical-align: inherit;">する可能性が</font><font style="vertical-align: inherit;">あり</font><font style="vertical-align: inherit;">ます（公式ウェブサイトによると最大1000）。生産的な作業のためには、少なくとも2つのスレーブノードを使用することが推奨されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、スキームは、Redis SentielサービスがMASTERノードとSLAVEノードで構成されるように構成され、MASTERノードに障害が発生した場合、残りの監視ノードは新しいMASTERを導入​​することを決定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisの最新バージョンは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、製品開発者の公式Webサイト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からダウンロードできます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ただし、配布パッケージはサイトのLinuxでのみ使用できます。</font><font style="vertical-align: inherit;">かつては</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RedisをWindowsに移植するため</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">の</font></a><font style="vertical-align: inherit;"> Microsoft </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プロジェクト</font></a><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">開発されて</font><font style="vertical-align: inherit;">いましたが、現時点ではプロジェクトはバージョン3.2.100で開発を停止したため、この記事では、最も適切な展開オプションであるLinuxについて検討します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストノードとして、Debian 10のLinuxディストリビューションがインストールされた2つの仮想ホストredis1とredis2を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、デフォルトのリポジトリからパッケージのリストを更新し、Redisをインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">apt-get update &amp;&amp; apt-get upgrade<font></font>
apt install redis-server</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョンを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:/home/user<span class="hljs-comment"># redis-server -v</span>
Redis server v=5.0.3 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=afa0decbb6de285f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1がマスターノードとして機能し、redis2がスレーブノードとして機能するようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、Redis構成ファイルに、レプリカを作成できるようにするための必要なパラメーターを記述します（まだフォールトトレラントではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイル/etc/redis/redis.confのredis1には、次のように指定します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># ,   MASTER     .</span>
requirepass TestPass </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイル/etc/redis/redis.confのredis2の場合は、次のように指定します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#   MASTER  .</span><font></font>
slaveof redis1 6379 <font></font>
<span class="hljs-comment">#      .</span><font></font>
masterauth TestPass <font></font>
<span class="hljs-comment">#   ,         .</span>
requirepass TestPass </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のノードでredis-serverサービスを再起動します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"># /etc/init.d/redis-server stop</span><font></font>
[ ok ] Stopping redis-server (via systemctl): redis-server.service.<font></font>
root@redis1:/etc/redis<span class="hljs-comment"># /etc/init.d/redis-server start</span><font></font>
[ ok ] Starting redis-server (via systemctl): redis-server.service.<font></font>
<font></font>
root@redis2:/etc/redis<span class="hljs-comment"># /etc/init.d/redis-server stop</span><font></font>
[ ok ] Stopping redis-server (via systemctl): redis-server.service.<font></font>
root@redis2:/etc/redis<span class="hljs-comment"># /etc/init.d/redis-server start</span>
[ ok ] Starting redis-server (via systemctl): redis-server.service.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードがレプリカになり、必要な役割を受け取ったことをマスター側で確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"># redis-cli -a TestPass info replication</span>
Warning: Using a password with <span class="hljs-string">'-a'</span> or <span class="hljs-string">'-u'</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.
<span class="hljs-comment"># Replication</span><font></font>
role:master<font></font>
connected_slaves:1<font></font>
slave0:ip=192.168.9.96,port=6379,state=online,offset=28,lag=0<font></font>
master_replid:56b0a702d5823d107b0ca1ca2c80f8ef650a4b28<font></font>
master_replid2:0000000000000000000000000000000000000000<font></font>
master_repl_offset:28<font></font>
second_repl_offset:-1<font></font>
repl_backlog_active:1<font></font>
repl_backlog_size:1048576<font></font>
repl_backlog_first_byte_offset:1<font></font>
repl_backlog_histlen:28</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スレーブ側でも同じ状況になります。</font></font><br>
<pre><code class="bash hljs">root@redis2:/etc/redis<span class="hljs-comment"># redis-cli -a TestPass info replication</span>
Warning: Using a password with <span class="hljs-string">'-a'</span> or <span class="hljs-string">'-u'</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.
<span class="hljs-comment"># Replication</span><font></font>
role:slave<font></font>
master_host:redis1<font></font>
master_port:6379<font></font>
master_link_status:up<font></font>
master_last_io_seconds_ago:4<font></font>
master_sync_in_progress:0<font></font>
slave_repl_offset:14<font></font>
slave_priority:100<font></font>
slave_read_only:1<font></font>
connected_slaves:0<font></font>
master_replid:56b0a702d5823d107b0ca1ca2c80f8ef650a4b28<font></font>
master_replid2:0000000000000000000000000000000000000000<font></font>
master_repl_offset:14<font></font>
second_repl_offset:-1<font></font>
repl_backlog_active:1<font></font>
repl_backlog_size:1048576<font></font>
repl_backlog_first_byte_offset:1<font></font>
repl_backlog_histlen:14</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、いずれかのノードで障害が発生した場合に自動的に復元されるようにレプリカを構成する必要があります。</font><font style="vertical-align: inherit;">これを行うには、Redis Sentinel追跡サービスが必要です。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ドキュメント</font></a><font style="vertical-align: inherit;">に</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基づいて、</font><font style="vertical-align: inherit;">Redis Sentinelモニタリングサービスは次の操作を実行できます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MASTERノードとSLAVEノードの可用性を確認し、ノードにアクセスできないことに関するアラートを送信できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MASTERノードに障害が発生した場合、監視ノードはSLAVEノードをMASTERモードにし、残りのSLAVEノードを再構成すると、新しいMASTERで動作し始めます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MASTERおよびSLAVEノードの構成ファイルを変更します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験の純粋さのために、別のredis3 VMに監視サービスを配置します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ方法でRedisリポジトリに接続し、redis-sentinelパッケージをインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">apt install redis-sentinel</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストール後、監視ノード/etc/redis/sentinel.confの構成ファイルで設定を行う必要があります。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#    redis1   6379. </span>
<span class="hljs-comment">#   1 -      , </span>
<span class="hljs-comment">#        MASTER-.</span>
<span class="hljs-comment">#       , </span>
<span class="hljs-comment">#     MASTER-.</span><font></font>
sentinel monitor master01 redis1 6379 1<font></font>
<font></font>
<span class="hljs-comment">#  3 ,       .</span><font></font>
sentinel down-after-milliseconds master01 3000<font></font>
<font></font>
<span class="hljs-comment">#    MASTER-</span><font></font>
sentinel failover-timeout master01 6000<font></font>
<font></font>
<span class="hljs-comment"># ,  SLAVE-   . </span>
<span class="hljs-comment">#    ,    , </span>
<span class="hljs-comment">#      .</span><font></font>
sentinel parallel-syncs master01 1<font></font>
<font></font>
<span class="hljs-comment">#    .</span>
<span class="hljs-built_in">bind</span> 192.168.9.97 127.0.0.1 ::1<font></font>
<font></font>
<span class="hljs-comment">#    MASTER-.</span><font></font>
sentinel auth-pass master01 TestPass<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定後、サービスを再起動します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"># /etc/init.d/redis-sentinel restart</span>
[ ok ] Restarting redis-sentinel (via systemctl): redis-sentinel.service.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
追跡サービスがマスターとスレーブを確認したことを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"># redis-cli -p 26379 info sentinel</span>
<span class="hljs-comment"># Sentinel</span><font></font>
sentinel_masters:1<font></font>
sentinel_tilt:0<font></font>
sentinel_running_scripts:0<font></font>
sentinel_scripts_queue_length:0<font></font>
sentinel_simulate_failure_flags:0<font></font>
master0:name=master01,status=ok,address=192.168.9.95:6379,slaves=1,sentinels=1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験を始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
障害をシミュレートし、redis1サーバーでredis-serverサービスを停止して、モニタリングノードの現在の情報を取得します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"># redis-cli -p 26379 info sentinel</span>
<span class="hljs-comment"># Sentinel</span><font></font>
sentinel_masters:1<font></font>
sentinel_tilt:0<font></font>
sentinel_running_scripts:0<font></font>
sentinel_scripts_queue_length:0<font></font>
sentinel_simulate_failure_flags:0<font></font>
master0:name=master01,status=ok,address=192.168.9.96:6379,slaves=1,sentinels=1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MASTERが変更されたことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1ノードの操作を復元し、その状態を確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/var/<span class="hljs-built_in">log</span>/redis<span class="hljs-comment"># redis-cli -h redis1 -p 6379 -a TestPass info replication</span>
Warning: Using a password with <span class="hljs-string">'-a'</span> or <span class="hljs-string">'-u'</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.
<span class="hljs-comment"># Replication</span><font></font>
role:slave<font></font>
master_host:192.168.9.96<font></font>
master_port:6379<font></font>
master_link_status:up<font></font>
master_last_io_seconds_ago:1<font></font>
master_sync_in_progress:0<font></font>
slave_repl_offset:15977<font></font>
slave_priority:100<font></font>
slave_read_only:1<font></font>
connected_slaves:0<font></font>
master_replid:6c0c7d0eedccede56f211f2db74a98c4d0ff6d56<font></font>
master_replid2:0000000000000000000000000000000000000000<font></font>
master_repl_offset:15977<font></font>
second_repl_offset:-1<font></font>
repl_backlog_active:1<font></font>
repl_backlog_size:1048576<font></font>
repl_backlog_first_byte_offset:1<font></font>
repl_backlog_histlen:15977</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードがSLAVEロールを受け取り、redis2ノードがMASTERノードであることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis2ノードの障害をシミュレートし、監視ノードのステータスを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/var/<span class="hljs-built_in">log</span>/redis<span class="hljs-comment"># redis-cli -p 26379 info sentinel</span>
<span class="hljs-comment"># Sentinel</span><font></font>
sentinel_masters:1<font></font>
sentinel_tilt:0<font></font>
sentinel_running_scripts:0<font></font>
sentinel_scripts_queue_length:0<font></font>
sentinel_simulate_failure_flags:0<font></font>
master0:name=master01,status=ok,address=192.168.9.95:6379,slaves=1,sentinels=1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、redis1ノードの状態：</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/var/<span class="hljs-built_in">log</span>/redis<span class="hljs-comment"># redis-cli -h redis1 -p 6379 -a TestPass info replication</span>
Warning: Using a password with <span class="hljs-string">'-a'</span> or <span class="hljs-string">'-u'</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.
<span class="hljs-comment"># Replication</span><font></font>
role:master<font></font>
connected_slaves:0<font></font>
master_replid:6e9d67d6460815b925319c2bafb58bf2c435cffb<font></font>
master_replid2:6c0c7d0eedccede56f211f2db74a98c4d0ff6d56<font></font>
master_repl_offset:33610<font></font>
second_repl_offset:26483<font></font>
repl_backlog_active:1<font></font>
repl_backlog_size:1048576<font></font>
repl_backlog_first_byte_offset:1<font></font>
repl_backlog_histlen:33610</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すばらしい、メカニズムは機能します。</font><font style="vertical-align: inherit;">ただし、DirectumRXサービスは単一のノードアドレスを必要とするため、どのように接続するかという問題が発生しました。</font><font style="vertical-align: inherit;">HAProxyサービスを使用して状況を解決します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisノードのプロキシ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロキシtcpサービスは、Redisノードのリバースプロキシとして機能できます。</font><font style="vertical-align: inherit;">この記事では、HAProxyの使用について検討します。HAProxyは、高可用性とロードバランシングを提供するために設計された専用ツールであり、広く知られているオンラインサービスで使用されているためです。</font><font style="vertical-align: inherit;">HAProxyの詳細について</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、開発者向けページをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxyをredis3ノードにインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/var/<span class="hljs-built_in">log</span>/redis<span class="hljs-comment"># apt install haproxy</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxy構成ファイル/etc/haproxy/haproxy.cfgに、リクエストをRedisノードにプロキシするための設定を追加します。</font></font><br>
<br>
<pre><code class="bash hljs">…<font></font>
frontend ft_redis<font></font>
        <span class="hljs-built_in">bind</span> *:6379 name redis<font></font>
        mode tcp<font></font>
        default_backend bk_redis<font></font>
<font></font>
backend bk_redis<font></font>
        mode tcp<font></font>
        option tcp-check<font></font>
        tcp-check connect<font></font>
        <span class="hljs-comment">#  ,         .</span><font></font>
        tcp-check send AUTH\ TestPass\r\n<font></font>
        tcp-check expect string +OK<font></font>
        tcp-check send PING\r\n<font></font>
        tcp-check expect string +PONG<font></font>
        tcp-check send info\ replication\r\n<font></font>
        <span class="hljs-comment">#    MASTER, .. SLAVE      .</span><font></font>
        tcp-check expect string role:master<font></font>
        tcp-check send QUIT\r\n<font></font>
        tcp-check expect string +OK<font></font>
        server Redis1 redis1:6379 check inter 3s<font></font>
        server Redis2 redis2:6379 check inter 3s<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構成では、ポート6379のアドレスにある現在の仮想マシンのすべてのインターフェースに送信されるすべての要求をプロキシすることが示されています。MASTERの役割を持っていると応答するノードに要求を送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
haproxyサービスを再起動します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/haproxy<span class="hljs-comment"># /etc/init.d/haproxy restart</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis-cliクライアントを使用して接続して、テストキーを作成してみましょう。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/haproxy<span class="hljs-comment"># redis-cli -p 6379 -a TestPass</span>
Warning: Using a password with <span class="hljs-string">'-a'</span> or <span class="hljs-string">'-u'</span> option on the <span class="hljs-built_in">command</span> line interface may not be safe.<font></font>
127.0.0.1:6379&gt; SET TestKey <span class="hljs-string">"Some test string"</span><font></font>
OK<font></font>
127.0.0.1:6379&gt; GET TestKey<font></font>
<span class="hljs-string">"Some test string"</span><font></font>
127.0.0.1:6379&gt; info keyspace<font></font>
<span class="hljs-comment"># Keyspace</span>
db0:keys=1,expires=0,avg_ttl=0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1ノードを停止し、キーのリストを再度クエリします。</font></font><br>
<br>
<pre><code class="bash hljs">127.0.0.1:6379&gt; info keyspace<font></font>
Error: Server closed the connection<font></font>
(3.01s)<font></font>
127.0.0.1:6379&gt; info keyspace<font></font>
<span class="hljs-comment"># Keyspace</span><font></font>
db0:keys=1,expires=0,avg_ttl=0<font></font>
(2.01s)<font></font>
127.0.0.1:6379&gt; GET TestKey<font></font>
<span class="hljs-string">"Some test string"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくの間、接続が切断されていましたが、その後、接続は再び復元され、すべてのデータはそのまま残りました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、Redisに接続するには、DirectumRXサービスの構成ファイルにリバースプロキシアドレスを登録するだけで十分です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisクラスターの構成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョンredis 3.0以降に実装されたRedisクラスタークラスタリングオプションは、データのセグメンテーションとレプリケーションを使用してクラスターを作成および管理するためのソリューションです。</font><font style="vertical-align: inherit;">ノードのノード管理、レプリケーション、データ同期のタスクを実行し、いくつかのMASTERノードの1つに障害が発生した場合にクライアントアプリケーションがMASTERノードにアクセスできるようにします。</font></font><br>
<br>
<img width="500" src="https://habrastorage.org/getpro/habr/post_images/86e/5c6/e56/86e5c6e56fe5541c36297e978c4c34d4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisクラスターはマルチマスターモードで動作し、各マスターノードは1つ以上のスレーブノード（最大1000）を持つことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スケーリングは、クラスターの主な機能です。</font><font style="vertical-align: inherit;">さらに、クラスターはRedisサービスのフォールトトレランスを保証できます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部のノードが機能しない場合、クラスターはそれらのノードから他のノードに負荷を再分散します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要なノードが機能しない場合、クラスター全体が終了します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアント2がノードM2に書き込むときに、状況が発生する可能性があります。 M2は「OK」と応答し、S2への書き込みを試みます。同時に、M2はS2とのデータ交換が正しく完了するまで待機せず、クライアントに即座に応答します。この場合、S2レプリカにはすべてのデータがない可能性があります。したがって、いくつかのスレーブレプリカを使用することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M1、M3がM2の「参照」を停止し、クライアントが引き続きM2へのデータの書き込みを続けると、状況が発生する場合もあります。しばらくの間利用できない状態が続く場合（cluster-node-timeoutパラメーター）、この場合、S2はMASTERモードになり、M2はそれ自体で動作を停止します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
公式ドキュメントは6ノットを使用することをお勧めします- 1が使用可能ノード上のRedisをコピー</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するために</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信頼性は低くなりますが、次の接続トポロジで3つのノードを使用することを禁止する人はいません。</font></font><br>
<br>
<img width="573" src="https://habrastorage.org/getpro/habr/post_images/3c1/56a/860/3c156a860e5728015e9631b3bb5854a1.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
物理ノードの1つに障害が発生すると、対応するスレーブレプリカがマスターモードになり、操作が中断されることはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストベンチに3つの仮想マシン（redis1、redis2、およびredis3）を実装し、それぞれが2つのRedisインスタンスを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントアプリケーションはクライアント構成ファイルで指定された特定のポートに接続するため、MASTER-SLAVEペアは同じポートで機能する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペアM1-S1にはポート6381を使用します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペアM2-S2には</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポート6382 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を</font><font style="vertical-align: inherit;">使用しますペアM3-S3にはポート6383 </font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">します構成ファイルを準備します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1：</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m1_redis.conf<font></font>
cp /etc/redis/redis.conf /etc/redis/s2_redis.conf<font></font>
mv /etc/redis/redis.conf /etc/redis/redis.bak </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis2の場合：</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m2_redis.conf<font></font>
cp /etc/redis/redis.conf /etc/redis/s3_redis.conf<font></font>
mv /etc/redis/redis.conf /etc/redis/redis.bak </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis3の場合：</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m3_redis.conf<font></font>
cp /etc/redis/redis.conf /etc/redis/s1_redis.conf <font></font>
mv /etc/redis/redis.conf /etc/redis/redis.bak</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートに従って構成ファイルに入力します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">bind</span> &lt;IP- &gt;<font></font>
protected-mode no <span class="hljs-comment">#      ,    .</span><font></font>
port &lt;&gt;<font></font>
pidfile /var/run/redis_&lt;&gt;.pid<font></font>
<span class="hljs-comment"># &lt;yes/no&gt; -   Redis Cluster</span><font></font>
cluster-enabled yes<font></font>
<span class="hljs-comment"># ,      : </span>
<span class="hljs-comment">#  ,  ,    .</span>
<span class="hljs-comment">#         .</span><font></font>
cluster-config-file nodes-&lt;&gt;.conf<font></font>
<span class="hljs-comment">#  ,  master-   , </span>
<span class="hljs-comment">#          slaves </span>
<span class="hljs-comment">#    .</span>
cluster-node-timeout 15000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisノードを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードredis1：</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/m1_redis.conf</span>
root@redis1:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/s2_redis.conf</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードredis2：</font></font><br>
<br>
<pre><code class="bash hljs">root@redis2:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/m2_redis.conf</span>
root@redis2:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/s3_redis.conf</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードredis3：</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/m3_redis.conf</span>
root@redis3:/etc/redis<span class="hljs-comment"># redis-server /etc/redis/s1_redis.conf</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターを設定するには、redis-cliクライアントユーティリティを使用して、MASTERおよびSLAVEの役割を果たすサーバーのip：portペアのリストを渡す必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">redis-cli --cluster create redis1-ip:6381 redis2-ip:6382 redis3-ip:6383 redis1-ip:6382 redis2-ip:6383 redis3-ip:6381 --cluster-replicas 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--cluster-replicas 1オプションは、各マスターが持つスレーブの数を示し、転送されたレプリカのリストから自動的に選択されます。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"># redis-cli --cluster create 192.168.9.51:6381 192.168.9.52:6382 192.168.9.53:6383 192.168.9.51:6382 192.168.9.52:6383 192.168.9.53:6381 --cluster-replicas 1</span>
&gt;&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...<font></font>
Master[0] -&gt; Slots 0 - 5460<font></font>
Master[1] -&gt; Slots 5461 - 10922<font></font>
Master[2] -&gt; Slots 10923 - 16383<font></font>
Adding replica 192.168.9.52:6383 to 192.168.9.51:6381<font></font>
Adding replica 192.168.9.51:6382 to 192.168.9.52:6382<font></font>
Adding replica 192.168.9.53:6381 to 192.168.9.53:6383<font></font>
&gt;&gt;&gt; Trying to optimize slaves allocation <span class="hljs-keyword">for</span> anti-affinity<font></font>
[OK] Perfect anti-affinity obtained!<font></font>
M: e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381<font></font>
   slots:[0-5460] (5461 slots) master<font></font>
M: d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382<font></font>
   slots:[5461-10922] (5462 slots) master<font></font>
M: 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383<font></font>
   slots:[10923-16383] (5461 slots) master<font></font>
S: 182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382<font></font>
   replicates d499af3672b3063c7239572ec311ad3160f280ae<font></font>
S: 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383<font></font>
   replicates 3a41475e1613519c3ecdec695736a898262a24a5<font></font>
S: 485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381<font></font>
   replicates e92cb96fd6c20db7509662a248902e3751ebe95f<font></font>
Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">'yes'</span> to accept): yes<font></font>
&gt;&gt;&gt; Nodes configuration updated<font></font>
&gt;&gt;&gt; Assign a different config epoch to each node<font></font>
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster<font></font>
Waiting <span class="hljs-keyword">for</span> the cluster to join<font></font>
.....<font></font>
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.9.51:6381)<font></font>
M: e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381<font></font>
   slots:[0-5460] (5461 slots) master<font></font>
   1 additional replica(s)<font></font>
M: d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382<font></font>
   slots:[5461-10922] (5462 slots) master<font></font>
   1 additional replica(s)<font></font>
S: 485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381<font></font>
   slots: (0 slots) slave<font></font>
   replicates e92cb96fd6c20db7509662a248902e3751ebe95f<font></font>
S: 182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382<font></font>
   slots: (0 slots) slave<font></font>
   replicates d499af3672b3063c7239572ec311ad3160f280ae<font></font>
S: 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383<font></font>
   slots: (0 slots) slave<font></font>
   replicates 3a41475e1613519c3ecdec695736a898262a24a5<font></font>
M: 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383<font></font>
   slots:[10923-16383] (5461 slots) master<font></font>
   1 additional replica(s)<font></font>
[OK] All nodes agree about slots configuration.<font></font>
&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...<font></font>
&gt;&gt;&gt; Check slots coverage...<font></font>
[OK] All 16384 slots covered.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターは正しく構築されています。</font><font style="vertical-align: inherit;">クラスターに関する情報を表示します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"># redis-cli -c -h 192.168.9.51 -p 6381</span><font></font>
192.168.9.51:6381&gt; CLUSTER INFO<font></font>
cluster_state:ok<font></font>
cluster_slots_assigned:16384<font></font>
cluster_slots_ok:16384<font></font>
cluster_slots_pfail:0<font></font>
cluster_slots_fail:0<font></font>
cluster_known_nodes:6<font></font>
cluster_size:3<font></font>
cluster_current_epoch:6<font></font>
cluster_my_epoch:1<font></font>
cluster_stats_messages_ping_sent:1254<font></font>
cluster_stats_messages_pong_sent:1243<font></font>
cluster_stats_messages_sent:2497<font></font>
cluster_stats_messages_ping_received:1238<font></font>
cluster_stats_messages_pong_received:1254<font></font>
cluster_stats_messages_meet_received:5<font></font>
cluster_stats_messages_received:2497<font></font>
192.168.9.51:6381&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis Sentielと同様に、特定のレプリカをテストするには、INFOレプリケーションコマンドを使用できます。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"># redis-cli -c -h 192.168.9.51 -p 6381</span><font></font>
192.168.9.51:6381&gt; INFO replication<font></font>
<span class="hljs-comment"># Replication</span><font></font>
role:master<font></font>
connected_slaves:1<font></font>
slave0:ip=192.168.9.53,port=6381,state=online,offset=1946,lag=0<font></font>
master_replid:59cd95d394dad9d0e49042637fdfd5290db4abfe<font></font>
master_replid2:0000000000000000000000000000000000000000<font></font>
master_repl_offset:1946<font></font>
second_repl_offset:-1<font></font>
repl_backlog_active:1<font></font>
repl_backlog_size:1048576<font></font>
repl_backlog_first_byte_offset:1<font></font>
repl_backlog_histlen:1946<font></font>
192.168.9.51:6381&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかのキーを作成して、これらのキーがレプリカに表示されていることを確認してみましょう。</font></font><br>
<br>
<pre><code class="bash hljs">192.168.9.51:6381&gt; SET key1 test1<font></font>
-&gt; Redirected to slot [9189] located at 192.168.9.52:6382<font></font>
OK<font></font>
192.168.9.52:6382&gt; SET key2 test2<font></font>
-&gt; Redirected to slot [4998] located at 192.168.9.51:6381<font></font>
OK<font></font>
192.168.9.51:6381&gt; SET key3 test3<font></font>
OK<font></font>
192.168.9.51:6381&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M2を確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@redis2:/home/user<span class="hljs-comment"># redis-cli -c -h 192.168.9.52 -p 6382</span><font></font>
192.168.9.52:6382&gt; GET key1<font></font>
<span class="hljs-string">"test1"</span><font></font>
192.168.9.52:6382&gt; GET key2<font></font>
-&gt; Redirected to slot [4998] located at 192.168.9.51:6381<font></font>
<span class="hljs-string">"test2"</span><font></font>
192.168.9.51:6381&gt; GET key3<font></font>
<span class="hljs-string">"test3"</span>
192.168.9.51:6381&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてM3では：</font></font><br>
<br>
<pre><code class="bash hljs">root@redis3:/home/user<span class="hljs-comment"># redis-cli -c -h 192.168.9.53 -p 6383</span><font></font>
192.168.9.53:6383&gt; GET key1<font></font>
-&gt; Redirected to slot [9189] located at 192.168.9.52:6382<font></font>
<span class="hljs-string">"test1"</span><font></font>
192.168.9.52:6382&gt; GET key2<font></font>
-&gt; Redirected to slot [4998] located at 192.168.9.51:6381<font></font>
<span class="hljs-string">"test2"</span><font></font>
192.168.9.51:6381&gt; GET key3<font></font>
<span class="hljs-string">"test3"</span>
192.168.9.51:6381&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1ノードを無効にし、S1がどのように機能するかを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">192.168.9.52:6382&gt; CLUSTER NODES<font></font>
&lt;b&gt;182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382@16382 slave,fail d499af3672b3063c7239572ec311ad3160f280ae 1569509904727 1569509900000 4 connected&lt;/b&gt;<font></font>
485ffb786e9763955e6f10ffc59247690ad9bc11 &lt;i&gt;192.168.9.53:6381@16381 master&lt;/i&gt; - 0 1569510017272 7 connected 0-5460<font></font>
44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383@16383 slave 3a41475e1613519c3ecdec695736a898262a24a5 0 1569510018274 5 connected<font></font>
&lt;b&gt;e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381@16381 master,fail - 1569509906731 1569509901721 1 connected&lt;/b&gt;<font></font>
3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383@16383 master - 0 1569510019275 3 connected 10923-16383<font></font>
d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382@16382 myself,master - 0 1569510017000 2 connected 5461-10922</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M1とS2の障害に関する情報と、S3がMASTERモードに切り替わったことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーが保存されている場所を確認します。</font></font><br>
<br>
<pre><code class="bash hljs">192.168.9.52:6382&gt; GET key1
<span class="hljs-string">"test1"</span><font></font>
192.168.9.52:6382&gt; GET key2<font></font>
-&gt; Redirected to slot [4998] located at 192.168.9.53:6381<font></font>
<span class="hljs-string">"test2"</span><font></font>
192.168.9.53:6381&gt; GET key3<font></font>
<span class="hljs-string">"test3"</span><font></font>
192.168.9.53:6381&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前はredis1に格納されていたキーがredis3で使用できるようになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
redis1ノードの操作を復元し、ノードM1およびS2の状態を確認します。</font></font><br>
<br>
<pre><code class="bash hljs">192.168.9.53:6381&gt; CLUSTER NODES<font></font>
&lt;i&gt;e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381@16381 slave 485ffb786e9763955e6f10ffc59247690ad9bc11 0 1569511658217 7 connected<font></font>
182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382@16382 slave d499af3672b3063c7239572ec311ad3160f280ae 0 1569511657000 4 connected&lt;/i&gt;<font></font>
d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382@16382 master - 0 1569511656000 2 connected 5461-10922<font></font>
3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383@16383 master - 0 1569511656000 3 connected 10923-16383<font></font>
485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381@16381 myself,master - 0 1569511656000 7 connected 0-5460<font></font>
44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383@16383 slave 3a41475e1613519c3ecdec695736a898262a24a5 0 1569511657216 5 connected</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M1とS2の状態は回復しましたが、M1はスレーブモードになっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、キーはredis3ノードにもあります。</font></font><br>
<br>
<pre><code class="bash hljs">192.168.9.53:6383&gt; GET key1<font></font>
-&gt; Redirected to slot [9189] located at 192.168.9.52:6382<font></font>
<span class="hljs-string">"test1"</span><font></font>
192.168.9.52:6382&gt; GET key2<font></font>
-&gt; Redirected to slot [4998] located at 192.168.9.53:6381<font></font>
<span class="hljs-string">"test2"</span><font></font>
192.168.9.53:6383&gt; GET key3<font></font>
-&gt; Redirected to slot [935] located at 192.168.9.53:6381<font></font>
<span class="hljs-string">"test3"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターが構成され、Redisリカバリがテストされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DirectumRXサービスにアクセスするには、Redis Sentielを設定する場合と同様に、リバースプロキシも設定する必要があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の代わりに</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、Redisのフォールトトレランスを向上させる別の方法、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまりPacemaker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのサードパーティのクラスターリソースマネージャーを使用する方法については考慮していません</font><font style="vertical-align: inherit;">。この場合、2つのノードで問題なく対処できますが、緊急時にデータが失われる可能性が高くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リバースプロキシ（この場合はHAProxy）の場合、フォールトトレランスを提供することも望ましいですが、この問題もこの記事の範囲を超えていました。このトピックに関心がある場合、これらの展開オプションは、段階的なチューニングと結果のテストを行う個別の記事の一部と見なすこともできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トピックの詳細については、以下のリンクをご覧</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ください</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。Redis </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">クラスターチュートリアル</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Sentinelドキュメント</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy設定マニュアル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja469529/index.html">テキストのレンダリングはあなたを嫌います</a></li>
<li><a href="../ja469531/index.html">「プログラミング言語をより悪い基準で比較することは、完全にばかげた職業です。」</a></li>
<li><a href="../ja469533/index.html">生体認証の問題と脅威</a></li>
<li><a href="../ja469537/index.html">SnakeでSwiftを理解する</a></li>
<li><a href="../ja469541/index.html">werfとGitLab CIを使用した同じタイプのマイクロサービスの組み立てとデプロイ</a></li>
<li><a href="../ja469545/index.html">Linuxカーネル5.3の新機能-ネットワークサブシステムのグラフィックスドライバー、仮想化、および変更</a></li>
<li><a href="../ja469549/index.html">Windows VPSの99ルーブルの関税をどうやって達成したか</a></li>
<li><a href="../ja469551/index.html">ビデオカードを備えたVDS-私たちは倒錯についてよく知っています</a></li>
<li><a href="../ja469555/index.html">ブロードキャスト：モスクワKubernetesミートアップ＃6</a></li>
<li><a href="../ja469557/index.html">Generic Recycler Viewまたは定型コードを作成しない方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>