<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏼 🛸 👩🏼‍⚖️ 人間用のClickHouseデータベース、またはAlien Technology 🦏 🈂️ 🍗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ICDの情報技術総局のリモートサービスチャネル能力センターの責任者であるアレクセイリズノフ
 
 
 
 ELKスタック（ElasticSearch、Logstash、Kibana）の代わりとして、ログのデータウェアハウスとしてのClickHouseデータベースの使用に関する調査を行っています。
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>人間用のClickHouseデータベース、またはAlien Technology</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICDの情報技術総局のリモートサービスチャネル能力センターの責任者であるアレクセイリズノフ</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ELKスタック（ElasticSearch、Logstash、Kibana）の代わりとして、ログのデータウェアハウスとしてのClickHouseデータベースの使用に関する調査を行っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、ClickHouseデータベースを使用した経験とパイロット運用の予備的な結果についてお話します。結果が印象的であったことはすぐに注目されるべきです。</font></font><br>
<br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、システムの構成方法とシステムの構成要素について詳しく説明します。しかし、今私はこのデータベース全体について、そしてなぜあなたがそれに注意を払うべきなのかについて少しお話ししたいと思います。 ClickHouseデータベースは、Yandexの高性能分析カラムデータベースです。これはYandexサービスで使用され、最初はYandex.Metricaのメインデータウェアハウスです。オープンソースシステムは無料です。開発者の視点から見ると、膨大な量のデータが存在するため、どのように実装したのか常に疑問に思っていました。そしてMetricaのユーザーインターフェース自体は非常に柔軟で高速です。このデータベースを初めて知ったときの印象：「やっと、やっと！ 「人のために」作られた！インストールプロセスから始まり、リクエストの送信で終了します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータベースのエントリしきい値は非常に低くなっています。熟練した平均的な開発者でさえ、このデータベースを数分でインストールして使用を開始できます。すべてが明確に機能します。 Linuxを初めて使用するユーザーでも、インストールをすばやく実行して簡単な操作を実行できます。以前、Big Data、Hadoop、Google BigTable、HDFSという言葉があったとき、通常の開発者は、数テラバイト、ペタバイトについて話していて、一部の超人がこれらのシステムの設定と開発に関与していたと考えていましたが、ClickHouseデータベースの登場により、これまで達成できなかったタスクの範囲を解決できる、シンプルで理解可能なツール。かなり普通の車1台と取り付けに5分かかります。つまり、MySqlなどのデータベースを取得しましたが、保存するのは数十億件のレコードのみです。なんらかのSQLスーパーバイザ。それはまるで人々がエイリアンの武器を与えられたかのようです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ収集システムについて</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
情報を収集するために、標準形式のWebアプリケーションのIISログファイルが使用されます（アプリケーションログの解析も行っていますが、パイロット操作の段階での主な目的はIISログを収集することです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまな理由により、ELKスタックを完全に破棄することに失敗し、LogStashおよびFilebeatコンポーネントを引き続き使用しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なログスキームを次の図に示し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。ClickHouseデータベースにデータを書き込む機能は、大規模なバッチでレコードを挿入する頻度が低い（1秒に1回）ことです。</font><font style="vertical-align: inherit;">これは明らかに、ClickHouseデータベースの操作を初めて経験したときに遭遇する最も「問題の多い」部分です。スキームは少し複雑です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseにデータを直接挿入するLogStashプラグインは、ここで非常に役立ちました。</font><font style="vertical-align: inherit;">このコンポーネントは、データベース自体と同じサーバーにデプロイされます。</font><font style="vertical-align: inherit;">したがって、一般的に言えば、同じサーバーにデプロイされているときに別のサーバーを作成しないように、実際にはそうすることはお勧めできません。</font><font style="vertical-align: inherit;">データベースの障害やリソースの競合は確認されませんでした。</font><font style="vertical-align: inherit;">また、エラーが発生した場合、プラグインには再トレイメカニズムがあることに注意してください。</font><font style="vertical-align: inherit;">エラーが発生した場合、プラグインは挿入できなかったデータのパケットをディスクに書き込みます（ファイル形式は便利です。編集後、クリックハウスクライアントを使用して修正したパケットを簡単に挿入できます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームで使用されているソフトウェアの完全なリストを表に示します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用ソフトウェア一覧</font></font></b><div class="spoiler_text"><div class="scrollable-table"><table>
<tbody>
<tr>
<td><b></b><br>
 </td>
<td><b></b><br>
 </td>
<td><b>  </b><br>
 </td>
</tr>
<tr>
<td> <p>NGINX</p><br>
 </td>
<td> <p>Reverse-proxy        </p><br>
<br>
<p>      </p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://nginx.org/ru/download.html</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://nginx.org/download/nginx-1.16.0.tar.gz</a></p><br>
 </td>
</tr>
<tr>
<td> <p>FileBeat</p><br>
 </td>
<td> <p>  .</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> (  Windows 64bit).</p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a></p><br>
 </td>
</tr>
<tr>
<td> <p>LogStash</p><br>
 </td>
<td> <p> .</p><br>
<br>
<p>     FileBeat,        RabbitMQ ( ,    DMZ.)</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.elastic.co/products/logstash</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a></p><br>
 </td>
</tr>
<tr>
<td> <p>Logstash- output- clickhouse</p><br>
 </td>
<td> <p> Loagstash      ClickHouse </p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a></p><br>
 </td>
<td> <p>/usr/share/logstash/bin/logstash-plugin install logstash-output-clickhouse</p><br>
 <p>/usr/share/logstash/bin/logstash-plugin install logstash-filter-prune</p><br>
 <p>/usr/share/logstash/bin/logstash-plugin install logstash-filter-multiline</p><br>
 </td>
</tr>
<tr>
<td> <p>ClickHouse</p><br>
 </td>
<td> <p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://clickhouse.yandex/docs/ru/</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a></p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a></p><br>
 <p>.    2018     ""  rpm  RHEL,     .      ,  Altinity.</p><br>
 </td>
</tr>
<tr>
<td> <p>Grafana</p><br>
 </td>
<td> <p> .  </p><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://grafana.com/</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://grafana.com/grafana/download</a></p><br>
<br>
<p>Redhat &amp; Centos(64 Bit) –  </p><br>
 </td>
</tr>
<tr>
<td> <p>ClickHouse datasource for Grafana 4.6+</p><br>
 </td>
<td> <p>  Grafana    ClickHouse</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/download</a></p><br>
 </td>
</tr>
<tr>
<td> <p>LogStash</p><br>
 </td>
<td> <p>   FileBeat   RabbitMQ.</p><br>
 <p>.    FileBeat  output   RabbitMQ,       Logstash</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.elastic.co/products/logstash</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a></p><br>
 </td>
</tr>
<tr>
<td> <p>RabbitMQ</p><br>
 </td>
<td> <p> .      DMZ</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.rabbitmq.com/download.html</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a></p><br>
 </td>
</tr>
<tr>
<td> <p>Erlang Runtime (  RabbitMQ)</p><br>
 </td>
<td> <p>  Erlang.    RabbitMQ</p><br>
 <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://www.erlang.org/download.html</a></p><br>
 </td>
<td> <p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://www.erlang.org/downloads/21.3</a></p><br>
 </td>
</tr>
</tbody>
</table></div><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseデータベースを使用したサーバー構成を次の表に示します。</font></font><br>
<div class="scrollable-table"><table>
<tbody>
<tr>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">題名</font></font></b><br>
 </td>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></b><br>
 </td>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HDD：40GB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAM：8GB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセッサー：Core 2 2Ghz</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseデータベースの操作に関するヒントに注意する必要があります（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://clickhouse.yandex/docs/ru/operations/tips/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム全体のソフトウェア</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS：Red Hat Enterprise Linux Server（Maipo）</font></font></p><br>
 <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JRE（Java 8）</font></font></p><br>
 </td>
<td> <p>&nbsp;</p><br>
 </td>
</tr>
</tbody>
</table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、これは通常のワークステーションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログを格納するためのテーブルの構造は次のとおりです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log_web.sql</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> log_web (<font></font>
  logdate <span class="hljs-built_in">Date</span>,<font></font>
  logdatetime DateTime CODEC(Delta, LZ4HC),<font></font>
   <font></font>
  fld_log_file_name LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  fld_server_name LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  fld_app_name LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  fld_app_module LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  fld_website_name LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
 <font></font>
  serverIP LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  method LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  uriStem <span class="hljs-keyword">String</span>,<font></font>
  uriQuery <span class="hljs-keyword">String</span>,<font></font>
  port UInt32,<font></font>
  username LowCardinality( <span class="hljs-keyword">String</span> ),<font></font>
  clientIP <span class="hljs-keyword">String</span>,<font></font>
  clientRealIP <span class="hljs-keyword">String</span>,<font></font>
  userAgent <span class="hljs-keyword">String</span>,<font></font>
  referer <span class="hljs-keyword">String</span>,<font></font>
  response <span class="hljs-keyword">String</span>,<font></font>
  subresponse <span class="hljs-keyword">String</span>,<font></font>
  win32response <span class="hljs-keyword">String</span>,<font></font>
  timetaken UInt64<font></font>
   <font></font>
  , uriQuery__utm_medium <span class="hljs-keyword">String</span>
  , uriQuery__utm_source <span class="hljs-keyword">String</span>
  , uriQuery__utm_campaign <span class="hljs-keyword">String</span>
  , uriQuery__utm_term <span class="hljs-keyword">String</span>
  , uriQuery__utm_content <span class="hljs-keyword">String</span>
  , uriQuery__yclid <span class="hljs-keyword">String</span>
  , uriQuery__region <span class="hljs-keyword">String</span><font></font>
 <font></font>
) <span class="hljs-keyword">Engine</span> = MergeTree()
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(logdate)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (fld_app_name, fld_app_module, logdatetime)
<span class="hljs-keyword">SETTINGS</span> index_granularity = <span class="hljs-number">8192</span>;</code></pre> <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスのパーティション分割（月単位）と粒度にはデフォルト値を使用します。</font><font style="vertical-align: inherit;">すべてのフィールドは、httpリクエストを登録するためのIISログエントリに実質的に対応しています。</font><font style="vertical-align: inherit;">utmタグを格納するための個別のフィールド（これらは、クエリ文字列フィールドからテーブルに挿入する段階で解析されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、表には、システム、コンポーネント、サーバーに関する情報を格納するためのいくつかのシステムフィールドが追加されています。</font><font style="vertical-align: inherit;">これらのフィールドの説明については、以下の表を参照してください。</font><font style="vertical-align: inherit;">1つのテーブルに、複数のシステムのログを保存します。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody>
<tr>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">題名</font></font></b><br>
 </td>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></b><br>
 </td>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></b><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fld_app_name</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション/システム名の</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有効な値：</font></font></p><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site1.domain.com外部サイト1</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site2.domain.com外部サイト2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">internal-site1.domain.local内部サイト1</font></font></li>
</ul><br>
 </td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> site1.domain.com</font></font><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fld_app_module</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムモジュールの</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有効な値：</font></font></p><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web-ウェブサイト</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svc-Webサイトサービス</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intgr-Web統合サービス</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bo-管理者（BackOffice）</font></font></li>
</ul><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウェブ</font></font></p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fld_website_name</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IISのWebサイト名</font></font></p><br>
 <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のシステムを1台のサーバーに配備することも、1つのシステムモジュールの複数のインスタンスを配備することもできます。</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウェブメイン</font></font></p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fld_server_name</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの名前</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web1.domain.com</font></font></p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fld_log_file_name</font></font></p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー上のログファイルへのパス</font></font></p><br>
 </td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C：\ inetpub \ logs \ LogFiles </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
\ W3SVC1 \ u_ex190711.log</font></font><br>
 </td>
</tr>
</tbody>
</table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、Grafanaでグラフィックを効果的に構築できます。</font><font style="vertical-align: inherit;">たとえば、特定のシステムのフロントエンドからのリクエストを表示します。</font><font style="vertical-align: inherit;">これは、Yandex.Metricaのサイトカウンターに似ています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2か月間のデータベースの使用に関するいくつかの統計を次に示します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムおよびコンポーネントごとのレコード数</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
    fld_app_name,<font></font>
    fld_app_module,<font></font>
    <span class="hljs-keyword">count</span>(fld_app_name) <span class="hljs-keyword">AS</span> rows_count
<span class="hljs-keyword">FROM</span> log_web
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><font></font>
    fld_app_name,<font></font>
    fld_app_module<font></font>
    <span class="hljs-keyword">WITH</span> TOTALS
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    fld_app_name <span class="hljs-keyword">ASC</span>,<font></font>
    rows_count <span class="hljs-keyword">DESC</span><font></font>
 <font></font>
┌─fld_app_name─────┬─fld_app_module─┬─rows_count─┐<font></font>
│ site1.domain.ru  │ web            │     <span class="hljs-number">131441</span> │<font></font>
│ site2.domain.ru  │ web            │    <span class="hljs-number">1751081</span> │<font></font>
│ site3.domain.ru  │ web            │  <span class="hljs-number">106887543</span> │<font></font>
│ site3.domain.ru  │ svc            │   <span class="hljs-number">44908603</span> │<font></font>
│ site3.domain.ru  │ intgr          │    <span class="hljs-number">9813911</span> │<font></font>
│ site4.domain.ru  │ web            │     <span class="hljs-number">772095</span> │<font></font>
│ site5.domain.ru  │ web            │   <span class="hljs-number">17037221</span> │<font></font>
│ site5.domain.ru  │ intgr          │     <span class="hljs-number">838559</span> │<font></font>
│ site5.domain.ru  │ bo             │       <span class="hljs-number">7404</span> │<font></font>
│ site6.domain.ru  │ web            │     <span class="hljs-number">595877</span> │<font></font>
│ site7.domain.ru  │ web            │   <span class="hljs-number">27778858</span> │<font></font>
└──────────────────┴────────────────┴────────────┘<font></font>
 <font></font>
Totals:<font></font>
┌─fld_app_name─┬─fld_app_module─┬─rows_count─┐<font></font>
│              │                │  <span class="hljs-number">210522593</span> │<font></font>
└──────────────┴────────────────┴────────────┘<font></font>
 <font></font>
<span class="hljs-number">11</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">4.874</span> sec. Processed <span class="hljs-number">210.52</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">421.67</span> MB (<span class="hljs-number">43.19</span> million <span class="hljs-keyword">rows</span>/s., <span class="hljs-number">86.51</span> MB/s.)</code></pre><br>
</div></div><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスク上のデータの量</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
    formatReadableSize(<span class="hljs-keyword">sum</span>(data_uncompressed_bytes)) <span class="hljs-keyword">AS</span> uncompressed,<font></font>
    formatReadableSize(<span class="hljs-keyword">sum</span>(data_compressed_bytes)) <span class="hljs-keyword">AS</span> compressed,
    <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">rows</span>) <span class="hljs-keyword">AS</span> total_rows
<span class="hljs-keyword">FROM</span> system.parts
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">table</span> = <span class="hljs-string">'log_web'</span><font></font>
 <font></font>
┌─uncompressed─┬─compressed─┬─total_rows─┐<font></font>
│ <span class="hljs-number">54.50</span> GiB    │ <span class="hljs-number">4.86</span> GiB   │  <span class="hljs-number">211427094</span> │<font></font>
└──────────────┴────────────┴────────────┘<font></font>
 <font></font>
<span class="hljs-number">1</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.035</span> sec.</code></pre><br>
</div></div><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列データ圧縮率</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">name</span>,<font></font>
    formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword">AS</span> uncompressed,<font></font>
    formatReadableSize(data_compressed_bytes) <span class="hljs-keyword">AS</span> compressed,<font></font>
    data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword">AS</span> compress_ratio
<span class="hljs-keyword">FROM</span> system.columns
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">table</span> = <span class="hljs-string">'log_web'</span><font></font>
 <font></font>
┌─<span class="hljs-keyword">name</span>───────────────────┬─uncompressed─┬─compressed─┬─────compress_ratio─┐<font></font>
│ logdate                │ <span class="hljs-number">401.53</span> MiB   │ <span class="hljs-number">1.80</span> MiB   │ <span class="hljs-number">223.16665968777315</span> │<font></font>
│ logdatetime            │ <span class="hljs-number">803.06</span> MiB   │ <span class="hljs-number">35.91</span> MiB  │ <span class="hljs-number">22.363966401202305</span> │<font></font>
│ fld_log_file_name      │ <span class="hljs-number">220.66</span> MiB   │ <span class="hljs-number">2.60</span> MiB   │  <span class="hljs-number">84.99905736932571</span> │<font></font>
│ fld_server_name        │ <span class="hljs-number">201.54</span> MiB   │ <span class="hljs-number">50.63</span> MiB  │  <span class="hljs-number">3.980924816977078</span> │<font></font>
│ fld_app_name           │ <span class="hljs-number">201.17</span> MiB   │ <span class="hljs-number">969.17</span> KiB │ <span class="hljs-number">212.55518183686877</span> │<font></font>
│ fld_app_module         │ <span class="hljs-number">201.17</span> MiB   │ <span class="hljs-number">968.60</span> KiB │ <span class="hljs-number">212.67805817411906</span> │<font></font>
│ fld_website_name       │ <span class="hljs-number">201.54</span> MiB   │ <span class="hljs-number">1.24</span> MiB   │  <span class="hljs-number">162.7204926761546</span> │<font></font>
│ serverIP               │ <span class="hljs-number">201.54</span> MiB   │ <span class="hljs-number">50.25</span> MiB  │  <span class="hljs-number">4.010824061219731</span> │<font></font>
│ method                 │ <span class="hljs-number">201.53</span> MiB   │ <span class="hljs-number">43.64</span> MiB  │  <span class="hljs-number">4.617721053304486</span> │<font></font>
│ uriStem                │ <span class="hljs-number">5.13</span> GiB     │ <span class="hljs-number">832.51</span> MiB │  <span class="hljs-number">6.311522291936919</span> │<font></font>
│ uriQuery               │ <span class="hljs-number">2.58</span> GiB     │ <span class="hljs-number">501.06</span> MiB │  <span class="hljs-number">5.269731450124478</span> │<font></font>
│ port                   │ <span class="hljs-number">803.06</span> MiB   │ <span class="hljs-number">3.98</span> MiB   │ <span class="hljs-number">201.91673864241824</span> │<font></font>
│ username               │ <span class="hljs-number">318.08</span> MiB   │ <span class="hljs-number">26.93</span> MiB  │ <span class="hljs-number">11.812513794583598</span> │<font></font>
│ clientIP               │ <span class="hljs-number">2.35</span> GiB     │ <span class="hljs-number">82.59</span> MiB  │ <span class="hljs-number">29.132328640073343</span> │<font></font>
│ clientRealIP           │ <span class="hljs-number">2.49</span> GiB     │ <span class="hljs-number">465.05</span> MiB │  <span class="hljs-number">5.478382297052563</span> │<font></font>
│ userAgent              │ <span class="hljs-number">18.34</span> GiB    │ <span class="hljs-number">764.08</span> MiB │  <span class="hljs-number">24.57905114484208</span> │<font></font>
│ referer                │ <span class="hljs-number">14.71</span> GiB    │ <span class="hljs-number">1.37</span> GiB   │ <span class="hljs-number">10.736792723669906</span> │<font></font>
│ response               │ <span class="hljs-number">803.06</span> MiB   │ <span class="hljs-number">83.81</span> MiB  │  <span class="hljs-number">9.582334090987247</span> │<font></font>
│ subresponse            │ <span class="hljs-number">399.87</span> MiB   │ <span class="hljs-number">1.83</span> MiB   │  <span class="hljs-number">218.4831068635027</span> │<font></font>
│ win32response          │ <span class="hljs-number">407.86</span> MiB   │ <span class="hljs-number">7.41</span> MiB   │ <span class="hljs-number">55.050315514606815</span> │<font></font>
│ timetaken              │ <span class="hljs-number">1.57</span> GiB     │ <span class="hljs-number">402.06</span> MiB │ <span class="hljs-number">3.9947395692010637</span> │<font></font>
│ uriQuery__utm_medium   │ <span class="hljs-number">208.17</span> MiB   │ <span class="hljs-number">12.29</span> MiB  │ <span class="hljs-number">16.936148912472955</span> │<font></font>
│ uriQuery__utm_source   │ <span class="hljs-number">215.18</span> MiB   │ <span class="hljs-number">13.00</span> MiB  │ <span class="hljs-number">16.548367623199912</span> │<font></font>
│ uriQuery__utm_campaign │ <span class="hljs-number">381.46</span> MiB   │ <span class="hljs-number">37.94</span> MiB  │ <span class="hljs-number">10.055156353418509</span> │<font></font>
│ uriQuery__utm_term     │ <span class="hljs-number">231.82</span> MiB   │ <span class="hljs-number">10.78</span> MiB  │ <span class="hljs-number">21.502540454070672</span> │<font></font>
│ uriQuery__utm_content  │ <span class="hljs-number">441.34</span> MiB   │ <span class="hljs-number">87.60</span> MiB  │  <span class="hljs-number">5.038260760449327</span> │<font></font>
│ uriQuery__yclid        │ <span class="hljs-number">216.88</span> MiB   │ <span class="hljs-number">16.58</span> MiB  │  <span class="hljs-number">13.07721335008116</span> │<font></font>
│ uriQuery__region       │ <span class="hljs-number">204.35</span> MiB   │ <span class="hljs-number">9.49</span> MiB   │  <span class="hljs-number">21.52661903446796</span> │<font></font>
└────────────────────────┴──────────────┴────────────┴────────────────────┘<font></font>
 <font></font>
<span class="hljs-number">28</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.005</span> sec.</code></pre><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FileBeat </font><font style="vertical-align: inherit;">の使用されているコンポーネントの</font><font style="vertical-align: inherit;">説明。</font><font style="vertical-align: inherit;">ファイルログ転送</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコンポーネントは、ディスク上のログファイルの変更を監視し、情報をLogStashに転送します。</font><font style="vertical-align: inherit;">ログファイルが書き込まれるすべてのサーバー（通常はIIS）にインストールされます。</font><font style="vertical-align: inherit;">テールモードで動作します（つまり、追加されたレコードのみをファイルに転送します）。</font><font style="vertical-align: inherit;">ただし、個別に、ファイル転送全体を構成できます。</font><font style="vertical-align: inherit;">これは、前月のデータをダウンロードする必要がある場合に役立ちます。</font><font style="vertical-align: inherit;">ログファイルをフォルダに入れるだけで、ログファイル全体が読み取られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスが停止すると、データはストレージに転送されなくなります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成例は次のとおりです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filebeat.yml</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">filebeat.inputs:<font></font>
- type: log<font></font>
  enabled: true<font></font>
  paths:<font></font>
    - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment">/*.log
  exclude_files: ['.gz$','.zip$']
  tail_files: true
  ignore_older: 24h
  fields:
    fld_server_name: "site1.domain.ru"
    fld_app_name: "site1.domain.ru"
    fld_app_module: "web"
    fld_website_name: "web-main"
 
- type: log
  enabled: true
  paths:
    - C:/inetpub/logs/LogFiles/__Import/access_log-*
  exclude_files: ['.gz$','.zip$']
  tail_files: false
  fields:
    fld_server_name: "site2.domain.ru"
    fld_app_name: "site2.domain.ru"
    fld_app_module: "web"
    fld_website_name: "web-main"
    fld_logformat: "logformat__apache"
 
 
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false
  reload.period: 2s
 
output.logstash:
  hosts: ["log.domain.com:5044"]
 
  ssl.enabled: true
  ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"]
  ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer"
  ssl.key: "C:/filebeat/certs/site1.domain.ru.key"
 
#================================ Processors =====================================
 
processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~</span></code></pre><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LogStash </font><font style="vertical-align: inherit;">ログコレクター</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコンポーネントは、FileBeatから（またはRabbitMQキューを介して）ログエントリを受信し、バンドルを解析してClickHouseデータベースに挿入することを目的としています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseに挿入するには、Logstash-output-clickhouseプラグインを使用します。</font><font style="vertical-align: inherit;">Logstashプラグインには、リクエストを取得するためのメカニズムがありますが、定期的にシャットダウンする場合は、サービス自体を停止することをお勧めします。</font><font style="vertical-align: inherit;">停止すると、メッセージはRabbitMQキューに蓄積されるため、長時間停止する場合は、サーバー上のFilebeatsを停止することをお勧めします。</font><font style="vertical-align: inherit;">RabbitMQが使用されていないスキーム（ローカルネットワークでは、Filebeatはログを直接Logstashに送信します）では、Filebeatは非常に適切で安全に機能するため、出力にアクセスできなくても影響はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成例は次のとおりです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log_web__filebeat_clickhouse.conf</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">input {<font></font>
 <font></font>
    beats {<font></font>
        port =&gt; 5044<font></font>
        type =&gt; 'iis'<font></font>
        ssl =&gt; true<font></font>
        ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"]<font></font>
        ssl_certificate =&gt; "/etc/logstash/certs/server.cer"<font></font>
        ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key"<font></font>
        ssl_verify_mode =&gt; "peer"<font></font>
 <font></font>
            add_field =&gt; {<font></font>
                "fld_server_name" =&gt; "%{[fields][fld_server_name]}"<font></font>
                "fld_app_name" =&gt; "%{[fields][fld_app_name]}"<font></font>
                "fld_app_module" =&gt; "%{[fields][fld_app_module]}"<font></font>
                "fld_website_name" =&gt; "%{[fields][fld_website_name]}"<font></font>
                "fld_log_file_name" =&gt; "%{source}"<font></font>
                "fld_logformat" =&gt; "%{[fields][fld_logformat]}"<font></font>
            }<font></font>
    }<font></font>
 <font></font>
    rabbitmq {<font></font>
        host =&gt; "queue.domain.com"<font></font>
        port =&gt; 5671<font></font>
        user =&gt; "q-reader"<font></font>
        password =&gt; "password"<font></font>
        queue =&gt; "web_log"<font></font>
        heartbeat =&gt; 30<font></font>
        durable =&gt; true<font></font>
        ssl =&gt; true<font></font>
        <span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12"</span>
        <span class="hljs-comment">#ssl_certificate_password =&gt; "password"</span><font></font>
 <font></font>
        add_field =&gt; {<font></font>
            "fld_server_name" =&gt; "%{[fields][fld_server_name]}"<font></font>
            "fld_app_name" =&gt; "%{[fields][fld_app_name]}"<font></font>
            "fld_app_module" =&gt; "%{[fields][fld_app_module]}"<font></font>
            "fld_website_name" =&gt; "%{[fields][fld_website_name]}"<font></font>
            "fld_log_file_name" =&gt; "%{source}"<font></font>
            "fld_logformat" =&gt; "%{[fields][fld_logformat]}"<font></font>
        }<font></font>
    }<font></font>
 <font></font>
}<font></font>
 <font></font>
filter { <font></font>
 <font></font>
      if [message] =~ "^<span class="hljs-comment">#" {</span>
        <span class="hljs-keyword">drop</span> {}<font></font>
      }<font></font>
 <font></font>
      <span class="hljs-keyword">if</span> [fld_logformat] == <span class="hljs-string">"logformat__iis_with_xrealip"</span> {<font></font>
     <font></font>
          grok {<font></font>
            <span class="hljs-keyword">match</span> =&gt; [<span class="hljs-string">"message"</span>, <span class="hljs-string">"%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"</span>]<font></font>
          }<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
   <font></font>
          grok {<font></font>
             <span class="hljs-keyword">match</span> =&gt; [<span class="hljs-string">"message"</span>, <span class="hljs-string">"%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"</span>]<font></font>
          }<font></font>
 <font></font>
      }<font></font>
 <font></font>
      <span class="hljs-built_in">date</span> {
        <span class="hljs-keyword">match</span> =&gt; [ <span class="hljs-string">"log_timestamp"</span>, <span class="hljs-string">"YYYY-MM-dd HH:mm:ss"</span> ]<font></font>
          timezone =&gt; <span class="hljs-string">"Etc/UTC"</span>
        remove_field =&gt; [ <span class="hljs-string">"log_timestamp"</span>, <span class="hljs-string">"@timestamp"</span> ]<font></font>
        target =&gt; [ <span class="hljs-string">"log_timestamp2"</span> ]<font></font>
      }<font></font>
 <font></font>
        ruby {<font></font>
            code =&gt; <span class="hljs-string">"tstamp = event.get('log_timestamp2').to_i
                        event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S'))
                        event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))"</span><font></font>
        }<font></font>
 <font></font>
      <span class="hljs-keyword">if</span> [bytesSent] {<font></font>
        ruby {<font></font>
          code =&gt; <span class="hljs-string">"event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0"</span><font></font>
        }<font></font>
      }<font></font>
 <font></font>
 <font></font>
      <span class="hljs-keyword">if</span> [bytesReceived] {<font></font>
        ruby {<font></font>
          code =&gt; <span class="hljs-string">"event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0"</span><font></font>
        }<font></font>
      }<font></font>
 <font></font>
   <font></font>
        ruby {<font></font>
            code =&gt; <span class="hljs-string">"event.set('clientRealIP', event.get('clientIP'))"</span><font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> [xrealIP] {<font></font>
            ruby {<font></font>
                code =&gt; <span class="hljs-string">"event.set('clientRealIP', event.get('xrealIP'))"</span><font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> [xforwarderfor] {<font></font>
            ruby {<font></font>
                code =&gt; <span class="hljs-string">"event.set('clientRealIP', event.get('xforwarderfor'))"</span><font></font>
            }<font></font>
        }<font></font>
 <font></font>
      mutate {<font></font>
        <span class="hljs-keyword">convert</span> =&gt; [<span class="hljs-string">"bytesSent"</span>, <span class="hljs-string">"integer"</span>]
        <span class="hljs-keyword">convert</span> =&gt; [<span class="hljs-string">"bytesReceived"</span>, <span class="hljs-string">"integer"</span>]
        <span class="hljs-keyword">convert</span> =&gt; [<span class="hljs-string">"timetaken"</span>, <span class="hljs-string">"integer"</span>] 
        <span class="hljs-keyword">convert</span> =&gt; [<span class="hljs-string">"port"</span>, <span class="hljs-string">"integer"</span>]<font></font>
 <font></font>
        add_field =&gt; {<font></font>
            <span class="hljs-string">"clientHostname"</span> =&gt; <span class="hljs-string">"%{clientIP}"</span><font></font>
        }<font></font>
      }<font></font>
 <font></font>
        useragent {<font></font>
            <span class="hljs-keyword">source</span>=&gt; <span class="hljs-string">"useragent"</span>
            prefix=&gt; <span class="hljs-string">"browser"</span><font></font>
        }<font></font>
 <font></font>
        kv {<font></font>
            <span class="hljs-keyword">source</span> =&gt; <span class="hljs-string">"uriQuery"</span>
            prefix =&gt; <span class="hljs-string">"uriQuery__"</span>
            allow_duplicate_values =&gt; <span class="hljs-literal">false</span>
            field_split =&gt; <span class="hljs-string">"&amp;"</span>
            include_keys =&gt; [ <span class="hljs-string">"utm_medium"</span>, <span class="hljs-string">"utm_source"</span>, <span class="hljs-string">"utm_campaign"</span>, <span class="hljs-string">"utm_term"</span>, <span class="hljs-string">"utm_content"</span>, <span class="hljs-string">"yclid"</span>, <span class="hljs-string">"region"</span> ]<font></font>
        }<font></font>
 <font></font>
        mutate {<font></font>
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__utm_source"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__utm_medium"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__utm_campaign"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__utm_term"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__utm_content"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__yclid"</span> =&gt; <span class="hljs-string">","</span> }
            <span class="hljs-keyword">join</span> =&gt; { <span class="hljs-string">"uriQuery__region"</span> =&gt; <span class="hljs-string">","</span> }<font></font>
        }<font></font>
 <font></font>
}<font></font>
 <font></font>
<span class="hljs-keyword">output</span> { 
  <span class="hljs-comment">#stdout {codec =&gt; rubydebug}</span><font></font>
    clickhouse {<font></font>
      headers =&gt; [<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Basic abcdsfks..."</span>]<font></font>
      http_hosts =&gt; [<span class="hljs-string">"http://127.0.0.1:8123"</span>]<font></font>
      save_dir =&gt; <span class="hljs-string">"/etc/logstash/tmp"</span>
      <span class="hljs-keyword">table</span> =&gt; <span class="hljs-string">"log_web"</span>
      request_tolerance =&gt; <span class="hljs-number">1</span>
      flush_size =&gt; <span class="hljs-number">10000</span>
      idle_flush_time =&gt; <span class="hljs-number">1</span><font></font>
        mutations =&gt; {<font></font>
            <span class="hljs-string">"fld_log_file_name"</span> =&gt; <span class="hljs-string">"fld_log_file_name"</span>
            <span class="hljs-string">"fld_server_name"</span> =&gt; <span class="hljs-string">"fld_server_name"</span>
            <span class="hljs-string">"fld_app_name"</span> =&gt; <span class="hljs-string">"fld_app_name"</span>
            <span class="hljs-string">"fld_app_module"</span> =&gt; <span class="hljs-string">"fld_app_module"</span>
            <span class="hljs-string">"fld_website_name"</span> =&gt; <span class="hljs-string">"fld_website_name"</span><font></font>
 <font></font>
            <span class="hljs-string">"logdatetime"</span> =&gt; <span class="hljs-string">"logdatetime"</span>
            <span class="hljs-string">"logdate"</span> =&gt; <span class="hljs-string">"logdate"</span>
            <span class="hljs-string">"serverIP"</span> =&gt; <span class="hljs-string">"serverIP"</span>
            <span class="hljs-string">"method"</span> =&gt; <span class="hljs-string">"method"</span>
            <span class="hljs-string">"uriStem"</span> =&gt; <span class="hljs-string">"uriStem"</span>
            <span class="hljs-string">"uriQuery"</span> =&gt; <span class="hljs-string">"uriQuery"</span>
            <span class="hljs-string">"port"</span> =&gt; <span class="hljs-string">"port"</span>
            <span class="hljs-string">"username"</span> =&gt; <span class="hljs-string">"username"</span>
            <span class="hljs-string">"clientIP"</span> =&gt; <span class="hljs-string">"clientIP"</span>
            <span class="hljs-string">"clientRealIP"</span> =&gt; <span class="hljs-string">"clientRealIP"</span>
            <span class="hljs-string">"userAgent"</span> =&gt; <span class="hljs-string">"userAgent"</span>
            <span class="hljs-string">"referer"</span> =&gt; <span class="hljs-string">"referer"</span>
            <span class="hljs-string">"response"</span> =&gt; <span class="hljs-string">"response"</span>
            <span class="hljs-string">"subresponse"</span> =&gt; <span class="hljs-string">"subresponse"</span>
            <span class="hljs-string">"win32response"</span> =&gt; <span class="hljs-string">"win32response"</span>
            <span class="hljs-string">"timetaken"</span> =&gt; <span class="hljs-string">"timetaken"</span><font></font>
             <font></font>
            <span class="hljs-string">"uriQuery__utm_medium"</span> =&gt; <span class="hljs-string">"uriQuery__utm_medium"</span>
            <span class="hljs-string">"uriQuery__utm_source"</span> =&gt; <span class="hljs-string">"uriQuery__utm_source"</span>
            <span class="hljs-string">"uriQuery__utm_campaign"</span> =&gt; <span class="hljs-string">"uriQuery__utm_campaign"</span>
            <span class="hljs-string">"uriQuery__utm_term"</span> =&gt; <span class="hljs-string">"uriQuery__utm_term"</span>
            <span class="hljs-string">"uriQuery__utm_content"</span> =&gt; <span class="hljs-string">"uriQuery__utm_content"</span>
            <span class="hljs-string">"uriQuery__yclid"</span> =&gt; <span class="hljs-string">"uriQuery__yclid"</span>
            <span class="hljs-string">"uriQuery__region"</span> =&gt; <span class="hljs-string">"uriQuery__region"</span><font></font>
        }<font></font>
    }<font></font>
 <font></font>
}</code></pre><br>
</div></div><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipelines.yml</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple.</span>
<span class="hljs-comment"># For more information on multiple pipelines, see the documentation:</span>
<span class="hljs-comment">#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</span><font></font>
 <font></font>
- pipeline.id: log_web__filebeat_clickhouse<font></font>
  path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</code></pre><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse。</font><font style="vertical-align: inherit;">ログストレージ</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのシステムのログは1つのテーブルに保存されます（記事の冒頭を参照）。</font><font style="vertical-align: inherit;">これは、リクエストに関する情報を保存することを目的としています。たとえば、IISログ、Apache、nginxログなど、すべてのパラメータはさまざまな形式で類似しています。</font><font style="vertical-align: inherit;">エラー、情報メッセージ、警告などが記録されているアプリケーションログの場合、対応する構造を備えた個別のテーブルが提供されます（現在は設計段階）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルを設計するときは、主キーを決定することが非常に重要です（これにより、格納中にデータがソートされます）。</font><font style="vertical-align: inherit;">データ圧縮の程度とクエリ速度はこれに依存します。</font><font style="vertical-align: inherit;">この例では、キーは</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ORDER BY（fld_app_name、fld_app_module、logdatetime）です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、システムの名前、システムコンポーネントの名前、およびイベントの日付です。イベントの最初の日付は最初の場所でした。最後の場所に移動した後、クエリは約2倍の速さで機能し始めました。主キーを変更するには、ClickHouseがディスク上のデータを再ソートするために、テーブルを再作成してデータを再ロードする必要があります。これは難しい操作なので、事前にソートキーに何を含める必要があるかを考えることをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、比較的最近のバージョンでは、LowCardinalityデータ型が使用されていることにも注意してください。これを使用すると、カーディナリティが低い（いくつかのオプション）フィールドの圧縮データのサイズが大幅に削減されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在はバージョン19.6を使用しており、最新バージョンに更新する予定です。</font><font style="vertical-align: inherit;">たとえば、アダプティブグラニュラリティ、スキップインデックス、DoubleDeltaコーデックなどのすばらしい機能が含まれていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、インストール時に構成ログレベルがトレースに設定されます。</font><font style="vertical-align: inherit;">ログはローテーションされてアーカイブされますが、ギガバイトまで拡張されます。</font><font style="vertical-align: inherit;">必要がない場合は、警告レベルを設定すると、ログのサイズが急激に減少します。</font><font style="vertical-align: inherit;">ログ設定はconfig.xmlファイルで設定されます。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>warning<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span></code></pre><br>
 <div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの便利なコマンド</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">      Debian,     Linux      Altinity.<font></font>
 <font></font>
          : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword">with</span>-clickhouse<font></font>
sudo yum <span class="hljs-keyword">search</span> clickhouse-<span class="hljs-keyword">server</span>
sudo yum <span class="hljs-keyword">install</span> clickhouse-server.noarch<font></font>
  <font></font>
<span class="hljs-number">1.</span>  <font></font>
sudo systemctl <span class="hljs-keyword">status</span> clickhouse-<span class="hljs-keyword">server</span><font></font>
 <font></font>
<span class="hljs-number">2.</span>  <font></font>
sudo systemctl <span class="hljs-keyword">stop</span> clickhouse-<span class="hljs-keyword">server</span><font></font>
 <font></font>
<span class="hljs-number">3.</span>  <font></font>
sudo systemctl <span class="hljs-keyword">start</span> clickhouse-<span class="hljs-keyword">server</span><font></font>
 <font></font>
       (   <span class="hljs-string">";"</span>)<font></font>
clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--multiline</span>
clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--multiline --host 127.0.0.1 --password pa55w0rd</span>
clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd</span><font></font>
 <font></font>
               /tmp/log_web_failed.json<font></font>
           :<font></font>
clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json</span><font></font>
 <font></font>
sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json<font></font>
sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json<font></font>
sudo clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json</span><font></font>
sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json<font></font>
 <font></font>
   <font></font>
quit;<font></font>
<span class="hljs-comment">##  TLS</span><font></font>
https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2<font></font>
 <font></font>
openssl s_client -connect log.domain.com:9440 &lt; /dev/null</code></pre><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LogStash </font><font style="vertical-align: inherit;">RabbitMQキューへのFileBeatログルーター</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコンポーネントは、FileBeatからのログをRabbitMQキューにルーティングするために使用されます。</font><font style="vertical-align: inherit;">2つのポイントがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">残念ながら、FileBeatにはRabbitMQに直接書き込むための出力プラグインがありません。</font><font style="vertical-align: inherit;">そして、その機能は、Githubのishで判断すると、実装の予定はありません。</font><font style="vertical-align: inherit;">Kafka用のプラグインがありますが、何らかの理由で自宅では使用できません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMZでログを収集するための要件が​​あります。</font><font style="vertical-align: inherit;">それらに基づいて、まずログをキューに追加してから、外部のLogStashがキューからエントリを読み取る必要があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、DMZ内のサーバーの場所の場合は、このような少し複雑なスキームを使用する必要があります。</font><font style="vertical-align: inherit;">構成例は次のとおりです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iis_w3c_logs__filebeat_rabbitmq.conf</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">input {<font></font>
 <font></font>
    beats {<font></font>
        port =&gt; 5044<font></font>
        type =&gt; 'iis'<font></font>
        ssl =&gt; true<font></font>
        ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"]<font></font>
        ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer"<font></font>
        ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key"<font></font>
        ssl_verify_mode =&gt; "peer"<font></font>
    }<font></font>
 <font></font>
}<font></font>
 <font></font>
output { <font></font>
  <span class="hljs-comment">#stdout {codec =&gt; rubydebug}</span><font></font>
 <font></font>
    rabbitmq {<font></font>
        host =&gt; "127.0.0.1"<font></font>
        port =&gt; 5672<font></font>
        exchange =&gt; "monitor.direct"<font></font>
        exchange_type =&gt; "direct"<font></font>
        key =&gt; "%{[fields][fld_app_name]}"<font></font>
        user =&gt; "q-writer"<font></font>
        password =&gt; "password"<font></font>
        ssl =&gt; false<font></font>
    }<font></font>
}</code></pre><br>
</div></div> <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ。</font><font style="vertical-align: inherit;">メッセージキュー</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコンポーネントは、DMZのログエントリをバッファするために使用されます。</font><font style="vertical-align: inherit;">記録は、一連のFilebeat→LogStashを介して行われます。</font><font style="vertical-align: inherit;">読み取りは、LogStashを介してDMZの外部から行われます。</font><font style="vertical-align: inherit;">RabboitMQを介して操作する場合、1秒あたり約4000のメッセージが処理されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージルーティングは、システムの名前に従って、つまりFileBeat構成データに基づいて構成されます。</font><font style="vertical-align: inherit;">すべてのメッセージは1つのキューに分類されます。</font><font style="vertical-align: inherit;">何らかの理由でキューサービスが停止しても、メッセージが失われることはありません。FileBeatsは接続エラーを受け取り、一時的な送信を一時停止します。</font><font style="vertical-align: inherit;">また、キューから読み取るLogStashもネットワークエラーを受け取り、接続が再開するのを待ちます。</font><font style="vertical-align: inherit;">もちろん、データはデータベースに書き込まれなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キューを作成および構成するには、次の手順を使用します。</font></font><br>
<br>
<pre><code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword">declare</span> <span class="hljs-keyword">exchange</span> <span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true</span>
sudo /usr/<span class="hljs-keyword">local</span>/<span class="hljs-keyword">bin</span>/rabbitmqadmin/rabbitmqadmin <span class="hljs-comment">--vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru"</span>
sudo /usr/<span class="hljs-keyword">local</span>/<span class="hljs-keyword">bin</span>/rabbitmqadmin/rabbitmqadmin <span class="hljs-comment">--vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラファナ </font><font style="vertical-align: inherit;">ダッシュボード</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコンポーネントは、監視データを視覚化するために使用されます。この場合、Grafana 4.6+プラグイン用のClickHouseデータソースをインストールする必要があります。ダッシュボードでSQLフィルターを処理する効率を上げるには、少し調整する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、変数を使用していて、それらがフィルターフィールドに設定されていない場合、WHEREフォームで条件を生成しないようにします（uriStem = `` AND uriStem！= ''）。この場合、ClickHouseはuriStem列を読み取ります。一般に、さまざまなオプションを試し、最後にプラグイン（マクロ$ valueIfEmpty）を修正しました。これにより、空の値の場合、列自体に言及せずに1を返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、あなたはこのクエリをグラフに使うことができます</font></font><br>
<br>
<pre><code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc<font></font>
and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name')<font></font>
and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%')<font></font>
and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはそのようなSQLに変換されます（空のuriStemフィールドは1に変換されたことに注意してください）</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
t,<font></font>
groupArray((response, c)) <span class="hljs-keyword">AS</span> groupArr
<span class="hljs-keyword">FROM</span> (
<span class="hljs-keyword">SELECT</span>
(intDiv(toUInt32(logdatetime), <span class="hljs-number">60</span>) * <span class="hljs-number">60</span>) * <span class="hljs-number">1000</span> <span class="hljs-keyword">AS</span> t, response,
<span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">AS</span> c <span class="hljs-keyword">FROM</span> default.log_web
<span class="hljs-keyword">WHERE</span> (logdate &gt;= toDate(<span class="hljs-number">1565061982</span>)) <span class="hljs-keyword">AND</span> (logdatetime &gt;= toDateTime(<span class="hljs-number">1565061982</span>)) <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> (fld_app_name = <span class="hljs-string">'site1.domain.ru'</span>) <span class="hljs-keyword">AND</span> (fld_app_module = <span class="hljs-string">'web'</span>) <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><font></font>
t, response<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
t <span class="hljs-keyword">ASC</span>,<font></font>
response <span class="hljs-keyword">ASC</span><font></font>
)<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> t <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> t <span class="hljs-keyword">ASC</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseデータベースの登場は、市場における画期的なイベントになりました。</font><font style="vertical-align: inherit;">すぐに無料でビッグデータを操作するための強力で実用的なツールを手に入れたことを想像するのは困難でした。</font><font style="vertical-align: inherit;">もちろん、ニーズの増加（たとえば、複数のサーバーへのシャーディングとレプリケーション）に伴い、スキームはより複雑になります。</font><font style="vertical-align: inherit;">しかし、第一印象によると、このデータベースでの作業は非常に便利です。</font><font style="vertical-align: inherit;">「人のために」作られているのがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ElasticSearchと比較して、事前の見積もりによると、ログの保存と処理のコストは5倍から10倍に削減されます。言い換えれば、現在のデータ量で複数のマシンのクラスターを構成する必要がある場合、ClickHouseを使用する場合、必要なのは1台の低電力マシンだけです。もちろん、ElasticSearchには、ディスク上のデータを圧縮するメカニズムや、リソースの消費を大幅に削減できるその他の機能もありますが、ClickHouseと比較すると、非常にコストがかかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その部分に特別な最適化を行わなくても、デフォルト設定では、データのロードとデータベースからのデータの取得は驚くべき速度で機能します。</font><font style="vertical-align: inherit;">これまでのところ、データはわずかですが（約2億レコード）、サーバー自体は脆弱です。</font><font style="vertical-align: inherit;">将来的には、このツールをログの保存とは関係のない他の目的に使用することができます。</font><font style="vertical-align: inherit;">たとえば、エンドツーエンドの分析の場合、セキュリティの分野では機械学習です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、長所と短所について少し。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなバンドルでのレコードのダウンロード。</font><font style="vertical-align: inherit;">これは一方では機能ですが、レコードをバッファリングするには追加のコンポーネントを使用する必要があります。</font><font style="vertical-align: inherit;">このタスクは常に単純であるとは限りませんが、解決可能です。</font><font style="vertical-align: inherit;">そして、スキームを簡素化したいと思います。</font></font></li>
<li>          .   ,      . ,   Kafka –   ,       ,   .     Issue  ,        . ,           ,    .</li>
</ol><br>
<h4></h4><br>
<ol>
<li> .</li>
<li>  .</li>
<li>Open-source.</li>
<li>.</li>
<li>  (/ « »)</li>
<li>    ,  .</li>
<li>    .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472896/index.html">プリンターからのヘリコプター：科学者が初めて、ヘリコプターエンジンの大型ケースを「印刷」しました</a></li>
<li><a href="../ja472902/index.html">Windows for IoT：強化されたハードウェアサポートと新しいスマートデバイス機能</a></li>
<li><a href="../ja472904/index.html">Amazonが株をゲームに変える方法</a></li>
<li><a href="../ja472908/index.html">ダガズ：エピソード（パート2）</a></li>
<li><a href="../ja472910/index.html">スマートフォンを使用して看板やパッケージのテキストを検索する</a></li>
<li><a href="../ja472914/index.html">Wolfram関数リポジトリ：Wolfram言語拡張のためのオープンアクセスプラットフォーム</a></li>
<li><a href="../ja472916/index.html">7月のHabrカンファレンスで最も興味深いのは、バックエンド、機械学習、サーバーレスです。</a></li>
<li><a href="../ja472918/index.html">ロシアとCISのZXスペクトラム：オンラインの追求がオフラインでどのように変化したか</a></li>
<li><a href="../ja472922/index.html">エントロピーよりも強力なディフェンダープログラマー</a></li>
<li><a href="../ja472926/index.html">返品を加速する法則（パート1）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>