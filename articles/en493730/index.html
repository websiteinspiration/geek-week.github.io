<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèüÔ∏è ü§ú üéôÔ∏è How not to protect your systems in the cloud üö≤ üñºÔ∏è ‚óΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, when I tell someone about vulnerability, they look at me like a madman with a sign ‚ÄúRepent, for the end of the world is near‚Äù! 
 
 Now everyone...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How not to protect your systems in the cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/technoserv/blog/493730/"><img src="https://habrastorage.org/webt/an/r8/8j/anr88ju9vtr97gbe1rhoz3yhfmm.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often, when I tell someone about vulnerability, they look at me like a madman with a sign ‚ÄúRepent, for the end of the world is near‚Äù! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now everyone is running in a panic and trying to organize a "remote", making simple mistakes, collecting all possible rakes, so I decided to share some dramatic stories with the participation of gypsy hackers, open CVEs and professional, but a bit naive devops. </font><font style="vertical-align: inherit;">Of course, I had to omit some details or even intentionally distort, so as not to upset the customers. </font><font style="vertical-align: inherit;">For the most part, this is not a practice from the current work at Technoserv, but let this post be a small memo on how to not do it, even if you really want to.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to fence the server</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There was a server in the data center. Such an old-school, iron, without any fancy containers and virtualization. Several generations of employees ago, one of the developers configured it ‚Äútemporarily, so that only a few large files for the project are accepted.‚Äù At the same time, the company really cared about information security, but, as often happens, colleagues from IS went to meet the needs of the business and agreed on a temporary option with full access to the Internet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, the server was located in the gray zone of the DMZ and could not connect directly to the critical services of the internal circuit. The 22nd port was set out, and inside, they just added a few local users with individual passwords to log in via ssh / sftp. Access by certificates was considered too inconvenient. Then, developers from another project came running and asked to help automate regular uploads from the counterparty‚Äôs server, because ‚Äúyou have a convenient server with a coordinated access to the network‚Äù. Then again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result was an extremely cheerful situation when the server, it seemed like a temporary one, did not receive any updates, but a bunch of business processes were already tied to it and several terabytes of data were pumped per month.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided to monitor it, since the server is so important, and the CPU‚Äôs graphs immediately have a shelf of 100%. They got it right to sort it out: and there a bunch of rand processes on behalf of the suspicious user test and a bunch of memory consumed by them, and the logs have continuous brute force from around the world. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before putting the server into oblivion, they poked a stick at the processes: lsof immediately showed the deleted, but unclosed files that were still hanging in RAM. Unfortunately, it was not possible to understand exactly what the attacker was doing, but the behavior was more likely to be like a person than working out a script. When examining a script in RAM, inserts like scanez clasa (scanning a class) in Romanian were very pleased:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-keyword">while</span>[<span class="hljs-string">"1"</span>];<span class="hljs-keyword">do</span>
class=<span class="hljs-string">"
#168
"</span>
classb=<span class="hljs-string">"`seq 1 255`"</span>
classb2=(<span class="hljs-variable">$classb</span>)<font></font>
num_classb=<span class="hljs-variable">${#classb2[*]}</span>
b=<span class="hljs-variable">${classb2[$((RANDOM%num_classb))]}</span>
classc=<span class="hljs-string">"`seq 1 255`"</span>
classc2=(<span class="hljs-variable">$classc</span>)<font></font>
num_classc=<span class="hljs-variable">${#classc2[*]}</span>
c=<span class="hljs-variable">${classc2[$((RANDOM%num_classc))]}</span>
classes=(<span class="hljs-variable">$class</span>)<font></font>
num_class=<span class="hljs-variable">${#classes[*]}</span>
a=<span class="hljs-variable">${classes[$((RANDOM%num_class))]}</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"scanez clasa <span class="hljs-variable">${a}</span>.<span class="hljs-variable">${b}</span>"</span>
./a <span class="hljs-variable">${a}</span>.<span class="hljs-variable">${c}</span>
<span class="hljs-keyword">done</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As far as I know, nothing serious has leaked (or they didn‚Äôt tell me about it) and the attacker couldn‚Äôt get into the internal perimeter, but since then the company has been talking about gypsy horse thief hackers.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rules</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not allow temporary convenient, but unsafe solutions to be fixed in the infrastructure. </font><font style="vertical-align: inherit;">Yes, I know that they are inconsistent, but only endure quarantine, but just agree when you will remove them. </font><font style="vertical-align: inherit;">After how many days or hours. </font><font style="vertical-align: inherit;">And clean up without delay. </font><font style="vertical-align: inherit;">Well, at least say it to others, please. </font><font style="vertical-align: inherit;">After all, the exposed service begins to break in an average of 20 minutes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not show ssh and pure RDP to the outside, it is better to provide access via VPN or web tunneling services. </font><font style="vertical-align: inherit;">I don‚Äôt know why, but for them, people are more responsible for the set of allowed accounts and their passwords.</font></font></li>
<li>   ssh ‚Äî    .  .        ssh,    .</li>
<li>   -  ‚Äî   -  fail2ban,   ,  -   .       ¬´¬ª   ¬´¬ª.   ,          . , ,  ,       ‚Äî  . </li>
<li>        ,     : ¬´      ?¬ª     .</li>
<li>        .       .   ,     ,  .</li>
</ol><br>
<h3> IP ‚Äì   ,  firewall !</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I perfectly understand that NAT was a necessary crutch that spoiled the life of developers and did not allow implementing options for quickly connecting nodes to each other. Nevertheless, its side effect of hiding the internal structure of the network is very useful in terms of complicating a regular automated attack. And yes, I understand very well that the most correct option is to use a whitelisted firewall to explicitly allow only the necessary connections. The problem is that in the world of continuous aggail for such trifles as hard configuration of a firewall or God forbid SELinux never has the time and budget. In general, they interfere with debugging, reduce the critical indicator of time-to-market and do not allow developers and devops to live in peace.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The situation became even more interesting when the cloud infrastructure, deployed automatically on demand, became the industry standard. The fact is that most cloud solutions assume that the protection of a heap of raised containers and virtual machines lies with the end user. As a rule, they provide you with the infrastructure, they allocate white IP addresses and that‚Äôs all, in essence, they provide a set of capabilities, not ready-made solutions. By default, everything is closed, but it‚Äôs inconvenient and so prevents development. Therefore, let's open everything and we will calmly test it, but on production we will do it right.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Often this leads to funny cases. I watched one slightly pirated copy of the famous MMORPG server. Clans, donat, continuous discussions of each other's mothers and other joys. Everyone wondered why some characters pumped so fast, and generally omnipotent. I ran nmap through the range of addresses closest to the game server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that the entire infrastructure, including the frontend, backend and database, simply stuck open ports to the outside world. And what is the most likely password for user sa if the database is accessible throughout the Internet? That's right, sa too! As a result, the most difficult thing is to figure out the table structure.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar story was with one customer who opened up remote access to the admin panel for a home machine while working from home for a while. </font><font style="vertical-align: inherit;">Naturally, the admin panel was without authorization, as it was considered a secure internal resource. </font><font style="vertical-align: inherit;">And the customer did not bother and just opened the port for the entire Internet immediately. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And ELK servers open to the world pop up every week. </font><font style="vertical-align: inherit;">What just do not find in their contents. </font><font style="vertical-align: inherit;">Starting from personal data, ending with credit card numbers.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rules</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall must be whitelisted. </font><font style="vertical-align: inherit;">In no case should the backend be accessible from the outside. </font><font style="vertical-align: inherit;">And do not hesitate to ask contractors and remote employees from which IP they will connect. </font><font style="vertical-align: inherit;">In the end, a dedicated IP costs about 150 r / month. This is a feasible waste for the opportunity to work from home.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Always use HTTPS and full authentication, even if they are ‚Äújust‚Äù test machines.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strictly separate test and productive environments. </font><font style="vertical-align: inherit;">Never, never at all, use the same accounts in both environments.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especially often I‚Äôm happy with the Samba server, which is traditionally used to organize shared access to resources. </font><font style="vertical-align: inherit;">Why not set up guest access for colleagues from the neighboring department to conveniently exchange files?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a small company, everything went well until there were no more departments. </font><font style="vertical-align: inherit;">After some time, it was required to configure access to remote branches. </font><font style="vertical-align: inherit;">And a completely ‚Äúreasonable‚Äù solution was to open access to samba from the outside. </font><font style="vertical-align: inherit;">Well, everyone has their own passwords, what could go wrong? </font><font style="vertical-align: inherit;">Nobody remembered about guest access until it turned out that a tangible part of the HDD was clogged with someone else's data. </font><font style="vertical-align: inherit;">Automatic scanners quickly found a free file storage, and the HDD began to clog quickly with someone else's encrypted archives. </font><font style="vertical-align: inherit;">And in one of the directories, we found during the audit a collection of selected films for adults with the participation of actresses 60+ (and it was lucky that not 18-, otherwise it would have flown from law enforcement agencies).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Never share storage without a VPN.</font></font></li>
<li>      samba  ftp-.  ,                .</li>
<li>,          ,  -     .</li>
</ol><br>
<h3>  ,     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I had one customer who did not understand at all why he needed to spend additional amounts on backing up if everything worked for him. </font><font style="vertical-align: inherit;">This is expensive. </font><font style="vertical-align: inherit;">And he‚Äôs fine tuned. </font><font style="vertical-align: inherit;">As a result, employees who open and run everything in a row that they are sent to the mail safely caught an encryption virus. </font><font style="vertical-align: inherit;">They lost the base 1C and were able to restore it only thanks to the paper archive and one contractor who once copied the base to himself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I talked with the leader, explained the key points that need to be changed in the company in order to eliminate the risks of losing the base. </font><font style="vertical-align: inherit;">He nodded throughout the conversation and ended up with a wonderful phrase: ‚ÄúThe projectile does not hit the same hole twice. </font><font style="vertical-align: inherit;">Now there‚Äôs nothing to be afraid of. ‚Äù </font><font style="vertical-align: inherit;">He again refused backups and naturally lost all the data in the same scenario six months later.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rules</font></font></h4><br>
<ol>
<li>   ,     (-   ).   ,        .</li>
<li>        . -    ,          .</li>
<li>         .    .  ,      helpdesk.</li>
</ol><br>
<h3>   !</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my experience, small and medium-sized companies usually start with fully manual user account management. I mean, the new sales manager stomps into the den of bearded admins, where he is solemnly given a login, password and access. All this works well until the company begins to grow. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are the people who sold composite tanks. They recently changed their leadership and it was decided to conduct a full security audit. They even brought us on an excursion to show production. The spectacle is very impressive: in a huge workshop, large workpieces were rotated, on which fiberglass was wound, while workers ran with a bucket of epoxy resin, carefully smearing it over the workpiece.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a separate building they had an administrative wing, where we buried ourselves directly in the organization of the information part of production. At first glance, they had organized a fairly logical scheme, when access to the customer database was provided only through an internal account in AD with the approval of the head. When a person quit, he ran through the checklist, handed over equipment, cards and the account was deactivated. All this was done manually, as funds for full Identity management were not allocated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the audit process, we found that they had implemented a self-written portal many years ago so that salespeople could remotely receive the data they need about customers. They even began to migrate their infrastructure to the cloud, but in the end they stopped halfway due to some internal difficulties. Moreover, AD could not be integrated there and the accounts were deleted exactly the same on the checklist upon dismissal. Everything seems to be normal, but in the logs we found an active account of a certain Vasily, who was fired several years ago and now has successfully worked in a competing company. Moreover, judging by the logs, he unloaded almost the entire client base at least once a month.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The account was immediately blocked and they began to watch how a person was able to circumvent internal regulations. </font><font style="vertical-align: inherit;">It turned out that Vasily first gained access to the portal as a sales manager, and then transferred to a managerial position directly in the workshop, after which he quit. </font><font style="vertical-align: inherit;">But the checklist for dismissal in the workshop is completely different and the account deactivation from the portal was not listed there. </font><font style="vertical-align: inherit;">Although, it would seem, to make a general checklist for access control in all systems and the problem could be avoided.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rules</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have more than 100 employees, consider introducing a full-fledged IDM system.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dismiss data not from the bypass sheet, but directly from the personnel department. </font><font style="vertical-align: inherit;">Layoffs are different and a workaround may not bring you.</font></font></li>
<li>         ‚Äî        .             . ,       ¬´      ,   ¬ª,          ,   ( ,     ,        . .). </li>
<li>      ¬´   ¬ª,  -            .</li>
<li>           .    .</li>
<li>  .       ,       ‚Äî     .        . </li>
</ol><br>
<h3>  ?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For some reason, information security is traditionally perceived as unfriendly individuals who run after everyone with their boring regulations and interfere with their work. In fact, for all the grotesque examples above, they are quite often found in real cases, and it‚Äôs the security guards and paranoid admins that help to avoid them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just try to find a common language. First of all, IS employees themselves should not become watchmen who are engaged only in making the brain a regular password policy without explanation. The right approach is to meet with developers and devs, plunge into their problems. Then develop the right compromise option, which will not only not shine with passwordless access to the outside world, but will be convenient to use.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And devops want to be sometimes at least a little paranoid.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The text was prepared by Vladimir Chikin, Head of Information </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technology at Technoserv Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493718/index.html">Discussion: standard UNIX utilities that few have used and are currently using</a></li>
<li><a href="../en493720/index.html">The perfect storm: how technology is changing the food service industry</a></li>
<li><a href="../en493724/index.html">RPA | Process robotization through the eyes of an analyst</a></li>
<li><a href="../en493726/index.html">Smoking Detection Complex by photo or video based on Intel NUC</a></li>
<li><a href="../en493728/index.html">Nine tips from a meteorologist on the topic: how not to get into a puddle with the weather forecast this spring (on the occasion of March 23)</a></li>
<li><a href="../en493732/index.html">Yesterday it was impossible, but today it is necessary: ‚Äã‚Äãhow to start working remotely and not cause a leak?</a></li>
<li><a href="../en493734/index.html">Perfectionism, cancellation: how technical specialists write articles</a></li>
<li><a href="../en493736/index.html">Security Week 13: Home Safety</a></li>
<li><a href="../en493740/index.html">Results of the online phase of NeoQUEST-2020: survived as best they could</a></li>
<li><a href="../en493742/index.html">How exchange rates and fuel prices depend on oil prices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>