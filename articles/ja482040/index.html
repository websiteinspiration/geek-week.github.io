<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏰ 📮 👲🏾 C ++のプロファイリングプログラムの機能 😺 💍 👨🏿‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="場合によっては、C ++プログラムでプログラムのパフォーマンスまたはメモリ消費をプロファイルする必要があります。残念ながら、これは見かけほど簡単ではありません。
 
 ここでは、valgrindおよびgoogle perftoolsツールを使用したプロファイリングプログラムの機能を検討します。資料は...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C ++のプロファイリングプログラムの機能</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482040/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/xj/sv/vy/xjsvvy62rgww5jixemahqzaz0yi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合によっては、C ++プログラムでプログラムのパフォーマンスまたはメモリ消費をプロファイルする必要があります。</font><font style="vertical-align: inherit;">残念ながら、これは見かけほど簡単ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valgrind</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">google perftoolsツール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用したプロファイリングプログラムの機能を検討します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">資料はあまり構造化されていないことがわかりました。これは、「個人的な目的で」知識ベースを組み立てるための試みであり、将来的に「なぜこれが機能しないのか」または「方法」を必死に覚える必要がないようにします。</font><font style="vertical-align: inherit;">ほとんどの場合、すべての明らかでないケースがここで影響を受けるわけではありません。追加するものがあれば、コメントに書き込んでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての例はLinuxシステムで実行されます。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイムプロファイリング</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロファイリングの機能を分析するために、通常は1つのmain.cppファイルと1つのfunc.cppファイルとインクルージョンで構成される小さなプログラムを実行します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g ++ 8.3.0コンパイラでコンパイルし</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化されていないプログラムのプロファイリングはかなり奇妙なタスクなので、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Ofast</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションを使用してコンパイルし</font><font style="vertical-align: inherit;">、出力にデバッグ文字を取得するために、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-g</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションを追加することを忘れないでください</font><font style="vertical-align: inherit;">。ただし、通常の関数名の代わりに、聞こえない呼び出しアドレスしか表示されない場合があります。これは、「アドレス空間割り当てのランダム化」が行われたことを意味します。これは、</font><b><font style="vertical-align: inherit;">nm</font></b><font style="vertical-align: inherit;">コマンドを呼び出すことで判別できます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリ上。</font><font style="vertical-align: inherit;">ほとんどのアドレスがこの00000000000030e0（最初に多数のゼロ）のように見える場合、これはおそらくそれです。</font><font style="vertical-align: inherit;">通常のプログラムでは、アドレスは0000000000402fa0のようになります。</font><font style="vertical-align: inherit;">したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-no-pie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションを追加する必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">結果として、オプションの完全なセットは次のようになります。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Ofast -g -no-pie</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
結果を表示するに</font><font style="vertical-align: inherit;">は、</font><b><font style="vertical-align: inherit;">callgrind</font></b><font style="vertical-align: inherit;">レポート</font><b><font style="vertical-align: inherit;">形式で</font></b><font style="vertical-align: inherit;">動作</font><font style="vertical-align: inherit;">する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KCachegrind</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムを使用し</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Callgrind</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取り上げる</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のユーティリティは</font><b><font style="vertical-align: inherit;">callgrind</font></b><font style="vertical-align: inherit;">です。このユーティリティは、valgrindツールの一部です。プログラムの各実行可能命令をエミュレートし、各命令の「コスト」に関する内部メトリックに基づいて、必要な結論を出します。このアプローチが原因で、callgrindが次の命令を認識できず、エラーが発生</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">してアドレスに認識されない命令が</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発生する</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つの共有ライブラリと1つの静的ライブラリで構成される、このツールをテストするためのプログラムを作成しましょう（ライブラリは後で他のテストで放棄します）。</font><font style="vertical-align: inherit;">各ライブラリとプログラム自体は、フィボナッチ数列の計算など、単純な計算機能を提供します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static_lib</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">//////////////////</span>
<span class="hljs-comment">// static_lib.h //</span>
<span class="hljs-comment">//////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> SERVER_STATIC_LIB_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SERVER_STATIC_LIB_H</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func_static_lib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//SERVER_STATIC_LIB_H</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">////////////////////</span>
<span class="hljs-comment">// static_lib.cpp //</span>
<span class="hljs-comment">///////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"static_lib.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"static_func.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstddef&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func_static_lib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">return</span> static_func(arg);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">///////////////////</span>
<span class="hljs-comment">// static_func.h //</span>
<span class="hljs-comment">///////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TEST_PROFILER_STATIC_FUNC_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEST_PROFILER_STATIC_FUNC_H</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">static_func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//TEST_PROFILER_STATIC_FUNC_H</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">/////////////////////</span>
<span class="hljs-comment">// static_func.cpp //</span>
<span class="hljs-comment">/////////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"static_func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">static_func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> tmp = (fst + snd) % <span class="hljs-number">17769897</span>;<font></font>
        fst = snd;<font></font>
        snd = tmp;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shared_lib</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">//////////////////</span>
<span class="hljs-comment">// shared_lib.h //</span>
<span class="hljs-comment">//////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TEST_PROFILER_SHARED_LIB_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEST_PROFILER_SHARED_LIB_H</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func_shared_lib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//TEST_PROFILER_SHARED_LIB_H</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">////////////////////</span>
<span class="hljs-comment">// shared_lib.cpp //</span>
<span class="hljs-comment">////////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shared_lib.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shared_func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func_shared_lib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">return</span> shared_func(arg);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">///////////////////</span>
<span class="hljs-comment">// shared_func.h //</span>
<span class="hljs-comment">///////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TEST_PROFILER_SHARED_FUNC_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEST_PROFILER_SHARED_FUNC_H</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shared_func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//TEST_PROFILER_SHARED_FUNC_H</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">/////////////////////</span>
<span class="hljs-comment">// shared_func.cpp //</span>
<span class="hljs-comment">/////////////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shared_func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shared_func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; arg; i++) {<font></font>
        result = (<span class="hljs-keyword">int</span>)(((<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)result * i) % <span class="hljs-number">19637856977</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メイン</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">//////////////</span>
<span class="hljs-comment">// main.cpp //</span>
<span class="hljs-comment">//////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"static_lib.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shared_lib.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Incorrect args"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> arg = <span class="hljs-built_in">std</span>::atoi(argv[<span class="hljs-number">1</span>]);<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"result: "</span> &lt;&lt; func_static_lib(arg) &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; func_shared_lib(arg) &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; func(arg);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">////////////</span>
<span class="hljs-comment">// func.h //</span>
<span class="hljs-comment">////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TEST_PROFILER_FUNC_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TEST_PROFILER_FUNC_H</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">//TEST_PROFILER_FUNC_H</span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//////////////</span>
<span class="hljs-comment">// func.cpp //</span>
<span class="hljs-comment">//////////////</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> res = (fst + snd + <span class="hljs-number">1</span>) % <span class="hljs-number">19845689</span>;<font></font>
        fst = snd;<font></font>
        snd = res;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムをコンパイルし、次のようにvalgrindを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">valgrind --tool=callgrind ./test_profiler 100000000</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/i7/xa/tt/i7xattm3xphucvb3x5ogxlbpv20.png"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
静的ライブラリと通常の関数の場合、結果は期待されるものと同様であることがわかります。</font><font style="vertical-align: inherit;">しかし、ダイナミックライブラリでは、callgrindは関数を完全に解決できませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを修正するには、プログラムを起動する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ときに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次のように</font><b><font style="vertical-align: inherit;">LD_BIND_NOW</font></b><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">を1 </font><font style="vertical-align: inherit;">に設定する必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">LD_BIND_NOW=1 valgrind --tool=callgrind ./test_profiler 100000000</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/nb/l2/yb/nbl2ybqiy6atyd5cak6evogfbem.png"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、ご覧の</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
とおり</font><font style="vertical-align: inherit;">、すべてが順調です。</font><font style="vertical-align: inherit;">命令をエミュレートすることによるプロファイリングから生じる次のコールグリッドの問題は、プログラムの実行が大幅に遅くなることです。これは、コードのさまざまな部分の実行時間の誤った相対推定を運ぶ可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードを見てみましょう：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-function"><span class="hljs-built_in">std</span>::ofstream <span class="hljs-title">file</span><span class="hljs-params">(<span class="hljs-string">"tmp.txt"</span>)</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> res = (fst + snd + <span class="hljs-number">1</span>) % <span class="hljs-number">19845689</span>;<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> r = <span class="hljs-built_in">std</span>::to_string(res);<font></font>
<font></font>
        file &lt;&lt; res;<font></font>
        file.flush();<font></font>
<font></font>
        fst = snd;<font></font>
        snd = res + r.size();<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ループの反復ごとに少量のデータをファイルに追加しました。ファイルへの書き込みはかなり時間がかかる操作であるため、カウンターウェイトとして、ループの各反復に数値から行生成を追加しました。明らかに、この場合、ファイルへの書き込み操作には、関数の残りのロジックよりも時間がかかります。しかし、callgrindの考え方は異なります</font><font style="vertical-align: inherit;">
。callgrindが機能するのは、機能したときの関数のコストしか測定できないことも考慮する価値があります。この機能は機能しません-したがって、コストは増加しません。これは、時々ロックに入る、またはブロッキングファイルシステム/ネットワークで動作するプログラムのデバッグを複雑にします。確認しよう：</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/hn/pg/zt/hnpgztqrtptlu7_g0tmr5frgbuy.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"func.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mutex&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::mutex mutex;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">funcImpl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-function"><span class="hljs-built_in">std</span>::lock_guard&lt;<span class="hljs-built_in">std</span>::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex)</span></span>;<font></font>
<font></font>
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> res = (fst + snd + <span class="hljs-number">1</span>) % <span class="hljs-number">19845689</span>;<font></font>
        fst = snd;<font></font>
        snd = res;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span>{
    <span class="hljs-keyword">return</span> funcImpl(arg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">return</span> funcImpl(arg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Incorrect args"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> arg = <span class="hljs-built_in">std</span>::atoi(argv[<span class="hljs-number">1</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">auto</span> <span class="hljs-built_in">future</span> = <span class="hljs-built_in">std</span>::async(<span class="hljs-built_in">std</span>::launch::async, &amp;func2, arg);<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"result: "</span> &lt;&lt; func(arg) &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"second result "</span> &lt;&lt; <span class="hljs-built_in">future</span>.get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、関数実行全体をミューテックスのロックで囲み、2つの異なるスレッドからこの関数を呼び出しました。</font><font style="vertical-align: inherit;">callgrindの結果は非常に予測可能です-彼はmutexのキャプチャーに問題を認識していません。</font><font style="vertical-align: inherit;">
そこで、callgrindプロファイラーの使用に関するいくつかの問題を調べました。</font><font style="vertical-align: inherit;">次のテスト科目-Google Perftoolsプロファイラーに移りましょう</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/be/eh/nj/beehnjstn0h_kjbjjq2by_randc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">google perftools</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
callgrindとは異なり、googleプロファイラーは異なる原理で動作します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行可能プログラムの各命令を分析する代わりに、プログラムを定期的に一時停止し、現在どの関数にあるかを判別しようとします。その結果、実行中のアプリケーションのパフォーマンスにはほとんど影響しません。しかし、このアプローチには弱点もあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、2つのライブラリを使用して最初のプログラムをプロファイリングしてみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、このユーティリティでプロファイリングを開始するには、libprofiler.soライブラリをプリロードし、サンプリング頻度を設定し、ダンプを保存するファイルを指定する必要があります。</font><font style="vertical-align: inherit;">残念ながら、プロファイラーはプログラムが「それ自体」で終了することを要求します。</font><font style="vertical-align: inherit;">プログラムを強制終了すると、レポートがダンプされなくなります。</font><font style="vertical-align: inherit;">これは、デーモンなど、それ自体は停止しない長命のプログラムをプロファイリングするときに不便です。</font><font style="vertical-align: inherit;">この障害を回避するために、次のスクリプトを作成しました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gprof.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">
rnd=<span class="hljs-variable">$RANDOM</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -eq 0 ]
  <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"./gprof.sh command args"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Run with variable N_STOP=true if hand stop required"</span>
    <span class="hljs-built_in">exit</span>
<span class="hljs-keyword">fi</span><font></font>
<font></font>
libprofiler=$( dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span> )<font></font>
arg=<span class="hljs-variable">$1</span>
nostop=<span class="hljs-variable">$N_STOP</span>
profileName=callgrind.out.<span class="hljs-variable">$rnd</span>.g<font></font>
gperftoolProfile=./gperftool.<span class="hljs-string">"<span class="hljs-variable">$rnd</span>"</span>.txt<font></font>
touch <span class="hljs-variable">$profileName</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Profile name <span class="hljs-variable">$profileName</span>"</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$nostop</span> = <span class="hljs-string">"true"</span> ]]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"without stop"</span>
    <span class="hljs-built_in">trap</span> <span class="hljs-string">'echo trap &amp;&amp; kill -12 $PID &amp;&amp; sleep 1 &amp;&amp; kill -TERM $PID'</span> TERM INT
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">trap</span> <span class="hljs-string">'echo trap &amp;&amp; kill -TERM $PID'</span> TERM INT
<span class="hljs-keyword">fi</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$nostop</span> = <span class="hljs-string">"true"</span> ]]
<span class="hljs-keyword">then</span>
    CPUPROFILESIGNAL=12 CPUPROFILE_FREQUENCY=1000000 CPUPROFILE=<span class="hljs-variable">$gperftoolProfile</span> LD_PRELOAD=<span class="hljs-variable">${libprofiler}</span>/libprofiler.so <span class="hljs-string">"<span class="hljs-variable">${@:1}</span>"</span> &amp;
<span class="hljs-keyword">else</span>
    CPUPROFILE_FREQUENCY=1000000 CPUPROFILE=<span class="hljs-variable">$gperftoolProfile</span> LD_PRELOAD=<span class="hljs-variable">${libprofiler}</span>/libprofiler.so <span class="hljs-string">"<span class="hljs-variable">${@:1}</span>"</span> &amp;
<span class="hljs-keyword">fi</span><font></font>
PID=$!<font></font>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$nostop</span> = <span class="hljs-string">"true"</span> ]]
<span class="hljs-keyword">then</span><font></font>
    sleep 1<font></font>
    <span class="hljs-built_in">kill</span> -12 <span class="hljs-variable">$PID</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">wait</span> <span class="hljs-variable">$PID</span>
<span class="hljs-built_in">trap</span> - TERM INT
<span class="hljs-built_in">wait</span> <span class="hljs-variable">$PID</span><font></font>
EXIT_STATUS=$?<font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$PWD</span>
<span class="hljs-variable">${libprofiler}</span>/pprof --callgrind <span class="hljs-variable">$arg</span> <span class="hljs-variable">$gperftoolProfile</span>* &gt; <span class="hljs-variable">$profileName</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Profile name <span class="hljs-variable">$profileName</span>"</span>
rm -f <span class="hljs-variable">$gperftoolProfile</span>*
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このユーティリティは、実行可能ファイルの名前とそのパラメーターのリストをパラメーターとして渡して実行する必要があります。</font><font style="vertical-align: inherit;">また、スクリプトの隣にlibprofiler.soとpprofが必要なファイルがあると想定されています。</font><font style="vertical-align: inherit;">プログラムが長命で実行の中断により停止する場合は、たとえば次のように、N_STOP変数をtrueに設定する必要があります。</font></font><br>
<pre><code class="bash hljs">N_STOP=<span class="hljs-literal">true</span> ./gprof.sh ./test_profiler 10000000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業の最後に、スクリプトは私のお気に入りのコールグリッド形式でレポートを生成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、このプロファイラの下でプログラムを実行してみましょう</font></font><br>
<pre><code class="bash hljs">./gprof.sh ./test_profiler 1000000000</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/qg/q_/sw/qgq_sw__etaj7mmmrgzvgw_b70c.png"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、すべてがかなり明確です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が言ったように、Googleプロファイラーはプログラムの実行を停止し、現在の関数を計算することによって機能します。</font><font style="vertical-align: inherit;">彼はそれをどのように行うのですか？</font><font style="vertical-align: inherit;">彼はスタックをプロモートすることでこれを行います。</font><font style="vertical-align: inherit;">しかし、スタックのプロモーション時に、プログラム自体がスタックをほどいたとしたらどうでしょうか。</font><font style="vertical-align: inherit;">まあ、明らかに、良いことは何も起こりません。</font><font style="vertical-align: inherit;">それをチェックしよう。</font><font style="vertical-align: inherit;">そのような関数を書いてみましょう：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">runExcept</span><span class="hljs-params">(<span class="hljs-keyword">int</span> res)</span> </span>{
    <span class="hljs-keyword">if</span> (res % <span class="hljs-number">13</span> == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"Exception"</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> res;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> res = (fst + snd + <span class="hljs-number">1</span>) % <span class="hljs-number">19845689</span>;<font></font>
<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            res = runExcept(res);<font></font>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;e) {<font></font>
            res = res - <span class="hljs-number">1</span>;<font></font>
        }<font></font>
<font></font>
        fst = snd;<font></font>
        snd = res;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、プロファイリングを実行します。</font><font style="vertical-align: inherit;">プログラムはすぐにフリーズします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロファイラーの動作機能に関連する別の問題があります。</font><font style="vertical-align: inherit;">スタックの巻き戻しに成功したとしましょう。次に、アドレスをプログラムの特定の関数と一致させる必要があります。</font><font style="vertical-align: inherit;">C ++ではかなり多数の関数がインライン化されるため、これは非常に重要です。</font><font style="vertical-align: inherit;">次のような例を見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"func.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">func1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">return</span> func(arg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">func2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-number">2</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">return</span> func(arg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">func3</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-number">3</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">if</span> (arg % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> func2(arg);<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> func1(arg);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Incorrect args"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> arg = <span class="hljs-built_in">std</span>::atoi(argv[<span class="hljs-number">1</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">int</span> arg2 = func3(arg);
    <span class="hljs-keyword">int</span> arg3 = func(arg);<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"result: "</span> &lt;&lt;  arg2 + arg3;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、たとえば次のようにプログラムを実行すると、</font></font><br>
<pre><code class="bash hljs">./gprof.sh ./test_profiler 1000000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、関数func1は呼び出されません。</font><font style="vertical-align: inherit;">しかし、プロファイラーの考え方は異なります</font><font style="vertical-align: inherit;">
（ちなみに、ここのvalgrindは、穏やかに静かにして、呼び出しがどの特定の関数から来たかを指定しないことにしました）。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/8-/0o/ny/8-0onyayanqwvdarg94cd92srzc.png"></a><br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリプロファイリング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、アプリケーションからのメモリがどこかに「フロー」する場合があります。これがリソースのクリーンアップの不足が原因である場合、Memcheckは問題の特定に役立つはずです。しかし、最近のC ++では、手動のリソース管理なしでそれを行うことはそれほど難しくありません。 unique_ptr、shared_ptr、vector、mapは、ベアポイント操作を無意味にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それにもかかわらず、このようなアプリケーションでは、メモリがリークしていることがあります。これはどのように起こりますか？簡単に言うと、原則として、「長命のマップに値を入れたが、削除するのを忘れた」ようなものです。この状況を追跡してみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、テスト関数を次のように書き換えます</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"func.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;deque&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;map&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">deque</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; <span class="hljs-built_in">deque</span>;
<span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">map</span>&lt;<span class="hljs-keyword">int</span>, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; <span class="hljs-built_in">map</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>{
    <span class="hljs-keyword">int</span> fst = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> snd = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; arg; i++) {
        <span class="hljs-keyword">int</span> res = (fst + snd + <span class="hljs-number">1</span>) % <span class="hljs-number">19845689</span>;<font></font>
<font></font>
        fst = snd;<font></font>
        snd = res;<font></font>
<font></font>
        <span class="hljs-built_in">deque</span>.emplace_back(<span class="hljs-built_in">std</span>::to_string(res) + <span class="hljs-string">" integer"</span>);
        <span class="hljs-built_in">map</span>[i] = <span class="hljs-string">"integer "</span> + <span class="hljs-built_in">std</span>::to_string(res);
        <span class="hljs-built_in">deque</span>.pop_front();
        <span class="hljs-keyword">if</span> (res % <span class="hljs-number">200</span> != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">map</span>.erase(i - <span class="hljs-number">1</span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> fst;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、各反復で、いくつかの要素をマップに追加しますが、偶然（true、true）、それらを時々そこから削除するのを忘れています。</font><font style="vertical-align: inherit;">また、目をそらすために、std :: dequeを拷問します。</font><b><font style="vertical-align: inherit;">valgrind massif</font></b><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">google heapdumpの</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2つのツールでメモリリークを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検出し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マッシフ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコマンドでプログラムを実行します</font></font><br>
<pre><code class="bash hljs">valgrind --tool=massif  ./test_profiler 1000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちは次のようなものを見ます</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マッシフ</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">time=<span class="hljs-number">1277949333</span>
mem_heap_B=<span class="hljs-number">313518</span>
mem_heap_extra_B=<span class="hljs-number">58266</span>
mem_stacks_B=<span class="hljs-number">0</span><font></font>
heap_tree=detailed<font></font>
n4: <span class="hljs-number">313518</span> (heap allocation functions) <span class="hljs-built_in">malloc</span>/<span class="hljs-keyword">new</span>/<span class="hljs-keyword">new</span>[], --alloc-fns, etc.<font></font>
 n1: <span class="hljs-number">195696</span> <span class="hljs-number">0x109A69</span>: func(<span class="hljs-keyword">int</span>) (new_allocator.h:<span class="hljs-number">111</span>)<font></font>
  n0: <span class="hljs-number">195696</span> <span class="hljs-number">0x10947A</span>: main (main.cpp:<span class="hljs-number">18</span>)<font></font>
 n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x52BA414</span>: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="hljs-number">.6</span><span class="hljs-number">.0</span><span class="hljs-number">.25</span>)<font></font>
  n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x4010731</span>: _dl_init (dl-init.c:<span class="hljs-number">72</span>)<font></font>
   n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x40010C8</span>: ??? (in /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.27</span>.so)<font></font>
    n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x0</span>: ???<font></font>
     n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x1FFF0000D1</span>: ???<font></font>
      n0: <span class="hljs-number">72704</span> <span class="hljs-number">0x1FFF0000E1</span>: ???<font></font>
 n2: <span class="hljs-number">42966</span> <span class="hljs-number">0x10A7EC</span>: <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;::_M_mutate(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span>*, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (new_allocator.h:<span class="hljs-number">111</span>)<font></font>
  n1: <span class="hljs-number">42966</span> <span class="hljs-number">0x10AAD9</span>: <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;::_M_replace(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span>*, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (basic_string.tcc:<span class="hljs-number">466</span>)<font></font>
   n1: <span class="hljs-number">42966</span> <span class="hljs-number">0x1099D4</span>: func(<span class="hljs-keyword">int</span>) (basic_string.h:<span class="hljs-number">1932</span>)<font></font>
    n0: <span class="hljs-number">42966</span> <span class="hljs-number">0x10947A</span>: main (main.cpp:<span class="hljs-number">18</span>)<font></font>
  n0: <span class="hljs-number">0</span> in <span class="hljs-number">2</span> places, all below massif<span class="hljs-number">'</span>s threshold (<span class="hljs-number">1.00</span>%)<font></font>
 n0: <span class="hljs-number">2152</span> in <span class="hljs-number">10</span> places, all below massif<span class="hljs-number">'</span>s threshold (<span class="hljs-number">1.00</span>%)</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
massifが関数のリークを検出できたことがわかりますが、これまでのところどこが明確ではありません。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-fno-inline</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグ</font><font style="vertical-align: inherit;">を指定</font><font style="vertical-align: inherit;">してプログラムを再構築し</font><font style="vertical-align: inherit;">、分析を再度実行して</font><font style="vertical-align: inherit;">みましょう</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">山塊</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">time=<span class="hljs-number">3160199549</span>
mem_heap_B=<span class="hljs-number">345142</span>
mem_heap_extra_B=<span class="hljs-number">65986</span>
mem_stacks_B=<span class="hljs-number">0</span><font></font>
heap_tree=detailed<font></font>
n4: <span class="hljs-number">345142</span> (heap allocation functions) <span class="hljs-built_in">malloc</span>/<span class="hljs-keyword">new</span>/<span class="hljs-keyword">new</span>[], --alloc-fns, etc.<font></font>
 n1: <span class="hljs-number">221616</span> <span class="hljs-number">0x10CDBC</span>: <span class="hljs-built_in">std</span>::_Rb_tree_node&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt;* <span class="hljs-built_in">std</span>::_Rb_tree&lt;<span class="hljs-keyword">int</span>, <span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt;, <span class="hljs-built_in">std</span>::_Select1st&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in">std</span>::less&lt;<span class="hljs-keyword">int</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt; &gt;::_M_create_node&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">piecewise_construct_t</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-built_in">std</span>::tuple&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>&amp;&gt;, <span class="hljs-built_in">std</span>::tuple&lt;&gt; &gt;(<span class="hljs-built_in">std</span>::<span class="hljs-keyword">piecewise_construct_t</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-built_in">std</span>::tuple&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>&amp;&gt;&amp;&amp;, <span class="hljs-built_in">std</span>::tuple&lt;&gt;&amp;&amp;) [clone .isra<span class="hljs-number">.81</span>] (stl_tree.h:<span class="hljs-number">653</span>)<font></font>
  n1: <span class="hljs-number">221616</span> <span class="hljs-number">0x10CE0C</span>: <span class="hljs-built_in">std</span>::_Rb_tree_iterator&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt; <span class="hljs-built_in">std</span>::_Rb_tree&lt;<span class="hljs-keyword">int</span>, <span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt;, <span class="hljs-built_in">std</span>::_Select1st&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in">std</span>::less&lt;<span class="hljs-keyword">int</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt; &gt;::_M_emplace_hint_unique&lt;<span class="hljs-built_in">std</span>::<span class="hljs-keyword">piecewise_construct_t</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-built_in">std</span>::tuple&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>&amp;&gt;, <span class="hljs-built_in">std</span>::tuple&lt;&gt; &gt;(<span class="hljs-built_in">std</span>::_Rb_tree_const_iterator&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt;, <span class="hljs-built_in">std</span>::<span class="hljs-keyword">piecewise_construct_t</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-built_in">std</span>::tuple&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>&amp;&gt;&amp;&amp;, <span class="hljs-built_in">std</span>::tuple&lt;&gt;&amp;&amp;) [clone .constprop<span class="hljs-number">.87</span>] (stl_tree.h:<span class="hljs-number">2414</span>)<font></font>
   n1: <span class="hljs-number">221616</span> <span class="hljs-number">0x10CF2B</span>: <span class="hljs-built_in">std</span>::<span class="hljs-built_in">map</span>&lt;<span class="hljs-keyword">int</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;, <span class="hljs-built_in">std</span>::less&lt;<span class="hljs-keyword">int</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; &gt; &gt; &gt;::<span class="hljs-keyword">operator</span>[](<span class="hljs-keyword">int</span> <span class="hljs-keyword">const</span>&amp;) (stl_map.h:<span class="hljs-number">499</span>)<font></font>
    n1: <span class="hljs-number">221616</span> <span class="hljs-number">0x10A7F5</span>: func(<span class="hljs-keyword">int</span>) (func.cpp:<span class="hljs-number">20</span>)<font></font>
     n0: <span class="hljs-number">221616</span> <span class="hljs-number">0x109F8E</span>: main (main.cpp:<span class="hljs-number">18</span>)<font></font>
 n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x52BA414</span>: ??? (in /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="hljs-number">.6</span><span class="hljs-number">.0</span><span class="hljs-number">.25</span>)<font></font>
  n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x4010731</span>: _dl_init (dl-init.c:<span class="hljs-number">72</span>)<font></font>
   n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x40010C8</span>: ??? (in /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.27</span>.so)<font></font>
    n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x0</span>: ???<font></font>
     n1: <span class="hljs-number">72704</span> <span class="hljs-number">0x1FFF0000D1</span>: ???<font></font>
      n0: <span class="hljs-number">72704</span> <span class="hljs-number">0x1FFF0000E1</span>: ???<font></font>
 n2: <span class="hljs-number">48670</span> <span class="hljs-number">0x10B866</span>: <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;::_M_mutate(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span>*, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (basic_string.tcc:<span class="hljs-number">317</span>)<font></font>
  n1: <span class="hljs-number">48639</span> <span class="hljs-number">0x10BB2C</span>: <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;::_M_replace(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span>*, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (basic_string.tcc:<span class="hljs-number">466</span>)<font></font>
   n1: <span class="hljs-number">48639</span> <span class="hljs-number">0x10A643</span>: <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt; <span class="hljs-built_in">std</span>::<span class="hljs-keyword">operator</span>+&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;(<span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span>*, <span class="hljs-built_in">std</span>::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>, <span class="hljs-built_in">std</span>::char_traits&lt;<span class="hljs-keyword">char</span>&gt;, <span class="hljs-built_in">std</span>::allocator&lt;<span class="hljs-keyword">char</span>&gt; &gt;&amp;&amp;) [clone .constprop<span class="hljs-number">.86</span>] (basic_string.h:<span class="hljs-number">6018</span>)<font></font>
    n1: <span class="hljs-number">48639</span> <span class="hljs-number">0x10A7E5</span>: func(<span class="hljs-keyword">int</span>) (func.cpp:<span class="hljs-number">20</span>)<font></font>
     n0: <span class="hljs-number">48639</span> <span class="hljs-number">0x109F8E</span>: main (main.cpp:<span class="hljs-number">18</span>)<font></font>
  n0: <span class="hljs-number">31</span> in <span class="hljs-number">1</span> place, below massif<span class="hljs-number">'</span>s threshold (<span class="hljs-number">1.00</span>%)<font></font>
 n0: <span class="hljs-number">2152</span> in <span class="hljs-number">10</span> places, all below massif<span class="hljs-number">'</span>s threshold (<span class="hljs-number">1.00</span>%)</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、マップ要素の追加でリークが発生している場所が明らかになりました。</font><font style="vertical-align: inherit;">Massifは存続期間の短いオブジェクトを検出できるため、std :: dequeを使用した操作はこのダンプでは見えません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒープダンプ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
google </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heapdumpを機能さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">せるには、</font><b><font style="vertical-align: inherit;">tcmalloc</font></b><font style="vertical-align: inherit;">ライブラリをリンクまたはプリロードする必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このライブラリは、メモリ割り当ての標準関数malloc、free、...を置き換えます。また、これらの関数の使用に関する情報を収集できます。これは、プログラムの分析時に使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法は（massifと比較しても）非常に遅いため、コンパイル時に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-fno-inline</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションを使用して関数のコンパイルをすぐに無効にすることをお勧めします</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そのため、アプリケーションを再構築してチームで実行します</font></font><br>
<pre><code class="bash hljs">HEAPPROFILESIGNAL=23 HEAPPROFILE=./heap ./test_profiler 100000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、tcmallocライブラリがアプリケーションにリンクされていると想定しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、顕著なリークの形成に必要な時間を待って、プロセスにシグナルを送信します23</font></font><br>
<pre><code class="bash hljs"><span class="hljs-built_in">kill</span> -23 &lt;pid&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、heap.0001.heapというファイルが表示されます。このファイルを次のコマンドでcallgrind形式に変換します</font></font><br>
<br>
<pre><code class="bash hljs">pprof ./test_profiler <span class="hljs-string">"./heap.0001.heap"</span> --inuse_space --callgrind &gt; callgrind.out.4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、pprofオプションにも注意してください。</font><font style="vertical-align: inherit;">オプション</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inuse_space</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inuse_objects</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc_space</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc_objects</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から選択できます</font><font style="vertical-align: inherit;">。これらは、使用中のスペースまたはオブジェクト、またはプログラムの全期間に割り当てられたスペースとオブジェクトをそれぞれ示します。</font><font style="vertical-align: inherit;">現在使用されているメモリ空間を示すinuse_spaceオプションに興味があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気に入りのkCacheGrindを開くと、</font><font style="vertical-align: inherit;">
std :: mapが「食べ過ぎ」ているメモリが多すぎる</font><font style="vertical-align: inherit;">ことがわかり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">おそらくそこに漏れがあります。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/of/z2/j8/ofz2j88agvmi4bhfyhigracbn-i.png"></a><br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++でのプロファイリングは非常に困難な作業です。</font><font style="vertical-align: inherit;">ここでは、関数のインライン化、サポートされていない命令、不正な結果などに対処する必要があります。</font><font style="vertical-align: inherit;">プロファイラーの結果を常に信頼できるとは限りません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記で提案された機能に加えて、プロファイリング用に設計された他のツール-perf、intel VTuneなどがあります。</font><font style="vertical-align: inherit;">しかし、彼らはまた、これらの欠点のいくつかを示しています。</font><font style="vertical-align: inherit;">したがって、関数の実行時間を測定してログに表示することで、プロファイリングの「祖父」方式を忘れないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、コードのプロファイリングに興味深いテクニックがある場合は、コメントに投稿してください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja482028/index.html">2つの赤いボタン、はんだごてとReact：IT会議への移行方法</a></li>
<li><a href="../ja482030/index.html">Vue.js：サードパーティコンポーネントのライフサイクルフック</a></li>
<li><a href="../ja482032/index.html">火遊び：開発iPhone 7で任意のコードを起動</a></li>
<li><a href="../ja482034/index.html">Yandex：ユーザーについてのすべてがあります...</a></li>
<li><a href="../ja482038/index.html">2019年の結果をHabr Careerでまとめています</a></li>
<li><a href="../ja482042/index.html">実際の例でNewtonsoft.Jsonライブラリを操作します。パート2</a></li>
<li><a href="../ja482044/index.html">Dockerイメージセキュリティのベストプラクティス10 パート2</a></li>
<li><a href="../ja482050/index.html">Jedi畳み込みネットワーク削減手法-剪定</a></li>
<li><a href="../ja482052/index.html">新年のデータセット2019：ロシア語の音調辞書を開く</a></li>
<li><a href="../ja482054/index.html">3.エラスティックスタック：セキュリティログ分析。ダッシュボード</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>