<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆘 🧔🏾 👩🏻‍⚖️ PHP匿名関数：ブラックマジックセッションの公開 🕦 👨🏼‍🍳 🐭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="おそらく、PHPの無名関数（クロージャー）は関数ではなく、クロージャークラスのオブジェクトであるという事実から始める必要があります。実はこの記事は完成していたかもしれませんが、詳細に興味のある方は猫へようこそ。
 
 
 根拠がないようにするために：
 

$func = function (){}...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHP匿名関数：ブラックマジックセッションの公開</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/478596/"><img src="https://habrastorage.org/webt/r6/gx/7h/r6gx7hxhbqlathbjqby__emcvj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、PHPの無名関数（クロージャー）は関数ではなく、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロージャー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスのオブジェクトであるという事実から始める必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">実はこの記事は完成していたかもしれませんが、詳細に興味のある方は猫へようこそ。</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根拠がないようにするために：</font></font><br>
<pre><code class="php hljs">$func = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{};<font></font>
var_dump($func);<font></font>
<font></font>
---------<font></font>
<span class="hljs-keyword">object</span>(<span class="hljs-built_in">Closure</span>)<span class="hljs-comment">#1 (0) {</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これからは、これは普通のオブジェクトではないと言います。</font><font style="vertical-align: inherit;">それを理解しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、そのようなコード</font></font><br>
<pre><code class="php hljs">$func = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Hello world!'</span>;<font></font>
};<font></font>
$func();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような一連のオペコードにコンパイルします。</font></font><br>
<pre><code class="php hljs">line     <span class="hljs-comment">#* E I O op                       fetch   ext  return  operands</span><font></font>
--------------------------------------------------------------------------<font></font>
   <span class="hljs-number">8</span>     <span class="hljs-number">0</span>  E &gt;   DECLARE_LAMBDA_FUNCTION                       <span class="hljs-string">'%00%7Bclosure%7D%2Fin%2FcrvX50x7fabda9ed09e'</span>
  <span class="hljs-number">10</span>     <span class="hljs-number">1</span>        ASSIGN                                        !<span class="hljs-number">0</span>, ~<span class="hljs-number">1</span>
  <span class="hljs-number">11</span>     <span class="hljs-number">2</span>        INIT_DYNAMIC_CALL                             !<span class="hljs-number">0</span>
         <span class="hljs-number">3</span>        DO_FCALL                         <span class="hljs-number">0</span>          
  <span class="hljs-number">11</span>     <span class="hljs-number">2</span>      &gt; <span class="hljs-keyword">RETURN</span>                                        <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">Function</span> %00%7<span class="hljs-title">Bclosure</span>%7<span class="hljs-title">D</span>%2<span class="hljs-title">Fin</span>%2<span class="hljs-title">FcrvX50x7fabda9ed09e</span>:
<span class="hljs-title">function</span> <span class="hljs-title">name</span>:  </span>{<span class="hljs-built_in">closure</span>}<font></font>
line     <span class="hljs-comment">#* E I O op                       fetch   ext  return  operands</span><font></font>
--------------------------------------------------------------------------<font></font>
   <span class="hljs-number">9</span>     <span class="hljs-number">0</span>  E &gt;   <span class="hljs-keyword">ECHO</span>                                          <span class="hljs-string">'Hello+world%21'</span>
  <span class="hljs-number">10</span>     <span class="hljs-number">1</span>      &gt; <span class="hljs-keyword">RETURN</span>                                        <span class="hljs-literal">null</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数本体の説明を含むブロックは特に興味深いものではありませんが、最初のブロックには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DECLARE_LAMBDA_FUNCTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INIT_DYNAMIC_CALLの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つの興味深いオペコードが</font><font style="vertical-align: inherit;">あり</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">2つ目から始めましょう。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INIT_DYNAMIC_CALL</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このオペコードは、コンパイラが変数または配列の関数呼び出しを検出したときに使用されます。</font><font style="vertical-align: inherit;">それら。</font></font><br>
<pre><code class="php hljs">$variable();<font></font>
[<span class="hljs-string">'ClassName'</span>, <span class="hljs-string">'staticMethod'</span>]();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、クロージャーのみに固有のオペコードではありません。この構文は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__ invoke（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドを呼び出すことによるオブジェクト</font><font style="vertical-align: inherit;">、関数名（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ a = 'funcName'; $ a（）;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を含む文字列変数</font><font style="vertical-align: inherit;">、およびクラス名と静的メソッドを含む配列に対しても機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロージャの場合、論理的なオブジェクトを持つ変数を呼び出すことに関心があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このオペコードを処理するVMコードをさらに</font><font style="vertical-align: inherit;">詳しく見ていくと</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zend_init_dynamic_call_object</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">に</font><b><font style="vertical-align: inherit;">到達し</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。ここでは、次のようになります（スライス）。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">zend_execute_data *<span class="hljs-title">zend_init_dynamic_call_object</span><span class="hljs-params">(zend_object *function, <span class="hljs-keyword">uint32_t</span> num_args)</span>
</span>{<font></font>
	zend_function *fbc;<font></font>
	zend_class_entry *called_scope;<font></font>
	zend_object *object;<font></font>
	...<font></font>
	<span class="hljs-keyword">if</span> (EXPECTED(function-&gt;handlers-&gt;get_closure) &amp;&amp;<font></font>
	    EXPECTED(function-&gt;handlers-&gt;get_closure(function, &amp;called_scope, &amp;fbc, &amp;object) == SUCCESS)) {<font></font>
		...<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		zend_throw_error(<span class="hljs-literal">NULL</span>, <span class="hljs-string">"Function name must be a string"</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
	}<font></font>
	...<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VMに関して</font><font style="vertical-align: inherit;">おなじみの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__invoke</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><b><font style="vertical-align: inherit;">呼び出し</font></b><font style="vertical-align: inherit;">が、クロージャ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-get_closure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を呼び出そうとするのは</font><b><font style="vertical-align: inherit;">おかしい</font></b><font style="vertical-align: inherit;">です。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、この時点での違いは、無名関数の呼び出しと</font><font style="vertical-align: inherit;">通常のオブジェクトの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__invoke</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの処理で始まり</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPでは、すべてのオブジェクトに、そのユーティリティとマジックメソッドを定義する一連の異なるハンドラがあります。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準セットはこんな感じ</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">ZEND_API <span class="hljs-keyword">const</span> zend_object_handlers std_object_handlers = {
  <span class="hljs-number">0</span>,                       <span class="hljs-comment">/* offset */</span>
   zend_object_std_dtor,         <span class="hljs-comment">/* free_obj */</span>
  zend_objects_destroy_object,    <span class="hljs-comment">/* dtor_obj */</span>
  zend_objects_clone_obj,           <span class="hljs-comment">/* clone_obj */</span>
  zend_std_read_property,           <span class="hljs-comment">/* read_property */</span>
  zend_std_write_property,       <span class="hljs-comment">/* write_property */</span>
  zend_std_read_dimension,       <span class="hljs-comment">/* read_dimension */</span>
  zend_std_write_dimension,      <span class="hljs-comment">/* write_dimension */</span>
  zend_std_get_property_ptr_ptr,  <span class="hljs-comment">/* get_property_ptr_ptr */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* get */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* set */</span>
  zend_std_has_property,        <span class="hljs-comment">/* has_property */</span>
  zend_std_unset_property,       <span class="hljs-comment">/* unset_property */</span>
  zend_std_has_dimension,           <span class="hljs-comment">/* has_dimension */</span>
  zend_std_unset_dimension,      <span class="hljs-comment">/* unset_dimension */</span>
  zend_std_get_properties,       <span class="hljs-comment">/* get_properties */</span>
  zend_std_get_method,          <span class="hljs-comment">/* get_method */</span>
  zend_std_get_constructor,      <span class="hljs-comment">/* get_constructor */</span>
  zend_std_get_class_name,       <span class="hljs-comment">/* get_class_name */</span>
  zend_std_compare_objects,      <span class="hljs-comment">/* compare_objects */</span>
  zend_std_cast_object_tostring,  <span class="hljs-comment">/* cast_object */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* count_elements */</span>
  zend_std_get_debug_info,       <span class="hljs-comment">/* get_debug_info */</span>
  <span class="hljs-comment">/* ------- */</span>
  zend_std_get_closure,         <span class="hljs-comment">/* get_closure */</span>
  <span class="hljs-comment">/* ------- */</span>
  zend_std_get_gc,             <span class="hljs-comment">/* get_gc */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* do_operation */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* compare */</span>
  <span class="hljs-literal">NULL</span>,                     <span class="hljs-comment">/* get_properties_for */</span>
};</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_closure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラーに注目し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">通常のオブジェクトの場合、これは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zend_std_get_closure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を</font><b><font style="vertical-align: inherit;">指し</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。これは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__ invoke</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数がオブジェクトに対して定義されていることを確認し、そのオブジェクト</font><font style="vertical-align: inherit;">へのポインターまたはエラーを返します。</font><font style="vertical-align: inherit;">ただし、</font><font style="vertical-align: inherit;">匿名関数を実装</font><font style="vertical-align: inherit;">する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Closure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスの</font><font style="vertical-align: inherit;">場合、ライフサイクルを制御するユーティリティ関数を含むほとんどすべてのユーティリティ関数は、このハンドラーの配列で再定義されます。</font><font style="vertical-align: inherit;">それら。</font><font style="vertical-align: inherit;">ユーザーにとっては普通のオブジェクトのように見えますが、実際にはそれは超能力を持つ変異体です:)</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Closureクラスのオブジェクトのハンドラーを登録する</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zend_register_closure_ce</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> <span class="hljs-comment">/* {{{ */</span>
</span>{<font></font>
	zend_class_entry ce;<font></font>
<font></font>
	INIT_CLASS_ENTRY(ce, <span class="hljs-string">"Closure"</span>, closure_functions);<font></font>
	zend_ce_closure = zend_register_internal_class(&amp;ce);<font></font>
	zend_ce_closure-&gt;ce_flags |= ZEND_ACC_FINAL;<font></font>
	zend_ce_closure-&gt;create_object = zend_closure_new;<font></font>
	zend_ce_closure-&gt;serialize = zend_class_serialize_deny;<font></font>
	zend_ce_closure-&gt;unserialize = zend_class_unserialize_deny;<font></font>
<font></font>
	<span class="hljs-built_in">memcpy</span>(&amp;closure_handlers, &amp;std_object_handlers, <span class="hljs-keyword">sizeof</span>(zend_object_handlers));<font></font>
	closure_handlers.free_obj = zend_closure_free_storage;<font></font>
	closure_handlers.get_constructor = zend_closure_get_constructor;<font></font>
	closure_handlers.get_method = zend_closure_get_method;<font></font>
	closure_handlers.write_property = zend_closure_write_property;<font></font>
	closure_handlers.read_property = zend_closure_read_property;<font></font>
	closure_handlers.get_property_ptr_ptr = zend_closure_get_property_ptr_ptr;<font></font>
	closure_handlers.has_property = zend_closure_has_property;<font></font>
	closure_handlers.unset_property = zend_closure_unset_property;<font></font>
	closure_handlers.compare_objects = zend_closure_compare_objects;<font></font>
	closure_handlers.clone_obj = zend_closure_clone;<font></font>
	closure_handlers.get_debug_info = zend_closure_get_debug_info;<font></font>
        <span class="hljs-comment">/* ------- */</span><font></font>
	closure_handlers.get_closure = zend_closure_get_closure;<font></font>
        <span class="hljs-comment">/* ------- */</span><font></font>
	closure_handlers.get_gc = zend_closure_get_gc;<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マニュアルは言う：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで説明するメソッドに加えて、このクラスには</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__invoke</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドもあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">このメソッドは関数の呼び出し時に使用されないため、このメソッドは、マジックコールが実装されている他のクラスとの互換性のためにのみ必要です。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それは本当です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_closureの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font><font style="vertical-align: inherit;">閉鎖のためには戻りません</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__invoke</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、クロージャが作成されたあなたの関数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースを自分で詳細に調べることができます-ファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zend_closure.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次のオペコードに</font><b><font style="vertical-align: inherit;">進み</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DECLARE_LAMBDA_FUNCTION</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは回路専用のオペコードであり、もはや何も機能していません。</font><font style="vertical-align: inherit;">プロセッサの内部では、3つの主要な操作があります。</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイルされた関数へのポインタが求められます。これがクロージャの本質になります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロージャのコンテキストが定義されます（つまり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の2つのポイントに基づいて、クラス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Closureの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト</font><b><font style="vertical-align: inherit;">が作成され</font></b><font style="vertical-align: inherit;">ます。</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、この場所であまり楽しいニュースが始まりません。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、無名関数の何が問題になっていますか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロージャーを作成することは、通常のオブジェクトを作成することよりも難しい操作です。オブジェクトを作成するための標準的なメカニズムが呼び出されるだけでなく、一定量のロジックが追加されますが、最も不愉快なのは、関数のオペコードの配列全体をクロージャーの本体にコピーすることです。これ自体はそれほど怖くはありませんが、「誤って」使用を開始するまではまったく同じです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題が待ち受けている場所を正確に理解するために、クロージャーが作成された場合のケースを分析します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロージャは新たに作成されます：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a）DECLARE_LAMBDA_FUNCTION </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opcodeの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各処理で</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
直感的に-クロージャが適切に見える場合とまったく同じですが、実際には、ループの各反復で新しいクロージャが作成されます。</font></font><br>
<pre><code class="php hljs"><span class="hljs-keyword">foreach</span>($values <span class="hljs-keyword">as</span> $value){<font></font>
	doSomeStuff($value, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$args</span>) </span>{ closureBody });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
b）</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bind </font></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">bindToメソッド</font></b><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">呼び出すたびに</font></b><font style="vertical-align: inherit;">：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、クロージャーは各反復で再度作成されます。</font></font><br>
<pre><code class="php hljs">$closure = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$args</span>) </span>{ closureBody };
<span class="hljs-keyword">foreach</span>($objects <span class="hljs-keyword">as</span> $object){<font></font>
	$closure-&gt;bindTo($object);<font></font>
	$object-&gt;doSomeStuff($closure);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
c）</font><font style="vertical-align: inherit;">ジェネレータが関数として使用されている場合</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドが</font><b><font style="vertical-align: inherit;">呼び出される</font></b><font style="vertical-align: inherit;">たび</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、ジェネレーターではなく、通常の関数である場合、オペコードの配列をコピーする部分のみが実行されます。</font><font style="vertical-align: inherit;">だからそうなるのです。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンスがどうしても重要でない場合は、匿名関数が便利で楽しいです。</font><font style="vertical-align: inherit;">そして、もし重要なら、おそらくそれだけの価値はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いずれにせよ、クロージャとサイクルが正しく準備されていなければ、そのような組み合わせであることを知っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご清聴ありがとうございました！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478582/index.html">2019年のモバイルデバイスに関するグローバルVPNレポート</a></li>
<li><a href="../ja478584/index.html">JVMの内部、パート2-クラスファイルの構造</a></li>
<li><a href="../ja478586/index.html">非効率</a></li>
<li><a href="../ja478590/index.html">マイクロサービスを使用してもよろしいですか？</a></li>
<li><a href="../ja478594/index.html">VFXデザイナーのために読むべき上位5冊の本</a></li>
<li><a href="../ja478602/index.html">UnityのMVCとスクリプト可能なオブジェクト。パート2</a></li>
<li><a href="../ja478604/index.html">労働者からPHPプログラマーまで。異常な開発経歴</a></li>
<li><a href="../ja478606/index.html">「おやすみ」-スマートガジェットが人々の睡眠を奪う方法</a></li>
<li><a href="../ja478616/index.html">Windows UACは驚かずにはいられません、またはインサイダーを検出する方法</a></li>
<li><a href="../ja478618/index.html">魔法のPHPの学校</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>