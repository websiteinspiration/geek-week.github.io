<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêî ü§∏üèª ‚ÜòÔ∏è Hist√≥ria de como criar uma m√°quina do tempo para um banco de dados e escrever acidentalmente uma explora√ß√£o üë®‚Äçüë©‚Äçüëß‚Äçüëß üò° üí™üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bom dia, Habr. 
 
 Voc√™ j√° se perguntou como alterar o tempo dentro do banco de dados? F√°cil? Bem, em alguns casos, sim, √© f√°cil - o comando linux dat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hist√≥ria de como criar uma m√°quina do tempo para um banco de dados e escrever acidentalmente uma explora√ß√£o</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503804/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bom dia, Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ j√° se perguntou como alterar o tempo dentro do banco de dados? </font><font style="vertical-align: inherit;">F√°cil? </font><font style="vertical-align: inherit;">Bem, em alguns casos, sim, √© f√°cil - o comando linux date e a coisa est√£o no chap√©u. </font><font style="vertical-align: inherit;">E se voc√™ precisar alterar o hor√°rio apenas dentro de uma inst√¢ncia do banco de dados, se houver v√°rios deles no servidor? </font><font style="vertical-align: inherit;">E para um √∫nico processo de banco de dados? </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E? </font><font style="vertical-align: inherit;">√â isso a√≠, meu amigo, esse √© o ponto.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algu√©m dir√° que esse √© outro sur, n√£o relacionado √† realidade, que √© periodicamente apresentado em Habr√©. </font><font style="vertical-align: inherit;">Mas n√£o, a tarefa √© bastante real e √© ditada pela necessidade de produ√ß√£o - teste de c√≥digo. </font><font style="vertical-align: inherit;">Embora eu concorde, o caso de teste pode ser bastante ex√≥tico - verifique como o c√≥digo se comporta para uma determinada data no futuro. </font><font style="vertical-align: inherit;">Neste artigo, examinarei em detalhes como essa tarefa foi resolvida e, ao mesmo tempo, capturamos um pouco o processo de organiza√ß√£o de teste e desenvolvimento para a base do Oracle. </font><font style="vertical-align: inherit;">Antes de uma longa leitura, fique √† vontade e pe√ßa um gato.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com uma breve introdu√ß√£o para mostrar por que isso √© necess√°rio. Como j√° anunciado, escrevemos testes ao implementar edi√ß√µes no banco de dados. O sistema sob o qual esses testes s√£o realizados foi desenvolvido no in√≠cio (ou talvez um pouco antes do in√≠cio) dos zero, portanto toda a l√≥gica de neg√≥cios est√° dentro do banco de dados e escrita na forma de procedimentos armazenados na linguagem pl / sql. E sim, isso nos traz dor e sofrimento. Mas isso √© legado, e voc√™ tem que viver com ele. No c√≥digo e no modelo tabular, √© poss√≠vel especificar como os par√¢metros dentro do sistema evoluem ao longo do tempo, ou seja, definem a atividade a partir de qual data e em que data eles podem ser aplicados. O que ir longe - a recente mudan√ßa na taxa de IVA √© um exemplo v√≠vido disso. E para que essas altera√ß√µes no sistema possam ser verificadas com anteced√™ncia,Se um banco de dados com essas altera√ß√µes precisar ser transferido para uma determinada data no futuro, os par√¢metros de c√≥digo nas tabelas ser√£o ativados no "momento atual". E devido √†s especificidades do sistema suportado, voc√™ n√£o pode usar testes simulados que simplesmente alterariam o valor de retorno da data atual do sistema no idioma quando a sess√£o de teste iniciar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, determinamos o porqu√™, ent√£o precisamos determinar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objetivo </font><i><font style="vertical-align: inherit;">√©</font></i><font style="vertical-align: inherit;"> alcan√ßado. </font><font style="vertical-align: inherit;">Para fazer isso, farei uma pequena retrospectiva das op√ß√µes para a cria√ß√£o de bancos de teste para desenvolvedores e como cada sess√£o de teste foi iniciada.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idade da Pedra</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era uma vez, quando as √°rvores eram pequenas e os mainframes grandes, havia apenas um servidor para desenvolvimento e tamb√©m estava realizando testes. </font><font style="vertical-align: inherit;">E, em princ√≠pio, tudo isso foi suficiente para todos ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">640K √© o suficiente para todos!</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: para executar a tarefa de alterar o tempo, era necess√°rio envolver muitos departamentos relacionados - administradores de sistema (o tempo mudou no servidor secund√°rio a partir da raiz), administradores de DBMS (o banco de dados foi reiniciado), programadores ( era necess√°rio notificar que uma mudan√ßa de hor√°rio ocorreria, porque parte do c√≥digo parou de funcionar, por exemplo, os tokens da web emitidos anteriormente para chamar m√©todos api deixaram de ser v√°lidos e isso pode ser uma surpresa), testadores (testando-se) ... Quando voc√™ retorna o tempo para o presente tudo foi repetido em ordem inversa.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meia idade</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o tempo, o n√∫mero de desenvolvedores no departamento cresceu e, em algum momento, 1 servidor deixou de ser suficiente. Principalmente devido ao fato de que diferentes desenvolvedores desejam alterar o mesmo pacote pl / sql e realizar testes para ele (mesmo sem alterar o tempo). Mais e mais indigna√ß√£o foi ouvida: ‚ÄúQuanto tempo! Chega de tolerar isso! F√°bricas para trabalhadores, terra para camponeses! Todo programador tem um banco de dados! ‚Äù No entanto, se voc√™ tiver alguns terabytes de banco de dados do produto e 50 a 100 desenvolvedores, honestamente, neste formul√°rio, o requisito n√£o √© muito real. E ainda assim todos querem que a base de teste e desenvolvimento n√£o fique muito atr√°s das vendas, tanto na estrutura quanto nos dados dentro das tabelas. Portanto, havia um servidor separado para teste, vamos cham√°-lo de pr√©-produ√ß√£o. Foi constru√≠do a partir de 2 servidores id√™nticos,onde a venda foi feita para restaurar o banco de dados do RMAN bucks e levou cerca de 2-2,5 dias. Ap√≥s a recupera√ß√£o, o banco de dados fez o anonimato dos dados pessoais e outros dados importantes e a carga dos aplicativos de teste foi aplicada a esse servidor (assim como os pr√≥prios programadores sempre trabalharam com o servidor restaurado recentemente). O trabalho com o servidor necess√°rio foi assegurado usando o recurso IP do cluster suportado pelo corosync (pacemaker). Enquanto todos est√£o trabalhando com o servidor ativo, no segundo n√≥, a recupera√ß√£o do banco de dados √© iniciada novamente e ap√≥s 2-3 dias eles mudam de lugar novamente.O trabalho com o servidor necess√°rio foi assegurado usando o recurso IP do cluster suportado pelo corosync (pacemaker). Enquanto todos est√£o trabalhando com o servidor ativo, no segundo n√≥, a recupera√ß√£o do banco de dados √© iniciada novamente e ap√≥s 2-3 dias eles mudam de lugar novamente.O trabalho com o servidor necess√°rio foi assegurado usando o recurso IP do cluster suportado pelo corosync (pacemaker). Enquanto todos est√£o trabalhando com o servidor ativo, no segundo n√≥, a recupera√ß√£o do banco de dados √© iniciada novamente e ap√≥s 2-3 dias eles mudam de lugar novamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das desvantagens √≥bvias: voc√™ precisa de 2 servidores e 2 vezes mais recursos (principalmente disco) que o prod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pr√≥s: opera√ß√£o e teste de altera√ß√£o de hor√°rio - ele pode ser realizado no 2¬∫ servidor, no servidor principal. Os desenvolvedores vivem e realizam seus neg√≥cios. </font><font style="vertical-align: inherit;">A mudan√ßa do servidor ocorre apenas quando o banco de dados est√° pronto e o tempo de inatividade do ambiente de teste √© m√≠nimo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A era do progresso cient√≠fico e tecnol√≥gico</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando mudamos para o banco de dados 11g Release 2, lemos sobre uma tecnologia interessante que a Oracle fornece sob o nome CloneDB. A conclus√£o √© que os backups do banco de dados do produto (h√° uma c√≥pia diretamente em bits dos arquivos de dados do produto) s√£o armazenados em um servidor especial, que publica esse conjunto de arquivos de dados via DNFS (NFS direto) em basicamente qualquer n√∫mero de servidores, e voc√™ n√£o precisa ter um no servidor o mesmo volume de discos, porque a abordagem Copy-On-Write √© implementada: o banco de dados usa um compartilhamento de rede com arquivos de dados do servidor de backup para ler dados em tabelas e as altera√ß√µes s√£o gravadas nos arquivos de dados locais no pr√≥prio servidor de desenvolvimento. Periodicamente, ‚Äúzerando os prazos‚Äù √© feito para o servidor, para que os arquivos de dados locais n√£o cres√ßam muito e o local n√£o termine. Ao atualizar o servidor, os dados tamb√©m s√£o despersonalizados nas tabelas,nesse caso, todas as atualiza√ß√µes de tabela caem em arquivos de dados locais e essas tabelas s√£o lidas no servidor local, todas as outras tabelas s√£o lidas na rede.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: ainda existem 2 servidores (para garantir atualiza√ß√µes tranquilas com tempo de inatividade m√≠nimo para os consumidores), mas agora o volume de discos √© bastante reduzido. Para armazenar dinheiro em uma bola nfs, voc√™ precisa de mais 1 servidor em tamanho + - como um produto, mas o tempo de execu√ß√£o da atualiza√ß√£o em si √© reduzido (especialmente ao usar dinheiro incremental). O trabalho em rede com uma bola nfs reduz visivelmente as opera√ß√µes de leitura de E / S. Para usar a tecnologia CloneDB, a base deve ser uma Enterprise Edition; no nosso caso, tivemos que executar o procedimento de atualiza√ß√£o em bases de teste a cada vez. Felizmente, os bancos de dados de teste est√£o isentos das pol√≠ticas de licenciamento da Oracle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pr√≥s: a opera√ß√£o para restaurar uma base de um bakup leva menos de 1 dia (n√£o me lembro da hora exata).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mudan√ßa de tempo: sem grandes mudan√ßas. </font><font style="vertical-align: inherit;">Embora, a essa altura, os scripts j√° tivessem sido feitos para alterar a hora no servidor e reiniciar o banco de dados para fazer isso sem atrair a </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aten√ß√£o dos ordenados dos</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> administradores.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era da Nova Hist√≥ria</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para economizar ainda mais espa√ßo em disco e tornar a leitura de dados offline, decidimos implementar nossa vers√£o CloneDB (com flashback e snapshots) usando um sistema de arquivos com compacta√ß√£o. </font><font style="vertical-align: inherit;">Durante os testes preliminares, a escolha recaiu sobre o ZFS, embora n√£o haja suporte oficial para ele no kernel Linux (cita√ß√£o do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Para compara√ß√£o, tamb√©m analisamos o BTRFS (b-tree fs), que a Oracle est√° promovendo, mas a taxa de compacta√ß√£o foi menor com o mesmo consumo de CPU e RAM nos testes. Para habilitar o suporte ao ZFS no RHEL5, foi criado seu pr√≥prio kernel baseado no UEK (kernel empresarial inquebr√°vel) e, em eixos e kernels mais novos, voc√™ pode simplesmente usar o kernel UEK pronto. A implementa√ß√£o dessa base de teste tamb√©m √© baseada no mecanismo COW, mas no n√≠vel dos instant√¢neos do sistema de arquivos. 2 dispositivos de disco s√£o fornecidos ao servidor; em um, o pool zfs √© criado, onde atrav√©s do RMAN √© feito um banco de dados adicional em espera da venda e, como usamos a compacta√ß√£o, a parti√ß√£o ocupa menos que a produ√ß√£o.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema est√° instalado no segundo dispositivo de disco e o restante √© necess√°rio para o servidor e o pr√≥prio banco de dados funcionarem, por exemplo, parti√ß√µes para desfazer e temp. A qualquer momento, voc√™ pode fazer uma captura instant√¢nea do pool zfs, que √© aberto como um banco de dados separado. Criar um instant√¢neo leva alguns segundos. √â Magica! E, em princ√≠pio, esses bancos de dados podem ser bastante inclinados, se apenas o servidor tiver RAM suficiente para todas as inst√¢ncias e o tamanho do conjunto zfs (para armazenar altera√ß√µes nos arquivos de dados durante a despersonaliza√ß√£o e durante o ciclo de vida do clone do banco de dados). O principal momento para atualizar a base de teste √© a opera√ß√£o de despersonaliza√ß√£o de dados, mas tamb√©m cabe em 15 a 20 minutos. H√° acelera√ß√£o significativa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: no servidor, voc√™ n√£o pode alterar a hora simplesmente traduzindo a hora do sistema, porque todas as inst√¢ncias de banco de dados em execu√ß√£o neste servidor caem nesse momento de uma s√≥ vez. Uma solu√ß√£o para esse problema foi encontrada e ser√° descrita na se√ß√£o apropriada. Olhando para o futuro, direi que permite alterar o hor√°rio em apenas uma inst√¢ncia do banco de dados (abordagem por altera√ß√£o de hor√°rio </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por inst√¢ncia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) sem afetar o restante no mesmo servidor. </font><font style="vertical-align: inherit;">E o tempo no pr√≥prio servidor tamb√©m n√£o muda. </font><font style="vertical-align: inherit;">Isso elimina a necessidade de um script raiz para alterar a hora no servidor. </font><font style="vertical-align: inherit;">Tamb√©m nesta fase, a automa√ß√£o de altera√ß√£o de hor√°rio para inst√¢ncias via Jenkins CI √© implementada e os usu√°rios (equipes de desenvolvimento relativamente falando) que possuem seu estande recebem direitos sobre os trabalhos pelos quais eles mesmos podem alterar o hor√°rio, atualizar o estande para o estado atual com vendas, fazer instant√¢neos e restaura√ß√£o (revers√£o) da base para o instant√¢neo criado anteriormente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era da Hist√≥ria Recente</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o advento do Oracle 12c, uma nova tecnologia apareceu - bancos de dados conect√°veis ‚Äã‚Äãe, como resultado, bancos de dados de cont√™iner (cdb). Com essa tecnologia, em uma inst√¢ncia f√≠sica, v√°rios bancos de dados "virtuais" podem ser criados, compartilhando uma √°rea de mem√≥ria comum da inst√¢ncia. Pr√≥s: voc√™ pode economizar mem√≥ria para o servidor (e aumentar o desempenho geral do nosso banco de dados, porque toda a mem√≥ria ocupada antes, por exemplo, 5 inst√¢ncias diferentes, pode ser compartilhada para todos os cont√™ineres pdb implantados no cdb, e eles a usar√£o apenas quando realmente precisam, e n√£o como na fase anterior, quando cada inst√¢ncia "bloqueava" a mem√≥ria alocada para si e com baixa atividade de alguns dos clones, a mem√≥ria n√£o era usada com efici√™ncia, ou seja, estava ociosa).Os arquivos de dados de pdb diferente ainda est√£o no pool zfs e, ao implantar clones, eles usam o mesmo mecanismo de snapshot do zfs. Nesse est√°gio, chegamos perto o suficiente da capacidade de fornecer a quase todos os desenvolvedores seu pr√≥prio banco de dados. Alterar o hor√°rio nesse est√°gio n√£o requer uma reinicializa√ß√£o do banco de dados e funciona com muita precis√£o apenas nos processos que precisam de um hor√°rio; todos os outros usu√°rios que trabalham com esse banco de dados n√£o s√£o afetados de forma alguma.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menos: voc√™ n√£o pode usar a abordagem de altera√ß√£o de tempo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por inst√¢ncia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da fase anterior, porque temos uma inst√¢ncia agora. No entanto, uma solu√ß√£o para este caso foi encontrada. E foi precisamente isso que serviu de impulso para a reda√ß√£o deste artigo. Olhando para o futuro, direi que √© uma mudan√ßa de tempo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> abordagem de </font><i><font style="vertical-align: inherit;">processo</font></i><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">ou seja. em cada processo do banco de dados, voc√™ pode definir seu hor√°rio exclusivo em geral.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, uma sess√£o de teste t√≠pica imediatamente ap√≥s a conex√£o com o banco de dados define o hor√°rio certo no in√≠cio de seu trabalho, realiza os testes e retorna o tempo no final. √â necess√°rio retornar o tempo por um motivo simples: alguns processos do banco de dados Oracle n√£o terminam quando o cliente do banco de dados se desconecta do servidor, s√£o processos chamados servidores compartilhados, que, diferentemente dos processos dedicados, s√£o executados quando o servidor do banco de dados √© iniciado e permanece quase indefinidamente (no ideal imagem do mundo). Se voc√™ deixar o hor√°rio alterado em um processo desse servidor, outra conex√£o que ser√° atendida nesse processo receber√° o hor√°rio errado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nosso sistema, os servidores compartilhados s√£o muito usados, porque at√© 11g, praticamente n√£o havia solu√ß√£o adequada para o nosso sistema suportar carga alta (em 11g apareceu o DRCP - pool de conex√£o residente no banco de dados). E aqui est√° o porqu√™ - no sub, h√° um limite no n√∫mero total de processos do servidor que ele pode criar nos modos dedicado e compartilhado. Processos dedicados s√£o gerados mais lentamente do que o banco de dados pode emitir um processo compartilhado j√° pronto do pool de processos compartilhados, o que significa que quando novas conex√µes est√£o chegando constantemente (especialmente se o processo faz outras opera√ß√µes lentas), o n√∫mero total de processos aumentar√°. Quando o limite de sess√µes / processos √© atingido, o banco de dados deixa de atender a novas conex√µes e ocorre um colapso.A transi√ß√£o para o uso de um conjunto de processos compartilhados nos permitiu reduzir o n√∫mero de novos processos no servidor durante a conex√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â a√≠ que a revis√£o das tecnologias para a constru√ß√£o de bancos de dados de teste √© conclu√≠da e podemos finalmente come√ßar a implementar os algoritmos de mudan√ßa de hor√°rio para o pr√≥prio banco de dados.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A abordagem falsa por inst√¢ncia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como alterar a hora dentro do banco de dados? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que veio √† mente foi criar em um esquema que contenha todo o c√≥digo da l√≥gica de neg√≥cios, sua pr√≥pria fun√ß√£o, que sobrep√µe as fun√ß√µes de linguagem que funcionam com o tempo (sysdate, current_date etc.) e, sob certas condi√ß√µes, come√ßa a fornecer outros valores, por exemplo, voc√™ pode defina valores atrav√©s do contexto da sess√£o no in√≠cio da execu√ß√£o do teste. N√£o deu certo, as fun√ß√µes do idioma interno n√£o se sobrepuseram √†s do usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, foram testados os sistemas de virtualiza√ß√£o leve (Vserver, OpenVZ) e a containeriza√ß√£o via docker. Tamb√©m n√£o funciona, eles usam o mesmo kernel que o sistema host, o que significa que usam os mesmos valores de timer do sistema. Caindo de novo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui n√£o tenho medo de resgatar esta palavra, uma grande inven√ß√£o do mundo Linux - redefini√ß√£o / intercepta√ß√£o de fun√ß√µes no est√°gio de carregamento din√¢mico de objetos compartilhados. √â conhecido por muitos como truques com LD_PRELOAD. Na vari√°vel de ambiente LD_PRELOAD, voc√™ pode especificar a biblioteca que ser√° carregada antes de todas as outras que o processo precisa e, se essa biblioteca contiver caracteres com o mesmo nome que, por exemplo, na libc padr√£o, que ser√° carregada posteriormente, a tabela de importa√ß√£o de s√≠mbolos do aplicativo parecer√° uma fun√ß√£o fornece nosso m√≥dulo de substitui√ß√£o. E √© exatamente isso que a biblioteca de projetos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libfaketime faz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que come√ßamos a usar para iniciar o banco de dados em um hor√°rio diferente, separadamente do sistema. A biblioteca perde chamadas relacionadas ao trabalho com o timer do sistema e √† obten√ß√£o da hora e data do sistema. Para controlar quanto tempo se move em rela√ß√£o √† data atual do servidor ou a que ponto o tempo deve passar dentro do processo - tudo √© controlado por vari√°veis ‚Äã‚Äãde ambiente que devem ser configuradas juntamente com LD_PRELOAD. Para implementar a mudan√ßa de hor√°rio, implementamos um trabalho no servidor Jenkins, que entra no servidor de banco de dados e reinicia o DBMS com ou sem vari√°veis ‚Äã‚Äãde ambiente definidas para libfaketime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um algoritmo de exemplo para iniciar um banco de dados com um hor√°rio de substitui√ß√£o:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> LD_PRELOAD=/usr/<span class="hljs-built_in">local</span>/lib/faketime/libfaketime.so
<span class="hljs-built_in">export</span> FAKETIME=<span class="hljs-string">"+1d"</span>
<span class="hljs-built_in">export</span> FAKETIME_NO_CACHE=1<font></font>
<font></font>
<span class="hljs-variable">$ORACLE_HOME</span>/bin/sqlplus @/home/oracle/scripts/restart_db.sql
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E se voc√™ pensa que tudo funcionou imediatamente, est√° profundamente enganado. </font><font style="vertical-align: inherit;">Porque, como se viu, valida as bibliotecas que s√£o carregadas no processo quando o DBMS √© iniciado. </font><font style="vertical-align: inherit;">E no alertlog, ele come√ßa a se ressentir da falsifica√ß√£o notada, enquanto a base n√£o inicia. </font><font style="vertical-align: inherit;">Agora, n√£o me lembro exatamente como se livrar dele; existe algum par√¢metro que pode desativar a execu√ß√£o de verifica√ß√µes de sanidade na inicializa√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A abordagem falsa por processo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia geral de alterar o tempo apenas dentro de 1 processo permaneceu a mesma - use libfaketime. </font><font style="vertical-align: inherit;">Iniciamos o banco de dados com uma biblioteca pr√©-carregada nele, mas definimos um deslocamento de tempo zero na inicializa√ß√£o, que √© propagado para todos os processos do DBMS. </font><font style="vertical-align: inherit;">E ent√£o, dentro da sess√£o de teste, defina a vari√°vel de ambiente apenas para esse processo. </font><font style="vertical-align: inherit;">Pff, neg√≥cios alguma coisa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, para aqueles que est√£o familiarizados com a linguagem pl / sql, toda a destrui√ß√£o dessa id√©ia √© imediatamente clara. Porque o idioma √© muito limitado e basicamente adequado para tarefas de alto n√≠vel. Nenhuma programa√ß√£o do sistema pode ser implementada l√°. Embora algumas opera√ß√µes de baixo n√≠vel (por exemplo, trabalhando com uma rede, trabalhando com arquivos) estejam presentes na forma de pacotes dbms / utl do sistema pr√©-instalados. Durante todo o tempo em que trabalhei com a Oracle, fiz engenharia reversa de pacotes pr√©-instalados v√°rias vezes, o c√≥digo de alguns deles fica oculto aos olhos de estranhos (eles s√£o chamados de empacotados). Se voc√™ √© proibido de assistir a algo, ent√£o a tenta√ß√£o de descobrir como ele √© organizado no interior s√≥ aumenta. Mas muitas vezes, mesmo ap√≥s o anvrapper, nem sempre h√° algo a ver, porque as fun√ß√µes desses pacotes s√£o implementadas como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para as bibliotecas do disco.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No total, abordamos um candidato √† implementa√ß√£o - tecnologia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com procedimentos externos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A biblioteca projetada de uma maneira especial pode exportar m√©todos, que o banco de dados Oracle pode chamar via pl / sql. Parece promissor. Somente quando conheci isso nos cursos avan√ßados de plsql, lembrei-me muito remotamente de como cozinh√°-lo. E isso significa que √© necess√°rio ler a documenta√ß√£o. Eu li - e imediatamente fiquei deprimido. Como o carregamento de uma biblioteca personalizada desse tipo passa por um processo de agente separado por meio de um ouvinte de banco de dados, e a comunica√ß√£o com esse agente passa por dlink. Portanto, nossa ideia era definir uma vari√°vel de ambiente dentro do pr√≥prio processo do banco de dados. E tudo isso √© feito por raz√µes de seguran√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma imagem da documenta√ß√£o que mostra como funciona:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/1h/07/pu1h07d6fvy1wwetq4deujbpnga.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tipo da biblioteca so / dll n√£o √© t√£o importante, mas por algum motivo a imagem √© apenas para Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez algu√©m tenha notado aqui mais uma oportunidade em potencial. Sim, sim, isso √© Java. O Oracle permite que voc√™ escreva o c√≥digo do procedimento armazenado n√£o apenas no plsql, mas tamb√©m no java, que, no entanto, s√£o exportados da mesma maneira que os m√©todos do plsql. Periodicamente, eu fazia isso, ent√£o n√£o deveria haver um problema com isso. Mas ent√£o outra armadilha foi escondida. Java trabalha com uma c√≥pia do ambiente e permite obter apenas as vari√°veis ‚Äã‚Äãde ambiente que o processo da JVM possu√≠a na inicializa√ß√£o. A JVM interna herda as vari√°veis ‚Äã‚Äãde ambiente do processo do banco de dados, mas √© tudo. Vi dicas na Internet sobre como alterar o mapa somente leitura atrav√©s da reflex√£o, mas qual √© o objetivo, porque ainda √© apenas uma c√≥pia. Ou seja, a mulher ficou novamente sem nada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, Java n√£o √© apenas um item valioso. Usando-o, voc√™ pode gerar processos de dentro de um processo de banco de dados. Embora todas as opera√ß√µes n√£o seguras devam ser resolvidas separadamente por meio do mecanismo de concess√£o de java, que √© feito usando o pacote dbms_java. De dentro do c√≥digo plsql, √© poss√≠vel obter o pid do processo atual do servidor no qual o c√≥digo est√° sendo executado, usando as visualiza√ß√µes do sistema v $ session e v $ process. Al√©m disso, podemos gerar algum processo filho da nossa sess√£o para fazer algo com esse pid. Para come√ßar, deduzi todas as vari√°veis ‚Äã‚Äãde ambiente que est√£o dentro do processo do banco de dados (para testar a hip√≥tese)</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span><font></font>
<font></font>
awk <span class="hljs-string">'BEGIN {RS="\0"; ORS="\n"} $0'</span> <span class="hljs-string">"/proc/<span class="hljs-variable">$pid</span>/environ"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem deduzido, e depois o que. Ainda √© imposs√≠vel alterar as vari√°veis ‚Äã‚Äãno arquivo do ambiente, esses s√£o os dados que foram transferidos para o processo quando ele foi iniciado e eles s√£o somente leitura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pesquisei na Internet no stackoverflow "Como alterar uma vari√°vel de ambiente em outro processo". A maioria das respostas era que era imposs√≠vel, mas havia uma resposta que descrevia essa oportunidade como um hack abaixo do padr√£o e sujo. E essa resposta foi </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Albert Einstein</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gdb. O depurador pode se conectar a qualquer processo que conhece seu pid e executar qualquer fun√ß√£o / procedimento nele existente como um s√≠mbolo exportado publicamente, por exemplo, de alguma biblioteca. Na libc, existem fun√ß√µes para trabalhar com vari√°veis ‚Äã‚Äãde ambiente, e a libc √© carregada em qualquer processo do banco de dados Oracle (e praticamente em qualquer programa no linux).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a vari√°vel de ambiente √© definida em um processo externo (voc√™ precisa cham√°-la do root por causa do ptrace usado):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
env_name=<span class="hljs-variable">$2</span>
env_val=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span><font></font>
<font></font>
out=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (int) setenv("'</span><span class="hljs-variable">$env_name</span><span class="hljs-string">'", "'</span><span class="hljs-string">"<span class="hljs-variable">$env_val</span>"</span><span class="hljs-string">'", 1)'</span> -ex <span class="hljs-string">"detach"</span> 2&gt;&amp;1`
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, ver as vari√°veis ‚Äã‚Äãde ambiente dentro do processo gdb tamb√©m √© adequado. </font><font style="vertical-align: inherit;">Como mencionado anteriormente, o arquivo ambiente de / proc / pid / mostra apenas as vari√°veis ‚Äã‚Äãque existiam no in√≠cio do processo. </font><font style="vertical-align: inherit;">E se o processo criou algo no decorrer de seu trabalho, isso s√≥ pode ser visto atrav√©s do depurador:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
var_name=<span class="hljs-variable">$2</span><font></font>
<font></font>
var_value=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (char*) getenv("'</span><span class="hljs-variable">$var_name</span><span class="hljs-string">'")'</span> -ex <span class="hljs-string">'detach'</span> | egrep <span class="hljs-string">'^\$1 ='</span>`<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> == <span class="hljs-string">'$1 = 0x0'</span> ]
<span class="hljs-keyword">then</span>
  <span class="hljs-comment"># variable empty or does not exist</span>
  <span class="hljs-built_in">echo</span> -n
<span class="hljs-keyword">else</span>
  <span class="hljs-comment"># gdb returns $1 = hex_value "string value"</span>
  var_hex=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>`<font></font>
  var_value=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | sed -r -e <span class="hljs-string">'s/^\$1 = '</span><span class="hljs-variable">$var_hex</span><span class="hljs-string">' //;s/^"//;s/"$//'</span>`<font></font>
  <font></font>
  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span>
<span class="hljs-keyword">fi</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a solu√ß√£o j√° est√° no nosso bolso - atrav√©s do java, criamos o processo de depura√ß√£o, que vai para o processo que a gerou e define a vari√°vel de ambiente desejada para ela e depois termina (o Moor fez seu trabalho - o Moor pode sair). </font><font style="vertical-align: inherit;">Mas havia um sentimento de que era algum tipo de muleta. </font><font style="vertical-align: inherit;">Eu queria algo mais elegante. </font><font style="vertical-align: inherit;">De alguma forma, seria o mesmo for√ßar o pr√≥prio processo do banco de dados a definir vari√°veis ‚Äã‚Äãde ambiente sem agress√£o externa.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um ovo em um pato, um pato em uma lebre ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o algu√©m vem em socorro, sim, voc√™ adivinhou certo, novamente Java, a saber, JNI (java native interface). </font><font style="vertical-align: inherit;">A JNI permite chamar m√©todos C nativos dentro da JVM. </font><font style="vertical-align: inherit;">O c√≥digo √© emitido de uma maneira especial na forma de um objeto compartilhado da biblioteca, que a JVM carrega, enquanto os m√©todos que estavam na biblioteca mapeiam para os m√©todos java dentro da classe declarados com o modificador nativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, ok, estamos escrevendo uma aula (na verdade, isso √© apenas uma pe√ßa de trabalho):</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Posix</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setenv</span><span class="hljs-params">(String key, String value, <span class="hljs-keyword">boolean</span> overwrite)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">getenv</span><span class="hljs-params">(String key)</span></span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stub</span><span class="hljs-params">()</span> 
    </span>{<font></font>
        <font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, compile-o e obtenha o arquivo h gerado da futura biblioteca:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  </span><font></font>
javac Posix.java<font></font>
<font></font>
<span class="hljs-comment">#   Posix.h        JNI</span><font></font>
javah Posix<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s receber o arquivo de cabe√ßalho, escrevemos o corpo para cada m√©todo:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Posix.h"</span></span><font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">Java_Posix_setenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key, jstring value, jboolean overwrite)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, value, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
    <span class="hljs-keyword">int</span> err = setenv(k, v, overwrite);<font></font>
<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, key, k);<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, value, v);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> err;<font></font>
}<font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jstring JNICALL <span class="hljs-title">Java_Posix_getenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = getenv(k);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> (*env)-&gt;NewStringUTF(env, v);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e compile a biblioteca</font></font><br>
<br>
<pre><code class="bash hljs">gcc -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include"</span> -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include/linux"</span> -fPIC Posix.c -shared -o libPosix.so -Wl,-soname -Wl,--no-whole-archive<font></font>
<font></font>
strip libPosix.so<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que o Java carregue a biblioteca nativa, ela deve ser encontrada pelo sistema ld de acordo com todas as regras do Linux. </font><font style="vertical-align: inherit;">Al√©m disso, o Java possui um conjunto de propriedades que cont√™m os caminhos nos quais as pesquisas da biblioteca ocorrem. </font><font style="vertical-align: inherit;">A maneira mais f√°cil de trabalhar dentro do Oracle √© colocar nossa biblioteca em $ ORACLE_HOME / lib. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E depois que criamos a biblioteca, precisamos compilar a classe dentro do banco de dados e public√°-la como um pacote plsql. </font><font style="vertical-align: inherit;">Existem 2 op√ß√µes para criar classes Java dentro do banco de dados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carregar arquivo de classe bin√°rio via utilit√°rio loadjava</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compilar c√≥digo de classe da fonte usando o sqlplus</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usaremos o segundo m√©todo, embora eles sejam basicamente iguais. </font><font style="vertical-align: inherit;">Para o primeiro caso, foi necess√°rio escrever imediatamente todo o c√≥digo da classe no est√°gio 1, quando recebemos uma classe de stub para o arquivo h. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para criar uma classe em subd, √© usada uma sintaxe especial:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">AND</span> RESOLVE <span class="hljs-keyword">JAVA</span> <span class="hljs-keyword">SOURCE</span> NAMED <span class="hljs-string">"Posix"</span> <span class="hljs-keyword">AS</span><font></font>
...<font></font>
...<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a classe √© criada, ela precisa ser publicada como m√©todos plsql, e aqui novamente a sintaxe especial:</font></font><br>
<br>
<pre><code class="sql hljs">procedure set_env(var_name varchar2, var_value varchar2)<font></font>
is<font></font>
language java name 'Posix.set_env(java.lang.String, java.lang.String)';<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando voc√™ tenta chamar m√©todos potencialmente inseguros dentro de Java, √© executada uma execu√ß√£o que diz que nenhuma concess√£o de java foi emitida para o usu√°rio. </font><font style="vertical-align: inherit;">Carregar m√©todos nativos √© outra opera√ß√£o insegura, porque injetamos c√≥digo estranho diretamente no processo do banco de dados (a mesma explora√ß√£o anunciada no cabe√ßalho). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, como o banco de dados √© teste, concedemos uma concess√£o sem qualquer preocupa√ß√£o de conex√£o com o sys:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_java.grant_permission( <span class="hljs-string">'SYSTEM'</span>, <span class="hljs-string">'SYS:java.lang.RuntimePermission'</span>, <span class="hljs-string">'loadLibrary.Posix'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O nome de usu√°rio do sistema √© aquele em que compilei o c√≥digo java e o pacote plsql wrapper. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante observar que, ao carregar uma biblioteca atrav√©s de uma chamada para System.loadLibrary, omitimos o prefixo da lib e a extens√£o so (conforme descrito na documenta√ß√£o) e n√£o passamos nenhum caminho para onde procurar. Existe um m√©todo System.load semelhante que s√≥ pode carregar uma biblioteca usando um caminho absoluto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o 2 surpresa desagrad√°vel nos espera - eu cheguei na pr√≥xima toca de coelho da Oracle. Ao emitir uma concess√£o, ocorre um erro com uma mensagem bastante nebulosa:</font></font><br>
<br>
<pre><code class="plaintext hljs">ORA-29532: Java call terminated by uncaught Java exception: java.lang.SecurityException: policy table update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© pesquisado na Internet e leva ao My Oracle Support (tamb√©m conhecido como Metalink). </font><font style="vertical-align: inherit;">Porque </font><font style="vertical-align: inherit;">De acordo com as regras da Oracle, a publica√ß√£o de artigos de um metalink n√£o √© permitida em fontes abertas, mencionarei apenas o n√∫mero do documento - 259471.1 (aqueles que t√™m acesso podem ler por conta pr√≥pria). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ess√™ncia do problema √© que a Oracle n√£o permitir√° apenas o carregamento de c√≥digos de terceiros suspeitos em nosso processo. </font><font style="vertical-align: inherit;">O que √© l√≥gico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas como a base √© testada e confiamos em nosso c√≥digo, permitimos o download sem medos especiais. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fuh, desventuras acabaram.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√° vivo, vivo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Respirando fundo, decidi tentar dar vida ao meu Frankenstein. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciamos o banco de dados com o libfaketime pr√©-carregado e o deslocamento 0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conecte-se ao banco de dados e fa√ßa uma chamada para o c√≥digo que simplesmente exibe o tempo antes e depois de alterar a vari√°vel de ambiente:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_output.enable(<span class="hljs-number">100000</span>);<font></font>
dbms_java.set_output(100000);<font></font>
dbms_output.put_line('old time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
system.posix.set_env('FAKETIME','+1d');<font></font>
dbms_output.put_line('new time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona, droga! </font><font style="vertical-align: inherit;">Honestamente, eu estava esperando mais algumas surpresas, como os erros do ORA-600. </font><font style="vertical-align: inherit;">No entanto, o alerta tinha o n√∫mero inteiro e o c√≥digo continuava funcionando. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante observar que, se a conex√£o com o banco de dados for feita como dedicada, depois que a conex√£o for conclu√≠da, o processo ser√° destru√≠do e n√£o haver√° rastreamento. </font><font style="vertical-align: inherit;">Mas se usarmos conex√µes compartilhadas, nesse caso, um processo pronto √© alocado no pool de servidores, alteraremos o tempo atrav√©s de vari√°veis ‚Äã‚Äãde ambiente e, quando desconectado, permanecer√° alterado dentro do processo. </font><font style="vertical-align: inherit;">E quando outra sess√£o do banco de dados cair no mesmo processo do servidor, ela receber√° a hora errada para sua consider√°vel surpresa. </font><font style="vertical-align: inherit;">Portanto, no final da sess√£o de teste, √© melhor sempre retornar o tempo para o deslocamento zero.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que a hist√≥ria tenha sido interessante (e talvez at√© √∫til para algu√©m). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os c√≥digos-fonte est√£o todos dispon√≠veis no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A documenta√ß√£o da libfaketime </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamb√©m</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ faz os testes? </font><font style="vertical-align: inherit;">E como voc√™ cria bancos de dados de desenvolvimento e teste em uma empresa?</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√¥nus para quem l√™ at√© o fim</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/wd/m1/s9/wdm1s9kk6_kckj-xf5amc_o6wjq.jpeg"><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt503782/index.html">Como fazer uma mesa interativa com uma superf√≠cie de trabalho em forma de c√≠rculo?</a></li>
<li><a href="../pt503786/index.html">Representa√ß√£o digital de √°udio anal√≥gico. Breve programa educacional</a></li>
<li><a href="../pt503788/index.html">Email din√¢mico :: seguran√ßa</a></li>
<li><a href="../pt503790/index.html">Permuta√ß√µes. 9 ¬∫ ano. Tarefa de paridade</a></li>
<li><a href="../pt503796/index.html">Tornando o suporte mais barato, tentando n√£o perder qualidade</a></li>
<li><a href="../pt503812/index.html">Pirata √°gil e algumas leis da dial√©tica</a></li>
<li><a href="../pt503826/index.html">Prote√ß√£o DDoS sim√©trica e assim√©trica - qual a diferen√ßa?</a></li>
<li><a href="../pt503830/index.html">Amazon abriu um grande abrigo para os sem-teto</a></li>
<li><a href="../pt503832/index.html">Receitas do PostgreSQL: mecanismo de modelo de bigode</a></li>
<li><a href="../pt503836/index.html">Pr√≥s e contras das tecnologias de modera√ß√£o de coment√°rios (+ Enquete)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>