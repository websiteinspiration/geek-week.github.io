<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí± üöê üõ°Ô∏è Connexion du capteur de mouvement et de l'alarme et de l'enregistrement vid√©o dans Home Assistant sur Raspberry Pi ‚úã üë≥üèø üçÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je veux parler de ma petite exp√©rience de travail avec Home Assistant (ci-apr√®s d√©nomm√© HA) sur le Raspberry pi et de la connexion de la fonction d'en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Connexion du capteur de mouvement et de l'alarme et de l'enregistrement vid√©o dans Home Assistant sur Raspberry Pi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je veux parler de ma petite exp√©rience de travail avec Home Assistant (ci-apr√®s d√©nomm√© HA) sur le Raspberry pi et de la connexion de la fonction d'enregistrement vid√©o, du capteur de mouvement et, en cons√©quence, de la fonction de s√©curit√© √† domicile pour recevoir des images par courrier en cas d'op√©ration de ¬´s√©curit√©¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, l'une des raisons est le d√©sir de comprendre √† partir de vos commentaires que ce que j'ai fait ¬´a mal fait¬ª apr√®s tout, en mettant en ≈ìuvre ce sc√©nario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe trois fa√ßons de configurer les fonctionnalit√©s ci-dessus: ¬´sans probl√®me¬ª, ¬´court¬ª et ¬´ind√©pendant¬ª. Dans le premier cas, vous, apr√®s avoir t√©l√©charg√© l'image finie depuis le site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://ViaMyBox.com/downloadpage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour votre Raspberry pi, vous pouvez voir √† quoi tout ressemble sous la forme d√©j√† configur√©e. Dans le second cas, vous pouvez t√©l√©charger le zip √† partir du site Web ou du projet github, installer et installer l'image HA docker via l'utilitaire (sudo via-setup.sh) pour voir comment tout est configur√©. Et enfin, la troisi√®me fa√ßon est de mettre en place ¬´tout √† votre fa√ßon¬ª: prendre quelque chose d'utile sur le site ou githab du projet, ou dans ce tutoriel. Liens vers tout √† la fin de l'article.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que vous disposiez d√©j√† d'un Home Assistant (HA) fonctionnel. Dans cet article, nous ne consid√©rerons que les aspects de la formation des configurations yaml et une description de la s√©quence de r√®gles et conditions qui conduisent √† une action sp√©cifique, dans notre cas, la connexion de la ¬´s√©curit√© de la maison¬ª et un script qui commence √† prendre des photos dans les 5 secondes apr√®s le d√©clenchement du capteur de mouvement. Et en cons√©quence, Home Assistant envoie les photos prises par courrier. Je ne suis pas un sp√©cialiste du yaml ou de la cr√©ation de configurations pour Home Assistant, mais, en suivant les exemples de travail, j'ai obtenu une configuration de travail que je souhaite partager.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les fichiers auxquels nous ferons r√©f√©rence, je les disposerai √† la fin de l'article pour une revue plus pratique. Je ne traiterai pas ici du travail des scripts d'enregistrement de vid√©o en bash ou en python dans cet exemple. Seul Home Assistant. Mais si vous avez des questions - Bienvenue! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au final, tout ressemble √† √ßa pour moi (surlign√© en rouge que nous allons consid√©rer dans l'article): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3u/ol/s8/3uols87hy7mnocdgbj-k-mfbp-a.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/v9/ib/8s/v9ib8sthumy5p5hphabioyvr1ie.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'utilise Raspberry pi comme plateforme. Et mon chemin vers les fichiers de configuration est / usr / share / hassio / homeassistant /. Le chemin d'acc√®s √† vos fichiers de configuration peut √™tre diff√©rent de mon chemin d'acc√®s. √Ä cette √©poque, j'avais Home Assistant 0.101.3. Nous serons int√©ress√©s par les fichiers de configuration de ce r√©pertoire: configuration.yaml et automation.yaml.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s chaque modification de ces fichiers, il est important de se rappeler qu'il sera n√©cessaire de v√©rifier la configuration apr√®s nos modifications pour d√©tecter toute erreur qui s'y serait produite. Cela se fait dans l'onglet Tableau de bord Home Assistant -&gt; Configuration -&gt; Contr√¥les du serveur -&gt; V√©rifier la configuration. Et puis, au m√™me endroit, nous effectuons le rechargement des automatisations et le rechargement des scripts, si la v√©rification a r√©ussi. Et, en cas de doute, - Le red√©marrage de la gestion du serveur dans le m√™me onglet met √† jour avec pr√©cision la configuration.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le capteur de mouvement HC-SR501 est connect√© au bus GPIO Raspberry pi. Il est n√©cessaire de connecter correctement les trois fils de contact au GPIO, et nous pouvons utiliser notre capteur en action. Le capteur a trois contacts: puissance gcc (+), z√©ro gnd (-), contact de commande (donn√©es). Apr√®s avoir lu la description du GPIO, je les ai connect√©s √† ma framboise comme suit. J'ai connect√© hc-sr501 au connecteur GPIO: broche # 2 - 5.5vvcc; broche n ¬∞ 26 (13e rang√©e) - contact de donn√©es et broche n ¬∞ 6 - gnd (-) du capteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'utilise un appareil photo USB ou un appareil photo csi conjointement avec mjpg-streamer comme source de la photo. Comment installer et configurer mjpg-streamer sur Raspberry pi, nous ne consid√©rerons pas ici. Exemples d'installation rapide sur Internet beaucoup. Cependant, je tiens √† dire que j'utilise les donn√©es de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce projet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'installation de ce module y est √©galement d√©crite en d√©tail. </font><font style="vertical-align: inherit;">Ou utilisez une m√©thode qui vous convient pour prendre des photos et des vid√©os. </font><font style="vertical-align: inherit;">Apr√®s tout, c'est vous qui d√©cidez du script bash √† attacher √† HA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant d√©crire notre capteur dans configuration.yaml, disons, via la ligne de commande:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo nano /usr/share/hassio/homeassistant/configuration.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bien que l'utilisation de notepad ++ avec winscp puisse √™tre plus pratique ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous d√©crivons la s√©quence de param√®tres pour le HC-SR501 comme ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">binary_sensor:<font></font>
  - platform: rpi_gpio<font></font>
    #name: HC-SR501<font></font>
    ports:<font></font>
      7: Sensor HC-SR501<font></font>
    invert_logic: false<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de noter qu'ici, l'important est les param√®tres dans les lignes qui d√©crivent la connexion aux contacts de contr√¥le (donn√©es) des capteurs: broches # 7 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ports: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7: Capteur HC-SR501 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le Home Assistant dispose d'un outil int√©gr√© pour activer la fonction de s√©curit√© domestique. </font><font style="vertical-align: inherit;">Nous le d√©crirons dans notre configuration.yaml, en utilisant la description: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.home-assistant.io/integrations/manual</font></font></a><br>
<br>
<pre><code class="plaintext hljs">alarm_control_panel:<font></font>
  - platform: manual<font></font>
    name: Home Alarm<font></font>
    pending_time: 60<font></font>
     delay time 40<font></font>
     triggered:<font></font>
    pending_time: 0<font></font>
    code: 1234<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce param√®tre signifie que nous avons 60 secondes pour quitter la maison (apr√®s cette heure, l'alarme se d√©clenchera) et 40 secondes pour la d√©sactiver (avec le mot de passe 1234) √† notre retour √† la maison. Pour une raison quelconque, vous partez toujours plus longtemps que vous venez.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant d√©crire le m√©canisme d'activation et de d√©sactivation des photos par le fonctionnement du capteur de mouvement dans notre configuration.yaml (plus d'informations sur le commutateur - la plate-forme command_line peut √™tre trouv√©e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="plaintext hljs"> - platform: command_line<font></font>
   switches:<font></font>
      start_stop_motion_rec_timelapse:<font></font>
        friendly_name: 'Record motion timelapse video'<font></font>
        command_on: 'curl http://localhost/start_mjpgstrm.php  &amp;&amp; curl http://localhost//rec-motion-mjpg.php'<font></font>
        command_off: 'curl http://localhost/stop_mjpgstrm.php &amp;&amp; curl http://localhost/rec-motion-mjpg-stop.php'<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous avons li√© les commandes enable enable command_on et command_off off √† nos scripts qui contr√¥lent l'enregistrement de la cam√©ra. Dans ce cas, lorsque la commande_on est ex√©cut√©e, 2 scripts sont ex√©cut√©s s√©quentiellement. Cela lance mjpg-streamer et d√©clenche l'enregistrement du capteur de mouvement. L'acc√®s aux scripts bash passe par le fichier php du site de travail sur Raspberry pi. Pour ce faire, j'ai configur√© l'acc√®s nginx et web, et lors de l'acc√®s via le navigateur sous la forme http: // &lt;adresse ip de votre Raspberry pi&gt; /start_mjpgstrm.php, notre script php doit √™tre ex√©cut√©. Ce script ex√©cute mjpg-streamer dans cette situation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne consid√©rons pas la configuration de l'acc√®s Web dans cet article. Ce n'est certainement pas de la s√©curit√©, mais √©tant donn√© que j'ai HA sur docker, j'ai √©t√© confront√© au fait que j'ai un environnement de docker isol√© et le ¬´monde ext√©rieur¬ª du syst√®me d'exploitation que je peux voir en contactant mon site via php. Il existe probablement un tas de bonnes solutions de la part des gourous docker ou HA. Ecrivez, il serait int√©ressant de savoir! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais laisser une liste de ces scripts sous l'article, nous ne nous attarderons pas sur eux. Dans cet article, je souhaite retracer uniquement la formation de la s√©quence d'actions dans l'assistant d'accueil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela est plac√© dans l'objet start_stop_motion_rec_timelapse Ce sera notre interrupteur visuel, avec lequel nous contr√¥lerons l'enregistrement des photos lorsque le capteur de mouvement sera d√©clench√©.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/jb/kz/j4jbkzlnslehtgai7ak93blgqnm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons visualiser ces objets cr√©√©s par nos soins dans l'onglet Home Assistant -&gt; Overwiew, en basculant l'activation du mode de configuration Configure UI dans le coin sup√©rieur droit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s5/r8/31/s5r831pi5yqbp6zpph6gy_yen2g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Red√©marrez HA dans le navigateur dans l'onglet ¬´Configuration -&gt; Server Control¬ª pour r√©cup√©rer notre configuration.yaml. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, s√©lectionnez le jaune plus au bas de la fen√™tre du navigateur, cliquez sur la carte Entit√©s et attachez nos objets cr√©√©s aux cartes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/6c/i_/t56ci_fwyo5z_vojj6iywesnwno.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour notre capteur, s√©lectionnez la carte du capteur. Cela ressemblera √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hi/h-/9d/hih-9d8acqpf9lxmub8pqpxbm2y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir sur l'image, dans le deuxi√®me champ de l'entit√©, le commutateur ci-dessus est: switch.start_stop_motion_rec_timelapse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il nous permet d'activer et de d√©sactiver notre enregistrement sur le capteur de mouvement, ind√©pendamment de l'inclusion de la fonction ¬´s√©curit√© √† domicile¬ª. Et, en g√©n√©ral, cela devrait d√©j√† fonctionner apr√®s toutes les actions ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, et en cons√©quence, la carte du panneau d'alarme: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m-/om/ob/m-omobeh7bj-auliurl9abujbhw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un autre point int√©ressant. J'utilise Home Assistant comme conteneur Docker. √Ä cet √©gard, le chemin d'acc√®s √† notre script sera diff√©rent du chemin d'acc√®s r√©el au fichier de script. Apr√®s tout, la structure de fichiers √† l'int√©rieur du conteneur est virtualis√©e et connect√©e √† la structure de fichiers r√©elle via des volumes de docker mont√©s. Il ressemble √† ceci: Chemin √† l'int√©rieur du conteneur: / config / scripts / Chemin √† l'int√©rieur du syst√®me d'exploitation: / usr / share / hassio / homeassiatnt / scripts. Regardez donc les param√®tres de votre conteneur, comment ces volumes sont configur√©s dans le champ Binds. Si vous en avez.</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo docker inspect homeassistant|less
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le d√©tecteur de mouvement est d√©clench√©, au moment o√π l'alarme est activ√©e: je veux, en plus du fait que nous commen√ßons la photographie rapide (instantan√©s instantan√©s), je recevrais un avertissement par mail et un instantan√©. J'ai parall√©lis√© les processus. Sur la premi√®re photo, la journalisation (instantan√©s instantan√©s) se produit quelques secondes apr√®s le d√©clenchement du capteur. Pour ce faire, j'ex√©cute mjpg-streamer curl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost / start_mjpgstrm.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lancez php: surl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: //localhost/rec-motion-mjpg.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √Ä son tour, il ex√©cute le script python mov.py. Tous les fichiers et liens d√©crits se trouvent √† la fin de l'article par r√©f√©rence. Et un autre script takeSnapshotWebcam.sh prend un instantan√©, que j'envoie dans un e-mail. Je d√©cris ces scripts dans notre configuration.yaml comme ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">shell_command:<font></font>
#      <font></font>
  take_snapshot_webcam: '/config/scripts/takeSnapshotWebcam.sh'<font></font>
#  mjpg-streamer <font></font>
  start_mgpg_streamer: 'curl http://localhost/start_mjpgstrm.php'<font></font>
# mjpg-streamer<font></font>
  stop_mgpg_streamer: 'curl http://localhost/stop_mjpgstrm.php'<font></font>
#      5 <font></font>
  start_motion_rec: 'curl http://localhost/rec-motion-mjpg.php'<font></font>
# <font></font>
  stop_motion_rec: 'curl http://localhost/rec-motion-mjpg-stop.php'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L√†, dans configuration.yaml, nous d√©crivons notre objet de mailing:</font></font><br>
<br>
<pre><code class="plaintext hljs">notify:<font></font>
  - name: ha_sendmail<font></font>
    platform: smtp<font></font>
#    gmail<font></font>
    server: smtp.gmail.com<font></font>
    port: 587<font></font>
    timeout: 15<font></font>
#  <font></font>
    sender: user@gmail.com<font></font>
    encryption: starttls<font></font>
    username: user@gmail.com<font></font>
    password: passwd<font></font>
#  (       ,    )<font></font>
    recipient:<font></font>
      - user@gmail.com<font></font>
    sender_name: My Home Assistant<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un point important! </font><font style="vertical-align: inherit;">Pour que notre HA se connecte et envoie des lettres (champ exp√©diteur), nous devons autoriser gmail √† utiliser cette case pour notre service HA. </font><font style="vertical-align: inherit;">Comment faire est le lien ici: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myaccount.google.com/lesssecureapps</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Et puis, nous d√©crivons le m√©canisme d'automatisation lui-m√™me lorsque l'alarme home_alarm est activ√©e dans automation.yaml:</font></font><br>
<br>
<pre><code class="plaintext hljs">#   (alias) ‚Äú  ,   ‚Äù<font></font>
- alias: 'Trigger alarm while armed away'<font></font>
#alias ,     ‚Äúon‚Äù<font></font>
  trigger: <font></font>
    - platform: state<font></font>
      entity_id: binary_sensor.sensor_hc_sr501<font></font>
      to: 'on'<font></font>
# ,         ‚Äúarmed away‚Äù<font></font>
  condition:<font></font>
    - condition: state<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
      state: armed_away<font></font>
#     <font></font>
  action:<font></font>
# mjpg-streamer ( )<font></font>
    - service: shell_command.start_mgpg_streamer<font></font>
# ,   <font></font>
    - service: shell_command.start_motion_rec<font></font>
#    ‚Äú  ‚Äù   HA   ‚Äú ‚Äù<font></font>
    - service: alarm_control_panel.alarm_trigger<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le groupe de conditions et d'actions suivant consiste √† envoyer un message de console lors de la d√©sactivation de la ¬´s√©curit√©¬ª et √† d√©sactiver nos scripts d'enregistrement de mouvement:</font></font><br>
<br>
<pre><code class="plaintext hljs">- alias: 'Send notification when alarm is Disarmed'<font></font>
  trigger:<font></font>
    - platform: state<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
      to: 'disarmed'<font></font>
  action:<font></font>
    - service: shell_command.stop_mgpg_streamer<font></font>
    - service: shell_command.stop_motion_rec<font></font>
    - service: persistent_notification.create<font></font>
      data:<font></font>
       message: The alarm is Disarmed at {{ states('sensor.date_time') }}"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, le troisi√®me groupe - nous envoyons une lettre avec une photo:</font></font><br>
<br>
<pre><code class="plaintext hljs">- alias: 'Send notification when alarm triggered'<font></font>
  trigger: <font></font>
   - platform: state<font></font>
     entity_id: alarm_control_panel.home_alarm<font></font>
     to: 'triggered'<font></font>
  action:<font></font>
    - service: persistent_notification.create<font></font>
      data:<font></font>
       message: Notification when alarm triggered. Motion sensor HC-SR501 detected.<font></font>
    - delay:<font></font>
       seconds: 4<font></font>
#     <font></font>
    - service: script.webcam_snapshot<font></font>
#      configuration.yaml: notify.ha_sendmail<font></font>
    - service: notify.ha_sendmail<font></font>
      data:<font></font>
        title: 'Intruder alert'<font></font>
        message: '{{now().strftime("%H:%M %Y-%m-%d")}}:Notification when alarm triggered. Motion sensor HC-SR501 detected.'<font></font>
        data:<font></font>
           images:<font></font>
#      script.webcam_snapshot  <font></font>
              - /config/camera/snapshot.jpg<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas que la disposition des lignes est importante dans les fichiers yaml et que les caract√®res d'espace avant les commandes jouent un r√¥le important dans la formation des blocs de code, leur structure. </font><font style="vertical-align: inherit;">V√©rifiez toutes les modifications apport√©es √† votre yaml via la configuration Home Assistant (HA) -&gt; Contr√¥les du serveur -&gt; V√©rifier la configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble √™tre, et votre Raspberry pi devient √©l√©gant ... si la foudre n'est pas rest√©e!) La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
voici - une automatisation HA fonctionnelle, sur mesure! </font><font style="vertical-align: inherit;">N'oubliez pas de m'√©crire ce que vous en pensez! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et, si vous lisez toujours jusqu'au bout, je vous propose les liens promis: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://viamybox.com/downloadpage </font></font><br>
</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/viatc/viamybox Les</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
fichiers de configuration d√©crits ici: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">automation.yaml, configuration.yaml, takeSnapshotWebcam. sh, rec-motion-mjpg.php, mov.py</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr486654/">https://habr.com/ru/post/fr486654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486644/index.html">Antenne DIY en 5 minutes</a></li>
<li><a href="../fr486646/index.html">√âloignez-vous de jQuery √† Svelte, pas de douleur</a></li>
<li><a href="../fr486648/index.html">AWS Lambda en action dans Java 11. Passer √† la production sans serveur</a></li>
<li><a href="../fr486650/index.html">M√©moire dynamique dans les syst√®mes durs en temps r√©el</a></li>
<li><a href="../fr486652/index.html">¬´Critique de la raison pure¬ª pour les programmeurs</a></li>
<li><a href="../fr486656/index.html">Comment ajouter de nouveaux personnages √† Unicode: l'exp√©rience du profane</a></li>
<li><a href="../fr486658/index.html">Plugin de strat√©gie Moxy</a></li>
<li><a href="../fr486660/index.html">Id√©es de table: combinaison spatiale Metro</a></li>
<li><a href="../fr486664/index.html">Hack The Box. Passage RE. Metasploit, chargement de document de bureau, attaque Zip Slip, un peu sur PowerSploit et les jetons</a></li>
<li><a href="../fr486666/index.html">Motoneiges, bi√®re et d√©riv√©s m√©t√©orologiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>