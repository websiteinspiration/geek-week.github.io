<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèø üëåüèª üëÉüèº Trabalho remoto no escrit√≥rio. RDP, Port Knocking, Mikrotik: simples e seguro ‚öΩÔ∏è ‚óΩÔ∏è üë©üèΩ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em conex√£o com a pandemia do v√≠rus covid-19 e a quarentena universal em muitos pa√≠ses, a √∫nica sa√≠da de muitas empresas para continuar trabalhando √© o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trabalho remoto no escrit√≥rio. RDP, Port Knocking, Mikrotik: simples e seguro</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495596/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em conex√£o com a pandemia do v√≠rus covid-19 e a quarentena universal em muitos pa√≠ses, a √∫nica sa√≠da de muitas empresas para continuar trabalhando √© o acesso remoto a empregos via Internet. Existem muitos m√©todos relativamente seguros para o trabalho remoto - mas, dada a escala do problema, voc√™ precisa de um m√©todo simples para qualquer usu√°rio se conectar remotamente ao escrit√≥rio e sem a necessidade de configura√ß√µes adicionais, explica√ß√µes, consultas tediosas e instru√ß√µes longas. Este m√©todo √© o favorito de muitos administradores RDP (Remote Desktop Protocol). Conectar-se diretamente ao local de trabalho via RDP resolve o nosso problema idealmente, exceto por uma grande mosca na pomada - manter a porta RDP aberta para a Internet √© muito inseguro. Portanto, abaixo, proponho um m√©todo de prote√ß√£o simples, por√©m confi√°vel.</font></font><img src="https://habrastorage.org/webt/yv/o3/ut/yvo3utx5cj_wwte6jja-pe6swfw.jpeg" alt="imagem"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Como geralmente encontro pequenas organiza√ß√µes nas quais os dispositivos Mikrotik s√£o usados ‚Äã‚Äãcomo acesso √† Internet, ser√° mostrado abaixo como implementar isso no Mikrotik, mas o m√©todo de prote√ß√£o Port Knocking √© facilmente implementado em outros dispositivos de classe superior com as mesmas configura√ß√µes para o roteador de entrada e firewall </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brevemente sobre Port Knocking</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Uma prote√ß√£o externa ideal para uma rede conectada √† Internet √© quando todos os recursos e portas s√£o fechados externamente por um firewall. E embora um roteador com esse firewall configurado n√£o reaja de maneira alguma aos pacotes vindos de fora, ele os ouve. Portanto, voc√™ pode configurar o roteador para que, ao receber uma certa sequ√™ncia (de c√≥digo) de pacotes de rede em portas diferentes, ele (o roteador) para IP de onde vieram os pacotes abra o acesso a determinados recursos (portas, protocolos etc.).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora ao ponto. </font><font style="vertical-align: inherit;">N√£o farei uma descri√ß√£o detalhada das configura√ß√µes de firewall no Mikrotik - a Internet est√° cheia de fontes de alta qualidade para isso. </font><font style="vertical-align: inherit;">Idealmente, um firewall bloqueia todos os pacotes recebidos, mas</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=accept chain=input comment="established and related accept" connection-state=established,related</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permite tr√°fego de entrada de conex√µes estabelecidas (relacionadas). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora configure o Port Knocking no Mikrotik:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
move [/ip firewall filter find comment=RemoteRules] 1<font></font>
/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora mais: as </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
duas primeiras regras</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
proibir pacotes recebidos de endere√ßos IP que est√£o na lista negra ao digitalizar portas; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A terceira regra:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adiciona ip √† lista de hosts que fizeram a primeira batida correta na porta desejada (19000); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As quatro regras a seguir:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
crie portas de intercepta√ß√£o para aqueles que desejam varrer suas portas e, quando essas tentativas forem detectadas, coloque seu IP na lista negra por 60 minutos, durante o qual as duas primeiras regras impedir√£o que esses hosts batam nas portas corretas; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguinte regra:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
coloca ip na lista de permiss√µes por 1 minuto (o suficiente para estabelecer uma conex√£o), uma vez que a segunda batida correta √© feita na porta desejada (16000); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pr√≥ximo comando:</font></font><br>
<br>
<pre><code class="plaintext hljs">move [/ip firewall filter find comment=RemoteRules] 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
move nossas regras para a cadeia de processamento do firewall, pois provavelmente j√° teremos regras de proibi√ß√£o diferentes configuradas que impedir√£o que nossos rec√©m-criados funcionem. A primeira regra no Mikrotik come√ßa do zero, mas no meu dispositivo o zero foi ocupado pela regra interna e era imposs√≠vel mover - mudei para 1. Ent√£o, olhamos para as nossas configura√ß√µes - onde voc√™ pode mover e especificar o n√∫mero desejado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguinte configura√ß√£o:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp_to_33" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
encaminha a porta 33890 selecionada aleatoriamente para uma porta RDP comum 3389 e ip do computador ou servidor de terminal de que precisamos. </font><font style="vertical-align: inherit;">Criamos essas regras para todos os recursos internos necess√°rios, de prefer√™ncia expondo portas externas n√£o padr√£o (e diferentes). </font><font style="vertical-align: inherit;">Naturalmente, o ip de recursos internos deve ser est√°tico ou protegido para um servidor DHCP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora nosso Mikrotik est√° configurado e precisamos de um procedimento simples para o usu√°rio se conectar ao nosso RDP interno. </font><font style="vertical-align: inherit;">Como temos principalmente usu√°rios do Windows, criamos um arquivo bat simples e o chamamos de StartRDP.bat:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.htm<font></font>
1.rdp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
consequentemente 1.htm cont√©m o seguinte c√≥digo:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:19000/1.jpg"</span>&gt;</span><font></font>
       RDP<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:16000/2.jpg"</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ele cont√©m dois links para imagens imagin√°rias localizadas no endere√ßo my_router.sn.mynetname.net - pegamos esse endere√ßo do sistema DDNS do Mikrotik pr√©-habilitando-o em nosso Mikrotik: v√° para o menu IP-&gt; Nuvem - marque a caixa de sele√ß√£o DDNS ativado, clique em Aplicar e copie o nome do DNS do nosso roteador. Mas isso √© necess√°rio apenas quando o ip externo do roteador √© din√¢mico ou √© usada uma configura√ß√£o com v√°rios provedores de Internet.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A porta no primeiro link: 19000 corresponde √† primeira porta na qual voc√™ precisa bater, na segunda, respectivamente, na segunda. Entre os links, h√° uma breve instru√ß√£o que mostra o que fazer se, de repente, nossa conex√£o for interrompida devido a problemas de rede curtos - atualizamos a p√°gina, a porta RDP se abre novamente para n√≥s por 1 minuto e nossa sess√£o √© restaurada. Al√©m disso, o texto entre as tags img forma um micro atraso para o navegador, o que reduz a probabilidade de o primeiro pacote ser entregue na segunda porta (16000) - at√© o momento n√£o houve casos em duas semanas de uso (30 pessoas). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, est√° o arquivo 1.rdp, que podemos configurar um para todos ou separadamente para cada usu√°rio (eu fiz isso - √© mais f√°cil gastar mais 15 minutos do que v√°rias horas para consultar aqueles que n√£o conseguiram descobrir)</font></font><br>
<br>
<pre><code class="plaintext hljs">screen mode id:i:2<font></font>
use multimon:i:1<font></font>
.....<font></font>
connection type:i:6<font></font>
networkautodetect:i:0<font></font>
.....<font></font>
disable wallpaper:i:1<font></font>
.....<font></font>
full address:s:my_router.sn.mynetname.net:33890<font></font>
.....<font></font>
username:s:myuserlogin<font></font>
domain:s:mydomain</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
das configura√ß√µes interessantes aqui usam multimon: i: 1 - isso inclui o uso de v√°rios monitores - alguns precisam, mas eles n√£o pensam em ativ√°-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tipo de conex√£o: i: 6 e networkautodetect: i: 0 - como a maioria da Internet √© superior a 10 Mbps, ative o tipo de conex√£o 6 (rede local de 10 Mbps e superior) e desative o networkautodetect, porque se for (autom√°tico) por padr√£o, √© ainda raro o atraso da rede define automaticamente permanentemente uma velocidade subestimada para a nossa sess√£o, o que pode criar atrasos vis√≠veis no trabalho, especialmente em programas gr√°ficos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
desativar papel de parede: i: 1 - desativar o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nome de usu√°rio da </font><font style="vertical-align: inherit;">imagem da √°rea de trabalho </font><font style="vertical-align: inherit;">: s: myuserlogin - especifique o nome de usu√°rio, pois uma parte significativa de nossos usu√°rios n√£o sabe o nome de usu√°rio</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
domain: s: mydomain - especifique o dom√≠nio ou o nome do computador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, se queremos simplificar a tarefa de criar um procedimento de conex√£o, tamb√©m podemos usar o PowerShell - StartRDP.ps1</font></font><br>
<br>
<pre><code class="plaintext hljs">Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 19000<font></font>
Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 16000<font></font>
mstsc /v:my_router.sn.mynetname.net:33890</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m um pouco sobre o cliente RDP no Windows: a MS percorreu um longo caminho para otimizar o protocolo e seu servidor e o lado do cliente, implementou muitos recursos √∫teis - como trabalhar com o hardware 3D, otimizar a resolu√ß√£o da tela do monitor, da tela m√∫ltipla e muito mais. Mas, √© claro, tudo √© implementado no modo de compatibilidade com vers√µes anteriores e, se o cliente for Windows 7 e o PC remoto for Windows 10, o RDP funcionar√° usando a vers√£o 7.0 do protocolo. Mas o benef√≠cio √© que voc√™ pode atualizar vers√µes do RDP para vers√µes mais recentes - por exemplo, voc√™ pode atualizar a vers√£o do protocolo de 7.0 (Windows 7) para 8.1. Portanto, para a conveni√™ncia dos clientes, voc√™ precisa maximizar a vers√£o do servidor, bem como liberar links para atualizar para novas vers√µes dos clientes do protocolo RDP.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, temos uma tecnologia simples e relativamente segura para conex√£o remota a um PC ou servidor de terminal em funcionamento. </font><font style="vertical-align: inherit;">Mas, para uma conex√£o mais segura, nosso m√©todo Port Knocking pode ser complicado para ataques de v√°rias ordens de magnitude, adicionando portas para verifica√ß√£o - voc√™ pode adicionar 3,4,5,6 ... a mesma l√≥gica e, neste caso, uma intrus√£o direta em sua rede ser√° quase imposs√≠vel . </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espa√ßos em branco de arquivo para criar uma conex√£o remota com o RDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495576/index.html">Plataforma automotriz no esp8266 MK com micropython</a></li>
<li><a href="../pt495580/index.html">JVM de pepino - n√£o apenas BDD</a></li>
<li><a href="../pt495588/index.html">Criando roguelike no Unity a partir do zero: gerador de masmorras</a></li>
<li><a href="../pt495592/index.html">Como usar dicion√°rios (e n√£o apenas)</a></li>
<li><a href="../pt495594/index.html">Comece a ganhar dinheiro com software: criando mini-neg√≥cios digitais</a></li>
<li><a href="../pt495602/index.html">Come√ßando com os dados principais! Dif√≠cil em palavras simples [Parte 2]</a></li>
<li><a href="../pt495604/index.html">Localiza√ß√£o tempor√°ria no Symfony 4 + Twig</a></li>
<li><a href="../pt495606/index.html">"Monitoramento social". Pontua√ß√£o 1: 0 a nosso favor</a></li>
<li><a href="../pt495608/index.html">[Infogr√°fico] Visualiza√ß√£o de pandemias na hist√≥ria da humanidade</a></li>
<li><a href="../pt495610/index.html">Por que o futuro n√£o √© para Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>