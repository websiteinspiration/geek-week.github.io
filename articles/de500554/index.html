<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👨🏽 🙏🏻 🤴🏼 Golang Backend Server Vorlage - Teil 2 (REST API) 🚍 🔣 🕵🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die unten stehende Golang-Servervorlage wurde erstellt, um Wissen innerhalb unseres Teams zu übertragen. Das Hauptziel der Vorlage besteht neben der S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Golang Backend Server Vorlage - Teil 2 (REST API)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500554/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die unten stehende Golang-Servervorlage wurde erstellt, um Wissen innerhalb unseres Teams zu übertragen. </font><font style="vertical-align: inherit;">Das Hauptziel der Vorlage besteht neben der Schulung darin, die Zeit für das Prototyping kleiner Serveraufgaben auf Go zu verkürzen.</font></font></p><br>
<p><strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der erste Teil der</font></font></a></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vorlage war dem HTTP-Server gewidmet:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurieren eines HTTP-Servers über die Befehlszeile und die Konfigurationsdatei</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurieren Sie die TLS-HTTP-Servereinstellungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Router-Setup und Registrierung von HTTP und Prof-Handlern</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichten der HTTP-Verkehrsprotokollierung, HTTP-Fehlerprotokollierung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP Basic- und MS AD-Authentifizierung, JSON-Web-Token</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Starten des Servers, der auf eine Rückkehr zum Fehlerkanal wartet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden des Kontexts, um den Server und die zugehörigen Dienste korrekt zu stoppen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benutzerdefinierte Fehlerbehandlung und benutzerdefinierte Protokollierung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code-Assembly mit Implementierung von Version, Erstellungsdatum und Festschreiben</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der zweite Teil der Vorlage ist dem Prototyping der REST-API gewidmet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Link zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projekt-Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bleibt unverändert.</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/5d3/ec6/db2/5d3ec6db2b43d2b01e06665fa558d027.png" alt="REST-API-Vorlagenarchitektur"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Während des Testens der Schablone am </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stand</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurden die folgenden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnisse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erhalten </font><font style="vertical-align: inherit;">.</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im direkten Lesemodus von PostgreSQL - bis zu 16.000 [get / sec], Parallelität 1024, Median 60 [ms]. </font><font style="vertical-align: inherit;">Jeder Get fordert Daten aus zwei Tabellen mit einer Gesamtgröße von 360.000.000 Zeilen an. </font><font style="vertical-align: inherit;">Die JSON-Größe beträgt 1800 Byte.</font></font></li>
<li>        100 000 — 120 000 [get/sec], oncurrency 1024,  2 [ms]. Transfer rate   200-250 [MB/sec]</li>
<li>   PostgreSQL —  10 000 [insert/sec].</li>
</ul><a name="habracut"></a><br>
<h2 id="soderzhanie-stati"> </h2><br>
<ol>
<li>  </li>
<li> <br>
<ul>
<li>  ,   </li>
<li>   </li>
<li>   </li>
<li>Marshal / Unmarshal   JSON </li>
</ul></li>
<li> <strong>SQLXX</strong> <br>
<ul>
<li>    </li>
<li>  </li>
<li>  SQL </li>
</ul></li>
<li> <strong>DB</strong> <br>
<ul>
<li>    </li>
<li>    </li>
<li>    </li>
</ul></li>
<li> <strong>JSON</strong> <br>
<ul>
<li>Marshal / Unmarshal JSON </li>
<li>Unmarshal JSON </li>
<li>      </li>
<li> JSON </li>
</ul></li>
<li> <strong>HTTP</strong> <br>
<ul>
<li>    </li>
<li> GET, POST, PUT </li>
<li>  </li>
</ul></li>
<li>  <br>
<ul>
<li>  </li>
<li> </li>
</ul></li>
</ol><br>
<h2 id="1-opisanie-arhitekturnogo-podhoda">1.   </h2><br>
<p>      .</p><br>
<ol>
<li>   <strong>Model</strong>  :<br>
<ul>
<li>   </li>
<li>      </li>
<li>  </li>
<li>   Marshal / Unmarshal JSON </li>
<li>    </li>
<li> -</li>
</ul></li>
<li>      <strong>SQLXX</strong>  :<br>
<ul>
<li>    </li>
<li>     </li>
<li>   </li>
<li>  SQL</li>
</ul></li>
<li>     <strong>DB</strong>  :<br>
<ul>
<li>  ,    SQL</li>
<li>   </li>
<li> </li>
<li>   </li>
</ul></li>
<li>  JSON <strong>JSON</strong>  :<br>
<ul>
<li>     </li>
<li>Marshal / Unmarshal JSON</li>
<li> JSON</li>
</ul></li>
<li> HTTP  <strong>HTTP</strong>  :<br>
<ul>
<li>  HTTP </li>
<li>   HTTP </li>
<li>  (basic, MS AD, ...)</li>
<li>  token</li>
<li>  (body)  </li>
<li>  (header)  </li>
<li>    </li>
<li>      </li>
<li> HSTS Strict-Transport-Security</li>
<li> Content-Type    (response)</li>
<li>  HTTP </li>
<li>  (header)  </li>
<li>   </li>
<li>   </li>
<li> defer recovery    panic</li>
</ul></li>
</ol><br>
<p>        REST API    : FaaS, , gRPC.</p><br>
<h2 id="2-model-dannyh-model">2   <strong>Model</strong></h2><br>
<h3 id="21-struktura-modeli-dannyh-interfeys-obrabotki">2.1.   ,  </h3><br>
<h4 id="211-primer-formalizovannoy-modeli-dannyh">2.1.1    </h4><br>
<p>  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">"Department"  "Employee"</a>.       .<br>
         ,  JOSN   .<br>
            (-).</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// Dept represent object "Department"</span>
<span class="hljs-keyword">type</span> Dept <span class="hljs-keyword">struct</span> {<font></font>
    Deptno <span class="hljs-keyword">int</span>         <span class="hljs-string">`db:"deptno" json:"deptNumber" validate:"required"`</span>
    Dname  <span class="hljs-keyword">string</span>      <span class="hljs-string">`db:"dname" json:"deptName" validate:"required"`</span>
    Loc    null.String <span class="hljs-string">`db:"loc" json:"deptLocation,nullempty"`</span>
    Emps   []*Emp      <span class="hljs-string">`json:"emps,omitempty"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Emp represent object "Employee"</span>
<span class="hljs-keyword">type</span> Emp <span class="hljs-keyword">struct</span> {<font></font>
    Empno    <span class="hljs-keyword">int</span>         <span class="hljs-string">`db:"empno" json:"empNo" validate:"required"`</span>
    Ename    null.String <span class="hljs-string">`db:"ename" json:"empName,nullempty"`</span>
    Job      null.String <span class="hljs-string">`db:"job" json:"job,nullempty"`</span>
    Mgr      null.Int    <span class="hljs-string">`db:"mgr" json:"mgr,omitempty"`</span>
    Hiredate null.String <span class="hljs-string">`db:"hiredate" json:"hiredate,nullempty"`</span>
    Sal      null.Int    <span class="hljs-string">`db:"sal" json:"sal,nullempty" validate:"gte=0"`</span>
    Comm     null.Int    <span class="hljs-string">`db:"comm" json:"comm,nullempty" validate:"gte=0"`</span>
    Deptno   null.Int    <span class="hljs-string">`db:"deptno" json:"deptNumber,nullempty"`</span>
}</code></pre><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"></a>.<br>
              (        ).<br>
 , ,   - (,      ).     ""      .<br>
       REST API   ,       : Get, Create, Update.<br>
     context.Context —    " ".<br>
    ,    ,  ,     ,    ,   .       sync.Pool.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// DeptService represent basic interface for Dept</span>
<span class="hljs-keyword">type</span> DeptService <span class="hljs-keyword">interface</span> {<font></font>
    GetDept(ctx context.Context, out *Dept) (<span class="hljs-keyword">bool</span>, error)<font></font>
    GetDeptsPK(ctx context.Context, out *DeptPKs) error<font></font>
    CreateDept(ctx context.Context, in *Dept, out *Dept) error<font></font>
    UpdateDept(ctx context.Context, in *Dept, out *Dept)  (<span class="hljs-keyword">bool</span>, error)<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// EmpService represent basic interface for Emp</span>
<span class="hljs-keyword">type</span> EmpService <span class="hljs-keyword">interface</span> {<font></font>
    GetEmp(ctx context.Context, out *Emp) (<span class="hljs-keyword">bool</span>, error)<font></font>
    GetEmpsByDept(ctx context.Context, in *Dept, out *EmpSlice) error<font></font>
    CreateEmp(ctx context.Context, in *Emp, out *Emp) error<font></font>
    UpdateEmp(ctx context.Context, in *Emp, out *Emp)  (<span class="hljs-keyword">bool</span>, error)<font></font>
}</code></pre><br>
<h4 id="212-primer-modeli-dannyh-dlya-raboty-s-ocheredyu">2.1.2       </h4><br>
<p>      IBM MQ.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// Request represent a type for request</span>
<span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> {<font></font>
    QObject               <span class="hljs-keyword">string</span> <span class="hljs-comment">//  </span>
    QueueName             <span class="hljs-keyword">string</span> <span class="hljs-comment">//    </span>
    QueueOptions          <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// MQOO_OUTPUT, MQOO_BROWSE, MQOO_INPUT_AS_Q_DEF  </span>
    QueueWaitInterval     <span class="hljs-keyword">int</span>    <span class="hljs-comment">//      seconds</span>
    MsgIdHex              <span class="hljs-keyword">string</span> <span class="hljs-comment">//    Hex </span>
    CorrelIdHex           <span class="hljs-keyword">string</span> <span class="hljs-comment">//     Hex </span>
    MesFormat             <span class="hljs-keyword">string</span> <span class="hljs-comment">// MQFMT_NONE, MQFMT_STRING</span>
    MesSyncpoint          <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// MQPMO_NO_SYNCPOINT, MQPMO_SYNCPOINT</span>
    MesOptions            <span class="hljs-keyword">int32</span>  <span class="hljs-comment">//</span>
    BrowseOptions         <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// MQGMO_BROWSE_FIRST, MQGMO_BROWSE_NEXT, ...</span>
    Bufsize               <span class="hljs-keyword">int</span>    <span class="hljs-comment">//  </span>
    Buf                   []<span class="hljs-keyword">byte</span> <span class="hljs-string">`json:"-"`</span> <span class="hljs-comment">//   </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Response represent a type for response</span>
<span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> {<font></font>
    QObject      <span class="hljs-keyword">string</span> <span class="hljs-comment">//  </span>
    QueueName    <span class="hljs-keyword">string</span> <span class="hljs-comment">//    </span>
    MsgId        []<span class="hljs-keyword">byte</span> <span class="hljs-comment">//    byte </span>
    MsgIdHex     <span class="hljs-keyword">string</span> <span class="hljs-comment">//    Hex </span>
    CorrelId     []<span class="hljs-keyword">byte</span> <span class="hljs-comment">//     byte </span>
    CorrelIdHex  <span class="hljs-keyword">string</span> <span class="hljs-comment">//     Hex </span>
    PutDate      <span class="hljs-keyword">string</span> <span class="hljs-comment">//     </span>
    PutTime      <span class="hljs-keyword">string</span> <span class="hljs-comment">//     </span>
    DataLen      <span class="hljs-keyword">int</span>    <span class="hljs-comment">//  </span>
    ErrCode      <span class="hljs-keyword">string</span> <span class="hljs-comment">//  </span>
    ErrMes       <span class="hljs-keyword">string</span> <span class="hljs-comment">//   </span>
    ErrTrace     <span class="hljs-keyword">string</span> <span class="hljs-comment">//    </span>
    CauseErrCode <span class="hljs-keyword">string</span> <span class="hljs-comment">//    - </span>
    CauseErrMes  <span class="hljs-keyword">string</span> <span class="hljs-comment">//    - </span>
    Buf          []<span class="hljs-keyword">byte</span> <span class="hljs-comment">//   </span>
}</code></pre><br>
<p>       IBM MQ.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// QueueService represent basic service for queue</span>
<span class="hljs-keyword">type</span> QueueService <span class="hljs-keyword">interface</span> {<font></font>
    OpenQueue(ctx context.Context, req *Request, resp *Response) error<font></font>
    CloseQueue(ctx context.Context, req *Request, resp *Response) error<font></font>
    BrowseMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    BrowseFirstMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    BrowseNextMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    BrowseUnderMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    GetMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    DeleteUnderMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    PutMessage(ctx context.Context, req *Request, resp *Response) error<font></font>
    RegisterCallback(ctx context.Context, req *Request, resp *Response) error<font></font>
    DeregisterCallback(ctx context.Context, req *Request, resp *Response) error<font></font>
}</code></pre><br>
<h3 id="22-validaciya-modeli-dannyh">2.2.   </h3><br>
<p>   ,    :</p><br>
<ol>
<li><strong> </strong> — ,       . , "" &gt; 0, "" not null.</li>
<li><strong>    </strong> — , " " &gt;= " "</li>
<li><strong>     ()</strong> — , "    " &gt;= "  " </li>
<li><strong>    </strong> — ,   (PK, UK),    .</li>
<li><strong>    </strong> — ,    (FK),       .</li>
<li><strong>    </strong> — ,             .</li>
</ol><br>
<p> 1, 2  3        .  4, 5, 6 , ,      .</p><br>
<p>            .<br>
          ,   , ,   .</p><br>
<ul>
<li>        .</li>
<li>      " API".  ,    DML .  ,        API. ,   Oracle  ,      API.</li>
<li>     (View API), ,     .</li>
<li>   Instead of Trigger   DML     API.</li>
</ul><br>
<p>  ,       —      DML .       (  Oracle      ).      API,         .<br>
        .</p><br>
<p>   ,     1, 2  3    JSON .</p><br>
<p>    3      1, 2  3     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">gopkg.in/go-playground/validator</a>.<br>
 4              (PK, UK).<br>
  5  6       .</p><br>
<h3 id="23-pul-obektov-modeli">2.3.   </h3><br>
<p>     REST API (JSON-&gt;Model-&gt;DB)      ().  ,   ,   JSON  .      API,         (GC).        (   GC).</p><br>
<p>     GC —   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">sync.Pool</a>.    .     —    sync.Pool.<br>
 ,     —   sync.Pool,      ,     ,  ,     .</p><br>
<p>       sync.Pool    :</p><br>
<ul>
<li>  </li>
<li>    —     </li>
<li>   </li>
<li>  —        </li>
</ul><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">  Dept</a></p><br>
<pre><code class="go hljs"><span class="hljs-comment">// deptsPool represent depts pooling</span>
<span class="hljs-keyword">var</span> deptsPool = sync.Pool{<font></font>
    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>{} { <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(Dept) },<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// GetDept allocates a new struct or grabs a cached one</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetDept</span><span class="hljs-params">()</span> *<span class="hljs-title">Dept</span></span> {<font></font>
    p := deptsPool.Get().(*Dept)<font></font>
    p.Reset()<font></font>
    <span class="hljs-keyword">return</span> p<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// PutDept return struct to cache</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PutDept</span><span class="hljs-params">(p *Dept, isCascad <span class="hljs-keyword">bool</span>)</span></span> {
    <span class="hljs-keyword">if</span> p != <span class="hljs-literal">nil</span> {<font></font>
        PutEmpSlice(p.Emps, isCascad)<font></font>
        p.Emps = <span class="hljs-literal">nil</span><font></font>
        deptsPool.Put(p)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Reset reset all fields in structure - use for sync.Pool</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Dept)</span> <span class="hljs-title">Reset</span><span class="hljs-params">()</span></span> {<font></font>
    p.Deptno = <span class="hljs-number">0</span>
    p.Dname = <span class="hljs-string">""</span>
    p.Loc.String = <span class="hljs-string">""</span>
    p.Loc.Valid = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> p.Emps != <span class="hljs-literal">nil</span> {<font></font>
        EmpSlice(p.Emps).Reset()<font></font>
    }<font></font>
    p.Emps = <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
<p>           </p><br>
<pre><code class="go hljs"><span class="hljs-comment">//EmpSlice represent slice of Emps</span>
<span class="hljs-keyword">type</span> EmpSlice []*Emp<font></font>
<font></font>
<span class="hljs-comment">// PutEmpSlice return struct to cache</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PutEmpSlice</span><span class="hljs-params">(p EmpSlice)</span></span> {
    <span class="hljs-keyword">if</span> p != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> p {<font></font>
            p[i] = <span class="hljs-literal">nil</span> <span class="hljs-comment">//      </span><font></font>
        }<font></font>
        p = p[:<span class="hljs-number">0</span>] <span class="hljs-comment">//   </span><font></font>
        empSlicePool.Put(p)<font></font>
    }<font></font>
}</code></pre><br>
<p> ,    ,  1000000 Get ,     500  .     .<br>
   ,   sync.Pool   CPU,         sync.Pool .<br>
 dept  emp          ,      . </p><br>
<h3 id="24-marshal--unmarshal-modeli-v-json">2.4. Marshal / Unmarshal   JSON</h3><br>
<p>  encoding/json    .<br>
     :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/francoispqt/gojay</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/mailru/easyjson</a></li>
</ul><br>
<p>    .    .<br>
  :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/francoispqt/gojay</a><br>
<ul>
<li>   NULL   .</li>
<li>  sync.Pool    encode.     ,     2  ,    ,    .      —  512 .</li>
<li>        encode JSON.</li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/mailru/easyjson</a><br>
<ul>
<li>    NULL   </li>
<li>      sync.Pool.     512  32768  ( ).  encode JSON        .</li>
<li>       encode JSON</li>
</ul></li>
</ul><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/mailru/easyjson</a>.</p><br>
<p>    ,      ,   /  JSON   .</p><br>
<pre><code class="go hljs"><span class="hljs-comment">//easyjson:json</span>
<span class="hljs-keyword">type</span> Dept <span class="hljs-keyword">struct</span> {<font></font>
    Deptno <span class="hljs-keyword">int</span>         <span class="hljs-string">`db:"deptno" json:"deptNumber" validate:"required"`</span>
    Dname  <span class="hljs-keyword">string</span>      <span class="hljs-string">`db:"dname" json:"deptName" validate:"required"`</span>
    Loc    null.String <span class="hljs-string">`db:"loc" json:"deptLocation,nullempty"`</span>
    Emps   []*Emp      <span class="hljs-string">`json:"emps,omitempty"`</span>
}</code></pre><br>
<p> ,  easyjson   NULL   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">gopkg.in/guregu/null.v4</a>.  ,    NULL       , , <strong>"Loc null.String"</strong>   <strong>"Loc sql.NullString"</strong>.</p><br>
<p>   .</p><br>
<pre><code class="bash hljs">easyjson model.go</code></pre><br>
<p> Marshal / Unmarshal   ,  JSON.</p><br>
<h2 id="3-sloy-sqlxx">3.  <strong>SQLXX</strong></h2><br>
<p>     <strong>SQLXX</strong>    :</p><br>
<ul>
<li>       </li>
<li>    </li>
<li>     , ,   Listen/notify    PostgreSQL (jackc/pgx/stdlib  lib/pq)</li>
</ul><br>
<p>       ,        .<br>
    ,  ,          SQL   .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">httpserver/sqlxx</a>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">jmoiron/sqlx</a>.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// DB is a wrapper around sqlx.DB</span>
<span class="hljs-keyword">type</span> DB <span class="hljs-keyword">struct</span> {<font></font>
    *sqlx.DB<font></font>
<font></font>
    cfg     *Config<font></font>
    sqlStms SQLStms <span class="hljs-comment">// SQL </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Tx is an sqlx wrapper around sqlx.Tx</span>
<span class="hljs-keyword">type</span> Tx <span class="hljs-keyword">struct</span> {<font></font>
    *sqlx.Tx<font></font>
}</code></pre><br>
<p>  ,  ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">jmoiron/sqlx</a>, ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">jackc/pgx</a>.</p><br>
<h3 id="31-obrabotka-oshibok-i-panik">3.1.    </h3><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">jmoiron/sqlx</a>  ,       : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Beginx, Rollback, Commit, Select, Get, Exec</a>.<br>
        .<br>
         INFO  trace.   , ,  ,    ,        .</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Commit</span><span class="hljs-params">(reqID <span class="hljs-keyword">uint64</span>, tx *Tx)</span> <span class="hljs-params">(myerr error)</span></span> {
    <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {<font></font>
        r := <span class="hljs-built_in">recover</span>()
        <span class="hljs-keyword">if</span> r != <span class="hljs-literal">nil</span> {<font></font>
            msg := <span class="hljs-string">"PostgreSQL recover from panic: commit transaction: reqID"</span>
            <span class="hljs-keyword">switch</span> t := r.(<span class="hljs-keyword">type</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">string</span>:<font></font>
                myerr = myerror.New(<span class="hljs-string">"4008"</span>, msg, reqID, t).PrintfInfo()
            <span class="hljs-keyword">case</span> error:<font></font>
                myerr = myerror.WithCause(<span class="hljs-string">"4006"</span>, msg, t, reqID).PrintfInfo()
            <span class="hljs-keyword">default</span>:<font></font>
                myerr = myerror.New(<span class="hljs-string">"4006"</span>, msg, reqID).PrintfInfo()<font></font>
            }<font></font>
        }<font></font>
    }()<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> tx == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Transaction is not defined: reqID"</span>, reqID).PrintfInfo()<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> err := tx.Commit(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> myerror.WithCause(<span class="hljs-string">"4008"</span>, <span class="hljs-string">"Error commit the transaction: reqID"</span>, err, reqID).PrintfInfo()<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>       interface{},   ,      ,    ,       .</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Select</span><span class="hljs-params">(reqID <span class="hljs-keyword">uint64</span>, tx *Tx, sqlStm *SQLStm, dest <span class="hljs-keyword">interface</span>{}, args ...<span class="hljs-keyword">interface</span>{})</span> <span class="hljs-params">(myerr error)</span></span> {
    <span class="hljs-keyword">if</span> dest != <span class="hljs-literal">nil</span> &amp;&amp; !reflect.ValueOf(dest).IsNil() {
        <span class="hljs-comment">// ...</span><font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4400"</span>, <span class="hljs-string">"Incorrect call - nil dest interface{} pointer: reqID"</span>, reqID).PrintfInfo()<font></font>
}</code></pre><br>
<p> reflect.ValueOf(in).IsNil()    ,               .</p><br>
<h3 id="32-parametry-bd">3.2.  </h3><br>
<p>          .      .</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// Config   </span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
    ConnectString   <span class="hljs-keyword">string</span> <span class="hljs-comment">//    </span>
    Host            <span class="hljs-keyword">string</span> <span class="hljs-comment">// host </span>
    Port            <span class="hljs-keyword">string</span> <span class="hljs-comment">//   </span>
    Dbname          <span class="hljs-keyword">string</span> <span class="hljs-comment">//  </span>
    SslMode         <span class="hljs-keyword">string</span> <span class="hljs-comment">//  SSL</span>
    User            <span class="hljs-keyword">string</span> <span class="hljs-comment">//     </span>
    Pass            <span class="hljs-keyword">string</span> <span class="hljs-comment">//  </span>
    ConnMaxLifetime <span class="hljs-keyword">int</span>    <span class="hljs-comment">//     </span>
    MaxOpenConns    <span class="hljs-keyword">int</span>    <span class="hljs-comment">//    </span>
    MaxIdleConns    <span class="hljs-keyword">int</span>    <span class="hljs-comment">//    </span>
    DriverName      <span class="hljs-keyword">string</span> <span class="hljs-comment">//   "postgres" | "pgx" | "godror"</span><font></font>
}<font></font>
</code></pre><br>
<h3 id="33-rabota-s-sql">3.3.   SQL</h3><br>
<p> <strong>SQLXX</strong>      SQL   interface{}.<br>
       ,    SQL .</p><br>
<p>  <strong>SQLXX</strong>   SQL      .   SQL    ,      ,     (  SQL  ).</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// SQLStm represent SQL text and sqlx.Stmt</span>
<span class="hljs-keyword">type</span> SQLStm <span class="hljs-keyword">struct</span> {<font></font>
    Text      <span class="hljs-keyword">string</span>     <span class="hljs-comment">//  SQL </span>
    Stmt      *sqlx.Stmt <span class="hljs-comment">//  SQL </span>
    IsPrepare <span class="hljs-keyword">bool</span>       <span class="hljs-comment">// ,     SQL </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// SQLStms represent SQLStm map</span>
<span class="hljs-keyword">type</span> SQLStms <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*SQLStm</code></pre><br>
<h2 id="4-sloy-db">4.  <strong>DB</strong></h2><br>
<p>  <strong>DB</strong>    :</p><br>
<ul>
<li>    </li>
<li>      </li>
<li> </li>
<li>   </li>
</ul><br>
<h3 id="41-podklyuchenie-k-bd-rabota-s-sql">4.1.   ,   SQL</h3><br>
<p> ,        (-)  :</p><br>
<ul>
<li>   (PK) —         API.      GUID,   ,   BTree    .</li>
<li>   (UK), , " ".  UK          .</li>
<li>    (FK)     PK.         (FK),     FK    API  .           FK.</li>
</ul><br>
<p>   dept  emp,    ,      —       .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">DB</a>       SQL .<br>
    SQL      : "GetDept", "GetDeptUK", "DeptExists"  ..   ,      SQL.</p><br>
<p>    ,   SQL :</p><br>
<ul>
<li>     PK, , "GetDept"</li>
<li>     UK, , "GetDeptUK"</li>
<li>     PK   UK, , "DeptExists"</li>
</ul><br>
<p>      ,      View API.   SQL    REST API   .      .</p><br>
<pre><code class="go hljs">service.SQLStms = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*sql.SQLStm{
    <span class="hljs-string">"GetDept"</span>:         &amp;sql.SQLStm{<span class="hljs-string">"SELECT deptno, dname, loc FROM dept WHERE deptno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetDeptUK"</span>:       &amp;sql.SQLStm{<span class="hljs-string">"SELECT deptno, dname, loc FROM dept WHERE deptno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"DeptExists"</span>:      &amp;sql.SQLStm{<span class="hljs-string">"SELECT 1 FROM dept WHERE deptno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetDepts"</span>:        &amp;sql.SQLStm{<span class="hljs-string">"SELECT deptno, dname, loc FROM dept"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetDeptsPK"</span>:      &amp;sql.SQLStm{<span class="hljs-string">"SELECT deptno FROM dept"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"CreateDept"</span>:      &amp;sql.SQLStm{<span class="hljs-string">"INSERT INTO dept (deptno, dname, loc) VALUES (:deptno, :dname, :loc)"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>},
    <span class="hljs-string">"UpdateDept"</span>:      &amp;sql.SQLStm{<span class="hljs-string">"UPDATE dept SET dname = :dname, loc = :loc WHERE deptno = :deptno"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>},
    <span class="hljs-string">"EmpExists"</span>:       &amp;sql.SQLStm{<span class="hljs-string">"SELECT 1 FROM emp WHERE empno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetEmp"</span>:          &amp;sql.SQLStm{<span class="hljs-string">"SELECT empno, ename, job, mgr, hiredate, sal, comm, deptno FROM emp WHERE empno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetEmpUK"</span>:        &amp;sql.SQLStm{<span class="hljs-string">"SELECT empno, ename, job, mgr, hiredate, sal, comm, deptno FROM emp WHERE empno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetEmpsByDept"</span>:   &amp;sql.SQLStm{<span class="hljs-string">"SELECT empno, ename, job, mgr, hiredate, sal, comm, deptno FROM emp WHERE deptno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"GetEmpsPKByDept"</span>: &amp;sql.SQLStm{<span class="hljs-string">"SELECT empno FROM emp WHERE deptno = $1"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>},
    <span class="hljs-string">"CreateEmp"</span>:       &amp;sql.SQLStm{<span class="hljs-string">"INSERT INTO emp (empno, ename, job, mgr, hiredate, sal, comm, deptno) VALUES (:empno, :ename, :job, :mgr, :hiredate, :sal, :comm, :deptno)"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>},
    <span class="hljs-string">"UpdateEmp"</span>:       &amp;sql.SQLStm{<span class="hljs-string">"UPDATE emp SET empno = :empno, ename = :ename, job = :job, mgr = :mgr, hiredate = :hiredate, sal = :sal, comm = :comm, deptno = :deptno WHERE empno = :empno"</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>},<font></font>
}</code></pre><br>
<p>  , SQL   "".</p><br>
<h3 id="42-realizaciya-interfeysov-modeli-dannyh">4.2.    </h3><br>
<p>       :</p><br>
<ul>
<li>     .</li>
<li>          .</li>
</ul><br>
<h4 id="421-shablon-get-metodov">4.2.1  Get </h4><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Get</a>   .  ,         .</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">getDept</span><span class="hljs-params">(ctx context.Context, tx *mysql.Tx, out *model.Dept)</span> <span class="hljs-params">(exists <span class="hljs-keyword">bool</span>, myerr error)</span></span> {<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> exists, myerr = s.db.Get(reqID, tx, <span class="hljs-string">"GetDept"</span>, out, out.Deptno); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> exists {<font></font>
        outEmps := model.GetEmpSlice() <span class="hljs-comment">//   pool    </span>
        <span class="hljs-keyword">if</span> myerr = s.getEmpsByDept(ctx, tx, out, &amp;outEmps); myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
        }<font></font>
        out.Emps = outEmps <span class="hljs-comment">//     </span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> exists, <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Get</a>   .</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">GetDept</span><span class="hljs-params">(ctx context.Context, out *model.Dept)</span> <span class="hljs-params">(exists <span class="hljs-keyword">bool</span>, myerr error)</span></span> {
    <span class="hljs-keyword">return</span> s.getDept(ctx, <span class="hljs-literal">nil</span>, out)<font></font>
}</code></pre><br>
<h4 id="422-shablon-create-metodov">4.2.2  Create </h4><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Create</a>   :</p><br>
<ul>
<li>     <strong>newDept</strong>,        <strong>model.GetDept()</strong>.   ,          .</li>
<li>       .           UK (    Dept   ).<br>
<ul>
<li>  <strong>Get(reqID, tx, "DeptExists", &amp;foo, in.Deptno)</strong>,   —   UK.    <strong>args ...interface{}</strong>,      .</li>
<li>  ,     —  .      .</li>
</ul></li>
<li>      PK<br>
<ul>
<li>     .   ,  SQL       /   1 .  ,        .</li>
<li>     API, ,   /       PK,   ,     <strong>Get(reqID, tx, "GetDeptUK", newDept, in.Deptno)</strong>   UK.</li>
</ul></li>
<li>  <br>
<ul>
<li>    ,     FK <strong>newEmp.Deptno = null.Int{sql.NullInt64{int64(newDept.Deptno), true}}</strong>       <strong>createEmp(ctx, tx, newEmp, nil)</strong>.</li>
<li> ,       .</li>
</ul></li>
<li>  —          PK<br>
<ul>
<li>   —   JSON        .</li>
<li>         HTTP      .</li>
<li>    ,    nil    out.</li>
</ul></li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">createDept</span><span class="hljs-params">(ctx context.Context, tx *mysql.Tx, in *model.Dept, out *model.Dept)</span> <span class="hljs-params">(myerr error)</span></span> {<font></font>
<font></font>
    newDept := model.GetDept()         <span class="hljs-comment">//   pool      </span>
    <span class="hljs-keyword">defer</span> model.PutDept(newDept, <span class="hljs-literal">true</span>) <span class="hljs-comment">//    pool</span><font></font>
<font></font>
    { <span class="hljs-comment">// ,        UK</span>
        <span class="hljs-keyword">var</span> foo <span class="hljs-keyword">int</span>
        exists, myerr := s.db.Get(reqID, tx, <span class="hljs-string">"DeptExists"</span>, &amp;foo, in.Deptno)
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> myerr<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> exists {
            <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Error create - row already exists: reqID, Deptno"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
        }<font></font>
    } <span class="hljs-comment">// ,        UK</span><font></font>
<font></font>
    { <span class="hljs-comment">//       PK</span>
        rows, myerr := s.db.Exec(reqID, tx, <span class="hljs-string">"CreateDept"</span>, in)
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> myerr<font></font>
        }<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span> rows != <span class="hljs-number">1</span> {
            <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Error create: reqID, Deptno, rows"</span>, reqID, in.Deptno, rows).PrintfInfo()<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//    -     ,   </span>
        <span class="hljs-comment">//    UK,    PK    </span>
        exists, myerr := s.db.Get(reqID, tx, <span class="hljs-string">"GetDeptUK"</span>, newDept, in.Deptno)
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> myerr<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> !exists {
            <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Row does not exists after creating: reqID, Deptno"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
        }<font></font>
    } <span class="hljs-comment">//       PK</span><font></font>
<font></font>
    { <span class="hljs-comment">//       </span>
        <span class="hljs-keyword">if</span> in.Emps != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">for</span> _, newEmp := <span class="hljs-keyword">range</span> in.Emps {
                <span class="hljs-comment">//   PK     </span>
                newEmp.Deptno = null.Int{sql.NullInt64{<span class="hljs-keyword">int64</span>(newDept.Deptno), <span class="hljs-literal">true</span>}}<font></font>
<font></font>
                <span class="hljs-comment">//   </span>
                <span class="hljs-keyword">if</span> myerr = s.createEmp(ctx, tx, newEmp, <span class="hljs-literal">nil</span>); myerr != <span class="hljs-literal">nil</span> {
                    <span class="hljs-keyword">return</span> myerr<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    } <span class="hljs-comment">//       </span><font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> out != <span class="hljs-literal">nil</span> {<font></font>
        out.Deptno = newDept.Deptno <span class="hljs-comment">//    PK</span><font></font>
        exists, myerr := s.getDept(ctx, tx, out)<font></font>
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> myerr<font></font>
        }<font></font>
        <span class="hljs-comment">//     API</span>
        <span class="hljs-keyword">if</span> !exists {
            <span class="hljs-keyword">return</span> myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Row does not exists after updating: reqID, PK"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Create</a>   :</p><br>
<ul>
<li> </li>
<li>  </li>
<li>rollback  commit </li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">CreateDept</span><span class="hljs-params">(ctx context.Context, in *model.Dept, out *model.Dept)</span> <span class="hljs-params">(myerr error)</span></span> {
    <span class="hljs-keyword">var</span> tx *mysql.Tx<font></font>
    reqID := myctx.FromContextRequestID(ctx) <span class="hljs-comment">// RequestID   context</span><font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> tx, myerr = s.db.Beginx(reqID); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> myerr = s.createDept(ctx, tx, in, out); myerr != <span class="hljs-literal">nil</span> {<font></font>
        _ = s.db.Rollback(reqID, tx)<font></font>
        <span class="hljs-keyword">return</span> myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">return</span> s.db.Commit(reqID, tx)<font></font>
}</code></pre><br>
<h4 id="423-shablon-update-metodov">4.2.3  Update </h4><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Update</a>   :</p><br>
<ul>
<li>     <strong>oldDept</strong>  <strong>newDept</strong>,           .</li>
<li>         PK.<br>
<ul>
<li>    —  .     .</li>
</ul></li>
<li>          <br>
<ul>
<li>,         .        ,     .</li>
<li>   UK,           UK.</li>
</ul></li>
<li>   <br>
<ul>
<li>     .   ,  SQL        1 .</li>
<li>     API, ,   /  ,   ,       P <strong>Get(reqID, tx, "GetDept", newDept, in.Deptno)</strong>.</li>
</ul></li>
<li>  <br>
<ul>
<li>    ,     FK       <strong>updateEmp(ctx, tx, inEmp, nil)</strong>.</li>
<li>   ,   </li>
</ul></li>
<li>  —          PK</li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">updateDept</span><span class="hljs-params">(ctx context.Context, tx *mysql.Tx, in *model.Dept, out *model.Dept)</span> <span class="hljs-params">(exists <span class="hljs-keyword">bool</span>, myerr error)</span></span> {<font></font>
<font></font>
    oldDept := model.GetDept()         <span class="hljs-comment">//   pool      </span>
    <span class="hljs-keyword">defer</span> model.PutDept(oldDept, <span class="hljs-literal">true</span>) <span class="hljs-comment">//    pool</span><font></font>
<font></font>
    newDept := model.GetDept()         <span class="hljs-comment">//   pool      </span>
    <span class="hljs-keyword">defer</span> model.PutDept(newDept, <span class="hljs-literal">true</span>) <span class="hljs-comment">//    pool</span><font></font>
<font></font>
    { <span class="hljs-comment">//         </span>
        oldDept.Deptno = in.Deptno <span class="hljs-comment">//    PK</span>
        <span class="hljs-keyword">if</span> exists, myerr = s.getDept(ctx, tx, oldDept); myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> !exists {<font></font>
            mylog.PrintfDebugMsg(<span class="hljs-string">"Row does not exists: reqID, PK"</span>, reqID, in.Deptno)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><font></font>
        }<font></font>
    } <span class="hljs-comment">//         </span><font></font>
<font></font>
    { <span class="hljs-comment">//   /        </span>
        <span class="hljs-comment">//   UK</span>
        <span class="hljs-comment">//  Dept PK  UK  -     </span>
        <span class="hljs-keyword">if</span> oldDept.Deptno != in.Deptno {
            <span class="hljs-keyword">var</span> foo <span class="hljs-keyword">int</span>
            exists, myerr := s.db.Get(reqID, tx, <span class="hljs-string">"DeptExists"</span>, &amp;foo, in.Deptno)
            <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> exists {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Error update - row with UK already exists: reqID, Deptno"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
            }<font></font>
        }<font></font>
    } <span class="hljs-comment">//   /        </span><font></font>
<font></font>
    { <span class="hljs-comment">//  </span>
        rows, myerr := s.db.Exec(reqID, tx, <span class="hljs-string">"UpdateDept"</span>, in)
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
        }<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span> rows != <span class="hljs-number">1</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Error update: reqID, Deptno, rows"</span>, reqID, in.Deptno, rows).PrintfInfo()<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//   -     PK</span>
        exists, myerr := s.db.Get(reqID, tx, <span class="hljs-string">"GetDept"</span>, newDept, in.Deptno)
        <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> !exists {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Row does not exists after creating: reqID, PK"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
        }<font></font>
    } <span class="hljs-comment">//  </span><font></font>
<font></font>
    { <span class="hljs-comment">//       </span>
        <span class="hljs-keyword">if</span> in.Emps != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">for</span> _, inEmp := <span class="hljs-keyword">range</span> in.Emps {
                <span class="hljs-comment">//   PK     </span>
                inEmp.Deptno = null.Int{sql.NullInt64{<span class="hljs-keyword">int64</span>(in.Deptno), <span class="hljs-literal">true</span>}}<font></font>
<font></font>
                <span class="hljs-comment">//   </span>
                <span class="hljs-keyword">if</span> exists, myerr = s.updateEmp(ctx, tx, inEmp, <span class="hljs-literal">nil</span>); myerr != <span class="hljs-literal">nil</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
                }<font></font>
                <span class="hljs-comment">//        -   </span>
                <span class="hljs-keyword">if</span> !exists {
                    <span class="hljs-keyword">if</span> myerr = s.createEmp(ctx, tx, inEmp, <span class="hljs-literal">nil</span>); myerr != <span class="hljs-literal">nil</span> {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    } <span class="hljs-comment">//       </span><font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> out != <span class="hljs-literal">nil</span> {<font></font>
        out.Deptno = in.Deptno <span class="hljs-comment">//    PK</span>
        <span class="hljs-keyword">if</span> exists, myerr = s.getDept(ctx, tx, out); myerr != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
        }<font></font>
        <span class="hljs-comment">//     API</span>
        <span class="hljs-keyword">if</span> !exists {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerror.New(<span class="hljs-string">"4004"</span>, <span class="hljs-string">"Row does not exists after updating: reqID, PK"</span>, reqID, in.Deptno).PrintfInfo()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">Update</a>   :</p><br>
<ul>
<li> </li>
<li>  </li>
<li>rollback  commit </li>
<li>     ,  <strong>exists = false</strong></li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">UpdateDept</span><span class="hljs-params">(ctx context.Context, in *model.Dept, out *model.Dept)</span> <span class="hljs-params">(exists <span class="hljs-keyword">bool</span>, myerr error)</span></span> {
    <span class="hljs-keyword">var</span> tx *mysql.Tx<font></font>
    reqID := myctx.FromContextRequestID(ctx) <span class="hljs-comment">// RequestID   context</span><font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> tx, myerr = s.db.Beginx(reqID); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> exists, myerr = s.updateDept(ctx, tx, in, out); myerr != <span class="hljs-literal">nil</span> {<font></font>
        _ = s.db.Rollback(reqID, tx)<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//            ,  </span>
    <span class="hljs-keyword">if</span> !exists {<font></font>
        _ = s.db.Rollback(reqID, tx)<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">if</span> myerr = s.db.Commit(reqID, tx); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, myerr<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> exists, <span class="hljs-literal">nil</span>
}</code></pre><br>
<h3 id="43-keshirovanie-dannyh-v-pamyati">4.3    </h3><br>
<p>     ,                     .</p><br>
<p>               .  ,     backend ,     .     /  ,     .</p><br>
<p> 3           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">dgraph-io/ristretto</a>.       PostgreSQL   listen/notify.</p><br>
<h2 id="5-sloy-json">5.  <strong>JSON</strong></h2><br>
<p> <strong>JSON</strong>    :</p><br>
<ul>
<li>     </li>
<li>Marshal / Unmarshal JSON</li>
<li> JSON</li>
</ul><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">JSON</a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">  </a>.         -  (  ). </p><br>
<p>   JSON    HTTP.      ,   .        []byte,   JSON.</p><br>
<h3 id="51-marshal-json">5.1. Marshal JSON</h3><br>
<p> encode  JSON    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">github.com/mailru/easyjson</a>     .</p><br>
<p>,   encode  JSON   Dept:</p><br>
<ul>
<li>       <strong>HTTP</strong>     <strong>JSON</strong>   <strong>buf []byte</strong></li>
<li>     ,   <strong>w.Buffer.BuildBytes(buf)</strong>  ,     </li>
<li>          <strong>HTTP</strong> </li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deptMarshal</span><span class="hljs-params">(reqID <span class="hljs-keyword">uint64</span>, v *model.Dept, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(outBuf []<span class="hljs-keyword">byte</span>, myerr error)</span></span> {<font></font>
    w := jwriter.Writer{} <span class="hljs-comment">//  EasyJSON Writer</span>
    v.MarshalEasyJSON(&amp;w) <span class="hljs-comment">//  JSON    EasyJSON Writer</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span> w.Error != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, myerror.WithCause(<span class="hljs-string">"6001"</span>, <span class="hljs-string">"Error Marshal: reqID"</span>, w.Error, reqID).PrintfInfo(<span class="hljs-number">1</span>)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//     EasyJSON Writer   </span>
    <span class="hljs-keyword">return</span> w.Buffer.BuildBytes(buf), <span class="hljs-literal">nil</span>
    }</code></pre><br>
<h3 id="52-unmarshal-json">5.2. Unmarshal JSON</h3><br>
<p>Decode  JSON  :</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">if</span> err := vIn.UnmarshalJSON(inBuf); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>, myerror.WithCause(<span class="hljs-string">"6001"</span>, <span class="hljs-string">"Error Unmarshal: reqID, buf"</span>, err, reqID, <span class="hljs-keyword">string</span>(inBuf)).PrintfInfo()<font></font>
}</code></pre><br>
<p>   .     <strong>mailru/easyjson</strong>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow">decode</a>  ,        .    <strong>make</strong>  <strong>new</strong>,   ""       .<br>
:</p><br>
<ul>
<li> <strong>out.Emps = make([]*Emp, 0, 8)</strong>  <strong>out.Emps = []*Emp(GetEmpSlice())</strong></li>
<li> <strong>v1 = new(Emp)</strong>  <strong>v1 = GetEmp()</strong></li>
</ul><br>
<h3 id="53-rabota-s-interfeysnymi-metodami-modeli-dannyh">5.3.      </h3><br>
<h4 id="531-scenariy-get">5.3.1.  Get</h4><br>
<p> Get  :</p><br>
<ul>
<li> : <strong>id</strong> —  PK,   , <strong>buf</strong> —      JSON</li>
<li> : <strong>outBuf</strong>    JSON (    <strong>buf</strong>)</li>
<li> <strong>JSON</strong>       .     <strong>vOut := model.GetDept()</strong> ( Dept —  ,  Emp —  )       <strong>defer model.PutDept(vOut, true)</strong>.           .</li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">GetDept</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">int</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(outBuf []<span class="hljs-keyword">byte</span>, myerr error)</span></span> {<font></font>
<font></font>
    vOut := model.GetDept()         <span class="hljs-comment">//   pool  </span>
    <span class="hljs-keyword">defer</span> model.PutDept(vOut, <span class="hljs-literal">true</span>) <span class="hljs-comment">//   pool     </span><font></font>
<font></font>
    vOut.Deptno = id                <span class="hljs-comment">// PK     </span><font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    exists, myerr := s.deptService.GetDept(ctx, vOut)<font></font>
    <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  json</span>
    <span class="hljs-keyword">if</span> exists {
        <span class="hljs-keyword">return</span> deptMarshal(reqID, vOut, buf)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">//    - ,    </span>
}</code></pre><br>
<h4 id="532-scenariy-create">5.3.2.  Create</h4><br>
<p> Create  :</p><br>
<ul>
<li>    <strong>inBuf</strong> —    JSON</li>
<li>    <strong>id</strong> —  PK  </li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">CreateDept</span><span class="hljs-params">(ctx context.Context, inBuf []<span class="hljs-keyword">byte</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(id <span class="hljs-keyword">int</span>, outBuf []<span class="hljs-keyword">byte</span>, myerr error)</span></span> {<font></font>
<font></font>
    vIn := model.GetDept()         <span class="hljs-comment">//   pool  </span>
    <span class="hljs-keyword">defer</span> model.PutDept(vIn, <span class="hljs-literal">true</span>) <span class="hljs-comment">//   pool </span><font></font>
<font></font>
    vOut := model.GetDept()         <span class="hljs-comment">//   pool  </span>
    <span class="hljs-keyword">defer</span> model.PutDept(vOut, <span class="hljs-literal">true</span>) <span class="hljs-comment">//   pool </span><font></font>
<font></font>
    <span class="hljs-comment">//  JSON  </span>
    <span class="hljs-keyword">if</span> err := vIn.UnmarshalJSON(inBuf); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>, myerror.WithCause(<span class="hljs-string">"6001"</span>, <span class="hljs-string">"Error Unmarshal: reqID, buf"</span>, err, reqID, <span class="hljs-keyword">string</span>(inBuf)).PrintfInfo()<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> myerr = s.deptService.CreateDept(ctx, vIn, vOut); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  json</span>
    <span class="hljs-keyword">if</span> outBuf, myerr = deptMarshal(reqID, vOut, buf); myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> vOut.Deptno, outBuf, myerr<font></font>
}</code></pre><br>
<h4 id="533-scenariy-update">5.3.3.  Update</h4><br>
<p> Update:</p><br>
<ul>
<li>    <strong>id</strong> —  PK  .</li>
<li> <strong>outBuf</strong>   NO_DATA_FOUND</li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">UpdateDept</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">int</span>, inBuf []<span class="hljs-keyword">byte</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(outBuf []<span class="hljs-keyword">byte</span>, myerr error)</span></span> {<font></font>
<font></font>
    vIn := model.GetDept()         <span class="hljs-comment">//   pool  </span>
    <span class="hljs-keyword">defer</span> model.PutDept(vIn, <span class="hljs-literal">true</span>) <span class="hljs-comment">//   pool </span><font></font>
<font></font>
    vOut := model.GetDept()         <span class="hljs-comment">//   pool  </span>
    <span class="hljs-keyword">defer</span> model.PutDept(vOut, <span class="hljs-literal">true</span>) <span class="hljs-comment">//   pool </span><font></font>
<font></font>
    <span class="hljs-comment">//  JSON  </span>
    <span class="hljs-keyword">if</span> err := vIn.UnmarshalJSON(inBuf); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, myerror.WithCause(<span class="hljs-string">"6001"</span>, <span class="hljs-string">"Error Unmarshal: reqID, buf"</span>, err, reqID, <span class="hljs-keyword">string</span>(inBuf)).PrintfInfo()<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ID </span>
    <span class="hljs-keyword">if</span> id != vIn.Deptno {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, myerror.New(<span class="hljs-string">"6001"</span>, <span class="hljs-string">"Resource ID does not corespond to JSON: resource.id, json.Deptno"</span>, id, vIn.Deptno).PrintfInfo()<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    exists, myerr := s.deptService.UpdateDept(ctx, vIn, vOut)<font></font>
    <span class="hljs-keyword">if</span> myerr != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, myerr<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  json</span>
    <span class="hljs-keyword">if</span> exists {
        <span class="hljs-keyword">return</span> deptMarshal(reqID, vOut, buf)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">//    - ,    </span>
}</code></pre><br>
<h3 id="54-keshirovanie-json">5.4.  JSON</h3><br>
<p>     :</p><br>
<ul>
<li>   </li>
<li>    encode  JSON</li>
<li>     .</li>
</ul><br>
<p> 3      JSON  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">go.etcd.io/bbolt</a>.         PostgreSQL   listen/notify.</p><br>
<h2 id="6-sloy-http">6.  HTTP</h2><br>
<p> <strong>HTTP</strong>    :</p><br>
<ul>
<li>  HTTP </li>
<li>   HTTP </li>
<li>  (basic, MS AD, ...)</li>
<li>  token ( )</li>
<li>  (body)  </li>
<li>  (header)  </li>
<li>    </li>
<li>      </li>
<li> HSTS Strict-Transport-Security</li>
<li> Content-Type    (response)</li>
<li>  HTTP </li>
<li>  (header)  </li>
<li>   </li>
<li>   </li>
<li> defer recovery    panic</li>
</ul><br>
<p>     .     HTTP       <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  HTTP   Golang</a></strong>.</p><br>
<p>,    ,  :</p><br>
<ul>
<li>     defer     .  UML  —    RecoverWrap.func1,   .</li>
<li>         <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/blob/master/httpserver/httpservice/" rel="nofollow">process</a></strong>.      HTTP handler.  UML  <strong>process</strong> —   .</li>
<li>              HTTP handler.  UML    EchoHandler.func1 —   .</li>
</ul><br>
<p>      .       <strong>process</strong>,         REST API.</p><br>
<p>              (   ).</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/6dc/24a/733/6dc24a733891dc197d74603f4a04bb9b.png" alt="http_handler"></p><br>
<h3 id="61-rabota-s-bufernym-pulom">6.1.    </h3><br>
<p>  JSON, <strong>[]byte</strong>   <strong>http.ResponseWriter</strong>  .       GC.        GC   .</p><br>
<ul>
<li>    JSON   <strong>http.ResponseWriter</strong></li>
<li>      JSON    <strong>http.ResponseWriter</strong></li>
</ul><br>
<p>    .</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"> </a>    ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">sync.Pool</a>:</p><br>
<ul>
<li>  </li>
<li>   </li>
<li>   </li>
</ul><br>
<p>       :</p><br>
<pre><code class="go hljs">[HTTP_POOL]<font></font>
UseBufPool = <span class="hljs-literal">true</span>           <span class="hljs-comment">//    </span>
BufPooledSize = <span class="hljs-number">512</span>         <span class="hljs-comment">//   ,       </span>
BufPooledMaxSize = <span class="hljs-number">32768</span>    <span class="hljs-comment">//      </span></code></pre><br>
<p>       <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/blob/master/httpserver/httpservice/" rel="nofollow">process</a></strong>    .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">var</span> buf []<span class="hljs-keyword">byte</span>
<span class="hljs-keyword">if</span> s.cfg.UseBufPool &amp;&amp; s.bytesPool != <span class="hljs-literal">nil</span> {<font></font>
    buf = s.bytesPool.GetBuf()<font></font>
}</code></pre><br>
<p>     ,     ,   encode  JSON    .<br>
  ,    JSON      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/blob/master/httpserver/httpservice/" rel="nofollow">   </a>.<br>
     <strong>[]byte</strong>  .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">if</span> responseBuf != <span class="hljs-literal">nil</span> &amp;&amp; s.cfg.UseBufPool &amp;&amp; s.bytesPool != <span class="hljs-literal">nil</span> {
    <span class="hljs-comment">//          pool</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span>(responseBuf) &gt;= s.cfg.BufPooledSize &amp;&amp; <span class="hljs-built_in">cap</span>(responseBuf) &lt;= s.cfg.BufPooledMaxSize {
        <span class="hljs-keyword">defer</span> s.bytesPool.PutBuf(responseBuf)<font></font>
    }<font></font>
}</code></pre><br>
<p>           ,   .  <strong>Pointer()</strong>       <strong>[]byte</strong>.</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">if</span> reflect.ValueOf(buf).Pointer() != reflect.ValueOf(responseBuf).Pointer() {
    <span class="hljs-comment">// ...</span>
}</code></pre><br>
<h3 id="62-obrabotchik-get">6.2.  GET</h3><br>
<p>       <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/blob/master/httpserver/httpservice/" rel="nofollow">process</a></strong>,      :</p><br>
<ul>
<li>  URL  ID   —     PK </li>
<li>   JSON    <strong>jsonService.GetDept(ctx, id, buf)</strong>,    <strong>buf</strong>       .</li>
<li>  .     ,        <strong>header["RequestID"]</strong></li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">GetDeptHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-comment">//   process,   </span>
    _ = s.process(<span class="hljs-string">"GET"</span>, w, r, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, requestBuf []<span class="hljs-keyword">byte</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, Header, <span class="hljs-keyword">int</span>, error)</span></span> {<font></font>
        reqID := myctx.FromContextRequestID(ctx) <span class="hljs-comment">// RequestID   context</span><font></font>
<font></font>
        <span class="hljs-comment">//  PK  URL     </span><font></font>
        vars := mux.Vars(r)<font></font>
        idStr := vars[<span class="hljs-string">"id"</span>]<font></font>
        id, err := strconv.Atoi(idStr)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusBadRequest, myerror.WithCause(<span class="hljs-string">"8001"</span>, <span class="hljs-string">"Failed to process parameter 'id' invalid number: reqID, id"</span>, err, reqID, idStr).PrintfInfo()<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  JSON ,     </span><font></font>
        responseBuf, err := s.jsonService.GetDept(ctx, id, buf)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusInternalServerError, err<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span> responseBuf == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusNotFound, <span class="hljs-literal">nil</span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  </span><font></font>
        header := Header{}<font></font>
        header[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/json; charset=utf-8"</span>
        header[<span class="hljs-string">"Errcode"</span>] = <span class="hljs-string">"0"</span>
        header[<span class="hljs-string">"RequestID"</span>] = fmt.Sprintf(<span class="hljs-string">"%v"</span>, reqID)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> responseBuf, header, http.StatusOK, <span class="hljs-literal">nil</span><font></font>
    })<font></font>
}</code></pre><br>
<h3 id="63-obrabotchik-post">6.3.  POST</h3><br>
<p>POST   :</p><br>
<ul>
<li>    ID   — PK </li>
</ul><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">CreateDeptHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-comment">//   process,   </span>
    _ = s.process(<span class="hljs-string">"POST"</span>, w, r, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, requestBuf []<span class="hljs-keyword">byte</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, Header, <span class="hljs-keyword">int</span>, error)</span></span> {<font></font>
        reqID := myctx.FromContextRequestID(ctx) <span class="hljs-comment">// RequestID   context</span><font></font>
<font></font>
        mylog.PrintfDebugMsg(<span class="hljs-string">"START: reqID"</span>, reqID)<font></font>
<font></font>
        <span class="hljs-comment">//  JSON </span><font></font>
        id, responseBuf, err := s.jsonService.CreateDept(ctx, requestBuf, buf)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusInternalServerError, err<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  </span><font></font>
        header := Header{}<font></font>
        header[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/json; charset=utf-8"</span>
        header[<span class="hljs-string">"Errcode"</span>] = <span class="hljs-string">"0"</span>
        header[<span class="hljs-string">"Id"</span>] = fmt.Sprintf(<span class="hljs-string">"%v"</span>, id)<font></font>
        header[<span class="hljs-string">"RequestID"</span>] = fmt.Sprintf(<span class="hljs-string">"%v"</span>, reqID)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> responseBuf, header, http.StatusOK, <span class="hljs-literal">nil</span><font></font>
    })<font></font>
    }</code></pre><br>
<h3 id="64-obrabotchik-put">6.4.  PUT</h3><br>
<p>PUT   :</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span> <span class="hljs-title">UpdateDeptHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-comment">//   process,   </span>
    _ = s.process(<span class="hljs-string">"PUT"</span>, w, r, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, requestBuf []<span class="hljs-keyword">byte</span>, buf []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, Header, <span class="hljs-keyword">int</span>, error)</span></span> {<font></font>
        reqID := myctx.FromContextRequestID(ctx) <span class="hljs-comment">// RequestID   context</span><font></font>
<font></font>
        mylog.PrintfDebugMsg(<span class="hljs-string">"START: reqID"</span>, reqID)<font></font>
<font></font>
        <span class="hljs-comment">//      </span><font></font>
        vars := mux.Vars(r)<font></font>
        idStr := vars[<span class="hljs-string">"id"</span>]<font></font>
        id, err := strconv.Atoi(idStr)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusBadRequest, myerror.WithCause(<span class="hljs-string">"8001"</span>, <span class="hljs-string">"Failed to process parameter 'id' invalid number: reqID, id"</span>, err, reqID, idStr).PrintfInfo()<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  JSON </span><font></font>
        responseBuf, err := s.jsonService.UpdateDept(ctx, id, requestBuf, buf)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusInternalServerError, err<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span> responseBuf == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, http.StatusNotFound, <span class="hljs-literal">nil</span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  </span><font></font>
        header := Header{}<font></font>
        header[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/json; charset=utf-8"</span>
        header[<span class="hljs-string">"Errcode"</span>] = <span class="hljs-string">"0"</span>
        header[<span class="hljs-string">"RequestID"</span>] = fmt.Sprintf(<span class="hljs-string">"%v"</span>, reqID)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> responseBuf, header, http.StatusOK, <span class="hljs-literal">nil</span><font></font>
    })<font></font>
}<font></font>
</code></pre><br>
<h3 id="65-registraciya-obrabotchikov">6.5.  </h3><br>
<p>    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/blob/master/httpserver/httpservice/" rel="nofollow">httpserver/httpservice</a>     <strong>Handlers</strong>.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// Handler represent HTTP handler</span>
<span class="hljs-keyword">type</span> Handler <span class="hljs-keyword">struct</span> {<font></font>
    Path        <span class="hljs-keyword">string</span>
    HundlerFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.ResponseWriter, *http.Request)</span></span>
    Method      <span class="hljs-keyword">string</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Handlers represent HTTP handlers map</span>
<span class="hljs-keyword">type</span> Handlers <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Handler</code></pre><br>
<p>      <strong>httpservice.New</strong>.       ,   <strong>service.recoverWrap()</strong>.</p><br>
<pre><code class="go hljs">service.Handlers = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Handler{
    <span class="hljs-comment">//  </span>
    <span class="hljs-string">"EchoHandler"</span>:         Handler{<span class="hljs-string">"/echo"</span>, service.recoverWrap(service.EchoHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"SinginHandler"</span>:       Handler{<span class="hljs-string">"/signin"</span>, service.recoverWrap(service.SinginHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"JWTRefreshHandler"</span>:   Handler{<span class="hljs-string">"/refresh"</span>, service.recoverWrap(service.JWTRefreshHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"HTTPLogHandler"</span>:      Handler{<span class="hljs-string">"/httplog"</span>, service.recoverWrap(service.HTTPLogHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"HTTPErrorLogHandler"</span>: Handler{<span class="hljs-string">"/httperrlog"</span>, service.recoverWrap(service.HTTPErrorLogHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"LogLevelHandler"</span>:     Handler{<span class="hljs-string">"/loglevel"</span>, service.recoverWrap(service.LogLevelHandler), <span class="hljs-string">"POST"</span>},<font></font>
<font></font>
    <span class="hljs-comment">// JSON </span>
    <span class="hljs-string">"CreateDeptHandler"</span>: Handler{<span class="hljs-string">"/depts"</span>, service.recoverWrap(service.CreateDeptHandler), <span class="hljs-string">"POST"</span>},
    <span class="hljs-string">"GetDeptHandler"</span>:    Handler{<span class="hljs-string">"/depts/{id:[0-9]+}"</span>, service.recoverWrap(service.GetDeptHandler), <span class="hljs-string">"GET"</span>},
    <span class="hljs-string">"UpdateDeptHandler"</span>: Handler{<span class="hljs-string">"/depts/{id:[0-9]+}"</span>, service.recoverWrap(service.UpdateDeptHandler), <span class="hljs-string">"PUT"</span>},<font></font>
}</code></pre><br>
<h2 id="7-testirovanie-proizvoditelnosti">7.  </h2><br>
<h3 id="71-testovyy-stend">7.1.  </h3><br>
<p>      Oracle  3-  :</p><br>
<ul>
<li> VM.DenseIO2.8 — 8 Core Intel (16 virtual core), 120 Memory (GB), Oracle Linux 7.7</li>
<li>  NVMe  — 6.4 TB NVMe SSD Storage (1 drives) min 250k IOPS (4k block)</li>
<li>    — 8.2 Network Bandwidth (Gbps)</li>
<li> — PostgreSQL 12.     .</li>
<li>   ApacheBench:<br>
<ul>
<li>concurrency level  4  16384</li>
<li> 10 000  1 000 000   .</li>
<li>    2  8  ApacheBench (  ApacheBench     1  )</li>
</ul></li>
</ul><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/5b9/840/4cb/5b98404cbbb595fc4a79e83d1c613ea3.png" alt="Prüfstand"></p><br>
<h3 id="72-rezultaty-testirovaniya-get-s-raznymi-vidami-keshirovaniya">7.2.   GET    </h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://raw.githubusercontent.com/romapres2010/" rel="nofollow"> JSON</a> — 1800 .    Dept  10   Emp.</li>
<li>  Dept — 33 000 000,  Emp — 330 000 000 .</li>
</ul><br>
<p>  :</p><br>
<ul>
<li>GET       PostgreSQL</li>
<li>GET   JSON  BBolt ( 74 )</li>
<li>GET     ( map)</li>
</ul><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/httpserver/tree/master/cmd/" rel="nofollow"></a>.<br>
      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/romapres2010/" rel="nofollow"></a></p><br>
<p>  Requests per second  Concurrency.</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/c19/9a3/571/c199a35717d719c1f3bbd729cc4583d4.png" alt="get_db_memory_json1"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeit pro Anforderungsabhängigkeitsgraph. </font><font style="vertical-align: inherit;">[ms] aus Parallelität (logarithmische Skala).</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/d51/593/d22/d51593d225698827addeb4df4bc732a6.png" alt="get_db_memory_json1"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafik von 99% Perzentil [ms] gegen Parallelität.</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/788/791/d6b/788791d6bfee4cea28ff0a3c78a3b780.png" alt="get_db_memory_json1"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafik von 99% Perzentil [ms] gegen Parallelität (logarithmische Skala).</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/e0e/11a/3c5/e0e11a3c57b5492f102156574f4b94ca.png" alt="get_db_memory_json1"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So sieht das Laden des Backend-Servers mit 100.000 [# / Sek.] Und das Zwischenspeichern von Daten in BBolt (Concurrency 128) aus. </font><font style="vertical-align: inherit;">Die durchschnittliche E / A-Latenz auf einem NVMe-Laufwerk beträgt 0,02 [ms] (500.000 IOPS).</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/54e/48b/9fd/54e48b9fd96200a80277701a80207e9a.png" alt="get_db_memory_json1"></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500528/index.html">Über die Übersetzung von "Praxis" / "Praktikabilität" ohne Praxis / Praxis</a></li>
<li><a href="../de500530/index.html">Canvas API Memo</a></li>
<li><a href="../de500542/index.html">Hack Age of Empires III, um die Einstellungen für die Shader-Qualität zu ändern</a></li>
<li><a href="../de500546/index.html">Erstellen Sie mit dem ODF Toolkit ein einfaches Tabellendokument</a></li>
<li><a href="../de500552/index.html">So beschleunigen Sie die Codeüberprüfung</a></li>
<li><a href="../de500556/index.html">Zwei Jahre digitale Transformation in zwei Monaten</a></li>
<li><a href="../de500558/index.html">Eine Auswahl von Artikeln zum maschinellen Lernen: Fallstudien, Leitfäden und Forschungsergebnisse für April 2020</a></li>
<li><a href="../de500562/index.html">Form Designmuster. Buchrezension</a></li>
<li><a href="../de500564/index.html">Offline-Transaktionen im öffentlichen Verkehr - Sicherheit und Betrugsbekämpfung</a></li>
<li><a href="../de500568/index.html">Einfache Weltraumsimulation mit Python und Box2D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>