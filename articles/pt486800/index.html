<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😅 🙌🏾 🕌 Cassandra. Como não morrer se você conhece apenas Oracle 🤹🏼 🙌🏿 🚴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá, Habr. 
 
 Meu nome é Misha Butrimov, gostaria de falar um pouco sobre Cassandra. Minha história será útil para quem nunca encontrou bancos de dad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cassandra. Como não morrer se você conhece apenas Oracle</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/486800/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olá, Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu nome é Misha Butrimov, gostaria de falar um pouco sobre Cassandra. Minha história será útil para quem nunca encontrou bancos de dados NoSQL - ela possui muitos recursos e armadilhas de implementação que você precisa conhecer. E se, além da Oracle ou de qualquer outra base relacional, você não tiver visto nada, essas coisas salvarão sua vida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que há de bom em Cassandra? Este é um banco de dados NoSQL projetado sem um único ponto de falha, que escala bem. Se você precisar adicionar alguns terabytes para qualquer base, basta adicionar nós ao anel. Estendê-lo para outro data center? Adicione nós ao cluster. Aumentar RPS processado? Adicione nós ao cluster. A outra maneira também funciona.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/4s/4m/jn/4s4mjnltsraqofl5-ey4g2fi9t0.png" width="700"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No que mais ela é boa? </font><font style="vertical-align: inherit;">É para lidar com muitos pedidos. </font><font style="vertical-align: inherit;">Mas quanto é quanto? </font><font style="vertical-align: inherit;">10, 20, 30, 40 mil solicitações por segundo - isso não é muito. </font><font style="vertical-align: inherit;">100 mil solicitações por segundo para gravação também. </font><font style="vertical-align: inherit;">Há empresas que disseram ter 2 milhões de solicitações por segundo. </font><font style="vertical-align: inherit;">Aqui eles provavelmente têm que acreditar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, em princípio, Cassandra tem uma grande diferença em relação aos dados relacionais - eles não se parecem com eles. </font><font style="vertical-align: inherit;">E isso é muito importante para lembrar.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nem tudo o que parece igual funciona da mesma maneira</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certa vez, um colega me procurou e perguntou: “Aqui está a linguagem de consulta do CQL Cassandra, e ela tem uma instrução select, ela tem onde, tem e. Eu escrevo cartas e não funciona. Por quê?". Se você tratar Cassandra como um banco de dados relacional, essa é a maneira ideal de terminar sua vida com um suicídio brutal. E eu não advogo, é proibido na Rússia. Você está apenas projetando algo errado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, um cliente chega até nós e diz: “Vamos criar um banco de dados para programas de TV ou um banco de dados para um diretório de receitas. Teremos pratos de comida lá ou uma lista de séries e atores. Dizemos alegremente: "Vamos lá!". Estes são dois bytes para enviar, algumas placas e tudo está pronto, tudo funcionará muito rapidamente, de forma confiável. E está tudo bem até os clientes chegarem e dizerem que as donas de casa também estão resolvendo o problema inverso: elas têm uma lista de produtos e querem saber qual prato querem cozinhar. Você está morto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso ocorre porque o Cassandra é um banco de dados híbrido: é um valor-chave e armazena dados em colunas amplas. Falando em Java ou Kotlin, poderia ser descrito assim:</font></font><br>
<br>
<code>Map&lt;RowKey, SortedMap&lt;ColumnKey, ColumnValue&gt;&gt;</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, um mapa, dentro do qual também há um mapa classificado. A primeira chave desse mapa é a chave de linha ou a chave de partição - a chave de partição. A segunda chave, que é a chave do mapa já classificado, é a chave de cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ilustrar a distribuição do banco de dados, desenhamos três nós. Agora você precisa entender como decompor dados em nós. Porque se colocarmos tudo em um (a propósito, pode haver mil, dois mil, cinco - quantos você quiser), isso não é realmente sobre distribuição. Portanto, precisamos de uma função matemática que retorne um número. Apenas um número, um int longo que cairá em algum intervalo. E nós temos um nó que será responsável por um intervalo, o segundo - pelo segundo, n-ésimo - pelo n-ésimo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/xn/mn/vlxnmnvvigtwc_ho-wkjqy5r60e.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse número é obtido usando uma função hash que se aplica exatamente ao que chamamos de chave Partition. </font><font style="vertical-align: inherit;">Essa é a coluna especificada na diretiva Chave Primária e esta é a coluna que será a primeira e a mais básica chave do mapa. </font><font style="vertical-align: inherit;">Determina qual nó obtém quais dados. </font><font style="vertical-align: inherit;">Uma tabela é criada no Cassandra com quase a mesma sintaxe que no SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (<font></font>
	user_id uu <span class="hljs-keyword">id</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>(user_id)<font></font>
<font></font>
)<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chave primária nesse caso consiste em uma coluna e também é uma chave de partição. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como os usuários cairão conosco? </font><font style="vertical-align: inherit;">Parte cairá em uma nota, parte em outra e parte em uma terceira. </font><font style="vertical-align: inherit;">Acontece uma tabela de hash comum, também é um mapa, também é um dicionário em Python, é também uma estrutura simples de valor de chave, na qual podemos ler todos os valores, ler e escrever por chave.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vp/3_/xa/vp3_xa1bupu1wawi77ytwk0pike.png" width="900"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecione: quando permitir que a filtragem se transforme em varredura completa ou como não fazer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos escrever alguma declaração O Select: </font></font><code>select * from users where, userid = </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Parece que, como no Oracle: escrevemos select, especificamos condições e tudo funciona, os usuários conseguem. Mas se você selecionar, por exemplo, um usuário com um determinado ano de nascimento, Cassandra jura que não pode atender à solicitação. Como ela não sabe nada sobre como distribuímos dados sobre o ano de nascimento - ela tem apenas uma coluna especificada como chave. Então ela diz: “Ok, ainda posso atender a essa solicitação. Adicione permitir filtragem ". Nós adicionamos uma diretiva, tudo funciona. E nesse momento uma coisa terrível acontece.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando dirigimos dados de teste, tudo está bem. E quando você atende à solicitação de produção, onde, por exemplo, temos 4 milhões de registros, tudo não está muito bem conosco. Como permitir filtragem é uma diretiva que permite ao Cassandra coletar todos os dados desta tabela de todos os nós, todos os datacenters (se houver muitos deles nesse cluster) e somente filtrá-los. Este é um análogo do Full Scan, e quase ninguém se deleita com isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se apenas precisássemos de usuários por identificadores, isso nos conviria. Mas, às vezes, precisamos escrever outras consultas e impor outras restrições à seleção. Portanto, lembramos: todos temos um mapa, que possui uma chave de partição, mas dentro dele há um mapa classificado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ela também tem uma chave, que chamamos de chave de cluster. Essa chave, que, por sua vez, consiste nas colunas que selecionamos, com as quais Cassandra entende como seus dados são classificados fisicamente e estarão em cada nó. Ou seja, para algumas chaves de Partição, a chave de Clustering informará exatamente como inserir os dados nessa árvore, em que lugar eles ocuparão lá. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta é realmente uma árvore, um comparador é simplesmente chamado ali, para o qual passamos um certo conjunto de colunas na forma de um objeto, e também é definido na forma de uma listagem de colunas.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_by_year_salary_id (<font></font>
	user_id <span class="hljs-keyword">uuid</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>((<span class="hljs-keyword">year</span>), salary, user_id)
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preste atenção à diretiva de chave primária, pois o primeiro argumento (no nosso caso, o ano) é sempre a chave de partição. </font><font style="vertical-align: inherit;">Pode consistir em uma ou várias colunas, não importa. </font><font style="vertical-align: inherit;">Se houver várias colunas, será necessário removê-lo novamente entre parênteses, para que o pré-processador do idioma entenda que essa é a chave Primária e, por trás dela, todas as outras colunas - a chave de Cluster. </font><font style="vertical-align: inherit;">Nesse caso, eles serão transmitidos no comparador na ordem em que vão. </font><font style="vertical-align: inherit;">Ou seja, a primeira coluna é mais significativa, a segunda é menos significativa e assim por diante. </font><font style="vertical-align: inherit;">À medida que escrevemos para classes de dados, por exemplo, é igual a campos: listamos campos e, para eles, escrevemos quais são maiores e quais são menores. </font><font style="vertical-align: inherit;">Em Cassandra, esse é, relativamente falando, o campo da classe de dados ao qual os iguais escritos para ele serão aplicados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definimos o tipo, impomos restrições</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deve-se lembrar que a ordem de classificação (decrescente, crescente, não importa) é definida ao mesmo tempo em que a chave é criada e não é possível alterá-la posteriormente. Ele determina fisicamente como os dados serão classificados e como eles estarão. Se você precisar alterar a chave de cluster ou a ordem de classificação, será necessário criar uma nova tabela e inserir dados nela. Com o existente, isso não funcionará. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qh/qt/kgqhqtjece2c4irbhyll0mxsl10.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enchemos nossa mesa com usuários e vimos que eles entraram em contato, primeiro por ano de nascimento e depois em cada nó por salário e por ID do usuário. Agora podemos selecionar, impondo restrições. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso trabalho aparece novamente</font></font><code>where, and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e os usuários chegam até nós e tudo está bem novamente. </font><font style="vertical-align: inherit;">Mas se tentarmos usar apenas a parte chave de cluster, a menos significativa, Cassandra jurará imediatamente que não podemos encontrar em nosso mapa onde esse objeto tem esses campos para o comparador nulo, mas este que acabou de ser definido - onde está. </font><font style="vertical-align: inherit;">Vou ter que pegar todos os dados desse nó novamente e filtrá-lo. </font><font style="vertical-align: inherit;">E este é um análogo do Full Scan dentro do nó, isso é ruim.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em qualquer situação incompreensível, crie uma nova tabela</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se quisermos obter usuários por ID, idade ou salário, o que devemos fazer? Nada. Apenas use duas tabelas. Se você precisar obter usuários de três maneiras diferentes - haverá três tabelas. Longe vão os dias em que economizamos espaço no parafuso. Este é o recurso mais barato. Custa muito menos que o tempo de resposta, o que pode ser fatal para o usuário. O usuário é muito mais agradável para conseguir algo em um segundo do que em 10 minutos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trocamos espaço excessivo, dados desnormalizados pela capacidade de escalar bem e trabalhar de forma confiável. De fato, na realidade, um cluster que consiste em três datacenters, cada um com cinco nós, com um nível aceitável de armazenamento de dados (quando nada é perdido com certeza), é capaz de sobreviver completamente à morte de um datacenter. E mais dois nós em cada um dos dois restantes. E somente depois disso os problemas começam. Essa é uma redundância bastante boa, pois custa algumas unidades e processadores ssd desnecessários. Portanto, para usar o Cassandra, que nunca é SQL, no qual não há relacionamentos, nem chaves estrangeiras, você precisa conhecer regras simples.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós projetamos tudo, desde uma solicitação. O principal não são os dados, mas como o aplicativo vai trabalhar com eles. Se ele precisar receber dados diferentes de maneiras diferentes ou os mesmos dados de maneiras diferentes, devemos colocá-los da maneira que for conveniente para a aplicação. Caso contrário, falharemos no Full Scan e o Cassandra não nos dará nenhuma vantagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desnormalizar dados é a norma. Esqueça os formulários normais, não temos mais bancos de dados relacionais. Colocamos algo 100 vezes, ele mentirá 100 vezes. É mais barato do que pará-lo de qualquer maneira.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selecionamos as chaves para particionar para que elas sejam distribuídas normalmente. </font><font style="vertical-align: inherit;">Não precisamos que o hash de nossas chaves caia em um intervalo estreito. </font><font style="vertical-align: inherit;">Ou seja, o ano de nascimento no exemplo acima é um mau exemplo. </font><font style="vertical-align: inherit;">Em vez disso, é bom que nossos usuários sejam normalmente distribuídos por ano de nascimento e ruim se estivermos falando de alunos da 5ª série - não será muito bom particionar lá. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classificação é selecionada uma vez durante a criação da chave de cluster. </font><font style="vertical-align: inherit;">Se você precisar alterá-lo, precisará preencher demais a nossa tabela com uma chave diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o mais importante: se precisarmos coletar os mesmos dados de 100 maneiras diferentes, teremos 100 tabelas diferentes.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486788/index.html">Webinar “Monitoramento remoto e diagnóstico de equipamentos. Estudos de caso da solução CNC da Winnum »</a></li>
<li><a href="../pt486790/index.html">E, novamente, Qbot - uma nova linhagem de cavalos de Troia bancários</a></li>
<li><a href="../pt486792/index.html">O caminho do robô para o satélite gelado de outro planeta começa nas profundezas da Antártica</a></li>
<li><a href="../pt486794/index.html">Os processos dos neurônios humanos mostraram capacidade inesperada de calcular</a></li>
<li><a href="../pt486798/index.html">Existe um GameDev em Sakhalin? Fim</a></li>
<li><a href="../pt486802/index.html">As pessoas conhecem os sistemas de recomendação. Fatoração</a></li>
<li><a href="../pt486804/index.html">Informática em Saúde Global: Tecnologias em Nuvem</a></li>
<li><a href="../pt486808/index.html">Teste de gravidez eletrônico em uma farmácia: como funciona</a></li>
<li><a href="../pt486810/index.html">Novo frontend do Odnoklassniki: iniciando o React em Java. parte II</a></li>
<li><a href="../pt486814/index.html">Zabbix: a topologia de rede é clara e automática</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>