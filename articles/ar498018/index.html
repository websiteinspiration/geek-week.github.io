<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏴‍☠️ 👩🏼‍⚕️ 🤙🏽 التحليلات التشغيلية في بنية الخدمات الصغيرة: مساعدة واقتراح Postgres FDW 🚃 🤳🏿 🚤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="لهندسة الخدمات الصغيرة ، مثل كل شيء في هذا العالم ، إيجابياتها وسلبياتها. تصبح بعض العمليات معه أسهل ، والبعض الآخر أكثر تعقيدًا. ومن أجل سرعة التغيير...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>التحليلات التشغيلية في بنية الخدمات الصغيرة: مساعدة واقتراح Postgres FDW</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لهندسة الخدمات الصغيرة ، مثل كل شيء في هذا العالم ، إيجابياتها وسلبياتها. تصبح بعض العمليات معه أسهل ، والبعض الآخر أكثر تعقيدًا. ومن أجل سرعة التغيير وتحسين قابلية التوسع ، يجب تقديم التضحيات. واحد منهم هو تعقيد التحليلات. إذا كان بالإمكان اختزال جميع التحليلات التشغيلية في مجموعة متجانسة إلى استعلامات SQL لنسخة متماثلة تحليلية ، فإن لكل خدمة في بنية متعددة الخدمات قاعدتها الخاصة ويبدو أنه لا يمكن الاستغناء عن استعلام واحد (أو يمكن الاستغناء عنه؟). بالنسبة لأولئك المهتمين بكيفية حل مشكلة التحليلات التشغيلية في شركتنا وكيف تعلمنا التعايش مع هذا الحل - مرحبًا.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
اسمي بافيل سيفاش ، في DomKlik أعمل في فريق مسؤول عن الحفاظ على مستودع البيانات التحليلية. تقليديا ، يمكن أن تعزى أنشطتنا إلى تاريخ الهندسة ، ولكن في الواقع ، فإن نطاق المهام أوسع بكثير. هناك معيار ETL / ELT لهندسة التواريخ ، ودعم وتكييف أدوات تحليل البيانات وتطوير أدواتهم الخاصة. على وجه الخصوص ، بالنسبة للتقارير التشغيلية ، قررنا "التظاهر" بأن لدينا كتلة متجانسة وإعطاء المحللين قاعدة واحدة حيث سيكون لديهم جميع البيانات التي يحتاجون إليها.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بشكل عام ، نظرنا في خيارات مختلفة. كان من الممكن بناء مستودع كامل - حتى أننا حاولنا ، ولكن بصراحة ، فشلنا في تكوين صداقات متكررة بما يكفي في المنطق مع عملية بطيئة نوعًا ما لبناء مستودع وإجراء تغييرات عليه (إذا نجح شخص ما ، اكتب في التعليقات كيف). يمكن للمرء أن يقول للمحللين: "يا شباب ، تعلموا الثعبان واذهبوا إلى الإشارات التحليلية" ، لكن هذا شرط إضافي لتعيين الموظفين ، ويبدو أنه يجب تجنب ذلك إذا أمكن. قررنا تجربة استخدام تقنية FDW (غلاف البيانات الأجنبية): في الواقع ، هذا هو dblink القياسي ، الموجود في معيار SQL ، ولكن مع واجهته الأكثر ملاءمة. وبناءً على ذلك ، اتخذنا قرارًا ، واستقر في النهاية ، وتوقفنا عليه. تفاصيلها هي موضوع مقال منفصل ، أو ربما ليست واحدة ،لأنني أريد التحدث عن الكثير: من مزامنة مخططات قواعد البيانات إلى التحكم في الوصول وإخفاء هوية البيانات الشخصية. من الضروري أيضًا إبداء تحفظ بأن هذا الحل ليس بديلاً عن قواعد البيانات التحليلية والمستودعات الحقيقية ، فهو يحل مشكلة محددة فقط.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يبدو المستوى الأعلى كما يلي:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
توجد قاعدة بيانات PostgreSQL ، حيث يمكن للمستخدمين تخزين بيانات العمل الخاصة بهم ، والأهم من ذلك ، يتم ربط النسخ المتماثلة التحليلية لجميع الخدمات بقاعدة البيانات هذه من خلال FDW. </font><font style="vertical-align: inherit;">هذا يجعل من الممكن كتابة استعلام إلى العديد من قواعد البيانات ، بغض النظر عن ما هو: PostgreSQL أو MySQL أو MongoDB أو أي شيء آخر (ملف ، API ، إذا لم يكن هناك فجأة غلاف مناسب ، يمكنك كتابة ملفك الخاص). </font><font style="vertical-align: inherit;">حسنًا ، يبدو أن كل شيء رائع! </font><font style="vertical-align: inherit;">هل نختلف؟ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا انتهى كل شيء بسرعة وبساطة ، فربما لم يكن هناك مقال.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
من المهم أن نفهم بوضوح كيف تتعامل postgres مع الطلبات على الخوادم البعيدة. </font><font style="vertical-align: inherit;">يبدو هذا منطقيًا ، ولكن في كثير من الأحيان لا ينتبهون إليه: يقسم postgres الطلب إلى أجزاء يتم إجراؤها على الخوادم البعيدة بشكل مستقل ، ويجمع هذه البيانات ، ويتم إجراء الحسابات النهائية من تلقاء نفسها ، لذلك ستعتمد سرعة الطلب بشكل كبير على كيفية كتابته. </font><font style="vertical-align: inherit;">وتجدر الإشارة أيضًا إلى أنه: عندما تأتي البيانات من خادم بعيد ، لم تعد تحتوي على فهارس ، فلا يوجد شيء يمكن أن يساعد المجدول ، وبالتالي ، يمكننا فقط أن نساعد ونقترحها. </font><font style="vertical-align: inherit;">وأود أن أخبركم المزيد عن ذلك.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">طلب بسيط وخطة معه</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لإظهار كيفية تنفيذ postgres لاستعلام على جدول 6 ملايين صف على خادم بعيد ، فلنلق نظرة على خطة بسيطة.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يسمح لك استخدام تعليمات VERBOSE بمشاهدة الطلب الذي سيتم إرساله إلى الخادم البعيد والنتائج التي سنتلقاها لمزيد من المعالجة (خط RemoteSQL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
دعنا نذهب إلى أبعد من ذلك قليلاً ونضيف بعض المرشحات إلى </font><b><font style="vertical-align: inherit;">استعلامنا</font></b><font style="vertical-align: inherit;"> : واحد حسب </font><font style="vertical-align: inherit;">الحقل </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">المنطقي</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، وواحد حسب </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الطابع الزمني</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في الفاصل الزمني ، وواحد بواسطة </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هذا هو المكان الذي تكمن فيه اللحظة التي تحتاج إلى الانتباه إليها عند كتابة الاستفسارات. </font><font style="vertical-align: inherit;">لم يتم نقل الفلاتر إلى الخادم البعيد ، مما يعني أنه لتنفيذه ، يمتد postgres جميع الخطوط الستة ملايين ، ثم فقط للتصفية محليًا (خط التصفية) وأداء التجميع. </font><font style="vertical-align: inherit;">مفتاح النجاح هو كتابة طلب حتى يتم نقل المرشحات إلى الآلة البعيدة ، ولا نتلقى ونجمع سوى الصفوف اللازمة.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هذا بعض booleanshit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مع الحقول المنطقية ، كل شيء بسيط. </font><font style="vertical-align: inherit;">في الطلب الأصلي ، كانت المشكلة بسبب العبارة </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">إذا استبدلناه بـ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، نحصل على النتيجة التالية:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كما ترون ، طار المرشح إلى خادم بعيد ، وتم تقليل وقت التشغيل من 27 إلى 19 ثانية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومن الجدير بالذكر أن </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هو</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> المشغل </font><font style="vertical-align: inherit;">يختلف من </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> عامل </font><font style="vertical-align: inherit;">في أنه يمكن أن تعمل مع قيمة خالية. </font><font style="vertical-align: inherit;">هذا يعني أن </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هذا ليس صحيحًا</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في الفلتر سيغادر False و Null ، بينما </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> سيترك False فقط. </font><font style="vertical-align: inherit;">لذلك ، عند استبدال </font><font style="vertical-align: inherit;">عامل التشغيل </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ليس</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، يجب تمرير شرطين باستخدام عامل التشغيل OR إلى عامل التصفية ، على سبيل المثال ، </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE (col! = True) OR (col null)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مع فرز منطقي ، انتقل. </font><font style="vertical-align: inherit;">في هذه الأثناء ، قم بإرجاع عامل التصفية حسب القيمة المنطقية إلى شكله الأصلي ، للنظر بشكل مستقل في تأثير التغييرات الأخرى.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamptz؟ </font><font style="vertical-align: inherit;">هرتز</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بشكل عام ، غالبًا ما يتعين على المرء تجربة كيفية كتابة استعلام يتضمن خوادم بعيدة ، وعندها فقط يبحث عن تفسير لسبب حدوث ذلك. يمكن العثور على معلومات قليلة جدًا حول هذا على الإنترنت. لذلك ، في التجارب ، وجدنا أن المرشح حسب تاريخ ثابت يطير إلى الخادم البعيد مع حدوث ضجة ، ولكن عندما نريد تعيين التاريخ ديناميكيًا ، على سبيل المثال ، الآن () أو CURRENT_DATE ، لا يحدث هذا. في مثالنا ، أضفنا فلترًا بحيث يحتوي عمود create_at على بيانات لمدة شهر واحد بالضبط في الماضي (BETWEEN CURRENT_DATE - INTERVAL '7 month' AND CURRENT_DATE - INTERVAL '6 month'). ماذا فعلنا في هذه الحالة؟</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لقد طلبنا من المجدول أن يحسب التاريخ في الاستعلام الفرعي مقدمًا ويمرر المتغير الجاهز إلى الفلتر. </font><font style="vertical-align: inherit;">وأعطانا هذا التلميح نتيجة ممتازة ، وأصبح الاستعلام أسرع 6 مرات تقريبًا! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مرة أخرى ، من المهم توخي الحذر هنا: يجب أن يكون نوع البيانات في الاستعلام الفرعي هو نفس الحقل الذي نقوم بالتصفية منه ، وإلا سيقرر المجدول أنه نظرًا لأن الأنواع مختلفة ويجب عليك أولاً الحصول على جميع البيانات وتصفيتها محليًا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إعادة عامل التصفية حسب التاريخ إلى قيمته الأصلية.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">فريدي مقابل </font><font style="vertical-align: inherit;">Jsonb</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بشكل عام ، أدت الحقول والتواريخ المنطقية إلى تسريع استعلامنا بالفعل ، ولكن كان هناك نوع آخر من البيانات. </font><font style="vertical-align: inherit;">بصراحة ، المعركة مع التصفية عليها لم تنته بعد ، على الرغم من وجود نجاحات. </font><font style="vertical-align: inherit;">لذا ، إليك كيفية تمكننا من تمرير عامل التصفية حسب </font><font style="vertical-align: inherit;">حقل </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إلى الخادم البعيد.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بدلاً من عوامل التصفية ، يجب عليك استخدام عامل التشغيل وجود </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في آخر. </font><font style="vertical-align: inherit;">7 ثوانٍ بدلاً من 29 الأولية. حتى الآن ، هذا هو الخيار الوحيد الناجح لنقل الفلاتر عبر </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إلى خادم بعيد ، ولكن من المهم أن تأخذ في الاعتبار قيود واحدة: نستخدم إصدار قاعدة البيانات 9.6 ، ولكننا نخطط لإكمال أحدث الاختبارات والانتقال إلى الإصدار 12 بنهاية أبريل. </font><font style="vertical-align: inherit;">كيفية التحديث ، كتابة كيف تأثرت ، لأن هناك الكثير من التغييرات التي لها آمال كثيرة: json_path ، سلوك CTE الجديد ، الضغط لأسفل (موجود من الإصدار 10). </font><font style="vertical-align: inherit;">أود تجربته قريبًا.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أكمله</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لقد تحققنا من تأثير كل تغيير على سرعة الطلب بشكل فردي. </font><font style="vertical-align: inherit;">الآن دعونا نرى ما يحدث عندما تتم كتابة جميع المرشحات الثلاثة بشكل صحيح.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نعم ، يبدو الطلب أكثر تعقيدًا ، فهو عبارة عن لوحة قسرية ، ولكن سرعة التنفيذ هي ثانيتان ، أي أسرع بعشر مرات! </font><font style="vertical-align: inherit;">ونحن نتحدث عن استعلام بسيط عن مجموعة بيانات صغيرة نسبيًا. </font><font style="vertical-align: inherit;">في الطلبات الحقيقية ، تلقينا نموًا يصل إلى عدة مئات من المرات. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
للتلخيص: إذا كنت تستخدم PostgreSQL مع FDW ، فتأكد دائمًا من إرسال جميع المرشحات إلى الخادم البعيد ، وستكون سعيدًا ... على الأقل حتى تصل إلى الصلات بين الجداول من خوادم مختلفة. </font><font style="vertical-align: inherit;">لكن هذه قصة مقال آخر. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
شكرا للانتباه! </font><font style="vertical-align: inherit;">يسعدني سماع أسئلة وتعليقات وقصص عن تجربتك في التعليقات.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar498002/index.html">دليل الجيب إلى Z3</a></li>
<li><a href="../ar498004/index.html">محطة العمل في حاوية عامل ميناء</a></li>
<li><a href="../ar498006/index.html">اختيار محامي براءات الاختراع</a></li>
<li><a href="../ar498012/index.html">Mikrotik RouterOS في Docker مع Qemu</a></li>
<li><a href="../ar498014/index.html">PyDERASN: كما أضفت دعم البيانات الضخمة</a></li>
<li><a href="../ar498020/index.html">حول مؤشر واحد ينطبق على التقييم البصري للوظائف سريعة النمو</a></li>
<li><a href="../ar498022/index.html">ملخص المواد المثيرة للاهتمام لمطور # 341 للجوال (من 13 إلى 19 أبريل)</a></li>
<li><a href="../ar498024/index.html">بناء المدن بنقرة من الفأرة مع هوديني وبيثون</a></li>
<li><a href="../ar498026/index.html">FOSS News No. 12 - مراجعة الأخبار المجانية والمفتوحة المصدر في 13-19 أبريل 2020</a></li>
<li><a href="../ar498028/index.html">Python COVID-19 محاكاة وبائية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>