<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåµ üéöÔ∏è ü•† Generaci√≥n de c√≥digo en Go con el ejemplo de crear un cliente para la base de datos üßõüèª üßñüèª üöà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, me gustar√≠a considerar los problemas de generaci√≥n de c√≥digo en Golang. Me di cuenta de que a menudo en los comentarios sobre los ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Generaci√≥n de c√≥digo en Go con el ejemplo de crear un cliente para la base de datos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501000/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este art√≠culo, me gustar√≠a considerar los problemas de generaci√≥n de c√≥digo en Golang. </font><font style="vertical-align: inherit;">Me di cuenta de que a menudo en los comentarios sobre los art√≠culos sobre Go mencionan la generaci√≥n y la reflexi√≥n del c√≥digo, lo que provoca un acalorado debate. </font><font style="vertical-align: inherit;">Al mismo tiempo, hay pocos art√≠culos sobre la generaci√≥n de c√≥digo en el hub, aunque se usa bastante en proyectos en Go. </font><font style="vertical-align: inherit;">En el art√≠culo intentar√© decirle qu√© es la generaci√≥n de c√≥digo, para describir el alcance de la aplicaci√≥n con ejemplos de c√≥digo. </font><font style="vertical-align: inherit;">Adem√°s, no ignorar√© la reflexi√≥n.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se usa la generaci√≥n de c√≥digo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Habr√© ya hay buenos art√≠culos sobre el tema </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no repetir√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La generaci√≥n de c√≥digo debe usarse en casos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aumentar la velocidad del c√≥digo, es decir, reemplazar la reflexi√≥n;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reducir la rutina de un programador (y los errores asociados con √©l);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n de envoltorios de acuerdo a las reglas dadas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de los ejemplos, podemos considerar la biblioteca Stringer, que se incluye en el suministro de idioma est√°ndar y le permite generar autom√°ticamente m√©todos String () para conjuntos de constantes num√©ricas. </font><font style="vertical-align: inherit;">Utiliz√°ndolo, puede implementar la salida de nombres de variables. </font><font style="vertical-align: inherit;">Ejemplos de la biblioteca se describieron en detalle en los art√≠culos anteriores. </font><font style="vertical-align: inherit;">El ejemplo m√°s interesante fue la derivaci√≥n del nombre del color de la paleta. </font><font style="vertical-align: inherit;">La aplicaci√≥n de generaci√≥n de c√≥digo all√≠ evita cambiar el c√≥digo en varios lugares al cambiar la paleta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De un ejemplo m√°s pr√°ctico, podemos mencionar la biblioteca easyjson de Mail.ru. </font><font style="vertical-align: inherit;">Esta biblioteca le permite acelerar la ejecuci√≥n de masrshall / unmarshall JSON desde / hacia la estructura. </font><font style="vertical-align: inherit;">Su implementaci√≥n en los puntos de referencia omiti√≥ todas las alternativas. </font><font style="vertical-align: inherit;">Para usar la biblioteca, debe llamar a easyjson, generar√° c√≥digo para todas las estructuras que encuentra en el archivo transferido, o solo para aquellas a las que se indica el comentario // easyjson: json. </font><font style="vertical-align: inherit;">Tome la estructura del usuario como ejemplo:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span>{<font></font>
    ID <span class="hljs-keyword">int</span>
    Login <span class="hljs-keyword">string</span>
    Email <span class="hljs-keyword">string</span>
    Level <span class="hljs-keyword">int</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el archivo en el que est√° contenido, ejecute la generaci√≥n de c√≥digo:</font></font><br>
<br>
<pre><code class="bash hljs">easyjson -all main.go</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtenemos m√©todos para Usuario:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MarshalEasyJSON (w * jwriter.Writer): para convertir la estructura en una matriz de bytes JSON;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UnmarshalEasyJSON (l * jlexer.Lexer): para convertir una matriz de bytes en una estructura. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las funciones MarshalJSON () ([] byte, error) y UnmarshalJSON (data [] byte) error son necesarias para la compatibilidad con la interfaz json est√°ndar.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo Easyjson</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestEasyJSON</span><span class="hljs-params">()</span></span> {<font></font>
	testJSON := <span class="hljs-string">`{"ID":123, "Login":"TestUser", "Email":"user@gmail.com", "Level":12}`</span>
	JSONb := []<span class="hljs-keyword">byte</span>(testJSON)<font></font>
	fmt.Println(testJSON)<font></font>
	recvUser := &amp;User{}<font></font>
	recvUser.UnmarshalJSON(JSONb)<font></font>
	fmt.Println(recvUser)<font></font>
	recvUser.Level += <span class="hljs-number">1</span><font></font>
	outJSON, _ := recvUser.MarshalJSON()<font></font>
	fmt.Println(<span class="hljs-keyword">string</span>(outJSON))<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta funci√≥n, primero convertimos JSON en una estructura, agregamos un nivel e imprimimos el JSON resultante. </font><font style="vertical-align: inherit;">La generaci√≥n de c√≥digo por easyjson significa deshacerse de la reflexi√≥n en tiempo de ejecuci√≥n y aumentar el rendimiento del c√≥digo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La generaci√≥n de c√≥digo se usa activamente para crear microservicios que se comunican a trav√©s de gRPC. Utiliza el formato protobuf para describir los m√©todos de servicios, utilizando el lenguaje intermedio EDL. Despu√©s de la descripci√≥n del servicio, se inicia el compilador de protocolos, que genera c√≥digo para el lenguaje de programaci√≥n deseado. En el c√≥digo generado, obtenemos las interfaces que deben implementarse en el servidor y los m√©todos que se utilizan en el cliente para organizar la comunicaci√≥n. Resulta bastante conveniente, podemos describir nuestros servicios en un solo formato y generar c√≥digo para el lenguaje de programaci√≥n en el que se describir√° cada uno de los elementos de interacci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, la generaci√≥n de c√≥digo se puede utilizar en el desarrollo de marcos. </font><font style="vertical-align: inherit;">Por ejemplo, para implementar c√≥digo que no es necesario que el desarrollador de la aplicaci√≥n escriba, pero es necesario para su correcto funcionamiento. </font><font style="vertical-align: inherit;">Por ejemplo, para crear validadores de campo de formulario, generaci√≥n autom√°tica de Middleware, generaci√≥n din√°mica de clientes para el DBMS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n de Go Code Generator</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinemos en la pr√°ctica c√≥mo funciona el mecanismo de generaci√≥n de c√≥digo en Go. En primer lugar, es necesario mencionar el AST - √Årbol de sintaxis abstracta o √Årbol de sintaxis abstracta. Para m√°s detalles, puede ir a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para nuestros prop√≥sitos, es necesario comprender que todo el programa se construye en forma de gr√°fico, donde los v√©rtices se asignan (marcan) con los operadores del lenguaje de programaci√≥n y las hojas con los operandos correspondientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, para empezar, necesitamos paquetes: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / ast </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / parser / </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / token / El</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
siguiente comando realiza el an√°lisis del archivo con el c√≥digo y la compilaci√≥n del √°rbol.</font></font><br>
<br>
<pre><code class="go hljs"><font></font>
fset := token.NewFileSet()<font></font>
node, err := parser.ParseFile(fset, os.Args[<span class="hljs-number">1</span>], <span class="hljs-literal">nil</span>, parser.ParseComments)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indicamos que el nombre del archivo debe tomarse del primer argumento de la l√≠nea de comando, tambi√©n solicitamos que se agreguen comentarios al √°rbol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, para controlar la generaci√≥n de c√≥digo, el usuario (el desarrollador del c√≥digo en funci√≥n del cual se genera otro c√≥digo) puede usar comentarios o etiquetas (mientras escribimos `json:" "` cerca del campo de estructura). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, escribiremos un generador de c√≥digo para trabajar con una base de datos. </font><font style="vertical-align: inherit;">El generador de c√≥digo examinar√° el archivo transferido, buscar√° estructuras que tengan un comentario correspondiente y crear√° un contenedor sobre la estructura (m√©todos CRUD) para la interacci√≥n de la base de datos. </font><font style="vertical-align: inherit;">Utilizaremos los par√°metros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comentario de dbe: {"table": "users"}, en el que puede definir la tabla en la que estar√°n los registros de estructura;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etiqueta dbe para los campos de la estructura, en la que puede especificar el nombre de la columna en la que colocar el valor del campo y los atributos para la base de datos: primary_key y not_null. </font><font style="vertical-align: inherit;">Se utilizar√°n al crear la tabla. </font><font style="vertical-align: inherit;">Y para el nombre del campo, puede usar "-" para no crear una columna para √©l.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Har√© una reserva por adelantado de que el proyecto a√∫n no est√° en combate, no contendr√° parte de las verificaciones y protecciones necesarias. </font><font style="vertical-align: inherit;">Si hay inter√©s, continuar√© su desarrollo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hemos decidido la tarea y los par√°metros para controlar la generaci√≥n de c√≥digo, podemos comenzar a escribir c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los enlaces a todo el c√≥digo estar√°n al final del art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos a pasar por alto el √°rbol resultante y analizaremos cada elemento del primer nivel. </font><font style="vertical-align: inherit;">Go tiene tipos predefinidos para el an√°lisis: BadDecl, GenDecl y FuncDecl.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripci√≥n del tipo</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-comment">// A BadDecl node is a placeholder for declarations containing</span>
<span class="hljs-comment">// syntax errors for which no correct declaration nodes can be</span>
<span class="hljs-comment">// created.</span>
<span class="hljs-comment">//</span>
BadDecl <span class="hljs-keyword">struct</span> {<font></font>
    From, To token.Pos <span class="hljs-comment">// position range of bad declaration</span><font></font>
}<font></font>
<span class="hljs-comment">// A GenDecl node (generic declaration node) represents an import,</span>
<span class="hljs-comment">// constant, type or variable declaration. A valid Lparen position</span>
<span class="hljs-comment">// (Lparen.IsValid()) indicates a parenthesized declaration.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Relationship between Tok value and Specs element type:</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// token.IMPORT *ImportSpec</span>
<span class="hljs-comment">// token.CONST *ValueSpec</span>
<span class="hljs-comment">// token.TYPE *TypeSpec</span>
<span class="hljs-comment">// token.VAR *ValueSpec</span>
<span class="hljs-comment">//</span>
GenDecl <span class="hljs-keyword">struct</span> {<font></font>
    Doc *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span>
    TokPos token.Pos <span class="hljs-comment">// position of Tok</span>
    Tok token.Token <span class="hljs-comment">// IMPORT, CONST, TYPE, VAR</span>
    Lparen token.Pos <span class="hljs-comment">// position of '(', if any</span><font></font>
    Specs []Spec<font></font>
    Rparen token.Pos <span class="hljs-comment">// position of ')', if any</span><font></font>
}<font></font>
<span class="hljs-comment">// A FuncDecl node represents a function declaration.</span>
FuncDecl <span class="hljs-keyword">struct</span> {<font></font>
    Doc *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span>
    Recv *FieldList <span class="hljs-comment">// receiver (methods); or nil (functions)</span>
    Name *Ident <span class="hljs-comment">// function/method name</span>
    Type *FuncType <span class="hljs-comment">// function signature: parameters, results, and position of "func" keyword</span>
    Body *BlockStmt <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos interesados ‚Äã‚Äãen las estructuras, por eso usamos GenDecl. </font><font style="vertical-align: inherit;">En esta etapa, FuncDecl puede ser √∫til, en el que se encuentran las definiciones de funciones y usted las ajusta, pero ahora no las necesitamos. </font><font style="vertical-align: inherit;">A continuaci√≥n, observamos la matriz de especificaciones en cada nodo y buscamos que estamos trabajando con un campo de definici√≥n de tipo (* ast.TypeSpec) y esta es una estructura (* ast.StructType). </font><font style="vertical-align: inherit;">Despu√©s de determinar que tenemos una estructura, verificamos que tenga un comentario // dbe. </font><font style="vertical-align: inherit;">El c√≥digo transversal del √°rbol completo y la definici√≥n de con qu√© estructura trabajar se encuentran a continuaci√≥n.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atravesar √°rboles y obtener estructuras</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> node.Decls {<font></font>
	genD, ok := f.(*ast.GenDecl)<font></font>
	<span class="hljs-keyword">if</span> !ok {<font></font>
		fmt.Printf(<span class="hljs-string">"SKIP %T is not *ast.GenDecl\n"</span>, f)
		<span class="hljs-keyword">continue</span><font></font>
	}<font></font>
	targetStruct := &amp;StructInfo{}<font></font>
	<span class="hljs-keyword">var</span> thisIsStruct <span class="hljs-keyword">bool</span>
	<span class="hljs-keyword">for</span> _, spec := <span class="hljs-keyword">range</span> genD.Specs {<font></font>
		currType, ok := spec.(*ast.TypeSpec)<font></font>
		<span class="hljs-keyword">if</span> !ok {<font></font>
			fmt.Printf(<span class="hljs-string">"SKIP %T is not ast.TypeSpec\n"</span>, spec)
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
<font></font>
		currStruct, ok := currType.Type.(*ast.StructType)<font></font>
		<span class="hljs-keyword">if</span> !ok {<font></font>
			fmt.Printf(<span class="hljs-string">"SKIP %T is not ast.StructType\n"</span>, currStruct)
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		targetStruct.Name = currType.Name.Name<font></font>
		thisIsStruct = <span class="hljs-literal">true</span><font></font>
	}<font></font>
	<span class="hljs-comment">//Getting comments</span>
	<span class="hljs-keyword">var</span> needCodegen <span class="hljs-keyword">bool</span>
	<span class="hljs-keyword">var</span> dbeParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">if</span> thisIsStruct {
		<span class="hljs-keyword">for</span> _, comment := <span class="hljs-keyword">range</span> genD.Doc.List {<font></font>
			needCodegen = needCodegen || strings.HasPrefix(comment.Text, <span class="hljs-string">"// dbe"</span>)
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(comment.Text) &lt; <span class="hljs-number">7</span> {<font></font>
				dbeParams = <span class="hljs-string">""</span>
			} <span class="hljs-keyword">else</span> {<font></font>
				dbeParams = strings.Replace(comment.Text, <span class="hljs-string">"// dbe:"</span>, <span class="hljs-string">""</span>, <span class="hljs-number">1</span>)<font></font>
			}<font></font>
		}<font></font>
	}<font></font>
	<span class="hljs-keyword">if</span> needCodegen {<font></font>
		targetStruct.Target = genD<font></font>
		genParams := &amp;DbeParam{}<font></font>
		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(dbeParams) != <span class="hljs-number">0</span> {<font></font>
			err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(dbeParams), genParams)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
				fmt.Printf(<span class="hljs-string">"Error encoding DBE params for structure %s\n"</span>, targetStruct.Name)
				<span class="hljs-keyword">continue</span><font></font>
			}<font></font>
		} <span class="hljs-keyword">else</span> {<font></font>
			genParams.TableName = targetStruct.Name<font></font>
		}<font></font>
<font></font>
		targetStruct.GenParam = genParams<font></font>
		generateMethods(targetStruct, out)<font></font>
	}<font></font>
}</code></pre><br>
     ,  :<br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> DbeParam <span class="hljs-keyword">struct</span> {<font></font>
	TableName <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"table"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> StructInfo <span class="hljs-keyword">struct</span> {<font></font>
	Name     <span class="hljs-keyword">string</span><font></font>
	GenParam *DbeParam<font></font>
	Target   *ast.GenDecl<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora prepararemos informaci√≥n sobre los campos de la estructura, de modo que, en funci√≥n de la informaci√≥n recibida, generaremos funciones de creaci√≥n de tablas (createTable) y m√©todos CRUD.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para obtener campos de una estructura</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateMethods</span><span class="hljs-params">(reqStruct *StructInfo, out *os.File)</span></span> {
	<span class="hljs-keyword">for</span> _, spec := <span class="hljs-keyword">range</span> reqStruct.Target.Specs {<font></font>
		fmt.Fprintln(out, <span class="hljs-string">""</span>)<font></font>
		currType, ok := spec.(*ast.TypeSpec)<font></font>
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		currStruct, ok := currType.Type.(*ast.StructType)<font></font>
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
<font></font>
		fmt.Printf(<span class="hljs-string">"\tgenerating createTable methods for %s\n"</span>, currType.Name.Name)<font></font>
<font></font>
		curTable := &amp;TableInfo{<font></font>
			TableName: reqStruct.GenParam.TableName,<font></font>
			Columns:   <span class="hljs-built_in">make</span>([]*ColInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(currStruct.Fields.List)),<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> currStruct.Fields.List {
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(field.Names) == <span class="hljs-number">0</span> {
				<span class="hljs-keyword">continue</span><font></font>
			}<font></font>
			tableCol := &amp;ColInfo{FieldName: field.Names[<span class="hljs-number">0</span>].Name}
			<span class="hljs-keyword">var</span> fieldIsPrimKey <span class="hljs-keyword">bool</span>
			<span class="hljs-keyword">var</span> preventThisField <span class="hljs-keyword">bool</span>
			<span class="hljs-keyword">if</span> field.Tag != <span class="hljs-literal">nil</span> {<font></font>
				tag := reflect.StructTag(field.Tag.Value[<span class="hljs-number">1</span> : <span class="hljs-built_in">len</span>(field.Tag.Value)<span class="hljs-number">-1</span>])<font></font>
				tagVal := tag.Get(<span class="hljs-string">"dbe"</span>)<font></font>
				fmt.Println(<span class="hljs-string">"dbe:"</span>, tagVal)<font></font>
				tagParams := strings.Split(tagVal, <span class="hljs-string">","</span>)<font></font>
			PARAMSLOOP:<font></font>
				<span class="hljs-keyword">for</span> _, param := <span class="hljs-keyword">range</span> tagParams {
					<span class="hljs-keyword">switch</span> param {
					<span class="hljs-keyword">case</span> <span class="hljs-string">"primary_key"</span>:
						<span class="hljs-keyword">if</span> curTable.PrimaryKey == <span class="hljs-literal">nil</span> {<font></font>
							fieldIsPrimKey = <span class="hljs-literal">true</span>
							tableCol.NotNull = <span class="hljs-literal">true</span>
						} <span class="hljs-keyword">else</span> {<font></font>
							log.Panicf(<span class="hljs-string">"Table %s cannot have more then 1 primary key!"</span>, currType.Name.Name)<font></font>
						}<font></font>
					<span class="hljs-keyword">case</span> <span class="hljs-string">"not_null"</span>:<font></font>
						tableCol.NotNull = <span class="hljs-literal">true</span>
					<span class="hljs-keyword">case</span> <span class="hljs-string">"-"</span>:<font></font>
						preventThisField = <span class="hljs-literal">true</span>
						<span class="hljs-keyword">break</span> PARAMSLOOP
					<span class="hljs-keyword">default</span>:<font></font>
						tableCol.ColName = param<font></font>
					}<font></font>
<font></font>
				}<font></font>
				<span class="hljs-keyword">if</span> preventThisField {
					<span class="hljs-keyword">continue</span><font></font>
				}<font></font>
			}<font></font>
			<span class="hljs-keyword">if</span> tableCol.ColName == <span class="hljs-string">""</span> {<font></font>
				tableCol.ColName = tableCol.FieldName<font></font>
			}<font></font>
			<span class="hljs-keyword">if</span> fieldIsPrimKey {<font></font>
				curTable.PrimaryKey = tableCol<font></font>
			}<font></font>
			<span class="hljs-comment">//Determine field type</span>
			<span class="hljs-keyword">var</span> fieldType <span class="hljs-keyword">string</span>
			<span class="hljs-keyword">switch</span> field.Type.(<span class="hljs-keyword">type</span>) {
			<span class="hljs-keyword">case</span> *ast.Ident:<font></font>
				fieldType = field.Type.(*ast.Ident).Name<font></font>
			<span class="hljs-keyword">case</span> *ast.SelectorExpr:<font></font>
				fieldType = field.Type.(*ast.SelectorExpr).Sel.Name<font></font>
			}<font></font>
			<span class="hljs-comment">//fieldType := field.Type.(*ast.Ident).Name</span>
			fmt.Printf(<span class="hljs-string">"%s- %s\n"</span>, tableCol.FieldName, fieldType)
			<span class="hljs-comment">//Check for integers</span>
			<span class="hljs-keyword">if</span> strings.Contains(fieldType, <span class="hljs-string">"int"</span>) {<font></font>
				tableCol.ColType = <span class="hljs-string">"integer"</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-comment">//Check for other types</span>
				<span class="hljs-keyword">switch</span> fieldType {
				<span class="hljs-keyword">case</span> <span class="hljs-string">"string"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"text"</span>
				<span class="hljs-keyword">case</span> <span class="hljs-string">"bool"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"boolean"</span>
				<span class="hljs-keyword">case</span> <span class="hljs-string">"Time"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"TIMESTAMP"</span>
				<span class="hljs-keyword">default</span>:<font></font>
					log.Panicf(<span class="hljs-string">"Field type %s not supported"</span>, fieldType)<font></font>
				}<font></font>
			}<font></font>
			tableCol.FieldType = fieldType<font></font>
			curTable.Columns = <span class="hljs-built_in">append</span>(curTable.Columns, tableCol)<font></font>
			curTable.StructName = currType.Name.Name<font></font>
<font></font>
		}<font></font>
		curTable.generateCreateTable(out)<font></font>
<font></font>
		fmt.Printf(<span class="hljs-string">"\tgenerating CRUD methods for %s\n"</span>, currType.Name.Name)<font></font>
		curTable.generateCreate(out)<font></font>
		curTable.generateQuery(out)<font></font>
		curTable.generateUpdate(out)<font></font>
		curTable.generateDelete(out)<font></font>
	}<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Revisamos todos los campos de la estructura deseada y comenzamos a analizar las etiquetas de cada campo. Usando la reflexi√≥n, obtenemos la etiqueta que nos interesa (despu√©s de todo, puede haber otras etiquetas en el campo, por ejemplo, para json). Analizamos el contenido de la etiqueta y determinamos si el campo es una clave primaria (si se especifica m√°s de una clave primaria, la maldecimos y detenemos la ejecuci√≥n), ¬øhay un requisito para que el campo sea distinto de cero? ¬øNecesitamos trabajar con la base de datos para este campo y definir nombre de columna si se anul√≥ en la etiqueta. Tambi√©n necesitamos determinar el tipo de columna de la tabla en funci√≥n del tipo de campo de estructura. Hay un conjunto finito de tipos de campo, generaremos solo para los tipos b√°sicos, reduciremos todas las filas al tipo de campo TEXTO, aunque en general, puede agregar la definici√≥n del tipo de columna a las etiquetas para que pueda configurar m√°s finamente. Por otra parte,nadie se molesta en crear la tabla deseada en la base de datos por adelantado, o en corregir la creada autom√°ticamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de analizar la estructura, comenzamos el m√©todo para crear el c√≥digo para la funci√≥n de creaci√≥n de tablas y los m√©todos para crear las funciones Crear, Consultar, Actualizar, Eliminar. </font><font style="vertical-align: inherit;">Preparamos una expresi√≥n SQL para cada funci√≥n y un enlace para ejecutar. </font><font style="vertical-align: inherit;">No me molest√© en el manejo de errores, solo di el error del controlador de la base de datos. </font><font style="vertical-align: inherit;">Para la generaci√≥n de c√≥digo, es conveniente usar plantillas de la biblioteca de texto / plantilla. </font><font style="vertical-align: inherit;">Con su ayuda, puede obtener un c√≥digo mucho m√°s compatible y predecible (el c√≥digo es visible de inmediato, pero no est√° manchado por el c√≥digo del generador).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creaci√≥n de tabla</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateCreateTable</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") createTable(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> resSQLq = fmt.Sprintf(<span class="hljs-string">"\tsqlQ := `CREATE TABLE %s (\n"</span>, tableD.TableName)
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {<font></font>
		colSQL := col.ColName + <span class="hljs-string">" "</span> + col.ColType
		<span class="hljs-keyword">if</span> col.NotNull {<font></font>
			colSQL += <span class="hljs-string">" NOT NULL"</span><font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {<font></font>
			colSQL += <span class="hljs-string">" AUTO_INCREMENT"</span><font></font>
		}<font></font>
		colSQL += <span class="hljs-string">",\n"</span><font></font>
		resSQLq += colSQL<font></font>
	}<font></font>
	<span class="hljs-keyword">if</span> tableD.PrimaryKey != <span class="hljs-literal">nil</span> {<font></font>
		resSQLq += fmt.Sprintf(<span class="hljs-string">"PRIMARY KEY (%s)\n"</span>, tableD.PrimaryKey.ColName)<font></font>
	}<font></font>
	resSQLq += <span class="hljs-string">")`\n"</span><font></font>
	fmt.Fprint(out, resSQLq)<font></font>
	fmt.Fprint(out, <span class="hljs-string">"\t_, err := db.Exec(sqlQ)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n"</span>)<font></font>
	fmt.Fprint(out, <span class="hljs-string">"\t return nil\n}\n\n"</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar registro</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><font></font>
<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Create(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> columns, valuePlaces, valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		columns += <span class="hljs-string">"`"</span> + col.ColName + <span class="hljs-string">"`,"</span>
		valuePlaces += <span class="hljs-string">"?,"</span>
		valuesListParams += <span class="hljs-string">"in."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	columns = columns[:<span class="hljs-built_in">len</span>(columns)<span class="hljs-number">-1</span>]<font></font>
	valuePlaces = valuePlaces[:<span class="hljs-built_in">len</span>(valuePlaces)<span class="hljs-number">-1</span>]<font></font>
	valuesListParams = valuesListParams[:<span class="hljs-built_in">len</span>(valuesListParams)<span class="hljs-number">-1</span>]<font></font>
<font></font>
	resSQLq := fmt.Sprintf(<span class="hljs-string">"\tsqlQ := \"INSERT INTO %s (%s) VALUES (%s);\"\n"</span>,<font></font>
		tableD.TableName,<font></font>
		columns,<font></font>
		valuePlaces)<font></font>
	fmt.Fprintln(out, resSQLq)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"result, err := db.Exec(sqlQ, %s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}`</span>)
	<span class="hljs-comment">//Setting id if we have primary key</span>
	<span class="hljs-keyword">if</span> tableD.PrimaryKey != <span class="hljs-literal">nil</span> {<font></font>
		fmt.Fprintf(out, <span class="hljs-string">`lastId, err := result.LastInsertId()
		if err != nil {
			return nil
		}`</span>)<font></font>
		fmt.Fprintf(out, <span class="hljs-string">"\nin.%s = %s(lastId)\n"</span>, tableD.PrimaryKey.FieldName, tableD.PrimaryKey.FieldType)<font></font>
	}<font></font>
	fmt.Fprintln(out, <span class="hljs-string">"return nil\n}\n\n"</span>)
	<span class="hljs-comment">//in., _ := result.LastInsertId()`)</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recuperando registros de una tabla</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateQuery</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Query(db *sql.DB) ([]*"</span>+tableD.StructName+<span class="hljs-string">", error) {\n"</span>)<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\tsqlQ := \"SELECT * FROM %s;\"\n"</span>, tableD.TableName)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"rows, err := db.Query(sqlQ)\n"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"results := make([]*%s, 0)\n"</span>, tableD.StructName)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`for rows.Next() {`</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\t tempR := &amp;%s{}\n"</span>, tableD.StructName)
	<span class="hljs-keyword">var</span> valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {<font></font>
		valuesListParams += <span class="hljs-string">"&amp;tempR."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	valuesListParams = valuesListParams[:<span class="hljs-built_in">len</span>(valuesListParams)<span class="hljs-number">-1</span>]<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\terr = rows.Scan(%s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`if err != nil {
		return nil, err
		}`</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\n\tresults = append(results, tempR)"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`}
		return results, nil
	}`</span>)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">""</span>)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">""</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizaci√≥n de registro (funciona por clave principal)</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateUpdate</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Update(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> updVals, valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		updVals += <span class="hljs-string">"`"</span> + col.ColName + <span class="hljs-string">"`=?,"</span>
		valuesListParams += <span class="hljs-string">"in."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	updVals = updVals[:<span class="hljs-built_in">len</span>(updVals)<span class="hljs-number">-1</span>]<font></font>
	valuesListParams += <span class="hljs-string">"in."</span> + tableD.PrimaryKey.FieldName<font></font>
<font></font>
	resSQLq := fmt.Sprintf(<span class="hljs-string">"\tsqlQ := \"UPDATE %s SET %s WHERE %s = ?;\"\n"</span>,<font></font>
		tableD.TableName,<font></font>
		updVals,<font></font>
		tableD.PrimaryKey.ColName)<font></font>
	fmt.Fprintln(out, resSQLq)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"_, err := db.Exec(sqlQ, %s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}`</span>)<font></font>
<font></font>
	fmt.Fprintln(out, <span class="hljs-string">"return nil\n}\n\n"</span>)
	<span class="hljs-comment">//in., _ := result.LastInsertId()`)</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eliminar un registro (funciona por clave primaria)</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateDelete</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Delete(db *sql.DB) (error) {\n"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"sqlQ := \"DELETE FROM %s WHERE id = ?\"\n"</span>, tableD.TableName)<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"_, err := db.Exec(sqlQ, in.%s)\n"</span>, tableD.PrimaryKey.FieldName)<font></font>
<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}
	return nil
}`</span>)<font></font>
	fmt.Fprintln(out)<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El inicio del generador de c√≥digo resultante se realiza mediante la ejecuci√≥n habitual de ejecuci√≥n, pasamos la ruta al archivo para el que desea generar el c√≥digo en el indicador -name. </font><font style="vertical-align: inherit;">Como resultado, obtenemos el archivo con el sufijo _dbe, en el que se encuentra el c√≥digo generado. </font><font style="vertical-align: inherit;">Para las pruebas, cree m√©todos para la siguiente estructura:</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-comment">// dbe:{"table": "users"}</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {<font></font>
	ID       <span class="hljs-keyword">int</span>    <span class="hljs-string">`dbe:"id,primary_key"`</span>
	Login    <span class="hljs-keyword">string</span> <span class="hljs-string">`dbe:"login,not_null"`</span>
	Email    <span class="hljs-keyword">string</span>
	Level    <span class="hljs-keyword">uint8</span>
	IsActive <span class="hljs-keyword">bool</span>
	UError   error <span class="hljs-string">`dbe:"-"`</span><font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo resultante</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-string">"database/sql"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">createTable</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">`CREATE TABLE users (
	id integer NOT NULL AUTO_INCREMENT,
	login text NOT NULL,
	Email text,
	Level integer,
	IsActive boolean,
	PRIMARY KEY (id)
	)`</span><font></font>
	_, err := db.Exec(sqlQ)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Create</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"INSERT INTO users (`login`,`Email`,`Level`,`IsActive`) VALUES (?,?,?,?);"</span><font></font>
<font></font>
	result, err := db.Exec(sqlQ, in.Login, in.Email, in.Level, in.IsActive)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	lastId, err := result.LastInsertId()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
	}<font></font>
	in.ID = <span class="hljs-keyword">int</span>(lastId)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Query</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-params">([]*User, error)</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"SELECT * FROM users;"</span><font></font>
	rows, err := db.Query(sqlQ)<font></font>
	results := <span class="hljs-built_in">make</span>([]*User, <span class="hljs-number">0</span>)
	<span class="hljs-keyword">for</span> rows.Next() {<font></font>
		tempR := &amp;User{}<font></font>
		err = rows.Scan(&amp;tempR.ID, &amp;tempR.Login, &amp;tempR.Email, &amp;tempR.Level, &amp;tempR.IsActive)<font></font>
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
		}<font></font>
		results = <span class="hljs-built_in">append</span>(results, tempR)<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Update</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"UPDATE users SET `login`=?,`Email`=?,`Level`=?,`IsActive`=? WHERE id = ?;"</span><font></font>
<font></font>
	_, err := db.Exec(sqlQ, in.Login, in.Email, in.Level, in.IsActive, in.ID)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Delete</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"DELETE FROM users WHERE id = ?"</span><font></font>
	_, err := db.Exec(sqlQ, in.ID)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para probar el funcionamiento del c√≥digo generado, cree un objeto con datos arbitrarios, cree una tabla para √©l (si la tabla existe en la base de datos, se devolver√° un error). </font><font style="vertical-align: inherit;">Despu√©s de colocar este objeto en la tabla, lea todos los campos de la tabla, actualice los valores de nivel y elimine el objeto.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llama a los m√©todos resultantes</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">var</span> err error<font></font>
db, err := sql.Open(<span class="hljs-string">"mysql"</span>, DSN)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Unable to connect to DB"</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
err = db.Ping()<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Unable to ping BD"</span>)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
newUser := &amp;User{<font></font>
	Login:    <span class="hljs-string">"newUser"</span>,<font></font>
	Email:    <span class="hljs-string">"new@test.com"</span>,<font></font>
	Level:    <span class="hljs-number">0</span>,<font></font>
	IsActive: <span class="hljs-literal">false</span>,<font></font>
	UError:   <span class="hljs-literal">nil</span>,<font></font>
}<font></font>
<font></font>
err = newUser.createTable(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error creating table."</span>, err)<font></font>
<font></font>
}<font></font>
err = newUser.Create(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error creating user."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
<font></font>
nU := &amp;User{}<font></font>
dbUsers, err := nU.Query(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error selecting users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
fmt.Printf(<span class="hljs-string">"From table users selected %d fields"</span>, <span class="hljs-built_in">len</span>(dbUsers))
<span class="hljs-keyword">var</span> DBUser *User
<span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> dbUsers {<font></font>
	fmt.Println(user)<font></font>
	DBUser = user<font></font>
}<font></font>
DBUser.Level = <span class="hljs-number">2</span><font></font>
err = DBUser.Update(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error updating users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
err = DBUser.Delete(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error deleting users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la implementaci√≥n actual, la funcionalidad del cliente para la base de datos es muy limitada:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo se admite MySQL;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No todos los tipos de campo son compatibles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hay filtros y l√≠mites para SELECT.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, corregir errores ya est√° fuera del alcance de analizar el c√≥digo fuente de Go y generar un nuevo c√≥digo basado en √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El uso de un generador de c√≥digo en tal escenario le permitir√° cambiar los campos y tipos de estructuras utilizados en la aplicaci√≥n en un solo lugar, no es necesario recordar hacer cambios en el c√≥digo para interactuar con la base de datos, solo necesita ejecutar el generador de c√≥digo cada vez. </font><font style="vertical-align: inherit;">Esta tarea podr√≠a resolverse con la ayuda de la reflexi√≥n, pero esto habr√≠a afectado el rendimiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El generador de c√≥digo fuente y un ejemplo del c√≥digo generado publicado en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es500984/index.html">Bad Apple o Happy Radio Day, geeks</a></li>
<li><a href="../es500986/index.html">Monitoreo en el centro de datos: c√≥mo cambiamos el viejo BMS a uno nuevo. Parte 3</a></li>
<li><a href="../es500992/index.html">¬øC√≥mo es la gesti√≥n del rendimiento en las mejores empresas de TI?</a></li>
<li><a href="../es500994/index.html">Corre hormiga. correr</a></li>
<li><a href="../es500996/index.html">C√≥mo convertirse en ingeniero de DevOps en seis meses o incluso m√°s r√°pido. Parte 1. Introducci√≥n</a></li>
<li><a href="../es501002/index.html">Umka: nuevo lenguaje de script est√°ticamente tipado</a></li>
<li><a href="../es501004/index.html">Hazlo. Trabajo</a></li>
<li><a href="../es501006/index.html">Somos amigos STM32 con pantalla LCD 1604 en bus I2C (biblioteca HAL)</a></li>
<li><a href="../es501008/index.html">Pavimentaci√≥n de domin√≥</a></li>
<li><a href="../es501010/index.html">Linux Kernel TLS y Nginx</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>