<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🚒 🙎🏼 👐🏾 終わりのないサイクル：聖杯虫の物語 🧔🏾 🚵 🧜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="むかしむかし、ハローキティコレクションと呼ばれるGBAのゲーム、ミラクルファッションメーカーがありました。有名なサンリオハローキティのフランチャイズをベースに、イマジニアが開発したかわいいゲームです。しかし、一見無邪気な名前を装って陰湿な問題がありました。何らかの理由で、この単純なゲームはどのGBA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>終わりのないサイクル：聖杯虫の物語</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488240/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">むかしむかし、ハローキティコレクションと呼ばれるGBAのゲーム、ミラクルファッションメーカーがありました。有名なサンリオハローキティのフランチャイズをベースに、イマジニアが開発したかわいいゲームです。しかし、一見無邪気な名前を装って陰湿な問題がありました。何らかの理由で、この単純なゲームはどのGBAエミュレーターでも実行できませんでした。しかし、これだけでは、この問題を聖杯のバグと呼ぶには不十分です。 Holy Grailのすべてのバグと同様に、このバグ自体も完全に混乱していました。説明は簡単でした。ゲームの起動シーケンスのある時点で、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在しない</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリから特定の値が読み取られるのを待って、それが</font><em><font style="vertical-align: inherit;">終了</font></em><font style="vertical-align: inherit;">しないというサイクルに陥りました</font><font style="vertical-align: inherit;">。多くのゲームで同様のバグがありますが、例えば、人気のあるイントロには</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼルダの伝説：ミニッシュキャップ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。無効なメモリアドレスの読み取りによって引き起こされる特別な動作に依存しています。</font><font style="vertical-align: inherit;">しかし、このサイクルはそのような行動に違反しているように見えました。</font><font style="vertical-align: inherit;">それにもかかわらず、ゲームは実際の機器で動作しました。</font><font style="vertical-align: inherit;">さらに、コールドリブート後にSonic Pinball Partyにセーブをロードするときにもまったく同じバグが発生しました。</font><font style="vertical-align: inherit;">これらの無効なメモリアドレスの予測に何らかの誤りがあるのでしょうか。</font><font style="vertical-align: inherit;">もしそうなら、どうやって？</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b0/c85/547/1b0c8554787a8e54e1ac5c21c78d639c.png"></div><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、これは違法ですよね？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちょっと待ってください-無効なメモリにアクセスしようとしている場合、ゲームはクラッシュするだけですよね？未解決の操作、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segfault、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">またはその他のエラー</font><font style="vertical-align: inherit;">が発生するはず</font><font style="vertical-align: inherit;">です。正しい？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあそれははいのようなものです。しかし、そうではありません。少なくともGBAではそうではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GBAで使用されていたARMプロセッサのアーキテクチャでは、この誤った状態はデータアボートと呼ばれ、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリマネージャーが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み取り権限を割り当て</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">いない</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">メモリ</font></a><font style="vertical-align: inherit;">にアクセスしようとしたときにのみ発生します</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。データアボートが発生すると、プロセッサは実行していたことを完了し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、例外ベクタに</font></a><font style="vertical-align: inherit;">進み</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データアボート例外に割り当てられます。次に、オペレーティングシステムはソリューションの1つを選択できます。現在のプロセスを</font><font style="vertical-align: inherit;">強制終了</font><font style="vertical-align: inherit;">する、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページフォールト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリを割り当てる、</font><font style="vertical-align: inherit;">一部のエミュレータのJITが「fastmem」でこれを行うなどの状況をプロセスに処理させる、またはその他のアクションを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GBAはデータアボートをどのように処理しますか？データアボートの例外ベクターエントリは、GBAコンソールのブートROM（または、BIOSでも呼び出されます）にあります。 GBAがデータアボートを検出した場合、GBAはDACS </font><sup><font style="vertical-align: inherit;">2</font></sup><font style="vertical-align: inherit;">ハンドラーに移動しようとします</font></font><sup><font style="vertical-align: inherit;"></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在する場合は、ブロックされます。</font><font style="vertical-align: inherit;">DACSハンドラーを備えた商用ゲームはありません。</font><font style="vertical-align: inherit;">では、なぜこのゲームがフリーズしないのですか？</font><font style="vertical-align: inherit;">すべてが非常に単純です-GBAはデータアボートを生成しません。</font><font style="vertical-align: inherit;">メモリーマネージャー（MMU）（またはDSのようなメモリー保護ユニット）がないため、引き続き機能し、無効なメモリーを読み取ります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリバスがシーンに入ります。</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f75/dd9/55f/f75dd955f33d3a974b417f401fe054a6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に無効なメモリとは何ですか？彼女はどのように見えますか？これが主な障害です。これは困難な状況です。コードが読み取る内容は、CPUが最近行った処理、より正確には、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリバス</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が最近行った処理に大きく依存し</font><font style="vertical-align: inherit;">ます。つまり、無効なメモリにアクセスすると、CPUはメモリバス上の最後のメモリを読み取ります。これから何が続くかを理解するには、メモリバスとその機能について少し学ぶ必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリバスは、CPUをすべてのプラットフォームのメモリコンポーネントに接続する電子回路の一部です。 GBAでは、いくつかのデバイス（ワーキングRAM、ビデオメモリ、カートリッジバス）がメモリバスに接続されています。 CPUがメモリにアクセスしようとすると、アクセスする必要のあるアドレスがメモリバスに通知され、そのアドレスに対応するコンポーネントがアクティブになります。次に、コンポーネントはバス上のこのアドレスに値を配置します。これには数</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイクルかかることが</font><font style="vertical-align: inherit;">あります。その後、CPUは最終的にバスから値を読み取ることができます。 GBAの場合、アドレスに関連付けられている機器がない場合、バスに値は書き込まれず、CPUはバスに</font><em><font style="vertical-align: inherit;">最後</font></em><font style="vertical-align: inherit;">に配置された値を読み取ります。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、読み取りが16ビットで、CPUが32ビットの読み取りを実行しようとした場合など、状況はさまざまですが、通常は常にバスからの値です。</font><font style="vertical-align: inherit;">開発者はこの機能を「オープンバス」と呼んでいます。</font><font style="vertical-align: inherit;">以前に、それが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のゲームに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのように影響</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">する</font></a><font style="vertical-align: inherit;">かを書きました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さて、すべてがそれほど悪く見えないようです...そうですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、最後のメモリアクセスをキャッシュすることができますか？そして、それを再び持ってきますか？一般的なケースでは、このアプローチは機能しますが、いくつかの困難があります。まず、すべてのメモリアクセス操作が正しい順序になっていることを確認する必要があります。これは、CPUがパイプライン内の次の命令を取得するために各命令でメモリにアクセスするため、予想よりも複雑です。実際、一般的なケースでは、バスにスタックされているメモリが最後に受信された命令です。これにより、事前に選択されたこの最後の値のみを取得する必要があるため、プロセスが簡略化されます。しかし、最後に選択された値は、現在メモリから実行している場所にのみ依存するため、常に同じである必要があります。受信アドレスが無効であるにもかかわらず変更された場合でも、あなたは常に同じメモリを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
えっと…やめて。</font><font style="vertical-align: inherit;">ただし、このサイクルが存在し、この値が事前に選択されている場合は終了できません。</font><font style="vertical-align: inherit;">では、何が起こっているのでしょうか。</font><font style="vertical-align: inherit;">彼が常に次の指示を受け取った場合、これらの操作の間で何が起こりますか？</font><font style="vertical-align: inherit;">このような無限ループをテストROMで実行して、たとえば値が悪くなるかどうかを確認しました。</font><font style="vertical-align: inherit;">これは、値が最近更新されていない場合に確実に発生しますが、値は各命令で更新されるため、破損する時間はありません。</font><font style="vertical-align: inherit;">私のテストはループから離れることはありません。</font><font style="vertical-align: inherit;">サイクルを正確に再現しましたが、私はこれらのゲームとは異なる何かをしました。</font><font style="vertical-align: inherit;">何を間違えたのですか？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポケモンエメラルドとACE、鉄でのみ発生</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2020年1月に早送りします。当時のソニックピンボールパーティーのバグレポートは、約3年半前のものでした。他のエミュレータでは、彼は長年知られていました。理論が不足しています。今月末、</font><strong><font style="vertical-align: inherit;">merrp</font></strong><font style="vertical-align: inherit;">というニックネームの</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、mGBAエミュレータのDiscordコミュニティに参加し、ポケモンエメラルドには、ハードウェアでのみ機能する新しい任意コード実行グリッチ（ACE）があると述べました。さらに、このグリッチは、エミュレーターを練習したいスピードランナーによって使用される可能性が高いです。明らかに、このバグはエラーを修正するための魅力的なターゲットになっていますが、バージョン0.8.0より前にそれを見つけた方がよいでしょう。私はグリッチを調査し始め、それがハードウェアでのみ機能するというmerrpの観察を確認しました。私が試したすべてのエミュレーターで、ゲームは黒い画面でハングしました。しかし、merrpは、ループ内の無効なメモリからの読み取りでハングアップすることを知らせ、近いうちにエラーを修正できない可能性が高いことに気付きました。これも</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バグです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回、ループ関数について学ぶことは私に優位性を与えました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pokeemeraldの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">逆コンパイル</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プロジェクトの</font></a><font style="vertical-align: inherit;">おかげで</font><font style="vertical-align: inherit;">、関数に的を絞った変更を簡単に加えて、彼女がループから抜け出した方法を理解しようとすることができました。このループの簡略版は次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> type = <span class="hljs-comment">/* ... */</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; table[type][i] != <span class="hljs-number">0xFFFF</span>; ++i) {
	<span class="hljs-keyword">uint16_t</span> value = table[type][i] &amp; <span class="hljs-number">0xFE00</span>;
	<span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0x7E00</span>) {
		<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
	<span class="hljs-comment">/* ... */</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ループはかなり単純なタスクを実行します。値の2次元の表があります。この列テーブルの各行で、</font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループは最初に値が特定のセンチネル値であるかどうかを判別しようとします。そうであれば、ループは終了します。それ以外の場合は、値にマスクを適用し、チェックされる値よりも大きいかどうかをチェックします。それ以外の場合は、サイクルがダウンします。グリッチの特定のケースでは、値</font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がテーブルの境界を超えているため、無効なポインターが表示されます。これは、アクセスしようとすると</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この存在しない列のこの要素に対しては、常に無効なメモリにアクセスします。テーブルオフセットは、実際のメモリに戻る前にループを繰り返すたびに増加しますが、数億回の繰り返しが必要になる場合があります。したがって、彼がそうしていないことは明らかです。では、プログラムはどのようにしてループから抜け出すのでしょうか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを調査するために、私はサイクルを変更し、私がすぐにサイクルから抜け出した場合に何が起こるかを見ました。</font><font style="vertical-align: inherit;">すべてが非常に単純であることがわかりました。現時点では、ACEはハードウェアとエミュレーターの両方で機能し、何もハングしていません。</font><font style="vertical-align: inherit;">そのため、代わりに、画面の色をプログラムがループを終了してフリーズするときに読み取る値に設定して、色が変化しないようにしました。</font><font style="vertical-align: inherit;">コードを再コンパイルして、実際のGBAで実行しました。</font><font style="vertical-align: inherit;">黒い画面で数秒間フリーズした後、それは豪華な青い色になった。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/e_/md/eqe_md60cly8igmztq2_kd2yigc.png"></div><br>
<i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常に</font><i><font style="vertical-align: inherit;">青い</font></i><font style="vertical-align: inherit;">しかし、エミュレータはまだ黒い画面でハングしています。</font><font style="vertical-align: inherit;">以前に受け取った値を読んだ場合、彼はどのような値を読み取りますか？</font><font style="vertical-align: inherit;">代わりに、それは暗い青緑色になりました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sh/hf/6j/shhf6jyqkem0ulhbpzjuhc9hmi4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フー。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
それはサイクルから抜け出すために管理する前に、プログラムであり、最も確かに少なくとも一度それを渡されました。</font><font style="vertical-align: inherit;">また、鉄のサイクルから脱出するのに必要な時間が変化することも判明しました。</font><font style="vertical-align: inherit;">これには通常2〜30秒かかりました。</font><font style="vertical-align: inherit;">何が起こっている？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい作業理論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから、私はそれがハングしたとき、私のテストROMとポケモンエメラルドの違いに気づきました。ポケモンは音楽を演奏した。ソニックピンボールパーティーでも音楽を演奏しました。ハローキティは音楽を演奏しませんでしたが、それは私にアイデアを与えました。プリフェッチとデータのロードの間に割り込みが発生するとどうなりますか？プログラムは、無効なメモリにアクセスする前に割り込みベクトルのプリフェッチを開始しますか？私はすぐにこの状況のレイアウトをmGBAで作成し、テストROMで割り込みをオンにしましたが、もちろんループから抜け出しました。次に、ハードウェアで同じテストROMを試しましたが、ループから抜け出すことができませんでした。そして理論が生まれました。やっと気づきました。上記のアスタリスクに気づいたと思いますので、はい、プリフェッチとメモリへのアクセスの間に1つのイベントが発生する可能性があります。ただし、プリフェッチと無効なメモリへのアクセスの間に、メモリバスがリクエストをCPUではなく他の何かに送信する場合に限ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリバスはCPUによって制御されると述べました。ほとんどの場合、これは本当ですが、プロセッサをバイパスしてメモリバスにアクセスできる他の重要な機器もあります。このプロセスは、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダイレクトメモリアクセス</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれ</font><em><font style="vertical-align: inherit;">ます</font></em><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">DMAについて説明しました</font><font style="vertical-align: inherit;">ので、ここではその動作原理については</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">触れ</font></a><font style="vertical-align: inherit;">ません。この記事をもう一度読むと、DMAの実行中にメインCPUが一時停止していると言ったことにお気づきかもしれません。つまり、DMAの実行中は、バス上の値がDMAメモリへの最後のアクセスになります。これは主に、DMAが実際のメモリを超えて無効な領域に移動する場合に重要です。ただし、最後の適切な値を複製します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DMAに無効なメモリをロードすると、最後のDMA値が表示されることが長い間知られていますが、私はそれをmGBAに長い間実装しており、すでにそれを忘れていました。バグを研究しているときに無効なメモリのアクセスコードでこれを見つけたとき、何かが私の頭の中をクリックしました。 DMA値が1つの命令に対してバス上に残っている場合はどうなりますか？ DMA後の最初の命令が次の値を取得する前に無効なメモリのロードを完了した場合、理論的には、これによりDMA値が再ロードされます。さらに、GBAで音楽を再生するには、通常、DMAを使用してオーディオ出力を送信します。これを正しく実装するには、正確なエミュレータが必要です。正確なエミュレータは、命令の実行とメモリアクセスの間の命令実行の途中でCPUをブロックする可能性があり、mGBAエミュレータのGBAコンソールエミュレーションは正確ではありません。そして、これは私にとって何かです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リコール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">幸いなことに、私はこの問題をなんとか回避することができました。</font><font style="vertical-align: inherit;">ソリューションは不完全ですが、DMA後の命令の予想CPUアドレスを無効なロードの現在のCPUアドレスと比較し、このDMA値の事前選択値の代わりに単一のアドレスを使用できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">待望の決定</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストROMでHブランクのDMA操作をオンにして、タイミングを安定させるためにそれらをVブランクと同期させ、ハードウェアで実行しました。 DMA値がバスから読み取られたとき、同じ回数の繰り返しの後、テストROMは常にループを終了しました。私は正しかったです！これをmGBAに正しく実装するために、いくつかの試行が必要でしたが、プログラムはハードウェアと同じ結果でサイクルを終了します。ようやくmGBAで青みがかった。ハローキティが起動しました。ソニックピンボールパーティーで貯金を獲得しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
やったよ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはおそらく、1つのバグに費やした最長の時間でした。 3年間にわたり、デバッグに多くの時間を費やして数を失ったため、他の開発者もエミュレーターで同様の状況に直面したと確信しています。この洞察がなければ、さらに1年、またはそれ以上かかる可能性がありましたが、音楽を再生する以外何も起こらなかった黒い画面が、問題全体の崩壊につながったそのドミノタイルになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションが見つかったので、他のGBAエミュレーターに実装して、このバグに終止符を打つことができます。バグはmGBA 0.9.0で修正される予定です。mGBA0.9.0は​​今年リリースされる予定で、テストビルドですでに修正されています。ついにハローキティコレクション：ミラクルファッションメーカーをプレイできます。もちろん、あなたが望んでいない限り、私があなたを判断することはありません。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34c/74c/fce/34c74cfce5ebbb092c5a55c9293ec0cb.png" alt="画像"></div><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行権限のないメモリを実行しようとすると、プリフェッチアボートと呼ばれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DACS（Debugging and Communication Systemの略）は、GBA開発キットの一部です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バスからの読み取り中のこれらのアイドルサイクルは、待ち状態と呼ばれることがあります。</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja488224/index.html">FSBからの手紙についての元TJ編集長：「Durov 2.0」のストーリーが出ますが、Habrがヘッドライナーになります</a></li>
<li><a href="../ja488228/index.html">2月14日のオタクデートのトップ10の場所とアイデア</a></li>
<li><a href="../ja488230/index.html">SSDの概要。パート3.フォームファクタ</a></li>
<li><a href="../ja488232/index.html">おおよその技術：QATOK＃2</a></li>
<li><a href="../ja488234/index.html">Windows 7でのQubesOSの使用</a></li>
<li><a href="../ja488242/index.html">VueJS + TSプロジェクトとSonarQubeの統合</a></li>
<li><a href="../ja488244/index.html">C ++で例外を処理するときのオーバーヘッドを削減する方法</a></li>
<li><a href="../ja488246/index.html">iOS上のVoiceOver：各コントロールの動作は異なります</a></li>
<li><a href="../ja488250/index.html">Linux（L）の質問へ</a></li>
<li><a href="../ja488252/index.html">SLSを使用して新製品を開発するコストを削減する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>