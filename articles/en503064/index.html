<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÉÔ∏è ‚ùî üë®üèΩ‚ÄçüöÄ IoT where you did not wait (part 3). Building a simulation model ‚òùüèª ‚ôíÔ∏è üéè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As I already said in the last part , when developing an IoT project, the protocols for interacting with devices are rather unstable, and the chances o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IoT where you did not wait (part 3). Building a simulation model</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/503064/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I already said in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last part</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when developing an IoT project, the protocols for interacting with devices are rather unstable, and the chances of losing contact with test devices after updating the firmware were quite large. </font><font style="vertical-align: inherit;">Several teams were involved in the development, and there was a strict requirement - not to lose the ability to test the business layer of the application, even if flashing the devices breaks the entire flow of working with sensors.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zv/z5/tv/zvz5tvvouwnwasl8uerdpzto6eq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for business analysts to test their hypotheses on data more or less similar to reality, we built a simulation model of the device. </font><font style="vertical-align: inherit;">Thus, if the device broke down due to new firmware, and the data needed to be urgently received, we launched a simulation model instead of a real device on the network, which, according to the old format, drove the data and produced the result.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, the advantage of the model was that the business would never buy a large batch of devices just to test a hypothesis. </font><font style="vertical-align: inherit;">For example, the business analysis team decided that predicting container filling time should work differently. </font><font style="vertical-align: inherit;">And to test their hypothesis, no one will run to buy 10,000 sensors.</font></font><br>
<br>
<h2><font color="#DB8E0D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development of a simulation model</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simulation model itself was as follows: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ed/bs/pf/edbspfx-ti5ypivxexehovva9ok.gif" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
state and behavior of the garbage can is described by a regular state machine. First, we initialize the state machine with the state `EMPTY (level = 0)` and we can perform some actions on it, that is, throw garbage into the container. Now you need to decide whether the container remains empty `(level? MAX_LEVEL)` or is it full` (level&gt; = MAX_LEVEL) `. If the second, then the state changes to `FULL`. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Someone can unload the garbage from a full container, or the janitor has come to clean up his mess, and we need to decide what state to switch to. The `CHOICE` state is responsible for choosing an action - in the terminology of a state machine, something similar to an if block.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another container may burn, and then the state-machine state changes to `FIRE`. </font><font style="vertical-align: inherit;">Also, the container may fall, and its condition becomes `FALL` (in the report I talked about what unexpected reasons container drops may cause). </font><font style="vertical-align: inherit;">But there is another `LOST` state, which is valid from any other state - it is set when the connection is lost. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a state machine describes almost all the behavior of the container and the sensor on it. </font><font style="vertical-align: inherit;">But this is not enough to make a simulation model, because we know about the possible states and transitions from them, but we do not know what the probability of these events is and when they will occur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, it turned out that the probability of events depended on the time of day, because:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carriers do not work at night;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">people throw more garbage at certain hours (in the morning before work and in the evening).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we made it possible for the business analysis team to customize the simulation behavior. </font><font style="vertical-align: inherit;">It was possible to set the probability of an event at a certain time of the day.</font></font><br>
<br>
<h2><font color="#DB8E0D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Simple and intuitive stress test </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imitation itself has many advantages, and one of them is cheap load testing. </font><font style="vertical-align: inherit;">It‚Äôs cheap because imitation is, in fact, a separate thread that starts the state machine, applies events to it, and the events themselves are sent to the real server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the simulation for the backend is no different from the real sensor. </font><font style="vertical-align: inherit;">And if we need to run 1000 sensors, run 1000 threads and work. </font><font style="vertical-align: inherit;">In addition, the simulation scales perfectly.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xq/5c/w5/xq5cw5zezhxybxbmk_xuyo7sjxk.gif" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the one hand, it‚Äôs rather rude to test the load, but on the other hand, the simulation made it possible to drive a lot of data close to reality for the entire project. And do not forget about gifted Chinese developers who ignored standard protocols like MQTT and sawed off their protocol on top of sockets. Therefore, we had to do our own implementation of a server that accepts data on sockets under this proprietary protocol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a server had to be multi-threaded, since there are many input sensors. and this part also needs to be tested separately using performance tests. You could take JMeter (write a typical test script), JMH / JCStress (test isolated parts and make a thinner benchmark), or something else of your own. When you make a decision in a similar situation, I advise you to listen to professionals, for example, Alexei Shipilev. At JPoint 2017, he very coolly </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">talked about</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> how to benchmark different things and what you need to think about when doing performance testing.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/p2b4JHESEOc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We chose the option to do something of our own, since the project had an atypical approach to QA - we do not have a separate team of testers, and the backend team itself tested the functionality. </font><font style="vertical-align: inherit;">That is, the person who wrote the socket server had to cover the code with ordinary units, integration and performance tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We had a small tool that allowed us to quickly describe the load scenario and run it in the right amount of parallel threads:</font></font><br>
<br>
<pre><code class="java hljs">StressTestRunner.test()<font></font>
                .mode(ExecutionMode.EXECUTOR_MODE)<font></font>
                .threads(THREADS_COUNT)<font></font>
                .iterations(MESSAGES_COUNT)<font></font>
                .timeout(<span class="hljs-number">5</span>, TimeUnit.SECONDS)<font></font>
                .run(() -&gt; sensor.send(MESSAGE));<font></font>
<font></font>
Awaitility.await()<font></font>
          .atMost(<span class="hljs-number">5</span>, TimeUnit.SECONDS)<font></font>
          .untilAsserted(() -&gt;<font></font>
            verifyReceived(MESSAGES_COUNT)<font></font>
          );<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We say how many threads you need to run, how many messages to send, how long it should take, and send data to the socket in each thread. </font><font style="vertical-align: inherit;">It remains only to wait for our server to correctly process all this data. </font><font style="vertical-align: inherit;">Only a few lines of code have been released that can be written by any backend developer.</font></font><br>
<br>
<h2><font color="#DB8E0D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emulation of network problems</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the help of imitation, we were able to simulate both poor-quality and specific work with sockets. </font><font style="vertical-align: inherit;">GSM SIM cards in the sensors do not have ‚Äúwhite‚Äù IP addresses, and we could receive data from different IPs 50 times a day. </font><font style="vertical-align: inherit;">And it often happened that the connection was opened, we started to transfer data, then the IP address changes, and the server opens a new connection without closing the old one. </font><font style="vertical-align: inherit;">If we did not take this into account, then in a couple of days we would run out of free ports on the server. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/7i/cp/zo7icpvaszptgcfrwhlisznm5aw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There was also a problem with different speed sensors. </font><font style="vertical-align: inherit;">A slow device may open a connection and freeze for a while, while a fast device will send something. </font><font style="vertical-align: inherit;">And all this needs to be processed correctly. </font><font style="vertical-align: inherit;">In imitation, simulating a similar situation is easy using pauses. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wh/q2/es/whq2esv39_sverob7195mc6yxtw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is only part of the scenarios that can be incorporated into the model.</font></font><br>
<br>
<h2><font color="#DB8E0D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems to me that it is precisely the possibility of simulation that strongly distinguishes IoT from other projects. Simulating device behavior is easier than human behavior. At the input, we get deterministic values ‚Äã‚Äãthat correlate well with our model, and not random human actions. Because the behavior of devices is logically easier to describe than the behavior of people, and testing the system becomes easier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We looked at quite a few different aspects of development in IoT. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/be/gl/dmbeglutox6rwbye8o2jkvgflm4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you skipped the previous two parts of this article, you can find them here: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IoT where you did not wait (Part 1) - The subject area and problems of </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IoT where you did not wait (Part 2) - Application architecture and IoT testing of specific things </font></font></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github with the testing tools in question.</font></font></a><br>
<br>
<blockquote> .  ,     Heisenbug    ,        IoT. ,   !        JPoint,        .          Heisenbug   JPoint    6   . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   !</a></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503042/index.html">5 Myths about Red Teaming</a></li>
<li><a href="../en503052/index.html">Automation of microfronts, or how component libraries are tested in Tinkoff</a></li>
<li><a href="../en503054/index.html">What is common between drops in a cup of coffee and quantum mechanics?</a></li>
<li><a href="../en503056/index.html">May 23 online pub: holivarim about clouds, JS and cell phones</a></li>
<li><a href="../en503062/index.html">–†–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∂–∏–∑–Ω–∏ –≤ –ö—Ä–µ–º–Ω–∏–µ–≤–æ–π –î–æ–ª–∏–Ω–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</a></li>
<li><a href="../en503068/index.html">At the crossroads of technology and business: IT leaders open a new university in Switzerland</a></li>
<li><a href="../en503070/index.html">Electric mug. Building a crazy electric scooter / electric bike</a></li>
<li><a href="../en503072/index.html">Just another tool: getting to know the service configuration with Desired State Configuration¬†</a></li>
<li><a href="../en503074/index.html">Details about the Provider package for Flutter</a></li>
<li><a href="../en503082/index.html">Telegram as NAS / FTP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>