<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÅ üë®üèΩ‚Äçüåæ ‚è∫Ô∏è Pure architecture with Typescript: DDD and layered architecture üß£ üçú üî´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! Recently I have been paying much attention to architecture and decided to share with the community a translation of the article Clean Arc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pure architecture with Typescript: DDD and layered architecture</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486734/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font><font style="vertical-align: inherit;">Recently I have been paying much attention to architecture and decided to share with the community a translation of the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean Architecture with Typescript: DDD, Onion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andr√© Bazaglia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For over 6 years of my professional experience, I have had the opportunity to work in cool technology companies that pay a lot of attention to high availability and code quality. </font><font style="vertical-align: inherit;">I had to deal with critical situations when bugs or even a second downtime of the system were unacceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The purpose of this article is not a detailed coverage of complex topics on DDD and Layered architecture, but an example of the implementation of these two approaches in Typescript. </font><font style="vertical-align: inherit;">The project used is basic and can be refined and expanded, for example, using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CQRS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approach </font><font style="vertical-align: inherit;">.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why DDD?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Created software products must implement the set business requirements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach simplifies the testing of the domain layer, which allows you to be sure that all business requirements are taken into account and write long-lived error-proof code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DDD in combination with a layered architecture avoids the domino effect when changing the code in one place leads to innumerable bugs in different places.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why layered architecture?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach goes well with DDD, as the whole system is built around a domain model, which is the center circle in the image below. The inner layers are not directly dependent on the outer ones and use them by injection. Plus, we get excellent flexibility, so each layer has its own area of ‚Äã‚Äãresponsibility and the incoming data is validated by each layer in accordance with its needs. And therefore, inner layers always receive valid data from outer layers. Not to mention testing: unit testing becomes easier with the use of dependency mocks based on interfaces, which allows you to abstract from external parts of the system, such as databases. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/at/ex/qsatexfqebsdg9n1gwlnga_vuuc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of Typescript and Javascript, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inversion of control (via Dependency Inversion)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">means embedding (passing) dependencies through parameters instead of explicit import. </font><font style="vertical-align: inherit;">In the following code example, we will use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inversify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">, which allows us to describe dependencies using decorators so that classes created later can have dynamically created containers for resolving dependencies.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this simple application ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will create a simple shopping cart application that can handle adding products to the cart. </font><font style="vertical-align: inherit;">A cart may have several business rules, such as a minimum or maximum quantity for each item. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's dive into the depths of the application layers, start with the innermost layer and move outwards sequentially.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domain</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The domain layer, by definition, is the habitat of business rules. It knows nothing about any external layers, has no dependencies and can be easily tested. Even if you change the entire application around, the domain will remain untouched, since it contains only business rules that are available to understand their purpose for everyone reading this code. This layer should be covered as much as possible with tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have an Entity base class, which can contain certain logic common to all domain classes. In this example, all the common logic is to generate a collision-resistant identifier suitable for horizontal scaling, and all objects will use this approach.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> abstract <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entity</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
  protected readonly _id: string<font></font>
  protected props: T<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(props: T, id?: string) {
    <span class="hljs-keyword">this</span>._id = id ? id : UniqueEntityID()
    <span class="hljs-keyword">this</span>.props = props<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// other common methods here...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After writing the Entity class, you can begin to create our central domain class that extends the Entity abstract class. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is nothing very complicated in this class, but there are some interesting points that you should pay attention to. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, the constructor is private, which means that executing </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new Cart ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will cause an error, which is what we need. In DDD, it is considered good practice to keep a domain object always in a valid state. Instead of directly creating an empty Cart object, we use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Factory pattern</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which returns the finished instance of the Cart class. To ensure that the creation procedure has received all the required attributes, they can be validated. Similarly, getters and setters are used to interact with the domain, for this very reason the internal state of the class is stored in a private </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">props</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><font style="vertical-align: inherit;">. Getters provide read access to attributes that should be public. Similarly, public setters and other methods allow you to change the domain with a constant guarantee of the validity of the state of the object. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize, we can emphasize an important point: domain logic should be focused on behavior, and not on properties.</font></font></b><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cart</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span>&lt;<span class="hljs-title">ICartProps</span>&gt; </span>{<font></font>
  private <span class="hljs-keyword">constructor</span>({ id, ...data }: ICartProps) {
    <span class="hljs-keyword">super</span>(data, id)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">static</span> create(props: ICartProps): Cart {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> Cart(props)
    <span class="hljs-keyword">return</span> instance<font></font>
  }<font></font>
<font></font>
  public unmarshal(): UnmarshalledCart {<font></font>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.id,
      <span class="hljs-attr">products</span>: <span class="hljs-keyword">this</span>.products.map(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> ({
        <span class="hljs-attr">item</span>: product.item.unmarshal(),
        <span class="hljs-attr">quantity</span>: product.quantity<font></font>
      })),<font></font>
      <span class="hljs-attr">totalPrice</span>: <span class="hljs-keyword">this</span>.totalPrice<font></font>
    }<font></font>
  }<font></font>
<font></font>
  private <span class="hljs-keyword">static</span> validQuantity(quantity: number) {
    <span class="hljs-keyword">return</span> quantity &gt;= <span class="hljs-number">1</span> &amp;&amp; quantity &lt;= <span class="hljs-number">1000</span><font></font>
  }<font></font>
<font></font>
  private setProducts(products: CartItem[]) {<font></font>
    <span class="hljs-keyword">this</span>.props.products = products<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">id</span>(): <span class="hljs-title">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._id<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">products</span>(): <span class="hljs-title">CartItem</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.props.products<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">totalPrice</span>(): <span class="hljs-title">number</span> {
    <span class="hljs-keyword">const</span> cartSum = <span class="hljs-function">(<span class="hljs-params">acc: number, product: CartItem</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> acc + product.item.price * product.quantity<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.products.reduce(cartSum, <span class="hljs-number">0</span>)<font></font>
  }<font></font>
<font></font>
  public add(item: Item, <span class="hljs-attr">quantity</span>: number) {
    <span class="hljs-keyword">if</span> (!Cart.validQuantity(quantity)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidationError(
        <span class="hljs-string">'SKU needs to have a quantity between 1 and 1000'</span><font></font>
      )<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> index = <span class="hljs-keyword">this</span>.products.findIndex(
      <span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> product.item.sku === item.sku<font></font>
    )<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">const</span> product = {<font></font>
        ...this.products[index],<font></font>
        <span class="hljs-attr">quantity</span>: <span class="hljs-keyword">this</span>.products[index].quantity + quantity<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">if</span> (!Cart.validQuantity(product.quantity)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidationError(<span class="hljs-string">'SKU exceeded allowed quantity'</span>)<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">const</span> products = [<font></font>
        ...this.products.slice(<span class="hljs-number">0</span>, index),<font></font>
        product,<font></font>
        ...this.products.slice(index + <span class="hljs-number">1</span>)<font></font>
      ]<font></font>
<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setProducts(products)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> products = [...this.products, { item, quantity }]
    <span class="hljs-keyword">this</span>.setProducts(products)<font></font>
  }<font></font>
<font></font>
  public remove(itemId: string) {<font></font>
    <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">this</span>.products.filter(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> product.item.id !== itemId)
    <span class="hljs-keyword">this</span>.setProducts(products)
    <span class="hljs-keyword">this</span>.emitCartMutation()<font></font>
  }<font></font>
<font></font>
  public empty() {<font></font>
    <span class="hljs-keyword">this</span>.setProducts([])<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While our Cart object can be used by the application using domain methods, in some cases, we may need to ‚Äúdeploy‚Äù it into a clean object. </font><font style="vertical-align: inherit;">For example, to save to the database or send to the client as a JSON object. </font><font style="vertical-align: inherit;">This can be implemented using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unmarshal ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To increase the flexibility of the architecture, the domain layer can also become a source of domain events. </font><font style="vertical-align: inherit;">Here, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Sourcing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approach can be applied </font><font style="vertical-align: inherit;">, with the creation of events when domain entities change.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User scripts</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we will use domain methods and objects implemented from the infrastructure level to store data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inversify</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">to implement the Inversion of Management approach, which injects the repository from the infrastructure layer into this scenario, providing us with the ability to manipulate the basket using domain methods and save changes to the database after that.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { inject, injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'inversify'</span><font></font>
<font></font>
@injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartService</span> </span>{<font></font>
  @inject(TYPES.CartRepository) private repository: CartRepository<font></font>
<font></font>
  private <span class="hljs-keyword">async</span> _getCart(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.repository.getById(id)
      <span class="hljs-keyword">return</span> cart<font></font>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">const</span> emptyCart = Cart.create({ id, <span class="hljs-attr">products</span>: [] })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.create(emptyCart)<font></font>
    }<font></font>
  }<font></font>
<font></font>
  public getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.getById(id)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">async</span> add(cartId: string, <span class="hljs-attr">item</span>: Item, <span class="hljs-attr">sku</span>: number): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._getCart(cartId)<font></font>
    cart.add(item, sku)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.update(cart)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">async</span> remove(cartId: string, <span class="hljs-attr">itemId</span>: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._getCart(cartId)<font></font>
    cart.remove(itemId)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.update(cart)<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This layer is responsible for the operation of the application. </font><font style="vertical-align: inherit;">Code changes to this layer do not affect domain entities or external dependencies like a database.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite all the obviousness, the infrastructure layer interacts with external systems, such as a database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To save data to the database, I use the Data mapper and Repository approaches. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mapper can get the source data from the database and convert it to the corresponding domain object:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Cart, CartItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/domain/cart'</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> getProducts = <span class="hljs-function">(<span class="hljs-params">products: CartItem[]</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> products.map(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> ({
    <span class="hljs-attr">item</span>: product.item,
    <span class="hljs-attr">quantity</span>: product.quantity<font></font>
  }))<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartMapper</span> </span>{<font></font>
  public <span class="hljs-keyword">static</span> toDomain(raw: any): Cart {
    <span class="hljs-keyword">return</span> Cart.create({
      <span class="hljs-attr">id</span>: raw.id,
      <span class="hljs-attr">couponCode</span>: raw.couponCode,
      <span class="hljs-attr">products</span>: getProducts(raw.products || [])<font></font>
    })<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The repository itself may depend on the client library of a particular database. </font><font style="vertical-align: inherit;">For example, from storage in RAM, and use these methods to manage data:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { injectable, inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'inversify'</span>
<span class="hljs-keyword">import</span> { Cart } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/domain/cart'</span>
<span class="hljs-keyword">import</span> { CartMapper } <span class="hljs-keyword">from</span> <span class="hljs-string">'../mappers/cart'</span><font></font>
<font></font>
interface ICartRepository {<font></font>
  getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
  create(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
  update(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
}<font></font>
<font></font>
@injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartRepository</span> <span class="hljs-title">implements</span> <span class="hljs-title">ICartRepository</span> </span>{<font></font>
  @inject(TYPES.Database) private _database: MemoryData<font></font>
<font></font>
  <span class="hljs-keyword">async</span> getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.getById(id)
    <span class="hljs-keyword">if</span> (!cart) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ResourceNotFound(<span class="hljs-string">'Cart'</span>, { id })<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> CartMapper.toDomain(cart)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> create(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> dtoCart = cart.unmarshal()
    <span class="hljs-keyword">const</span> inserted = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.insert(dtoCart)
    <span class="hljs-keyword">return</span> CartMapper.toDomain(inserted)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> update(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> dtoCart = cart.unmarshal()
    <span class="hljs-keyword">const</span> updated = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.update(cart.id, dtoCart)
    <span class="hljs-keyword">return</span> CartMapper.toDomain(updated)<font></font>
  }<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a lot of room for improvements and improvements. </font><font style="vertical-align: inherit;">The code was created for this visual demonstration, and the first improvement in the layered architecture could be the announcement of the repository interface declaration in the domain layer and its implementation in the infrastructure layer, which we can discuss next time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Source code is available on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486734/">https://habr.com/ru/post/en486734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486714/index.html">Instagram api at the minimum</a></li>
<li><a href="../en486716/index.html">What the Moscow Exchange Free API does on Google Sheets</a></li>
<li><a href="../en486722/index.html">Static safety testing with open source tools</a></li>
<li><a href="../en486726/index.html">Diagnosing network connections on a virtual EDGE router</a></li>
<li><a href="../en486728/index.html">German Data Protection Authority: telemetry in Windows 10 1909 Enterprise can be completely disabled</a></li>
<li><a href="../en486736/index.html">How to increase the decoding speed of a video stream in FFmpeg</a></li>
<li><a href="../en486738/index.html">PHP Code Style Conventions</a></li>
<li><a href="../en486740/index.html">Writing an API in Rust using procedural macros</a></li>
<li><a href="../en486742/index.html">Interview with Anatoly Wasserman about the Future</a></li>
<li><a href="../en486744/index.html">A smart domestic-made posture corrector went on sale. We looked at the new product - IBACK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>