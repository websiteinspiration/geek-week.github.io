<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚣🏾 👇🏿 👈🏻 Pencatatan hierarki aplikasi ke basis data 🗓️ 👨🏿‍🚒 🐈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo semuanya!
 

Dalam artikel ini, saya ingin berbicara tentang salah satu pendekatan untuk pencatatan aplikasi, yang sangat membantu saya dan rekan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pencatatan hierarki aplikasi ke basis data</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500656/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo semuanya!</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam artikel ini, saya ingin berbicara tentang salah satu pendekatan untuk pencatatan aplikasi, yang sangat membantu saya dan rekan saya dalam debugging, pemecahan masalah, dan menganalisis masalah kinerja. Banyak artikel bagus ditulis tentang perlunya penebangan, termasuk di Habré, oleh karena itu, tidak ada alasan untuk mengulang di sini. Saya memulai karir TI saya dengan Oracle dan mempelajari basis data ini dari buku-buku ahli utama - Tom Kite. Saya ingat ungkapannya tentang masuk dari buku "Oracle Efektif oleh Desain":</font></font></p><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instrumentasi bukan overhead. </font><font style="vertical-align: inherit;">Overhead adalah sesuatu yang dapat Anda hapus tanpa kehilangan banyak manfaat. </font><font style="vertical-align: inherit;">Menghapus (atau tidak memiliki) instrumentasi menghilangkan banyak fungsi. </font><font style="vertical-align: inherit;">Anda tidak perlu melakukan ini jika sistem Anda tidak pernah rusak, tidak pernah memerlukan diagnostik, dan tidak pernah menderita masalah kinerja. </font><font style="vertical-align: inherit;">Jika itu benar, Anda tidak perlu menginstruksikan sistem Anda (dan kirimkan saya alamat email Anda, karena saya memiliki tawaran pekerjaan untuk Anda).</font></font></blockquote><p></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan bekerja pada proyek-proyek Oracle, semuanya dimulai.</font></font></p><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hierarchical Logging di Oracle</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa waktu lalu saya sedang mengerjakan proyek untuk mengembangkan Gudang Data besar pada platform Oracle. Logika memuat, memeriksa, memperkaya data diimplementasikan di dalam database dalam PL / SQL. Berkenaan dengan penebangan, ide berikut diusulkan. Jika Anda melihat secara global pada aplikasi apa pun, maka itu adalah pohon panggilan ke fungsi / prosedur (metode). Pada saat yang sama, suatu metode di dalam dirinya sendiri dapat memanggil beberapa metode anak, tetapi panggilannya terjadi persis dari satu metode induk. Dengan demikian, kita mendapatkan hierarki induk / anak antara metode (disebut / dipanggil), yang secara alami dimodelkan dalam database menggunakan bidang </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parent_id</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di mana </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parent_id</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah kunci asing di bidang </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini persis hubungan yang sama seperti dalam contoh klasik dengan karyawan dan manajer mereka (karyawan hanya dapat memiliki satu manajer, manajer dapat memiliki beberapa karyawan). </font><font style="vertical-align: inherit;">Skema logging dapat dijelaskan sebagai berikut:</font></font></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> log_instances (<font></font>
  start_log_id <span class="hljs-built_in">number</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
  , log_instance_name <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
  , start_ts <span class="hljs-built_in">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
  , end_ts <span class="hljs-built_in">timestamp</span>(<span class="hljs-number">6</span>)<font></font>
  , <span class="hljs-keyword">status</span> <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
  , log_date <span class="hljs-built_in">date</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
  , <span class="hljs-keyword">constraint</span> log_instances_pk primary <span class="hljs-keyword">key</span>(start_log_id))<font></font>
/<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> log_instances_name_idx <span class="hljs-keyword">on</span> log_instances(log_instance_name)<font></font>
/<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> log_table (<font></font>
  action_name <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
  log_id  <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
  parent_log_id <span class="hljs-built_in">NUMBER</span>(<span class="hljs-number">16</span>),<font></font>
  start_ts <span class="hljs-built_in">timestamp</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
  end_ts <span class="hljs-built_in">timestamp</span>(<span class="hljs-number">6</span>),
  <span class="hljs-keyword">status</span> <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
  comments <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">4000</span>),<font></font>
  exception_message <span class="hljs-built_in">varchar2</span>(<span class="hljs-number">4000</span>),<font></font>
  large_text <span class="hljs-keyword">CLOB</span>,<font></font>
  log_date <span class="hljs-built_in">date</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
  <span class="hljs-keyword">constraint</span> log_table_status_chck <span class="hljs-keyword">check</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'C'</span><span class="hljs-comment">/*completed*/</span>, <span class="hljs-string">'R'</span><span class="hljs-comment">/*running*/</span>, <span class="hljs-string">'F'</span><span class="hljs-comment">/*failed*/</span>))<font></font>
)<font></font>
<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">range</span> (log_date)
<span class="hljs-built_in">interval</span>(NUMTODSINTERVAL(<span class="hljs-number">7</span>,<span class="hljs-string">'day'</span>))<font></font>
(<span class="hljs-keyword">partition</span> p_fst_day_of_week <span class="hljs-keyword">values</span> <span class="hljs-keyword">less</span> <span class="hljs-keyword">than</span> (<span class="hljs-built_in">date</span> <span class="hljs-string">'...'</span>))<font></font>
/<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> log_table_log_id_idx <span class="hljs-keyword">on</span> log_table(log_id) <span class="hljs-keyword">local</span><font></font>
/<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> log_table_parent_id_idx <span class="hljs-keyword">on</span> log_table(parent_log_id) <span class="hljs-keyword">local</span><font></font>
/<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> log_table_action_name_idx <span class="hljs-keyword">on</span> log_table(action_name) <span class="hljs-keyword">local</span>
/</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabel </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log_inances</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pertama </font><em><font style="vertical-align: inherit;">berisi</font></em><font style="vertical-align: inherit;"> informasi tentang setiap permulaan aplikasi:</font></font></p><br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log_instance_name</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - name, misalnya, "sample_app_20200501"</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start_ts / end_ts</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - waktu mulai dan berakhir pencatatan ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">end_ts</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kosong jika aplikasi sedang berjalan)</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 'C' (selesai) - aplikasi dihentikan tanpa kesalahan, 'R' (berjalan) - aplikasi sedang berjalan, 'F' (gagal) - aplikasi diakhiri dengan kesalahan.</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start_log_id</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah id root dalam hierarki panggilan.</font></font></li>
</ul><br>
<p> <em>log_table</em>             . </p><br>
<ul>
<li><em>action_name</em> —   </li>
<li><em>start_ts/end_ts</em> —  /  </li>
<li><em>status</em> — 'C' (completed) —    , 'R'(running) —  , 'F'(failed) —    . </li>
<li><em>exception_message</em> —     ,    error stack trace   ,   </li>
</ul><br>
<p>     API ( Oracle API        /  ). :</p><br>
<ul>
<li><em>PROCEDURE start_logging(instance_name)</em> —  ,   ,     <em>log_instances</em></li>
<li><em>PROCEDURE open_next_level(action_name, comments, clob_text)</em> —      .     <em>log_table</em></li>
<li><em>PROCEDURE close_level_success</em> —      'C'</li>
<li><em>PROCEDURE close_level_fail</em> —      'F'</li>
<li><em>PROCEDURE stop_log_success</em> —      'C'</li>
<li><em>PROCEDURE stop_log_fail</em> —      'F'</li>
</ul><br>
<h3 id="kontekst-logirovaniya"> </h3><br>
<p> <em> </em>      ( Oracle    <em></em>):</p><br>
<ul>
<li><em>id</em>   </li>
<li> <em>id</em>,     INSERT/UPDATE  <em>log_table</em></li>
<li> <em>id</em>  log_table   ,        </li>
</ul><br>
<p>  <em>pk_util_log</em>   .     API  :<br>
-<em>info</em> —  <em>open_level</em>   <em>close_level</em>.      -     <em>logger.info</em>  Java.<br>
-<em>resume_logging (parent_log_id)</em> —         .     id    log_table.</p><br>
<h3 id="primer"></h3><br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">PROCEDURE</span> b(p_name_in <span class="hljs-keyword">IN</span> <span class="hljs-built_in">VARCHAR2</span>) <span class="hljs-keyword">IS</span><font></font>
        v_dummy_cnt PLS_INTEGER;<font></font>
    <span class="hljs-keyword">BEGIN</span>
        pk_util_log.open_next_level(p_action_name_in =&gt; <span class="hljs-string">'In procedure b()'</span>,<font></font>
                        p_comments_in =&gt; <span class="hljs-string">'procedure B(), line: '</span> || $$PLSQL_LINE || <span class="hljs-keyword">chr</span>(<span class="hljs-number">13</span>) || <span class="hljs-keyword">chr</span>(<span class="hljs-number">10</span>) ||
                                                     <span class="hljs-string">'p_name_in: '</span> || p_name_in);<font></font>
        dbms_lock.sleep(3);<font></font>
        pk_util_log.close_level_success;<font></font>
    EXCEPTION<font></font>
        WHEN OTHERS THEN<font></font>
            pk_util_log.close_level_fail;<font></font>
            RAISE;<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
    PROCEDURE a(p_name_in IN VARCHAR2) IS<font></font>
    <span class="hljs-keyword">BEGIN</span>
        pk_util_log.open_next_level(p_action_name_in =&gt; <span class="hljs-string">'In procedure a()'</span>,<font></font>
                            p_comments_in =&gt; <span class="hljs-string">'procedure A(), line: '</span> || $$PLSQL_LINE || <span class="hljs-keyword">chr</span>(<span class="hljs-number">13</span>) || <span class="hljs-keyword">chr</span>(<span class="hljs-number">10</span>) ||
                                    <span class="hljs-string">'p_name_in: '</span> || p_name_in);<font></font>
        b('dummy_b');<font></font>
        dbms_lock.sleep(2);<font></font>
        pk_util_log.close_level_success;<font></font>
    EXCEPTION<font></font>
        WHEN OTHERS THEN<font></font>
            pk_util_log.close_level_fail;<font></font>
            RAISE;<font></font>
    <span class="hljs-keyword">END</span>;<font></font>
<font></font>
<span class="hljs-keyword">BEGIN</span>
    pk_util_log.start_logging(<span class="hljs-string">'sample_app_20200501'</span>);<font></font>
    dbms_output.put_line(pk_util_log.get_start_log_id);<font></font>
    a('dummy_a');<font></font>
    pk_util_log.stop_log_success;<font></font>
exception<font></font>
    when others then<font></font>
        pk_util_log.stop_log_fail;<font></font>
        raise;<font></font>
<span class="hljs-keyword">END</span>;<font></font>
/</code></pre><br>
<p>   <em>start_log_id</em>:</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> start_log_id <span class="hljs-keyword">from</span> log_instances <span class="hljs-keyword">where</span> log_instance_name = <span class="hljs-string">'sample_app_20200501'</span>;</code></pre><br>
<p>  start_log_id          :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">LPAD</span> (<span class="hljs-string">' '</span>, <span class="hljs-number">2</span>* (<span class="hljs-keyword">LEVEL</span>- <span class="hljs-number">1</span>)) || l.action_name <span class="hljs-keyword">as</span> action_name,<font></font>
    l.status,<font></font>
    l.start_ts,<font></font>
    l.end_ts,<font></font>
    l.comments<font></font>
<span class="hljs-keyword">FROM</span><font></font>
    tech_log_table l<font></font>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">WITH</span> l.log_id = <span class="hljs-number">204</span> <span class="hljs-comment">/*start_log_id*/</span>
<span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">BY</span>
    l.parent_log_id = <span class="hljs-keyword">PRIOR</span> l.log_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">SIBLINGS</span> <span class="hljs-keyword">BY</span>
    l.log_id <span class="hljs-keyword">ASC</span>;</code></pre><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>ACTION_NAME</th>
<th>STATUS</th>
<th>START_TS</th>
<th>END_TS</th>
<th>COMMENTS</th>
</tr>
</thead>
<tbody>
<tr>
<td>sample_app_20200501</td>
<td>C</td>
<td>2020-05-01 16:37:46.753168</td>
<td>2020-05-01 16:37:51.755380</td>
<td>NULL</td>
</tr>
<tr>
<td>In procedure a()</td>
<td>C</td>
<td>2020-05-01 16:37:46.753554</td>
<td>2020-05-01 16:37:51.754649</td>
<td>procedure A(), line: 19<br>
p_name_in: dummy_a</td>
</tr>
<tr>
<td>In procedure b()</td>
<td>C</td>
<td>2020-05-01 16:37:46.753869</td>
<td>2020-05-01 16:37:49.753746</td>
<td>procedure B(), line: 6<br>
p_name_in: dummy_b</td>
</tr>
</tbody>
</table></div><br>
<p>,     <em>a(p_name_in)</em>          <em>b(p_name_in)</em>. </p><br>
<h3 id="zachem-eto-nuzhno">  </h3><br>
<ol>
<li>    ,    , ,           .</li>
<li>   ,   ,  .         :       ,         .</li>
<li>     , ,  .       SQL  .         email    id    . </li>
</ol><br>
<p>   :</p><br>
<ol>
<li>DML   <em>log_table</em>    (<em>log_id</em>). <em>log_id</em>   sequence   Oracle,     .   sequence                .</li>
<li> <em>log_table</em>    ,        .    Oracle     ,       .     ,   .</li>
</ol><br>
<p> Oracle         ,      Java.           Java API.</p><br>
<h2 id="ierarhicheskoe-logirovanie-v-java">   Java</h2><br>
<p>,      ,     .     PostgreSql     Oracle    Open Source.</p><br>
<p> ,       Connection      ,  Connection Pool   ( <em>HikariCP</em>).</p><br>
<p>           .  Java     thread'.     <em>ThreadLocal</em>,   <em>InheritableThreadLocal</em>,   thread     .</p><br>
<h3 id="api">API</h3><br>
<p> :</p><br>
<ul>
<li><em>public static void startLog(final String logInstanceName)</em></li>
<li><em>public static void openNextLevel(final String actionName, final String comments)</em></li>
<li><em>public static void stopLogSuccess()</em></li>
<li><em>public static void stopLogFail(final Exception exception)</em></li>
<li><em>public static void closeLevelSuccess()</em></li>
<li><em>public static void closeLevelFail(final Exception exception)</em></li>
</ul><br>
<p>:</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        <span class="hljs-keyword">try</span> {<font></font>
            LogUtils.startLog(<span class="hljs-string">"sample_app_20200501"</span>);<font></font>
            A a = <span class="hljs-keyword">new</span> A();<font></font>
            a.method1(<span class="hljs-string">"some string"</span>);<font></font>
            LogUtils.stopLogSuccess();<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            LogUtils.stopLogFail(e);<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">method1</span><span class="hljs-params">(String s)</span> </span>{
        <span class="hljs-keyword">try</span> {<font></font>
            LogUtils.openNextLevel(<span class="hljs-string">"method1"</span>, <span class="hljs-string">"Arguments: "</span> + s);<font></font>
            method2(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<font></font>
            LogUtils.closeLevelSuccess();<font></font>
            <span class="hljs-keyword">return</span> s;<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            LogUtils.closeLevelFail(e);<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> <span class="hljs-title">method2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i1, <span class="hljs-keyword">int</span> i2)</span> </span>{
        <span class="hljs-keyword">try</span> {<font></font>
            LogUtils.openNextLevel(<span class="hljs-string">"method2"</span>, <span class="hljs-string">"Arguments: "</span> + i1 + <span class="hljs-string">", "</span> + i2);<font></font>
            LogUtils.closeLevelSuccess();<font></font>
            <span class="hljs-keyword">return</span> i1 + i2;<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            LogUtils.closeLevelFail(e);<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
        }<font></font>
    }<font></font>
<font></font>
}</code></pre><br>
<p>    ,         <em>log_instances</em> id   (<em>start_log_id</em>)    .    PostgreSql    RECURSIVE WITH:</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>                <span class="hljs-keyword">as</span> <span class="hljs-keyword">level</span>,
           <span class="hljs-built_in">ARRAY</span> [l.log_id] <span class="hljs-keyword">AS</span> <span class="hljs-keyword">path</span>,<font></font>
           l.log_id,<font></font>
           l.action_name,<font></font>
           l.parent_log_id,<font></font>
           l.start_ts,<font></font>
           l.end_ts,<font></font>
           l.status,<font></font>
           l.comments,<font></font>
           l.exception_message<font></font>
    <span class="hljs-keyword">FROM</span> log_table l
    <span class="hljs-keyword">WHERE</span> l.log_id = ...
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> l.level + <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">level</span>,
           <span class="hljs-keyword">path</span> || l1.log_id,<font></font>
           l1.log_id,<font></font>
           l1.action_name,<font></font>
           l1.parent_log_id,<font></font>
           l1.start_ts,<font></font>
           l1.end_ts,<font></font>
           l1.status,<font></font>
           l1.comments,<font></font>
           l1.exception_message<font></font>
    <span class="hljs-keyword">FROM</span> log_table l1
             <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">log</span> l <span class="hljs-keyword">ON</span> l.log_id = l1.parent_log_id<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
       <span class="hljs-keyword">lpad</span>(<span class="hljs-string">' '</span>, (l.level - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>) || l.log_id <span class="hljs-keyword">as</span> log_id,<font></font>
       l.action_name,<font></font>
       l.start_ts,<font></font>
       l.end_ts,<font></font>
       l.end_ts - l.start_ts <span class="hljs-keyword">as</span> <span class="hljs-keyword">duration</span>,<font></font>
       l.status,<font></font>
       l.comments,<font></font>
       l.exception_message<font></font>
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">log</span> l
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> l.path, l.start_ts;</code></pre><br>
<h3 id="boilerplate-kod-i-aspect-oriented-programming">Boilerplate   Aspect Oriented Programming</h3><br>
<p>    ,   ,      ,     exception      :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    LogUtils.openNextLevel(...);<font></font>
    ...<font></font>
    LogUtils.closeLevelSuccess();<font></font>
} <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
    LogUtils.closeLevelFail(e);<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
}</code></pre><br>
<p> "" ,         .        code templates,     IDE            .      :   Aspect Oriented Programming (AOP).        ,     ,  AOP —    ,    (<em>cross-cutting concerns</em>).      , , .  AOP      (<em>advice</em>)  ,      (<em>pointcut</em>).  <em>pointcut</em>  <em>advice</em>  <em></em>.         ,      .      (<em>weave</em>)   : <em>compile-time</em>, <em>post-compile</em>, <em>load-time</em>.    <em>compile-time weaving</em>,   AOP  AspectJ.</p><br>
<p>,     <em>@LogToDb</em>,      ,   .     :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LogToDb {
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">suppressLogArgs</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">false</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">suppressLogResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">false</span></span>;<font></font>
}</code></pre><br>
<p>    :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogToDbAspect</span> </span>{
    <span class="hljs-meta">@Pointcut("@annotation(logToDb) &amp;&amp; execution(* *.*(..))")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">logToDbPointcut</span><span class="hljs-params">(LogToDb logToDb)</span> </span>{<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Around(value = "logToDbPointcut(logToDb)")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">around</span><span class="hljs-params">(ProceedingJoinPoint pjp, LogToDb logToDb)</span> <span class="hljs-keyword">throws</span> Throwable </span>{
        <span class="hljs-keyword">try</span> {<font></font>
            LogUtils.openNextLevel(pjp.getSignature().toShortString(),<font></font>
                    logToDb.suppressLogArgs() ? <span class="hljs-keyword">null</span> : AspectUtils.getArgsString(pjp.getArgs()));<font></font>
            Object result = pjp.proceed();<font></font>
            <span class="hljs-keyword">if</span> (!logToDb.suppressLogResult()) {<font></font>
                LogUtils.addComments(<span class="hljs-string">"\nResult: "</span> + result.toString());<font></font>
            }<font></font>
            LogUtils.closeLevelSuccess();<font></font>
            <span class="hljs-keyword">return</span> result;<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            LogUtils.closeLevelFail(e);<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>   boilerplate :</p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">method1</span><span class="hljs-params">(String s)</span> </span>{
    <span class="hljs-keyword">try</span> {<font></font>
        LogUtils.openNextLevel(<span class="hljs-string">"method1"</span>, <span class="hljs-string">"Arguments: "</span> + s);<font></font>
        LogUtils.addComments(<span class="hljs-string">"\nResult: "</span> + s);<font></font>
        LogUtils.closeLevelSuccess();<font></font>
        <span class="hljs-keyword">return</span> s;<font></font>
    } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
        LogUtils.closeLevelFail(e);<font></font>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<font></font>
    }<font></font>
}</code></pre><br>
<p>  :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@LogToDb</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">method1</span><span class="hljs-params">(String s)</span> </span>{
    <span class="hljs-keyword">return</span> s;<font></font>
}</code></pre><br>
<p>      :</p><br>
<ol>
<li> compile-time weaving    aspectjc. </li>
<li>aspectjc       ,      .   aspectjc    Lombok.      :</li>
</ol><br>
<pre><code class="plaintext hljs">[WARNING] You aren't using a compiler supported by lombok, so lombok will not work and has been disabled.<font></font>
Your processor is: org.aspectj.org.eclipse.jdt.internal.compiler.apt.dispatch.BatchProcessingEnvImpl<font></font>
Lombok supports: sun/apple javac 1.6, ECJ</code></pre><br>
<p>   lombok-maven-plugin,    aspectjc        lombok.</p><br>
<h2 id="itogi"></h2><br>
<p>       :</p><br>
<ol>
<li>    :<br>
<ul>
<li>    </li>
<li>exception</li>
<li>parent/child  (/)</li>
</ul></li>
<li>  :<br>
<ul>
<li> SQL     , </li>
<li>       ,   </li>
</ul></li>
<li>:<br>
<ul>
<li>   boilerplate </li>
<li>      </li>
</ul></li>
<li>   Java    :<br>
<ul>
<li>    .     DevOps       . </li>
<li>boilerplate       AOP,     ( ,   runtime).</li>
<li>,              . Connection pool,      ,      ,    —     .        .   DML       .</li>
</ul></li>
</ol><br>
<h2 id="ssylki"></h2><br>
<p>        GitHub:</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi Oracle:</font></font></p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/nikita-mospan/plsql-liquibase-utplsql/blob/master/src/main/resources/oracle/tech_user/packages/pk_util_log.pks</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/nikita-mospan/plsql-liquibase-utplsql/blob/master/src/main/resources/oracle/tech_user/packages/pk_util_log.pkb</font></font></a></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi Java:</font></font></p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/nikita-mospan/log-to-db</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id500642/index.html">Igrostroy: ambang batas untuk memasuki industri, spesialisasi dan kemungkinan pendapatan</a></li>
<li><a href="../id500644/index.html">Random Coffee Habr Edition - jaringan untuk komunitas IT</a></li>
<li><a href="../id500646/index.html">Memasak bytecode di dapur JVM</a></li>
<li><a href="../id500648/index.html">Apa model arsitektur kematangan perusahaan?</a></li>
<li><a href="../id500654/index.html">WebRTC di Android: cara mengaktifkan penyandian perangkat keras pada banyak perangkat</a></li>
<li><a href="../id500660/index.html">Sejarah pengembangan "awan" yang disederhanakan dan sangat singkat</a></li>
<li><a href="../id500666/index.html">Sertifikasi online Microsoft - Anda, ruang Anda, dan komputer Anda</a></li>
<li><a href="../id500668/index.html">Kontrol motor nirkabel dari Lego menggunakan Steam Controller</a></li>
<li><a href="../id500670/index.html">Bagaimana kami menciptakan produk kami. Bagian Satu, Penelitian</a></li>
<li><a href="../id500672/index.html">Kelanjutan aliran untuk penguji dan tidak hanya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>