<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 🤲🏻 👩‍🔧 Javaネイティブイメージ：ユーザビリティチェック 🍓 👐🏼 〽️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="少し前に、OracleはGraalVMプロジェクトの最初のリリース（https://www.graalvm.org/）をリリースしました。リリースにはすぐに番号19.0.0が割り当てられました。これは、プロジェクトが成熟していて、本格的なアプリケーションで使用する準備ができていることを納得させるため...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Javaネイティブイメージ：ユーザビリティチェック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454790/"><img src="https://habrastorage.org/webt/ge/3k/12/ge3k12jjimph6xn8zteg9n3olqo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し前に、OracleはGraalVMプロジェクトの最初のリリース（https://www.graalvm.org/）をリリースしました。リリースにはすぐに番号19.0.0が割り当てられました。これは、プロジェクトが成熟していて、本格的なアプリケーションで使用する準備ができていることを納得させるためです。このプロジェクトの一部：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substrate VM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Javaアプリケーションをネイティブの実行可能ファイル（およびC / C ++などで記述されたアプリケーションで接続できるネイティブライブラリ）に変換できるようにするフレームワークです。この機能はこれまでのところ実験的であると宣言されています。ネイティブJavaアプリケーションにはいくつかの制限があることにも注意する必要があります。ネイティブプログラムに含めるために使用されるすべてのリソースをリストする必要があります。リフレクションおよびその他の制限とともに使用されるすべてのクラスをリストする必要があります。完全なリストはここにリストされています。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネイティブイメージJavaの制限</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このリストを調査した結果、基本的に制限はそれほど重要ではなく、地獄の言葉よりも複雑なアプリケーションを開発することが不可能であったことが理解できます。</font><font style="vertical-align: inherit;">私はこの目標を設定しました。組み込みのWebサーバーがあり、データベースを使用し（ORMライブラリ経由）、Javaマシンがインストールされていないシステムで実行できるネイティブバイナリにコンパイルする小さなプログラムを開発します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu 19.04（Intel Core i3-6100 CPU @ 3.70GHz×4）で実験します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVMをインストールする</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GraalVMのインストールは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDKMAN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">簡単に実行でき</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">GraalVMインストールコマンド：</font></font><br>
<br>
<pre><code class="bash hljs">sdk install java 19.0.0-grl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これによりOpenJDK GraalVM CE 19.0.0がインストールされます。CEはCommunity Editionです。</font><font style="vertical-align: inherit;">Enterprise Edition（EE）もありますが、このエディションはOracle Technology Networkからダウンロードする必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リンクは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVMのダウンロード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページにあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GraalVMをインストールした後、GraalVMのguコンポーネントアップデートマネージャーを使用して、コンパイルサポートをネイティブバイナリにインストールしました-</font></font><br>
<br>
<pre><code class="bash hljs">gu install native-image</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての作業ツールが準備できました。これでアプリケーションの開発を開始できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シンプルなネイティブアプリケーション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビルドシステムとして、Mavenを使用します。</font><font style="vertical-align: inherit;">ネイティブバイナリを作成するために、mavenプラグインがあります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">native-image-maven-plugin</font></font></b><div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.oracle.substratevm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-image-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${graal.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>native-image<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">imageName</span>&gt;</span>nativej<span class="hljs-tag">&lt;/<span class="hljs-name">imageName</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">buildArgs</span>&gt;</span><font></font>
                    --no-server<font></font>
                <span class="hljs-tag">&lt;/<span class="hljs-name">buildArgs</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションのメインクラスを設定する必要があります。</font><font style="vertical-align: inherit;">これは、native-image-maven-pluginと従来の方法の両方で実行できます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maven-jar-plugin</font></font></b><div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>nativej.Startup<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインクラスを作成します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startup.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        System.out.println(<span class="hljs-string">"Hello world!"</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、mavenコマンドを実行してアプリケーションをビルドできます。</font></font><br>
<br>
<pre><code class="bash hljs">mvn clean package</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のマシンでネイティブバイナリをビルドすると、35秒かかります。</font><font style="vertical-align: inherit;">その結果、2.5 MBのバイナリファイルがターゲットディレクトリに取得されます。</font><font style="vertical-align: inherit;">プログラムは、Javaマシンがインストールされている必要がなく、Javaが欠落しているマシンで実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリリンク：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github：native-java-helloworld-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDBC Postgresドライバー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、シンプルなアプリケーションが機能し、「Hello world」が表示されます。</font><font style="vertical-align: inherit;">ソリューションは必要ありませんでした。</font><font style="vertical-align: inherit;">私は1つ上のレベルに移動しようとします。データベースからデータを要求するためにPostgres JDBCドライバーを接続します。</font><font style="vertical-align: inherit;">githabe GraalVM </font><font style="vertical-align: inherit;">の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はPostgresドライバーに関連するバグに遭遇しますが、GraalVMのリリース候補です。</font><font style="vertical-align: inherit;">それらはすべて修正済みとしてマークされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postgresql依存関係を接続します。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>42.2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースからデータを抽出するためのコードを書いています（最も単純なユーザープレートが作成されました）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startup.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> SQLException </span>{
        <span class="hljs-keyword">final</span> PGSimpleDataSource ds = <span class="hljs-keyword">new</span> PGSimpleDataSource();<font></font>
        ds.setUrl(<span class="hljs-string">"jdbc:postgresql://localhost/demo_nativem"</span>);<font></font>
        ds.setUser(<span class="hljs-string">"test"</span>);<font></font>
        ds.setPassword(<span class="hljs-string">"test"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">try</span> (<font></font>
                Connection conn = ds.getConnection();<font></font>
                Statement stmt = conn.createStatement();<font></font>
                ResultSet rs = stmt.executeQuery(<span class="hljs-string">"SELECT * FROM \"public\".\"user\""</span>);<font></font>
        ) {<font></font>
            <span class="hljs-keyword">while</span>(rs.next()){<font></font>
                System.out.print(<span class="hljs-string">"ID: "</span> + rs.getLong(<span class="hljs-string">"id"</span>));<font></font>
                System.out.println(<span class="hljs-string">", Name: "</span> + rs.getString(<span class="hljs-string">"name"</span>));<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はネイティブバイナリを収集し、すぐにビルドエラーが発生します</font><font style="vertical-align: inherit;">
。実際、ネイティブアプリケーションビルダーはビルドプロセス中にすべての静的フィールドを初期化します（特に指定がない限り）。クラスの依存関係を調べることでこれを行います。</font><font style="vertical-align: inherit;">私のコードはorg.postgresql.Driverを参照していないため、コレクターはそれをより適切に初期化する方法（ビルド時またはアプリケーションの起動時）を認識せず、ビルド時の初期化のために登録することを提案しています。</font><font style="vertical-align: inherit;">これは、エラーの説明に示されているように、native-image-maven-pluginプラグインのmaven引数に追加することで実行できます。</font><font style="vertical-align: inherit;">ドライバーを追加した後、org.postgresql.util.SharedTimerに関連する同じエラーが発生します。</font><font style="vertical-align: inherit;">繰り返しますが、私はそのようなビルドエラーを収集して発生します：</font></font><br>
<br>
<code>Error: No instances are allowed in the image heap for a class that is initialized or reinitialized at image runtime: org.postgresql.Driver. Try marking this class for build-time initialization with --initialize-at-build-time=org.postgresql.Driver<br>
</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>Error: Class initialization failed: org.postgresql.sspi.SSPIClient<br>
</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
修正に関する推奨事項はありません。しかし、クラスのソースを見ると、それがWindowsでのコードの実行に関連していることは明らかです。 Linuxでは、初期化（アセンブリ中に発生）はエラーで失敗します。初期化をアプリケーションの開始に延期する機会があります：--initialize-at-run-time = org.postgresql.sspi.SSPIClient。 Linuxでの初期化は行われず、このクラスに関連するエラーは発生しなくなります。構築引数：</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">buildArgs</span>&gt;</span><font></font>
    --no-server<font></font>
    --no-fallback<font></font>
    --initialize-at-build-time=org.postgresql.Driver<font></font>
    --initialize-at-build-time=org.postgresql.util.SharedTimer<font></font>
    --initialize-at-run-time=org.postgresql.sspi.SSPIClient<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">buildArgs</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリは1分20秒かかり始め、ファイルは最大11 MBに膨らみました。バイナリをビルドするためのフラグを追加しました。--no-fallbackは、インストールされているJavaマシンを必要とするネイティブバイナリの生成を禁止します。このようなバイナリは、コレクターがSubstrate VMでサポートされていないか、構成が必要な言語機能の使用を検出したが、まだ構成されていない場合に作成されます。私の場合、コレクターはJDBCドライバーでのリフレクションの潜在的な使用を発見しました。しかし、これは潜在的な使用のみであり、私のプログラムでは必要ないため、追加の構成は必要ありません（その方法は後で説明します）。ジェネレーターにlibcを静的にリンクさせる--staticフラグもあります。しかし、それを使用すると、ネットワーク名をIPアドレスに解決しようとすると、セグメンテーション違反でプログラムがクラッシュします。この問題の解決策を探しましたが、適切なものが見つからなかったため、プログラムの依存関係をlibcに残しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果のバイナリを実行すると、次のエラーが発生します。</font><font style="vertical-align: inherit;">
調査</font><font style="vertical-align: inherit;">の結果</font><font style="vertical-align: inherit;">、エラーの原因が特定されました。デフォルトでは、Postgresは楕円曲線を使用してTLS接続を確立します。 SubstrateVMには、TLSのそのようなアルゴリズムの実装は含まれていません。対応する未解決の問題</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">-SubstrateVMのシングルバイナリECC（ECDSA / ECDHE）TLSサポート</font></a><font style="vertical-align: inherit;">。いくつかの解決策があります。GraalVMパッケージからライブラリを配置します。アプリケーションの横にlibsunec.soを置き、Postgresサーバーでアルゴリズムのリストを構成し、楕円曲線アルゴリズムを除外するか、PostgresドライバーでTLS接続を無効にします（このオプションが選択されています）。</font></font><br>
<br>
<code>Exception in thread "main" org.postgresql.util.PSQLException: Could not find a java cryptographic algorithm: TLS SSLContext not available.<br>
</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="java hljs">dataSource.setSslMode(SslMode.DISABLE.value);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postgresとの接続を作成する際のエラーをなくしたので、ネイティブアプリケーションを起動し、実行してデータベースのデータを表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリリンク：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github：native-java-postgres-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIフレームワークと組み込みWebサーバー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複雑なJavaアプリケーションを開発する場合、通常、Spring Bootなどのある種のフレームワークを使用します。</font><font style="vertical-align: inherit;">しかし、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVMネイティブイメージサポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によるこの記事から判断する</font><font style="vertical-align: inherit;">と、ネイティブイメージでのSpring Bootの動作は、Spring Boot 5.3でのみ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">保証</font></a><font style="vertical-align: inherit;">されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、GraalVMネイティブイメージで動作する</font></a><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">主張</font></a><font style="vertical-align: inherit;">するすばらしい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Micronaut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレームワーク</font><font style="vertical-align: inherit;">があり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一般に、バイナリでアセンブルされるアプリケーションにMicronautを接続するために、特別な設定や問題解決は必要ありません。</font><font style="vertical-align: inherit;">実際、Substrate VMのリフレクションと接続リソースを使用するための多くの設定は、すでにMicronaut内で行われています。</font><font style="vertical-align: inherit;">ちなみに、同じ設定をアプリケーション内の設定ファイルMETA-INF / native-image / $ {groupId} / $ {artifactId} /native-image.properties（このような設定ファイルのパスはSubstrate VMで推奨されます）に配置できます。ファイルの内容：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">native-image.properties</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">Args = \<font></font>
  -H:+ReportUnsupportedElementsAtRuntime \<font></font>
  -H:ResourceConfigurationResources=${.}/resource-config.json \<font></font>
  -H:ReflectionConfigurationResources=${.}/reflect-config.json \<font></font>
  -H:DynamicProxyConfigurationResources=${.}/proxy-config.json \<font></font>
  --initialize-at-build-time=org.postgresql.Driver \<font></font>
  --initialize-at-build-time=org.postgresql.util.SharedTimer \<font></font>
  --initialize-at-run-time=org.postgresql.sspi.SSPIClient<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルresource-config.json、reflect-config.json、proxy-config.jsonには、接続リソース、リフレクション、および使用されるプロキシ（Proxy.newProxyInstance）の設定が含まれています。</font><font style="vertical-align: inherit;">これらのファイルは手動で作成するか、agentlib：native-image-agentを使用して取得できます。</font><font style="vertical-align: inherit;">native-image-agentを使用する場合は、エージェントを使用して（ネイティブバイナリではなく）通常のjarを実行する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
java -agentlib:native-image-agent=config-output-dir=output -jar my.jar<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、outputは、上記のファイルが配置されるディレクトリです。</font><font style="vertical-align: inherit;">この場合、リフレクションを使用してリソースを開き、プロキシを作成すると設定がファイルに書き込まれるため、プログラムを起動するだけでなく、プログラムでスクリプトを実行する必要もあります。</font><font style="vertical-align: inherit;">これらのファイルはMETA-INF / native-image / $ {groupId} / $ {artifactId}に配置して、native-image.propertiesで参照できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
logbackを使用してロギングを接続することにしました。logback-classicライブラリとlogback.xmlファイルに依存関係を追加しました。</font><font style="vertical-align: inherit;">その後、通常のjarをコンパイルし、native-image-agentを使用して実行しました。</font><font style="vertical-align: inherit;">プログラムが終了すると、必要な設定ファイル。</font><font style="vertical-align: inherit;">それらの内容を見ると、エージェントがlogback.xmlの使用を登録してバイナリにコンパイルしていることがわかります。</font><font style="vertical-align: inherit;">また、reflection-config.jsonファイルには、reflectionを使用するすべてのケースが含まれています。特定のクラスの場合、メタ情報はバイナリーに入ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、micronaut-http-server-nettyライブラリに依存関係を追加して、nettyベースの組み込みWebサーバーを使用し、コントローラーを作成しました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startup.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Controller("/hello")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{
    <span class="hljs-meta">@Get("/{name}")</span>
    <span class="hljs-meta">@Produces(MediaType.TEXT_PLAIN)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpResponse&lt;String&gt; <span class="hljs-title">hello</span><span class="hljs-params">(String name)</span> </span>{
        <span class="hljs-keyword">return</span> HttpResponse.ok(<span class="hljs-string">"Hello "</span> + name);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてメインクラス：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HelloController.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        Signal.handle(<span class="hljs-keyword">new</span> Signal(<span class="hljs-string">"INT"</span>), sig -&gt; System.exit(<span class="hljs-number">0</span>));<font></font>
<font></font>
        Micronaut.run(Startup.class, args);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、ネイティブバイナリの構築を試すことができます。</font><font style="vertical-align: inherit;">私の組み立てには4分かかりました。</font><font style="vertical-align: inherit;">実行してアドレス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http：// localhost：8080 / hello / userに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセスすると</font><font style="vertical-align: inherit;">、エラーが発生します。</font></font><br>
<br>
<pre><code class="plaintext hljs">{"_links":{"self":{"href":"/hello/user","templated":false}},"message":"More than 1 route matched the incoming request. The following routes matched /hello/user: GET - /hello/user, GET - /hello/user"}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正直なところ、これが発生する理由は完全には明らかではありませんが、突っ込んだ後、次の行が（エージェントによって作成された）resource-config.jsonファイルから削除されるとエラーが消えることがわかりました。</font></font><br>
<br>
<pre><code class="plaintext hljs">    {"pattern":"META-INF/services/com.fasterxml.jackson.databind.Module"}, <font></font>
    {"pattern":"META-INF/services/io.micronaut.context.env.PropertySourceLoader"}, <font></font>
    {"pattern":"META-INF/services/io.micronaut.http.HttpResponseFactory"}, <font></font>
    {"pattern":"META-INF/services/io.micronaut.inject.BeanConfiguration"}, <font></font>
    {"pattern":"META-INF/services/io.micronaut.inject.BeanDefinitionReference"}, <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Micronautがこれらのリソースを登録します。再登録すると、コントローラーの二重登録とエラーが発生するようです。</font><font style="vertical-align: inherit;">ファイルを修正した後、バイナリを再構築して実行すると、エラーは発生しなくなり、</font><font style="vertical-align: inherit;">「Hello user」</font><font style="vertical-align: inherit;">という</font><font style="vertical-align: inherit;">テキストが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http：// localhost：8080 / hello / userに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示さ</font><font style="vertical-align: inherit;">れ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインクラスで次の行を使用することに注意を向けたいです。</font></font><br>
<br>
<pre><code class="java hljs">Signal.handle(<span class="hljs-keyword">new</span> Signal(<span class="hljs-string">"INT"</span>), sig -&gt; System.exit(<span class="hljs-number">0</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Micronautが正しく完了するには、挿入する必要があります。</font><font style="vertical-align: inherit;">Micronautはシャットダウンするためのフックを掛けているという事実にもかかわらず、ネイティブバイナリでは機能しません。</font><font style="vertical-align: inherit;">対応する問題があり</font><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネイティブでShutdownhookが起動しない</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">修正済みとマークされていますが、実際には、Signalクラスを使用した回避策しかありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリリンク：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github：native-java-postgres-micronaut-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ORM接続</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JDBCは優れていますが、コードの繰り返し、無限のSELECTおよびUPDATEにはうんざりしています。</font><font style="vertical-align: inherit;">ある種のORMを接続することで、自分の人生を円滑に（または、どちらを見るかによって複雑に）しようとします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハイバネート</font></font></h4><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hibernateは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Javaの最も一般的なORMの1つであるため、</font><font style="vertical-align: inherit;">
最初に試すことにしました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、ビルドエラーのため、Hibernateを使用してネイティブイメージをビルドできませんでした。</font></font><br>
<br>
<pre><code class="plaintext hljs">Error: Field java.lang.reflect.Method.defaultValue is not present on type java.lang.reflect.Constructor. Error encountered while analysing java.lang.reflect.Method.getDefaultValue() <font></font>
Parsing context:<font></font>
	parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy.getAnnotationValues(AnnotationProxy.java:63)<font></font>
	parsing org.hibernate.annotations.common.annotationfactory.AnnotationProxy(AnnotationProxy.java:52)<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
対応する未解決の問題があります：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[native-image] Micronaut + Hibernateの結果、java.lang.reflect.Method.getDefaultValue（）の分析中にエラーが発生します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジョーク</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jOOQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を試すことにし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ネイティブバイナリをビルドすることができましたが、初期化するクラス（ビルドタイム、ランタイム）を指定したり、リフレクションを乱したりするなど、多くの設定を行う必要がありました。</font><font style="vertical-align: inherit;">結局のところ、アプリケーションが起動すると、jOOQはプロキシorg.jooq.impl.ParserImpl $ Ignoreをクラスorg.jooq.impl.Toolsの静的メンバーとして初期化するということになります。</font><font style="vertical-align: inherit;">また、このプロキシは、Substrate VM </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がまだサポートしていない</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MethodHandleを使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同様の未解決の問題は次のとおりです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[native-image] Micronaut + KafkaがMethodHandle引数を使用してネイティブイメージを構築できませんでした</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アパッチカイエン</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache Cayenneは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あまり一般的で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">はあり</font></a><font style="vertical-align: inherit;">ませんが、かなり機能的に見えます。</font><font style="vertical-align: inherit;">接続してみます。</font><font style="vertical-align: inherit;">データベーススキーマを記述するためのXMLファイルを作成しました。これらは手動で、またはCayenneModeler GUIツールを使用して、または既存のデータベースに基づいて作成できます。</font><font style="vertical-align: inherit;">pomファイルのcayenne-maven-pluginを使用して、データベーステーブルに対応するクラスのコード生成が実行されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cayenne-maven-plugin</font></font></b><div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.cayenne.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cayenne-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${cayenne.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span>src/main/resources/db/datamap.map.xml<span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">destDir</span>&gt;</span>${project.build.directory}/generated-sources/cayenne<span class="hljs-tag">&lt;/<span class="hljs-name">destDir</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>cgen<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、CayenneRuntimeFactoryクラスを追加して、データベースコンテキストファクトリを初期化します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CayenneRuntimeFactory.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Factory</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CayenneRuntimeFactory</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CayenneRuntimeFactory</span><span class="hljs-params">(DataSource dataSource)</span> </span>{
        <span class="hljs-keyword">this</span>.dataSource = dataSource;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ServerRuntime <span class="hljs-title">cayenneRuntime</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> ServerRuntime.builder()<font></font>
                .dataSource(dataSource)<font></font>
                .addConfig(<span class="hljs-string">"db/cayenne-test.xml"</span>)<font></font>
                .build();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HelloControllerコントローラー：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HelloController.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Controller("/hello")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerRuntime cayenneRuntime;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HelloController</span><span class="hljs-params">(ServerRuntime cayenneRuntime)</span> </span>{
        <span class="hljs-keyword">this</span>.cayenneRuntime = cayenneRuntime;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Get("/{name}")</span>
    <span class="hljs-meta">@Produces(MediaType.TEXT_PLAIN)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpResponse&lt;String&gt; <span class="hljs-title">hello</span><span class="hljs-params">(String name)</span> </span>{
        <span class="hljs-keyword">final</span> ObjectContext context = cayenneRuntime.newContext();<font></font>
<font></font>
        <span class="hljs-keyword">final</span> List&lt;User&gt; result = ObjectSelect.query(User.class).select(context);
        <span class="hljs-keyword">if</span> (result.size() &gt; <span class="hljs-number">0</span>) {<font></font>
            result.get(<span class="hljs-number">0</span>).setName(name);<font></font>
        }<font></font>
<font></font>
        context.commitChanges();<font></font>
<font></font>
        <span class="hljs-keyword">return</span> HttpResponse.ok(result.stream()<font></font>
                .map(x -&gt; MessageFormat.format(<span class="hljs-string">"{0}.{1}"</span>, x.getObjectId(), x.getName()))<font></font>
                .collect(Collectors.joining(<span class="hljs-string">","</span>)));<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、agentlibエージェント：native-image-agentを使用して、通常のjarとしてプログラムを起動し、使用されたリソースと反射に関する情報を収集しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブバイナリを収集して実行し、アドレス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http：// localhost：8080 / hello / user</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にアクセスして</font><font style="vertical-align: inherit;">エラーを取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">{"message":"Internal Server Error: Provider com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl not found"}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
agentlibが判明しました。native-image-agentは、このクラスの使用をリフレクションで検出しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手動でreflect-config.jsonファイルに追加しました：</font></font><br>
<br>
<pre><code class="plaintext hljs">{<font></font>
  "name":"com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl",<font></font>
  "allDeclaredConstructors":true<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、私はバイナリを収集し、それを開始し、Webページを更新して、別のエラーを取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">Caused by: java.util.MissingResourceException: Resource bundle not found org.apache.cayenne.cayenne-strings. Register the resource bundle using the option -H:IncludeResourceBundles=org.apache.cayenne.cayenne-strings.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすべてが明確です。提案されたソリューションに示されているように、設定を追加します。</font><font style="vertical-align: inherit;">再びバイナリを収集します（これは5分です）、何度もエラーを開始します。</font></font><br>
<br>
<pre><code class="plaintext hljs">No DataMap found, can't route query org.apache.cayenne.query.SelectQuery@2af96966[root=class name.voyachek.demos.nativemcp.db.User,name=]"}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はこのエラーをいじくり回さなければなりませんでした。ソースを調べて何度もテストした後、エラーの原因がorg.apache.cayenne.resource.URLResourceクラスのこの行にあることが明らかになりました。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLResource(<span class="hljs-keyword">new</span> URL(url, relativePath));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局のところ、Substrate VMは、baseとrelativePathに基づいて形成される必要があるURLではなく、baseとして示されるURLによってリソースをロードします。</font><font style="vertical-align: inherit;">次の問題について私が登録した</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">新しいURL（URLコンテキスト、文字列仕様）使用時の無効なリソースコンテンツ</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーが定義されたので、次善策を探す必要があります。</font><font style="vertical-align: inherit;">幸い、Apache Cayenneはかなりカスタマイズ可能なものでした。</font><font style="vertical-align: inherit;">独自のリソースローダーを登録する必要がありました：</font></font><br>
<br>
<pre><code class="java hljs">ServerRuntime.builder()<font></font>
                .dataSource(dataSource)<font></font>
                .addConfig(<span class="hljs-string">"db/cayenne-test.xml"</span>)<font></font>
                .addModule(binder -&gt; {<font></font>
                    binder.bind(ResourceLocator.class).to(ClassLoaderResourceLocatorFix.class);<font></font>
                    binder.bind(Key.get(ResourceLocator.class, Constants.SERVER_RESOURCE_LOCATOR)).to(ClassLoaderResourceLocatorFix.class);<font></font>
                })<font></font>
                .build();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが彼のコードです：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClassLoaderResourceLocatorFix.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderResourceLocatorFix</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ResourceLocator</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> ClassLoaderManager classLoaderManager;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassLoaderResourceLocatorFix</span><span class="hljs-params">(<span class="hljs-meta">@Inject</span> ClassLoaderManager classLoaderManager)</span> </span>{
        <span class="hljs-keyword">this</span>.classLoaderManager = classLoaderManager;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;Resource&gt; <span class="hljs-title">findResources</span><span class="hljs-params">(String name)</span> </span>{
        <span class="hljs-keyword">final</span> Collection&lt;Resource&gt; resources = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-number">3</span>);<font></font>
<font></font>
        <span class="hljs-keyword">final</span> Enumeration&lt;URL&gt; urls;
        <span class="hljs-keyword">try</span> {<font></font>
            urls = classLoaderManager.getClassLoader(name).getResources(name);<font></font>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ConfigurationException(<span class="hljs-string">"Error getting resources for "</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (urls.hasMoreElements()) {<font></font>
            resources.add(<span class="hljs-keyword">new</span> URLResourceFix(urls.nextElement()));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> resources;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLResourceFix</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLResource</span> </span>{<font></font>
<font></font>
        URLResourceFix(URL url) {<font></font>
            <span class="hljs-keyword">super</span>(url);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Resource <span class="hljs-title">getRelativeResource</span><span class="hljs-params">(String relativePath)</span> </span>{
            <span class="hljs-keyword">try</span> {<font></font>
                String url = getURL().toString();<font></font>
                url = url.substring(<span class="hljs-number">0</span>, url.lastIndexOf(<span class="hljs-string">"/"</span>) + <span class="hljs-number">1</span>) + relativePath;<font></font>
<font></font>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLResource(<span class="hljs-keyword">new</span> URI(url).toURL());<font></font>
            } <span class="hljs-keyword">catch</span> (MalformedURLException | URISyntaxException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CayenneRuntimeException(
                        <span class="hljs-string">"Error creating relative resource '%s' : '%s'"</span>,<font></font>
                        e,<font></font>
                        getURL(),<font></font>
                        relativePath);<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
線あり</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLResource(<span class="hljs-keyword">new</span> URL(url, relativePath));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
と取り換える：</font></font><br>
<br>
<pre><code class="java hljs">String url = getURL().toString();<font></font>
url = url.substring(<span class="hljs-number">0</span>, url.lastIndexOf(<span class="hljs-string">"/"</span>) + <span class="hljs-number">1</span>) + relativePath;
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLResource(<span class="hljs-keyword">new</span> URI(url).toURL());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バイナリー（70 MB）を収集して開始し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http：// localhost：8080 / hello / user</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にアクセスする</font><font style="vertical-align: inherit;">と、すべてが機能し、データベースのデータがページに表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリリンク：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github：native-micronaut-cayenne-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目標が達成されました。ORMを使用してデータベースにアクセスできるシンプルなWebアプリケーションが開発されました。</font><font style="vertical-align: inherit;">アプリケーションはネイティブバイナリにコンパイルされ、Javaマシンがインストールされていないシステムで実行できます。</font><font style="vertical-align: inherit;">数多くの問題があるにもかかわらず、私はフレームワーク、設定、および回避策の組み合わせを見つけて、動作するプログラムを取得できました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、Javaソースコードから通常のバイナリをコンパイルする機能はまだ実験段階です。</font><font style="vertical-align: inherit;">これは、問題が豊富であること、回避策を探す必要があることから明らかです。</font><font style="vertical-align: inherit;">しかし、結局のところ、それでも望ましい結果が得られることがわかりました。</font><font style="vertical-align: inherit;">何をもらったの？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javaマシンのないシステムで実行できる唯一の自己完結型ファイル（libcなどのライブラリへの依存関係があります）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開始時間は平均40ミリ秒ですが、通常のjarを開始するときは2秒です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
欠点の中でも、ネイティブバイナリのコンパイル時間が長いことに注意したいと思います。</font><font style="vertical-align: inherit;">私には平均5分かかりますが、コードを記述してライブラリを接続すると、おそらく増加します。</font><font style="vertical-align: inherit;">したがって、完全にデバッグされたコードに基づいてバイナリを作成することは理にかなっています。</font><font style="vertical-align: inherit;">さらに、ネイティブバイナリのデバッグ情報は、Gral VM-Enterprise Editionの商用版でのみ利用できます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454774/index.html">私たちは人生で最も有用なコードを書きましたが、それをゴミ箱に捨てました。私たちと一緒に</a></li>
<li><a href="../ja454776/index.html">フリーランスまたはオフィス？フリーランサーの反応</a></li>
<li><a href="../ja454778/index.html">本「機械学習：ビジネスのためのアルゴリズム」</a></li>
<li><a href="../ja454780/index.html">マイクロサービスについて知っていること</a></li>
<li><a href="../ja454788/index.html">慎重な投資家の武器：投資債券の公正価値を考慮する</a></li>
<li><a href="../ja454792/index.html">交換ソーティングアルゴリズムの比較</a></li>
<li><a href="../ja454804/index.html">マイクロテンプレートを使用してコンポーネントを作成する</a></li>
<li><a href="../ja454806/index.html">Cisco 200-125 CCNA v3.0のトレーニング。9日目。スイッチの物理的な世界。パート1</a></li>
<li><a href="../ja454808/index.html">宇宙船と宇宙について。途中で製品全体を変更してフィーチャーを作成する方法</a></li>
<li><a href="../ja454810/index.html">火星の新鮮な空気：CO2分子を曲げて酸素を得る</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>