<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👋🏿 🙇🏻 🤸🏾 Packer、Terraform、Ansible：1時間でのKubernetesクラスターのデプロイ 🧡 🧑🏿‍🤝‍🧑🏿 🤚🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、私の名前はAndrey Schukinです。大企業がサービスやシステムをCROCクラウドに移行するのを手伝っています。 SlermトレーニングセンターでKubernetesコースを運営しているサウスブリッジの同僚と一緒に、最近、お客様向けのウェビナーを実施しました。
 
 Pavel S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Packer、Terraform、Ansible：1時間でのKubernetesクラスターのデプロイ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/492616/"><img src="https://habrastorage.org/webt/0m/2c/zt/0m2cztx1saqv1v7e8a3mrliht_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは、私の名前はAndrey Schukinです。大企業がサービスやシステムをCROCクラウドに移行するのを手伝っています。 SlermトレーニングセンターでKubernetesコースを運営しているサウスブリッジの同僚と一緒に、最近、お客様向けのウェビナーを実施しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pavel Selivanovによる優れた講義から資料を取り、クラウドプロビジョニングツールを使い始めたばかりで、どこから始めればよいかわからない人のために投稿を書くことにしました。したがって、CROC Cloudのトレーニングとプロダクションで使用されるテクノロジーのスタックについてお話します。インフラストラクチャ管理への最新のアプローチ、多数のPacker、Terraform、Ansibleコンポーネント、および一緒にインストールするKubeadmツールについて話しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カットの下にはたくさんのテキストと設定があります。</font><font style="vertical-align: inherit;">資料が多いので投稿ナビを追加しました。</font><font style="vertical-align: inherit;">また、トレーニングの展開に必要なすべてのものを置く小さなリポジトリも用意しました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チキンに名前を付けないでください。</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">焼きたてのケーキは揚げたものより健康的です。</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーブンを始めます。</font><font style="vertical-align: inherit;">Packer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform-コードとしてのインフラストラクチャ</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">すべてのファイルを</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">含む</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター構造Kubernetes </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">リポジトリを</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">起動</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
 <a name="habracut"></a><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニワトリには名前を付けないでください</font></font></h2><br>
<img src="https://habrastorage.org/webt/j0/0w/v1/j00wv1h7pcevviakk2iocfleqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャ管理には多くの異なる概念があります。それらの1つはペット対と呼ばれます。牛、つまり「家畜に対するペット」。この概念は、インフラストラクチャに対する2つの相反するアプローチを説明しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気に入りの犬がいると想像してみてください。私たちは彼女の面倒を見て、彼を獣医に連れて行き、毛皮をとかします、そしてそれは一般的に他の多くの犬の中で私たちに独特です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のケースでは、鶏小屋があります。また、鶏肉、飼料、加熱の世話をし、最も快適な環境を作り出すよう努めています。それにもかかわらず、鶏は私たちにとっては面白くない資源であり、卵を産むというその機能を果たします。せいぜい、鶏を「常にセメントをつつく黒色の粉末」と呼んでいます。鶏が産卵を停止したり、足を壊したりした場合は、おそらくランチにおいしいスープが提供されます。実際、私たちは個々の鶏の運命を気にするのではなく、生産ライン全体としての鶏小屋について気にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ITでは、エンジニアのエントリしきい値を下げ、完全自動モードで複雑なクラスターを展開および維持できるツールが登場するとすぐに、同様のアプローチが適用され始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前は、少数のサーバーが監視され、手動で調整され、あらゆる方法で管理されていました。監視中、クトゥルフ、アイリス、ダゴンのサーバーからのログが点滅しました。伝統。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、仮想化が私たちの生活にしっかりと浸透し、LovecraftとStar Trekの作品からの名前が、より実用的な「vlg-vlt-vault01.company.ru」に取って代わりました。サーバーはたくさんありますが、サービスは多かれ少なかれ手動で引き上げ、必要に応じて各マシンの問題を排除しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、インフラストラクチャを維持するためのアプローチはプログラミングと完全に一致しています。</font><font style="vertical-align: inherit;">別のレベルの抽象化を追加し、個々のノードの問題を解消します。</font><font style="vertical-align: inherit;">それぞれに名前の代わりにフェースレスインデックスがあり、問題が発生した場合、仮想マシンは作業スナップショットから強制終了して起動します。</font><font style="vertical-align: inherit;">このアプローチを実装できるツールがあります。</font><font style="vertical-align: inherit;">私たちの場合、最初のツールはCROCクラウド、2番目のツールはTerraformです。</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">焼きたてのケーキは揚げ物よりも健康的です</font></font></h2><br>
<img src="https://habrastorage.org/webt/hs/pp/oa/hsppoaujv0lhrk0u3dt6ust0rry.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャ管理では、フリードとアプローチの2つのアプローチに違いがあります。焼き、つまり「焼き揚げ」。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Friedアプローチは、CentOS 7などの一般的なOSイメージがあることを意味します。次に、OSを展開した後、システムをターゲット状態にするために構成管理システムを使用します。たとえば、Ansible、Chef、Puppet、SaltStackを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特にサーバーがそれほど多くない場合、すべてが正常に動作します。大規模な展開が必要な場合、パフォーマンスの問題に直面します。何百ものサーバーが同時に、多くの新しいパッケージを展開する過程で、ネットワークリソース、CPU、RAM、IOPSを食い尽くし始めます。さらに、このプロセスはかなり長い間遅延する可能性があります。つまり、回路は完全に動作していますが、事故時のダウンタイムを最小限に抑えるという観点からはそれほど興味深いものではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bakedアプローチは、必要なパッケージをすべてインストールし、構成とその他すべてを構成した既製の「ベイク」OSイメージがあることを意味します。</font><font style="vertical-align: inherit;">出力には、いくつかの関数のパフォーマンスのためにシャープにされた抽象的なスナップショットテンプレートがあります。</font><font style="vertical-align: inherit;">このようなベイク処理されたイメージからインフラストラクチャを展開すると、大幅に時間が短縮され、ダウンタイムが最小限に抑えられます。</font><font style="vertical-align: inherit;">非常によく似たイデオロギーが多層のDockerイメージで使用されています。</font><font style="vertical-align: inherit;">コンテナを釘付け-新しいものを拾いました。</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーブンを始めます。</font><font style="vertical-align: inherit;">パッカー</font></font></h2><br>
<img src="https://habrastorage.org/webt/xw/mr/im/xwmrimtkl-6qvfcrae3xo4zdf7q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのインフラストラクチャでは、いくつかのハシコープ製品を使用していますが、その一部は非常に成功していることが判明しました。パッカーツールを使用して画像を準備およびベイクすることから魔法を始めましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packerは、JSONテンプレート、つまり「ベイク」仮想マシン（VM）として取得する必要のあるものの説明を含むテンプレートファイルを使用します。テンプレートを作成すると、ファイルがPackerに転送され、クラウドでサーバーを作成するために必要な権限が構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packerを使用すると、KVM、VirtualBox、Vagrant、AWS、GCP、Alibaba Cloud、OpenStackなどでローカルにVMを生成できます。AWSインターフェース、つまり、 AWS、CROC Cloudと連携します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なテンプレートを設定した後、PackerはクラウドでVM CROCを発生させ、それが開始するのを待ってから、「プロバイダー」が作業に入ります-プロビジョナー：イメージの準備を完了する必要があるユーティリティ。</font><font style="vertical-align: inherit;">私たちの場合、これはAnsibleですが、Packerは他のオプションを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VMの準備ができると、Packerはそのイメージを作成してCROCクラウドに配置し、同じイメージから他のVMを起動できるようにします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base.json構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルの先頭には、変数が宣言されているセクションがあります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"variables" : {<font></font>
 "source_ami_name": "{{env SOURCE_AMI_NAME}}",<font></font>
 "ami_name": "{{env AMI_NAME}}",<font></font>
 "instance_type": "{{env INSTANCE_TYPE}}",<font></font>
 "kubernetes_version": "{{env KUBERNETES_VERSION}}",<font></font>
 "docker_version": "{{env DOCKER_VERSION}}",<font></font>
 "subnet_id": "",<font></font>
 "availability_zone": "",<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの変数のメインセットは、settings.jsonファイルから設定されます。</font><font style="vertical-align: inherit;">また、頻繁に変化する変数は、Packerを起動して新しいイメージを構築するときに、コンソールから設定する方が便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下はビルダーセクションです：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"builders" : [<font></font>
 {<font></font>
  "type": "amazon-ebs",<font></font>
  "region": "croc",<font></font>
  "skip_region_validation": true,<font></font>
  "custom_endpoint_ec2": "https://api.cloud.croc.ru",<font></font>
  "source_ami": "",<font></font>
  "source_ami_filter": {<font></font>
   "filters": {<font></font>
    "name": "{{user `source_ami_name`}}"<font></font>
    "state": "available",<font></font>
    "virtualization-type": "kvm-virtio"<font></font>
     },<font></font>
...</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ターゲットクラウドとVMの起動方法について説明します。この場合、amazon-ebsタイプが宣言されていますが、PackerがCROCクラウドで動作するように、custom_endpoint_ec2の対応するアドレスが設定されていることに注意してください。私たちのインフラストラクチャは、Amazon Webサービスとほぼ完全に互換性のあるAPIを備えているため、このプラットフォームの既製の開発がある場合、ほとんどの場合、カスタムAPIエントリポイント</font><font style="vertical-align: inherit;">（この例では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.cloud.croc.ru）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を指定するだけ</font><font style="vertical-align: inherit;">で済みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
source_ami_filterセクションは別に注意する価値があります。</font><font style="vertical-align: inherit;">ここで、VMの初期イメージが設定され、必要な変更が行われます。</font><font style="vertical-align: inherit;">ただし、Packerでは、このイメージのAMI、つまりランダムな識別子が必要です。</font><font style="vertical-align: inherit;">この識別子が事前に知られることはほとんどなく、更新のたびに変化するため、ソースAMIは特定の値ではなく、変数source_ami_filterとして設定されます。</font><font style="vertical-align: inherit;">この場合、フィルターの決定パラメーターは画像の名前です。</font><font style="vertical-align: inherit;">この名前は、settings.jsonファイルを介して変数に設定されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、VM設定が定義されます。インスタンスのタイプ、プロセッサ、メモリサイズ、割り当てられたスペースなどが指定されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"instance_type": "{{user `instance_type`}}",<font></font>
"launch_block_device_mappings": [<font></font>
 {<font></font>
  "device_name": "disk1",<font></font>
  "volume_type": "io1",<font></font>
  "volume_size": "8",<font></font>
  "iops": "1000",<font></font>
  "delete_on_termination": "true"<font></font>
 }<font></font>
],</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
base.jsonに続くのは、このVMに接続するためのパラメーターです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"availability_zone": "{{user `availability_zone`}}",<font></font>
"subnet_id": "{{user `subnet_id`}}",<font></font>
"associate_public_ip_address": true,<font></font>
"ssh_username": "ec2-user",<font></font>
"ami_name": "{{user `ami_name`}}"<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでsubnet_idパラメータに注意することが重要です。</font><font style="vertical-align: inherit;">CROCクラウドでVMサブネットを指定しないと作成できないため、手動で設定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事前準備が必要なもう1つのパラメーターは、associate_public_ip_addressです。</font><font style="vertical-align: inherit;">VM Packerは作成後にAnsibleを介して必要な設定の適用を開始するため、白いIPアドレスを選択する必要があります。</font><font style="vertical-align: inherit;">この場合、AnsibleはSSH経由でVMに接続します。これには、白いIPアドレスまたはVPNが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後のセクションはプロビジョニング担当者です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"provisioners": [<font></font>
 {<font></font>
  "type": "ansible",<font></font>
  "playbook_file": "playbook.yml",<font></font>
  "extra_arguments": [<font></font>
   "--extra-vars",<font></font>
   "kubernetes_version={{user `kubernetes_version`}}",<font></font>
   "--extra-vars",<font></font>
   "docker_version={{user `docker_version`}}"<font></font>
   ]<font></font>
  }<font></font>
]</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらはプロバイダーです。つまり、Packerがサーバーを構成するときに使用するユーティリティです。</font><font style="vertical-align: inherit;">この場合、ansibleタイププロバイダーが使用されます。</font><font style="vertical-align: inherit;">以下はplaybook_fileパラメーターで、Ansibleロールと指定されたロールが適用されるホストを定義します。</font><font style="vertical-align: inherit;">追加のオプションextra_argumentsを以下に示します。これらは、Ansibleの起動時に、KubernetesおよびDockerのバージョンを送信します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CROCクラウドの準備</font></font></h3><br>
 <img src="https://habrastorage.org/webt/23/_s/uo/23_suoef0us5ia6kjgn8xteomba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定ファイルに加えて、すべての魔法が機能するように、クラウドコントロールパネルの側からいくつかのことを行う必要があります。</font><font style="vertical-align: inherit;">白いIPを選択して、デプロイ時に使用する有効なサブネットを作成する必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[アドレスを強調表示]をクリックします。</font><font style="vertical-align: inherit;">Packerは、必要なホワイトIPアドレスを独自に見つけます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[サブネットの作成]をクリックして、サブネットとマスクを指定します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブネットIDをコピーします。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この値をPacker起動コマンドのsubnet_idパラメータに挿入します。 </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/24/0w/gp/240wgpvzi8oyy6ixwzdj8cougqk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Packerを実行します。</font><font style="vertical-align: inherit;">彼は元のVMイメージを見つけてCROCクラウドにデプロイし、Ansibleの役割を実行します。</font><font style="vertical-align: inherit;">新しいVMは、「インスタンス」セクションのCROCクラウドに表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/aj/ui/olajuiprqljv50bi2opn4xlqcvs.png"> <br>
 <br>
<img src="https://habrastorage.org/webt/rq/0d/ri/rq0drint5cwvddjxbd7czcyfp9a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業が完了すると、PackerはVMをクラウドから削除し、その場所に既製のイメージを残します。イメージは[テンプレート]セクションにあります。</font><font style="vertical-align: inherit;">Kubernetesインフラストラクチャ全体がこのイメージから作成されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンシブル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前述のように、プレイブックパラメーターはAnsibleプロバイダーのパラメーターで渡されます。</font><font style="vertical-align: inherit;">playbook.ymlファイル自体は次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">- hosts: all<font></font>
  become: true<font></font>
<font></font>
  roles:<font></font>
  | - base</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルはすべてのホストでbaseの役割を実行する必要があることをAnsibleに転送します。</font><font style="vertical-align: inherit;">他の役割がある場合は、それらをリストとして同じファイルに追加できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本の役割では、1つのコマンドで既製のクラスターを取得できます。</font><font style="vertical-align: inherit;">main.ymlファイルは、このロールが正確に何をするかを示しています：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerリポジトリをシステムテンプレートに追加します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesリポジトリをシステムテンプレートに追加します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なパッケージをインストールします。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerデーモンを設定するためのディレクトリを作成します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daemon.json.j2構成ファイルに従ってマシンを構成します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">br_netfilterカーネルをロードします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">br_netfilterに必要なオプションが含まれています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DockerおよびKubeletコンポーネントが含まれています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VMでDockerを実行します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesの動作に必要なDockerイメージをダウンロードするコマンドを実行します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、インストールされたパッケージはvarsディレクトリのmain.ymlファイルに設定されます。</font><font style="vertical-align: inherit;">この例では、docker-ceパッケージと、Kubernetesが機能するために必要な3つのパッケージ、kubelet、kubeadm、kubectlをインストールします。</font></font><br>
<br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform-コードとしてのインフラストラクチャ</font></font></h2><br>
<img src="https://habrastorage.org/webt/o4/um/wi/o4umwitq-qh_zpwr0thmcmejis0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformは、クラウドオーケストレーション用のHashiCorpの非常に機能的なツールです。独自のHCL言語があり、HashiCorp VaultやConsulなど、会社の他の製品でよく使用されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本的な原理は、すべての構成管理システムと同様です。目的の状態を目的の形式で指定するだけで、システムはこれを達成するためのアルゴリズムを計算します。もう1つは、複雑なプレイブックでブラックボックスとして機能する同じAnsibleとは異なり、Terraformは分析に便利な形式で将来のアクションの計画を発行できることです。これは、複雑なインフラストラクチャの変更を計画するときに重要です。必要なアクションを計画した後、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terraform apply</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">実行する</font><font style="vertical-align: inherit;">と、Terraformがファイルに記述されているインフラストラクチャをデプロイします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packerと同様に、このツールはAWS、GCP、Alibaba Cloud、Azure、OpenStack、VMwareなどをサポートしています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトについて説明します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformディレクトリには、拡張子が.tfの一連のファイルがあります。</font><font style="vertical-align: inherit;">これらのファイルは、作業するインフラストラクチャのコンポーネントを記述しています。</font><font style="vertical-align: inherit;">プロジェクトを機能モジュールに分割します。</font><font style="vertical-align: inherit;">このような構造により、既成の便利なブロックからバージョン管理を制御し、各プロジェクトを組み立てやすくなります。</font><font style="vertical-align: inherit;">私たちのオプションでは、次の構造が適しています：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security_groups.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tpl</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main.tfファイルの構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドへのアクセスが構成されているmain.tfファイルから始めましょう。</font><font style="vertical-align: inherit;">特に、CROCクラウドと連携するようにTerraformを構成するいくつかのパラメーターが発表されています。</font></font><br>
<br>
<pre><code class="plaintext hljs">provider "aws" {<font></font>
 endpoints {<font></font>
  ec2 = "https://api.cloud.croc.ru"<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このファイルには、Terraformが個別に秘密鍵を作成し、その公開部分をすべてのサーバーにアップロードする必要があることが記述されています。</font><font style="vertical-align: inherit;">秘密鍵自体はTerraformの最後に発行されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "tls_private_key" "ssh" {<font></font>
 algorithm = "RSA"<font></font>
}<font></font>
resource "aws_key_pair" "kube" {<font></font>
 key_name = "terraform"<font></font>
 public_key = "${tls_private_key.ssh.public_key_openssh}"<font></font>
}<font></font>
output "ssh" {<font></font>
value = "${tls_private_key.ssh.private_key_pem}"<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tfファイルの構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルには、VMの起動に必要なネットワークコンポーネントが記述されています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">data "aws_availability_zones" "az" {<font></font>
 state = "available"<font></font>
}<font></font>
resource "aws_vpc" "kube" {<font></font>
 cidr_block = "${var.vpc_cidr}"<font></font>
}<font></font>
resource "aws_eip" "master" {<font></font>
 count = "1"<font></font>
 vpc = true<font></font>
}<font></font>
resource "aws_subnet" "private" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 count = "${length(data.aws_availability_zones.az.names)}"<font></font>
 cidr_block = "${var.private_subnet_cidr_list[count.index]}"<font></font>
 availability_zone = "${data.aws_availability_zones.az.names[count.index]}"<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformは2種類のコンポーネントを使用します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソース-作成する必要があるもの。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ-取得する必要があるもの。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、データパラメーターは、Terraformが指定されたクラウドのアベイラビリティーゾーンを受信する必要があることを示します。これらのアベイラビリティーゾーンは、利用可能な状態にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のパラメーターリソースは仮想プライベートクラウドの作成を説明し、次のパラメーターはElastic IPアドレスの作成を説明します。 Kubernetesクラスターの場合、Terraformを通じてこのIPアドレスを注文します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、各アクセシビリティゾーンで、現時点ではCROCに2つのクラウドサービスがあるため、独自のサブネットが作成されます。タイプaws_subnetのリソースが宣言され、生成されたaws_vpcのIDがこのパラメーターの一部として渡されます。ただし、このリソースのIDはまだ不明なので、作成されたリソースを参照し、IDフィールドの値を置き換えるaws_vpc.kube.idパラメーターを指定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成されるサブネットの数はクラウドアベイラビリティゾーンの数によって決まり、この数は時間の経過とともに変化する可能性があるため、このパラメーターは長さ変数（data.aws_availability_zones.az.names）を介して設定されます。つまり、dataパラメーターを介して受信されるアクセスゾーンのリストの長さです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の2つのパラメーターは、cidr_block（割り当てられたサブネット）と、このサブネットが作成されるアベイラビリティーゾーンです。</font><font style="vertical-align: inherit;">最後のパラメーターは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[count.index]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって宣言されたループのインデックスに従ってデータリストから値を取得する変数によっても設定されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Security_groups.tfファイル構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セキュリティグループは一種のクラウド用ファイアウォールであり、VM自体の内部ではなく、クラウドを使用して作成できます。</font><font style="vertical-align: inherit;">この場合、ファイアウォールは2つのルールを記述します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のルールは、kubeと呼ばれるセキュリティグループを作成します。</font><font style="vertical-align: inherit;">このセキュリティグループは、Kubernetesノードからのすべての発信トラフィックを許可し、ノードがインターネットに自由にアクセスできるようにするために必要です。</font><font style="vertical-align: inherit;">ノード自体のサブネットからKubernetesノードへのインバウンドトラフィックも許可されます。</font><font style="vertical-align: inherit;">したがって、Kubernetesノードは制限なしにノード間で動作できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のルールは、sshセキュリティグループを作成します。</font><font style="vertical-align: inherit;">任意のIPアドレスからKubernetesクラスターVMのポート22へのSSH接続を許可します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_security_group" "kube" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "kubernetes"<font></font>
 # Allow all outbound<font></font>
 egress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
 # Allow all internal<font></font>
 ingress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["${var.vpc_cidr}"]<font></font>
 }<font></font>
}<font></font>
resource "aws_security_group" "ssh" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "ssh"<font></font>
<font></font>
 # Allow all inbound<font></font>
 ingress {<font></font>
  from_port = 22<font></font>
  to_port = 22<font></font>
  protocol = "tcp"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マスターノード。</font><font style="vertical-align: inherit;">Master.tfファイルの構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
master.tfファイルには、いくつかのテンプレートとインスタンスの作成が記述されています。</font><font style="vertical-align: inherit;">特に、Kubernetesマスターインスタンスが作成されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ami変数は、VMのソースイメージのAMIを設定します。</font><font style="vertical-align: inherit;">次に、VMのタイプとVMが作成されるサブネットについて説明します。</font><font style="vertical-align: inherit;">サブネットを定義するとき、各アベイラビリティーゾーンでVMを作成するためにサイクルが再び使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、使用されるセキュリティグループとmain.tfファイルで指定されたキーが宣言されます。</font><font style="vertical-align: inherit;">user_dataフィールドには、一連のcloud-initスクリプトの実行が含まれており、その結果はVMに実装されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_instance" "master" {<font></font>
 count = "1"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"<font></font>
 disable_api_termination = false<font></font>
 instance_initiated_shutdown_behavior = "terminate"<font></font>
 source_dest_check = false<font></font>
 subnet_id = "${aws_subnet.private.*.id[count.index % length(data.aws_availability_zones.az.names)]}"<font></font>
 associate_public_ip_address = true<font></font>
 vpc_security_group_ids = [<font></font>
  "${aws_security_group.ssh.id}",<font></font>
  "${aws_security_group.kube.id}",<font></font>
 ]<font></font>
 key_name = "${aws_key_pair.kube.key_name}"<font></font>
 user_data = "${data.template_cloudinit_config.master.rendered}"<font></font>
 monitoring = "true"<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マスターノード。</font><font style="vertical-align: inherit;">クラウド初期化</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud-init</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はCanonicalが開発しているツールです。</font><font style="vertical-align: inherit;">VMの起動後に、クラウドインフラストラクチャで特定のコマンドセットを自動的に実行できます。</font><font style="vertical-align: inherit;">Terraformには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレートを使用してそれ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">統合する</font></a><font style="vertical-align: inherit;">ためのメカニズムがあり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VMで必要なすべてのものを「ベイク」することは不可能であるため、起動後、そのタイプに応じて、Kubernetesクラスターに参加するか、Kubernetesクラスターを初期化する必要があります。</font><font style="vertical-align: inherit;">master.tplと呼ばれるcloud-initファイルテンプレートでは、いくつかのアクションが実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Kubeadmの構成ファイルが記録されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">#cloud-config<font></font>
<font></font>
    write_files:<font></font>
    - path: etc/kubernetes/kubeadm.conf<font></font>
      owner: root:root<font></font>
      content:<font></font>
    ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.コマンドセットが実行されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィザードのIPアドレスは、生成された構成ファイルに書き込まれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesクラスターのマスターは、kubeadm initコマンドで初期化されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesクラスターでは、calicoオーバーレイネットワークはkubectl applyコマンドでインストールされます。</font></font></li>
</ul><br>
 <pre><code class="plaintext hljs">runcmd:<font></font>
         - sed -i "s/CONTROL_PLANE_IP/$(curl http://169.254.169.254/latest/meta-data-local-ipv4)/g" /etc/kubernetes/kubeadm.conf<font></font>
         - kubeadm init --config /etc/kubernetes/kubeadm.conf<font></font>
         - mkdir -p $HOME/.kube<font></font>
         - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
         - sudo chown $(id -u):$(id -g) $HOME/.kube/config<font></font>
         - kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VMの起動時にコマンドを実行した後、1つのマスターノードから稼働中のKubernetesクラスターを取得します。</font><font style="vertical-align: inherit;">残りのノードはこのマスターノードに参加します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常のノード。</font><font style="vertical-align: inherit;">node.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
node.tfファイルは、master.tfファイルに似ています。</font><font style="vertical-align: inherit;">ここでもリソースが作成されます。この場合はノードと呼ばれます。</font><font style="vertical-align: inherit;">唯一の違いは、マスターノードが単一のインスタンスで作成され、作成される作業ノードの数は、nodes_count変数を介して設定されることです。</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "aws_instance" "node" {<font></font>
 count = "${var.nodes_count}"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業ノードのcloud-initファイルは、kubeadm joinという1つのコマンドのみを実行します。</font><font style="vertical-align: inherit;">このコマンドは、送信した認証トークンを使用して、完成したマシンをKubernetesクラスターに接続します。</font></font><br>
<br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformを起動する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起動すると、Terraformはいくつかのモジュールを使用します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWSモジュール</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレートモジュール;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鍵生成を担当するTLSモジュール。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのモジュールはローカルマシンにインストールする必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform init terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコマンドとともに、必要なすべてのファイルが配置されているディレクトリが示されます。</font><font style="vertical-align: inherit;">初期化時に、Terraformは指定されたすべてのモジュールをダウンロードします。その後、terraform planコマンドを実行する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform plan -var-file terraform/vars/dev.tfvars terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformファイルのあるディレクトリに加えて、Terraformファイルで使用される変数の値を含むvar-fileが示されることに注意してください。</font><font style="vertical-align: inherit;">varsディレクトリには複数の.tfvarsファイルを含めることができます。これにより、Terraformファイルの1つのセットでさまざまなタイプのインフラストラクチャを管理できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dev.tfvarsファイル自体には、次の重要な変数が含まれています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_version（Kubernetesのインストール可能なバージョン）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_ami（Packerが作成したAMIイメージ）。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数の必要な値を設定した後、terraform planコマンドを実行します。その後、Terraformは、Terraformファイルに記述されている状態を実現するために必要なアクションのリストを表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリストを確認した後、提案された変更を適用します</font></font><br>
<br>
<code>terraform apply -auto-approve -var-file terraform/vars/dev.tfvars terraform/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。terraform planコマンドから、それはキーの存在によって識別されます-自動承認。これにより、行われた変更を確認する必要がなくなります。</font><font style="vertical-align: inherit;">このキーは省略できますが、その場合は各アクションを手動で確認する必要があります。</font></font><br>
<br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesクラスター構造</font></font></h2><br>
<img src="https://habrastorage.org/webt/zs/i-/c3/zsi-c326-ips2acfurg_trunzhm.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesクラスタは、管理機能を実行するマスターノードと、クラスタにインストールされたアプリケーションを実行する作業ノードで構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このシステムの動作を保証する4つのコンポーネントがマスターノードにインストールされています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETCD、つまりKubernetesデータベース</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APIサーバー。Kubernetesに情報を格納し、そこから情報を取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラーマネージャー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケジューラー </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業ノードに2つの追加コンポーネントがインストールされます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kube-proxy（Kubernetesクラスターでのネットワークルールの生成を担当）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubelet（Dockerデーモンにコマンドを送信してKubernetesクラスターでアプリケーションを実行する責任があります）。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノード間で、Calicoネットワークプラグインが機能します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタワークフロー図</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oz/ew/f3/ozewf310dnhdmnx2gg4ozhzb1rc.png"><br>
,      Kubernetes    replicaset.<br>
<br>
<ol>
<li>     API-,     ETCD.        .</li>
<li>API-      .</li>
<li>Controller-manager   API-   ,    «»,    .</li>
<li>Scheduler       .       ETCD  API-.</li>
<li>Kubelet  API-  Docker    .</li>
<li>Docker   .</li>
<li>Kubelet   API-   ,     .</li>
</ol><br>
 ,    Kubernetes  ,      .       ,           ,     YAML-.  ,   ,    API-.       .<br>
</div></div><br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クベアドム</font></font></h2><br>
<img src="https://habrastorage.org/webt/wd/sw/cu/wdswcujzvnx4ynnrbi_ec9c1gr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
言及する価値のある最後の要素はKubeadmです。</font><font style="vertical-align: inherit;">新しいKubernetesクラスターのデプロイは常に骨の折れるプロセスです。</font><font style="vertical-align: inherit;">各段階で、人的要因によるエラーのリスクがあり、多くのタスクは単に非常に日常的で長いです。</font><font style="vertical-align: inherit;">たとえば、ノード間でTLS暗号化の証明書を注ぎ込み、それらを最新の状態に保ちます。</font><font style="vertical-align: inherit;">ここで、基本的なテンプレート自動化のためのユーティリティが役に立ちます。</font><font style="vertical-align: inherit;">Kubeadmのトリックは、Kubernetesでの動作が正式に認定されていることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のことができます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての主要なクラスターコンポーネントをインストール、構成、および実行する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">証明書をローテーションして新しい証明書を書き出すなど、証明書を管理する。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタコンポーネントのバージョンを管理します（アップグレードおよびダウングレード）。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、Kubeadmは完全なKubernetesクラスタ管理システムではありませんが、Kubeadmユーティリティが実行されているノードでKubernetesを構成できる一種のビルディングブロックです。</font><font style="vertical-align: inherit;">つまり、必要なVMをすべて実行し、それらを構成して、すべてのノードでKubeadmを実行するオーケストレーションシステムが必要です。</font><font style="vertical-align: inherit;">Terraformが使用されるのは、これらの目的のためです。</font></font><br>
<br>
<a name="8"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのファイルを含むリポジトリ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、すべてのファイルと構成</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を1か所</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">に置いている</font></a><font style="vertical-align: inherit;">ので、より便利です。</font><font style="vertical-align: inherit;">プライベートクラウドが手元にないが、これらすべてのステップを自分で実行し、実際にデプロイメントをテストしたい場合は、cloud @ croc.ruまでご連絡ください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト用のデモ版を提供し、すべての問題についてアドバイスします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すぐに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいSlurm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が登場し、独自のクラスターを作成できます。</font><font style="vertical-align: inherit;">CROCプロモーションコードには10％の割引があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにKubernetesを使用している人のために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上級コースがあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">割引は同じです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同僚、Habraparserはコードのマークアップを壊します。</font><font style="vertical-align: inherit;">上記のリンクからGitHubからソースを取得してください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492600/index.html">WiFiルーターをホストするための準科学ガイド</a></li>
<li><a href="../ja492604/index.html">コルーチンを使用して非同期でビューを操作する</a></li>
<li><a href="../ja492606/index.html">大規模プロジェクトでのツールキットの問題</a></li>
<li><a href="../ja492608/index.html">大規模プロジェクトの配信機能</a></li>
<li><a href="../ja492612/index.html">装飾シーリングライトLeek Celebrity</a></li>
<li><a href="../ja492622/index.html">「いじめっ子、ウイスキーを持ってきて！」、またはアイルランド語のルーツを持つ英語の単語について</a></li>
<li><a href="../ja492626/index.html">セキュリティウィーク12：重大なSMBの脆弱性</a></li>
<li><a href="../ja492628/index.html">コロナウイルス患者数の信頼区間（死亡率の計算）</a></li>
<li><a href="../ja492632/index.html">隔離された中小企業：パニックは理性の敵</a></li>
<li><a href="../ja492636/index.html">効果があるとはどういう意味ですか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>