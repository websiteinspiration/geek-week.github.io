<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🎓 👨🏾‍🚀 🏴󠁧󠁢󠁥󠁮󠁧󠁿 SQLクエリを無効にするためのレシピ 🦂 📂 🍬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="数か月前、PostgreSQL クエリプランを解析および視覚化するパブリックサービスであるExplain.tensor.ruを発表しました。
 
 過去6,000回以上使用していますが、便利な機能の1つが気付かれない可能性があります。これらは次のような構造上のヒントです。
 
 
 
 それらを聞く...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SQLクエリを無効にするためのレシピ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数か月前、</font><font style="vertical-align: inherit;">PostgreSQL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">クエリプランを解析および視覚化</font></a><font style="vertical-align: inherit;">するパブリック</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">サービス</font></a><font style="vertical-align: inherit;">である</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><i><b><font style="vertical-align: inherit;">Explain.tensor.ru</font></b></i></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を発表</font></font><i><b><font style="vertical-align: inherit;"></font></b></i></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
過去6,000回以上使用していますが、便利な機能の1つが気付かれない可能性があります。これらは</font><font style="vertical-align: inherit;">次のような</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造上のヒント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/66/1s/jp661svgeudxc0wvgnzqoyjffbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらを聞くと、要求は「滑らかで滑らかになります」。 :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、真剣に、リソースの点で要求が遅くなり、「大食い」になる状況の多く</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は典型的なものであり、計画の構造とデータによって認識できます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、個々の開発者は自分の経験だけに頼って最適化オプションを探す必要はありません。ここで何が起こっているのか、何が原因であるの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして</font><b><font style="vertical-align: inherit;">解決策にどのように取り組むのかを</font></b><font style="vertical-align: inherit;">彼に伝えることができます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちがやった。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/br/mr/upbrmra7tcpkdnygwg0abfhbqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのケースを詳しく見てみましょう。どのようにしてそれらが決定され、どのような推奨事項がもたらされるかです。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トピックについてのより良い洞察を得るために、最初</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にPGConf.Russia 2020に関する私のレポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から対応するブロックを聞くことができ</font><font style="vertical-align: inherit;">、次に各例の詳細な分析に進むことができます。</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引「分類不足」</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックス交差（BitmapAnd）</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスのマージ（BitmapOr）</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不必要にたくさん読む</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スパーステーブル</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの「中央」から読み取る</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTE×CTE</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスクにスワップ（一時書き込み）</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無関係な統計</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「問題が発生しました」</font></font></a></li>
</ol><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jHqaLp040rY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<a name="01"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃1：インデックス「アンダーソーティング」</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアント「LLCベル」の最後の請求書を表示します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Limit<font></font>
   -&gt; Sort<font></font>
      -&gt; Index [Only] Scan [Backward] | Bitmap Heap Scan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドのソートに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
使用さ</font><b><font style="vertical-align: inherit;">れる</font></b><font style="vertical-align: inherit;">インデックスを使用</font><b><font style="vertical-align: inherit;">します</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">1</span> <span class="hljs-comment">--    </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  pk <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    "" </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/nn/u1/wp/nnu1wpmpqryyy3rrpmhpofv1izk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
インデックスによって100を超えるエントリが差し引かれ、その後ソートされ、1つだけ残った</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">こと</font></a><font style="vertical-align: inherit;">がすぐに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">わかり</font></a><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは修正します：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_cli_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli, pk <span class="hljs-keyword">DESC</span>); <span class="hljs-comment">--   </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/gv/ny/ni/gvnyniyvlmcsfk-f2qk4voomvzo.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
このような原始的なサンプルを使用した場合でも、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">測定値は8.5倍速く、33倍少なくなります</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">効果は、各値に対して持つ「事実」が多いほど、よりはっきりとわかります</font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなインデックス</font><font style="vertical-align: inherit;">は、</font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並べ替え</font></font><code>pk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も</font><font style="vertical-align: inherit;">並べ替え</font><font style="vertical-align: inherit;">も行われなかった</font><font style="vertical-align: inherit;">他のクエリの前のインデックスよりも「プレフィックス」として機能することに注意してください</font><font style="vertical-align: inherit;">（これについての詳細</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、非効率的なインデックスの検索に関する私の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で確認でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">特に、</font><font style="vertical-align: inherit;">このフィールドの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明示的な外部キー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">通常どおり</font><b><font style="vertical-align: inherit;">サポートし</font></b><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<a name="02"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃2：インデックスの交差（BitmapAnd）</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NAOバターカップに代わって締結されたクライアントLLC Kolokolchikのすべての契約を表示します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapAnd<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースの両方からフィールドの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複合インデックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">
作成する</font><font style="vertical-align: inherit;">か、2番目のフィールドから既存のフィールドの1つを展開します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org); <span class="hljs-comment">--   foreign key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  (fk_org, fk_cli) = (<span class="hljs-number">1</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">--    </span></code></pre><br>
<img src="https://habrastorage.org/webt/dh/y4/mz/dhy4mzknpsqyk3ejuetev5mlmiy.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
正解：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_org_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli);
</code></pre><br>
<img src="https://habrastorage.org/webt/vt/nm/2c/vtnm2csqildllccdfsffjgxu4ya.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ビットマップヒープスキャン自体は非常に効果的であるため、ここではゲインは小さくなります。</font><font style="vertical-align: inherit;">しかし、それでも</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7倍速く、2.5倍少ない測定値</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<a name="03"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃3：インデックスプーリング（BitmapOr）</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
処理する最初の20個の最も古い「所有」または割り当てられていないアプリケーションとその優先順位を表示します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapOr<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION [ALL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">
使用して</font><font style="vertical-align: inherit;">、条件の各ORブロックのサブクエリを結合します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--   1:16  ""</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk); <span class="hljs-comment">--   "  " </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_own = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> <span class="hljs-comment">-- </span>
  fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">-- ...  ""</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
, (fk_own = <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  ""</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/7k/n2/d1/7kn2d1ko1hrbobs44a69hasatcs.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
正解：</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own = <span class="hljs-number">1</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">--   - 20,    </span></code></pre><br>
<img src="https://habrastorage.org/webt/pa/ej/2f/paej2f1lpkzhinvlz64tvf9n8ti.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最初のブロックで20の必要なすべてのレコードがすぐに受信されたという事実を利用したため、より「高価な」ビットマップヒープスキャンを使用した2番目のレコードは実行されませんでした。その結果</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、22倍速くなりました。読み取り値が44倍</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定の例を使用した</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この最適化方法の詳細について</font><font style="vertical-align: inherit;">は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのアンチパターン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の記事</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">：有害なJOINとOR</font></a><font style="vertical-align: inherit;">、および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのアンチパターン：名前による検索の反復的な絞り込み</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、または「最適化のあちらこちら」をご覧ください</font></a><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">SQLのハウツー</font></a><font style="vertical-align: inherit;">記事では、（const / NULLペアだけでなく）</font><b><font style="vertical-align: inherit;">いくつかのキーによる順序付けされた選択の</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
一般化されたバージョン</font><font style="vertical-align: inherit;">が検討さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れています。クエリでwhileループを直接記述するか、「基本的な3方向」</font></a><font style="vertical-align: inherit;">です。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></blockquote><br>
<a name="04"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃4：不必要にたくさん読む</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、既存のリクエストに「別のフィルターを固定する」場合に発生します。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「それと同じではありませんが、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真珠のボタン</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><i><font style="vertical-align: inherit;">あります</font></i><font style="vertical-align: inherit;">か？」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">映画「ダイヤモンドハンド」</font></font></i><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、上記のタスクを変更すると、目的に関係なく、最初の20個の最も古い「重要な」アプリケーションの処理が表示されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; 5 × rows &lt; RRbF --  &gt;80% <font></font>
   &amp;&amp; loops × RRbF &gt; 100 --     100  <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE句を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><b><font style="vertical-align: inherit;">し</font></b><font style="vertical-align: inherit;"> 
て[more]カスタム</font><b><font style="vertical-align: inherit;">インデックスを</font></b><font style="vertical-align: inherit;">作成する</font><font style="vertical-align: inherit;">か、インデックスに追加のフィールドを含めます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィルタリング条件がタスクに対して「静的」</font><font style="vertical-align: inherit;">である場合、つまり将来的に値</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リストを</font><b><font style="vertical-align: inherit;">拡張する必要がない</font></b><font style="vertical-align: inherit;">場合、WHEREインデックスを使用することをお勧めします。</font><font style="vertical-align: inherit;">さまざまなブール値/列挙型ステータスがこのカテゴリによく適合します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィルター条件</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が異なる値を取る可能性がある</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は、</font><font style="vertical-align: inherit;">上記のBitmapAndの場合のように、これらのフィールドを使用してインデックスを拡張することをお勧めします。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own<font></font>
, (random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">50</span>) <span class="hljs-keyword">critical</span>; <span class="hljs-comment">-- 1:50,   ""</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk);<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">critical</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ca/lg/hn/calghnldd9_313mns2a535sjwma.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
正解：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk)
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">critical</span>; <span class="hljs-comment">--  ""  </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/op/t2/u4/opt2u4yh2mzocmdot9qovn6pzgu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ご覧のとおり、フィルタリングは計画から完全に消え、リクエストは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5倍速くなりました</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="05"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃5：スパーステーブル</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブル上の多数のレコードの更新/削除によって多数の「デッド」レコードが発生する状況になると、処理タスクの独自のキューを作成するさまざまな試み。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM [FULL]を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
手動で手動で実行する</font><font style="vertical-align: inherit;">か</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、特定のテーブル</font></a><font style="vertical-align: inherit;">を含むパラメータを微調整することにより、</font><font style="vertical-align: inherit;">適切な頻繁な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動真空</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストを実行</font><font style="vertical-align: inherit;">し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの場合、これらの問題は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのアンチパターンで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明されているようなビジネスロジックから呼び出すときの構造化されていないクエリによって引き起こされ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、VACUUM FULLでさえも必ずしも役立つとは限らないことを理解する必要があります。</font><font style="vertical-align: inherit;">このような場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBAの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事のアルゴリズムをよく理解しておく必要があります</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。VACUUMが成功すると、テーブルを手動でクリーンアップします</font></a><font style="vertical-align: inherit;">。</font></font></blockquote><br>
<a name="06"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃6：インデックスの中央から読み取る</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは多くを読んでおらず、すべてインデックスで検索しているようで、余分なものは何もフィルタリングしていませんでした。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用するインデックスの構造とリクエストで指定されたキーフィールドをよく見てください。おそらく</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの一部が指定されていません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ほとんどの場合、同様のインデックスを作成する必要がありますが、プレフィックスフィールドがない</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か、それらの値を反復する方法を学習します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli); <span class="hljs-comment">--     #2</span>
<span class="hljs-comment">--      fk_cli      </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">999</span> <span class="hljs-comment">--  fk_org  ,     </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/tl/py/lb/tlpylbllwrea5ilsf-epratclha.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
インデックスでさえ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">すべて問題ない</font></a><font style="vertical-align: inherit;">ようですが、どういうわけか疑わしい-読み取った20レコードのそれぞれについて、4ページのデータ（レコードあたり32KB）を差し引かなければなりませんでしたか。</font><font style="vertical-align: inherit;">はい、インデックスの名前が</font><font style="vertical-align: inherit;">示唆的です。</font><font style="vertical-align: inherit;">
私たちは修正します：</font></font><code>tbl_<b>fk_org</b>_fk_cli_idx</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli);</code></pre><br>
<img src="https://habrastorage.org/webt/n9/5x/uz/n95xuzh7tcrmlv3eqg-bq2axhk4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
突然</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-10倍速く、4倍少なく読まれます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの非効率的な使用に関するその他の状況の例は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBAの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">「役に立たないインデックスの検索」にあり</font></a><font style="vertical-align: inherit;">ます。</font></font></blockquote><br>
<a name="07"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃7：CTE×CTE</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリでは</font><font style="vertical-align: inherit;">、さまざまなテーブルから</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「太い」CTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">入力</font></b><font style="vertical-align: inherit;">し、それらの間で行うことにしました</font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このケースは、v12より前のバージョンまたはからのリクエストに関連しています</font></font><code>WITH MATERIALIZED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; CTE Scan<font></font>
   &amp;&amp; loops &gt; 10<font></font>
   &amp;&amp; loops × (rows + RRbF) &gt; 10000<font></font>
      --     CTE<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを慎重に分析します- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでCTEは必要</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ですか？</font><font style="vertical-align: inherit;">すべて同じ場合</font><font style="vertical-align: inherit;">は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">PostgreSQLのアンチパターンで</font></a><font style="vertical-align: inherit;">説明されているモデルに従って</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、hstore / json</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><b><font style="vertical-align: inherit;">「ティアリング」を適用します</font></b><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重いJOINで辞書をヒット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="08"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃8：ディスクにスワップ（一時書き込み）</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多数のレコードの1回限りの処理（ソートまたは一意化）は、これに割り当てられたメモリに収まりません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; temp written &gt; 0</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作で使用されるメモリ量が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_mem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータの設定値を大幅に超えない場合は、</font><font style="vertical-align: inherit;">調整する価値があります。</font><font style="vertical-align: inherit;">あなたは誰でもすぐに設定に入ることができますが</font></font><code>SET [LOCAL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、特定のリクエスト/トランザクションを行う</font><font style="vertical-align: inherit;">ことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SHOW</span> work_mem;
<span class="hljs-comment">-- "16MB"</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  random()<font></font>
<span class="hljs-keyword">FROM</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/x-/mu/my/x-mumysko4noy3qy8qhdk0fecpq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
正解：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> work_mem = <span class="hljs-string">'128MB'</span>; <span class="hljs-comment">--   </span></code></pre><br>
<img src="https://habrastorage.org/webt/h0/4z/kx/h04zkxsgcscgj8yxdasba8jdi2s.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを参照]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
明らかな理由により、ディスクではなくメモリのみが使用されている場合、リクエストははるかに速く実行されます。</font><font style="vertical-align: inherit;">同時に、HDDからの負荷の一部も取り除かれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、大量のメモリを割り当てることも常に機能するわけではないことを理解する必要があります-それは誰にとっても十分ではありません。</font></font><br>
<br>
<a name="09"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃9：無関係な統計</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らはすぐに基地にたくさん注ぎましたが、追い払う時間はありませんでした</font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; ratio &gt;&gt; 10</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じことをしてください</font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この状況は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのアンチパターンで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">詳しく説明されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます。統計はあらゆるところにあり</font></a><font style="vertical-align: inherit;">ます。</font></font></blockquote><br>
<a name="10"></a><h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃10：「問題が発生しました」</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ起こるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
競合する要求によって強制されるロックが予期されていたか、十分なCPU /ハイパーバイザーハードウェアリソースがありませんでした。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認識する方法</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; (shared hit / 8K) + (shared read / 1K) &lt; time / 1000<font></font>
      -- RAM hit = 64MB/s, HDD read = 8MB/s<font></font>
   &amp;&amp; time &gt; 100ms --  ,   <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムを使用して、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーのロックや異常なリソース消費</font><b><font style="vertical-align: inherit;">を監視し</font></b><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">数百のサーバーを対象としたこのプロセスの編成のバージョンについては、すでに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">話し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">まし</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/bi/9s/tsbi9svuilrqhgpgftjytkknpk4.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h7/zm/6d/h7zm6d-va_yx8g0mtxbdkyevcwq.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492676/index.html">Saturn 5ロケットの磁気コアのメモリ</a></li>
<li><a href="../ja492678/index.html">Microsoft Dynamics 365 For Finance and Operationsのプラットフォームでの最初のプロジェクトの開発</a></li>
<li><a href="../ja492682/index.html">テストステロン、それが男性にとってなぜであるか、そして老年期に強度を維持する方法</a></li>
<li><a href="../ja492684/index.html">ドメイン認証を備えた企業向けの無料プロキシサーバー</a></li>
<li><a href="../ja492686/index.html">Linux conntrackがあなたの友達ではなくなったとき</a></li>
<li><a href="../ja492696/index.html">身分証明書の認識と処理のためのアルゴリズムを何をテストするか？</a></li>
<li><a href="../ja492700/index.html">Payment Request APIとAngularを使用したインターネット宣言型ショッピング</a></li>
<li><a href="../ja492702/index.html">機械翻訳。冷戦から現在まで</a></li>
<li><a href="../ja492704/index.html">インプラントの生存率を5〜7倍に高めるには、どうすればよいでしょうか。</a></li>
<li><a href="../ja492706/index.html">メモリアーカイブ：脳がどのようにメモリをエンコードおよび再現するか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>