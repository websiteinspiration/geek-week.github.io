<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦁 💐 🧒🏽 Sodinokibiランサムウェア：詳細な調査 👨🏼‍🔧 👨🏽‍🔬 👨‍👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sodinokibiランサムウェアが最近ニュースで話題になりましたが、このマルウェアの詳細に潜っている人はほとんどいません。今日は、ソディノキビについて詳しく知り、ランサムウェアの原理を検討して、情報システムを新しい脅威から保護するための優先ベクトルを特定します。
 
 
 
 テキストライター：ラ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sodinokibiランサムウェア：詳細な調査</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acronis/blog/462567/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sodinokibiランサムウェアが最近ニュースで話題になりましたが、このマルウェアの詳細に潜っている人はほとんどいません。</font><font style="vertical-align: inherit;">今日は、ソディノキビについて詳しく知り、ランサムウェアの原理を検討して、情報システムを新しい脅威から保護するための優先ベクトルを特定します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/o7/r6/owo7r6oqzz6yfcvxv_g0b7dpzs0.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストライター：ラビカントティワリとアレクサンダーコシェレフ</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソディノキビについて何を知っていますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiは、GandCrabファミリーのランサムウェアによる攻撃で知られている同じ攻撃者によって拡散されている可能性が高く、アンダーグラウンドフォーラムのレポートによると、今後は開発されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiは、Oracle WebLogicの脆弱性（CVE-2019-2725）を使用して、被害者のコンピュータにアクセスします。システムに入ると、マルウェアは拡張された権限で自分自身を実行し、PCのすべてのファイルとリソースに制限なしに</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセスしようとし</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。Sodinokibiは、イラン、ロシア、および旧ソ連の他の国のコンピュータに感染しないようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランサムウェアプログラムは、AESおよびSalsa20アルゴリズムを使用してユーザーファイルを暗号化します。 AESは、セッションキーと、管理サーバーに送信されるデータの暗号化に使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーファイルはSalsa20を使用して暗号化されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鍵を生成して配布するために、Sodinokibiは楕円曲線に対してDiffie-Hellmanアルゴリズムを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウイルスがマシンに入ると、バックアップフォルダからすべてのファイルが即座に削除されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、ランサムウェアは、暗号化されたファイルへのアクセスを復元するために0.32806964 BTC（≈2,500ドル）を要求しています。</font><font style="vertical-align: inherit;">さらに、身代金が4日以内に支払われない場合、恐喝者は金額を2倍にすることを約束します...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソディノキビはどのように機能しますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの研究室ではソディノキビの一例を研究しました。</font><font style="vertical-align: inherit;">ランサムウェアはカスタムパッカーによってパッケージ化されました。</font><font style="vertical-align: inherit;">同時に、アンパックが成功した後でも、コードに読み取り可能な行がありませんでした。</font><font style="vertical-align: inherit;">さらに、ソフトウェアはシステムライブラリやAPIをインポートしません。</font><font style="vertical-align: inherit;">したがって、読み込み可能な文字列とインポートされたAPIのテーブルに基づく署名を使用して静的なウイルス対策を検出することは非常に困難です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアがRC4アルゴリズムを使用して実行されている間に、API名およびその他のパラメーターが復号化されました。</font><font style="vertical-align: inherit;">アンチウイルスの検出をさらに困難にするために、このランサムウェアは文字列そのものではなく、DJBハッシュを使用して文字列に対して操作を実行します...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiは、動的インポートテーブルを作成することから始めます。まず、プログラムはミューテックスをチェックする方法によるシステム内の唯一のコピーであると確信しています。チェック後、プログラムファイルに格納されているRC4を使用してJSON設定を復号化し、「exp」キーのブール値をチェックします。その値が「true」の場合、Sodinokibiはエクスプロイトを起動しようとします。それは脆弱性を悪用する機能を実行してそれは、私たちのサンプルではそうだった。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/jl/1-/zgjl1-mazfcbijmbdjy-xzgwffw.png"><br>
<br>
<img src="https://habrastorage.org/webt/a3/mf/2d/a3mf2do1b2kblyq6nbu3us-vopi.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">復号化されたJSONの構成</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エクスプロイトを実行するコードは、2018年9月11日更新（KB4457138）がコンピューターにインストールされているかどうかを確認します。このパッチは、以下の脆弱性の多くに対処します。マシン上にない場合、ランサムウェアはマルウェアが実行されているプラ​​ットフォームに応じて、32ビットまたは64ビットのシェルコードを起動します。ランサムウェアは、CVE-2018-8440を使用して管理者に特権を昇格しようとしていると考えています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ge/cd/uk/gecduk1m7ga29wiioqmee4k-sjk.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スニペット1</font></font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
KB4457138パッチで修正される脆弱性のリスト</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KB4457138パッチで脆弱性が修正されます：</font></font><br>
<br>
<ul>
<li>CVE-2018-8457, CVE-2018-8335, CVE-2018-8424, CVE-2018-8455, CVE-2018-8468, CVE-2018-8447, CVE-2018-8475, CVE-2018-8271, CVE-2018-8440, CVE-2018-8464, CVE-2018-8469, CVE-2018-8421, CVE-2018-8442, CVE-2018-8367, CVE-2018-8443, CVE-2018-8465, CVE-2018-8419, CVE-2018-8466, CVE-2018-8410, CVE-2018-8467, CVE-2018-8462, CVE-2018-8452, CVE-2018-8446, CVE-2018-8449, CVE-2018-8420, CVE-2018-8433, CVE-2018-8438, CVE-2018-8435, CVE-2018-8456, CVE-2018-8354, CVE-2018-8434, CVE-2018-8470, CVE-2018-8332, CVE-2018-0965, CVE-2018-8315, CVE-2018-8439, CVE-2018-8392, CVE-2018-8425, CVE-2018-8393.</li>
</ul> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムに脆弱性が検出されず、プロセスが引き続き通常のユーザーとして機能する場合、RUNASコマンドを使用して別のインスタンスを起動しますが、管理者権限があり、制限付きの権限で動作している現在のインスタンスが完了します。完全な疑似コードは、以下のスクリーンショットに示されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ge/cd/uk/gecduk1m7ga29wiioqmee4k-sjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiが管理者モードで正常に起動すると、ソフトウェアは追加の予備チェックを実行し、JSON構成の「bro」キーの値を明確にして、ロケーションの国を見つけます。次の場所のパラメータがコンピュータ設定で設定されている場合、以下の国のコンピュータへの感染は試みません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i5/yv/2m/i5yv2m2hqz8lpaztizkchsrek-4.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言語IDの絞り込み例</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
外国のリスト</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーマニア、ロシア、ウクライナ、ベラルーシ、エストニア、ラトビア、リトアニア、タジキスタン、イラン、アルメニア、アゼルバイジャン、ジョージア、カザフスタン、キルギスタン、トルクメニスタン、ウズベキスタン、タタールスタン</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*編集者注：不明な理由により、著者はロシアのタタール語ロケールを明確に強調しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストに合格すると、マルウェアはMySQLファイルにアクセスして暗号化するために、mysql.exeプロセス（実行されている場合）を停止します。</font><font style="vertical-align: inherit;">その後、ランサムウェアはvssadminを使用してWindowsのシャドウコピーを削除し、bcdeditを使用してWindowsリカバリシステムを無効にします。</font></font><br>
<br>
<code>vssadmin.exe Delete Shadows /All /Quiet &amp; bcedit /set {default}<br>
recoveryenabled No &amp; bcedit /set {default} bootstatuspolice ignorealfailures</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーファイルを暗号化する前に、Sodinokibiはネットワークフォルダを含むすべてのファイルシステムを検索して、「backup」という名前のディレクトリを見つけ、それらを完全に削除します。</font><font style="vertical-align: inherit;">興味深いことに、マルウェアはディレクトリ自体を削除する前に、まずそのようなすべてのフォルダーのコンテンツをランダムなバイトのセットに置き換えて、原則として回復を不可能にします。</font><font style="vertical-align: inherit;">幸いなことに、Acronis Backupファイルは、特にランサムウェアがそのようなアクションを実行するのを防ぐためにカーネルレベルで保護されているため、削除することはできません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鍵の生成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SodinokibiはDiffie – Hellman Elliptic Curve Generation and Exchange Protocol（ECDH）を使用しています。生成されたセッションキーは対称暗号化アルゴリズムで使用され、さまざまな種類のデータがさまざまな方法（AESとSalsa20）を使用して暗号化されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AESは、ユーザーマシンでローカルに生成された秘密キーと公開キーのペアから秘密キーを暗号化するために使用されます。また、ネットワークを介した送信中にデータを暗号化します。 Salsa20は、ユーザーファイルの暗号化に使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiには2つの異なる公開鍵が含まれています。1つはJSON構成の一部で、もう1つはバイナリーに埋め込まれています。これらの公開鍵は、マシンで作成された秘密鍵の暗号化に使用されます。鍵の生成と暗号化の具体的な段階は次のとおりです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順1.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルマシン上の秘密鍵（秘密、乱数）と公開鍵からのセッションペアの生成。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/o7/s_/sso7s_-kmgvl8z8tqqecaufm7va.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルの秘密鍵と公開鍵の生成</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ステップ1の秘密鍵の暗号化は、JSON構成の公開鍵を使用して行われます</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">秘密鍵と公開鍵の別のペアの生成。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順2の秘密キーと公開キー（pkキー値）を使用して、JSONから公開キーを生成し、ハッシュ化した後、対称キーを取得します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lo/sp/af/lospafrq5cwhv1ucx8rq3cc6nem.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有キーを使用した対称キーの</font></font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ4.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16ビットIV（初期化ベクトル）の生成。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化ステップ3および4で得られたキーとIVとAESを使用して、ステップ1で生成した秘密鍵、</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の計算ステップ5で得られた暗号化された秘密鍵のためのCRC32 </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">付録IVをそして、CRC32ステップ5から暗号化された秘密鍵を含む緩衝液の最後に</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ8.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保存したオフセット（マーク「sk_key」）に関連付けられたファイルへのバッファを。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/tu/tp/aututpoxj74jy0shog3h30cms4m.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">攻撃者の公開鍵</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を使用したステップ1の秘密鍵の暗号化バイナリファイルに含まれる公開鍵を使用したステップ1の秘密鍵の暗号化。</font></font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順9.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順3でバイナリファイルに組み込まれた別の公開鍵を使用して手順</font><font style="vertical-align: inherit;">2〜7を</font><font style="vertical-align: inherit;">繰り返します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順10.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリオフセット（「0_key」のマーク）を付けて、関連ファイルにバッファを保存します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。sk_key、0_key、pk_keyはプログラムが受け取ったアクセス許可に応じて、レジストリ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HKLM \ SOFTWARE \ recfg \ sk_keyまたはHKCU \ SOFTWARE \ recfg \ sk_key</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HKLM \ SOFTWARE \ recfg \ 0_keyまたはHKCU \ SOFTWARE \ recfg \ 0_key</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HKLM \ SOFTWARE \ recfg \ pfg \ pfk HKCU \ SOFTWARE \ recfg \ pk_key</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/la/os/eylaoslusems6caly5ma0gwgez8.png"><i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリ内の暗号化された秘密キー</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salsa20を使用した個々のファイルのキーの生成</font></font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ11.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公開キーと秘密キーから新しいペアを生成します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ12.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2で作成したセッション公開鍵とハッシュを使用して共有鍵を生成し、Salsa20で鍵を生成するために必要な次の対称鍵を取得します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ13.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salsa20に256ビットキー（32バイト）をインストールする</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ14.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salsa20キーの8ビットIVを生成する</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ15.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salsa20キーを</font><font style="vertical-align: inherit;">生成する</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ16.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salsa20 key_stateを使用して、Salsa20を使用してユーザーファイルを暗号化する。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/xs/yq/ejxsyqwuteyfomfybfsrsdyolvc.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルごとにSalsa20キーを生成</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
する暗号化されたファイルごとに手順</font><font style="vertical-align: inherit;">11〜16を</font><font style="vertical-align: inherit;">繰り返します。</font></font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化と復号化の図</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
攻撃者と被害者のコンピュータ間でキーが生成および送信される方法をよりよく理解するには、Diffie Hellmanアルゴリズムがどのように機能するかを理解する必要があります。これは簡単に説明できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化プロセス</font></font></h3><br>
<img src="https://habrastorage.org/webt/h4/wy/v1/h4wyv1ghwh-gvjedkpk8r5efoa4.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">楕円曲線上のDiffie-Hellman鍵交換（ECDH）</font></font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_w/jh/j-/_wjhj-xhi3xqpklm437g5eicadu.png"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sodinokibiでの暗号化プロセスの詳細な説明</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
データを復号化するには、攻撃者の秘密鍵が必要です。</font><font style="vertical-align: inherit;">しかし、それらはどこにも公開されていないため、ファイルを復元することは不可能です。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/155/103/aed/155103aedec3a0a2df481b585b12e0e5.png" alt="画像"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">復号化プロセス（攻撃者の秘密は彼の秘密鍵です）</font></font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/533/3be/cc1/5333becc1ca07074b35d708cc402796f.png" alt="画像"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーファイルを復号化する簡略化されたプロセスを以下に示します。</font></font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルハードドライブとネットワークフォルダーのファイル暗号化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーファイルを暗号化するために、SodinokibiはI / O完了ポートを使用して複数の暗号化ストリームを起動しますが、マシン上のプロセッサコアの数の2倍以下であり、これらのストリームを特別に作成されたI / Oポートに関連付けます。これらのスレッドは、GetQueuedCompletionStatus Win API関数を使用して、パケットがI / Oポートに到着するのを待ってから、ファイルの暗号化を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ストリームが作成され、I / Oパケットが到着するのを待つとすぐに、Sodinokibiは、CDROMとRAMDISKを除くすべてのローカルドライブとすべてのネットワークフォルダー内のユーザーファイルの並べ替えを開始し、対応するI / O完了ポートに割り当てます。フォルダー、ファイル、拡張子の名前の例外のリストに該当しないすべてのファイルについて、AddFileToIoCompletionPort関数が呼び出され、次にPostQueuedCompletionStatusが実行を暗号化ストリームに渡します。これは、I / O完了ポートに関する情報を待ってファイルの暗号化を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AddFileToIoCompletionPort関数は、暗号化するファイルごとに一意のSalsa20キーも生成し、Salsa20キーを、PostQueuedCompletionStatus Win API関数のlpOverlappedパラメーターを使用して暗号化後に記録する必要がある他のメタデータと共に暗号化ストリームに渡します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ディレクトリのファイルを処理した後、例外を除いて、身代金要求のあるファイルが作成されます。暗号化するファイルが終了すると、ストリームはループに入り、暗号化および名前変更されたファイルの総数がI / O完了ポートに転送されたファイルの総数に達するまで待機します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、システムは、暗号化するファイルがもうないことを示すフラグを設定し、プロセスの完了を知らせるいくつかのI / Oパケットを送信します。</font><font style="vertical-align: inherit;">これにより、データを待っていた追加の暗号化ストリームの停止が実現されます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3ba/7a2/e30/3ba7a2e309a6402db2e6dd37adf44acc.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例外フォルダのリスト</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「$ windows。〜bt」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「インテル」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「プログラムファイル（x86）」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"プログラムファイル"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Msocache」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「$ recycle.bin」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「$ windows。〜ws」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「トールブラウザ」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ブート"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"システムボリューム情報"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Perflogs」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グーグル</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"アプリケーションデータ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ウィンドウズ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"プログラムデータ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Windows.old」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"アプリデータ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「モジラ」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルの例外</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Bootfont.bin」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Boot.ini」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Ntuser.dat」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Desktop.ini」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Iconcache.db」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ntldr</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Ntuser.dat.log」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Thumbs.db」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Bootsect.bak」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Ntuser.ini」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Autorun.inf」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拡張の例外</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「テーマパック」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDF</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scr</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「386」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Cmd」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「アニ」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「前売」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"テーマ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「MSI」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「RTP」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Diagcfg」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Msstyles」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"置き場"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Hlp」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高等学校</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drv</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Wpx」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「デスクテーマパック」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"コウモリ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ROM"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「MSC」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Lnk」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タクシー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Spl」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「PS1」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ムス」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IC</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"キー"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「MSP」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「コム」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sys</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「diagpkg」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Nls」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ダイアグキャブ」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イコ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ロック"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Ocx」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「MPA」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「キュア」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"モッド"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"EXE"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ICNS」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Prf」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Dll」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Nomedia」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なつ</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗号化ストリームは、ファイルのコンテンツの読み取り、暗号化、同じファイルへの書き戻し、暗号化されたセッション秘密鍵、各ファイルのECDHの公開部分、ファイルの暗号化に使用されるSalsa20初期化ベクトルなどのメタデータの追加を引き受けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、ストリームはファイルの名前を変更し、ランダムに生成された名前を名前に追加します。</font><font style="vertical-align: inherit;">ファイルは、EncryptAndWrite関数を使用してSalsa20アルゴリズムで暗号化されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、EncryptingThreadRoutine関数を呼び出す例です。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/585/d44/fab/585d44fab868f9461a5963dc1f6a9f72.png" alt="画像"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化後のファイル構造</font></font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/1ce/0a1/c4a/1ce0a1c4acd810503e66c32de66c0a93.png" alt="画像"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化されたファイルの構造</font></font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク活動</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗号化プロセスが完了すると、ランサムウェアは管理サーバーに送信するデータを準備します。</font><font style="vertical-align: inherit;">データには、JSON構成のさまざまなフィールド、システム情報、暗号化キーが含まれます。</font><font style="vertical-align: inherit;">準備されたデータは、キー「[HKLM | HKCU] \ SOFTWARE \ recfg \ stat」の下のレジストリにも書き込まれてから、AESによって暗号化されて攻撃者のサーバーに</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/177/c79/75b/177c7975bd8ed873554686cd35085dee.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信されます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_e/7-/nt/_e7-ntfpxprjff32wylpvkqbwou.jpeg"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。 +アドレス1の一部</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Wpコンテンツ」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"静的"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"コンテンツ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"含める"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「アップロード」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ニュース"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"データ"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「管理者」</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
住所2の一部</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「画像」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ピクチャー"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"画像"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「温度」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Tmp」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"グラフィック"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「資産」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写真</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ゲーム"</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/114/8c0/080/1148c0080da59e15820170215234c139.png" alt="画像"><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL生成</font></font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身代金の要求</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sodinokibiには、買い戻しリクエストを作成するためのテンプレートがあり、ユーザーデータ用のスペースが残されています。</font><font style="vertical-align: inherit;">これらは、名前、ユーザーID（uid-上記の説明）、およびキーを自動的に置き換えます。</font><font style="vertical-align: inherit;">買い戻しリクエストは、例外を除いて、各ディレクトリに配置されます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/386/32b/bd6/38632bbd6f4f0aee82221e912141f581.png" alt="画像"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解読</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/125/d73/54d/125d7354d290e43946bfdb96a5694c79.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このランサムウェアのデータを解読する無料の方法はありません。データを回復する唯一の方法は、攻撃者が提供する解読サービスを使用することです。</font><font style="vertical-align: inherit;">身代金要求の指示に従ってそれに行きます...</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/707/55b/adf/70755badfcf4a2f59b23e72cffc4cbec.png" alt="画像"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
高度なランサムウェア対策を使用し、ウイルス対策システムを最新の状態に保つことをお勧めします。</font><font style="vertical-align: inherit;">すべてのアクロニス製品にはランサムウェア保護が強化されており、このような攻撃からユーザーを保護して、データ損失のリスクを最小限に抑えることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイバー保護は、Acronis True Image 2019パーソナルソリューションとAcronis Backupビジネスシステムに含まれており、Acronis Active Protectionと呼ばれる人工知能に基づくマルウェア対策モジュールが付属しています。</font><font style="vertical-align: inherit;">これにより、どちらのシステムもユーザーをSodinokibiから保護することができます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462551/index.html">テストに関する開発者からのよくある質問</a></li>
<li><a href="../ja462553/index.html">シンプルについて少し。テスト設計。パート1</a></li>
<li><a href="../ja462555/index.html">ディスカッション：Cookieなしで機能する場合-代替案を教えてくれます</a></li>
<li><a href="../ja462563/index.html">ウェビナー「コンプライアンスを生き残る方法は？」規制要件を満たすための最善のアプローチ」</a></li>
<li><a href="../ja462565/index.html">CelonisによるSAP Process Miningのデータを準備する方法</a></li>
<li><a href="../ja462569/index.html">私たちと一緒の輸送システムまたは「アグリゲーターに対するバスステーション2」</a></li>
<li><a href="../ja462571/index.html">とらえどころのないマルヴァリの冒険：多彩な防御（最終的な考え）</a></li>
<li><a href="../ja462573/index.html">プロジェクトコンテスト：何を、なぜ、なぜ？</a></li>
<li><a href="../ja462575/index.html">セキュリティウィーク32：iMessageの穴、音声入力のプライバシー</a></li>
<li><a href="../ja462577/index.html">私のNim開発経験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>