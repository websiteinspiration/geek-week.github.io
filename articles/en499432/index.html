<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçî ‚ö∞Ô∏è ‚ùÑÔ∏è Autonomy of Unit Tests in PHPUnit ü§∞üèø üßëüèæ‚Äçü§ù‚Äçüßëüèª ü§≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone!
 
 

My name is Anton and now (not so long, about a year) I am developing in PHP in one big and old project. To ensure the quality of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Autonomy of Unit Tests in PHPUnit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499432/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone!</font></font><br>
</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My name is Anton and now (not so long, about a year) I am developing in PHP in one big and old project. To ensure the quality of the project, we use autotests on the PHPUnit framework. But, unfortunately, it so happened that most of our autotests are functional. Recently, we realized that if we continue to use autotests in the same way, then soon the time spent on solving problems with not passing them to CI will become more than the time spent writing useful code (actually not, but it grows and it‚Äôs not nicely).</font></font><br>
</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For a systematic solution to this problem, we chose an approach that involves writing a lot of unit tests and a minimum number of functional tests. </font><font style="vertical-align: inherit;">We also decided that as part of the changes to the existing code necessary according to the scout rule, update existing tests. </font><font style="vertical-align: inherit;">For a while - all this time we saw new features - everything was fine with us. </font><font style="vertical-align: inherit;">But recently, a task flew to me to fix a bug in the old code. </font><font style="vertical-align: inherit;">I started writing unit tests and realized that the ancient evil legacy woke up. </font><font style="vertical-align: inherit;">It became clear that this is the road to nowhere:</font></font><br>
<br>
</p><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrote a couple of test cases for several hours;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I realized that during this time I wrote a very, very many repeating code;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">didn't actually do any useful work;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the case of a change in DI, you will have to spend a lot of time on useless adaptation of the test code.</font></font></li>
</ul><br>
<p></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article is about how I solved the problem of refusing to write valueless code. </font><font style="vertical-align: inherit;">Under the cut - the final form of the test case, with the exception of most of the mechanical code</font></font></p><br>
<a name="habracut"></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The title of the article refers to automation in the kanban style - on the one hand, we performed automation, and on the other hand, all key decisions are made by a person.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How did</font></font></h2><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Company</span>\<span class="hljs-title">Bundle</span>\<span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Service</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit_Framework_MockObject_MockObject</span>;<font></font>
<font></font>
<span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
 * <span class="hljs-doctag">@method</span> \Company\Bundle\Service\TestedService getTestedClass()</span><font></font><span class="hljs-comment">
 * <span class="hljs-doctag">@property</span> PHPUnit_Framework_MockObject_MockObject|\Company\AnotherBundle\Repository\DependencyRepository $dependencyRepository</span><font></font><span class="hljs-comment">
 * <span class="hljs-doctag">@property</span> ConstDependencyInjectionParameter $diConstParam</span><font></font><span class="hljs-comment">
 */</span><font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestedServiceTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Intelligent_PHPUnit_Framework_TestCase</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@throws</span> \Exception</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_getData_DataDescripion_ResultDescription</span>(<span class="hljs-params"></span>): <span class="hljs-title">void</span></span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-comment">// data</span><font></font>
        <span class="hljs-keyword">$this</span><font></font>
            -&gt;diConstParam<font></font>
            -&gt;set(<span class="hljs-string">"value"</span>)<font></font>
        ;<font></font>
<font></font>
        <span class="hljs-comment">// behaviour</span><font></font>
        <span class="hljs-keyword">$this</span><font></font>
            -&gt;dependencyRepository<font></font>
            -&gt;expects(<span class="hljs-keyword">$this</span>-&gt;once())<font></font>
            -&gt;method(<span class="hljs-string">'findData'</span>)<font></font>
            -&gt;with(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>)<font></font>
            -&gt;will(<span class="hljs-keyword">$this</span>-&gt;returnValue([]))<font></font>
        ;<font></font>
<font></font>
        <span class="hljs-comment">// SUT</span><font></font>
        $clazz = <span class="hljs-keyword">$this</span>-&gt;getTestedClass();<font></font>
<font></font>
        <span class="hljs-comment">// act</span><font></font>
        $res = $clazz-&gt;getData();<font></font>
<font></font>
        <span class="hljs-comment">// asserts</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As it was</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was bad. </font><font style="vertical-align: inherit;">There was an endless spaghetti from the generation of mobs for dependencies, a lengthy call to the constructor in the test case. </font><font style="vertical-align: inherit;">In general, it was ugly, and somewhere at the bottom of the article a noticeably cropped example of such a test is given.</font></font><br>
</p><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of pain in our conditions</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, our project uses PHPUnit 3.x. </font><font style="vertical-align: inherit;">Yes, I know that it ceased to be supported even before the 2014 (!) Year, but, unfortunately, we cannot refuse it on a local time scale.</font></font><br>
</p><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolved Issues</font></font></h2><br>
<p>,    ‚Äî      ,    ,      .   ,   ‚Äî   (,  ,   20)    -, ,   ,      unit-       ,    .<br>
</p><br>
<p> , ,  ¬´  ¬ª  :<br>
<br>
</p><ol>
<li>       setUp.</li>
<li>     tearDown. ,   ,       </li>
<li>       -.</li>
</ol><br>
<p></p><br>
<h2>   </h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text">    - .    ,     .     ‚Äî       .     .  -   ,      .      ‚Ä¶<br>
</div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider repeating code fragments.</font></font></p><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mock Generation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duplicate code snippet:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">$this</span>-&gt;service = <span class="hljs-keyword">$this</span><font></font>
    -&gt;getMockBuilder(Service::class)<font></font>
    -&gt;disableOriginalConstructor()<font></font>
    -&gt;getMock()<font></font>
;<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP has a good candidate for hiding monotonous this monotonous work - a magic function:</font></font></p> <pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__get</font></font></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we still need to convey the type that we are wetting. </font><font style="vertical-align: inherit;">And then a suitable tool was found - phpDoc:</font></font></p> <pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@property Type $ service</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, especially taking into account the capabilities of modern IDEs, it turned out to be most convenient to set it in the following format: </font></font><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@property \ FQCN \ Service | \ PHPUnit_Framework_MockObject_MockObject $ service</font></font></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inside the __get function of the abstract class Intellegence_PHPUnit_Framework_TestCase, metaprogramming occurs, which parses phpDoc and forms mocks on its basis, which are available as $ this-&gt; propertyName in the test class. </font><font style="vertical-align: inherit;">Attention, all the code given in the article is a little pseudo-code, the full version is in the repository:</font></font><br>
</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Intelligent_PHPUnit_Framework_TestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span> </span>{<font></font>
   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $name</span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-comment">// propertyBag     ,        phpDoc property</span><font></font>
        $property = <span class="hljs-keyword">$this</span>-&gt;getPropertyBag()-&gt;get($name);<font></font>
        <span class="hljs-keyword">if</span> ($property === <span class="hljs-literal">false</span>) {<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"Invalid property name: ${name}"</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> $property;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPropertyBag</span>(<span class="hljs-params"></span>): <span class="hljs-title">PropertyBag</span></span><font></font><span class="hljs-function">
    </span>{<font></font>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;propertyBag === <span class="hljs-literal">null</span>) {<font></font>
               <span class="hljs-comment">//     </span><font></font>
               <span class="hljs-keyword">$this</span>-&gt;propertyBag = (<span class="hljs-keyword">new</span> DocCommentParser())<font></font>
                   -&gt;parse(<font></font>
                        <span class="hljs-comment">//    phpDoc   FQCN .   FQCN  ,      </span><font></font>
                        get_class(<span class="hljs-keyword">$this</span>),<font></font>
                        <span class="hljs-comment">//     callback,   getMockBuilder -     unit-</span><font></font>
                        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> $className</span>): <span class="hljs-title">PHPUnit_Framework_MockObject_MockObject</span> </span>{<font></font>
                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;createDefaultObjectMock($className);<font></font>
                        }<font></font>
                    );<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;propertyBag;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>  ,   phpDoc    .    :<br>
</p><br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocCommentParser</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> string $className</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> callable $mockCreator</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@throws</span> Exception</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@return</span> PropertyBag</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(</span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">string</span> $className,</span></span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">callable</span> $mockCreator</span></span><font></font><span class="hljs-function"><span class="hljs-params">
    </span>): <span class="hljs-title">PropertyBag</span> </span>{<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $res */</span><font></font>
        $r = <span class="hljs-keyword">new</span> ReflectionClass($className);<font></font>
        <span class="hljs-comment">//   phpDoc</span><font></font>
        $docComment = $r-&gt;getDocComment();<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ($docComment === <span class="hljs-literal">false</span>) {<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyBag([]);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;parseDocString($docComment, $mockCreator);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDocString</span>(</span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">string</span> $docComment,</span></span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">callable</span> $mockCreator</span></span><font></font><span class="hljs-function"><span class="hljs-params">
    </span>): <span class="hljs-title">PropertyBag</span> </span>{<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $map */</span><font></font>
        $map = [];<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $constructorParams */</span><font></font>
        $constructorParams = [];<font></font>
<font></font>
        <span class="hljs-comment">//   -  : property Type1|Type2 $propertyName</span><font></font>
        <span class="hljs-comment">//    mock,   DI     ,   </span><font></font>
        preg_match_all(<span class="hljs-string">'/@property\s*(?&lt;mock&gt;(\S*)\|(\S+)\s*\$(\S+))/'</span>, $docComment, $matches, PREG_SET_ORDER);<font></font>
        <span class="hljs-keyword">foreach</span> ($matches <span class="hljs-keyword">as</span> $match) {<font></font>
            <span class="hljs-keyword">if</span> (array_key_exists(<span class="hljs-string">'mock'</span>, $match) &amp;&amp; !<span class="hljs-keyword">empty</span>($match[<span class="hljs-string">'mock'</span>])) {<font></font>
                <span class="hljs-comment">//        -    </span><font></font>
                <span class="hljs-comment">//   </span><font></font>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isMockObject($match[<span class="hljs-number">2</span>])) {<font></font>
                    $map[$match[<span class="hljs-number">4</span>]] = $mockCreator($match[<span class="hljs-number">3</span>]);<font></font>
  <font></font>
                    <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isMockObject($match[<span class="hljs-number">3</span>])) {<font></font>
                    $map[$match[<span class="hljs-number">4</span>]] = $mockCreator($match[<span class="hljs-number">2</span>]);<font></font>
<font></font>
                    <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyBag($map);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>      ?  ,     ‚Äî   FQCN  phpDoc property   .    ‚Äî  ,     .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">  2</b>
                        <div class="spoiler_text">        .<br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">-</b>
                        <div class="spoiler_text"><h4></h4><br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> DependencyRepository|PHPUnit_Framework_MockObject_MockBuilder */</span><font></font>
    <span class="hljs-keyword">private</span> $repository;<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-built_in">parent</span>::setUp();<font></font>
        <span class="hljs-keyword">$this</span><font></font>
            -&gt;repository = <span class="hljs-keyword">$this</span>-&gt;getMockBuilder(DependencyRepository::class)<font></font>
            -&gt;disableOriginalConstructor()<font></font>
            -&gt;getMock()<font></font>
        ;    <font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-keyword">$this</span>-&gt;repository = <span class="hljs-literal">null</span>;<font></font>
        <span class="hljs-built_in">parent</span>::tearDown();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_test</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
         <span class="hljs-comment">// $this-&gt;repository = ...</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4></h4><br>
<pre><code class="php hljs"><span class="hljs-comment">/** <span class="hljs-doctag">@property</span> PHPUnit_Framework_MockObject_MockObject|\Company\AnotherBundle\Repository\DependencyRepository $repository */</span><font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Intelligent_PHPUnit_Framework_TestCase</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_test</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
         <span class="hljs-comment">// $this-&gt;repository = ...</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>     3-4-5 (   ) ‚Äî .   ,     , , 7  ‚Äî .   ,      20  ‚Äî   -.<br>
</p><br>
<h3>   </h3><br>
<p>      . !      -,  ,      .<br>
</p><br>
<p>  :<br>
</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_case</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
</span>{<font></font>
    <span class="hljs-comment">// SUT</span><font></font>
    <span class="hljs-comment">//   , ,    DI    .</span><font></font>
    <span class="hljs-comment">// ,      DI.</span><font></font>
    <span class="hljs-keyword">$this</span>-&gt;clazz = <span class="hljs-keyword">$this</span>-&gt;createTestClass(<font></font>
        $dependency1,<font></font>
        $dependency2,<font></font>
        $dependency3 <span class="hljs-comment">//, ...</span><font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<p>,                  .     php    __call,   phpDoc   method.<br>
</p><br>
<p>, ,           ?! ,       property!    ,       . <b> ,    property ‚Äî     .</b>    ‚Äî  ,      .<br>
</p><br>
<p>,     :</p><br>
<pre><code class="php hljs"><span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
 * <span class="hljs-doctag">@method</span> FQCN\TestedService getTestedClass()</span><font></font><span class="hljs-comment">
 */</span><font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceTest</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_case</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
         <span class="hljs-comment">// SUT</span><font></font>
         $clazz = <span class="hljs-keyword">$this</span>-&gt;getTestedClass();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>      __call:</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Intelligent_PHPUnit_Framework_TestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> GET_TESTED_CLASS_METHOD_NAME = <span class="hljs-string">'getTestedClass'</span>;<font></font>
<font></font>
    <span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> string $method</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> array $params</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@throws</span> Exception</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@return</span> object</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $method, <span class="hljs-keyword">array</span> $params</span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-keyword">if</span> ($method !== <span class="hljs-built_in">self</span>::GET_TESTED_CLASS_METHOD_NAME) {<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"Invalid method name: ${method}"</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!array_key_exists(<span class="hljs-built_in">self</span>::GET_TESTED_CLASS_METHOD_NAME, <span class="hljs-keyword">$this</span>-&gt;getMethodsMap())) {<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Method '</span> . <span class="hljs-built_in">self</span>::GET_TESTED_CLASS_METHOD_NAME . <span class="hljs-string">' not annotated'</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//  ,  PropertyBag        property -    </span><font></font>
        $params = <span class="hljs-keyword">$this</span>-&gt;getPropertyBag()-&gt;getConstructorParams();<font></font>
        $paramValues = [];<font></font>
        <span class="hljs-keyword">foreach</span> ($params <span class="hljs-keyword">as</span> $param) {<font></font>
            $property = <span class="hljs-keyword">$this</span>-&gt;__get($param);<font></font>
            $paramValues[] = $property;<font></font>
        }<font></font>
<font></font>
        $reflection = <span class="hljs-keyword">new</span> ReflectionClass(<span class="hljs-keyword">$this</span>-&gt;getMethodsMap()[<span class="hljs-built_in">self</span>::GET_TESTED_CLASS_METHOD_NAME]);<font></font>
        <span class="hljs-comment">//         </span><font></font>
        <span class="hljs-keyword">return</span> $reflection-&gt;newInstanceArgs($paramValues);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>  ?          property:</p><br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocCommentParser</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-comment">/**</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> string $className</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@param</span> callable $mockCreator</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@throws</span> Exception</span><font></font><span class="hljs-comment">
     * <span class="hljs-doctag">@return</span> PropertyBag</span><font></font><span class="hljs-comment">
     */</span><font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(</span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">string</span> $className,</span></span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">callable</span> $mockCreator</span></span><font></font><span class="hljs-function"><span class="hljs-params">
    </span>): <span class="hljs-title">PropertyBag</span> </span>{<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $res */</span><font></font>
        $r = <span class="hljs-keyword">new</span> ReflectionClass($className);<font></font>
        $docComment = $r-&gt;getDocComment();<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ($docComment === <span class="hljs-literal">false</span>) {<font></font>
            <span class="hljs-comment">//     </span><font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyBag([], []);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;parseDocString($docComment, $mockCreator);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDocString</span>(</span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">string</span> $docComment,</span></span><font></font><span class="hljs-function"><span class="hljs-params">
        <span class="hljs-keyword">callable</span> $mockCreator</span></span><font></font><span class="hljs-function"><span class="hljs-params">
    </span>): <span class="hljs-title">PropertyBag</span> </span>{<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $map */</span><font></font>
        $map = [];<font></font>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> string[] $constructorParams */</span><font></font>
        $constructorParams = [];<font></font>
<font></font>
        preg_match_all(<span class="hljs-string">'/@property\s*(?&lt;mock&gt;(\S*)\|(\S+)\s*\$(\S+))/'</span>, $docComment, $matches, PREG_SET_ORDER);<font></font>
        <span class="hljs-keyword">foreach</span> ($matches <span class="hljs-keyword">as</span> $match) {<font></font>
            <span class="hljs-keyword">if</span> (array_key_exists(<span class="hljs-string">'mock'</span>, $match) &amp;&amp; !<span class="hljs-keyword">empty</span>($match[<span class="hljs-string">'mock'</span>])) {<font></font>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isMockObject($match[<span class="hljs-number">2</span>])) {<font></font>
                    $map[$match[<span class="hljs-number">4</span>]] = $mockCreator($match[<span class="hljs-number">3</span>]);<font></font>
                    <span class="hljs-comment">//    </span><font></font>
                    $constructorParams[] = $match[<span class="hljs-number">4</span>];<font></font>
<font></font>
                    <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;isMockObject($match[<span class="hljs-number">3</span>])) {<font></font>
                    $map[$match[<span class="hljs-number">4</span>]] = $mockCreator($match[<span class="hljs-number">2</span>]);<font></font>
                    <span class="hljs-comment">//    </span><font></font>
                    $constructorParams[] = $match[<span class="hljs-number">4</span>];<font></font>
<font></font>
                    <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PropertyBag($map, $constructorParams);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<p>                  . ,      .   ,     DI   - ,  ,        ,     ‚Äî     ,       </p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">-</b>
                        <div class="spoiler_text"><h4></h4><br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span></span><font></font><span class="hljs-class">
</span>{<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> DependencyRepository|PHPUnit_Framework_MockObject_MockBuilder */</span><font></font>
    <span class="hljs-keyword">private</span> $repository;<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-built_in">parent</span>::setUp();<font></font>
        <span class="hljs-keyword">$this</span><font></font>
            -&gt;repository = <span class="hljs-keyword">$this</span>-&gt;getMockBuilder(DependencyRepository::class)<font></font>
            -&gt;disableOriginalConstructor()<font></font>
            -&gt;getMock()<font></font>
        ;    <font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-keyword">$this</span>-&gt;repository = <span class="hljs-literal">null</span>;<font></font>
        <span class="hljs-built_in">parent</span>::tearDown();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_test</span>(<span class="hljs-params"></span>)</span><font></font><span class="hljs-function">
    </span>{<font></font>
        <span class="hljs-keyword">$this</span>-&gt;clazz = <span class="hljs-keyword">$this</span>-&gt;createTestClass(repository);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTestClass</span>(<span class="hljs-params"></span>) </span>{<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestedService($repository)<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4></h4><br>
  ‚Äî   .   .<br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">  3</b>
                        <div class="spoiler_text">       <s> </s>    .<br>
</div>
                    </div><br>
<h3> </h3><br>
<p>           ConstDependencyInjectionParameter.          ,       .<br>
</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   </a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499418/index.html">The futurism we deserve</a></li>
<li><a href="../en499422/index.html">Teleport the process to another computer!‚Äâ</a></li>
<li><a href="../en499426/index.html">It seems to me that Russian VPS / VDS hosting comes from hell (and yes, we mow too)</a></li>
<li><a href="../en499428/index.html">Morpheus Red Cloud Management Tablet</a></li>
<li><a href="../en499430/index.html">Googled too?</a></li>
<li><a href="../en499434/index.html">How to implement knowledge management: benefit ‚Äúpouches‚Äù, ‚Äúparrot fines‚Äù and clip thinking</a></li>
<li><a href="../en499436/index.html">Remote-controlled enzyme will accelerate the treatment of strokes and spinal injuries</a></li>
<li><a href="../en499438/index.html">Stream for testers and not only</a></li>
<li><a href="../en499440/index.html">As we wrote the world's coolest autopilot for a shunting locomotive</a></li>
<li><a href="../en499442/index.html">Creating a Pseudo-3D Racing Game: Implementing the Hills and Finishing the Game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>