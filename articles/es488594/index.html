<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游깾 游볡 游븿 Pandas y otros para datos gruesos 游녝游 游뚞 游녲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art칤culo, hablar칠 sobre un par de trucos simples que son 칰tiles cuando se trabaja con datos que no caben en la m치quina local, pero que a칰n son...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pandas y otros para datos gruesos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488594/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este art칤culo, hablar칠 sobre un par de trucos simples que son 칰tiles cuando se trabaja con datos que no caben en la m치quina local, pero que a칰n son demasiado peque침os para ser llamados Grandes. </font><font style="vertical-align: inherit;">Siguiendo la analog칤a del idioma ingl칠s (grande pero no grande), llamaremos a este dato grueso. </font><font style="vertical-align: inherit;">Estamos hablando de tama침os de unidades y decenas de gigabytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[Descargo de responsabilidad] Si te encanta el SQL, todo lo que est치 escrito a continuaci칩n puede provocar emociones negativas brillantes, muy probablemente, en los Pa칤ses Bajos hay 49262 Tesla, 427 de ellos son taxis, mejor no seguir leyendo [/ Descargo de responsabilidad].</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-s/ac/gl/-sacgl0hwmynxnpiov5s_coofa4.png" alt="imagen"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El punto de partida fue </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un art칤culo sobre el centro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con una descripci칩n de un conjunto de datos interesante: una lista completa de veh칤culos registrados en los Pa칤ses Bajos, 14 millones de l칤neas, desde tractores de camiones hasta bicicletas el칠ctricas a velocidades superiores a 25 km / h. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El conjunto es interesante, toma 7 GB, </font><font style="vertical-align: inherit;">puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descargarlo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el sitio web de la organizaci칩n responsable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El intento de manejar los datos tal como est치n en los pandas para filtrarlos y limpiarlos termin칩 en un fiasco (춰se침ores de los h칰sares SQL, advert칤!). Los pandas cayeron por falta de memoria en el escritorio con 8 GB. Con un poco de derramamiento de sangre, la pregunta puede resolverse si recuerda que los pandas pueden leer archivos csv en piezas de tama침o moderado. El tama침o del fragmento en filas est치 determinado por el par치metro chunksize.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ilustrar el trabajo, escribiremos una funci칩n simple que haga una solicitud y determine cu치ntos autom칩viles Tesla hay en total y qu칠 proporci칩n de ellos trabajan en taxis. Sin trucos con lectura de fragmentos, una solicitud de este tipo primero consume toda la memoria, luego sufre durante mucho tiempo y, al final, la rampa se cae. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la lectura de fragmentos, nuestra funci칩n se ver치 as칤:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pandas_chunky_query</span>():</span>
    print(<span class="hljs-string">'reading csv file with pandas in chunks'</span>)<font></font>
    filtered_chunk_list=[]<font></font>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> pd.read_csv(<span class="hljs-string">'C:\Open_data\RDW_full.CSV'</span>, chunksize=<span class="hljs-number">1E+6</span>):<font></font>
        filtered_chunk=chunk[chunk[<span class="hljs-string">'Merk'</span>].isin([<span class="hljs-string">'TESLA MOTORS'</span>,<span class="hljs-string">'TESLA'</span>])]<font></font>
        filtered_chunk_list.append(filtered_chunk)<font></font>
    model_df = pd.concat(filtered_chunk_list)<font></font>
    print(model_df[<span class="hljs-string">'Taxi indicator'</span>].value_counts())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Al especificar un mill칩n de l칤neas perfectamente razonables, puede ejecutar la consulta en 1:46 y usar 1965 M de memoria en su punto m치ximo. Todos los n칰meros para un escritorio tonto con algo antiguo, de ocho n칰cleos, aproximadamente 8 GB de memoria y bajo el s칠ptimo Windows. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7d/id/0-/7did0-qetjm9v9wrlaouudevkss.png" alt="imagen"><br>
<br>
<img src="https://habrastorage.org/webt/8n/ch/go/8nchgo5c-tr54min7qwpfvgwuuq.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cambia chunksize, el consumo m치ximo de memoria lo sigue literalmente, el tiempo de ejecuci칩n no cambia mucho. Para l칤neas de 0.5 M, la solicitud toma 1:44 y 1063 MB, para 2M 1:53 y 3762 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La velocidad no es particularmente agradable, y menos a칰n es que leer el archivo en fragmentos hace que sea necesario escribir funciones adaptadas para esto, trabajando con listas de fragmentos que luego deben ensamblarse en un marco de datos. Adem치s, el formato csv en s칤 no es muy feliz, lo que ocupa mucho espacio y se lee lentamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como podemos conducir datos a una rampa, se puede usar un formato Apachev mucho m치s compacto para el almacenamiento</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parquet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donde hay compresi칩n y, gracias al esquema de datos, es mucho m치s r치pido de leer cuando se lee. Y la rampa es bastante capaz de trabajar con 칠l. Solo que ahora no puede leerlos en fragmentos. 쯈u칠 hacer? </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- 춰 </font><font style="vertical-align: inherit;">Divirt치monos </font><font style="vertical-align: inherit;">, toma el </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acorde칩n del bot칩n</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dask y acelera! </font></font></i><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dask!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un sustituto de la rampa fuera de la caja, capaz de leer archivos de gran tama침o, capaz de trabajar en paralelo en varios n칰cleos y utilizando c치lculos perezosos. Para mi sorpresa sobre Dask en Habr칠, solo hay 4 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publicaciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, tomamos el dask, introducimos el csv original en 칠l y con una conversi칩n m칤nima, lo llevamos al piso. Al leer, dask jura por la ambig칲edad de los tipos de datos en algunas columnas, por lo que los configuramos expl칤citamente (en aras de la claridad, lo mismo se hizo para la rampa, el tiempo de funcionamiento es mayor teniendo en cuenta este factor, el diccionario con dtypes se corta para mayor claridad en todas las consultas), el resto es para 칠l . Adem치s, para la verificaci칩n, realizamos peque침as mejoras en el piso, es decir, tratamos de reducir los tipos de datos a los m치s compactos, reemplazar un par de columnas con texto s칤 / no con booleanos y convertir otros datos a los tipos m치s econ칩micos (para el n칰mero de cilindros del motor, uint8 es definitivamente suficiente). Guardamos el piso optimizado por separado y vemos lo que obtenemos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que agrada cuando trabajamos con Dask es que no necesitamos escribir nada superfluo simplemente porque tenemos datos densos. Si no presta atenci칩n al hecho de que se importa el dask, y no la rampa, todo se ve igual que procesar un archivo con cien l칤neas en la rampa (m치s un par de silbatos decorativos para perfilar).</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dask_query</span>():</span>
    print(<span class="hljs-string">'reading CSV file with dask'</span>)
    <span class="hljs-keyword">with</span> ProgressBar(), ResourceProfiler(dt=<span class="hljs-number">0.25</span>) <span class="hljs-keyword">as</span> rprof:<font></font>
        raw_data=dd.read_csv(<span class="hljs-string">'C:\Open_data\RDW_full.CSV'</span>)<font></font>
        model_df=raw_data[raw_data[<span class="hljs-string">'Merk'</span>].isin([<span class="hljs-string">'TESLA MOTORS'</span>,<span class="hljs-string">'TESLA'</span>])]<font></font>
        print(model_df[<span class="hljs-string">'Taxi indicator'</span>].value_counts().compute())<font></font>
    rprof.visualize()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ahora compare el impacto del archivo fuente en el rendimiento cuando trabaje con dasko. Primero leemos el mismo archivo csv que cuando trabajamos con la rampa. Lo mismo sobre dos minutos y dos gigabytes de memoria (1:38 2096 Mb). Parecer칤a, 쯨ali칩 la pena besarse en los arbustos? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9a/oy/al/9aoyalzd1a62bw31uivvy699xme.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora alimente el tablero con un archivo de parquet no optimizado. La solicitud se proces칩 en aproximadamente 54 segundos, consumiendo 1388 MB de memoria, y el archivo en s칤 para la solicitud ahora es 10 veces m치s peque침o (aproximadamente 700 MB). Aqu칤 los bonos ya son visibles de forma convexa. La utilizaci칩n de la CPU de cientos de por ciento es la paralelizaci칩n en varios n칰cleos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1u/sz/_x/1usz_xafa2hng3nogb2fbp9zspm.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El parquet previamente optimizado con tipos de datos ligeramente modificados en forma comprimida es solo 1 MB menos, lo que significa que sin pistas todo se comprime de manera bastante eficiente. </font><font style="vertical-align: inherit;">El aumento de la productividad tampoco es particularmente significativo. </font><font style="vertical-align: inherit;">La solicitud tarda los mismos 53 segundos y consume un poco menos de memoria: 1332 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg칰n los resultados de nuestros ejercicios, podemos decir lo siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si sus datos son "gordos" y est치 acostumbrado a una rampa, el tama침o de trozo ayudar치 a la rampa a digerir este volumen, la velocidad ser치 soportable. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si desea obtener m치s velocidad, ahorre espacio durante el almacenamiento y no se est치 reteniendo con solo una rampa, entonces el anochecer con parquet es una buena combinaci칩n. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, sobre computaci칩n perezosa. Una de las caracter칤sticas del dask es que utiliza c치lculos perezosos, es decir, los c치lculos no se realizan inmediatamente como se encuentran en el c칩digo, sino cuando realmente son necesarios o cuando lo solicit칩 expl칤citamente utilizando el m칠todo de c치lculo. Por ejemplo, en nuestra funci칩n, dask no lee todos los datos en la memoria cuando le indicamos que lea el archivo. Los lee m치s tarde, y solo las columnas que se relacionan con la solicitud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto se ve f치cilmente en el siguiente ejemplo. </font><font style="vertical-align: inherit;">Tomamos un archivo prefiltrado en el que dejamos solo 12 columnas de las 64 iniciales, el parquet comprimido ocupa 203 MB. </font><font style="vertical-align: inherit;">Si ejecuta nuestra solicitud habitual, se ejecutar치 en 8.8 segundos, y el uso m치ximo de memoria ser치 de aproximadamente 300 MB, lo que corresponde a una d칠cima parte del archivo comprimido si lo supera en un csv simple. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jg/we/bq/jgwebqzk7enoz6z6rwiearbofgs.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le solicitamos expl칤citamente que lea el archivo y luego ejecute la solicitud, el consumo de memoria ser치 casi 10 veces mayor. </font><font style="vertical-align: inherit;">Modificamos ligeramente nuestra funci칩n al leer expl칤citamente el archivo:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dask_query</span>():</span>
    print(<span class="hljs-string">'reading parquet file with dask'</span>)
    <span class="hljs-keyword">with</span> ProgressBar(), ResourceProfiler(dt=<span class="hljs-number">0.25</span>) <span class="hljs-keyword">as</span> rprof:<font></font>
        raw_data=dd.read_parquet(<span class="hljs-string">'C:\Open_data\RDW_filtered.parquet'</span> ).compute()<font></font>
        model_df=raw_data[raw_data[<span class="hljs-string">'Merk'</span>].isin([<span class="hljs-string">'TESLA MOTORS'</span>,<span class="hljs-string">'TESLA'</span>])]
        <span class="hljs-comment">#print(model_df.head())</span>
        print(model_df[<span class="hljs-string">'Taxi indicator'</span>].value_counts())<font></font>
    rprof.visualize()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y esto es lo que obtenemos, 10.5 segundos y 3568 MB de memoria (!) </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w5/5w/aj/w55wajaohsdjyevm1hxbgpvns2a.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez m치s, estamos convencidos de que el desperdicio es competente en sus tareas, y no vale la pena </font><font style="vertical-align: inherit;">volver a meterse </font><font style="vertical-align: inherit;">en 칠l con la microgesti칩n una vez m치s.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es488584/index.html">Lo que querr치 saber antes de escribir una aplicaci칩n para Apple Watch: nuestra experiencia</a></li>
<li><a href="../es488586/index.html">The Ember Times - N칰mero 135</a></li>
<li><a href="../es488588/index.html">춰C ++ 20 aprobado! Qu칠 esperar y qu칠 preparar para los desarrolladores en C ++ 23</a></li>
<li><a href="../es488590/index.html">FOSS News No. 3 - Revisi칩n de noticias gratuitas y de c칩digo abierto del 10 al 16 de febrero de 2020</a></li>
<li><a href="../es488592/index.html">Una carta abierta de Mail.ru sobre el juego "Allods II: Lord of Souls"</a></li>
<li><a href="../es488596/index.html">Google ha desarrollado un algoritmo para recortar video autom치ticamente en objetos importantes en el marco</a></li>
<li><a href="../es488598/index.html">쮼st치 preparado el mundo para una pandemia?</a></li>
<li><a href="../es488600/index.html">C칩mo se preocupan los proveedores por la seguridad del cliente</a></li>
<li><a href="../es488602/index.html">MEETUP # 2 de iOS de FUNCORP y C칩mo mantener actualizado a un desarrollador</a></li>
<li><a href="../es488604/index.html">El resumen de materiales frescos del mundo del front-end para la 칰ltima semana No. 402 (10 al 16 de febrero de 2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>