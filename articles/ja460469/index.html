<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👸🏻 😟 🕦 3proxyとiptables / netfilterを使用した透過プロキシの基本、または「すべてをプロキシ経由にする」方法 🌦️ 🧜🏽 🤚🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、透過プロキシの可能性を明らかにしたいと思います。これにより、外部プロキシサーバーを介してトラフィックの全部または一部をまったく気付かれることなくリダイレ​​クトできます。
 
 この問題を解決し始めたとき、その実装に重要な問題が1つあるという事実に直面しました。HTTPSプロトコルです...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>3proxyとiptables / netfilterを使用した透過プロキシの基本、または「すべてをプロキシ経由にする」方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460469/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、透過プロキシの可能性を明らかにしたいと思います。これにより、外部プロキシサーバーを介してトラフィックの全部または一部をまったく気付かれることなくリダイレ​​クトできます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決し始めたとき、その実装に重要な問題が1つあるという事実に直面しました。HTTPSプロトコルです。古き良き時代、透過的なHTTPプロキシには特別な問題はありませんでしたが、HTTPSをプロキシすると、ブラウザはプロトコルの干渉を報告し、そこから幸福は終わります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロキシサーバーへの一般的な指示では、Squidは独自の証明書を生成してクライアントにインストールすることさえ提案しますが、これは</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まったくナンセンスです</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少なくとも不合理で、MITM攻撃のように見えます。</font><font style="vertical-align: inherit;">私はSquidがすでにこのようなことを行うことができることを知っていますが、この記事は、尊敬される3APA3Aの3proxyを使用した実証済みの機能的な方法についてです。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ソースからの3proxyビルドプロセス、その構成、NATを使用した完全かつ選択的なプロキシ、複数の外部プロキシサーバーへのチャネル配布、ルーターと静的ルートの使用について詳しく見ていきます。</font><font style="vertical-align: inherit;">OSにはDebian 9 x64を使用しています。</font><font style="vertical-align: inherit;">入門！</font></font><br>
<a name="habracut"></a><br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3proxyをインストールして通常のプロキシサーバーを起動する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.（ネット-toolsパッケージから）ifconfigコマンドをインストールします</font></font><br>
<code>apt-get install net-tools</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。2. Midnigth司令インストール</font></font><br>
<code>apt-get install mc</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は今2つのインターフェイス持っ3.：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
enp0s3 -インターネット上の外部、ルックス</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
enp0s8 -内部を、ローカルネットワーク上のはずです</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 他のDebianベースのディストリビューションでは、インタフェースは通常はeth0と呼ばれていますとeth1。</font></font><br>
<code>ifconfig -a</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターフェース</font></font></b><div class="spoiler_text">enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500<br>
 inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255<br>
 inet6 fe80::a00:27ff:fec2:bae4 prefixlen 64 scopeid 0x20 ether 08:00:27:c2:ba:e4 txqueuelen 1000 (Ethernet)<br>
 RX packets 6412 bytes 8676619 (8.2 MiB)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 1726 bytes 289128 (282.3 KiB)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
enp0s8: flags=4098&lt;BROADCAST,MULTICAST&gt; mtu 1500<br>
 ether 08:00:27:79:a7:e3 txqueuelen 1000 (Ethernet)<br>
 RX packets 0 bytes 0 (0.0 B)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 0 bytes 0 (0.0 B)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536<br>
 inet 127.0.0.1 netmask 255.0.0.0<br>
 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Local Loopback)<br>
 RX packets 0 bytes 0 (0.0 B)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 0 bytes 0 (0.0 B)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
 enp0s8     ,   ,     Proxy NAT  NAT.        ip. <br>
<br>
4.    3proxy<br>
 <br>
 4.1      3proxy   <br>
<br>
<code>root@debian9:~# apt-get install build-essential libevent-dev libssl-dev -y</code><br>
 <br>
 4.2.       <br>
<br>
<code>root@debian9:~# mkdir -p /opt/proxy</code><br>
 <br>
 4.3.    <br>
<br>
<code>root@debian9:~# cd /opt/proxy<br>
</code><br>
 <br>
4.4.     3proxy.         0.8.12 (18/04/2018)      3proxy<br>
<br>
<code>root@debian9:/opt/proxy# wget https://github.com/z3APA3A/3proxy/archive/0.8.12.tar.gz<br>
</code><br>
 <br>
 4.5.   <br>
 <br>
<code>root@debian9:/opt/proxy# tar zxvf 0.8.12.tar.gz</code><br>
<br>
4.6.       <br>
<br>
<code>root@debian9:/opt/proxy# cd 3proxy-0.8.12</code><br>
<br>
4.7.       ,       ( ,  , ip  )<br>
<br>
<code>root@debian9:/opt/proxy/3proxy-0.8.12# nano +29 src/proxy.h</code><br>
 <br>
   <br>
<br>
<code>#define ANONYMOUS 1<br>
</code><br>
  Ctrl+x  Enter,   .<br>
<br>
4.8.    <br>
<br>
<code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">Makelog</b><div class="spoiler_text">make[2]: Leaving directory '/opt/proxy/3proxy-0.8.12/src/plugins/TransparentPlugin'<br>
make[1]: Leaving directory '/opt/proxy/3proxy-0.8.12/src'<br>
</div></div><br>
  , .<br>
<br>
4.9.    <br>
<br>
<code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux install</code><br>
<br>
4.10.      ,   <br>
<br>
<code>root@debian9:/opt/proxy/3proxy-0.8.12# cd ~/<br>
root@debian9:~# whereis 3proxy</code><br>
3proxy: /usr/local/bin/3proxy /usr/local/etc/3proxy<br>
<br>
4.11.           <br>
<br>
<code>root@debian9:~# mkdir -p /home/joke/proxy/logs</code><br>
 <br>
 4.12.   ,    <br>
<br>
<code>root@debian9:~# cd /home/joke/proxy/</code><br>
<br>
4.13.       <br>
<br>
<code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.conf</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">3proxy.conf</b><div class="spoiler_text">daemon<br>
pidfile /home/joke/proxy/3proxy.pid<br>
nserver 8.8.8.8<br>
nscache 65536<br>
users tester:CL:1234<br>
timeouts 1 5 30 60 180 1800 16 60<br>
log /home/joke/proxy/logs/3proxy.log D<br>
logformat "- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T"<br>
rotate 3<br>
auth strong<br>
flush<br>
allow tester<br>
socks -p3128<br>
proxy -p8080<br>
</div></div><br>
   Ctrl + Z<br>
<br>
4.14.  pid — ,      .<br>
<br>
<code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.pid</code><br>
<br>
   Ctrl + Z<br>
<br>
4.15.   !<br>
<br>
<code>root@debian9:/home/joke/proxy# 3proxy /home/joke/proxy/3proxy.conf</code><br>
<br>
4.16. ,    <br>
<br>
<code>root@debian9:~/home/joke/proxy# netstat -nlp</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">netstat log</b><div class="spoiler_text">Active Internet connections (only servers)<br>
Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name <br>
tcp 0 0 0.0.0.0:8080 0.0.0.0:* LISTEN 504/3proxy <br>
tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 338/sshd <br>
tcp 0 0 0.0.0.0:3128 0.0.0.0:* LISTEN 504/3proxy <br>
tcp6 0 0 :::22 :::* LISTEN 338/sshd <br>
udp 0 0 0.0.0.0:68 0.0.0.0:* 352/dhclient <br>
</div></div><br>
      , -     8080, Socks5- — 3128.<br>
<br>
4.17.           cron.<br>
<br>
<code>root@debian9:/home/joke/proxy# crontab -e</code><br>
<br>
 <br>
<br>
<code>@reboot /usr/local/bin/3proxy /home/joke/proxy/3proxy.conf</code><br>
<br>
 Enter,   cron        .<br>
<br>
      crontab-.<br>
<br>
crontab: installing new crontab<br>
<br>
4.18.         .     Firefox ( -)   FoxyProxy  socks5  .<br>
<br>
<code>root@debian9:/home/joke/proxy# reboot</code><br>
<br>
4.19.     ,   .    - .<br>
<br>
<div class="spoiler"><b class="spoiler_title">3 proxy log</b><div class="spoiler_text">1542573996.018 PROXY.8080 00000 tester 192.168.23.10:50915 217.12.15.54:443 1193 6939 0 CONNECT_ads.yahoo.com:443_HTTP/1.1<br>
1542574289.634 SOCK5.3128 00000 tester 192.168.23.10:51193 54.192.13.69:443 0 0 0 CONNECT_normandy.cdn.mozilla.net:443<br>
</div></div><br>
<h3>    Transparent Proxy NAT</h3><br>
               -.   tcp-       (   ,   №2!) -.  DNS    3proxy (dnspr). UDP  «»  ,        forward (-    Linux).<br>
<br>
1.     enp0s8<br>
<br>
<code>root@debian9:~# nano /etc/network/interfaces</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">/etc/network/interfaces file</b><div class="spoiler_text"># This file describes the network interfaces available on your system<br>
# and how to activate them. For more information, see interfaces(5).<br>
<br>
source /etc/network/interfaces.d/*<br>
<br>
# The loopback network interface<br>
auto lo<br>
iface lo inet loopback<br>
<br>
# The primary network interface<br>
allow-hotplug enp0s3<br>
iface enp0s3 inet dhcp<br>
<br>
# The secondary network interface<br>
allow-hotplug enp0s8 <br>
iface enp0s8 inet static<br>
address 192.168.201.254<br>
netmask 255.255.255.0<br>
</div></div><br>
     enp0s8   192.168.201.254   255.255.255.0<br>
  Ctrl+X  <br>
<br>
<code>root@debian9:~# reboot</code><br>
<br>
2.  <br>
<br>
<code>root@debian9:~# ifconfig</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">ifconfig log</b><div class="spoiler_text">enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500<br>
 inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255<br>
 inet6 fe80::a00:27ff:fec2:bae4 prefixlen 64 scopeid 0x20 ether 08:00:27:c2:ba:e4 txqueuelen 1000 (Ethernet)<br>
 RX packets 61 bytes 7873 (7.6 KiB)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 65 bytes 10917 (10.6 KiB)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
enp0s8: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500<br>
 inet 192.168.201.254 netmask 255.255.255.0 broadcast 192.168.201.255<br>
 inet6 fe80::a00:27ff:fe79:a7e3 prefixlen 64 scopeid 0x20 ether 08:00:27:79:a7:e3 txqueuelen 1000 (Ethernet)<br>
 RX packets 0 bytes 0 (0.0 B)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 8 bytes 648 (648.0 B)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536<br>
 inet 127.0.0.1 netmask 255.0.0.0<br>
 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Local Loopback)<br>
 RX packets 0 bytes 0 (0.0 B)<br>
 RX errors 0 dropped 0 overruns 0 frame 0<br>
 TX packets 0 bytes 0 (0.0 B)<br>
 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0<br>
<br>
3.  ,    3proxy   .<br>
 <br>
<code>root@debian9:~# cd /home/joke/proxy/<br>
root@debian9:/home/joke/proxy# cat &gt; 3proxytransp.conf</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">   - №1</b><div class="spoiler_text">daemon<br>
pidfile /home/joke/proxy/3proxy.pid<br>
nserver 8.8.8.8<br>
nscache 65536<br>
timeouts 1 5 30 60 180 1800 16 60<br>
log /home/joke/proxy/logs/3proxy.log D<br>
logformat "- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T"<br>
rotate 3<br>
flush<br>
auth iponly<br>
dnspr<br>
allow * <br>
parent 1000 socks5 IP___ 3128 tester 1234<br>
plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin<br>
tcppm -i0.0.0.0 888 127.0.0.1 11111<br>
</div></div><br>
4.   3proxy   <br>
<code>root@debian9:/home/joke/proxy# /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code><br>
<br>
5.    crontab<br>
<code>root@debian9:/home/joke/proxy# crontab -e<br>
@reboot /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code><br>
<br>
6. ,     <br>
<code>root@debian9:~# netstat -nlp<br>
</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">netstat log</b><div class="spoiler_text">Active Internet connections (only servers)<br>
Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name<br>
tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 349/sshd<br>
tcp 0 0 0.0.0.0:888 0.0.0.0:* LISTEN 354/3proxy<br>
tcp6 0 0 :::22 :::* LISTEN 349/sshd<br>
udp 0 0 0.0.0.0:53 0.0.0.0:* 354/3proxy<br>
udp 0 0 0.0.0.0:68 0.0.0.0:* 367/dhclient<br>
</div></div><br>
7.      TCP-   888, DNS   53,       socks5 —   DNS  8.8.8.8.     netfilter (iptables)  DHCP   .<br>
<br>
8.   iptables-persistent  dhcpd<br>
<br>
<code>root@debian9:~# apt-get install iptables-persistent isc-dhcp-server</code><br>
<br>
9.    dhcpd<br>
<code>root@debian9:~# nano /etc/dhcp/dhcpd.conf</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">dhcpd.conf</b><div class="spoiler_text"># dhcpd.conf<br>
#<br>
# Sample configuration file for ISC dhcpd<br>
#<br>
<br>
# option definitions common to all supported networks…<br>
option domain-name «example.org»;<br>
option domain-name-servers ns1.example.org, ns2.example.org;<br>
<br>
default-lease-time 600;<br>
max-lease-time 7200;<br>
<br>
ddns-update-style none;<br>
<br>
# If this DHCP server is the official DHCP server for the local<br>
# network, the authoritative directive should be uncommented.<br>
<br>
authoritative;<br>
<br>
# A slightly different configuration for an internal subnet.<br>
subnet 192.168.201.0 netmask 255.255.255.0 {<br>
range 192.168.201.10 192.168.201.250;<br>
option domain-name-servers 192.168.201.254;<br>
option routers 192.168.201.254;<br>
option broadcast-address 192.168.201.255;<br>
default-lease-time 600;<br>
max-lease-time 7200;<br>
}<br>
</div></div><br>
11.       67<br>
<code>root@debian9:~# reboot<br>
root@debian9:~# netstat -nlp</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">netstat log</b><div class="spoiler_text">Active Internet connections (only servers)<br>
Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name <br>
tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 389/sshd <br>
tcp 0 0 0.0.0.0:888 0.0.0.0:* LISTEN 310/3proxy <br>
tcp6 0 0 :::22 :::* LISTEN 389/sshd <br>
udp 0 0 0.0.0.0:20364 0.0.0.0:* 393/dhcpd <br>
udp 0 0 0.0.0.0:53 0.0.0.0:* 310/3proxy <br>
udp 0 0 0.0.0.0:67 0.0.0.0:* 393/dhcpd <br>
udp 0 0 0.0.0.0:68 0.0.0.0:* 405/dhclient <br>
udp6 0 0 :::31728 :::* 393/dhcpd <br>
raw 0 0 0.0.0.0:1 0.0.0.0:* 393/dhcpd <br>
<br>
</div></div><br>
12.    tcp    888     iptables<br>
<br>
<code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -p tcp -j REDIRECT --to-ports 888</code><br>
<br>
<code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code><br>
<br>
13.         -.     1000.      0.2, 0.2, 0.2, 0.2, 0,1, 0,1   -.<br>
<br>
:    web-   socks5   connect,  socks4,  socks4 (socks4    /!)<br>
<br>
<div class="spoiler"><b class="spoiler_title">   - №2</b><div class="spoiler_text">daemon<br>
pidfile /home/joke/proxy/3proxy.pid<br>
nserver 8.8.8.8<br>
nscache 65536<br>
maxconn 500<br>
timeouts 1 5 30 60 180 1800 16 60<br>
log /home/joke/proxy/logs/3proxy.log D<br>
logformat "- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T"<br>
rotate 3<br>
flush<br>
auth iponly<br>
dnspr<br>
allow *<br>
<br>
parent 200 socks5 IP___№1 3128 tester 1234<br>
parent 200 socks5 IP___№2 3128 tester 1234<br>
parent 200 socks5 IP___№3 3128 tester 1234<br>
parent 200 socks5 IP___№4 3128 tester 1234<br>
parent 100 socks5 IP___№5 3128 tester 1234<br>
parent 100 socks5 IP___№6 3128 tester 1234<br>
<br>
plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin<br>
tcppm -i0.0.0.0 888 127.0.0.1 11111<br>
</div></div><br>
<h3>    NAT + Transparent Proxy</h3><br>
         NAT          .        /   ,     .  https   ,   /  .<br>
<br>
  ,  /   . ,   -  ,    ,  pandora.com.     /.<br>
<br>
1.  <br>
<br>
<code>root@debian9:~# ping pandora.com</code><br>
PING pandora.com (208.85.40.20) 56(84) bytes of data.<br>
<br>
2.    BGP 208.85.40.20 <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">bgp.he.net/net/208.85.40.0/24#_netinfo</a><br>
,     AS40428 Pandora Media, Inc<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">bgp.he.net/net/208.85.40.0/24#_netinfo</a><br>
 <br>
  v4<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">bgp.he.net/AS40428#_prefixes</a><br>
<br>
   !<br>
<br>
199.116.161.0/24<br>
199.116.162.0/24<br>
199.116.164.0/23<br>
199.116.164.0/24<br>
199.116.165.0/24<br>
208.85.40.0/24<br>
208.85.41.0/24<br>
208.85.42.0/23<br>
208.85.42.0/24<br>
208.85.43.0/24<br>
208.85.44.0/24<br>
208.85.46.0/23<br>
208.85.46.0/24<br>
208.85.47.0/24<br>
<br>
3.       .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ip-calculator.ru/aggregate</a>     .   — 6   14-.<br>
<br>
199.116.161.0/24<br>
199.116.162.0/24<br>
199.116.164.0/23<br>
208.85.40.0/22<br>
208.85.44.0/24<br>
208.85.46.0/23<br>
<br>
4.   iptables<br>
<br>
<code>root@debian9:~# iptables -F<br>
root@debian9:~# iptables -X<br>
root@debian9:~# iptables -t nat -F<br>
root@debian9:~# iptables -t nat -X</code><br>
 <br>
  forward  NAT<br>
<br>
<code>root@debian9:~# echo 1 &gt; /proc/sys/net/ipv4/ip_forward<br>
root@debian9:~# iptables -A FORWARD -i enp0s3 -o enp0s8 -j ACCEPT<br>
root@debian9:~# iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT<br>
root@debian9:~# iptables -t nat -A POSTROUTING -o enp0s3 -s 192.168.201.0/24 -j MASQUERADE</code><br>
<br>
 forward       <br>
<br>
<code>root@debian9:~# nano /etc/sysctl.conf</code><br>
<br>
  <br>
<br>
net.ipv4.ip_forward = 1<br>
<br>
Ctrl+X   <br>
<br>
5.   pandora.com  <br>
<br>
<code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888 </code><br>
<br>
6.   <br>
<br>
<code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code><br>
<br>
<h3>    Transparent Proxy via router</h3><br>
    -         / .                 -  . <br>
 <br>
! ,      IP  ,      .<br>
 <br>
 1.     ( enp0s3)<br>
<br>
<code>root@debian9:~# nano /etc/network/interfaces</code><br>
<br>
<div class="spoiler"><b class="spoiler_title">/etc/network/interfaces file</b><div class="spoiler_text"># This file describes the network interfaces available on your system<br>
# and how to activate them. For more information, see interfaces(5).<br>
<br>
source /etc/network/interfaces.d/*<br>
<br>
# The loopback network interface<br>
auto lo<br>
iface lo inet loopback<br>
<br>
# The primary network interface<br>
allow-hotplug enp0s3<br>
iface enp0s3 inet static<br>
address 192.168.23.2<br>
netmask 255.255.255.0<br>
gateway 192.168.23.254<br>
<br>
# The secondary network interface<br>
allow-hotplug enp0s8 <br>
iface enp0s8 inet static<br>
address 192.168.201.254<br>
netmask 255.255.255.0<br>
</div></div><br>
 2.     192.168.23.0/24   <br>
<br>
<code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.23.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888 </code><br>
<br>
3.   <br>
<code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code><br>
<br>
4.    <br>
<br>
<div class="spoiler"><b class="spoiler_title">Router network list</b><div class="spoiler_text">199.116.161.0 255.255.255.0 192.168.23.2<br>
199.116.162.0 255.255.255.0 192.168.23.2<br>
199.116.164.0 255.255.254.0 192.168.23.2<br>
208.85.40.0 255.255.252.0 192.168.23.2<br>
208.85.44.0 255.255.255.0 192.168.23.2<br>
208.85.46.0 255.255.254.0 192.168.23.2<br>
</div></div><br>
 <h3> /</h3><br>
1.    3proxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3proxy.ru</a><br>
<br>
2.    3proxy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">www.ekzorchik.ru/2015/02/how-to-take-your-socks-proxy</a><br>
<br>
3.   3proxy  GitHub <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github.com/z3APA3A/3proxy/issues/274</a><br>
<br>
</div></div></div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460457/index.html">Солнечная электростанция на дом 200 м2 своими руками</a></li>
<li><a href="../ja460461/index.html">セキュリティ評価としての標的型攻撃のシミュレーション。レッドチーミングサイバーインストラクション</a></li>
<li><a href="../ja460463/index.html">GALILEO-GNSS Programmer Versionの変更点</a></li>
<li><a href="../ja460465/index.html">デジタルシャドウ-デジタルリスクの削減に効果的</a></li>
<li><a href="../ja460467/index.html">車の音による故障を探しています。エンジンの異常を見つけるために、少しの機械学習を要求します</a></li>
<li><a href="../ja460471/index.html">管理パネルのエラーまたはLaravel Orchidの開発経験</a></li>
<li><a href="../ja460473/index.html">ホワイトノイズは黒い四角を描画します</a></li>
<li><a href="../ja460475/index.html">リモートコントロールモバイルライフブイ</a></li>
<li><a href="../ja460479/index.html">そして、テディベアは重い負荷がかかっているようです</a></li>
<li><a href="../ja460481/index.html">ファンレスパフォーマンスコンピューターMIC-7000</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>