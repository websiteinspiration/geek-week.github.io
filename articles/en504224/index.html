<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñï üïé üöå How did we survive the sharp increase in x10 load on the remote site and what conclusions did üî≤ üõÅ ü§≥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! The last couple of months we have lived in a very interesting situation, and I would like to share our history of infrastructure scaling....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How did we survive the sharp increase in x10 load on the remote site and what conclusions did</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sbermarket/blog/504224/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font><font style="vertical-align: inherit;">The last couple of months we have lived in a very interesting situation, and I would like to share our history of infrastructure scaling. </font><font style="vertical-align: inherit;">During this time, SberMarket grew 4 times in orders and launched a service in 17 new cities. </font><font style="vertical-align: inherit;">The explosive growth in demand for food delivery has required us to scale our infrastructure. </font><font style="vertical-align: inherit;">Read the most interesting and useful findings under the cat.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/el/ry/lnelryyy8ylmld9qzjuwsdfrafo.gif"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Dima Bobylev, I am the Technical Director of SberMarket. </font><font style="vertical-align: inherit;">Since this is the first post on our blog, I‚Äôll say a few words about myself and about the company. </font><font style="vertical-align: inherit;">Last fall, I participated in the contest of young leaders of the Runet. </font><font style="vertical-align: inherit;">For the contest, I </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote a short story</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about how we at SberMarket see the internal culture and approach to the development of the service. </font><font style="vertical-align: inherit;">And although it was not possible to win the competition, I formulated for myself the basic principles for the development of the IT ecosystem.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When managing a team, it is important to understand and find a balance between what the business needs and the needs of each specific developer. Now SberMarket is growing 13 times year to year, and this affects the product, requiring a constant increase in the volume and pace of development. Despite this, we devote enough time to developers for preliminary analysis and high-quality code writing. The formed approach helps not only in creating a working product, but also in its further scaling and development. As a result of this growth, SberMarket has already become a leader among food delivery services: we deliver about 18 thousand orders a day every day, although in the beginning of February there were about 3,500 of them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7v/jy/m7/7vjym762x2sa2ehkkvlwtzgi-og.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once a client asked the SberMarket courier to deliver products to him contactlessly - directly to the balcony</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But let's move on to the specifics. </font><font style="vertical-align: inherit;">Over the past few months, we have been actively scaling the infrastructure of our company. </font><font style="vertical-align: inherit;">Such a need was explained by external and internal factors. </font><font style="vertical-align: inherit;">Simultaneously with the expansion of the customer base, the number of connected stores increased from 90 at the beginning of the year to more than 200 by mid-May. </font><font style="vertical-align: inherit;">Of course, we prepared, reserved the main infrastructure, and counted on the possibility of vertical and horizontal scaling of all virtual machines located in the Yandex cloud. </font><font style="vertical-align: inherit;">However, practice has shown: "Everything that can go wrong goes wrong." </font><font style="vertical-align: inherit;">And today I want to share the most interesting situations that have happened in these weeks. </font><font style="vertical-align: inherit;">I hope our experience will be useful to you.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slave in full alert</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even before the pandemic began, we were faced with an increase in the number of requests to our backend servers. The tendency to order products with home delivery began to gain momentum, and with the introduction of the first self-isolation measures in connection with COVID-19, the load grew dramatically before our eyes all day. There was a need to quickly unload the master servers of the main database and transfer part of the read requests to the replica servers (slaves). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We were preparing in advance for this step, and for such a maneuver 2 slave servers had already been launched. They mainly worked on batch tasks of generating information feeds for exchanging data with partners. These processes created an extra load and quite rightly were put ‚Äúoutside the brackets‚Äù a couple of months earlier.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since there was replication on Slave, we adhered to the concept that applications can only work with them in read only mode. Disaster Recovery Plan suggested that in the event of a disaster, we could simply mount the Slave in place of the Master and switch all write and read requests to the Slave. However, we also wanted to use replicas for the needs of the analytics department, so the servers were not completely transferred to read only status, and each host had its own set of users, and some had write permissions to save intermediate calculation results.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Up to a certain level of load, we had enough wizards for both writing and reading when processing http requests. In mid-March, just when Sbermarket decided to completely switch to a remote site, we began a multiple increase in RPS. More and more of our customers went to self-isolation or work from home, which was reflected in the load indicators. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The performance of the ‚Äúmaster‚Äù was no longer enough, so we began to endure some of the heaviest read requests for a replica. To transparently send requests to write to the master, and reading to the slave, we used ruby ‚Äã‚Äãgem ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octopus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". We created a special user with the _readonly postfix without write permissions. But due to an error in the configuration of one of the hosts, part of the write requests went to the slave server on behalf of a user who had the appropriate rights. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem did not manifest itself immediately, because increased load increased the slave lag. Data inconsistency was revealed in the morning when, after nightly imports, the slaves did not ‚Äúcatch up‚Äù with the master. We attributed this to the high load on the service itself and the import associated with the launch of new stores. But to give information to the many hours of delay was unacceptable, and we switched to the second analytical processes the slave, because he had used </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lshie resources and was not loaded read requests (and we have explained ourselves to the absence of replication lag).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we figured out the reasons for the ‚Äúcreep‚Äù of the main slave, the analytic already failed for the same reason. Despite the presence of two additional servers, to which we planned to transfer the load in the event of a master crash, due to an unfortunate error, it turned out that at a critical moment there are none. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But since we did not only dump the database (the rest at that time was about 5 hours), but also a snapshot master server, we managed to start the replica within 2 hours. True, after that we were expected to roll the replication log for a long time (because the process is in single-threaded mode, but this is a completely different story).</font></font><br>
<br>
<blockquote><strong>:</strong>     ,            readonly  .      ,        .</blockquote><br>
<h3>      ¬´  ¬ª </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although we constantly update the catalog on the site, the requests that we made to the Slave servers allowed a slight lag from Master. The time during which we discovered and eliminated the problem of ‚Äúsuddenly dropping out of the distance‚Äù slaves was more than a ‚Äúpsychological barrier‚Äù (during this time prices could have updated, and customers would have seen outdated data), and we had to switch all requests to the main database server . As a result, the site worked slowly ... but at least it worked. And while the Slave was recovering, we had no choice but to optimize.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While the Slave servers were recovering, the minutes slowly dragged on, the Master remained overloaded, and we devoted all our efforts to optimizing active tasks according to the Pareto Rule: we selected the TOP requests that give most of the load and started tuning. This was done directly "on the fly."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An interesting effect was that MySQL loaded to the eyeball responds to even a slight improvement in processes. </font><font style="vertical-align: inherit;">Optimization of a pair of requests, which gave only 5% of the total load, already showed tangible CPU unloading. </font><font style="vertical-align: inherit;">As a result, we were able to provide an acceptable supply of resources for Master to work with the database and get the necessary time to restore replicas.&nbsp;</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Even a small optimization allows you to "survive" during overload for several hours. </font><font style="vertical-align: inherit;">This was just enough for us during the recovery of servers with replicas. </font><font style="vertical-align: inherit;">By the way, we will discuss the technical side of query optimization in one of the following posts. </font><font style="vertical-align: inherit;">So subscribe to our blog if this may be useful to you.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organize performance monitoring of partner services</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are engaged in processing orders from customers, and therefore our services constantly interact with third-party APIs - these are gateways for sending SMS, payment platforms, routing systems, geocoder, the Federal Tax Service and many other systems. And when the load began to grow rapidly, we began to rest against the API limitations of our service partners, which we had not even thought about before. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unexpected excess of quotas for affiliate services can lead to downtime of your own. Many APIs block clients that exceed the limits, and in some cases, an excess of requests can overload production with a partner.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, at the time of increasing the number of deliveries, the accompanying services could not cope with the tasks of their distribution, determination of routes. As a result, it turned out that the orders were made, and the service creating the route does not work. I must say that our logisticians made it almost impossible under these conditions, and the clear interaction of the team helped to compensate for temporary service failures. But such a volume of applications is impossible to process manually manually, and after some time we would encounter an unacceptable gap between orders and their execution.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A number of organizational measures were taken and the coordinated work of the team helped to gain time while we agreed on new conditions and waited for the modernization of services from some partners. There are other APIs that please you with high endurance and godless tariffs in case of high traffic. For example, in the beginning we used one well-known mapping API to determine the address of a delivery point. But at the end of the month they received a tidy bill of almost 2 million rubles. After that, they decided to quickly replace it. I will not engage in advertising, but I will say that our expenses have decreased significantly.</font></font><br>
<img src="https://habrastorage.org/webt/mn/3x/qr/mn3xqrx5sj531isw8dmeoezlz1g.png"><br>
<blockquote><strong>: </strong>            .    ,    ¬´  ¬ª,   ,        . , ,    &nbsp;      .&nbsp;</blockquote><br>
<h3> ,  ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  </a>¬ª ()  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are used to ‚Äúplugging‚Äù in the main database or application servers, but when scaling up, troubles can appear where they were not expected. For full-text search on the site, we use the Apache Solr engine. With an increase in load, we noted a decrease in response time, and server processor load reached 100%. What could be simpler - we will give out more resources to the container with Solr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of the expected performance gain, the server simply ‚Äúdied‚Äù. It immediately loaded 100% and responded even more slowly. Initially, we had 2 cores and 2 GB of RAM. We decided to do what usually helps - we gave the server 8 cores and 32 GB. Everything has become much worse (exactly how and why - we will tell in a separate post).&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For several days, we figured out the intricacies of this issue, and achieved optimal performance with 8 cores and 32 GB. </font><font style="vertical-align: inherit;">This configuration allows us to continue to increase the load today, which is very important, because the growth is not only in customers, but also in the number of connected stores - over 2 months their number has doubled.&nbsp;</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Standard methods such as "add more iron" do not always work. </font><font style="vertical-align: inherit;">So when scaling up any service, you need to understand well how it uses resources and pre-test its operation in new conditions.&nbsp;</font></font><br>
</blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateless - the key to easy horizontal scaling</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, our team adheres to a well-known approach: services should not have stateless state and should be independent of the runtime environment. This allowed us to survive the load growth by simple horizontal scaling. But we had one service exception - a handler for long background tasks. He was engaged in sending emails and sms, processing events, generating feeds, importing prices and stocks, and processing images. It so happened that it depended on the local file storage and was in a single copy.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the number of tasks in the handler queue increased (and this naturally happened with an increase in the number of orders), the performance of the host hosting the handler and file storage became a limiting factor. </font><font style="vertical-align: inherit;">As a result, the assortment and prices were stopped updating, sending notifications to users and many other critical functions stuck in the queue. </font><font style="vertical-align: inherit;">The Ops team quickly migrated the file storage to an S3-like network storage, and this allowed us to raise several powerful machines to scale the background task handler.</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Stateless rule must be respected for all components, without exception, even if it seems ‚Äúthat we‚Äôre definitely not bothering‚Äù. </font><font style="vertical-align: inherit;">It is better to spend a little time on the correct organization of the work of all systems than to rewrite the code in a hurry and repair the service that is experiencing overload.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 principles for intense growth</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the availability of additional capacity, in the process of growth we stepped on a few rakes. </font><font style="vertical-align: inherit;">During this time, the number of orders increased by more than 4 times. </font><font style="vertical-align: inherit;">Now we already deliver more than 17,000 orders a day in 62 cities and plan to expand our geography even further - in the first half of 2020, service is expected to be launched throughout Russia. </font><font style="vertical-align: inherit;">In order to cope with the growing load, taking into account the already full bumps, we have developed for ourselves 7 basic principles of work in conditions of constant growth:</font></font><br>
<br>
<ol>
<li><strong>-</strong>.     Jira,   &nbsp;    .          .       ‚Äî         .   ,    ,    ,      ,         .</li>
<li><strong> </strong>      .            ¬´ ¬ª   .  ,        ,      .           ,     .</li>
<li><strong> </strong>      . -,        . -,     ,           .</li>
<li><strong>   stateless. </strong>   ,        .      .          , ,   S3.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> https://12factor.net</a>.         ,             .</li>
<li><strong>    . </strong>          ,     .  ,       ,  -    .         ,    .&nbsp;</li>
<li><strong>   . </strong>  ,       .         ,      SMS       .        ,     .</li>
<li><strong> .</strong>      ,       .     , ,    .       API,    -.      .</li>
</ol><br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not without losses, but we survived this stage, and today we try to adhere to all found principles, and each machine has the ability to easily increase x4 performance to cope with any surprises.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the following posts, we will share our experience in investigating performance subsidence in Apache Solr, as well as talk about query optimization and how interaction with the Federal Tax Service helps the company save money. </font><font style="vertical-align: inherit;">Subscribe to our blog so that you don‚Äôt miss anything, and tell us in the comments if you had such troubles during the growth of traffic.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/ky/jx/iakyjxz9atsneo1adhjxi_qpwyi.jpeg"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504214/index.html">The development of DATA VAULT and the transition to BUSINESS DATA VAULT</a></li>
<li><a href="../en504216/index.html">How old is this house. How I made a map of the age of houses in St. Petersburg</a></li>
<li><a href="../en504218/index.html">Productivity, interns, seniors and loss of spirit of Silicon Valley. Zuckerberg's Great Interview on Remote Work</a></li>
<li><a href="../en504220/index.html">Server HTTP Header Verification Service</a></li>
<li><a href="../en504222/index.html">Hydrogen is the head of everything: how energy is generated from plastic debris for a Japanese hotel</a></li>
<li><a href="../en504226/index.html">The digest of events for HR and IT recruiters in June 2020</a></li>
<li><a href="../en504228/index.html">RangeAmp - a new vulnerability allows DDoS attacks with an amplification factor of tens of thousands</a></li>
<li><a href="../en504230/index.html">NextDNS out of beta - privacy protection, circumvention of state censorship and ad blocking for the entire home network</a></li>
<li><a href="../en504232/index.html">How an engineer grow into techlida</a></li>
<li><a href="../en504236/index.html">Deploy Docker Image to Dokku with Ansible</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>