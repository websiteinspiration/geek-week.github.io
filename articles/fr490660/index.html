<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👆🏼 🔽 📐 Comment avons-nous assuré la croissance de CityMobile 🤦 💤 👩🏿‍🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je m’appelle Ivan, je suis responsable du développement des serveurs chez Citimobil. Aujourd'hui, je vais parler de ce qu'est ce développement de serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment avons-nous assuré la croissance de CityMobile</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/490660/"><img src="https://habrastorage.org/webt/zp/vs/q8/zpvsq8dn-snye4kfqv2ktymbip8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je m’appelle Ivan, je suis responsable du développement des serveurs chez Citimobil. </font><font style="vertical-align: inherit;">Aujourd'hui, je vais parler de ce qu'est ce développement de serveur, des problèmes que nous avons rencontrés et de la façon dont nous prévoyons de le développer.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Début de croissance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peu de gens savent que CityMobile existe depuis longtemps, 13 ans. Autrefois, c'était une petite entreprise qui ne travaillait qu'à Moscou. Il y avait très peu de développeurs, et ils savaient bien comment fonctionnait le système - parce qu'ils l'avaient eux-mêmes créé. Le marché des taxis commençait alors à peine à se développer, les charges étaient penny. Nous n'avions même pas la tâche d'assurer la tolérance aux pannes et la mise à l'échelle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2018, Mail.Ru Group a investi dans CityMobile, et nous avons commencé à croître rapidement. Nous n'avons pas eu le temps de réécrire la plateforme, ou du moins une refactorisation importante, il a fallu développer ses capacités fonctionnelles pour rattraper notre principal concurrent, et embaucher rapidement des personnes. Lorsque j'ai rejoint l'entreprise, seuls 20 développeurs étaient impliqués dans le backend, et presque tous étaient en procès. Par conséquent, nous avons décidé de «cueillir des fruits bas»: apporter des changements simples qui donnent un résultat énorme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À cette époque, nous avions un monolithe en PHP et trois services sur Go, ainsi qu'une base principale dans MySQL à laquelle le monolithe accédait (les services étaient utilisés comme référentiels de Redis et EasticSearch). Et progressivement, avec l'augmentation de la charge, de lourdes demandes système ont commencé à ralentir la base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que pourrait-on faire avec ça?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons franchi l'étape évidente: mettre un esclave en production. Mais si de nombreuses demandes lourdes lui parviennent, le tiendra-t-il? Il était également évident qu'avec une abondance de demandes de rapports analytiques, l'esclave commencerait à traîner. Un important arriéré d'esclaves pourrait nuire aux performances de l'ensemble du CityMobile. En conséquence, nous avons mis un autre esclave pour les analystes. Son décalage ne conduit jamais à des problèmes sur la prod. Mais même cela ne nous a pas semblé suffisant. Nous avons écrit un réplicateur de table de MySQL dans Clickhouse. Et aujourd'hui, l'analyse vit seule, en utilisant une pile plus conçue pour OLAP.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous cette forme, le système a fonctionné pendant un certain temps, puis des fonctions ont commencé à apparaître qui étaient plus exigeantes sur le matériel. </font><font style="vertical-align: inherit;">Il y avait de plus en plus de demandes chaque semaine: même pas une semaine sans un nouveau record. </font><font style="vertical-align: inherit;">De plus, nous avons placé une bombe à retardement sous notre système. </font><font style="vertical-align: inherit;">Auparavant, nous n'avions qu'un seul point de défaillance - la base maître MySQL, mais avec l'ajout d'un esclave, il y avait deux points de ce type: le maître et l'esclave. </font><font style="vertical-align: inherit;">La défaillance de l'une de ces machines entraînerait une défaillance complète du système. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour se protéger contre cela, nous avons commencé à utiliser un proxy local pour effectuer des esclaves de contrôle de santé. </font><font style="vertical-align: inherit;">Cela nous a permis d'utiliser de nombreux esclaves sans changer le code. </font><font style="vertical-align: inherit;">Nous avons introduit des contrôles automatiques réguliers du statut de chaque esclave et de ses métriques générales:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décalage esclave;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disponibilité du port;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de serrures, etc.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si un certain seuil est dépassé, le système retire l'esclave de la charge. </font><font style="vertical-align: inherit;">Mais en même temps, pas plus de la moitié des esclaves peuvent être retirés, de sorte qu'en raison de l'augmentation de la charge sur les autres, ils ne peuvent pas organiser eux-mêmes un temps d'arrêt. </font><font style="vertical-align: inherit;">En tant que proxy, nous avons utilisé HAProxy et inclus immédiatement un plan pour passer à ProxySQL dans le backlog. </font><font style="vertical-align: inherit;">Le choix était quelque peu étrange, mais nos administrateurs avaient déjà une bonne expérience de travail avec HAProxy, et le problème était aigu et nécessitait une solution rapide. </font><font style="vertical-align: inherit;">Ainsi, nous avons créé un système à sécurité intégrée pour les esclaves, qui évoluait assez facilement. </font><font style="vertical-align: inherit;">Malgré toute sa simplicité, elle ne nous a jamais laissé tomber.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poursuite de la croissance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À mesure que l'entreprise se développait, nous avons trouvé un autre goulot d'étranglement dans notre système. Avec les changements des conditions extérieures - par exemple, les précipitations ont commencé dans une grande région - le nombre de commandes de taxi a augmenté rapidement. Dans de telles situations, les conducteurs n'ont pas eu le temps de réagir assez rapidement et il y avait une pénurie de voitures. Alors que les commandes étaient distribuées, elles ont créé une charge sur les esclaves MySQL en boucle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons trouvé une solution réussie - Tarantool. Il était difficile de réécrire le système pour cela, nous avons donc résolu le problème différemment: en utilisant l'outil de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réplication mysql-tarantool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fait la réplication de certaines tables de MySQL vers Tarantool. Toutes les demandes de lecture qui ont surgi lors de la pénurie de voitures, nous avons commencé à diffuser à Tarantool et depuis, nous ne sommes plus préoccupés par les orages et les ouragans! Et nous avons résolu le problème avec le point de défaillance encore plus facilement: nous avons immédiatement installé plusieurs répliques auxquelles nous accédons healthcheck via HAProxy. Chaque instance de Tarantool est répliquée par un réplicateur distinct. Comme bonus agréable, nous avons également résolu le problème du retard des esclaves dans cette section de code: la réplication de MySQL vers Tarantool fonctionne beaucoup plus rapidement que de MySQL vers MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, notre base principale était toujours un point d'échec et n'a pas évolué lors des opérations d'enregistrement. Nous avons commencé à résoudre ce problème de cette façon.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premièrement, à cette époque, nous avons déjà commencé à créer activement de nouveaux services (par exemple, la lutte contre la fraude, à propos de laquelle mes collègues </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont déjà écrit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). De plus, les services ont immédiatement exigé une évolutivité du stockage. Pour Redis, nous avons commencé à utiliser uniquement Redis-cluster, et pour Tarantool - Vshard. Là où nous utilisons MySQL, nous avons commencé à utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vitess</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour une nouvelle logique </font><font style="vertical-align: inherit;">. Ces bases de données sont immédiatement partageables, il n'y a donc presque aucun problème d'enregistrement, et si elles surviennent soudainement, il sera facile de les résoudre en ajoutant des serveurs. Maintenant, nous utilisons Vitess uniquement pour les services non critiques et étudions les pièges, mais, à l'avenir, ce sera sur toutes les bases de données MySQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxièmement, comme il était difficile et long d'implémenter Vitess pour la logique déjà existante, nous sommes allés de manière plus simple, quoique moins universelle: nous avons commencé à distribuer la base maître sur différents serveurs, table par table. Nous avons eu beaucoup de chance: il s'est avéré que la charge principale de l'enregistrement est créée par des tables qui ne sont pas critiques pour la fonctionnalité principale. Et lorsque nous créons de tels tableaux, nous ne créons pas de points de défaillance supplémentaires. Le principal ennemi pour nous était la forte connectivité des tables dans le code à l'aide de JOIN (il y avait des JOIN et 50 à 60 tables chacune). Nous les avons coupés sans pitié. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est maintenant temps de rappeler deux modèles très importants pour la conception de systèmes à haute charge:</font></font><br>
<br>
<ul>
<li>Graceful degradation.   ,       -   . ,   ,      ,       ,     ..    ,             .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Circuit breaker</a>.    ,    . ,    ,    ,        .    ?      (        - graceful degradation).  ,   FPM-  ,     .  -  ( )     ,       .           ,      - ,       ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc commencé à évoluer à tout le moins, mais il y avait encore des points d'échec. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons décidé de nous tourner vers la réplication semi-synchrone (et de l'implémenter avec succès). Quelle est sa caractéristique? Si au cours de la réplication asynchrone normale, le nettoyeur du centre de données verse un seau d'eau sur le serveur, les dernières transactions n'auront pas le temps de se répliquer sur les esclaves et seront perdues. Et nous devons être sûrs que dans ce cas, nous n'aurons pas de problèmes sérieux après que l'un des esclaves deviendra un nouveau maître. En conséquence, nous avons décidé de ne pas perdre du tout les transactions, et pour cela, nous avons utilisé la réplication semi-synchrone. Désormais, les esclaves peuvent être en retard, mais même si le serveur de base de données maître est détruit, les informations sur toutes les transactions seront stockées sur au moins un esclave.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce fut la première étape vers le succès. </font><font style="vertical-align: inherit;">La deuxième étape consistait à utiliser l'utilitaire d'orchestrateur. </font><font style="vertical-align: inherit;">Nous surveillons également en permanence tous les MySQL du système. </font><font style="vertical-align: inherit;">En cas d'échec de la base maître, l'automatisation créera le plus récent maître esclave (et en tenant compte de la réplication semi-synchrone, elle contiendra toutes les transactions) et y basculera toute la charge d'écriture. </font><font style="vertical-align: inherit;">Nous pouvons donc maintenant revivre l'histoire d'une femme de ménage et d'un seau d'eau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et après? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand je suis arrivé à CityMobile, nous avions trois services et un monolithe. </font><font style="vertical-align: inherit;">Aujourd'hui, il y en a plus de 20. Et l'essentiel qui freine notre croissance, c'est que nous n'avons toujours qu'une seule base maître. </font><font style="vertical-align: inherit;">Nous combattons héroïquement cela et le divisons en bases distinctes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment évoluons-nous?</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développez l'ensemble des microservices.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cela résoudra bon nombre des problèmes auxquels nous sommes confrontés aujourd'hui. Par exemple, l'équipe n'a plus une seule personne qui connaît l'appareil de l'ensemble du système. Et comme en raison de la croissance rapide, nous n'avons pas toujours de documentation à jour, et il est très difficile de la maintenir, il est difficile pour les débutants de se plonger dans le cours des choses. Et si le système comprendra de nombreux services, la rédaction de la documentation pour chacun d'eux sera incomparablement plus facile. Et la quantité de code pour une étude ponctuelle est considérablement réduite. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faut que j'y aille.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'adore vraiment cette langue, mais j'ai toujours cru qu'il n'était pas pratique de réécrire le code de travail d'une langue à une autre. Mais récemment, l'expérience a montré que les bibliothèques PHP, même les plus courantes et les plus populaires, ne sont pas de la plus haute qualité. Autrement dit, nous corrigeons de nombreuses bibliothèques. Disons que l'équipe SRE a corrigé la bibliothèque standard pour interagir avec RabbitMQ: il s'est avéré qu'une fonction aussi basique que le time out ne fonctionnait pas. Et plus l'équipe SRE est profonde et je comprends ces problèmes, plus il devient clair que peu de gens pensent aux délais d'attente en PHP, peu de gens se soucient de tester les bibliothèques, peu de gens pensent aux verrous. Pourquoi cela devient-il un problème pour nous? Parce que les solutions Go sont beaucoup plus faciles à maintenir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quoi d'autre m'impressionne avec Go? Curieusement, y écrire est très simple. De plus, Go facilite la création de diverses solutions de plate-forme. Ce langage dispose d'un ensemble d'outils standard très puissant. Si pour une raison quelconque, notre backend commence à ralentir soudainement, allez simplement à une URL spécifique et vous pouvez voir toutes les statistiques - le diagramme d'allocation de mémoire, pour comprendre où le processus est inactif. Et en PHP, il est plus difficile d'identifier les problèmes de performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, Go a de très bons linters - des programmes qui trouvent automatiquement les erreurs les plus courantes pour vous. La plupart d'entre eux sont décrits dans l'article «50 nuances de Go», et le linter les détecte parfaitement. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuez à tailler les bases.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous passerons à Vitess sur tous les services. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduction d'un monolithe PHP en redis-cluster.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans nos services, redis-cluster s'est révélé excellent. </font><font style="vertical-align: inherit;">Malheureusement, son implémentation en PHP est plus difficile. </font><font style="vertical-align: inherit;">Le monolith utilise des commandes qui ne sont pas prises en charge par redis-cluster (ce qui est bien, ces commandes apportent plus de problèmes que d'avantages). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous étudierons les problèmes de RabbitMQ. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On pense que RabbitMQ n'est pas le logiciel le plus fiable. </font><font style="vertical-align: inherit;">Nous étudierons cette question, trouverons et résoudrons des problèmes. </font><font style="vertical-align: inherit;">Peut-être penserons-nous à passer à Kafka ou Tarantool.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490648/index.html">Utilisation de conteneurs Kata dans Kubernetes</a></li>
<li><a href="../fr490650/index.html">Les principales erreurs dans la compilation d'un CV par des informaticiens débutants</a></li>
<li><a href="../fr490652/index.html">Logistique. introduction À peu près compliqué</a></li>
<li><a href="../fr490654/index.html">Pointillé sur les capteurs de gaz de la série MQ - compréhension approfondie de la fiche technique et du réglage</a></li>
<li><a href="../fr490656/index.html">Tâches externes Camunda - un outil puissant pour créer des applications avec une architecture résiliente et évolutive</a></li>
<li><a href="../fr490664/index.html">PHP: array_key_exists recherche 500 fois plus vite que in_array</a></li>
<li><a href="../fr490668/index.html">L'histoire de la transformation du produit au projet et vice versa (en utilisant l'exemple de la bonté dans la région de Moscou)</a></li>
<li><a href="../fr490670/index.html">Comment faire en sorte qu'une voiture écrive des tests à partir du code pour vous</a></li>
<li><a href="../fr490674/index.html">Habr Wickley # 41 / Plus de voitures autonomes, prof. Fortran, Yandex, la douleur du robot, comment bloquer le site d'un concurrent</a></li>
<li><a href="../fr490676/index.html">Tests unitaires, sciences et mathématiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>