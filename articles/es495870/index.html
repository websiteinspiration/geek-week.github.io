<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüè≠ üë®üèº‚Äçüåæ ü¶Ç Consejos y trucos para trabajar con Ceph en proyectos ocupados üë∏üèΩ ü§∞üèø üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usando Ceph como almacenamiento de red en diferentes proyectos de carga de trabajo, podemos encontrar varias tareas que a primera vista no parecen sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Consejos y trucos para trabajar con Ceph en proyectos ocupados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/495870/"><img src="https://habrastorage.org/webt/ph/1x/bv/ph1xbvwvoynsjkdr3h_l_gxwoxe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando Ceph como almacenamiento de red en diferentes proyectos de carga de trabajo, podemos encontrar varias tareas que a primera vista no parecen simples o triviales. </font><font style="vertical-align: inherit;">Por ejemplo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> migraci√≥n de datos de Ceph antiguo a nuevo con uso parcial de servidores anteriores en el nuevo cl√∫ster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> soluci√≥n del problema de distribuci√≥n de espacio en disco en Ceph.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfrentando tales tareas, nos enfrentamos a la necesidad de extraer correctamente el OSD sin p√©rdida de datos, lo cual es especialmente cierto para grandes cantidades de datos. </font><font style="vertical-align: inherit;">Esto se discutir√° en el art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los m√©todos descritos a continuaci√≥n son relevantes para cualquier versi√≥n de Ceph. </font><font style="vertical-align: inherit;">Adem√°s, se tendr√° en cuenta el hecho de que se puede almacenar una gran cantidad de datos en Ceph: para evitar la p√©rdida de datos y otros problemas, algunas acciones se "dividir√°n" en varias otras.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefacio de OSD</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que dos de las tres recetas en consideraci√≥n est√°n dedicadas a OSD ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Object Storage Daemon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), antes de sumergirse en la parte pr√°ctica, brevemente sobre qu√© es en Ceph y por qu√© es tan importante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, debe decirse que todo el cl√∫ster Ceph consta de muchos OSD. Cuantos m√°s haya, mayor ser√° el volumen de datos libres en Ceph. Desde aqu√≠ es f√°cil comprender la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funci√≥n principal de OSD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : guarda los datos de objetos Ceph en los sistemas de archivos de todos los nodos del cl√∫ster y les proporciona acceso de red (para leer, escribir y otras solicitudes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el mismo nivel, los par√°metros de replicaci√≥n se establecen copiando objetos entre diferentes OSD. Y aqu√≠ puede encontrar varios problemas, cuya soluci√≥n se discutir√° m√°s adelante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caso No. 1. </font><font style="vertical-align: inherit;">Recupere OSD de forma segura del cl√∫ster Ceph sin p√©rdida de datos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La necesidad de eliminar el OSD puede deberse a la retirada del servidor del cl√∫ster, por ejemplo, para reemplazarlo por otro servidor, lo que sucedi√≥ con nosotros y dio lugar a la redacci√≥n del art√≠culo. </font><font style="vertical-align: inherit;">Por lo tanto, el objetivo final de la manipulaci√≥n es extraer todos los OSD y mones en un servidor determinado para que pueda detenerse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por conveniencia y eliminaci√≥n de la situaci√≥n en la que, en el proceso de ejecuci√≥n de comandos, cometemos un error al indicar la OSD necesaria, estableceremos una variable separada, cuyo valor ser√° el n√∫mero de OSD que se eliminar√°. </font><font style="vertical-align: inherit;">Lo llamaremos </font></font><code>${ID}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en adelante, dicha variable reemplaza el n√∫mero OSD con el que trabajamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos la condici√≥n antes de comenzar a trabajar:</font></font><br>
<br>
<pre><code class="bash hljs">root@hv-1 ~ <span class="hljs-comment"># ceph osd tree</span><font></font>
ID CLASS WEIGHT  TYPE NAME      STATUS REWEIGHT PRI-AFF<font></font>
-1       0.46857 root default<font></font>
-3       0.15619      host hv-1<font></font>
-5       0.15619      host hv-2<font></font>
 1   ssd 0.15619      osd.1     up     1.00000  1.00000<font></font>
-7       0.15619      host hv-3<font></font>
 2   ssd 0.15619      osd.2     up     1.00000  1.00000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para iniciar la eliminaci√≥n de OSD, deber√° ejecutarlo sin problemas </font></font><code>reweight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en cero. Por lo tanto, reducimos la cantidad de datos en el OSD al equilibrarlo con otros OSD. Para hacer esto, se ejecutan los siguientes comandos:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd reweight osd.<span class="hljs-variable">${ID}</span> 0.98<font></font>
ceph osd reweight osd.<span class="hljs-variable">${ID}</span> 0.88<font></font>
ceph osd reweight osd.<span class="hljs-variable">${ID}</span> 0.78</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... y as√≠ sucesivamente a cero. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTUALIZADO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Los comentarios sobre el art√≠culo hablaron sobre el m√©todo con </font></font><code>norebalance</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font><code>backfill</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La soluci√≥n es correcta, pero antes que nada debe analizar la situaci√≥n, porque la </font></font><code>norebalance</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usamos cuando no queremos que ning√∫n OSD provoque una carga en la red. </font></font><code>osd_max_backfill</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado en casos donde es necesario limitar la velocidad del reequilibrio. Como resultado, el reequilibrio ser√° m√°s lento y causar√° menos carga de red. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un equilibrio suave es necesario</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para no perder datos. Esto es especialmente cierto si el OSD contiene una gran cantidad de datos. Para asegurarse de que </font></font><code>reweight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo fue exitoso </font><font style="vertical-align: inherit;">despu√©s de ejecutar los comandos </font><font style="vertical-align: inherit;">, puede ejecutarlo </font></font><code>ceph -s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font><font style="vertical-align: inherit;">ejecutarlo </font><font style="vertical-align: inherit;">en una ventana de terminal separada</font></font><code>ceph -w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para observar cambios en tiempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando el OSD est√° "vac√≠o", puede comenzar la operaci√≥n est√°ndar para eliminarlo. </font><font style="vertical-align: inherit;">Para hacer esto, coloque el OSD deseado en el estado </font></font><code>down</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd down osd.<span class="hljs-variable">${ID}</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Extraer" OSD del cl√∫ster:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd out osd.<span class="hljs-variable">${ID}</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Detenga el servicio OSD y desmonte su partici√≥n en el FS:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop ceph-osd@<span class="hljs-variable">${ID}</span>
umount /var/lib/ceph/osd/ceph-<span class="hljs-variable">${ID}</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elimine la OSD del </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mapa CRUSH</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd crush remove osd.<span class="hljs-variable">${ID}</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eliminar el usuario OSD:</font></font><br>
<br>
<pre><code class="bash hljs">ceph auth del osd.<span class="hljs-variable">${ID}</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y finalmente, elimine el OSD en s√≠:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd rm osd.<span class="hljs-variable">${ID}</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : si est√° utilizando Ceph Luminous o superior, los pasos anteriores para eliminar OSD se pueden reducir a dos comandos:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd out osd.<span class="hljs-variable">${ID}</span>
ceph osd purge osd.<span class="hljs-variable">${ID}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si, despu√©s de realizar los pasos anteriores, se ejecuta el comando </font></font><code>ceph osd tree</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, deber√≠a verse que el servidor donde se realiz√≥ el trabajo ya no tiene el OSD para el que se realizaron las operaciones anteriores:</font></font><br>
<br>
<pre><code class="bash hljs">root@hv-1 ~ <span class="hljs-comment"># ceph osd tree</span><font></font>
ID CLASS WEIGHT  TYPE NAME     STATUS REWEIGHT PRI-AFF<font></font>
-1       0.46857      root default<font></font>
-3       0.15619      host hv-1<font></font>
-5       0.15619      host hv-2<font></font>
-7       0.15619      host hv-3<font></font>
 2   ssd 0.15619      osd.2    up     1.00000  1.00000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el camino, notamos que el estado del cl√∫ster Ceph entrar√° </font></font><code>HEALTH_WARN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y tambi√©n veremos una disminuci√≥n en el n√∫mero de OSD y la cantidad de espacio disponible en disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, se describir√°n los pasos que se requerir√°n si desea detener completamente el servidor y, en consecuencia, eliminarlo de Ceph. </font><font style="vertical-align: inherit;">En este caso, es importante recordar que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes de apagar el servidor, debe extraer todos los OSD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en este servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no queda m√°s OSD en este servidor, luego de eliminarlos, debe excluir el servidor de la tarjeta OSD </font></font><code>hv-2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecutando el siguiente comando:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd crush rm hv-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo eliminamos </font></font><code>mon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del servidor </font></font><code>hv-2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecutando el siguiente comando en otro servidor (es decir, en este caso, en </font></font><code>hv-1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="bash hljs">ceph-deploy mon destroy hv-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, puede detener el servidor y continuar con las acciones posteriores (su redistribuci√≥n, etc.).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caso No. 2. </font><font style="vertical-align: inherit;">Asignaci√≥n de espacio en disco en un cl√∫ster Ceph ya creado</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda historia comienza con un prefacio sobre PG ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grupos de ubicaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">El papel principal de PG en Ceph es principalmente en la agregaci√≥n de objetos Ceph y su posterior replicaci√≥n en OSD. </font><font style="vertical-align: inherit;">La f√≥rmula con la que puede calcular el n√∫mero requerido de PG se puede encontrar en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">secci√≥n correspondiente de la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> documentaci√≥n de Ceph. </font><font style="vertical-align: inherit;">En el mismo lugar, este problema tambi√©n se analiz√≥ con ejemplos espec√≠ficos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces: uno de los problemas comunes durante la operaci√≥n de Ceph es una cantidad desequilibrada de OSD y PG entre grupos en Ceph. </font><font style="vertical-align: inherit;">En general, un valor correctamente seleccionado de PG es la clave para el funcionamiento confiable del cl√∫ster, y luego consideraremos lo que puede suceder en el caso contrario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dificultad para elegir la cantidad correcta de PG radica en dos cosas:</font></font><br>
<br>
<ol>
<li>       PG,   , ,     chunk'.</li>
<li>   , ,   PG,      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la pr√°ctica, se obtiene un problema m√°s grave: desbordamiento de datos en uno de los OSD. La raz√≥n de esto es que Ceph, al calcular la cantidad de datos disponibles (puede encontrarlo </font></font><code>MAX AVAIL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la salida del comando </font></font><code>ceph df</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada grupo por separado), se basa en la cantidad de datos disponibles en OSD. Si no hay suficiente espacio en al menos un OSD, escribir m√°s datos no funcionar√° hasta que los datos se distribuyan correctamente entre todos los OSD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena aclarar que estos problemas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se resuelven en gran medida en la etapa de configuraci√≥n del cl√∫ster Ceph</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Una herramienta que puede usar es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceph PGCalc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Con su ayuda, se calcula visualmente la cantidad necesaria de PG. Sin embargo, puede recurrir a √©l en una situaci√≥n en la que el cl√∫ster Ceph </font><i><font style="vertical-align: inherit;">ya</font></i><font style="vertical-align: inherit;"> est√°</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no configurado correctamente Aqu√≠ vale la pena aclarar que, como parte del trabajo de correcci√≥n, lo m√°s probable es que necesite reducir el n√∫mero de PG, y esta funci√≥n no est√° disponible en versiones anteriores de Ceph (apareci√≥ solo con la versi√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nautilus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, imaginemos la siguiente imagen: un cl√∫ster tiene un estado </font></font><code>HEALTH_WARN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debido al final de un lugar en uno de los OSD. Un error lo atestiguar√° </font></font><code>HEALTH_WARN: 1 near full osd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A continuaci√≥n se muestra un algoritmo para superar esta situaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, debe distribuir los datos disponibles entre el resto de la OSD. Ya realizamos una operaci√≥n similar en el primer caso, cuando "drenamos" el nudo, con la √∫nica diferencia que ahora tendr√° que reducirse ligeramente </font></font><code>reweight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por ejemplo, antes de 0.95:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd reweight osd.<span class="hljs-variable">${ID}</span> 0.95</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto libera espacio en disco en el OSD y corrige un error en la salud ceph. </font><font style="vertical-align: inherit;">Sin embargo, como ya se mencion√≥, este problema surge principalmente debido a la configuraci√≥n incorrecta de Ceph en las etapas iniciales: es muy importante reconfigurar para que no aparezca en el futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro caso particular, todo se basaba en:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demasiado importante </font></font><code>replication_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en una de las piscinas,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Demasiados PG en un grupo y demasiado peque√±os en otro. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizaremos la calculadora ya mencionada. Muestra claramente lo que debe ingresarse y, en principio, no hay nada complicado. Una vez establecidos los par√°metros necesarios, obtenemos las siguientes recomendaciones: </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : si configura el cl√∫ster Ceph desde cero, otra funci√≥n √∫til de la calculadora ser√° la generaci√≥n de comandos que crear√°n grupos desde cero con los par√°metros enumerados en la tabla.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
La √∫ltima columna, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuenta de PG sugerida, lo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ayuda a </font><i><font style="vertical-align: inherit;">navegar</font></i><font style="vertical-align: inherit;"> . En nuestro caso, el segundo tambi√©n es √∫til, donde se indica el par√°metro de replicaci√≥n, ya que decidimos cambiar el factor de replicaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, primero debe cambiar la configuraci√≥n de replicaci√≥n; vale la pena hacerlo primero, ya que al reducir el multiplicador liberaremos espacio en disco. </font><font style="vertical-align: inherit;">Durante la ejecuci√≥n del comando, notar√° que el valor del espacio disponible en disco aumentar√°:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd pool <span class="hljs-variable">$pool_name</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$replication_size</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y despu√©s de su finalizaci√≥n, cambiamos los valores de los par√°metros </font></font><code>pg_num</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y de la </font></font><code>pgp_num</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siguiente manera:</font></font><br>
<br>
<pre><code class="bash hljs">ceph osd pool <span class="hljs-built_in">set</span> <span class="hljs-variable">$pool_name</span> pg_num <span class="hljs-variable">$pg_number</span>
ceph osd pool <span class="hljs-built_in">set</span> <span class="hljs-variable">$pool_name</span> pgp_num <span class="hljs-variable">$pg_number</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : debemos cambiar secuencialmente el n√∫mero de PG en cada grupo y no cambiar los valores en otros grupos hasta que desaparezcan las advertencias </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Redundancia de datos degradada"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"n-n√∫mero de pgs degradados"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n puede verificar que todo fue exitoso, de acuerdo con las conclusiones de los comandos </font></font><code>ceph health detail</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>ceph -s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caso No. 3. </font><font style="vertical-align: inherit;">Migraci√≥n de m√°quina virtual de LVM a Ceph RBD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En una situaci√≥n en la que el proyecto utiliza m√°quinas virtuales instaladas en servidores alquilados de metal desnudo, a menudo surge la cuesti√≥n del almacenamiento tolerante a fallas. Y tambi√©n es muy deseable que haya suficiente espacio en este almacenamiento ... Otra situaci√≥n com√∫n: hay una m√°quina virtual con almacenamiento local en el servidor y necesita expandir el disco, pero en ninguna parte, porque no queda espacio libre en el servidor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema se puede resolver de diferentes maneras, por ejemplo, migrando a otro servidor (si hay uno) o agregando nuevos discos al servidor. Pero no siempre es posible hacer esto, por lo que la migraci√≥n de LVM a Ceph puede ser una excelente soluci√≥n a este problema. Al elegir esta opci√≥n, tambi√©n simplificamos el proceso adicional de migraci√≥n entre servidores, ya que no ser√° necesario mover el almacenamiento local de un hipervisor a otro. El √∫nico inconveniente es que tendr√° que detener la VM mientras dure el trabajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se indica en la receta a continuaci√≥n, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tom√≥ </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">un art√≠culo de este blog</font></a><font style="vertical-align: inherit;"> , cuyas instrucciones se probaron en acci√≥n. Por cierto, el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo de migraci√≥n sin obst√°culos tambi√©n se describe all√≠.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, en nuestro caso, simplemente no era necesario, por lo que no lo verificamos. </font><font style="vertical-align: inherit;">Si esto es cr√≠tico para su proyecto, nos complacer√° saber los resultados en los comentarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasemos a la parte pr√°ctica. </font><font style="vertical-align: inherit;">En el ejemplo, usamos virsh y, en consecuencia, libvirt. </font><font style="vertical-align: inherit;">Primero, aseg√∫rese de que el grupo Ceph al que se migrar√°n los datos est√© conectado a libvirt:</font></font><br>
<br>
<pre><code class="bash hljs">virsh pool-dumpxml <span class="hljs-variable">$ceph_pool</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La descripci√≥n del grupo debe contener datos de conexi√≥n Ceph con datos de autorizaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente paso es convertir la imagen LVM a Ceph RBD. </font><font style="vertical-align: inherit;">El tiempo de ejecuci√≥n depende principalmente del tama√±o de la imagen:</font></font><br>
<br>
<pre><code class="bash hljs">qemu-img convert -p -O rbd /dev/main/<span class="hljs-variable">$vm_image_name</span> rbd:<span class="hljs-variable">$ceph_pool</span>/<span class="hljs-variable">$vm_image_name</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de la conversi√≥n, la imagen LVM permanecer√°, lo que ser√° √∫til si no puede migrar la VM a RBD y tiene que revertir los cambios. </font><font style="vertical-align: inherit;">Adem√°s, para poder revertir r√°pidamente los cambios, realizaremos una copia de seguridad del archivo de configuraci√≥n de la m√°quina virtual:</font></font><br>
<br>
<pre><code class="bash hljs">virsh dumpxml <span class="hljs-variable">$vm_name</span> &gt; <span class="hljs-variable">$vm_name</span>.xml<font></font>
cp <span class="hljs-variable">$vm_name</span>.xml <span class="hljs-variable">$vm_name_backup</span>.xml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... y edite el original ( </font></font><code>vm_name.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Busque un bloque con una descripci√≥n del disco (comienza con una l√≠nea </font></font><code>&lt;disk type='file' device='disk'&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y termina con </font></font><code>&lt;/disk&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) y ll√©velo al siguiente formulario:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">disk</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'network'</span> <span class="hljs-attr">device</span>=<span class="hljs-string">'disk'</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">driver</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'qemu'</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">auth</span> <span class="hljs-attr">username</span>=<span class="hljs-string">'libvirt'</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">secret</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'ceph'</span> <span class="hljs-attr">uuid</span>=<span class="hljs-string">'sec-ret-uu-id'</span>/&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">auth</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">'rbd'</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'$ceph_pool/$vm_image_name&gt;
  &lt;host name='</span><span class="hljs-attr">10.0.0.1</span>' <span class="hljs-attr">port</span>=<span class="hljs-string">'6789'</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'10.0.0.2'</span> <span class="hljs-attr">port</span>=<span class="hljs-string">'6789'</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">dev</span>=<span class="hljs-string">'vda'</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">'virtio'</span>/&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">alias</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'virtio-disk0'</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">address</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'pci'</span> <span class="hljs-attr">domain</span>=<span class="hljs-string">'0x0000'</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">'0x00'</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">'0x04'</span> <span class="hljs-attr">function</span>=<span class="hljs-string">'0x0'</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">disk</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo a algunos de los detalles:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El protocolo </font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica la direcci√≥n del almacenamiento en Ceph RBD (esta es la direcci√≥n que indica el nombre del grupo Ceph y la imagen RBD, que se determin√≥ en la primera etapa).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bloque </font></font><code>secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica el tipo </font></font><code>ceph</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as√≠ como el UUID del secreto para conectarse a √©l. </font><font style="vertical-align: inherit;">Su uuid se puede encontrar con el comando </font></font><code>virsh secret-list</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el bloque </font></font><code>host</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se indican </font><font style="vertical-align: inherit;">las </font><font style="vertical-align: inherit;">direcciones a los monitores Ceph.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de editar el archivo de configuraci√≥n y completar la conversi√≥n de LVM a RBD, puede aplicar el archivo de configuraci√≥n modificado e iniciar la m√°quina virtual:</font></font><br>
<br>
<pre><code class="bash hljs">virsh define <span class="hljs-variable">$vm_name</span>.xml<font></font>
virsh start <span class="hljs-variable">$vm_name</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es hora de verificar que la m√°quina virtual se inici√≥ correctamente: puede averiguarlo, por ejemplo, conect√°ndose a trav√©s de SSH o mediante </font></font><code>virsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la m√°quina virtual funciona correctamente y no encontr√≥ otros problemas, puede eliminar la imagen LVM que ya no est√° en uso:</font></font><br>
<br>
<pre><code class="bash hljs">lvremove main/<span class="hljs-variable">$vm_image_name</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la pr√°ctica, encontramos todos los casos descritos; esperamos que las instrucciones ayuden a otros administradores a resolver problemas similares. </font><font style="vertical-align: inherit;">Si tiene comentarios u otras historias similares de la experiencia operativa de Ceph, ¬°nos complacer√° verlos en los comentarios!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea tambi√©n en nuestro blog:</font></font><br>
<br>
<ul>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    :   Rook  K8s</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rook   Rook ‚Äî    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rook ‚Äî ‚Äû‚Äú    Kubernetes</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    provisioning  Kubernetes   Ceph</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495850/index.html">La vida cotidiana de Scrum-Masters: equipo y auto transformaci√≥n</a></li>
<li><a href="../es495852/index.html">LDA en LiveJournal art√≠culos + visualizaci√≥n</a></li>
<li><a href="../es495854/index.html">¬øC√≥mo escapar de Covid y de la vigilancia?</a></li>
<li><a href="../es495856/index.html">Intel DevCloud para oneAPI: un servicio en la nube para desarrolladores que se sientan en casa</a></li>
<li><a href="../es495858/index.html">Remoto y autoaislamiento: experiencia espacial para ayudar a los terr√≠colas</a></li>
<li><a href="../es495880/index.html">El libro "Cabeza primero. Learning Go ¬ª</a></li>
<li><a href="../es495884/index.html">Predicci√≥n de series de tiempo usando redes neuronales recurrentes</a></li>
<li><a href="../es495888/index.html">PyCon Russia ha abierto CFP para futuros oradores. Formularios de participaci√≥n y temas esperados</a></li>
<li><a href="../es495890/index.html">Configuraci√≥n de paquetes Nginx / LetsEncrypt en Docker Swarm</a></li>
<li><a href="../es495892/index.html">¬øRealmente sabes qu√© son las matrices?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>