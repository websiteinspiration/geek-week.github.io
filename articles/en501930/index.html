<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôè üë©üèæ‚Äçüåæ üë®üèº What opportunities does Spring provide for customizing its behavior? üíÜüèæ ü§± üòî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In touch Vladislav Rodin. Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software arc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>What opportunities does Spring provide for customizing its behavior?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501930/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">In touch Vladislav Rodin. </font><font style="vertical-align: inherit;">Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software architecture. </font></font></i><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to teaching, I am also writing copyright material for the OTUS blog on the Haber and I want to coincide with today's article to launch the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Developer on the Spring Framework"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is now open for recruitment.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/pz/w4/uv/pzw4uv5fvldfmljzvc4v3flumdc.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the reader‚Äôs point of view, the application code that uses Spring looks quite simple: some beans are declared, classes are marked with annotations, and then the beans are injected where necessary, everything works fine. But an inquisitive reader has a question: ‚ÄúHow does it work? What's happening?". In this article we will try to answer this question, but not for the sake of satisfying idle curiosity.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring framework is known for being flexible enough and provides options for customizing the behavior of the framework. </font><font style="vertical-align: inherit;">Spring also abounds with a number of rather interesting rules for applying certain annotations (for example, Transactional). </font><font style="vertical-align: inherit;">In order to understand the meaning of these rules, to be able to derive them, and also to understand what and how to configure in Spring, you need to understand several principles of what is in Spring under the hood. </font><font style="vertical-align: inherit;">As you know, the knowledge of several principles exempts from the knowledge of many facts. </font><font style="vertical-align: inherit;">I suggest that you familiarize yourself with these principles below if, of course, you do not already know them.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reading configurations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the very beginning, you need to parse the configurations that are in your application. </font><font style="vertical-align: inherit;">Since there are several types of configurations (xml-, groovy-, java-configurations, configuration based on annotations), different methods are used to read them. </font><font style="vertical-align: inherit;">One way or another, a map of the form Map &lt;String, BeanDefinition&gt; is collected, in which the names of beans are assigned to their bean definitions. </font><font style="vertical-align: inherit;">The objects of the BeanDefinition class are meta-information on beans and contain the bean's id-id, its name, its class, destroy- and init-methods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examples of classes involved in this process: GroovyBeanDefinitionReader, XmlBeanDefinitionReader, AnnotatedBeanDefinitionReader, implementing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanDefinitionReader</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up Beandefinitions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have descriptions of beans, but there are no beans themselves, they have not been created yet. </font><font style="vertical-align: inherit;">Before creating beans, Spring provides the ability to customize the resulting BeanDefinitions. </font><font style="vertical-align: inherit;">For these purposes, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanFactoryPostProcessor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface is </font><b><font style="vertical-align: inherit;">used</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It looks like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BeanFactoryPostProcessor</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method parameter of this interface allows using its own getBeanDefinitionNames method to get the names by which you can get BeanDefinitions from the map and edit them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why might this be needed? </font><font style="vertical-align: inherit;">Suppose that some beans require details to connect to an external system, such as a database. </font><font style="vertical-align: inherit;">We want the beans to be created already with the details, but the details themselves are stored in the property-file. </font><font style="vertical-align: inherit;">We can apply one of the standard BeanFactoryPostProcessors - PropertySourcesPlaceholderConfigurer, which will replace the name property in the BeanDefinition with the actual value stored in the property file. </font><font style="vertical-align: inherit;">That is, it will actually replace Value ("user") with Value ("root") in BeanDefinion. </font><font style="vertical-align: inherit;">For this to work, the PropertySourcesPlaceholderConfigurer, of course, needs to be connected. </font><font style="vertical-align: inherit;">But this is not limited to this; you can register your BeanFactoryPostProcessor, in which you can implement any logic you need to process BeanDefinitions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating Beans</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, we have a map that has the names of beans located by the keys, and the configured BeanDefinitions by the values. Now you need to create these beans. This is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what BeanFactory does</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . But here you can add customization by writing and registering your </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FactoryBean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . FactoryBean is an interface of the form:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FactoryBean</span> </span>{
    <span class="hljs-function">T <span class="hljs-title">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>;<font></font>
    Class&lt;?&gt; getObjectType();<font></font>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isSingleton</span><span class="hljs-params">()</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, a BeanFactory creates a bean itself if there is no FactoryBean corresponding to the bean class, or asks the FactoryBean to create this bean. </font><font style="vertical-align: inherit;">There is a small nuance: if the scope of the bean is singletone, then the bean is created at this stage, if prototype, then every time this bean is needed, it will be requested from the BeanFactory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we again get a map, but it‚Äôs already a little different: the keys contain the names of the beans, and the values ‚Äã‚Äãof the beans themselves. </font><font style="vertical-align: inherit;">But this is true only for singletones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Beans</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now comes the most interesting stage. We have a map containing the created beans, but these beans have not yet been configured. That is, we did not process annotations that set the state of the bean: Autowired, Value. We also did not process annotations that change the behavior of the bean: Transactional, Async. To solve this problem, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BeanPostProcessor's</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allow </font><font style="vertical-align: inherit;">, which again are implementations of the corresponding interface:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BeanPostProcessor</span> </span>{
    <span class="hljs-function">Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException</span>;
    <span class="hljs-function">Object <span class="hljs-title">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see 2 methods with scary but comprehensive names. Both methods take a bean as input, from which you can ask which class it is, and then use the Reflection API to process annotations. Return bean methods, possibly replaced by proxy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each bean before placing it in the context, the following happens: the postProcessBeforeInitialization methods are triggered for all BeanPostProcessors, then the init method is triggered, and then the postProcessAfterInitialization methods are triggered for all BeanPostProcessors too.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These two methods have different semantics: postProcessBeforeInitialization processes state annotations, postProcessAfterInitialization processes behavior, because proxying is used to process the behavior, which can lead to loss of annotations. That is why behavior changes in the last place. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where is customization? We can write our annotation, BeanPostProcessor for it, and Spring will process it. However, for BeanPostProcessor to work, it also needs to be registered as a bean. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, to embed a random number in a field, we create an InjectRandomInt annotation (hung on the fields), create and register an InjectRandomIntBeanPostProcessor, in the first method of which we process the created annotation, and in the second method, we simply return the incoming bean.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To profile the beans, create a Profile annotation that broadcasts to methods, create and register a ProfileBeanPostProcessor, in the first method of which we return the incoming bean, and in the second method, we return a proxy that wraps the call to the original method with clipping and execution time logging.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501914/index.html">Stream Modern Web Live 2020 - Best UX Practices in Indefinite Times</a></li>
<li><a href="../en501918/index.html">The book "Game Design. Recipes for the success of the best computer games from Super Mario and Doom to Assassin's Creed and on ¬ª</a></li>
<li><a href="../en501922/index.html">IoT where you did not wait. Development and testing (part 1)</a></li>
<li><a href="../en501924/index.html">How to build a venn diagram with 50 circles? Visualization of sets and the history of my open source Python project</a></li>
<li><a href="../en501928/index.html">PM online mitap with speakers from Atlassian (Jira), Wrike and Productboard</a></li>
<li><a href="../en501932/index.html">Accelerating the implementation of AI projects in the Segezha forest holding</a></li>
<li><a href="../en501934/index.html">Publish VKUI component design library in Figma</a></li>
<li><a href="../en501938/index.html">Prometheus, don't go: 6 alternative monitoring tools for Kubernetes</a></li>
<li><a href="../en501940/index.html">A bit about Neutralino.js</a></li>
<li><a href="../en501942/index.html">Kanban Method: Understanding Your Process as a Collective Learning Process</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>