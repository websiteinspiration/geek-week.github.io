<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾 🕘 👩🏼‍🏭 PostgreSQL-8のMVCC。凍結 🛋️ 🚣🏿 🤳🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="分離に関連する問題から始め、低レベルでのデータの整理について余談を述べ、行のバージョンとバージョンからスナップショットを取得する方法について詳しく説明しました。
 
 次に、さまざまな種類のクリーニングを検討しました。ページ内（HOT更新と共に）、定期的、自動です。
 
 そして、このサイクルの最後...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL-8のMVCC。凍結</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/455590/"><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分離</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">関連する問題から始め</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、低レベル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">データの整理</font></a><font style="vertical-align: inherit;">について余談</font><font style="vertical-align: inherit;">を述べ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、行のバージョン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とバージョンから</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を取得する方法</font><font style="vertical-align: inherit;">について詳しく説明</font><font style="vertical-align: inherit;">しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、さまざまな種類のクリーニングを検討しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページ内</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（HOT更新と共に）、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定期的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、このサイクルの最後のトピックに行きました。</font><font style="vertical-align: inherit;">今日は、トランザクションIDオーバーフロー（トランザクションIDラップアラウンド）とフリーズの問題について説明します。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションカウンターのオーバーフロー</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLでは、トランザクション番号に32ビットが割り当てられています。これはかなり大きな数（約40億）ですが、サーバーがアクティブに動作していると、使い尽くされる可能性があります。たとえば、1秒あたり1000トランザクションの負荷の場合、これは1か月半の連続操作の後に発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、マルチバージョン管理メカニズムは番号付けのシーケンスに依存しているという事実について話しました。2つのトランザクションのうち、番号が小さいトランザクションが早く開始されたと見なすことができます。したがって、カウンタをリセットして再度番号付けを続けることができないのは明らかです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cn/om/rg/cnomrgflv1bnkqme9k68bit4ad0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクション番号に64ビットが割り当てられていないのはなぜですか？これにより問題が完全に解消されますか？事実は（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">前述の</font></a><font style="vertical-align: inherit;">ように</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）行の各バージョンのヘッダーに2つのトランザクション番号が格納されます-xminとxmax。</font><font style="vertical-align: inherit;">ヘッダーはすでに非常に大きく、少なくとも23バイトであり、ビット深度が増加すると、さらに8バイト増加します。</font><font style="vertical-align: inherit;">これは絶対に方法ではありません。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64ビットのトランザクション番号は、弊社の製品であるPostgres Pro Enterpriseに実装されていますが、完全に正直なわけではありません。xminとxmaxは32ビットのままで、ページの見出しには、ページ全体に共通する「時代の始まり」が含まれています。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何をすべきか？線形図の代わりに、すべてのトランザクション番号がループバックされます。どのトランザクションでも、反時計回りの数字の半分は過去に属し、半分は「時計回り」に未来と見なされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションの経過時間は、システムに表示されてから経過したトランザクションの数です（カウンターがゼロを通過したかどうかに関係なく）。あるトランザクションが別のトランザクションより古いかどうかを知りたい場合は、数値ではなく、それらの年齢を比較します。 （したがって、xidデータ型には、「より大きい」および「より小さい」という演算は定義されていません。）</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8f/rk/ft/8frkftw38-c0-yfbjaz7m-au3va.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、そのようなループ回路では、不愉快な状況が発生します。</font><font style="vertical-align: inherit;">遠い過去のトランザクション（図のトランザクション1）は、しばらくすると、将来に関係する円の半分になります。</font><font style="vertical-align: inherit;">もちろん、これは可視性のルールに違反し、問題を引き起こします-トランザクション1によって加えられた変更は単に表示されなくなります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qp/vy/ag/qpvyagxruu4gik-rof6eqoxk1e4.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョンの凍結と可視性のルール</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような過去から未来への「移動」を防ぐために、クリーニングプロセス（ページのスペースを解放することに加えて）は別のタスクを実行します。彼はラインのかなり古いバージョンと「コールド」バージョンを見つけ（すべての画像に表示され、その変更はすでにありそうにありません）、特別な方法でマークします-それらを「フリーズ」します。行の凍結バージョンは、通常のデータよりも古いと見なされ、すべてのデータスナップショットで常に表示されます。さらに、トランザクション番号xminを確認する必要がなくなり、この番号を安全に再利用できます。したがって、文字列の凍結バージョンは常に過去のままです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2c/vn/yp/2cvnypkp70pikgco9rzjjiccob0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクション番号xminを凍結済みとしてマークするために、両方のヒントビットが同時に設定されます（コミットビットとキャンセルビット）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xmaxトランザクションは凍結する必要がないことに注意してください。</font><font style="vertical-align: inherit;">その存在は、このバージョンの文字列が関連しなくなったことを意味します。</font><font style="vertical-align: inherit;">データスナップショットに表示されなくなると、このバージョンの行は消去されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験の場合は、テーブルを作成します。</font><font style="vertical-align: inherit;">各ページに2行のみが収まるように、最小のfillfactorを設定します。これにより、何が起こっているのかを観察することがより便利になります。</font><font style="vertical-align: inherit;">オートメーションをオフにして、清掃時間を自分で制御します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tfreeze(<font></font>
  id <span class="hljs-type">integer</span>,<font></font>
  s <span class="hljs-type">char</span>(<span class="hljs-number">300</span>)<font></font>
) <span class="hljs-keyword">WITH</span> (fillfactor = <span class="hljs-number">10</span>, autovacuum_enabled = <span class="hljs-keyword">off</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数のいくつかのバリアントをすでに作成しており、pageinspect拡張機能を使用して、ページ上の行のバージョンを示しています。</font><font style="vertical-align: inherit;">次に、同じ関数の別のバリアントを作成します。これにより、一度に複数のページが表示され、xminトランザクションの経過時間が表示されます（このためにシステム関数の経過時間が使用されます）。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> heap_page(relname <span class="hljs-type">text</span>, pageno_from <span class="hljs-type">integer</span>, pageno_to <span class="hljs-type">integer</span>)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(ctid tid, state <span class="hljs-type">text</span>, xmin <span class="hljs-type">text</span>, xmin_age <span class="hljs-type">integer</span>, xmax <span class="hljs-type">text</span>, t_ctid tid)
<span class="hljs-keyword">AS</span> $$<span class="pgsql">
<span class="hljs-keyword">SELECT</span> (pageno,lp)::<span class="hljs-type">text</span>::tid <span class="hljs-keyword">AS</span> ctid,
       <span class="hljs-keyword">CASE</span> lp_flags
         <span class="hljs-keyword">WHEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'unused'</span>
         <span class="hljs-keyword">WHEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'normal'</span>
         <span class="hljs-keyword">WHEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'redirect to '</span>||lp_off
         <span class="hljs-keyword">WHEN</span> <span class="hljs-number">3</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'dead'</span>
       <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> state,
       t_xmin || <span class="hljs-keyword">CASE</span>
         <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">256</span>+<span class="hljs-number">512</span>) = <span class="hljs-number">256</span>+<span class="hljs-number">512</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">' (f)'</span>
         <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">256</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">' (c)'</span>
         <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">512</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">' (a)'</span>
         <span class="hljs-keyword">ELSE</span> <span class="hljs-string">''</span>
       <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> xmin,
      age(t_xmin) xmin_age,
       t_xmax || <span class="hljs-keyword">CASE</span>
         <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">1024</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">' (c)'</span>
         <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">2048</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">' (a)'</span>
         <span class="hljs-keyword">ELSE</span> <span class="hljs-string">''</span>
       <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> xmax,
       t_ctid
<span class="hljs-keyword">FROM</span> generate_series(pageno_from, pageno_to) p(pageno),
     heap_page_items(get_raw_page(relname, pageno))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pageno, lp;
$$</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
凍結の兆候（括弧内の文字fで示されます）は、コミットされたプロンプトと中止されたプロンプトの同時インストールによって決定されることに注意してください。多くのソース（ドキュメントを含む）は、凍結されたトランザクションをマークする特別な番号FrozenTransactionId = 2について言及しています。このようなシステムはバージョン9.4まで動作していましたが、現在はツールチップビットに置き換えられています。これにより、元のトランザクション番号をラインバージョンに保存できるため、サポートとデバッグに便利です。ただし、2番のトランザクションは、最新バージョンにアップグレードされたとしても、古いシステムでも発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、可視性マップを調べることができるpg_visibility拡張機能も必要です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> pg_visibility;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL 9.6より前のバージョンでは、可視性マップにはページごとに1ビットが含まれていました。</font><font style="vertical-align: inherit;">すべての画像で表示されることが既に保証されている文字列の「かなり古い」バージョンのみを含むページをマークしました。</font><font style="vertical-align: inherit;">ここでの考え方は、ページが可視性マップでマークされている場合、その行のバージョンでは、可視性ルールを確認する必要がないということです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン9.6から、フリーズマップが同じレイヤーに追加されました-ページごとに1ビット。</font><font style="vertical-align: inherit;">凍結マップは、すべての行バージョンが凍結されているページをマークします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルに複数の行を挿入し、すぐにクリーニングを実行して可視性マップを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tfreeze(id, s)
  <span class="hljs-keyword">SELECT</span> g.id, <span class="hljs-string">'FOO'</span> <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>) g(id);<font></font>
=&gt; <span class="hljs-keyword">VACUUM</span> tfreeze;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、両方のページが可視性マップ（all_visible）でマークされているが、まだフリーズされていない（all_frozen）ことがわかります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) g(blkno), pg_visibility_map(<span class="hljs-string">'tfreeze'</span>,g.blkno)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.blkno;
</code></pre><pre><code class="plaintext hljs"> blkno | all_visible | all_frozen <font></font>
-------+-------------+------------<font></font>
     0 | t           | f<font></font>
     1 | t           | f<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行を作成したトランザクション（xmin_age）の経過時間は1です。これは、システムで実行された最後のトランザクションです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> heap_page(<span class="hljs-string">'tfreeze'</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
</code></pre><pre><code class="plaintext hljs"> ctid  | state  |  xmin   | xmin_age | xmax  | t_ctid <font></font>
-------+--------+---------+----------+-------+--------<font></font>
 (0,1) | normal | 697 (c) |        1 | 0 (a) | (0,1)<font></font>
 (0,2) | normal | 697 (c) |        1 | 0 (a) | (0,2)<font></font>
 (1,1) | normal | 697 (c) |        1 | 0 (a) | (1,1)<font></font>
 (1,2) | normal | 697 (c) |        1 | 0 (a) | (1,2)<font></font>
(4 rows)<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">凍結の最低年齢</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つの主要なパラメーターがフリーズを制御し、それらを順に検討します。</font><font style="vertical-align: inherit;">文字列バージョンを凍結できる最小トランザクション</font><em><font style="vertical-align: inherit;">経過時間</font></em><font style="vertical-align: inherit;"> xminを定義する</font><em><font style="vertical-align: inherit;">vacuum_freeze_min_age</font></em><font style="vertical-align: inherit;">から</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
始めましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この値が小さいほど、不要なオーバーヘッドコストが大きくなる可能性があります。「ホット」で積極的にデータを変更している場合、フリーズはますます多くなり、何の利点もなく新しいバージョンが消えます。</font><font style="vertical-align: inherit;">この場合、待機することをお勧めします。</font><font style="vertical-align: inherit;">
このパラメーターのデフォルト値は、他のトランザクションが出現してから5000万が経過した後にトランザクションがフリーズし始めることを決定します。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SHOW</span> vacuum_freeze_min_age;
</code></pre><pre><code class="plaintext hljs"> vacuum_freeze_min_age <font></font>
-----------------------<font></font>
 50000000<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
凍結がどのように発生するかを確認するために、このパラメーターの値を1に減らします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> vacuum_freeze_min_age = <span class="hljs-number">1</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ゼロページの1行を更新します。</font><font style="vertical-align: inherit;">fillfactor値が小さいため、新しいバージョンは同じページに移動します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">UPDATE</span> tfreeze <span class="hljs-keyword">SET</span> s = <span class="hljs-string">'BAR'</span> <span class="hljs-keyword">WHERE</span> id = <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データページに表示される内容は次のとおりです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> heap_page(<span class="hljs-string">'tfreeze'</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
</code></pre><pre><code class="plaintext hljs"> ctid  | state  |  xmin   | xmin_age | xmax  | t_ctid <font></font>
-------+--------+---------+----------+-------+--------<font></font>
 (0,1) | normal | 697 (c) |        2 | 698   | (0,3)<font></font>
 (0,2) | normal | 697 (c) |        2 | 0 (a) | (0,2)<font></font>
 (0,3) | normal | 698     |        1 | 0 (a) | (0,3)<font></font>
 (1,1) | normal | 697 (c) |        2 | 0 (a) | (1,1)<font></font>
 (1,2) | normal | 697 (c) |        2 | 0 (a) | (1,2)<font></font>
(5 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_freeze_min_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 1 </font><font style="vertical-align: inherit;">より古い行</font><font style="vertical-align: inherit;">が凍結されます。</font><font style="vertical-align: inherit;">ただし、可視性マップでゼロ行がマークされておらず（ビットがUPDATEコマンドによってリセットされ、ページが変更された）、最初の行はチェックされたままであることに注意してください。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) g(blkno), pg_visibility_map(<span class="hljs-string">'tfreeze'</span>,g.blkno)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.blkno;
</code></pre><pre><code class="plaintext hljs"> blkno | all_visible | all_frozen <font></font>
-------+-------------+------------<font></font>
     0 | f           | f<font></font>
     1 | t           | f<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すでに述べてきた</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことのクリーニングが可視性マップにマークされていないページだけをスキャンします。</font><font style="vertical-align: inherit;">そしてそれは判明しました：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">VACUUM</span> tfreeze;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> heap_page(<span class="hljs-string">'tfreeze'</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
</code></pre><pre><code class="plaintext hljs"> ctid  |     state     |  xmin   | xmin_age | xmax  | t_ctid <font></font>
-------+---------------+---------+----------+-------+--------<font></font>
 (0,1) | redirect to 3 |         |          |       | <font></font>
 (0,2) | normal        | 697 (f) |        2 | 0 (a) | (0,2)<font></font>
 (0,3) | normal        | 698 (c) |        1 | 0 (a) | (0,3)<font></font>
 (1,1) | normal        | 697 (c) |        2 | 0 (a) | (1,1)<font></font>
 (1,2) | normal        | 697 (c) |        2 | 0 (a) | (1,2)<font></font>
(5 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゼロページでは、1つのバージョンがフリーズされていますが、最初のページはクリーニングをまったく考慮していませんでした。</font><font style="vertical-align: inherit;">したがって、現在のバージョンのみがページに残っている場合、クリーニングはそのようなページに到達せず、フリーズしません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) g(blkno), pg_visibility_map(<span class="hljs-string">'tfreeze'</span>,g.blkno)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.blkno;
</code></pre><pre><code class="plaintext hljs"> blkno | all_visible | all_frozen <font></font>
-------+-------------+------------<font></font>
     0 | t           | f<font></font>
     1 | t           | f<font></font>
(2 rows)<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル全体を凍結する年齢</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングで確認できないページに残っている行のバージョンを引き続きフリーズするために、2番目のパラメーター、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_freeze_table_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が提供されています</font><font style="vertical-align: inherit;">。クリーンアップが可視性マップを無視し、テーブルのすべてのページを通過してフリーズするトランザクションの経過時間を決定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各テーブルはトランザクション番号を格納します。これについては、古いトランザクションはすべて凍結されることが保証されています（pg_class.relfrozenxid）。この記憶されたトランザクションの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古さ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、</font><em><font style="vertical-align: inherit;">vacuum_freeze_table_age</font></em><font style="vertical-align: inherit;">パラメータの値が</font><em><font style="vertical-align: inherit;">比較され</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> relfrozenxid, age(relfrozenxid) <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">'tfreeze'</span>;
</code></pre><pre><code class="plaintext hljs"> relfrozenxid | age <font></font>
--------------+-----<font></font>
          694 |   5<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL 9.6より前のバージョンでは、クリーンアップで全テーブルスキャンが実行され、すべてのページが確実にクロールされました。大きなテーブルの場合、この操作は長くて悲しいものでした。この問題は、クリーニングが最後まで到達しなかった場合（たとえば、せっかちな管理者がコマンドの実行を中断した場合）、最初から開始する必要があるという事実によって悪化しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン9.6以降、フリーズマップ（pg_visibility_map出力のall_frozen列に表示される）のおかげで、クリアすると、マップでまだマークされていないページのみがバイパスされます。これは作業量がはるかに少ないだけでなく、中断に対する抵抗でもあります。クリーニングプロセスが停止して再開された場合、前回フリーズマップでマークしたページをもう一度見る必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何らかの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
方法で、テーブル内のすべてのページが（</font><em><font style="vertical-align: inherit;">vacuum_freeze_table_age</font></em><font style="vertical-align: inherit;"> - </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_freeze_min_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）トランザクションで</font><font style="vertical-align: inherit;">1回凍結され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">デフォルト値では、これは100万トランザクションごとに1回発生します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SHOW</span> vacuum_freeze_table_age;
</code></pre><pre><code class="plaintext hljs"> vacuum_freeze_table_age <font></font>
-------------------------<font></font>
 150000000<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font><font style="vertical-align: inherit;">オーバーヘッドを減らす代わりに、これはそれらを増やし始めるので、</font><font style="vertical-align: inherit;">あまりにも多くの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_freeze_min_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を設定すべきでない</font><font style="vertical-align: inherit;">ことは明らかです</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブル全体がどのように凍結されるかを見てみましょう。これを行うには、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_freeze_table_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を5 </font><font style="vertical-align: inherit;">に減らし</font><font style="vertical-align: inherit;">て、凍結の条件が満たされるようにします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> vacuum_freeze_table_age = <span class="hljs-number">5</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
掃除しましょう：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">VACUUM</span> tfreeze;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、テーブル全体が検証されることが保証されたため、凍結されたトランザクションの数を増やすことができます。ページに古い凍結されていないトランザクションがないことは確実です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> relfrozenxid, age(relfrozenxid) <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">'tfreeze'</span>;
</code></pre><pre><code class="plaintext hljs"> relfrozenxid | age <font></font>
--------------+-----<font></font>
          698 |   1<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、最初のページの行のすべてのバージョンが凍結されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> heap_page(<span class="hljs-string">'tfreeze'</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
</code></pre><pre><code class="plaintext hljs"> ctid  |     state     |  xmin   | xmin_age | xmax  | t_ctid <font></font>
-------+---------------+---------+----------+-------+--------<font></font>
 (0,1) | redirect to 3 |         |          |       | <font></font>
 (0,2) | normal        | 697 (f) |        2 | 0 (a) | (0,2)<font></font>
 (0,3) | normal        | 698 (c) |        1 | 0 (a) | (0,3)<font></font>
 (1,1) | normal        | 697 (f) |        2 | 0 (a) | (1,1)<font></font>
 (1,2) | normal        | 697 (f) |        2 | 0 (a) | (1,2)<font></font>
(5 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、最初のページはフリーズマップでマークされます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) g(blkno), pg_visibility_map(<span class="hljs-string">'tfreeze'</span>,g.blkno)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.blkno;
</code></pre><pre><code class="plaintext hljs"> blkno | all_visible | all_frozen <font></font>
-------+-------------+------------<font></font>
     0 | t           | f<font></font>
     1 | t           | t<font></font>
(2 rows)<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「積極的な」対応の時代</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行バージョンが時間どおりにフリーズすることが重要です。</font><font style="vertical-align: inherit;">まだ凍結されていないトランザクションが将来に入るリスクがある状況が発生した場合、潜在的な問題を防ぐためにPostgreSQLがクラッシュします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これの理由は何でしょうか？</font><font style="vertical-align: inherit;">さまざまな理由があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニングをオフにでき、通常のクリーニングも開始されません。</font><font style="vertical-align: inherit;">これは必須ではないと既に述べましたが、技術的には可能です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含まれている自動クリーニングでも、使用されていないデータベースには</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到達し</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ません（</font><em><font style="vertical-align: inherit;">track_counts</font></em><font style="vertical-align: inherit;">パラメーター</font><font style="vertical-align: inherit;">とtemplate0データベースを</font><font style="vertical-align: inherit;">思い出してください</font><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">たように</font></a><font style="vertical-align: inherit;">、クリーニングはデータが追加されるだけで削除または変更されないテーブルをスキップします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような場合、「積極的な」</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニング</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作が提供され、</font><em><font style="vertical-align: inherit;">autovacuum_freeze_max_age</font></em><font style="vertical-align: inherit;">パラメーターによって規制されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">任意のデータベースの任意のテーブルで、パラメーターで指定された経過日数より古いフリーズされていないトランザクションが存在する可能性がある場合、自動クリーニングは（無効になっている場合でも）強制的に開始され、遅かれ早かれ問題のテーブルに到達します（通常の基準にもかかわらず）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルト値はかなり控えめです：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SHOW</span> autovacuum_freeze_max_age;
</code></pre><pre><code class="plaintext hljs"> autovacuum_freeze_max_age <font></font>
---------------------------<font></font>
 200000000<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_freeze_max_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の制限</font><font style="vertical-align: inherit;">は20億トランザクションであり、10倍小さい値が使用されます。これは理にかなっています。値を大きくすることで、残りの時間で自動クリーニングに必要なバージョンの文字列をすべて凍結する時間がないというリスクも高まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このパラメーターの値はXACT構造のサイズを決定します。ステータスを確認する必要のある古いトランザクションはシステムにないため、自動クリーニングにより不要なXACTセグメントファイルが削除され、スペースが解放されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例としてtfreezeを使用して、クリーニングが追加専用テーブルを処理する方法を見てみましょう。このテーブルでは、通常、自動クリーニングは無効になっていますが、これは障害にはなりません。</font><em><font style="vertical-align: inherit;">autovacuum_freeze_max_ageを</font></em></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
変更</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの再起動が必要です。ただし、前述のすべてのパラメータは、ストレージパラメータを使用して個々のテーブルのレベルで設定することもできます。通常、これは、テーブルが本当に特別な注意を必要とする特別な場合にのみ意味があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font><font style="vertical-align: inherit;">テーブルレベルで</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_freeze_max_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を設定し</font><font style="vertical-align: inherit;">ます（同時に通常のfillfactorも返します）。残念ながら、可能な最小値は100,000です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> tfreeze <span class="hljs-keyword">SET</span> (autovacuum_freeze_max_age = <span class="hljs-number">100000</span>, fillfactor = <span class="hljs-number">100</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、私たちに関心のある状況を再現するには、100,000件のトランザクションを完了する必要があります。</font><font style="vertical-align: inherit;">しかし、もちろん、実際には、これは非常に低い値です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを追加するので、トランザクションにそれぞれ100,000行をテーブルに挿入します。</font><font style="vertical-align: inherit;">繰り返しますが、実際にはこれを行うべきではないことを予約する必要があります。</font><font style="vertical-align: inherit;">しかし、今は探索しているだけです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> foo(id <span class="hljs-type">integer</span>) <span class="hljs-keyword">AS</span> $$<span class="pgsql">
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tfreeze <span class="hljs-keyword">VALUES</span> (id, <span class="hljs-string">'FOO'</span>);
  <span class="hljs-keyword">COMMIT</span>;
<span class="hljs-keyword">END</span>;
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;<font></font>
<font></font>
=&gt; <span class="hljs-keyword">DO</span> $$<span class="pgsql">
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">101</span> .. <span class="hljs-number">100100</span> <span class="hljs-keyword">LOOP</span>
    <span class="hljs-keyword">CALL</span> foo(i);
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見てわかるように、テーブル内の最後に凍結されたトランザクションの経過時間がしきい値を超えています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> relfrozenxid, age(relfrozenxid) <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">'tfreeze'</span>;
</code></pre><pre><code class="plaintext hljs"> relfrozenxid |  age   <font></font>
--------------+--------<font></font>
          698 | 100006<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、少し待つと、サーバーのメッセージログに、テーブル「test.public.tfreeze」の自動アグレッシブバキュームに関するエントリがあり、凍結されたトランザクションの数が変化し、経過時間が良性に戻ります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> relfrozenxid, age(relfrozenxid) <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">'tfreeze'</span>;
</code></pre><pre><code class="plaintext hljs"> relfrozenxid | age <font></font>
--------------+-----<font></font>
       100703 |   3<font></font>
(1 row)<font></font>
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチトランザクションのフリーズなどもありますが、それについてはまだ説明しません。先に進まないように、ロックについて説明するまで延期します。</font></font><br>
</blockquote><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動凍結</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動クリーニングの到着を待つよりも、フリーズを手動で制御する方が便利な場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VACUUM FREEZEコマンドを使用して、コマンドを手動で凍結できます—トランザクションの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">経過時間</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関係なく、すべての行バージョンが凍結されます（</font><em><font style="vertical-align: inherit;">autovacuum_freeze_min_age</font></em><font style="vertical-align: inherit;"> = 0 </font><font style="vertical-align: inherit;">パラメーターのように</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">テーブルがVACUUM FULLまたはCLUSTERコマンドで再構築されると、すべての行も凍結されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのデータベースを凍結するには、ユーティリティを使用できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">vacuumdb --all --freeze
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FREEZEパラメーターを指定することにより、COPYコマンドを使用して初期ロード中にデータを凍結することもできます。これを行うには、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
COPY </font><font style="vertical-align: inherit;">と同じ</font><font style="vertical-align: inherit;">トランザクションで</font><font style="vertical-align: inherit;">テーブルを作成（またはTRUNCATEコマンドで空にする）する必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フリーズされた行には個別の可視性ルールがあるため、このような行は、通常の分離ルールに違反して他のトランザクションからのデータのスナップショットに表示されます（これは、反復可能読み取りまたはシリアル化可能レベルのトランザクションに適用されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを確認するには、別のセッションで、反復可能読み取り分離レベルでトランザクションを開始します。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">REPEATABLE</span> <span class="hljs-keyword">READ</span>;<font></font>
|  =&gt; <span class="hljs-keyword">SELECT</span> txid_current();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このトランザクションはデータのスナップショットを作成しましたが、tfreezeテーブルにはアクセスしなかったことに注意してください。</font><font style="vertical-align: inherit;">次に、1つのトランザクションでtfreezeテーブルを空にし、新しい行をロードします。</font><font style="vertical-align: inherit;">並列トランザクションがtfreezeの内容を読み取る場合、TRUNCATEコマンドはトランザクションが終了するまでロックされます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">TRUNCATE</span> tfreeze;<font></font>
=&gt; <span class="hljs-keyword">COPY</span> tfreeze <span class="hljs-keyword">FROM stdin</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">FREEZE</span>;
</code></pre><pre><code class="plaintext hljs">1	FOO<font></font>
2	BAR<font></font>
3	BAZ<font></font>
\.<font></font>
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで並列トランザクションは新しいデータを認識しますが、これにより分離が解除されます。 </font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> tfreeze;
</code></pre><pre><code class="plaintext hljs">|   count <font></font>
|  -------<font></font>
|       3<font></font>
|  (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このようなデータのロードは定期的に発生する可能性は低いため、通常これは問題になりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに悪いことに、COPY WITH FREEZEは可視性マップでは機能しません-ロードされたページは、誰にでも見える行のバージョンのみを含むものとしてマークされません。</font><font style="vertical-align: inherit;">したがって、最初にテーブルにアクセスすると、クリーニングによってすべてが再処理され、可視性マップが作成されます。</font><font style="vertical-align: inherit;">さらに悪いことに、データページのヘッダーには完全な可視性の兆候があるため、クリーニングを行うとテーブル全体が読み取られるだけでなく、完全に再書き込みされ、目的のビットが書き込まれます。</font><font style="vertical-align: inherit;">残念ながら、この問題の解決策はバージョン13（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスカッション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">前に待つ必要はありません</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、PostgreSQLの分離とマルチバージョンに関する私の一連の記事は終わりです。</font><font style="vertical-align: inherit;">あなたの注意、特にコメントをありがとう-彼らは材料を改善し、しばしば私の側でより注意深い注意が必要な領域を指摘します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちと一緒に、続けてください！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja455579/index.html">タッパーウェア：FacebookキラーKubernetes？</a></li>
<li><a href="../ja455582/index.html">店内でのナビゲーション：拡張現実を通して目的の棚に</a></li>
<li><a href="../ja455584/index.html">会社の内部力とのカスタムインタビュー：エラーから発見まで</a></li>
<li><a href="../ja455586/index.html">ドイツ、ボーフムの神経情報学研究所（INI）所長、グレゴールシェーナー教授によるロボット工学の講義シリーズ</a></li>
<li><a href="../ja455588/index.html">タンバリンと踊らないようにコミュニティを教育する方法</a></li>
<li><a href="../ja455592/index.html">物理的セキュリティへの脅威として産業企業を攻撃するウイルス</a></li>
<li><a href="../ja455594/index.html">Windows 10でのCVEからRCEへのMicrosoft Edge</a></li>
<li><a href="../ja455596/index.html">DevConfX ::管理-簡単な言葉での管理レポート</a></li>
<li><a href="../ja455598/index.html">Eximを4.92に早急にアップグレードします-アクティブな感染があります</a></li>
<li><a href="../ja455600/index.html">3DEXPERIENCEプラットフォームが未来の公共交通機関の構築を支援</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>