<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöø üë®‚Äçüé§ üë®‚Äçüë®‚Äçüë¶ Pocket weather station üë∞ üõ¥ ‚úåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yes, the weather station is about something that measures a huge number of parameters from the direction and strength of the wind to the level of sola...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pocket weather station</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486988/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, the weather station is about something that measures a huge number of parameters from the direction and strength of the wind to the level of solar radiation, but there was no more suitable term, so you have to mislead. </font><font style="vertical-align: inherit;">But about the size, everything is fair.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/vf/yl/sbvfylae2jg5ca22n6incvh0_le.jpeg"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The device, perhaps, does not have much commercial value, because </font><font style="vertical-align: inherit;">even in the amount of components, it is inferior to many Chinese, and not only </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">goods</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that have similar functionality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DIY is also difficult to name because of such things as the need to order printed circuit boards with subsequent soldering of small / lead-free components, which greatly reduces the number of people who want to repeat the device. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The weather station itself was created as something, I want to think, aesthetic, compact and able to quickly assess the temperature + humidity around, and once the selected sensor can also tell about pressure, then this too. </font><font style="vertical-align: inherit;">Everything looks something like this (clickable):</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/xy/6q/1n/xy6q1n0mungrju5uff3k_qznrhw.jpeg"></div></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/pa/ur/8t/paur8tgioddbzxqzwbkywgcr9pg.jpeg"></div><br>
</a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compared:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/on/6z/bi/on6zbi8c1riuymare1htfaoy3gy.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About iron.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a sensor, the BOSCH-BME280 was chosen, which gives the required environmental parameters even according to I2C, even according to SPI, eight legs in a leadless LGA case measuring 2.5 x 2.5 mm - relatively inexpensive, tiny. Initially, a more sophisticated sensor was planned from the same BME680 series, which, in addition to temperature, humidity and atmospheric pressure, according to the datasheet, can also evaluate air quality by the so-called Index for Air Quality (IAQ). It seems to be not bad, but in fact it turned out that IAQ can only be obtained using BSEC: Bosch Software Environmental Cluster, which, based on the sensor readings and changing these readings, calculates the IAQ. It would seem that you can take the testimony yourself and calculate everything; Not certainly in that way. Upon request for measuring air quality, the sensor gives resistance, in ohms.It heats the inside of a small sensitive area that reacts with conductivity to the presence of volatile organic substances - Volatile Organic Compounds (VOC), and gives the result i.e. resistance to this area. Basically,</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some craftsmen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> offer their own algorithms for interpreting these readings without BSEC, but, among other things, the multiple cost, in comparison with the BME280, left no choice.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xm/6f/ua/xm6fuaet6jexqzojp2ijibwk8yg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The display consists of two TOS-F2101, these are ordinary seven-segment indicators of green color with a common cathode. </font><font style="vertical-align: inherit;">Of the notable, this is the size and housing for surface mounting, allowing you to place them in an unconventional way. </font><font style="vertical-align: inherit;">By the way, these are the smallest planar indicators that were found on sale, and they, for the most part, determine the size of the entire device.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mv/s2/ur/mvs2urkyspmxu99dx60ynxqs0ju.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manages all STM32F072 in a 48-pin QFPN package. </font><font style="vertical-align: inherit;">Selected, again, based on the size, availability of peripherals and the required number of conclusions for controlling indicators, which, in the dual version, for some reason, do not occur and the conclusions need to be decently.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dd/1q/ph/dd1qph6m-u11ozvyb8nudzl1mf0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rest is resistors, capacitors, a 3.3 V voltage converter, the smaller - the better, within reasonable limits and TTX components, of course. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The USB connector is made on the board. For reliable contact, the thickness of the PCB should be approximately 2 mm. If you are guided by the drawing on USB Type-A, then there is a little more, but if you take into account the mask on both sides, it turns out quite tolerably. Of course, this format of the connector leaves more chances for mechanical damage to the USB outlet, but, by and large, this can be dealt with using a regular flash drive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The touch button is a round polygon under the picture on the board, the button responds to a short and long touch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the display, the board has three LEDs that indicate which of the readings is currently displayed on the indicator.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for the software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program is written using CMSIS, the operating frequency is 48 MHz and from an internal source; there is one here, you can even use USB with it without using external quartz. For flexibility and, possibly, expansion of functionality, FreeRTOS is added.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The touch button is handled by the Touch sensing controller (TSC). Since there is no keyboard from the touch buttons on the board, or sliders, when the touch pads are combined in a line, and there is one sensor that captures short and long touches, there is no sense in using the comprehensive library from ST. The principle of operation of the sensor sensor is simple, there are several conclusions combined in groups, a capacitor (Sampling capasitor) Cs is connected to one of them, this conclusion becomes exemplary, the remaining conclusions of the group can be connected to the polygons of the sensors, which in fact are also Cx capacitors . The controller charges the capacitance of the landfill capacitor Cx and then this charge distills into the model Cs, the operation is repeated until a certain voltage limit on Cs. Sensor capacity is usually small,therefore, many such operations will be required and there is a separate register (TSC_IOGxCR) for counting. If you touch the sensor, then the capacitance Cx will become larger and the cycles for charging Cs will be needed less, this is immediately fixed and a touch is reported upward. By the way, the sensor capacitance begins to increase when there is no direct touch, so the sensor can be protected from physical contact, for example with a mask, or you can record different degrees of approximation.or fix different degrees of approximation.or fix different degrees of approximation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To communicate with the BME280, the I2C interface is used. </font><font style="vertical-align: inherit;">The implementation of I2C in STM32F072 is simpler than in the popular STM32F103, among other things, you do not need to track separately 1/2 / many bytes received, it is enough to specify their number in advance (I2C_CR2.NBYTES [7: 0]). </font><font style="vertical-align: inherit;">The very same library for working with the sensor is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provided</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and recommended for use by the manufacturer of the sensor. </font><font style="vertical-align: inherit;">In order to read the readings using the library, you need to create two structures - for settings and data. </font><font style="vertical-align: inherit;">In the settings you need to make:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sensor address on I2C bus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I2C read / write functions as well as delay function</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the number of readings of indications for averaging (Oversmpling) x1, x2, etc., for each of the parameters temperature / humidity / pressure</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filtering coefficient for ADC</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">period of removal of parameter values</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in general, which of the parameters can be read, for example, you can leave one temperature</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operating mode, "normal" - with periodic readings, "forced" - taking readings on request</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In principle, if the ‚Äúnormal‚Äù mode is selected, then the actual values ‚Äã‚Äãof the readings can be obtained by running the function ‚Äúbme280_get_sensor_data‚Äù, it will look at the corresponding sensor registers, read the direct readings, and then process them in accordance with the correction factors recorded in the microcircuit at the factory. </font><font style="vertical-align: inherit;">As a result, the output data structure will contain the temperature in degrees Celsius, relative humidity in percent, atmospheric pressure in Pascals. </font><font style="vertical-align: inherit;">In the "forced" mode, the same thing, only every time before reading the readings, you need to run the conversion "bme280_set_sensor_mode".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The general principle of the device is as follows: connect to USB, or to Power Bank in a mobile version. For the initial display and switching of readings - a short touch of the sensor, to disable - a long touch. First, the temperature in degrees Celsius is displayed, then the relative humidity in percent and atmospheric pressure in millimeters of mercury, because there are only two indicators, and the pressure indicator rarely goes beyond seven hundred, then the number seven is virtual here. If you do not touch the sensor for a while, the indicators will turn off so that, for example, you do not discharge the Power Bank. The average consumption of the device is ~ 50 mA, and the main consumers are just indicators, if you turn them off, the account goes to microamps.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/os/yc/m4/osycm4d_nxftmdscyosimsmxyqu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/9g/of/6q/9gof6qylzgjq2zeba4rkgumqvze.jpeg"></div><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/n91MdTEM7X4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the total cost of the components in January 2020 turned out to be about 850 rubles, this is without taking into account the board, it went easy, </font><font style="vertical-align: inherit;">the manufacturer had New Year discounts, and I have coupons, but this is unlikely to happen again in the near future, at least until next December. </font><font style="vertical-align: inherit;">Well, those who want to familiarize themselves with the source can do it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486976/index.html">Problems of Russian information education and their possible solutions</a></li>
<li><a href="../en486978/index.html">Field Notes: One of the Biggest OpenSource Conferences FOSDEM 2020</a></li>
<li><a href="../en486980/index.html">Kim Dotcom: Caught, the most wanted person online. Part 1</a></li>
<li><a href="../en486982/index.html">How to learn front-end development, find your first job and not get bumps</a></li>
<li><a href="../en486984/index.html">Python Gateway at InterSystems IRIS</a></li>
<li><a href="../en486994/index.html">Angular: Integration Testing (Shallow testing)</a></li>
<li><a href="../en486998/index.html">Cheap and fast check thermal printer printing</a></li>
<li><a href="../en487000/index.html">Citrus: Style Set for AvaloniaUI</a></li>
<li><a href="../en487002/index.html">Augmented Reality Marketing: What It Is and How It Works</a></li>
<li><a href="../en487004/index.html">Why more and more US states are returning network neutrality - discuss the course of events</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>