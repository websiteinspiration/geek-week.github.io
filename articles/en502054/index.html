<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìô üë®üèΩ‚Äçüåæ üë®üèª‚Äçüè≠ Convolutional neural network and its integration in iOS (part 2) üíÉüèº ‚òÇÔ∏è ‚ô£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, we prepared the data, and also examined the implementation tools and the architecture of the neural network ( link ). Let's star...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Convolutional neural network and its integration in iOS (part 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502054/"><img src="https://habrastorage.org/webt/fk/nn/iv/fknnivkxwzilkr5dzw_mstec7bk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous part, we prepared the data, and also examined the implementation tools and the architecture of the neural network ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Let's start the next stage of development with data preprocessing. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrades</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Keras provides a wide range of tools for data preprocessing, especially for images. </font><font style="vertical-align: inherit;">The ImageDataGenerator method (Fig. 7) allows you to expand the data set with artificial transformations. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/70/0y/bj700y-rnmubq3yfqfyustyshcu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 7. </font><font style="vertical-align: inherit;">- Data generator.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first number rotation_range is a random number for rotating images inside the generator. Width_shift_range - shows how much you can reduce the pixel values ‚Äã‚Äãin width. Height_shift_range - the coefficient by which each pixel will be multiplied to compress in height. Shear_range - shear rate, angle of shift in the counterclockwise direction in degrees. Zoom_range - range for random scaling. Horizontal_flip - random image display horizontally. Vertical_flip - random vertical image display. Fill_mode - points outside the input data are filled in accordance with the specified mode. Data_format - image data format. Thus, the neural network will have a better generalization, because the original dataset basically has clean pixels, the numbers are in the center.In real photographs, other situations are possible when the gesture is in a corner or blurred. The learning process is being rewritten with new data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Fig. 8, the Test graph started to decrease, so the training was stopped. If the val_acc metric were not used to stop, the algorithm would continue to work, resulting in a retrained neural network.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compared to past results, the value of the loss function decreased and, therefore, the degree of confidence of the algorithm in predictions increased. Accuracy increased slightly more than 2% (Fig. 8, Fig. 9). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/do/cc/jd/doccjdygrwyzydl51abbpmusqos.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 8 - Training schedule on new data. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/3k/5f/pf/3k5fpfjks90dt-gmtnxpwlkxj0u.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 9. - Model metrics. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conversion</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For integration into iOS application you need to get a neural network of a certain format. This allows you to make the CoreML framework. It allows you to run trained machine learning models in a format. mlmodel in applications. For working with images, the Vision framework works on the basis of Core ML and helps with tracking and recognition of faces, text, objects, barcodes. Horizon determination and matrix acquisition for image alignment are also available.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To convert a model from .h5 to. mlmodel is used by the library in Python Coremltools. This library supports conversion to mlmodel format. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the correct conclusion of the model, a dictionary is specified that will correspond to 10 digits. The next line declares, Model_check.h5 is the name of the model, it is further indicated that it will receive images on the input layer of the neural network. The image_scale field will lead to standardize the matrix of pixels. (Fig. 10) Fig. 10 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/fe/ii/ghfeiiblwg6m92ho-avcn9zh7rg.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. - Conversion. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mobile app. Work with a prepared model.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
An example from the official website of Apple developers is used as the basis for the project. The latest Xcode development environment, the programming language is Swift fifth version.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Files (Fig. 11) containing the code in the project are considered. AppDelegate.swift launches the application start window and initializes all files connected to the project. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/a4/7c/hsa47cfkzfwyp_x9buco1zs4onm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 11. - The structure of the application.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A prepared model is added to the project after the conversion of sign_lang.mlmodel (Fig. 12). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/7v/_l/ja7v_ltd52_ttq50j4gc-axbucq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 12. - Model in Xcode.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Type line indicates that the Machine Learning Model added to the project is indeed a classifying neural network. To predict the model, black-and-white pictures with gray elements of dimension 64x64 will be input, the program will convert them to this format using Vision. The output will be a dictionary in which the pairs will be the line with the label that was specified during the conversion, and the confidence (probability) with which the neural predicts it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main application files.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The main file is considered - Image Classification View Controller.swift </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ImageView - a window for displaying the current image on the phone screen, sent to the input of the model.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CameraButton - a button that, when clicked, will bring up a context menu offering the user to do the following: Take Photo, Choose Photo. The first action will open the camera of the smartphone, in which the photo mode will be available. (Fig. 13) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When choosing an alternative action, Choose Photo, an internal gallery will open. Pressing the Use Photo button will return the user to the main screen, where the neural network will analyze the images and give its prediction, as shown in Fig. 14.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the word Classification, we see the conclusion of the two most likely outcomes that the model predicted. The number in parentheses is the confidence of the neural network that its prediction is correct. From Fig. 14 it can be seen that the algorithm with a confidence of 0.99 says that the number 0 is shown. And this coincides with reality. No machine learning algorithm can give 100% accuracy on real data, and the constructed neural network is no exception, and false predictions are possible, which can be seen in Fig. 15. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/78/qp/5h/78qp5hj0ajrbotphwhueoaybit0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 13. - Work with the camera. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/px/l6/gf/pxl6gfi5rspqsfe53bsnk2dpyzi.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 14. - Prediction of the neural network. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/oy/pv/s4/oypvs4v3zrcxig6481s3zqnpdrq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 15. - False prediction.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we designed the architecture of a convolutional neural network for recognizing digits of sign language. </font><font style="vertical-align: inherit;">Neural network training was performed, and as a result of the expansion of training data and the selection of hyperparameters, an accuracy of 81% was obtained on a test data set. </font><font style="vertical-align: inherit;">The algorithm has been successfully converted for porting to a smartphone. </font><font style="vertical-align: inherit;">A mobile application was developed in which a neural network was integrated. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code Link</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502042/index.html">Interview with Analyst - Alexander Sibrikov, Product Manager at AppMetrica</a></li>
<li><a href="../en502046/index.html">Five years Rust</a></li>
<li><a href="../en502048/index.html">Complex behavior without neural networks and training. The philosophical basis</a></li>
<li><a href="../en502050/index.html">A few notes about Culture</a></li>
<li><a href="../en502052/index.html">Kubernetes best practices. Create small containers</a></li>
<li><a href="../en502056/index.html">How to Build a Smart Home and Not Go Crazy</a></li>
<li><a href="../en502066/index.html">Simple console commands that everyone should know</a></li>
<li><a href="../en502068/index.html">110 volts on your computer</a></li>
<li><a href="../en502070/index.html">The history of Pentax (article plus video)</a></li>
<li><a href="../en502072/index.html">Docking the ISS using JavaScript and compass</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>