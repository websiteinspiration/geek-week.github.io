<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∫ üìä üöø √Ä quest√£o de Apophenia, Telegonia e Time Travel (e funciona com _ no in√≠cio) üßóüèª ü•§ ü§µüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 1958, o neuropsic√≥logo alem√£o Klaus Konrad cunhou o termo "apophenia" (do latim apophene - julgamento expresso, explique; o termo remonta a textos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>√Ä quest√£o de Apophenia, Telegonia e Time Travel (e funciona com _ no in√≠cio)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505926/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em 1958, o neuropsic√≥logo alem√£o Klaus Konrad cunhou o termo "apophenia" (do latim apophene - julgamento expresso, explique; o termo remonta a textos de revela√ß√µes religiosas, onde significa conhecimento alcan√ßado fora do processo de cogni√ß√£o), implicando por ele a propriedade da psique, consistindo na habilidade veja relacionamentos em fatos ou dados sem sentido ou aleat√≥rios e encontre significado em coincid√™ncias. A ilus√£o de comunica√ß√£o significativa. Nosso c√©rebro est√° constantemente procurando padr√µes, mas freq√ºentemente comete erros e h√° um desejo irracional de ver padr√µes onde eles n√£o existem. Um desejo peculiar de obedecer coincid√™ncias e conting√™ncias. Isso √© chamado de apofenia. Nas estat√≠sticas matem√°ticas, esse √© um erro padr√£o do primeiro tipo. </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nepryakhin N. "Estou manipulando voc√™"</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que me lembrei desse termo, especialmente em um recurso de TI? </font><font style="vertical-align: inherit;">Porque a busca de relacionamentos entre fatos d√≠spares durante a depura√ß√£o do programa √© um dos principais fatores que determinam seu sucesso. </font><font style="vertical-align: inherit;">Uma s√©rie de imprecis√µes aleat√≥rias no trabalho, cada uma das quais n√£o mostra os motivos de sua ocorr√™ncia e n√£o afeta a opera√ß√£o do programa como um todo, pode parecer ca√≥tico. </font><font style="vertical-align: inherit;">No entanto, se voc√™ tentar encontrar um relacionamento entre eles, poder√° resolver imediatamente muitos problemas com uma linha de c√≥digo ... Ou verifique se o relacionamento n√£o passa de um jogo da mente, um produto da imagina√ß√£o do desenvolvedor.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 1. ‚ÄúAgente e Coordenador‚Äù</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo foi iniciado durante o desenvolvimento de um programa de agente que executa v√°rias tarefas em um servidor remoto, recebendo uma lista de tarefas por meio de um mecanismo cliente-servidor. O agente elevou o servidor na porta 34002, um coordenador local conectado a ele, verificou a autoriza√ß√£o um do outro e, se tudo correu bem, o agente executou as a√ß√µes necess√°rias e relatou de volta ao topo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tr/mz/kl/trmzklssjskomt-sxqhxfdpbihq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema simplificado do programa</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Uma etapa √≥bvia da parte do agente foi criar sua pr√≥pria bifurca√ß√£o para executar qualquer fun√ß√£o da fam√≠lia exec para substituir o processo pelo programa que est√° sendo lan√ßado. Nesse caso, o agente recebeu o pid do processo, o que permitiu aguardar sua conclus√£o ou finaliz√°-lo √† for√ßa. Tudo correu bem, no entanto, para que o coordenador recebesse um relat√≥rio sobre o trabalho realizado, era necess√°rio retornar as conclus√µes de stdout e stderr.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse problema pode ser resolvido por v√°rios m√©todos - passe o processo new (dup2) FD para stdout e stderr e leia-os no processo pai; redirecione o stderr para o stdout e use o popen; substitua os descritores stdout e stderr como arquivos e leia-os quando terminar. Escolhemos o √∫ltimo m√©todo, j√° que a leitura pelo primeiro m√©todo exigia c√≥digo e sincroniza√ß√£o adicionais (e se voc√™ n√£o o ler constantemente, depois de atingir 2 MB, a grava√ß√£o ser√° interrompida quando o buffer do pipe estiver esgotado) e, no segundo, perdemos a diferencia√ß√£o de stdout e stderr. Portanto, o m√©todo mais simples foi escolhido - fechar stdout e stderr para um novo processo e, em seguida, abrir arquivos atrav√©s de abrir, onde queremos substituir nossa sa√≠da. De acordo com a documenta√ß√£o do open, ele usa o √≠ndice FD m√≠nimo dispon√≠vel, e √© por isso que o c√≥digo ser√° simples e elegante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> pid = fork();
<span class="hljs-keyword">switch</span> (pid) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span> :
        <span class="hljs-keyword">return</span> BADFORK;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> :<font></font>
        close(<span class="hljs-built_in">stdout</span>);<font></font>
        close(<span class="hljs-built_in">stderr</span>);<font></font>
        open(fileout, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);<font></font>
        open(fileerr, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);<font></font>
        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    <span class="hljs-keyword">default</span> :
        <span class="hljs-keyword">return</span> pid;<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo simplificado se parece com isso (verifica√ß√£o de erro removida para facilitar a leitura). </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo foi lan√ßado, a sa√≠da do comando foi gravada com sucesso no arquivo, foi conclu√≠da e estava pronta para trabalhar em sistemas de "combate". </font><font style="vertical-align: inherit;">Ou n√£o? </font><font style="vertical-align: inherit;">Na fase de testes, um pequeno bug apareceu, "provando" a possibilidade de viajar no tempo (ou pelo menos a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">telegrafia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 2. "Telegonia"</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema era o seguinte: ap√≥s a conclus√£o do programa e tamb√©m ap√≥s a conclus√£o do agente, foi encontrada a seguinte linha no arquivo que deve conter a sa√≠da do programa que est√° sendo iniciado (para o qual redirecionamos o stdout do programa filho):</font></font><br>
<br>
<pre><code class="plaintext hljs">[2020-06-05 16:58:49]      :34002</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espere um minuto! Mas essa √© uma linha da sa√≠da do pr√≥prio agente - o processo pai que chamou fork ()! Al√©m disso, o agente exibe essa linha algum tempo ap√≥s o t√©rmino do programa chamado! Como todo o restante da sa√≠da do agente pode ser gravado no stdout, e uma das linhas pode entrar em um arquivo, com todo o trabalho do agente para l√™-lo ap√≥s a conclus√£o do waitpid? Talvez um erro ao ler um arquivo tenha uma mem√≥ria danificada?</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _exec_readfile(struct frs_json * target, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * filename) {<font></font>
    FILE * fp;<font></font>
    <span class="hljs-keyword">char</span> linebuff[VEN_PIPE_READ_SIZE + <span class="hljs-number">1</span>] = { <span class="hljs-number">0</span> };<font></font>
    fp = fopen(filename, <span class="hljs-string">"r"</span>);
    <span class="hljs-keyword">if</span> (!fp)<font></font>
        frs_err(<span class="hljs-string">" \"%s\"    "</span>, filename);
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">while</span>(fgets(linebuff, VEN_PIPE_READ_SIZE, fp))<font></font>
            frs_json_string(target, <span class="hljs-literal">NULL</span>, bxi_strtrimr(linebuff));<font></font>
    }<font></font>
    fclose(fp);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece n√£o haver nada que possa ultrapassar a mem√≥ria (frs_ * s√£o cobertos por testes). </font><font style="vertical-align: inherit;">Ent√£o, como esse FP afeta a sa√≠da do agente, que ocorre alguns minutos ap√≥s a execu√ß√£o dessa fun√ß√£o? </font><font style="vertical-align: inherit;">Naturalmente, algum tipo de telegrafia - eles tocaram o arquivo para leitura e, ap√≥s 9 meses, recebemos uma fala do "primeiro parceiro" nele. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9g/pv/c7/9gpvc7fjwrn55pggacmexfxbohm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meu FD foi tocado por uma zebra que</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Valgrind n√£o encontrou nenhum problema, o que nos deixou um pouco chateados. </font><font style="vertical-align: inherit;">Afinal, seus analisadores onipotentes n√£o viram um erro de acesso √† mem√≥ria, eles gastaram muito tempo em v√£o na an√°lise. </font><font style="vertical-align: inherit;">Ou n√£o em v√£o? </font><font style="vertical-align: inherit;">Se n√£o houver erro de acesso √† mem√≥ria, isso significa um erro l√≥gico. </font><font style="vertical-align: inherit;">Mas que erro l√≥gico poderia levar a esse efeito?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 3. ‚ÄúDois Servidores‚Äù</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto isso, um segundo bug foi encontrado. </font><font style="vertical-align: inherit;">Durante o lan√ßamento na depura√ß√£o do QtCreator (n√≥s o usamos como ambiente de desenvolvimento, o pr√≥prio projeto C), conclu√≠mos com √™xito todos os processos relacionados ao programa e esse bug n√£o apareceu. </font><font style="vertical-align: inherit;">No entanto, valia a pena tentar iniciar o programa diretamente e depois finaliz√°-lo (por m√©todos legais), pois ele parou de iniciar uma segunda vez.</font></font><br>
<br>
<pre><code class="plaintext hljs">^C[2020-06-05 16:58:46]    "Interrupt",   <font></font>
[2020-06-05 16:58:49]      :34002<font></font>
[2020-06-05 16:58:49]      :34002<font></font>
[2020-06-05 16:58:49]      :34002<font></font>
[2020-06-05 16:58:49]     <font></font>
[2020-06-05 16:58:50]      </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era justo pensar em pequenos gremlins que destroem o mecanismo do programa por dentro, quebrando uma parte do programa e depois a outra. </font><font style="vertical-align: inherit;">Mas o talento do programador sugeria que havia um relacionamento entre esses bugs. </font><font style="vertical-align: inherit;">Qual? </font><font style="vertical-align: inherit;">Quem sabe, mas √© por isso que n√£o √© √† toa! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontrar a causa da falha no lan√ßamento acabou sendo f√°cil. </font><font style="vertical-align: inherit;">Foi o suficiente para examinar os logs do sistema do programa, nos quais definiu clara e claramente o motivo:</font></font><br>
<br>
<pre><code class="plaintext hljs">[2020-06-06 14:40:12] frs_socket_bind  :34002   ("Address already in use" (98))<font></font>
[2020-06-06 14:40:12]      :34002<font></font>
[2020-06-06 14:40:12] ven_server_start     </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ele j√° foi lan√ßado? </font><font style="vertical-align: inherit;">Quem lan√ßou? </font><font style="vertical-align: inherit;">Voc√™ terminou um minuto atr√°s!</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ps aux | grep vento<font></font>
alex     14144  0.0  0.0 156780  7212 pts/0    Sl+  14:39   0:00 ./vento</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realmente lan√ßado. </font><font style="vertical-align: inherit;">Mas talvez apenas um acidente?</font></font><br>
<br>
<pre><code class="plaintext hljs">kill -9 14144</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, novamente, o programa inicia, mas ap√≥s o t√©rmino do programa, o processo que possui a porta 34002 permanece:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002<font></font>
vento     14144 alex    3u  IPv4 12275384      0t0  TCP *:34002 (LISTEN)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E quem ent√£o acaba? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere a sa√≠da de lsof -i em tempo de execu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lan√ßamos:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002<font></font>
vento     151640 alex    3u  IPv4 12275384      0t0  TCP *:34002 (LISTEN)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, um soquete, um servidor </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um Reich</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002<font></font>
_Postman  25078 alex  104u  IPv4 12885232      0t0  TCP localhost:46154-&gt;localhost:34002 (ESTABLISHED)<font></font>
vento     27468 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui o cliente est√° conectado a ele e define algum comando ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o que √© isso?</font></font><br>
<br>
<pre><code class="plaintext hljs">$ lsof -i | grep 34002<font></font>
_Postman  25078 alex  104u  IPv4 12885232      0t0  TCP localhost:46154-&gt;localhost:34002 (ESTABLISHED)<font></font>
vento     27468 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)<font></font>
vento     27506 alex    3u  IPv4 12890254      0t0  TCP *:34002 (LISTEN)<font></font>
vento     27506 alex    4u  IPv4 12890329      0t0  TCP localhost:34002-&gt;localhost:46154 (ESTABLISHED)</code></pre><br>
<img src="https://habrastorage.org/webt/wp/wq/62/wpwq62hwasqdflzz9bxomgjvebq.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosidade # 197766: mais cedo ou mais tarde, uma refer√™ncia a Star Wars deve aparecer</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Duas portas de servidor? </font><font style="vertical-align: inherit;">Apesar do fato de nosso servidor n√£o usar o sinalizador REUSEPORT.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 4. ‚ÄúCLOEXEC‚Äù</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm ... Talvez o sinalizador CLOEXEC esteja ausente na implementa√ß√£o do servidor? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada na bandeira:</font></font><br>
<br>
<pre><code class="plaintext hljs">$man fork<font></font>
       *  The child process is created  with  a  single  thread‚Äîthe  one  that<font></font>
          called  fork().   The  entire virtual address space of the parent is<font></font>
          replicated in the child, including the states of mutexes,  condition<font></font>
          variables,  and other pthreads objects; the use of pthread_atfork(3)<font></font>
          may be helpful for dealing with problems that this can cause.<font></font>
<font></font>
       *  The child inherits copies of the parent's set of open file  descrip‚Äê<font></font>
          tors.   Each  file  descriptor  in the child refers to the same open<font></font>
          file description (see open(2)) as the corresponding file  descriptor<font></font>
          in  the parent.  This means that the two file descriptors share open<font></font>
          file status flags, file offset,  and  signal-driven  I/O  attributes<font></font>
          (see the description of F_SETOWN and F_SETSIG in fcntl(2)).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chamar a fun√ß√£o fork () criar√° uma c√≥pia do encadeamento atual do processo e criar√° uma c√≥pia de cada descritor de processo aberto (e como nos sistemas UNIX [como]] ‚Äútudo √© um arquivo‚Äù, os arquivos de rede ser√£o inclinados junto com os descritores de arquivo)</font></font><br>
<br>
<pre><code class="plaintext hljs">$man exec<font></font>
       The exec() family of functions replaces the current process image with a new process image.  The functions described in<font></font>
       this manual page are front-ends for execve(2).  (See the manual page  for  execve(2)  for  further  details  about  the<font></font>
       replacement of the current process image.)</code></pre><br>
<pre><code class="plaintext hljs">$man execve<font></font>
       *  By  default,  file  descriptors  remain open across an execve().  File descriptors that are marked close-on-exec are<font></font>
          closed; see the description of FD_CLOEXEC in fcntl(2).  (If a file descriptor is closed, this will cause the release<font></font>
          of  all record locks obtained on the underlying file by this process.  See fcntl(2) for details.)  POSIX.1 says that<font></font>
          if file descriptors 0, 1, and 2 would otherwise be closed after a successful execve(), and the  process  would  gain<font></font>
          privilege because the set-user-ID or set-group_ID mode bit was set on the executed file, then the system may open an<font></font>
          unspecified file for each of these file descriptors.  As a general principle, no portable  program,  whether  privi‚Äê<font></font>
          leged or not, can assume that these three file descriptors will remain closed across an execve().</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se n√£o queremos que o processo chamado receba uma c√≥pia do descritor, devemos definir o sinalizador FD_CLOEXEC / SOCK_CLOEXEC. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, seria l√≥gico se foram marcadas com tags que voc√™ deseja copiar, a fim de vazamento Evitar em arquivos de acesso root, mas a bandeira apareceu em POSIX-2001, ent√£o agora √© a nossa heran√ßa, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">embora</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controversa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<pre><code class="cpp hljs">server-&gt;socket = socket(AF_INET, SOCK_STREAM | SOCK_CLOEXEC, <span class="hljs-number">0</span>);</code></pre><br>
<pre><code class="cpp hljs">fcntl(client, F_SETFD, FD_CLOEXEC);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, n√£o, nossas bandeiras s√£o definidas como deveriam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o o que acontece? </font><font style="vertical-align: inherit;">O kernel ignora a flag? </font><font style="vertical-align: inherit;">Algu√©m o largou? </font><font style="vertical-align: inherit;">E o mais importante, por que, depois que o aplicativo √© conclu√≠do, o processo que ocupa a porta permanece no sistema? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar fechar o servidor principal e conectar-se ao processo restante usando o gdb:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ sudo gdb -p 27506<font></font>
GNU gdb (Ubuntu 8.1-0ubuntu3.2) 8.1.0.20180409-git<font></font>
[...]<font></font>
Reading symbols from /lib/x86_64-linux-gnu/libgcc_s.so.1...(no debugging symbols found)...done.<font></font>
0x00007f503d50c9f3 in futex_wait_cancelable (private=[optimized out], expected=0, futex_word=0x55f485d383b8)<font></font>
    at ../sysdeps/unix/sysv/linux/futex-internal.h:88<font></font>
88	../sysdeps/unix/sysv/linux/futex-internal.h:     .<font></font>
(gdb) bt<font></font>
#0  0x00007f503d50c9f3 in futex_wait_cancelable (private=[optimized out], expected=0, futex_word=0x55f485d383b8)<font></font>
    at ../sysdeps/unix/sysv/linux/futex-internal.h:88<font></font>
#1  __pthread_cond_wait_common (abstime=0x0, mutex=0x55f485d38368, cond=0x55f485d38390) at pthread_cond_wait.c:502<font></font>
#2  __pthread_cond_wait (cond=0x55f485d38390, mutex=0x55f485d38368) at pthread_cond_wait.c:655<font></font>
#3  0x00007f503d948097 in _frs_signal_wait (signal=0x55f485d38340, filename=0x7f503d7315c8 "fen_server.c", fileline=298)<font></font>
    at ./projects/shared/libforseti/code/thread/frs_signal.c:250<font></font>
#4  0x00007f503d728044 in _server_wait (server=0x55f485d38270) at ./projects/shared/libfenrir/code/server/fen_server.c:298<font></font>
#5  0x00007f503d72822d in fen_server_free (server=0x55f485d38270) at ./projects/shared/libfenrir/code/server/fen_server.c:351</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stop stop stop, que server_free? </font><font style="vertical-align: inherit;">Conclu√≠mos o processo errado? </font><font style="vertical-align: inherit;">Afinal, aqui deve ser o lan√ßamento do aplicativo de eco! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou n√£o deveria ser?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 5. ‚ÄúUm Personagem‚Äù</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enviamos a string echo, mas voc√™ precisa colocar o caminho completo para o aplicativo em exec, porque n√£o o executamos no ambiente shell, ao contr√°rio do mesmo sistema. </font><font style="vertical-align: inherit;">Mude para / bin / echo e observe que o problema se foi. </font><font style="vertical-align: inherit;">Mas acontece que, quando atribu√≠mos o comando incorreto do ponto de vista do exec, continuamos trabalhando no mesmo processo e n√£o o substitu√≠mos por um aplicativo em execu√ß√£o, o que significa que ...</font></font><br>
<br>
<pre><code class="cpp hljs">        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, sim, a sa√≠da est√° conclu√≠da. </font><font style="vertical-align: inherit;">Mas como isso faz o servidor desligar?</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*! \brief   */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _free(<span class="hljs-keyword">void</span>) __attribute__((destructor));
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _free(<span class="hljs-keyword">void</span>) {<font></font>
    fen_server_free(g_server);<font></font>
    frs_inf(<span class="hljs-string">"   "</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora tudo se encaixou. </font><font style="vertical-align: inherit;">Esses dois bugs realmente estavam interconectados, e agora voc√™ pode at√© dizer exatamente como: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g0/sk/-s/g0sk-sf74ratdovfkkoqny7ongu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, resta corrigir o sistema que est√° funcionando incorretamente. </font><font style="vertical-align: inherit;">E faremos isso como em uma piada sobre o mestre da televis√£o e um golpe com um martelo: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione um s√≠mbolo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "_" √† palavra exit:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> pid = fork();
<span class="hljs-keyword">switch</span> (pid) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span> :
        <span class="hljs-keyword">return</span> BADFORK;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> :<font></font>
        close(<span class="hljs-built_in">stdout</span>);<font></font>
        close(<span class="hljs-built_in">stderr</span>);<font></font>
        open(fileout, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);<font></font>
        open(fileerr, O_CREAT | O_WRONLY, <span class="hljs-number">0777</span>);<font></font>
        execve(arguments[<span class="hljs-number">0</span>], arguments, environ);<font></font>
        _exit(EXIT_FAILURE);<font></font>
    <span class="hljs-keyword">default</span> :
        <span class="hljs-keyword">return</span> pid;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que est√° acontecendo agora? </font><font style="vertical-align: inherit;">Nada de especial, exceto que agora o processo de encerramento terminar√° sem chamar as fun√ß√µes registradas atrav√©s do atexit. </font><font style="vertical-align: inherit;">Nas implementa√ß√µes glibc mais antigas, essa ser√° uma chamada para a chamada do sistema _exit; nas mais recentes, o exit_group ser√° chamado para concluir todos os threads do programa mais corretamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, ambos os bugs foram derrotados e voc√™ disse "apofenia", "voc√™ s√≥ quer saber", "n√£o h√° conex√£o". </font><font style="vertical-align: inherit;">Vou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mover a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> caixa na prateleira, caso contr√°rio a humanidade n√£o voar√° mais para o espa√ßo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt505898/index.html">Claude Shannon: Jack of All Trades, Coringa e pai da teoria da informa√ß√£o</a></li>
<li><a href="../pt505900/index.html">Depend√™ncias pessoais: tamanho 40 mm, sem fio, por 72 horas por 8.000 rublos</a></li>
<li><a href="../pt505904/index.html">Semana do Stream Online do JUG Ru Group # 5</a></li>
<li><a href="../pt505906/index.html">Passo a passo Bandit de overthewire.org</a></li>
<li><a href="../pt505918/index.html">Interface telef√¥nica da Sony - publicidade n√£o desativada</a></li>
<li><a href="../pt505928/index.html">Por que a programa√ß√£o funcional √© t√£o complicada</a></li>
<li><a href="../pt505946/index.html">Armazenando imagens usando o Django / Django REST</a></li>
<li><a href="../pt505954/index.html">Alpine.js - eventos e armaz√©m de dados global</a></li>
<li><a href="../zh-CN486176/index.html">‰ºÅ‰∏öÁîµÂ≠êÈÇÆ‰ª∂ÈÄöËÆØÂ§áÂøòÂΩï</a></li>
<li><a href="../zh-CN486178/index.html">FOSSÊñ∞Èóª1-2020Âπ¥1Êúà27Êó•Ëá≥2Êúà2Êó•ÂÖçË¥πÂíåÂºÄÊ∫êÊñ∞ÈóªÁöÑÂõûÈ°æ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>