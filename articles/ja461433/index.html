<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦎 Ⓜ️ 🕰️ Net Core 3.0でのIdentity Server 4の使用 🎣 🧚🏾 🗞️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 

私がサポートしているプロジェクトの1つには、蓄積された大量の技術的負債をリファクタリングしてかき集める必要がある場合に、.NET Framework 4.5から.Net Coreに移行する可能性を分析するタスクがありました。 Microsoftの開発者によると、バージョン3.0のリリー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Net Core 3.0でのIdentity Server 4の使用</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私がサポートしているプロジェクトの1つには、蓄積された大量の技術的負債をリファクタリングしてかき集める必要がある場合に、.NET Framework 4.5から.Net Coreに移行する可能性を分析するタスクがありました。 Microsoftの開発者によると、バージョン3.0のリリースに伴い、レガシーコードを移行するために必要な手順が数回減少するため、選択はターゲットプラットフォームの.NET Core 3.0に当てはまりました。特に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.Net Coreの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> EntityFramework 6.3リリース計画に惹かれました</font><font style="vertical-align: inherit;">。 EF 6.2に基づくコードのほとんどは、ネットコア上の移行されたプロジェクトに「そのまま」残すことができます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データレベルについては明らかになったようですが、コードの移植のもう1つの大きな部分はセキュリティレベルでした。残念なことに、迅速な監査の結果、ほぼ完全に破棄し、ゼロから書き直す必要があります。</font><font style="vertical-align: inherit;">幸いなことに、プロジェクトではASP NET Identityの一部を既に使用しており、ユーザーやその他の「自転車」を側面に接続して格納しています。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは論理的な問題を提起します。セキュリティの部分で多くの変更を行う必要がある場合は、業界標準の形式で推奨されているアプローチをすぐに実装しないでください。つまり、アプリケーションで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identity Server4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレームワークを通じてOpen Id接続とOAuthを使用できるようにします</font><font style="vertical-align: inherit;">。</font></font></p><a name="habracut"></a><br>
<h2 id="problemy-i-puti-resheniya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題と解決策</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり、Angular（IS4に関してはクライアント）にJavaScriptアプリケーションがあり、WebAPI（リソース）の一部のサブセットを使用しています。また、更新後に再利用する必要があるユーザーログインを含む古いASP NET Identityのデータベースもあります（他の全員を起動しないようにするため）さらに、IdentityServer4側でWindows認証を使用してシステムにログインする機会を与える必要がある場合もあります。それら。ユーザーがActiveDirectoryドメインのローカルエリアネットワークを介して作業する場合があります。</font></font></p><br>
<p>        ,   (    )          Identity. ,   ,         SQL ,     Identity         .  -     EFMigrationsHistory,     EF    , ,   IdentityUser   .</p><br>
<p>      IdentityServer4      Windows     .</p><br>
<h2 id="plan-realizacii"> </h2><br>
<p>  NDA    ,     IS4    , ,        ASP.NET Core,   , ,    ,       ,       IdentityServer4.<br>
        : </p><br>
<ul>
<li>   ASP.Net Core     IdentityServer4.</li>
<li>    Angular .</li>
<li>   open-id-connect google</li>
<li>   Windows </li>
</ul><br>
<p>      (IdentityServer, WebAPI, Angular )     .      IdentityServer (GrantType) – Implicit flow,  access_token      ,       WebAPI. <em>  ,      ASP.NET Core, Implicit flow    Authorization Code + PKCE.)</em></p><br>
<p>            .NET Core,            preview Core 3.0 (    3.0.100-preview7-012821).</p><br>
<h2 id="sozdanie-i-konfigurirovanie-web-proekta">   web </h2><br>
<p> IdentityServer  4,    UI   .            .    .      UI   QuickStart UI,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>.</p><br>
<p>,   ,     ASP NET Core Identity UI,            .       .</p><br>
<p>    web ,        :</p><br>
<pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code></pre><br>
<p>         ,        .    ,   .Net Core 3.0  Identity    RazorPages,     MVC.<br>
    IdentityServer   .     :</p><br>
<pre><code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7<font></font>
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7<font></font>
dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6<font></font>
dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code></pre><br>
<p>     ,     Entity Framework        Identity.      SQLite.</p><br>
<p>          ,      ApplicationUser,   <em>IdentityUser</em>   Models  <em>ApplicationDbContext</em>,  : <em>ApiAuthorizationDbContext   Data.</em><br>
</p><p>     EntityFramework    .       <em>ConfigureServices</em>  Startup:</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
{<font></font>
  services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string">"DefaultConnection"</span>)));<font></font>
    services.AddRazorPages();<font></font>
}</code></pre><br>
<p>     <em>appsettings.json</em></p><br>
<pre><code class="json hljs"><span class="hljs-string">"ConnectionStrings"</span>: {
    <span class="hljs-attr">"DefaultConnection"</span>: <span class="hljs-string">"Data Source=data.db"</span><font></font>
  },<font></font>
</code></pre><br>
<p>         .   ,    tool  ef core (  preview   3.0.0-preview7.19362.6).</p><br>
<pre><code class="plaintext hljs">dotnet ef migrations add Init<font></font>
dotnet ef database update</code></pre><br>
<p>       ,      SQLite   data.db. </p><br>
<p>             Asp.Net Core Identity.       <em>Startup. Configure</em>  <em>Startup.ConfigureServices</em>.</p><br>
<pre><code class="cs hljs"><span class="hljs-comment">//Startup.ConfigureServices:</span><font></font>
services.AddDefaultIdentity&lt;ApplicationUser&gt;()<font></font>
                .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();<font></font>
<font></font>
<span class="hljs-comment">//Startup. Configure:</span><font></font>
app.UseAuthentication();<font></font>
app.UseAuthorization();<font></font>
<font></font>
app.UseEndpoints(endpoints =&gt;<font></font>
{<font></font>
    endpoints.MapRazorPages();<font></font>
});</code></pre><br>
<p>           .        Identity.<br>
   UI,   Pages\Shared   Razor view   <em>_LoginPartial.cshtml</em>   :</p><br>
<pre><code class="html hljs xml">@using IdentityServer4WebApp.Models<font></font>
@using Microsoft.AspNetCore.Identity<font></font>
@inject SignInManager<span class="hljs-tag">&lt;<span class="hljs-name">ApplicationUser</span>&gt;</span> SignInManager<font></font>
@inject UserManager<span class="hljs-tag">&lt;<span class="hljs-name">ApplicationUser</span>&gt;</span> UserManager<font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav"</span>&gt;</span><font></font>
    @if (SignInManager.IsSignedIn(User))<font></font>
    {<font></font>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">"Identity"</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Account/Manage/Index"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Manage"</span>&gt;</span>Hello @User.Identity.Name!<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-inline"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">"Identity"</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Account/Logout"</span> <span class="hljs-attr">asp-route-returnUrl</span>=<span class="hljs-string">"/"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link btn btn-link text-dark"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><font></font>
    }<font></font>
    else<font></font>
    {<font></font>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">"Identity"</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Account/Register"</span>&gt;</span>Register<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">"Identity"</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Account/Login"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><font></font>
    }<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre><br>
<p>            Identity      (   ,   ..)</p><br>
<p>     ,    <em>_Layout.cshtml</em>,      .</p><br>
<pre><code class="html hljs xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav flex-grow-1"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">""</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Index"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> <span class="hljs-attr">asp-area</span>=<span class="hljs-string">""</span> <span class="hljs-attr">asp-page</span>=<span class="hljs-string">"/Privacy"</span>&gt;</span>Privacy<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">partial</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_LoginPartial"</span> /&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">!––––</span>&gt;</span> 
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre><br>
<p>            <br>
,         <br>
   .       – <br>
 .</p><br>
<p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br>
<p> IdentityServer4        ASP.NET Identity    .      OAuth2,         .</p><br>
<p>    <em>Startup.ConfigureServices</em>    IS4  ASP.NET Core Identity:</p><br>
<pre><code class="cs hljs">services.AddIdentityServer()<font></font>
    .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code></pre><br>
<p> AddApiAuthorization      ,     appsettings.json.        IS4        ,         .   ,             callback.</p><br>
<p>​    ,       JWT,  .</p><br>
<pre><code class="cs hljs">services.AddAuthentication()<font></font>
    .AddIdentityServerJwt();</code></pre><br>
<p> ,   <em>Startup.Configure</em>    <br>
   Open ID Connect.</p><br>
<pre><code class="cs hljs">app.UseAuthentication();<font></font>
app.UseAuthorization();<font></font>
app.UseIdentityServer();<span class="hljs-comment">//&lt;-</span></code></pre><br>
<p>    ,      <br>
   <em>appsettings.json</em>,      <br>
 <em>IdentityServer</em>.</p><br>
<pre><code class="json hljs"><span class="hljs-string">"IdentityServer"</span>: {
    <span class="hljs-attr">"Clients"</span>: {
      <span class="hljs-attr">"TestIdentityAngular"</span>: {
        <span class="hljs-attr">"Profile"</span>: <span class="hljs-string">"IdentityServerSPA"</span><font></font>
      }<font></font>
    }<font></font>
  }</code></pre><br>
<p>       TestIdentityAngular,          .</p><br>
<p> –     IdentityServer,         .     <em>IdentityServerSPA</em>,   ,             :</p><br>
<ul>
<li> redirect_uri,   <em>/authentication/login-callback</em>.</li>
<li> post_logout_redirect_uri,   <em>/authentication/logout-callback.</em></li>
<li>   openid, profile,    API .</li>
<li>    OIDC — id_token token</li>
<li>GrantType   – Implicit</li>
</ul><br>
<p>   – <em>SPA</em> (  IS4), <em>IdentityServerJwt</em> (API    IS4), <em>API</em> ( API).</p><br>
<p>    :</p><br>
<ul>
<li>ApiResources:  API    &lt;&lt; appname&gt;&gt;API   properties    (*).</li>
<li>IdentityServerResources: <em>IdentityResources.OpenId()</em>  <em>IdentityResources.Profile()</em></li>
</ul><br>
<p> , IdentityServer     ,        ,       <br>
 x509-,        «Key»  <em>appsettings.Development.json</em>.</p><br>
<pre><code class="json hljs"><span class="hljs-string">"IdentityServer"</span>: {
    <span class="hljs-attr">"Key"</span>: {
      <span class="hljs-attr">"Type"</span>: <span class="hljs-string">"Development"</span><font></font>
    }<font></font>
  }</code></pre><br>
<p>  ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">IdentityServer </a>       .</p><br>
<h2 id="realizaciya-klienta-na-angular">   Angular</h2><br>
<p>  SPA     Angular.     ,  –   ,    ,  .     8.1.2</p><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">ng new ClientApp</code></pre><br>
<p>     “”    .       bootstrap:</p><br>
<pre><code class="plaintext hljs">cd ClientApp<font></font>
ng add bootstrap</code></pre><br>
<p>     SPA    .     csproj –      .</p><br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TargetFramework</span>&gt;</span>netcoreapp3.0<span class="hljs-tag">&lt;/<span class="hljs-name">TargetFramework</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;<span class="hljs-name">TypeScriptCompileBlocked</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">TypeScriptCompileBlocked</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TypeScriptToolsVersion</span>&gt;</span>Latest<span class="hljs-tag">&lt;/<span class="hljs-name">TypeScriptToolsVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">IsPackable</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">IsPackable</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SpaRoot</span>&gt;</span>ClientApp\<span class="hljs-tag">&lt;/<span class="hljs-name">SpaRoot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">DefaultItemExcludes</span>&gt;</span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag">&lt;/<span class="hljs-name">DefaultItemExcludes</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BuildServerSideRenderer</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">BuildServerSideRenderer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><font></font>
…<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> <span class="hljs-attr">Remove</span>=<span class="hljs-string">"$(SpaRoot)**"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">None</span> <span class="hljs-attr">Remove</span>=<span class="hljs-string">"$(SpaRoot)**"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">None</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"$(SpaRoot)**"</span> <span class="hljs-attr">Exclude</span>=<span class="hljs-string">"$(SpaRoot)node_modules\**"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">Target</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"DebugEnsureNodeEnv"</span> <span class="hljs-attr">BeforeTargets</span>=<span class="hljs-string">"Build"</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">"node --version"</span> <span class="hljs-attr">ContinueOnError</span>=<span class="hljs-string">"true"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Output</span> <span class="hljs-attr">TaskParameter</span>=<span class="hljs-string">"ExitCode"</span> <span class="hljs-attr">PropertyName</span>=<span class="hljs-string">"ErrorCode"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Exec</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Error</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(ErrorCode)' != '0'"</span> <span class="hljs-attr">Text</span>=<span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Message</span> <span class="hljs-attr">Importance</span>=<span class="hljs-string">"high"</span> <span class="hljs-attr">Text</span>=<span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span> <span class="hljs-attr">WorkingDirectory</span>=<span class="hljs-string">"$(SpaRoot)"</span> <span class="hljs-attr">Command</span>=<span class="hljs-string">"npm install"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Target</span>&gt;</span>
</code></pre><br>
<p>     nuget    .</p><br>
<pre><code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code></pre><br>
<p>    :</p><br>
<pre><code class="cs hljs"><span class="hljs-comment">//Startup. ConfigureServices:</span><font></font>
services.AddSpaStaticFiles(configuration =&gt;<font></font>
            {<font></font>
                configuration.RootPath = <span class="hljs-string">"ClientApp/dist"</span>;<font></font>
            });<font></font>
<font></font>
<span class="hljs-comment">//Startup. Configure:</span><font></font>
app.UseSpa(spa =&gt;<font></font>
            {<font></font>
                spa.Options.SourcePath = <span class="hljs-string">"ClientApp"</span>;<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (env.IsDevelopment())<font></font>
                {<font></font>
                    spa.UseAngularCliServer(npmScript: <span class="hljs-string">"start"</span>);<font></font>
                }<font></font>
            });<font></font>
</code></pre><br>
<p>       Razor <em>Index.chtml</em>  <em>_ViewStart.chtml</em>,      SPA.</p><br>
<p>       ,        .</p><br>
<p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br>
<p>   ,      2<br>
:</p><br>
<pre><code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true<font></font>
ng generate component Data -t=true -s=true --skipTests=true</code></pre><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">const routes: Routes = [<font></font>
  { path: '', component: HomeComponent, pathMatch: 'full' },<font></font>
  { path: 'data', component: DataComponent }<font></font>
];</code></pre><br>
<p>   app.component.html,     .</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-brand"</span> [<span class="hljs-attr">routerLink</span>]=<span class="hljs-string">'["/"]'</span>&gt;</span>Client App<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span> [<span class="hljs-attr">ngClass</span>]=<span class="hljs-string">'{"show": isExpanded}'</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav flex-grow"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> [<span class="hljs-attr">routerLinkActive</span>]=<span class="hljs-string">'["link-active"]'</span> [<span class="hljs-attr">routerLinkActiveOptions</span>]=<span class="hljs-string">'{ exact: true }'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> [<span class="hljs-attr">routerLink</span>]=<span class="hljs-string">'["/"]'</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> [<span class="hljs-attr">routerLinkActive</span>]=<span class="hljs-string">'["link-active"]'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> [<span class="hljs-attr">routerLink</span>]=<span class="hljs-string">'["/data"]'</span>&gt;</span>Web api data<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align:center"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><font></font>
    Welcome to {{ title }}!<font></font>
  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"router-outlet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">router-outlet</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-outlet</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre><br>
<p>             ,  IdentityServer.</p><br>
<p>     SPA          ,         OpenID Connect  OAuth.  ,   Microsoft             .     ,    7 ASP.NET Core 3.0,         «v3.0.0-preview7.19365.7»  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>.</p><br>
<p>      <em>oidc-client</em>, <br>
     ,  <br>
      . <br>
       . </p><br>
<pre><code class="plaintext hljs">npm install oidc-client@1.8.0</code></pre><br>
<p>   SPA   ,      .       ApiAuthorizationModule     ASP.NET Core     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.</p><br>
<p> ,        AppModule:</p><br>
<pre><code class="plaintext hljs">@NgModule({<font></font>
  declarations: [<font></font>
    AppComponent,<font></font>
    HomeComponent,<font></font>
    DataComponent<font></font>
  ],<font></font>
  imports: [<font></font>
    BrowserModule,<font></font>
    HttpClientModule,<font></font>
    ApiAuthorizationModule,//&lt;-<font></font>
    AppRoutingModule<font></font>
  ],<font></font>
  providers: [],<font></font>
  bootstrap: [AppComponent]<font></font>
})<font></font>
export class AppModule { }</code></pre><br>
<p>          <em>app-login-menu</em>,<br>
          <br>
       <em>app.component.html</em>.</p><br>
<p>  API   OpenID connect  SPA    endpoint   ,    <br>
   :</p><br>
<ol>
<li> ID     ,       appsettings.json   IdentityServer:Clients,     TestIdentityAngular,        api-authorization.constants.ts.</li>
<li>  OidcConfigurationController,        </li>
</ol><br>
<p>    :</p><br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OidcConfigurationController</span>: <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IClientRequestParametersProvider _clientRequestParametersProvider;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OidcConfigurationController</span>(<span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span>)</span><font></font>
        {<font></font>
            _clientRequestParametersProvider = clientRequestParametersProvider;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"_configuration/{clientId}"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetClientRequestParameters</span>(<span class="hljs-params">[FromRoute]<span class="hljs-keyword">string</span> clientId</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId);
            <span class="hljs-keyword">return</span> Ok(parameters);<font></font>
        }<font></font>
    }</code></pre><br>
<p>    API    .</p><br>
<pre><code class="cs hljs"><span class="hljs-comment">//Startup.ConfigureServices:</span>
services.AddControllers();<span class="hljs-comment">//&lt;- </span><font></font>
services.AddRazorPages();<font></font>
<font></font>
<span class="hljs-comment">//Startup. Configure:</span><font></font>
app.UseEndpoints(endpoints =&gt;<font></font>
            {<font></font>
                endpoints.MapRazorPages();<font></font>
                endpoints.MapControllers();<font></font>
            });<font></font>
</code></pre><br>
<p>    .           – <em>Login</em>  <em>Register</em>.            ,       .     :</p><br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"authority"</span>: <span class="hljs-string">"https://localhost:44367"</span>,
    <span class="hljs-attr">"client_id"</span>: <span class="hljs-string">"TestIdentityAngular"</span>,
    <span class="hljs-attr">"redirect_uri"</span>: <span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span>,
    <span class="hljs-attr">"post_logout_redirect_uri"</span>: <span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span>,
    <span class="hljs-attr">"response_type"</span>: <span class="hljs-string">"id_token token"</span>,
    <span class="hljs-attr">"scope"</span>: <span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span>
}</code></pre><br>
<p> ,      id    ,          API.</p><br>
<p>       <em>Login</em>,       IdentityServer4        ,    ,        ,      <em>id_token</em>  <em>access_token</em>.   ,  app-login-menu  ,    ,   «»,     <em>Logout</em>. </p><br>
<p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br>
<p>    « »,    backstage     OIDC/OAuth.      <br>
 endpoint <em>.well-known/openid-configuration</em>  pooling      connect/checksession.  ,      «  »,       ,        iframe.        <em>includeIdTokenInSilentRenew</em>  «false»   <em>authorize.service.ts</em>.</p><br>
<p>          SPA ,    API   .     API    Models  <em>ExchangeRateItem,</em>       Controller,    .</p><br>
<pre><code class="cs hljs"><span class="hljs-comment">//Controller:</span>
    [<span class="hljs-meta">ApiController</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ExchangeRateController</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span>[] Currencies = <span class="hljs-keyword">new</span>[]<font></font>
        {<font></font>
            <span class="hljs-string">"EUR"</span>, <span class="hljs-string">"USD"</span>, <span class="hljs-string">"BGN"</span>, <span class="hljs-string">"AUD"</span>, <span class="hljs-string">"CNY"</span>, <span class="hljs-string">"TWD"</span>, <span class="hljs-string">"NZD"</span>, <span class="hljs-string">"TND"</span>, <span class="hljs-string">"UAH"</span>, <span class="hljs-string">"UYU"</span>, <span class="hljs-string">"MAD"</span><font></font>
        };<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"api/rates"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;ExchangeRateItem&gt; <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> rng = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-keyword">return</span> Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>).Select(index =&gt; <span class="hljs-keyword">new</span> ExchangeRateItem<font></font>
            {<font></font>
                FromCurrency = <span class="hljs-string">"RUR"</span>,<font></font>
                ToCurrency = Currencies[rng.Next(Currencies.Length)],<font></font>
                Value = Math.Round(<span class="hljs-number">1.0</span>+ <span class="hljs-number">1.0</span>/rng.Next(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>),<span class="hljs-number">2</span>)<font></font>
                })<font></font>
                .ToArray();<font></font>
        }<font></font>
    }<font></font>
<font></font>
<span class="hljs-comment">//Models:</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ExchangeRateItem</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> FromCurrency { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> ToCurrency { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br>
<p>      ,   <br>
          .</p><br>
<pre><code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code></pre><br>
<p>     :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core';<font></font>
import { HttpClient } from '@angular/common/http';<font></font>
import { Observable, of, Subject } from 'rxjs';<font></font>
import { catchError } from 'rxjs/operators';<font></font>
<font></font>
@Component({<font></font>
  selector: 'app-exchange-rate',<font></font>
  template: `<font></font>
&lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt;<font></font>
  {{msg}}<font></font>
&lt;/div&gt;<font></font>
&lt;table class='table table-striped'&gt;<font></font>
  &lt;thead&gt;<font></font>
  &lt;tr&gt;<font></font>
    &lt;th&gt;From currency&lt;/th&gt;<font></font>
    &lt;th&gt;To currency&lt;/th&gt;<font></font>
    &lt;th&gt;Rate&lt;/th&gt;    <font></font>
  &lt;/tr&gt;<font></font>
  &lt;/thead&gt;<font></font>
  &lt;tbody&gt;<font></font>
  &lt;tr *ngFor="let rate of rates | async"&gt;<font></font>
    &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt;<font></font>
    &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt;<font></font>
    &lt;td&gt;{{ rate.value }}&lt;/td&gt;<font></font>
  &lt;/tr&gt;<font></font>
  &lt;/tbody&gt;<font></font>
&lt;/table&gt;<font></font>
<font></font>
  `,<font></font>
  styles: []<font></font>
})<font></font>
export class ExchangeRateComponent implements OnInit {<font></font>
  public rates: Observable&lt;ExchangeRateItem[]&gt;;<font></font>
<font></font>
  public errorMessage: Subject&lt;string&gt;;<font></font>
<font></font>
  @Input() public apiUrl: string;<font></font>
<font></font>
  constructor(private http: HttpClient) {<font></font>
    this.errorMessage = new Subject&lt;string&gt;();<font></font>
  }<font></font>
<font></font>
  ngOnInit() {<font></font>
    this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) );<font></font>
  }<font></font>
<font></font>
  private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; {<font></font>
    return (error) =&gt; {<font></font>
      let message = '';<font></font>
      if (error.error instanceof ErrorEvent) {<font></font>
        message = `Error: ${error.error.message}`;<font></font>
      } else {<font></font>
        message = `Error Code: ${error.status}\nMessage: ${error.message}`;<font></font>
      }<font></font>
      subject.next(message);<font></font>
      let emptyResult: ExchangeRateItem[] = [];<font></font>
      return of(emptyResult);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
interface ExchangeRateItem {<font></font>
  fromCurrency: string;<font></font>
  toCurrency: string;<font></font>
  value: number;<font></font>
}</code></pre></div></div><br>
<p>       app-data,   template   &lt;app-exchange-rate apiUrl=«rates»&gt;&lt;/app-exchange-rate&gt;    .       ,          .</p><br>
<p>       API ,     <em>ExchangeRateController</em>   <em>[Authorize]</em>     SPA, ,  ,      ,   API,   ,      . </p><br>
<p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br>
<p>        <br>
 Angular   Interceptors.  ,      ,         .</p><br>
<pre><code class="plaintext hljs">providers: [<font></font>
    { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true }<font></font>
  ],</code></pre><br>
<p>      .     ,        Bearer access_token.       IdentityServer          API.</p><br>
<p>      ,          SPA  Guard ,       ,       .        ,       .</p><br>
<pre><code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard]  }</code></pre><br>
<p>  ,             ,            .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>.</p><br>
<h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google">       Google</h2><br>
<p>      Google  ASP.NET core 1.1/2.0+   Nuget  Microsoft.AspNetCore.Authentication.Google, ,        ,  Microsoft    ASP.NET Core 3.0+   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.        <em>OpenIdConnectExtensions</em>  <em>AddOpenIdConnect</em>,        .</p><br>
<p>  OpenIdConnect:</p><br>
<pre><code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code></pre><br>
<p>  ,        Google – Id Client  Client Secret,      :</p><br>
<ul>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>    « CONFIGURE A PROJECT».</li>
<li>    Web server.</li>
<li>    «Authorized redirect URI»           Google (..      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://localhost:44301/</a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://localhost:44301/signin-google</a>)</li>
<li>     ClientID  Client Secret.</li>
<li>        ,   ,   URL    .</li>
</ul><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Secret Manager</a>.       ,    . </p><br>
<pre><code class="plaintext hljs">dotnet user-secrets init<font></font>
dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID"<font></font>
dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code></pre><br>
<p>          Google.</p><br>
<pre><code class="cs hljs">services.AddAuthentication()<font></font>
                .AddOpenIdConnect(<span class="hljs-string">"Google"</span>, <span class="hljs-string">"Google"</span>,<font></font>
                    o =&gt;<font></font>
                    {<font></font>
                        IConfigurationSection googleAuthNSection =<font></font>
                            Configuration.GetSection(<span class="hljs-string">"Authentication:Google"</span>);<font></font>
                        o.ClientId = googleAuthNSection[<span class="hljs-string">"ClientId"</span>];<font></font>
                        o.ClientSecret = googleAuthNSection[<span class="hljs-string">"ClientSecret"</span>];<font></font>
                        o.Authority = <span class="hljs-string">"https://accounts.google.com"</span>;<font></font>
                        o.ResponseType = OpenIdConnectResponseType.Code;<font></font>
                        o.CallbackPath = <span class="hljs-string">"/signin-google"</span>; <font></font>
                    })<font></font>
                .AddIdentityServerJwt();</code></pre><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>     ,   <br>
     Google.     ,    ,       SPA          .</p><br>
<p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br>
<p> ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. </p><br>
<h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">     Windows</h2><br>
<p>  ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em>.  ,  IS4    ,        ,   <br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>. ,             ASP.NET Core Identity 3.0.</p><br>
<p>         Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ):</p><br>
<pre><code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer<font></font>
dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design<font></font>
<font></font>
dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code></pre><br>
<p>   ,     Area   <em>Identity</em>    ,          .</p><br>
<p>        ,       .   ,  Identity      I<em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   :</p><br>
<pre><code class="cs hljs">ExternalLogins = (<span class="hljs-keyword">await</span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();
<span class="hljs-comment">// &lt;&lt; &gt;&gt;</span>
ExternalLogins =(<span class="hljs-keyword">await</span> _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != <span class="hljs-literal">null</span> ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</code></pre><br>
<p>        <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em>.    View         <em>Login.cshtml</em>:</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"provider"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"@provider.Name"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Log in using your @provider.DisplayName account"</span>&gt;</span>@provider.DisplayName<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;&lt; &gt;</span>&gt;
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"provider"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"@provider.Name"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span>&gt;</span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></code></pre><br>
<p> ,  windows      <em>launchSettings.json</em><br>
(   IIS,       <em>web.config</em>).</p><br>
<pre><code class="json hljs">
<span class="hljs-string">"iisSettings"</span>: {
    <span class="hljs-attr">"windowsAuthentication"</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-attr">"anonymousAuthentication"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"iisExpress"</span>: {
      <span class="hljs-attr">"applicationUrl"</span>: <span class="hljs-string">"http://localhost:15479"</span>,
      <span class="hljs-attr">"sslPort"</span>: <span class="hljs-number">44301</span><font></font>
    }<font></font>
  },</code></pre><br>
<p>       «Windows»    .</p><br>
<p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br>
<p>    SPA      IdentityServer     .    «»    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em>,     ,       WindowsIdentity. </p><br>
<p>   <em>ExternalLogin</em>,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em>.</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">ProcessWindowsLoginAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> returnUrl</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme);
            <span class="hljs-keyword">if</span> (result?.Principal <span class="hljs-keyword">is</span> WindowsPrincipal wp)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> redirectUrl = Url.Page(<span class="hljs-string">"./ExternalLogin"</span>, pageHandler: <span class="hljs-string">"Callback"</span>, values: <span class="hljs-keyword">new</span> { returnUrl });<font></font>
<font></font>
                <span class="hljs-keyword">var</span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl);<font></font>
                props.Items[<span class="hljs-string">"scheme"</span>] = IISDefaults.AuthenticationScheme;<font></font>
<font></font>
                <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">new</span> ClaimsIdentity(IISDefaults.AuthenticationScheme);<font></font>
                id.AddClaim(<span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Subject, wp.Identity.Name));<font></font>
                id.AddClaim(<span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Name, wp.Identity.Name));<font></font>
                id.AddClaim(<span class="hljs-keyword">new</span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name));<font></font>
<font></font>
                <span class="hljs-keyword">var</span> wi = wp.Identity <span class="hljs-keyword">as</span> WindowsIdentity;
                <span class="hljs-keyword">var</span> groups = wi.Groups.Translate(<span class="hljs-keyword">typeof</span>(NTAccount));
                <span class="hljs-keyword">var</span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string">@"BUILTIN\Users"</span>, StringComparison.OrdinalIgnoreCase));<font></font>
<font></font>
                id.AddClaim(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"hasUsersGroup"</span>, hasUsersGroup.ToString()));<font></font>
<font></font>
                <span class="hljs-keyword">await</span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword">new</span> ClaimsPrincipal(id), props);<font></font>
<font></font>
                <span class="hljs-keyword">return</span> Redirect(props.RedirectUri);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> Challenge(IISDefaults.AuthenticationScheme);<font></font>
        }</code></pre></div></div><br>
<p>      ,             .</p><br>
<p>   <em>ExternalLoginModel.OnPost</em>          :</p><br>
<pre><code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider)<font></font>
            {<font></font>
                return await ProcessWindowsLoginAsync(returnUrl);<font></font>
            }</code></pre><br>
<p>   Claim  Windows      Claim «hasUsersGroup»,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em>.</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">UpdateClaims</span>(<span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, <span class="hljs-keyword">params</span> <span class="hljs-keyword">string</span>[] claimTypes</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (claimTypes == <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> claimTypesHash = <span class="hljs-keyword">new</span> HashSet&lt;<span class="hljs-keyword">string</span>&gt;(claimTypes);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> claims = (<span class="hljs-keyword">await</span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList();<font></font>
<font></font>
            <span class="hljs-keyword">await</span> _userManager.RemoveClaimsAsync(user, claims);<font></font>
<font></font>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> claimType <span class="hljs-keyword">in</span> claimTypes)<font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (info.Principal.HasClaim(c =&gt; c.Type == claimType))<font></font>
                {<font></font>
                    claims = info.Principal.FindAll(claimType).ToList();<font></font>
                    <span class="hljs-keyword">await</span> _userManager.AddClaimsAsync(user, claims);<font></font>
                }<font></font>
            }<font></font>
        }</code></pre><br>
<p>      <em>OnPostConfirmationAsync</em> (   <br>
    ).</p><br>
<pre><code class="cs hljs">result = <span class="hljs-keyword">await</span> _userManager.AddLoginAsync(user, info);
                    <span class="hljs-keyword">if</span> (result.Succeeded)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">await</span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal">false</span>);<font></font>
                        _logger.LogInformation(<span class="hljs-string">"User created an account using {Name} provider."</span>, info.LoginProvider);<font></font>
<font></font>
                        <span class="hljs-keyword">await</span> UpdateClaims(info, user, <span class="hljs-string">"hasUsersGroup"</span>);<span class="hljs-comment">//</span><font></font>
<font></font>
                        <span class="hljs-keyword">return</span> LocalRedirect(returnUrl);<font></font>
                    }</code></pre><br>
<p>   <em>OnGetCallbackAsync</em>,      .</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal">false</span>, bypassTwoFactor : <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (result.Succeeded)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey);<font></font>
<font></font>
                <span class="hljs-keyword">await</span> UpdateClaims(info, user, <span class="hljs-string">"hasUsersGroup"</span>);<span class="hljs-comment">//</span></code></pre><br>
<p> ,        WebAPI  <br>
 «hasUsersGroup».      «ShouldHasUsersGroup»</p><br>
<pre><code class="cs hljs">services.AddAuthorization(options =&gt;<font></font>
            {<font></font>
                options.AddPolicy(<span class="hljs-string">"ShouldHasUsersGroup"</span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string">"hasUsersGroup"</span>);});<font></font>
            });</code></pre><br>
<p>   <em>ExchangeRateController</em>      <br>
    Policy.</p><br>
<pre><code class="cs hljs">        [<span class="hljs-meta">Authorize(Policy = <span class="hljs-meta-string">"ShouldHasUsersGroup"</span>)</span>]<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"api/internalrates"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;ExchangeRateItem&gt; <span class="hljs-title">GetInternalRates</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number">-0.02</span>,<span class="hljs-number">2</span>);<span class="hljs-keyword">return</span> i;});<font></font>
        }</code></pre><br>
<p>  view    .</p><br>
<pre><code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code></pre><br>
<p>   template          .</p><br>
<pre><code class="html hljs xml">//internal-data.component.ts:<font></font>
template: `<span class="hljs-tag">&lt;<span class="hljs-name">app-exchange-rate</span> <span class="hljs-attr">apiUrl</span>=<span class="hljs-string">"internalrates"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-exchange-rate</span>&gt;</span> `,<font></font>
<font></font>
//app-routing.module.ts:<font></font>
{ path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard]  }<font></font>
<font></font>
//app.component.html:<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> [<span class="hljs-attr">routerLinkActive</span>]=<span class="hljs-string">'["link-active"]'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link text-dark"</span> [<span class="hljs-attr">routerLink</span>]=<span class="hljs-string">'["/internaldata"]'</span>&gt;</span>Internal api data<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></code></pre><br>
<p>           <br>
, ,    .   ,  accsee_token   <br>
  claim   <em>hasUsersGroup</em>,      <br>
    ApiResources  .  ,    ,        <em>appsettings.json</em>,           <em>Startup. ConfigureServices</em>.</p><br>
<pre><code class="cs hljs">services.AddIdentityServer()<font></font>
                .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt;<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> apiResource = options.ApiResources.First();<font></font>
                    apiResource.UserClaims = <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"hasUsersGroup"</span> };<font></font>
                });</code></pre><br>
<p>,     ,    windows      ,         .</p><br>
<p>      ,   –  Guard    claim   «hasUsersGroup»     «  ».    Guard  :</p><br>
<pre><code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code></pre><br>
<p>     :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">import { Injectable } from '@angular/core';<font></font>
import { Observable } from 'rxjs';<font></font>
import { map,tap} from 'rxjs/operators';<font></font>
import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router';<font></font>
import { AuthorizeService } from "./authorize.service";<font></font>
import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants';<font></font>
<font></font>
@Injectable({<font></font>
  providedIn: 'root'<font></font>
})<font></font>
export class AuthorizeWindowsGroupGuardGuard implements CanActivate{<font></font>
  constructor(private authorize: AuthorizeService, private router: Router) {}<font></font>
<font></font>
  canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; |<font></font>
                                                                          Promise&lt;boolean | UrlTree&gt; |<font></font>
                                                                          boolean |<font></font>
    UrlTree {<font></font>
    return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));;<font></font>
  }<font></font>
<font></font>
  private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) {<font></font>
    if (!isAuthenticated) {<font></font>
      window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/";<font></font>
    }<font></font>
  }<font></font>
}</code></pre></div></div><br>
<p>, ,         .</p><br>
<pre><code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]  </code></pre><br>
<p>    IdentityServer,      claims (<em>sub</em>, <em>profile</em>),     «hasUsersGroup».      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em>.</p><br>
<pre><code class="cs hljs">  <span class="hljs-keyword">var</span> identityResource = <span class="hljs-keyword">new</span> IdentityResource<font></font>
                    {<font></font>
                        Name = <span class="hljs-string">"customprofile"</span>,<font></font>
                        DisplayName = <span class="hljs-string">"Custom profile"</span>,<font></font>
                        UserClaims = <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"hasUsersGroup"</span> },<font></font>
                    };                    identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string">"*"</span>);<font></font>
                    options.IdentityResources.Add(identityResource); </code></pre><br>
<p>- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   ,         windows    « »   SPA –   ,     ,    Guard    .</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github</a>   .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461417/index.html">産業用システムでdb4oを拒否した方法</a></li>
<li><a href="../ja461421/index.html">取引所に投資する際に起こり得る損失から身を守る方法：構造製品</a></li>
<li><a href="../ja461423/index.html">11のヒント：「非デザイナー」にUI / UX作業を提示する方法</a></li>
<li><a href="../ja461425/index.html">プロダクトマネージャーになり、さらに成長する方法</a></li>
<li><a href="../ja461431/index.html">「好き嫌い」：DNS over HTTPS</a></li>
<li><a href="../ja461435/index.html">畳み込みニューラルネットワークを使用した感情認識</a></li>
<li><a href="../ja461437/index.html">370個の電球</a></li>
<li><a href="../ja461439/index.html">ReactおよびTypeScriptコンポーネントライブラリの開始</a></li>
<li><a href="../ja461441/index.html">Rを使用したスト​​レージの状態に関するレポート。並列コンピューティング、グラフ、xlsx、電子メールなど</a></li>
<li><a href="../ja461443/index.html">事後分析：SKS Keyserver暗号鍵サーバーネットワークに対する最新の攻撃について知られていること</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>