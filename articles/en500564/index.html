<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç® ü§∑üèº üöö Offline transactions in public transport - security and antifraud üë®üèª‚Äçüé§ üëàüèº üéâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And not a day has passed, as I am writing a new article, which is also related to NFC technology. Namely - offline transactions in public transport, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Offline transactions in public transport - security and antifraud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500564/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And not a day has passed, as I am writing a new article, which is also related to NFC technology. Namely - offline transactions in public transport, why and what are the pros and cons for passengers and carriers it carries. About five years ago, several scandals related to the hacking of Troika cards in Moscow made a noise. Then the hackers needed to get the keys to access the contents of Mifare 1K cards and the like, as well as quite specific software for working with them. At the same time, the probability of being detected was quite high - cards with inconsistencies in the content and the Troika server were quickly sent to the stop list, and when trying to go through such a card, the turnstile emitted a piercing scream, attracting attention. What changed when the terminals began to support bank cards?</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/up/59/xi/up59xi-eljbjnmjuvc9a2uj34yq.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is exactly the picture when paying for fare can be observed in some large cities. </font><font style="vertical-align: inherit;">New terminals can work both with old Mifare cards and with contactless EMV cards. </font><font style="vertical-align: inherit;">Is it necessary to say that despite the scandals that have erupted, the vulnerabilities of old Mifare have not gone away? </font><font style="vertical-align: inherit;">But in this article, we‚Äôll talk about the vulnerabilities that EMV support brings.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warning for outcasts, crooks and hackers of all stripes:</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Described below is purely informative and informative in nature. </font><font style="vertical-align: inherit;">I understand that for some subjective reasons this warning will not stop some readers, but still remember - there are articles of the Criminal Code of the Russian Federation No. 159 and No. 272!</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit of theory</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EMV (Europay Mastercard Visa)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a standard that describes the behavior of a payment card chip in various scenarios to ensure the highest possible security of payments. </font><font style="vertical-align: inherit;">You can read more about this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in a respected post</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexgre</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We are only interested in the fact that in some cases the protocol allows offline transactions, that is, the operation that the card and terminal conducts exclusively between themselves, and transaction information is transmitted to the acquirer bank later. The advantage of this approach is undoubtedly that this solution is ideal for conditions where there is no connection, or the connection is unstable - like the same bus, for example. The minus follows from the name - the terminal cannot check the availability of funds on the card, as well as the status of the card itself. The bank will only be able to confirm or deny write-offs for a specific transaction during synchronization. What happens if you show the conductor a blank or blocked card? But nothing will happen.Using basic APDU commands, the terminal will ask the card for its expiration date and compare it with the system time - if it has not expired, then it will ask the card for its PAN - this is the same card number stamped on it. Having saved this data, further at the discretion of TRM (Terminal Risk Management, Terminal Risk Management), the terminal will transfer a random number to the card, it hashes it and signs it with its key, the terminal saves the original number and the card's response so that it can later be transferred to the bank. After performing these operations, the terminal sends a command to end the connection to the card and terminates the connection by printing a check ticket. Later, the terminal will not be able to write off money from this card - the PAN card is sent to the stop list - until they pay off the debt, they will not accept this card in any bus. An ideal system, isn't it? It would seem that there are vulnerabilities,no freebies all pay for everything in the end. Everything would have remained the same, if not for one big "But" ... Or a few.</font></font><br>
<br>
<h3>Apple/Samsung/Google Pay ‚Äî </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And on September 9, 2014, Apple introduced a new contactless payment method over existing infrastructure. Apple Pay has been focused on simplicity, speed and privacy. Simplicity was provided (and provides) by Wallet's intuitive interface, and privacy is ensured by tokenization. When adding a card to Wallet, a payment system (such as Mastercard or Visa) generates a token. The token is a PAN - but not the one that is knocked out on the card being added, but its equivalent in the payment system. From now on, POS terminal requests for this virtual PAN will be considered by the payment system as if it were a physical card number. With this approach, even a potentially compromised terminal does not see the real card number - the token can only be used for payments on POS terminals, in other cases it is useless.Later, Samsung Pay and Google Pay (formerly Android Pay) began to work on the same principle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tokens in offline transactions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes. </font><font style="vertical-align: inherit;">A contactless device here is tantamount to a physical card. </font><font style="vertical-align: inherit;">And in case of a payment error, the terminal on the bus will pedantically put the PAN in the stop list. </font><font style="vertical-align: inherit;">Justice has triumphed! </font><font style="vertical-align: inherit;">Only ... PAN is ephemeral! </font><font style="vertical-align: inherit;">Each time you add a card to a mobile device, the token will be different. </font><font style="vertical-align: inherit;">Accordingly - we add the card to the device - and we got out of the stop list without paying a dime. </font><font style="vertical-align: inherit;">Repeat if necessary. </font><font style="vertical-align: inherit;">Thus, to reproduce this attack, any device capable of making contactless payment is suitable. </font><font style="vertical-align: inherit;">That is 90 percent of all phones with NFC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to fight?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Offline - no way. </font><font style="vertical-align: inherit;">Absolutely. </font><font style="vertical-align: inherit;">There is no way to determine whether a token belongs to any account. </font><font style="vertical-align: inherit;">Therefore, we need terminals that can go offline only when necessary, and stay online for as long as possible. </font><font style="vertical-align: inherit;">I understand that the sum of risks is small, but the vulnerability is so easy to operate that everyone can take advantage. </font><font style="vertical-align: inherit;">You can fix the situation - there are specialized validators for public transport.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type of such.</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/ov/1t/wl/ov1twljnqkirfa91bajgeyo8igk.jpeg" alt="image"><br>
     ,      .       .<br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are the findings?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasty innovations will not always be safe and reliable. </font><font style="vertical-align: inherit;">As with the transport system, the old vulnerabilities have not yet been fixed, but they have already brought in new, easily exploited ones. </font><font style="vertical-align: inherit;">And crutches are bad. </font><font style="vertical-align: inherit;">I hope that my little research will help some transport companies rethink their priorities.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500552/index.html">How to speed up code review</a></li>
<li><a href="../en500554/index.html">Golang backend server template - part 2 (REST API)</a></li>
<li><a href="../en500556/index.html">Two years of digital transformation in two months</a></li>
<li><a href="../en500558/index.html">A selection of articles on machine learning: case studies, guides and research for April 2020</a></li>
<li><a href="../en500562/index.html">Form design patterns. Book Review</a></li>
<li><a href="../en500568/index.html">Simple space simulation using Python and Box2D</a></li>
<li><a href="../en500572/index.html">Spring MVC: Website Design and RESTful Services</a></li>
<li><a href="../en500574/index.html">Full analysis of the first part of the exam in SHAD 2020</a></li>
<li><a href="../en500576/index.html">Interpolation and discretization, why are they needed for projective image conversion?</a></li>
<li><a href="../en500578/index.html">The Only One That Matters (Part 4 of Mark Andriessen's Startup Guide, 2007)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>