<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçæ ü§õüèº ü§î Mise √† l'√©chelle des tests Android √† Odnoklassniki üí™üèΩ üéà üà∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Je m'appelle Roman Ivanitsky, je travaille dans l'√©quipe d'automatisation des tests d'Odnoklassniki. OK est un √©norme service avec plus de 70 m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mise √† l'√©chelle des tests Android √† Odnoklassniki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
salut! Je m'appelle Roman Ivanitsky, je travaille dans l'√©quipe d'automatisation des tests d'Odnoklassniki. OK est un √©norme service avec plus de 70 millions d'utilisateurs. Si nous parlons d'appareils mobiles, la majorit√© utilise OK.RU sur les smartphones fonctionnant sous Android. Pour cette raison, nous sommes tr√®s s√©rieux au sujet du test de notre application Android. Dans cet article, je vais raconter l'histoire du d√©veloppement des tests automatis√©s dans notre entreprise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012, Odnoklassniki, la soci√©t√© conna√Æt une augmentation active du nombre d'utilisateurs et une augmentation du nombre de fonctionnalit√©s utilisateur. </font><font style="vertical-align: inherit;">Afin de satisfaire les objectifs commerciaux, il √©tait n√©cessaire de raccourcir le cycle de publication, mais cela a √©t√© entrav√© par le fait que toutes les fonctionnalit√©s ont √©t√© test√©es manuellement. </font><font style="vertical-align: inherit;">La solution √† ce probl√®me est venue d'elle-m√™me - nous avons besoin d'autotests. </font><font style="vertical-align: inherit;">Ainsi, en 2012 √† Odnoklassniki une √©quipe d'automatisation des tests est apparue, et la premi√®re √©tape a √©t√© de commencer √† √©crire des tests.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu d'histoire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les premiers autotests √† Odnoklassniki ont √©t√© √©crits en s√©l√©nium, pour leur lancement, ils ont soulev√© Jenkins, Selenium Grid avec Selenium Hub et un ensemble de s√©l√©nium Node. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solution rapide, d√©marrage rapide, profit rapide - parfait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fil du temps, le nombre de tests a augment√© et des services auxiliaires sont apparus - par exemple, services de lancement, service de rapport, service de donn√©es de test. √Ä la fin de 2014, nous avions mille tests effectu√©s en quinze √† vingt minutes environ. Cela ne nous convenait pas, car il √©tait clair que le nombre de tests augmenterait, et avec lui le temps n√©cessaire pour les ex√©cuter augmenterait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä cette √©poque, l'infrastructure de tests automatis√©s ressemblait √† ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, avec une quantit√© de n≈ìud de s√©l√©nium sup√©rieure ou √©gale √† 200, le concentrateur n'a pas pu faire face √† la charge. </font><font style="vertical-align: inherit;">Maintenant, ce probl√®me a d√©j√† √©t√© √©tudi√©, et c'est pourquoi des outils tels que le Zalenium ou le Selenoid pr√©f√©r√© de tous sont apparus. </font><font style="vertical-align: inherit;">Mais en 2014, il n'y avait pas de solution standard, nous avons donc d√©cid√© de cr√©er la notre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©fini les exigences minimales auxquelles le service doit r√©pondre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âvolutivit√©. </font><font style="vertical-align: inherit;">Nous ne voulons pas d√©pendre des limites du Selenium Hub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La stabilit√©. </font><font style="vertical-align: inherit;">En 2014, le Selenium Hub n'√©tait pas r√©put√© pour son fonctionnement stable.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tol√©rance aux pannes. </font><font style="vertical-align: inherit;">Nous devons pouvoir poursuivre le processus de test en cas de panne du centre de donn√©es ou de l'un des serveurs.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, notre solution pour la mise √† l'√©chelle de Selenium Grid est apparue, compos√©e d'un coordinateur et de gestionnaires de n≈ìuds, ext√©rieurement tr√®s similaire √† la grille de s√©l√©nium standard, mais avec ses propres fonctionnalit√©s. </font><font style="vertical-align: inherit;">Ces caract√©ristiques seront discut√©es plus loin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coordinateur</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, c'est un courtier en ressources (les ressources sont comprises comme des navigateurs). Il dispose d'une API externe √† travers laquelle les tests envoient des demandes de ressources. Ces requ√™tes sont enregistr√©es dans la base de donn√©es en tant que t√¢ches √† ex√©cuter. Le coordinateur sait tout sur la configuration de notre cluster - quels gestionnaires de n≈ìuds existent, quels types de ressources ces gestionnaires de n≈ìuds peuvent fournir, le nombre total de ressources, combien de ressources sont actuellement impliqu√©es dans les t√¢ches. Dans le m√™me temps, il surveille les ressources - activit√©, stabilit√© et, dans ce cas, informe les responsables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une caract√©ristique du coordinateur est qu'il int√®gre tous les gestionnaires de n≈ìuds dans ce qu'on appelle des batteries de serveurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voil√† √† quoi ressemble la ferme. Plus de la moiti√© des ressources sont utilis√©es et tous les n≈ìuds en ligne:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©galement afficher les n≈ìuds hors ligne ou les entrer en rotation d'un certain pourcentage, cela est n√©cessaire s'il devient n√©cessaire de r√©duire la charge sur un n≈ìud particulier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque ferme peut √™tre combin√©e avec d'autres dans une unit√© logique, que nous appelons un service. En m√™me temps, une ferme peut √™tre incluse dans plusieurs services diff√©rents. Premi√®rement, il permet de fixer des limites et de hi√©rarchiser les ressources utilis√©es par chaque service sp√©cifique. Deuxi√®mement, il vous permet de g√©rer facilement la configuration - nous avons la possibilit√© d'ajouter le nombre de gestionnaires de n≈ìuds dans le service √† la vol√©e, ou vice versa pour les supprimer de la batterie de serveurs afin de pouvoir interagir avec ces gestionnaires de n≈ìuds, par exemple, configurer ou mettre √† jour, etc. .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'API du coordinateur est assez simple: il est possible de demander le service pour la quantit√© actuelle de ressources utilis√©es, d'obtenir sa limite et de d√©marrer ou d'arr√™ter une ressource.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaire de n≈ìuds</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un service qui peut bien faire deux choses: recevoir des t√¢ches du coordinateur et lancer certaines ressources √† la demande. </font><font style="vertical-align: inherit;">Par d√©faut, il est con√ßu pour que chaque lancement de la ressource soit isol√©, c'est-√†-dire qu'aucun des lancements pr√©c√©dents ne peut affecter le lancement des tests suivants. </font><font style="vertical-align: inherit;">En r√©ponse, le coordinateur utilise un tas d'h√¥tes et un ensemble de ports sur√©lev√©s. </font><font style="vertical-align: inherit;">Par exemple, l'h√¥te sur lequel le serveur Selenium a √©t√© lanc√© et son port. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'h√¥te, cela ressemble √† ceci: le service Node Manager est en cours d'ex√©cution et il g√®re l'ensemble du cycle de vie des ressources. </font><font style="vertical-align: inherit;">Il r√©cup√®re les navigateurs, les compl√®te, s'assure qu'ils ne sont pas oubli√©s de se fermer. </font><font style="vertical-align: inherit;">Pour garantir l'isolement les uns des autres, tout cela se produit au nom de l'utilisateur du service.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test interagit avec l'infrastructure d√©crite ci-dessus comme suit: il adresse au coordinateur une demande pour les ressources n√©cessaires, le coordinateur enregistre cette t√¢che comme n√©cessitant une ex√©cution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire de n≈ìud, √† son tour, se tourne vers le coordinateur de t√¢ches. Ayant re√ßu la t√¢che, il d√©marre la ressource. Apr√®s cela, il envoie le r√©sultat du lancement au coordinateur, les √©checs de d√©marrage sont √©galement signal√©s au coordinateur. Le test re√ßoit le r√©sultat de la demande de ressource et, s'il r√©ussit, commence √† travailler directement avec la ressource. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les avantages de cette approche sont de r√©duire la charge du coordinateur en gagnant la capacit√© de travailler directement avec la ressource. Inconv√©nients - la n√©cessit√© de mettre en ≈ìuvre la logique d'interaction avec le coordinateur dans les cadres de test, mais pour nous, cela est acceptable.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous pouvons ex√©cuter plus de 800 navigateurs en parall√®le dans trois centres de donn√©es. </font><font style="vertical-align: inherit;">Pour le coordinateur, ce n'est pas la limite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tol√©rance aux pannes est assur√©e par le lancement de plusieurs instances de coordinateur enroul√©es derri√®re le pare-feu DNS dans diff√©rents centres de donn√©es. </font><font style="vertical-align: inherit;">Cela garantit l'acc√®s √† l'instance de travail en cas de probl√®me avec le centre de donn√©es ou le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons obtenu une solution qui r√©pondait √† toutes les exigences initialement d√©finies. </font><font style="vertical-align: inherit;">Il fonctionne r√©guli√®rement depuis 2015 et a prouv√© son efficacit√©.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ce qui concerne les tests sur Android, il existe g√©n√©ralement deux approches principales. La premi√®re consiste √† utiliser WebDriver - c'est ainsi que Selendroid et Appium fonctionnent. Le second - en travaillant avec des outils natifs, a donc impl√©ment√© Robotium, UI Automator ou Espresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les similitudes fondamentales entre ces approches sont d'obtenir l'appareil et le navigateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup plus de diff√©rences, la principale est la n√©cessit√© d'installer l'APK test√©, avec lequel nous prendrons des artefacts sous forme de journaux, de captures d'√©cran, etc. et aussi, le fait que les tests sont effectu√©s sur l'appareil lui-m√™me, et non sur le CI.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2015, Odnoklassniki a commenc√© √† couvrir son application Android avec des autotests. Nous avons s√©lectionn√© une machine Linux, connect√© un v√©ritable appareil via USB et commenc√© √† √©crire des tests sur Robotium. Cette solution simple vous a permis d'obtenir rapidement des r√©sultats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le temps a pass√©, le nombre de tests et le nombre d'appareils ont augment√©. Pour r√©soudre les t√¢ches de gestion, Device Manager a √©t√© cr√©√© - un wrapper sur les commandes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Android Debug Bridge), qui permet √† l'interface http api de les ex√©cuter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemblait la premi√®re API pour Device Manager - avec son aide, vous pouvez obtenir une liste de p√©riph√©riques, installer / d√©sinstaller des APK, ex√©cuter des tests et obtenir des r√©sultats.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous avons remarqu√© que les r√©sultats des tests se d√©gradent au d√©marrage sur le serveur ADB auquel plusieurs p√©riph√©riques sont connect√©s. La solution qui nous a aid√©s √† am√©liorer la stabilit√© a √©t√© trouv√©e en isolant chaque serveur ADB √† l'aide de Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ferme est pr√™te - vous pouvez connecter des t√©l√©phones. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup connaissent cette image. J'ai entendu dire que si vous √™tes engag√© dans des fermes Android, vous √™tes comme en enfer tous les jours.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un √©mulateur Android est venu √† notre aide. Son utilisation √©tait due √† deux facteurs: d'une part, √† l'√©poque, il avait d√©j√† atteint le niveau de stabilit√© n√©cessaire, et d'autre part, nous n'avions aucune caract√©ristique qui d√©pendrait sp√©cifiquement du fer dans nos tests. De plus, cet √©mulateur √©tait bien projet√© sur l'infrastructure existante √† l'√©poque. L'√©tape suivante consistait √† apprendre au gestionnaire de n≈ìuds √† lancer de nouveaux types de ressources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faut-il pour ex√©cuter l'√©mulateur Android? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, vous avez besoin d'un SDK Android avec un ensemble d'utilitaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez cr√©er AVD - Appareil virtuel Android - c'est ainsi que votre √©mulateur Android sera organis√© - quelle architecture il aura, combien de c≈ìurs il utilisera, si les services Google seront disponibles, etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, vous devez s√©lectionner le nom de l'AVD cr√©√©, d√©finir les param√®tres, par exemple, transf√©rer le port sur lequel ADB sera lanc√© et d√©marrer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il y a une particularit√© dans un tel sch√©ma - le syst√®me vous permet d'ex√©cuter un seul √©mulateur d'instance sur un AVD sp√©cifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La solution √† ce probl√®me √©tait de cr√©er un AVD de base, qui √©tait stock√© en m√©moire, ce qui permettait de le copier ailleurs. </font><font style="vertical-align: inherit;">Lors du lancement de l'√©mulateur Android, l'AVD de base a √©t√© copi√© dans un r√©pertoire temporaire mapp√© en m√©moire, apr√®s quoi il a d√©marr√©. </font><font style="vertical-align: inherit;">Un tel syst√®me a fonctionn√© rapidement, mais √©tait lourd. </font><font style="vertical-align: inherit;">√Ä ce jour, ce probl√®me a √©t√© r√©solu par l'option en lecture seule, qui vous permet d'ex√©cuter des √©mulateurs Android en quantit√©s illimit√©es √† partir d'un seul AVD</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base des r√©sultats du travail avec AVD, nous avons d√©velopp√© plusieurs recommandations internes:</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quant aux images Docker pour les tests sur Android, je veux souligner Agoda et Selenoid, elles utilisent au maximum les capacit√©s des √©mulateurs Android. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diff√©rence entre eux est que dans le s√©l√©no√Øde par d√©faut </font><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Agoda et l'√©mulateur "propre" sont utilis√©s. De plus, Selenoid a plus de soutien communautaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fin 2018, CloudNode-Manager a √©t√© cr√©√©, il contacte le coordinateur, re√ßoit les t√¢ches et se lance √† l'aide de commandes dans le cloud. Au lieu de machines √† repasser, ce service utilise les ressources d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le cloud priv√© d'Odnoklassniki.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons r√©ussi √† atteindre l'√©chelle en enseignant √† DeviceManager comment travailler avec le coordinateur. Pour ce faire, j'ai d√ª changer l'API du gestionnaire de p√©riph√©riques pour ajouter la possibilit√© de demander un type de p√©riph√©rique (virtuel / r√©el). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est ce qui se produit si vous essayez d'ex√©cuter ADB Install sur 250 √©mulateurs √† partir d'une seule machine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les pr√©pos√©s ont imm√©diatement r√©agi √† cela et ont d√©clench√© un incident - la machine a charg√© l'interface r√©seau gigabit avec le trafic sortant. Cette complexit√© a √©t√© r√©solue en augmentant le d√©bit sur le serveur. Je ne peux pas dire que ce probl√®me nous a caus√© beaucoup de probl√®mes, mais vous ne devez pas l‚Äôoublier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait que le succ√®s soit le Devicemanager, coordinateur, scaling. Nous pouvons ex√©cuter des tests sur toute la ferme. En principe, nous pouvons les ex√©cuter √† chaque demande de tirage et le d√©veloppeur recevra rapidement des commentaires.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais tout n'est pas si rose. Vous avez peut-√™tre remarqu√© que jusqu'√† pr√©sent, rien n'a √©t√© dit sur la qualit√© des tests. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voil√† √† quoi ressemblaient nos lancements. Et le plus int√©ressant, c'est qu'entre les lancements, des tests compl√®tement diff√©rents pourraient tomber. Ce sont des chutes instables. Et ni moi, ni les d√©veloppeurs, ni les testeurs n'ont fait confiance √† ces r√©sultats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment avons-nous r√©gl√© ce probl√®me? Ils ont juste tout copi√©, de Robotium √† Espresso, et c'est devenu bon ... En fait, non. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©soudre ce probl√®me, nous avons non seulement tout r√©√©crit sur Espresso, mais nous avons √©galement commenc√© √† utiliser l'API pour toutes sortes d'actions telles que le t√©l√©chargement de photos, la cr√©ation de messages, l'ajout √† des amis, etc., une connexion rapide, des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diplinks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilis√©s </font><font style="vertical-align: inherit;">qui vous permettaient d'acc√©der directement √† l'√©cran souhait√© et, bien s√ªr, nous avons analys√© tous les cas de test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, les ex√©cutions de test ressemblent √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vous pouvez remarquer que les tests rouges restent, mais il est important de se rappeler que ce sont des tests de bout en bout qui s'ex√©cutent en production. Nous avons une limite sur le nombre de tests qui peuvent tomber dans la branche principale de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant des tests et une mise √† l'√©chelle stables. Cependant, l'infrastructure de test est toujours fortement li√©e aux tests. Dans le m√™me temps, en raison de l'attente de tests de bout en bout, CI est occup√© et d'autres assemblys peuvent faire la queue, en attendant les agents libres. De plus, il n'y a pas de sch√©ma clair pour travailler avec des d√©marrages parall√®les.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les raisons mentionn√©es ci-dessus sont devenues l'impulsion pour le d√©veloppement de QueueRunner - un service qui vous permet d'ex√©cuter des tests de mani√®re asynchrone sans bloquer le CI. </font><font style="vertical-align: inherit;">Pour travailler, il a besoin d'un test et d'un test APK, ainsi que d'un ensemble de tests. </font><font style="vertical-align: inherit;">Ayant re√ßu les donn√©es n√©cessaires, il pourra organiser des runs de runs dans la file d'attente, allouer et lib√©rer les ressources n√©cessaires. </font><font style="vertical-align: inherit;">QueueRunner t√©l√©charge les r√©sultats de l'ex√©cution sur Jira et Stash, et les envoie √©galement par courrier et dans le messager. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner a un flux de test - il surveille le cycle de vie du test. </font><font style="vertical-align: inherit;">Le flux par d√©faut que nous utilisons maintenant se compose de cinq √©tapes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appareil r√©cepteur. </font><font style="vertical-align: inherit;">√Ä ce stade, le Devicemanager demande via le coordinateur un appareil r√©el ou virtuel.</font></font></li>
<li> .        APK  ,    ‚Äì  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, cinq √©tapes simples constituent l'ensemble du cycle de vie du test dans notre service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels avantages QueueRunner nous a-t-il apport√©? Tout d'abord, il utilise toutes les ressources possibles au maximum - il peut √™tre adapt√© √† l'ensemble de la batterie de serveurs et obtenir rapidement des r√©sultats. Deuxi√®mement, avec le bonus, nous avons eu la possibilit√© de contr√¥ler la s√©quence des tests. Par exemple, nous pouvons ex√©cuter les tests les plus longs ou les plus probl√©matiques au d√©but et ainsi r√©duire le temps d'attente pour qu'ils s'ex√©cutent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner vous permet √©galement de cr√©er des plateaux intelligents. Nous stockons toutes les donn√©es dans la base de donn√©es, donc √† tout moment nous pouvons voir l'historique du test. Par exemple, il est possible d'examiner le ratio de r√©ussite et d'√©chec du test et de d√©cider si, en principe, cela vaut la peine de recommencer le test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner et Devicemanager nous ont donn√© la possibilit√© de nous adapter √† la quantit√© de ressources. Maintenant, nous pouvons √©voluer sur l'ensemble de la batterie de serveurs, gr√¢ce √† l'utilisation d'√©mulateurs, c'est-√†-dire qu'un nombre presque illimit√© d'appareils virtuels nous a donn√© la possibilit√© d'ex√©cuter beaucoup plus de tests, mais si pour une raison quelconque les ressources ne sont pas disponibles, le service attendra leur retour et il n'y aura aucune perte de lancements. Nous utilisons uniquement les ressources √† notre disposition, en cons√©quence, apr√®s un certain temps, les r√©sultats seront toujours obtenus et en m√™me temps, l'IC ne sera pas bloqu√©. Et surtout, l'infrastructure de test et les tests sont d√©sormais s√©par√©s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, pour ex√©cuter des tests sur Android, il vous suffit de nous donner un APK de test et une liste de tests.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons parcouru un long chemin depuis la ferme Selenium sur machines virtuelles jusqu'au lancement de tests Android dans le cloud. </font><font style="vertical-align: inherit;">Cependant, ce chemin n'est pas encore termin√©.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processus de d√©veloppement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment l'infrastructure de test est li√©e au processus de d√©veloppement et comment les testeurs et les d√©veloppeurs la voient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre √©quipe Android utilise le GitFlow standard: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
chaque fonctionnalit√© a sa propre branche. Le d√©veloppement principal se d√©roule dans la branche develop. Un d√©veloppeur qui d√©cide de cr√©er une nouvelle super fonctionnalit√© commence son d√©veloppement dans sa propre branche, tandis que d'autres d√©veloppeurs peuvent travailler dans d'autres branches en parall√®le. Lorsqu'un d√©veloppeur consid√®re que le meilleur code id√©alement beau au monde est pr√™t et doit √™tre d√©ploy√© aupr√®s des utilisateurs le plus rapidement possible, il fait une demande d'extraction lors du d√©veloppement, l'unit√© est automatiquement assembl√©e, des tests unitaires et des tests de composants sont ex√©cut√©s. Simultan√©ment, les fichiers APK sont assembl√©s, envoy√©s √† QueueRunner et des tests de bout en bout sont ex√©cut√©s. Apr√®s cela, les r√©sultats de l'ex√©cution des tests reviennent au d√©veloppeur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il y a une forte probabilit√© qu'apr√®s la cr√©ation de la branche de fonctionnalit√© dans develop, il y ait eu de nombreux commits. </font><font style="vertical-align: inherit;">Cela signifie que d√©velopper peut ne plus √™tre ce qu'il √©tait. </font><font style="vertical-align: inherit;">Par cons√©quent, la pr√©-fusion se produit en premier - nous fusionnons le d√©veloppement dans la branche de fonctionnalit√© actuelle, et c'est sur cet √©tat pr√©matur√© que nous faisons l'assemblage, les tests unitaires, les tests de composants, de bout en bout, et sur la base de ces r√©sultats, nous faisons un rapport. </font><font style="vertical-align: inherit;">Ainsi, nous comprenons √† quel point la fonctionnalit√© est fonctionnelle dans la version actuelle de develop et, si tout va bien, elle est envoy√©e aux utilisateurs.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rapports</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble le rapport Stash: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre bot √©crit d'abord que les tests ont commenc√©, et quand ils r√©ussissent, il met √† jour le message et ajoute combien ont r√©ussi, combien sont tomb√©s, combien d'erreurs connues et combien de tests Flaky. Il √©crit la m√™me chose dans Jira et ajoute un lien vers une comparaison des lancements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble la comparaison des deux lancements: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, l'ex√©cution en cours dans la branche de fonctionnalit√© est compar√©e √† la derni√®re ex√©cution du d√©veloppement. Il contient des informations sur le nombre de tests en cours d'ex√©cution, les probl√®mes de correspondance, les tests abandonn√©s et les tests Flaky instables qui √©taient dans un √©tat et pass√©s √† un autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si au moins un test unitaire ou plus d'un certain seuil de tests de bout en bout tombe, la fusion sera bloqu√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de comprendre si les tests tombent de mani√®re stable, nous comparons les hachages des traces traces des chutes, avant qu'elles soient pr√©alablement d√©barrass√©es des chiffres, il ne reste que les num√©ros de ligne. </font><font style="vertical-align: inherit;">Si les hachages correspondent, alors c'est la m√™me chute, s'ils sont diff√©rents, alors les chutes seront probablement diff√©rentes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons mis en ≈ìuvre une solution stable et tol√©rante aux pannes qui s'adapte bien √† notre infrastructure. </font><font style="vertical-align: inherit;">Ensuite, l'infrastructure r√©sultante a √©t√© adapt√©e pour les tests Android. </font><font style="vertical-align: inherit;">Nous avons √©t√© aid√©s √† cet √©gard par le gestionnaire de p√©riph√©riques, qui nous aide √† travailler √† la fois avec des p√©riph√©riques r√©els et virtuels, ainsi qu'avec QueueRunner, qui nous a aid√©s √† s√©parer l'infrastructure et les tests, et non √† bloquer les CI pendant la dur√©e des tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemblait √† la dur√©e d'ex√©cution du test pendant une semaine en 2016 - de cinquante minutes ou plus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voil√† √† quoi cela ressemble maintenant: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ce graphique montre les ex√©cutions qui ont eu lieu sur 2 heures d'un jour ouvrable moyen. </font><font style="vertical-align: inherit;">Le temps de course a √©t√© r√©duit √† un maximum de 15 minutes, le nombre de courses a consid√©rablement augment√©.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497700/index.html">Mitaps en ligne hebdomadaires sur le support et DevOps, la s√©curit√© et les robots √† partir du 17 avril</a></li>
<li><a href="../fr497702/index.html">Cinq tendances du stockage de donn√©es auxquelles vous devriez faire attention en 2020</a></li>
<li><a href="../fr497708/index.html">Nous vous invitons √† une s√©rie de webinaires Fujitsu en avril et mai</a></li>
<li><a href="../fr497714/index.html">Comment prot√©ger les processus et les extensions du noyau sur macOS</a></li>
<li><a href="../fr497724/index.html">Pr√©paration d'un serveur pour la publication d'une application Web en Python</a></li>
<li><a href="../fr497728/index.html">Les dangers de ¬´br√ªler¬ª les puces</a></li>
<li><a href="../fr497730/index.html">BDD pratique: SpecFlow + TFS</a></li>
<li><a href="../fr497736/index.html">Examen de 10 nouveaux moteurs √† combustion interne</a></li>
<li><a href="../fr497738/index.html">Testez-vous dans Swift: un puzzle pour les amateurs de puzzle</a></li>
<li><a href="../fr497740/index.html">Les constructeurs automobiles admettent qu'il faut beaucoup de temps avant d'√™tre enti√®rement sans pilote</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>