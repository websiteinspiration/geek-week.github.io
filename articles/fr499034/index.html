<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå•Ô∏è üïú üíæ Comment d√©ployer un refactoring dangereux pour produire avec un million d'utilisateurs? üß¢ üõ©Ô∏è ‚è©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le film "Avion", 1980. 
 
 C'est comme √ßa que je me sentais quand j'ai vers√© un autre refactoring sur la prod. M√™me si vous couvrez tout le code avec ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment d√©ployer un refactoring dangereux pour produire avec un million d'utilisateurs?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le film "Avion", 1980. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est comme √ßa que je me sentais quand j'ai vers√© un autre refactoring sur la prod. </font><font style="vertical-align: inherit;">M√™me si vous couvrez tout le code avec des m√©triques et des journaux, testez la fonctionnalit√© sur tous les environnements - cela n'√©conomisera pas 100% des fakaps apr√®s le d√©ploiement.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First Fakap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons en quelque sorte refactoris√© notre traitement de l'int√©gration avec Google Sheets. Pour les utilisateurs, il s'agit d'une fonctionnalit√© tr√®s utile, car ils utilisent de nombreux outils en m√™me temps qui doivent √™tre li√©s ensemble - envoyer des contacts √† une table, t√©l√©charger des r√©ponses aux questions, exporter des utilisateurs, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code d'int√©gration n'a pas √©t√© refactoris√© √† partir de la premi√®re version et il est devenu de plus en plus difficile √† maintenir. Cela a commenc√© √† affecter nos utilisateurs - d'anciens bogues ont √©t√© r√©v√©l√©s que nous avions peur d'√©diter en raison de la complexit√© du code. Il est temps de faire quelque chose. Aucune modification logique n'√©tait suppos√©e - il suffit d'√©crire des tests, de d√©placer des classes et des noms de peigne. Bien s√ªr, nous avons test√© la fonctionnalit√© sur l'environnement de d√©veloppement et sommes all√©s d√©ployer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s 20 minutes, les utilisateurs ont √©crit que l'int√©gration ne fonctionnait pas. </font><font style="vertical-align: inherit;">La fonctionnalit√© d'envoi de donn√©es √† Google Sheet est tomb√©e - il s'est av√©r√© que pour le d√©bogage, nous envoyons des donn√©es dans diff√©rents formats pour les ventes et les environnements locaux. </font><font style="vertical-align: inherit;">Lors de la refactorisation, nous avons atteint le format de vente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons fix√© l'int√©gration, mais n√©anmoins, les s√©diments du joyeux vendredi soir (et vous pensiez!) Sont rest√©s. </font><font style="vertical-align: inherit;">R√©trospectivement (rencontrer l'√©quipe pour terminer le sprint), nous avons commenc√© √† r√©fl√©chir √† la fa√ßon de pr√©venir de telles situations √† l'avenir - nous devons am√©liorer la pratique des tests manuels, des auto-tests, travailler avec des m√©triques et des alarmes, et en plus de cela, nous avons eu l'id√©e d'utiliser des indicateurs de fonctionnalit√© pour tester la refactorisation sur prode, en fait, cela sera discut√©.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la mise en oeuvre</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sch√©ma est simple: si l'utilisateur a le drapeau activ√©, passez au code avec la nouvelle version, sinon, au code avec l'ancienne version:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette approche, nous avons la possibilit√© de tester la refactorisation sur prod d'abord sur nous-m√™mes, puis de la verser aux utilisateurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque d√®s le d√©but du projet, nous avons eu une impl√©mentation primitive de la fonction drapeaux. </font><font style="vertical-align: inherit;">Dans la base de donn√©es de deux entit√©s de base, utilisateur et compte, des champs de fonctionnalit√©s ont √©t√© ajout√©s, qui √©taient un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masque de bits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans le code, nous avons enregistr√© de nouvelles constantes pour les fonctionnalit√©s, que nous avons ensuite ajout√©es au masque si une fonctionnalit√© sp√©cifique devient disponible pour l'utilisateur.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisation dans le code ressemblait √† ceci:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la refactorisation, nous ouvrons g√©n√©ralement le drapeau √† l'√©quipe pour les tests, puis √† plusieurs utilisateurs qui utilisent activement la fonctionnalit√©, et enfin ouverts √† tous, mais parfois des sch√©mas plus complexes apparaissent, plus √† leur sujet ci-dessous.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring des lieux surcharg√©s</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'un de nos syst√®mes accepte les webhooks Facebook et les traite via la file d'attente. Le traitement des files d'attente a cess√© de fonctionner et les utilisateurs ont commenc√© √† recevoir certains messages avec un retard, ce qui pourrait affecter de mani√®re critique l'exp√©rience des abonn√©s au bot. Nous avons commenc√© √† refactoriser cet endroit en transf√©rant le traitement vers un sch√©ma de file d'attente plus complexe. L'endroit est critique - il est dangereux de verser une nouvelle logique sur tous les serveurs, nous avons donc ferm√© la nouvelle logique sous le drapeau et avons pu la tester sur la prod. Mais que se passe-t-il lorsque nous ouvrons ce drapeau? Comment se comportera notre infrastructure? Cette fois, nous avons d√©ploy√© l'ouverture du drapeau sur les serveurs et suivi les m√©triques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les traitements de donn√©es critiques que nous avons divis√©s en clusters. </font><font style="vertical-align: inherit;">Chaque cluster a un identifiant. </font><font style="vertical-align: inherit;">Nous avons d√©cid√© de simplifier les tests d'une refactorisation aussi complexe en ouvrant la fonctionnalit√© de drapeau uniquement sur certains serveurs, la v√©rification dans le code ressemble √† ceci:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons vers√© du refactoring et ouvert les drapeaux √† l'√©quipe. </font><font style="vertical-align: inherit;">Ensuite, nous avons trouv√© plusieurs utilisateurs qui utilisaient activement la fonction cgt, leur ouvraient des drapeaux et cherchaient si tout fonctionnait pour eux. </font><font style="vertical-align: inherit;">Et enfin, ils ont commenc√© √† ouvrir des drapeaux sur les serveurs et √† suivre les m√©triques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'indicateur cgt_refactoring_cluster_ids peut √™tre modifi√© via le panneau d'administration. </font><font style="vertical-align: inherit;">Initialement, nous attribuons la valeur cgt_refactoring_cluster_ids √† un tableau vide, puis ajoutons un cluster √† la fois - [1], examinons les m√©triques pendant un certain temps et ajoutons un autre cluster - [1, 2] jusqu'√† ce que nous testions l'ensemble du syst√®me.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation du configurateur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais parler un peu de ce qu'est le configurateur et de la fa√ßon dont il est impl√©ment√©. </font><font style="vertical-align: inherit;">Il a √©t√© √©crit pour pouvoir changer la logique sans d√©ploiement, par exemple, comme dans le cas ci-dessus, lorsque nous devons faire reculer la logique. </font><font style="vertical-align: inherit;">Nous l'utilisons √©galement pour les configurations dynamiques, par exemple, lorsque vous devez tester diff√©rents temps de mise en cache, vous pouvez le retirer pour un test rapide. </font><font style="vertical-align: inherit;">Pour le d√©veloppeur, cela ressemble √† une liste de champs avec des valeurs d'administration qui peuvent √™tre modifi√©es. </font><font style="vertical-align: inherit;">Nous stockons tout cela dans une base de donn√©es, nous mettons en cache dans Redis et dans une statique pour nos travailleurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactorisation d'emplacements obsol√®tes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours du prochain trimestre, nous avons refondu la logique d'inscription, la pr√©parant √† la transition vers la possibilit√© d'inscription via plusieurs services. </font><font style="vertical-align: inherit;">Dans nos conditions, il est impossible de regrouper la logique d'enregistrement afin qu'un certain utilisateur soit li√© √† une certaine logique, et nous n'avons rien trouv√© de mieux que de tester la logique, en d√©ployant un pourcentage de toutes les demandes d'enregistrement. </font><font style="vertical-align: inherit;">Ceci est facile √† faire d'une mani√®re similaire avec des drapeaux:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons d√©fini la valeur de auth_refactoring_percentage dans le panneau d'administration de 0 √† 100. Bien s√ªr, nous avons ¬´√©tal√©¬ª toute la logique d'autorisation avec des m√©triques afin de comprendre que nous n'avons pas r√©duit la conversion √† la fin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©trique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour dire comment nous suivons les m√©triques dans le processus d'ouverture des indicateurs, nous examinerons un autre cas plus en d√©tail. </font><font style="vertical-align: inherit;">ManyChat accepte les hooks Facebook de Facebook lorsqu'un abonn√© envoie un message √† Facebook Messenger. </font><font style="vertical-align: inherit;">Nous devons traiter chaque message conform√©ment √† la logique m√©tier. </font><font style="vertical-align: inherit;">Pour la fonctionnalit√© cgt, nous devons d√©terminer si l'abonn√© a commenc√© la conversation via un commentaire sur Facebook afin de lui envoyer un message pertinent en r√©ponse. </font><font style="vertical-align: inherit;">Dans le code, cela ressemble √† d√©terminer le contexte de l'abonn√© actuel, si nous pouvons d√©terminer le widgetId, alors nous en d√©terminons le message de r√©ponse.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur la fonctionnalit√©</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      ‚Äî    .        Widget,   :<br>
<br>
  ‚Äî&gt;     ‚Äî&gt;     ‚Äî&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  ‚Äî&gt;    ‚Äî&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     ‚Äú , !‚Äù   ,        .   ,     ‚Äú  !‚Äù   id       ,     ‚Äî   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auparavant, nous avons d√©fini le contexte de 3 fa√ßons, il ressemblait √† ceci:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le service de surveillance envoie des analyses au moment de la correspondance, respectivement, nous avions des mesures pour les trois cas: le </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fois o√π le </font><i><font style="vertical-align: inherit;">contexte a √©t√© trouv√© par diff√©rentes m√©thodes de liaison dans le temps.</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ensuite, nous avons trouv√© une autre m√©thode de correspondance qui devrait remplacer toutes les anciennes options. </font><font style="vertical-align: inherit;">Pour tester cela, nous avons obtenu une autre m√©trique:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce stade, nous voulons nous assurer que le nombre de nouveaux hits est √©gal √† la somme des anciens hits, il suffit donc d'√©crire la m√©trique sans retourner $ widgetId: le </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de contextes trouv√©s par la nouvelle m√©thode couvre compl√®tement la somme des liaisons par les anciennes m√©thodes</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
mais cela ne nous garantit pas la logique de correspondance correcte dans tous les cas. </font><font style="vertical-align: inherit;">L'√©tape suivante consiste √† tester progressivement √† travers l'ouverture des drapeaux:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le processus de test a commenc√©: au d√©but, nous avons test√© la nouvelle fonctionnalit√© par nous-m√™mes sur tous les environnements et sur des utilisateurs al√©atoires qui utilisent souvent la correspondance en ouvrant l'indicateur UserFeatures :: ALLOW_CGT_MATCHING_BY_ECHO. </font><font style="vertical-align: inherit;">√Ä ce stade, nous avons d√©tect√© quelques cas o√π le match a mal fonctionn√© et les avons r√©par√©s. </font><font style="vertical-align: inherit;">Puis ils ont commenc√© √† se d√©ployer sur les serveurs: en moyenne, nous avons d√©ploy√© un serveur en 1 jour au cours de la semaine. </font><font style="vertical-align: inherit;">Avant les tests, nous avertissons le support qu'ils examinent attentivement les tickets li√©s √† la fonctionnalit√© et nous √©crivent sur toute anomalie. </font><font style="vertical-align: inherit;">Gr√¢ce au support et aux utilisateurs, plusieurs cas d'angle ont √©t√© corrig√©s. </font><font style="vertical-align: inherit;">Et enfin, la derni√®re √©tape est la d√©couverte de tous sans condition:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation de la nouvelle fonctionnalit√© de drapeau</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mise en ≈ìuvre de la fonctionnalit√© de drapeau d√©crite au d√©but de l'article nous a servi pendant environ 3 ans, mais avec la croissance des √©quipes, cela est devenu inconfortable - nous avons d√ª d√©ployer lors de la cr√©ation de chaque drapeau et ne pas oublier d'effacer la valeur des drapeaux (nous avons r√©utilis√© des valeurs constantes pour diff√©rentes fonctionnalit√©s). </font><font style="vertical-align: inherit;">R√©cemment, le composant a √©t√© r√©√©crit et nous pouvons maintenant g√©rer de mani√®re flexible les indicateurs via le panneau d'administration. </font><font style="vertical-align: inherit;">Les drapeaux ont √©t√© d√©tach√©s du masque binaire et stock√©s dans une table distincte, ce qui facilite la cr√©ation de nouveaux drapeaux. </font><font style="vertical-align: inherit;">Chaque entr√©e a √©galement une description et un propri√©taire, la gestion des drapeaux est devenue plus transparente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inconv√©nients de ces approches</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche a un gros inconv√©nient - il existe deux versions du code et elles doivent √™tre prises en charge en m√™me temps. </font><font style="vertical-align: inherit;">Lors des tests, vous devez consid√©rer qu'il existe deux branches de la logique et que vous devez toutes les v√©rifier, ce qui est tr√®s douloureux. </font><font style="vertical-align: inherit;">Au cours du d√©veloppement, il y a eu des situations o√π nous avons introduit un correctif dans une logique, mais en avons oubli√© une autre et √† un moment donn√©, il a tourn√©. </font><font style="vertical-align: inherit;">Par cons√©quent, nous n'appliquons cette approche que dans des endroits critiques et essayons de nous d√©barrasser de l'ancienne version du code le plus rapidement possible. </font><font style="vertical-align: inherit;">Nous essayons de faire le reste du refactoring en petites it√©rations.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le processus actuel ressemble √† ceci - nous fermons d'abord la logique sous la condition des drapeaux, puis d√©ployons et commen√ßons √† ouvrir progressivement les drapeaux. Lors de l'expansion des indicateurs, nous surveillons √©troitement les erreurs et les mesures, d√®s qu'un probl√®me se produit - annulez imm√©diatement l'indicateur et r√©solvez le probl√®me. Le plus est que l'ouverture / fermeture du drapeau est tr√®s rapide - c'est juste un changement de valeur dans le panneau d'administration. Apr√®s un certain temps, nous avons supprim√© l'ancienne version du code, ce devrait √™tre le temps minimum pour emp√™cher les modifications dans les deux versions du code. Il est important d'avertir ses coll√®gues de ce refactoring. Nous effectuons un examen via github et utilisons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des propri√©taires de code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors d'une telle refactorisation afin que les modifications ne p√©n√®trent pas dans le code √† l'insu de l'auteur du refactoring.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus r√©cemment, j'ai d√©ploy√© une nouvelle version de l'API Facebook Graph. </font><font style="vertical-align: inherit;">En une seconde, nous faisons plus de 3000 requ√™tes √† l'API et toute erreur nous co√ªte cher. </font><font style="vertical-align: inherit;">Par cons√©quent, j'ai d√©ploy√© le changement sous le drapeau avec un impact minimal - il s'est av√©r√© attraper un bug d√©sagr√©able, tester la nouvelle version et finalement y basculer compl√®tement sans soucis.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499016/index.html">Int√©gration avec ESIA pour .Net: plus simple qu'il n'y para√Æt</a></li>
<li><a href="../fr499018/index.html">6 applications de sport √† domicile</a></li>
<li><a href="../fr499020/index.html">Une √©tude d'un comportement vague</a></li>
<li><a href="../fr499030/index.html">Surveillance des performances de MySQL pour Grafana sur isic en 20 minutes</a></li>
<li><a href="../fr499032/index.html">Comment utiliser Prometheus pour d√©tecter des anomalies dans GitLab</a></li>
<li><a href="../fr499036/index.html">Travail du prestataire: une s√©lection de supports sur les protocoles, les infrastructures informatiques et r√©seau</a></li>
<li><a href="../fr499038/index.html">Mon exp√©rience avec un moniteur vertical</a></li>
<li><a href="../fr499040/index.html">Lire le week-end: une s√©lection de documents sur l'histoire du DNS, de la r√©glementation informatique et du mat√©riel 1cloud.ru</a></li>
<li><a href="../fr499044/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 508 (04/07/2020/13/04/2020)</a></li>
<li><a href="../fr499046/index.html">Neuro√©volution Cybercalmar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>