<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💑 🧔 🔚 PostgreSQL Antipatterns: un conte sur le raffinement itératif d'une recherche par nom, ou «aller-retour d'optimisation» 🧙🏾 👩🏿‍🤝‍👨🏽 ❤️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Des milliers de managers des bureaux de vente à travers le pays enregistrent chaque jour des dizaines de milliers de contacts dans notre système CRM  ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Antipatterns: un conte sur le raffinement itératif d'une recherche par nom, ou «aller-retour d'optimisation»</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/491162/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des milliers de managers des bureaux de vente à travers le pays enregistrent </font><b><font style="vertical-align: inherit;">chaque jour des dizaines de milliers de contacts</font></b><font style="vertical-align: inherit;"> dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre système CRM</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - des faits de communication avec des clients potentiels ou déjà en collaboration avec nous. Et pour ce client, vous devez d'abord trouver, et de préférence très rapidement. Et cela se produit le plus souvent par nom. </font><font style="vertical-align: inherit;">
Par conséquent, il n'est pas surprenant qu'en analysant à nouveau les demandes «lourdes» sur l'une des bases de données les plus chargées - notre propre </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">compte VLSI d'entreprise</font></a><font style="vertical-align: inherit;"> , j'ai trouvé «en haut» une </font><b><font style="vertical-align: inherit;">demande de recherche «rapide» par nom</font></b><font style="vertical-align: inherit;"> des cartes d'entreprise. </font><font style="vertical-align: inherit;">
De plus, une enquête plus approfondie a révélé un exemple intéressant d' </font><i><b><font style="vertical-align: inherit;">optimisation puis de dégradation des performances</font></b></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><b><font style="vertical-align: inherit;"></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> demande dans son affinement ultérieur par plusieurs équipes, chacune agissant uniquement par bonne volonté.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0: que voulait l'utilisateur</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/du/k9/mg/duk9mgzeofw0ka5_lrg8lewch7k.png"></div><font color="#c0c0c0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[KDPV </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Qu'est-ce que l'utilisateur veut généralement dire quand il fait une recherche «rapide» par nom? </font><font style="vertical-align: inherit;">Presque jamais cela ne s'avère être une recherche «honnête» sur une sous-chaîne du type </font></font><code>... LIKE '%%'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- car alors non seulement </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">, mais </font><font style="vertical-align: inherit;">même </font><font style="vertical-align: inherit;">obtenir le résultat </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
L'utilisateur implique au niveau du ménage que vous lui fournirez une </font><b><font style="vertical-align: inherit;">recherche au début d'un mot</font></b><font style="vertical-align: inherit;"> dans le titre et montrerez plus pertinent ce qui </font><b><font style="vertical-align: inherit;">commence par la</font></b><font style="vertical-align: inherit;"> saisie. </font><font style="vertical-align: inherit;">Et faites-le </font><b><font style="vertical-align: inherit;">presque instantanément</font></b><font style="vertical-align: inherit;"> - avec une entrée interlinéaire.</font></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>' <u></u>'</code><font style="vertical-align: inherit;"></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>'  <u></u>'</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1: limiter la tâche</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et plus encore, une personne n'entrera pas spécifiquement de </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sorte que vous devez rechercher chaque préfixe de mot. </font><font style="vertical-align: inherit;">Non, il est beaucoup plus facile pour l'utilisateur de répondre à un indice rapide pour le dernier mot que de «manquer» délibérément les précédents - voyez comment fonctionne n'importe quel moteur de recherche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, </font><font style="vertical-align: inherit;">formuler </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">correctement les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exigences d'un problème représente plus de la moitié de la solution. </font><font style="vertical-align: inherit;">Parfois, une analyse minutieuse du cas d'utilisation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut considérablement affecter le résultat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que fait le développeur abstrait?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.0: moteur de recherche externe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, la recherche est difficile, je ne veux rien faire du tout - donnons-la aux devops! </font><font style="vertical-align: inherit;">Qu'ils nous déploient un moteur de recherche externe par rapport à la base de données: Sphinx, ElasticSearch, ... Une </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
option fonctionnelle, quoique longue, en termes de synchronisation et de rapidité de changement. </font><font style="vertical-align: inherit;">Mais pas dans notre cas, puisque la recherche n'est effectuée pour chaque client que dans le cadre de ses données de compte. </font><font style="vertical-align: inherit;">Et les données ont une variabilité assez élevée - et si le gestionnaire a maintenant inséré la carte </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors au bout de 5 à 10 secondes, il peut déjà se rappeler qu'il a oublié d'indiquer l'e-mail et que vous souhaitez le trouver et le corriger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherchons «directement dans la base de données»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Heureusement, PostgreSQL nous permet de le faire, et pas seulement une option - nous les considérerons.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1: sous-chaîne «honnête»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous accrochons au mot «sous-chaîne». </font><font style="vertical-align: inherit;">Mais exactement pour la recherche d'index par sous-chaîne (et même par des expressions régulières!) Il existe un excellent </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module pg_trgm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Alors seulement, il sera nécessaire de trier correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons de prendre une plaque pour la simplicité du modèle:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> firms(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">text</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous y remplissons 7,8 millions d'enregistrements d'organisations réelles et indexons:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> EXTENSION pg_trgm;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) gin_trgm_ops);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons les 10 premières entrées pour la recherche interligne:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'(^|\s)'</span> || <span class="hljs-string">''</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  " "</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/0m/pk/su/0mpksuspk5xdasdj7mtg5ch4jvw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[jetez un oeil à expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Eh bien, c'est ... </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26 ms, 31 Mo de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> données lues et plus de 1,7 Ko d'enregistrements filtrés - pour 10 personnes. </font><font style="vertical-align: inherit;">Les frais généraux sont trop élevés, est-il possible d'être plus efficace?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2: recherche de texte? </font><font style="vertical-align: inherit;">c'est FTS!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En effet, PostgreSQL fournit un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mécanisme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> très puissant </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pour la recherche en texte intégral</font></a><font style="vertical-align: inherit;"> ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">recherche en texte intégral</font></a><font style="vertical-align: inherit;"> ), y compris la possibilité de préfixer la recherche. </font><font style="vertical-align: inherit;">Excellente option, même les extensions n'ont pas besoin d'être installées! </font><font style="vertical-align: inherit;">Essayons:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)));</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/wd/ln/tq/wdlntqgqo_zvb4sbhcq-wln_jrw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici, la parallélisation de l'exécution des requêtes nous a un peu aidés, réduisant le temps de moitié à </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11 ms</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oui, et nous avons dû lire 1,5 fois moins - seulement </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20Mo</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et ici, plus petit est le mieux, car plus la quantité que nous soustrayons est élevée, plus les chances de manquer de cache sont élevées, et chaque page de données supplémentaire lue sur le disque est un «frein» potentiel pour la demande.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3: toujours comme?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La demande précédente est bonne pour tout le monde, mais seulement si vous la tirez cent mille fois par jour, </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 To de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> données lues </font><font style="vertical-align: inherit;">s'exécuteront </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Au mieux - de la mémoire, mais si vous n'êtes pas chanceux, alors à partir du disque. </font><font style="vertical-align: inherit;">Essayons donc de le réduire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelons que l'utilisateur veut voir d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abord "qui commence par ..."</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">C'est donc sous sa forme pure une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherche de préfixe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec </font></font><code>text_pattern_ops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Et seulement si nous ne sommes "pas assez" jusqu'à 10 enregistrements requis, alors nous devrons les lire en utilisant la recherche FTS:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) text_pattern_ops);</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/_7/e_/jx/_7e_jxpnkc7n97e9rj2rbbk2ukq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Excellentes performances - seulement </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,05 ms et un peu plus de 100 Ko de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lecture! </font><font style="vertical-align: inherit;">Seulement, nous avons oublié de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trier par nom</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin que l'utilisateur ne se perde pas dans les résultats:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ku/d4/r1/kud4r1oipobzbsljhvbavzd2ypa.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Oh, quelque chose n'est plus aussi joli - il semble qu'il y ait un index, mais le tri s'envole ... Il est, bien sûr, beaucoup plus efficace que la version précédente, mais ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4: «modifier avec un fichier»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il existe un index qui vous permet de rechercher par plage, et il est normal d'utiliser le tri - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btree normal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seule une demande devra être «montée manuellement»:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,   - chr(255)</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
   <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/eh/o3/-i/eho3-irvjqbcpgpmmp7fuheb9nm.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Génial - les travaux de tri et la consommation des ressources restent "microscopiques", des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milliers de fois plus efficaces que les FTS "purs"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Il reste à collecter en une seule demande:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,    - chr(255)</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
     <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>) <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>) <span class="hljs-comment">-- " "    </span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    ,     btree-</span>
  , <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note que la deuxième sous-requête n'est exécutée que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la première renvoie moins que le</font></font></b><font style="vertical-align: inherit;"></font><code>LIMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nombre de lignes </font><b><font style="vertical-align: inherit;">attendu par la</font></b><font style="vertical-align: inherit;"> dernière </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déjà écrit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur cette méthode d'optimisation des requêtes </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors oui, nous avons maintenant btree et gin sur la table en même temps, mais statistiquement, il s'est avéré que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moins de 10% des demandes atteignent le deuxième bloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Autrement dit, avec des limitations typiques bien connues pour la tâche, nous avons pu réduire la consommation totale des ressources du serveur de près de mille fois!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 *: supprimer le fichier</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessus, </font></font><code>LIKE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous avons été empêchés d'utiliser le mauvais type. </font><font style="vertical-align: inherit;">Mais il peut être "mis sur le vrai chemin" en spécifiant l'instruction USING:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La valeur par défaut est implicite </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">De plus, vous pouvez spécifier le nom d'un opérateur de tri spécifique dans une phrase </font></font><code>USING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'opérateur de tri doit être un membre inférieur ou supérieur à une certaine famille d'opérateurs B-tree. </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">généralement équivalent </font></font><code>USING &lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>DESC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">généralement équivalent </font></font><code>USING &gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans notre cas, «moins» est </font></font><code>~&lt;~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">USING</span> ~&lt;~
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/s8/6r/4u/s86r4ujfiklgl9rqwn0fl7_g44i.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2: comment "aigrir" les demandes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous laissons notre demande d '«insister» pendant six mois ou un an, et avec surprise, nous la trouvons à nouveau «en haut» avec des indicateurs du «pompage» quotidien total de la mémoire ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tampons partagés par coup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5,5 To</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est-à-dire encore plus qu'il ne l'était à l'origine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non, bien sûr, notre entreprise a grandi et la charge a augmenté, mais pas tant! </font><font style="vertical-align: inherit;">Donc, quelque chose est sale ici - découvrons-le.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1: la naissance de la pagination</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À un moment donné, une autre équipe de développement a voulu permettre de «sauter» dans le registre à partir d'une recherche rapide en indice avec les mêmes résultats, mais étendus. </font><font style="vertical-align: inherit;">Et quel registre sans navigation de page? </font><font style="vertical-align: inherit;">Foutons-le!</font></font><br>
<br>
<pre><code class="sql hljs">( ... LIMIT &lt;N&gt; + 10)<font></font>
UNION ALL<font></font>
( ... LIMIT &lt;N&gt; + 10)<font></font>
LIMIT 10 OFFSET &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, il était possible sans effort pour le développeur d'afficher le registre des résultats de recherche avec le chargement de "type-page". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, en fait, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour chaque page de données suivante, de plus en plus sont lues</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tout le temps précédent, que nous rejetons, plus la «queue» souhaitée) - c'est-à-dire qu'il s'agit d'un contre-motif sans ambiguïté. </font><font style="vertical-align: inherit;">Et il serait plus correct de commencer la recherche à la prochaine itération à partir de la clé stockée dans l'interface, mais à ce sujet - une autre fois.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2: envie d'exotisme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À un moment donné, le développeur a voulu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diversifier la sélection résultante avec des données</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'une autre table, dans ce but, la totalité de la demande précédente a été envoyée au CTE:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
  <span class="hljs-keyword">LIMIT</span> &lt;N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query <span class="hljs-comment">-- -    </span>
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et même ainsi - pas mal, car une sous-requête n'est calculée que pour 10 enregistrements retournés, sinon ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3: DISTINCT insignifiant et impitoyable</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque part dans le processus d'une telle évolution, une </font><b><font style="vertical-align: inherit;">condition a été </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perdue</font></font><code>NOT LIKE</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la 2e sous-requête </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est clair qu'après cela, j'ai </font></font><code>UNION ALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commencé à renvoyer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quelques enregistrements deux fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d'abord trouvé au début de la ligne, puis à nouveau - au début du premier mot de cette ligne. </font><font style="vertical-align: inherit;">Dans la limite, tous les enregistrements de la deuxième sous-requête pourraient coïncider avec les enregistrements de la première. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que fait un développeur au lieu de chercher une raison? .. Pas question!</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doubler la taille des</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> échantillons originaux</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettez DISTINCT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour que nous n'obtenions que des instances uniques de chaque ligne</font></font></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, il est clair que le résultat, au final, est exactement le même, mais la chance de «voler» vers la deuxième sous-requête CTE est devenue beaucoup plus élevée, et sans cela, elle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est clairement lue plus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce n'est pas la chose la plus triste. </font><font style="vertical-align: inherit;">Étant donné que le développeur m'a demandé de sélectionner, </font></font><b><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non pas par spécifique, mais immédiatement par tous les champs de l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enregistrement, le champ sub_query, le résultat de la sous-requête, y est également arrivé automatiquement. </font><font style="vertical-align: inherit;">Maintenant, pour l'exécution </font></font><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la base de données devait exécuter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non pas 10 sous-requêtes, mais toutes &lt;2 * N&gt; + 10</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4: la coopération avant tout!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, les développeurs ont vécu - ils ne se sont pas dérangés, car dans le registre, ils ont été "corrigés" à des valeurs N significatives avec un ralentissement chronique de la réception de chaque "page" suivante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jusqu'à ce que les développeurs d'un autre service viennent à eux et ne souhaitent pas utiliser une méthode aussi pratique </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour la recherche itérative</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est-à-dire que nous prenons un morceau d'un échantillon, filtrons par conditions supplémentaires, dessinons le résultat, puis le morceau suivant (qui dans notre cas est atteint par augmenter N), et ainsi de suite jusqu'à ce que nous remplissions l'écran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, dans le spécimen capturé, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N a atteint des valeurs de près de 17K</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et en seulement 24 heures, au moins 4K de telles requêtes ont été exécutées "dans la chaîne". </font><font style="vertical-align: inherit;">Le dernier d'entre eux a déjà été audacieusement scanné</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Go de mémoire à chaque itération</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...</font></font><br>
<br>
<h2></h2><br>
<img src="https://habrastorage.org/webt/zt/yx/ss/ztyxssr661ga_wndmpmqmvgtrq0.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491138/index.html">Intégration satellite et tour Ansible</a></li>
<li><a href="../fr491146/index.html">UML pour les développeurs</a></li>
<li><a href="../fr491150/index.html">Comment j'ai piraté les escrocs, ou tout simplement l'intérieur des panneaux de phishing</a></li>
<li><a href="../fr491154/index.html">Recherche de cours: comment construire un parcours d'apprentissage</a></li>
<li><a href="../fr491156/index.html">Empathie mesurable: prédire la sympathie pour l'IRM cérébrale</a></li>
<li><a href="../fr491164/index.html">Comment programmeur écrire un diplôme. Guide complet</a></li>
<li><a href="../fr491170/index.html">Comment Amplifer utilise Logux - un outil de communication entre le client et le serveur</a></li>
<li><a href="../fr491172/index.html">Quand un développeur front-end devrait passer de React à Vue, et quand cela compliquera le développement</a></li>
<li><a href="../fr491174/index.html">N'écrivez pas la même chose: comment les composants React réutilisés aideront les développeurs frontaux à créer des applications plus rapidement</a></li>
<li><a href="../fr491176/index.html">5 signes d'un it-produit à vendre</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>