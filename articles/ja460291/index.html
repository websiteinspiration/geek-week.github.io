<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🔧 🍿 🔋 リクエストのバッチ処理の問題とその解決策（パート1） 😡 🤹🏽 #⃣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ほとんどすべての最新のソフトウェア製品は、いくつかのサービスで構成されています。多くの場合、長いサービス間チャネルの応答時間がパフォーマンスの問題の原因になります。この種の問題に対する標準的な解決策は、複数のサービス間要求を1つのパッケージにまとめることです。これはバッチ処理と呼ばれます。
 
 バ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>リクエストのバッチ処理の問題とその解決策（パート1）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/460291/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/0r/ap/sb0raprlu2jwllu3gasyznuom40.jpeg"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどすべての最新のソフトウェア製品は、いくつかのサービスで構成されています。</font><font style="vertical-align: inherit;">多くの場合、長いサービス間チャネルの応答時間がパフォーマンスの問題の原因になります。</font><font style="vertical-align: inherit;">この種の問題に対する標準的な解決策は、複数のサービス間要求を1つのパッケージにまとめることです。これはバッチ処理と呼ばれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッチ処理を使用する場合、パフォーマンスまたはコードの理解性の点でその結果に満足できない場合があります。</font><font style="vertical-align: inherit;">この方法は、あなたが考えるほど、発信者にとって簡単ではありません。</font><font style="vertical-align: inherit;">目的や状況によって、決定は大きく異なる可能性があります。</font><font style="vertical-align: inherit;">特定の例について、いくつかのアプローチの長所と短所を示します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモプロジェクト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
わかりやすくするために、私が現在取り組んでいるアプリケーションのサービスの1つの例を考えてみましょう。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例としてのプラットフォームの選択の説明</font></font></b><div class="spoiler_text">     &nbsp;&nbsp; -   &nbsp;. &nbsp;     &nbsp;     &nbsp;Spring&nbsp;+&nbsp;Kotlin. Kotlin   ( ) Java- &nbsp;C#- ,  ,     &nbsp;,  &nbsp;Java.      Java-, &nbsp;    Kotlin &nbsp;   (  Lombok).   extension-, &nbsp; &nbsp;    Java-  static-,      ,  &nbsp;  .</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文書承認サービスがあります。誰かがドキュメントを作成し、それをディスカッションのために送信します。その間に編集が行われ、最終的にドキュメントは一貫します。調整サービス自体はドキュメントについて何も認識していません。これは、小さな追加機能を持つコーディネーターのチャットであ​​り、ここでは考慮しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、チャットルーム（ドキュメントに対応）があり、それぞれに事前定義された一連の参加者がいます。通常のチャットと同様に、メッセージにはテキストとファイルが含まれており、返信や転送が可能です。</font><font style="vertical-align: inherit;">
ファイルとユーザーのリンクは、他のドメインへのリンクです。それはこのように私たちと住ん：</font><font style="vertical-align: inherit;">
ユーザーデータがKeycloakに格納し、RESTを介して取得されます。ファイルについても同じことが言えます。ファイルとそれらに関するメタ情報は、別のファイルストレージサービスにあります。</font></font><br>
<br>
<code><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="3f7f5f">//&nbsp;nullable&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;persist<br>
</font><font color="3f7f5f">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>Long</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">author</font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">message</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="3f7f5f">//&nbsp;-&nbsp;&nbsp;&nbsp;JPA+&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;&nbsp;&nbsp;<br>
</font><font color="3f7f5f">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">files</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">replyTo</font>:&nbsp;<font color="3e7eff"><b>ChatMessage</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">forwardFrom</font>:&nbsp;<font color="3e7eff"><b>ChatMessage</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null<br>
</b></font><font color="000066">)</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>typealias&nbsp;</b></font><font color="3e7eff"><b>FileReference&nbsp;</b></font><font color="333333">=&nbsp;</font><font color="3e7eff"><b>Long<br>
</b></font><font color="7f0055"><b>typealias&nbsp;</b></font><font color="3e7eff"><b>UserReference&nbsp;</b></font><font color="333333">=&nbsp;</font><font color="3e7eff"><b>Long<br>
</b></font></code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのサービスへのすべての呼び出しは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重い要求</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。つまり、これらのリクエストを転送するためのオーバーヘッドは、サードパーティのサービスによってリクエストが処理されるのにかかる時間よりもはるかに大きくなります。私たちのテストスタンドでは、このようなサービスの一般的な通話時間は100ミリ秒なので、将来はこれらの数値を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なすべての情報を含む最後のNメッセージを受信するために、単純なRESTコントローラーを作成する必要があります。つまり、フロントエンドではメッセージモデルはほとんど同じであり、すべてのデータを送信する必要があると考えています。フロントエンドのモデルの違いは、ファイルとユーザーをリンクするために、ファイルを少し解読した形式で提示する必要があるということです。</font><font style="vertical-align: inherit;">
以下を実装する必要があり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">
。PostfixUIは、フロントエンドのDTOモデル、つまりRESTを通じて提供する必要があるものを意味します。</font></font><br>
<br>
<code><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ReferenceUI</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;url&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">ref</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String<br>
</b></font><font color="000066">)<br>
</font><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>Long</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">author</font>:&nbsp;<font color="3e7eff"><b>ReferenceUI</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">message</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">files</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ReferenceUI</b></font><font color="333333">&gt;,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">replyTo</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br>
</font><font color="395da1">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">forwardFrom</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null<br>
</b></font><font color="000066">)</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="333333">&gt;<br>
</font><font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでチャットIDを渡さないこと、そしてChatMessage / ChatMessageUIモデルでさえ渡さないことは驚くべきことかもしれません。</font><font style="vertical-align: inherit;">これは、例のコードが乱雑にならないように意図的に行ったものです（チャットは分離されているため、1つあると想定できます）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">哲学の隠れ家</font></font></b><div class="spoiler_text">&nbsp;&nbsp; ChatMessageUI, &nbsp;&nbsp; ChatRestApi.getLast    List,   &nbsp;    Set. &nbsp;JDK &nbsp;  ,     &nbsp;  (    &nbsp;) &nbsp;.       List &nbsp; ,    Set (  LinkedHashSet, &nbsp; &nbsp;).</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要な制限：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応答または転送の長いチェーンはないと想定しています。</font><font style="vertical-align: inherit;">つまり、それらはありますが、その長さは3つのメッセージを超えません。</font><font style="vertical-align: inherit;">フロントエンドメッセージチェーン全体を送信する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部サービスからデータを受信するために、そのようなAPIがあります。</font><font style="vertical-align: inherit;">
バッチ処理は、最初は外部サービスで提供され、両方の場合：Set（要素の順序を保持せずに、一意のキーを使用）とListを介して（重複する可能性があります-順序は保持されます） 。</font></font><br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>ChatMessageRepository&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>findLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">&gt;<br>
</font><font color="000066">}<br>
</font><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>FileReference</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String<br>
</b></font><font color="000066">)<br>
</font><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>FileRemoteApi&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadById</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>FileReference</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>FileHeadRemote<br>
</b></font><font color="3e7eff"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByChat</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;<br>
</font><font color="000066">}<br>
</font><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>UserRemote</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String<br>
</b></font><font color="000066">)<br>
</font><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>UserRemoteApi&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUserById</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>UserRemote<br>
</b></font><font color="3e7eff"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;<br>
</font><font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シンプルな実装</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素朴な実装</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RESTコントローラーの最初の素朴な実装は、ほとんどの場合、次のようになります。</font><font style="vertical-align: inherit;">
すべてが非常に明確で、これは大きなプラスです。</font><font style="vertical-align: inherit;">
バッチ処理を使用し、外部サービスからデータをバッチで受け取ります。しかし、パフォーマンスはどうなりますか？</font><font style="vertical-align: inherit;">
メッセージごとに、作成者フィールドのデータを取得するためにUserRemoteApiを1回呼び出し、すべての添付ファイルを受信するためにFileRemoteApiを1回呼び出します。それがすべてのようです。追加の呼び出しを必要としないように、ChatMessageのforwardFromおよびreplyToフィールドが取得されると想定します。ただし、それらをChatMessageUIに変換すると、再帰が発生します。つまり、コールカウントのパフォーマンスが大幅に向上します。前述したように、ネストがあまりなく、チェーンが3つのメッセージに制限されているとしましょう。</font></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatRestController</b></font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi<br>
</b></font><font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="170591">ChatMessageUI</font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id&nbsp;</font>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="170591">IllegalStateException</font><font color="000066">(</font><b>"</b><font color="333333"><b>$</b></font><font color="7f0055"><b>this</b></font><b>&nbsp;must&nbsp;be&nbsp;persisted"</b><font color="000066">)</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">author&nbsp;=&nbsp;</font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUserById</font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">files&nbsp;=&nbsp;</font><font color="566874">files</font><font color="333333">?.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>files&nbsp;</i></font><font color="000066"><b>-&gt;<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="000066"><i>files</i></font><font color="000066">)<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</b></font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;)<br>
</font><font color="000066">}<br>
</font></code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、メッセージごとに2から6の外部サービス呼び出しと、メッセージパケット全体に対する1つのJPA呼び出しが得られます。</font><font style="vertical-align: inherit;">呼び出しの総数は、2 * N + 1から6 * N + 1まで変化します。</font><font style="vertical-align: inherit;">これは実際の単位でいくらですか？</font><font style="vertical-align: inherit;">ページをレンダリングするために20件の投稿が必要だとします。</font><font style="vertical-align: inherit;">それらを取得するには、4秒から10秒が必要です。</font><font style="vertical-align: inherit;">ひどい </font><font style="vertical-align: inherit;">500ミリ秒に会いたいです。</font><font style="vertical-align: inherit;">また、フロントエンドでシームレスなスクロールを作成することを夢見ていたため、このエンドポイントのパフォーマンス要件を2倍にすることができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長所：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードは簡潔で自己文書化されています（サポートの夢）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードはシンプルなので、脚を撃つ機会はほとんどありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッチ処理は、異質に見えず、ロジックに有機的に適合します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロジックの変更は簡単に行われ、ローカルになります。</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
パケットが非常に小さいという事実のため、ひどいパフォーマンス。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは、単純なサービスやプロトタイプでよく見られます。</font><font style="vertical-align: inherit;">変化の速度が重要な場合、システムを複雑にする価値はほとんどありません。</font><font style="vertical-align: inherit;">同時に、非常に単純なサービスの場合、パフォーマンスはひどいため、このアプローチの適用範囲は非常に狭いです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単純な並列処理</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのメッセージの並列処理を開始できます。これにより、メッセージ数に応じて時間の直線的な増加が解消されます。これは外部サービスの大きなピーク負荷につながるため、特に良い方法ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
並列処理の実装は非常に簡単です。</font><font style="vertical-align: inherit;">
メッセージの並列処理を使用すると、理想的には300〜700ミリ秒になります。これは、単純な実装よりもはるかに優れていますが、それでも十分な速度ではありません。</font><font style="vertical-align: inherit;">
このアプローチでは、userRepositoryとfileRepositoryへのリクエストは同期的に実行されるため、あまり効率的ではありません。これを修正するには、呼び出しのロジックを大幅に変更する必要があります。たとえば、CompletionStage（別名CompletableFuture）を通じて：</font></font><br>
<br>
<code><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><font color="170591">map&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="333333">.</font><font color="170591">collect</font><font color="000066">(</font><font color="170591">toList</font><font color="000066">())</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;</font><font color="3e7eff"><b>CompletableFuture</b></font><font color="333333">.</font><font color="170591">supplyAsync&nbsp;</font><font color="000066"><b>{<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUserById</font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">thenCombine</font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="566874">files</font><font color="333333">?.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3e7eff"><b>CompletableFuture</b></font><font color="333333">.</font><font color="170591">supplyAsync&nbsp;</font><font color="000066"><b>{<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font>files<font color="000066">)</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</b></font>?:&nbsp;<font color="3e7eff"><b>CompletableFuture</b></font><font color="333333">.</font><font color="170591">completedFuture</font><font color="000066">(</font><i><b>listOf</b></i><font color="000066">())<br>
</font><font color="000066">&nbsp;&nbsp;)&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>author</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>files&nbsp;</i></font><font color="000066"><b>-&gt;<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="170591">ChatMessageUI</font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id&nbsp;</font>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="170591">IllegalStateException</font><font color="000066">(</font><b>"</b><font color="333333"><b>$</b></font><font color="7f0055"><b>this</b></font><b>&nbsp;must&nbsp;be&nbsp;persisted"</b><font color="000066">)</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">author&nbsp;=&nbsp;</font><font color="000066"><i>author</i></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">files&nbsp;=&nbsp;</font><font color="000066"><i>files</i></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;)<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">get</font><font color="000066">()</font><font color="333333">!!</font></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は単純なマッピングコードが不明確になったことがわかります。これは、結果が使用された場所から外部サービス呼び出しを分離する必要があったためです。これ自体は悪くありません。しかし、呼び出しの組み合わせはあまりエレガントに見えず、典型的な反応型「ヌードル」に似ています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コルーチンを使用すると、すべてがまともに見えます。</font><font style="vertical-align: inherit;">
場所：</font><font style="vertical-align: inherit;">
理論的には、このような並列処理を使用すると、予想に近い200〜400ミリ秒になります。</font><font style="vertical-align: inherit;">
残念ながら、このような適切な並列化は行われず、見返りはかなり残酷です：同時に数人のユーザーが作業しているだけで、一連のリクエストがサービスに落ち、それでも並列処理されないため、悲しい4秒に戻ります。</font></font><br>
<br>
<code><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;</font><i><b>join</b></i><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUserById</font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="566874">files</font><font color="333333">?.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font>files<font color="000066">)<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}&nbsp;}&nbsp;</b></font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;</b></font><font color="000066">)</font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">author</font><font color="333333">,&nbsp;</font><font color="170591">files</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="170591">ChatMessageUI</font><font color="000066">(<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id&nbsp;</font>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="170591">IllegalStateException</font><font color="000066">(</font><b>"</b><font color="333333"><b>$</b></font><font color="7f0055"><b>this</b></font><b>&nbsp;must&nbsp;be&nbsp;persisted"</b><font color="000066">)</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">author&nbsp;=&nbsp;</font><font color="170591">author</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">files&nbsp;=&nbsp;</font><font color="170591">files</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()</font><font color="333333">,<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;)<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="000066"><b>}</b></font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>B</i></font><font color="333333">&gt;&nbsp;</font><font color="170591"><b>join</b></font><font color="000066">(</font><font color="000066"><i>a</i></font>:&nbsp;<font color="000066">()&nbsp;-&gt;&nbsp;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>b</i></font>:&nbsp;<font color="000066">()&nbsp;-&gt;&nbsp;</font><font color="000066"><i>B</i></font><font color="000066">)&nbsp;</font><font color="333333">=<br>
</font><font color="333333">&nbsp;&nbsp;</font><i><b>runBlocking</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>awaitAll</b></i><font color="000066">(</font><i><b>async&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>a</b></font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,&nbsp;</font><i><b>async&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>b</b></font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="000066">)<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{<br>
</b></font><font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>it</i></font><font color="000066">[</font><font color="333333"><b>0</b></font><font color="000066">]&nbsp;</font><font color="7f0055"><b>as&nbsp;</b></font><font color="000066"><i>A&nbsp;</i></font><i><b>to&nbsp;</b></i><font color="000066"><i>it</i></font><font color="000066">[</font><font color="333333"><b>1</b></font><font color="000066">]&nbsp;</font><font color="7f0055"><b>as&nbsp;</b></font><font color="000066"><i>B<br>
</i></font><font color="000066"><i>&nbsp;&nbsp;</i></font><font color="000066"><b>}</b></font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなサービスを使用した場合の私の結果は、20メッセージを処理するために1300〜1700 msです。</font><font style="vertical-align: inherit;">これは最初の実装よりも高速ですが、それでも問題は解決しません。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列クエリの代替使用</font></font></b><div class="spoiler_text">  &nbsp;     ? ,         :<br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>UserRemoteApi&nbsp;</b></font><font color="000066">{<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUserById</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>UserRemote<br>
</b></font><font color="3e7eff"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;&nbsp;=<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="000066"><i>id</i></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><font color="170591">map&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="170591">getUserById</font><font color="000066">(</font><b>it</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">collect</font><font color="000066">(</font><font color="170591">toSet</font><font color="000066">())<br>
</font><font color="000066">&nbsp;&nbsp;</font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;&nbsp;=<br>
</font><font color="333333">&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="000066"><i>id</i></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()<br>
</font><font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><font color="333333">.</font><font color="170591">map&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="170591">getUserById</font><font color="000066">(</font><font color="000066"><i>it</i></font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">collect</font><font color="000066">(</font><font color="170591">toList</font><font color="000066">())<br>
</font><font color="000066">}</font></code><br>
<br>
  ,          .</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長所：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同時メッセージ処理の簡単な実装。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">優れたスケーラビリティ。</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なるサービスのリクエストを並行処理する際に、データの受信と処理を分離する必要性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サードパーティサービスの負荷の増加。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
適用範囲は単純なアプローチとほぼ同じであることがわかります。</font><font style="vertical-align: inherit;">他のサービスの無慈悲な悪用のためにサービスのパフォーマンスを数回向上させたい場合は、並列クエリメソッドを使用することは理にかなっています。</font><font style="vertical-align: inherit;">この例では、生産性は2.5倍に向上しましたが、これでは明らかに十分ではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシング</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部サービスに対してJPAスタイルのキャッシュを実行できます。つまり、受信したオブジェクトをセッション内に格納して、再度受信しないようにします（バッチ処理中も含む）。</font><font style="vertical-align: inherit;">このようなキャッシュを自分で作成したり、@ CacheableでSpringを使用したり、EhCacheのような既製のキャッシュを常に手動で使用したりできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的な問題は、ヒットがある場合にのみキャッシュが有効であるという事実に関連しています。</font><font style="vertical-align: inherit;">私たちの場合、作成者フィールド（たとえば、50％）へのヒットは非常に可能性が高く、ファイルへのヒットはまったくありません。</font><font style="vertical-align: inherit;">このアプローチはいくつかの改善をもたらしますが、パフォーマンスは根本的に変化しません（そして私たちはブレークスルーを必要とします）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッション間（長い）キャッシュには、複雑な無効化ロジックが必要です。</font><font style="vertical-align: inherit;">一般に、セッション間キャッシュでパフォーマンスの問題を解決するようになるのが遅いほど、より良い方法です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長所：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを変更せずにキャッシュを実装します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスが数倍に向上します（場合によっては）。</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不適切に使用すると、パフォーマンスが低下する可能性があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特に長いキャッシュでの大きなメモリオーバーヘッド。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複雑な無効化、ランタイムでの困難な問題につながるエラー。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、キャッシュはデザインの問題を迅速に修正するためにのみ使用されます。</font><font style="vertical-align: inherit;">これは、使用する必要がないという意味ではありません。</font><font style="vertical-align: inherit;">ただし、常に慎重に扱い、結果として得られるパフォーマンスの向上を最初に評価してから、決定を下す必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、キャッシュのパフォーマンスが約25％向上します。</font><font style="vertical-align: inherit;">同時に、キャッシュには多くの欠点があるため、ここでは使用しません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、バッチ処理を使用するサービスの素朴な実装と、それを高速化するいくつかの簡単な方法を見ました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべての方法の主な利点は単純さであり、そこから多くの快適な結果が得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの方法の一般的な問題は、主にパケットサイズが原因で、パフォーマンスが低下することです。</font><font style="vertical-align: inherit;">したがって、これらのソリューションが適さない場合は、より根本的な方法を検討する価値があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策を探すことができる2つの主要な領域があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データの非同期処理（パラダイムシフトが必要なため、この記事は考慮されていません）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同期処理を維持しながらのパックの拡大。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バンドルを拡大すると、外部呼び出しの数が大幅に削減され、同時にコードの同期が維持されます。</font><font style="vertical-align: inherit;">記事の次の部分では、このトピックを取り上げます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460279/index.html">100億契約：国防総省のクラウドを誰が扱うか</a></li>
<li><a href="../ja460281/index.html">UXライターが製品の改善にどのように役立つか</a></li>
<li><a href="../ja460283/index.html">新しい日曜大工のプログラミング言語</a></li>
<li><a href="../ja460285/index.html">PHPを用意します。while、foreach、array_walk、その他の怖い言葉はどうですか</a></li>
<li><a href="../ja460287/index.html">ルネットニュース視覚化</a></li>
<li><a href="../ja460295/index.html">Rustで危険とはどういう意味ですか？</a></li>
<li><a href="../ja460297/index.html">WeakRef-ECMAScript標準に追加するための提案</a></li>
<li><a href="../ja460301/index.html">新世代ハイパワーLEDランプ</a></li>
<li><a href="../ja460305/index.html">AERODISKエンジン：壊滅的。パート2. Metrocluster</a></li>
<li><a href="../ja460307/index.html">Computer Vision Mail.ruチームのモデリング経験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>