<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👆🏼 💆🏿 👩🏻‍🍳 私たちは別のテストから来ました-MSTestでデータベースをテストしています 🔚 👨🏽‍💻 🗺️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="普遍的な原則としてのテスト
 私たちはほぼ四半世紀にわたってミレニアムを祝っていて、テストが私たちの生活に浸透し始めています...初心者の開発者がこの驚くべき手法を彼らの仕事で使用するように説得することは困難です...しかし、開発者について私たちが言えることは、単なる人間であり、テストが基本であるこ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>私たちは別のテストから来ました-MSTestでデータベースをテストしています</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481474/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">普遍的な原則としてのテスト</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはほぼ四半世紀にわたってミレニアムを祝っていて、テストが私たちの生活に浸透し始めています...初心者の開発者がこの驚くべき手法を彼らの仕事で使用するように説得することは困難です...しかし、開発者について私たちが言えることは、単なる人間であり、テストが基本であることを常に理解することは必ずしも可能ではありません。持続可能なシステム！新製品のテストはそれを食べることを意味するものではないことを店員に納得させるのがどれほど難しいか！経験豊富なセキュリティガードでさえ、明らかに昔ながらの方法で作業します。テストに追いつき、選択しようとします。そして、あなたが彼らに、主神ご自身が彼の作品にTDDを使用することを軽視しない場合（大洪水を思い出してください）、彼らが言うように、神ご自身が命じたことを彼らに証明しないでしょう...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
離婚の数が増えています-なぜですか？</font><font style="vertical-align: inherit;">はい、すべて同じです！</font><font style="vertical-align: inherit;">TDD！</font><font style="vertical-align: inherit;">まずテストしてから結婚しましょう！</font><font style="vertical-align: inherit;">いいえ、性的搾取のコマーシャルに熱心な擦り切れたシープスキンコートを着た、だまされやすい小さな男性が、若い妻を本番に送り出しています... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、私たちは別のテスト、最初のテスト、そして他のすべてのものです！</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスターを歩行で認識して......</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、別のコードを最初にデータベースに書き始めたとき、それについて考えました。VisualStudioに組み込まれたテストで直接DALレイヤーの自動テストを行わないのはなぜですか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして私はそれをやった！</font><font style="vertical-align: inherit;">EntityFrameworkに対して透過的で、カバーの下に手をまわしたり、偽のオブジェクトを使用した詐欺行為はありません。</font><font style="vertical-align: inherit;">気にする人-VSを明らかにし、テスターのように服を着て行ってください！</font><font style="vertical-align: inherit;">（私はいつもテスターのように服を着ます）</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスター服</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/tg/pv/kw/tgpvkwgvjzb4zf7tt-navdbcazi.jpeg" alt="画像"><br>
</div></div><a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みんなに嘘をついて、これはテストです！</font></font></h4><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">人生のケース：</font></font></b><div class="spoiler_text">  ,     :<br>
<br>
<pre><code class="plaintext hljs">ObjectLink link = this.ObjectLinks.ToList().Where(x =&gt; x.SpotCode.ToLowerInvariant() == code.ToLowerInvariant()).SingleOrDefault();</code></pre><br>
     ,     —      ,   .     ,     …     … <br>
<br>
   ,      ,            ,    …     ,    ,   ,   ,    Microsoft       core 3.0.  ,   ,     —  ,  ?      …    !    !  ,      —   ?<br>
<br>
   :      LINQ ToLowerInvariant…          …      ,       .      ,     ,    …       deploy.<br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバイスと材料：</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft VisualStudio 2019 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
asp.net Core 3.1（他のフレームワークのインストールプロジェクトメニューから配信できる場合は、スタジオにインストールしました）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL Server Express（スタジオに</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
含まれ</font><font style="vertical-align: inherit;">ています）</font><font style="vertical-align: inherit;">Git Extension to visual studio（included）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常はユニット内テスト、各テストは分離する必要があり、それらの間の状態は保存されません。</font><font style="vertical-align: inherit;">したがって、実際には統合テストを取得しますが、これにはMSTestを使用します。</font><font style="vertical-align: inherit;">彼らが私たちを警察に連れて行ってくれないことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの版で、データベースをテストするためのモックオブジェクトの使用に出会いました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一見すると、テーブル間の複雑な相互作用が始まるまで、このアイデアは優れています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、モックを設定すること自体をテストするだけではありません。しかし、実際には-Control + C-Control + V！私たちはすべて、EF、データベース、DataAnnotations、またはモック層のFluentAPI複製にすでに登録されているデータベース制約です。そしてコピーは一種のパターンを壊すようなものです...アイ、市民、壊す...良くない！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、モックの設定が複雑で、たとえば、そこでの制限を誤った場合、モックテストはパスしますが、実際のベースでエラーが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはすべて私に興味があり、私は新しいアプローチを試すことにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイデアは、いつものように、TRIZから生まれました。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理想的なシステムは存在しないものですが、その機能は実行され</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。そして、テストではデータベース自体を使用する必要があると思いました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それは私にとってはうまくいった。</font><font style="vertical-align: inherit;">これを共有したいのですが、誰かが助けてくれるといいのですが。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モックの短所：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストする多くのプリセット</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストが汚れる、たくさんの余分なコード</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行をテストするのは難しい</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視下でのみ正常に動作し、実際には未知のエラーを生成する可能性があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベースの構造を変更するときは、常にモックに登り、そこでもすべてを変更する必要があります</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のベースでのテストの利点：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムは戦闘サーバーとまったく同じように動作します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストは単純です。データベースにデータを入力するのと同じ方法で、次々にテストを構築できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストに番号を付けることで、データベースのクリーン度を調整できます（MSTestではアルファベット順に実行されます）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストが実行されている時間を確認できます（実際のサーバーでは異なりますが、少なくとも順序は表示されます-10倍、2倍。プログラムの動作を効率的に評価できます）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストアドプロシージャをテストできる</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチにはいくつかの困難があり、数日間掘り進んでいますが、問題は正常に解決します。私の石のバックエンドがあなたと一緒にいるかもしれません！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行こう！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいASP.Net Core 3.1 Webアプリケーション（Model-View-Controller）プロジェクトを作成し、認証を個別ユーザーアカウント（アプリ内にユーザーアカウント</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n1/oq/5c/n1oq5cv0fxxqnuu0sdgdwda7xem.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を保存</font><font style="vertical-align: inherit;">）に変更して、[作成]をクリックします。</font><font style="vertical-align: inherit;">これから、プロジェクトのスナップショットをgitに保存し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ダウンロードして、各ブランチをアップロードして実験して</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">くださいgithub.com/3263927/Habr_1 </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snapshot_0_ProjectCreated</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリについて</font></font></b><div class="spoiler_text">   ,    —     ,    Visual Studio,   ,      VS.       ,      commit     .     ,  .    github .   -      …           Dropbox     ,           Google Drive  .     SD 120 ,    ,  …          !<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、リポジトリを作成したので、新しいブランチを作成するための作業を計画する必要があります。</font><font style="vertical-align: inherit;">将来的には、Snapshotキーワードを使用して、問題が発生した場合にリカバリポイントを見つけることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VisualStudioから直接リポジトリに新しいブランチを作成し、略して「シスターオブタレント」と呼びます（冗談、Snap_1_DataBases）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目標：機能する接続とベースを作成します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは拠点を作り始めています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのテスト（ローカルマシン上）、もう1つの実稼働環境（リモートサーバー上で動作中）、および別のローカルで動作中（デバッグ構成でサイトの状態を確認するため）の3つのベースがあることをすぐに言っておく必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロジックはこれです：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルマシンでサイトを実行し、その動作を確認したい場合、Habr1_Localが機能します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを本番環境に配置すると、Habr1_Productionが機能します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストインフラストラクチャがテストを開始すると、Habr1_Testベースを見つけて実行する必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、1つの矛盾があります。構成は、デバッグとリリースの2つだけです。</font><font style="vertical-align: inherit;">これはまだ問題ですが、解決されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、最低限機能するプログラムを作成します。まず、少なくとも1つのデータベースが機能するかどうかを確認します。</font><font style="vertical-align: inherit;">Visual Studio自体の手で作成しましょう！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
appsettings.jsonファイルを開きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような行があり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="json hljs"><span class="hljs-string">"ConnectionStrings"</span>: {
    <span class="hljs-attr">"DefaultConnection"</span>: <span class="hljs-string">"Server=(localdb)\\mssqllocaldb;Database=aspnet-WebApp-[- ,   ];Trusted_Connection=True;MultipleActiveResultSets=true"</span>
  },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、接続文字列、サーバー名、データベース名の正しい名前を入力する必要があります。他の接続が本番環境で使用されていることをすぐに言わなければなりませんが、今は必要ありません。私たちのタスクは、2つのデータベースを作成することです（ローカルとテスト、本番環境は単なる例です。リリース構成で使用します。その後、稼働中のリモートデータベースで置き換えることができます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜこれが必要なのですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visual Studioの構成では、Visual Studioパネルの構成を切り替えることで一部の設定を変更できます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/8k/nr/qa8knrxqxt8komoewxxf-b-s2qs.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。一般に、開発環境ではDEBUG定数を宣言するだけで、コードからどこからでも読み取り、現在どの構成がアクティブであるかを理解できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、コロケーションホスティングでは、リモートデバッガーが常に使用できるとは限りません。 asp.netサーバーをローカルで実行し、データベースをリモートに接続すると、運用中に発生したすべてのエラーを確認できます。これはリリース構成で行うことであり、デバッグ構成はローカルデータベースで機能します。また、セキュリティ上の理由から、テスト構成は行いません。誤ってデータを消去したり、構成の切り替えを忘れたりしないようにするため</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、接続文字列の変更を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバー名-タブビューで確認できます-&gt; SQLサーバーオブジェクトエクスプローラー</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mk/-1/tc/mk-1tcplz6dtcpzupszdzpesh84.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（コンピューターの名前を慎重に消去します。それ以外の場合は、IPで計算して何かを入力します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから私はこれを持っています（localdb）\ ProjectsV13。インストール中にSQLを呼び出した理由がわかりません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、接続文字列が </font></font><br>
<br>
<pre><code class="json hljs"><span class="hljs-string">"DefaultConnection"</span>: <span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;
Trusted_Connection=True;MultipleActiveResultSets=true"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
異なる場合がありますが、ProjectV13のみです。</font><font style="vertical-align: inherit;">残りはそのままにしておきます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DefaultConnectionをHabr1_Local </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に</font><font style="vertical-align: inherit;">変更</font><font style="vertical-align: inherit;">します。次のようになります。</font></font><br>
<br>
<pre><code class="json hljs"> <span class="hljs-string">"ConnectionStrings"</span>: {
        <span class="hljs-attr">"Habr1_Local"</span>: <span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span>
    },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、Startup.csファイルに移動して、DefaultConnectionをHabr1_Localに置き換える必要があります。</font></font><br>
<br>
<pre><code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;<font></font>
	options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string">"DefaultConnection"</span>)));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
になる </font></font><br>
<br>
<pre><code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;<font></font>
	options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string">"Habr1_Local"</span>)));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバッグ構成でプロジェクトを開始し、ブラウザーが開き、最初のページが表示され、[ログイン]ボタンをクリックし、そこに有効な電子メールを入力し（レターは送信せず、形式を検証するだけです）、[ログイン]をクリックすると、この画面が表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p3/u3/r4/p3u3r4gkdanievaornpxfxwoous.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[移行の適用</font><font style="vertical-align: inherit;">]をクリックします</font><font style="vertical-align: inherit;">。移行が成功したことを示す青いボタンの右側に確認が表示され、ページを更新する必要があるときに待機します。更新し、データの再送信を確認して、「ログインに失敗しました」</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fc/sw/pc/fcswpc-tqd0gyuhz70cyefi9uls.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
という画面が表示されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そのような画面が表示されれば、すべてOKです。データベースエラーは発生しませんでしたが、そのようなユーザーを見つけることができませんでした。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行について少し：</font></font></b><div class="spoiler_text">           ,    .<br>
         -  —       ,       ,    /      .<br>
<br>
      -,           ,  production      ,     —    migration.      .  ,            .            .<br>
<br>
 ,          ,        . Migrations  ,      Git —         C# .        —    ,      ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの可用性を確認します-Visual Studioがデータベースを作成したはずです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/op/6i/c_/op6ic_e4cdoarqotsmz441fkmkc.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースがない場合は、問題が発生したか、SQLサーバーがインストールされていないか、または一般的に、プログラマーが医師であったかどうかについてのジョークのように、次のようになります。医者、私の足が痛い...-ええと、私は知りません、私は同じ足を持っているので、何も痛くないです！」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場所で、さらに2つの接続文字列を作成します。appsettings.jsonはこの形式を取ります。</font></font><br>
<br>
<pre><code class="json hljs"><span class="hljs-string">"ConnectionStrings"</span>: {
        <span class="hljs-attr">"Habr1_Local"</span>: <span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span>,
        <span class="hljs-attr">"Habr1_Test"</span>: <span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Test;Trusted_Connection=True;MultipleActiveResultSets=true"</span>,
        <span class="hljs-attr">"Habr1_Production"</span>: <span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Production;Trusted_Connection=True;MultipleActiveResultSets=true"</span><font></font>
    },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コミットを行い、次のスナップショットをリポジトリに入れます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snap_1_DataBases</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
新しいブランチ</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Snap_2_Configurations </font><b><font style="vertical-align: inherit;">ゴール：動作する構成を作成する構成を</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
切り替えると、プログラムのどこからでも現在の構成を読み取ることができます（実際にはどこからでも、実際には表示されません。特別な機能ですが、これはこのプロジェクトでは重要ではありません）：</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><font></font>
			 DEBUG<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><font></font>
			 RELEASE ( DEBUG   )<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Startup.csファイルを開き、ConfigureServicesメソッドを次のように変換します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
{<font></font>
<font></font>
	String ConnStr = <span class="hljs-string">""</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span>
	ConnStr = <span class="hljs-string">"Habr1_Local"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
	ConnStr = <span class="hljs-string">"Habr1_Production"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
	services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;<font></font>
		options.UseSqlServer(<font></font>
			Configuration.GetConnectionString(ConnStr)));<font></font>
	services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = <span class="hljs-literal">true</span>)<font></font>
		.AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();<font></font>
	services.AddControllersWithViews();<font></font>
	services.AddRazorPages();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、Habr1_Localを変数に置き換えました。構成に応じて、接続文字列はHabr1_LocalまたはHabr1_Productionになり</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。プロジェクトを開始し、構成に応じてデータベースがどのように作成されるかを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パネルでDEBUGを選択し、開始、ログイン、移行を適用し、ベースを確認します作成済み（Habr1_Local）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクト</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">停止し、リリース構成を選択し、開始、ログイン、移行の適用、データベースが作成されたことの確認-2つのベースがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できた！</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snap_3_HabrDB </font></font></b><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目的：別のデータベースプロジェクトを作成し、別のプロジェクトで使用できるようにする</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
なぜ別のプロジェクトなのか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
個々のプロジェクトにはいくつかの利点があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のプロジェクトで使用できます。</font></font></li>
<li>       ,      </li>
<li>   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ソリューションの右ボタン-追加-&gt;新しいソリューションフォルダーにDBという名前を付けます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、作成されたフォルダーの右側に-新しいプロジェクトを追加-&gt; .net標準、HabrDBという名前を付けます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何らかの理由で、私にとってはそれは.net標準2.0として作成されていますが、2.1に変更する必要があります</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（作成時に物理パスを提供し、DBフォルダー内に物理的に配置します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私にはこれのように見えます：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g4/kb/wu/g4kbwu45mu92my9ucaanuldtuhs.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、プロジェクトにいくつかのApplicationDBContextがあり、私たちは独自のものをもう1つ作成しましたか？それらは互いに衝突しますか？今、私たちは彼らと友達になります。同じデータベースに2つの異なるコンテキストがあり、Entity Frameworkを介して交差しません。それらに異なるスキーマ名を付けます。1つはデフォルトでdboのままで、もう1つは「habr」です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなコンテキストをコンポジションのルートを介して接続すると、他のプロジェクトでほぼ透過的にリサイクルできます。 （たとえば、倉庫のコンテキストと従業員のコンテキスト）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、もう1つのアーキテクチャ上のポイントとして、プロパティの一部をユーザーに追加する必要がある場合があります。これは、記事のトピックに直接適用されませんが、方法を知るためだけに行います。さらに、それぞれ独立してコンテキストを作成および削除できるようになります。セキュリティテーブルを個人データで分離し、データベースレベルで暗号化することをお勧めします（このプロジェクトではこれを行いませんが、法律などにより、通常これが必要になる場合があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい。この方法でテストする方が簡単です。一度にすべてのテーブルを作成することはできません。特定のコンテキストをテストするために必要なテーブルのみを作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいプロジェクトのスナップショットを作成しています-ステージ4。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このステージの目的は次のとおりです。</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準ユーザーを上級ユーザーに変更する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Srartup.csファイルでユーザーを変更する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoginPartialとViewImportsでユーザーを変更する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい形式でデータベースを自動的に作成する新しい移行を作成する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、ApplicationDBContextクラスをWebAppプロジェクトからHabrDBに転送します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポータブルではなく、コピーするだけです。 WebAppから削除し、HabrDBプロジェクトから開き、名前空間をHabrDBに変更すると、多くのエラーが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、このプロジェクトでは必要なパッケージはありません。今すぐお届けします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nugetを使用して、HabrDBプロジェクトでMicrosoft.AspNetCore.Identity.EntityFrameworkCoreをインストールする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/-d/q4/wj-dq4ldm5nx32fs9hvzdiya5ys.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電球をクリックすると、最新の</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワー</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョンの</font><font style="vertical-align: inherit;">セットが提供され</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的なSecurityDBContextファイル（名前も変更する必要があります）の形式は次のとおりです。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Identity.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SecurityDBContext</span> : <span class="hljs-title">IdentityDbContext</span><font></font>
	{<font></font>
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SecurityDBContext</span>(<span class="hljs-params">DbContextOptions&lt;SecurityDBContext&gt; options</span>)
			: <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
		{<font></font>
		}<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリの後、</font><font style="vertical-align: inherit;">エラーの</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あるファイル</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><s><font style="vertical-align: inherit;">慎重に処理します</font></s><font style="vertical-align: inherit;">。これは正しく行われました。ApplicationDBContextを削除して、SecurityDBContextに置き換えました。次に、プロジェクト全体のApplicationDBContextへのすべてのリンクをSecurityDBContextに置き換える必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、私のプロジェクトでWebAppからの参照に黄色の三角形が表示されました。これは、一部のリンクが正しく機能していないことを示しています。プロジェクトをクリーンアップし（ビルド-&gt;クリーンソリューション）、プロジェクトを閉じ、プロジェクトフォルダーからすべてのDebug、Release、Obj、Binディレクトリを削除しました。その後、プロジェクトを再度開いて、しばらくの間、インターネットで必要なリンクを検索し、それらをロードしました。消えた-その後、すべてが大丈夫です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、WebAppプロジェクトからDataフォルダーを削除し、SQL Serverオブジェクトエクスプローラーウィンドウでデータベース（Habr1_LocalおよびHabr1_Production）を削除して、プロジェクトを実行します。</font><font style="vertical-align: inherit;">ログインを試みますが、移行を適用する提案の代わりにエラーが発生します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z_/ex/ca/z_excar1pqk18n8pdmyvf3eobog.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうです、すべての移行があったDataフォルダーを削除しましたが、フレームワークは何をすべきかわかりません。</font><font style="vertical-align: inherit;">でもかっこよかった！？</font><font style="vertical-align: inherit;">何のために？！</font><font style="vertical-align: inherit;">次に、ユーザークラスを展開します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいファイルをHabrDBプロジェクトに追加します。ApplicationUser.csIdentityUser </font><font style="vertical-align: inherit;">
から継承し</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。</font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Identity;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Text;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationUser</span>:<span class="hljs-title">IdentityUser</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> String NickName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-keyword">public</span> DateTime BirthDate { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-keyword">public</span> String PassportNumber { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスヘッダーのSecurityDBContextファイルに以下を追加します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SecurityDBContext</span> : <span class="hljs-title">IdentityDbContext</span>&lt;ApplicationUser&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、EntityFrameworkがデータベースを作成するときに、標準モデルではなくAppllicationUserクラスの高度なユーザーモデルを使用する必要があることを認識するために必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Startup.csファイルのConfigureServicesメソッドの形式は次のとおりです。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
{<font></font>
<font></font>
	String ConnStr = <span class="hljs-string">""</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span>
	ConnStr = <span class="hljs-string">"Habr1_Local"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
	ConnStr = <span class="hljs-string">"Habr1_Production"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
	services.AddDbContext&lt;SecurityDBContext&gt;(options =&gt;<font></font>
		options.UseSqlServer(<font></font>
			Configuration.GetConnectionString(ConnStr)));<font></font>
	services.AddDefaultIdentity&lt;ApplicationUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = <span class="hljs-literal">true</span>)<font></font>
		.AddEntityFrameworkStores&lt;SecurityDBContext&gt;();<font></font>
	services.AddControllersWithViews();<font></font>
	services.AddRazorPages();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（IdentityUserをApplicationUserに置き換えます）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
_ViewImports.cshtmlファイルに次の行を追加します</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HabrDB </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、すべての型がベース付きのプロジェクトを参照できるようになり、型の最初に書き込む必要が</font><font style="vertical-align: inherit;">なくなり</font><font style="vertical-align: inherit;">ます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HabrDB。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
_LoginPartial.cshtmlファイルで、すべてのIdentityUserをApplicationUserに変更します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microsoft.AspNetCore.Identity</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注入する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SignInManager SignInManager</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注入する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserManager UserManager </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
念のため、プロジェクトをコンパイルして、エラーがなく、どこでも何かを置き換えるのを忘れていないことを確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に移行を行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージマネージャーコンソールを開き、DB / HabrDBプロジェクトを選択して書き込む必要があります</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">add</span>-migration initial</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが私が得たものです</font></font><br>
<br>
<img src="https://habrastorage.org/webt/95/zv/aj/95zvaj1nj3d42hnzq2rk_bvncvo.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。HabrDBプロジェクトでは、Migrationsフォルダーが表示され、その中のファイルを使用してデータベースを自動的に作成できますが、NickName、BirthDate、PassportNumberという追加フィールドが追加されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それがどのように機能するか試してみましょう- </font><b><font style="vertical-align: inherit;">始めて</font></b><font style="vertical-align: inherit;">ログインしようとします（登録しないで、そこに複雑なパスワードを入力する必要があります）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/01/ib/0u/01ib0ufzxz_bds3n2scb5pqgyoi.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行するように求められ、同意しました-これが私たちのベースです：</font><b><font style="vertical-align: inherit;">スナップショットは</font></b></font><br>
<br>
<img src="https://habrastorage.org/webt/qg/af/js/qgafjs_fgtlnj39nlru_bxb9a2a.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
このステップの</font><font style="vertical-align: inherit;">準備</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できてい</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます</font><b><font style="vertical-align: inherit;">：Snap_4_Security</font></b><font style="vertical-align: inherit;">準備完了</font><font style="vertical-align: inherit;">5番目のショットを作成します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目的：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト接続文字列を機能させる </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベーステストプロジェクトを作成する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストプロジェクトにベースを作成させ、何か有用なものをテストさせる</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBパパを右クリックし、新しいプロジェクト-MSTest .netコアを作成します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトの唯一のファイルの名前をDBTestおよびponderに変更します... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、それは困難になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストデータベースとの通信が保証されているコンテキストを作成する方法、つまり、別のプロジェクト（WebApp）からだけでなく、リリース/デバッグ構成と接続するConnectionStringをどのように使用できますか？新しい構成を作成できます、テスト例えば？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいえ、これはデータ損失の可能性があります-どういうわけか、テスト構成から切り替えるのを忘れて、[すべてのテストを実行]ボタンをクリックしました-そして、データベース全体の削除...いいえ、このオプションは機能しません... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、テストコンテキストを明確に作成します！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HabrDBContextファイルを開き、その内容を次のように変更します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.IO;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.Configuration;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HabrDBContext</span>:<span class="hljs-title">DbContext</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> String ConnectionString = <span class="hljs-string">""</span>;
		<span class="hljs-keyword">public</span> IConfigurationRoot Configuration { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-function"><span class="hljs-keyword">public</span> HabrDBContext <span class="hljs-title">CreateTestContext</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			DirectoryInfo info = <span class="hljs-keyword">new</span> DirectoryInfo(Directory.GetCurrentDirectory());<font></font>
			DirectoryInfo temp = info.Parent.Parent.Parent.Parent;<font></font>
			String CurDir = Path.Combine(temp.ToString(), <span class="hljs-string">"WebApp"</span>);<font></font>
			String ConnStr = <span class="hljs-string">"Habr1_Test"</span>;<font></font>
			Configuration = <span class="hljs-keyword">new</span> ConfigurationBuilder().SetBasePath(CurDir).AddJsonFile(<span class="hljs-string">"appsettings.json"</span>).Build();
			<span class="hljs-keyword">var</span> builder = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;HabrDBContext&gt;();
			<span class="hljs-keyword">var</span> connectionString = Configuration.GetConnectionString(ConnStr);<font></font>
			builder.UseSqlServer(connectionString);<font></font>
			ConnectionString = connectionString;<font></font>
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<font></font>
		}<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nugetを使用して、次のライブラリをデータベースに追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">Microsoft.AspNetCore.Identity.EntityFrameworkCore<font></font>
Microsoft.EntityFrameworkCore<font></font>
Microsoft.EntityFrameworkCore.SqlServer<font></font>
Microsoft.Extensions.Configuration.FileExtensions<font></font>
Microsoft.Extensions.Configuration.Json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CreateTestContextメソッドは、Habr1_Testという名前の接続文字列のみを強制することができます。</font><font style="vertical-align: inherit;">別のプロジェクトで使用する必要があります。</font><font style="vertical-align: inherit;">1つの設定しか必要ないため、参照を介してプロジェクトを接続しないようにするために、ビルダーに、指定されたconnectionStringに基づいてオプションを作成するように依頼します。このため、テストプロジェクトがコンパイルされるディレクトリからプロジェクトルートディレクトリまでのディレクトリチェーンを取得し、パーツからWebAppプロジェクトへのパスを収集します。設定が保存されている設定ファイルappsettings.jsonを追加して、設定にコンパイルしてください。</font><font style="vertical-align: inherit;">この構成からさらに、connectionStringを取得して記憶します（これは後で必要になります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大規模なプロジェクトでは、キャッシングで設定データにアクセスするために、文字列、DLL、またはオブジェクトを含む別のプロジェクトに設定を移動できます。現時点では、より単純なアプローチで十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何故ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト接続文字列をテストプロジェクトに直接配置し、それを使用してデータベースを初期化できます。データベースにテスト接続文字列を作成できます。ただし、不愉快なことが1つあります。すべての接続文字列が別の場所に格納されます。そして、私は自分の頭が穴でいっぱいであることを知っています。たとえば、データベースまたはサーバーの名前が変更されたときに何かを変更するのを忘れることがあるので、すべての接続文字列を1か所に収めるため、これを行います。これで、構成ファイルappsettings.jsonを変更することで、すべての接続を管理できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ベースを使用して何かを作成してみましょう。たとえば、何かを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HabrDBプロジェクトでは、DBClassesフォルダーを作成しました。そこにはデータベーステーブルクラスしかありません。</font><font style="vertical-align: inherit;">最初にコードを処理します。自分が何をしているのか想像できれば、通常はそれがより便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようなテーブルを作成します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.ComponentModel.DataAnnotations;
<span class="hljs-keyword">using</span> System.ComponentModel.DataAnnotations.Schema;
<span class="hljs-keyword">using</span> System.Text;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB.DBClasses</span><font></font>
{<font></font>
	[<span class="hljs-meta">Table(<span class="hljs-meta-string">"Phones"</span>, Schema =<span class="hljs-meta-string">"Habr"</span>)</span>]
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Phone</span><font></font>
	{<font></font>
		[<span class="hljs-meta">Key</span>]
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-keyword">public</span> String Model { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-keyword">public</span> DateTime DayZero { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
美しさのために、私のクラスを「telephone」と呼び、データベース内のテーブルを複数形-「telephones」と呼びます。</font><font style="vertical-align: inherit;">したがって、私はTable属性で、テーブルの名前とデータベース内の名前空間を示します（SQLではこれをスキーマと呼びます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、美学の別の問題があります。ここでは、データベースクラスにさまざまなインフラストラクチャメソッドの束があり、次に別の異なるテーブルとこれらすべてが1つのヒープにあります-部分クラスを作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のように、HabrDBContext.csファイルの単語クラスの後に部分単語を追加します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HabrDBContext</span>:<span class="hljs-title">DbContext</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HabrDBContext.csファイルのコピーを作成します。ファイル上でCTRL + C-CTRL + Vを実行し、コピーを作成して、ソースファイルの名前をHabrDBContext_Infrastructure.csに変更し、新しいファイルをHabrDBContext_Data.csに変更します。新しいファイルに次の</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ように書き込みます。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB.DBClasses;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HabrDBContext</span>:<span class="hljs-title">DbContext</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> DbSet&lt;Phone&gt; Phones { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すばらしいですね。データを1つの場所で処理し、インフラストラクチャを別の場所で処理します。</font><font style="vertical-align: inherit;">ファイルは異なりますが、クラスは同じです-プロジェクトをビルドするときに、環境自体がいくつかを1つにまとめます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、それを試してみてください！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
唯一のテストクラスのコードを次のコードに置き換えます。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB;
<span class="hljs-keyword">using</span> HabrDB.DBClasses;
<span class="hljs-keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DBTest</span><font></font>
{<font></font>
	[<span class="hljs-meta">TestClass</span>]
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DBTest</span><font></font>
	{<font></font>
		[<span class="hljs-meta">TestMethod</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestMethod1</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			String PhoneName = <span class="hljs-string">"Nokia"</span>;<font></font>
			DateTime now = DateTime.Now;<font></font>
<font></font>
			HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
			db.Database.EnsureCreated();<font></font>
<font></font>
			List&lt;Phone&gt; Phones = db.Phones.ToList();<font></font>
			Assert.AreEqual(<span class="hljs-number">0</span>, Phones.Count);<font></font>
<font></font>
			Phone ph = <span class="hljs-keyword">new</span> Phone();<font></font>
			ph.Model = PhoneName;<font></font>
			ph.DayZero = now;<font></font>
<font></font>
			db.Phones.Add(ph);<font></font>
			db.SaveChanges();<font></font>
<font></font>
			Phone ph1 = db.Phones.Single();<font></font>
			Assert.AreEqual(PhoneName, ph1.Model);<font></font>
			Assert.AreEqual(now, ph1.DayZero);<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[テストエクスプローラー]タブ（または[テスト]-&gt; [すべてのテストを実行]）の再生ボタンをクリックすると、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qe/68/9wqe686vdpg6jet-epu30oakdou.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーが発生します。</font><font style="vertical-align: inherit;">ここにそれらがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは彼らが私たちに書いたものを読みます：</font></font><br>
<br>
<pre><code class="plaintext hljs">Message: <font></font>
    Test method DBTest.DBTest.TestMethod1 threw exception: <font></font>
    System.InvalidOperationException: No database provider has been configured for this DbContext. A provider can be configured by overriding the DbContext.OnConfiguring method or by using AddDbContext on the application service provider. If AddDbContext is used, then also ensure that your DbContext type accepts a DbContextOptions&lt;TContext&gt; object in its constructor and passes it to the base constructor for DbContext.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
英語でのがらくたのような… </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、私たちはランダムに行動します！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような関数をHabrDBContext_Infrastructure.csファイルにファイルすることは可能ですか？</font><font style="vertical-align: inherit;">試してみよう！</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
{<font></font>
	String ConnStr = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">if</span> (Configuration == <span class="hljs-literal">null</span>)<font></font>
	{<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><font></font>
<font></font>
		ConnStr = <span class="hljs-string">"Habr1_Local"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
		ConnStr= <span class="hljs-string">"Habr1_Production"</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
		Configuration = <span class="hljs-keyword">new</span> ConfigurationBuilder()<font></font>
			.SetBasePath(Directory.GetCurrentDirectory())<font></font>
			.AddJsonFile(<span class="hljs-string">"appsettings.json"</span>).Build();<font></font>
		ConnectionString = Configuration.GetConnectionString(ConnStr);<font></font>
	}<font></font>
<font></font>
	optionsBuilder.UseSqlServer(ConnectionString);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
始めました... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラッキーでした!!! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいベースが作成され、その中に-テーブルが！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/an/cv/1a/ancv1ahppxwymetpwayqqwdtlzg.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なんでそうなの？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OnConfiguring関数とCreateTestContext関数にいくつかのブレークポイントを設定すると、CreateTestContextメソッドが最初に呼び出され、接続文字列がConnectionStringオブジェクトに保存されます。すべてが大丈夫だと思います。しかし、誰かがOnConfiguringを呼び出そうとします...それは誰ですか？呼び出しスタックを見てみましょう-はい、これはテストのdb.Database.EnsureCreated（）行です！実際のところ、そのようなベースはまだありません。EnsureCreatedメソッドがベースを作成します。ただし、このメソッドはパラメーターを取りません。そのため、コンストラクターの呼び出しとEnsureCreatedの呼び出し間でコンテキストを何らかの方法で保持する必要があります。さらに、プロジェクト自体からこのコンテキストを適用すると（テストではなく、たとえばWebサイトで）、あらゆる種類のミドルウェア、DI、およびその他のキャッチーなメカニズムもそれを呼び出そうとするため、事前にすべてを予測します-データベースを呼び出す人は誰でも、OnConfiguringを呼び出したい場合-そのような機会があります。私たちはすべてを提供しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度テストを実行します-そして... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、間違いですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースはすでに存在し、データは...何が問題なのですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベースは永続的なオブジェクトであり、プロジェクトを再開しても残ります...そして今、本当に難しい部分が始まります。これらのテーブルをすべて削除するにはどうすればよいですか？データを削除し、すべてのインデックスをリセットする方法は？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snap_5_ContextCraftingの準備ができました。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最初に、</font><b><font style="vertical-align: inherit;">DAL-</font></b><font style="vertical-align: inherit;">データアクセスレイヤーを記述します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HabrDBContext_Data.csファイルのコピーを作成し、それをHabrDBContext_DAL.cs </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
と</font><font style="vertical-align: inherit;">呼び</font><font style="vertical-align: inherit;">、それに書き込みます。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB.DBClasses;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Threading.Tasks;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">HabrDB</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HabrDBContext</span>:<span class="hljs-title">DbContext</span><font></font>
	{<font></font>
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">AddPhone</span>(<span class="hljs-params">Phone ph</span>)</span><font></font>
		{<font></font>
			<span class="hljs-keyword">this</span>.Phones.Add(ph);
			<span class="hljs-keyword">int</span> res = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.SaveChangesAsync();
			<span class="hljs-keyword">return</span> res;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Phone&gt;&gt; GetAllPhones()<font></font>
		{<font></font>
			List&lt;Phone&gt; phones = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Phones.ToListAsync();
			<span class="hljs-keyword">return</span> phones;<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはデータのラッパーです。データベースにアクセスするためのインターフェースで何かを変更して、私がそれを呼び出したプロジェクト全体で検索を処理する必要はありません。したがって、抽象化レイヤー-データアクセスレイヤーを作成します。彼は、サイトの基本メカニズムとMVCメカニズムまたは他のメカニズムの間の仲介者になります。そして-偶然？ -すぐにテストオブジェクトがあります。テストを使用するもう1つの理由は、接続性の低いソリューションを引き起こすことです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストの関数コードを変更します。1つはその名前を変更します。これで、テスト中であることがわかりました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電話を追加！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリは作成しません。デモプロジェクトの場合、これは冗長なソリューションです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、startup.csのDIを介してすべてを接続できますが、デモプロジェクトの場合、これはあまりにもわかりにくいので、このままにしておきましょう</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいテスト機能コード：</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">TestMethod</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddPhone_Test</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
	String PhoneName = <span class="hljs-string">"Nokia"</span>;<font></font>
	DateTime now = DateTime.Now;<font></font>
<font></font>
	HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
	db.Database.EnsureCreated();<font></font>
<font></font>
	List&lt;Phone&gt; Phones = db.GetAllPhones().Result;<font></font>
	Assert.AreEqual(<span class="hljs-number">0</span>, Phones.Count);<font></font>
<font></font>
	Phone ph = <span class="hljs-keyword">new</span> Phone();<font></font>
	ph.Model = PhoneName;<font></font>
	ph.DayZero = now;<font></font>
<font></font>
	db.AddPhone(ph);<font></font>
<font></font>
	Phone ph1 = db.Phones.Single();<font></font>
	Assert.AreEqual(PhoneName, ph1.Model);<font></font>
	Assert.AreEqual(now, ph1.DayZero);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電話を含む行をテストデータベースから削除し、テストを再実行します-機能するはずです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それが機能しない場合は、まだ別の脚があります。</font><font style="vertical-align: inherit;">私にとってはすべてが緑です：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kc/vz/ea/kcvzeaiyug4owclncwblblpqoaw.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
db.GetAllPhones（）とは何ですか？結果？</font><font style="vertical-align: inherit;">実際のところ、DAL関数は非同期です。</font><font style="vertical-align: inherit;">しかし、テスト方法自体は普通なので、その中でawaitを呼び出すことはできません。</font><font style="vertical-align: inherit;">データを削除して、メソッドを非同期にして、何が起こるか見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの関数は非同期タスクになりました-それ以外の場合、テストは開始されず、非同期メソッドが呼び出されたところはどこでも-彼らはそれらの前に待つ必要があります</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">TestMethod</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddPhone_Test</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
	String PhoneName = <span class="hljs-string">"Nokia"</span>;<font></font>
	DateTime now = DateTime.Now;<font></font>
<font></font>
	HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
	db.Database.EnsureCreated();<font></font>
<font></font>
	List&lt;Phone&gt; Phones = <span class="hljs-keyword">await</span> db.GetAllPhones();<font></font>
	Assert.AreEqual(<span class="hljs-number">0</span>, Phones.Count);<font></font>
<font></font>
	Phone ph = <span class="hljs-keyword">new</span> Phone();<font></font>
	ph.Model = PhoneName;<font></font>
	ph.DayZero = now;<font></font>
<font></font>
	<span class="hljs-keyword">await</span> db.AddPhone(ph);<font></font>
<font></font>
	Phone ph1 = db.Phones.Single();<font></font>
	Assert.AreEqual(PhoneName, ph1.Model);<font></font>
	Assert.AreEqual(now, ph1.DayZero);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非同期呼び出しがあるすべてのテスト関数がvoidではなくTaskを返すことが重要です。そうしないと、テストが開始されないか、非同期データが返されるのを待たずにエラーが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、多かれ少なかれ動作します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snap_6_Dal</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
そして、データを手動で削除する必要があるのでしょうか。もちろん違います！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースからテーブルを削除する関数が必要です... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
db.Database.EnsureDeleted ...を使用すると便利です。実際にそれが可能です！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、より良いことは必要ではありません...実際、このプロジェクトでは、私たちの拠点はパスワードに関連付けられていません。データベースがパスワードに関連付けられている場合は、SQL Management Studioを介してデータベースを個別に作成する必要があります。データベースをdb.Database.EnsureDeletedから削除すると、すべてのパスワード、アクセス、ユーザー権限と共に削除され、フレームワークが次回作成しようとしたときに、すると、データベースにアクセスできなくなり、すべてを再度設定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが最初です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つ目は、あまり多くの作業を行わない方がよいため、データベーステストは、外部メカニズムに関連しない通常の関数よりも時間がかかるため、可能な限りすべての方法でテスト時間を最適化することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして3番目：おそらく1つのテストで、他のテーブルをそのままにして、いくつかのテーブルまたは数回を削除して再作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
db.Database.EnsureDeleted関数を呼び出して、ブラケットを押し、何が受け入れられるか、オーバーロードがあるかどうかを確認してみましょう... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uh/by/ti/uhbytib40xtjnbwfapd26iqtrus.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、あまり多くありません</font><font style="vertical-align: inherit;">... </font><font style="vertical-align: inherit;">ええ、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自のものを作成しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐに新しいプロジェクトをソリューションに追加し、（ソリューション自体で）右ボタンを使用してソリューションに追加し、-&gt; .net standard C＃を追加して、Extensionsと呼びます。バージョン2.1であることを確認してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Extensionsプロジェクトの唯一のファイルの名前をDBContextExtensions.csに変更し、次のコードをそこに配置する必要があります。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore.Infrastructure;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Extensions</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DBContextExtensions</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword">this</span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword">set</span>) <span class="hljs-keyword">where</span> TEntity : <span class="hljs-keyword">class</span><font></font>
		{<font></font>
			TableDescription Table = GetTableName(<span class="hljs-keyword">set</span>);
			<span class="hljs-keyword">int</span> res = <span class="hljs-number">0</span>;
			<span class="hljs-keyword">try</span><font></font>
			{<font></font>
				res = db.ExecuteSqlRaw(<span class="hljs-string">$"DROP TABLE [<span class="hljs-subst">{Table.Schema}</span>].[<span class="hljs-subst">{Table.TableName}</span>];"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">catch</span> (Exception)<font></font>
			{<font></font>
<font></font>
			}<font></font>
			<span class="hljs-keyword">return</span> res;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TableDescription GetTableName&lt;T&gt;(<span class="hljs-keyword">this</span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span><font></font>
		{<font></font>
			<span class="hljs-keyword">var</span> dbContext = dbSet.GetDbContext();<font></font>
<font></font>
			<span class="hljs-keyword">var</span> model = dbContext.Model;
			<span class="hljs-keyword">var</span> entityTypes = model.GetEntityTypes();
			<span class="hljs-keyword">var</span> entityType = entityTypes.First(t =&gt; t.ClrType == <span class="hljs-keyword">typeof</span>(T));
			<span class="hljs-keyword">var</span> tableNameAnnotation = entityType.GetAnnotation(<span class="hljs-string">"Relational:TableName"</span>);
			<span class="hljs-keyword">var</span> tableSchemaAnnotation = entityType.GetAnnotation(<span class="hljs-string">"Relational:Schema"</span>);
			<span class="hljs-keyword">var</span> tableName = tableNameAnnotation.Value.ToString();
			<span class="hljs-keyword">var</span> schemaName = tableSchemaAnnotation.Value.ToString();
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TableDescription { Schema = schemaName, TableName = tableName };<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword">this</span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span><font></font>
		{<font></font>
			<span class="hljs-keyword">var</span> infrastructure = dbSet <span class="hljs-keyword">as</span> IInfrastructure&lt;IServiceProvider&gt;;
			<span class="hljs-keyword">var</span> serviceProvider = infrastructure.Instance;
			<span class="hljs-keyword">var</span> currentDbContext = serviceProvider.GetService(<span class="hljs-keyword">typeof</span>(ICurrentDbContext)) <span class="hljs-keyword">as</span> ICurrentDbContext;
			<span class="hljs-keyword">return</span> currentDbContext.Context;<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TableDescription</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> String Schema { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
		<span class="hljs-keyword">public</span> String TableName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NugetからMicrosoft.EntityFrameworkCoreを追加します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のパッケージであるMicrosoft.EntityFrameworkCore.Relational </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Extensionsは非常に便利なメカニズムです。これを使用すると、クラスオブジェクトに追加の機能を追加できます。これは、最初のパラメーターのタイプの前にthisキーワードを追加したためです。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword">this</span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword">set</span>) <span class="hljs-keyword">where</span> TEntity : <span class="hljs-keyword">class</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡張可能なタイプを示します。これは、これを書き込んだ後、DatabaseFacadeオブジェクトに新しいメソッド（パラメーターを指定したEnsureDeleted）が含まれることを意味します。これは、先ほど記述した関数になります。ここで、TEntity：クラスの最後は、TEntityに制約があることを意味します-使用に関する制限です。クラスではなく、何かによって一般化しようとすると、コンパイル時エラーになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はあなたの論理的な質問を予測しています-なぜこれがですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、EnsureDeletedから呼び出されるGetTableName関数には、この制限が必要です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ彼女はこの制限を必要とするのですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、GetTableNameから呼び出されるGetDbContext関数にもこの制限が必要です... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜこの制限</font><font style="vertical-align: inherit;">が必要なのです</font><font style="vertical-align: inherit;">か??? !!!あなたは高いトーンで尋ねるとあなたは正しいでしょう...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行のGetDbContextメソッドで拡張しようとしているdbSet</font></font><br>
<br>
<pre><code class="cs hljs">Public <span class="hljs-keyword">static</span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword">this</span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、Tが参照型である必要があり、クラスはそれらの1つにすぎません... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、これらのすべての困難-1つの小さいが非常に便利な機能では-として文字列値をパラメーターとしてEnsureDeletedメソッドに渡さないでください。記憶力が悪いから。 DBContextがどのテーブルを持っているかを通知し、このデータセットから既にコンテキストを計算し、サービスプロバイダーを介して現在のコンテキストに持ってきて、このコンテキストからモデルを取得し、そこから型を取得して、これらの型を持つ型を探しますデータセットと同じ（これは既にGetTableNameにあります）の場合、アノテーションを介してテーブルとスキーマの名前を取得し、それを既にEnsureDeletedに渡します-いまいましい！繰り返しますが、removetableなどの関数はありません。文字列からSQL syrnikiを作成する必要があります...少なくとも、どういうわけかうまくいきました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、EnsureDeleted関数には例外があるため、テーブルを削除する手順について考えることができません。関連するデータがある場合は、関連するテーブルを削除した直後に、もう一度テーブルを削除してみてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メソッドをテストに追加します（最後に）</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">TestMethod</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DeleteTable_Test</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
	HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
	db.Database.EnsureDeleted(db.Phones);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行、チェック、吐き出す... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度実行-動作するはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、テストを実行するたびに、必要なテーブルが作成され、削除されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット：Snap_7_Extensions</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
to new </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">痔の</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地平線</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、1つの問題があります-HabrDBContextオブジェクトは永続化されません（各テストメソッドで作成されます）。</font><font style="vertical-align: inherit;">（そうですね、KGBの単体テストのアイデアは分離する必要があります。それを壊そうとしています！警察が見ないのはいいことです...）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、各テストメソッドでコンテキストが再作成され、関数間でこのオブジェクトを共有できませんすべてに共通であり、すべてのテストに対して一度作成されます。</font><font style="vertical-align: inherit;">できない？</font><font style="vertical-align: inherit;">さて、さて、私たちはそれぞれの関数を書きます。</font></font><br>
<br>
<pre><code class="cs hljs">HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
db.Database.EnsureCreated();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後のメソッドを呼び出します</font></font><br>
<br>
<pre><code class="cs hljs">HabrDBContext db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
db.Database.EnsureDeleted(db.Phones);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のいくつかのテーブル... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あまり美しくないので、この問題の解決方法を検討します...テスターのように服を着せるため、画像と一致させる必要があります-解決策を探します！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスには、静的メンバーという興味深い機能があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図面とこの図面から作成されたオブジェクトを想像すると、静的メンバーは、図面から作成されたオブジェクトではなく、この図面自体に固有のメンバーであることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはもうおもしろい… </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さあやってみよう！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストクラスはDBTestと呼ばれ、静的オブジェクトを作成します-db</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB;
<span class="hljs-keyword">using</span> HabrDB.DBClasses;
<span class="hljs-keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Extensions;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DBTest</span><font></font>
{<font></font>
	[<span class="hljs-meta">TestClass</span>]
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DBTest</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HabrDBContext db;<font></font>
<font></font>
		[<span class="hljs-meta">TestMethod</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AA0_init</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
			db.Database.EnsureCreated();<font></font>
		}<font></font>
<font></font>
		[<span class="hljs-meta">TestMethod</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddPhone_Test</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			String PhoneName = <span class="hljs-string">"Nokia"</span>;<font></font>
			DateTime now = DateTime.Now;<font></font>
<font></font>
			List&lt;Phone&gt; Phones = <span class="hljs-keyword">await</span> db.GetAllPhones();<font></font>
			Assert.AreEqual(<span class="hljs-number">0</span>, Phones.Count);<font></font>
<font></font>
			Phone ph = <span class="hljs-keyword">new</span> Phone();<font></font>
			ph.Model = PhoneName;<font></font>
			ph.DayZero = now;<font></font>
<font></font>
			<span class="hljs-keyword">await</span> db.AddPhone(ph);<font></font>
<font></font>
			Phone ph1 = db.Phones.Single();<font></font>
			Assert.AreEqual(PhoneName, ph1.Model);<font></font>
			Assert.AreEqual(now, ph1.DayZero);<font></font>
		}<font></font>
<font></font>
		[<span class="hljs-meta">TestMethod</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DeleteTable_Test</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			db.Database.EnsureDeleted(db.Phones);<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動作します！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、そのようなメソッドを番号付けするのは愚かです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策があります！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特別なテスト属性！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストプロジェクトで、DBTestBaseという新しいクラスを作成し、そこからDBTestクラスを継承します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBTestから、以下を除くすべてを削除する必要があります。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB;
<span class="hljs-keyword">using</span> HabrDB.DBClasses;
<span class="hljs-keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Extensions;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DBTest</span><font></font>
{<font></font>
	[<span class="hljs-meta">TestClass</span>]
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DBTest</span>:<span class="hljs-title">DBTestBase</span><font></font>
	{<font></font>
		[<span class="hljs-meta">TestMethod</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddPhone_Test</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			String PhoneName = <span class="hljs-string">"Nokia"</span>;<font></font>
			DateTime now = DateTime.Now;<font></font>
<font></font>
			List&lt;Phone&gt; Phones = <span class="hljs-keyword">await</span> db.GetAllPhones();<font></font>
			Assert.AreEqual(<span class="hljs-number">0</span>, Phones.Count);<font></font>
<font></font>
			Phone ph = <span class="hljs-keyword">new</span> Phone();<font></font>
			ph.Model = PhoneName;<font></font>
			ph.DayZero = now;<font></font>
<font></font>
			<span class="hljs-keyword">await</span> db.AddPhone(ph);<font></font>
<font></font>
			Phone ph1 = db.Phones.Single();<font></font>
			Assert.AreEqual(PhoneName, ph1.Model);<font></font>
			Assert.AreEqual(now, ph1.DayZero);<font></font>
		}<font></font>
<font></font>
		[<span class="hljs-meta">ClassCleanup</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DeleteTable</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			db.Database.EnsureDeleted(db.Phones);<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBTestBaseクラスの内容：</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> HabrDB;
<span class="hljs-keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">DBTest</span><font></font>
{<font></font>
	[<span class="hljs-meta">TestClass</span>]
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DBTestBase</span><font></font>
	{<font></font>
		<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HabrDBContext db{ <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Executes once before the test run. (Optional)</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="context"&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span>
		[<span class="hljs-meta">AssemblyInitialize</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AssemblyInit</span>(<span class="hljs-params">TestContext context</span>)</span><font></font>
		{<font></font>
			db = <span class="hljs-keyword">new</span> HabrDBContext().CreateTestContext();<font></font>
			db.Database.EnsureCreated();<font></font>
		}<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Executes before this class creation</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="context"&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span>
		[<span class="hljs-meta">ClassInitialize</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestFixtureSetup</span>(<span class="hljs-params">TestContext context</span>)</span><font></font>
		{<font></font>
<font></font>
		}<font></font>
<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Executes Before each test </span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		[<span class="hljs-meta">TestInitialize</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Setup</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
<font></font>
		}<font></font>
<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Executes once after the test run</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		[<span class="hljs-meta">AssemblyCleanup</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AssemblyCleanup</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
<font></font>
		}<font></font>
<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Runs once after all tests in this class are executed.</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Not guaranteed that it executes instantly after all tests from the class.</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		[<span class="hljs-meta">ClassCleanup</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestFixtureTearDown</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
<font></font>
		}<font></font>
<font></font>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> Executes after each test</span>
		<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
		[<span class="hljs-meta">TestCleanup</span>]
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TearDown</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			<span class="hljs-comment">//db.Database.EnsureDeleted();//don`t call! delete database instead of tables!</span><font></font>
		}<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今、すべてが明確です！</font><font style="vertical-align: inherit;">データベースはDBTestBaseクラスの静的な部分として作成されるため、データベースから継承されたすべてのクラスにアクセスできます。</font><font style="vertical-align: inherit;">これは、データベースが1回だけ作成されることを意味します-テストの開始時に。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[ClassCleanup]属性を任意のクラスの任意のメソッドに追加し、「よりクリーンな」テストを取得します。このような関数は、このクラスのすべてのテストが完了した後に何かを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、データベース自体に触れることなく、このテストで作成されたすべてのテーブルを削除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの特別な関数はすべてメトリックスから除外されているため、関数が機能するクリーンな時間を確認できます。いくつかの左のオブジェクトを追加し、選択関数の実行時間の急激な増加を確認できます。つまり、DAL関数に問題があり、1つの関数をテストした場合1つのテスト方法では、問題がどこにあるかすぐに明らかになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数からプレイリストを作成することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、たとえば、データ準備関数を呼び出すために必要です（テスト用にのみ）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、DAL関数がこのデータを更新し、次に別のDAL関数が、たとえば何かを考えたり、このデータからレポートを表示したりして、このデータを削除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、実際のビジネスプロセスから一部のユーザーアクションを模倣できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
覚えておくべき主なことは、これらのテスト属性以外では、テストはアルファベット順に呼び出されるということです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、何らかの静的シーケンスが必要な場合は、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T1_AddPhone_Test、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T2_RemovePhone_Test </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
など</font><font style="vertical-align: inherit;">を呼び出す</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">まあ、データベースについて心配する必要はありません。すべてが完全にテストされます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、今は寝る時間です！私はまだテストされていない女の子がいます... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストに成功しました！みんなさようなら！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gitリポジトリプロジェクト：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//github.com/3263927/Habr_1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このトピックが興味深い場合はコメントに書き込んでください。次に、Identity、Roles、Claim、3D認証のテスト、およびTypeFilterAttributeの書き込みに関する投稿を書き留めます（標準のものはキャッシュされるため、ロールから人物を削除した場合、彼は結婚するまでこのロールを維持します。そして、結婚はテストされるまで出ません！：/）</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もうできます、テストに合格しました</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/ek/8u/bl/ek8ublhenuarw7809onfz2l_nx4.jpeg" alt="image"><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja481460/index.html">メッセージング-> OTP内のPubSub</a></li>
<li><a href="../ja481462/index.html">教育ソフトウェアの歴史：パソコンと仮想教師の開発</a></li>
<li><a href="../ja481466/index.html">多くの異なる環境が必要な場合に、Jenkinsでプロジェクトを構築する方法</a></li>
<li><a href="../ja481470/index.html">一年中スマートガーランド</a></li>
<li><a href="../ja481472/index.html">DNSの履歴：ドメイン名が支払われる時期</a></li>
<li><a href="../ja481476/index.html">会議で話し始めたが止まらない</a></li>
<li><a href="../ja481478/index.html">STM32 + CMSIS + STM32CubeIDE</a></li>
<li><a href="../ja481480/index.html">これが標準です：法線マップとは何で、どのように機能しますか</a></li>
<li><a href="../ja481482/index.html">PHP SDKを使用したFacebookページへのクロスポスト</a></li>
<li><a href="../ja481484/index.html">AIが複雑な動作を学習して問題を回避しようとする</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>