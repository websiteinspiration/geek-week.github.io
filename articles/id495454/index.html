<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üßìüèΩ ü¶ó Pengantar singkat tentang BPF dan eBPF ‚óæÔ∏è üé∑ ü•ã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Kami memberi tahu Anda bahwa kami sedang bersiap untuk merilis buku " Linux Observability with BPF ".
 
 
 Ketika mesin virtual BPF terus ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pengantar singkat tentang BPF dan eBPF</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/495454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo, Habr! </font><font style="vertical-align: inherit;">Kami memberi tahu Anda bahwa kami sedang bersiap untuk merilis buku " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Observability with BPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/bv/rl/pwbvrl5-5goay7zxvi8tb3fisrc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika mesin virtual BPF terus berkembang dan diterapkan secara aktif dalam praktiknya, kami telah menerjemahkan sebuah artikel untuk Anda yang menjelaskan fitur-fitur utama dan status saat ini.</font></font><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam beberapa tahun terakhir, alat dan teknik pemrograman mulai mendapatkan popularitas, yang dirancang untuk mengompensasi keterbatasan kernel Linux dalam kasus-kasus di mana pemrosesan paket berkinerja tinggi diperlukan. Salah satu metode yang paling populer dari jenis ini disebut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bypassing kernel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (kernel bypass) dan memungkinkan lewat core lapisan jaringan melakukan semua pemrosesan paket dari ruang pengguna. Melewati kernel juga melibatkan pengelolaan kartu jaringan dari </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ruang pengguna</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dengan kata lain, ketika bekerja dengan kartu jaringan, kami bergantung pada driver </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ruang pengguna</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan mentransfer kendali penuh atas kartu jaringan ke program dari ruang pengguna, kami mengurangi biaya yang terkait dengan kernel (pengalihan konteks, pemrosesan tingkat jaringan, interupsi, dll.), Yang cukup penting ketika bekerja pada kecepatan 10Gb / dtk atau lebih tinggi. Pemintas kernel ditambah kombinasi fitur lain ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pemrosesan batch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dan penyetelan kinerja yang akurat ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penghitungan NUMA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isolasi CPU</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dll.) Sesuai dengan dasar-dasar pemrosesan jaringan berkinerja tinggi di ruang pengguna. Mungkin contoh model dari pendekatan baru dalam pemrosesan paket ini </font><font style="vertical-align: inherit;">adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">Kit Pengembangan Data Pesawat)</font></i><font style="vertical-align: inherit;"> Intel</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), meskipun ada alat dan teknik terkenal lainnya, termasuk VPP dari Cisco (Vector Packet Processing), Netmap dan, tentu saja, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snabb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Organisasi interaksi jaringan di ruang pengguna memiliki sejumlah kelemahan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernel OS adalah tingkat abstraksi untuk sumber daya perangkat keras. </font><font style="vertical-align: inherit;">Karena program ruang pengguna harus mengelola sumber dayanya secara langsung, mereka juga harus mengelola perangkat keras mereka sendiri. </font><font style="vertical-align: inherit;">Ini sering berarti bahwa Anda perlu memprogram driver Anda sendiri.</font></font></li>
<li>      ,        ,  .        , , ,      .</li>
<li>    ,               .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intinya, ketika mengatur interaksi jaringan di ruang pengguna, peningkatan produktivitas dicapai dengan mentransfer pemrosesan paket dari kernel ke ruang pengguna. XDP melakukan yang sebaliknya: memindahkan program jaringan dari ruang pengguna (filter, konverter, perutean, dll.) Ke area kernel. XDP memungkinkan kita untuk melakukan fungsi jaringan segera setelah paket tiba di antarmuka jaringan dan sebelum mulai bergerak naik ke subsistem jaringan kernel. Akibatnya, kecepatan pemrosesan paket meningkat secara signifikan. Namun, bagaimana kernel memungkinkan pengguna untuk menjalankan program mereka di ruang kernel? Sebelum menjawab pertanyaan ini, mari kita lihat apa itu BPF. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF dan eBPF</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meskipun nama BPF tidak begitu jelas (Packet Filtering, Berkeley), itu sebenarnya adalah model mesin virtual. </font><font style="vertical-align: inherit;">Mesin virtual ini awalnya dirancang untuk menangani penyaringan paket, oleh karena itu namanya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu alat paling terkenal menggunakan BPF adalah </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Saat mengambil paket dengan, </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengguna dapat menentukan ekspresi untuk memfilter paket. </font><font style="vertical-align: inherit;">Hanya paket yang cocok dengan ungkapan ini yang akan ditangkap. </font><font style="vertical-align: inherit;">Sebagai contoh, ekspresi " </font></font><code>tcp dst port 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" berlaku untuk semua paket TCP yang tiba di port 80. Kompiler dapat mempersingkat ekspresi ini dengan mengubahnya menjadi bytecode BPF. </font><font style="vertical-align: inherit;">
Inilah yang pada dasarnya dilakukan oleh program di atas:</font></font><br>
<br>
<code>$ sudo tcpdump -d "tcp dst port 80"<br>
(000) ldh [12]<br>
(001) jeq #0x86dd jt 2 jf 6<br>
(002) ldb [20]<br>
(003) jeq #0x6 jt 4 jf 15<br>
(004) ldh [56]<br>
(005) jeq #0x50 jt 14 jf 15<br>
(006) jeq #0x800 jt 7 jf 15<br>
(007) ldb [23]<br>
(008) jeq #0x6 jt 9 jf 15<br>
(009) ldh [20]<br>
(010) jset #0x1fff jt 15 jf 11<br>
(011) ldxb 4*([14]&amp;0xf)<br>
(012) ldh [x + 16]<br>
(013) jeq #0x50 jt 14 jf 15<br>
(014) ret #262144<br>
(015) ret #0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instruction (000): mengunduh paket pada offset 12 sebagai kata 16-bit ke dalam baterai. </font><font style="vertical-align: inherit;">Offset 12 sesuai dengan paket ethertype.</font></font></li>
<li> (001):      0x86dd,  ,  ethertype-  IPv6.    true,       (002),    ‚Äì   (006).</li>
<li> (006):    0x800 (ethertype-  IPv4).   true,     (007),   ‚Äì   (015).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan seterusnya, hingga program penyaringan paket mengembalikan hasilnya. Ini biasanya bulean. Mengembalikan nilai bukan nol (instruksi (014)) berarti bahwa paket telah mendekati, dan mengembalikan nol (instruksi (015)) berarti bahwa paket belum tiba. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesin virtual BPF dan kode byanya diusulkan oleh Steve McCann dan Van Jacobson pada akhir 1992 ketika artikel mereka </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSD Packet Filter: Arsitektur Baru untuk Pengambilan Paket pada Tingkat Pengguna</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pertama kali diperkenalkan pada konferensi Usenix pada musim dingin tahun 1993.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena BPF adalah mesin virtual, BPF mendefinisikan lingkungan tempat program dijalankan. Selain bytecode, ia juga mendefinisikan model memori batch (instruksi boot secara implisit diterapkan pada paket), register (A dan X; register baterai dan indeks), penyimpanan memori awal, dan penghitung program implisit. Menariknya, bytecode BPF dimodelkan setelah Motorola 6502 ISA. Seperti yang diingat Steve McCann dalam pidato </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pleno</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di Sharkfest '11, ia telah terbiasa dengan bangunan 6502 sejak sekolah menengah ketika ia memprogram di Apple II, dan pengetahuan ini memengaruhi pekerjaannya dalam merancang bytecode BPF.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dukungan untuk BPF diimplementasikan dalam kernel Linux dalam versi v2.5 dan lebih tinggi, ditambahkan terutama oleh upaya Jay Schullist. Kode BPF tetap tidak berubah hingga 2011, ketika Eric Dumazett redid penerjemah BPF untuk bekerja dalam mode JIT (Sumber: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT untuk filter paket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Setelah itu, kernel, alih-alih menginterpretasikan kode byte BPF, bisa langsung mengonversi program BPF ke arsitektur target: x86, ARM, MIPS, dll.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian, pada 2014, Alexey Starovoitov mengusulkan mekanisme JIT baru untuk BPF. </font><font style="vertical-align: inherit;">Bahkan, JIT baru ini telah menjadi arsitektur berbasis BPF baru dan disebut eBPF. </font><font style="vertical-align: inherit;">Saya berpikir bahwa untuk beberapa waktu kedua mesin virtual hidup berdampingan, tetapi saat ini packet filtering diimplementasikan berdasarkan eBPF. </font><font style="vertical-align: inherit;">Bahkan, dalam banyak contoh dokumentasi modern, BPF dipahami sebagai eBPF, dan BPF klasik sekarang dikenal sebagai cBPF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF memperluas mesin virtual BPF klasik dalam beberapa cara:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berdasarkan arsitektur 64-bit modern. </font><font style="vertical-align: inherit;">eBPF menggunakan register 64-bit dan meningkatkan jumlah register yang tersedia dari 2 (baterai dan X) menjadi 10. eBPF juga menyediakan kode operasi tambahan (BPF_MOV, BPF_JNE, BPF_CALL ...).</font></font></li>
<li>    . BPF      .      ,     ,   . ,   eBPF            . ,   eBPF    tracepoint   kprobe.      eBPF,            .   eBPF    : kernel/bpf.</li>
<li>     .  ‚Äì    ¬´-¬ª,         .  eBPF    .</li>
<li> .  ,   ,      .            .  ,   eBPF    .</li>
<li> .    eBPF  4096 .      eBPF    eBPF-       (     32 ).</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF: Sebuah Contoh</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ada beberapa contoh untuk eBPF di sumber kernel Linux. </font><font style="vertical-align: inherit;">Mereka tersedia di sampel / bpf /. </font><font style="vertical-align: inherit;">Untuk mengkompilasi contoh-contoh ini, cukup masukkan: </font></font><br>
<br>
<code>$ sudo make samples/bpf/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sendiri tidak akan menulis contoh baru untuk eBPF, tetapi akan menggunakan salah satu sampel yang tersedia dalam sampel / bpf /. </font><font style="vertical-align: inherit;">Saya akan melihat beberapa bagian dari kode dan menjelaskan cara kerjanya. </font><font style="vertical-align: inherit;">Sebagai contoh, saya memilih program </font></font><code>tracex4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, masing-masing contoh dalam sampel / bpf / terdiri dari dua file. </font><font style="vertical-align: inherit;">Pada kasus ini:</font></font><br>
<br>
<ul>
<li><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, berisi kode sumber yang harus dijalankan di kernel sebagai bytecode eBPF.</font></font></li>
<li><code>tracex4_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, berisi program dari ruang pengguna.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, kita perlu mengkompilasi </font></font><code> tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF ke dalam bytecode. </font><font style="vertical-align: inherit;">Saat ini </font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak ada bagian server untuk eBPF. </font><font style="vertical-align: inherit;">Untungnya, ia </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bisa mengeluarkan bytecode eBPF. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Makefile</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gunakan </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mengkompilasi </font></font><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file objek. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sebutkan di atas bahwa salah satu fitur paling menarik dari eBPF adalah kartu. </font><font style="vertical-align: inherit;">tracex4_kern mendefinisikan satu peta:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> {</span><font></font>
    u64 val;<font></font>
    u64 ip;<font></font>
};  <font></font>
<font></font>
<span class="hljs-function">struct bpf_map_def <span class="hljs-title">SEC</span><span class="hljs-params">(<span class="hljs-string">"maps"</span>)</span> my_map </span>= {<font></font>
    .type = BPF_MAP_TYPE_HASH,<font></font>
    .key_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>),<font></font>
    .value_size = <span class="hljs-keyword">sizeof</span>(struct pair),<font></font>
    .max_entries = <span class="hljs-number">1000000</span>,<font></font>
};</code></pre><br>
<code>BPF_MAP_TYPE_HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Salah satu dari banyak jenis kartu yang ditawarkan oleh eBPF. </font><font style="vertical-align: inherit;">Dalam hal ini, itu hanya hash. </font><font style="vertical-align: inherit;">Anda mungkin juga memperhatikan iklan </font></font><code>SEC("maps")</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">SEC adalah makro yang digunakan untuk membuat bagian baru dari file biner. </font><font style="vertical-align: inherit;">Sebenarnya, contoh </font></font><code>tracex4_kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendefinisikan dua bagian lagi:</font></font><br>
<br>
<pre><code class="cpp hljs">SEC(<span class="hljs-string">"kprobe/kmem_cache_free"</span>)
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog1</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{   
    <span class="hljs-keyword">long</span> ptr = PT_REGS_PARM2(ctx);<font></font>
<font></font>
    bpf_map_delete_elem(&amp;my_map, &amp;ptr); <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
    <font></font>
SEC(<span class="hljs-string">"kretprobe/kmem_cache_alloc_node"</span>) 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog2</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{
    <span class="hljs-keyword">long</span> ptr = PT_REGS_RC(ctx);
    <span class="hljs-keyword">long</span> ip = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  ip-   kmem_cache_alloc_node() </span><font></font>
    BPF_KRETPROBE_READ_RET_IP(ip, ctx);<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> <span class="hljs-title">v</span> = {</span><font></font>
        .val = bpf_ktime_get_ns(),<font></font>
        .ip = ip,<font></font>
    };<font></font>
    <font></font>
    bpf_map_update_elem(&amp;my_map, &amp;ptr, &amp;v, BPF_ANY);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua fungsi ini memungkinkan Anda untuk menghapus entri dari kartu ( </font></font><code>kprobe/kmem_cache_free</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dan menambahkan catatan baru ( </font></font><code>kretprobe/kmem_cache_alloc_node</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">ke kartu </font><font style="vertical-align: inherit;">. Semua nama fungsi yang ditulis dengan huruf besar sesuai dengan makro yang didefinisikan dalam </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bpf_helpers.h</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika saya menampilkan dump bagian dari file objek, saya akan melihat bahwa bagian-bagian baru ini sudah didefinisikan: </font><font style="vertical-align: inherit;">
Masih ada </font><font style="vertical-align: inherit;">, program utama. Pada dasarnya, program ini mendengarkan acara </font><font style="vertical-align: inherit;">. Ketika peristiwa semacam itu terjadi, kode eBPF yang sesuai dijalankan. Kode menyimpan atribut IP objek di peta, dan kemudian objek ini ditampilkan secara siklis di program utama. Contoh: </font><font style="vertical-align: inherit;">
Bagaimana program ruang pengguna dan program eBPF terkait? Pada inisialisasi, ini </font><font style="vertical-align: inherit;">memuat file objek </font><font style="vertical-align: inherit;">menggunakan fungsi </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<code>$ objdump -h tracex4_kern.o<br>
<br>
tracex4_kern.o: file format elf64-little<br>
<br>
Sections:<br>
Idx Name Size VMA LMA File off Algn<br>
 0 .text 00000000 0000000000000000 0000000000000000 00000040 2**2<br>
 CONTENTS, ALLOC, LOAD, READONLY, CODE<br>
 1 kprobe/kmem_cache_free 00000048 0000000000000000 0000000000000000 00000040 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 2 kretprobe/kmem_cache_alloc_node 000000c0 0000000000000000 0000000000000000 00000088 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 3 maps 0000001c 0000000000000000 0000000000000000 00000148 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 4 license 00000004 0000000000000000 0000000000000000 00000164 2**0<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 5 version 00000004 0000000000000000 0000000000000000 00000168 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 6 .eh_frame 00000050 0000000000000000 0000000000000000 00000170 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</code><br>
<br><font style="vertical-align: inherit;"></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tracex4_user.c</a></code><font style="vertical-align: inherit;"></font><code>kmem_cache_alloc_node</code><font style="vertical-align: inherit;"></font><br>
<br>
<code>$ sudo ./tracex4<br>
obj 0xffff8d6430f60a00 is 2sec old was allocated at ip ffffffff9891ad90<br>
obj 0xffff8d6062ca5e00 is 23sec old was allocated at ip ffffffff98090e8f<br>
obj 0xffff8d5f80161780 is 6sec old was allocated at ip ffffffff98090e8f</code><br>
<br><font style="vertical-align: inherit;"></font><code>tracex4_user.c</code><font style="vertical-align: inherit;"></font><code>tracex4_kern.o</code><font style="vertical-align: inherit;"></font><code>load_bpf_file</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ac, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span> = {</span>RLIM_INFINITY, RLIM_INFINITY};
    <span class="hljs-keyword">char</span> filename[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), <span class="hljs-string">"%s_kern.o"</span>, argv[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;r)) {<font></font>
        perror(<span class="hljs-string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (load_bpf_file(filename)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, bpf_log_buf);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; i++) {<font></font>
        print_old_objects(map_fd[<span class="hljs-number">1</span>]);<font></font>
        sleep(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika dieksekusi, </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">load_bpf_file</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probe yang ditentukan dalam file eBPF ditambahkan ke </font></font><code>/sys/kernel/debug/tracing/kprobe_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sekarang kami mendengarkan acara ini, dan program kami dapat melakukan sesuatu ketika itu terjadi. </font><font style="vertical-align: inherit;">
Semua program lain dalam sampel / bpf / disusun dengan cara yang sama. </font><font style="vertical-align: inherit;">Mereka selalu memiliki dua file:</font></font><br>
<br>
<code>$ sudo cat /sys/kernel/debug/tracing/kprobe_events<br>
p:kprobes/kmem_cache_free kmem_cache_free<br>
r:kprobes/kmem_cache_alloc_node kmem_cache_alloc_node</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><code>XXX_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: program eBPF.</font></font></li>
<li><code>XXX_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: program utama.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Program eBPF mendefinisikan kartu dan fungsi yang terkait dengan bagian tersebut. </font><font style="vertical-align: inherit;">Ketika kernel melempar suatu kejadian dari tipe tertentu (misalnya, </font></font><code>tracepoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), fungsi terikat dieksekusi. </font><font style="vertical-align: inherit;">Peta menyediakan pertukaran data antara program kernel dan program ruang pengguna. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Artikel ini menguraikan BPF dan eBPF. </font><font style="vertical-align: inherit;">Saya tahu bahwa hari ini ada banyak informasi dan sumber daya tentang eBPF, jadi saya merekomendasikan beberapa bahan untuk studi lebih lanjut. Saya </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sarankan membaca:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF: mesin virtual in-kernel universal oleh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jonathan Corbett. </font><font style="vertical-align: inherit;">Pengantar BPF dan bagaimana BPB berkembang menjadi eBPF.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">A thorough introduction to eBPF</a>  .    LWN.net.      eBPF           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Notes on BPF &amp; eBPF</a>  .      ‚ÄúThe BSD Packet Filter: A New Architecture for User-level Packet Capture‚Äù.        .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">eBPF, part1: Past, Present and Future</a>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>,   .      eBPF,   .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id495438/index.html">Bahasa R untuk pengguna Excel (kursus video gratis)</a></li>
<li><a href="../id495446/index.html">Antigravitasi bukanlah yang Anda pikirkan</a></li>
<li><a href="../id495448/index.html">Mitaps online untuk seluruh minggu di belakang, depan, QA, PM, DevOps dan sedikit pada robot, mulai dari 3 April</a></li>
<li><a href="../id495450/index.html">Debugging aplikasi Golang yang sarat muatan atau bagaimana kami mencari masalah di Kubernet yang tidak ada</a></li>
<li><a href="../id495452/index.html">Cara menyiapkan situs untuk pertumbuhan beban</a></li>
<li><a href="../id495456/index.html">Tinjau 14 plugin baru untuk Figma yang akan membantu meningkatkan produktivitas sementara kita semua</a></li>
<li><a href="../id495458/index.html">Cara menulis kode ketika anak-anak berlarian di sekitar Anda dan bertanya: "Untuk apa Anda bekerja?"</a></li>
<li><a href="../id495460/index.html">Gelembung gas 22.000 kali ukuran Bumi meledak di Uranus</a></li>
<li><a href="../id495462/index.html">.NET Core: x86_64 Intrinsics di Mesin Virtual</a></li>
<li><a href="../id495464/index.html">Pesan informasi 404 - tidak hanya kesalahan, tetapi juga hari libur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>