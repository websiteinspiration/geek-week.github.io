<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👩🏼 👼🏾 🙋 Prometheusを使用してGitLabで異常を検出する方法 👨🏼‍🎤 👨🏾‍🚒 🗣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prometheusクエリ言語の基本機能の1つは、時系列のリアルタイム集計です。Prometheusクエリ言語を使用して、時系列データの異常を検出することもできます。 Mail.ruクラウドソリューションチームがいる翻訳GitLabインフラチームのエンジニアによる記事あなたがあなたのシステム上で試す...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Prometheusを使用してGitLabで異常を検出する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheusクエリ言語の基本機能の1つは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時系列の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リアルタイム</font><font style="vertical-align: inherit;">集計です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Prometheusクエリ言語を使用して、時系列データの異常を検出することもできます。&nbsp;</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Mail.ruクラウドソリューション</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">チームがいる</font></a><font style="vertical-align: inherit;">翻訳</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">GitLabインフラチームのエンジニアによる記事</font></a><font style="vertical-align: inherit;">あなたがあなたのシステム上で試すことができ、コードの例があります。</font></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異常検出とは何ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLabの異常検出の重要性を決定する主な理由は4つあります。</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インシデント診断</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：インシデント検出時間（MTTD）を短縮することで、通常の範囲を超えたサービスを検出し、問題に対するより迅速なソリューションを提供します。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンス低下の検出</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：たとえば、サービスに回帰が導入されて別のサービスに頻繁にアクセスする場合、この問題をすばやく検出して修正できます。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">虐待の検出と排除</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：GitLabは、配信および統合メカニズム（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）およびホスティング（GitLab Pages）と、これらのメカニズムを使用できる限られた数のユーザーを提供します。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全性</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：異常検出は、GitLab時系列の異常な傾向を検出するために重要です。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの理由およびその他の理由により、この記事の作成者は、Prometheusクエリおよびルールを使用して、GitLab時系列の異常の定義を構成する方法を理解することを決定しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しい集約レベルは何ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、時系列を正しく集計する必要があります。</font><font style="vertical-align: inherit;">以下の例では、標準のhttp_requests_totalカウンターを使用してデータを取得しましたが、他の多くのメトリックでも同様です。</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテスト指標にはいくつかのパラメーターがあります。メソッド、コントローラー、ステータスコード（status_code）、環境、さらにジョブやインスタンスなど、Prometheus自体によって追加されたパラメーターです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、適切なレベルのデータ集約を選択する必要があります。</font><font style="vertical-align: inherit;">多すぎる、少なすぎる-これらすべては異常を検出するために重要です。</font><font style="vertical-align: inherit;">データの集計が多すぎる場合、2つの潜在的な問題があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集計はデータのサブセットで発生する問題を隠すため、異常をスキップできます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異常を発見した場合、追加の努力なしにそれをシステムの別の部分に関連付けることは困難です。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データが十分に集計されていない場合、これにより誤検知の数が増加し、有効なデータが誤っていると誤って解釈される可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの経験に基づくと、最も正確な集約レベルはサービスレベルです。つまり、ジョブと環境のラベルを含め、他のすべてのラベルは破棄します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事全体で説明する集約には、ジョブ-http_request、集約-5分が含まれます。これは、5分の作業と環境に基づいて計算されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の例から、一連のhttp_requests_totalサブセットから、作業と環境のコンテキストでサブセットが選択され、その数は5分間と見なされることは明らかです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zスコアを使用して異常を検出する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
統計の基本原則を適用して異常を検出できます。</font><font style="vertical-align: inherit;">プロメテウス系列</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
の平均と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準偏差</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">わかっている場合</font><font style="vertical-align: inherit;">は、系列内の任意のサンプルを使用してZスコアを計算できます。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zスコアは、観測値または測定値の相対的な広がりの測定値であり</font><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">平均値</font></a><font style="vertical-align: inherit;">に対するその広がりの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準偏差の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数を示します</font><font style="vertical-align: inherit;">。&nbsp;</font><font style="vertical-align: inherit;">
つまり、zスコア= 0は、zスコアが標準分布のデータセットの平均値と同じであることを意味し、zスコア= 1は、平均からの標準偏差= 1.0であることを意味します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本データは正規分布であると想定しています。つまり、サンプルの99.7％のZスコアは0〜3です。Zスコアがゼロから離れるほど、存在する可能性は低くなります。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロパティを適用して、Prometheusデータシリーズの異常を検出します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなサンプルサイズのデータ​​を使用して、メトリックの平均と標準偏差を計算します。</font><font style="vertical-align: inherit;">この例では、週次データを使用します。</font><font style="vertical-align: inherit;">レコードが1分に1回評価されると仮定すると、1週間で10,000を少し超えるサンプルが得られます。</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集計の平均と標準偏差を取得するとすぐに、PrometheusクエリのZスコアを計算できます。</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正規分布の統計的原則に基づいて、+ 3から-3の範囲外の値は異常であると想定します。</font><font style="vertical-align: inherit;">したがって、そのような異常についての警告を作成できます。</font><font style="vertical-align: inherit;">たとえば、集計がこの範囲を5分以上超えると、アラートを受け取ります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">48時間のGitLab Pagesサービスへの1秒あたりのリクエスト数のグラフ。</font><font style="vertical-align: inherit;">+3から-3の範囲のZスコアは緑色で強調表示されます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
この値には測定単位がないため、Zスコアはグラフで解釈するのが難しい場合があります。</font><font style="vertical-align: inherit;">ただし、このグラフの異常は非常に簡単に特定できます。</font><font style="vertical-align: inherit;">zスコアが-3から+3の値のコリドーを示すグリーンゾーンを超えるすべてのものは、異常な値になります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ配信が正常でない場合の対処</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの分布は正常であると想定しています。</font><font style="vertical-align: inherit;">そうでない場合、Zスコアはfalseになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ分布の正規性を判断するには、多くの統計的手法がありますが、最善の方法は、データのZスコアが-4.0〜+4.0の範囲にあることを確認することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zスコアの最小値と最大値を示す2つのPrometheusクエリ：</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果が-20から+20の範囲にある場合、これは使用されているデータが多すぎて結果が歪んでいることを意味します。</font><font style="vertical-align: inherit;">集計された行を操作する必要があることも覚えておいてください。</font><font style="vertical-align: inherit;">正規分布を持たないメトリックには、エラー率、遅延、キューの長さなどのパラメーターが含まれます。</font><font style="vertical-align: inherit;">ただし、これらのメトリックの多くは、アラートしきい値が固定されているとうまく機能します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統計的季節性異常検出</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zスコアの計算は、時系列データの正規分布でうまく機能しますが、より正確な異常検出結果を提供できる2番目の方法があります。</font><font style="vertical-align: inherit;">これは統計的な季節性の使用です。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
季節性は、このメトリックが定期的で予測可能な変化を受け、各サイクルで繰り返される場合の時系列メトリックの特性です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">連続した4週間の月曜日から日曜日までの1秒あたりのリクエスト数（RPS）の</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
グラフ上</font><i><font style="vertical-align: inherit;">の</font></i><font style="vertical-align: inherit;">グラフは、</font><i><font style="vertical-align: inherit;">連続した4週間の</font></i><font style="vertical-align: inherit;">月曜日から日曜日までの7日間のRPS（1秒あたりのリクエスト数）を示しています。</font><font style="vertical-align: inherit;">この7日間の範囲は「オフセット」と呼ばれます。つまり、測定に使用されるパターンです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チャートの各週は異なる色です。</font><font style="vertical-align: inherit;">データの季節性は、グラフに示された傾向の順序で示されます。毎週月曜日の朝に同様のRPSの増加が観察され、金曜日の夜に常にRPSの減少が観察されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時系列データで季節性を使用すると、異常の発生とその検出をより正​​確に予測できます。&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">季節性の使い方</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロメテウスは、いくつかの異なる統計メカニズムを使用して季節性を計算します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、前週の結果にその週の成長傾向を加えて計算します。成長傾向は次のように計算されます。先週の移動平均から先週の移動平均を差し引きます。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の反復はやや「狭い」ことがわかります。今週と前週の5分のウィンドウを使用して予測を取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の反復では、前週の4時間の平均を取り、それを現在の週と比較することにより、対象範囲を拡大します。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、前の週の同じ5分のウィンドウではなく、月曜日の朝の8にメトリック値を予測しようとすると、前の月曜日の朝のメトリックの平均値が6〜10になります。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在の時刻に基づいて4時間の期間を使用したいので、オフセットは1週間より2時間短い必要があるため、リクエストは166時間を示しました。これは1週間より2時間少ない（7 * 24 = 168）です。&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2週間</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
での実際の</font><i><font style="vertical-align: inherit;">RPS（黄色）と予測（青）</font></i><font style="vertical-align: inherit;">実際のRPSを予測と比較すると、計算がかなり正確であることがわかります。しかしながら、この方法には欠点があります。</font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、5月1日は、GitLabが水曜日にいつもより少なく使用されました。予測される成長傾向は、前週のシステムの使用方法に依存するため、翌週、つまり5月8日水曜日の予測では、実際よりも低いRPSが得られました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このエラーは、5月1日水曜日の前の3週間、つまり前の水曜日の3週間にわたって3つの予測を行うことで修正できます。リクエストは同じままですが、オフセットが調整されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5月8日水曜日の実際のRPSと比較して、5月8日より前の3週間のグラフには3つの予測があります。 2つの予測は非常に正確ですが、5月1日の週の予測は依然として不正確</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
であることがわかります</font><i><font style="vertical-align: inherit;">。</font></i><font style="vertical-align: inherit;">さらに、3つの予測は必要なく、1つの予測が必要です。 5月1日以降の歪んだRPSデータによって不明瞭になるため、平均値はオプションではありません。代わりに、中央値を計算する必要があります。 Prometheusには中央値クエリがありませんが、中央値の代わりに変位値集計を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
唯一の問題は、3つのシリーズを集計に含めようとしていることです。これら3つのシリーズは、実際には3週間で同じシリーズです。つまり、同じラベルが付いているので、まとめるのが難しいのです。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
混乱を避けるために、offsetというラベルを作成し、label-replace関数を使用して3週間のそれぞれにオフセットを追加します。</font><font style="vertical-align: inherit;">次に、分位点集計でこれらのラベルを破棄します。これにより、平均で3つになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、中央値が3つの集計の予測がより正確になりました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央値予測と実際のRPS</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予測が本当に正確であることを確認する方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予測の精度を確認するには、Zスコアに戻ります。</font><font style="vertical-align: inherit;">これは、標準偏差での予測とサンプルの不一致を測定するために使用されます。</font><font style="vertical-align: inherit;">予測からの標準偏差が大きいほど、特定の値が外れ値である可能性が高くなります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予測される偏差の範囲は+1.5から-1.5です</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。Grafanaチャートを変更して、週ごとの移動平均ではなく季節予測を使用できます。</font><font style="vertical-align: inherit;">1日の特定の時間の正常値の範囲は、緑色で網掛けされています。</font><font style="vertical-align: inherit;">グリーンゾーンを超えるものはすべて異常値と見なされます。</font><font style="vertical-align: inherit;">この場合、異常値は日曜の午後に発生しました。このとき、クラウドプロバイダーにネットワークの問題が発生しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
季節性の予測には、±2 zスコアを使用することをお勧めします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheusでアラートを設定する方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
異常なイベントのアラートを設定する場合は、かなり単純なPrometheusルールを適用できます。これは、インジケーターのZスコアが+2から-2の範囲にあるかどうかをチェックします。</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLabでは、異常を検出したときにSlack経由でアラートを送信するカスタムルーティングルールを使用しますが、サポートチームには連絡しません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheusを使用してGitLabで異常を検出する方法</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheusは、いくつかの異常を検出するために使用できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異常を見つけるには、適切な集計が重要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データに正規分布がある場合、Zスコアリングは効果的です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統計的季節性は、異常を検出するための強力なメカニズムです。</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutionsの</font></font></i></a><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">サポートにより翻訳されました</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まだ便利</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CIのシンプルなキャッシュ方法：画像ガイド</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCSマーケットプレイスの既製でカスタマイズされたGitLab CEツール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デジタルトランスフォーメーションに関する当社の電報チャネル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja499014/index.html">JavaScriptインタビューの23の難しい質問</a></li>
<li><a href="../ja499016/index.html">ESIA for .Netとの統合：思ったより簡単</a></li>
<li><a href="../ja499018/index.html">6つのホームスポーツアプリ</a></li>
<li><a href="../ja499020/index.html">あいまいな行動の研究</a></li>
<li><a href="../ja499030/index.html">20分でisic上のGrafanaのMySQLパフォーマンスを監視する</a></li>
<li><a href="../ja499034/index.html">危険なリファクタリングを100万人のユーザーに提供する方法は？</a></li>
<li><a href="../ja499036/index.html">プロバイダーの仕事：プロトコル、IT、ネットワークインフラストラクチャに関するさまざまな資料</a></li>
<li><a href="../ja499038/index.html">縦型モニターの使用経験</a></li>
<li><a href="../ja499040/index.html">週末にお読みください：DNS、IT規制、ハードウェアの歴史に関する資料の選択1cloud.ru</a></li>
<li><a href="../ja499044/index.html">OpenStreetMap No.508の世界からのニュース（2020年4月7日、2020年4月13日）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>