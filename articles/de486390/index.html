<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùáÔ∏è üìë üëâüèº Wright in den Schatten ü§ôüèΩ üöØ ‚õπüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist eine Geschichte √ºber eine der Aufgaben, die wir f√ºr die CTFZone- Qualifikationsphase vorbereitet haben , die Ende November stattfand. √úber de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wright in den Schatten</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/bizone/blog/486390/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist eine Geschichte √ºber eine der Aufgaben, die wir f√ºr die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTFZone-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Qualifikationsphase vorbereitet haben </font><font style="vertical-align: inherit;">, die Ende November stattfand. √úber den Qualifizierungsvorbereitungsprozess k√∂nnen Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lesen </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie beginnen mit zwei Dateien: decrypt_flag.py und ntfs_volume.raw. Schauen wir uns das Skript an. Er √∂ffnet eine Datei mit dem Namen key.bin und versucht dann mithilfe einer Schleife, aus jedem Offset in der Datei eine 34-Byte-Bin√§rzeichenfolge zu ziehen, die dann als Eingabe f√ºr die PBKDF2-Funktion verwendet wird. Jeder zur√ºckgegebene Schl√ºssel wird als XOR-Schl√ºssel verwendet, um die in den Code eingen√§hte verschl√ºsselte Zeichenfolge zu entschl√ºsseln. Wenn der entschl√ºsselte MD5-Hash mit dem vorgegebenen Wert in entschl√ºsselter Form √ºbereinstimmt, verwendet das Skript die empfangenen Daten, um das Flag zu generieren und zu drucken.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie m√ºssen also die Datei key.bin finden. </font><font style="vertical-align: inherit;">Es ist unm√∂glich, einfach alle Offsets in der Bilddatei (ntfs_volume.raw) zu sortieren, da das Auffinden des Schl√ºssels zu langsam ist. </font><font style="vertical-align: inherit;">Dies ist nach den Regeln nicht verboten, aber Sie haben sicherlich keine Zeit vor dem Ende der CTF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Image-Datei enth√§lt eine MBR-Partitionstabelle mit einer Partition. </font><font style="vertical-align: inherit;">Sein Offset betr√§gt 2048 512-Byte-Sektoren und enth√§lt das NTFS-Dateisystem, aber die Datei key.bin ist nicht vorhanden:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fls -o 2048 -r -p ntfs_volume.raw | grep -F key.bin | wc ‚Äìl<font></font>
0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTFS speichert UTF-16LE-codierte Dateinamen. </font><font style="vertical-align: inherit;">Lassen Sie uns versuchen, darin zu suchen!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/c4/9n/5g/c49n5g_kmk7j-ga2zo5nzthtad0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchergebnisse f√ºr Dateidatens√§tze</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nachdem wir die Suchergebnisse untersucht haben, konzentrieren wir uns auf Dateidatens√§tze, die mit der FILE-Signatur beginnen [1]. </font><font style="vertical-align: inherit;">Hier ist der einzige solche Eintrag:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/-x/id/wv-xid-sp4valyl_kmqxj9e2o5s.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rekord gefunden</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Das Ziel ist schon nah! Wir haben einen Dateidatensatz, aber wir brauchen Daten. In NTFS werden sie im Attribut $ DATA gespeichert, das resident oder nicht resident sein kann [2]. F√ºr den Datensatz, den wir gefunden haben, beginnt dieses Attribut bei Offset 0 √ó 3AADD00 und zeigt nicht residente Daten an (dies bedeutet, dass Informationen au√üerhalb des Dateidatensatzes gespeichert werden). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wo genau befinden sich die Daten der gew√ºnschten Datei? Um diese Frage zu beantworten, m√ºssen die sogenannten Mapping-Paare oder Datenl√§ufe (Paare ‚ÄûBlockl√§nge - Blockoffset‚Äú) dekodiert werden [3]. Die Datenl√§ufe der gew√ºnschten Datei lauten wie folgt (beachten Sie den Versatz 0 √ó 3AADD40): 22 53 01 A0 4E 21 05 31 C1 11 38 30 00. Oder wenn wir sie neu anordnen:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.	22 53 01 A0 4E<font></font>
2.	21 05 31 C1<font></font>
3.	11 38 30 00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Datei besteht aus drei Fragmenten, deren Gr√∂√üe 339 Cluster betr√§gt, und beginnt mit Cluster # 20128. F√ºr unseren Code mit PBKDF2 ist dieses Snippet gro√ü. Wie im Dateisystem-Header angegeben, betr√§gt die Gr√∂√üe eines Clusters 4096 Byte:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fsstat -o 2048 ntfs_volume.raw | grep 'Cluster Size'<font></font>
Cluster Size: 4096</code></pre><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werfen wir </font><font style="vertical-align: inherit;">
einen Blick auf die Daten f√ºr diesen Offset (in Bytes): </font><font style="vertical-align: inherit;">2048 * 512 + 20128 * 4096 = 83492864. Wir extrahieren hier eine signifikante Menge an Informationen (z. B. 128 Bytes), f√ºgen sie in eine neue Datei ein, die wir key.bin nennen, f√ºhren Sie das Skript aus ... Nichts war erfolgreich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√∂glicherweise wurde die Datei nicht in der aktuellen, sondern in der vorherigen Version des Dateisystems (vorherige Formatierung) gespeichert. Vergessen Sie nicht, dass der Datensatz √ºber die gel√∂schte Datei mit demselben Namen nicht angezeigt wurde. Wie gro√ü war der Cluster zuvor? Suchen wir nach dem Dateisystem-Header mit der NTFS-Signatur [4]. Vielleicht haben wir Gl√ºck und finden wirklich den Header aus der vorherigen Formatierung.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s3/mp/na/s3mpnalay_jhx-yvaytbqgp4qta.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchergebnisse f√ºr den Dateisystem-Header</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Die erste und die letzte Position in den Ergebnissen beziehen sich auf das aktuelle Dateisystem, aber die dazwischen liegenden Dateisystem-Header scheinen zur vorherigen Formatierung zu geh√∂ren. Und sie haben eine andere Clustergr√∂√üe!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/co/hb/locohbcqzrc6_etzqfxfnb1tusk.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Dateisystem-Header aus der vorherigen Version.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Eine solche Sektorgr√∂√üe wird mit einem Versatz von 0 √ó 4554800B: 00 02 oder 512 geschrieben. Eine solche Clustergr√∂√üe wird jedoch mit einem Versatz von 0 √ó 0x4554800D: F7 oder 247 aufgezeichnet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben also die Clustergr√∂√üe (in Bytes) bei uns 512 * 247 = 126464. Irgendein Unsinn! Wenn Sie dem NTFS-Parser [5] glauben, muss ein solcher Wert ein Vorzeichen haben und auf besondere Weise verarbeitet werden, sodass die tats√§chliche Clustergr√∂√üe (in Sektoren) 1 &lt;&lt; - (- 9) = 512 betr√§gt. Oder in Bytes 512 * 512 = 262144 Klingt jetzt glaubw√ºrdiger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Daten beginnen hier bei diesem Offset (in Bytes): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 262144 = 5277483008. Versuchen wir noch einmal, den gleichen Trick mit den dort gespeicherten Informationen zu machen ... Wieder ein Fehler! Was ist falsch? Wir haben CTF hier, es bedeutet "nicht so", dass alles sein kann.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aufgabe, um die wir uns streiten, hei√üt In the Shadows. </font><font style="vertical-align: inherit;">M√∂glicherweise hat dies etwas mit Schattenkopien des Volumes zu tun. </font><font style="vertical-align: inherit;">Wir haben also eine Datei aus dem Dateisystem, die zuvor in diesem Volume vorhanden war. </font><font style="vertical-align: inherit;">Leider k√∂nnen wir die Schattenkopie einfach nicht aufnehmen und mounten, aber wir kennen den genauen Versatz, bei dem die Daten beginnen! </font><font style="vertical-align: inherit;">Dies ist 5277483008 oder innerhalb des Abschnitts 5277483008 - 2048 * 512 = 5276434432. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gem√§√ü den Spezifikationen des VSS-Formats [6] werden umgeleitete Datenbl√∂cke in der </font><font style="vertical-align: inherit;">Blockdeskriptorstruktur </font><font style="vertical-align: inherit;">beschrieben, die ein 64-Bit-Feld enth√§lt, in dem der urspr√ºngliche Offset (innerhalb des Volumes) gespeichert ist, und auch ein 64-Bit-Feld, das den Versatz des Zielblocks (innerhalb des Volumes) beschreibt. </font><font style="vertical-align: inherit;">Suchen wir nach 5276434432 als 64-Bit-Little-Endian-Zahl.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Ergebnisse enthalten nur zwei Ergebnisse, von denen sich nur eines in einem gleichm√§√üigen Versatz befindet.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y6/bo/dm/y6bodmvczyemr2uu-2m7giaukqw.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gefundener Blockdeskriptor</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Zielblockversatz: 00 00 9B 03 00 00 00 00 oder nur 60489728. Endg√ºltiger Versatz: 60489728 + 2048 * 512 = 61538304. Exportieren Sie von hier aus eine bestimmte Datenmenge in eine neue Datei mit dem Namen key.bin und ...</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./decrypt_flag.py<font></font>
ctfzone{my_c0ngr4t5_t0_u,w311_d0n3_31337}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erledigt!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/file_record.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/attributes/data.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/data_runs.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/files/boot.html</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/msuhanov/dfir_ntfs/blob/94bb46d6600153071b0c3c507ef37c42ad62110d/dfir_ntfs/BootSector.py#L58</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/libyal/libvshadow/blob/master/documentation/Volume%20Shadow%20Snapshot%20(VSS)%20format.asciidoc#431-block-descriptor</font></font></a></li>
</ol></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de486376/index.html">Wie Leveldesigner die Architekturtheorie verwenden, um Spielebenen zu erstellen</a></li>
<li><a href="../de486378/index.html">Der solarbetriebene Heimserver war 15 Monate lang in Betrieb: Betriebszeit 95,26%</a></li>
<li><a href="../de486380/index.html">Was ein Produktmanager eigentlich tun sollte</a></li>
<li><a href="../de486382/index.html">Siegel und Scrum</a></li>
<li><a href="../de486388/index.html">MyVPN Open Source Nonprofit Projekt√ºbersicht</a></li>
<li><a href="../de486392/index.html">Ein kurzer Vergleich der SDS-Architektur oder die Suche nach einer geeigneten Speicherplattform (GlusterVsCephVsVirtuozzoStorage)</a></li>
<li><a href="../de486394/index.html">Lesezeichen - gibt es ein Limit?</a></li>
<li><a href="../de486396/index.html">React Native: Neuer Meilenstein in der mobilen Entwicklung von Shopify</a></li>
<li><a href="../de486400/index.html">Um Ihre pers√∂nlichen Daten zu erhalten, m√ºssen Sie noch mehr pers√∂nliche Daten preisgeben</a></li>
<li><a href="../de486402/index.html">Backup Death: Neue Bedrohungen und neuer Schutz f√ºr den Global Cyber ‚Äã‚ÄãSummit 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>