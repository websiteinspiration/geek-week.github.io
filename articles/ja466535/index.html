<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤼 🎏 👨 deepCloneの再考 🙋🏾 👨🏽‍⚕️ 🥨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="JavaScriptで知っているように、オブジェクトは参照によってコピーされます。しかし、オブジェクトのディープクローニングを行う必要がある場合があります。多くのjsライブラリは、この場合のためのdeepClone関数の実装を提供しています。しかし、残念ながら、ほとんどのライブラリはいくつかの重要な...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>deepCloneの再考</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466535/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScriptで知っているように、オブジェクトは参照によってコピーされます。</font><font style="vertical-align: inherit;">しかし、オブジェクトのディープクローニングを行う必要がある場合があります。</font><font style="vertical-align: inherit;">多くのjsライブラリは、この場合のためのdeepClone関数の実装を提供しています。</font><font style="vertical-align: inherit;">しかし、残念ながら、ほとんどのライブラリはいくつかの重要なことを考慮していません：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列はオブジェクト内にある可能性があり、配列としてコピーすることをお勧めします</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトには、記号をキーとするフィールドがある場合があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトフィールドにデフォルト以外の記述子があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数はオブジェクトのフィールドに入れることができ、それらも複製する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトは最終的にObject.prototypeとは異なるプロトタイプを持ちます</font></font></li>
</ul><a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰にでも読めるように、私は完全なコードをネタバレの下に置きました</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepClone</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> ({
		<span class="hljs-string">'object'</span>: cloneObject,
		<span class="hljs-string">'function'</span>: cloneFunction<font></font>
	}[<span class="hljs-keyword">typeof</span> source] || clonePrimitive)(source)();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneObject</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> (<span class="hljs-built_in">Array</span>.isArray(source)<font></font>
		? <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> source.map(deepClone)<font></font>
		: clonePrototype(source, cloneFields(source, simpleFunctor({})))<font></font>
	);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneFunction</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> cloneFields(source, simpleFunctor(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> source.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);<font></font>
	}));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clonePrimitive</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> source;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simpleFunctor</span>(<span class="hljs-params">value</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">mapper</span> =&gt;</span> mapper ? simpleFunctor(mapper(value)) : value;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeCloneFieldReducer</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">destinationFunctor, field</span>) =&gt;</span> {
		<span class="hljs-keyword">const</span> descriptor = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(source, field);
		<span class="hljs-keyword">return</span> destinationFunctor(<span class="hljs-function"><span class="hljs-params">destination</span> =&gt;</span> <span class="hljs-built_in">Object</span>.defineProperty(destination, field, <span class="hljs-string">'value'</span> <span class="hljs-keyword">in</span> descriptor ? {<font></font>
			...descriptor,<font></font>
			<span class="hljs-attr">value</span>: deepClone(descriptor.value)<font></font>
		} : descriptor));<font></font>
	};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneFields</span>(<span class="hljs-params">source, destinationFunctor</span>) </span>{
	<span class="hljs-keyword">return</span> (<span class="hljs-built_in">Object</span>.getOwnPropertyNames(source)<font></font>
		.concat(<span class="hljs-built_in">Object</span>.getOwnPropertySymbols(source))<font></font>
		.reduce(makeCloneFieldReducer(source), destinationFunctor)<font></font>
	);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clonePrototype</span>(<span class="hljs-params">source, destinationFunctor</span>) </span>{
	<span class="hljs-keyword">return</span> destinationFunctor(<span class="hljs-function"><span class="hljs-params">destination</span> =&gt;</span> <span class="hljs-built_in">Object</span>.setPrototypeOf(destination, <span class="hljs-built_in">Object</span>.getPrototypeOf(source)));<font></font>
}<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の実装は、信頼性、安定性、シンプルさを提供する関数形式で記述されています。しかし、残念ながら、まだ多くの人が手順と疑似OOPから彼らの考えを再構築できないので、私は私の実装のすべての構築ブリックを説明します：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
deepClone関数自体が1つの引数source-クローン元のソースを受け取り、それを返します上記のすべての機能を備えたディープクローン：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepClone</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> ({
		<span class="hljs-string">'object'</span>: cloneObject,
		<span class="hljs-string">'function'</span>: cloneFunction<font></font>
	}[<span class="hljs-keyword">typeof</span> source] || clonePrimitive)(source)();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすべてが単純で、ソース内のデータのタイプに応じて、それを複製できる関数が選択され、ソース自体がそれに転送されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、返された結果は、ユーザーに返される前に、パラメーターなしの関数として呼び出されることにも注意してください。これは、補助関数の純粋さを損なうことなく変更できるように、クローンを作成する値を単純なファンクターにラップするために必要です。このファンクターの実装は次のとおりです。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simpleFunctor</span>(<span class="hljs-params">value</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">mapper</span> =&gt;</span> mapper ? simpleFunctor(mapper(value)) : value;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼は2つのことを行うことができます。マップ（マッパー関数が渡された場合）と抽出（何も渡されなかった場合）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、補助関数cloneObject、cloneFunction、clonePrimitiveを分析します。それぞれが特定のタイプのソースの引数を1つ取り、そのクローンを返します。</font><b><font style="vertical-align: inherit;">cloneObject</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の実装では</font><font style="vertical-align: inherit;">、配列もオブジェクト型であることを考慮に入れる必要があります。他の場合では、フィールドとプロトタイプを複製する必要があります。ここにその実装があります：</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneObject</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> (<span class="hljs-built_in">Array</span>.isArray(source)<font></font>
		? <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> source.map(deepClone)<font></font>
		: clonePrototype(source, cloneFields(source, simpleFunctor({})))<font></font>
	);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配列は、sliceメソッドを使用してコピーできますが、ディープクローニングがあり、配列にはプリミティブ値だけでなく、mapメソッドは、上記のdeepCloneを引数として使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のオブジェクトについては、新しいオブジェクトを作成して上記のファンクターでラップし、cloneFieldsヘルパー関数を使用してフィールド（および記述子）を複製し、次にclonePrototypeを使用してプロトタイプを複製します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下で説明するヘルパー関数。それまでの間、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloneFunction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の実装を検討して</font><b><font style="vertical-align: inherit;">ください</font></b><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneFunction</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> cloneFields(source, simpleFunctor(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> source.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);<font></font>
	}));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのロジックを持つ関数を複製することはできません。ただし、すべての引数とコンテキストでオリジナルを呼び出し、その結果を返す別の関数でそれをラップすることができます。そのような「クローン」は確かに元の機能をメモリに保持しますが、少し「重さ」を量って元のロジックを完全に再現します。 JSの関数は単に呼び出されるオブジェクトであるため、フィールドをそれ自体に格納できるため、クローンされた関数をファンクターでラップし、cloneFieldsを使用して元の関数からすべてのフィールドをコピーします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
潜在的に、関数にはFunction.prototypeとは異なるプロトタイプが含まれている可能性がありますが、この極端なケースは考慮していません。 FPの魅力の1つは、必要な機能を実装するために、既存の関数に新しいラッパーを簡単に追加できることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリミティブ値の複製に使用される</font><font style="vertical-align: inherit;">
最後のビルドkirpichek </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clonePrimitive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、プリミティブ値は値によって（または参照によってコピーされますが、JSエンジンの一部の実装では不変であるため）、単純にコピーできます。</font><font style="vertical-align: inherit;">しかし、純粋な値を取得することは期待されていないため、extractが引数なしで呼び出すことができるファンクタでラップされた値は、関数で値をラップします。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clonePrimitive</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> source;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、上記で使用した補助関数を実装します-clonePrototypeとcloneFields </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトタイプを複製するには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clonePrototype</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は単純にソースオブジェクトからプロトタイプを抽出し、結果のファンクターにマップ操作を実行して、ターゲットオブジェクトに設定します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clonePrototype</span>(<span class="hljs-params">source, destinationFunctor</span>) </span>{
	<span class="hljs-keyword">return</span> destinationFunctor(<span class="hljs-function"><span class="hljs-params">destination</span> =&gt;</span> <span class="hljs-built_in">Object</span>.setPrototypeOf(destination, <span class="hljs-built_in">Object</span>.getPrototypeOf(source)));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィールドの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複製</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><b><font style="vertical-align: inherit;">もう少し</font></b><font style="vertical-align: inherit;">複雑なので、</font><b><font style="vertical-align: inherit;">cloneFields</font></b><font style="vertical-align: inherit;">関数を2つ</font><font style="vertical-align: inherit;">に分割し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">外部関数は、すべての名前付きフィールドとすべてのシンボルフィールドを連結して、すべてのフィールドを受け取り、それらを補助関数によって作成されたレデューサーに通します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cloneFields</span>(<span class="hljs-params">source, destinationFunctor</span>) </span>{
	<span class="hljs-keyword">return</span> (<span class="hljs-built_in">Object</span>.getOwnPropertyNames(source)<font></font>
		.concat(<span class="hljs-built_in">Object</span>.getOwnPropertySymbols(source))<font></font>
		.reduce(makeCloneFieldReducer(source), destinationFunctor)<font></font>
	);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
makeCloneFieldReducerは、ソースオブジェクトのすべてのフィールドの配列のreduceメソッドに渡すことができるリデューサー関数を作成する必要があります。</font><font style="vertical-align: inherit;">バッテリーとして、ターゲットを格納するファンクターが使用されます。</font><font style="vertical-align: inherit;">レデューサーは、ソースオブジェクトのフィールドからハンドルを抽出し、それをターゲットオブジェクトのフィールドに割り当てる必要があります。</font><font style="vertical-align: inherit;">ただし、ここでは、値を使用する記述子とget / setを使用する記述子の2つのタイプがあることを考慮することが重要です。</font><font style="vertical-align: inherit;">明らかに、値は複製する必要がありますが、get / setではそのような必要はなく、そのような記述子をそのまま返すことができます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeCloneFieldReducer</span>(<span class="hljs-params">source</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">destinationFunctor, field</span>) =&gt;</span> {
		<span class="hljs-keyword">const</span> descriptor = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(source, field);
		<span class="hljs-keyword">return</span> destinationFunctor(<span class="hljs-function"><span class="hljs-params">destination</span> =&gt;</span> <span class="hljs-built_in">Object</span>.defineProperty(destination, field, <span class="hljs-string">'value'</span> <span class="hljs-keyword">in</span> descriptor ? {<font></font>
			...descriptor,<font></font>
			<span class="hljs-attr">value</span>: deepClone(descriptor.value)<font></font>
		} : descriptor));<font></font>
	};<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで全部です。</font><font style="vertical-align: inherit;">このようなdeepCloneの実装により、記事の冒頭で提起されたすべての問題が解決されます。</font><font style="vertical-align: inherit;">さらに、純粋な関数と1つのファンクタに基づいて構築されており、ラムダ計算に固有のすべての保証を提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、MapやSetなど、個別に複製する価値のある配列以外のコレクションには優れた動作を実装しなかったことにも注意します。</font><font style="vertical-align: inherit;">ただし、これが必要になる場合もあります。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja466521/index.html">C for Metal-Intelグラフィックスカードでのコンピューティング用の貴金属</a></li>
<li><a href="../ja466525/index.html">PSD iPhoneレイアウトとは何ですか？</a></li>
<li><a href="../ja466527/index.html">カピバラページオブジェクトを使用したウェブサイトユーザー機能のテスト</a></li>
<li><a href="../ja466529/index.html">JVMのコンパイルタイプ：ブラックマジックセッションの公開</a></li>
<li><a href="../ja466533/index.html">パスティルダ：結果</a></li>
<li><a href="../ja466537/index.html">本番環境でのJavaScriptモジュールの使用：現在の状況。パート1</a></li>
<li><a href="../ja466539/index.html">本番環境でのJavaScriptモジュールの使用：現在の状況。パート2</a></li>
<li><a href="../ja466541/index.html">DbToolを使用して.NETアプリケーションにデータベースをシードする（コア）</a></li>
<li><a href="../ja466543/index.html">Habr Weekly＃17 / SberbankのクレジットはAIによって承認される-恐ろしい、オープンソース製品の広告-疑わしい</a></li>
<li><a href="../ja466547/index.html">ハッピープログラマーの日</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>