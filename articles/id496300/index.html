<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôüÔ∏è üåå üòø Kode asynchronous di Startup ASP.NET Core: 4 cara untuk berkeliling GetAwaiter (). GetResult () üö∂üèª ü¶ã üì¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Karena mekanisme async / await diperkenalkan pada C # 5.0, kami telah secara konstan diajarkan dalam semua artikel dan dokumen bahwa menggunakan kode ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kode asynchronous di Startup ASP.NET Core: 4 cara untuk berkeliling GetAwaiter (). GetResult ()</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dodopizzadev/blog/496300/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Karena mekanisme async / await diperkenalkan pada C # 5.0, kami telah secara konstan diajarkan dalam semua artikel dan dokumen bahwa menggunakan kode asinkron dalam sinkron sangat buruk. </font><font style="vertical-align: inherit;">Dan mereka memanggil ketakutan seperti konstruksi GetAwaiter (). GetResult (). </font><font style="vertical-align: inherit;">Namun, ada satu kasus di mana programmer Microsoft sendiri tidak meremehkan desain ini.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yl/m9/nb/ylm9nbu--2sz9pzjxu-tgx8k5t4.png"><br>
 <a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latar belakang tentang tugas pekerjaan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami sekarang dalam proses transisi dari otentikasi lama ke OAuth 2.0, yang sudah menjadi standar dalam industri kami. </font><font style="vertical-align: inherit;">Layanan yang saya kerjakan sekarang telah menjadi percontohan untuk integrasi dengan sistem baru dan untuk transisi ke otentikasi JWT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama proses integrasi, kami bereksperimen, mempertimbangkan berbagai opsi, cara mengurangi beban pada penyedia token (IdentityServer dalam kasus kami) dan memastikan keandalan yang lebih besar dari keseluruhan sistem. </font><font style="vertical-align: inherit;">Menghubungkan validasi berbasis JWT ke ASP.NET Core sangat sederhana dan tidak terikat dengan implementasi spesifik dari penyedia token:</font></font><br>
<br>
<pre><code class="cs hljs">services<font></font>
      .AddAuthentication()<font></font>
      .AddJwtBearer(); <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi apa yang tersembunyi di balik dua garis ini? </font><font style="vertical-align: inherit;">Di bawah tenda mereka, JWTBearerHandler dibuat, yang sudah berurusan dengan JWT dari klien API.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fs/sx/ce/fssxce2duwjnem0_zgekkezhglm.jpeg" width="550"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaksi klien, API, dan penyedia token saat meminta</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ketika JWTBearerHandler menerima token dari klien, ia tidak mengirim token ke penyedia untuk validasi, melainkan meminta penyedia Signing Key - bagian publik dari kunci yang menandatangani token. Berdasarkan kunci ini, diverifikasi bahwa token ditandatangani oleh penyedia yang benar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di dalam JWTBearerHandler duduk HttpClient, yang berinteraksi dengan penyedia melalui jaringan. Tetapi, jika kami berasumsi bahwa Signing Key dari penyedia kami tidak berencana untuk sering berubah, maka Anda dapat mengambilnya sekali ketika Anda memulai aplikasi, cache diri Anda sendiri dan singkirkan permintaan jaringan yang konstan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mendapat kode ini untuk Signing Key:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthenticationBuilder <span class="hljs-title">AddJwtAuthentication</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> AuthenticationBuilder builder, AuthJwtOptions options</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> signingKeys = <span class="hljs-keyword">new</span> List&lt;SecurityKey&gt;();<font></font>
<font></font>
    <span class="hljs-keyword">var</span> jwtBearerOptions = <span class="hljs-keyword">new</span> JwtBearerOptions {Authority = options?.Authority};<font></font>
    <font></font>
    <span class="hljs-keyword">new</span> JwtBearerPostConfigureOptions().PostConfigure(<span class="hljs-keyword">string</span>.Empty, jwtBearerOptions);
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> config = jwtBearerOptions.ConfigurationManager<font></font>
            .GetConfigurationAsync(<span class="hljs-keyword">new</span> CancellationTokenSource(options?.AuthorityTimeoutInMs ?? <span class="hljs-number">5000</span>).Token)<font></font>
            .GetAwaiter().GetResult();<font></font>
        <span class="hljs-keyword">var</span> providerSigningKeys = config.SigningKeys;<font></font>
        signingKeys.AddRange(providerSigningKeys);<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception)<font></font>
    {<font></font>
        <span class="hljs-comment">// ignored</span><font></font>
    }<font></font>
<font></font>
    builder<font></font>
        .AddJwtBearer(options =&gt;<font></font>
        {<font></font>
            options.TokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters<font></font>
            {<font></font>
                <span class="hljs-comment">// ...</span><font></font>
                IssuerSigningKeys = signingKeys,<font></font>
                <span class="hljs-comment">// ...</span><font></font>
            };<font></font>
        });<font></font>
    <span class="hljs-keyword">return</span> builder;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada baris 12 kita bertemu .GetAwaiter (). GetResult (). </font><font style="vertical-align: inherit;">Itu karena AuthenticationBuilder dikonfigurasi di dalam ruang publik ConfigureServices (layanan IServiceCollection) {...} dari kelas Startup, dan metode ini tidak memiliki versi asinkron. </font><font style="vertical-align: inherit;">Masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dimulai dengan C # 7.1, kami memiliki Main asynchronous (). </font><font style="vertical-align: inherit;">Tetapi metode konfigurasi Startup tidak sinkron di Asp.NET Core belum dikirim. </font><font style="vertical-align: inherit;">Saya secara estetika terganggu untuk menulis GetAwaiter (). GetResult () (saya diajari untuk tidak melakukan ini!), Jadi saya online untuk mencari cara orang lain menangani masalah ini.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya terganggu oleh GetAwaiter (). GetResult (), tetapi Microsoft tidak</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu yang pertama saya menemukan opsi yang digunakan programmer Microsoft dalam tugas yang sama untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendapatkan rahasia dari Azure KeyVault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Jika Anda turun melalui beberapa lapisan abstraksi, maka kita akan melihat:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Load</span>(<span class="hljs-params"></span>)</span> =&gt; LoadAsync().ConfigureAwait(<span class="hljs-literal">false</span>).GetAwaiter().GetResult();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Halo lagi, GetAwaiter (). GetResult ()! </font><font style="vertical-align: inherit;">Apakah ada solusi lain? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah google singkat, saya menemukan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serangkaian artikel hebat oleh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Andrew Lock, yang setahun lalu memikirkan masalah yang sama dengan saya. </font><font style="vertical-align: inherit;">Bahkan untuk alasan yang sama - ia secara estetis tidak suka secara serentak memohon kode asinkron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, saya merekomendasikan semua orang yang tertarik dengan topik ini untuk membaca seluruh seri dari lima artikel oleh Andrew. </font><font style="vertical-align: inherit;">Di sana, ia menganalisis secara rinci tugas kerja yang mengarah ke masalah ini, kemudian mempertimbangkan beberapa pendekatan yang salah, dan baru kemudian menjelaskan solusi. </font><font style="vertical-align: inherit;">Dalam artikel saya, saya akan mencoba menyajikan penelitian singkatnya, lebih berkonsentrasi pada solusi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peran tugas asinkron dalam memulai layanan web</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambil langkah mundur untuk melihat seluruh gambar. </font><font style="vertical-align: inherit;">Apa masalah konseptual yang saya coba pecahkan, terlepas dari kerangka kerjanya?</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perlu untuk memulai layanan web sehingga memproses permintaan kliennya, tetapi ada serangkaian operasi (yang relatif) lama, yang tanpanya layanan tidak dapat menanggapi klien, atau jawabannya tidak akan benar.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh operasi tersebut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Validasi konfigurasi sangat diketik.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengisi cache.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koneksi awal ke database atau layanan lain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemuatan JIT dan perakitan (pemanasan layanan).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrasi Basis Data. </font><font style="vertical-align: inherit;">Ini adalah salah satu contoh Andrew Lock, tetapi dia sendiri mengakui bahwa bagaimanapun juga, operasi ini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak diinginkan ketika memulai layanan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin menemukan solusi yang akan memungkinkan Anda untuk melakukan tugas asinkron sewenang-wenang pada startup aplikasi, dan dengan cara alami untuk mereka, tanpa GetAwaiter (). GetResult (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas-tugas ini harus diselesaikan sebelum aplikasi mulai menerima permintaan, tetapi untuk pekerjaan mereka, mereka mungkin memerlukan konfigurasi dan layanan terdaftar dari aplikasi. </font><font style="vertical-align: inherit;">Oleh karena itu, tugas-tugas ini harus dilakukan setelah konfigurasi DI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ide ini dapat direpresentasikan dalam bentuk diagram:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/eh/ym/ncehymvjo0cm3yz5p3uq-uycvpq.jpeg"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solusi # 1: solusi kerja yang dapat membingungkan ahli waris</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi kerja pertama yang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ditawarkan oleh Lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
{<font></font>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
   {<font></font>
       IWebHost webHost = CreateWebHostBuilder(args).Build();<font></font>
<font></font>
       <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = webHost.Services.CreateScope())<font></font>
       {<font></font>
           <span class="hljs-comment">//   </span>
           <span class="hljs-keyword">var</span> myService = scope.ServiceProvider.GetRequiredService&lt;MyService&gt;();<font></font>
<font></font>
           <span class="hljs-keyword">await</span> myService.DoAsyncJob();<font></font>
       }<font></font>
<font></font>
       <span class="hljs-keyword">await</span> webHost.RunAsync();<font></font>
   }<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWebHostBuilder <span class="hljs-title">CreateWebHostBuilder</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span> =&gt;<font></font>
       WebHost.CreateDefaultBuilder(args)<font></font>
           .UseStartup&lt;Startup&gt;();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan ini dimungkinkan oleh munculnya Main asynchronous () dari C # 7.1. </font><font style="vertical-align: inherit;">Satu-satunya negatif adalah bahwa kami mentransfer bagian konfigurasi dari Startup.cs ke Program.cs. </font><font style="vertical-align: inherit;">Solusi non-standar untuk kerangka kerja ASP.NET dapat membingungkan seseorang yang akan mewarisi kode kami.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solusi # 2: sematkan operasi asinkron dalam DI</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, Andrew mengusulkan versi solusi yang lebih baik. </font><font style="vertical-align: inherit;">Antarmuka untuk tugas asinkron dinyatakan:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStartupTask</span><font></font>
{<font></font>
    <span class="hljs-function">Task <span class="hljs-title">ExecuteAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Serta metode ekstensi yang mendaftarkan tugas-tugas ini di DI:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServiceCollectionExtensions</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection AddStartupTask&lt;T&gt;(<span class="hljs-keyword">this</span> IServiceCollection services)
        <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span>, <span class="hljs-title">IStartupTask</span><font></font>
        =&gt; services.AddTransient&lt;IStartupTask, T&gt;();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, metode ekstensi lain dideklarasikan, sudah untuk IWebHost:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StartupTaskWebHostExtensions</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunWithTasksAsync</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IWebHost webHost, CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">//      DI</span>
        <span class="hljs-keyword">var</span> startupTasks = webHost.Services.GetServices&lt;IStartupTask&gt;();<font></font>
<font></font>
        <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> startupTask <span class="hljs-keyword">in</span> startupTasks)<font></font>
        {<font></font>
            <span class="hljs-keyword">await</span> startupTask.ExecuteAsync(cancellationToken);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">await</span> webHost.RunAsync(cancellationToken);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di Program.cs kita hanya mengubah satu baris. </font><font style="vertical-align: inherit;">Sebagai gantinya:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">await</span> CreateWebHostBuilder(args).Build().Run();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memanggil:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">await</span> CreateWebHostBuilder(args).Build().RunWithTasksAsync();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menurut pendapat saya, pendekatan hebat yang membuat bekerja dengan operasi lama setransparan mungkin saat memulai aplikasi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solusi # 3: bagi mereka yang beralih ke ASP.NET Core 3.x</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika Anda menggunakan ASP.NET Core 3.x, maka ada opsi lain. </font><font style="vertical-align: inherit;">Saya akan kembali merujuk ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel oleh Andrew Lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut adalah kode peluncuran WebHost dari ASP.NET Core 2.x:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebHost</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ... initial setup</span>
        <span class="hljs-keyword">await</span> Server.StartAsync(hostingApp, cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// Fire IApplicationLifetime.Started</span><font></font>
        _applicationLifetime?.NotifyStarted();<font></font>
<font></font>
        <span class="hljs-comment">// Fire IHostedService.Start</span>
        <span class="hljs-keyword">await</span> _hostedServiceExecutor.StartAsync(cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// ...remaining setup</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan inilah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metode yang sama</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di ASP.NET Core 3.0:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebHost</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ... initial setup</span><font></font>
<font></font>
        <span class="hljs-comment">// Fire IHostedService.Start</span>
        <span class="hljs-keyword">await</span> _hostedServiceExecutor.StartAsync(cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// ... more setup</span>
        <span class="hljs-keyword">await</span> Server.StartAsync(hostingApp, cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// Fire IApplicationLifetime.Started</span><font></font>
        _applicationLifetime?.NotifyStarted();<font></font>
<font></font>
        <span class="hljs-comment">// ...remaining setup</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam ASP.NET Core 3.x, HostedServices pertama kali diluncurkan dan hanya kemudian WebHost utama, dan sebelum itu justru sebaliknya. </font><font style="vertical-align: inherit;">Apa yang ini berikan pada kita? </font><font style="vertical-align: inherit;">Sekarang semua operasi asinkron dapat dipanggil di dalam metode StartAsync (CancellingToken) dari antarmuka IHostedService dan mencapai efek yang sama tanpa membuat antarmuka dan metode ekstensi yang terpisah.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solusi # 4: kisah pemeriksaan kesehatan dan Kubernet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seseorang bisa tenang dalam hal ini, tetapi ada pendekatan lain, dan tiba-tiba menjadi penting dalam kenyataan saat ini. Ini adalah penggunaan pemeriksaan kesehatan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ide dasarnya adalah memulai server Kestrel sedini mungkin untuk memberi tahu penyeimbang beban bahwa layanan siap menerima permintaan. Tetapi pada saat yang sama, semua permintaan pemeriksaan non-kesehatan akan mengembalikan 503 (Layanan Tidak Tersedia). Ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cukup </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">luas</font></a><font style="vertical-align: inherit;"> di situs Microsoft </font><font style="vertical-align: inherit;">tentang cara menggunakan pemeriksaan kesehatan di ASP.NET Core. Saya ingin mempertimbangkan pendekatan ini tanpa rincian khusus sebagaimana diterapkan pada tugas kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andrew Lock memiliki </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel terpisah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk pendekatan ini. Keuntungan utamanya adalah ia menghindari timeout jaringan.</font></font><br>
<blockquote> ,          ,    ,     .  Kestrel   ,       ,       ¬´   ¬ª.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya tidak akan memberikan di sini solusi lengkap Andrew Lock untuk pendekatan pemeriksaan kesehatan. Ini cukup banyak, tetapi tidak ada yang rumit di dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Singkatnya, saya akan memberi tahu Anda: Anda harus memulai layanan web tanpa menunggu selesainya operasi asinkron. Dalam hal ini, titik akhir pemeriksaan kesehatan harus mengetahui status operasi-operasi ini, mengeluarkan 503 ketika sedang dieksekusi, dan 200 ketika mereka telah selesai. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jujur, ketika saya mempelajari opsi ini, saya memiliki skeptisisme tertentu. Seluruh solusi tampak rumit dibandingkan dengan pendekatan sebelumnya. Dan jika kita menggambar analogi, maka ini adalah bagaimana menggunakan kembali </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pendekatan EAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan berlangganan acara, bukan async / tunggu yang sudah akrab.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi kemudian Kubernetes ikut bermain. </font><font style="vertical-align: inherit;">Dia memiliki konsep penyelidikan kesiapan sendiri. </font><font style="vertical-align: inherit;">Saya akan mengutip dari buku "Kubernetes in Action" dalam presentasi gratis saya:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selalu tentukan kesiapan pemeriksaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda tidak memiliki probe kesiapan, pod Anda menjadi titik akhir layanan hampir secara instan. </font><font style="vertical-align: inherit;">Jika aplikasi Anda terlalu lama bersiap untuk menerima permintaan masuk, permintaan klien untuk layanan ini juga akan memulai pod yang belum siap menerima koneksi masuk. </font><font style="vertical-align: inherit;">Akibatnya, klien akan menerima kesalahan "Sambungan ditolak".</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya melakukan percobaan sederhana: Saya membuat layanan ASP.NET Core 3 dengan tugas asinkron yang panjang di HostedService:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LongTaskHostedService</span> : <span class="hljs-title">IHostedService</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span><font></font>
    {<font></font>
            Console.WriteLine(<span class="hljs-string">"Long task started..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>, cancellationToken);<font></font>
            Console.WriteLine(<span class="hljs-string">"Long task finished."</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">StopAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span><font></font>
    {...}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika saya memulai layanan ini menggunakan minikube, dan kemudian menambah jumlahnya menjadi dua, dalam waktu 5 detik dari keterlambatan, setiap permintaan saya yang kedua tidak menghasilkan informasi yang berguna, tetapi ‚ÄúSambungan menolak‚Äù.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernet 1.16 UPD</font></font></b><div class="spoiler_text">    , ,   Kubernetes 1.16  startup probe (   ).     ,     readiness probe.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>.      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temuan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa kesimpulan yang bisa ditarik dari semua studi ini? </font><font style="vertical-align: inherit;">Mungkin setiap orang harus memutuskan untuk proyeknya solusi mana yang paling cocok. </font><font style="vertical-align: inherit;">Jika diasumsikan bahwa operasi asinkron tidak akan mengambil terlalu banyak waktu, dan klien memiliki semacam kebijakan coba lagi, maka Anda dapat menggunakan semua pendekatan, mulai dengan GetAwaiter (). GetResult () dan berakhir dengan IHostedService di ASP.NET Core 3.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sisi lain, jika Anda menggunakan Kubernetes dan operasi asinkron Anda dapat dilakukan untuk waktu yang lama, maka Anda tidak dapat melakukannya tanpa pemeriksaan kesehatan (alias kesiapan / penyelidikan startup).</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id496258/index.html">Holivar online: format baru untuk pertukaran pengalaman. Sabtu ini</a></li>
<li><a href="../id496260/index.html">Kiat keamanan siber untuk bekerja dari rumah</a></li>
<li><a href="../id496262/index.html">Mendapatkan ID CVE</a></li>
<li><a href="../id496268/index.html">Produk dan solusi jaringan Huawei Enterprise untuk pelanggan perusahaan pada tahun 2020</a></li>
<li><a href="../id496272/index.html">Privasi diferensial: membandingkan perpustakaan</a></li>
<li><a href="../id496302/index.html">Bagaimana tidak memberikan perusahaan Anda kepada peretas saat dia pergi. Kiat untuk Spesialis SOC</a></li>
<li><a href="../id496304/index.html">Bagaimana saya terus belajar UE4 saat membuat game saya</a></li>
<li><a href="../id496308/index.html">Buat peta kebisingan mulus</a></li>
<li><a href="../id499818/index.html">Pemasaran Telegram Uzbek</a></li>
<li><a href="../id499820/index.html">Mengapa kami memilih Kotlin sebagai salah satu bahasa target kami. Bagian 2: Kotlin Multiplatform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>