<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëã üèÇüèº üçß Procedural hydrology: dynamic simulation of rivers and lakes üí™üèª ‚ò£Ô∏è üë†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note: the full source code of the project is posted on Github [ here ]. The repository also contains detailed information on how to read and use the c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Procedural hydrology: dynamic simulation of rivers and lakes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498290/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/664/fbe/93d664fbe19ce63dfa6b60d9621d07ae.png"></div><blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> full source code of the project is posted on Github [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]. </font><font style="vertical-align: inherit;">The repository also contains detailed information on how to read and use the code.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After implementing the particle-based hydraulic erosion simulation, I decided that it would be possible to expand this concept to simulate other aspects of surface hydrology. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I researched the existing methods of procedural generation of rivers and lakes, but the results found did not suit me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main objective of many methods is to create river systems (very beautiful) using various algorithms (sometimes based on a previously created elevation map or inverse problem), but they lack a strong realistic relationship between the topography and hydrology. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, processing of the water model on the relief as a whole is considered on some resources and a simulation of highly complex fluids is used.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I will demonstrate my attempt to overcome these problems with a technique that extends the ability to simulate particle-based hydraulic erosion. </font><font style="vertical-align: inherit;">I will also explain how, in general, I solve the problem of ‚Äúwater on the relief‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my method, I strive both for simplicity and for realism at the cost of a slight increase in the complexity of the underlying erosion system. </font><font style="vertical-align: inherit;">I recommend reading my previous article about this system [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habr√©], because the new model is based on it.</font></font><br>
<a name="habracut"></a><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology6.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This system is capable of quickly generating a very realistic looking terrain with hydrology. </font><font style="vertical-align: inherit;">This video was rendered in real time. </font><font style="vertical-align: inherit;">The system is capable of generating an infinite number of such landscapes.</font></font></i><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explanation:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I am not a geologist, so I created the system based on my knowledge.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrology concept</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I want to create a generative system that can simulate many geographical phenomena, including:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">River and stream migration</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natural waterfalls</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canyon Formation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swelling of the soil and floodplain</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consequently, the systems of hydrology and topography must be dynamic and closely related. </font><font style="vertical-align: inherit;">The particle-based hydraulic erosion system already has the basic aspects necessary for this:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The relief affects the movement of water</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erosion and sedimentation affect the terrain</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, this system simulates the erosion caused by rain, but is not able to convey many other influences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a moving </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> water behaves differently.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a standing </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pool, the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> water behaves differently</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will often mention </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streams</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pools</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The assumption is made in the model that these are two-dimensional large-scale phenomena. </font><font style="vertical-align: inherit;">They greatly reduce the complexity of the model. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the above geographical phenomena can be conveyed using the model of flows and basins. </font><font style="vertical-align: inherit;">Ideally, they should borrow and enhance the realism of a particle-based system.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplified hydrological model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Storing information about flows and pools in one or more data structures (graphs, objects, etc.) is too complex and limiting our capabilities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, our hydrological model consists of two maps: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow </font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maps</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font><strong><font style="vertical-align: inherit;">basin maps</font></strong><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do not forget that they are modeled as 2D systems.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream and Pool Maps</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The flow map describes the flowing water on the surface (streams and rivers). </font><font style="vertical-align: inherit;">It stores the time-averaged particle positions on the map. </font><font style="vertical-align: inherit;">Old information is slowly being deleted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The basin map describes the still water on the surface (puddles, ponds, lakes, oceans). </font><font style="vertical-align: inherit;">It stores the depth of water in the corresponding position of the map.</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stream and pool maps are arrays of the same size as the height map.</font></font></blockquote><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/869/209/77f/86920977ff555d0cf5a2e0a923d79207.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relief with hydrological impact. </font><font style="vertical-align: inherit;">The layer of water in the render is taken from hydrological maps.</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0f1/2a1/1c2/0f12a11c2164cc93995a9f5599b1a7a9.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combined hydrological maps. </font><font style="vertical-align: inherit;">Light blue is a stream map; dark blue is a pool map. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These maps are generated and connected by particles moving water along the terrain. </font><font style="vertical-align: inherit;">Adding these hydrological maps also gives us time-independent information that allows for the interaction of particles with their simulation separately. </font><font style="vertical-align: inherit;">Particles can interact through the use of these cards to obtain parameters that affect their movement. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the stream map is displayed after passing through the ease-in-out function and is rendered on the terrain based on this. </font><font style="vertical-align: inherit;">To obtain finer / sharper flows (or to ignore lower values ‚Äã‚Äãon wide flat areas), this display can be modified or set threshold values ‚Äã‚Äãfor it.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Water as a particle</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Water is presented in the form of a discrete mass (‚Äúparticles‚Äù) having a volume and moving along the surface of the relief. </font><font style="vertical-align: inherit;">It has several parameters that affect its motion (friction, evaporation rate, deposition rate, etc.). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the basic data structure used to simulate hydrology. </font><font style="vertical-align: inherit;">Particles are </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not stored</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but are used only for interaction between maps of heights, flows and pools. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> concept of a particle is explained in more detail in a previous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">post</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habr√©] (and an infinite number of other resources).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrological cycle and map interaction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maps interact with each other through a hydrological cycle. </font><font style="vertical-align: inherit;">The hydrological cycle consists of the following steps:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a particle on the terrain</font></font></li>
<li><strong></strong>        (.. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">     </a>).</li>
<li>        ,                  <strong></strong>.</li>
<li>  ,           <strong></strong>.</li>
<li> ,     (    )      .</li>
<li>     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Throughout the system, there are only two algorithms: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descend (descent)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flood (flooding)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Descending particles change the map of flows, and flooding particles change the map of basins. </font><font style="vertical-align: inherit;">These algorithms are described in detail below.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/989/a81/2cb/989a812cb5d769edbb76fd5a284d18b1.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One-dimensional diagram of the hydrological model. </font><font style="vertical-align: inherit;">Particles are created on the terrain and cyclically processed by two algorithms: Descend and Flood. </font><font style="vertical-align: inherit;">In the process, the maps of the basins and flows change, in turn affecting the movement of particles.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below I will explain the full implementation of the system used to generate the results, and present code examples. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will only show relevant pieces of code. </font><font style="vertical-align: inherit;">More information can be found in the repository on Github. </font><font style="vertical-align: inherit;">All relevant parts of the code are in the ‚Äúwater.h‚Äù file.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Particle class</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The structure of the Drop particle is identical to the structure of the previous system. </font><font style="vertical-align: inherit;">Descend and flood are now members of the structure because they act on only one particle at a time.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Drop</span>{</span><font></font>
  <font></font>
  <span class="hljs-comment">//... constructors</span><font></font>
<font></font>
  <span class="hljs-keyword">int</span> index;                         <span class="hljs-comment">//Flat Array Index</span>
  glm::vec2 pos;                     <span class="hljs-comment">//2D Position</span>
  glm::vec2 speed = glm::vec2(<span class="hljs-number">0.0</span>);
  <span class="hljs-keyword">double</span> volume = <span class="hljs-number">1.0</span>;
  <span class="hljs-keyword">double</span> sediment = <span class="hljs-number">0.0</span>;<font></font>
<font></font>
  <span class="hljs-comment">//... parameters</span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> volumeFactor = <span class="hljs-number">100.0</span>; <span class="hljs-comment">//"Water Deposition Rate"</span><font></font>
<font></font>
  <span class="hljs-comment">//Hydrological Cycle Functions</span>
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">descend</span><span class="hljs-params">(<span class="hljs-keyword">double</span>* h, <span class="hljs-keyword">double</span>* stream, <span class="hljs-keyword">double</span>* pool, <span class="hljs-keyword">bool</span>* track, glm::ivec2 dim, <span class="hljs-keyword">double</span> scale)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">flood</span><span class="hljs-params">(<span class="hljs-keyword">double</span>* h, <span class="hljs-keyword">double</span>* pool, glm::ivec2 dim)</span></span>;<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An additional parameter is the volume factor, which determines how flooding transfers volume to the water level.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descent algorithm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The descent algorithm is almost the same as the simple particle erosion algorithm. </font><font style="vertical-align: inherit;">He receives additional input ‚Äútrack‚Äù - an array in which he writes all the positions visited by him. </font><font style="vertical-align: inherit;">An array is needed to build stream maps in the future.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Drop::descend</span><span class="hljs-params">(<span class="hljs-keyword">double</span>* h, <span class="hljs-keyword">double</span>* stream, <span class="hljs-keyword">double</span>* pool, <span class="hljs-keyword">bool</span>* track, glm::ivec2 dim, <span class="hljs-keyword">double</span> scale)</span></span>{<font></font>
<font></font>
  glm::ivec2 ipos; <font></font>
<font></font>
  <span class="hljs-keyword">while</span>(volume &gt; minVol){<font></font>
<font></font>
    ipos = pos; <span class="hljs-comment">//Initial Position</span>
    <span class="hljs-keyword">int</span> ind = ipos.x*dim.y+ipos.y; <span class="hljs-comment">//Flat Array Index</span><font></font>
<font></font>
    <span class="hljs-comment">//Register Position</span>
    track[ind] = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    <span class="hljs-comment">//...</span><font></font>
  }<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The set of parameters is modified by flow and pool maps:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//...</span>
  <span class="hljs-comment">//Effective Parameter Set</span>
  <span class="hljs-keyword">double</span> effD = depositionRate;
  <span class="hljs-keyword">double</span> effF = friction*(<span class="hljs-number">1.0</span><span class="hljs-number">-0.5</span>*stream[ind]);
  <span class="hljs-keyword">double</span> effR = evapRate*(<span class="hljs-number">1.0</span><span class="hljs-number">-0.2</span>*stream[ind]);
<span class="hljs-comment">//...</span></code></pre><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I found out that such a parameter change works well.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous system, particles could get out of this cycle and be destroyed only with complete evaporation or going beyond the boundaries of the relief. </font><font style="vertical-align: inherit;">Now two additional exit conditions have been added here:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//... nind is the next position after moving the particle</span><font></font>
  <font></font>
  <span class="hljs-comment">//Out-Of-Bounds</span>
  <span class="hljs-keyword">if</span>(!glm::all(glm::greaterThanEqual(pos, glm::vec2(<span class="hljs-number">0</span>))) ||<font></font>
     !glm::all(glm::lessThan((glm::ivec2)pos, dim))){<font></font>
       volume = <span class="hljs-number">0.0</span>;
       <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//Slow-Down</span>
  <span class="hljs-keyword">if</span>(stream[nind] &gt; <span class="hljs-number">0.5</span> &amp;&amp; length(acc) &lt; <span class="hljs-number">0.01</span>)
    <span class="hljs-keyword">break</span>;<font></font>
<font></font>
  <span class="hljs-comment">//Enter Pool</span>
  <span class="hljs-keyword">if</span>(pool[nind] &gt; <span class="hljs-number">0.0</span>)
    <span class="hljs-keyword">break</span>;<font></font>
<font></font>
<span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the particle does not have sufficient acceleration and is surrounded by other particles, or directly enters the pool, then it prematurely completes the descent with all its remaining volume and proceeds to the flooding algorithm.</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> overflow condition also resets the volume so that the particles do not go over to the flooding algorithm.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flooding algorithm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A particle with the remaining volume can flood from its current position. This happens if it stops descending (there is no acceleration) or enters an existing pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The flooding algorithm transfers the volume of the particle to the increased water level, changing the map of the basin. The technique is to incrementally increase the water level by a fraction of the particle‚Äôs volume using the ‚Äútest plane‚Äù. As the water level rises, the particle volume decreases.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c28/908/ebc/c28908ebc4f1efee43232578962beed2.gif"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flooding algorithm animation. The test plane and water level increase gradually, reducing the particle volume. If a leak is found, then the remaining volume moves to the leak point to perform the descent.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
At each step, we perform a flood-fill from the particle‚Äôs position (that is, recursively check the positions of neighbors), adding all positions located above the original plane (current water level) and below the test plane to the ‚Äúflood set‚Äù. This is the area of ‚Äã‚Äãrelief that is part of the pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the fill, we check for leaks. These are points from the set of flooding that are below the test plane AND of the original plane. If we find several leak points, we select the lowest one.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Drop::flood</span><span class="hljs-params">(<span class="hljs-keyword">double</span>* height, <span class="hljs-keyword">double</span>* pool, glm::ivec2 dim)</span></span>{<font></font>
<font></font>
  index = (<span class="hljs-keyword">int</span>)pos.x*dim.y + (<span class="hljs-keyword">int</span>)pos.y;
  <span class="hljs-keyword">double</span> plane = height[index] + pool[index];  <span class="hljs-comment">//Testing Plane</span>
  <span class="hljs-keyword">double</span> initialplane = plane;                 <span class="hljs-comment">//Water Level</span><font></font>
<font></font>
  <span class="hljs-comment">//Flood Set</span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-built_in">set</span>;
  <span class="hljs-keyword">int</span> fail = <span class="hljs-number">10</span>; <span class="hljs-comment">//Just in case...</span><font></font>
<font></font>
  <span class="hljs-comment">//Iterate while particle still has volume</span>
  <span class="hljs-keyword">while</span>(volume &gt; minVol &amp;&amp; fail){<font></font>
<font></font>
    <span class="hljs-built_in">set</span>.clear();
    <span class="hljs-keyword">bool</span> tried[dim.x*dim.y] = {<span class="hljs-literal">false</span>};<font></font>
<font></font>
    <span class="hljs-comment">//Lowest Drain</span>
    <span class="hljs-keyword">int</span> drain;
    <span class="hljs-keyword">bool</span> drainfound = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-comment">//Recursive Flood-Fill Function</span>
    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">int</span>)&gt; fill = [&amp;](<span class="hljs-keyword">int</span> i){<font></font>
<font></font>
      <span class="hljs-comment">//Out of Bounds</span>
      <span class="hljs-keyword">if</span>(i/dim.y &gt;= dim.x || i/dim.y &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span>(i%dim.y &gt;= dim.y || i%dim.y &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
<font></font>
      <span class="hljs-comment">//Position has been tried</span>
      <span class="hljs-keyword">if</span>(tried[i]) <span class="hljs-keyword">return</span>;<font></font>
      tried[i] = <span class="hljs-literal">true</span>;<font></font>
<font></font>
      <span class="hljs-comment">//Wall / Boundary of the Pool</span>
      <span class="hljs-keyword">if</span>(plane &lt; height[i] + pool[i]) <span class="hljs-keyword">return</span>;<font></font>
<font></font>
      <span class="hljs-comment">//Drainage Point</span>
      <span class="hljs-keyword">if</span>(initialplane &gt; height[i] + pool[i]){<font></font>
<font></font>
        <span class="hljs-comment">//No Drain yet</span>
        <span class="hljs-keyword">if</span>(!drainfound)<font></font>
          drain = i;<font></font>
<font></font>
        <span class="hljs-comment">//Lower Drain</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( pool[drain] + height[drain] &lt; pool[i] + height[i] )<font></font>
          drain = i;<font></font>
<font></font>
        drainfound = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">//No need to flood from here</span><font></font>
      }<font></font>
<font></font>
      <span class="hljs-comment">//Part of the Pool</span>
      <span class="hljs-built_in">set</span>.push_back(i);<font></font>
      fill(i+dim.y);    <span class="hljs-comment">//Fill Neighbors</span><font></font>
      fill(i-dim.y);<font></font>
      fill(i+<span class="hljs-number">1</span>);<font></font>
      fill(i<span class="hljs-number">-1</span>);<font></font>
      fill(i+dim.y+<span class="hljs-number">1</span>);  <span class="hljs-comment">//Diagonals (Improves Drainage)</span>
      fill(i-dim.y<span class="hljs-number">-1</span>);<font></font>
      fill(i+dim.y<span class="hljs-number">-1</span>);<font></font>
      fill(i-dim.y+<span class="hljs-number">1</span>);<font></font>
    };<font></font>
<font></font>
    <span class="hljs-comment">//Perform Flood</span><font></font>
    fill(index);<font></font>
<font></font>
    <span class="hljs-comment">//...</span></code></pre><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for simplicity, an eight </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-way fill algorithm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is used here </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the future, it will be possible to implement it more efficiently.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After identifying the many flooding and leak points, we change the water level and the pool map. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a leak point is found, we move the particle (and its ‚Äúoverflow‚Äù volume) to the leak point so that it can begin to descend again. </font><font style="vertical-align: inherit;">Then the water level goes down to the height of the leak point.</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">//...</span><font></font>
<font></font>
    <span class="hljs-comment">//Drainage Point</span>
    <span class="hljs-keyword">if</span>(drainfound){<font></font>
<font></font>
      <span class="hljs-comment">//Set the Particle Position</span><font></font>
      pos = glm::vec2(drain/dim.y, drain%dim.y);<font></font>
<font></font>
      <span class="hljs-comment">//Set the New Waterlevel (Slowly)</span>
      <span class="hljs-keyword">double</span> drainage = <span class="hljs-number">0.001</span>;<font></font>
      plane = (<span class="hljs-number">1.0</span>-drainage)*initialplane + drainage*(height[drain] + pool[drain]);<font></font>
<font></font>
      <span class="hljs-comment">//Compute the New Height</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; s: <span class="hljs-built_in">set</span>) <span class="hljs-comment">//Iterate over Set</span>
        pool[s] = (plane &gt; height[s])?(plane-height[s]):<span class="hljs-number">0.0</span>;<font></font>
<font></font>
      <span class="hljs-comment">//Remove some sediment</span>
      sediment *= <span class="hljs-number">0.1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//...</span></code></pre><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when water level decreases due to leakage, I found out that this works best with a low leakage rate. </font><font style="vertical-align: inherit;">In addition, the elimination of part of the sedimentary rocks helps the implementation.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to this, new particles entering the filled pool instantly move their volume to the leak point, because adding volume to the pool displaces the same volume from it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the leak point is not found, then we calculate the volume under the test plane and compare it with the volume of the particle. </font><font style="vertical-align: inherit;">If it is less, then we remove the volume from the particle and adjust the water level. </font><font style="vertical-align: inherit;">Then the test plane rises. </font><font style="vertical-align: inherit;">If it is larger, then the test plane is lowered. </font><font style="vertical-align: inherit;">The process is repeated until the particle runs out of space or a leak point is found.</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">//...</span><font></font>
<font></font>
    <span class="hljs-comment">//Get Volume under Plane</span>
    <span class="hljs-keyword">double</span> tVol = <span class="hljs-number">0.0</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; s: <span class="hljs-built_in">set</span>)<font></font>
      tVol += volumeFactor*(plane - (height[s]+pool[s]));<font></font>
<font></font>
    <span class="hljs-comment">//We can partially fill this volume</span>
    <span class="hljs-keyword">if</span>(tVol &lt;= volume &amp;&amp; initialplane &lt; plane){<font></font>
<font></font>
      <span class="hljs-comment">//Raise water level to plane height</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; s: <span class="hljs-built_in">set</span>)<font></font>
        pool[s] = plane - height[s];<font></font>
<font></font>
      <span class="hljs-comment">//Adjust Drop Volume</span><font></font>
      volume -= tVol;<font></font>
      tVol = <span class="hljs-number">0.0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//Plane was too high and we couldn't fill it</span>
    <span class="hljs-keyword">else</span> fail--;<font></font>
<font></font>
    <span class="hljs-comment">//Adjust Planes</span>
    <span class="hljs-keyword">float</span> approach = <span class="hljs-number">0.5</span>;<font></font>
    initialplane = (plane &gt; initialplane)?plane:initialplane;<font></font>
    plane += approach*(volume-tVol)/(<span class="hljs-keyword">double</span>)<span class="hljs-built_in">set</span>.size()/volumeFactor;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//Couldn't place the volume (for some reason)- so ignore this drop.</span>
  <span class="hljs-keyword">if</span>(fail == <span class="hljs-number">0</span>)<font></font>
    volume = <span class="hljs-number">0.0</span>;<font></font>
<font></font>
} <span class="hljs-comment">//End of Flood Algorithm</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The height of the plane is adjusted in proportion to the difference in volumes scaled by the surface area of ‚Äã‚Äãthe pool (i.e., by the size of the set). </font><font style="vertical-align: inherit;">By using the proximity coefficient, you can increase the stability of how the plane reaches the correct water level.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erosion wrap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The world class contains all three maps in the form of ordinary arrays:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">World</span> {</span><font></font>
<font></font>
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">generate</span><span class="hljs-params">()</span></span>;            <span class="hljs-comment">//Initialize</span>
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">erode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> cycles)</span></span>;     <span class="hljs-comment">//Erode with N Particles</span><font></font>
<font></font>
  <span class="hljs-comment">//...</span><font></font>
<font></font>
  <span class="hljs-keyword">double</span> heightmap[<span class="hljs-number">256</span>*<span class="hljs-number">256</span>] = {<span class="hljs-number">0.0</span>};
  <span class="hljs-keyword">double</span> waterstream[<span class="hljs-number">256</span>*<span class="hljs-number">256</span>] = {<span class="hljs-number">0.0</span>};
  <span class="hljs-keyword">double</span> waterpool[<span class="hljs-number">256</span>*<span class="hljs-number">256</span>] = {<span class="hljs-number">0.0</span>};<font></font>
<font></font>
};</code></pre><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The height map is initialized using Perlin noise.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each hydrological step for an individual particle consists of the following:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//...</span><font></font>
<font></font>
<span class="hljs-comment">//Spawn Particle</span>
glm::vec2 newpos = glm::vec2(rand()%(<span class="hljs-keyword">int</span>)dim.x, rand()%(<span class="hljs-keyword">int</span>)dim.y);
<span class="hljs-function">Drop <span class="hljs-title">drop</span><span class="hljs-params">(newpos)</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">int</span> spill = <span class="hljs-number">5</span>;
<span class="hljs-keyword">while</span>(drop.volume &gt; drop.minVol &amp;&amp; spill != <span class="hljs-number">0</span>){<font></font>
<font></font>
  drop.descend(heightmap, waterstream, waterpool, track, dim, scale);<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(drop.volume &gt; drop.minVol)<font></font>
    drop.flood(heightmap, waterpool, dim);<font></font>
<font></font>
  spill--;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The spill parameter determines how many times a particle can enter the pool and leave it again before it is simply destroyed. </font><font style="vertical-align: inherit;">Otherwise, the particles die when their volume is depleted.</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> particles rarely enter the pools and leave them more than one or two times before they completely evaporate during the descent stages, but I added this just in case.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The erosion function wraps this code and performs hydrological steps for N particles, directly changing the flow map:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">World::erode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> N)</span></span>{<font></font>
<font></font>
  <span class="hljs-comment">//Track the Movement of all Particles</span>
  <span class="hljs-keyword">bool</span> track[dim.x*dim.y] = {<span class="hljs-literal">false</span>};<font></font>
<font></font>
  <span class="hljs-comment">//Simulate N Particles</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++){<font></font>
   <font></font>
    <span class="hljs-comment">//... simulate individual particle</span><font></font>
<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//Update Path</span>
  <span class="hljs-keyword">double</span> lrate = <span class="hljs-number">0.01</span>;  <span class="hljs-comment">//Adaptation Rate</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; dim.x*dim.y; i++)<font></font>
    waterstream[i] = (<span class="hljs-number">1.0</span>-lrate)*waterstream[i] + lrate*((track[i])?<span class="hljs-number">1.0</span>:<span class="hljs-number">0.0</span>);<font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the track array is passed to the descent function. </font><font style="vertical-align: inherit;">I found that simultaneously tracking the movement of several particles and corresponding changes provide improved results for the flow map. </font><font style="vertical-align: inherit;">The adaptation rate determines how quickly old information is deleted.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trees</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just for fun, I added trees to see if the erosion simulation could be further improved. </font><font style="vertical-align: inherit;">They are stored in the world classroom as a vector. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trees are randomly created on the map in places where there are no pools and strong streams, and the terrain is not very steep. </font><font style="vertical-align: inherit;">They also have a chance to create additional trees around themselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the process of creating trees, they write to the density map of vegetation in a certain radius around them. </font><font style="vertical-align: inherit;">High vegetation density reduces mass transfer between descending particles and topography. </font><font style="vertical-align: inherit;">This is to simulate how the roots hold the soil in place.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//... descend function</span>
<span class="hljs-keyword">double</span> effD = depositionRate*max(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>-treedensity[ind]);
<span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trees die if they are in the pool, or the stream below them is too powerful. </font><font style="vertical-align: inherit;">In addition, they have a random probability of death.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/trees.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to shading and normal maps, even very simple tree sprites make the relief more beautiful.</font></font></i><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the tree model can be found in the file "vegetation.h" and in the function "World :: grow ()".</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other details</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results are visualized using a home-made OpenGL wrapper, which is laid out [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ].</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">results</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Particles can be created on the map according to any distribution you need. </font><font style="vertical-align: inherit;">In my demos, I created them with a uniform distribution on 256 √ó 256 cards. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As can be seen below, the resulting simulation is highly dependent on the choice of the original relief. </font><font style="vertical-align: inherit;">The system is able to simulate a large number of natural phenomena. </font><font style="vertical-align: inherit;">I could not adequately get only canyons. </font><font style="vertical-align: inherit;">They may need a very long and slow simulation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other phenomena can be observed in the system, such as waterfalls, tortuosity and river deltas, lakes, soil swelling, and so on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system is also very good at distributing flows and pools in places where a lot of rain accumulates, and not in random places. </font><font style="vertical-align: inherit;">Therefore, the generated hydrology is closely related to the terrain.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="http://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/rivererosion.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Real-time hydrological simulation on a 256 √ó 256 grid. </font><font style="vertical-align: inherit;">The original relief is relatively smooth, which allows streams to appear quickly. </font><font style="vertical-align: inherit;">At the very beginning, one can observe the simplest creation of pools and leaks, after which large flows appear and remain.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparison of the effects of narrowing flows</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To compare the difference created by linking a map to an erosion system, you can simulate hydrology on the same map, including and disabling various effects. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I simulated the same terrain three times:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Particle-based erosion (basic erosion) that receives flow and pool maps. </font><font style="vertical-align: inherit;">Pools still affect generation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basic erosion with parameters changed by hydrological maps (in combination with erosion)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combined erosion with parameters changed by hydrological maps and affecting erosion by trees</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this is a rather chaotic system, and the type of hydrology that appears is highly dependent on the terrain. </font><font style="vertical-align: inherit;">It is difficult to find a "very revealing" example of a relief.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/39e/e81/65c/39ee8165c1b4a8ca4f8a987e12464de4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relief rendering of the base system</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/969/6b2/fc0/9696b2fc03defb56681b7bfff7fa6740.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combined system elevation render</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/868/d7f/8bc/868d7f8bcd087c968833ba0a4c99619c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render of the topography of a system with trees</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
An interesting observation: the combination of hydrological maps with particle parameters actually narrows the river beds. </font><font style="vertical-align: inherit;">Particularly in planar regions, particles are less distributed and merge into a small amount of stronger flows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reduced friction and evaporation successfully cope with the fact that particles begin to prefer already existing channels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other effects are more visible with direct observation of the relief.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9a5/acd/d6b/9a5acdd6b7130655c66c716d0b713ec2.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrological map of the base system</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5df/f5a/575/5dff5a575ae295091062b6e2153694ff.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrological map of the combined system</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9d0/acb/8fa/9d0acb8fa508aa24afab3a5dddacf7a5.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrological map of the system with trees </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> these results were generated in exactly 60 seconds of the simulation time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trees additionally affect narrowing. </font><font style="vertical-align: inherit;">They enhance the process of cutting out clear paths in steep areas. </font><font style="vertical-align: inherit;">They force the streams to remain in the already laid channels, and therefore reduce the tortuosity. </font><font style="vertical-align: inherit;">Thus, the location of trees affects the movement of water.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Example_Hydrology2.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of recording how the location of trees can help maintain the location of streams </font><font style="vertical-align: inherit;">This is the same relief as before, with all activated effects.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pool Impact</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system for creating pools works well and allows several water bodies with different heights to exist on the same relief. </font><font style="vertical-align: inherit;">They can also spill out into one another and empty out.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Pooling-1.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of a video of the formation of pools on a rougher baseline relief with a large elevation difference. </font><font style="vertical-align: inherit;">The upper lake is physically located above the lower one and discharges the resulting water directly into the lower lake.</font></font></i><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I got several seeds, in which three lakes flowed into each other sequentially, but I did not want to spend a lot of time finding the right one for this article. </font><font style="vertical-align: inherit;">I already generated too many pictures and videos.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From time to time, the height level of the pool jumps. </font><font style="vertical-align: inherit;">I think this happens when the water level is close to the level of leakage and a lot of water is added. </font><font style="vertical-align: inherit;">This effect can be reduced by reducing the leakage rate in the flooding function.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/475/469/f09/475469f09d224928863b2b2eaf48cfb8.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After another minute of generation, several new pools appeared on their own.</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/78a/36c/76e/78a36c76ed90db36cae64c47376fc585.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At a steeper angle, the difference in basin heights is more noticeable.</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac8/bd1/897/ac8bd18976e9cb06bd8d6d1fffd23667.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The hydrological map clearly shows that the central basin merges into the lower basin. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execution of the flooding algorithm leads to the fact that the pools see a "wall" at the border of the map. </font><font style="vertical-align: inherit;">This is noticeable in the images shown above. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another possible improvement could be the addition of sea level to the world so that the pools observe leaks at the edges of the map at sea level, otherwise they simply overflow.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation speed</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The time of each step of descent and flooding varies from particle to particle, but about one order of magnitude remains (about 1 microsecond). With steady flows, particles move around the map faster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flooding time varies in proportion to the size of the pool, because the pouring operation is the most costly step. The larger the pools, the larger the area for which you need to raise the water level. Large pools are definitely the bottleneck of the system. If you have ideas for increasing speed, let me know. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The descent time varies in proportion to the size of the map and many other parameters, including friction and evaporation rate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All videos in this article are recorded in real time, that is, in general, the simulation is fast.</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shortly after the publication of this article, I made a small change in the method of calculating surface normals, which increased the simulation speed. </font><font style="vertical-align: inherit;">The effect of this is very noticeable during the simulation, but it is difficult to benchmark it due to large variations in the time it takes to launch and flood. </font><font style="vertical-align: inherit;">According to my estimates, the simulation speed has doubled.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More beautiful videos</font></font></h3><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology1.mp4" type="video/mp4"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hydrology simulation on uneven vertical terrain.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology5.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A little smoother relief. </font><font style="vertical-align: inherit;">Some lakes turn out a little fluctuating a little.</font></font></i><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology3.mp4" type="video/mp4"></video></div></div></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hydrology simulation on a flat smooth terrain. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subsequent videos were recorded after speed improvement.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology10.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even flatter and smoother terrain.</font></font></i><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology7.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video with a river formed from several connected streams. </font><font style="vertical-align: inherit;">The main river has two points at which it incorporates smaller flows, and we see how it grows in size.</font></font></i><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://weigert.vsos.ethz.ch/wp-content/uploads/2020/04/Hydrology9.mp4" type="video/mp4"></video></div></div></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A more uneven relief with the formation of rivers. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I can go on forever.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion and work for the future</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This simple technique is still particle based, but it successfully manages to convey many additional effects. It provides an easy way to simulate large-scale water movement without fully simulating fluid dynamics. In addition, she works with an intuitive water model. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the simulations, we can observe the appearance of winding rivers, waterfalls, lakes and transfusions of lakes, rivers that divide into flat areas into deltas, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would be interesting to add different types of soil in the form of a soil map from which erosion parameters could be taken. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also easily change the tree system to create different types of trees that hold the soil in place.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is difficult to convey the variety of generated results in several pictures and videos, so you should try to do it yourself, it turns out very interesting. </font><font style="vertical-align: inherit;">I recommend experimenting with the original map parameters, including octave noise and map scale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have questions or comments, you can contact me. </font><font style="vertical-align: inherit;">I worked quite hard on this project, so my brains were sintering and I'm sure I missed some interesting aspects.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498278/index.html">Publisher Peter. Spring sale</a></li>
<li><a href="../en498280/index.html">The story of the Dodo bird from the genus Phoenix. The Great Fall of Dodo IS</a></li>
<li><a href="../en498282/index.html">[instruction] Creating an account and site on the Google Site platform</a></li>
<li><a href="../en498284/index.html">How to optimize learning English</a></li>
<li><a href="../en498288/index.html">Your city needs a metro bus</a></li>
<li><a href="../en498292/index.html">Save a lot of money on large volumes in PostgreSQL</a></li>
<li><a href="../en498294/index.html">Object Detection Recognize and rule. Part 1</a></li>
<li><a href="../en498296/index.html">Design at the system level. Part 1. From idea to system</a></li>
<li><a href="../en498298/index.html">Firms use bug bounties to buy hacker silence</a></li>
<li><a href="../en498300/index.html">Blitz.Engine: Asset System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>