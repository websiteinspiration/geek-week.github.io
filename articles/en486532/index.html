<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🤝‍👨🏽 🤶🏿 🍜 Data backup using a bunch of FreeFileSync and 7-zip 😆 🤕 🎽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anamnesis, so to speak: 
 
 Fujitsu rx300 s6 server, RAID6 of 6 1TB of disks, XenServer 6.2 is up, several servers are spinning, among them Ubunta wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Data backup using a bunch of FreeFileSync and 7-zip</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486532/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anamnesis, so to speak: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fujitsu rx300 s6 server, RAID6 of 6 1TB of disks, XenServer 6.2 is up, several servers are spinning, among them Ubunta with several balls, 3.5 million files, 1.5 TB of data, all this gradually grows and swells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Task: configure backup of data from the file server, partially daily, partially weekly. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have a Windows backup machine with RAID5 (in terms of poverty, a regular system unit with a RAID controller built into the mother) plus a separate 2TB disk for intermediate copying of the current state of files. You could use any Linux distribution, but this machine was already in stock with a raid array and a Windows license.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeFileSync</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the backup server </font><font style="vertical-align: inherit;">, configure the “mirror” of everything in a row from all the file server balls once a day in the evening after 18 hours by running through the scheduler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An important point: when saving a batch task, it is obligatory to mark “Close the task window at completion”, otherwise the processes will multiply and multiply. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We throw temporary files into mask exceptions: * .dwl, * .dwl2, * .tmp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FreeFileSync uses the network extremely well, copying takes several streams, the speed reaches 80 Mb / s when copying large files, no plugging was detected on small files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will carry out archiving already on the local backup server, instead of the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">TheCopier</font></a><font style="vertical-align: inherit;"> used earlier</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with archiving on a network. By the way, TheCopier is great! But with such volumes, it just doesn’t have time to transfer everything, despite the 1GB \ s interface on the backup and 2GB \ s on the file interface (bond of two network cards). </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">SyncToy was</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
also previously used </font><font style="vertical-align: inherit;">, but with the number of files more than 1.5-2 million, it stopped working normally, just could not cope. </font><font style="vertical-align: inherit;">
To archive the necessary folders, we write a batch file for </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">7-zip</font></a><font style="vertical-align: inherit;"> : </font><i><font style="vertical-align: inherit;">set now =% TIME: ~ 0, -3% </font></i><i><font style="vertical-align: inherit;">
set now =% now :: =.% </font></i><i><font style="vertical-align: inherit;">
Set now =% now: = 0% </font></i><i><font style="vertical-align: inherit;">
set now =% DATE: ~ - 4%.% DATE: ~ 3.2%.% DATE: ~ 0.2% _% now% </font></i><i><font style="vertical-align: inherit;">
C: \ "Program Files" \ 7-Zip \ 7z.exe a -tzip -mx = 1 -mmt = on -mtc = off -ssw D: \ backups \ All \% now% _10-04.zip E: \ 10-04</font></i></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<i><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_35-110.zip E:\35-110<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_asu.zip E:\asu<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_director.zip E:\director<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_gpr.zip E:\gpr<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_otiz.zip E:\otiz<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_ps.zip E:\ps<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_pto.zip E:\pto<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_rza.zip E:\rza<br>
C:\«Program Files»\7-Zip\7z.exe a -tzip -mx=1 -mmt=on -mtc=off -ssw D:\backups\All\%now%_smeta.zip E:\smeta<br>
<br>
:: a —  <br>
:: -tzip  -t7z —   ( zip  1.5-2   )<br>
:: -mx=1 —   (1 , 9   x=[0 | 1 | 3 | 5 | 7 | 9 ])<br>
:: -mmt=on —      <br>
:: -mtc=off —     ( ,   ..)<br>
:: -ssw —   ,   <br>
:: -xr!.Sync* —    BtSync  ,  <br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The construction from set now =% and so on allows you to save the time record format in the file name without the problems that occurred when the day or month was less than 10, that is, we substitute the zero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment -xr! .Sync * is the vestigial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remnant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the originally used </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">BTSync</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Up to 500 GB and 700-800 thousand files, BTSync still worked nothing, synchronized on the fly, but at current volumes it was eating memory and processor resources both on the ubunt file server and on the Windows backup where it was launched by the service, and also simply raped a disk system with constant read-write. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although the archiver is also 7-zip, we archive it in zip format instead of the native 7z, because it is much faster, and there is practically no difference in compression with mx = 1, it has been tested by many experiments.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Archives are executed in turn. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cleaning the archive folder also occurs through the scheduled task using the fpurge utility, leaving the archives no older than a week. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we have a copy of the files for the previous day, as well as archives for the last week, FreeFileSync puts the deleted files in the trash.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486514/index.html">Weekend Reading: 10 materials about replicas of sound cards, open sound libraries and audio software</a></li>
<li><a href="../en486516/index.html">Scientists have found T cells that open up the promise of universal anti-cancer immune therapy</a></li>
<li><a href="../en486518/index.html">Like 20 years ago</a></li>
<li><a href="../en486528/index.html">This is the norm - 3: normal map types</a></li>
<li><a href="../en486530/index.html">Mainstream. Honorary Workers. Biographical novel</a></li>
<li><a href="../en486538/index.html">How I uploaded soft skills online and what it gave me</a></li>
<li><a href="../en486540/index.html">HighLoad ++, Mikhail Makurov, Maxim Chernetsov (Intersvyaz): Zabbix, 100kNVPS on one server</a></li>
<li><a href="../en486542/index.html">Parse the sound of a dial-up modem</a></li>
<li><a href="../en486544/index.html">Two hours and 3.5 dollars. How I made a simple site with visualization of the distribution of coronavirus</a></li>
<li><a href="../en486548/index.html">Primitive recursive functions and Ackerman function</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>