<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßôüèº ‚è© üå† The evolution of Facebook webhook processing: from zero to 25,000 per second üõï üëÜüèø üëàüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most likely, no one needs to tell what webhooks are. But just in case: webhooks are a mechanism for reporting events in an external system. For exampl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The evolution of Facebook webhook processing: from zero to 25,000 per second</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Most likely, no one needs to tell what webhooks are. But just in case: webhooks are a mechanism for reporting events in an external system. For example, about buying in an online store through an online cashier, sending a code to a GitHub repository, or user actions in chats. In a typical API, you need to constantly query the server if the user wrote something in the chat. Using the webhook mechanism, you can "subscribe" to notifications, and the server itself will send an HTTP request when an event occurs. This is more convenient and faster than constantly requesting new data on the server.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat is a platform that helps businesses communicate with their customers via chat in instant messengers. Webhooks are one of the important parts of ManyChat, because it is through them that the business communicates with customers. And they communicate a lot - for example, through a system, businesses send billions of messages a month to their customers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most messages are sent via Facebook Messenger. It has a feature - a slow API. When a customer writes a message to order pizza, Facebook sends a webhook to ManyChat. The platform processes it, sends the request back and the user receives a message. Due to the slow API, some requests go a few seconds. But when the platform does not respond for a long time, the business loses the client, and Facebook can disconnect the application from webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, processing webhooks is one of the main engineering tasks of the platform. </font><font style="vertical-align: inherit;">To solve the problem, ManyChat changed its processing architecture several times over the course of three years from a simple controller in Yii to a distributed system with Galaxies. </font><font style="vertical-align: inherit;">Read more about this under the cut Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov leads development at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and has been professionally programming in PHP since 2001. </font><font style="vertical-align: inherit;">Dmitry will tell you how architecture has changed along with the growth of service and load, what solutions and technologies were applied at different stages, how webhook processing has evolved and how the platform manages to cope with a huge load using modest resources in PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. </font><font style="vertical-align: inherit;">The article is based on Dmitry's report ‚ÄúThe evolution of Facebook webhook processing: from zero to 12,500 per second‚Äù in </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But while he was preparing, indicators rose to 25,000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, I‚Äôll introduce you into the context of our tasks. ManyChat is a service that helps businesses use instant messengers for marketing, sales, and support. The main product is the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">platform for Messenger Marketing on Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For three years, more than 1 million businesses from 100 countries of the world used the service to communicate with 700 million of their customers. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the client side,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it looks like this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buttons, pictures and galleries in the dialogs in Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This is the Facebook Messenger interface. In addition to text messages, you can send interactive elements in it to interact with customers, engage in dialogue, increase interest in your products and sell. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the business side</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">everything looks different. </font><font style="vertical-align: inherit;">This is the interface of our web application where, using a visual interface, business representatives create and program dialogue scripts. </font><font style="vertical-align: inherit;">The picture is one example of a scenario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The heart of our system is the Flow Builder component. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The set of scripts and automation rules we call a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, to simplify, we can say that ManyChat is a bot designer. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of a bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client of the business that participates in the dialogue is called the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subscriber</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because for interaction the client </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subscribes to the bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why Facebook Messenger, we are the country of the surviving Telegram? </font><font style="vertical-align: inherit;">There are reasons for this.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     ‚Ññ1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interaction with Facebook is organized like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business uses a web application to configure the logic of the bot. </font><font style="vertical-align: inherit;">When a client interacts with the bot via the phone, Facebook receives information about this and sends us a webhook. </font><font style="vertical-align: inherit;">ManyChat processes it, depending on the logic that is programmed by the business, and sends the request back. </font><font style="vertical-align: inherit;">Then Facebook delivers the message to the user's phone.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technological stack</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We do all this on a modest stack. </font><font style="vertical-align: inherit;">At the core, of course, is PHP. </font><font style="vertical-align: inherit;">The web server runs Nginx, the main database is PostgreSQL, and there are also Redis and Elasticsearch. </font><font style="vertical-align: inherit;">It all spins in the Amazon Web Services clouds.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handling Facebook Webhook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is what Facebook‚Äôs webcam looks like: this is a request with payload in JSON format.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webhooks are only 10% of our load, but the most important part of the system. </font><font style="vertical-align: inherit;">Through them, the business communicates with users. </font><font style="vertical-align: inherit;">If messages slow down or are not sent, then the user refuses to interact with the bot, and the business loses the client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a look at the evolution of our architecture since the launch of the product. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">May 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We just launched our service: 20 bots, 10 of which are test ones, and 20 subscribers. </font><font style="vertical-align: inherit;">The load was 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The interaction scheme looked like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The request goes to nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx accesses PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM takes the application up to Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The webhook controller processes the logic and sends requests to Facebook in accordance with it.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bunch of Nginx and PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">June 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A month later, we announced ManyChat on ProductHunt and the number of bots increased to 2 thousand. </font><font style="vertical-align: inherit;">The number of subscribers has increased to 7 thousand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this moment, the first problem appeared in the system. </font><font style="vertical-align: inherit;">The Facebook API is not very fast: some requests can take several seconds, and several requests can take tens of seconds. </font><font style="vertical-align: inherit;">But the webhook server wants us to respond quickly. </font><font style="vertical-align: inherit;">Due to the slow API, we do not respond for a long time: the server first swears, and then it can completely disconnect the application from webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are few users, we are still developing the application, we are looking for our market, audience, and the load problem has already appeared. </font><font style="vertical-align: inherit;">But we were saved by a simple solution: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the moment when the controller starts, we interrupt the access to Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We tell Facebook that everything is fine, but in the background we process requests and webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queues on PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">December 2016. The</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service grew 5-10 times: 10 thousand bots and 700 thousand subscribers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, we worked on new tasks: displaying statistics, message delivery, conversion of impressions and transitions. </font><font style="vertical-align: inherit;">Also implemented Live Chat. </font><font style="vertical-align: inherit;">In addition to automating interactions, it gives businesses the ability to write messages directly to their subscriber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution to these problems increased the number of tracked hooks by 4 times. </font><font style="vertical-align: inherit;">For each message we sent, we received 3 additional webhooks. </font><font style="vertical-align: inherit;">The processing system needed to be improved again. </font><font style="vertical-align: inherit;">We are a small platform, only two people worked on the backend, so we chose the simplest solution - queues on PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We do not yet want to implement complex systems, so we simply share the processing flows. </font><font style="vertical-align: inherit;">Webhooks that need to be processed quickly so that the user receives a response are processed synchronously. </font><font style="vertical-align: inherit;">All the rest are sent in queues for asynchronous requests.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queues at Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">June 2017.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Service is growing: 75 thousand bots, 7 million subscribers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are implementing another new feature. All the webhooks that we processed concerned only communications in the messenger. But now we decided to give businesses the opportunity to communicate </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with subscribers of business pages</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and began to process new types of webhooks - those that relate to the feed of the page itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business page feeds are not infrequently updated. Marketers often post something, then they follow each like and count them. There is no huge traffic on business pages. But there are reverse situations, for example, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry is a famous American singer with a huge number of fans around the world. </font><font style="vertical-align: inherit;">There are 64 million subscribers in her Facebook group alone. </font><font style="vertical-align: inherit;">At some point, the singer‚Äôs marketers decided to make a bot on Facebook Messenger and chose our platform. </font><font style="vertical-align: inherit;">At that moment, when they published a message calling to subscribe to the bot, our load increased 3-4 times. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This situation helped us understand that without the normal implementation of the queues, we can do nothing. </font><font style="vertical-align: inherit;">As a solution, they chose Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choosing Redis for queues is a fantastically good decision.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He helped to solve a huge number of problems. Now every second through our Redis-cluster passes 1 million different requests. We use it not only for all cascading queues, but also for other tasks, for example, monitoring. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queues on Redis were not implemented on the first try. When we started just folding webhooks in Redis and processing them in one process, we expanded the funnel at the top: there were more incoming webhooks processed, too, but the process itself still took some time. This first decision was unsuccessful.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When they tried to scale the number of these requests, there was a slight collapse. The queue can accumulate requests from different pages, but requests from one page can go in a row. If one handler is slow, then requests from one subscriber and from one bot will be processed in the wrong order. The user sends messages, performs some actions with the bot, but receives a response randomly. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This seems to be a rare case, but testing on our workloads has shown that this will happen frequently. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We started looking for another solution. Here the simplicity and power of Redis came to the rescue - we decided to make a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue for each bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How it works? Messages that relate to each bot are added to the queue. In order not to raise the handler to each queue, we made a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">control queue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . She works like that. Each time a request comes from a bot, two messages are published in Redis: one in the bot's queue, the second in the control. The handler monitors the control and each time it starts the daemon when there is a task to process the bot. The demon rakes the queue of the corresponding bot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the main task, we solved the problem of ‚Äúnoisy neighbors‚Äù. This is when one bot generated a huge mass of webhooks and it slows down the system, because other pages are waiting for processing. To solve the problem, it is enough to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scale</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : when the control queue is full, we add new handlers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queues are virtual</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">These are just cells in Redis memory. </font><font style="vertical-align: inherit;">When there is nothing in the queue, it does not exist, it does not occupy anything.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">January 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We have reached 1 billion posts per month. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The load was 5 thousand RPS per system. This is not peak load, but standard. When bots of famous singers appear, everything grows several times already from this figure. But it's not a problem. The problem is in PHP-FPM: it can no longer withstand the load of 5 thousand RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everyone at that time was talking about fashionable asynchronous processing. We took a closer look at it, saw ReactPHP, conducted quick tests, replaced it with PHP-FPM and instantly got a 4-fold increase. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We did not rewrite the processing of our processing - ReactPHP raised the Yii framework. First, we raised 4 ReactPHP services, and later we reached 30. For a long time we lived on them, and the framework coped with the load.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as we expanded the funnel, another collapse occurred: after starting the funnel at the reception, processing began to suffer again. </font><font style="vertical-align: inherit;">To solve this problem already, we decided to separate processing into clusters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clusters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They took bots, distributed them into clusters and built logical chains from Redis, Postgres and a handler. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we have formed the concept of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúGalaxy‚Äù - a logical physical abstraction over processing</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It consists of instances: Redis, PostgreSQL and a set of PHP services. </font><font style="vertical-align: inherit;">Each bot belongs to a particular cluster, and ReactPHP knows which cluster the message for this bot needs to be placed in. </font><font style="vertical-align: inherit;">The scheme above works further. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Universe is expanding, the Universe of our systems too, and we add a new ‚ÄúGalaxy‚Äù when this happens.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Galaxies are our way of scaling.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replacing ReactPHP with a bunch of Nginx and Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the next six months, we continued to grow: 200 million subscribers and 3 billion messages per month. </font><font style="vertical-align: inherit;">Imagine a site for 200 million registered users - the same load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A new problem has arisen. </font><font style="vertical-align: inherit;">Webhooks are small tasks of the same type, and PHP is not suitable for solving them. </font><font style="vertical-align: inherit;">Even ReactPHP didn't help anymore.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He could not cope with the load of 10 thousand RPS - since the introduction of ReactPHP, the load has increased.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was necessary to restart it even with deployments, moreover, sequentially, because you can not interrupt the processing of incoming webhooks. </font><font style="vertical-align: inherit;">Facebook disables the application when it realizes that it has problems. </font><font style="vertical-align: inherit;">For ManyChat, this is a disaster - 650 thousand actively operating businesses will not forgive us.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we gradually bit off different logic from ReactPHP, passed it to the processors, and isolated new queues. In the process, they noticed that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP performs one simple task - it takes a webhook and puts it in a queue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . All the rest is done by processings. Are there any analogues for such a simple task? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remembered that Nginx has modules and noticed the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">. In addition to supporting the Lua programming language, she had a module for working with Redis. A test written in 3 hours showed that all the work of 30 services on ReactPHP can be done directly on the nginx side. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how it turned out: we process some kind of endpoint, pick up the request body and add it directly to Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty and Lua have helped increase throughput. </font><font style="vertical-align: inherit;">We continue to cope with our workload, the service lives on, everyone is happy.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Improving the solution on Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last stage ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">note: at the time of the report</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">February 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 million subscribers send and receive 7 million messages from a million bots every month. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a step to improve our solution on Lua. </font><font style="vertical-align: inherit;">Gradually bite off some logic from the queues, and transfer the primary processing of distributing webhooks between systems to Lua. </font><font style="vertical-align: inherit;">Now our systems are more productive and less dependent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We maintain </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separate processing and asynchronous processing</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Processing concerns statistics and other things - now it is a completely different system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system seems simple, but it is not. </font><font style="vertical-align: inherit;">Under the hood, there are 500 services that process their requests. </font><font style="vertical-align: inherit;">The whole system runs on 50 Amazon instances: Redis, PostgreSQL, and the PHP handlers themselves.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processing Evolution</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highload can be cool to do in PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Briefly recall how we did this in the process of developing the system.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Started with regular Nginx and PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added queues to PostgreSQL, and then to Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added clustering.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implemented ReactPHP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We replaced ReactPHP with a bunch of Nginx and Lua, and later moved the logic to the bunch.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From our experience, we found out that it is possible to grow and build architecture by successively changing vulnerable parts, using simple well-known approaches and at the same time not expanding the stack.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486844/">https://habr.com/ru/post/en486844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486824/index.html">Bad advice when working with ANTLR</a></li>
<li><a href="../en486826/index.html">Creating a full-fledged Viberbot on Django 2 and the Viber REST API. Part One - Webhook</a></li>
<li><a href="../en486828/index.html">Food Design Digest, January 2020</a></li>
<li><a href="../en486832/index.html">How many years taiga go - understand no</a></li>
<li><a href="../en486842/index.html">Consul + iptables =: 3</a></li>
<li><a href="../en486850/index.html">New reserved seat - like a capsule hotel</a></li>
<li><a href="../en486858/index.html">Creating a full-fledged Viberbot. Part two - first contact or "conversion_started"</a></li>
<li><a href="../en486860/index.html">ATX12VO - Eating a New Way</a></li>
<li><a href="../en486862/index.html">5 reasons why motion design helps you connect with people</a></li>
<li><a href="../en486864/index.html">Migrating from OpenVPN to WireGuard to join networks into one L2 network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>