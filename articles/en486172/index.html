<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî© ü§ôüèΩ üë∞ Deploy StatsD + Grafana Image in Docker and Kubernetes üî§ ‚öΩÔ∏è ‚¨ÖÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the beginning of my study of Docker and Kubernetes, I lacked a simple and understandable example with which I could ‚Äúplay around‚Äù while studying th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Deploy StatsD + Grafana Image in Docker and Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486172/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the beginning of my study of Docker and Kubernetes, I lacked a simple and understandable example with which I could ‚Äúplay around‚Äù while studying the features of this environment. I would like to close this gap with this article. Here I will talk about integrating .NET Core applications with Telegraf and Grafana, how metrics are sent and how to deploy to Docker and Kubernetes. The examples in the article are intended for those who begin to study this area, but it is desirable to have basic concepts in order to fully understand the article. It describes how to deploy a container that has StatsD, InfluxDB and Grafana, as well as how to send metrics of various types from the application.</font></font><br>
<a name="habracut"></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The examples in this article were run on Kubernetes coming with Docker for Windows. </font><font style="vertical-align: inherit;">But if you have Windows Home Edition, then you will not be able to install it. </font><font style="vertical-align: inherit;">If you have Windows Professional, then there should be no problems. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are a couple of tips for installing kubernetes on Windows. </font><font style="vertical-align: inherit;">Everything should work fine on Linux, tested on Ubuntu, 18.04 LTS.</font></font></blockquote><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demonstration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's see how everything I talk about looks in action. In this example, you run two applications: one sends requests to the other, the second performs some difficult task, and both applications send some StatsD metrics, which you will see in Grafana. Before completing the steps described here, you need to make sure that Kubernetes is installed on your computer. Then simply follow the instructions below and you will see some result. True, you will need to perform some settings yourself.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> git clone https://github.com/xtrmstep/DockerNetSample
<span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> .\DockerNetSample\
<span class="hljs-variable">$</span> kubectl apply <span class="hljs-operator">-f</span> .\src\StatsDServer\k8s<span class="hljs-literal">-deployment</span>.yaml
<span class="hljs-variable">$</span> .\build.ps1
<span class="hljs-variable">$</span> .\run.ps1
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in the browser you can download the </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> URL </font><b><font style="vertical-align: inherit;">: 3003</font></b><font style="vertical-align: inherit;"> and, using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root / root</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> credentials </font><font style="vertical-align: inherit;">, you can access the Grafana interface. </font><font style="vertical-align: inherit;">Metrics are already submitted, and you can try adding your dashboard. </font><font style="vertical-align: inherit;">After some tweaking, you can get something like this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6d/kk/ms/6dkkms7qvifd1vxbrjf2a7iwnuq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you decide to stop everything and clear the resources, just close the two windows with the workflows and run the following commands that will clear the objects in Kubernetes:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl delete svc stats<span class="hljs-literal">-tcp</span>
<span class="hljs-variable">$</span> kubectl delete svc stats<span class="hljs-literal">-udp</span>
<span class="hljs-variable">$</span> kubectl delete deployment stats
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's talk what happened.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You deployed StatsD, InfluxDb, and Grafana to local Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not so long ago I discovered that DockerHub has many useful and already prepared images. </font><font style="vertical-align: inherit;">In my example, I use one of these. </font><font style="vertical-align: inherit;">You can find the repository with the image </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This image contains InfluxDB, Telegraf (StatsD), and Grafana, which are already configured to work together. </font><font style="vertical-align: inherit;">There are two common ways to deploy images: the first is using docker-compose in Docker, and the second is deploying on Kubernetes. </font><font style="vertical-align: inherit;">Both methods make it possible to deploy several components (images) at once, describe network settings and other parameters. </font><font style="vertical-align: inherit;">I‚Äôll briefly talk about docker-compose, but dwell on the deployment in Kubernetes in more detail. </font><font style="vertical-align: inherit;">By the way, recently it became possible to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy docker-compose in Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy with Docker-Compose</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker-compose is distributed with Docker for Windows. But you need to check which version you can use in your YAML. To do this, you need to find out the version of the installed Docker and </font><font style="vertical-align: inherit;">find the desired version from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compatibility matrix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I installed Docker version </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">19.03.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so I can use the version </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.x</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. But I will use 2 for compatibility with previous versions of Docker. All the necessary information for writing docker-compose files is already in the repository description: image name and ports.</font></font><br>
<br>
<pre><code class="python hljs">version: <span class="hljs-string">'2'</span><font></font>
services:<font></font>
  stats:<font></font>
    image: samuelebistoletti/docker-statsd-influxdb-grafana:latest<font></font>
    ports:<font></font>
      - <span class="hljs-string">"3003:3003"</span>
      - <span class="hljs-string">"3004:8888"</span>
      - <span class="hljs-string">"8086:8086"</span>
      - <span class="hljs-string">"8125:8125/udp"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ports</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section, </font><font style="vertical-align: inherit;">I make visible the ports from the container through the ports of the host system. </font><font style="vertical-align: inherit;">If I do not, I will not be able to access the resources in the container from the host system, because they will only be visible inside Docker. </font><font style="vertical-align: inherit;">Roughly speaking, I cannot load Grafana in the browser. </font><font style="vertical-align: inherit;">You can read more about port mapping </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After compiling the file, you can deploy it. </font><font style="vertical-align: inherit;">By default, docker-compose looks for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose.yaml file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the current folder, so you can run it with minimal parameters by simply running the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose up command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This will expand the container in Docker. </font><font style="vertical-align: inherit;">I will use additional parameters to explicitly specify the file and start the container in the background.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> docker<span class="hljs-literal">-compose</span> <span class="hljs-operator">-f</span> docker<span class="hljs-literal">-compose</span>.yaml up <span class="hljs-literal">-d</span>
<span class="hljs-variable">$</span> docker<span class="hljs-literal">-compose</span> stop
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Deployment</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, deploying to Kubernetes looks a bit more complicated as you need to define Deployment, Service, and other parameters. I resort to a little trick that saves me time writing YAML files for Kubernetes. First, I deploy everything in a minimal configuration to the cluster using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubectl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And then I export the objects I need, like YAML and only then I add the necessary settings.</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A note on Kubernetes installed on virtual machines in GCP</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I tried to use Kubernetes, which is deployed on the Compute Engine in GCP and ran into a problem while deploying the LoadBalancer service. </font><font style="vertical-align: inherit;">It remains in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pending</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state </font><font style="vertical-align: inherit;">and does not receive an external IP address. </font><font style="vertical-align: inherit;">This circumstance prevents access to the service from the Internet, even if you have configured the network. </font><font style="vertical-align: inherit;">To do this, there is a solution that requires the installation of an ingress service and the use of NodePort, according to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advice on Stackoverflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
</blockquote> <h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy with kubectl</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, let's create a deployment from an image. </font><font style="vertical-align: inherit;">The name stats is the deployment name that I myself gave for this object. </font><font style="vertical-align: inherit;">You can use a different name.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl run stats -<span class="hljs-literal">-image</span>=samuelebistoletti/docker<span class="hljs-literal">-statsd</span><span class="hljs-literal">-influxdb</span><span class="hljs-literal">-grafana</span>:latest -<span class="hljs-literal">-image</span><span class="hljs-literal">-pull</span><span class="hljs-literal">-policy</span>=Always
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will create Deployment, which in turn will create Pod and ReplicaSet in k8s. </font><font style="vertical-align: inherit;">To get access to Grafana, I need to create a service and set up ports. </font><font style="vertical-align: inherit;">This can be done using the NodePort service or the LoadBalancer. </font><font style="vertical-align: inherit;">In most cases, you will create LoadBlancer services. </font><font style="vertical-align: inherit;">Read more about this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl expose deployment stats -<span class="hljs-literal">-type</span>=LoadBalancer -<span class="hljs-literal">-port</span>=<span class="hljs-number">3003</span> -<span class="hljs-literal">-target</span><span class="hljs-literal">-port</span>=<span class="hljs-number">3003</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will also map the host port 3003 ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--port</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) to the port in the container ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--target-port</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">After executing the command, you can access Grafana by loading the </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 3003</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> URL </font><font style="vertical-align: inherit;">in the browser. </font><font style="vertical-align: inherit;">You can check created objects in k8s with this command:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl get all
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You should see something like this picture:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rc/xe/cg/rcxecg7npeyrhg1sh-thgnf43zw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Export YAML configuration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, the deployed system is not yet what I need, but I can use it as a draft. </font><font style="vertical-align: inherit;">Export the YAML configuration:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl get deployment,service stats <span class="hljs-literal">-o</span> yaml -<span class="hljs-literal">-export</span> &gt; exported.yaml
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The exported file will contain the Deployment and Service definitions with the current configuration. </font><font style="vertical-align: inherit;">I will need to remove unnecessary settings and add port mapping. </font><font style="vertical-align: inherit;">The final minimalist version might look like this:</font></font><br>
<br>
<pre><code class="python hljs">apiVersion: extensions/v1beta1<font></font>
kind: Deployment<font></font>
metadata:<font></font>
  name: stats<font></font>
spec:<font></font>
  replicas: <span class="hljs-number">1</span><font></font>
  selector:<font></font>
    matchLabels:<font></font>
      run: stats<font></font>
  template:<font></font>
    metadata:<font></font>
      labels:<font></font>
        run: stats<font></font>
    spec:<font></font>
      containers:<font></font>
      - image: samuelebistoletti/docker-statsd-influxdb-grafana:latest<font></font>
        imagePullPolicy: Always<font></font>
        name: stats<font></font>
---<font></font>
apiVersion: v1<font></font>
kind: Service<font></font>
metadata:<font></font>
  name: stats-tcp<font></font>
spec:<font></font>
  type: LoadBalancer<font></font>
  ports:<font></font>
    - name: grafana<font></font>
      protocol: TCP<font></font>
      port: <span class="hljs-number">3003</span>
      targetPort: <span class="hljs-number">3003</span><font></font>
    - name: influxdb-admin<font></font>
      protocol: TCP<font></font>
      port: <span class="hljs-number">3004</span>
      targetPort: <span class="hljs-number">8888</span><font></font>
    - name: influxdb<font></font>
      protocol: TCP<font></font>
      port: <span class="hljs-number">8086</span>
      targetPort: <span class="hljs-number">8086</span><font></font>
  selector:<font></font>
    run: stats<font></font>
---<font></font>
apiVersion: v1<font></font>
kind: Service<font></font>
metadata:<font></font>
  name: stats-udp<font></font>
spec:<font></font>
  type: LoadBalancer<font></font>
  ports:<font></font>
    - name: telegraf<font></font>
      protocol: UDP<font></font>
      port: <span class="hljs-number">8125</span>
      targetPort: <span class="hljs-number">8125</span><font></font>
  selector:<font></font>
    run: stats<font></font>
</code></pre><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note on using TCP / UDP protocols</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You cannot create a service such as LoadBalancer that supports TCP and UDP. </font><font style="vertical-align: inherit;">This is a known limitation, and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">community is trying to find some solution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Meanwhile, you can create two separate services for each type of protocol.</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before using the new file, clear the existing resources in Kubernetes, and then use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubectl apply command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$</span> kubectl delete svc stats
<span class="hljs-variable">$</span> kubectl delete deployment stats<font></font>
<font></font>
<span class="hljs-variable">$</span> kubectl apply <span class="hljs-operator">-f</span> k8s<span class="hljs-literal">-deployment</span>.yaml
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You have just deployed an image in Kubernetes with the correct port settings. </font><font style="vertical-align: inherit;">Using the URL mentioned above, you can open Grafana, but now you can still send StatsD metrics. </font><font style="vertical-align: inherit;">In the next section I will talk a little about metrics.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StatsD Protocol</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The StatsD protocol is very simple, you can even create your own client library if you really need it. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can read more about StatsD datagrams. </font><font style="vertical-align: inherit;">This protocol supports metrics such as counters, time, timing, gauge, etc.</font></font><br>
<br>
<pre><code class="plaintext hljs">counter.name:1|c<font></font>
timing.name:320|ms<font></font>
gauge.name:333|g<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Counters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are used to count the number of some events. </font><font style="vertical-align: inherit;">Usually, you just always increment some counter (bucket in StatsD). </font><font style="vertical-align: inherit;">Aggregation is done at a lower level, so when you get the value in seconds, minutes, you do not have to do additional calculations, and in Grafana you will see the number in seconds, minutes and so on, as you wish. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timing is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used to measure the duration of a process. </font><font style="vertical-align: inherit;">For example, this metric is just perfect for measuring the duration of a web request. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gauge is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used to measure some current state of a resource. </font><font style="vertical-align: inherit;">For example, the amount of available memory or the number of free threads.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metrics in the .NET Core Service</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will need the NuGet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JustEat.StatsD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It has a good description on github. </font><font style="vertical-align: inherit;">So, just follow his instructions to make your own configuration and register with IoC. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, let's take the API, where some method, when called, queues threads using ThreadPool. </font><font style="vertical-align: inherit;">The API logic allows only a certain number of parallel computations. </font><font style="vertical-align: inherit;">Let's say you want to know the following about your service:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How many requests are coming?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How many requests are waiting before ThreadPool issues a thread?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How long does the operation take?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How fast do free threads end in the API?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what metrics collection might look like in code:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task&lt;FactorialReply&gt; <span class="hljs-title">Factorial</span>(<span class="hljs-params">FactorialRequest request, ServerCallContext context</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">// Obtain the number of available threads in ThreadPool</span>
    ThreadPool.GetAvailableThreads(<span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> availableThreads, <span class="hljs-keyword">out</span> _);
    <span class="hljs-comment">// The number of available threads is the example of Gauge metric</span>
    <span class="hljs-comment">// Send gauge metric to StatsD (using JustEat.StatsD nuget)</span>
    _stats.Gauge(availableThreads, <span class="hljs-string">"GaugeAvailableThreads"</span>);<font></font>
    <font></font>
    <span class="hljs-comment">// Increment a counter metric for incoming requests</span>
    _stats.Increment(<span class="hljs-string">"CountRequests"</span>);<font></font>
    <font></font>
    <span class="hljs-comment">// The method _stats.Time() will calculate the time while the _semaphoreSlim.WaitAsync() were waiting</span>
    <span class="hljs-comment">// and send the metric to StatsD</span>
    <span class="hljs-keyword">await</span> _stats.Time(<span class="hljs-string">"TimeWait"</span>, <span class="hljs-keyword">async</span> f =&gt; <span class="hljs-keyword">await</span> _semaphoreSlim.WaitAsync());<font></font>
<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-comment">// Again measure time length of calculation and send it to StatsD </span>
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _stats.Time(<span class="hljs-string">"TimeCalculation"</span>, <span class="hljs-keyword">async</span> t =&gt; <span class="hljs-keyword">await</span> CalculateFactorialAsync(request.Factor));<font></font>
<font></font>
        <span class="hljs-comment">// Increment a counter of processed requests</span>
        _stats.Increment(<span class="hljs-string">"CountProcessed"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> Task.FromResult(<span class="hljs-keyword">new</span> FactorialReply<font></font>
        {<font></font>
            Result = result<font></font>
        });<font></font>
    }<font></font>
    <span class="hljs-keyword">finally</span><font></font>
    {<font></font>
        _semaphoreSlim.Release();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the code, the number of simultaneous calculations is controlled by the SemaphoreSlim class. </font><font style="vertical-align: inherit;">If the number of parallel executions exceeds the maximum, it will stop execution and will wait for the completion of some other thread.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486172/">https://habr.com/ru/post/en486172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486156/index.html">As I taught, and then wrote a training manual in Python</a></li>
<li><a href="../en486158/index.html">Visualizing neural machine translation (seq2seq models with attention mechanism)</a></li>
<li><a href="../en486162/index.html">How important is the order of properties in JavaScript objects?</a></li>
<li><a href="../en486164/index.html">Coronavirus 2019-nCoV. FAQ on Respiratory Protection and Disinfection</a></li>
<li><a href="../en486170/index.html">Report "42". Big synopsis</a></li>
<li><a href="../en486174/index.html">I have zero turnover</a></li>
<li><a href="../en486176/index.html">Corporate Email Correspondence Memo</a></li>
<li><a href="../en486178/index.html">FOSS News No. 1 - review of free and open source news for January 27 - February 2, 2020</a></li>
<li><a href="../en486180/index.html">Tips and sources for creating serverless applications</a></li>
<li><a href="../en486184/index.html">How to use search effectively</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>