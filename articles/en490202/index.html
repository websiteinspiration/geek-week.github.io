<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå∂Ô∏è üëàüèª üå•Ô∏è Query Counting: Basic Django Performance Testing üëï ü¶ó üö®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. We have prepared a translation of another useful material for students of the course "Web-developer in Python" , which started yesterd...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Query Counting: Basic Django Performance Testing</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/490202/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">We have prepared a translation of another useful material for students of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Web-developer in Python"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which started yesterday.</font></font><br>
</b></i><br>
<br>
<img src="https://habrastorage.org/webt/-i/l9/rg/-il9rgpfjconn-on4udsprg5vyi.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can often hear about testing methods such as TDD, and how to test the business logic of an application. However, testing application performance is a completely different task. There are many different ways, but the most common approach is to create an environment in which you can conduct a DDoS attack on your application and observe its behavior. This is a very interesting topic, but this is not what I want to talk about today. Today we will look at a simpler test, one that you can do using the default Django unit tests: that is, testing the number of times your application accesses the database.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testing this is very simple, and this is exactly the aspect that can hurt application performance in the early stages. This aspect is the very first to be tested when something starts to work slowly. The good news is that there is only one thing you need to know to write tests of this kind: the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assertNumQueries</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">, and it is pretty easy to use. Here is an example:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above code claims that during the view, the </font></font><code>"trucks:list_trucks"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application will access the database only 6 times. But there is something else, note that before starting, we first create a new object </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and after that we say that </font></font><code>trucks_list</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is at least one object </font><font style="vertical-align: inherit;">in the context data of the view </font><font style="vertical-align: inherit;">. In this kind of tests, this is important because you need a guarantee that you are not testing on an empty data set. It‚Äôs important to understand that just instantiating a class is </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not enough. You need to check if it has been included in the context. Perhaps you are filtering the list of trucks, so it is likely that your instance </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will not be included in the result.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having done all of the above, we have already made significant progress, but there is another important step that is easy to forget about. If we want our views to scale, we must ensure that performance does not decrease as the number of returned items grows. In the end, we still have a performance problem if we turn to the database not 6 times to get one item, but 106 if we have 100 items. We need a constant number of database calls, which will not depend on the number of returned items. Fortunately, this problem is also solved very simply, we need to add one more (or several) elements to the database and again count the number of hits. This is how the test will look in the final version:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 2)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that we again check the number of items returned in the context, but on the second run we expect 2 trucks ( </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">The reason for this behavior is similar to the first case. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuring a constant number of calls to the database when adding new data is more priority than ensuring a small number of calls in general. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last thing to do is to make sure that your data is as hydrated as possible. </font><font style="vertical-align: inherit;">This means that you need to create related data that will be used during the processing of your view. </font><font style="vertical-align: inherit;">If you do not, there is a risk that your application will access the database more often in production than in the test (although it may succeed). </font><font style="vertical-align: inherit;">In our example, we needed to create </font></font><code>TruckDriver</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a company for our</font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from trucks.models import Truck, TruckDriver
...
        truck = Truck.objects.create(...)
        TruckDriver.objects.create(name="Alex", truck=truck)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the number of database calls is no longer constant after performing the steps described above, then look for more information about the </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select_related</font></font></a> </i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefetch_related</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> methods </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for today, I hope that from this moment on you will begin to check the number of queries of your application to the database at the very beginning of the project. </font><font style="vertical-align: inherit;">This will not take much time, but will prevent problems that may arise with the increase in the number of users of your application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, you can still </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catch the course</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">See you.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490186/index.html">What we made JET BI from. Architecture Business Intelligence System without lyric digressions</a></li>
<li><a href="../en490190/index.html">I'm going to search: host geo-positioning by IP address in the global Internet using the Binance crypto exchange as an example</a></li>
<li><a href="../en490194/index.html">Using RabbitMQ with MonsterMQ Part 4</a></li>
<li><a href="../en490196/index.html">[Flipper Zero] refuse Raspberry Pi, make our own board from scratch. Finding the right WiFi chip</a></li>
<li><a href="../en490198/index.html">Trust but verify! Demo zone with Epson projectors for home theater in the demo hall Pult.ru</a></li>
<li><a href="../en490204/index.html">The digest of events for HR and IT recruiters in March 2020</a></li>
<li><a href="../en490208/index.html">Backend section on DUMP2020: banter, fan, fail</a></li>
<li><a href="../en490210/index.html">Speeding up the frontend. When a lot of server requests are good</a></li>
<li><a href="../en490222/index.html">Death Day Standard Library</a></li>
<li><a href="../en490224/index.html">Fashionable stealth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>