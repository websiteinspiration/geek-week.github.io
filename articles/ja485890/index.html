<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•§ ğŸ“ˆ ğŸ’ Kerasã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨è©•ä¾¡ ğŸ‘´ ğŸ‘¨â€ğŸ”§ ğŸ‘©ğŸ¼â€âš–ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€2ã¤ã®ä¸€èˆ¬çš„ãªçŠ¶æ³ã§ã®TensorFlow 2.0ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€è©•ä¾¡ã€äºˆæ¸¬ï¼ˆçµè«–ï¼‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
 
 

- ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€å†…è”µã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æ¤œè¨¼ã®ãŸã‚ã®APIï¼ˆã®ã‚ˆã†ãªmodel.fit()ã€model.evaluate()ã€model.predict()ï¼‰...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kerasã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨è©•ä¾¡</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485890/"><img src="https://habrastorage.org/webt/gt/q2/58/gtq258bwdr1hxjw1fwbwup18j3i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€2ã¤ã®ä¸€èˆ¬çš„ãªçŠ¶æ³ã§ã®TensorFlow 2.0ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€è©•ä¾¡ã€äºˆæ¸¬ï¼ˆçµè«–ï¼‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€å†…è”µã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æ¤œè¨¼ã®ãŸã‚ã®APIï¼ˆã®ã‚ˆã†ãª</font></font><code>model.fit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><code>model.evaluate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><code>model.predict()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€</font><b><font style="vertical-align: inherit;">ã€Œçµ„ã¿è¾¼ã¿ã®å­¦ç¿’ãŠã‚ˆã³è©•ä¾¡ã‚µã‚¤ã‚¯ãƒ«ã®ä½¿ç”¨ã€</font></b><font style="vertical-align: inherit;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸»é¡Œã§ã™</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç†±å¿ƒãªå®Ÿè¡Œã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ã‚¼ãƒ­ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ—ã‚’è¨˜è¿°ã™ã‚‹å ´åˆ</font></font><code>GradientTape</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®å•é¡Œã«ã¤ã„ã¦ã¯ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€Œç‹¬è‡ªã®å­¦ç¿’ãŠã‚ˆã³è©•ä¾¡ã‚µã‚¤ã‚¯ãƒ«ã‚’æœ€åˆã‹ã‚‰ä½œæˆã™ã‚‹ã€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ã¦ã„ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬ã«ã€çµ„ã¿è¾¼ã¿ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã™ã‚‹ã‹ç‹¬è‡ªã®ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ã‹ã«é–¢ä¿‚ãªãã€ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã¨è©•ä¾¡ã¯ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—ã®Kerasãƒ¢ãƒ‡ãƒ«ã§ã¾ã£ãŸãåŒã˜ã‚ˆã†ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚FunctionalAPIã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚Œã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹åŒ–ã‚’ä½¿ç”¨ã—ã¦æœ€åˆã‹ã‚‰ä½œæˆã•ã‚ŒãŸã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãƒ¢ãƒ‡ãƒ«ã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å–ã‚Šä»˜ã‘</font></font></h2><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> absolute_import, division, print_function, unicode_literals<font></font>
<font></font>
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<font></font>
<font></font>
tf.keras.backend.clear_session()  <span class="hljs-comment"># #     .</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒ¼ãƒˆIï¼šçµ„ã¿è¾¼ã¿ã®å­¦ç¿’ãŠã‚ˆã³è©•ä¾¡ã‚µã‚¤ã‚¯ãƒ«ã®ä½¿ç”¨</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµ„ã¿è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã™ã‚‹å ´åˆã¯ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numpyé…åˆ—</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå°ã•ãã€ãƒ¡ãƒ¢ãƒªã«åã¾ã‚‹å ´åˆï¼‰ã€ã¾ãŸã¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dataset tf.data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹</font><b><font style="vertical-align: inherit;">å¿…è¦ãŒã‚ã‚Š</font></b><font style="vertical-align: inherit;">ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã®ã„ãã¤ã‹ã®æ®µè½ã§ã¯ã€MNISTãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’Numpyé…åˆ—ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã€æå¤±é–¢æ•°ã€ãŠã‚ˆã³ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®ä½¿ç”¨æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APIã®æ¦‚è¦ï¼šæœ€åˆã®å®Œå…¨ãªä¾‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆFunctional APIã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ã¾ã™ãŒã€ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ãƒ¢ãƒ‡ãƒ«ã§ã‚‚ã‚µãƒ–ã‚¯ãƒ©ã‚¹ãƒ¢ãƒ‡ãƒ«ã§ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ï¼‰ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras
<span class="hljs-keyword">from</span> tensorflow.keras <span class="hljs-keyword">import</span> layers<font></font>
<font></font>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¸å‹çš„ãªå®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸä¿ç•™ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ã€ãã—ã¦æœ€å¾Œã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã®è©•ä¾¡ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      </span><font></font>
(x_train, y_train), (x_test, y_test) = keras.datasets.mnist.load_data()<font></font>
<font></font>
<span class="hljs-comment">#   (  Numpy)</span>
x_train = x_train.reshape(<span class="hljs-number">60000</span>, <span class="hljs-number">784</span>).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span>
x_test = x_test.reshape(<span class="hljs-number">10000</span>, <span class="hljs-number">784</span>).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span><font></font>
<font></font>
y_train = y_train.astype(<span class="hljs-string">'float32'</span>)<font></font>
y_test = y_test.astype(<span class="hljs-string">'float32'</span>)<font></font>
<font></font>
<span class="hljs-comment">#  10,000   </span>
x_val = x_train[<span class="hljs-number">-10000</span>:]<font></font>
y_val = y_train[<span class="hljs-number">-10000</span>:]<font></font>
x_train = x_train[:<span class="hljs-number">-10000</span>]<font></font>
y_train = y_train[:<span class="hljs-number">-10000</span>]<font></font>
<font></font>
<span class="hljs-comment">#    (,  , )</span>
model.compile(optimizer=keras.optimizers.RMSprop(),  <span class="hljs-comment"># Optimizer</span>
              <span class="hljs-comment">#   </span><font></font>
              loss=keras.losses.SparseCategoricalCrossentropy(),<font></font>
              <span class="hljs-comment">#    </span><font></font>
              metrics=[keras.metrics.SparseCategoricalAccuracy()])<font></font>
<font></font>
<span class="hljs-comment">#      ""</span>
<span class="hljs-comment">#  "batch_size",   </span>
<span class="hljs-comment">#     ""</span>
print(<span class="hljs-string">'#     '</span>)<font></font>
history = model.fit(x_train, y_train,<font></font>
                    batch_size=<span class="hljs-number">64</span>,<font></font>
                    epochs=<span class="hljs-number">3</span>,
                    <span class="hljs-comment">#     </span>
                    <span class="hljs-comment">#       </span>
                    <span class="hljs-comment">#    </span><font></font>
                    validation_data=(x_val, y_val))<font></font>
<font></font>
<span class="hljs-comment">#   "history"  </span>
<span class="hljs-comment">#       </span>
print(<span class="hljs-string">'\nhistory dict:'</span>, history.history)<font></font>
<font></font>
<span class="hljs-comment">#     ,  "evaluate"</span>
print(<span class="hljs-string">'\n#    '</span>)<font></font>
results = model.evaluate(x_test, y_test, batch_size=<span class="hljs-number">128</span>)<font></font>
print(<span class="hljs-string">'test loss, test acc:'</span>, results)<font></font>
<font></font>
<span class="hljs-comment">#   ( -    )</span>
<span class="hljs-comment">#      "predict"</span>
print(<span class="hljs-string">'\n#    3 '</span>)<font></font>
predictions = model.predict(x_test[:<span class="hljs-number">3</span>])<font></font>
print(<span class="hljs-string">' :'</span>, predictions.shape)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æå¤±ã€ãƒ¡ãƒˆãƒªãƒƒã‚¯ã€ãŠã‚ˆã³ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®å®šç¾©</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã™ã‚‹ã«ã¯ã€æå¤±é–¢æ•°ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã€ãŠã‚ˆã³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç”¨ã®ã„ãã¤ã‹ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã‚Œã‚‰ã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™</font></font><code>compile()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs">model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=keras.losses.SparseCategoricalCrossentropy(),<font></font>
              metrics=[keras.metrics.SparseCategoricalAccuracy()])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¼•æ•°</font></font><code>metrics</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ãƒªã‚¹ãƒˆã¨ã—ã¦ä¸ãˆã‚‰ã‚Œã¾ã™-ãƒ¢ãƒ‡ãƒ«ã¯ä»»æ„ã®æ•°ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¢ãƒ‡ãƒ«ã«è¤‡æ•°ã®å‡ºåŠ›ãŒã‚ã‚‹å ´åˆã¯ã€å„å‡ºåŠ›ã«ç•°ãªã‚‹ãƒ¡ãƒˆãƒªãƒƒã‚¯ã¨æå¤±é–¢æ•°ã‚’è¨­å®šã—ã€ãƒ¢ãƒ‡ãƒ«æå¤±ã®åˆè¨ˆå€¤ã«å¯¾ã™ã‚‹å„å‡ºåŠ›ã®å¯„ä¸ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤šãã®å ´åˆã€æå¤±é–¢æ•°ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã¯æ–‡å­—åˆ—è­˜åˆ¥å­ã‚’ä½¿ç”¨ã—ã¦æŒ‡å®šã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,<font></font>
              metrics=[<span class="hljs-string">'sparse_categorical_accuracy'</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œã®å†åˆ©ç”¨ã®ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–¢æ•°ã«é…ç½®ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®ã‚¬ã‚¤ãƒ‰ã®åˆ¥ã®ä¾‹ã§ã¯ã€ãã‚Œã‚‰ã‚’æ•°å›å‘¼ã³å‡ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_uncompiled_model</span>():</span>
  inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
  x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
  x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
  outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
  model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
  <span class="hljs-keyword">return</span> model<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_compiled_model</span>():</span><font></font>
  model = get_uncompiled_model()<font></font>
  model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,<font></font>
              metrics=[<span class="hljs-string">'sparse_categorical_accuracy'</span>])
  <span class="hljs-keyword">return</span> model
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤šãã®çµ„ã¿è¾¼ã¿ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã€æå¤±é–¢æ•°ã€ãŠã‚ˆã³ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŸå‰‡ã¨ã—ã¦ã€ç‹¬è‡ªã®æå¤±é–¢æ•°ã€ãƒ¡ãƒˆãƒªãƒƒã‚¯ã€ã¾ãŸã¯ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã‚’æœ€åˆã‹ã‚‰ä½œæˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¿…è¦ãªã®ã¯ã€ãŠãã‚‰ãã™ã§ã«Keras APIã®ä¸€éƒ¨ã§ã‚ã‚‹</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã§ã‚ã‚‹ãŸã‚ã§ã™ã€‚</font></font><br>
<br>
<ul>
<li><code>SGD() </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆå‹¢ã„ã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãšï¼‰</font></font></li>
<li><code>RMSprop()</code></li>
<li><code>Adam()</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æå¤±é–¢æ•°ï¼š</font></font><br>
<br>
<ul>
<li><code>MeanSquaredError()</code></li>
<li><code>KLDivergence()</code></li>
<li><code>CosineSimilarity()</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æŒ‡æ¨™ï¼š</font></font><br>
<br>
<ul>
<li><code>AUC()</code></li>
<li><code>Precision()</code></li>
<li><code>Recall()</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚«ã‚¹ã‚¿ãƒ æå¤±é–¢æ•°</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kerasã§ã‚«ã‚¹ã‚¿ãƒ æå¤±é–¢æ•°ã‚’å–å¾—ã™ã‚‹ã«ã¯2ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®ä¾‹ã§ã¯ã€å…¥åŠ›</font></font><code>y_true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font><font style="vertical-align: inherit;">ã‚’å—ã‘å–ã‚Š</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã¨äºˆæ¸¬ã®é–“ã®å¹³å‡è·é›¢ã‚’è¨ˆç®—</font><font style="vertical-align: inherit;">ã™ã‚‹é–¢æ•°ãŒä½œæˆã•ã‚Œã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
 <br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">basic_loss_function</span>(<span class="hljs-params">y_true, y_pred</span>):</span>
    <span class="hljs-keyword">return</span> tf.math.reduce_mean(y_true - y_pred)<font></font>
<font></font>
model.compile(optimizer=keras.optimizers.Adam(),<font></font>
              loss=basic_loss_function)<font></font>
<font></font>
model.fit(x_train, y_train, batch_size=<span class="hljs-number">64</span>, epochs=<span class="hljs-number">3</span>)
</code></pre><br><font style="vertical-align: inherit;"></font><code>y_true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">
ä»¥å¤–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŒã¤æå¤±é–¢æ•°ãŒå¿…è¦ãªå ´åˆã¯</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã‚¯ãƒ©ã‚¹</font></font><code>tf.keras.losses.Loss</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’</font><font style="vertical-align: inherit;">ã‚µãƒ–ã‚¯ãƒ©ã‚¹åŒ–ã—ã¦</font><font style="vertical-align: inherit;">ã€æ¬¡ã®2ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…</font><font style="vertical-align: inherit;">ã§ã</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br>
<ul>
<li><code>__init__(self)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -æå¤±é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã¨ãã«æ¸¡ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹</font></font></li>
<li><code>call(self, y_true, y_pred)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-å›ç­”ï¼ˆ</font></font><code>y_true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã¨ãƒ¢ãƒ‡ãƒ«äºˆæ¸¬ï¼ˆ</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦</font><font style="vertical-align: inherit;">ãƒ¢ãƒ‡ãƒ«æå¤±ã‚’è¨ˆç®—ã™ã‚‹</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¸¡ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€</font><font style="vertical-align: inherit;">æå¤±ã®è¨ˆç®—</font></font><code>__init__()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ã«ä½¿ç”¨ã§ãã¾ã™</font></font><code>call()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®ä¾‹ã¯</font><font style="vertical-align: inherit;">ã€ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã¾ãŸã¯é–¢æ•°å…¨ä½“ã®æå¤±ãŒã‚¹ã‚«ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å¤‰æ›´ã§ãã‚‹å ´æ‰€</font></font><code>WeightedCrossEntropy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’è¨ˆç®—</font><font style="vertical-align: inherit;">ã™ã‚‹æå¤±é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™</font></font><code>BinaryCrossEntropy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeightedBinaryCrossEntropy</span>(<span class="hljs-params">keras.losses.Loss</span>):</span>
    <span class="hljs-string">"""
    Args:
      pos_weight:       .
      weight:      .
      from_logits:       .
      reduction:  tf.keras.losses.Reduction     .
      name:   .
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, pos_weight, weight, from_logits=False,
                 reduction=keras.losses.Reduction.AUTO,
                 name=<span class="hljs-string">'weighted_binary_crossentropy'</span></span>):</span><font></font>
        super(WeightedBinaryCrossEntropy, self).__init__(reduction=reduction,<font></font>
                                                         name=name)<font></font>
        self.pos_weight = pos_weight<font></font>
        self.weight = weight<font></font>
        self.from_logits = from_logits<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span>(<span class="hljs-params">self, y_true, y_pred</span>):</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.from_logits:
            <span class="hljs-comment">#    -.</span>
            <span class="hljs-comment">#   qz * -log(sigmoid(x)) + (1 - z) * -log(1 - sigmoid(x))</span>
            <span class="hljs-comment">#  z - , x - ,  q - .</span>
            <span class="hljs-comment">#      (   )</span>
            <span class="hljs-comment"># sigmoid(x)    y_pred</span><font></font>
<font></font>
            <span class="hljs-comment"># qz * -log(sigmoid(x)) 1e-6   ,      </span>
            x_1 = y_true * self.pos_weight * -tf.math.log(y_pred + <span class="hljs-number">1e-6</span>)<font></font>
<font></font>
            <span class="hljs-comment"># (1 - z) * -log(1 - sigmoid(x)).  ,      </span>
            x_2 = (<span class="hljs-number">1</span> - y_true) * -tf.math.log(<span class="hljs-number">1</span> - y_pred + <span class="hljs-number">1e-6</span>)<font></font>
<font></font>
            <span class="hljs-keyword">return</span> tf.add(x_1, x_2) * self.weight <font></font>
<font></font>
        <span class="hljs-comment">#   </span>
        <span class="hljs-keyword">return</span> tf.nn.weighted_cross_entropy_with_logits(y_true, y_pred, self.pos_weight) * self.weight<font></font>
<font></font>
<font></font>
model.compile(optimizer=keras.optimizers.Adam(),<font></font>
              loss=WeightedBinaryCrossEntropy(<span class="hljs-number">0.5</span>, <span class="hljs-number">2</span>))<font></font>
<font></font>
model.fit(x_train, y_train, batch_size=<span class="hljs-number">64</span>, epochs=<span class="hljs-number">3</span>)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªãƒƒã‚¯</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIã®ä¸€éƒ¨ã§ã¯ãªã„æŒ‡æ¨™ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚¯ãƒ©ã‚¹ã‚’ã‚µãƒ–ã‚¯ãƒ©ã‚¹åŒ–ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«ã‚«ã‚¹ã‚¿ãƒ æŒ‡æ¨™ã‚’ä½œæˆã§ãã¾ã™</font></font><code>Metric</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">4ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<ul>
<li><code>__init__(self)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã“ã§ã€ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®çŠ¶æ…‹å¤‰æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚</font></font></li>
<li><code>update_state(self, y_true, y_pred, sample_weight=None)</code><font style="vertical-align: inherit;"></font><code>y_true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¢ãƒ‡ãƒ«ã®</font><font style="vertical-align: inherit;">å¿œç­”</font><font style="vertical-align: inherit;">ã¨äºˆæ¸¬</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’</font><font style="vertical-align: inherit;">ä½¿ç”¨ã—ã¦</font><font style="vertical-align: inherit;">çŠ¶æ…‹å¤‰æ•°ã‚’æ›´æ–°ã—ã¾ã™ã€‚</font></font></li>
<li><code>result(self)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çŠ¶æ…‹å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦æœ€çµ‚çµæœã‚’è¨ˆç®—ã—ã¾ã™ã€‚</font></font></li>
<li><code>reset_states(self)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®çŠ¶æ…‹ã‚’å†åˆæœŸåŒ–ã—ã¾ã™ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€çµæœã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ï¼ˆã«åˆ¥ã€…ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹</font></font><code>update_state()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>result()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã„ãã¤ã‹ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€çµæœã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã¯éå¸¸ã«é«˜ä¾¡ã§ã‚ã‚‹ã“ã¨ãŒã§ãã€å‘¨æœŸçš„ã«ã®ã¿è¡Œã‚ã‚Œã‚‹ã®ã§ã€ãã‚Œã«å¿œã˜ã¦ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã“ã®ã‚¯ãƒ©ã‚¹ã«å±ã™ã‚‹ã‚‚ã®ã¨ã—ã¦æ­£ã—ãåˆ†é¡ã•ã‚ŒãŸè¦ç´ ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã™ã‚‹ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã™ç°¡å˜ãªä¾‹ã‚’æ¬¡ã«ç¤ºã—ã¾ã™</font></font><code>CategoricalTruePositives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CategoricalTruePositives</span>(<span class="hljs-params">keras.metrics.Metric</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, name=<span class="hljs-string">'categorical_true_positives'</span>, **kwargs</span>):</span><font></font>
      super(CategoricalTruePositives, self).__init__(name=name, **kwargs)<font></font>
      self.true_positives = self.add_weight(name=<span class="hljs-string">'tp'</span>, initializer=<span class="hljs-string">'zeros'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_state</span>(<span class="hljs-params">self, y_true, y_pred, sample_weight=None</span>):</span>
      y_pred = tf.reshape(tf.argmax(y_pred, axis=<span class="hljs-number">1</span>), shape=(<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>))<font></font>
      values = tf.cast(y_true, <span class="hljs-string">'int32'</span>) == tf.cast(y_pred, <span class="hljs-string">'int32'</span>)<font></font>
      values = tf.cast(values, <span class="hljs-string">'float32'</span>)
      <span class="hljs-keyword">if</span> sample_weight <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
        sample_weight = tf.cast(sample_weight, <span class="hljs-string">'float32'</span>)<font></font>
        values = tf.multiply(values, sample_weight)<font></font>
      self.true_positives.assign_add(tf.reduce_sum(values))<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span>(<span class="hljs-params">self</span>):</span>
      <span class="hljs-keyword">return</span> self.true_positives<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_states</span>(<span class="hljs-params">self</span>):</span>
      <span class="hljs-comment">#        .</span>
      self.true_positives.assign(<span class="hljs-number">0.</span>)<font></font>
<font></font>
<font></font>
model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=keras.losses.SparseCategoricalCrossentropy(),<font></font>
              metrics=[CategoricalTruePositives()])<font></font>
model.fit(x_train, y_train,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">3</span>)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¨™æº–ã®ç½²åã¨ä¸€è‡´ã—ãªã„æå¤±é–¢æ•°ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®å‡¦ç†</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æå¤±ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¤§åŠã¯ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹</font></font><code>y_true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å ´åˆã¯ã€</font></font><code>y_pred</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠä½¿ã„ã®ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã™ã¹ã¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€æ­£å‰‡åŒ–æå¤±ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã®ã¿ã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆãŒã‚ã‚Šï¼ˆã“ã®å ´åˆã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€¤ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€ã“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã¯ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›ã§ã¯ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚ˆã†ãªå ´åˆã€</font><font style="vertical-align: inherit;">ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼</font></font><code>self.add_loss(loss_value)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™</font></font><code>call</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã¯ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®æ­£å‰‡åŒ–ã‚’è¿½åŠ ã™ã‚‹ç°¡å˜ãªä¾‹ã§ã™ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®æ­£å‰‡åŒ–ã¯ã™ã¹ã¦ã®Kerasãƒ¬ã‚¤ãƒ¤ãƒ¼ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„-ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç‰¹å®šã®ä¾‹ã‚’ç¤ºã™ãŸã‚ã«ã®ã¿ä½¿ç”¨ã•ã‚Œã¾ã™ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActivityRegularizationLayer</span>(<span class="hljs-params">layers.Layer</span>):</span><font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span>(<span class="hljs-params">self, inputs</span>):</span>
    self.add_loss(tf.reduce_sum(inputs) * <span class="hljs-number">0.1</span>)
    <span class="hljs-keyword">return</span> inputs  <span class="hljs-comment"># Pass-through layer.</span><font></font>
<font></font>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
<font></font>
<span class="hljs-comment">#      </span><font></font>
x = ActivityRegularizationLayer()(x)<font></font>
<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>)<font></font>
<font></font>
<span class="hljs-comment">#       </span>
<span class="hljs-comment"># -  .</span><font></font>
model.fit(x_train, y_train,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">1</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ãƒˆãƒªãƒƒã‚¯å€¤ã®ãƒ­ã‚®ãƒ³ã‚°ã«ã¤ã„ã¦ã‚‚åŒã˜ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricLoggingLayer</span>(<span class="hljs-params">layers.Layer</span>):</span><font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span>(<span class="hljs-params">self, inputs</span>):</span>
    <span class="hljs-comment">#  `aggregation` </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-comment">#   :</span>
    <span class="hljs-comment">#       .</span><font></font>
    self.add_metric(keras.backend.std(inputs),<font></font>
                    name=<span class="hljs-string">'std_of_activation'</span>,<font></font>
                    aggregation=<span class="hljs-string">'mean'</span>)
    <span class="hljs-keyword">return</span> inputs  <span class="hljs-comment">#  .</span><font></font>
<font></font>
<font></font>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
<font></font>
<span class="hljs-comment">#   std   .</span><font></font>
x = MetricLoggingLayer()(x)<font></font>
<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
model.compile(optimizer=keras.optimizers.RMSprop(learning_rate=<span class="hljs-number">1e-3</span>),<font></font>
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>)<font></font>
model.fit(x_train, y_train,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">1</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ©Ÿèƒ½APIã§ã¯</font></font><code>model.add_loss(loss_tensor)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã¾ãŸã¯ã‚’</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™</font></font><code>model.add_metric(metric_tensor, name, aggregation)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã«ç°¡å˜ãªä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x1 = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
x2 = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x1)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x2)<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
<font></font>
model.add_loss(tf.reduce_sum(x1) * <span class="hljs-number">0.1</span>)<font></font>
<font></font>
model.add_metric(keras.backend.std(x1),<font></font>
                 name=<span class="hljs-string">'std_of_activation'</span>,<font></font>
                 aggregation=<span class="hljs-string">'mean'</span>)<font></font>
<font></font>
model.compile(optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>)<font></font>
model.fit(x_train, y_train,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">1</span>)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¤œè¨¼å»¶æœŸã‚»ãƒƒãƒˆã®è‡ªå‹•å‰²ã‚Šå½“ã¦</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã®å®Œå…¨ãªä¾‹ã§ã¯ã€</font></font><code>validation_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã”è¦§ã®ã¨ãŠã‚Š</font><font style="vertical-align: inherit;">ã€å¼•æ•°ã‚’ä½¿ç”¨ã—ã¦</font><font style="vertical-align: inherit;">Numpyé…åˆ—ã®ã‚¿ãƒ—ãƒ«ã‚’</font></font><code>(x_val, y_val)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¢ãƒ‡ãƒ«ã«</font><font style="vertical-align: inherit;">æ¸¡ã—ã€</font><font style="vertical-align: inherit;">å„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«æ¤œè¨¼ã®æå¤±ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è©•ä¾¡ã—ã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚ã“ã®å¼•æ•°ã‚’</font></font><code>validation_split</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ã™ã‚‹ã¨ã€æ¤œè¨¼ç”¨ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã‚’è‡ªå‹•çš„ã«äºˆç´„ã§ãã¾ã™ã€‚å¼•æ•°ã®å€¤ã¯ã€æ¤œè¨¼ã®ãŸã‚ã«äºˆç´„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆã§ã‚ã‚‹ãŸã‚ã€å€¤ã¯0ã‚ˆã‚Šå¤§ãã1æœªæº€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€</font></font><code>validation_split=0.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€Œæ¤œè¨¼ã«ãƒ‡ãƒ¼ã‚¿ã®20ï¼…ã‚’ä½¿ç”¨ã€ã€</font></font><code>validation_split=0.6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¤ã¾ã‚Šã€Œæ¤œè¨¼ã«ãƒ‡ãƒ¼ã‚¿ã®60ï¼…ã‚’ä½¿ç”¨ã€</font><font style="vertical-align: inherit;">ã‚’</font><font style="vertical-align: inherit;">æ„å‘³ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¤œè¨¼ã¯ã€ã«ã‚ˆã£ã¦è¨ˆç®—ã•ã‚Œã‚‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ«ã§å—ä¿¡ã•ã‚ŒãŸã‚¢ãƒ¬ã‚¤ãƒ»ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æœ€å¾Œã®xï¼…ã‚’å–ã£ã¦</font></font></i> <code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»»æ„ã®æ··åˆã®å‰ã«</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ãªãŸã¯ä½¿ã†ã“ã¨ãŒã§ãã¾ã™</font></font><code>validation_split</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Numpyãƒ‡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å ´åˆã®ã¿ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
model.fit(x_train, y_train, batch_size=<span class="hljs-number">64</span>, validation_split=<span class="hljs-number">0.2</span>, epochs=<span class="hljs-number">1</span>, steps_per_epoch=<span class="hljs-number">1</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tf.dataãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨è©•ä¾¡</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã®ã„ãã¤ã‹ã®æ®µè½ã§ã¯ã€ã‚ãªãŸã¯æã€è©•ä¾¡æŒ‡æ¨™ã€ãŠã‚ˆã³ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚’ã©ã®ã‚ˆã†ã«å‡¦ç†ã™ã‚‹ã‹ã‚’è¦‹ã¦ã€ã‚ãªãŸã¯å¼•æ•°ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦</font></font><code>validation_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>validation_split</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã—ã¦</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã¯numpyã®é…åˆ—ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸã¨ãã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ãƒ‡ãƒ¼ã‚¿ãŒãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆtf.dataã®å½¢å¼ã§ã‚ã‚‹å ´åˆã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tf.data APIã¯ã€é«˜é€Ÿã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªæ–¹æ³•ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§å‰å‡¦ç†ã™ã‚‹ãŸã‚ã®TensorFlow 2.0ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚»ãƒƒãƒˆã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ãªãŸã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ã“ã¨ãŒã§ã</font></font><code>fit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><code>evaluate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã—ã¦</font></font><code>predict()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
<span class="hljs-comment">#      Dataset.</span>
<span class="hljs-comment">#          MNIST   .</span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
<span class="hljs-comment">#     .</span>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<span class="hljs-comment">#    .</span><font></font>
test_dataset = tf.data.Dataset.from_tensor_slices((x_test, y_test))<font></font>
test_dataset = test_dataset.batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<span class="hljs-comment">#        ,</span>
<span class="hljs-comment">#     `batch_size`.</span>
model.fit(train_dataset, epochs=<span class="hljs-number">3</span>)<font></font>
<font></font>
<span class="hljs-comment">#          .</span>
print(<span class="hljs-string">'\n# '</span>)<font></font>
model.evaluate(test_dataset)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯å„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚ã€æ¬¡ã®æ™‚ä»£ã«å†åˆ©ç”¨ã§ãã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ç‰¹å®šã®æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã®ã¿å­¦ç¿’ã™ã‚‹å ´åˆã¯ã€ `steps_per_epoch`å¼•æ•°ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€æ¬¡ã®æ™‚ä»£ã«é€²ã‚€å‰ã«ã€ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—ã®æ•°ã‚’ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯å„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œãšã€ä»£ã‚ã‚Šã«æ¬¡ã®ãƒ‘ã‚±ãƒƒãƒˆã®å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã¯æœ€çµ‚çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§çµ‚ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ãªã„é™ã‚Šï¼‰ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<span class="hljs-comment">#   100    ( 64 * 100 )</span>
model.fit(train_dataset.take(<span class="hljs-number">100</span>), epochs=<span class="hljs-number">3</span>)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½¿ç”¨</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ãªãŸã¯ã€å¼•æ•°ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™</font></font><code>validation_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã—ã¾ã™</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
val_dataset = tf.data.Dataset.from_tensor_slices((x_val, y_val))<font></font>
val_dataset = val_dataset.batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
model.fit(train_dataset, epochs=<span class="hljs-number">3</span>, validation_data=val_dataset)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«ã€ãƒ¢ãƒ‡ãƒ«ã¯æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’é€šéã—ã€æ¤œè¨¼ã®æå¤±ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰ç‰¹å®šã®æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å¯¾ã—ã¦ã®ã¿æ¤œè¨¼ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€</font></font><code>validation_steps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¤œè¨¼ã‚’çµ‚äº†ã—ã¦æ¬¡ã®æ™‚ä»£ã«é€²ã‚€å‰ã«ãƒ¢ãƒ‡ãƒ«ãŒå®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã®æ•°ã‚’ç¤ºã™</font><font style="vertical-align: inherit;">å¼•æ•°</font><font style="vertical-align: inherit;">ã‚’</font><font style="vertical-align: inherit;">æ¸¡ã™ã“ã¨ãŒã§ã</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
val_dataset = tf.data.Dataset.from_tensor_slices((x_val, y_val))<font></font>
val_dataset = val_dataset.batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
model.fit(train_dataset, epochs=<span class="hljs-number">3</span>,
          <span class="hljs-comment">#      10  </span>
          <span class="hljs-comment">#   `validation_steps`</span>
          validation_data=val_dataset, validation_steps=<span class="hljs-number">10</span>)
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯ä½¿ç”¨ã®ãŸã³ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼ˆãã®ãŸã‚ã€å¸¸ã«åŒã˜ä¾‹ã«ã¤ã„ã¦ã®æ™‚ä»£ã”ã¨ã®è©•ä¾¡ãŒå¾—ã‚‰ã‚Œã¾ã™ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¼•æ•°</font></font><code>validation_split</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é…å»¶ã‚µãƒ³ãƒ—ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼‰ã¯ã€Datasetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å ´åˆã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¯ã€è¦ç´ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹æ©Ÿèƒ½ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€é€šå¸¸Dataset APIã§ã¯ä¸å¯èƒ½ã§ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã®ä»–ã®ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å…¥åŠ›å½¢å¼</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NumpyãŠã‚ˆã³TensorFlow Dataseté…åˆ—ã«åŠ ãˆã¦ã€Pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦ã€ã¾ãŸã¯ãƒãƒƒãƒã§å€¤ã‚’æä¾›ã™ã‚‹Pythonã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€Kerasãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬ã«ã€æ•°å€¤ãŒå°ã•ããƒ¡ãƒ¢ãƒªã«åã¾ã‚‹å ´åˆã¯Numpyå…¥åŠ›ã‚’ä½¿ç”¨ã—ã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹ã¨ã‚¯ãƒ©ã‚¹ã«é‡ã¿ã‚’ä½¿ç”¨ã™ã‚‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¥åŠ›ãƒ©ãƒ™ãƒ«ã¨ãƒ¢ãƒ‡ãƒ«ãƒ©ãƒ™ãƒ«ã«åŠ ãˆã¦ã€æ¬¡ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä¾‹ã®é‡ã¿ã¨ã‚¯ãƒ©ã‚¹ã®é‡ã¿ã‚’è»¢é€ã§ãã¾ã™</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numpyãƒ‡ãƒ¼ã‚¿ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å ´åˆï¼šå¼•æ•° `sample_weight`ãŠã‚ˆã³` class_weight`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datasetã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å ´åˆï¼šDatasetãŒã‚¿ãƒ—ãƒ« `ï¼ˆinput_batchã€target_batchã€sample_weight_batchï¼‰`ã‚’è¿”ã™å ´åˆã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€Œã‚µãƒ³ãƒ—ãƒ«ã®é‡ã¿ã€é…åˆ—ã¯ã€æå¤±å€¤ã‚’è¨ˆç®—ã™ã‚‹ã¨ãã«ãƒ‘ã‚±ãƒƒãƒˆã®å„è¦ç´ ã«ä¸ãˆã‚‹é‡ã¿ã®é‡ã‚’æ±ºå®šã™ã‚‹æ•°å€¤ã®é…åˆ—ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯é€šå¸¸ã€ä¸å‡è¡¡ãªåˆ†é¡ã®å•é¡Œã§ä½¿ç”¨ã•ã‚Œã¾ã™ï¼ˆé‡è¦ãªã®ã¯ã€ã¾ã‚Œãªã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚Šå¤šãã®é‡ã¿ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã™ï¼‰ã€‚ä½¿ç”¨ã•ã‚Œã‚‹é‡ã¿ãŒ1ã¨0ã«ç­‰ã—ã„å ´åˆã€é…åˆ—</font><font style="vertical-align: inherit;">ã¯æå¤±é–¢æ•°ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒã‚¹ã‚¯</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™</font><font style="vertical-align: inherit;">ï¼ˆæå¤±ã®åˆè¨ˆå€¤ã«å¯¾ã™ã‚‹ç‰¹å®šã®è¦ç´ ã®å½±éŸ¿ã‚’å®Œå…¨ã«æ’é™¤ã—ã¾ã™ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¾æ›¸ã€Œã‚¯ãƒ©ã‚¹ã®é‡ã¿ã€ã¯ã€åŒã˜æ¦‚å¿µã®ã‚ˆã‚Šå…·ä½“çš„ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã«å±ã™ã‚‹è¦ç´ ã«ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹é‡ã¿ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ©ã‚¹ã€Œ0ã€ãŒã‚¯ãƒ©ã‚¹ã€Œ1ã€ã‚ˆã‚Š3å€å°ã•ã„å ´åˆã€ã‚’ä½¿ç”¨ã§ãã¾ã™</font></font><code>class_weight={0: 1., 1: 0.5}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Numpyã‚¯ãƒ©ã‚¹ã®é‡ã¿ã¨è¦ç´ ã®é‡ã¿ã®ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¹ï¼ƒ5ï¼ˆMNISTãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ç•ªå·ã€Œ5ã€ã«å¯¾å¿œï¼‰ã®æ­£ã—ã„åˆ†é¡ã‚’ã‚ˆã‚Šé‡è¦ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<font></font>
<font></font>
class_weight = {<span class="hljs-number">0</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">1</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">2</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">3</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">4</span>: <span class="hljs-number">1.</span>,
                <span class="hljs-comment">#   "2"   "5",</span>
                <span class="hljs-comment">#     2x  </span>
                <span class="hljs-number">5</span>: <span class="hljs-number">2.</span>,
                <span class="hljs-number">6</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">7</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">8</span>: <span class="hljs-number">1.</span>, <span class="hljs-number">9</span>: <span class="hljs-number">1.</span>}<font></font>
print(<span class="hljs-string">'   '</span>)<font></font>
model.fit(x_train, y_train,<font></font>
          class_weight=class_weight,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">4</span>)<font></font>
<font></font>
<span class="hljs-comment">#      `sample_weight`:</span><font></font>
sample_weight = np.ones(shape=(len(y_train),))<font></font>
sample_weight[y_train == <span class="hljs-number">5</span>] = <span class="hljs-number">2.</span>
print(<span class="hljs-string">'\n   '</span>)<font></font>
<font></font>
model = get_compiled_model()<font></font>
model.fit(x_train, y_train,<font></font>
          sample_weight=sample_weight,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          epochs=<span class="hljs-number">4</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã¯ã€å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä¾‹ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">sample_weight = np.ones(shape=(len(y_train),))<font></font>
sample_weight[y_train == <span class="hljs-number">5</span>] = <span class="hljs-number">2.</span><font></font>
<font></font>
<span class="hljs-comment">#   Dataset   </span>
<span class="hljs-comment"># (3-    ).</span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices(<font></font>
    (x_train, y_train, sample_weight))<font></font>
<font></font>
<span class="hljs-comment">#    .</span>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
model = get_compiled_model()<font></font>
model.fit(train_dataset, epochs=<span class="hljs-number">3</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¤‡æ•°ã®å…¥åŠ›ã¨å‡ºåŠ›ã‚’æŒã¤ãƒ¢ãƒ‡ãƒ«ã§ã®ãƒ‡ãƒ¼ã‚¿è»¢é€</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‰ã®ä¾‹ã§ã¯ã€å˜ä¸€ã®å…¥åŠ›ï¼ˆã‚µã‚¤ã‚ºãƒ†ãƒ³ã‚½ãƒ«</font></font><code>(764,)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã¨1ã¤ã®å‡ºåŠ›ï¼ˆã‚µã‚¤ã‚ºäºˆæ¸¬å­ãƒ†ãƒ³ã‚½ãƒ«</font></font><code>(10,)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã‚’</font><font style="vertical-align: inherit;">æŒã¤ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œè¨ã—ã¾ã—ãŸ</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€è¤‡æ•°ã®å…¥åŠ›ã¾ãŸã¯å‡ºåŠ›ã‚’æŒã¤ãƒ¢ãƒ‡ãƒ«ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚µã‚¤ã‚ºç”»åƒ</font></font><code>(32, 32, 3)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆthis </font></font><code>(height, width, channels)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã¨æ™‚ç³»åˆ—ã‚µã‚¤ã‚º</font></font><code>(None, 10)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆthis </font></font><code>(timesteps, features)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">ã§ã‚ã‚‹æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è€ƒãˆã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç§ãŸã¡ã®ãƒ¢ãƒ‡ãƒ«ã«ã¯ã€ã“ã‚Œã‚‰ã®å…¥åŠ›ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰è¨ˆç®—ã•ã‚ŒãŸ2ã¤ã®å‡ºåŠ›ãŒã‚ã‚Šã¾ã™ã€‚ã€Œã‚¹ã‚³ã‚¢ã€ï¼ˆãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³</font></font><code>(1,)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã¨5ã¤ã®ã‚¯ãƒ©ã‚¹ã®ç¢ºç‡åˆ†å¸ƒï¼ˆãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³</font></font><code>(5,)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras
<span class="hljs-keyword">from</span> tensorflow.keras <span class="hljs-keyword">import</span> layers<font></font>
<font></font>
image_input = keras.Input(shape=(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">3</span>), name=<span class="hljs-string">'img_input'</span>)<font></font>
timeseries_input = keras.Input(shape=(<span class="hljs-literal">None</span>, <span class="hljs-number">10</span>), name=<span class="hljs-string">'ts_input'</span>)<font></font>
<font></font>
x1 = layers.Conv2D(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)(image_input)<font></font>
x1 = layers.GlobalMaxPooling2D()(x1)<font></font>
<font></font>
x2 = layers.Conv1D(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)(timeseries_input)<font></font>
x2 = layers.GlobalMaxPooling1D()(x2)<font></font>
<font></font>
x = layers.concatenate([x1, x2])<font></font>
<font></font>
score_output = layers.Dense(<span class="hljs-number">1</span>, name=<span class="hljs-string">'score_output'</span>)(x)<font></font>
class_output = layers.Dense(<span class="hljs-number">5</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'class_output'</span>)(x)<font></font>
<font></font>
model = keras.Model(inputs=[image_input, timeseries_input],<font></font>
                    outputs=[score_output, class_output])<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’æç”»ã—ã¦ã€ã“ã“ã§ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ãŒæ˜ç¢ºã«ã‚ã‹ã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ˆå›³ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¯¸æ³•ã¯ã€ãƒ‘ã‚±ãƒƒãƒˆå˜ä½ã®å¯¸æ³•ã§ã‚ã‚Šã€è¦ç´ å˜ä½ã®å¯¸æ³•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚</font></font><br>
<br>
<pre><code class="python hljs">keras.utils.plot_model(model, <span class="hljs-string">'multi_input_and_output_model.png'</span>, show_shapes=<span class="hljs-literal">True</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/lg/85/tn/lg85tn_0a8cc-c8zxzhoxyrxdn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­ã«ã€ã•ã¾ã–ã¾ãªå‡ºåŠ›ã«ã•ã¾ã–ã¾ãªæå¤±é–¢æ•°ã‚’æŒ‡å®šã—ã¦ã€æå¤±é–¢æ•°ã‚’ãƒªã‚¹ãƒˆã§æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss=[keras.losses.MeanSquaredError(),<font></font>
          keras.losses.CategoricalCrossentropy()])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¢ãƒ‡ãƒ«æå¤±é–¢æ•°ã‚’1ã¤ã ã‘è»¢é€ã™ã‚‹ã¨ã€å„å‡ºåŠ›ã«é©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯é©ã—ã¦ã„ã¾ã›ã‚“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒæ§˜ã«ã€æŒ‡æ¨™ã®å ´åˆï¼š</font></font><br>
<br>
<pre><code class="python hljs">model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss=[keras.losses.MeanSquaredError(),<font></font>
          keras.losses.CategoricalCrossentropy()],<font></font>
    metrics=[[keras.metrics.MeanAbsolutePercentageError(),<font></font>
              keras.metrics.MeanAbsoluteError()],<font></font>
             [keras.metrics.CategoricalAccuracy()]])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‡ºåŠ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åå‰ã‚’ä»˜ã‘ãŸã®ã§ã€dictã®å„å‡ºåŠ›ã®æå¤±é–¢æ•°ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss={<span class="hljs-string">'score_output'</span>: keras.losses.MeanSquaredError(),
          <span class="hljs-string">'class_output'</span>: keras.losses.CategoricalCrossentropy()},<font></font>
    metrics={<span class="hljs-string">'score_output'</span>: [keras.metrics.MeanAbsolutePercentageError(),<font></font>
                              keras.metrics.MeanAbsoluteError()],<font></font>
             <span class="hljs-string">'class_output'</span>: [keras.metrics.CategoricalAccuracy()]})
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3ã¤ä»¥ä¸Šã®å‡ºåŠ›ãŒã‚ã‚‹å ´åˆã¯ã€åå‰ã¨è¾æ›¸ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¼•æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ç•°ãªã‚‹æå¤±é–¢æ•°ã«ç•°ãªã‚‹é‡ã¿ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãŸã¨ãˆã°ã€ã“ã®ä¾‹ã§ã¯ã€ã€Œã‚¹ã‚³ã‚¢ã€æå¤±ã‚’å„ªå…ˆã—ã€ã‚¯ãƒ©ã‚¹æå¤±ã®é‡è¦åº¦ã‚’2å€ã«å¢—ã‚„ã™ã“ã¨ãŒã§ãã¾ã™ï¼‰</font></font><code>loss_weights</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss={<span class="hljs-string">'score_output'</span>: keras.losses.MeanSquaredError(),
          <span class="hljs-string">'class_output'</span>: keras.losses.CategoricalCrossentropy()},<font></font>
    metrics={<span class="hljs-string">'score_output'</span>: [keras.metrics.MeanAbsolutePercentageError(),<font></font>
                              keras.metrics.MeanAbsoluteError()],<font></font>
             <span class="hljs-string">'class_output'</span>: [keras.metrics.CategoricalAccuracy()]},<font></font>
    loss_weights={<span class="hljs-string">'score_output'</span>: <span class="hljs-number">2.</span>, <span class="hljs-string">'class_output'</span>: <span class="hljs-number">1.</span>})
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€éƒ¨ã®å‡ºåŠ›ãŒäºˆæ¸¬ã®ã¿ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç›®çš„ã¨ã—ã¦ã„ãªã„å ´åˆã€ä¸€éƒ¨ã®å‡ºåŠ›ã®æå¤±ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#   </span><font></font>
model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss=[<span class="hljs-literal">None</span>, keras.losses.CategoricalCrossentropy()])<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss={<span class="hljs-string">'class_output'</span>: keras.losses.CategoricalCrossentropy()})</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¤‡æ•°ã®å…¥åŠ›ã¨å‡ºåŠ›ã‚’æŒã¤ãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ‡ãƒ¼ã‚¿è»¢é€</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€ã®æå¤±é–¢æ•°ã®å®šç¾©ã¨åŒæ§˜</font><font style="vertical-align: inherit;">ã«</font><font style="vertical-align: inherit;">è¡Œã‚</font></font><code>compile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ã™ã€‚Numpyé…åˆ—ã®ãƒªã‚¹ãƒˆï¼ˆæå¤±é–¢æ•°ã‚’æŒã¤å‡ºåŠ›ã¨1ï¼š1ã«</font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€è‡´</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">ï¼‰</font></i><font style="vertical-align: inherit;">ã¾ãŸã¯</font><i><font style="vertical-align: inherit;">å‡ºåŠ›ã®åå‰ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®Numpyé…åˆ—ã«ä¸€è‡´ã™ã‚‹è¾æ›¸ã‚’è»¢é€ã§ãã¾ã™</font></i><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model.compile(<font></font>
    optimizer=keras.optimizers.RMSprop(<span class="hljs-number">1e-3</span>),<font></font>
    loss=[keras.losses.MeanSquaredError(),<font></font>
          keras.losses.CategoricalCrossentropy()])<font></font>
<font></font>
<span class="hljs-comment">#   Numpy </span>
img_data = np.random.random_sample(size=(<span class="hljs-number">100</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">3</span>))<font></font>
ts_data = np.random.random_sample(size=(<span class="hljs-number">100</span>, <span class="hljs-number">20</span>, <span class="hljs-number">10</span>))<font></font>
score_targets = np.random.random_sample(size=(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>))<font></font>
class_targets = np.random.random_sample(size=(<span class="hljs-number">100</span>, <span class="hljs-number">5</span>))<font></font>
<font></font>
<span class="hljs-comment">#       </span><font></font>
model.fit([img_data, ts_data], [score_targets, class_targets],<font></font>
          batch_size=<span class="hljs-number">32</span>,<font></font>
          epochs=<span class="hljs-number">3</span>)<font></font>
<font></font>
<span class="hljs-comment">#       </span>
model.fit({<span class="hljs-string">'img_input'</span>: img_data, <span class="hljs-string">'ts_input'</span>: ts_data},<font></font>
          {<span class="hljs-string">'score_output'</span>: score_targets, <span class="hljs-string">'class_output'</span>: class_targets},<font></font>
          batch_size=<span class="hljs-number">32</span>,<font></font>
          epochs=<span class="hljs-number">3</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã¯Datasetã®ä¾‹ã§ã™ã€‚Numpyé…åˆ—ã¨åŒæ§˜ã«ã€Datasetã¯ãƒ‡ã‚£ã‚¯ã‚·ãƒ§ãƒŠãƒªã‚¿ãƒ—ãƒ«ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">train_dataset = tf.data.Dataset.from_tensor_slices(<font></font>
    ({<span class="hljs-string">'img_input'</span>: img_data, <span class="hljs-string">'ts_input'</span>: ts_data},<font></font>
     {<span class="hljs-string">'score_output'</span>: score_targets, <span class="hljs-string">'class_output'</span>: class_targets}))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
model.fit(train_dataset, epochs=<span class="hljs-number">3</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ä½¿ç”¨</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kerasã§ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ï¼ˆãªã©ã€æ™‚ä»£ã®çµ‚ã‚ã‚Šã«ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®çµ‚ã‚ã‚Šã«ã€æ™‚ä»£ã®åˆã‚ã«ï¼‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ç•°ãªã‚‹å ´æ‰€ã«å‘¼ã°ã‚Œã€ã“ã®ã‚ˆã†ãªå‹•ä½œã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ï¼š</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¨ä½“ã®ã•ã¾ã–ã¾ãªãƒã‚¤ãƒ³ãƒˆã§æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ï¼ˆå„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«çµ„ã¿è¾¼ã¾ã‚ŒãŸæ¤œè¨¼ã‚’é™¤ãï¼‰</font></font><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®šæœŸçš„ã«ã€ã¾ãŸã¯ç‰¹å®šã®ç²¾åº¦ã—ãã„å€¤ã‚’è¶…ãˆãŸã¨ãã«ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­¦ç¿’ãŒåæŸã—ã¦ã„ãªã„ã‚ˆã†ã«æ€ã‚ã‚Œã‚‹ã¨ãã«ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’é€Ÿåº¦ã‚’å¤‰æ›´ã™ã‚‹</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒåæŸã—ãªããªã£ãŸã‚ˆã†ã«è¦‹ãˆã‚‹å ´åˆã¯ã€ä¸Šå±¤ã‚’å¾®èª¿æ•´ã—ã¾ã™</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒçµ‚äº†ã—ãŸã¨ãã€ã¾ãŸã¯ç‰¹å®šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã—ãã„å€¤ã‚’è¶…ãˆãŸã¨ãã«ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã€å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ãƒªã‚¹ãƒˆã«ã‚ˆã£ã¦è»¢é€ã§ãã¾ã™</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
callbacks = [<font></font>
    keras.callbacks.EarlyStopping(<font></font>
        <span class="hljs-comment">#    `val_loss`   </span>
        monitor=<span class="hljs-string">'val_loss'</span>,
        <span class="hljs-comment"># "  "   "   1e-2  "</span>
        min_delta=<span class="hljs-number">1e-2</span>,
        <span class="hljs-comment"># "  "    "    2 "</span>
        patience=<span class="hljs-number">2</span>,<font></font>
        verbose=<span class="hljs-number">1</span>)<font></font>
]<font></font>
model.fit(x_train, y_train,<font></font>
          epochs=<span class="hljs-number">20</span>,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          callbacks=callbacks,<font></font>
          validation_split=<span class="hljs-number">0.2</span>)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¤šæ•°ã®çµ„ã¿è¾¼ã¿ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</font></font></h4><br>
<ul>
<li><code>ModelCheckpoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šå®šæœŸçš„ã«ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã€‚</font></font></li>
<li><code>EarlyStopping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæ¤œè¨¼ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®æ”¹å–„ãŒæ­¢ã¾ã£ãŸã¨ãã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åœæ­¢ã—ã¾ã™ã€‚</font></font></li>
<li><code>TensorBoard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šTensorBoardã§å¯è¦–åŒ–ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ã‚°ã‚’å®šæœŸçš„ã«æ›¸ãè¾¼ã¿ã¾ã™ï¼ˆè©³ç´°ã«ã¤ã„ã¦ã¯ã€ã€Œå¯è¦–åŒ–ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼‰ã€‚</font></font></li>
<li><code>CSVLogger</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæå¤±å€¤ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ›¸ã</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
keras.callbacks.CallbackåŸºæœ¬ã‚¯ãƒ©ã‚¹ã‚’å±•é–‹ã™ã‚‹ã“ã¨ã§ã€ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½œæˆã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã€ã‚¯ãƒ©ã‚¹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é€šã˜ã¦é–¢é€£ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</font></font><code>self.model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ãƒ‘ã‚±ãƒƒãƒˆæå¤±å€¤ã®ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ç°¡å˜ãªä¾‹ã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LossHistory</span>(<span class="hljs-params">keras.callbacks.Callback</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_train_begin</span>(<span class="hljs-params">self, logs</span>):</span><font></font>
        self.losses = []<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_batch_end</span>(<span class="hljs-params">self, batch, logs</span>):</span>
        self.losses.append(logs.get(<span class="hljs-string">'loss'</span>))</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¢ãƒ‡ãƒ«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã®ä¿å­˜</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¯”è¼ƒçš„å¤§ããªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å ´åˆã€ãƒ¢ãƒ‡ãƒ«ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å®šæœŸçš„ã«ç¶­æŒã™ã‚‹ã“ã¨ãŒä¸å¯æ¬ ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã‚’è¡Œã†æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨</font></font><code>ModelCheckpoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = get_compiled_model()<font></font>
<font></font>
callbacks = [<font></font>
    keras.callbacks.ModelCheckpoint(<font></font>
        filepath=<span class="hljs-string">'mymodel_{epoch}.h5'</span>,
        <span class="hljs-comment">#      </span>
        <span class="hljs-comment">#       </span>
        <span class="hljs-comment">#         , </span>
        <span class="hljs-comment">#   `val_loss`.</span>
        save_best_only=<span class="hljs-literal">True</span>,<font></font>
        monitor=<span class="hljs-string">'val_loss'</span>,<font></font>
        verbose=<span class="hljs-number">1</span>)<font></font>
]<font></font>
model.fit(x_train, y_train,<font></font>
          epochs=<span class="hljs-number">3</span>,<font></font>
          batch_size=<span class="hljs-number">64</span>,<font></font>
          callbacks=callbacks,<font></font>
          validation_split=<span class="hljs-number">0.2</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¦ã€ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ãŠã‚ˆã³å¾©å…ƒã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­¦ç¿’é€Ÿåº¦ã®ã‚°ãƒ©ãƒ•ã®ä½¿ç”¨</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ·±å±¤å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã¨ãã®ä¸€èˆ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã¨ãã«å¾ã€…ã«å­¦ç¿’é€Ÿåº¦ã‚’ä½ä¸‹ã•ã›ã‚‹ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ä¸€èˆ¬ã«ã€Œå­¦ç¿’é€Ÿåº¦ã®ä½ä¸‹ã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€Ÿåº¦ä½ä¸‹ã®ã‚°ãƒ©ãƒ•ã¯ã€é™çš„ï¼ˆç¾åœ¨ã®æ™‚ä»£ã¾ãŸã¯ç¾åœ¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é–¢æ•°ã¨ã—ã¦äº‹å‰ã«å›ºå®šï¼‰ã¾ãŸã¯å‹•çš„ï¼ˆãƒ¢ãƒ‡ãƒ«ã®ç¾åœ¨ã®å‹•ä½œã€ç‰¹ã«æ¤œè¨¼æå¤±ã«å¿œã˜ã¦ï¼‰ã®ã„ãšã‚Œã‹ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã«æ¸¡ã™</font></font></h4><br><font style="vertical-align: inherit;"></font><code>learning_rate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã«</font><font style="vertical-align: inherit;">
å¼•æ•°ã¨ã—ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™ã“ã¨ã«ã‚ˆã‚Šã€å­¦ç¿’é€Ÿåº¦ã®é™çš„ãªä½ä¸‹ã®ã‚°ãƒ©ãƒ•ã‚’ç°¡å˜ã«ä½¿ç”¨ã§ã</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">initial_learning_rate = <span class="hljs-number">0.1</span><font></font>
lr_schedule = keras.optimizers.schedules.ExponentialDecay(<font></font>
    initial_learning_rate,<font></font>
    decay_steps=<span class="hljs-number">100000</span>,<font></font>
    decay_rate=<span class="hljs-number">0.96</span>,<font></font>
    staircase=<span class="hljs-literal">True</span>)<font></font>
<font></font>
optimizer = keras.optimizers.RMSprop(learning_rate=lr_schedule)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼šã‚ã‚Šå†…è”µã®å›è·¯ã®ã„ãã¤ã‹ã¯ã€å­¦ç¿’ç‡ã‚’ä½æ¸›ã—ã¦ã„ã‚‹</font></font><code>ExponentialDecay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><code>PiecewiseConstantDecay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><code>PolynomialDecay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>InverseTimeDecay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦å‹•çš„ã«å¤‰åŒ–ã™ã‚‹å­¦ç¿’é€Ÿåº¦ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãŒæ¤œè¨¼ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€ã“ã‚Œã‚‰ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å­¦ç¿’é€Ÿåº¦ã‚’å‹•çš„ã«å¤‰æ›´ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãŸã¨ãˆã°ã€æ¤œè¨¼ä¸­ã®æå¤±ãŒæ”¹å–„ã•ã‚Œãªããªã£ãŸã¨ãã«å­¦ç¿’é€Ÿåº¦ã‚’ä¸‹ã’ã‚‹ï¼‰ã‚’é”æˆã§ãã¾ã›ã‚“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãŸã ã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯æ¤œè¨¼ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’å«ã‚€ã™ã¹ã¦ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®ç¾åœ¨ã®å­¦ç¿’é€Ÿåº¦ã‚’å¤‰æ›´ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">å®Ÿéš›ã€çµ„ã¿è¾¼ã¿ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ã‚ã‚Šã¾ã™</font></font><code>ReduceLROnPlateau</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã®æå¤±ã¨æ¸¬å®šåŸºæº–ã®è¦–è¦šåŒ–</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¿½è·¡ã™ã‚‹æœ€è‰¯ã®æ–¹æ³•ã¯ã€TensorBoardã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚TensorBoardã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã§ãã€æ¬¡ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨è©•ä¾¡ã®ãŸã‚ã®æå¤±é–¢æ•°ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®ãƒ©ã‚¤ãƒ–ã‚°ãƒ©ãƒ•</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®è¦–è¦šåŒ–</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</font></font><code>Embedding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ</font><font style="vertical-align: inherit;">æ¢ç´¢ã—ãŸãƒã‚¹ãƒˆç©ºé–“ã®3Dè¦–è¦šåŒ–</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tipã‚’pipã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆã¯ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰TensorBoardã‚’èµ·å‹•ã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">tensorboard --logdir=/full_path_to_your_logs</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TensorBoardã®ä½¿ç”¨</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kerasãƒ¢ãƒ‡ãƒ«ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã§TensorBoardã‚’ä½¿ç”¨ã™ã‚‹æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•</font></font><code>fit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨</font></font><code>TensorBoard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€ã‚‚å˜ç´”ãªã‚±ãƒ¼ã‚¹ã§ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ­ã‚°ã‚’æ›¸ãè¾¼ã‚€å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§å®Œäº†ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">tensorboard_cbk = keras.callbacks.TensorBoard(log_dir=<span class="hljs-string">'/full_path_to_your_logs'</span>)<font></font>
model.fit(dataset, epochs=<span class="hljs-number">10</span>, callbacks=[tensorboard_cbk])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kolbekã«</font></font><code>TensorBoard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®ãƒ­ã‚°ã‚’æ›¸ãè¾¼ã‚€ã‹ã©ã†ã‹ã€ãƒ­ã‚°ã‚’æ›¸ãè¾¼ã‚€</font><font style="vertical-align: inherit;">é »åº¦</font><font style="vertical-align: inherit;">ãªã©ã€å¤šãã®ä¾¿åˆ©ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">keras.callbacks.TensorBoard(<font></font>
  log_dir=<span class="hljs-string">'/full_path_to_your_logs'</span>,<font></font>
  histogram_freq=<span class="hljs-number">0</span>,  <span class="hljs-comment">#      </span>
  embeddings_freq=<span class="hljs-number">0</span>,  <span class="hljs-comment">#      </span>
  update_freq=<span class="hljs-string">'epoch'</span>)  <span class="hljs-comment">#     ( :   )</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒ¼ãƒˆIIï¼šç‹¬è‡ªã®å­¦ç¿’ãŠã‚ˆã³è©•ä¾¡ã‚µã‚¤ã‚¯ãƒ«ã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œæˆã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ãªãŸã¯ã€å½¼ã‚‰ãŒä¸ãˆã‚‹ã‚‚ã®ã‚ˆã‚Šã‚‚ã‚ãªãŸã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨è©•ä¾¡ã®ã‚µã‚¤ã‚¯ãƒ«ã®ä½ã„ãƒ¬ãƒ™ãƒ«ã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆ</font></font><code>fit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>evaluate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã‚ãªãŸã¯ã‚ãªãŸè‡ªèº«ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã¯å®Ÿéš›ã«ã¯éå¸¸ã«ç°¡å˜ã§ã™ï¼</font><font style="vertical-align: inherit;">ãŸã ã—ã€ã•ã‚‰ã«ãƒ‡ãƒãƒƒã‚°ã™ã‚‹æº–å‚™ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GradientTapeã®ä½¿ç”¨ï¼šæœ€åˆã®å®Œå…¨ãªä¾‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã™</font></font><code>GradientTape</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨ã€æå¤±å€¤ã«å¯¾ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é‡ã¿ã®å‹¾é…ã‚’å–å¾—ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰ã®å‹¾é…ã‚’ä½¿ç”¨ã—ã¦å¤‰æ•°ã‚’æ›´æ–°ã§ãã¾ã™ï¼ˆå¤‰æ•°ã¯ã§å–å¾—ã§ãã¾ã™</font></font><code>model.trainable_weights</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã®éƒ¨åˆ†ã‹ã‚‰å…ƒã®MNISTãƒ¢ãƒ‡ãƒ«ã‚’å†åˆ©ç”¨ã—ã€ã‚«ã‚¹ã‚¿ãƒ å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«ã‚’å‚™ãˆãŸãƒŸãƒ‹ãƒãƒƒãƒå‹¾é…é™ä¸‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#  .</span>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
<font></font>
<span class="hljs-comment">#   .</span>
optimizer = keras.optimizers.SGD(learning_rate=<span class="hljs-number">1e-3</span>)
<span class="hljs-comment"># Instantiate a loss function.</span>
loss_fn = keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<span class="hljs-comment">#   .</span>
batch_size = <span class="hljs-number">64</span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(batch_size)<font></font>
<font></font>
<span class="hljs-comment">#   .</span>
epochs = <span class="hljs-number">3</span>
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(epochs):<font></font>
  print(<span class="hljs-string">'  %d'</span> % (epoch,))<font></font>
<font></font>
  <span class="hljs-comment">#     .</span>
  <span class="hljs-keyword">for</span> step, (x_batch_train, y_batch_train) <span class="hljs-keyword">in</span> enumerate(train_dataset):<font></font>
<font></font>
    <span class="hljs-comment">#  GradientTape   </span>
    <span class="hljs-comment">#     ,  .</span>
    <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:<font></font>
<font></font>
      <span class="hljs-comment">#    .</span>
      <span class="hljs-comment">#     </span>
      <span class="hljs-comment">#    </span>
      <span class="hljs-comment">#  GradientTape.</span>
      logits = model(x_batch_train, training=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># Logits for this minibatch</span><font></font>
<font></font>
      <span class="hljs-comment">#      .</span><font></font>
      loss_value = loss_fn(y_batch_train, logits)<font></font>
<font></font>
    <span class="hljs-comment">#  gradient tape    </span>
    <span class="hljs-comment">#    .</span><font></font>
    grads = tape.gradient(loss_value, model.trainable_weights)<font></font>
<font></font>
    <span class="hljs-comment">#      </span>
    <span class="hljs-comment">#    .</span><font></font>
    optimizer.apply_gradients(zip(grads, model.trainable_weights))<font></font>
<font></font>
    <span class="hljs-comment">#    200 .</span>
    <span class="hljs-keyword">if</span> step % <span class="hljs-number">200</span> == <span class="hljs-number">0</span>:<font></font>
        print(<span class="hljs-string">'   (  )   %s: %s'</span> % (step, float(loss_value)))<font></font>
        print(<span class="hljs-string">' : %s '</span> % ((step + <span class="hljs-number">1</span>) * <span class="hljs-number">64</span>))
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½ãƒ¬ãƒ™ãƒ«ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯å‡¦ç†</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font><font style="vertical-align: inherit;">ã‚¼ãƒ­ã‹ã‚‰ä½œæˆã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«ã§ã¯ã€çµ„ã¿è¾¼ã¿ãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼ˆã¾ãŸã¯ç‹¬è‡ªã«ä½œæˆã—ãŸãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼‰ã‚’ç°¡å˜ã«ä½¿ç”¨ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹æ™‚ã«ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>metric.update_state()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å„ãƒ‘ã‚±ãƒƒãƒˆã®å¾Œã«</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã™</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>metric.result()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¾åœ¨ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯å€¤ã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ãã«</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>metric.reset_states()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ãã«</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã—</font><font style="vertical-align: inherit;">ã¾ã™ï¼ˆé€šå¸¸ã€å„æ™‚ä»£ã®çµ‚ã‚ã‚Šï¼‰</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®çŸ¥è­˜ã‚’ä½¿ç”¨</font></font><code>SparseCategoricalAccuracy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã—ã¦ã€å„æ™‚ä»£ã®çµ‚ã‚ã‚Šã«æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿</font><font style="vertical-align: inherit;">ã‚’é ¼ã‚Šã«</font><font style="vertical-align: inherit;">ã—</font><font style="vertical-align: inherit;">ã¾ã—ã‚‡ã†</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#  </span>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
<font></font>
<span class="hljs-comment">#      .</span>
optimizer = keras.optimizers.SGD(learning_rate=<span class="hljs-number">1e-3</span>)
<span class="hljs-comment">#    .</span><font></font>
loss_fn = keras.losses.SparseCategoricalCrossentropy()<font></font>
<font></font>
<span class="hljs-comment">#  .</span><font></font>
train_acc_metric = keras.metrics.SparseCategoricalAccuracy()<font></font>
val_acc_metric = keras.metrics.SparseCategoricalAccuracy()<font></font>
<font></font>
<span class="hljs-comment">#   .</span>
batch_size = <span class="hljs-number">64</span><font></font>
train_dataset = tf.data.Dataset.from_tensor_slices((x_train, y_train))<font></font>
train_dataset = train_dataset.shuffle(buffer_size=<span class="hljs-number">1024</span>).batch(batch_size)<font></font>
<font></font>
<span class="hljs-comment">#   .</span><font></font>
val_dataset = tf.data.Dataset.from_tensor_slices((x_val, y_val))<font></font>
val_dataset = val_dataset.batch(<span class="hljs-number">64</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment">#   .</span>
epochs = <span class="hljs-number">3</span>
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(epochs):<font></font>
  print(<span class="hljs-string">'  %d'</span> % (epoch,))<font></font>
<font></font>
  <span class="hljs-comment">#     .</span>
  <span class="hljs-keyword">for</span> step, (x_batch_train, y_batch_train) <span class="hljs-keyword">in</span> enumerate(train_dataset):
    <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:<font></font>
      logits = model(x_batch_train)<font></font>
      loss_value = loss_fn(y_batch_train, logits)<font></font>
    grads = tape.gradient(loss_value, model.trainable_weights)<font></font>
    optimizer.apply_gradients(zip(grads, model.trainable_weights))<font></font>
<font></font>
    <span class="hljs-comment">#    .</span><font></font>
    train_acc_metric(y_batch_train, logits)<font></font>
<font></font>
    <span class="hljs-comment">#    200 .</span>
    <span class="hljs-keyword">if</span> step % <span class="hljs-number">200</span> == <span class="hljs-number">0</span>:<font></font>
        print(<span class="hljs-string">'   (  )   %s: %s'</span> % (step, float(loss_value)))<font></font>
        print(<span class="hljs-string">' : %s '</span> % ((step + <span class="hljs-number">1</span>) * <span class="hljs-number">64</span>))<font></font>
<font></font>
  <span class="hljs-comment">#      .</span><font></font>
  train_acc = train_acc_metric.result()<font></font>
  print(<span class="hljs-string">'Accuracy    : %s'</span> % (float(train_acc),))
  <span class="hljs-comment">#       </span><font></font>
  train_acc_metric.reset_states()<font></font>
<font></font>
  <span class="hljs-comment">#      .</span>
  <span class="hljs-keyword">for</span> x_batch_val, y_batch_val <span class="hljs-keyword">in</span> val_dataset:<font></font>
    val_logits = model(x_batch_val)<font></font>
    <span class="hljs-comment">#   </span><font></font>
    val_acc_metric(y_batch_val, val_logits)<font></font>
  val_acc = val_acc_metric.result()<font></font>
  val_acc_metric.reset_states()<font></font>
  print(<span class="hljs-string">'Accuracy  : %s'</span> % (float(val_acc),))
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿½åŠ æå¤±ã®ä½ãƒ¬ãƒ™ãƒ«å‡¦ç†</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ãƒ¬ã‚¤ãƒ¤ã«å¯¾ã—ã¦</font></font><code>self.add_loss(value)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’</font><font style="vertical-align: inherit;">å‘¼ã³å‡ºã™ã“ã¨</font><font style="vertical-align: inherit;">ã§</font><font style="vertical-align: inherit;">æ­£å‰‡åŒ–æå¤±ã‚’è¿½åŠ ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—</font><font style="vertical-align: inherit;">ã¾ã—ãŸ</font></font><code>call</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«ã§ã“ã‚Œã‚‰ã®æå¤±ã‚’è€ƒæ…®ã«å…¥ã‚Œã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼ˆè‡ªåˆ†ã§ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¦ã€ãã®ã‚ˆã†ãªæå¤±ãŒç™ºç”Ÿã—ãªã„ã“ã¨ãŒã™ã§ã«ã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã‚’é™¤ãã¾ã™ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¾‹ã‚’æ€ã„å‡ºã—ã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯ã€æ­£å‰‡åŒ–æå¤±ã‚’ä½œæˆã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActivityRegularizationLayer</span>(<span class="hljs-params">layers.Layer</span>):</span><font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span>(<span class="hljs-params">self, inputs</span>):</span>
    self.add_loss(<span class="hljs-number">1e-2</span> * tf.reduce_sum(inputs))
    <span class="hljs-keyword">return</span> inputs<font></font>
<font></font>
inputs = keras.Input(shape=(<span class="hljs-number">784</span>,), name=<span class="hljs-string">'digits'</span>)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_1'</span>)(inputs)
<span class="hljs-comment"># Insert activity regularization as a layer</span><font></font>
x = ActivityRegularizationLayer()(x)<font></font>
x = layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>, name=<span class="hljs-string">'dense_2'</span>)(x)<font></font>
outputs = layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>, name=<span class="hljs-string">'predictions'</span>)(x)<font></font>
<font></font>
model = keras.Model(inputs=inputs, outputs=outputs)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã™ã¨ã€</font></font><br>
<br>
<pre><code class="python hljs">logits = model(x_train)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ‘ã‚¹ä¸­ã«ç™ºç”Ÿã™ã‚‹æå¤±ã¯ã€å±æ€§ã«è¿½åŠ ã•ã‚Œã¾ã™</font></font><code>model.losses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">logits = model(x_train[:<span class="hljs-number">64</span>])<font></font>
print(model.losses)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿½è·¡ã•ã‚ŒãŸæå¤±ã¯ãƒ¢ãƒ‡ãƒ«ã®æœ€åˆã«æœ€åˆã«ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹</font></font><code>__call__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŸã‚ã€ç¾åœ¨ã®1ã¤ã®ç›´æ¥ãƒ‘ã‚¹ä¸­ã«ä½œæˆã•ã‚ŒãŸæå¤±ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€ãƒ¢ãƒ‡ãƒ«ã¸ã®ç¹°ã‚Šè¿”ã—ã®å‘¼ã³å‡ºã—ã¨ãã‚Œã«ç¶šãã¸ã®è¦æ±‚</font></font><code>losses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã¯ã€æœ€å¾Œã®å‘¼ã³å‡ºã—ä¸­ã«ä½œæˆã•ã‚ŒãŸæœ€å¾Œã®æå¤±ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">logits = model(x_train[:<span class="hljs-number">64</span>])<font></font>
logits = model(x_train[<span class="hljs-number">64</span>: <span class="hljs-number">128</span>])<font></font>
logits = model(x_train[<span class="hljs-number">128</span>: <span class="hljs-number">192</span>])<font></font>
print(model.losses)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã®ã“ã‚Œã‚‰ã®æå¤±ã‚’è€ƒæ…®ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã®ã¯ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«ã‚’å¤‰æ›´ã—ã¦ã€æå¤±ã®å®Œå…¨ãªå€¤ã«è¿½åŠ ã™ã‚‹ã“ã¨ã ã‘ã§ã™</font></font><code>sum(model.losses)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">optimizer = keras.optimizers.SGD(learning_rate=<span class="hljs-number">1e-3</span>)<font></font>
<font></font>
epochs = <span class="hljs-number">3</span>
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(epochs):<font></font>
  print(<span class="hljs-string">'  %d'</span> % (epoch,))<font></font>
<font></font>
  <span class="hljs-keyword">for</span> step, (x_batch_train, y_batch_train) <span class="hljs-keyword">in</span> enumerate(train_dataset):
    <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:<font></font>
      logits = model(x_batch_train)<font></font>
      loss_value = loss_fn(y_batch_train, logits)<font></font>
<font></font>
      <span class="hljs-comment">#   ,     :</span><font></font>
      loss_value += sum(model.losses)<font></font>
<font></font>
    grads = tape.gradient(loss_value, model.trainable_weights)<font></font>
    optimizer.apply_gradients(zip(grads, model.trainable_weights))<font></font>
<font></font>
    <span class="hljs-comment">#    200 .</span>
    <span class="hljs-keyword">if</span> step % <span class="hljs-number">200</span> == <span class="hljs-number">0</span>:<font></font>
        print(<span class="hljs-string">'   (  )   %s: %s'</span> % (step, float(loss_value)))<font></font>
        print(<span class="hljs-string">': %s '</span> % ((step + <span class="hljs-number">1</span>) * <span class="hljs-number">64</span>))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚ŒãŒãƒ‘ã‚ºãƒ«ã®æœ€å¾Œã®ãƒ”ãƒ¼ã‚¹ã§ã—ãŸï¼</font><font style="vertical-align: inherit;">ã‚¬ã‚¤ãƒ‰ã®æœ€å¾Œã«é”ã—ã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã§ã€çµ„ã¿è¾¼ã¿ã®å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ç”¨ã—ã€ç‹¬è‡ªã®ã‚µã‚¤ã‚¯ãƒ«ã‚’æœ€åˆã‹ã‚‰ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã™ã¹ã¦ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485878/index.html">JetCalcãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ç®¡ç†ä¼šè¨ˆã‚’æ•´ç†ã™ã‚‹ãŸã‚ã®ä¸€é€£ã®ã‚¹ãƒ†ãƒƒãƒ—</a></li>
<li><a href="../ja485882/index.html">ã“ã®ãƒªã‚¹ãƒˆã‚’ã©ã®ã‚ˆã†ã«åˆ†é¡ã™ã‚‹ã®ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja485884/index.html">ä¸­å›½ã®ãƒ¬ãƒ“ãƒˆãƒ­ãƒ³ã‚’è¨­å®šã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja485886/index.html">Yandex.DirectãŠã‚ˆã³Googleåºƒå‘Šã‹ã‚‰ã®ç«¶åˆä»–ç¤¾ã®ã‚­ãƒ¼ã¨åºƒå‘Šã‚’ç„¡æ–™ã§è§£æã™ã‚‹æ–¹æ³•ï¼ˆãŠã‚ˆã³ç†ç”±ï¼‰</a></li>
<li><a href="../ja485888/index.html">ã‚µãƒ¼ãƒãƒ¼è¦æ±‚å½é€ ã€ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰SSRFæ“ä½œ</a></li>
<li><a href="../ja485892/index.html">ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆæ™‚ä»£ã®çµ‚ã‚ã‚Š</a></li>
<li><a href="../ja485896/index.html">è¶…ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹Greenplum-çŸ­ã„æ•™è‚²ãƒ—ãƒ­ã‚°ãƒ©ãƒ </a></li>
<li><a href="../ja485898/index.html">Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ+ REST APIï¼ˆPythonï¼‰çµŒç”±ã§Googleã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
<li><a href="../ja485902/index.html">DPIï¼šãƒ‡ã‚£ãƒ¼ãƒ—ãƒ‘ã‚±ãƒƒãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€ã¾ãŸã¯RTKã¨MRGé–“ã®é™°è¬€ã®é™°è¬€ç†è«–</a></li>
<li><a href="../ja485904/index.html">Raiffeisenbankã§ã®è² è·ãƒ†ã‚¹ãƒˆã«é–¢ã™ã‚‹ãƒŸãƒ¼ãƒˆã‚¢ãƒƒãƒ—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>