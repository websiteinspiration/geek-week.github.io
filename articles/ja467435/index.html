<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏿 👩🏿‍⚕️ 👨🏽‍🤝‍👨🏼 VeeamエージェントLinuxのレポートをメールまたはTelegramで送信します 👉🏻 ◻️ 🚏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="あいさつ、ハーブル！
 
 最近では、私が働いている会社がVeeamを主要なバックアップツールとして提供し始めました。そして、すべてがうまくいくでしょうが、慣れ親しむプロセスの間に以下が見つかりました：
 
 

- 一元化されたリポジトリーの配備を含む、VeeamツールがWindowsで強化されま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>VeeamエージェントLinuxのレポートをメールまたはTelegramで送信します</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467435/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あいさつ、ハーブル！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近では、私が働いている会社がVeeamを主要なバックアップツールとして提供し始めました。</font><font style="vertical-align: inherit;">そして、すべてがうまくいくでしょうが、慣れ親しむプロセスの間に以下が見つかりました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一元化されたリポジトリーの配備を含む、VeeamツールがWindowsで強化されました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxでは、Veeamエージェントしかありません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに基づいて、組織がLinuxのみを使用している場合、レポートは表示されないことがわかります。または、Windowsを購入してインストールし、その中にすでに必要なすべてのものをインストールして構成し、そこからVeeamエージェント（Linux）の結果に関する完全な情報を取得します。または、各車に行って、エージェントの次の「稼働日」がそこにどのように行ったかを確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、Linuxだけを使用していて、本当にバックアップして、できれば無料でバックアップする必要のある小さな組織が見つかった日が来ました。しかし、エージェントがそこでどのように機能したかを毎日監視するために、サーバーでの大規模なレイドではなく、集中的に行いたいと思います。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するには、Veeam WebサイトのFAQにアクセスし、コンソールを使用して何が得られるか、および使用可能なveeamエージェントコマンドを読む必要がありました。</font><font style="vertical-align: inherit;">読み込まれた内容から、最後のタスクの結果と、バックアップを保存するために設計されたネットワークフォルダー内の1つの空き領域を確認する小さなBashスクリプトが生まれました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、このスクリプトを共有したいと思います。</font><font style="vertical-align: inherit;">すぐに警告します。私はスクリプトが得意ではないので、批判や提案を歓迎します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check_veeam_backup.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment"># PARAMETRS</span><font></font>
<font></font>
HOST=`hostname`<font></font>
REPORT_NAME_FORMAT=<span class="hljs-string">"%d-%m-%Y"</span>
CURRENT_DATE_FORMAT=<span class="hljs-string">"%d.%m.%Y"</span>
CURRENT_TIME_FORMAT=<span class="hljs-string">"%H:%M:%S"</span>
REPORT_FILE=report_$(date +<span class="hljs-variable">$REPORT_NAME_FORMAT</span>).<span class="hljs-built_in">log</span>
<span class="hljs-comment">#TOKEN="000000000:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>
<span class="hljs-comment">#RECIP_ID="00000000"</span>
REPOSITORY=<span class="hljs-string">" "</span>
MOUNT_POINT=<span class="hljs-string">" "</span>
<span class="hljs-comment"># MOUNT_USER=" "</span>
<span class="hljs-comment"># MOUNT_PASSWORD=" "</span><font></font>
<font></font>
<span class="hljs-comment"># Get Veeam job list</span><font></font>
<font></font>
JOB_LIST=($(awk <span class="hljs-string">'NR&gt;1 {print$1}'</span> &lt;&lt;&lt; <span class="hljs-string">"<span class="hljs-subst">$(veeamconfig job list)</span>"</span>))<font></font>
JOB_RESULT_PATH=<span class="hljs-string">"/var/log/veeam/Backup/"</span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nStart check on <span class="hljs-subst">$(date +$CURRENT_DATE_FORMAT)</span> at <span class="hljs-subst">$(date +$CURRENT_TIME_FORMAT)</span>\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span><font></font>
<font></font>
<span class="hljs-comment"># Check result Veeam backup job</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> JOB <span class="hljs-keyword">in</span> <span class="hljs-variable">$JOB_LIST</span>
        <span class="hljs-keyword">do</span>
                <span class="hljs-built_in">echo</span> ------------------------------------------------------ &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> Check Schedule job name: <span class="hljs-variable">$JOB</span> from Host: <span class="hljs-variable">$HOST</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"------------------------------------------------------\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(veeamconfig schedule  show --jobName $JOB)</span>\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> ------------------------------------------------------ &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> Check latest session Job name: <span class="hljs-variable">$JOB</span> from Host: <span class="hljs-variable">$HOST</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"------------------------------------------------------\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
                LAST_JOB_RESULT=$(ls -t <span class="hljs-variable">$JOB_RESULT_PATH</span>/<span class="hljs-variable">$JOB</span> | head -n1 | cut -c 25-)<font></font>
                veeamconfig session info --id <span class="hljs-variable">$LAST_JOB_RESULT</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
        <span class="hljs-keyword">done</span>
<span class="hljs-built_in">echo</span> ------------------------------------------------------ &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> Stop check on $(date +<span class="hljs-variable">$CURRENT_DATE_FORMAT</span>) at $(date +<span class="hljs-variable">$CURRENT_TIME_FORMAT</span>) &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-comment"># if the repository owner is not root </span>
<span class="hljs-comment"># mount -t cifs -o user=$MOUNT_USER,password=$MOUNT_PASSWORD $REPOSITORY $MOUNT_POINT</span>
mount -t cifs <span class="hljs-variable">$REPOSITORY</span> <span class="hljs-variable">$MOUNT_POINT</span>
<span class="hljs-built_in">echo</span> ------------------------------------------------------ &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"Check files in backup repository:\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
ls -h <span class="hljs-variable">$MOUNT_POINT</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> ------------------------------------------------------ &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"Check free space on backup repository:\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(df -h $MOUNT_POINT)</span>\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"------------------------------------------------------\n\n\n"</span> &gt;&gt; <span class="hljs-variable">$REPORT_FILE</span><font></font>
sleep 30<font></font>
umount <span class="hljs-variable">$MOUNT_POINT</span><font></font>
<font></font>
SEND_RESULT=<span class="hljs-string">"<span class="hljs-subst">$(echo -e <span class="hljs-string">"<span class="hljs-subst">$(cat ${REPORT_FILE})</span>"</span>)</span>"</span><font></font>
<font></font>
<span class="hljs-comment"># Send result to telegram</span>
<span class="hljs-comment"># Uncomment the next line to send results to telegram</span>
<span class="hljs-comment"># curl --silent --data "html&amp;text=$SEND_RESULT" https://api.telegram.org/bot$TOKEN/sendMessage?chat_id=$RECIP_ID&amp;parse_mode=</span><font></font>
<font></font>
<span class="hljs-comment"># Send result to email</span>
<span class="hljs-comment"># Uncomment the next line to send the results by email and replace &lt;your_mail@yuor_domain&gt;</span>
<span class="hljs-comment"># mail -s "Report $HOST - $(date +$CURRENT_DATE_FORMAT)" your_mail@yuor_domen &lt; $REPORT_FILE</span><font></font>
<font></font>
<span class="hljs-comment"># if you want delete report file, uncomment next line </span>
<span class="hljs-comment"># rm -rf $REPORT_FILE #Delete log file</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの結果として、レポートは次のように作成されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">Start check on 10.09.2019 at 14:13:30<font></font>
------------------------------------------------------<font></font>
Check Schedule job name: HP from Host: hp<font></font>
------------------------------------------------------<font></font>
Every day<font></font>
At: 23:00<font></font>
Run automatically: enabled<font></font>
------------------------------------------------------<font></font>
Check latest session Job name: HP from Host: hp<font></font>
------------------------------------------------------<font></font>
Backup session<font></font>
   ID: {555ebf40-2fb9-47cc-baf0-7192c0ae896e}<font></font>
   Job name: HP<font></font>
   Job ID: {435117d7-ace8-4009-9c51-b00e8174c252}<font></font>
   State: Success<font></font>
   Start time: 2019-09-06 22:43:19<font></font>
   End time: 2019-09-07 00:02:14<font></font>
------------------------------------------------------<font></font>
Stop check on 10.09.2019 at 14:13:30<font></font>
------------------------------------------------------<font></font>
Check files in backup repository:<font></font>
media media<font></font>
------------------------------------------------------<font></font>
Check free space on backup repository:<font></font>
               %  C <font></font>
//share/backup           1,8T          96G                  1,7T        6%                     /media/backup_repository<font></font>
------------------------------------------------------ </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選択した方法に応じて、レポートはメールまたはテレグラム（私の場合）に送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/8y/wd/xb8ywd4ywemezru3n2qrszenuym.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、タスクをcrontabに毎日追加します。たとえば、毎日午前9時</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 9 * * * / scripts / check_veeam_backup.sh&gt; / dev / null ＃午前9時の毎日のチェック</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
スクリプトは毎朝実行され、就業日が始まるまでに、エージェントの作業とバックアップサーバーの使用可能なスペースに関するすべての情報が手元にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトですべてがスムーズであるとは限りません。特に、特別なユーザーだけがアクセスできるネットワークフォルダーをマウントするためのユーザー名とパスワードが必要です。</font><font style="vertical-align: inherit;">ただし、このユーザーに読み取りのみを許可する場合、明確なプラスがあります。</font><font style="vertical-align: inherit;">偶然であっても、バックアップがこのユーザーによってこすられることは決してありません。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467421/index.html">C ++でリモートメモリの表現力豊かなスマートポインタを作成する</a></li>
<li><a href="../ja467423/index.html">Xamarin.Forms-アプリケーションでのアイコンフォントの便利な使用法</a></li>
<li><a href="../ja467425/index.html">STEM集中学習アプローチ</a></li>
<li><a href="../ja467427/index.html">BudgetTracker-個人の財務会計用のもう1つのオープンソースツール</a></li>
<li><a href="../ja467429/index.html">Habrastatistics：サイトの最も訪問されたセクションと最も訪問されていないセクションの探索</a></li>
<li><a href="../ja467439/index.html">なぜレコード盤が戻ってきたのですか、ストリーミングサービスはこれにどのように関連していますか？</a></li>
<li><a href="../ja467441/index.html">Dockerはcnab-to-ociをCNABプロジェクトに渡します...そして一般的にCNABは何ですか？</a></li>
<li><a href="../ja467443/index.html">マルチメディアセンター「コディ」とヨクトプロジェクト</a></li>
<li><a href="../ja467445/index.html">インストールされているWindows更新のわかりにくいリスト</a></li>
<li><a href="../ja467449/index.html">脆弱性の検出と、スマートカードおよび暗号化プロセッサが組み込まれたハッカー攻撃に対する耐性の評価</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>