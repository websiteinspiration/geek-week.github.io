<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤸🏼 ♑️ 🏂🏼 11億のタクシー：108コアのClickHouseクラスター 🔓 🤾🏼 💦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="記事の翻訳は、データエンジニアコースの学生向けに特別に作成されました。
 
 
 
 
 ClickHouseはオープンソースの列データベースです。これは、何百ものアナリストが1日に数百億の新しいレコードが入力された場合でも、詳細なデータをすばやく要求できる優れた環境です。このようなシステムをサポー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>11億のタクシー：108コアのClickHouseクラスター</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/463665/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事の翻訳は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データエンジニア</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの学生向けに特別に作成されました</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/tn/35/7p/tn357puvfbdxdyajjdoxagm47ju.png"><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はオープンソースの列データベースです。これは、何百ものアナリストが1日に数百億の新しいレコードが入力された場合でも、詳細なデータをすばやく要求できる優れた環境です。このようなシステムをサポートするためのインフラストラクチャのコストは、年間10万米ドルに達する可能性があり、使用状況によっては半分になる可能性があります。ある時点で、Yandex.Metrica ClickHouseのインストールには10兆のエントリが含まれていました。 Yandexに加えて、ClickHouseはBloombergとCloudflareでも成功を収めました。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2年前、私は</font><font style="vertical-align: inherit;">1台のマシンを使用してデータベースの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比較分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を行い、</font><font style="vertical-align: inherit;">これが今までにない</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最速の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無料データベースソフトウェアに</font><font style="vertical-align: inherit;">なりまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">。それ以来、開発者はKafka、HDFS、ZStandard圧縮のサポートを含む機能の追加を止めていません。昨年、カスケード圧縮方式のサポートが追加され、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デルタ-デルタ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンコーディングが可能になりました。時系列データを圧縮する場合、ゲージ値はデルタコーディングを使用して適切に圧縮できますが、カウンターにはデルタデルタコーディングを使用する方が良いでしょう。良好な圧縮がClickHouseのパフォーマンスの鍵となっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseは、サードパーティのライブラリを除いて、17万行のC ++コードで構成されており、分散データベースの最小のコードベースの1つです。比較として、SQLiteはC言語で235,000行のコードで構成されるディストリビューションをサポートしていません。この記事の執筆時点では、207人のエンジニアがClickHouseに貢献しており、最近コミットの強度が高まっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2017年3月、ClickHouseは、</font><font style="vertical-align: inherit;">開発を追跡する簡単な方法として</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更ログ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">開始しました</font><font style="vertical-align: inherit;">。また、モノリシックドキュメントファイルをMarkdownベースのファイル階層に分割します。問題と機能はGitHubを通じて追跡され、全体として、このソフトウェアはここ数年ではるかにアクセスしやすくなっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、36コアのプロセッサーとNVMeドライブを使用したAWS EC2でのClickHouseクラスターのパフォーマンスを見ていきます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新：この投稿が最初に公開されてから1週間後、構成を改善してテストを再実行し、はるかに優れた結果を達成しました。</font><font style="vertical-align: inherit;">この投稿は、これらの変更を反映するように更新されています。</font></font></blockquote> <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS EC2クラスターの起動</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この投稿では、c5d.9xlarge EC2の3つのインスタンスを使用します。</font><font style="vertical-align: inherit;">それぞれに36個の仮想CPU、72 GBのRAM、900 GBのNVMe SSDが含まれ、10ギガビットネットワークをサポートしています。</font><font style="vertical-align: inherit;">オンデマンドで起動した場合、eu-west-1リージョンで1時間あたり1,962ドルかかります。</font><font style="vertical-align: inherit;">オペレーティングシステムとしてUbuntu Server 16.04 LTSを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイアウォールは、各マシンが制限なしに相互に通信できるように構成されており、SSHクラスターでIPv4アドレスのみがホワイトリストに登録されています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタンバイNVMe </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseを機能させるために、NVMeドライブの各サーバーにEXT4ファイルシステムを作成します。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo mkfs -t ext4 /dev/nvme1n1<font></font>
$ sudo mkdir /ch<font></font>
$ sudo mount /dev/nvme1n1 /ch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての構成が完了すると、各システムで使用可能なマウントポイントと783 GBのスペースが表示されます。</font></font><br>
<br>
<pre><code class="sql hljs">$ lsblk</code></pre><br>
<pre><code class="sql hljs">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT<font></font>
loop0         7:0    0  87.9M  1 loop /snap/core/5742<font></font>
loop1         7:1    0  16.5M  1 loop /snap/amazon-ssm-agent/784<font></font>
nvme0n1     259:1    0     8G  0 disk<font></font>
└─nvme0n1p1 259:2    0     8G  0 part /<font></font>
nvme1n1     259:0    0 838.2G  0 disk /ch</code></pre><br>
<pre><code class="sql hljs">$ df -h</code></pre><br>
<pre><code class="sql hljs">Filesystem      Size  Used Avail <span class="hljs-keyword">Use</span>% Mounted <span class="hljs-keyword">on</span>
udev             <span class="hljs-number">35</span>G     <span class="hljs-number">0</span>   <span class="hljs-number">35</span>G   <span class="hljs-number">0</span>% /dev<font></font>
tmpfs           <span class="hljs-number">6.9</span>G  <span class="hljs-number">8.8</span>M  <span class="hljs-number">6.9</span>G   <span class="hljs-number">1</span>% /run<font></font>
/dev/nvme0n1p1  <span class="hljs-number">7.7</span>G  <span class="hljs-number">967</span>M  <span class="hljs-number">6.8</span>G  <span class="hljs-number">13</span>% /<font></font>
tmpfs            <span class="hljs-number">35</span>G     <span class="hljs-number">0</span>   <span class="hljs-number">35</span>G   <span class="hljs-number">0</span>% /dev/shm<font></font>
tmpfs           <span class="hljs-number">5.0</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">5.0</span>M   <span class="hljs-number">0</span>% /run/<span class="hljs-keyword">lock</span>
tmpfs            <span class="hljs-number">35</span>G     <span class="hljs-number">0</span>   <span class="hljs-number">35</span>G   <span class="hljs-number">0</span>% /<span class="hljs-keyword">sys</span>/fs/cgroup<font></font>
/dev/loop0       <span class="hljs-number">88</span>M   <span class="hljs-number">88</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/core/<span class="hljs-number">5742</span>
/dev/loop1       <span class="hljs-number">17</span>M   <span class="hljs-number">17</span>M     <span class="hljs-number">0</span> <span class="hljs-number">100</span>% /snap/amazon-ssm-<span class="hljs-keyword">agent</span>/<span class="hljs-number">784</span>
tmpfs           <span class="hljs-number">6.9</span>G     <span class="hljs-number">0</span>  <span class="hljs-number">6.9</span>G   <span class="hljs-number">0</span>% /run/<span class="hljs-keyword">user</span>/<span class="hljs-number">1000</span>
/dev/nvme1n1    <span class="hljs-number">825</span>G   <span class="hljs-number">73</span>M  <span class="hljs-number">783</span>G   <span class="hljs-number">1</span>% /ch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストで使用するデータセットは、ニューヨークで6年間に行われた11億のタクシーで生成されたデータダンプです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redshift</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Billion Taxi</font></a><font style="vertical-align: inherit;">ブログ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">で</font></a><font style="vertical-align: inherit;">は、このデータセットの収集方法について詳しく説明しています。</font><font style="vertical-align: inherit;">それらはAWS S3に格納されているので、アクセスと秘密キーを使用してAWSコマンドラインインターフェイスを構成します。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo apt <span class="hljs-keyword">update</span>
$ sudo apt <span class="hljs-keyword">install</span> awscli<font></font>
$ aws configure</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時クライアント要求数の制限を100に設定して、ファイルが標準設定よりも速くロードされるようにします。</font></font><br>
<br>
<pre><code class="sql hljs">$ aws configure <span class="hljs-keyword">set</span> \<font></font>
    default.s3.max_concurrent_requests \<font></font>
    <span class="hljs-number">100</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWS S3からタクシーの乗車データセットをダウンロードし、最初のサーバーのNVMeドライブに保存します。</font><font style="vertical-align: inherit;">このデータセットは、GZIP圧縮CSV形式で約104 GBです。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo mkdir -p /ch/csv<font></font>
$ sudo chown -R ubuntu /ch/csv<font></font>
$ aws s3 sync s3://&lt;bucket&gt;/csv /ch/csv</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseをインストールする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのマシンすべてにClickHouseを分散インストールするために必要なApache ZooKeeperを実行する必要があるため、Java 8用のOpenJDKディストリビューションをインストールします。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo apt <span class="hljs-keyword">update</span>
$ sudo apt <span class="hljs-keyword">install</span> \<font></font>
    openjdk<span class="hljs-number">-8</span>-jre \<font></font>
    openjdk<span class="hljs-number">-8</span>-jdk-headless</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、環境変数を設定します</font></font><code>JAVA_HOME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo vi /etc/profile<font></font>
 <font></font>
export JAVA_HOME=/usr<font></font>
 <font></font>
$ source /etc/profile</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Ubuntuのパッケージ管理システムを使用して、3台すべてのマシンにClickHouse 18.16.1、glances、ZooKeeperをインストールします。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo apt-key adv \
    <span class="hljs-comment">--keyserver hkp://keyserver.ubuntu.com:80 \</span>
    <span class="hljs-comment">--recv E0C56BD4</span><font></font>
$ echo "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/" | \<font></font>
    sudo tee /etc/apt/sources.list.d/clickhouse.list<font></font>
$ sudo apt-get <span class="hljs-keyword">update</span></code></pre><br>
<pre><code class="sql hljs">$ sudo apt <span class="hljs-keyword">install</span> \<font></font>
    clickhouse-<span class="hljs-keyword">client</span> \<font></font>
    clickhouse-<span class="hljs-keyword">server</span> \<font></font>
    glances \<font></font>
    zookeeperd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouse用のディレクトリを作成し、3つすべてのサーバーでいくつかの構成をオーバーライドします。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo mkdir /ch/clickhouse<font></font>
$ sudo chown -R clickhouse /ch/clickhouse<font></font>
<font></font>
$ sudo mkdir -p /etc/clickhouse-server/conf.d<font></font>
$ sudo vi /etc/clickhouse-server/conf.d/taxis.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは、使用する構成オーバーライドです。</font></font><br>
<br>
<pre><code class="sql hljs">&lt;?xml version="1.0"?&gt;<font></font>
&lt;yandex&gt;<font></font>
    &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt;<font></font>
    &lt;path&gt;/ch/clickhouse/&lt;/path&gt;<font></font>
</code></pre><br>
 <pre><code class="sql hljs"> &lt;remote_servers&gt;<font></font>
        &lt;perftest_3shards&gt;<font></font>
            &lt;shard&gt;<font></font>
                &lt;replica&gt;<font></font>
                    &lt;host&gt;172.30.2.192&lt;/host&gt;<font></font>
                    &lt;port&gt;9000&lt;/port&gt;<font></font>
                 &lt;/replica&gt;<font></font>
            &lt;/shard&gt;<font></font>
            &lt;shard&gt;<font></font>
                 &lt;replica&gt;<font></font>
                    &lt;host&gt;172.30.2.162&lt;/host&gt;<font></font>
                    &lt;port&gt;9000&lt;/port&gt;<font></font>
                 &lt;/replica&gt;<font></font>
            &lt;/shard&gt;<font></font>
            &lt;shard&gt;<font></font>
                 &lt;replica&gt;<font></font>
                    &lt;host&gt;172.30.2.36&lt;/host&gt;<font></font>
                    &lt;port&gt;9000&lt;/port&gt;<font></font>
                 &lt;/replica&gt;<font></font>
            &lt;/shard&gt;<font></font>
        &lt;/perftest_3shards&gt;<font></font>
    &lt;/remote_servers&gt;</code></pre><br>
 <pre><code class="sql hljs">  &lt;zookeeper-servers&gt;<font></font>
        &lt;node&gt;<font></font>
            &lt;host&gt;172.30.2.192&lt;/host&gt;<font></font>
            &lt;port&gt;2181&lt;/port&gt;<font></font>
        &lt;/node&gt;<font></font>
        &lt;node&gt;<font></font>
            &lt;host&gt;172.30.2.162&lt;/host&gt;<font></font>
            &lt;port&gt;2181&lt;/port&gt;<font></font>
        &lt;/node&gt;<font></font>
        &lt;node&gt;<font></font>
            &lt;host&gt;172.30.2.36&lt;/host&gt;<font></font>
            &lt;port&gt;2181&lt;/port&gt;<font></font>
        &lt;/node&gt;<font></font>
    &lt;/zookeeper-servers&gt;</code></pre><br>
 <pre><code class="sql hljs"> &lt;macros&gt;<font></font>
        &lt;shard&gt;03&lt;/shard&gt;<font></font>
        &lt;replica&gt;01&lt;/replica&gt;<font></font>
    &lt;/macros&gt;<font></font>
&lt;/yandex&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、3つのマシンすべてでZooKeeperとClickHouseサーバーを起動します。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo /etc/init.d/zookeeper <span class="hljs-keyword">start</span>
$ sudo service clickhouse-<span class="hljs-keyword">server</span> <span class="hljs-keyword">start</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseへのデータの読み込み</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のサーバーで、トラベルテーブル（</font></font><code>trips</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を作成します。このテーブルに</font><font style="vertical-align: inherit;">は、ログエンジンを使用してタクシーのデータセットが格納されます。</font></font><br>
<br>
<pre><code class="sql hljs">$ clickhouse-client <span class="hljs-comment">--host=0.0.0.0</span><font></font>
 <font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips (<font></font>
    trip_id                 UInt32,<font></font>
    vendor_id               <span class="hljs-keyword">String</span>,<font></font>
<font></font>
    pickup_datetime         DateTime,<font></font>
    dropoff_datetime        Nullable(DateTime),<font></font>
<font></font>
    store_and_fwd_flag      Nullable(FixedString(<span class="hljs-number">1</span>)),<font></font>
    rate_code_id            Nullable(UInt8),<font></font>
    pickup_longitude        Nullable(Float64),<font></font>
    pickup_latitude         Nullable(Float64),<font></font>
    dropoff_longitude       Nullable(Float64),<font></font>
    dropoff_latitude        Nullable(Float64),<font></font>
    passenger_count         Nullable(UInt8),<font></font>
    trip_distance           Nullable(Float64),<font></font>
    fare_amount             Nullable(Float32),<font></font>
    extra                   Nullable(Float32),<font></font>
    mta_tax                 Nullable(Float32),<font></font>
    tip_amount              Nullable(Float32),<font></font>
    tolls_amount            Nullable(Float32),<font></font>
    ehail_fee               Nullable(Float32),<font></font>
    improvement_surcharge   Nullable(Float32),<font></font>
    total_amount            Nullable(Float32),<font></font>
    payment_type            Nullable(<span class="hljs-keyword">String</span>),<font></font>
    trip_type               Nullable(UInt8),<font></font>
    pickup                  Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff                 Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    cab_type                Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    precipitation           Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    snow_depth              Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    snowfall                Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    max_temperature         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    min_temperature         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    average_wind_speed      Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
<font></font>
    pickup_nyct2010_gid     Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    pickup_ctlabel          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_borocode         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    pickup_boroname         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_ct2010           Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_boroct2010       Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_cdeligibil       Nullable(FixedString(<span class="hljs-number">1</span>)),<font></font>
    pickup_ntacode          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_ntaname          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_puma             Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    dropoff_nyct2010_gid    Nullable(UInt8),<font></font>
    dropoff_ctlabel         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_borocode        Nullable(UInt8),<font></font>
    dropoff_boroname        Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ct2010          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_boroct2010      Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_cdeligibil      Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ntacode         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ntaname         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_puma            Nullable(<span class="hljs-keyword">String</span>)<font></font>
) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">Log</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、各CSVファイルを解凍してトラベルテーブルにアップロードします（</font></font><code>trips</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">以下は55分10秒で行われます。</font><font style="vertical-align: inherit;">この操作後、データディレクトリのサイズは134 GBでした。</font></font><br>
<br>
<pre><code class="sql hljs">$ time (for FILENAME in /ch/csv/trips_x*.csv.gz; <span class="hljs-keyword">do</span><font></font>
            echo $FILENAME<font></font>
            gunzip -c $FILENAME | \<font></font>
                clickhouse-<span class="hljs-keyword">client</span> \
                    <span class="hljs-comment">--host=0.0.0.0 \</span>
                    <span class="hljs-comment">--query="INSERT INTO trips FORMAT CSV"</span>
        done)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インポート速度は、1秒あたり155 MBの非圧縮CSVコンテンツでした。</font><font style="vertical-align: inherit;">これはGZIP解凍のボトルネックが原因であったと思います。</font><font style="vertical-align: inherit;">xargsを使用してすべてのgzipファイルを並行して解凍し、解凍したデータをダウンロードする方が高速だったかもしれません。</font><font style="vertical-align: inherit;">以下は、CSVインポートプロセス中に報告された内容の説明です。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo glances</code></pre><br>
<pre><code class="sql hljs">ip-172-30-2-200 (Ubuntu 16.04 64bit / Linux 4.4.0-1072-aws)                                                                                                 Uptime: 0:11:42<font></font>
CPU       8.2%  nice:     0.0%                           <span class="hljs-keyword">LOAD</span>    <span class="hljs-number">36</span>-core                           MEM      <span class="hljs-number">9.8</span>%  active:    <span class="hljs-number">5.20</span>G                           SWAP      <span class="hljs-number">0.0</span>%
<span class="hljs-keyword">user</span>:     <span class="hljs-number">6.0</span>%  irq:      <span class="hljs-number">0.0</span>%                           <span class="hljs-number">1</span> <span class="hljs-keyword">min</span>:    <span class="hljs-number">2.24</span>                            total:  <span class="hljs-number">68.7</span>G  inactive:  <span class="hljs-number">61.0</span>G                           total:       <span class="hljs-number">0</span>
<span class="hljs-keyword">system</span>:   <span class="hljs-number">0.9</span>%  iowait:   <span class="hljs-number">1.3</span>%                           <span class="hljs-number">5</span> <span class="hljs-keyword">min</span>:    <span class="hljs-number">1.83</span>                            used:   <span class="hljs-number">6.71</span>G  buffers:   <span class="hljs-number">66.4</span>M                           used:        <span class="hljs-number">0</span>
idle:    <span class="hljs-number">91.8</span>%  steal:    <span class="hljs-number">0.0</span>%                           <span class="hljs-number">15</span> <span class="hljs-keyword">min</span>:   <span class="hljs-number">1.01</span>                            free:   <span class="hljs-number">62.0</span>G  cached:    <span class="hljs-number">61.6</span>G                           free:        <span class="hljs-number">0</span><font></font>
<font></font>
NETWORK     Rx/s   Tx/s   TASKS <span class="hljs-number">370</span> (<span class="hljs-number">507</span> thr), <span class="hljs-number">2</span> run, <span class="hljs-number">368</span> slp, <span class="hljs-number">0</span> oth sorted automatically <span class="hljs-keyword">by</span> cpu_percent, flat <span class="hljs-keyword">view</span>
ens5        <span class="hljs-number">136</span>b    <span class="hljs-number">2</span>Kb<font></font>
lo         <span class="hljs-number">343</span>Mb  <span class="hljs-number">343</span>Mb     CPU%  MEM%  VIRT   RES   PID <span class="hljs-keyword">USER</span>        NI S    <span class="hljs-built_in">TIME</span>+ IOR/s IOW/s Command
                           <span class="hljs-number">100.4</span>   <span class="hljs-number">1.5</span> <span class="hljs-number">1.65</span>G <span class="hljs-number">1.06</span>G  <span class="hljs-number">9909</span> ubuntu       <span class="hljs-number">0</span> S  <span class="hljs-number">1</span>:<span class="hljs-number">01.33</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--host=0.0.0.0 --query=INSERT INTO trips FORMAT CSV</span>
DISK I/O     R/s    W/s     <span class="hljs-number">85.1</span>   <span class="hljs-number">0.0</span> <span class="hljs-number">4.65</span>M  <span class="hljs-number">708</span>K  <span class="hljs-number">9908</span> ubuntu       <span class="hljs-number">0</span> R  <span class="hljs-number">0</span>:<span class="hljs-number">50.60</span>   <span class="hljs-number">32</span>M     <span class="hljs-number">0</span> gzip -d -c /ch/csv/trips_xac.csv.gz<font></font>
loop0          <span class="hljs-number">0</span>      <span class="hljs-number">0</span>     <span class="hljs-number">54.9</span>   <span class="hljs-number">5.1</span> <span class="hljs-number">8.14</span>G <span class="hljs-number">3.49</span>G  <span class="hljs-number">8091</span> clickhous    <span class="hljs-number">0</span> S  <span class="hljs-number">1</span>:<span class="hljs-number">44.23</span>     <span class="hljs-number">0</span>   <span class="hljs-number">45</span>M /usr/<span class="hljs-keyword">bin</span>/clickhouse-<span class="hljs-keyword">server</span> <span class="hljs-comment">--config=/etc/clickhouse-server/config.xml</span>
loop1          <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">4.5</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>   <span class="hljs-number">319</span> root         <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">07.50</span>    <span class="hljs-number">1</span>K     <span class="hljs-number">0</span> kworker/u72:<span class="hljs-number">2</span>
nvme0n1        <span class="hljs-number">0</span>     <span class="hljs-number">3</span>K      <span class="hljs-number">2.3</span>   <span class="hljs-number">0.0</span> <span class="hljs-number">91.1</span>M <span class="hljs-number">28.9</span>M  <span class="hljs-number">9912</span> root         <span class="hljs-number">0</span> R  <span class="hljs-number">0</span>:<span class="hljs-number">01.56</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> /usr/<span class="hljs-keyword">bin</span>/python3 /usr/<span class="hljs-keyword">bin</span>/glances<font></font>
nvme0n1p1      <span class="hljs-number">0</span>     <span class="hljs-number">3</span>K      <span class="hljs-number">0.3</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>   <span class="hljs-number">960</span> root       <span class="hljs-number">-20</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.10</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> kworker/<span class="hljs-number">28</span>:<span class="hljs-number">1</span>H<font></font>
nvme1n1    <span class="hljs-number">32.1</span>M   <span class="hljs-number">495</span>M      <span class="hljs-number">0.3</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>  <span class="hljs-number">1058</span> root       <span class="hljs-number">-20</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.90</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> kworker/<span class="hljs-number">23</span>:<span class="hljs-number">1</span>H</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
続行する前にソースCSVファイルを削除して、NVMeドライブのスペースを解放します。</font></font><br>
<br>
<pre><code class="sql hljs">$ sudo rm -fr /ch/csv</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列形式に変換</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Log ClickHouseエンジンは、データを行指向の形式で格納します。</font><font style="vertical-align: inherit;">データをより速くリクエストするために、MergeTreeエンジンを使用してデータを列形式に変換します。</font></font><br>
<br>
<pre><code class="sql hljs">$ clickhouse-client <span class="hljs-comment">--host=0.0.0.0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、34分50秒で完了します。</font><font style="vertical-align: inherit;">この操作後、データディレクトリのサイズは237 GBでした。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_mergetree
    <span class="hljs-keyword">ENGINE</span> = MergeTree(pickup_date, pickup_datetime, <span class="hljs-number">8192</span>)
    <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span><font></font>
        trip_id,<font></font>
        <span class="hljs-keyword">CAST</span>(vendor_id <span class="hljs-keyword">AS</span> Enum8(<span class="hljs-string">'1'</span> = <span class="hljs-number">1</span>,
                                <span class="hljs-string">'2'</span> = <span class="hljs-number">2</span>,
                                <span class="hljs-string">'CMT'</span> = <span class="hljs-number">3</span>,
                                <span class="hljs-string">'VTS'</span> = <span class="hljs-number">4</span>,
                                <span class="hljs-string">'DDS'</span> = <span class="hljs-number">5</span>,
                                <span class="hljs-string">'B02512'</span> = <span class="hljs-number">10</span>,
                                <span class="hljs-string">'B02598'</span> = <span class="hljs-number">11</span>,
                                <span class="hljs-string">'B02617'</span> = <span class="hljs-number">12</span>,
                                <span class="hljs-string">'B02682'</span> = <span class="hljs-number">13</span>,
                                <span class="hljs-string">'B02764'</span> = <span class="hljs-number">14</span>)) <span class="hljs-keyword">AS</span> vendor_id,<font></font>
        toDate(pickup_datetime)                 <span class="hljs-keyword">AS</span> pickup_date,
        <span class="hljs-keyword">ifNull</span>(pickup_datetime, toDateTime(<span class="hljs-number">0</span>))  <span class="hljs-keyword">AS</span> pickup_datetime,<font></font>
        toDate(dropoff_datetime)                <span class="hljs-keyword">AS</span> dropoff_date,
        <span class="hljs-keyword">ifNull</span>(dropoff_datetime, toDateTime(<span class="hljs-number">0</span>)) <span class="hljs-keyword">AS</span> dropoff_datetime,<font></font>
        assumeNotNull(store_and_fwd_flag)       <span class="hljs-keyword">AS</span> store_and_fwd_flag,<font></font>
        assumeNotNull(rate_code_id)             <span class="hljs-keyword">AS</span> rate_code_id,<font></font>
<font></font>
        assumeNotNull(pickup_longitude)         <span class="hljs-keyword">AS</span> pickup_longitude,<font></font>
        assumeNotNull(pickup_latitude)          <span class="hljs-keyword">AS</span> pickup_latitude,<font></font>
        assumeNotNull(dropoff_longitude)        <span class="hljs-keyword">AS</span> dropoff_longitude,<font></font>
        assumeNotNull(dropoff_latitude)         <span class="hljs-keyword">AS</span> dropoff_latitude,<font></font>
        assumeNotNull(passenger_count)          <span class="hljs-keyword">AS</span> passenger_count,<font></font>
        assumeNotNull(trip_distance)            <span class="hljs-keyword">AS</span> trip_distance,<font></font>
        assumeNotNull(fare_amount)              <span class="hljs-keyword">AS</span> fare_amount,<font></font>
        assumeNotNull(extra)                    <span class="hljs-keyword">AS</span> extra,<font></font>
        assumeNotNull(mta_tax)                  <span class="hljs-keyword">AS</span> mta_tax,<font></font>
        assumeNotNull(tip_amount)               <span class="hljs-keyword">AS</span> tip_amount,<font></font>
        assumeNotNull(tolls_amount)             <span class="hljs-keyword">AS</span> tolls_amount,<font></font>
        assumeNotNull(ehail_fee)                <span class="hljs-keyword">AS</span> ehail_fee,<font></font>
        assumeNotNull(improvement_surcharge)    <span class="hljs-keyword">AS</span> improvement_surcharge,<font></font>
        assumeNotNull(total_amount)             <span class="hljs-keyword">AS</span> total_amount,<font></font>
        assumeNotNull(payment_type)             <span class="hljs-keyword">AS</span> payment_type_,<font></font>
        assumeNotNull(trip_type)                <span class="hljs-keyword">AS</span> trip_type,<font></font>
<font></font>
        pickup <span class="hljs-keyword">AS</span> pickup,<font></font>
        pickup <span class="hljs-keyword">AS</span> dropoff,<font></font>
<font></font>
        <span class="hljs-keyword">CAST</span>(assumeNotNull(cab_type)
            <span class="hljs-keyword">AS</span> Enum8(<span class="hljs-string">'yellow'</span> = <span class="hljs-number">1</span>, <span class="hljs-string">'green'</span> = <span class="hljs-number">2</span>))
                                <span class="hljs-keyword">AS</span> cab_type,<font></font>
<font></font>
        precipitation           <span class="hljs-keyword">AS</span> precipitation,<font></font>
        snow_depth              <span class="hljs-keyword">AS</span> snow_depth,<font></font>
        snowfall                <span class="hljs-keyword">AS</span> snowfall,<font></font>
        max_temperature         <span class="hljs-keyword">AS</span> max_temperature,<font></font>
        min_temperature         <span class="hljs-keyword">AS</span> min_temperature,<font></font>
        average_wind_speed      <span class="hljs-keyword">AS</span> average_wind_speed,<font></font>
<font></font>
        pickup_nyct2010_gid     <span class="hljs-keyword">AS</span> pickup_nyct2010_gid,<font></font>
        pickup_ctlabel          <span class="hljs-keyword">AS</span> pickup_ctlabel,<font></font>
        pickup_borocode         <span class="hljs-keyword">AS</span> pickup_borocode,<font></font>
        pickup_boroname         <span class="hljs-keyword">AS</span> pickup_boroname,<font></font>
        pickup_ct2010           <span class="hljs-keyword">AS</span> pickup_ct2010,<font></font>
        pickup_boroct2010       <span class="hljs-keyword">AS</span> pickup_boroct2010,<font></font>
        pickup_cdeligibil       <span class="hljs-keyword">AS</span> pickup_cdeligibil,<font></font>
        pickup_ntacode          <span class="hljs-keyword">AS</span> pickup_ntacode,<font></font>
        pickup_ntaname          <span class="hljs-keyword">AS</span> pickup_ntaname,<font></font>
        pickup_puma             <span class="hljs-keyword">AS</span> pickup_puma,<font></font>
<font></font>
        dropoff_nyct2010_gid    <span class="hljs-keyword">AS</span> dropoff_nyct2010_gid,<font></font>
        dropoff_ctlabel         <span class="hljs-keyword">AS</span> dropoff_ctlabel,<font></font>
        dropoff_borocode        <span class="hljs-keyword">AS</span> dropoff_borocode,<font></font>
        dropoff_boroname        <span class="hljs-keyword">AS</span> dropoff_boroname,<font></font>
        dropoff_ct2010          <span class="hljs-keyword">AS</span> dropoff_ct2010,<font></font>
        dropoff_boroct2010      <span class="hljs-keyword">AS</span> dropoff_boroct2010,<font></font>
        dropoff_cdeligibil      <span class="hljs-keyword">AS</span> dropoff_cdeligibil,<font></font>
        dropoff_ntacode         <span class="hljs-keyword">AS</span> dropoff_ntacode,<font></font>
        dropoff_ntaname         <span class="hljs-keyword">AS</span> dropoff_ntaname,<font></font>
        dropoff_puma            <span class="hljs-keyword">AS</span> dropoff_puma
    <span class="hljs-keyword">FROM</span> trips;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作中のglance出力は次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs">ip-172-30-2-200 (Ubuntu 16.04 64bit / Linux 4.4.0-1072-aws)                                                                                                 Uptime: 1:06:09<font></font>
CPU      10.3%  nice:     0.0%                           <span class="hljs-keyword">LOAD</span>    <span class="hljs-number">36</span>-core                           MEM     <span class="hljs-number">16.1</span>%  active:    <span class="hljs-number">13.3</span>G                           SWAP      <span class="hljs-number">0.0</span>%
<span class="hljs-keyword">user</span>:     <span class="hljs-number">7.9</span>%  irq:      <span class="hljs-number">0.0</span>%                           <span class="hljs-number">1</span> <span class="hljs-keyword">min</span>:    <span class="hljs-number">1.87</span>                            total:  <span class="hljs-number">68.7</span>G  inactive:  <span class="hljs-number">52.8</span>G                           total:       <span class="hljs-number">0</span>
<span class="hljs-keyword">system</span>:   <span class="hljs-number">1.6</span>%  iowait:   <span class="hljs-number">0.8</span>%                           <span class="hljs-number">5</span> <span class="hljs-keyword">min</span>:    <span class="hljs-number">1.76</span>                            used:   <span class="hljs-number">11.1</span>G  buffers:   <span class="hljs-number">71.8</span>M                           used:        <span class="hljs-number">0</span>
idle:    <span class="hljs-number">89.7</span>%  steal:    <span class="hljs-number">0.0</span>%                           <span class="hljs-number">15</span> <span class="hljs-keyword">min</span>:   <span class="hljs-number">1.95</span>                            free:   <span class="hljs-number">57.6</span>G  cached:    <span class="hljs-number">57.2</span>G                           free:        <span class="hljs-number">0</span><font></font>
<font></font>
NETWORK     Rx/s   Tx/s   TASKS <span class="hljs-number">367</span> (<span class="hljs-number">523</span> thr), <span class="hljs-number">1</span> run, <span class="hljs-number">366</span> slp, <span class="hljs-number">0</span> oth sorted automatically <span class="hljs-keyword">by</span> cpu_percent, flat <span class="hljs-keyword">view</span>
ens5         <span class="hljs-number">1</span>Kb    <span class="hljs-number">8</span>Kb<font></font>
lo           <span class="hljs-number">2</span>Kb    <span class="hljs-number">2</span>Kb     CPU%  MEM%  VIRT   RES   PID <span class="hljs-keyword">USER</span>        NI S    <span class="hljs-built_in">TIME</span>+ IOR/s IOW/s Command
                           <span class="hljs-number">241.9</span>  <span class="hljs-number">12.8</span> <span class="hljs-number">20.7</span>G <span class="hljs-number">8.78</span>G  <span class="hljs-number">8091</span> clickhous    <span class="hljs-number">0</span> S <span class="hljs-number">30</span>:<span class="hljs-number">36.73</span>   <span class="hljs-number">34</span>M  <span class="hljs-number">125</span>M /usr/<span class="hljs-keyword">bin</span>/clickhouse-<span class="hljs-keyword">server</span> <span class="hljs-comment">--config=/etc/clickhouse-server/config.xml</span>
DISK I/O     R/s    W/s      <span class="hljs-number">2.6</span>   <span class="hljs-number">0.0</span> <span class="hljs-number">90.4</span>M <span class="hljs-number">28.3</span>M  <span class="hljs-number">9948</span> root         <span class="hljs-number">0</span> R  <span class="hljs-number">1</span>:<span class="hljs-number">18.53</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> /usr/<span class="hljs-keyword">bin</span>/python3 /usr/<span class="hljs-keyword">bin</span>/glances<font></font>
loop0          <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1.3</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>   <span class="hljs-number">203</span> root         <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">09.82</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> kswapd0<font></font>
loop1          <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0.3</span>   <span class="hljs-number">0.1</span>  <span class="hljs-number">315</span>M <span class="hljs-number">61.3</span>M <span class="hljs-number">15701</span> ubuntu       <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.40</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> clickhouse-<span class="hljs-keyword">client</span> <span class="hljs-comment">--host=0.0.0.0</span>
nvme0n1        <span class="hljs-number">0</span>     <span class="hljs-number">3</span>K      <span class="hljs-number">0.3</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">7</span> root         <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.83</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> rcu_sched<font></font>
nvme0n1p1      <span class="hljs-number">0</span>     <span class="hljs-number">3</span>K      <span class="hljs-number">0.0</span>   <span class="hljs-number">0.0</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span>   <span class="hljs-number">142</span> root         <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.22</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> <span class="hljs-keyword">migration</span>/<span class="hljs-number">27</span>
nvme1n1    <span class="hljs-number">25.8</span>M   <span class="hljs-number">330</span>M      <span class="hljs-number">0.0</span>   <span class="hljs-number">0.0</span> <span class="hljs-number">59.7</span>M <span class="hljs-number">1.79</span>M  <span class="hljs-number">2764</span> ubuntu       <span class="hljs-number">0</span> S  <span class="hljs-number">0</span>:<span class="hljs-number">00.00</span>     <span class="hljs-number">0</span>     <span class="hljs-number">0</span> (sd-pam)</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後のテストでは、いくつかの列が変換され、再カウントされました。</font><font style="vertical-align: inherit;">これらの関数のいくつかは、このデータセットでは正しく機能しないことがわかりました。</font><font style="vertical-align: inherit;">この問題を解決するために、不適切な関数を削除し、より詳細な型に変換せずにデータを読み込みました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターデータ分散</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスタの3つのノードすべてにデータを分散します。</font><font style="vertical-align: inherit;">まず、3つのマシンすべてにテーブルを作成します。</font></font><br>
<br>
<pre><code class="sql hljs">$ clickhouse-client <span class="hljs-comment">--host=0.0.0.0</span></code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_mergetree_third (<font></font>
    trip_id                 UInt32,<font></font>
    vendor_id               <span class="hljs-keyword">String</span>,<font></font>
    pickup_date             <span class="hljs-built_in">Date</span>,<font></font>
    pickup_datetime         DateTime,<font></font>
    dropoff_date            <span class="hljs-built_in">Date</span>,<font></font>
    dropoff_datetime        Nullable(DateTime),<font></font>
    store_and_fwd_flag      Nullable(FixedString(<span class="hljs-number">1</span>)),<font></font>
    rate_code_id            Nullable(UInt8),<font></font>
    pickup_longitude        Nullable(Float64),<font></font>
    pickup_latitude         Nullable(Float64),<font></font>
    dropoff_longitude       Nullable(Float64),<font></font>
    dropoff_latitude        Nullable(Float64),<font></font>
    passenger_count         Nullable(UInt8),<font></font>
    trip_distance           Nullable(Float64),<font></font>
    fare_amount             Nullable(Float32),<font></font>
    extra                   Nullable(Float32),<font></font>
    mta_tax                 Nullable(Float32),<font></font>
    tip_amount              Nullable(Float32),<font></font>
    tolls_amount            Nullable(Float32),<font></font>
    ehail_fee               Nullable(Float32),<font></font>
    improvement_surcharge   Nullable(Float32),<font></font>
    total_amount            Nullable(Float32),<font></font>
    payment_type            Nullable(<span class="hljs-keyword">String</span>),<font></font>
    trip_type               Nullable(UInt8),<font></font>
    pickup                  Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff                 Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    cab_type                Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    precipitation           Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    snow_depth              Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    snowfall                Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    max_temperature         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    min_temperature         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    average_wind_speed      Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
<font></font>
    pickup_nyct2010_gid     Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    pickup_ctlabel          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_borocode         Nullable(<span class="hljs-built_in">Int8</span>),<font></font>
    pickup_boroname         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_ct2010           Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_boroct2010       Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_cdeligibil       Nullable(FixedString(<span class="hljs-number">1</span>)),<font></font>
    pickup_ntacode          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_ntaname          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    pickup_puma             Nullable(<span class="hljs-keyword">String</span>),<font></font>
<font></font>
    dropoff_nyct2010_gid    Nullable(UInt8),<font></font>
    dropoff_ctlabel         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_borocode        Nullable(UInt8),<font></font>
    dropoff_boroname        Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ct2010          Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_boroct2010      Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_cdeligibil      Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ntacode         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_ntaname         Nullable(<span class="hljs-keyword">String</span>),<font></font>
    dropoff_puma            Nullable(<span class="hljs-keyword">String</span>)<font></font>
) <span class="hljs-keyword">ENGINE</span> = MergeTree(pickup_date, pickup_datetime, <span class="hljs-number">8192</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最初のサーバーがクラスター内の3つのノードすべてを認識できることを確認します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> system.clusters
<span class="hljs-keyword">WHERE</span> cluster = <span class="hljs-string">'perftest_3shards'</span>
<span class="hljs-keyword">FORMAT</span> Vertical;</code></pre><br>
 <br>
<pre><code class="sql hljs">Row 1:<font></font>
──────<font></font>
cluster:          perftest_3shards<font></font>
shard_num:        1<font></font>
shard_weight:     1<font></font>
replica_num:      1<font></font>
host_name:        172.30.2.192<font></font>
host_address:     172.30.2.192<font></font>
port:             9000<font></font>
is_local:         1<font></font>
user:             default<font></font>
default_database:</code></pre><br>
<br>
<pre><code class="sql hljs">Row 2:<font></font>
──────<font></font>
cluster:          perftest_3shards<font></font>
shard_num:        2<font></font>
shard_weight:     1<font></font>
replica_num:      1<font></font>
host_name:        172.30.2.162<font></font>
host_address:     172.30.2.162<font></font>
port:             9000<font></font>
is_local:         0<font></font>
user:             default<font></font>
default_database:</code></pre><br>
<pre><code class="sql hljs">Row 3:<font></font>
──────<font></font>
cluster:          perftest_3shards<font></font>
shard_num:        3<font></font>
shard_weight:     1<font></font>
replica_num:      1<font></font>
host_name:        172.30.2.36<font></font>
host_address:     172.30.2.36<font></font>
port:             9000<font></font>
is_local:         0<font></font>
user:             default<font></font>
default_database:</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最初のサーバーに新しいテーブルを定義します。これは、スキーマに基づいて</font></font><code>trips_mergetree_third</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おり、分散エンジンを使用</font><font style="vertical-align: inherit;">しています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_mergetree_x3
    <span class="hljs-keyword">AS</span> trips_mergetree_third
    <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">Distributed</span>(perftest_3shards,
                         <span class="hljs-keyword">default</span>,<font></font>
                         trips_mergetree_third,<font></font>
                         <span class="hljs-keyword">rand</span>());</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、MergeTreeに基づくテーブルから3つのサーバーすべてにデータをコピーします。</font><font style="vertical-align: inherit;">以下は、34分44秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_mergetree_x3
    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> trips_mergetree;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の操作の後、ClickHouseに最大ストレージレベルマークから離れるように15分の時間を与えました。</font><font style="vertical-align: inherit;">3つのサーバーのそれぞれで、データディレクトリはそれぞれ264 GB、34 GB、33 GBになりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseクラスターのパフォーマンス評価</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に見たのは、テーブル内の各クエリを繰り返し実行したときに見た最速の時間でした</font></font><code>trips_mergetree_x3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs">$ clickhouse-client <span class="hljs-comment">--host=0.0.0.0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は2.449秒で完了しました。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> cab_type, <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree_x3
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> cab_type;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は0.691秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,
       <span class="hljs-keyword">avg</span>(total_amount)
<span class="hljs-keyword">FROM</span> trips_mergetree_x3
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は0秒で完了しました。582秒。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,<font></font>
       toYear(pickup_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">year</span>,
       <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree_x3
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count,
         <span class="hljs-keyword">year</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は0.983秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,<font></font>
       toYear(pickup_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">year</span>,
       <span class="hljs-keyword">round</span>(trip_distance) <span class="hljs-keyword">AS</span> distance,
       <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree_x3
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count,
         <span class="hljs-keyword">year</span>,<font></font>
         distance<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">year</span>,
         <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">DESC</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
比較のために、最初のサーバーにのみ配置されているMergeTreeに基づくテーブルで同じクエリを実行しました。</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのClickHouseノードのパフォーマンス評価</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に見たのは、テーブル内の各クエリを繰り返し実行したときに見た最速の時間でした</font></font><code>trips_mergetree_x3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は0.241秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> cab_type, <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> cab_type;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は0.826秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,
       <span class="hljs-keyword">avg</span>(total_amount)
<span class="hljs-keyword">FROM</span> trips_mergetree
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は1.209秒で完了します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,<font></font>
       toYear(pickup_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">year</span>,
       <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count,
         <span class="hljs-keyword">year</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は1.781秒で完了しました。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> passenger_count,<font></font>
       toYear(pickup_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">year</span>,
       <span class="hljs-keyword">round</span>(trip_distance) <span class="hljs-keyword">AS</span> distance,
       <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span> trips_mergetree
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> passenger_count,
         <span class="hljs-keyword">year</span>,<font></font>
         distance<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">year</span>,
         <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">DESC</span>;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果についての考察</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のテストでは、無料のプロセッサベースのデータベースがGPUデータベースをしのぐことができたのはこれが初めてです。そのGPUベースのデータベースはそれ以来2つの改訂を受けましたが、それでも、ClickHouseが1つのノードで示したパフォーマンスは非常に印象的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、分散エンジンでクエリ1を実行すると、オーバーヘッドが1桁高くなります。クラスターにノードを追加するとクエリ時間がどのように減少するかを確認できるので、この投稿の研究で何かを見逃したことを願っています。ただし、他のクエリを実行すると、生産性が約2倍に向上したことは注目に値します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseが進化し、ストレージとコンピューティングを分離して独立して拡張できるようになれば、すばらしいと思います。</font><font style="vertical-align: inherit;">昨年追加されたHDFSサポートは、これに向けた一歩になる可能性があります。</font><font style="vertical-align: inherit;">コンピューティングに関しては、クラスターにノードを追加することで単一のリクエストを加速できる場合、このソフトウェアの将来は非常に明るいものになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この投稿を読んでいただきありがとうございます。</font><font style="vertical-align: inherit;">北米とヨーロッパのクライアントにコンサルティング、アーキテクチャ、実践的な開発サービスを提供しています。</font><font style="vertical-align: inherit;">私の提案があなたのビジネスにどのように役立つかについて話し合いたい場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LinkedIn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">経由で私に連絡してください</font><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja463651/index.html">WMSの離散数学：セル内の商品を圧縮するアルゴリズム（パート2）</a></li>
<li><a href="../ja463653/index.html">Unityでの16ビットゲームとそのレクリエーションの制限</a></li>
<li><a href="../ja463655/index.html">1つのプロジェクトの誕生または独自のCMSの作成方法</a></li>
<li><a href="../ja463657/index.html">チャットボットは吸う</a></li>
<li><a href="../ja463663/index.html">株式市場の構造、証券取引所への投資、自動取引について理解するための10冊の本</a></li>
<li><a href="../ja463667/index.html">フォレストは検索技術に身を任せませんが、エンジニアは反撃します</a></li>
<li><a href="../ja463669/index.html">MQTTプロトコル：概念的な没入</a></li>
<li><a href="../ja463673/index.html">カナダでITスタートアップを設立する6つの理由</a></li>
<li><a href="../ja463675/index.html">人事錬金術：GosSOPKAセンターのチームの最適な構成は何ですか？</a></li>
<li><a href="../ja463677/index.html">離れた場所のチームリード：家族と一緒に旅行し、ギリシャとベトナムで働いた方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>