<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüîß üë©üèΩ‚Äç‚úàÔ∏è üêÇ Um guia pr√°tico para lidar com vazamentos de mem√≥ria no Node.js ü§ôüèº ü§ôüèΩ ü§∂üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vazamentos de mem√≥ria s√£o semelhantes √†s entidades parasit√°rias em um aplicativo. Eles penetram discretamente no sistema, a princ√≠pio, sem causar nenh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Um guia pr√°tico para lidar com vazamentos de mem√≥ria no Node.js</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/495898/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vazamentos de mem√≥ria s√£o semelhantes √†s entidades parasit√°rias em um aplicativo. </font><font style="vertical-align: inherit;">Eles penetram discretamente no sistema, a princ√≠pio, sem causar nenhum dano. </font><font style="vertical-align: inherit;">Mas se o vazamento for forte o suficiente, poder√° levar o aplicativo ao desastre. </font><font style="vertical-align: inherit;">Por exemplo - para desaceler√°-lo com for√ßa ou simplesmente para "mat√°-lo". </font><font style="vertical-align: inherit;">
O autor do artigo, cuja tradu√ß√£o estamos publicando hoje, sugere falar sobre vazamentos de mem√≥ria em JavaScript. </font><font style="vertical-align: inherit;">Em particular, falaremos sobre gerenciamento de mem√≥ria em JavaScript, como identificar vazamentos de mem√≥ria em aplicativos reais e como lidar com vazamentos de mem√≥ria.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/ut/sj/t-/utsjt-d80r9mqkvrexbbkws-eae.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© um vazamento de mem√≥ria?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um vazamento de mem√≥ria √©, em um sentido amplo, uma parte da mem√≥ria alocada para um aplicativo que ele n√£o precisa mais, mas n√£o pode ser devolvido ao sistema operacional para uso futuro. </font><font style="vertical-align: inherit;">Em outras palavras, √© um bloco de mem√≥ria capturado pelo aplicativo sem a inten√ß√£o de usar essa mem√≥ria no futuro.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciamento de mem√≥ria</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gerenciamento de mem√≥ria √© um mecanismo para alocar mem√≥ria do sistema para um aplicativo que precisa e um mecanismo para retornar mem√≥ria desnecess√°ria ao sistema operacional. </font><font style="vertical-align: inherit;">Existem muitas abordagens para gerenciamento de mem√≥ria. </font><font style="vertical-align: inherit;">Qual abordagem √© usada depende da linguagem de programa√ß√£o usada. </font><font style="vertical-align: inherit;">Aqui est√° uma vis√£o geral de v√°rias abordagens comuns ao gerenciamento de mem√≥ria:</font></font><br>
<br>
<ul>
<li>  .           .         .       ,    .        C  C++.   ,   ,   <code>malloc</code>  <code>free</code>,      .</li>
<li>   . ,      ,   ,       .   ,  ,    ,        . ,     ,  ,      ,   .         .  ‚Äî JavaScript, ,   JVM (Java, Scala, Kotlin), Golang, Python, Ruby  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplica√ß√£o do conceito de propriedade da mem√≥ria. </font><font style="vertical-align: inherit;">Com essa abordagem, cada vari√°vel deve ter seu pr√≥prio propriet√°rio. </font><font style="vertical-align: inherit;">Assim que o propriet√°rio est√° fora do escopo, o valor na vari√°vel √© destru√≠do, liberando mem√≥ria. </font><font style="vertical-align: inherit;">Essa ideia √© usada no Rust.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem outras abordagens para gerenciamento de mem√≥ria usadas em diferentes linguagens de programa√ß√£o. </font><font style="vertical-align: inherit;">Por exemplo, o C ++ 11 usa o idioma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAII</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , enquanto o Swift usa o mecanismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mas falar sobre isso est√° al√©m do escopo deste artigo. </font><font style="vertical-align: inherit;">Para comparar os m√©todos acima de gerenciamento de mem√≥ria, para entender seus pr√≥s e contras, precisamos de um artigo separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O JavaScript, uma linguagem sem a qual os programadores da Web n√£o conseguem imaginar seu trabalho, usa a id√©ia da coleta de lixo. </font><font style="vertical-align: inherit;">Portanto, falaremos mais sobre como esse mecanismo funciona.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coleta de lixo JavaScript</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como j√° mencionado, o JavaScript √© uma linguagem que usa o conceito de coleta de lixo. </font><font style="vertical-align: inherit;">Durante a opera√ß√£o dos programas JS, um mecanismo chamado coletor de lixo √© iniciado periodicamente. </font><font style="vertical-align: inherit;">Ele descobre quais partes da mem√≥ria alocada podem ser acessadas a partir do c√≥digo do aplicativo. </font><font style="vertical-align: inherit;">Ou seja, quais vari√°veis ‚Äã‚Äãs√£o referenciadas. </font><font style="vertical-align: inherit;">Se o coletor de lixo descobrir que um peda√ßo de mem√≥ria n√£o √© mais acessado a partir do c√≥digo do aplicativo, ele libera essa mem√≥ria. </font><font style="vertical-align: inherit;">A abordagem acima pode ser implementada usando dois algoritmos principais. </font><font style="vertical-align: inherit;">O primeiro √© o chamado algoritmo Mark and Sweep. </font><font style="vertical-align: inherit;">√â usado em JavaScript. </font><font style="vertical-align: inherit;">O segundo √© a contagem de refer√™ncia. </font><font style="vertical-align: inherit;">√â usado em Python e PHP.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3ee/8ac/c60/3ee8acc608afe85e6a4c6f202cb1e8fe.gif"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fases de marca√ß√£o (marca√ß√£o) e varredura (limpeza) do</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
algoritmo de marca√ß√£o</font><i><font color="#999999"><font style="vertical-align: inherit;"> e varredura</font></font></i><font style="vertical-align: inherit;"> Ao implementar o algoritmo de marca√ß√£o, uma lista de n√≥s raiz representados por vari√°veis ‚Äã‚Äãde ambiente global (este √© um objeto no navegador</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© criada primeiro e, em seguida, a √°rvore resultante √© rastreada dos n√≥s raiz para folha marcados com todos encontrado no caminho objetos. </font><font style="vertical-align: inherit;">A mem√≥ria no heap que √© ocupada por objetos n√£o rotulados √© liberada.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vazamentos de mem√≥ria nos aplicativos Node.js.</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At√© o momento, analisamos conceitos te√≥ricos suficientes relacionados a vazamentos de mem√≥ria e coleta de lixo. </font><font style="vertical-align: inherit;">Ent√£o - estamos prontos para ver como tudo fica em aplicativos reais. </font><font style="vertical-align: inherit;">Nesta se√ß√£o, escreveremos um servidor Node.js. com um vazamento de mem√≥ria. </font><font style="vertical-align: inherit;">Vamos tentar identificar esse vazamento usando v√°rias ferramentas e depois elimin√°-lo.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Familiaridade com um c√≥digo com vazamento de mem√≥ria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fins de demonstra√ß√£o, escrevi um servidor Express que possui uma rota de vazamento de mem√≥ria. </font><font style="vertical-align: inherit;">Vamos depurar este servidor.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Example app listening on port <span class="hljs-subst">${port}</span>!`</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° uma matriz </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que est√° fora do escopo do c√≥digo de processamento de solicita√ß√µes da API. </font><font style="vertical-align: inherit;">Como resultado, toda vez que o c√≥digo correspondente √© executado, novos elementos s√£o simplesmente adicionados √† matriz. </font><font style="vertical-align: inherit;">A matriz nunca √© limpa. </font><font style="vertical-align: inherit;">Como o link para essa matriz n√£o desaparece ap√≥s a sa√≠da do manipulador de solicita√ß√µes, o coletor de lixo nunca libera a mem√≥ria usada.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LeakChame vazamento de mem√≥ria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui chegamos ao mais interessante. Muitos artigos foram escritos sobre como, usando </font></font><code>node --inspect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, depurar vazamentos de mem√≥ria do servidor, ap√≥s preencher o servidor com solicita√ß√µes usando algo como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artilharia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mas essa abordagem tem uma desvantagem importante. Imagine que voc√™ tenha um servidor de API com milhares de terminais. Cada um deles usa muitos par√¢metros, o c√≥digo espec√≠fico que ser√° chamado depende dos recursos. Como resultado, em condi√ß√µes reais, se o desenvolvedor n√£o souber onde est√° o vazamento de mem√≥ria, ele precisar√° acessar cada API muitas vezes usando todas as combina√ß√µes poss√≠veis de par√¢metros para preencher a mem√≥ria. Quanto a mim, n√£o √© f√°cil faz√™-lo. A solu√ß√£o para esse problema, no entanto, √© facilitada usando algo como</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">goreplay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - um sistema que permite gravar e "reproduzir" tr√°fego real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para lidar com o nosso problema, vamos fazer a depura√ß√£o na produ√ß√£o. </font><font style="vertical-align: inherit;">Ou seja, permitiremos que o servidor sobrecarregue a mem√≥ria durante seu uso real (pois recebe uma variedade de solicita√ß√µes de API). </font><font style="vertical-align: inherit;">E depois que encontrarmos um aumento suspeito na quantidade de mem√≥ria alocada, faremos a depura√ß√£o.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Despejo de pilha</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender o que √© um dump de heap, primeiro precisamos descobrir o significado do conceito de heap. Se voc√™ descrever esse conceito da maneira mais simples poss√≠vel, verifica-se que o heap √© o local em que tudo o que a mem√≥ria est√° alocada se encaixa. Tudo isso fica na pilha at√© o coletor de lixo remover tudo o que √© considerado desnecess√°rio. Um despejo de heap √© algo como uma captura instant√¢nea do estado atual de um heap. O dump cont√©m todas as vari√°veis ‚Äã‚Äãinternas e vari√°veis ‚Äã‚Äãdeclaradas pelo programador. Ele representa toda a mem√≥ria alocada no heap no momento em que o dump foi recebido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, se pud√©ssemos comparar de alguma forma o despejo de pilha do servidor iniciado com o despejo de pilha do servidor, que est√° em execu√ß√£o h√° muito tempo e transborda mem√≥ria, poderemos identificar objetos suspeitos que o aplicativo n√£o precisa, mas que n√£o s√£o exclu√≠dos pelo coletor de lixo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de continuar a conversa, vamos falar sobre como criar despejos de heap. </font><font style="vertical-align: inherit;">Para resolver esse problema, usaremos o pacote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hpmdump do npm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que permite obter programaticamente um dump do heap do servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale o pacote:</font></font><br>
<br>
<pre><code class="bash hljs">npm i heapdump
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faremos algumas altera√ß√µes no c√≥digo do servidor que nos permitir√° usar este pacote:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> heapdump = <span class="hljs-built_in">require</span>(<span class="hljs-string">"heapdump"</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.get(<span class="hljs-string">'/heapdump'</span>, (req, res) =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDump-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a bloated server written to"</span>, filename);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">msg</span>: <span class="hljs-string">"successfully took a heap dump"</span>})<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDumpAtServerStart.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a fresh server written to"</span>, filename);<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui usamos este pacote para despejar um servidor rec√©m-lan√ßado. </font><font style="vertical-align: inherit;">Tamb√©m criamos uma API </font></font><code>/heapdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projetada para criar uma pilha ao acess√°-la. </font><font style="vertical-align: inherit;">Voltaremos a essa API no momento em que percebermos que o servidor come√ßou a consumir muita mem√≥ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o seu servidor estiver executando em um cluster Kubernetes, voc√™ n√£o poder√°, sem esfor√ßo extra, recorrer ao mesmo pod cujo servidor est√° executando no qual consome muita mem√≥ria. </font><font style="vertical-align: inherit;">Para fazer isso, voc√™ pode usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encaminhamento de porta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Al√©m disso, como voc√™ n√£o ter√° acesso ao sistema de arquivos para baixar arquivos de despejo, seria melhor fazer o upload desses arquivos para o armazenamento em nuvem externo (como o S3).</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detection Detec√ß√£o de vazamento de mem√≥ria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora, o servidor est√° implantado. Ele trabalha h√° v√°rios dias. Ele recebe muitas solicita√ß√µes (no nosso caso, apenas solicita√ß√µes de um tipo) e prestamos aten√ß√£o ao aumento da quantidade de mem√≥ria consumida pelo servidor. Um vazamento de mem√≥ria pode ser detectado usando ferramentas de monitoramento como o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express Status Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clinic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Depois disso, chamamos a API para despejar o heap. Este despejo conter√° todos os objetos que o coletor de lixo n√£o p√¥de excluir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° a apar√™ncia da consulta para criar um dump:</font></font><br>
<br>
<pre><code class="bash hljs">curl --location --request GET <span class="hljs-string">'http://localhost:3000/heapdump'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um dump de heap √© criado, o coletor de lixo √© for√ßado a executar. Como resultado, n√£o precisamos nos preocupar com os objetos que podem ser removidos pelo coletor de lixo no futuro, mas ainda est√£o na pilha. Ou seja, sobre os objetos ao trabalhar com os quais n√£o ocorrem vazamentos de mem√≥ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que tivermos ambos os dumps √† nossa disposi√ß√£o (um dump de um servidor rec√©m-lan√ßado e um dump de um servidor que funcionou por algum tempo), podemos come√ßar a compar√°-los. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obter um despejo de mem√≥ria √© uma opera√ß√£o de bloqueio que requer muita mem√≥ria para ser conclu√≠da. Portanto, deve ser realizado com cautela. Voc√™ pode ler mais sobre os poss√≠veis problemas encontrados durante esta opera√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicie o Chrome e pressione a tecla</font></font><code>F12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Isso levar√° √† descoberta de ferramentas de desenvolvedor. </font><font style="vertical-align: inherit;">Aqui voc√™ precisa ir para a guia </font></font><code>Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e carregar os dois instant√¢neos de mem√≥ria.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5c1/252/992/5c125299224be08bb5bb73f74842f0b8.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixando despejos de mem√≥ria na guia Mem√≥ria das ferramentas para desenvolvedores Chrome</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Depois de baixar os dois instant√¢neos, voc√™ precisa mudar</font></font><code>perspective</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font><code>Comparison</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e clique no instant√¢neo da mem√≥ria do servidor que trabalhou por algum tempo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/7c7/224/a997c7224ac3d053651be9e848380e75.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comece a comparar instant√¢neos</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aqui, podemos analisar a coluna</font></font><code>Constructor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e procurar objetos que o coletor de lixo n√£o pode remover. </font><font style="vertical-align: inherit;">A maioria desses objetos ser√° representada por links internos que os n√≥s usam. </font><font style="vertical-align: inherit;">Aqui √© √∫til usar um truque, que consiste em classificar a lista por campo</font></font><code>Alloc. Size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Isso encontrar√° rapidamente os objetos que usam mais mem√≥ria. </font><font style="vertical-align: inherit;">Se voc√™ expandir o bloco</font></font><code>(array)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e depois -</font></font><code>(object elements)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, poder√° ver uma matriz</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contendo um grande n√∫mero de objetos que n√£o podem ser exclu√≠dos usando o coletor de lixo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e85/02c/0a2/e8502c0a2dcd1cf635f229eaef8d9e90.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise de uma matriz suspeita</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Essa t√©cnica nos permitir√° entrar na matriz</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e entender que √© a opera√ß√£o incorreta que causa um vazamento de mem√≥ria.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corrigir vazamento de mem√≥ria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora que sabemos que o "culpado" √© uma matriz </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, podemos analisar o c√≥digo e descobrir que o problema √© que a matriz √© declarada fora do manipulador de solicita√ß√µes. </font><font style="vertical-align: inherit;">Como resultado, acontece que o link para ele nunca √© exclu√≠do. </font><font style="vertical-align: inherit;">Para corrigir este problema √© bastante simples - basta transferir a declara√ß√£o da matriz para o manipulador:</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar a efic√°cia das medidas tomadas, basta repetir as etapas acima e comparar novamente as imagens da pilha.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vazamentos de mem√≥ria acontecem em diferentes idiomas. </font><font style="vertical-align: inherit;">Em particular, naqueles que usam mecanismos de coleta de lixo. </font><font style="vertical-align: inherit;">Por exemplo, em JavaScript. </font><font style="vertical-align: inherit;">Geralmente n√£o √© dif√≠cil consertar um vazamento - as dificuldades reais surgem apenas quando voc√™ o procura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, voc√™ se familiarizou com os conceitos b√°sicos de gerenciamento de mem√≥ria e como o gerenciamento de mem√≥ria √© organizado em diferentes idiomas. </font><font style="vertical-align: inherit;">Aqui, reproduzimos um cen√°rio real de vazamento de mem√≥ria e descrevemos um m√©todo para solu√ß√£o de problemas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queridos leitores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ encontrou vazamentos de mem√≥ria em seus projetos da web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495888/index.html">A PyCon Russia abriu o CFP para futuros palestrantes. Formul√°rios de participa√ß√£o e t√≥picos esperados</a></li>
<li><a href="../pt495890/index.html">Configurando um pacote Nginx / LetsEncrypt no Docker Swarm</a></li>
<li><a href="../pt495892/index.html">Voc√™ realmente sabe o que s√£o matrizes?</a></li>
<li><a href="../pt495894/index.html">Medi√ß√£o de desempenho Javascript</a></li>
<li><a href="../pt495896/index.html">Pacote Use-Sound: Efeitos sonoros em aplicativos React</a></li>
<li><a href="../pt495902/index.html">CAPTCHA: matando a convers√£o</a></li>
<li><a href="../pt495904/index.html">Uma epidemia pode ser prevista?</a></li>
<li><a href="../pt495908/index.html">O caminho para a recompensa</a></li>
<li><a href="../pt495910/index.html">Instalando o ROS em uma imagem IMG de placa √∫nica do Ubuntu</a></li>
<li><a href="../pt495912/index.html">Adesivos de repeti√ß√£o inteligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>