<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗼 🤾 ↙️ Montre DOOM sur ESP32. Partie 1 👨🏾‍🏫 🏇🏿 👨🏿‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ayant essayé le développement avec des modules ESP32 prêts à l'emploi, je voulais faire quelque chose de petit et de natif. J'ai décidé de faire une m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Montre DOOM sur ESP32. Partie 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ayant essayé le développement avec des modules ESP32 prêts à l'emploi, je voulais faire quelque chose de petit et de natif. </font><font style="vertical-align: inherit;">J'ai décidé de faire une montre. </font><font style="vertical-align: inherit;">Au début, j'ai pensé à l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32-PICO-D4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Puisqu'il n'a que 4 Mo de mémoire flash pour le programme, j'ai décidé de faire une version complète avec une extension allant jusqu'à 16 Mo de mémoire flash et 8 Mo de mémoire SRAM. </font><font style="vertical-align: inherit;">Quelle que soit l'horloge, vous pouvez exécuter le premier Doom. </font><font style="vertical-align: inherit;">En général, c'était tout à plein! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r0/tm/qh/r0tmqhwcgq1geu0iyijuroahpvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui n'a pas été fait ou doit être amélioré:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicateur de batterie</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Circuit de barrière de charge implémenté sur la diode Schottky</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'antenne n'est pas très bien située sur une autre couche d'ESP32</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pas un tutoriel!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bw/cn/gr/bwcngruk2zywo5wuqk-zvco4toq.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par affichage</font></font></h3><br>
<img width="400" src="https://habrastorage.org/webt/y-/0a/rp/y-0arpnjd4fsidh22irudjow-qg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai appliqué un écran couleur sur le contrôleur ST7789 avec une résolution de 240x240. </font><font style="vertical-align: inherit;">Il est assez compact et bon marché. </font><font style="vertical-align: inherit;">De plus en plus de pilotes et de ports apparaissent sur le réseau. </font><font style="vertical-align: inherit;">Par exemple, il y a un port pour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LittlevGL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais il n'y a pas de brouette sur cet affichage. </font><font style="vertical-align: inherit;">Je pense qu'il peut être acheté et collé. </font><font style="vertical-align: inherit;">Peut-être que quelqu'un a de l'expérience? </font><font style="vertical-align: inherit;">Partager. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je développé une carte sur ST7789 et il a </font><font style="vertical-align: inherit;">commencé sans aucun problème.</font></font><br>
<br>
<img width="500" src="https://habrastorage.org/webt/fw/ic/mc/fwicmcivnyq44nxvhwqpjqrlsco.jpeg"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LittlevGL esp32</font></font></b>
                        <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/15qrV2CNSoQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En remplissant les programmes et en déboguant</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai utilisé le </font><font style="vertical-align: inherit;">convertisseur CP2102 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB-TO-UART BRIDGE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Premièrement, il est compact et deuxièmement, le schéma de connexion est très simple et presque aucune pièce supplémentaire n'est requise.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 2: un condensateur de 4,7 μF peut être ajouté si vous alimentez d'autres appareils à partir du régulateur sur puce.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous connectez REGIN et VBUS à une alimentation USB 5V, vous n'aurez besoin que d'un condensateur shunt à l'entrée. </font><font style="vertical-align: inherit;">Bien que je pense que cela peut fonctionner sans lui. </font><font style="vertical-align: inherit;">VDD sur une puce dans ce cas est la solution! </font><font style="vertical-align: inherit;">J'ai fait une erreur et je l'ai connecté au circuit d'alimentation de 3,3 V et je ne pouvais pas comprendre pourquoi j'avais 4.65 V sur l'alimentation?! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le lien dans la documentation ci-dessous propose des options de connexion à une alimentation de 3,3 V. </font><font style="vertical-align: inherit;">Mais je pense qu'il n'est absolument pas nécessaire d'alimenter le CP2102 lorsque nous n'avons pas besoin de télécharger ou de déboguer l'appareil</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yy/-k/go/yy-kgo5r6igfhil55qe7zg2j7wu.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge de la batterie Modulo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La résistance du LTC4054 définit le courant de charge:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/ex/5q/rdex5qbeqitjred4al5o0c267ju.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alimenté par des piles de 3,7 V avec stabilisateur HT7833. Courant de sortie 500mA. Il a une petite chute de tension de ~ 300mV. LD1117-3.3 en a «un peu» plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une note sur les conclusions de VDD_SDIO. Cette sortie d'alimentation des broches est de 1,8 V ou 3,3 V, selon l'état du microcontrôleur IO12 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au démarrage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . 3,3 V GPIO12 est 0 (par défaut)</font></font><br>
<blockquote>VDD_SDIO works as the power supply for the related IO, and also for an external device.<br>
<br>
When VDD_SDIO operates at 1.8 V, it can be generated from ESP32’s internal LDO. The maximum currentthis LDO can offer is 40 mA, and the output voltage range is 1.65 V~2.0 V. <br>
<br>
When the VDD_SDIO outputs 1.8 V, the value of GPIO12 should be set to 1 when the chip boots and it is recommended that users add a2 kΩ ground resistor and a 4.7 mF filter capacitor close to VDD_SDIO.<br>
<br>
When VDD_SDIO operates at 3.3 V, it is driven directly by VDD3P3_RTC through a 6Ωresistor, therefore,there will be some voltage drop from VDD3P3_RTC. <br>
<br>
When the VDD_SDIO outputs 3.3 V, the value of GPIO12 is 0 (default) when the chip boots and it is recommended that users add a 1mF capacitor close to VDD_SDIO<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est très pratique si vous avez un flash 1.8V. </font><font style="vertical-align: inherit;">Mais dans mon cas, j'ai marqué cette conclusion et connecté mon flash 3V3 et ma PSRAM à l'alimentation générale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains modules ESP32 utilisent VDD_SDIO, donc je ne peux rien accrocher aux périphériques sur IO12 au démarrage. </font><font style="vertical-align: inherit;">Vous pouvez, par exemple, accrocher un bouton. </font><font style="vertical-align: inherit;">Dans l'une de mes solutions, j'ai accroché une jambe SPI sur IO12 et le module n'a pas démarré. </font><font style="vertical-align: inherit;">Apparemment, IO12 a obtenu une unité de ce port SPI, mais j'avais besoin de 0 ou vice versa. </font><font style="vertical-align: inherit;">Il faut en tenir compte! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous ensemble:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cx/-o/ku/cx-oku_wxajemjbyrjrilqm0xpc.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 Mo de PSRAM</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">charge du </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">module de mise à niveau PSRAM de 8 Mo </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour la RAM externe</font></font></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSRAM / CE (broche 1)&gt; ESP32 GPIO 16 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SO (broche 2)&gt; flash DO </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SIO [2] (broche 3)&gt; flash WP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SI (broche 5)&gt; flash DI </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SCLK (broche 6)&gt; ESP32 GPIO 17 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SIO [3] (broche 7)&gt; flash HOLD </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM Vcc (broche 8)&gt; ESP32 VCC_SDIO</font></font></blockquote><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antenne PCB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai utilisé une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antenne PCB de petite taille 2,4 GHz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il se trouve dans la bibliothèque Eagle Autodesk et occupe une petite zone. </font><font style="vertical-align: inherit;">Vous pouvez probablement utiliser une ANTENNE DIÉLECTRIQUE CÉRAMIQUE mais vous devez l'acheter, et le prix d'une antenne PCB est un peu plus occupé. </font><font style="vertical-align: inherit;">Cependant, une antenne en céramique est moins efficace. </font><font style="vertical-align: inherit;">Toute option </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide de sélection rapide de l' </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">antenne Les directives de conception d'antenne et de disposition RF</font></a><font style="vertical-align: inherit;"> conviennent pour vérifier le concept.</font></font><br>
<br>
<img width="400" src="https://habrastorage.org/webt/m9/0b/lq/m90blqi_al7oqlx6cgobpazbk4c.png" alt="image"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu sur l'adaptation de l'antenne</font></font></h3><br>
<img src="https://habrastorage.org/webt/py/o-/lx/pyo-lxfj7y7lu51eltxs_f3u-mm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directives de conception matérielle ESP32</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à la page 7 fournissent des directives pour la mise en œuvre d'un filtre RF:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'impédance de sortie des broches RF d'ESP32 (QFN 6 * 6) et d'ESP32 (QFN 5 * 5) est de (30 + j10) Ω et (35 + j10) Ω, respectivement</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour calculer, utilisez l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outil de graphique Smith en ligne</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'idée principale est d'arriver au centre du cercle à (30 + j10). Cependant, il s'agit de données calculées et l'utilisation réelle des paramètres peut être affectée par l'épaisseur des pistes et du PCB, ainsi que par rapport à d'autres composants du circuit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/lw/w2/mblww2rcjw5h5otg0bwgbfoqhgw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est pas le seul circuit d'adaptation d'antenne. Par exemple, l'adaptation sur la carte esp32-pic est un peu différente: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp32-pico-kit-v4_schematic </font></font></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Smith Chart and Impedance Matching L'</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
emplacement de l'antenne et la zone libre autour d'elle sont également importants. Comme je l'ai écrit plus tôt, dans mon cas, la position n'est pas sélectionnée de manière optimale. Mais pour la première itération de la carte et la vérification du concept, la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2y/sk/me/2yskmeit4qo4hv0fhldmyq0xgpq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
deuxième partie sera consacrée à la carte elle-même et au troisième portage du logiciel. Peut-être que tout tient en un.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais prendre un peu d'avance sur le port </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'Espressif Systems. </font><font style="vertical-align: inherit;">Le port utilise ILI9341, nous avons ST7789. </font><font style="vertical-align: inherit;">Mais comme l'initialisation et la sortie du tampon sont extraites dans un fichier séparé et divisées en méthodes distinctes, l'adaptation à mon affichage ne devrait pas poser de grandes difficultés.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ili_init et displayTask sont responsables de l'initialisation de l'affichage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisplayTask est responsable de l'affichage.</font></font></li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">displayTask</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> IRAM_ATTR <span class="hljs-title">displayTask</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
	<span class="hljs-keyword">int</span> x, i;
	<span class="hljs-keyword">int</span> idx=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> inProgress=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">static</span> <span class="hljs-keyword">uint16_t</span> *dmamem[NO_SIM_TRANS];
	<span class="hljs-keyword">spi_transaction_t</span> trans[NO_SIM_TRANS];
	<span class="hljs-keyword">spi_transaction_t</span> *rtrans;<font></font>
<font></font>
    <span class="hljs-keyword">esp_err_t</span> ret;
    <span class="hljs-keyword">spi_bus_config_t</span> buscfg={<font></font>
        .miso_io_num=<span class="hljs-number">-1</span>,<font></font>
        .mosi_io_num=PIN_NUM_MOSI,<font></font>
        .sclk_io_num=PIN_NUM_CLK,<font></font>
        .quadwp_io_num=<span class="hljs-number">-1</span>,<font></font>
        .quadhd_io_num=<span class="hljs-number">-1</span>,<font></font>
        .max_transfer_sz=(MEM_PER_TRANS*<span class="hljs-number">2</span>)+<span class="hljs-number">16</span><font></font>
    };<font></font>
    <span class="hljs-keyword">spi_device_interface_config_t</span> devcfg={<font></font>
        .clock_speed_hz=<span class="hljs-number">26000000</span>,               <span class="hljs-comment">//Clock out at 26 MHz. Yes, that's heavily overclocked.</span>
        .mode=<span class="hljs-number">0</span>,                                <span class="hljs-comment">//SPI mode 0</span>
        .spics_io_num=PIN_NUM_CS,               <span class="hljs-comment">//CS pin</span>
        .queue_size=NO_SIM_TRANS,               <span class="hljs-comment">//We want to be able to queue this many transfers</span>
        .pre_cb=ili_spi_pre_transfer_callback,  <span class="hljs-comment">//Specify pre-transfer callback to handle D/C line</span><font></font>
    };<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"*** Display task starting.\n"</span>);<font></font>
<font></font>
    <span class="hljs-comment">//Initialize the SPI bus</span>
    ret=spi_bus_initialize(HSPI_HOST, &amp;buscfg, <span class="hljs-number">1</span>);<font></font>
    assert(ret==ESP_OK);<font></font>
    <span class="hljs-comment">//Attach the LCD to the SPI bus</span><font></font>
    ret=spi_bus_add_device(HSPI_HOST, &amp;devcfg, &amp;spi);<font></font>
    assert(ret==ESP_OK);<font></font>
    <span class="hljs-comment">//Initialize the LCD</span><font></font>
    ili_init(spi);<font></font>
<font></font>
	<span class="hljs-comment">//We're going to do a fair few transfers in parallel. Set them all up.</span>
	<span class="hljs-keyword">for</span> (x=<span class="hljs-number">0</span>; x&lt;NO_SIM_TRANS; x++) {<font></font>
		dmamem[x]=pvPortMallocCaps(MEM_PER_TRANS*<span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
		assert(dmamem[x]);<font></font>
		<span class="hljs-built_in">memset</span>(&amp;trans[x], <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">spi_transaction_t</span>));<font></font>
		trans[x].length=MEM_PER_TRANS*<span class="hljs-number">2</span>;<font></font>
		trans[x].user=(<span class="hljs-keyword">void</span>*)<span class="hljs-number">1</span>;<font></font>
		trans[x].tx_buffer=&amp;dmamem[x];<font></font>
	}<font></font>
	xSemaphoreGive(dispDoneSem);<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {<font></font>
		xSemaphoreTake(dispSem, portMAX_DELAY);<font></font>
<span class="hljs-comment">//		printf("Display task: frame.\n");</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> DOUBLE_BUFFER</span>
		<span class="hljs-keyword">uint8_t</span> *myData=(<span class="hljs-keyword">uint8_t</span>*)currFbPtr;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
		send_header_start(spi, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">320</span>, <span class="hljs-number">240</span>);<font></font>
		send_header_cleanup(spi);<font></font>
		<span class="hljs-keyword">for</span> (x=<span class="hljs-number">0</span>; x&lt;<span class="hljs-number">320</span>*<span class="hljs-number">240</span>; x+=MEM_PER_TRANS) {
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> DOUBLE_BUFFER</span>
			<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;MEM_PER_TRANS; i+=<span class="hljs-number">4</span>) {
				<span class="hljs-keyword">uint32_t</span> d=currFbPtr[(x+i)/<span class="hljs-number">4</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">0</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">0</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">1</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">2</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">3</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">24</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
			}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
			<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;MEM_PER_TRANS; i++) {<font></font>
				dmamem[idx][i]=lcdpal[myData[i]];<font></font>
			}<font></font>
			myData+=MEM_PER_TRANS;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
			trans[idx].length=MEM_PER_TRANS*<span class="hljs-number">16</span>;<font></font>
			trans[idx].user=(<span class="hljs-keyword">void</span>*)<span class="hljs-number">1</span>;<font></font>
			trans[idx].tx_buffer=dmamem[idx];<font></font>
			ret=spi_device_queue_trans(spi, &amp;trans[idx], portMAX_DELAY);<font></font>
			assert(ret==ESP_OK);<font></font>
<font></font>
			idx++;<font></font>
			<span class="hljs-keyword">if</span> (idx&gt;=NO_SIM_TRANS) idx=<span class="hljs-number">0</span>;<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (inProgress==NO_SIM_TRANS<span class="hljs-number">-1</span>) {<font></font>
				ret=spi_device_get_trans_result(spi, &amp;rtrans, portMAX_DELAY);<font></font>
				assert(ret==ESP_OK);<font></font>
			} <span class="hljs-keyword">else</span> {<font></font>
				inProgress++;<font></font>
			}<font></font>
		}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> DOUBLE_BUFFER</span><font></font>
		xSemaphoreGive(dispDoneSem);<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
		<span class="hljs-keyword">while</span>(inProgress) {<font></font>
			ret=spi_device_get_trans_result(spi, &amp;rtrans, portMAX_DELAY);<font></font>
			assert(ret==ESP_OK);<font></font>
			inProgress--;<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vidéo de démonstration rapide Esp32-Doom</font></font></b>
                        <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/Gb_JFDa0AIo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La commande de la carte a été envoyée à l'usine Jlcpcb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le défi est lancé!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494728/index.html">La méthode d'automatisation de rideau la plus abordable</a></li>
<li><a href="../fr494730/index.html">Entretien avec Amusa Buminasan</a></li>
<li><a href="../fr494732/index.html">Le responsable de la bibliothèque JS la plus populaire a été condamné à une peine d'emprisonnement pour un accident mortel en raison de sa faute</a></li>
<li><a href="../fr494736/index.html">Ce que le blog de l'éditeur raconte sur les tendances de la communauté informatique</a></li>
<li><a href="../fr494738/index.html">Ansible n'est pas pour vous. Sergey Pechenko</a></li>
<li><a href="../fr494750/index.html">Théorie des couleurs, contraste</a></li>
<li><a href="../fr494754/index.html">Événements numériques à Moscou du 30 mars au 5 avril</a></li>
<li><a href="../fr494762/index.html">50 applications pour une organisation efficace du travail à distance</a></li>
<li><a href="../fr494766/index.html">Tendances des technologies des communications dans un avenir proche</a></li>
<li><a href="../fr494772/index.html">Comment la lutte contre les appels robotiques se développe aux États-Unis - sur les mesures des politiciens et des entreprises de télécommunications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>