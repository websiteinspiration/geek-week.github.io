<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õµÔ∏è ‚õé üí™ Dentro da m√°quina virtual Python. Parte 1 üòá üë¨ üêØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° a todos. Finalmente decidi descobrir como o interpretador Python funciona. Para fazer isso, ele come√ßou a estudar um livro de artigos e concebeu a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Dentro da m√°quina virtual Python. Parte 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501338/"><img src="https://habrastorage.org/webt/jm/9r/uc/jm9rucormi1lrcussoajjremszi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√° a todos. </font><font style="vertical-align: inherit;">Finalmente decidi descobrir como o interpretador Python funciona. </font><font style="vertical-align: inherit;">Para fazer isso, ele come√ßou a estudar um livro de artigos e concebeu ao mesmo tempo para traduzi-lo para o russo. </font><font style="vertical-align: inherit;">O fato √© que as tradu√ß√µes n√£o permitem que voc√™ perca uma frase incompreens√≠vel e a qualidade da assimila√ß√£o do material aumenta).</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pe√ßo desculpas antecipadamente por poss√≠veis imprecis√µes. </font><font style="vertical-align: inherit;">Eu sempre tento traduzir o mais corretamente poss√≠vel, mas um dos principais problemas: simplesmente n√£o h√° men√ß√£o de alguns termos no equivalente russo.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota de tradu√ß√£o</font></font></b>
                        <div class="spoiler_text"> Python   ,  ¬´code object¬ª,  (  )     .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">  </a>   .<br>
<br>
<b> </b> ‚Äî   Python,    -   ,     :   ,    ,  ( !    )  ,    ,     - (     )  .. ‚Äî    ()  -   str (,  Python3, bytes).<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A linguagem de programa√ß√£o Python j√° existe h√° algum tempo. </font><font style="vertical-align: inherit;">O desenvolvimento da primeira vers√£o foi iniciado por Guido Van Rossum em 1989 e, desde ent√£o, a linguagem cresceu e se tornou uma das mais populares. </font><font style="vertical-align: inherit;">O Python √© usado em v√°rias aplica√ß√µes: de interfaces gr√°ficas a aplicativos de an√°lise de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo deste artigo √© conhecer os bastidores do int√©rprete e fornecer uma vis√£o geral conceitual de como um programa escrito em Python √© executado. </font><font style="vertical-align: inherit;">O CPython ser√° considerado no artigo, porque, no momento da reda√ß√£o deste documento, √© a implementa√ß√£o Python mais popular e b√°sica.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python e CPython s√£o usados ‚Äã‚Äãcomo sin√¥nimos neste texto, mas qualquer men√ß√£o a Python significa CPython (a vers√£o python implementada em C). </font><font style="vertical-align: inherit;">Outras implementa√ß√µes incluem PyPy (python implementado em um subconjunto limitado de Python), Jython (implementa√ß√£o na Java Virtual Machine), etc.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gosto de dividir a execu√ß√£o de um programa Python em duas ou tr√™s etapas principais (listadas abaixo), dependendo de como o int√©rprete √© chamado. </font><font style="vertical-align: inherit;">Essas etapas ser√£o abordadas em v√°rios graus neste artigo:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - esta etapa envolve a configura√ß√£o das v√°rias estruturas de dados exigidas pelo processo python. </font><font style="vertical-align: inherit;">Provavelmente isso acontecer√° quando o programa for executado no modo n√£o interativo atrav√©s do shell do int√©rprete.</font></font></li>
<li><b></b> ‚Äî     , :       ,    ,       .</li>
<li><b></b> ‚Äî         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mecanismo para gerar √°rvores de "an√°lise", bem como √°rvores de sintaxe abstrata (ASD), √© independente da linguagem. Portanto, n√£o abordaremos muito esse t√≥pico, porque os m√©todos usados ‚Äã‚Äãno Python s√£o semelhantes aos m√©todos de outras linguagens de programa√ß√£o. Por outro lado, o processo de constru√ß√£o de tabelas de s√≠mbolos e objetos de c√≥digo do ADS no Python √© mais espec√≠fico e, portanto, merece aten√ß√£o especial. Ele tamb√©m discute a interpreta√ß√£o de objetos de c√≥digo compilados e todas as outras estruturas de dados. Os t√≥picos abordados por n√≥s incluem, entre outros: o processo de constru√ß√£o de tabelas de s√≠mbolos e cria√ß√£o de objetos de c√≥digo, objetos Python, objetos de quadro, objetos de c√≥digo, objetos funcionais, opcodes, loops de interpretador, geradores e classes de usu√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este material √© destinado a qualquer pessoa interessada em aprender como a m√°quina virtual CPython funciona. Sup√µe-se que o usu√°rio j√° esteja familiarizado com python e entenda o b√°sico da linguagem. Ao estudar a estrutura de uma m√°quina virtual, encontraremos uma quantidade significativa de c√≥digo C, para que seja mais f√°cil para um usu√°rio que tenha um conhecimento b√°sico da linguagem C entender o material. E ent√£o, basicamente, o que voc√™ precisa para se familiarizar com esse material: o desejo de aprender mais sobre a m√°quina virtual CPython. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo √© uma vers√£o ampliada de anota√ß√µes pessoais feitas no estudo do trabalho interno do int√©rprete. H√° muita coisa de qualidade nos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deos do PyCon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nas palestras da escola e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste blog.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Meu trabalho n√£o teria sido conclu√≠do sem essas fontes fant√°sticas de conhecimento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final deste livro, o leitor ser√° capaz de entender os meandros de como o interpretador Python executa seu programa. </font><font style="vertical-align: inherit;">Isso inclui os v√°rios est√°gios da execu√ß√£o do programa e estruturas de dados que s√£o cr√≠ticas no programa. </font><font style="vertical-align: inherit;">Para come√ßar, teremos uma vis√£o geral do que acontece quando um programa trivial √© executado, quando o nome do m√≥dulo √© passado para o int√©rprete na linha de comando. </font><font style="vertical-align: inherit;">O c√≥digo execut√°vel do CPython pode ser instalado a partir da fonte, seguindo o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Developer's Guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este livro usa a vers√£o Python 3.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista de 30.000 p√©s</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este cap√≠tulo fala sobre como o int√©rprete executa um programa Python. Nos cap√≠tulos seguintes, examinaremos as v√°rias partes desse ‚Äúquebra-cabe√ßa‚Äù e forneceremos uma descri√ß√£o mais detalhada de cada parte. Independentemente da complexidade de um programa escrito em Python, esse processo √© sempre o mesmo. A excelente explica√ß√£o dada por Yaniv Aknin em sua </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©rie de artigos sobre o Python Internal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> define o t√≥pico para nossa discuss√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√≥dulo de origem test.py pode ser executado na linha de comando (ao transmiti-lo como argumento para o programa interpretador Python na forma de $ python test.py). Esta √© apenas uma maneira de chamar o execut√°vel Python. Tamb√©m podemos iniciar um int√©rprete interativo, executar linhas de um arquivo como c√≥digo, etc. Mas este e outros m√©todos n√£o nos interessam. √â a transfer√™ncia do m√≥dulo como argumento (dentro da linha de comando) para o arquivo execut√°vel (Figura 2.1) que reflete melhor o fluxo de v√°rias a√ß√µes envolvidas na execu√ß√£o real do c√≥digo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/bw/i5/tlbwi5onywd5j1xmkmyv7ni_lgm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2.1: Fluxo em tempo de execu√ß√£o.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O execut√°vel python √© um programa C regular; portanto, quando √© chamado, ocorrem processos semelhantes aos que existem, por exemplo, no kernel do linux ou no programa hello world simples. </font><font style="vertical-align: inherit;">Reserve um minuto do seu tempo para entender: o execut√°vel python √© apenas outro programa que lan√ßa o seu. </font><font style="vertical-align: inherit;">Tais "relacionamentos" existem entre a linguagem C e o assembler (ou llvm). </font><font style="vertical-align: inherit;">O processo de inicializa√ß√£o padr√£o (que depende da plataforma em que a execu√ß√£o ocorre) inicia quando o execut√°vel python √© chamado com o nome do m√≥dulo como argumento.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este artigo pressup√µe que voc√™ esteja usando um sistema operacional baseado em Unix; portanto, alguns recursos podem variar no Windows.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A linguagem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na inicializa√ß√£o executa toda a sua ‚Äúm√°gica‚Äù de inicializa√ß√£o - carrega bibliotecas, verifica / define vari√°veis ‚Äã‚Äãde ambiente e, depois disso, o principal m√©todo do execut√°vel python √© iniciado como qualquer outro programa C. O arquivo execut√°vel principal do Python est√° localizado em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Programs/python.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e executa algumas inicializa√ß√µes (como fazer c√≥pias dos argumentos da linha de comando do programa que foram passados ‚Äã‚Äãpara o m√≥dulo). A fun√ß√£o principal chama a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> localizada em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Modules/main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele processa o processo de inicializa√ß√£o do int√©rprete: analisa os argumentos da linha de comando, define sinalizadores, l√™ vari√°veis ‚Äã‚Äãde ambiente, executa ganchos, randomiza fun√ß√µes de hash, etc. Tamb√©m chamado</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylifecycle.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que lida com a inicializa√ß√£o das estruturas de dados do interpretador e do estado do fluxo, s√£o duas estruturas de dados muito importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinar declara√ß√µes de estruturas de dados de int√©rpretes e estados de fluxo deixa claro por que eles s√£o necess√°rios. O estado do int√©rprete e o fluxo s√£o apenas estruturas com ponteiros para os campos que cont√™m as informa√ß√µes necess√°rias para executar o programa. Os dados do estado do int√©rprete s√£o criados via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (pense nessa palavra-chave em C como uma defini√ß√£o de tipo, embora isso n√£o seja totalmente verdade). O c√≥digo para essa estrutura √© mostrado na Listagem 2.1.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> {</span>
 <span class="hljs-number">2</span> 
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">tstate_head</span>;</span>
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         PyObject *modules;
 <span class="hljs-number">7</span>         PyObject *modules_by_index;
 <span class="hljs-number">8</span>         PyObject *sysdict;
 <span class="hljs-number">9</span>         PyObject *builtins;
<span class="hljs-number">10</span>         PyObject *importlib;
<span class="hljs-number">11</span> 
<span class="hljs-number">12</span>         PyObject *codec_search_path;
<span class="hljs-number">13</span>         PyObject *codec_search_cache;
<span class="hljs-number">14</span>         PyObject *codec_error_registry;
<span class="hljs-number">15</span>         <span class="hljs-keyword">int</span> codecs_initialized;
<span class="hljs-number">16</span>         <span class="hljs-keyword">int</span> fscodec_initialized;
<span class="hljs-number">17</span> 
<span class="hljs-number">18</span>         PyObject *builtins_copy;
<span class="hljs-number">19</span>     } PyInterpreterState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listagem de c√≥digo 2.1: Estrutura de dados do estado do int√©rprete</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Qualquer pessoa que tenha usado a linguagem de programa√ß√£o Python por um longo tempo pode reconhecer v√°rios campos mencionados nessa estrutura (sysdict, builtins, codec).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O campo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* next</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma refer√™ncia a outra inst√¢ncia do int√©rprete, pois v√°rios int√©rpretes Python podem existir no mesmo processo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campo * tstate_head</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indica o encadeamento principal de execu√ß√£o (se o programa √© multiencadeado, o interpretador √© comum a todos os encadeamentos criados pelo programa). </font><font style="vertical-align: inherit;">Discutiremos isso em mais detalhes em breve.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modules, modules_by_index, sysdict, builtins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importlib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> falam por si. </font><font style="vertical-align: inherit;">Todos eles s√£o definidos como inst√¢ncias do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© o tipo raiz de todos os objetos na m√°quina virtual Python. </font><font style="vertical-align: inherit;">Os objetos Python ser√£o discutidos em mais detalhes nos pr√≥ximos cap√≠tulos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os campos relacionados ao </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codec *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cont√™m informa√ß√µes que ajudam no download de codifica√ß√µes. </font><font style="vertical-align: inherit;">Isso √© muito importante para decodificar bytes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A execu√ß√£o do programa deve ocorrer em um encadeamento. </font><font style="vertical-align: inherit;">A estrutura de estado do fluxo cont√©m todas as informa√ß√µes necess√°rias para executar algum objeto de c√≥digo. </font><font style="vertical-align: inherit;">Parte da estrutura de dados do fluxo √© mostrada na Listagem 2.2.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> {</span>
 <span class="hljs-number">2</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">prev</span>;</span>
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         PyInterpreterState *interp;
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">frame</span> *<span class="hljs-title">frame</span>;</span>
 <span class="hljs-number">7</span>         <span class="hljs-keyword">int</span> recursion_depth;
 <span class="hljs-number">8</span>         <span class="hljs-keyword">char</span> overflowed; 
 <span class="hljs-number">9</span>                         
<span class="hljs-number">10</span>         <span class="hljs-keyword">char</span> recursion_critical; 
<span class="hljs-number">11</span>         <span class="hljs-keyword">int</span> tracing;
<span class="hljs-number">12</span>         <span class="hljs-keyword">int</span> use_tracing;
<span class="hljs-number">13</span> 
<span class="hljs-number">14</span>         Py_tracefunc c_profilefunc;
<span class="hljs-number">15</span>         Py_tracefunc c_tracefunc;
<span class="hljs-number">16</span>         PyObject *c_profileobj;
<span class="hljs-number">17</span>         PyObject *c_traceobj;
<span class="hljs-number">18</span> 
<span class="hljs-number">19</span>         PyObject *curexc_type;
<span class="hljs-number">20</span>         PyObject *curexc_value;
<span class="hljs-number">21</span>         PyObject *curexc_traceback;
<span class="hljs-number">22</span> 
<span class="hljs-number">23</span>         PyObject *exc_type;
<span class="hljs-number">24</span>         PyObject *exc_value;
<span class="hljs-number">25</span>         PyObject *exc_traceback;
<span class="hljs-number">26</span> 
<span class="hljs-number">27</span>         PyObject *dict;  <span class="hljs-comment">/* Stores per-thread state */</span>
<span class="hljs-number">28</span>         <span class="hljs-keyword">int</span> gilstate_counter;
<span class="hljs-number">29</span> 
<span class="hljs-number">30</span>         ... 
<span class="hljs-number">31</span>     } PyThreadState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listagem 2.2: Parte da</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
estrutura de </font><i><font style="vertical-align: inherit;">dados do estado do fluxo</font></i><font style="vertical-align: inherit;"> As estruturas de </font><i><font style="vertical-align: inherit;">dados do</font></i><font style="vertical-align: inherit;"> interpretador e os estados do fluxo s√£o discutidos em mais detalhes nos pr√≥ximos cap√≠tulos. O processo de inicializa√ß√£o tamb√©m configura mecanismos de importa√ß√£o e tamb√©m o stdio elementar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s concluir toda a inicializa√ß√£o, Py_Main chama a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tamb√©m localizada no m√≥dulo main.c). A seguir, h√° uma s√©rie de chamadas de fun√ß√£o: PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags -&gt; PyRun_FileExFlags -&gt; PyParser_ASTFromFileObject. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyRun_SimpleFileExFlags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cria o espa√ßo para nome __main__ no qual o conte√∫do do arquivo ser√° executado. Ele tamb√©m verifica se a vers√£o pyc do arquivo existe (o arquivo pyc √© um arquivo simples que cont√©m uma vers√£o j√° compilada do c√≥digo-fonte). Se existir uma vers√£o pyc, ser√° feita uma tentativa de l√™-la como um arquivo bin√°rio e depois execut√°-la. Se o arquivo pyc estiver ausente, PyRun_FileExFlags √© chamado etc. A fun√ß√£o PyParser_ASTFromFileObject chama </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ParseFileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que l√™ o conte√∫do do m√≥dulo e cria √°rvores de an√°lise a partir dele. Em seguida, a √°rvore criada √© passada para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ASTFromNodeObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que cria uma √°rvore de sintaxe abstrata a partir dela.</font></font><br>
<br>
<blockquote>     ,     Py_INCREF  Py_DECREF.    ,     . CPython        :  ,      ,    Py_INCREF. ,      ,       Py_DECREF.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AST √© gerado quando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_mod √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chamado </font><font style="vertical-align: inherit;">. Essa fun√ß√£o chama </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyAST_CompileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que cria objetos de c√≥digo do AST. Observe que o bytecode gerado durante a chamada PyAST_CompileObject √© passado pelo otimizador de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">olho m√°gico</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simples </font><font style="vertical-align: inherit;">, que executa baixa otimiza√ß√£o do bytecode gerado antes de criar objetos de c√≥digo. A fun√ß√£o run_mod em seguida, aplica-se o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyEval_EvalCode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fun√ß√£o </font><font style="vertical-align: inherit;">do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ceval.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> arquivo </font><font style="vertical-align: inherit;">ao objeto c√≥digo. Isso leva a outra s√©rie de chamadas de fun√ß√£o: PyEval_EvalCode -&gt; PyEval_EvalCode -&gt; _PyEval_EvalCodeWithName -&gt; _PyEval_EvalFrameEx. O objeto de c√≥digo √© passado como argumento para a maioria dessas fun√ß√µes de uma forma ou de outra. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_PyEval_EvalFrameEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Este √© um loop de int√©rprete normal que lida com a execu√ß√£o de objetos de c√≥digo. No entanto, √© chamado n√£o apenas com o objeto de c√≥digo como argumento, mas com o objeto de quadro, que tem como atributo um campo que se refere ao objeto de c√≥digo. Esse quadro fornece o contexto para a execu√ß√£o do objeto de c√≥digo. Em palavras simples: o loop do interpretador l√™ continuamente a pr√≥xima instru√ß√£o indicada pelo contador de instru√ß√µes da matriz de instru√ß√µes. Em seguida, ele executa esta instru√ß√£o: adiciona ou remove objetos da pilha de valores no processo at√© esvaziar a matriz de instru√ß√µes a serem executadas (bem, ou algo de excepcional acontece que interrompe o loop).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Python fornece um conjunto de fun√ß√µes que voc√™ pode usar para examinar objetos de c√≥digo reais. Por exemplo, um programa simples pode ser compilado em um objeto de c√≥digo e desmontado para obter opcodes executados pela m√°quina virtual python. Isso √© mostrado na Listagem 2.3.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">1</span>         &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square</span>(<span class="hljs-params">x</span>):</span>
<span class="hljs-number">2</span>         ...     <span class="hljs-keyword">return</span> x*x
<span class="hljs-number">3</span>         ... 
<span class="hljs-number">4</span> 
<span class="hljs-number">5</span>         &gt;&gt;&gt; dis(square)
<span class="hljs-number">6</span>         <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">7</span>                     <span class="hljs-number">2</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">8</span>                     <span class="hljs-number">4</span> BINARY_MULTIPLY     
<span class="hljs-number">9</span>                     <span class="hljs-number">6</span> RETURN_VALUE        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem de c√≥digo 2.3: Desmontando uma fun√ß√£o no Python O </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
arquivo de cabe√ßalho </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Include/opcodes.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cont√©m uma lista completa de todas as instru√ß√µes / c√≥digos de opera√ß√£o da m√°quina virtual Python. Opcode's s√£o bem simples. Tomemos nosso exemplo na Listagem 2.3, que possui um conjunto de quatro instru√ß√µes. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOAD_FAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carrega o valor de seu argumento (neste caso x) </font><b><font style="vertical-align: inherit;">na</font></b><font style="vertical-align: inherit;"> pilha de valores. A m√°quina virtual python √© baseada em pilha; portanto, os valores para opera√ß√µes de c√≥digo de opera√ß√£o s√£o "removidos" da pilha e os resultados do c√°lculo s√£o enviados de volta √† pilha para uso posterior por outros c√≥digos de opera√ß√£o. Em seguida, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BINARY_MULTIPLY exibe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dois itens da pilha, executa multiplica√ß√£o bin√°ria de ambos os valores e empurra o resultado de volta </font><b><font style="vertical-align: inherit;">para a</font></b><font style="vertical-align: inherit;"> pilha. Instru√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RETURN VALUE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recupera um valor da pilha, define o valor de retorno do objeto para esse valor e sai do loop do interpretador. </font><font style="vertical-align: inherit;">Se voc√™ observar a Listagem 2.3, fica claro que essa √© uma simplifica√ß√£o bastante forte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A explica√ß√£o atual do loop do int√©rprete n√£o leva em considera√ß√£o v√°rios detalhes, que ser√£o discutidos nos cap√≠tulos subseq√ºentes. </font><font style="vertical-align: inherit;">Por exemplo, aqui est√£o as perguntas para as quais n√£o recebemos uma resposta:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De onde vieram os valores carregados pela instru√ß√£o LOAD_FAST?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De onde v√™m os argumentos, que s√£o usados ‚Äã‚Äãcomo parte das instru√ß√µes?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como s√£o tratadas as chamadas de fun√ß√£o e m√©todo aninhadas?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o loop do interpretador lida com exce√ß√µes?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s concluir todas as instru√ß√µes, a fun√ß√£o Py_Main continua a execu√ß√£o, mas desta vez inicia o processo de limpeza. </font><font style="vertical-align: inherit;">Se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for chamado para executar a inicializa√ß√£o durante o in√≠cio do int√©rprete, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_FinalizeEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° chamado para executar a limpeza. </font><font style="vertical-align: inherit;">Esse processo inclui aguardar a sa√≠da dos encadeamentos, chamar quaisquer manipuladores de sa√≠da e liberar a mem√≥ria ainda usada alocada pelo int√©rprete.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, analisamos a descri√ß√£o "de alto n√≠vel" dos processos que ocorrem no execut√°vel do Python quando um script √© executado. </font><font style="vertical-align: inherit;">Como observado anteriormente, h√° muitas perguntas que ainda precisam ser respondidas. </font><font style="vertical-align: inherit;">No futuro, aprofundaremos o estudo do int√©rprete e consideraremos detalhadamente cada uma das etapas. </font><font style="vertical-align: inherit;">E come√ßaremos descrevendo o processo de compila√ß√£o no pr√≥ximo cap√≠tulo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt501326/index.html">Como se tornar um engenheiro de DevOps em seis meses ou at√© mais r√°pido. Parte 3. Vers√µes</a></li>
<li><a href="../pt501328/index.html">Apresentando os c√≥digos de c√≥digo do Visual Studio: desenvolvimento em nuvem, onde quer que voc√™ esteja</a></li>
<li><a href="../pt501330/index.html">Microsservi√ßos em C ++. Fic√ß√£o ou realidade?</a></li>
<li><a href="../pt501332/index.html">Reuni√µes s√£o f√°ceis. Tr√™s dicas pr√°ticas di√°rias</a></li>
<li><a href="../pt501336/index.html">FOSS News No. 15 - uma revis√£o das not√≠cias gratuitas e de c√≥digo aberto de 4 a 10 de maio de 2020</a></li>
<li><a href="../pt501340/index.html">Por que o Flutter est√° ganhando?</a></li>
<li><a href="../pt501342/index.html">Certifica√ß√£o online da Microsoft - Anota√ß√µes de campo</a></li>
<li><a href="../pt501346/index.html">Vis√£o geral do teclado mec√¢nico Vortex Core RGB</a></li>
<li><a href="../pt501352/index.html">Kafka contra-ataca</a></li>
<li><a href="../pt501354/index.html">Uma nova vis√£o do estilo do c√≥digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>