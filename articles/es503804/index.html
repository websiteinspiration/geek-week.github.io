<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòñ üå¨Ô∏è üêç Cuento de c√≥mo hacer una m√°quina del tiempo para una base de datos y escribir accidentalmente un exploit üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø üé® üçª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buen dia, Habr. 
 
 ¬øAlguna vez te has preguntado c√≥mo cambiar el tiempo dentro de la base de datos? ¬øF√°cil? Bueno, en algunos casos, s√≠, es f√°cil: el...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cuento de c√≥mo hacer una m√°quina del tiempo para una base de datos y escribir accidentalmente un exploit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503804/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buen dia, Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øAlguna vez te has preguntado c√≥mo cambiar el tiempo dentro de la base de datos? </font><font style="vertical-align: inherit;">¬øF√°cil? </font><font style="vertical-align: inherit;">Bueno, en algunos casos, s√≠, es f√°cil: el comando de Linux es date y el punto est√° en el sombrero. </font><font style="vertical-align: inherit;">¬øY si necesita cambiar la hora solo dentro de una instancia de la base de datos si hay varias en el servidor? </font><font style="vertical-align: inherit;">¬øY para un solo proceso de base de datos? </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY? </font><font style="vertical-align: inherit;">Uh, eso es, mi amigo, ese es el punto.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alguien dir√° que este es otro sur, no relacionado con la realidad, que se presenta peri√≥dicamente en Habr√©. </font><font style="vertical-align: inherit;">Pero no, la tarea es bastante real y est√° dictada por la necesidad de producci√≥n: pruebas de c√≥digo. </font><font style="vertical-align: inherit;">Aunque estoy de acuerdo, el caso de prueba puede ser bastante ex√≥tico: compruebe c√≥mo se comporta el c√≥digo para una fecha determinada en el futuro. </font><font style="vertical-align: inherit;">En este art√≠culo, examinar√© en detalle c√≥mo se resolvi√≥ esta tarea, y al mismo tiempo capturar√© un poco el proceso de organizaci√≥n de pruebas y dev representa la base de Oracle. </font><font style="vertical-align: inherit;">Antes de una lectura larga, p√≥ngase c√≥modo y pida un gato.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con una breve introducci√≥n para mostrar por qu√© esto es necesario. Como ya se anunci√≥, escribimos pruebas al implementar ediciones en la base de datos. El sistema bajo el cual se realizan estas pruebas se desarroll√≥ al principio (o tal vez un poco antes del inicio) de los cero, por lo que toda la l√≥gica de negocios est√° dentro de la base de datos y est√° escrita en forma de procedimientos almacenados en el lenguaje pl / sql. Y s√≠, nos trae dolor y sufrimiento. Pero este es un legado, y tienes que vivir con √©l. En el c√≥digo y el modelo tabular, es posible especificar c√≥mo evolucionan los par√°metros dentro del sistema con el tiempo, en otras palabras, establecer la actividad desde qu√© fecha y a qu√© fecha se pueden aplicar. Qu√© llegar lejos: el cambio reciente en la tasa del IVA es un claro ejemplo de esto. Y para que tales cambios en el sistema puedan verificarse por adelantado,una base de datos con tales cambios debe transferirse a una fecha determinada en el futuro, los par√°metros de c√≥digo en las tablas se activar√°n en el "momento actual". Y debido a las caracter√≠sticas espec√≠ficas del sistema compatible, no puede utilizar pruebas simuladas que simplemente cambiar√≠an el valor de retorno de la fecha actual del sistema en el idioma en que comienza la sesi√≥n de prueba.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, determinamos por qu√©, luego necesitamos determinar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥mo se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> logra </font><i><font style="vertical-align: inherit;">el</font></i><font style="vertical-align: inherit;"> objetivo. </font><font style="vertical-align: inherit;">Para hacer esto, har√© una peque√±a retrospectiva de las opciones para construir bancos de prueba para desarrolladores y c√≥mo comenz√≥ cada sesi√≥n de prueba.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edad de Piedra</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ârase una vez, cuando los √°rboles eran peque√±os, y los mainframes eran grandes, solo hab√≠a un servidor para el desarrollo y tambi√©n estaba realizando pruebas. </font><font style="vertical-align: inherit;">Y, en principio, todo esto fue suficiente para todos (¬° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">640K es suficiente para todos!</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: para la tarea de cambiar el tiempo, era necesario involucrar a muchos departamentos relacionados: administradores del sistema (haciendo el cambio de hora en el servidor secundario desde la ra√≠z), administradores de DBMS (haciendo el reinicio de la base de datos), programadores ( fue necesario notificar que se producir√≠a un cambio de hora, porque parte del c√≥digo dej√≥ de funcionar, por ejemplo, los tokens web emitidos anteriormente para llamar a m√©todos api dejaron de ser v√°lidos y esto podr√≠a ser una sorpresa), probadores (prob√°ndose a s√≠ mismo) ... Cuando devuelve el tiempo al presente todo se repiti√≥ en orden inverso.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edades medias</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el tiempo, el n√∫mero de desarrolladores en el departamento creci√≥ y en alg√∫n momento 1 servidor dej√≥ de ser suficiente. Principalmente debido al hecho de que diferentes desarrolladores quieren cambiar el mismo paquete pl / sql y realizar pruebas para √©l (incluso sin cambiar el tiempo). Se escuch√≥ m√°s y m√°s indignaci√≥n: ‚Äú¬°Cu√°nto tiempo! ¬°Basta de tolerar esto! ¬°F√°bricas para trabajadores, tierras para campesinos! ¬°Cada programador tiene una base de datos! Sin embargo, si tiene unos pocos terabytes de base de datos de productos y 50-100 desarrolladores, honestamente en este formulario, el requisito no es muy real. Y a√∫n as√≠, todos quieren que la base de prueba y desarrollo no se quede muy atr√°s de las ventas, tanto en estructura como en los datos dentro de las tablas. Entonces hab√≠a un servidor separado para las pruebas, llam√©moslo preproducci√≥n. Fue construido a partir de 2 servidores id√©nticos,donde se realiz√≥ la venta para restaurar la base de datos de d√≥lares RMAN y tard√≥ entre 2 y 2,5 d√≠as. Despu√©s de la recuperaci√≥n, la base de datos realiz√≥ el anonimato de datos personales y otros datos importantes y la carga de las aplicaciones de prueba se aplic√≥ a este servidor (as√≠ como los programadores siempre trabajaron con el servidor recientemente restaurado). El trabajo con el servidor requerido se asegur√≥ utilizando el recurso de IP del cl√∫ster compatible con corosync (marcapasos). Mientras todos trabajan con el servidor activo, en el segundo nodo, la recuperaci√≥n de la base de datos comienza nuevamente y despu√©s de 2-3 d√≠as cambian nuevamente de lugar.El trabajo con el servidor requerido se asegur√≥ utilizando el recurso de IP del cl√∫ster compatible con corosync (marcapasos). Mientras todos trabajan con el servidor activo, en el segundo nodo, la recuperaci√≥n de la base de datos comienza nuevamente y despu√©s de 2-3 d√≠as cambian nuevamente de lugar.El trabajo con el servidor requerido se asegur√≥ utilizando el recurso de IP del cl√∫ster compatible con corosync (marcapasos). Mientras todos trabajan con el servidor activo, en el segundo nodo, la recuperaci√≥n de la base de datos comienza nuevamente y despu√©s de 2-3 d√≠as cambian nuevamente de lugar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De las desventajas obvias: necesita 2 servidores y 2 veces m√°s recursos (principalmente discos) que productos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pros: operaci√≥n y prueba de cambio de hora: se puede realizar en el segundo servidor, en el servidor principal en este momento, los desarrolladores viven y se dedican a sus negocios. </font><font style="vertical-align: inherit;">El cambio de servidor ocurre solo cuando la base de datos est√° lista y el tiempo de inactividad del entorno de prueba es m√≠nimo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La era del progreso cient√≠fico y tecnol√≥gico.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando cambiamos a la base de datos 11g Release 2, leemos acerca de una tecnolog√≠a interesante que Oracle proporciona bajo el nombre de CloneDB. La conclusi√≥n es que las copias de seguridad de la base de datos del producto (hay una copia directa de los archivos de datos del producto) se almacenan en un servidor especial, que luego publica este conjunto de archivos de datos a trav√©s de DNFS (NFS directo) a pr√°cticamente cualquier n√∫mero de servidores, y no es necesario tener uno en el servidor la misma cantidad de discos, porque se implementa el enfoque Copiar en escritura: la base de datos utiliza un recurso compartido de red con archivos de datos del servidor de respaldo para leer datos en tablas, y los cambios se escriben en archivos de datos locales en el servidor de desarrollo. Peri√≥dicamente, se realiza la "puesta a cero de los plazos" para el servidor, de modo que los archivos de datos locales no crecen demasiado y el lugar no termina. Al actualizar el servidor, los datos tambi√©n se despersonalizan en las tablas,en este caso, todas las actualizaciones de tablas caen en archivos de datos locales y esas tablas se leen desde el servidor local, todas las dem√°s tablas se leen a trav√©s de la red.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: todav√≠a hay 2 servidores (para garantizar actualizaciones fluidas con un tiempo de inactividad m√≠nimo para los consumidores), pero ahora el volumen de discos se reduce considerablemente. Para almacenar d√≥lares en una bola nfs, necesita 1 servidor m√°s en tama√±o + - como producto, pero el tiempo de ejecuci√≥n de la actualizaci√≥n se reduce (especialmente cuando se usan d√≥lares incrementales). La conexi√≥n en red con una bola nfs ralentiza notablemente las operaciones de lectura de E / S. Para usar la tecnolog√≠a CloneDB, la base debe ser una Edici√≥n Enterprise; en nuestro caso, tuvimos que llevar a cabo el procedimiento de actualizaci√≥n en las bases de prueba cada vez. Afortunadamente, las bases de datos de prueba est√°n exentas de las pol√≠ticas de licencias de Oracle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pros: la operaci√≥n para restaurar una base de un bakup lleva menos de 1 d√≠a (no recuerdo la hora exacta).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cambio de tiempo: sin cambios importantes. </font><font style="vertical-align: inherit;">Aunque en este momento ya se hab√≠an hecho scripts para cambiar la hora en el servidor y reiniciar la base de datos para hacer esto sin llamar la </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atenci√≥n de los ordenados de los</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> administradores.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era de nueva historia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ahorrar a√∫n m√°s espacio en disco y hacer que la lectura de datos fuera de l√≠nea, decidimos implementar nuestra versi√≥n CloneDB (con flashback e instant√°neas) usando un sistema de archivos con compresi√≥n. </font><font style="vertical-align: inherit;">Durante las pruebas preliminares, la elecci√≥n recay√≥ en ZFS, aunque no hay soporte oficial para ello en el kernel de Linux (cita del </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) A modo de comparaci√≥n, tambi√©n analizamos BTRFS (b-tree fs), que Oracle est√° promoviendo, pero la relaci√≥n de compresi√≥n fue menor con el mismo consumo de CPU y RAM en las pruebas. Para habilitar el soporte de ZFS en RHEL5, se construy√≥ su propio n√∫cleo basado en UEK (n√∫cleo empresarial irrompible), y en los ejes y n√∫cleos m√°s nuevos, simplemente puede usar el n√∫cleo UEK listo para usar. La implementaci√≥n de una base de prueba de este tipo tambi√©n se basa en el mecanismo COW, pero a nivel de las instant√°neas del sistema de archivos. Se suministran 2 dispositivos de disco al servidor, en uno, se crea el grupo zfs, donde a trav√©s de RMAN se crea una base de datos de reserva adicional de la venta, y dado que usamos compresi√≥n, la partici√≥n ocupa menos que la producci√≥n.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema se instala en el segundo dispositivo de disco y el resto es necesario para que el servidor y la base de datos funcionen, por ejemplo, particiones para deshacer y temp. En cualquier momento, puede hacer una instant√°nea del grupo zfs, que luego se abre como una base de datos separada. Crear una instant√°nea toma un par de segundos. ¬°Es magia! Y, en principio, tales bases de datos pueden inclinarse bastante, si solo el servidor tuviera suficiente RAM para todas las instancias y el tama√±o del grupo zfs en s√≠ (para almacenar cambios en los archivos de datos durante la despersonalizaci√≥n y durante el ciclo de vida del clon de la base de datos). El momento principal para actualizar la base de prueba es la operaci√≥n de despersonalizaci√≥n de datos, pero tambi√©n cabe en 15-20 minutos. Hay una aceleraci√≥n significativa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras: en el servidor no puede cambiar la hora simplemente traduciendo la hora del sistema, porque todas las instancias de la base de datos que se ejecutan en este servidor caer√°n en este momento de una vez. Se ha encontrado una soluci√≥n a este problema y se describir√° en la secci√≥n correspondiente. Mirando hacia el futuro, dir√© que le permite cambiar la hora dentro de solo 1 instancia de la base de datos (enfoque de cambio de hora </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por instancia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) sin afectar al resto en el mismo servidor. </font><font style="vertical-align: inherit;">Y el tiempo en el servidor en s√≠ tampoco cambia. </font><font style="vertical-align: inherit;">Esto elimina la necesidad de un script ra√≠z para cambiar la hora en el servidor. </font><font style="vertical-align: inherit;">Tambi√©n en esta etapa, se implementa la automatizaci√≥n de cambio de tiempo para instancias a trav√©s de Jenkins CI y los usuarios (en t√©rminos relativos, equipos de desarrollo) que poseen su stand tienen derecho a los trabajos a trav√©s de los cuales ellos mismos pueden cambiar el horario, actualizar el stand al estado actual con ventas, tomar instant√°neas y restauraci√≥n (reversi√≥n) de la base a la instant√°nea creada previamente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era de la historia reciente</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la llegada de Oracle 12c, apareci√≥ una nueva tecnolog√≠a: bases de datos conectables y, como resultado, bases de datos de contenedores (cdb). Con esta tecnolog√≠a, dentro de una instancia f√≠sica, se pueden crear varias bases de datos "virtuales" que comparten un √°rea de memoria com√∫n de la instancia. Pros: puede guardar memoria para el servidor (y aumentar el rendimiento general de nuestra base de datos, porque toda la memoria que estaba ocupada antes, por ejemplo, 5 instancias diferentes, se puede compartir para todos los contenedores pdb implementados dentro de cdb, y solo la usar√°n cuando realmente lo necesitan, y no como lo fue en la fase anterior, cuando cada instancia "bloque√≥" la memoria que se le asign√≥ y cuando la actividad de uno de los clones fue baja, la memoria no se us√≥ de manera efectiva, en otras palabras, estaba inactiva).Los archivos de datos de diferentes pdb todav√≠a se encuentran en el grupo zfs, y cuando implementan clones, usan el mismo mech de instant√°neas zfs. En esta etapa, nos acercamos lo suficiente a la capacidad de dar a casi todos los desarrolladores su propia base de datos. Cambiar el tiempo en esta etapa no requiere un reinicio de la base de datos y funciona con mucha precisi√≥n solo para aquellos procesos que necesitan un cambio de tiempo; todos los dem√°s usuarios que trabajan con esta base de datos no se ven afectados de ninguna manera.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menos: no puede utilizar el enfoque de cambio de tiempo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por instancia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la fase anterior, porque ahora tenemos una instancia. Sin embargo, se encontr√≥ una soluci√≥n para este caso. Y fue precisamente esto lo que sirvi√≥ de impulso para escribir este art√≠culo. Mirando hacia el futuro, dir√© que es un cambio de tiempo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enfoque de </font><i><font style="vertical-align: inherit;">proceso</font></i><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">es decir en cada proceso de base de datos, puede establecer su propio tiempo √∫nico en general.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, una sesi√≥n de prueba t√≠pica inmediatamente despu√©s de conectarse a la base de datos establece el momento adecuado al comienzo de su trabajo, realiza pruebas y devuelve el tiempo al final. Es necesario devolver el tiempo por una simple raz√≥n: algunos procesos de la base de datos Oracle no terminan cuando el cliente de la base de datos se desconecta del servidor, estos son procesos del servidor llamados servidores compartidos, que, a diferencia de los procesos dedicados, se ejecutan cuando el servidor de la base de datos se inicia y vive casi indefinidamente (en el ideal imagen del mundo). Si deja la hora cambiada en dicho proceso del servidor, entonces otra conexi√≥n que se servir√° en este proceso recibir√° la hora incorrecta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro sistema, los servidores compartidos se usan mucho, porque hasta 11 g pr√°cticamente no hab√≠a una soluci√≥n adecuada para que nuestro sistema soportara cargas elevadas (en 11 g apareci√≥ DRCP - agrupaci√≥n de conexiones residentes en la base de datos). Y he aqu√≠ por qu√©: en sub hay un l√≠mite en el n√∫mero total de procesos del servidor que puede crear tanto en modo dedicado como compartido. Los procesos dedicados se generan m√°s lentamente de lo que la base de datos puede emitir un proceso compartido ya preparado del conjunto de procesos compartidos, lo que significa que cuando las nuevas conexiones est√°n llegando constantemente (especialmente si el proceso realiza otras operaciones lentas), el n√∫mero total de procesos aumentar√°. Cuando se alcanza el l√≠mite de sesiones / procesos, la base de datos deja de dar servicio a nuevas conexiones y se produce el colapso.La transici√≥n al uso de un grupo de procesos compartidos nos permiti√≥ reducir la cantidad de procesos nuevos en el servidor al conectarnos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ah√≠ es donde se completa la revisi√≥n de las tecnolog√≠as para construir bases de datos de prueba y finalmente podemos comenzar a implementar los algoritmos de cambio de tiempo para la base de datos en s√≠.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El enfoque falso por instancia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo cambiar el tiempo dentro de la base de datos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que se me ocurri√≥ fue crear en un esquema que contiene todo el c√≥digo de l√≥gica de negocios su propia funci√≥n que se superpone a las funciones del lenguaje que funcionan con el tiempo (sysdate, current_date, etc.) y, bajo ciertas condiciones, comienza a dar otros valores, por ejemplo, podr√≠a establecer valores a trav√©s del contexto de la sesi√≥n al comienzo de la ejecuci√≥n de la prueba. No funcion√≥, las funciones de lenguaje incorporadas no se superponen con las del usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, se probaron los sistemas de virtualizaci√≥n ligera (Vserver, OpenVZ) y la contenedorizaci√≥n a trav√©s de Docker. Tampoco funciona, usan el mismo n√∫cleo que el sistema host, lo que significa que usan los mismos valores de temporizador del sistema. Caerse de nuevo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ no tengo miedo de rescatar esta palabra, una invenci√≥n brillante del mundo Linux: redefinici√≥n / intercepci√≥n de funciones en la etapa de carga din√°mica de objetos compartidos. Muchos lo conocen como trucos con LD_PRELOAD. En la variable de entorno LD_PRELOAD, puede especificar la biblioteca que se cargar√° antes que todas las dem√°s que el proceso necesita, y si esta biblioteca tiene caracteres con el mismo nombre que, por ejemplo, en la biblioteca est√°ndar, que se cargar√° m√°s tarde, la tabla de importaci√≥n de s√≠mbolos para la aplicaci√≥n se ver√° como si la funci√≥n proporciona nuestro m√≥dulo de reemplazo. Y eso es exactamente lo que hace la biblioteca del proyecto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libfaketime</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que comenzamos a usar para iniciar la base de datos en un momento diferente al del sistema. La biblioteca pierde llamadas relacionadas con trabajar con el temporizador del sistema y obtener la hora y fecha del sistema. Para controlar cu√°nto tiempo se mueve en relaci√≥n con la fecha actual del servidor o desde qu√© momento debe pasar el tiempo dentro del proceso, todo est√° controlado por variables de entorno que deben establecerse junto con LD_PRELOAD. Para implementar el cambio de hora, implementamos un trabajo en el servidor Jenkins, que ingresa al servidor de la base de datos y reinicia el DBMS con o sin variables de entorno establecidas para libfaketime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un algoritmo de ejemplo para iniciar una base de datos con un tiempo de sustituci√≥n:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> LD_PRELOAD=/usr/<span class="hljs-built_in">local</span>/lib/faketime/libfaketime.so
<span class="hljs-built_in">export</span> FAKETIME=<span class="hljs-string">"+1d"</span>
<span class="hljs-built_in">export</span> FAKETIME_NO_CACHE=1<font></font>
<font></font>
<span class="hljs-variable">$ORACLE_HOME</span>/bin/sqlplus @/home/oracle/scripts/restart_db.sql
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y si piensas que todo funcion√≥ de inmediato, entonces est√°s profundamente equivocado. </font><font style="vertical-align: inherit;">Porque, como result√≥, valida las bibliotecas que se cargan en el proceso cuando se inicia el DBMS. </font><font style="vertical-align: inherit;">Y en el registro de alertas, comienza a resentirse por la falsificaci√≥n notada, mientras que la base no comienza. </font><font style="vertical-align: inherit;">Ahora no recuerdo exactamente c√≥mo deshacerme de √©l, hay alg√∫n par√°metro que puede deshabilitar la ejecuci√≥n de controles de cordura al inicio.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El enfoque falso por proceso</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea general de cambiar el tiempo solo dentro de 1 proceso sigui√≥ siendo la misma: use libfaketime. </font><font style="vertical-align: inherit;">Comenzamos la base de datos con una biblioteca precargada, pero establecemos un desplazamiento de tiempo cero al inicio, que luego se propaga a todos los procesos DBMS. </font><font style="vertical-align: inherit;">Y luego, dentro de la sesi√≥n de prueba, configure la variable de entorno solo para este proceso. </font><font style="vertical-align: inherit;">Pff, algo de negocios.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, para aquellos que est√°n familiarizados con el lenguaje pl / sql, todo el destino de esta idea es inmediatamente claro. Porque el lenguaje es muy limitado y b√°sicamente adecuado para tareas de alto nivel. No se puede implementar la programaci√≥n del sistema all√≠. Aunque algunas operaciones de bajo nivel (por ejemplo, trabajar con una red, trabajar con archivos) est√°n presentes en forma de paquetes dbms / utl preinstalados del sistema. Durante todo el tiempo que trabaj√© con Oracle, realic√© ingenier√≠a inversa de paquetes preinstalados varias veces, el c√≥digo de algunos de ellos est√° oculto a los ojos de extra√±os (se llaman envueltos). Si tiene prohibido mirar algo, entonces la tentaci√≥n de descubrir c√≥mo est√° organizada en el interior solo aumenta. Pero a menudo, incluso despu√©s del anvrapper, no siempre hay algo que ver, porque las funciones de dichos paquetes se implementan como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interfaz c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para las bibliotecas en el disco.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En total, nos acercamos a un candidato para la implementaci√≥n: tecnolog√≠a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con procedimientos externos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioteca dise√±ada de manera especial puede exportar m√©todos, que luego la base de datos Oracle puede llamar a trav√©s de pl / sql. Parece prometedor Solo una vez que conoc√≠ esto en los cursos avanzados de plsql, record√© muy remotamente c√≥mo cocinarlo. Y significa que es necesario leer la documentaci√≥n. Lo le√≠ e inmediatamente me deprim√≠. Debido a que la carga de dicha biblioteca personalizada se realiza en un proceso de agente separado a trav√©s de un escucha de base de datos, y la comunicaci√≥n con este agente se realiza a trav√©s de dlink. Entonces, nuestra idea fue establecer una variable de entorno dentro del proceso de la base de datos. Y todo esto se hace por razones de seguridad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una imagen de la documentaci√≥n que muestra c√≥mo funciona:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/1h/07/pu1h07d6fvy1wwetq4deujbpnga.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tipo de la biblioteca so / dll no es tan importante, pero por alguna raz√≥n la imagen es solo para Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiz√°s alguien not√≥ aqu√≠ otra oportunidad potencial. S√≠, s√≠, esto es Java. Oracle le permite escribir c√≥digo de procedimiento almacenado no solo en plsql, sino tambi√©n en java, que sin embargo se exportan de la misma manera que los m√©todos plsql. Peri√≥dicamente, hice esto, por lo que no deber√≠a haber un problema con esto. Pero luego se escondi√≥ otra trampa. Java funciona con una copia del entorno y le permite obtener solo las variables de entorno que el proceso JVM ten√≠a al inicio. La JVM incorporada hereda las variables de entorno del proceso de la base de datos, pero eso es todo. Vi consejos en Internet sobre c√≥mo cambiar el mapa de solo lectura a trav√©s de la reflexi√≥n, pero cu√°l es el punto, porque todav√≠a es solo una copia. Es decir, la mujer qued√≥ nuevamente sin nada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, Java no es solo un pelaje valioso. Al usarlo, puede generar procesos desde un proceso de base de datos. Aunque todas las operaciones inseguras deben resolverse por separado a trav√©s del mecanismo de concesiones de Java, que se realizan utilizando el paquete dbms_java. Desde el interior del c√≥digo plsql, puede obtener el proceso pid del proceso del servidor actual en el que se est√° ejecutando el c√≥digo, utilizando las vistas del sistema v $ session y v $ process. Adem√°s, podemos generar algunos procesos secundarios de nuestra sesi√≥n para hacer algo con este pid. Para comenzar, simplemente deduje todas las variables de entorno que est√°n dentro del proceso de la base de datos (para probar la hip√≥tesis)</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span><font></font>
<font></font>
awk <span class="hljs-string">'BEGIN {RS="\0"; ORS="\n"} $0'</span> <span class="hljs-string">"/proc/<span class="hljs-variable">$pid</span>/environ"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien deducido, y luego qu√©. Todav√≠a es imposible cambiar las variables en el archivo de entorno, estos son los datos que se transfirieron al proceso cuando comenz√≥ y son de solo lectura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Busqu√© en Internet en stackoverflow "C√≥mo cambiar una variable de entorno en otro proceso". La mayor√≠a de las respuestas fueron que era imposible, pero hubo una respuesta que describi√≥ esta oportunidad como un truco sucio y deficiente. Y esa respuesta fue </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Albert Einstein</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gdb. El depurador puede conectarse a cualquier proceso conociendo su pid y ejecutar cualquier funci√≥n / procedimiento que exista en √©l como s√≠mbolo exportado p√∫blicamente, por ejemplo, desde alguna biblioteca. En libc, hay funciones para trabajar con variables de entorno, y libc se carga en cualquier proceso de la base de datos Oracle (y pr√°cticamente en cualquier programa en Linux).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se establece la variable de entorno en un proceso extra√±o (debe llamarlo desde la ra√≠z debido al ptrace utilizado):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
env_name=<span class="hljs-variable">$2</span>
env_val=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span><font></font>
<font></font>
out=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (int) setenv("'</span><span class="hljs-variable">$env_name</span><span class="hljs-string">'", "'</span><span class="hljs-string">"<span class="hljs-variable">$env_val</span>"</span><span class="hljs-string">'", 1)'</span> -ex <span class="hljs-string">"detach"</span> 2&gt;&amp;1`
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, para ver las variables de entorno dentro del proceso gdb tambi√©n es adecuado. </font><font style="vertical-align: inherit;">Como se mencion√≥ anteriormente, el archivo entorno de / proc / pid / muestra solo las variables que exist√≠an al comienzo del proceso. </font><font style="vertical-align: inherit;">Y si el proceso cre√≥ algo en el curso de su trabajo, esto solo se puede ver a trav√©s del depurador:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
var_name=<span class="hljs-variable">$2</span><font></font>
<font></font>
var_value=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (char*) getenv("'</span><span class="hljs-variable">$var_name</span><span class="hljs-string">'")'</span> -ex <span class="hljs-string">'detach'</span> | egrep <span class="hljs-string">'^\$1 ='</span>`<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> == <span class="hljs-string">'$1 = 0x0'</span> ]
<span class="hljs-keyword">then</span>
  <span class="hljs-comment"># variable empty or does not exist</span>
  <span class="hljs-built_in">echo</span> -n
<span class="hljs-keyword">else</span>
  <span class="hljs-comment"># gdb returns $1 = hex_value "string value"</span>
  var_hex=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>`<font></font>
  var_value=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | sed -r -e <span class="hljs-string">'s/^\$1 = '</span><span class="hljs-variable">$var_hex</span><span class="hljs-string">' //;s/^"//;s/"$//'</span>`<font></font>
  <font></font>
  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span>
<span class="hljs-keyword">fi</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, la soluci√≥n ya est√° en nuestro bolsillo: a trav√©s de Java generamos el proceso de depuraci√≥n, que va al proceso que lo gener√≥ y establece la variable de entorno deseada para √©l y luego termina (el moro ha hecho su trabajo, el moro puede irse). </font><font style="vertical-align: inherit;">Pero ten√≠a la sensaci√≥n de que era una especie de muleta. </font><font style="vertical-align: inherit;">Quer√≠a algo m√°s elegante. </font><font style="vertical-align: inherit;">De alguna manera, ser√≠a lo mismo forzar al proceso de la base de datos a establecer variables de entorno sin asalto externo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un huevo en un pato, un pato en una liebre ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego alguien viene al rescate, s√≠, lo has adivinado bien, nuevamente Java, es decir, JNI (interfaz nativa de Java). </font><font style="vertical-align: inherit;">JNI le permite llamar a m√©todos C nativos dentro de la JVM. </font><font style="vertical-align: inherit;">El c√≥digo se emite de manera especial en forma de un objeto compartido de la biblioteca, que luego carga la JVM, mientras que los m√©todos que estaban en la biblioteca se asignan a los m√©todos de Java dentro de la clase declarada con el modificador nativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, ok, estamos escribiendo una clase (de hecho, esto es solo una pieza de trabajo):</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Posix</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setenv</span><span class="hljs-params">(String key, String value, <span class="hljs-keyword">boolean</span> overwrite)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">getenv</span><span class="hljs-params">(String key)</span></span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stub</span><span class="hljs-params">()</span> 
    </span>{<font></font>
        <font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, comp√≠lelo y obtenga el archivo h generado de la futura biblioteca:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  </span><font></font>
javac Posix.java<font></font>
<font></font>
<span class="hljs-comment">#   Posix.h        JNI</span><font></font>
javah Posix<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habiendo recibido el archivo de encabezado, escribimos el cuerpo para cada m√©todo:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Posix.h"</span></span><font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">Java_Posix_setenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key, jstring value, jboolean overwrite)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, value, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
    <span class="hljs-keyword">int</span> err = setenv(k, v, overwrite);<font></font>
<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, key, k);<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, value, v);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> err;<font></font>
}<font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jstring JNICALL <span class="hljs-title">Java_Posix_getenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = getenv(k);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> (*env)-&gt;NewStringUTF(env, v);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y compilar la biblioteca</font></font><br>
<br>
<pre><code class="bash hljs">gcc -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include"</span> -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include/linux"</span> -fPIC Posix.c -shared -o libPosix.so -Wl,-soname -Wl,--no-whole-archive<font></font>
<font></font>
strip libPosix.so<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que Java cargue la biblioteca nativa, debe ser encontrada por el sistema ld de acuerdo con todas las reglas de Linux. </font><font style="vertical-align: inherit;">Adem√°s, Java tiene un conjunto de propiedades que contienen las rutas donde se realizan las b√∫squedas en la biblioteca. </font><font style="vertical-align: inherit;">La forma m√°s f√°cil de trabajar dentro de Oracle es poner nuestra biblioteca en $ ORACLE_HOME / lib. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y despu√©s de haber creado la biblioteca, necesitamos compilar la clase dentro de la base de datos y publicarla como un paquete plsql. </font><font style="vertical-align: inherit;">Hay 2 opciones para crear clases Java dentro de la base de datos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cargar el archivo de clase binario a trav√©s de la utilidad loadjava</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compilar c√≥digo de clase desde la fuente usando sqlplus</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usaremos el segundo m√©todo, aunque son b√°sicamente iguales. </font><font style="vertical-align: inherit;">Para el primer caso, fue necesario escribir inmediatamente todo el c√≥digo de clase en la etapa 1, cuando recibimos una clase de c√≥digo auxiliar para el archivo h. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para crear una clase en subd, se utiliza una sintaxis especial:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">AND</span> RESOLVE <span class="hljs-keyword">JAVA</span> <span class="hljs-keyword">SOURCE</span> NAMED <span class="hljs-string">"Posix"</span> <span class="hljs-keyword">AS</span><font></font>
...<font></font>
...<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se crea la clase, debe publicarse como m√©todos plsql, y aqu√≠ nuevamente la sintaxis especial:</font></font><br>
<br>
<pre><code class="sql hljs">procedure set_env(var_name varchar2, var_value varchar2)<font></font>
is<font></font>
language java name 'Posix.set_env(java.lang.String, java.lang.String)';<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando intenta llamar a m√©todos potencialmente inseguros dentro de Java, se genera una ejecuci√≥n que dice que no se ha emitido ninguna concesi√≥n de Java para el usuario. </font><font style="vertical-align: inherit;">La carga de m√©todos nativos es otra operaci√≥n insegura, porque inyectamos c√≥digo extra√±o directamente en el proceso de la base de datos (el mismo exploit que se anunci√≥ en el encabezado). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero dado que la base de datos es de prueba, otorgamos una subvenci√≥n sin ninguna preocupaci√≥n al conectarse desde sys:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_java.grant_permission( <span class="hljs-string">'SYSTEM'</span>, <span class="hljs-string">'SYS:java.lang.RuntimePermission'</span>, <span class="hljs-string">'loadLibrary.Posix'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El nombre de usuario del sistema es el que compil√© el c√≥digo de Java y el paquete de envoltorio plsql. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante tener en cuenta que al cargar una biblioteca a trav√©s de una llamada a System.loadLibrary, omitimos el prefijo lib y la extensi√≥n so (como se describe en la documentaci√≥n) y no pasamos ninguna ruta donde buscar. Existe un m√©todo similar de System.load que solo puede cargar una biblioteca utilizando una ruta absoluta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego nos esperan 2 desagradables sorpresas: aterric√© en la pr√≥xima madriguera de conejos de Oracle. Al emitir una subvenci√≥n, se produce un error con un mensaje bastante brumoso:</font></font><br>
<br>
<pre><code class="plaintext hljs">ORA-29532: Java call terminated by uncaught Java exception: java.lang.SecurityException: policy table update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema se busca en Internet y conduce a My Oracle Support (tambi√©n conocido como Metalink). </font><font style="vertical-align: inherit;">Porque </font><font style="vertical-align: inherit;">De acuerdo con las reglas de Oracle, no est√° permitido publicar art√≠culos de un enlace de metal en fuentes abiertas, solo mencionar√© el n√∫mero de documento: 259471.1 (los que tengan acceso podr√°n leer por s√≠ mismos). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La esencia del problema es que Oracle no nos permitir√° simplemente cargar el c√≥digo sospechoso de terceros en nuestro proceso. </font><font style="vertical-align: inherit;">Lo cual es l√≥gico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero como la base es prueba y confiamos en nuestro c√≥digo, permitimos la descarga sin miedos especiales. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fuh, las desventuras han terminado.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta vivo, vivo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la respiraci√≥n contenida, decid√≠ intentar darle vida a mi Frankenstein. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos la base de datos con el libfaketime precargado y el desplazamiento 0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con√©ctese a la base de datos y realice una llamada al c√≥digo que simplemente muestra el tiempo antes y despu√©s de cambiar la variable de entorno:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_output.enable(<span class="hljs-number">100000</span>);<font></font>
dbms_java.set_output(100000);<font></font>
dbms_output.put_line('old time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
system.posix.set_env('FAKETIME','+1d');<font></font>
dbms_output.put_line('new time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Funciona, maldita sea! </font><font style="vertical-align: inherit;">Honestamente, esperaba algunas sorpresas m√°s, como los errores de ORA-600. </font><font style="vertical-align: inherit;">Sin embargo, la alerta ten√≠a el n√∫mero entero y el c√≥digo segu√≠a funcionando. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante tener en cuenta que si la conexi√≥n a la base de datos se realiza como dedicada, luego de que se complete la conexi√≥n, el proceso se destruir√° y no habr√° rastros. </font><font style="vertical-align: inherit;">Pero si usamos conexiones compartidas, en este caso se asigna un proceso listo desde el grupo de servidores, cambiamos el tiempo en √©l a trav√©s de variables de entorno y cuando se desconecta, permanecer√° modificado dentro del proceso. </font><font style="vertical-align: inherit;">Y cuando otra sesi√≥n de la base de datos caiga en el mismo proceso del servidor, recibir√° la hora equivocada para su considerable sorpresa. </font><font style="vertical-align: inherit;">Por lo tanto, al final de la sesi√≥n de prueba, es mejor volver siempre el tiempo a cero.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que la historia haya sido interesante (y tal vez incluso √∫til para alguien). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los c√≥digos fuente est√°n disponibles en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentaci√≥n de libfaketime </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambi√©n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo haces las pruebas? </font><font style="vertical-align: inherit;">¬øY c√≥mo se crean bases de datos de desarrollo y prueba en una empresa?</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bono para aquellos que leen hasta el final</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/wd/m1/s9/wdm1s9kk6_kckj-xf5amc_o6wjq.jpeg"><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es503782/index.html">¬øC√≥mo hacer una mesa interactiva con una superficie de trabajo en forma de c√≠rculo?</a></li>
<li><a href="../es503786/index.html">Representaci√≥n digital de audio anal√≥gico. Breve programa educativo</a></li>
<li><a href="../es503788/index.html">Correo din√°mico :: seguridad</a></li>
<li><a href="../es503790/index.html">Permutaciones Noveno grado. Tarea de paridad</a></li>
<li><a href="../es503796/index.html">Hacer el soporte m√°s barato, tratando de no perder calidad</a></li>
<li><a href="../es503812/index.html">Pirata √°gil y algunas leyes de dial√©ctica.</a></li>
<li><a href="../es503826/index.html">Protecci√≥n DDoS sim√©trica y asim√©trica: ¬øcu√°l es la diferencia?</a></li>
<li><a href="../es503830/index.html">Amazon ha abierto un gran refugio para personas sin hogar.</a></li>
<li><a href="../es503832/index.html">Recetas PostgreSQL: motor de plantillas de bigote</a></li>
<li><a href="../es503836/index.html">Pros y contras de las tecnolog√≠as de moderaci√≥n de comentarios (+ Encuesta)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>