<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ä ‚òòÔ∏è üê∂ How I designed blocks and transactions on my Go blockchain ü¶Ö üë∑üèº üë∂üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order to ultimately produce a blockchain, and not just a database, we need to add 3 important elements to our project: 
 
 

- Description of data ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How I designed blocks and transactions on my Go blockchain</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499930/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to ultimately produce a blockchain, and not just a database, we need to add 3 important elements to our project: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Description of data structure and block methods</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Description of data structure and transaction methods</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Blockchain functions that save blocks in the database and find them there by their hash or height (or something else).</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/633/90e/12c/63390e12c9217c81913a097b1474cee7.jpg" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the second article about blockchain for industry, the first </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remembering the questions that readers asked me in the previous article of this series, it should be noted: in this case, the LevelDB database is used to store blockchain data, but it doesn‚Äôt interfere with using any other, say the same MySQL. And now we will understand the structure of this data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the transactions: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Rusldv/bcstartup/blob/master/transaction/builder.go</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Here is its data structure:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> TX <span class="hljs-keyword">struct</span> {<font></font>
	DataType <span class="hljs-keyword">byte</span>		
	TxHash <span class="hljs-keyword">string</span> 
	TxType <span class="hljs-keyword">byte</span>	
	Timestamp <span class="hljs-keyword">int64</span>		<font></font>
	INs []TxIn<font></font>
	OUTs []TxOut<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> TxIn <span class="hljs-keyword">struct</span> {<font></font>
	ThatTxHash <span class="hljs-keyword">string</span>
	TxOutN <span class="hljs-keyword">int</span>
	ByteCode <span class="hljs-keyword">string</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> TxOut <span class="hljs-keyword">struct</span> {<font></font>
	Value <span class="hljs-keyword">int</span>
	ByteCode <span class="hljs-keyword">string</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TX stores the data type (for transaction 2), the hash of this transaction, the type of transaction itself, the timestamp, and also the inputs and outputs. The TxIn inputs store the hash of the transaction to which the output is referenced, the number of this output and the bytecode, and the TxOut outputs store some value and also the bytecode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what actions a transaction can perform on its data, i.e. let's analyze the methods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create a transaction, use the transaction.NewTransaction (txtype byte) * TX function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The AddTxIn method (thattxhash [] byte, txoutn int, code [] byte) (* TxIn, error) adds the input to the transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The AddTxOut (value int, data [] byte) (* TxOut, error) method adds output to the transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ToBytes () [] byte method turns a transaction into a byte slice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The internal function preByteHash (bytes [] byte) string is used in Build () and Check () for compatibility of the created transaction hash with transaction hashes generated from JavaScript applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Build () method sets the transaction hash as follows: tx.TxHash = preByteHash (tx.ToBytes ()). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ToJSON () method of a string converts a transaction into a JSON string. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The FromJSON (data [] byte) error method loads a transaction from the JSON format transmitted as a byte slice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Check () bool method compares the received hash from the hash field of the transaction with the hash obtained as a result of hashing this transaction (excluding the hash field). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transactions are added to the block: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Rusldv/bcstartup/blob/master/block/builder.go</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The data structure of the block is more voluminous:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Block <span class="hljs-keyword">struct</span> {<font></font>
	DataType <span class="hljs-keyword">byte</span>				
	BlockHeight <span class="hljs-keyword">int</span>					
        Timestamp <span class="hljs-keyword">int64</span>				 
        HeaderSize <span class="hljs-keyword">int</span>					
        PrevBlockHash <span class="hljs-keyword">string</span>				 
        SelfBlockHash <span class="hljs-keyword">string</span>			
	TxsHash <span class="hljs-keyword">string</span>			
	MerkleRoot <span class="hljs-keyword">string</span>
	CreatorPublicKey <span class="hljs-keyword">string</span>			
	CreatorSig <span class="hljs-keyword">string</span>
	Version <span class="hljs-keyword">int</span>
	TxsN <span class="hljs-keyword">int</span><font></font>
	Txs []transaction.TX<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DataType stores a data type, a node on it, and detaches the block from a transaction or other data. For a block, this value is 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BlockHeight stores the height of the block. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Timestamp timestamp. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HeaderSize block size in bytes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PrevBlockHash hash of the previous block, and SelfBlockHash - the current. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TxsHash is a common transaction hash. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MerkleRoot - The root of the Merkle tree. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next in the fields is the public key of the creator of the block, the signature of the creator, the version of the block, the number of transactions in the block, and these transactions themselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider its methods:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The block.NewBlock () function is used to create a block: NewBlock (prevBlockHash string, height int) * Block, which accepts the hash of the previous block and the height set for the created block in the blockchain. The block type from the constant of the types package is also set:</font></font><pre><code class="go hljs">b.DataType = types.BLOCK_TYPE.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The AddTx method (tx * transaction.TX) adds a transaction to the block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Build () method loads the values ‚Äã‚Äãinto the fields of the block and generates and sets its current hash. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ToBytesHeader () [] byte method translates the block header (without transactions) into a byte slice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ToJSON () method of the string translates the block into JSON format in the string representation of the data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The FromJSON (data [] byte) error method loads data from JSON into the block structure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Check () bool method generates a block hash and compares it with the one specified in the block hash field. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetTxsHash () string method returns the common hash of all transactions in the block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetMerkleRoot () method sets the root of the Merkle tree for transactions in the block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Sign (privk string) method signs the block with the private key of the block creator.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SetHeight (height int) method writes the block height to the block structure field. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetHeight () int method returns the height of the block as indicated in the corresponding field of the block structure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ToGOBBytes () [] byte method encodes the block in the GOB format and returns it as a byte slice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The FromGOBBytes (data [] byte) error method writes block data to the block structure from the transmitted byte slice in GOB format. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetHash () method string returns the hash of this block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetPrevHash () method string returns the hash of the previous block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SetPublicKey (pubk string) method writes the public key of the block creator to the block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, using the methods of the Block object, we can easily convert it to a format for transmission over the network and saving it to the LevelDB database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The blockchain package functions are responsible for saving to the blockchain: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Rusldv/bcstartup/tree/master/blockchain</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For this, the block must implement the IBlock interface:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> IGOBBytes <span class="hljs-keyword">interface</span> {<font></font>
	ToGOBBytes() []<span class="hljs-keyword">byte</span>
	FromGOBBytes(data []<span class="hljs-keyword">byte</span>) error<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> IBlock <span class="hljs-keyword">interface</span> {<font></font>
	IGOBBytes<font></font>
	GetHash() <span class="hljs-keyword">string</span>
	GetPrevHash() <span class="hljs-keyword">string</span>
	GetHeight() <span class="hljs-keyword">int</span>
	Check() <span class="hljs-keyword">bool</span><font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A database connection is created once during initialization of the package in the init () function: </font></font><br>
<pre><code class="go hljs">db, err = leveldb.OpenFile(BLOCKCHAIN_DB_DEBUG, <span class="hljs-literal">nil</span>).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CloseDB () is a wrapper for db.Cloce () - called after working with the package functions to close the database connection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SetTargetBlockHash (hash string) error function writes the hash of the current block with the key specified by the BLOCK_HASH constant in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetTargetBlockHash () (string, error) function returns the hash of the current block stored in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SetTargetBlockHeight (height int) error function writes to the database the value of the blockchain height for the node with the key specified by the BLOCK_HEIGHT constant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetTargetBlockHeight () (int, error) function returns the blockchain height for a given node stored in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The CheckBlock (block IBlock) bool function checks the block for correctness before adding this block to the blockchain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The AddBlock (block IBlock) error function adds a block to the blockchain.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The functions for receiving and viewing blocks are located in the explore.go file of the blockchain package: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GetBlockByHash (hash string) (* block.Block, error) function creates an empty block object, loads a block from the database whose hash is passed to it and returns a pointer to it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The genesis block is created by the Genesis () error function from the genesis.go file of the blockchain package. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next article, we will talk about connecting to a client node using the WebSocket mechanism.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499910/index.html">Balance in decision making. Fork "random experience"</a></li>
<li><a href="../en499920/index.html">SSH Little Tricks</a></li>
<li><a href="../en499922/index.html">Finally we deal with the Modbus baud rate</a></li>
<li><a href="../en499926/index.html">April 30th Java Digest</a></li>
<li><a href="../en499928/index.html">Udalenka: what changed with COVID-19 and who is now even better than before</a></li>
<li><a href="../en499934/index.html">Whip effect and beer game: modeling and supply chain management</a></li>
<li><a href="../en499936/index.html">The main reason why Linux</a></li>
<li><a href="../en499944/index.html">Google Style Guide in C ++. Part 10</a></li>
<li><a href="../en499950/index.html">A lot of free RAM, NVMe Intel P4500 and everything slows down - the story of the unsuccessful addition of the swap partition</a></li>
<li><a href="../en499954/index.html">Storacle - decentralized file storage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>