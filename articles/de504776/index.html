<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧘🏿 📣 🏟️ Schreiben Sie eine Spiel-Engine in Ihrem ersten Jahr: einfach! (Fast) 📁 🖐️ 🧓🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! Mein Name ist Gleb Maryin, ich bin in meinem ersten Studienjahr "Angewandte Mathematik und Informatik" an der HSE in St. Petersburg. Im zweiten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Schreiben Sie eine Spiel-Engine in Ihrem ersten Jahr: einfach! (Fast)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/hsespb/blog/504776/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo! </font><font style="vertical-align: inherit;">Mein Name ist Gleb Maryin, ich bin in meinem ersten Studienjahr "Angewandte Mathematik und Informatik" an der HSE in St. Petersburg. </font><font style="vertical-align: inherit;">Im zweiten Semester machen alle Studienanfänger in unserem Programm Teamprojekte in C ++. </font><font style="vertical-align: inherit;">Meine Teamkollegen und ich haben beschlossen, eine Spiel-Engine zu schreiben.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie, was wir unter die Katze bekommen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind zu dritt im Team: ich, Alexei Luchinin und Ilya Onofriychuk. </font><font style="vertical-align: inherit;">Keiner von uns ist Experte für Spieleentwicklung, geschweige denn für die Erstellung von Spiel-Engines. </font><font style="vertical-align: inherit;">Dies ist das erste große Projekt für uns: Vorher haben wir nur Hausaufgaben und Laborarbeiten gemacht, daher ist es unwahrscheinlich, dass Fachleute auf dem Gebiet der Computergrafik hier neue Informationen für sich finden. </font><font style="vertical-align: inherit;">Wir freuen uns, wenn unsere Ideen denen helfen, die auch ihren eigenen Motor entwickeln wollen. </font><font style="vertical-align: inherit;">Dieses Thema ist jedoch komplex und vielfältig, und der Artikel erhebt in keiner Weise Anspruch auf vollständige Fachliteratur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle anderen, die mehr über unsere Implementierung erfahren möchten - viel Spaß beim Lesen!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafik</font></font></h1><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstes Fenster, Maus und Tastatur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Fenster zu erstellen, Maus- und Tastatureingaben zu verarbeiten, haben wir die SDL2-Bibliothek ausgewählt. </font><font style="vertical-align: inherit;">Es war eine zufällige Wahl, aber bisher haben wir es nicht bereut.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der ersten Phase war es wichtig, einen praktischen Wrapper über die Bibliothek zu schreiben, damit Sie ein Fenster mit ein paar Zeilen erstellen, Manipulationen damit vornehmen können, z. B. den Cursor bewegen und in den Vollbildmodus wechseln und Ereignisse behandeln können: Tastenanschläge, Cursorbewegungen. </font><font style="vertical-align: inherit;">Die Aufgabe war nicht schwierig: Wir haben schnell ein Programm erstellt, mit dem ein Fenster geschlossen und geöffnet werden kann. Wenn Sie auf RMB klicken, wird „Hallo Welt!“ Angezeigt.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann erschien der Hauptspielzyklus:</font></font><br>
<br>
<pre><code class="cpp hljs">Event ev;
<span class="hljs-keyword">bool</span> running = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">while</span> (running):<font></font>
	ev = pullEvent();<font></font>
	<span class="hljs-keyword">for</span> handler in handlers[ev.type]:<font></font>
		handler.handleEvent(ev);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Event-Handler ist angehängt - </font></font><code>handlers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z </font></font><code>handlers[QUIT] = {QuitHandler()}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ihre Aufgabe ist es, das entsprechende Ereignis zu behandeln. </font></font><code>QuitHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Beispiel wird es freigelegt </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wodurch das Spiel gestoppt wird.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Welt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Zeichnen des Motors verwenden wir </font></font><code>OpenGL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das erste war </font></font><code>Hello World</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wie ich glaube, in vielen Projekten ein weißes Quadrat auf schwarzem Hintergrund:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">glBegin(GL_QUADS);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glEnd();</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/612/ed8/fbe/612ed8fbe433abd35b12b59e72aac0c7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann lernten wir, wie man ein zweidimensionales Polygon zeichnet, und führten die Figuren in einer separaten Klasse aus </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die sich drehen </font></font><code>glRotate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bewegen </font></font><code>glTranslate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und dehnen kann </font></font><code>glScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir stellen die Farbe in vier Kanälen mit ein </font></font><code>glColor4f(r, g, b, a)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dieser Funktion können Sie bereits einen schönen Brunnen aus Quadraten erstellen. </font><font style="vertical-align: inherit;">Erstellen Sie eine Klasse </font></font><code>ParticleSystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Array von Objekten. </font><font style="vertical-align: inherit;">Bei jeder Iteration der Hauptschleife aktualisiert das Partikelsystem die alten Quadrate und sammelt einige neue, die in zufälliger Richtung beginnen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kamera</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der nächste Schritt bestand darin, eine Kamera zu schreiben, die sich bewegen und in verschiedene Richtungen schauen konnte. </font><font style="vertical-align: inherit;">Um zu verstehen, wie dieses Problem gelöst werden kann, benötigen wir Kenntnisse aus der linearen Algebra. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn dies für Sie nicht sehr interessant ist, können Sie den Abschnitt überspringen, das GIF anzeigen und weiterlesen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir möchten einen Scheitelpunkt in den Koordinaten des Bildschirms zeichnen und dessen Koordinaten relativ zur Mitte des Objekts kennen, zu dem er gehört.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zuerst müssen wir seine Koordinaten relativ zum Zentrum der Welt finden, in dem sich das Objekt befindet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie dann die Koordinaten und den Standort der Kamera kennen, finden Sie die Position des Scheitelpunkts in der Basis der Kamera.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projizieren Sie dann den Scheitelpunkt auf die Ebene des Bildschirms.&nbsp;</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen können, gibt es drei Stufen. </font><font style="vertical-align: inherit;">Die Multiplikation mit drei Matrizen entspricht ihnen. </font><font style="vertical-align: inherit;">Wir nannten diese Matrizen </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir damit, die Koordinaten des Objekts auf der Basis der Welt zu erhalten. </font><font style="vertical-align: inherit;">Mit einem Objekt können drei Transformationen durchgeführt werden: Skalieren, Drehen und Verschieben. </font><font style="vertical-align: inherit;">Alle diese Operationen werden durch Multiplizieren des ursprünglichen Vektors (Koordinaten in der Basis des Objekts) mit den entsprechenden Matrizen spezifiziert. </font><font style="vertical-align: inherit;">Dann </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sieht </font><font style="vertical-align: inherit;">die Matrix folgendermaßen </font><font style="vertical-align: inherit;">aus:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">Model = Translate * Scale * Rotate. 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir die Position der Kamera kennen, möchten wir die Koordinaten in ihrer Basis bestimmen: Multiplizieren Sie die zuvor erhaltenen Koordinaten mit der Matrix </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In C ++ wird dies bequem mit der Funktion berechnet:</font></font><br>
<br>
<pre><code class="cpp hljs">
glm::mat4 View = glm::lookAt(cameraPosition, objectPosition, up);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wörtlich: Betrachten Sie </font></font><code>objectPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von einer Position aus </font></font><code>cameraPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und die Aufwärtsrichtung ist "oben". Warum ist diese Richtung notwendig? Stellen Sie sich vor, Sie fotografieren eine Teekanne. Sie richten die Kamera auf ihn und stellen den Wasserkocher in den Rahmen. An dieser Stelle können Sie genau sagen, wo sich der Rahmen oben befindet (höchstwahrscheinlich dort, wo der Wasserkocher einen Deckel hat). Das Programm kann für uns nicht herausfinden, wie der Frame angeordnet werden soll, und deshalb muss der Vektor „up“ angegeben werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben die Koordinaten in der Basis der Kamera, es bleibt, die erhaltenen Koordinaten auf die Ebene der Kamera zu projizieren. Die Matrix beschäftigt sich damit </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, was den Effekt erzeugt, das Objekt zu reduzieren, wenn es von uns entfernt wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Koordinaten des Scheitelpunkts auf dem Bildschirm zu erhalten, müssen Sie den Vektor mindestens fünfmal mit der Matrix multiplizieren. </font><font style="vertical-align: inherit;">Alle Matrizen sind 4 mal 4 groß, so dass einige Multiplikationsoperationen durchgeführt werden müssen. </font><font style="vertical-align: inherit;">Wir möchten keine Prozessorkerne mit vielen einfachen Aufgaben laden. </font><font style="vertical-align: inherit;">Hierfür ist eine Grafikkarte mit den erforderlichen Ressourcen besser. </font><font style="vertical-align: inherit;">Sie müssen also einen Shader schreiben: eine kleine Anweisung für eine Grafikkarte. </font><font style="vertical-align: inherit;">OpenGL verfügt über eine spezielle GLSL-Shader-Sprache, ähnlich wie C, die uns dabei hilft. </font><font style="vertical-align: inherit;">Gehen wir nicht auf die Details des Schreibens eines Shaders ein, sondern schauen uns endlich an, was passiert ist:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/9f3/3cd/6c09f33cd1fb76ea4446b1c4a79f056a.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erläuterung: Es gibt zehn Quadrate, die nicht weit voneinander entfernt sind. </font><font style="vertical-align: inherit;">Auf der rechten Seite befindet sich ein Spieler, der die Kamera dreht und bewegt.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physik</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist ein Spiel ohne Physik? Um die physische Interaktion zu handhaben, haben wir uns für die Box2d-Bibliothek entschieden und eine Klasse erstellt </font></font><code>WorldObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, von der geerbt wurde </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Leider hat Box2d nicht sofort funktioniert, daher hat der tapfere Ilya einen Wrapper für b2Body und alle physischen Verbindungen in dieser Bibliothek geschrieben.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fa/68a/807/1fa68a80750c650cb3d3f947a6f58d54.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bis zu diesem Moment haben wir uns überlegt, die Grafiken in der Engine absolut zweidimensional zu gestalten. Wenn wir uns für die Beleuchtung entscheiden, verwenden wir die Raycasting-Technik. </font><font style="vertical-align: inherit;">Aber wir hatten eine wundervolle Kamera zur Hand, die Objekte in allen drei Dimensionen anzeigen kann. </font><font style="vertical-align: inherit;">Deshalb haben wir allen zweidimensionalen Objekten Dicke hinzugefügt - warum nicht? </font><font style="vertical-align: inherit;">Darüber hinaus können Sie in Zukunft eine sehr schöne Beleuchtung erstellen, die Schatten von dicken Objekten hinterlässt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zwischen den Fällen erschien eine Beleuchtung. </font><font style="vertical-align: inherit;">Um es zu erstellen, mussten die entsprechenden Anweisungen zum Zeichnen jedes Pixels geschrieben werden - ein Fragment-Shader.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/faf/f88/460faff88bbc07d7b466c0c9d7a12f4b.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Texturen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Herunterladen der Bilder haben wir die DevIL-Bibliothek verwendet. </font><font style="vertical-align: inherit;">Jedes </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde zu einer Instanz der Klasse </font></font><code>GraphicalPolygon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- dem vorderen Teil des Objekts - und dem </font></font><code>GraphicalEdge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seitenteil. </font><font style="vertical-align: inherit;">Auf jedem können Sie Ihre Textur dehnen. </font><font style="vertical-align: inherit;">Erstes Ergebnis:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8db/847/a6f/8db847a6fddf768afc0cd175a7368b98.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles, was für die Grafik erforderlich ist, ist fertig: Zeichnen, eine Lichtquelle und Textur. </font><font style="vertical-align: inherit;">Grafik - das wars erstmal.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zustandsmaschine, die das Verhalten von Objekten definiert</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedes Objekt, was auch immer es sein mag - ein Zustand in der Zustandsmaschine, grafisch oder physisch - muss "ticken", dh jede Iteration der Spielschleife wird aktualisiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objekte, die aktualisiert werden können, werden von der von uns erstellten Behavior-Klasse geerbt. Es verfügt über Funktionen </font></font><code>onStart, onActive, onStop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mit denen Sie das Verhalten des Erben beim Start, während des Lebens und am Ende seiner Aktivität überschreiben können. Jetzt müssen wir ein oberstes Objekt erstellen </font></font><code>Activity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, das diese Funktionen von allen Objekten aufruft. Die Schleifenfunktion, die dies tut, ist wie folgt:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>:
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title">onAwake</span><span class="hljs-params">()</span></span>;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;awake = <span class="hljs-literal">true</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (awake):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStart();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;running = <span class="hljs-literal">true</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (running):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onActive();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStop();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;onDestroy();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im </font></font><code>running == true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moment kann jemand eine Funktion aufrufen </font></font><code>pause()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die dies tut </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Wenn jemand anruft </font></font><code>kill()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dann </font></font><code>awake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und </font></font><code>running</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenden sich </font><font style="vertical-align: inherit;">an </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und Aktivität zum Stillstand. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir möchten eine Gruppe von Objekten anhalten, zum Beispiel ein System von Partikeln und Partikeln darin. Im aktuellen Status müssen Sie </font></font><code>onPause</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jedes Objekt </font><font style="vertical-align: inherit;">manuell aufrufen </font><font style="vertical-align: inherit;">, was nicht sehr praktisch ist. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lösung:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jeder </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hat ein Array </font></font><code>subBehaviors</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, das er aktualisieren wird, dh:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onStart</span><span class="hljs-params">()</span> 		<span class="hljs-comment">//     </span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onStart</span><span class="hljs-params">()</span>	<span class="hljs-comment">//       Behavior</span>
<span class="hljs-keyword">void</span> <span class="hljs-title">onActive</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onActive</span><span class="hljs-params">()</span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onActive</span><span class="hljs-params">()</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und so weiter für jede Funktion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber nicht jedes Verhalten kann auf diese Weise eingestellt werden. Wenn zum Beispiel ein Feind auf einer Plattform geht - Feind, dann hat er höchstwahrscheinlich verschiedene Zustände: Er steht - </font></font><code>idle_stay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, er geht auf einer Plattform, ohne uns zu bemerken - </font></font><code>idle_walk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und er kann uns jederzeit bemerken und in einen Angriffszustand übergehen - </font></font><code>attack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ich möchte auch bequem die Bedingungen für den Übergang zwischen Zuständen festlegen, zum Beispiel:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">isTransitionActivated</span><span class="hljs-params">()</span>: 		<span class="hljs-comment">//  idle_walk-&gt;attack</span>
	<span class="hljs-keyword">return</span> <span class="hljs-title">canSee</span><span class="hljs-params">(enemy)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das gewünschte Muster ist eine Zustandsmaschine. </font><font style="vertical-align: inherit;">Wir haben sie auch zur Erbin gemacht </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, da bei jedem Tick geprüft werden muss, ob es an der Zeit ist, den Staat zu wechseln. </font><font style="vertical-align: inherit;">Dies ist nicht nur für Objekte im Spiel nützlich. </font><font style="vertical-align: inherit;">Beispielsweise </font></font><code>Level</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist dies ein Zustand </font></font><code>Level Switcher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und Übergänge in der Steuerung Maschine sind die </font><font style="vertical-align: inherit;">Bedingungen für die </font><font style="vertical-align: inherit;">Ebene im Spiel wechseln. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Staat hat drei Phasen: Er hat begonnen, er tickt, er hat aufgehört. </font><font style="vertical-align: inherit;">Sie können jeder Stufe einige Aktionen hinzufügen, z. B. eine Textur an ein Objekt anhängen, einen Impuls darauf anwenden, die Geschwindigkeit einstellen usw.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhaltung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ich ein Level im Editor erstelle, möchte ich es speichern können, und das Spiel selbst sollte das Level aus den gespeicherten Daten laden können. Daher werden alle Objekte, die gespeichert werden müssen, von der Klasse geerbt </font></font><code>NamedStoredObject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es speichert eine Zeichenfolge mit dem Namen und dem Klassennamen und verfügt über eine Funktion </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mit der Daten zu einem Objekt in eine Zeichenfolge ausgegeben werden.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu speichern, muss es einfach </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für jedes Objekt </font><font style="vertical-align: inherit;">überschrieben </font><font style="vertical-align: inherit;">werden. Loading ist ein Konstruktor aus einer Zeichenfolge, die alle Informationen zum Objekt enthält. Der Download ist abgeschlossen, wenn für jedes Objekt ein solcher Konstruktor erstellt wurde.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich sind das Spiel und der Editor fast dieselbe Klasse, nur im Spiel wird das Level im Lesemodus und im Editor im Aufnahmemodus geladen. Die Engine verwendet die RapidJson-Bibliothek, um Objekte aus JSON zu schreiben und zu lesen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Irgendwann stellte sich vor uns die Frage: Lassen Sie die Grafiken, die Zustandsmaschine und alles andere geschrieben werden. </font><font style="vertical-align: inherit;">Wie kann ein Benutzer damit ein Spiel schreiben?&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Originalversion musste er </font><font style="vertical-align: inherit;">Objekte in den Feldern der Klasse </font><font style="vertical-align: inherit;">erben, </font></font><code>Game2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überschreiben </font></font><code>onActive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und erstellen. </font><font style="vertical-align: inherit;">Aber während der Erstellung kann er nicht sehen, was er erstellt, und er müsste auch sein Programm kompilieren und auf unsere Bibliothek verlinken. </font><font style="vertical-align: inherit;">Grusel! </font><font style="vertical-align: inherit;">Es würde Pluspunkte geben - man könnte nach so komplexen Verhaltensweisen fragen, die man sich hätte vorstellen können: Bewegen Sie beispielsweise den Landblock so weit wie das Leben des Spielers, vorausgesetzt, Uranus befindet sich im Sternbild Stier und der Euro überschreitet nicht 40 Rubel. </font><font style="vertical-align: inherit;">Wir haben uns dennoch für eine grafische Oberfläche entschieden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der grafischen Oberfläche ist die Anzahl der Aktionen, die mit einem Objekt ausgeführt werden können, begrenzt: Blättern Sie durch die Animationsfolie, üben Sie Kraft aus, stellen Sie eine bestimmte Geschwindigkeit ein usw. Die gleiche Situation mit Übergängen in der Zustandsmaschine. In großen Engines wird das Problem einer begrenzten Anzahl von Aktionen gelöst, indem das aktuelle Programm mit einem anderen verknüpft wird. Beispielsweise verwenden Unity und Godot die Bindung mit C #. Bereits mit diesem Skript können Sie alles tun: und sehen, in welcher Konstellation Uranus und wie hoch der aktuelle Euro-Wechselkurs ist. Wir haben derzeit keine solche Funktionalität, aber wir planen, die Engine mit Python 3 zu verbinden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die grafische Oberfläche zu implementieren, haben wir uns für Dear ImGui entschieden, da es sehr klein ist (im Vergleich zum bekannten Qt) und das Schreiben sehr einfach ist. </font><font style="vertical-align: inherit;">ImGui - das Paradigma zur Erstellung einer grafischen Oberfläche. </font><font style="vertical-align: inherit;">Darin werden bei jeder Iteration der Hauptschleife alle Widgets und Fenster nur bei Bedarf neu gezeichnet. </font><font style="vertical-align: inherit;">Dies reduziert einerseits den Speicherbedarf, andererseits dauert es höchstwahrscheinlich länger als eine Ausführung der komplexen Funktion zum Erstellen und Speichern der erforderlichen Informationen für das nachfolgende Zeichnen. </font><font style="vertical-align: inherit;">Es bleiben nur die Schnittstellen zum Erstellen und Bearbeiten zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die grafische Oberfläche zum Zeitpunkt der Veröffentlichung aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09a/e87/f8e/09ae87f8eea964d382f07b411991d6d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Level-Editor</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93b/b2e/1bd/93bb2e1bd41ab656341a78fd3dd04102.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zustandsmaschinen-Editor</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben nur die Basis geschaffen, auf der Sie etwas Interessanteres aufhängen können. Mit anderen Worten, es gibt Raum für Wachstum: Sie können Schattenrendering implementieren, mehr als eine Lichtquelle erstellen und die Engine mit dem Python 3-Interpreter verbinden, um Skripte für das Spiel zu schreiben. Ich möchte die Benutzeroberfläche verfeinern: schöner machen, mehr verschiedene Objekte hinzufügen, Hotkeys unterstützen ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt noch viel Arbeit, aber wir sind zufrieden mit dem, was wir im Moment haben.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während der Erstellung des Projekts haben wir viele verschiedene Erfahrungen gesammelt: Arbeiten mit Grafiken, Erstellen grafischer Oberflächen, Arbeiten mit JSON-Dateien, Wrapper zahlreicher C-Bibliotheken. Und auch die Erfahrung, das erste große Projekt in einem Team zu schreiben. Wir hoffen, dass wir darüber ebenso interessant erzählen konnten, wie es interessant war, damit umzugehen :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Link zum Gihab-Projekt: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Glebanister/ample</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504766/index.html">Wie wir das metallurgische Werk in Asha besuchten</a></li>
<li><a href="../de504768/index.html">Analystenpraktikum in Yandex: Analyse von Testaufgaben</a></li>
<li><a href="../de504770/index.html">Linux-Gaming-Distributionen</a></li>
<li><a href="../de504772/index.html">Digitale Veranstaltungen in Moskau vom 1. bis 7. Juni</a></li>
<li><a href="../de504774/index.html">Befragung von IT-Führungskräften zu sich ändernden Anforderungen an IT-Services</a></li>
<li><a href="../de504780/index.html">NSA, Ghidra und Einhörner</a></li>
<li><a href="../de504784/index.html">Das AddTrust-Stammzertifikat von Sectigo lief am 30. Mai 2020 ab, was zu Problemen bei OpenSSL 1.0.x- und GnuTLS-Clients führte</a></li>
<li><a href="../de504786/index.html">Alles, was Sie über Caching wissen müssen</a></li>
<li><a href="../de504790/index.html">Eine Auswahl von Artikeln zum maschinellen Lernen: Fälle, Leitfäden und Studien für Mai 2020</a></li>
<li><a href="../de504792/index.html">Dienstpension. Wie NSPK seinen Dienstraum vor einem Coronavirus rettete</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>