<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🏫 👨🏽‍🤝‍👨🏼 ⚒️ IRO.Mvc.MvcExceptionHandlerを使用したASP.NET例外の処理 🥃 👩🏽‍💻 👨🏿‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="あなたがcバックエンド開発者なら、多分遅かれ早かれ、例外的な状況を処理するための統一された方法を見つける必要があるでしょう。回答の500コードに満足している場合でも、この記事はメソッドの改善に役立ちますが、何も書き換える必要はありません。
 
 この問題をできるだけエレガントに解決できるASP.NE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IRO.Mvc.MvcExceptionHandlerを使用したASP.NET例外の処理</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469731/"><img src="https://habrastorage.org/webt/qp/uf/w4/qpufw4gxcz0is2ivjqx-uncl2l0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたがcバックエンド開発者なら、多分遅かれ早かれ、例外的な状況を処理するための統一された方法を見つける必要があるでしょう。回答の500コードに満足している場合でも、この記事はメソッドの改善に役立ちますが、何も書き換える必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題をできるだけエレガントに解決できるASP.NETライブラリについて説明します。長い記事を読むのが面倒なので、readmeとライブラリ自体が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにある</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ので、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a><font style="vertical-align: inherit;">に例を示し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 nuget.orgで入手でき、誰にとっても有益な場合にのみ喜んでいます。それでは、コードに移りましょう。まず、代替案を見てみましょう。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に頭に浮かぶのは、例外を処理するDTO（データ転送オブジェクト）を作成し、コントローラーで例外をキャッチすることです（例外である必要はありませんが、nullまたはそのようなものをチェックするだけで可能です）。 DTOにデータを入力し、クライアントに送信します。</font><font style="vertical-align: inherit;">このメソッドのコードは次のようになります。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-comment">//Code with exception.</span><font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JsonResult(
            <span class="hljs-keyword">new</span> ErrorDto<font></font>
            {<font></font>
                IsError = <span class="hljs-literal">true</span>,<font></font>
                Message = ex.Message<font></font>
            });<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のオプションは、これにHTTPステータスコードを使用することです。 </font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-comment">//Code with exception.</span><font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> BadRequest();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
かなり一般的な方法ですが、欠点があります。標準コードの1つを使用して状況の本質を説明するのは難しい場合があります。そのため、同じシステムでも同じコードが異なって解釈される可能性があり、開発者にデバッグするための情報が少なすぎます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、いくつかはこれらの方法の両方を組み合わせて、異なる比率で始めることさえあるかもしれません。 DTOの送信を忘れる場所、コードが送信されない場所、間違ったコードが送信される場所、一般的には間違ったjson設定でシリアル化され、必要なものを返さない場所。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記に直面して、多くは</font><b><font style="vertical-align: inherit;">app.UseExceptionHandler（）;</font></b><font style="vertical-align: inherit;">を使用してこの問題を解決しようとしてい</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それを通して例外を処理することによって。これは良い試みですが、問題を簡単に忘れることはできません。まず、例外としてDTOを選択するという問題に直面します。次に、そのようなハンドラーは、コントローラーから返されたhttpエラーコードを処理できません。例外は発生しませんでした。第三に、このようにしてエラー分類の問題を解決するのは不便です;メッセージ、httpコード、または何かを各例外に添付するために多くのコードを書く必要があります。そして4番目に、デバッグに非常に不便なAspA DeveloperExceptionPageを使用する機会を失います。どういうわけかこの問題を解決したとしても、このプロジェクトのすべての開発者は仕様に厳密に従い、例外に特化したエラー処理を構築し、DTOを返さない必要があります。それ以外の場合、APIのエラーはメソッドごとに異なる場合があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択された例外処理オプション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IRO.Mvc.MvcExceptionHandlerを使用して例外を処理する方法を説明する前に、まず、理想的な例外処理を確認する方法について説明します。</font><font style="vertical-align: inherit;">これを行うには、いくつかの要件を設定します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTOである必要がありますが、httpコードも拒否しません。</font><font style="vertical-align: inherit;">多くのエラーの場合、それらは依然として適切であり、どこでも使用でき、サポートする必要がある古いプロジェクトでも使用できます。また、それらは単純に普遍的です。</font><font style="vertical-align: inherit;">標準のDTOには、IsErrorフィールドが含まれます（これにより、クライアントでエラー処理を汎用的に記述できます）。ErrorKey文字列エラーコードも含まれている必要があります。開発者はこれを見るだけですぐに認識でき、詳細情報を提供します。</font><font style="vertical-align: inherit;">さらに、必要に応じて、このエラーの説明が記載されたページへのリンクを追加できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはすべて製品版です。</font><font style="vertical-align: inherit;">開発モードでは、このDTOはスタックトレースを返し、データ（Cookie、ヘッダー、パラメーター）を要求します。</font><font style="vertical-align: inherit;">先を見ると、記事で説明されているミドルウェアは、生成されたDeveloperExceptionPageへのリンクを返します。これにより、便利な形式で例外トレースを監視できますが、後で詳しく説明します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者は、例外、httpエラーコード、ErrorKeyをバインドできます。</font><font style="vertical-align: inherit;">つまり、コントローラからコード403を送信した場合、開発者が特定のErrorKeyをそれにアタッチすると、DTOが返されます。</font><font style="vertical-align: inherit;">また、その逆の場合、UnauthorizedAccessExceptionが発生すると、httpコードとErrorKeyにバインドされます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ライブラリで使用されるデフォルトの形式です。</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"__IsError"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"ErrorKey"</span>: <span class="hljs-string">"ClientException"</span>,
  <span class="hljs-attr">"InfoUrl"</span>: <span class="hljs-string">"https://iro.com/errors/ClientException"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データがクライアントに送信されるタイプは、絶対に誰でも設定できることをすぐに言っておく必要があります。これはオプションの1つにすぎません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IRO.Mvc.MvcExceptionHandler</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、IRO.Mvc.MvcExceptionHandlerライブラリーを作成して、この問題を自分で解決する方法を示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のミドルウェアと同じように、Startupクラスで例外ハンドラを接続します。</font></font><br>
<br>
<pre><code class="cs hljs">app.UseMvcExceptionHandler((s) =&gt;<font></font>
{<font></font>
    <span class="hljs-comment">//Settings...</span><font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
委任されるデリゲート内で、ミドルウェアを構成する必要があります。</font><font style="vertical-align: inherit;">例外のhttpコードとErrorKeyへのマッピング（バインド）を実行する必要があります。</font><font style="vertical-align: inherit;">以下は、最も簡単なセットアップオプションです。</font></font><br>
<br>
<pre><code class="cs hljs">    s.Mapping((builder) =&gt;<font></font>
    {      <font></font>
        builder.RegisterAllAssignable&lt;Exception&gt;(<font></font>
            httpCode: <span class="hljs-number">500</span>,<font></font>
            errorKeyPrefix: <span class="hljs-string">"Ex_"</span><font></font>
        );        <font></font>
    });<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例外の処理に慣れていない</font><font style="vertical-align: inherit;">
最も</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怠惰な</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">筋金入りの開発者</font><font style="vertical-align: inherit;">に約束したとおり、</font><font style="vertical-align: inherit;">他に何もする必要はありません。</font><font style="vertical-align: inherit;">このコードは、ASP.NETパイプラインのすべての例外をコード500の一般的なDTOにバインドし、例外の名前自体がErrorKeyに書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RegisterAllAssignableメソッドは、指定されたタイプの例外だけでなく、そのすべての子孫も登録することを理解することは価値があります。特定の例外に関する情報のみをクライアントに送信する場合は、ClientExceptionを作成してそれだけをマッピングするのはかなり合理的な決定です。同時に、ClientExceptionに1つのhttpコードを設定し、その後継のSpecialClientExceptionに別のhttpコードを設定すると、ClientException設定を無視して、コードSpecialClientExceptionがすべての子孫に使用されます。これはすべてキャッシュされるため、パフォーマンスの問題はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の例外について、ErrorKeyとhttpコードを微調整して登録できます。</font></font><br>
<br>
<pre><code class="cs hljs">    s.Mapping((builder) =&gt;<font></font>
    {<font></font>
        <span class="hljs-comment">//By exception, custom error key.</span><font></font>
        builder.Register&lt;ArgumentNullException&gt;( <font></font>
            httpCode: <span class="hljs-number">555</span>,<font></font>
            errorKey: <span class="hljs-string">"CustomErrorKey"</span><font></font>
            );<font></font>
        <span class="hljs-comment">//By http code.</span><font></font>
        builder.Register(<font></font>
            httpCode: <span class="hljs-number">403</span>,<font></font>
            errorKey: <span class="hljs-string">"Forbidden"</span><font></font>
            );<font></font>
        <span class="hljs-comment">//By exception, default ErrorKey and http code.</span><font></font>
        builder.Register&lt;NullReferenceException&gt;();<font></font>
<font></font>
        <span class="hljs-comment">//Alternative registration method.</span>
        builder.Register((ErrorInfo) <span class="hljs-keyword">new</span> ErrorInfo()<font></font>
        {<font></font>
            ErrorKey = <span class="hljs-string">"MyError"</span>,<font></font>
            ExceptionType = <span class="hljs-keyword">typeof</span>(NotImplementedException),<font></font>
            HttpCode = <span class="hljs-number">556</span><font></font>
        });  <font></font>
    });<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マッピングに加えて、ミドルウェイトを構成することは価値があります。</font><font style="vertical-align: inherit;">jsonシリアル化設定、サイトのアドレス、エラーの説明ページへのリンク、IsDebugによるミドルウェアの動作モード、未処理の例外の標準httpコードを指定できます。</font></font><br>
<br>
<pre><code class="cs hljs">    s.ErrorDescriptionUrlHandler = <span class="hljs-keyword">new</span> FormattedErrorDescriptionUrlHandler(<span class="hljs-string">"https://iro.com/errors/{0}"</span>);<font></font>
    s.IsDebug = isDebug;<font></font>
    s.DefaultHttpCode = <span class="hljs-number">500</span>;    <font></font>
    s.JsonSerializerSettings.Formatting = Formatting.Indented;<font></font>
    s.Host=<span class="hljs-string">"https://iro.com"</span>;<font></font>
    s.CanBindByHttpCode = <span class="hljs-literal">true</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後のプロパティは、DTOをhttpコードでバインドできるかどうかを示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.Wait（）が原因で内部ログにエラーが記録されたTaskCanceledExceptionなど、内部例外のある状況を処理する方法を指定することもできます。</font><font style="vertical-align: inherit;">たとえば、以下は、そのような例外から内部例外を取り出して、すでにそれらと連携する標準リゾルバーです。</font></font><br>
<br>
<pre><code class="cs hljs">    s.InnerExceptionsResolver = InnerExceptionsResolvers.InspectAggregateException;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シリアル化を微調整する必要がある場合は、FilterAfterDTOメソッドを設定できます。</font><font style="vertical-align: inherit;">標準処理を無効にし、必要に応じてerrorContext.ErrorDTOをシリアル化するには、trueを返します。</font><font style="vertical-align: inherit;">HttpContextとエラー自体へのアクセスがあります。</font></font><br>
<br>
<pre><code class="cs hljs">    s.FilterAfterDTO = <span class="hljs-keyword">async</span> (errorContext) =&gt;<font></font>
    {<font></font>
        <span class="hljs-comment">//Custom error handling. Return true if MvcExceptionHandler must ignore current error,</span>
        <span class="hljs-comment">//because it was handled.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    };<font></font>
</code></pre><br>
<h2>DeveloperExceptionPage     </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定がわかったので、それをすべてデバッグする方法を考えましょう。</font><font style="vertical-align: inherit;">DTO製品では、答えの答えは単純で、すでに上で示しましたが、デバッグモードで同じDTOがどのように見えるかを示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/yo/wf/dayowfdy5xfftmrpeg0czujz8os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、ここにはさらに多くの情報があり、スタックトレースと要求データがあります。</font><font style="vertical-align: inherit;">ただし、DebugUrlフィールドのリンクをたどって、緊張せずにエラーデータを確認する方が便利です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/td/i3/ki/tdi3ki-kc-hr7s6umrlpx3txkci.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能を実装するのはかなり困難でした。</font><font style="vertical-align: inherit;">DeveloperExceptionPageは、サードパーティの開発者による使用を意図したものではありません。</font><font style="vertical-align: inherit;">最初は、別のセッションでブラウザでリンクを開くことができませんでした。コンテンツは再起動後に表示されなくなりました。</font><font style="vertical-align: inherit;">このすべては、このミドルバーのhtml応答をキャッシュすることによってのみ解決できます。</font><font style="vertical-align: inherit;">これで、共有専用サーバーを使用する場合、少なくとも例外リンクをチームメイトに渡すことができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事を読んだ開発者が、自分にとって興味深くて便利なツールを見つけたことを願っています。</font><font style="vertical-align: inherit;">私にとって、この記事の一部は、その開発とそれらに関する記事の有用性のテストです。</font><font style="vertical-align: inherit;">私には、Habrコミュニティに伝えたい、既成のクールなプロジェクトがいくつかあります。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja469709/index.html">Blitz Engine＆Battle Prime：ECSとネットワークコード</a></li>
<li><a href="../ja469717/index.html">光を輝かせて</a></li>
<li><a href="../ja469721/index.html">Dell OptiPlex 7070 Ultra：モニターをモノブロック化するモジュラーコンピューター</a></li>
<li><a href="../ja469723/index.html">Yandex.CloudとPythonのサーバーレス関数でAliceのステートフルスキルを作成する</a></li>
<li><a href="../ja469725/index.html">ヒッチハイカーのための太陽系ガイド</a></li>
<li><a href="../ja469733/index.html">ラジコンカー：初めての購入-シャーシとパワートレイン</a></li>
<li><a href="../ja469735/index.html">任意の正の数からn次の根を計算するアルゴリズム</a></li>
<li><a href="../ja469737/index.html">木製おもちゃ、パート5-1991</a></li>
<li><a href="../ja469739/index.html">木製おもちゃ、パート6-1992</a></li>
<li><a href="../ja469743/index.html">セレスティア：スペースバグアドベンチャー</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>