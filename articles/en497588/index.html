<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï≥Ô∏è üë©‚Äçüè≠ üöë Spring Security - An OAuth2 Authorization Web Application Example Through BitBucket üë©üèæ üë©üèª‚Äçüè≠ üíÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will consider a way to authorize users in web applications on Spring Boot using the OAuth2 protocol using an external authorizatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spring Security - An OAuth2 Authorization Web Application Example Through BitBucket</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497588/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article, we will consider a way to authorize users in web applications on Spring Boot using the OAuth2 protocol using an external authorization server (using the example of Bitbucket).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we want to get</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we are developing a secure web application that has access to user resources on an external server, for example, a continuous integration system, and Bitbucket acts as an external server, and we would not want to store the username and password of the user from the external system. </font><font style="vertical-align: inherit;">That is, we need to authorize the user through Bitbucket in order to access his account and resources, additionally check that he is a user of our application and make it so that the user does not disclose to us his Bitbucket credentials. </font><font style="vertical-align: inherit;">I wonder how to do this - welcome to cat.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 is an authorization protocol that allows you to provide a third party with limited access to a user's protected resources without having to give her (a third party) a username and password. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 defines 4 roles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resource owner </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resource server </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Authorization server </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Client (application) </font></font></li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A resource owner</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a user who uses a client application and allows him access to his account hosted on a resource server. Application access to the account is limited by granted permissions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resource server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hosts secure user accounts. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The authorization server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> authenticates the owner of the resource and issues access tokens. The authorization server can simultaneously be a resource server. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A client application</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an application that wants to access a user‚Äôs account and resources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, the client application is the application that we are developing, and Bitbucket will be both an authorization server and a resource server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 supports four types of authorization: Authorization Code, Implicit, Resource Owner Password Credentials, and Client Credentials. </font><font style="vertical-align: inherit;">We will not consider them all, we are interested in the type of Authorization Code. </font><font style="vertical-align: inherit;">The Authorization Code type is optimized for server applications in which the source code is not publicly available and the Client Secret code can be kept confidential. </font><font style="vertical-align: inherit;">This type works on the basis of redirection, that is, the user will be redirected to the authorization server in order to confirm his identity and allow the application to use his account. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The authorization process through the Authorization Code consists of a sequence of two requests:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Authorization Request </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Access Token Request </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An authorization request is used to confirm the identity of the user, as well as request authorization of our application from the user. </font><font style="vertical-align: inherit;">This request is a GET request with the following parameters:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> response_type - the value must be equal to code </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - value obtained when registering a client with OAuth2 provider </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - URL where the user will be redirected after authorization </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> scope - an optional parameter indicating which access level is requested </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state - randomly generated string to verify the response </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Request example:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://server.example.com/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;state=xyz&amp;redirect_uri=REDIRECT_URI
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the user confirms his identity and allows the application access to his resources, the user agent will be redirected to the callback URL specified during registration of the client with the additional parameter code containing the authorization code and state parameter with the value passed in the request. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Callback example:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://client.example.com/cb?code=AUTH_CODE_HERE&amp;state=xyz
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An access code request is used to exchange the received authorization code for an access code to user resources. </font><font style="vertical-align: inherit;">This request is a POST request with the following parameters:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grant_type - value must be authorization_code </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code - authorization code obtained in the previous step </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - must match the URL specified in the previous step </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - value obtained when registering a client with OAuth2 provider </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_secret - value obtained when registering a client with OAuth2 provider </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Request example:</font></font><br>
<br>
<pre><code class="plaintext hljs">POST https://server.example.com/token<font></font>
    grant_type=authorization_code&amp;<font></font>
    code=AUTH_CODE&amp;<font></font>
    redirect_uri=REDIRECT_URI&amp;<font></font>
    client_id=CLIENT_ID&amp;<font></font>
    client_secret=CLIENT_SECRET<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server response contains the access code and its lifetime:</font></font><br>
<br>
<pre><code class="plaintext hljs">{<font></font>
    "access_token": "2YotnFZFEjr1zCsicMWpAA",<font></font>
    "expires_in": 3600,<font></font>
    "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA"<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This whole process is already automated in Spring Security and we do not need to worry about its implementation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customer registration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we will register our application as a client in Bitbucket to get a key (Key) and an access code (Client Secret). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/gz/ba/sngzbaxdqi0wpbsua7eurx_wcis.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enter the client name and callback URL. </font><font style="vertical-align: inherit;">Then we note what will be available to this client. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/y3/3z/vky33zq59j1qg1nvtwmtwxpwqni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The obtained Key and ClientSecret values ‚Äã‚Äãare stored in application.properties:</font></font><br>
<br>
<pre><code class="plaintext hljs">client_id=ZJsdANfWkJ7jcktw2x<font></font>
client_secret=28uUrJ9m43svbkcnXVNj8qeBjFtd8jaD<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure Spring Security</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, let's set up Spring Security. </font><font style="vertical-align: inherit;">For OAuth2 to work, you must create a ClientRegistration object. </font><font style="vertical-align: inherit;">ClientRegistration stores information about the client registered with the OAuth2 provider. </font><font style="vertical-align: inherit;">Here we need the client_id and client_secret obtained in the previous step. </font><font style="vertical-align: inherit;">Since there can be several such ClientRegistration objects in general, Spring Security uses the ClientRegistrationRepository object to store and access them. </font><font style="vertical-align: inherit;">Let's create it too. </font><font style="vertical-align: inherit;">We also indicate that only an authorized user can call any request and redefine UserService with its implementation.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SecurityConfig.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_id}")</span>
    <span class="hljs-keyword">private</span> String clientId;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_secret}")</span>
    <span class="hljs-keyword">private</span> String clientSecret;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistration <span class="hljs-title">clientRegistration</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> ClientRegistration<font></font>
                .withRegistrationId(<span class="hljs-string">"bitbucket"</span>)<font></font>
                .clientId(clientId)<font></font>
                .clientSecret(clientSecret)<font></font>
                .userNameAttributeName(<span class="hljs-string">"username"</span>)<font></font>
                .clientAuthenticationMethod(BASIC)<font></font>
                .authorizationGrantType(AUTHORIZATION_CODE)<font></font>
                .userInfoUri(<span class="hljs-string">"https://api.bitbucket.org/2.0/user"</span>)<font></font>
                .tokenUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/access_token"</span>)<font></font>
                .authorizationUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/authorize"</span>)<font></font>
                .redirectUriTemplate(<span class="hljs-string">"{baseUrl}/login/oauth2/code/{registrationId}"</span>)<font></font>
                .build();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> MyOAuth2UserService <span class="hljs-title">oAuth2userService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2UserService(userService);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistrationRepository <span class="hljs-title">clientRegistrationRepository</span><span class="hljs-params">(List&lt;ClientRegistration&gt; registrations)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InMemoryClientRegistrationRepository(registrations);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@EnableWebSecurity</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MyOAuth2UserService userService;<font></font>
<font></font>
        <span class="hljs-meta">@Autowired</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthConfig</span><span class="hljs-params">(MyOAuth2UserService userService)</span> </span>{
            <span class="hljs-keyword">this</span>.userService = userService;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
            http<font></font>
                    .authorizeRequests(authorizeRequests -&gt; authorizeRequests<font></font>
                            .anyRequest().authenticated()<font></font>
                    )<font></font>
                    .oauth2Login(oauth2Login -&gt; oauth2Login<font></font>
                            .userInfoEndpoint(userInfoEndpoint -&gt; userInfoEndpoint.userService(userService))<font></font>
                    );<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customization UserService</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring Security not only fully implements the authorization process, but also provides the ability to customize it. For example, the possibility of customizing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an authorization request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requesting an access code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as well as the possibility of custom post processing of a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">response to an access code request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . After successful authorization, Spring Security uses </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserInfo Endpoint</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to retrieve user attributes from the authorization server. In particular, the OAuth2UserService interface implementation is used for this.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are going to create our own implementation of this service, so that after user authorization on the authorization server, we additionally check whether he is a user of our application, or register it if registration is open to everyone. </font><font style="vertical-align: inherit;">By default, Spring Security uses the implementation of DefaultOAuth2UserService. </font><font style="vertical-align: inherit;">He will form the basis of our implementation.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyOAuth2UserService.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyOAuth2UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OAuth2UserService</span>&lt;<span class="hljs-title">OAuth2UserRequest</span>, <span class="hljs-title">OAuth2User</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_INFO_URI_ERROR_CODE = <span class="hljs-string">"missing_user_info_uri"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String INVALID_USER_INFO_RESPONSE_ERROR_CODE = <span class="hljs-string">"invalid_user_info_response"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE = <span class="hljs-string">"missing_user_name_attribute"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt; PARAMETERIZED_RESPONSE_TYPE = <span class="hljs-keyword">new</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt;() {<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestOperations restOperations;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = <span class="hljs-keyword">new</span> OAuth2UserRequestEntityConverter();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyOAuth2UserService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">this</span>.userService = requireNonNull(userService);
        <span class="hljs-keyword">this</span>.restOperations = createRestTemplate();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2User <span class="hljs-title">loadUser</span><span class="hljs-params">(OAuth2UserRequest userRequest)</span> <span class="hljs-keyword">throws</span> OAuth2AuthenticationException </span>{<font></font>
        checkNotNull(userRequest, <span class="hljs-string">"userRequest cannot be null"</span>);
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri())) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(MISSING_USER_INFO_URI_ERROR_CODE, <span class="hljs-string">"Missing required UserInfo Uri in UserInfoEndpoint for Client Registration: "</span> + userRequest.getClientRegistration().getRegistrationId(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        String registrationId = userRequest.getClientRegistration().getRegistrationId();<font></font>
        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();<font></font>
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userNameAttributeName)) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(<font></font>
                    MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE,<font></font>
                    <span class="hljs-string">"Missing required \"user name\" attribute name in UserInfoEndpoint for Client Registration: "</span> + registrationId, <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        ResponseEntity&lt;Map&lt;String, Object&gt;&gt; response;<font></font>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// OAuth2UserRequestEntityConverter cannot return null values.</span>
            <span class="hljs-comment">//noinspection ConstantConditions</span>
            response = <span class="hljs-keyword">this</span>.restOperations.exchange(requestEntityConverter.convert(userRequest), PARAMETERIZED_RESPONSE_TYPE);<font></font>
        } <span class="hljs-keyword">catch</span> (OAuth2AuthorizationException ex) {<font></font>
            OAuth2Error oauth2Error = ex.getError();<font></font>
            StringBuilder errorDetails = <span class="hljs-keyword">new</span> StringBuilder();<font></font>
            errorDetails.append(<span class="hljs-string">"Error details: ["</span>);<font></font>
            errorDetails.append(<span class="hljs-string">"UserInfo Uri: "</span>).append(<font></font>
                    userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri());<font></font>
            errorDetails.append(<span class="hljs-string">", Error Code: "</span>).append(oauth2Error.getErrorCode());
            <span class="hljs-keyword">if</span> (oauth2Error.getDescription() != <span class="hljs-keyword">null</span>) {<font></font>
                errorDetails.append(<span class="hljs-string">", Error Description: "</span>).append(oauth2Error.getDescription());<font></font>
            }<font></font>
            errorDetails.append(<span class="hljs-string">"]"</span>);<font></font>
            oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + errorDetails.toString(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        } <span class="hljs-keyword">catch</span> (RestClientException ex) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + ex.getMessage(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        }<font></font>
<font></font>
        Map&lt;String, Object&gt; userAttributes = emptyIfNull(response.getBody());<font></font>
<font></font>
        Set&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<font></font>
        authorities.add(<span class="hljs-keyword">new</span> OAuth2UserAuthority(userAttributes));<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (String authority : userRequest.getAccessToken().getScopes()) {<font></font>
            authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"SCOPE_"</span> + authority));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//     ,   </span>
        <span class="hljs-comment">//          ,</span>
        <span class="hljs-comment">//    </span><font></font>
        User user = findOrCreate(userAttributes);<font></font>
        userAttributes.put(MyOAuth2User.ID_ATTR, user.getId());<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2User(userNameAttributeName, userAttributes, authorities);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">findOrCreate</span><span class="hljs-params">(Map&lt;String, Object&gt; userAttributes)</span> </span>{<font></font>
        String login = (String) userAttributes.get(<span class="hljs-string">"username"</span>);<font></font>
        String username = (String) userAttributes.get(<span class="hljs-string">"display_name"</span>);<font></font>
<font></font>
        Optional&lt;User&gt; userOpt = userService.findByLogin(login);<font></font>
        <span class="hljs-keyword">if</span> (!userOpt.isPresent()) {<font></font>
            User user = <span class="hljs-keyword">new</span> User();<font></font>
            user.setLogin(login);<font></font>
            user.setName(username);<font></font>
            <span class="hljs-keyword">return</span> userService.create(user);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> userOpt.get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>{<font></font>
        RestTemplate restTemplate = <span class="hljs-keyword">new</span> RestTemplate();<font></font>
        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> OAuth2ErrorResponseErrorHandler());
        <span class="hljs-keyword">return</span> restTemplate;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test endpoint</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to create an endpoint to test the health of what we just did. </font><font style="vertical-align: inherit;">Our endpoint will consist of just one request, which will welcome the current user.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WelcomeEndpoint.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Path("/")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WelcomeEndpoint</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-meta">@GET</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">welcome</span><span class="hljs-params">()</span> </span>{<font></font>
        User currentUser = getCurrentUser();<font></font>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Welcome, %s! (user id: %s, user login: %s)"</span>,<font></font>
                currentUser.getName(), currentUser.getId(), currentUser.getLogin());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getCurrentUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> userService.findByLogin(getAuthenticatedUser().getName()).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"No user logged in."</span>));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Authentication <span class="hljs-title">getAuthentication</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> MyOAuth2User <span class="hljs-title">getAuthenticatedUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (MyOAuth2User) getAuthentication().getPrincipal();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Health Check</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We launch the application and go to the address </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // localhost: 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and see that we were redirected to the Bitbucket website to confirm our account. </font><font style="vertical-align: inherit;">Enter username and password. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vn/g7/g5/vng7g5ick7pzzako7jzlwafgqeu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to allow our application access to our account and resources. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k0/4g/hr/k04ghrn2luycrilhcghd5gdo-g0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The user's greeting contains both attributes from the authorization server and the user ID in our application.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/ud/tl/reudtl-zj8py7cgal2rroct6nvu.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full source code for this application is on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h3><br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth - Wikipedia</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spring security reference</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The OAuth 2.0 Authorization Framework</font></font></a> </li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497574/index.html">Oncology in the context of the COVID-19 pandemic: how to save maximum lives</a></li>
<li><a href="../en497578/index.html">AMD is committed to gaining a significant share of the market for data centers</a></li>
<li><a href="../en497580/index.html">Hard quarantine is very very bad</a></li>
<li><a href="../en497582/index.html">Habr takes first place in the ranking of digital rights of users</a></li>
<li><a href="../en497584/index.html">Quantified self: how Madrobots brought Picooc smart scales to Russia</a></li>
<li><a href="../en497590/index.html">We deal with the wave function collapse algorithm</a></li>
<li><a href="../en497594/index.html">External data storage: from the time of IBM 1311 to the present day. Part 1</a></li>
<li><a href="../en497596/index.html">Long live PHP</a></li>
<li><a href="../en497602/index.html">Do you consider yourself a signor? Who are you kidding</a></li>
<li><a href="../en497606/index.html">Automatic garden watering system for Home Assistant, ESP8266 and MiFlora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>