<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé® üå•Ô∏è üõ£Ô∏è Kubernetes ConfigMaps: Nuancen zu wissen üë≤ üë¶üèº üéã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hinweis : Dies ist kein vollst√§ndiger Leitfaden, sondern eine Erinnerung / ein Hinweis f√ºr diejenigen, die ConfigMap bereits in Kubernetes verwenden o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: Nuancen zu wissen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Dies ist kein vollst√§ndiger Leitfaden, sondern eine Erinnerung / ein Hinweis f√ºr diejenigen, die ConfigMap bereits in Kubernetes verwenden oder gerade ihre Anwendung f√ºr die Arbeit darin vorbereiten.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund: Von rsync zu ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist vorher passiert? Im Zeitalter der ‚Äûklassischen Administration‚Äú wurde in der einfachsten Version die Konfigurationsdatei direkt neben den Anwendungen (oder, wenn Sie m√∂chten, im Repository) platziert. Es ist ganz einfach: Wir machen eine elementare Lieferung (CD) f√ºr unseren Code zusammen mit der Konfiguration. Sogar eine bedingte rsync-Implementierung kann als die Grundlagen einer CD bezeichnet werden.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als die Infrastruktur wuchs, waren unterschiedliche Konfigurationen f√ºr unterschiedliche Umgebungen erforderlich (Entwickler / B√ºhne / Produktion). Die Anwendung wurde geschult, um zu verstehen, welche Konfiguration verwendet werden soll, und sie als Argumente zum Starten oder als Umgebungsvariablen in der Umgebung √ºbergeben. Noch mehr CDs werden durch das Aufkommen solch n√ºtzlicher K√∂che / Puppen / Ansible kompliziert. Rollen werden auf Servern angezeigt, und Umgebungen werden an verschiedenen Stellen nicht mehr beschrieben - wir kommen zu IaC (Infrastruktur als Code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was folgte? Wenn es m√∂glich war, Kubernetes entscheidende Vorteile f√ºr sich selbst zu erkennen und sich sogar mit der Notwendigkeit abzufinden, Anwendungen so zu √§ndern, dass sie in dieser Umgebung funktionieren, kam es zu einer Migration. Unterwegs erwartete ich viele Nuancen und Unterschiede in der Konstruktion der Architektur, aber als ich den Hauptteil bew√§ltigen konnte, lief die lang erwartete Anwendung in K8s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobald wir hier sind, k√∂nnen wir weiterhin die im Repository neben der Anwendung vorbereiteten Konfigurationen verwenden oder ENV an den Container √ºbergeben. </font><font style="vertical-align: inherit;">Zus√§tzlich zu diesen Methoden sind jedoch auch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verf√ºgbar </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mit diesem K8-Grundelement k√∂nnen Sie Go-Vorlagen in Konfigurationen verwenden, d. H. </font><font style="vertical-align: inherit;">Rendern Sie sie wie HTML-Seiten und laden Sie die Anwendung neu, wenn Sie die Konfiguration ohne Neustart √§ndern. </font><font style="vertical-align: inherit;">Mit ConfigMaps m√ºssen nicht mehr 3+ Konfigurationen f√ºr verschiedene Umgebungen gespeichert und die Relevanz der einzelnen Umgebungen verfolgt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine allgemeine Einf√ºhrung in ConfigMaps finden Sie beispielsweise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In diesem Artikel werde ich mich auf einige Funktionen der Arbeit mit ihnen konzentrieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfache ConfigMaps</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sahen Konfigurationen in Kubernetes aus? </font><font style="vertical-align: inherit;">Was haben sie von den Go-Vorlagen bekommen? </font><font style="vertical-align: inherit;">Hier ist beispielsweise eine normale ConfigMap f√ºr eine Anwendung, die aus einem Helmdiagramm bereitgestellt wird:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier werden die Werte ersetzt </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus der Datei √ºbernommen </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Warum genau von </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Wie funktioniert die Go Template Engine? </font><font style="vertical-align: inherit;">Wir haben bereits √ºber diese Details genauer gesprochen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Anruf </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hilft bei der Auswahl der erforderlichen Linie aus der Karte:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus k√∂nnen Sie sowohl bestimmte Zeilen als auch ganze Fragmente der Konfiguration verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigMap k√∂nnte beispielsweise folgenderma√üen aussehen:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... und in </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- den folgenden Inhalten:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geht es um den Namen der Umgebung. </font><font style="vertical-align: inherit;">Wenn Sie diesen Wert w√§hrend der Bereitstellung ersetzen, k√∂nnen Sie ConfigMaps mit unterschiedlichen Inhalten rendern. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier gebraucht, weil </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gibt eine Liste zur√ºck, deren erstes Element den gew√ºnschten Wert enth√§lt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn es viele Konfigurationen gibt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine ConfigMap kann mehrere Konfigurationsdateien enthalten:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen sogar jede Konfiguration separat bereitstellen:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... oder alle Konfigurationen auf einmal mit dem Verzeichnis abholen:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie die Beschreibung der Bereitstellungsressource w√§hrend der Bereitstellung √§ndern, erstellt Kubernetes ein neues ReplicaSet, verringert das alte auf 0 und erh√∂ht das neue auf die angegebene Anzahl von Replikaten. </font><font style="vertical-align: inherit;">(Dies gilt f√ºr die Bereitstellungsstrategie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solche Aktionen f√ºhren zur Neuerstellung des Pods mit einer neuen Beschreibung. </font><font style="vertical-align: inherit;">Zum Beispiel: Es gab ein Bild </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wurde aber - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dabei spielt es keine Rolle, was genau wir in der Beschreibung unserer Bereitstellung ge√§ndert haben: Hauptsache, dies hat dazu gef√ºhrt, dass das replicaSet (und damit der Pod) neu erstellt wurde. </font><font style="vertical-align: inherit;">In diesem Fall wird die neue Version der Konfigurationsdatei in der neuen Version der Anwendung automatisch bereitgestellt, und es tritt kein Problem auf.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap-√Ñnderungsantwort</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei √Ñnderungen in ConfigMap k√∂nnen vier Ereignisszenarien folgen. </font><font style="vertical-align: inherit;">Betrachten Sie sie:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap‚Äô,   Deployment,   pod  ,   ‚Äî        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod‚Äô   / pod‚Äô.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden genauer analysieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Szenario 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ConfigMap korrigiert? </font><font style="vertical-align: inherit;">Die Anwendung wird nicht neu gestartet. </font><font style="vertical-align: inherit;">Bei der Montage durch </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werden keine √Ñnderungen vorgenommen, bis der Pod manuell neu gestartet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles ist einfach: Kubernetes stellt unsere ConfigMap in einem Pod einer bestimmten Version der Ressource bereit. </font><font style="vertical-align: inherit;">Da es mit gemountet ist </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wird kein zus√§tzlicher "Einfluss" auf die Konfiguration mehr bereitgestellt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Szenario 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen die Datei nicht aktualisieren, ohne den Pod neu zu erstellen? </font><font style="vertical-align: inherit;">Okay, wir haben 6 Replikate in Deployment, sodass wir abwechselnd alles manuell erledigen k√∂nnen </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn sie dann neue Pods erstellen, werden sie die neue Version von ConfigMap "abholen".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Szenario 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sind Sie es leid, solche Vorg√§nge manuell auszuf√ºhren? </font><font style="vertical-align: inherit;">Eine L√∂sung f√ºr dieses Problem finden Sie in den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipps und Tricks zu Helm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher wird der </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hash der gerenderten Annotationskonfiguration einfach </font><font style="vertical-align: inherit;">in die pod ( </font><font style="vertical-align: inherit;">) - </font><font style="vertical-align: inherit;">Vorlage geschrieben </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anmerkungen sind beliebige Schl√ºsselwertfelder, in denen Sie Ihre Werte speichern k√∂nnen. </font><font style="vertical-align: inherit;">Wenn Sie sie in der Vorlage des </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zuk√ºnftigen Pods </font><font style="vertical-align: inherit;">registrieren </font><font style="vertical-align: inherit;">, fallen diese Felder in das ReplicaSet und den Pod selbst. </font><font style="vertical-align: inherit;">Kubernetes wird feststellen, dass sich die Pod-Vorlage ge√§ndert hat (seit sich die sha256-Konfiguration ge√§ndert hat) und startet </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wobei sich au√üer dieser Anmerkung nichts √§ndert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen speichern wir dieselbe Version der Anwendung und Beschreibung der Bereitstellung und l√∂sen im Wesentlichen nur die Neuerstellung des Pods durch den Computer aus - √§hnlich wie bei der manuellen Ausf√ºhrung </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, jedoch bereits ‚Äûkorrekt‚Äú: automatisch und mit </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Szenario 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht wei√ü die Anwendung bereits, wie √Ñnderungen in der Konfiguration √ºberwacht und automatisch neu geladen werden? </font><font style="vertical-align: inherit;">Hier liegt eine wichtige Funktion von ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Konfiguration in Kubernetes </font><font style="vertical-align: inherit;">bereitgestellt </font><font style="vertical-align: inherit;">wird </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wird sie erst aktualisiert, wenn der Pod neu gestartet wird </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(siehe die ersten drei oben beschriebenen Szenarien)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn Sie ConfigMap jedoch als Verzeichnis ohne bereitstellen </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, befindet sich im Container ein Verzeichnis mit einer aktualisierten Konfiguration, ohne den Pod neu zu starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt andere n√ºtzliche Funktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine solche aktualisierte Konfigurationsdatei im Container wird mit einiger Verz√∂gerung aktualisiert. </font><font style="vertical-align: inherit;">Dies liegt daran, dass die Datei nicht genau gemountet wird, sondern das Kubernetes-Objekt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die darin enthaltene Datei ist ein Symlink. </font><font style="vertical-align: inherit;">Beispiel mit </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und was passiert ohne, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn es vom Verzeichnis gemountet wird?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie die Konfiguration (√ºber </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment </font><font style="vertical-align: inherit;">oder </font><font style="vertical-align: inherit;">), warten Sie 2 Minuten (Apiserver-Caching-Zeit) - und voila:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie den ge√§nderten Zeitstempel in dem von Kubernetes erstellten Verzeichnis.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracking √§ndern</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und schlie√ülich - ein einfaches Beispiel daf√ºr, wie Sie √Ñnderungen in der Konfiguration √ºberwachen k√∂nnen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir werden eine solche Go-Anwendung verwenden</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... mit einer solchen Konfiguration hinzuf√ºgen:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ausgef√ºhrt, lautet das Protokoll:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt werden wir diese Anwendung in Kubernetes installieren, nachdem wir die ConfigMap-Konfiguration im Pod anstelle der Datei aus dem Image bereitgestellt haben. </font><font style="vertical-align: inherit;">Auf GitHub wurde ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel f√ºr ein Helm-Diagramm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erstellt </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und √§ndern Sie nur ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie das Helm-Diagramm im Cluster beispielsweise wie folgt:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was wird passieren?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anwendungen v1 und v2 werden nicht neu gestartet, da </font><font style="vertical-align: inherit;">F√ºr sie hat sich in der Bereitstellung nichts ge√§ndert - sie hei√üen Alice immer noch willkommen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die v3-Anwendung wurde neu gestartet, die Konfiguration erneut gelesen und Bob begr√º√üt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die v4-Anwendung wurde nicht neu gestartet. </font><font style="vertical-align: inherit;">Da ConfigMap als Verzeichnis bereitgestellt wird, wurden √Ñnderungen in der Konfiguration festgestellt und die Konfiguration im laufenden Betrieb ge√§ndert, ohne den Pod neu zu starten. </font><font style="vertical-align: inherit;">Ja, die Anwendung hat √Ñnderungen in unserem einfachen Beispiel festgestellt - siehe die Ereignismeldung von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen pr√ºfen , </font><font style="vertical-align: inherit;">wie eine √§hnliche Situation - ConfigMap die √Ñnderungen Tracking - in einem erwachsenen gel√∂st wird (und nur ‚Äûreal‚Äú) Projekt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wichtig! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist auch n√ºtzlich daran zu erinnern, dass all das oben Genannte im Artikel auch f√ºr Secret'ov in Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) gilt: Nicht umsonst sind sie ConfigMap so √§hnlich ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus! </font><font style="vertical-align: inherit;">L√∂sungen von Drittanbietern</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie sich f√ºr das Thema Nachverfolgung von √Ñnderungen in Konfigurationen interessieren, gibt es daf√ºr bereits vorgefertigte Dienstprogramme:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Sendet eine HTTP-Anfrage, wenn sich die Datei ge√§ndert hat. </font><font style="vertical-align: inherit;">Der Entwickler plant auch, SIGHUP das Senden beizubringen, aber das Fehlen von Commits ab Oktober 2019 l√§sst diese Pl√§ne in Frage.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √ºberwacht ConfigMap / Secrets und f√ºhrt ein fortlaufendes Upgrade (wie der Autor es nennt) f√ºr die ihnen zugeordneten Ressourcen durch.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist zweckm√§√üig, solche Anwendungen mit einem Beiwagencontainer f√ºr vorhandene Anwendungen zu starten. </font><font style="vertical-align: inherit;">Wenn Sie jedoch die Funktionen von Kubernetes / ConfigMap kennen und konfigurieren, um nicht "live" (durch </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), sondern nur im Rahmen der </font><font style="vertical-align: inherit;">Bereitstellung zu bearbeiten </font><font style="vertical-align: inherit;">, erscheinen die Funktionen solcher Dienstprogramme m√∂glicherweise √ºberfl√ºssig, d. H. </font><font style="vertical-align: inherit;">Grundfunktionen duplizieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem Aufkommen von ConfigMap in Kubernetes gingen die Konfigurationen in die n√§chste Entwicklungsrunde √ºber: Die Verwendung einer Vorlagen-Engine brachte ihnen Flexibilit√§t, die mit dem Rendern von HTML-Seiten vergleichbar war. </font><font style="vertical-align: inherit;">Gl√ºcklicherweise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ersetzten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solche Komplikationen nicht </font><i><font style="vertical-align: inherit;">die</font></i><font style="vertical-align: inherit;"> bestehenden L√∂sungen, sondern wurden zu ihrer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erg√§nzung</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Daher sind f√ºr Administratoren (oder besser gesagt sogar Entwickler), die neue Funktionen f√ºr √ºberfl√ºssig halten, weiterhin gute alte Dateien verf√ºgbar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr diejenigen, die ConfigMap'ami bereits verwenden oder sich nur ansehen, bietet der Artikel einen kurzen √úberblick √ºber ihre Essenz und Verwendungsnuancen. </font><font style="vertical-align: inherit;">Wenn Sie eigene Tipps und Tricks zum Thema haben, freue ich mich √ºber die Kommentare.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie auch in unserem Blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lokale Dateien beim Portieren einer Anwendung auf Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   Kubernetes  Helm:    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498944/index.html">Telegramm. Hund, oder wie man keine Spiegel macht</a></li>
<li><a href="../de498948/index.html">Zeit f√ºr die Drachen. Selbstisolation mit R√§tseln</a></li>
<li><a href="../de498952/index.html">Wir laden zu DINS JS EVENING ein: Wir sprechen √ºber aspektorientierte Programmierung und das Vuejs 3 Composition API Framework</a></li>
<li><a href="../de498958/index.html">Fehler ist nicht UIAlertController</a></li>
<li><a href="../de498962/index.html">√úber Multitasking: Fenster unter Kontrolle</a></li>
<li><a href="../de498976/index.html">Einf√ºhrung in .NET 5.0 Vorschau 3</a></li>
<li><a href="../de498978/index.html">Verwenden von Graylog und NLog zum Sammeln von Protokollen aus C # -Anwendungen. Pers√∂nliche Erfahrung</a></li>
<li><a href="../de498982/index.html">Disketten f√ºr Dreamcast</a></li>
<li><a href="../de498984/index.html">Stealth School: 5 Arten von Gadgets in Stealth-Spielen</a></li>
<li><a href="../de498988/index.html">Arbeitssuche in √úbersee und Einwanderung nach Kanada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>