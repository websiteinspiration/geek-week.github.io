<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💕 🚒 🔔 Études de cas pour l'utilisation d'outils d'analyse d'anomalies réseau: découverte de campagne DNSpionage ✍🏽 ♎️ 📁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons d'examiner les cas de systèmes d'analyse du trafic réseau (NTA) pour les objectifs de cybersécurité. Aujourd'hui, nous verrons comment...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Études de cas pour l'utilisation d'outils d'analyse d'anomalies réseau: découverte de campagne DNSpionage</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cisco/blog/487850/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous continuons d'examiner les cas de systèmes d'analyse du trafic réseau (NTA) pour les objectifs de cybersécurité. </font><font style="vertical-align: inherit;">Aujourd'hui, nous verrons comment ces solutions peuvent être utilisées pour détecter des campagnes très complexes, ciblées et très efficaces appelées DNSpionage et Sea Turtle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avant cela, je rappellerai brièvement comment fonctionne le DNS (Domain Name System), qui sous-tend l'interaction sur Internet. Le cerveau humain est agencé de telle sorte qu'il est incapable de mémoriser de nombreux nombres et nombres qu'une personne n'associe à rien de familier. Et le nombre de combinaisons mémorables de nombres et de nombres est en tout cas petit. Par conséquent, afin de ne pas mémoriser et stocker dans le carnet des centaines et des milliers d'adresses IP des sites qui nous intéressent, le système DNS a été inventé, qui traduit les adresses symboliques des sites plus compréhensibles par l'homme en leurs adresses IP. Si je dois accéder à un site, j'envoie une requête DNS avec le nom du site au serveur DNS, qui me renvoie son adresse IP, vers laquelle je me rends.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/_h/qa/sd_hqaa3za1u2yk51zof_p6x0yi.png" alt="image"><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous plongez un peu plus dans les détails, le schéma semble plus compliqué. Si le serveur DNS le plus proche de moi ne connaît pas l'adresse IP du site qui m'intéresse, il me dirige vers le serveur racine, qui me dirige ensuite vers le serveur DNS de la zone dans laquelle se trouve le site qui m'intéresse (par exemple, «.ru»), et plus encore le long de la chaîne jusqu'à ce que j'atteigne un serveur DNS qui connaît l'adresse IP dont j'ai besoin.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1u/ev/vz/1uevvz_3p_mvln6p7tn_4z7i828.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'avère que nous faisons confiance aux serveurs DNS qui nous envoient les adresses IP des sites que nous souhaitons visiter. Et si quelqu'un s'introduit dans un serveur DNS et usurpe un enregistrement pour faire correspondre un nom symbolique et une adresse IP? Et si nous sommes dirigés vers un faux site qui ressemble à un vrai et qui peut voler nos identifiants et mots de passe, ainsi que d'autres informations confidentielles à notre sujet? Cette usurpation est appelée redirection DNS et est utilisée par les cybercriminels dans des attaques particulièrement dangereuses.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c8/ye/tb/c8yetbb4kae4bljgha9nrwqscrg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2009, la «Iranian Cyber ​​Army» a ainsi remplacé twitter.com. En 2011, 186 domaines ont été remplacés par des pirates turcs, dont HSBC, Vodafone, Acer, etc. En 2013-2014, l'armée électronique syrienne a remplacé les sites NYT, Twitter et Huffingtin Post (la tentative a échoué contre Facebook). La même année, des actions similaires ont été menées contre WhatsApp, AVG, Avira. Un an plus tard, les sites Google vietnamiens et malaisiens ont été remplacés, ainsi que le domaine de la Banque fédérale de réserve de Saint-Louis. En 2016, une certaine quantité de crypto-monnaie a été volée à blockchain.info de cette manière. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il y a plus de vecteurs d'attaque DNS, mais aujourd'hui, nous ne regarderons que ceux liés aux </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campagnes DNSpionage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sea Turtle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/br/en/4n/bren4nxhs7lc3q-b-9amxefwdlk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que nous avons un aperçu rapide du fonctionnement du DNS et de la façon dont vous pouvez l'utiliser au détriment, nous pouvons passer directement aux campagnes DNSpionage et Sea Turtle, en commençant par la première. En 2018, la division Cisco Talos l'a rencontré dans plusieurs pays du Moyen-Orient. Il comprenait deux parties - l'infection des utilisateurs et la redirection DNS, qui n'étaient pas toujours liées, mais pour un certain nombre de signes, nous avons conclu que le même groupe était très probablement derrière les deux parties.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a4/ke/ct/a4kectwab8uvix5-roevs-xfaly.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier cas, les utilisateurs victimes ont reçu des offres d'emploi via LinkedIn et d'autres sites de recherche d'emploi. Tous les postes vacants ont conduit à de faux sites sur lesquels des postes tentants ont été publiés. Deux sites ont été enregistrés - hr-wipro [.] Com et hr-suncor [.] Com, qui redirigeaient les utilisateurs vers les sites wipro.com et suncor.com légaux. Les liens ont placé des fichiers au format MS Word avec des macros incorporées, chacune fonctionnant respectivement à l'ouverture et à la fermeture du document.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/m5/6o/u1m56oezwvzjqkyxh657_crei8s.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première macro a décodé le fichier PE et l'a enregistré à l'adresse "% UserProfile% \. OracleServices \ svshost_serv.doc". La deuxième macro a été renommée «svshost_serv.doc» en «svshost_serv.exe». Ensuite, la macro a créé la tâche «chromium updater v 37.5.0», qui a exécuté le fichier exécutable et l'a répété toutes les minutes. Ce malware exécutait les fonctions de RAT (outil d'administration à distance), appelé DNSpionage. Il a interagi avec un domaine spécialement créé, demandant / recevant des commandes qu'il a exécutées. Parmi ces commandes, on peut interroger le contenu du répertoire, analyser le réseau, copier des fichiers, utiliser des utilitaires distants (WinSSHD, Putty, mimikatz), etc. Les commandes du serveur de commandes, ainsi que les résultats du travail, ont été envoyés dans l'un des deux modes - HTTP ou DNS. La deuxième option est généralement plus simple, car il y a une forte probabilitéque vous ne disposez pas d'une inspection à part entière du trafic DNS et que vous ne remarquez tout simplement pas le code malveillant DNSpionage communiquant avec le serveur de commandes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chose la plus intéressante commence au moment où les parties client et serveur du malware communiquent. Le client envoie la requête DNS obscurcie suivante à 0ffice36o [.] Com (le premier caractère est zéro et la dernière lettre est «o»): RoyNGBDVIAA0 [.] 0ffice36o [.] Com, où les 4 premiers octets sont générés de manière aléatoire et le reste (GBDVIAA0 ) sont une requête encodée en base32 (pour chaque victime, leur propre alphabet base64 / dase32 a été sélectionné). Le déchiffrer nous donne "0GT \ x00", où GT est l'identifiant de la victime, et \ x00 est le numéro de requête. Le serveur de commandes nous répond sous la forme d'une adresse IP, qui n'est pas toujours correcte, par exemple 0.1.0.3 (le protocole DNS le permet). La deuxième requête DNS ressemble à ceci: t0qIGBDVIAI0 [.] 0ffice36o [.] Com. Le serveur de commandes nous renvoie l'adresse IP: 100.105.114.0, qui est de 4 caractères en encodage ASCII normal,ce qui dans ce cas signifie la commande exécutable "dir \ x00". En réponse, le côté client de DNSpionage envoie:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GLtAGJDVIAJAKZXWY000 0ffice36o com [.] [.] -&gt; GJDVIAJAKZXWY000 -&gt; « 2GT \ x01 Vol» </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TwGHGJDVIATVNVSSA000 0ffice36o com [.] [.] -&gt; GJDVIATVNVSSA000 -&gt; «2GT \ x02 UME» </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1QMUGJDVIA3JNYQGI000 0ffice36o com [.] [.] - &gt; GJDVIA3JNYQGI000 -&gt; "2GT \ x03 en d" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iucCGJDVIBDSNF3GK000 [.] 0ffice36o [.] Com -&gt; GJDVIBDSNF3GK000 -&gt; "2GT \ x04 rive" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
viLxGJDVIBJAIMQGQ36 [0] [Q] [0]] h "</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de la deuxième partie de la campagne DNSpionage, l'administrateur de l'administrateur du serveur DNS a été volé, les enregistrements DNS correspondants ont été modifiés et des certificats ont été créés à l'aide de LetsEncrypt, qui sera utilisé plus tard dans l'attaque «site au milieu». C'est sur un tel site que l'attaque de redirection DNS décrite précédemment enverra des victimes sélectionnées (en seulement 2 ans de cette campagne, nous avons pu identifier 25 redirections, ce qui indique non pas une attaque massive mais ciblée). Veuillez noter que votre propre serveur DNS (si vous en avez un) et les serveurs DNS tiers que vous ne contrôlez pas déjà peuvent être attaqués.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de leurs activités, les assaillants ont pu intercepter tout le trafic qui se dirigeait vers les domaines indiqués des organes gouvernementaux du Liban et des Émirats arabes unis (le ministère des Finances, la police, le ministère des Communications et des Télécommunications, la compagnie aérienne, etc.), y compris le courrier électronique et le VPN, ce qui pourrait leur permettre de recueillir des informations supplémentaires sur leurs victimes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La campagne Cisco Talos Sea Turtle était encore plus compliquée que DNSpionage, car les attaquants ont attaqué non seulement les serveurs DNS, mais aussi les serveurs TLD (y compris les ccTLD et les gTLD), </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dn/cq/d6/dncqd6jglxgcen7krr5h3ha7naw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ce qui a permis à des pirates inconnus d'attaquer des organisations étatiques et militaires au Moyen-Orient et au Nord. Afrique, ainsi que des services spéciaux et des sociétés pétrolières et gazières.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r6/tr/d1/r6trd1zsobqmfdzjk3qiwxrighe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Revenons maintenant à la tâche d'origine et voyez comment les systèmes d'analyse du trafic réseau peuvent aider à identifier les campagnes mentionnées. Il convient de noter tout de suite qu'étant donné leur complexité et le fait qu'ils peuvent être dirigés contre des serveurs DNS externes, les systèmes de classe NTA ne nous aideront pas toujours. Mais dans ces cas, lorsqu'il s'agit du mode de fonctionnement DNS de DNSpionage ou d'une attaque sur des serveurs DNS locaux dans le cadre de DNSpionage ou de Sea Turtle, nous pouvons utiliser Netflow pour voir tous les signes d'une attaque dont nous avons besoin et les bloquer en temps opportun.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous devons définir nos serveurs DNS internes et les ajouter à un groupe. C'est là que commence l'introduction de presque tous les systèmes de surveillance des anomalies. Pour comprendre si nous avons rencontré des anomalies dans le trafic réseau ou non, nous devons d'abord décider ce qui est normal et légitime. Et ce n'est qu'après cela que le système commence à fonctionner pleinement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yz/7j/xf/yz7jxfj_hi5yatj6vn3vtmxk74k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut être fait manuellement, mais il est préférable d'utiliser la fonction de classification des nœuds par type de trafic, qui vous permet d'identifier tous les nœuds, même ceux que nous ne connaissons pas, mais qui fonctionnent comme des serveurs DNS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tc/sn/lk/tcsnlktrq9ufitfyfiiquzxzrgy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, nous avons trouvé 5 serveurs:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8d/lo/vt/8dlovtovjuua5mgq2oclorteeig.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir décidé des serveurs DNS légaux, nous ne pouvons surveiller que tout le trafic DNS, ce qui est anormal, c'est-à-dire au-delà de ce qui est autorisé. Par exemple, voici comment nous pouvons décrire une règle pour identifier les serveurs DNS internes fonctionnant illégalement: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_6/fs/8n/_6fs8neufdjlgvdgp8wii7mzw7w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cette règle ressemblera à ceci, ce qui montre que pour une raison quelconque, nous avons 2 serveurs DNS dans notre réseau, dont l'un est situé dans le segment de serveur confidentiel et le deuxième dans le segment des appareils utilisateur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/oi/d-/nqoid-kfwr9umo4tdeuizttrvsi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La règle suivante nous permet d'identifier les serveurs DNS suspects externes qui interagissent directement avec les hôtes internes, ce qui peut être un signe que le serveur de commandes DNSpionage fonctionne avec des appareils d'entreprise infectés: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rn/aw/65/rnaw654ohhi-lk7reigqaf5v8vw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons des exemples d'une telle interaction:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4h/xe/dp/4hxedpbytb_3jktf7gxmdlz6ade.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la même manière, nous pouvons configurer le système de détection d'anomalies réseau (et cet article utilise Cisco Stealthwatch comme exemple) pour détecter les tentatives non autorisées d'accéder aux nœuds internes au serveur DNS local (cela peut indiquer qu'un DNSpionage ou Sea Turtle fonctionne), ainsi que l'interaction active hôtes internes avec des hôtes externes utilisant le protocole DNS (cela enregistrera le fonctionnement de DNSpionage en mode DNS). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir corrigé les anomalies et les violations de politique de sécurité correspondantes, nous devons développer des règles qui nous permettent de signaler toute tentative future de connecter des nœuds internes, à l'exclusion des serveurs DNS locaux, à des serveurs DNS externes (et vice versa).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/u5/lq/dau5lqybrkndi_vgnx8x1xju49s.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième règle nous permet d'enregistrer toutes les tentatives d'interaction à l'aide du trafic DNS au sein du réseau d'entreprise, à l'exclusion des serveurs DNS locaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rh/cv/ru/rhcvruxhxrjyk0pssluyl8g9gcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est ainsi que la surveillance de Netflow (ainsi que d'autres protocoles de flux) nous permet d'identifier les étapes individuelles d'attaques assez complexes qui peuvent nuire aux entreprises et aux agences gouvernementales modernes.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487836/index.html">Téléchargement interactif de fichiers sur le serveur à l'aide de RxJS</a></li>
<li><a href="../fr487838/index.html">Validation des données: une approche différente</a></li>
<li><a href="../fr487842/index.html">2 SIM pour un routeur de pays - est-ce beaucoup ou peu?</a></li>
<li><a href="../fr487844/index.html">L'odeur révèle</a></li>
<li><a href="../fr487846/index.html">The Ember Times - Numéro 133</a></li>
<li><a href="../fr487854/index.html">Comment la Namibie protège les animaux sauvages + les colliers IoT</a></li>
<li><a href="../fr487858/index.html">Utilisation pratique du modèle de stratégie</a></li>
<li><a href="../fr487862/index.html">Combien coûte Nyasha?</a></li>
<li><a href="../fr487864/index.html">Passeports électroniques: rejoignez la pratique mondiale ou courez le risque de fuite de données personnelles?</a></li>
<li><a href="../fr487868/index.html">Numérisation de documents et reconnaissance de texte avec VisionKit et Vision Framework sur iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>