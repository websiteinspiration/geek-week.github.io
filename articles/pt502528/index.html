<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèª üë©üèæ‚Äçüé® üßìüèΩ Programando um jogo para um dispositivo incorporado no ESP32 ü§∏üèº üõ•Ô∏è üêÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parte 0: motiva√ß√£o
 Introdu√ß√£o
 Eu estava procurando por um projeto de hobby em que pudesse trabalhar fora das minhas principais tarefas, a fim de esc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programando um jogo para um dispositivo incorporado no ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502528/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 0: motiva√ß√£o</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu estava procurando por um projeto de hobby em que pudesse trabalhar fora das minhas principais tarefas, a fim de escapar da situa√ß√£o no mundo. </font><font style="vertical-align: inherit;">Estou mais interessado em programa√ß√£o de jogos, mas tamb√©m gosto de sistemas embarcados. </font><font style="vertical-align: inherit;">Agora eu trabalho em uma empresa de jogos, mas antes eu estava envolvido principalmente em microcontroladores. </font><font style="vertical-align: inherit;">Embora no final eu tenha decidido mudar meu caminho e entrar na ind√∫stria de jogos, ainda gosto de experimentar com eles. </font><font style="vertical-align: inherit;">Ent√£o, por que n√£o combinar os dois hobbies?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid go</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tinha o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go por a√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o que seria interessante para brincar. </font><font style="vertical-align: inherit;">Seu n√∫cleo √© o ESP32 - um microcontrolador muito popular com funcionalidade MK padr√£o (SPI, I2C, GPIO, temporizadores etc.), mas tamb√©m com WiFi e Bluetooth, o que o torna atraente para a cria√ß√£o de dispositivos IoT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Odroid Go complementa o ESP32 com v√°rios perif√©ricos, transformando-o em uma m√°quina de jogos port√°til que lembra o Gameboy Color: uma tela de LCD, um alto-falante, uma cruz de controle, dois bot√µes principais e quatro auxiliares, uma bateria e um leitor de cart√£o SD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Principalmente as pessoas compram o Odroid Go para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executar emuladores de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sistemas antigos de 8 bits. </font><font style="vertical-align: inherit;">Se isso for capaz de emular jogos antigos, ele tamb√©m lidar√° com o lan√ßamento de um jogo nativo projetado especificamente para ele.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/800/42e/44b80042e94aa2f2da9da2d2296461ad.jpg"></div><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limita√ß√µes</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolu√ß√£o 320x240 A</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
tela tem um tamanho de apenas 320x240; portanto, somos muito limitados na quantidade de informa√ß√µes exibidas na tela ao mesmo tempo. Precisamos considerar cuidadosamente qual jogo criaremos e quais recursos usar. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cor de 16 bits O</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
monitor suporta </font><strong><font style="vertical-align: inherit;">cores de</font></strong><font style="vertical-align: inherit;"> 16 bits por pixel: 5 bits para vermelho, 6 bits para verde e 5 para azul. Por raz√µes √≥bvias, esse circuito √© geralmente chamado RGB565. O verde ficou um pouco mais vermelho e azul, porque o olho humano distingue melhor as grada√ß√µes de verde do que azul ou vermelho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cores de 16 bits significa que temos acesso a apenas 65 mil cores. Compare isso com a cor padr√£o de 24 bits (8 bits por cor), fornecendo 16 </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milh√µes de</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cores. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de GPU</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem uma GPU, n√£o podemos usar uma API como o OpenGL. Hoje, as mesmas GPUs s√£o geralmente usadas para renderizar jogos 2D e jogos 3D. Em vez de objetos, quadr√¢ngulos s√£o desenhados, sobre os quais as texturas de bits s√£o sobrepostas. Sem uma GPU, temos que rasterizar cada pixel com uma CPU, que √© mais lenta mas mais simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com uma resolu√ß√£o de tela de 320x240 e cores de 16 bits, o tamanho total do buffer do quadro √© 153.600 bytes. Isso significa que pelo menos trinta vezes por segundo precisaremos transmitir 153.600 bytes para o display. Em √∫ltima an√°lise, isso pode causar problemas, por isso precisamos ser mais inteligentes ao renderizar a tela. Por exemplo, voc√™ pode converter uma cor indexada em uma paleta para que, para cada pixel, voc√™ precise armazenar um byte, que ser√° usado como um √≠ndice de uma paleta de 256 cores.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 MB O</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ESP32 possui 520 KB de RAM interna, enquanto o Odroid Go adiciona outros 4 MB de RAM externa. Mas nem toda essa mem√≥ria est√° dispon√≠vel para n√≥s, porque parte √© usada pelo ESP32 SDK (mais sobre isso mais tarde). Depois de desativar todas as fun√ß√µes estranhas poss√≠veis e inserir minha fun√ß√£o principal, o ESP32 relata que podemos usar 4.494.848 bytes. Se, no futuro, precisarmos de mais mem√≥ria, mais tarde poderemos voltar a aparar fun√ß√µes desnecess√°rias. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processador de 80-240 MHz</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A CPU est√° configurada em tr√™s velocidades poss√≠veis: 80 MHz, 160 MHz e 240 MHz. Mesmo um m√°ximo de 240 MHz est√° longe do poder de mais de tr√™s gigahertz de computadores modernos com os quais estamos acostumados a trabalhar. Vamos come√ßar a 80 MHz e ver at√© onde podemos ir. Se queremos que o jogo funcione com energia da bateria, o consumo de energia deve ser baixo. Para fazer isso, seria bom diminuir a frequ√™ncia. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depura√ß√£o incorreta</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem maneiras de usar depuradores com dispositivos incorporados (JTAG), mas, infelizmente, o Odroid Go n√£o nos fornece os contatos necess√°rios, portanto, n√£o podemos percorrer o c√≥digo no depurador, como geralmente √© o caso. </font><font style="vertical-align: inherit;">Isso significa que a depura√ß√£o pode ser um processo dif√≠cil, e teremos que usar ativamente a depura√ß√£o na tela (usando cores e texto) e tamb√©m enviar informa√ß√µes para o console de depura√ß√£o (que, felizmente, √© facilmente acess√≠vel via USB UART).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que todo esse problema?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que tentar criar um jogo para este dispositivo fraco com todas as limita√ß√µes listadas acima e simplesmente n√£o escrever nada para um PC de mesa? H√° duas raz√µes para isso: </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limita√ß√µes estimulam a criatividade:</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
quando voc√™ trabalha com um sistema que possui um determinado conjunto de equipamentos, cada um com suas pr√≥prias limita√ß√µes, isso faz voc√™ pensar em como usar da melhor maneira as vantagens dessas limita√ß√µes. Ent√£o, nos aproximamos dos desenvolvedores de jogos de sistemas antigos, por exemplo, Super Nintendo (mas ainda √© muito mais f√°cil para n√≥s do que para eles). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento de baixo n√≠vel √© divertido</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escrever um jogo do zero para um sistema de desktop comum, precisamos trabalhar com conceitos padr√£o de mecanismo de baixo n√≠vel: renderiza√ß√£o, f√≠sica, reconhecimento de colis√£o. </font><font style="vertical-align: inherit;">Por√©m, ao implementar tudo isso em um dispositivo incorporado, tamb√©m precisamos lidar com conceitos de computador de baixo n√≠vel, por exemplo, escrevendo um driver de LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o baixo ser√° o desenvolvimento?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando se trata de n√≠vel baixo e a cria√ß√£o de seu pr√≥prio c√≥digo, voc√™ deve desenhar uma borda em algum lugar. Se estamos tentando escrever um jogo sem bibliotecas para a √°rea de trabalho, √© prov√°vel que a borda seja um sistema operacional ou uma API de plataforma cruzada como SDL. No meu projeto, tra√ßarei uma linha para escrever coisas como drivers SPI e gerenciadores de inicializa√ß√£o. Com eles, muito mais tormento do que divers√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, usaremos o ESP-IDF, que √© essencialmente um SDK para o ESP32. Podemos assumir que ele nos fornece alguns utilit√°rios que o sistema operacional geralmente fornece, mas o </font><font style="vertical-align: inherit;">sistema operacional </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona </font><font style="vertical-align: inherit;">no ESP32 </font><font style="vertical-align: inherit;">. A rigor, este MK usa o FreeRTOS, que √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um sistema operacional em tempo real</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mas este n√£o √© um sistema operacional real. </font><font style="vertical-align: inherit;">Este √© apenas um planejador. </font><font style="vertical-align: inherit;">Provavelmente, n√£o vamos interagir com ele, mas em seu n√∫cleo o ESP-IDF o usa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP-IDF fornece uma API para perif√©ricos ESP32, como SPI, I2C e UART, bem como uma biblioteca de tempo de execu√ß√£o C, portanto, quando chamamos algo como printf, na verdade transfere bytes via UART para serem exibidos no monitor da interface serial. </font><font style="vertical-align: inherit;">Ele tamb√©m processa todo o c√≥digo de inicializa√ß√£o necess√°rio para preparar a m√°quina antes de invocar o ponto de lan√ßamento do nosso jogo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste post, vou manter uma revista de desenvolvimento na qual falarei sobre pontos interessantes que me pareceram e explicarei os aspectos mais dif√≠ceis. </font><font style="vertical-align: inherit;">N√£o tenho um plano e provavelmente cometerei muitos erros. </font><font style="vertical-align: inherit;">Tudo isso eu crio por interesse.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: sistema de compila√ß√£o</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßarmos a escrever o c√≥digo para o Odroid Go, precisamos configurar o ESP32 SDK. </font><font style="vertical-align: inherit;">Ele cont√©m o c√≥digo que inicia o ESP32 e chama nossa fun√ß√£o principal, bem como o c√≥digo perif√©rico (por exemplo, SPI) que precisaremos quando escrevermos o driver do LCD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Espressif chama seu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDK </font><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">usamos a vers√£o est√°vel mais recente </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4.0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos clonar o reposit√≥rio de acordo com suas instru√ß√µes (com o sinalizador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recursivo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ou simplesmente fazer o download do zip na p√°gina de lan√ßamentos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso primeiro objetivo √© um aplicativo m√≠nimo no estilo Hello World instalado no Odroid Go que comprove a configura√ß√£o correta do ambiente de compila√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ou C ++</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP-IDF usa C99, por isso tamb√©m a escolheremos. </font><font style="vertical-align: inherit;">Se desejado, poder√≠amos usar C ++ (existe um compilador C ++ na cadeia de ferramentas ESP32), mas por enquanto vamos nos ater a C. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, eu gosto de C e de sua simplicidade. </font><font style="vertical-align: inherit;">N√£o importa o quanto eu escreva c√≥digo em C ++, nunca consegui chegar ao momento de apreci√°-lo. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa pessoa resume meus pensamentos muito bem. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, se necess√°rio, podemos mudar para C ++ a qualquer momento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto m√≠nimo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A IDF usa o CMake para gerenciar o sistema de compila√ß√£o. Ele tamb√©m suporta Makefile, mas eles foram descontinuados na v4.0, portanto, apenas usaremos o CMake. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No m√≠nimo, precisamos de um arquivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com uma descri√ß√£o do nosso projeto, uma pasta </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o arquivo de origem do ponto de entrada no jogo e outro arquivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que lista os arquivos de origem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O CMake precisa fazer refer√™ncia a vari√°veis ‚Äã‚Äãde ambiente que informam onde procurar IDF e cadeia de ferramentas. Fiquei aborrecido por ter que reinstal√°-los toda vez que iniciei uma nova sess√£o de terminal, ent√£o escrevi o script </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele define </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e tamb√©m √© uma fonte de exporta√ß√£o IDF que define outras vari√°veis ‚Äã‚Äãde ambiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â suficiente para o usu√°rio script para definir os </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vari√°veis IDF_TOOLS_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="powershell hljs">IDF_PATH=<font></font>
IDF_TOOLS_PATH=<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_TOOLS_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_TOOLS_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<font></font>
export IDF_PATH<font></font>
export IDF_TOOLS_PATH<font></font>
<font></font>
source <span class="hljs-variable">$IDF_PATH</span>/export.sh</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na raiz:</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>)<font></font>
<font></font>
<span class="hljs-keyword">set</span>(COMPONENTS <span class="hljs-string">"esptool_py main"</span>)<font></font>
<font></font>
<span class="hljs-keyword">include</span>($ENV{IDF_PATH}/tools/cmake/<span class="hljs-keyword">project</span>.cmake)<font></font>
<font></font>
<span class="hljs-keyword">project</span>(game)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por padr√£o, o sistema de compila√ß√£o criar√° todos os componentes poss√≠veis dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ESP_IDF / components</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o que resultar√° em mais tempo de compila√ß√£o. </font><font style="vertical-align: inherit;">Queremos compilar um conjunto m√≠nimo de componentes para chamar nossa fun√ß√£o principal e conectar componentes adicionais posteriormente, se necess√°rio. </font><font style="vertical-align: inherit;">√â para isso que serve a vari√°vel </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COMPONENTS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cmake hljs">idf_component_register(<font></font>
	SRCS <span class="hljs-string">"main.c"</span>
    INCLUDE_DIRS <span class="hljs-string">""</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo o que ele faz - infinitamente uma vez por segundo exibe no monitor a interface serial "Hello World". </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O VTaskDelay</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa o FreeRTOS </font><font style="vertical-align: inherit;">para atrasar </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">muito simples:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/FreeRTOS.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/task.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello World!\n"</span>);<font></font>
		vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que nossa fun√ß√£o √© chamada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o </font></font></em> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A fun√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">usada pelo IDF para a prepara√ß√£o necess√°ria e, em seguida, cria uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com a fun√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como ponto de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma tarefa √© apenas um bloco execut√°vel que o FreeRTOS pode gerenciar. Embora n√£o devamos nos preocupar com isso (ou talvez nem um pouco), √© importante observar aqui que nosso jogo √© executado em um n√∫cleo (o ESP32 possui dois n√∫cleos) e, a cada itera√ß√£o do loop for, a tarefa atrasa a execu√ß√£o por um segundo. Durante esse atraso, o agendador do FreeRTOS pode executar outro c√≥digo que est√° aguardando na fila para execu√ß√£o (se houver).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos usar os dois n√∫cleos, mas, por enquanto, vamos nos limitar a um.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Componentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo se reduzirmos a lista de componentes ao m√≠nimo necess√°rio para o aplicativo Hello World (que √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esptool_py</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), devido √† configura√ß√£o da cadeia de depend√™ncias, ele ainda coleta outros componentes que n√£o s√£o necess√°rios. </font><font style="vertical-align: inherit;">Ele coleta todos esses componentes:</font></font><br>
<br>
<pre><code class="cmake hljs">app_trace app_update bootloader bootloader_support cxx driver efuse esp32 esp_common esp_eth esp_event esp_ringbuf<font></font>
esp_rom esp_wifi espcoredump esptool_py freertos heap log lwip main mbedtls newlib nvs_flash partition_table pthread<font></font>
soc spi_flash tcpip_adapter vfs wpa_supplicant xtensa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitos deles s√£o bastante l√≥gicos ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bootloader</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freertos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mas s√£o seguidos por componentes desnecess√°rios porque n√£o usamos fun√ß√µes de rede: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_eth, esp_wifi, lwip, mbedtls, tcpip_adapter, wpa_supplicant</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Infelizmente, ainda somos obrigados a montar esses componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, o vinculador √© inteligente o suficiente e n√£o coloca componentes n√£o utilizados em um arquivo bin√°rio pronto do jogo. </font><font style="vertical-align: inherit;">Podemos verificar isso com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make size-components</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<code><pre>Total sizes:
 DRAM .data size:    8476 bytes
 DRAM .bss  size:    4144 bytes
Used static DRAM:   12620 bytes ( 168116 available, 7.0% used)
Used static IRAM:   56345 bytes (  74727 available, 43.0% used)
      Flash code:   95710 bytes
    Flash rodata:   40732 bytes
Total image size:~ 201263 bytes (.bin may be padded larger)
Per-archive contributions to ELF file:
            Archive File DRAM .data &amp; .bss   IRAM Flash code &amp; rodata   Total
                  libc.a        364      8   5975      63037     3833   73217
              libesp32.a       2110    151  15236      15415    21485   54397
           libfreertos.a       4148    776  14269          0     1972   21165
                libsoc.a        184      4   7909        875     4144   13116
          libspi_flash.a        714    294   5069       1320     1386    8783
                libvfs.a        308     48      0       5860      973    7189
         libesp_common.a         16   2240    521       1199     3060    7036
             libdriver.a         87     32      0       4335     2200    6654
               libheap.a        317      8   3150       1218      748    5441
             libnewlib.a        152    272    869        908       99    2300
        libesp_ringbuf.a          0      0    906          0      163    1069
                liblog.a          8    268    488         98        0     862
         libapp_update.a          0      4    127        159      486     776
 libbootloader_support.a          0      0      0        634        0     634
                libhal.a          0      0    519          0       32     551
            libpthread.a          8     12      0        288        0     308
             libxtensa.a          0      0    220          0        0     220
                libgcc.a          0      0      0          0      160     160
               libmain.a          0      0      0         22       13      35
                libcxx.a          0      0      0         11        0      11
                   (exe)          0      0      0          0        0       0
              libefuse.a          0      0      0          0        0       0
         libmbedcrypto.a          0      0      0          0        0       0
     libwpa_supplicant.a          0      0      0          0        0       0</pre></code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima de tudo, libc afeta o tamanho do bin√°rio, e isso √© bom.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do projeto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O IDF permite especificar par√¢metros de configura√ß√£o em tempo de compila√ß√£o usados ‚Äã‚Äãdurante a montagem para ativar ou desativar v√°rias fun√ß√µes. </font><font style="vertical-align: inherit;">Precisamos definir par√¢metros que nos permitam tirar proveito dos aspectos adicionais do Odroid Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa executar o script de origem do </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que o CMake tenha acesso √†s vari√°veis ‚Äã‚Äãde ambiente necess√°rias. </font><font style="vertical-align: inherit;">Al√©m disso, como em todos os projetos do CMake, precisamos criar uma pasta de montagem e chamar o CMake a partir dela.</font></font><br>
<br>
<pre><code class="cmake hljs">source <span class="hljs-keyword">export</span>.sh<font></font>
mkdir build<font></font>
cd build<font></font>
cmake ..</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ executar o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make menuconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ser√° aberta uma janela onde voc√™ poder√° definir as configura√ß√µes do projeto.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expans√£o de mem√≥ria flash de at√© 16 MB</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Odroid Go expande a capacidade padr√£o da unidade flash para 16 MB. </font><font style="vertical-align: inherit;">Voc√™ pode ativar esse recurso acessando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do pisca-pisca serial -&gt; Tamanho do flash -&gt; 16 MB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ativar RAM SPI externa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m temos acesso a mais 4 MB de RAM externa conectados via SPI. </font><font style="vertical-align: inherit;">Voc√™ pode habilit√°-lo acessando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Component config -&gt; ESP32-specific -&gt; Support for RAM externa conectada a SPI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e pressionando a barra de espa√ßo para habilit√°-lo. </font><font style="vertical-align: inherit;">Tamb√©m queremos poder alocar explicitamente a mem√≥ria da SPI RAM; </font><font style="vertical-align: inherit;">isso pode ser ativado acessando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI RAM config -&gt; SPI RAM access method -&gt; Tornar a RAM aloc√°vel usando heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abaixe a frequ√™ncia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP32 funciona por padr√£o com uma frequ√™ncia de 160 MHz, mas vamos abaix√°-lo para 80 MHz para ver at√© onde voc√™ pode ir com a menor frequ√™ncia de clock. Queremos que o jogo funcione com bateria, e diminuir a frequ√™ncia economizar√° energia. Voc√™ pode alter√°-lo indo para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Component config -&gt; ESP32 specific -&gt; CPU frequency -&gt; 80MHz</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ selecionar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salvar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o arquivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° salvo na raiz da pasta do projeto </font><font style="vertical-align: inherit;">. Podemos escrever esse arquivo no git, mas ele possui muitos par√¢metros que n√£o s√£o importantes para n√≥s. At√© agora, estamos satisfeitos com os par√¢metros padr√£o, exceto aqueles que acabamos de alterar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode criar o arquivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que conter√° os valores alterados acima. </font><font style="vertical-align: inherit;">Todo o resto ser√° configurado por padr√£o. </font><font style="vertical-align: inherit;">Durante a constru√ß√£o, o IDF ler√° </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , substituir√° os valores que definimos e usar√° o padr√£o para todos os outros par√¢metros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fica assim:</font></font><br>
<br>
<pre><code class="cpp hljs"># Set flash size to <span class="hljs-number">16</span>MB<font></font>
CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y<font></font>
<font></font>
# Set CPU frequency to <span class="hljs-number">80</span>MHz<font></font>
CONFIG_ESP32_DEFAULT_CPU_FREQ_80=y<font></font>
<font></font>
# Enable SPI RAM <span class="hljs-keyword">and</span> allocate with heap_caps_malloc()<font></font>
CONFIG_ESP32_SPIRAM_SUPPORT=y<font></font>
CONFIG_SPIRAM_USE_CAPS_ALLOC=y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, a estrutura original do jogo √© assim:</font></font><br>
<br>
<code><pre>game
‚îú‚îÄ‚îÄ CMakeLists.txt
‚îú‚îÄ‚îÄ export.sh
‚îú‚îÄ‚îÄ main
‚îÇ   ‚îú‚îÄ‚îÄ CMakeLists.txt
‚îÇ   ‚îî‚îÄ‚îÄ main.c
‚îî‚îÄ‚îÄ sdkconfig.defaults</pre></code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constru√ß√£o e flash</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processo de montagem e firmware √© bastante simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corremos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para compilar (para compila√ß√£o paralela, adicione </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j8</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para gravar a imagem no Odroid Go e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para exibir a sa√≠da das instru√ß√µes </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cmake hljs">make<font></font>
make flash<font></font>
make monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m podemos execut√°-los em uma linha.</font></font><br>
<br>
<pre><code class="cmake hljs">make flash monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado n√£o √© particularmente impressionante, mas se tornar√° a base para o restante do projeto.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c2/329/62f/3c232962f8e782c9220b25b7e3c0df5e.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o ESP-IDF: Build System</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o do FreeRTOS: vTaskDelay</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: entrada</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos ser capazes de ler os bot√µes pressionados pelo jogador e a cruz no Odroid Go.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot√µes</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/142/ca2/106142ca2250eb9301215015b6f0bbad.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Odroid Go possui seis bot√µes: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecionar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iniciar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menu</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volume</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada um dos bot√µes est√° conectado a um </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pino GPO (General Purpose IO)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> separado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Os pinos GPIO podem ser usados ‚Äã‚Äãcomo entradas (para leitura) ou como sa√≠das (escrevemos neles). </font><font style="vertical-align: inherit;">No caso de bot√µes, precisamos de uma leitura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa configurar os contatos como entradas, ap√≥s o que podemos ler seu status. </font><font style="vertical-align: inherit;">Os contatos internos t√™m uma das duas tens√µes (3,3V ou 0V), mas ao l√™-los usando a fun√ß√£o IDF, eles s√£o convertidos em valores inteiros.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializa√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os elementos marcados como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no diagrama </font><font style="vertical-align: inherit;">s√£o os pr√≥prios bot√µes f√≠sicos. Quando n√£o pressionados, os contatos do ESP32 ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.) s√£o conectados a 3,3 V; isto √©, 3,3 V significa que o bot√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° </font><strong><font style="vertical-align: inherit;">pressionado</font></strong><font style="vertical-align: inherit;"> . A l√≥gica aqui √© o oposto do que √© esperado. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possuem resistores f√≠sicos na placa. Se o bot√£o n√£o for pressionado, o resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puxa os</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contatos para uma alta tens√£o. Se o bot√£o for pressionado, a corrente que </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flui</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atrav√©s dos contatos ser√° direcionada ao solo, para que a tens√£o 0 seja lida nos contatos </font><strong><font style="vertical-align: inherit;">IO13</font></strong><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o possui resistores, porque o contato no ESP32 possui resistores internos, configurados para o modo pull-up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabendo disso, podemos configurar seis bot√µes usando a API GPIO.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_A = GPIO_NUM_32;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_B = GPIO_NUM_33;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_START = GPIO_NUM_39;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_SELECT = GPIO_NUM_27;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_VOLUME = GPIO_NUM_0;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_MENU = GPIO_NUM_13;<font></font>
<font></font>
<span class="hljs-keyword">gpio_config_t</span> gpioConfig = {};<font></font>
<font></font>
gpioConfig.mode = GPIO_MODE_INPUT;<font></font>
gpioConfig.pull_up_en = GPIO_PULLUP_ENABLE;<font></font>
gpioConfig.pin_bit_mask =<font></font>
	  (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_A)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_B)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_START)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_SELECT)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_VOLUME)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_MENU);<font></font>
<font></font>
ESP_ERROR_CHECK(gpio_config(&amp;gpioConfig));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As constantes especificadas no in√≠cio do c√≥digo correspondem a cada um dos contatos do circuito. Usamos a estrutura </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para configurar cada um dos seis bot√µes como entrada pull-up. No caso de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> precisamos solicitar √† IDF para ativar os resistores de pull-up desses contatos. Para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√£o precisamos fazer isso porque eles t√™m resistores f√≠sicos, mas faremos de qualquer maneira para tornar a configura√ß√£o bonita. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_ERROR_CHECK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma macro auxiliar do IDF que verifica automaticamente o resultado de todas as fun√ß√µes que retornam </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_err_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(a maioria das IDF) e afirma que o resultado n√£o √© igual a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_OK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â conveniente usar essa macro para uma fun√ß√£o se o erro for cr√≠tico e depois n√£o fizer sentido continuar a execu√ß√£o. </font><font style="vertical-align: inherit;">Neste jogo, um jogo sem entrada n√£o √© um jogo, portanto, essa afirma√ß√£o √© verdadeira. </font><font style="vertical-align: inherit;">Geralmente usaremos essa macro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot√µes de leitura</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, configuramos todos os contatos e finalmente podemos ler os valores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os bot√µes num√©ricos s√£o lidos pela fun√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_get_level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas precisamos inverter os valores recebidos, porque os contatos s√£o puxados para cima, ou seja, um sinal alto realmente significa "n√£o pressionado" e um baixo significa "pressionado". </font><font style="vertical-align: inherit;">A invers√£o preserva a l√≥gica usual: 1 significa "pressionado", 0 - "n√£o pressionado".</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> a = !gpio_get_level(BUTTON_PIN_A);
<span class="hljs-keyword">int</span> b = !gpio_get_level(BUTTON_PIN_B);
<span class="hljs-keyword">int</span> select = !gpio_get_level(BUTTON_PIN_SELECT);
<span class="hljs-keyword">int</span> start = !gpio_get_level(BUTTON_PIN_START);
<span class="hljs-keyword">int</span> menu = !gpio_get_level(BUTTON_PIN_MENU);
<span class="hljs-keyword">int</span> volume = !gpio_get_level(BUTTON_PIN_VOLUME);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travessa (D-pad)</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/d9e/a73/1e8d9ea7303257afd45846771726a275.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectar a cruz √© diferente de conectar os bot√µes. </font><font style="vertical-align: inherit;">Os bot√µes para cima e para baixo s√£o conectados a um pino de um </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conversor anal√≥gico-digital (ADC)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e os bot√µes esquerdo e direito s√£o </font><font style="vertical-align: inherit;">conectados </font><font style="vertical-align: inherit;">a outro pino ADC. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao contr√°rio dos contatos digitais GPIO, dos quais podemos ler um dos dois estados (alto ou baixo), o ADC converte uma tens√£o anal√≥gica cont√≠nua (por exemplo, de 0 V a 3,3 V) em um valor num√©rico discreto (por exemplo, de 0 a 4095 ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponho que os designers do Odroid Go fizeram isso para economizar nos pinos GPIO (voc√™ s√≥ precisa de dois pinos anal√≥gicos em vez de quatro pinos digitais). </font><font style="vertical-align: inherit;">Seja como for, isso complica um pouco a configura√ß√£o e a leitura desses contatos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O contato </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35 √©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conectado ao eixo Y da </font><strong><font style="vertical-align: inherit;">aranha</font></strong><font style="vertical-align: inherit;"> e o contato </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><strong><font style="vertical-align: inherit;">conectado</font></strong><font style="vertical-align: inherit;"> ao eixo X da </font><strong><font style="vertical-align: inherit;">aranha</font></strong><font style="vertical-align: inherit;"> . Vemos que as articula√ß√µes da cruz s√£o um pouco mais complicadas que os bot√µes num√©ricos. Cada eixo possui dois interruptores ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o eixo Y, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o eixo X), cada um dos quais √© conectado a um conjunto de resistores ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se nem "para cima" nem "para baixo" for pressionado, o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pino IO35 √©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puxado para o ch√£o via </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e consideramos o valor 0 V. Se nem "esquerdo" nem "direito" forem pressionados, entre em contato com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desce ao solo atrav√©s de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e contamos o valor at√© 0 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1 for</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pressionado </font><strong><font style="vertical-align: inherit;">("para cima")</font></strong><font style="vertical-align: inherit;"> , ent√£o com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos 3,3 V. Se </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2 for</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pressionado </font><strong><font style="vertical-align: inherit;">("para baixo")</font></strong><font style="vertical-align: inherit;"> , com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos cerca de 1, 65 V, porque metade da tens√£o cair√° no resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3 for</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pressionado </font><strong><font style="vertical-align: inherit;">(‚Äúesquerda‚Äù)</font></strong><font style="vertical-align: inherit;"> , ent√£o com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos 3,3 V. Se </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4 for</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pressionado </font><strong><font style="vertical-align: inherit;">(‚Äúdireita‚Äù)</font></strong><font style="vertical-align: inherit;"> , ent√£o com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m contamos cerca de 1,65 V, porque metade da tens√£o cair√° no resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambos os casos s√£o exemplos de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">divisores</font></a><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tens√£o.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Quando dois resistores no divisor de tens√£o t√™m a mesma resist√™ncia (no nosso caso - 100K), a queda de tens√£o ser√° metade da tens√£o de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabendo disso, podemos configurar a pe√ßa transversal:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_X_AXIS = ADC1_GPIO34_CHANNEL;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_Y_AXIS = ADC1_GPIO35_CHANNEL;<font></font>
<font></font>
ESP_ERROR_CHECK(adc1_config_width(ADC_WIDTH_BIT_12));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_X_AXIS,ADC_ATTEN_DB_11));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_Y_AXIS,ADC_ATTEN_DB_11));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definimos o ADC para 12 bits de largura, de modo que 0 V foi lido como 0 e 3,3 V como 4095 (2 ^ 12). </font><font style="vertical-align: inherit;">A atenua√ß√£o relata que n√£o precisamos atenuar o sinal para obter a faixa de tens√£o total de 0 V a 3,3 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A 12 bits, podemos esperar que se nada for pressionado, 0 ser√° lido, quando pressionado para cima e para a esquerda - 4096, e aproximadamente 2048 ser√° lido quando pressionado e para a direita (porque os resistores reduzem a tens√£o pela metade).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leitura cruzada</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ler a cruz √© mais dif√≠cil que os bot√µes, porque precisamos ler os valores brutos (de 0 a 4095) e interpret√°-los.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_POSITIVE_LEVEL = <span class="hljs-number">3072</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_NEGATIVE_LEVEL = <span class="hljs-number">1024</span>;<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadX = adc1_get_raw(DPAD_PIN_X_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadX &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Left pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadX &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Right pressed</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadY = adc1_get_raw(DPAD_PIN_Y_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadY &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Up pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadY &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Down pressed</span>
}</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_POSITIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_NEGATIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o valores com uma margem, garantindo que sempre lemos os valores corretos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vota√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem duas op√ß√µes para obter valores de bot√£o: polling ou interrup√ß√µes. Podemos criar fun√ß√µes de processamento de entrada e solicitar ao IDF que chame essas fun√ß√µes quando os bot√µes forem pressionados, ou pesquise manualmente o estado dos bot√µes quando precisarmos. O comportamento orientado a interrup√ß√µes torna as coisas mais complicadas e dif√≠ceis de entender. Al√©m disso, eu sempre me esfor√ßo para tornar tudo o mais simples poss√≠vel. Se necess√°rio, podemos adicionar interrup√ß√µes mais tarde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criaremos uma estrutura que armazenar√° o estado de seis bot√µes e quatro dire√ß√µes da cruz. Podemos criar uma estrutura com 10 int booleanos, 10 int ou 10 n√£o assinados. No entanto, em vez disso, criaremos a estrutura usando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campos de bits</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span>
	<span class="hljs-keyword">uint16_t</span> a : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> b : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> volume : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> menu : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> select : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> start : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> left : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> right : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> up : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> down : <span class="hljs-number">1</span>;<font></font>
} Odroid_Input;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao programar para sistemas de desktop, os campos de bits geralmente s√£o evitados porque s√£o mal portados para m√°quinas diferentes, mas programamos para uma m√°quina espec√≠fica e n√£o precisamos nos preocupar com isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de campos, uma estrutura com 10 valores booleanos com um tamanho total de 10 bytes pode ser usada. </font><font style="vertical-align: inherit;">Outra op√ß√£o √© uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint16_t com</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macros de deslocamento e mascaramento de bits que podem definir, </font><strong><font style="vertical-align: inherit;">limpar</font></strong><font style="vertical-align: inherit;"> e verificar bits individuais. </font><font style="vertical-align: inherit;">Funcionar√°, mas n√£o ser√° muito bonito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um campo de bits simples nos permite tirar proveito de ambas as abordagens: dois bytes de dados e campos nomeados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos pesquisar o estado das entradas dentro do loop principal e exibir o resultado.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-built_in">printf</span>(
			<span class="hljs-string">"\ra: %d  b: %d  start: %d  select: %d  vol: %d  menu: %d  up: %d  down: %d  left: %d  right: %d"</span>,<font></font>
			input.a, input.b, input.start, input.select, input.volume, input.menu,<font></font>
			input.up, input.down, input.left, input.right);<font></font>
<font></font>
		fflush(<span class="hljs-built_in">stdout</span>);<font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">250</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para substituir a linha anterior em vez de adicionar uma nova. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fflush √©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necess√°rio para exibir uma linha, porque no estado normal ela √© redefinida pelo caractere de nova linha </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ n</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seu navegador n√£o suporta v√≠deo HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_2/media/input.mp4" type="video/mp4"></video></div></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid esquem√°tico</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o ESP-IDF: ADC</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o ESP-IDF: GPIO</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3: exibi√ß√£o</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos ser capazes de renderizar pixels no LCD do Odroid Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exibir cores na tela ser√° mais dif√≠cil do que ler o status de entrada porque o LCD possui c√©rebros. </font><font style="vertical-align: inherit;">A tela √© controlada pelo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ILI9341</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - um driver TFT LCD muito popular em um √∫nico chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em outras palavras, estamos conversando com o ILI9341, que responde aos nossos comandos controlando os pixels no LCD. </font><font style="vertical-align: inherit;">Quando digo "tela" ou "exibi√ß√£o" nesta parte, na verdade quero dizer ILI9341. </font><font style="vertical-align: inherit;">Estamos lidando com ILI9341. </font><font style="vertical-align: inherit;">Controla o LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O LCD est√° conectado ao ESP32 via </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI (Serial Peripheral Interface)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O SPI √© um protocolo padr√£o usado para trocar dados entre dispositivos em uma placa de circuito impresso. Possui quatro sinais: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI (entrada principal escrava)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO (entrada principal escrava)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK (rel√≥gio)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS (sele√ß√£o de chip)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um √∫nico dispositivo mestre no barramento coordena a transfer√™ncia de dados controlando SCK e CS. Pode haver v√°rios dispositivos em um barramento, cada um com seus pr√≥prios sinais CS. Quando o sinal CS deste dispositivo √© ativado, ele pode transmitir e receber dados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP32 ser√° o mestre SPI (mestre) e o LCD ser√° o escravo SPI escravo. </font><font style="vertical-align: inherit;">Precisamos configurar o barramento SPI com os par√¢metros necess√°rios e adicionar um display LCD ao barramento, configurando os contatos correspondentes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bc/60e/18c/7bc60e18c1b066ba7c22756464f92512.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f12/463/615/f124636158029efeab3259f299a2af36.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os nomes </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSPI.XXXX</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o apenas r√≥tulos para os contatos no diagrama, mas podemos examinar os contatos observando as partes dos diagramas de LCD e ESP32.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MOSI -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO23</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MISO -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO19</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.SCK -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO18</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.CS0 -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO5</font></font></strong></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m temos o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO14</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© o pino GPIO usado para ligar a luz de fundo, e tamb√©m o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO21</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© conectado ao pino </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><font style="vertical-align: inherit;">LCD. Este contato controla o tipo de informa√ß√£o que transmitimos para o display. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, configure o barramento SPI.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MISO = GPIO_NUM_19;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MOSI = GPIO_NUM_23;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_SCLK = GPIO_NUM_18;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_CS = GPIO_NUM_5;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_DC = GPIO_NUM_21;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_BACKLIGHT = GPIO_NUM_14;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_WIDTH = <span class="hljs-number">320</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_HEIGHT = <span class="hljs-number">240</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_DEPTH = <span class="hljs-number">2</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">spi_bus_config_t</span> spiBusConfig = {};<font></font>
spiBusConfig.miso_io_num = LCD_PIN_MISO;<font></font>
spiBusConfig.mosi_io_num = LCD_PIN_MOSI;<font></font>
spiBusConfig.sclk_io_num = LCD_PIN_SCLK;<font></font>
spiBusConfig.quadwp_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span>
spiBusConfig.quadhd_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span><font></font>
spiBusConfig.max_transfer_sz = LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_initialize(VSPI_HOST, &amp;spiBusConfig, <span class="hljs-number">1</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s configuramos o barramento usando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_bus_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â necess√°rio comunicar os contatos que usamos e o tamanho m√°ximo de uma transfer√™ncia de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por enquanto, realizaremos uma transmiss√£o SPI para todos os dados do buffer de quadro, que √© igual √† largura do LCD (em pixels) vezes sua altura (em pixels) vezes o n√∫mero de bytes por pixel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A largura √© 320, a altura √© 240 e a profundidade da cor √© 2 bytes (a exibi√ß√£o espera que as cores dos pixels tenham 16 bits de profundidade).</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">spi_handle_t</span> gSpiHandle;<font></font>
<font></font>
<span class="hljs-keyword">spi_device_interface_config_t</span> spiDeviceConfig = {};<font></font>
spiDeviceConfig.clock_speed_hz = SPI_MASTER_FREQ_40M;<font></font>
spiDeviceConfig.spics_io_num = LCD_PIN_CS;<font></font>
spiDeviceConfig.queue_size = <span class="hljs-number">1</span>;<font></font>
spiDeviceConfig.flags = SPI_DEVICE_NO_DUMMY;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_add_device(VSPI_HOST, &amp;spiDeviceConfig, &amp;gSpiHandle));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s inicializar o barramento, precisamos adicionar um dispositivo de LCD ao barramento para que possamos come√ßar a conversar com ele.</font></font><br>
<br>
<ul>
<li><strong>clock_speed_hz</strong> ‚Äî   - ,      SPI   40 ,     .        80 ,         .</li>
<li><strong>spics_io_num</strong> ‚Äî    CS,  IDF     CS,        ( SD-     SPI).</li>
<li><strong>queue_size</strong> ‚Äî     1,           (  ).</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinalizadores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o driver IDF SPI geralmente insere bits vazios na transmiss√£o para evitar problemas de temporiza√ß√£o durante a leitura do dispositivo SPI, mas realizamos uma transmiss√£o unidirecional (n√£o iremos ler a partir da tela). </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_DEVICE_NO_DUMMY</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> relata que confirmamos esta transmiss√£o unidirecional e n√£o precisamos inserir bits vazios.</font></font></li>
</ul><br>
<br>
<pre><code class="cpp hljs">gpio_set_direction(LCD_PIN_DC, GPIO_MODE_OUTPUT);<font></font>
gpio_set_direction(LCD_PIN_BACKLIGHT, GPIO_MODE_OUTPUT);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m precisamos definir os </font><font style="vertical-align: inherit;">pinos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e de luz de fundo como pinos GPIO. </font><font style="vertical-align: inherit;">Depois de mudar para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC, a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> luz de fundo estar√° constantemente ligada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A comunica√ß√£o com o LCD √© na forma de comandos. </font><font style="vertical-align: inherit;">Primeiro, passamos um byte que indica o comando que queremos enviar e depois passamos os par√¢metros do comando (se houver). </font><font style="vertical-align: inherit;">O visor entende que o byte √© um comando se o </font><font style="vertical-align: inherit;">sinal </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estiver baixo. </font><font style="vertical-align: inherit;">Se o </font><font style="vertical-align: inherit;">sinal </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estiver alto, os dados recebidos ser√£o considerados os par√¢metros do comando transmitido anteriormente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o fluxo fica assim:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Damos um </font><font style="vertical-align: inherit;">sinal baixo </font><font style="vertical-align: inherit;">para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviamos um byte do comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Damos um </font><font style="vertical-align: inherit;">sinal alto </font><font style="vertical-align: inherit;">para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envie zero ou mais bytes, dependendo dos requisitos do comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repita as etapas 1 a 4</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, nosso melhor amigo √© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a especifica√ß√£o ILI9341</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele lista todos os comandos poss√≠veis, seus par√¢metros e como us√°-los.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68d/8d8/09c/68d8d809ceb9446142cd5c77bb78d0e2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo de comando sem par√¢metros √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display ON</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O byte de comando √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x29</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas nenhum par√¢metro foi especificado para ele.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35a/4e0/446/35a4e04466c22aa6746fe441f345c02f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo de um comando com par√¢metros √© o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conjunto de endere√ßos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da </font><strong><font style="vertical-align: inherit;">coluna</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O byte de comando √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas quatro par√¢metros necess√°rios s√£o especificados para ele. </font><font style="vertical-align: inherit;">Para usar o comando, voc√™ precisa enviar um </font><font style="vertical-align: inherit;">sinal baixo </font><font style="vertical-align: inherit;">para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , enviar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , enviar um </font><font style="vertical-align: inherit;">sinal alto </font><font style="vertical-align: inherit;">para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e transferir os bytes de quatro par√¢metros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os c√≥digos de comando em si s√£o especificados na enumera√ß√£o.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span><font></font>
{<font></font>
	SOFTWARE_RESET = <span class="hljs-number">0x01</span>u,<font></font>
	SLEEP_OUT = <span class="hljs-number">0x11</span>u,<font></font>
	DISPLAY_ON = <span class="hljs-number">0x29</span>u,<font></font>
	COLUMN_ADDRESS_SET = <span class="hljs-number">0x2A</span>u,<font></font>
	PAGE_ADDRESS_SET = <span class="hljs-number">0x2B</span>u,<font></font>
	MEMORY_WRITE = <span class="hljs-number">0x2C</span>u,<font></font>
	MEMORY_ACCESS_CONTROL = <span class="hljs-number">0x36</span>u,<font></font>
	PIXEL_FORMAT_SET = <span class="hljs-number">0x3A</span>u,<font></font>
} CommandCode;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, poder√≠amos usar uma macro ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define SOFTWARE_RESET (0x01u)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mas elas n√£o possuem s√≠mbolos no depurador e n√£o t√™m escopo. </font><font style="vertical-align: inherit;">Tamb√©m seria poss√≠vel usar as constantes est√°ticas inteiras, como fizemos com os contatos do GPIO, mas, gra√ßas √† enum, podemos entender rapidamente quais dados s√£o passados ‚Äã‚Äãpara uma fun√ß√£o ou membro da estrutura: eles s√£o do tipo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandCode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Caso contr√°rio, poderia ser </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint8_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bruto </font><font style="vertical-align: inherit;">que nada </font><strong><font style="vertical-align: inherit;">diz</font></strong><font style="vertical-align: inherit;"> ao programador que est√° lendo o c√≥digo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lan√ßamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante a inicializa√ß√£o, podemos passar comandos diferentes para poder desenhar algo. </font><font style="vertical-align: inherit;">Cada comando possui um byte de comando, que chamaremos de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de comando</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definiremos uma estrutura para armazenar o comando de inicializa√ß√£o, para que voc√™ possa especificar sua matriz.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span><font></font>
	CommandCode code;<font></font>
	<span class="hljs-keyword">uint8_t</span> parameters[<span class="hljs-number">15</span>];
	<span class="hljs-keyword">uint8_t</span> length;<font></font>
} StartupCommand;</code></pre><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o c√≥digo de comando.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma matriz de par√¢metros de comando (se houver). </font><font style="vertical-align: inherit;">Essa √© uma matriz est√°tica de tamanho 15, porque esse √© o n√∫mero m√°ximo de par√¢metros que precisamos. </font><font style="vertical-align: inherit;">Devido √† natureza est√°tica da matriz, n√£o precisamos nos preocupar em alocar uma matriz din√¢mica para cada comando todas as vezes.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">length</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o n√∫mero de par√¢metros na matriz de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par√¢metros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando essa estrutura, podemos especificar uma lista de comandos de inicializa√ß√£o.</font></font><br>
<br>
<pre><code class="cpp hljs">StartupCommand gStartupCommands[] =<font></font>
{<font></font>
	<span class="hljs-comment">// Reset to defaults</span><font></font>
	{<font></font>
		SOFTWARE_RESET,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Landscape Mode</span>
	<span class="hljs-comment">// Top-Left Origin</span>
	<span class="hljs-comment">// BGR Panel</span><font></font>
	{<font></font>
		MEMORY_ACCESS_CONTROL,<font></font>
		{<span class="hljs-number">0x20</span> | <span class="hljs-number">0xC0</span> | <span class="hljs-number">0x08</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// 16 bits per pixel</span><font></font>
	{<font></font>
		PIXEL_FORMAT_SET,<font></font>
		{<span class="hljs-number">0x55</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Exit sleep mode</span><font></font>
	{<font></font>
		SLEEP_OUT,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Turn on the display</span><font></font>
	{<font></font>
		DISPLAY_ON,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comandos sem par√¢metros, por exemplo, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOFTWARE_RESET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , defina a lista do inicializador de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par√¢metros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como </font><font style="vertical-align: inherit;">vazia (ou seja, com um zeros) e o comprimento definido como 0. Os comandos com par√¢metros preenchem os par√¢metros e especificam o comprimento. </font><font style="vertical-align: inherit;">Seria √≥timo se pud√©ssemos definir o comprimento automaticamente e n√£o escrever n√∫meros (no caso de cometermos um erro ou os par√¢metros mudarem), mas acho que n√£o vale a pena. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo da maioria das equipes √© claro desde o nome, com exce√ß√£o de duas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_ACCESS_CONTROL</font></font></strong><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo Paisagem:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por padr√£o, a tela usa a orienta√ß√£o retrato (240x320), mas queremos usar a paisagem (320x240).</font></font></li>
<li><strong>Top-Left Origin:</strong>      (0,0)     ,    ( )         .</li>
<li><strong>BGR Panel:</strong>  ,        BGR.   ,    , ,   ,     .</li>
</ul><br>
<strong>PIXEL_FORMAT_SET</strong><br>
<br>
<ul>
<li><strong>16 bits per pixel:</strong>   16- .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos outros comandos que podem ser enviados na inicializa√ß√£o para controlar v√°rios aspectos, como gama. Os par√¢metros necess√°rios est√£o descritos na especifica√ß√£o do pr√≥prio LCD (e n√£o no controlador ILI9341), ao qual n√£o temos acesso. Se n√£o transmitirmos esses comandos, ser√£o usadas as configura√ß√µes de exibi√ß√£o padr√£o, o que nos conv√©m perfeitamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de preparar uma s√©rie de comandos de inicializa√ß√£o, podemos come√ßar a transferi-los para a tela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, precisamos de uma fun√ß√£o que envie um byte de comando para o display. N√£o esque√ßa que os comandos de envio s√£o diferentes dos par√¢metros de envio, porque precisamos enviar um </font><font style="vertical-align: inherit;">sinal baixo </font><font style="vertical-align: inherit;">para o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BYTES_TO_BITS(value) ( (value) * 8 )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandCode</span><span class="hljs-params">(CommandCode code)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(<span class="hljs-number">1</span>);<font></font>
	transaction.tx_data[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">uint8_t</span>)code;<font></font>
	transaction.flags = SPI_TRANS_USE_TXDATA;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">0</span>);<font></font>
	spi_device_transmit(gSpiHandle, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O IDF possui uma estrutura </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_transaction_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© preenchida quando queremos transferir algo atrav√©s do barramento SPI. Sabemos quantos bits a carga √∫til tem e transferimos a carga propriamente dita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos passar um ponteiro para a carga √∫til ou usar a estrutura struct </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que tem apenas quatro bytes de tamanho, mas evita que o driver </font><strong><font style="vertical-align: inherit;">precise</font></strong><font style="vertical-align: inherit;"> acessar a mem√≥ria externa. Se usarmos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , devemos definir o sinalizador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de transmitir dados, enviamos um </font><font style="vertical-align: inherit;">sinal baixo </font><font style="vertical-align: inherit;">para o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , indicando que este √© um c√≥digo de comando.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandParameters</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* data, <span class="hljs-keyword">int</span> length)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(length);<font></font>
	transaction.tx_buffer = data;<font></font>
	transaction.flags = <span class="hljs-number">0</span>;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">1</span>);<font></font>
	spi_device_transmit(SPIHANDLE, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A passagem de par√¢metros √© semelhante ao envio de um comando, s√≥ que desta vez usamos nosso pr√≥prio buffer ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e enviamos um </font><font style="vertical-align: inherit;">sinal alto </font><font style="vertical-align: inherit;">ao </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para informar ao display que os par√¢metros est√£o sendo transmitidos. </font><font style="vertical-align: inherit;">Al√©m disso, n√£o definimos o sinalizador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque estamos passando nosso pr√≥prio buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o voc√™ pode enviar todos os comandos de inicializa√ß√£o.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ARRAY_COUNT(value) ( sizeof(value) / sizeof(value[0]) )</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> commandCount = ARRAY_COUNT(gStartupCommands);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> commandIndex = <span class="hljs-number">0</span>; commandIndex &lt; commandCount; ++commandIndex)<font></font>
{<font></font>
	StartupCommand* command = &amp;gStartupCommands[commandIndex];<font></font>
<font></font>
	SendCommandCode(command-&gt;code);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (command-&gt;length &gt; <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		SendCommandData(command-&gt;parameters, command-&gt;length);<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Percorremos iterativamente a matriz de comandos de inicializa√ß√£o, passando o c√≥digo de comando primeiro e depois os par√¢metros (se houver).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenho do quadro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s inicializar a exibi√ß√£o, voc√™ pode come√ßar a desenhar nela.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UPPER_BYTE_16(value) ( (value) &gt;&gt; 8u )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOWER_BYTE_16(value) ( (value) &amp; 0xFFu )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Odroid_DrawFrame</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* buffer)</span>
</span>{
	<span class="hljs-comment">// Set drawing window width to (0, LCD_WIDTH)</span>
    <span class="hljs-keyword">uint8_t</span> drawWidth[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_WIDTH), LOWER_BYTE_16(LCD_WIDTH) };<font></font>
	SendCommandCode(COLUMN_ADDRESS_SET);<font></font>
	SendCommandParameters(drawWidth, ARRAY_COUNT(drawWidth));<font></font>
<font></font>
	<span class="hljs-comment">// Set drawing window height to (0, LCD_HEIGHT)</span>
    <span class="hljs-keyword">uint8_t</span> drawHeight[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_HEIGHT), LOWER_BYTE_16(LCD_HEIGHT) };<font></font>
	SendCommandCode(PAGE_ADDRESS_SET);<font></font>
	SendCommandParameters(drawHeight, ARRAY_COUNT(drawHeight));<font></font>
<font></font>
	<span class="hljs-comment">// Send the buffer to the display</span><font></font>
	SendCommandCode(MEMORY_WRITE);<font></font>
	SendCommandParameters(buffer, LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ILI9341 tem a capacidade de redesenhar partes individuais da tela. Isso pode ser √∫til no futuro se notarmos uma queda na taxa de quadros. Nesse caso, ser√° poss√≠vel atualizar apenas as partes alteradas da tela, mas, por enquanto, simplesmente redesenharemos a tela inteira novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para renderizar um quadro, √© necess√°rio definir uma janela de renderiza√ß√£o. Para fazer isso, envie o comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLUMN_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com a largura da janela e o comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAGE_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com a altura da janela. Cada um dos comandos usa quatro bytes do par√¢metro que descrevem a janela na qual executaremos a renderiza√ß√£o. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPPER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOWER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Essas s√£o macros auxiliares para extrair os bytes alto e baixo de um valor de 16 bits. </font><font style="vertical-align: inherit;">Os par√¢metros desses comandos requerem a divis√£o do valor de 16 bits em dois valores de 8 bits, e √© por isso que fazemos isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A renderiza√ß√£o √© iniciada pelo comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_WRITE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e envia para a exibi√ß√£o todos os </font><strong><font style="vertical-align: inherit;">153.600</font></strong><font style="vertical-align: inherit;"> bytes do buffer de quadros por vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem outras maneiras de transferir o buffer de quadros para a tela:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos criar outra tarefa do FreeRTOS (tarefa), respons√°vel por coordenar as transa√ß√µes SPI.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode transferir um quadro n√£o em um, mas em v√°rias transa√ß√µes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode usar a transmiss√£o sem bloqueio, na qual iniciamos o envio e, em seguida, continuamos a executar outras opera√ß√µes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode usar qualquer combina√ß√£o dos m√©todos acima.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por enquanto, usaremos a maneira mais simples: a √∫nica transa√ß√£o de bloqueio. </font><font style="vertical-align: inherit;">Quando o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DrawFrame √©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chamado, a </font><font style="vertical-align: inherit;">transfer√™ncia para a tela √© iniciada e nossa tarefa √© pausada at√© que a transfer√™ncia seja conclu√≠da. </font><font style="vertical-align: inherit;">Se mais tarde descobrirmos que n√£o podemos alcan√ßar uma boa taxa de quadros com esse m√©todo, retornaremos a esse problema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ordem de bytes e RGB565</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma tela t√≠pica (por exemplo, o monitor do seu computador) tem uma profundidade de 24 bits (1,6 milh√£o de cores): 8 bits por vermelho, verde e azul. O pixel √© gravado na mem√≥ria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRRRRGGGGGGGGGBBBBBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O LCD Odroid tem uma profundidade de 16 bits (65 mil cores): 5 bits de vermelho, 6 bits de verde e 5 bits de azul. O pixel √© gravado na mem√≥ria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRGGGGGGGBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este formato √© chamado </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAP_ENDIAN_16(value) ( (((value) &amp; 0xFFu) <span class="hljs-meta-string">&lt;&lt; 8u) | ((value) &gt;&gt; 8u)  )</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RGB565(red, green, blue) ( SWAP_ENDIAN_16( ((red) &lt;&lt; 11u) | ((green) &lt;&lt; 5u) | (blue) ) )</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Defina uma macro que cria uma cor no formato RGB565. Passaremos a ele um byte de vermelho, um byte de verde e um byte de azul. Ele pegar√° os cinco bits mais significativos de vermelho, os seis bits mais significativos de verde e os cinco bits mais significativos de azul. Escolhemos bits altos porque eles cont√™m mais informa√ß√µes que bits baixos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, o ESP32 armazena os dados na ordem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Little Endian</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, o byte menos significativo √© armazenado no endere√ßo de mem√≥ria mais baixo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, o valor de 32 bits </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xDE 0xAD 0xBE 0xEF]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° armazenado na mem√≥ria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xEF 0xBE 0xAD 0xDE]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ao transferir dados para a tela, isso se torna um problema, porque o byte menos significativo ser√° enviado primeiro e o LCD espera receber o byte mais significativo primeiro. </font><strong><font style="vertical-align: inherit;">Definir</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
macro </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWAP_ENDIAN_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para trocar bytes e us√°-lo na macro </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veja como cada uma das tr√™s cores prim√°rias √© descrita no RGB565 e como elas s√£o armazenadas na mem√≥ria ESP32, se voc√™ n√£o alterar a ordem dos bytes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vermelho</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
11111 | 000000 | 00000? -&gt; 11111000 00000000 -&gt; 00000000 11111000 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verde</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 111111 | 00000? -&gt; 00000111 11100000 -&gt; 11100000 00000111 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Azul</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 000000 | 11111? -&gt; 00000000 00011111 -&gt; 00011111 00000000</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos criar uma demonstra√ß√£o simples para assistir ao LCD em a√ß√£o. </font><font style="vertical-align: inherit;">No in√≠cio do quadro, ele esvazia o buffer do quadro para preto e desenha um quadrado de 50x50. </font><font style="vertical-align: inherit;">Podemos mover o quadrado com uma cruz e mudar sua cor com os bot√µes </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
	Odroid_InitializeDisplay();<font></font>
<font></font>
	ESP_LOGI(LOG_TAG, <span class="hljs-string">"Odroid initialization complete - entering main loop"</span>);<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span>* framebuffer = (<span class="hljs-keyword">uint16_t</span>*)heap_caps_malloc(<span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
	assert(framebuffer);<font></font>
<font></font>
	<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> y = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span> color = <span class="hljs-number">0xffff</span>;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">memset</span>(framebuffer, <span class="hljs-number">0</span>, <span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>);<font></font>
<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.left) { x -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.right) { x += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.up) { y -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.down) { y += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.a) { color = RGB565(<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.b) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.start) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>); }<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = y; row &lt; y + <span class="hljs-number">50</span>; ++row)<font></font>
		{<font></font>
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = x; col &lt; x + <span class="hljs-number">50</span>; ++col)<font></font>
			{<font></font>
				framebuffer[<span class="hljs-number">320</span> * row + col] = color;<font></font>
			}<font></font>
		}<font></font>
<font></font>
		Odroid_DrawFrame(framebuffer);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alocamos o buffer de quadros de acordo com o tamanho total da tela: 320 x 240, dois bytes por pixel (cor de 16 bits). </font><font style="vertical-align: inherit;">Usamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que seja alocado na mem√≥ria, que pode ser usada para transa√ß√µes SPI com </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acesso direto √† mem√≥ria (DMA)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O DMA permite que os perif√©ricos SPI acessem o buffer de quadros sem a necessidade de envolvimento da CPU. </font><font style="vertical-align: inherit;">Sem o DMA, as transa√ß√µes SPI levam muito mais tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o realizamos verifica√ß√µes para garantir que a renderiza√ß√£o n√£o ocorra fora das bordas da tela.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seu navegador n√£o suporta v√≠deo HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_3/media/demo.mp4" type="video/mp4"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rasgando forte √© percept√≠vel. Em aplicativos de desktop, a maneira padr√£o de eliminar lacrimejamento √© usar v√°rios buffers. Por exemplo, ao fazer buffer duplo, h√° dois buffers: frontal e traseiro. Enquanto o buffer frontal √© exibido, a grava√ß√£o √© realizada </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
na parte traseira. Ent√£o eles mudam de lugar e o processo se repete. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP32 n√£o possui RAM suficiente com recursos de DMA para armazenar dois buffers de quadro (4 MB de RAM SPI externa, infelizmente, n√£o possui recursos de DMA), portanto, essa op√ß√£o n√£o √© adequada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ILI9341 possui um sinal ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) que informa quando o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VBLANK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acontece, </font><strong><font style="vertical-align: inherit;">para</font></strong><font style="vertical-align: inherit;"> que possamos gravar no display at√© que ele seja desenhado. Mas com o Odroid (ou o m√≥dulo de exibi√ß√£o) esse sinal n√£o est√° conectado, portanto, n√£o podemos acess√°-lo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez possamos encontrar um valor decente, mas por enquanto n√£o o faremos, porque agora nossa tarefa √© simplesmente exibir os pixels na tela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo o c√≥digo fonte pode ser encontrado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid esquem√°tico</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√° jogar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o ESP-IDF: SPI Master</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folha de dados do driver do LCD</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt502518/index.html">Como escalar uma √°rvore</a></li>
<li><a href="../pt502520/index.html">Relat√≥rios em v√≠deo de relat√≥rios mitap sobre an√°lise de produtos</a></li>
<li><a href="../pt502522/index.html">Abrimos o chip de isolamento galv√¢nico com um pequeno transformador dentro</a></li>
<li><a href="../pt502524/index.html">Os psicopatas fazem civiliza√ß√£o</a></li>
<li><a href="../pt502526/index.html">Semana do Stream Online do JUG Ru Group # 2</a></li>
<li><a href="../pt502532/index.html">A revolu√ß√£o no departamento de TI (departamento). Isso √© necess√°rio?</a></li>
<li><a href="../pt502536/index.html">Primeiras impress√µes e principais recursos do MIUI 12</a></li>
<li><a href="../pt502538/index.html">Como criar uma vers√£o antiga do NGINX Ingress Controller e corrigi-la</a></li>
<li><a href="../pt502540/index.html">Alpine.js - continuar namorando</a></li>
<li><a href="../pt502542/index.html">Como ensinamos o Yandex a responder perguntas e economizar usu√°rios 20 mil horas por dia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>