<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏼 🤚🏿 👸 Recettes pour les requêtes SQL en difficulté 🏘️ 🌝 🧔🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelques mois, nous avons annoncé expliquer.tensor.ru , un service public d'analyse et de visualisation des plans de requête PostgreSQL. 
 
 Au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Recettes pour les requêtes SQL en difficulté</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a quelques mois, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous avons annoncé </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expliquer.tensor.ru</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> public </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">d'analyse et de visualisation des plans de requête</font></a><font style="vertical-align: inherit;"> PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours du passé, vous l'avez déjà utilisé plus de 6000 fois, mais l'une des fonctions pratiques pourrait passer inaperçue - ce sont </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des indices structurels</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui ressemblent à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/66/1s/jp661svgeudxc0wvgnzqoyjffbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
écoutez-les et vos demandes "deviendront lisses et soyeuses". :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais sérieusement, bon nombre des situations qui rendent la demande lente et «gloutonne» en termes de ressources </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sont typiques et peuvent être reconnues par la structure et les données du plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, chaque développeur individuel n'aura pas à chercher seul une option d'optimisation, en s'appuyant uniquement sur son expérience - nous pouvons lui dire ce qui se passe ici, quelle pourrait être la raison et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment aborder la solution</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce que nous avons fait. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/br/mr/upbrmra7tcpkdnygwg0abfhbqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons de plus près ces cas - comment ils sont déterminés et quelles recommandations ils conduisent.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une meilleure compréhension du sujet, vous pouvez d'abord écouter le bloc correspondant de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mon rapport sur PGConf.Russia 2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis seulement passer à une analyse détaillée de chaque exemple:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jHqaLp040rY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: index "sous-tri"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Montrez la dernière facture du client "LLC Bell".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Limit<font></font>
   -&gt; Sort<font></font>
      -&gt; Index [Only] Scan [Backward] | Bitmap Heap Scan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez l'index utilisé </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour trier les champs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">1</span> <span class="hljs-comment">--    </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  pk <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    "" </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/nn/u1/wp/nnu1wpmpqryyy3rrpmhpofv1izk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru] Vous</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
pouvez immédiatement remarquer que l'index a soustrait plus de 100 entrées, qui ont ensuite été triées, puis la seule a été laissée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous fixons:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_cli_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli, pk <span class="hljs-keyword">DESC</span>); <span class="hljs-comment">--   </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/gv/ny/ni/gvnyniyvlmcsfk-f2qk4voomvzo.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Même avec un échantillon aussi primitif - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8,5 fois plus rapide et 33 fois moins de lectures</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'effet sera d'autant plus visible que vous aurez de «faits» pour chaque valeur </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note qu'un tel index ne fonctionnera pas comme "préfixe" pas pire que le précédent pour les autres requêtes avec </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, où </font></font><code>pk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y a pas eu de </font><font style="vertical-align: inherit;">tri </font><font style="vertical-align: inherit;">et il n'y en a pas (pour plus de détails, voir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mon article sur la recherche d'index inefficaces</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">En particulier, il fournira un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> normal </font><b><font style="vertical-align: inherit;">pour une clé étrangère explicite</font></b><font style="vertical-align: inherit;"> dans ce domaine.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: intersection d'index (BitmapAnd)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afficher tous les contrats du client LLC Kolokolchik conclus au nom de NAO Buttercup.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapAnd<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index composite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour les champs à la fois à partir de la source ou développez l'un des champs existants à partir du second. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org); <span class="hljs-comment">--   foreign key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  (fk_org, fk_cli) = (<span class="hljs-number">1</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">--    </span></code></pre><br>
<img src="https://habrastorage.org/webt/dh/y4/mz/dhy4mzknpsqyk3ejuetev5mlmiy.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_org_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli);
</code></pre><br>
<img src="https://habrastorage.org/webt/vt/nm/2c/vtnm2csqildllccdfsffjgxu4ya.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici, le gain est moindre, car Bitmap Heap Scan est assez efficace en soi. </font><font style="vertical-align: inherit;">Mais toujours </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 fois plus rapides et 2,5 fois moins de lectures</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: Pool d'index (BitmapOr)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Affichez les 20 premières demandes de traitement «propres» ou non affectées, et leur priorité.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapOr<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION [ALL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour combiner des sous-requêtes pour chacun des blocs de conditions OR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--   1:16  ""</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk); <span class="hljs-comment">--   "  " </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_own = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> <span class="hljs-comment">-- </span>
  fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">-- ...  ""</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
, (fk_own = <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  ""</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/7k/n2/d1/7kn2d1ko1hrbobs44a69hasatcs.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own = <span class="hljs-number">1</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">--   - 20,    </span></code></pre><br>
<img src="https://habrastorage.org/webt/pa/ej/2f/paej2f1lpkzhinvlz64tvf9n8ti.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous avons profité du fait que les 20 enregistrements nécessaires ont été immédiatement reçus dans le premier bloc, donc le second, avec le Bitmap Heap Scan le plus «cher», n'a même pas été effectué - en conséquence </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, 22 fois plus rapide, dans 44 fois moins de lectures</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une histoire plus détaillée sur cette méthode d'optimisation à l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aide d'exemples spécifiques</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut être trouvée dans les articles de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: JOIN JOIN et OR nuisibles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: un récit sur le raffinement itératif de la recherche par nom, ou «Optimisation ici et là»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une version généralisée de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sélection ordonnée par plusieurs clés</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (et pas seulement par la paire const / NULL) a été envisagée dans l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL HowTo: nous écrivons la boucle while directement dans la requête, ou «Elementary three-way»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4: lire beaucoup d'excès</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En règle générale, cela se produit si vous souhaitez «attacher un autre filtre» à une demande existante.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Et vous n'avez pas la même chose, mais </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec des boutons de nacre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">film "Diamond Hand"</font></font></i><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, en modifiant la tâche ci-dessus, affichez les 20 premières applications «critiques» les plus anciennes pour le traitement, quel que soit leur objectif.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; 5 × rows &lt; RRbF --  &gt;80% <font></font>
   &amp;&amp; loops × RRbF &gt; 100 --     100  <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> personnalisé [plus] </font><b><font style="vertical-align: inherit;">avec une clause WHERE</font></b><font style="vertical-align: inherit;"> ou incluez des champs supplémentaires dans l'index.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la condition de filtre est «statique» pour vos tâches - c'est-à-dire qu'elle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'implique pas d'élargir la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> liste de valeurs à l'avenir - il est préférable d'utiliser l'index WHERE. </font><font style="vertical-align: inherit;">Différents statuts booléens / enum entrent bien dans cette catégorie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la condition de filtre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut prendre différentes valeurs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il est préférable d'étendre l'index avec ces champs - comme dans la situation avec BitmapAnd ci-dessus.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own<font></font>
, (random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">50</span>) <span class="hljs-keyword">critical</span>; <span class="hljs-comment">-- 1:50,   ""</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk);<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">critical</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ca/lg/hn/calghnldd9_313mns2a535sjwma.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk)
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">critical</span>; <span class="hljs-comment">--  ""  </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/op/t2/u4/opt2u4yh2mzocmdot9qovn6pzgu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
expliquez.tensor.ru </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">]</font></a><font style="vertical-align: inherit;"> Comme vous pouvez le voir, le filtrage a complètement disparu du plan, et la demande est devenue </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 fois plus rapide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5: Table clairsemée</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diverses tentatives pour créer leur propre file d'attente de tâches de traitement lorsqu'un grand nombre de mises à jour / suppressions d'enregistrements sur la table conduisent à une situation d'un grand nombre d'enregistrements "morts".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Effectuez manuellement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM [FULL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manuellement </font><font style="vertical-align: inherit;">ou réalisez des tests fréquents sous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adéquats en </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">affinant</font></a><font style="vertical-align: inherit;"> ses paramètres, y compris </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour une table spécifique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la plupart des cas, ces problèmes sont causés par des requêtes mal structurées lors d'appels à partir de la logique métier, telles que celles abordées dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: combat des hordes de «morts»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais vous devez comprendre que même VACUUM FULL peut ne pas toujours aider. </font><font style="vertical-align: inherit;">Pour de tels cas, vous devez vous familiariser avec l'algorithme de l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA: lorsque VACUUM passe, nous nettoyons la table manuellement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: lecture à partir du milieu de l'index</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble qu’ils n’aient pas beaucoup lu, et tous par index, et qu’ils n’aient rien filtré de plus - mais de toute façon, beaucoup plus de pages ont été lues que nous le souhaiterions.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinez attentivement la structure de l'index utilisé et les champs clés spécifiés dans la demande - très probablement, une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partie de l'index n'est pas spécifiée</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Très probablement, vous devrez créer un index similaire, mais sans champs de préfixe ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apprendre à itérer sur leurs valeurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli); <span class="hljs-comment">--     #2</span>
<span class="hljs-comment">--      fk_cli      </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">999</span> <span class="hljs-comment">--  fk_org  ,     </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/tl/py/lb/tlpylbllwrea5ilsf-epratclha.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il semble que tout va bien, même par index, mais d'une manière suspecte - pour chacun des 20 enregistrements lus, j'ai dû soustraire 4 pages de données, 32 Ko par enregistrement - n'est-ce pas en gras? </font><font style="vertical-align: inherit;">Oui, et le nom de l'index est </font><font style="vertical-align: inherit;">suggestif. </font><font style="vertical-align: inherit;">
Nous fixons:</font></font><code>tbl_<b>fk_org</b>_fk_cli_idx</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli);</code></pre><br>
<img src="https://habrastorage.org/webt/n9/5x/uz/n95xuzh7tcrmlv3eqg-bq2axhk4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Soudain - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 fois plus rapide et 4 fois moins lu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'autres exemples de situations d'utilisation inefficace des index peuvent être vus dans l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA: Find Useless Indexes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 7: CTE × CTE</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la requête, nous avons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tapé les CTE «gras»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de différentes tables, puis décidé de faire entre eux </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le cas est pertinent pour les versions inférieures à v12 ou les demandes de </font></font><code>WITH MATERIALIZED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; CTE Scan<font></font>
   &amp;&amp; loops &gt; 10<font></font>
   &amp;&amp; loops × (rows + RRbF) &gt; 10000<font></font>
      --     CTE<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysez soigneusement la demande - le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTE est-il nécessaire ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Si tout de même, alors </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appliquez le "déchirement" dans hstore / json</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> selon le modèle décrit dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: frappez le dictionnaire avec un JOIN lourd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 8: échange sur disque (écrit temporairement)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le traitement ponctuel (tri ou personnalisation) d'un grand nombre d'enregistrements ne rentre pas dans la mémoire allouée à cet effet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; temp written &gt; 0</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la quantité de mémoire utilisée par l'opération ne dépasse pas largement la valeur définie du paramètre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_mem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cela vaut la peine de l'ajuster. </font><font style="vertical-align: inherit;">Vous pouvez immédiatement dans la configuration pour tout le monde, mais vous pouvez passer </font></font><code>SET [LOCAL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour une demande / transaction spécifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SHOW</span> work_mem;
<span class="hljs-comment">-- "16MB"</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  random()<font></font>
<span class="hljs-keyword">FROM</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/x-/mu/my/x-mumysko4noy3qy8qhdk0fecpq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> work_mem = <span class="hljs-string">'128MB'</span>; <span class="hljs-comment">--   </span></code></pre><br>
<img src="https://habrastorage.org/webt/h0/4z/kx/h04zkxsgcscgj8yxdasba8jdi2s.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
expliquez.tensor.ru </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">]</font></a><font style="vertical-align: inherit;"> Pour des raisons évidentes, si seulement la mémoire est utilisée, pas un disque, alors la requête sera exécutée beaucoup plus rapidement. </font><font style="vertical-align: inherit;">Dans le même temps, une partie de la charge du disque dur est également supprimée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais vous devez comprendre qu'allouer beaucoup de mémoire ne fonctionne pas toujours non plus - ce ne sera pas suffisant pour tout le monde.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 9: Statistiques non pertinentes</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils se sont déversés beaucoup à la fois dans la base de données, mais n'ont pas réussi à les chasser </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; ratio &gt;&gt; 10</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites de même </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette situation est décrite plus en détail dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: les statistiques sont partout</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 10: «quelque chose s'est mal passé»</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand surgit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait une attente d'un verrou imposé par une demande concurrente, ou il n'y avait pas suffisamment de ressources matérielles CPU / hyperviseur.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment reconnaître</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; (shared hit / 8K) + (shared read / 1K) &lt; time / 1000<font></font>
      -- RAM hit = 64MB/s, HDD read = 8MB/s<font></font>
   &amp;&amp; time &gt; 100ms --  ,   <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommandations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">système</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externe </font><b><font style="vertical-align: inherit;">pour surveiller le</font></b><font style="vertical-align: inherit;"> serveur pour les verrous ou la consommation anormale de ressources. </font><font style="vertical-align: inherit;">A propos de notre version de l'organisation de ce processus pour des centaines de serveurs, nous en avons déjà parlé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/bi/9s/tsbi9svuilrqhgpgftjytkknpk4.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h7/zm/6d/h7zm6d-va_yx8g0mtxbdkyevcwq.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492676/index.html">Mémoire sur les noyaux magnétiques de la fusée Saturn 5</a></li>
<li><a href="../fr492678/index.html">Développement du premier projet sur la plateforme de Microsoft Dynamics 365 For Finance and Operations</a></li>
<li><a href="../fr492682/index.html">La testostérone, pourquoi est-elle pour les hommes et comment maintenir la force dans la vieillesse</a></li>
<li><a href="../fr492684/index.html">Serveur proxy gratuit pour les entreprises avec authentification de domaine</a></li>
<li><a href="../fr492686/index.html">Quand Linux Conntrack n'est plus votre ami</a></li>
<li><a href="../fr492696/index.html">Sur quoi tester les algorithmes de reconnaissance et de traitement des documents d'identité?</a></li>
<li><a href="../fr492700/index.html">Achats déclaratifs sur Internet avec l'API de demande de paiement et Angular</a></li>
<li><a href="../fr492702/index.html">Traduction automatique. De la guerre froide à nos jours</a></li>
<li><a href="../fr492704/index.html">Pour augmenter l'efficacité de la survie des implants de 5 à 7 fois - comment est-ce possible?</a></li>
<li><a href="../fr492706/index.html">Archives de la mémoire: comment le cerveau code et reproduit les souvenirs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>