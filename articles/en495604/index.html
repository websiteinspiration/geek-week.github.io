<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß§ üßúüèº üëºüèª Temporary localization on Symfony 4 + Twig üêÇ üßëüèº‚Äçü§ù‚Äçüßëüèª üïë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The need for temporary localization of the product arises when the product grows to such a scale that requires work in different time zones (evidence)...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Temporary localization on Symfony 4 + Twig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495604/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The need for temporary localization of the product arises when the product grows to such a scale that requires work in different time zones (evidence). </font><font style="vertical-align: inherit;">I would like to describe a variant of a simple idea for solving this case. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The background is this: they developed a niche CRM / ERP system, and then we were told that tomorrow they would work with this system on a franchise from Vladivostok to Kaliningrad. </font><font style="vertical-align: inherit;">Unfortunately, such a scenario was not originally thought out, and we began to learn how to do this with minimal cost and maximum convenience.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In total, three tasks turned out to be enlarged: how we output the data and how we enter, and between them the task how we store it all. Since time, as you know, is relatively literally and figuratively, it was decided to store time as before in Moscow UTC + 3, but process it at the input and output (and keep in mind that the reference point is UTC + 3). Of course, we understood that there are other solutions in this and other directions. You can convert all existing entries to UTC + -0, as well as use specialized types in the DBMS that store the time zone, you can write this custom type yourself, if suddenly the database does not fully support such features. But guided by the principle of simplicity, we went along the proposed path, all the more, at first glance, he did not lose much to the rest,and the logic for determining the desired time zone was quite simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After Moscow became a reference point, we added a custom time zone parameter to each user, as well as a number of related entities (organization, city, applications, transactions, etc.). </font><font style="vertical-align: inherit;">Then it was possible to unambiguously establish in which time zone the user or entity with which he works. </font><font style="vertical-align: inherit;">The logic there is standard and precisely often specific to projects. </font><font style="vertical-align: inherit;">We wrapped this logic in the service and got a time zone where you need to</font></font><br>
<br>
<pre><code class="php hljs">$localizationService-&gt;getTimezone();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The decision to localize dates in the templates was as follows: when initializing Twig extensions, the time zone was changed to the desired one:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Environment $twig, LocalizationService $localizationService</span>) </span>{<font></font>
    $twig-&gt;getExtension(<span class="hljs-string">'Twig_Extension_Core'</span>)-&gt;setTimezone($localizationService-&gt;getTimezone());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our situation was further complicated by the fact that after any date-time is displayed, it is necessary to make a subscript ‚Äú01.01.2020 12:30 (Moscow)‚Äù, so that, for example, in a conditional order / task / transaction that is tied to the time zone, information about the time belt. </font><font style="vertical-align: inherit;">For practical reasons, this is necessary so that a single call center can comfortably work with different time zones within the framework of a task / application / transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the logic for determining the priority of time zones was wired into the aforementioned getTimezone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, we were faced with the fact that if you make your twig filter or function, you will need to change a bunch of templates, but you would like to avoid this. </font><font style="vertical-align: inherit;">Therefore, after a little asking, we decided to redefine the standard twig-filter date</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'date'</span>], [<span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">date</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{<font></font>
    $appendix = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (format &amp;&amp; strpos($format, <span class="hljs-string">'H:i'</span>) !== <span class="hljs-literal">false</span>)<font></font>
        $appendix = <span class="hljs-string">' ('</span>.DateTimeFunctions::getRussianAbbrev(<span class="hljs-keyword">$this</span>-&gt;localizationService-&gt;getTimezone()).<span class="hljs-string">')'</span>;   <font></font>
...<font></font>
    <span class="hljs-comment">//    date   $result</span><font></font>
...<font></font>
   <span class="hljs-keyword">return</span> $result.$appendix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, since we took the standard filter, the old version was redefined:</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'native_date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'nativeDate'</span>], [ <span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeDate</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{
    <span class="hljs-comment">//    date </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The standard date filter code can be found in / twig / twig / lib / Twig / Extension / Core :: twig_date_format_filter. </font><font style="vertical-align: inherit;">Although in fact in most cases a simple, not much different option will do:</font></font><br>
<br>
<pre><code class="php hljs">$date-&gt;setTimeZone($timezone)<font></font>
$result = $date-&gt;format($format);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, you can also fork or redefine the more substantial part of Twig, but if the functionality of the standard filter suits you, you can simply take it out separately and lose nothing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to solve the problem of entering the date-time. </font><font style="vertical-align: inherit;">One solution:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOffsetHours</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $local = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>, <span class="hljs-keyword">new</span> \DateTimeZone(<span class="hljs-keyword">$this</span>-&gt;getTimezone()));<font></font>
    $user = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>);<font></font>
<font></font>
    $localOffset = $local-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
    $globalOffset = $user-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
<font></font>
    $diff = $globalOffset - $localOffset;<font></font>
    <span class="hljs-keyword">return</span> $diff;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toGlobalTime</span>(<span class="hljs-params">\DateTimeInterface $dateTime</span>): \<span class="hljs-title">DateTimeInterface</span> 
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $offsetHours = <span class="hljs-keyword">$this</span>-&gt;getOffsetHours();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ($offsetHours &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify(<span class="hljs-string">'+ '</span>.$offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    } <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>($offsetHours &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify($offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $dateTime;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then call before saving the date-time, for example, in listeners. This option came up to us, since basically the time and date in the project is fixed for certain events, and not entered manually. For another extreme case, where time is constantly introduced through forms, the solution may not be optimal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a bonus. The project uses Omines datatables-bundle to output tables. There the solution was even easier. Instead of DateTimeColumn for localization the following was used:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomDateTimeColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateTimeColumn</span>
</span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> $localizationService;
    <span class="hljs-keyword">private</span> $timeZone;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">LocalizationService $localizationService</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;localizationService = $localizationService;
        <span class="hljs-keyword">$this</span>-&gt;timeZone = $localizationService-&gt;getTimezoneObject();<font></font>
    }<font></font>
    <font></font>
   <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">$value</span>)
    </span>{<font></font>
        $value-&gt;setTimeZone(<span class="hljs-keyword">$this</span>-&gt;timeZone);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::normalize($value);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for your time. </font><font style="vertical-align: inherit;">If someone helps to improve the basic things of the solution, I will be very grateful. </font><font style="vertical-align: inherit;">We are talking about basic ones, since it is clear that the code is vacuum and in reality has a much larger DI and all sorts of goodies for internal use in the project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In summary. </font><font style="vertical-align: inherit;">The idea of ‚Äã‚Äãa simple solution for quick temporary localization of the project is presented. </font><font style="vertical-align: inherit;">It does not depend on versions, or if it does, it is weak. </font><font style="vertical-align: inherit;">This solution successfully migrated from Symfony 4.2 to 5.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495588/index.html">Creating roguelike in Unity from scratch: dungeon generator</a></li>
<li><a href="../en495592/index.html">How to use dictionaries (and not only)</a></li>
<li><a href="../en495594/index.html">Start making money on software: creating mini-digital-business</a></li>
<li><a href="../en495596/index.html">Remote work in the office. RDP, Port Knocking, Mikrotik: simple and safe</a></li>
<li><a href="../en495602/index.html">Starting with Core Data! Difficult in simple words [Part 2]</a></li>
<li><a href="../en495606/index.html">"Social monitoring." Score 1: 0 in our favor</a></li>
<li><a href="../en495608/index.html">[Infographic] Visualization of pandemics in the history of mankind</a></li>
<li><a href="../en495610/index.html">Why the future is not for Python</a></li>
<li><a href="../en495612/index.html">Will Airbnb survive the coronavirus? [spoiler: yes]</a></li>
<li><a href="../en495614/index.html">FFmpeg libav manual</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>