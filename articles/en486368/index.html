<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëßüèø üîü ü§Ø ~ SMAK ~ - programmable controllers for smart homesteads using the asyncio library on MicroPython üë®üèª‚Äçüíª „Ä∞Ô∏è üí∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble
 The use of the Internet of things in rural areas is much wider than home automation, although this, of course, is a matter of terminology - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>~ SMAK ~ - programmable controllers for smart homesteads using the asyncio library on MicroPython</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486368/"><hr><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preamble</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The use of the Internet of things in rural areas is much wider than home automation, although this, of course, is a matter of terminology - what is meant by this. Nevertheless, I conceived the concept of Smart Homestead as a project of rational automation of processes occurring at objects located on the territory of my estate, and sometimes at a decent distance from where I am at one time or another, but at the same time I want to at least be sufficiently confident that what is happening at these objects will not go beyond the boundaries of what is permitted, that I can, if necessary, quickly get an idea of ‚Äã‚Äãthe situation on the estate as a whole and at each controlled object in particular, as well as In your essay, to intervene in the processes are not rushing headlong, to the object that caused my concern,because at this moment I‚Äôm busy with something important, or simply banally cold and too lazy to leave the house.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the implementation of this concept will allow me to deepen my understanding of the use of microcontrollers using the capabilities of MicroPython, which I just like with its illusion of lightness compared to C ++, in which I heroically carried out projects of varying complexity in past lives, as well as implement algorithms, up to which either did not reach hands, or they have not yet been embodied in libraries in high-level languages. This, in fact, determined my interest precisely in my own implementation, without resorting to widespread solutions ranging from well-known manufacturers of the same Xiaomy to specialized applications such as EspHome or frameworks. Although I do not exclude the possibility that, having run through a large and thorny circle of my own design, stuffed with bumps and corns, pretty plucked but certainly not defeated, I will exhale,I‚Äôll spend my hard-earned money on beautifully packaged and designed devices of foreign and Russian production at a very market price and implement the experience gained in existing cloudy and not so monsters like MiHime, Domoticz, IFTT or something else.</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Summarizing - I wanted to take pleasure in the invention of the bicycle, when for this there was, finally, time before the summer suffering, when it was no longer easy to do, but there was no time to think, while servicing my estate. </font><font style="vertical-align: inherit;">I wrote this in order to understand for myself exactly what I want, but in order to give myself the right in advance not to respond to comments that may suggest existing and obviously more comprehensive solutions. </font><font style="vertical-align: inherit;">Although algorithms for solving a particular problem related to the implementation of the plan are very welcome.</font></font><br>
<cut></cut><br>
<hr><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General approach</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The processes occurring at the objects are controlled by programmable controllers, which are expedient to develop for solving local problems, combining them later in a hierarchy, if necessary, by forming wireless connections. Local tasks are solved where it is possible to provide a wired connection or short radio connections with sensors and actuators, using the simplest protocols for exchanging information. The spatial solution consists in the fact that the maximum decision-making burden falls on the controller that controls the leaves of the oriented graph in the form of sensors and devices, which, at the same time, has the ability to send summary information in packaged form to the node of this wireless graph that requested such information.On the Internet, on a phone or other device, it‚Äôs enough for me to see a blank screen, which means that everything is working as usual, but the ability to request details and, in an emergency, intervene in the actions of the final controller should belong to me as the Creator of this space. Security issues and protection from external influences are postponed until later.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The controller itself can already have more powerful communication channels and use more advanced protocols such as MQTT or ZigBee to organize a stable mesh network graph with subsequent access to the Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Currently, the concept is limited by the logic of the programmable controller, taking into account the possibility of its inclusion in a swarm, or, in other words, in a group connected by wireless connections. </font><font style="vertical-align: inherit;">The scope of the controller is an object subject to control and management, by no means a complete list of which I give below:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Greenhouse - temperature, lighting, soil and air humidity</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Garden - watering, soil moisture</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incubator - temperature, humidity, tray rotation, sound</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bruder - temperature, humidity and lighting</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coop - temperature, lighting</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beehive - temperature, humidity, weight and sound (swarm)</font></font></li>
<li> ‚Äì , ,    </li>
<li>  ‚Äì      , </li>
<li>  ‚Äì    , </li>
<li> ‚Äì    , </li>
<li>  ‚Äì  , </li>
<li> ‚Äì   ( )   (, )</li>
<li> ‚Äì  </li>
<li>  ‚Äî </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To describe, research and solve the problem, a metalanguage has been developed that allows us to briefly describe the device drivers used as sources and consumers, delays associated with the processing of information, communication channels through which this information passes, schedules and timers for generating cyclic actions, variables, which contains information essential for the control and management of processes occurring at the facility. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this part, the metalanguage allows you to read the description of the project in a readable form, which will be useful for generating documentation as well as a list of hardware devices and logic expressed in printed circuit boards on which or to which these hardware devices must be connected.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the second part, the metalanguage presents the primitives by which the process is controlled and which are used in the initialization and subsequent analysis of the state of processes controlled by the controller. If there are sufficient resources for the microcontrollers used, this part can be implemented as an interpreter, the input of which is fed with text files describing the initialization of drivers, communication channels, variables and the script itself, which describes the logic of the controller and does not require changing the sewing if the scenario is clarified.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you call an idea, that‚Äôs how it will float, therefore Smart Manor is a Smart Homestead, the birthplace of an idea is Altai, however, Automation is also suitable, although it is a kind of tautology in this context to the definition of Smart and, of course, by means of which using a programmable Controller . Combining the uppercase letters and mixing the English and Russian words, it turned out - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but the Meta Language of the System Description, respectively, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ MEAT ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This culinary concept came out - the application </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ MEAT ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . By the way, the primitive wireless protocol for the interaction of the controller and devices that are not endowed with their own protocols in advance, I called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ JuJu ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The hardware implementation is conceived using the capabilities of ESP8266 and Arduino with RF24 + or other, more modern, but no less cheap - for sensors and actuators - relays, valves, switches, etc., if they cannot be connected directly for any reason, the logic itself try to place the controller on ESP32, and if it fails, on STM32. The goal is to minimize iron costs. I admit the use of hardware implementation of a number of processes such as temperature controllers with hysteresis or air quality measuring instruments, but since I'm not an electronics engineer, developing a circuit using capacitors, resistances and transistors is painful for me and this determines a reasonable balance between hardware and software implementation, and also a desire for direct participation,or at least the contemplation of what is happening in the controller.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The software implementation is based on the syntax of the metalanguage </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ MEAT ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the asyncio library and related algorithms, the general logic </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> described below. The task of controlling the processes occurring at the facility is aimed at maintaining certain operating conditions, as well as to restore these conditions in the event of deviations, moreover, with a stronger deviation, more energetic actions can be used, as well as a response to emergency situations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, the following terminology will be used in the text: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sources (Source) - sensors, incoming communication channels </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consumers - executive devices, outgoing communication channels</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The interaction of Sources and Consumers is described in the Scenario by analyzing the values ‚Äã‚Äãreceived from the sources; status of timers and consumers; values ‚Äã‚Äãof variables; schedules, on the basis of which control commands are issued to consumers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source register is used to store the latest data obtained as a result of a survey of sources, each of which can be interrogated with its own frequency. After updating the data of at least one of the sources, an analysis unit is launched to clarify the operating modes of consumers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The consumer register is used to separate program and physical data in order to implement the mechanism of priority logic for script execution, which consists in the fact that in the process of analyzing the conditions described in the script, conflicting commands to the same device can be issued and the final command will be considered which was recorded last in the script. Thus, by forming a sequence of condition checks in the scenario of the operation of devices, their priority can be formed. Physically, the commands will be executed only after the end of the analysis unit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interrogation of sources and execution of commands by consumers takes place in asynchronous mode, that is, their drivers transfer control to the system planner in anticipation of the moment of inquiry or command, as well as in case of inertia of operation, during which the source or consumer is in a busy state and then subsequent requests are placed turn. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on the type of device, the driver can use more than one information channel, for example, a DHT temperature and humidity sensor uses 2 channels to transmit temperature and humidity, and DS18B20 devices connected to a common bus to control the collector of the warm floor - even more, or an integrated servo drive, controlling several motors or valves at the same time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Driver characteristics include a set of requests and commands specific to the device, the delay time for their execution, as well as the type of communication through which a signal is transmitted, which can be hardware (1Wire, I2C, SPI, UART, etc.) and wireless (WiFi, RF-radio, BT, etc.), which complements the methods for transmitting requests and commands. In addition, the driver provides self-diagnostic modes when it is loaded, actions when it is turned off, and diagnostics of unforeseen conditions during normal operation in asynchronous mode. The driver can run several asynchronous tasks, for example, if feedback on the status of the device is required.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the analysis unit, you can access the registers of sources, consumers, timers and variables, system constants as well as the schedule. </font><font style="vertical-align: inherit;">Ideally, the analysis unit is seen as an interpreter of a simple script description language, represented by a text file, but in the first versions, when writing a script in the firmware code, I will adhere to the basic primitives of this language to generate a more concise presentation of it. </font><font style="vertical-align: inherit;">Currently, the script description language is used to simulate the operation of objects (incubator, brooder, chicken coop, apiary, greenhouse, garden, boiler room, hotel room), determine the required number of devices and their characteristics, which has already proved to be very useful. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further in the plans is the publication of already accumulated and created:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~ - description of general functioning algorithms</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~ - description of metalanguage ~ MEAT ~</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~ - protocol description ~ JuJu ~</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~ - description of requirements for creating device drivers in ~ SMAK ~</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ SMAK ~ - application practice</font></font></li>
</ul></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486354/index.html">Georgy Potapov: ‚ÄúI am a professional OpenStreetMap data consumer‚Äù</a></li>
<li><a href="../en486356/index.html">The Ember Times - Issue 132</a></li>
<li><a href="../en486358/index.html">Transformer in pictures</a></li>
<li><a href="../en486360/index.html">How to migrate from mocha to jest in 15 easy steps - and why</a></li>
<li><a href="../en486362/index.html">How I did not become a product manager after training at Product Univercity Moreynis and Chernyak</a></li>
<li><a href="../en486372/index.html">Czech programmers wrote a site worth 16 million euros for free? Truth?</a></li>
<li><a href="../en486376/index.html">How level designers use architecture theory to create game levels</a></li>
<li><a href="../en486378/index.html">The solar-powered home server worked for 15 months: uptime 95.26%</a></li>
<li><a href="../en486380/index.html">What a Product Manager Should Actually Do</a></li>
<li><a href="../en486382/index.html">Seals and Scrum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>