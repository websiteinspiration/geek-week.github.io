<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ûó üíô ü§òüèª The fight for milliseconds. How to choose the server with the least ping üíØ ü•î üëÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many tasks, delays between the client and server are critical, for example, in online games, video / voice conferences, IP telephony, VPN, etc. If...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The fight for milliseconds. How to choose the server with the least ping</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499878/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For many tasks, delays between the client and server are critical, for example, in online games, video / voice conferences, IP telephony, VPN, etc. </font><font style="vertical-align: inherit;">If the server is too far from the client at the IP network level, then delays (popularly known as ‚Äúping‚Äù, ‚Äúlag‚Äù) will interfere with the work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The geographical proximity of the server is not always equal to the proximity at the IP routing level. </font><font style="vertical-align: inherit;">So, for example, a server in another country may be ‚Äúcloser‚Äù to you than a server in your city. </font><font style="vertical-align: inherit;">All because of the features of routing and networking. </font><font style="vertical-align: inherit;">
How to choose a server as close as possible to all potential customers? </font><font style="vertical-align: inherit;">What is IP network connectivity? </font><font style="vertical-align: inherit;">How to direct the client to the nearest server? </font><font style="vertical-align: inherit;">Let's look at the article.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/la/pd/oi/lapdoiqdxqa-wqitvx0ke920xl8.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We measure delays</font></font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, learn how to measure latency. </font><font style="vertical-align: inherit;">This task is not as simple as it might seem, because for different protocols and packet sizes, delays may vary. </font><font style="vertical-align: inherit;">You can also not notice short-term phenomena, such as failures lasting several milliseconds.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICMP - regular ping</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will use the Unix ping utility, it allows you to manually set the intervals between packages, which the ping version for windows does not know. </font><font style="vertical-align: inherit;">This is important, because if the pauses between packets are long, you just can‚Äôt see what is happening between them. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (option -s) - by default, ping sends packets of size 64 bytes. </font><font style="vertical-align: inherit;">With such small packets, phenomena that occur with large packets may not be noticeable, so we will set the packet size to 1300 bytes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The interval between packets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (option -i) - the time between sending data. </font><font style="vertical-align: inherit;">By default, packets are sent once per second, it takes a very long time, real programs send hundreds and thousands of packets per second, so we set the interval to 0.1 second. </font><font style="vertical-align: inherit;">The program simply does not allow less.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the command looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">ping -s 1300 -i 0.1 yandex.ru
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This design allows you to see a more realistic picture of delays.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ping over UDP and TCP</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In some cases, TCP connections are not handled in the same way as ICMP packets, and because of this, the measurements may differ depending on the protocol. </font><font style="vertical-align: inherit;">It also often happens that the host simply does not respond to ICMP, and regular ping does not work. </font><font style="vertical-align: inherit;">So, for example, the host </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">microsoft.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> makes a lifetime </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">from the developers of the famous nmap scanner can generate any packages. </font><font style="vertical-align: inherit;">It can also be used to measure delays. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since UDP and TCP work on specific ones, we need to "ping" a specific port. </font><font style="vertical-align: inherit;">Let's try to ping TCP 80, that is, the web server port:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ sudo nping --tcp -p 80 --delay 0.1 -c 0 microsoft.com<font></font>
<font></font>
Starting Nping 0.7.80 ( https://nmap.org/nping ) at 2020-04-30 13:07 MSK<font></font>
SENT (0.0078s) TCP 10.0.0.1:63236 &gt; 13.77.161.179:80 S ttl=64 id=49156 iplen=40  seq=3401731188 win=1480<font></font>
SENT (0.1099s) TCP 10.0.0.1:63236 &gt; 13.77.161.179:80 S ttl=64 id=49156 iplen=40  seq=3401731188 win=1480<font></font>
RCVD (0.2068s) TCP 13.77.161.179:80 &gt; 10.0.0.1:63236 SA ttl=43 id=0 iplen=44  seq=1480267007 win=64240 &lt;mss 1440&gt;<font></font>
SENT (0.2107s) TCP 10.0.0.1:63236 &gt; 13.77.161.179:80 S ttl=64 id=49156 iplen=40  seq=3401731188 win=1480<font></font>
RCVD (0.3046s) TCP 13.77.161.179:80 &gt; 10.0.0.1:63236 SA ttl=43 id=0 iplen=44  seq=1480267007 win=64240 &lt;mss 1440&gt;<font></font>
SENT (0.3122s) TCP 10.0.0.1:63236 &gt; 13.77.161.179:80 S ttl=64 id=49156 iplen=40  seq=3401731188 win=1480<font></font>
RCVD (0.4247s) TCP 13.77.161.179:80 &gt; 10.0.0.1:63236 SA ttl=42 id=0 iplen=44  seq=2876862274 win=64240 &lt;mss 1398&gt;<font></font>
<font></font>
Max rtt: 112.572ms | Min rtt: 93.866ms | Avg rtt: 101.093ms<font></font>
Raw packets sent: 4 (160B) | Rcvd: 3 (132B) | Lost: 1 (25.00%)<font></font>
Nping done: 1 IP address pinged in 0.43 seconds<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, nping sends 4 packets and stops. </font><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-c 0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option </font><font style="vertical-align: inherit;">enables the infinite sending of packages. To stop the program, press Ctrl + C. </font><font style="vertical-align: inherit;">At the end, statistics will be shown. </font><font style="vertical-align: inherit;">We see that the average rtt (round-trip time) is 101ms.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTR - traceroute on steroids</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> program </font><font style="vertical-align: inherit;">(English My Traceroute) is an advanced utility for tracing routes to a remote host. </font><font style="vertical-align: inherit;">Unlike the regular system utility traceroute (in windows it is the tracert utility), it can show delays to each host in the packet chain. </font><font style="vertical-align: inherit;">Also knows how to trace routes not only via ICMP, but also via UDP and TCP.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo mtr microsoft.com</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ym/dy/id/ymdyidxtjy3uqco5royohylfk6i.png"></a><br>
<font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Clickable) The interface of the MTR program. </font><font style="vertical-align: inherit;">A route trace has been started to microsoft.com</font></font></sup></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
MTR immediately shows ping to each host in the chain, moreover, the data is constantly updated while the program is running and you can see short-term changes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The screenshot shows that there are packet losses on the No.6 node, but in reality this is not entirely true, because some routers can simply drop packets with expired TTL and not return an error response, so data on packet losses can be ignored here.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WiFi vs cable</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/rg/ut/ul/rgutulxuxjraddrqzzan1xvpkws.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This topic is not entirely relevant to the article, but in my opinion it is very important in the context of delays. I really like WiFi, but if I have even the slightest opportunity to connect a cable to the Internet, I will use it. Also, I always discourage people from using WiFi cameras. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you play serious online shooters, broadcast video streaming, trade on the exchange: please use the Internet via cable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a visual test for comparing WiFi and cable connectivity. This is ping to a WiFi router, that is, not even the Internet. </font><font><sup><font style="vertical-align: inherit;">(Clickable) Comparison of ping to a WiFi router via cable and WiFi</font></sup></font><font style="vertical-align: inherit;"> 
It can be seen that WiFi delays are 1ms longer and sometimes there are packets with delays ten times longer! And this is only a short period of time. In this case, the same router produces stable delays &lt;1ms.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/v5/nv/va/v5nvva7e1hwfakt4lucnahq9rfi.png" alt="image"></a><br>
<font><sup><font style="vertical-align: inherit;"></font></sup></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the example above, WiFi 802.11n at 2.4GHz is used, only a laptop and a phone are connected to the access point via WiFi. </font><font style="vertical-align: inherit;">If there were more customers on the access point, the results would be much worse. </font><font style="vertical-align: inherit;">That is why I am so against the transfer of all office computers to WiFi, if there is the opportunity to reach them with a cable.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP connectivity</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we learned how to measure the delay to the server, try to find the nearest server to us. To do this, we can see how the routing of our provider is arranged. For this, it is convenient to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bgp.he.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">.</font></a></font><br>
<br>
<img src="https://habrastorage.org/webt/8n/yi/yp/8nyiyp-unvpxvw7wlex_1tuxbs8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When entering the site, we see that our IP address belongs to the autonomous system </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AS42610</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking at the connectivity graph of autonomous systems, we can see through which superior providers our provider is connected to the rest of the world. Each of the points is clickable, you can go in and read what kind of provider it is. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/kx/zx/chkxzx30am1a2hm5eu9ktmnq9nu.png"><br>
<font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provider connectivity graph</font></font></sup></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using this tool, you can learn how the channels of any provider are arranged, including hosting. </font><font style="vertical-align: inherit;">See which providers it is connected directly to. </font><font style="vertical-align: inherit;">To do this, drive the server IP into bgp.he.net search and look at the graph of its autonomous system. </font><font style="vertical-align: inherit;">You can also understand how one data center or hosting provider is related to another. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most traffic exchange points provide a special tool called looking glass, which allows you to ping and traceroute from a specific router on the exchange point. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">looking glass</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from MGTS</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, choosing a server, we can see in advance how it will look from different points of traffic exchange. </font><font style="vertical-align: inherit;">And if our potential customers are located in a certain geographical area, we can find the optimal location for the server.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choose the nearest server</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided to simplify the process of finding the optimal server for our customers and made a page with an automatic test of the nearest locations: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUVDS data centers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you enter the page, the script measures the delays from your browser to each server and displays them on an interactive map. </font><font style="vertical-align: inherit;">When you click on a data center, information with test results is displayed. </font><font style="vertical-align: inherit;">
The button leads to the delay test page to all our data centers. </font><font style="vertical-align: inherit;">To see the test results, click on the data center point on the map</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o2/fm/p5/o2fmp5f93v5cz4-4llyammapenc.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ph/9i/ne/ph9inec7gpoqguypuezzjvk1fx4.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499858/index.html">What to do on the weekend: an overview of some board games for those who are tired of blue screens</a></li>
<li><a href="../en499870/index.html">Pylint: a detailed test of the code analyzer</a></li>
<li><a href="../en499872/index.html">Modularity in Java 9</a></li>
<li><a href="../en499874/index.html">Cough Detection on Intel NUC</a></li>
<li><a href="../en499876/index.html">Top 5 classic books to improve financial literacy and prepare for the first steps on the exchange</a></li>
<li><a href="../en499882/index.html">How we select designers and conduct technical interviews</a></li>
<li><a href="../en499884/index.html">11 things I understood about CustDev</a></li>
<li><a href="../en499894/index.html">House of singing things. Chipolo ONE Smart Keychain Tracker Review</a></li>
<li><a href="../en499896/index.html">We are leaving to the remote site correctly: how to organize our work and the work of the project in Telegram?</a></li>
<li><a href="../en499898/index.html">How IT people relate to quarantine, what they do in self-isolation and what they use</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>