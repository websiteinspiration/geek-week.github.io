<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥐 🧜🏿 👨‍🍳 本番環境での3つのKubernetesクラッシュストーリー：反アフィニティ、正常なシャットダウン、Webhook 🚚 🛌🏼 🙏🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=". .: - , Kubernetes. , , , , , .
 
 , , — . , «failure stories»   (  Git-).
 
 №1. kernel panic 
 オリジナル：月光。
 
 1月18日から22日の間、MoonlightのWebサイトとAPIで断続的な誤...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>本番環境での3つのKubernetesクラッシュストーリー：反アフィニティ、正常なシャットダウン、Webhook</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/475026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/_c/ra/y7_cracjhm0ke_mtazml1fhzprk.jpeg"></div><br>
<i><b>. .</b>:   -     ,            Kubernetes.      ,    ,  , ,  ,      .<br>
<br>
 ,     ,   —         . ,         «failure stories»   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a> (   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Git-</a>).</i><a name="habracut"></a><br>
<br>
<h2>№1.  kernel panic    </h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オリジナル：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">月光</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1月18日から22日の間、MoonlightのWebサイトとAPIで断続的な誤動作が発生しました。</font><font style="vertical-align: inherit;">すべてがランダムなAPIエラーで始まり、完全なシャットダウンで終わりました。</font><font style="vertical-align: inherit;">問題は解決され、アプリケーションは通常に戻りました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般情報</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MoonlightはKubernetesと呼ばれるソフトウェアを使用します。</font><font style="vertical-align: inherit;">Kubernetesは、サーバーグループでアプリケーションを実行します。</font><font style="vertical-align: inherit;">これらのサーバーはノードと呼ばれます。</font><font style="vertical-align: inherit;">ノードで実行されているアプリケーションのコピーはポッドと呼ばれます。</font><font style="vertical-align: inherit;">Kubernetesには、どのノードのどのポッドが動作するかを動的に決定するスケジューラがあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">年表</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
金曜日の最初のエラーは、Redisデータベースへの接続の問題に関連しています。 Moonlight APIはRedisを使用して、認証された各リクエストのセッションを検証します。 Kubernetesモニタリングツールが、一部のノードとポッドが応答しないことを通知しました。同時に、Google Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からネットワークサービスの不具合が</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報告され、</font><font style="vertical-align: inherit;">それが問題の原因であると判断しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
週末のトラフィックが減少したため、エラーは一括して解決されたようです。しかし、火曜日の朝、Moonlightのサイトはダウンし、外部トラフィックはクラスターにまったく到達しませんでした。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Twitterで別の人</font></a><font style="vertical-align: inherit;">を見つけまし</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同様の症状で、Googleホスティングにネットワーク障害があると判断しました。</font><font style="vertical-align: inherit;">Google Cloudサポートに連絡したところ、すぐに問題がテクニカルサポートチームに紹介されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Googleテクニカルサポートチームは、Kubernetesクラスター内のノードの動作に何らかのパターンがあることを明らかにしました。</font><font style="vertical-align: inherit;">個々のノードのCPU使用率が100％に達した後、仮想マシンでカーネルパニックが発生し、クラッシュしました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
失敗の原因となったサイクルは次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kubernetesスケジューラーは、同じノードでCPU使用率が高い複数のポッドをホストしていました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ポッドはノード上のすべてのCPUリソースを消費しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 次にカーネルパニックが発生し、ノードがスケジューラに応答しないダウンタイムが発生しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> スケジューラーはすべての落ちたポッドを新しいノードに移動し、プロセスが繰り返され、全体的な状況が悪化しました。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、Redisポッドでエラーが発生しましたが、最終的にはトラフィックを処理するすべてのポッドが落ちて、完全にシャットダウンしました。</font><font style="vertical-align: inherit;">再計画中の指数関数的な遅延により、非アクティブな期間が長くなりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">決定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての主要なデプロイメントに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンチアフィニティルール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">
追加することで、サイトを復元できました</font><font style="vertical-align: inherit;">。ノードにポッドを自動的に分散し、フォールトトレランスとパフォーマンスを向上させます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes自体は、フォールトトレラントなホストシステムとして設計されています。 Moonlightは、安定性を確保するために異なるサーバー上の3つのノードを使用し、トラフィックを処理する各アプリケーションの3つのコピーを実行します。アイデアは、各ノードに1つのコピーを持つことです。この場合、2つのノードで障害が発生しても、ダウンタイムは発生しません。ただし、Kubernetesが同じノード上のサイトで3つのポッドすべてをホストすることがあり、システムにボトルネックが発生しました。同時に、CPUパワーを必要とする他のアプリケーション（つまり、サーバー側のレンダリング）は、別のノードではなく、同じノードで終了しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長時間にわたる高CPU負荷に対処し、ポッドを配置して利用可能なリソースを最大限に活用するには、適切に構成され、適切に機能しているKubernetesクラスターが必要です。</font><font style="vertical-align: inherit;">サーバー上のカーネルパニックの根本的な原因を特定して対処するために、引き続きGoogle Cloudサポートと協力しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アンチアフィニティルールにより、外部トラフィックと連携するアプリケーションの耐障害性が向上します。</font><font style="vertical-align: inherit;">Kubernetesに同様のサービスがある場合は、それらを追加することを検討してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードのOSカーネルの障害の原因を見つけて排除するために、Googleの担当者と引き続き協力しています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番。</font><font style="vertical-align: inherit;">KubernetesおよびIngressエンドポイントの「ダーティ」シークレット</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オリジナル：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ravelinのフィル・パール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エレガンスは過大評価されています</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ravelinの私たちは（GKEで）Kubernetesに移行しました。プロセスは非常に成功しています。ポッド中断の予算はこれまでと同じようにいっぱいで、ステートフルは本当に風格があります</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（翻訳が難しい言い回し：「私たちのステートフルセットは非常に風格があります」-約変換）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。そして、ノードのスライド交換は時計仕掛けのようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パズルの最後のピースは、APIレイヤーを古い仮想マシンからKubernetesクラスターに移動することです。これを行うには、外部からAPIにアクセスできるようにIngressを構成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、タスクは単純に見えました。単にIngressコントローラーを定義し、Terraformを微調整して特定の数のIPアドレスを取得します。Googleは他のほとんどすべてを処理します。そして、これらすべてはまるで魔法のように機能します。クラス！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、時間の経過とともに、統合テストが定期的にエラー502を受け取ることに気付き始めました。これから、私たちの旅が始まりました。</font><font style="vertical-align: inherit;">しかし、私はあなたの時間を節約し、結論に直行します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正常なシャットダウン</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰もがグレースフルシャットダウン（ "グレースフル"、段階的なシャットダウン）について話しています。</font><font style="vertical-align: inherit;">しかし、Kubernetesで彼に依存するべきではありません。</font><font style="vertical-align: inherit;">または、少なくとも、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://golang.org/pkg/net/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">母乳で吸収し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た優雅な閉鎖ではないはず</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">Kubernetesの世界では、このレベルの「優雅さ」は不要であり、深刻な問題で脅かされています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パーフェクト・ワールド</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マジョリティビューがKubernetesのサービスまたはロードバランサーからポッドを削除する方法を次に示します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> レプリケーションコントローラはポッドを削除することを決定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドポイントポッドがサービスまたはロードバランサーから削除されます。</font><font style="vertical-align: inherit;">ポッドへの新しいトラフィックが到着しなくなりました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 事前停止フックが呼び出されるか、ポッドがSIGTERMシグナルを受信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「優雅に」ポッドは切断されています。</font><font style="vertical-align: inherit;">着信接続の受け入れを停止します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 「エレガントな」切断が完了し、既存の接続がすべて停止または終了すると、ポッドは破棄されます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、現実は完全に異なります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現実の世界</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのドキュメンテーションは、すべてが少し異なって起こることを示唆していますが、彼らはそれについてどこにも明示的に書いていません。主な問題は、ステップ3がステップ2の後に続かないことです。それらは同時に発生します。通常のサービスでは、エンドポイントはすぐに削除されるため、問題が発生する可能性は非常に低くなります。ただし、イングレスではすべてが異なります。通常、応答がはるかに遅くなるため、問題が明らかになります。ポッドは、エンドポイントの変更がIngressに入るかなり前にSIGTERMを取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、ポッドに必要なのは正常なシャットダウンではありません。彼は新しい接続を受け取り、それらの処理を続行する必要があります。そうしないと、クライアントは500番目のエラーを受け取り始め、複雑でない展開とスケーリングに関するすばらしいストーリー全体が崩れ始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが実際に起こることです：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> レプリケーションコントローラはポッドを削除することを決定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドポイントポッドがサービスまたはロードバランサーから削除されます。</font><font style="vertical-align: inherit;">Ingressの場合、これには時間がかかる場合があり、新しいトラフィックがポッドに流れ続けます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 事前停止フックが呼び出されるか、ポッドがSIGTERMシグナルを受信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの場合、ポッドはこれを無視し、作業を続行して新しい接続を維持する必要があります。</font><font style="vertical-align: inherit;">可能であれば、別の場所に切り替えるとよいことを顧客に説明する必要があります。</font><font style="vertical-align: inherit;">たとえば、HTTPの場合</font></font><code>Connection: close</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、応答ヘッダーで</font><font style="vertical-align: inherit;">送信さ</font><font style="vertical-align: inherit;">れる</font><font style="vertical-align: inherit;">場合があります</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ポッドは、「エレガントな」待機期間が終了し、SIGKILLによって強制終了された場合にのみ終了します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> この期間が、ロードバランサーの再プログラムにかかる時間よりも長いことを確認してください。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがサードパーティのコードであり、その動作を変更できない場合、実行できる最善の方法は、「エレガント」な期間だけスリープする事前停止フックを追加して、ポッドが何もないかのように動作し続けるようにすることです。発生した。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ナンバー3。</font><font style="vertical-align: inherit;">単純なWebhookがクラスター障害を引き起こした方法</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オリジナル：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetstack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetstackは、Kubernetes上のマルチテナントプラットフォームを顧客に提供します。</font><font style="vertical-align: inherit;">標準のKubernetes構成では満たすことができない特別な要件がある場合があります。</font><font style="vertical-align: inherit;">それらを実装するために、最近、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open Policy Agent</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使い始めました</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このレビューで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトについて詳しく説明し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;"> -約Transl。）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。特別なポリシーを実装するためのアクセスコントローラーとして。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、この統合の設定が不適切なために発生した障害について説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インシデント</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは開発クラスターのウィザードの更新に従事しました。そこでは、さまざまなチームが稼働日にアプリケーションをテストしました。これは、Google Kubernetes Engine（GKE）のeurope-west1ゾーンのリージョンクラスタでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドはアップグレードが進行中であることを警告され、ダウンタイムは予想されませんでした。その日の初めに、別の運用前環境に対して同様の更新を既に行いました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GKE Terraformパイプラインを使用してアップグレードを開始しました。ウィザードの更新は、Terraformタイムアウト（20分に設定）が期限切れになるまで完了しませんでした。これは、問題が発生した最初のウェイクアップコールでしたが、GKEコンソールでは、クラスターはまだ「アップグレード中」と表示されていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パイプラインを再起動すると、次のエラーが発生しました</font></font><br>
<br>
<pre><code class="bash hljs">google_container_cluster.cluster: Error waiting <span class="hljs-keyword">for</span> updating GKE master version:<font></font>
All cluster resources were brought up, but the cluster API is reporting that:<font></font>
component <span class="hljs-string">"kube-apiserver"</span> from endpoint <span class="hljs-string">"gke-..."</span> is unhealthy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回は、APIサーバーとの接続が定期的に中断され始め、チームはアプリケーションをデプロイできませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が起こっているのかを理解しようとしている間に、すべてのノードが無限のサイクルで破壊され、再作成され始めました。</font><font style="vertical-align: inherit;">これにより、すべてのお客様に無差別のサービス拒否が発生しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">失敗の根本原因を特定します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Googleのサポートにより、失敗の原因となった一連のイベントを特定することができました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GKEはウィザードの1つのインスタンスでアップグレードを完了し、次のウィザードが更新されると、そのサーバー上のAPIサーバーへのすべてのトラフィックを受け入れ始めました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップグレード中に、APIマスターサーバーの2番目のインスタンスは</font><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">登録CAの</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostStartHook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実行できませんでした</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このフックの実行中に、APIサーバーはの名前</font></font><code>extension-apiserver-authentication</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ConfigMapを更新しようとし</font><font style="vertical-align: inherit;">ました</font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">構成したOpen Policy Agent（OPA）チェックwebhookのバックエンドが応答しなかったため、これを行うことはできませんでした。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィザードがヘルスチェックに合格するには、この操作が正常に完了する必要があります。</font><font style="vertical-align: inherit;">これが発生しなかったため、2番目のマスターは緊急サイクルに入り、更新を停止しました。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、kubeletがノードの操作を報告できなかったため、APIが定期的にクラッシュしました。</font><font style="vertical-align: inherit;">これにより、GKEノードの自動復元メカニズム</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ノードの自動修復）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がノードを再起動し始めました。</font><font style="vertical-align: inherit;">この機能は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で詳細に説明されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">：</font></font><br>
<br>
<blockquote><i> unhealthy  :     ( 10 )     - .</i></blockquote><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソース</font></font><code>ValidatingAdmissionWebhook</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がAPIサーバーへの断続的なアクセスを引き起こし</font><font style="vertical-align: inherit;">ていることが判明したとき</font><font style="vertical-align: inherit;">、それを削除してクラスターを復元しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それ以来、</font></font><code>ValidatingAdmissionWebhook</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OPA </font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、ポリシーが適用され、開発チームがアクセスできる名前空間のみを監視する</font><font style="vertical-align: inherit;">ように構成さ</font><font style="vertical-align: inherit;">れています。また、webhookのリソースも限られて</font><font style="vertical-align: inherit;">いるため、ポリシー</font></font><code>Ingress</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を適用できるの</font></font><code>Service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこの</font><font style="vertical-align: inherit;">リソース</font><font style="vertical-align: inherit;">だけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にOPAを展開してから、</font><font style="vertical-align: inherit;">この変更を反映するように</font><font style="vertical-align: inherit;">ドキュメントが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新されまし</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、OPAが使用できなくなった場合にOPAが再起動することを確認するための活性テストも追加しました（</font><font style="vertical-align: inherit;">ドキュメントを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適切に修正</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しました）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
切断も検討しました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GKEノードの自動リカバリの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">メカニズムです</font></a><font style="vertical-align: inherit;">が、それでもこのアイデアを放棄することにしました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIサーバーの応答時間に関するアラートを有効</font><font style="vertical-align: inherit;">にした場合、OPA用のWebhookをデプロイした後で</font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も</font></font><code>UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、最初に</font><font style="vertical-align: inherit;">すべてのリクエストのグローバルな増加に気付くことができ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、すべてのワークロードに対してテストをセットアップすることの重要性を強調しています。</font><font style="vertical-align: inherit;">振り返ってみると、OPAの展開は一見単純そうだったので、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘルムチャートに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関与することすらしませんでした</font><font style="vertical-align: inherit;">（当然ですが）。</font><font style="vertical-align: inherit;">チャートは、アドミッションコントローラーを備えたコンテナーのlivenessProbe設定を含め、マニュアルで説明されている基本設定を超える多くの調整を行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはこの問題に遭遇した最初ではありませんでした：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップストリームの問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開いたままです。</font><font style="vertical-align: inherit;">この問題の機能は明らかに改善できます（これについてはフォローアップします）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻訳者からのPS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesのポッドの優先順位がGrafana Labsのダウンタイムをどのように引き起こしたか</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesのある生活から：スペイン人がHTTPサーバーについて文句を言わなかった方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes [およびその解決策]の運用における6つの面白いシステムバグ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのSRE-日常生活からの6つの実用的な物語</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。」</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja475016/index.html">11月22日、RedmadrobotでのQA mitap</a></li>
<li><a href="../ja475018/index.html">列の変更Radiotehnika S-30</a></li>
<li><a href="../ja475020/index.html">現代のテクノロジーが徐々に火の塔に取って代わる方法</a></li>
<li><a href="../ja475022/index.html">建築統合失調症Facebook天秤座</a></li>
<li><a href="../ja475024/index.html">ランニングは、よりリモートな人にとって理想的なスポーツです。パート1：100 kmの最初のレースへの道</a></li>
<li><a href="../ja475028/index.html">ビジネスにおけるMLのonijemeIT株式への適用に関する所見</a></li>
<li><a href="../ja475032/index.html">Gartner Hype Cycle 2019：報告</a></li>
<li><a href="../ja475034/index.html">ArduinoおよびSTM32のブラウザーのグラフ</a></li>
<li><a href="../ja475036/index.html">CassandraからKubernetesへの移行：機能とソリューション</a></li>
<li><a href="../ja475038/index.html">サンクトペテルブルグHSEでの「応用数学とコンピュータサイエンス」の最初のセット：誰であり、どのように扱うか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>