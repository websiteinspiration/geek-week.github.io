<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∂ üë©üèø‚Äçüé§ üéÖüèæ Sensor de movimento e conex√£o de registro de alarme e v√≠deo no Home Assistant no Raspberry pi üë©üèæ‚ÄçüöÄ üßñüèæ üåµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quero falar sobre minha pouca experi√™ncia em trabalhar com o Home Assistant (doravante referido como HA) no Raspberry pi e sobre como conectar a fun√ß√£...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sensor de movimento e conex√£o de registro de alarme e v√≠deo no Home Assistant no Raspberry pi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quero falar sobre minha pouca experi√™ncia em trabalhar com o Home Assistant (doravante referido como HA) no Raspberry pi e sobre como conectar a fun√ß√£o de registro de v√≠deo, sensor de movimento e, portanto, a fun√ß√£o de seguran√ßa em casa para receber imagens por correio no caso de uma opera√ß√£o de "seguran√ßa". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, uma das raz√µes √© o desejo de entender pelos seus coment√°rios que o que eu fiz "fez errado", afinal, implementando esse cen√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem tr√™s maneiras de configurar a funcionalidade acima: "sem problemas", "curto" e "independente". No primeiro caso, voc√™, tendo baixado a imagem final do site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://ViaMyBox.com/downloadpage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o seu Raspberry pi, voc√™ pode ver como tudo fica no formul√°rio j√° configurado. No segundo caso, voc√™ pode baixar o zip do site ou do projeto github, instalar e instalar a imagem do docker HA atrav√©s do utilit√°rio (sudo via-setup.sh) para ver como tudo est√° configurado. E, finalmente, a terceira maneira √© configurar ‚Äútudo do seu jeito‚Äù: pegue algo √∫til no site ou githab do projeto ou neste tutorial. Links para tudo no final do artigo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que voc√™ j√° tenha um Assistente Dom√©stico (HA) em funcionamento. Neste artigo, consideraremos apenas aspectos da forma√ß√£o de configura√ß√µes yaml e uma descri√ß√£o da sequ√™ncia de regras e condi√ß√µes que levam a uma a√ß√£o espec√≠fica, no nosso caso, a conex√£o de "seguran√ßa da casa" e um script que come√ßa a tirar fotos dentro de 5 segundos ap√≥s o sensor de movimento ser acionado. E, como resultado, o Assistente Dom√©stico envia as fotos tiradas por correio. N√£o sou especialista em yaml ou na cria√ß√£o de configura√ß√µes para o Home Assistant, mas, seguindo os exemplos de trabalho, tenho uma configura√ß√£o de trabalho, que quero compartilhar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os arquivos aos quais nos referiremos, explicarei no final do artigo para uma revis√£o mais conveniente. N√£o vou tratar aqui do trabalho de scripts para grava√ß√£o de v√≠deo no bash ou python neste exemplo. Somente Assistente Dom√©stico. Mas se voc√™ tiver d√∫vidas - Bem-vindo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, tudo fica assim para mim (destacado em vermelho que consideraremos no artigo): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3u/ol/s8/3uols87hy7mnocdgbj-k-mfbp-a.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/v9/ib/8s/v9ib8sthumy5p5hphabioyvr1ie.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu uso o Raspberry pi como plataforma. E meu caminho para os arquivos de configura√ß√£o √© / usr / share / hassio / homeassistant /. O caminho para seus arquivos de configura√ß√£o pode ser diferente do meu caminho. Naquela √©poca, eu tinha o Assistente Dom√©stico 0.101.3. Estaremos interessados ‚Äã‚Äãnos arquivos de configura√ß√£o neste diret√≥rio: configuration.yaml e automation.yaml.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s cada altera√ß√£o nesses arquivos, √© importante lembrar que ser√° necess√°rio verificar a configura√ß√£o ap√≥s nossas altera√ß√µes para detectar quaisquer erros nela. Isso √© feito na guia Painel do Home Assistant -&gt; Configura√ß√£o -&gt; Controles do servidor -&gt; Verificar configura√ß√£o. E ent√£o, no mesmo local, recarregamos automa√ß√µes e recarregamos scripts, se a verifica√ß√£o foi bem-sucedida. E, em caso de d√∫vida, o rein√≠cio do Gerenciamento do Servidor na mesma guia atualiza com precis√£o a configura√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sensor de movimento HC-SR501 est√° conectado ao barramento Raspberry pi GPIO. √â necess√°rio conectar corretamente os tr√™s fios de contato ao GPIO, e podemos usar nosso sensor em a√ß√£o. O sensor possui tr√™s contatos: pot√™ncia gcc (+), zero gnd (-), contato de controle (dados). Depois de ler a descri√ß√£o do GPIO, eu os conectei ao meu raspberry da seguinte maneira. Conectei o hc-sr501 ao conector GPIO: pino 2 - 5,5vvcc; pino 26 (13¬™ linha) - contato de dados e pino 6 - gnd (-) do sensor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu uso uma c√¢mera USB ou uma c√¢mera CSI em conjunto com o mjpg-streamer como fonte da foto. Como instalar e configurar o mjpg-streamer no Raspberry pi, n√£o consideraremos aqui. Exemplos de instala√ß√£o r√°pida na Internet muito. No entanto, quero dizer que uso dados </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deste projeto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A instala√ß√£o deste m√≥dulo tamb√©m √© descrita em detalhes aqui. </font><font style="vertical-align: inherit;">Ou use qualquer m√©todo conveniente para voc√™ tirar fotos e v√≠deos. </font><font style="vertical-align: inherit;">Afinal, qual script bash para fixar no HA, em √∫ltima an√°lise, depende de voc√™. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora descreveremos nosso sensor em configuration.yaml, digamos, atrav√©s da linha de comando:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo nano /usr/share/hassio/homeassistant/configuration.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
embora o uso do bloco de notas ++ com winscp possa ser mais conveniente ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descrevemos a sequ√™ncia de configura√ß√µes do HC-SR501 da seguinte maneira:</font></font><br>
<br>
<pre><code class="plaintext hljs">binary_sensor:<font></font>
  - platform: rpi_gpio<font></font>
    #name: HC-SR501<font></font>
    ports:<font></font>
      7: Sensor HC-SR501<font></font>
    invert_logic: false<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note-se que aqui o importante s√£o as configura√ß√µes nas linhas que descrevem a conex√£o com os contatos de controle (dados) dos sensores: pino 7 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
portas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7: Sensor HC-SR501 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Assistente Dom√©stico possui uma ferramenta integrada para ativar a fun√ß√£o de seguran√ßa dom√©stica. </font><font style="vertical-align: inherit;">Vamos descrev√™-lo em nosso configuration.yaml, usando a descri√ß√£o: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.home-assistant.io/integrations/manual</font></font></a><br>
<br>
<pre><code class="plaintext hljs">alarm_control_panel:<font></font>
  - platform: manual<font></font>
    name: Home Alarm<font></font>
    pending_time: 60<font></font>
     delay time 40<font></font>
     triggered:<font></font>
    pending_time: 0<font></font>
    code: 1234<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa configura√ß√£o significa que temos 60 segundos para sair de casa (ap√≥s esse per√≠odo o alarme ser√° ativado) e 40 segundos para deslig√°-lo (com senha 1234) ao retornar para casa. Por alguma raz√£o, voc√™ sempre sai mais do que vem.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, descreveremos o mecanismo para ativar e desativar as fotos pela opera√ß√£o do sensor de movimento em nossa configuration.yaml (mais sobre a plataforma switch - command_line pode ser encontrada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="plaintext hljs"> - platform: command_line<font></font>
   switches:<font></font>
      start_stop_motion_rec_timelapse:<font></font>
        friendly_name: 'Record motion timelapse video'<font></font>
        command_on: 'curl http://localhost/start_mjpgstrm.php  &amp;&amp; curl http://localhost//rec-motion-mjpg.php'<font></font>
        command_off: 'curl http://localhost/stop_mjpgstrm.php &amp;&amp; curl http://localhost/rec-motion-mjpg-stop.php'<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, vinculamos o comando enable command_on e command_off off aos nossos scripts que controlam a grava√ß√£o da c√¢mera. Nesse caso, quando o command_on √© executado, 2 scripts s√£o executados seq√ºencialmente. Isso est√° lan√ßando o mjpg-streamer e disparando a grava√ß√£o do sensor de movimento. O acesso aos scripts bash passa pelo arquivo php do site de trabalho no Raspberry pi. Para fazer isso, configurei o nginx e o acesso √† web e, ao acessar pelo navegador no formato http: // &lt;endere√ßo IP do seu Raspberry pi&gt; /start_mjpgstrm.php, nosso script php deve ser executado. Este script executa mjpg-streamer nesta situa√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o consideramos a configura√ß√£o de acesso √† web neste artigo. Definitivamente, isso n√£o √© seguran√ßa, mas devido ao fato de eu ter HA no docker, me deparei com o fato de eu ter um ambiente de docker isolado e o ‚Äúmundo externo‚Äù do SO que posso ver entrando em contato com meu site atrav√©s do php. Provavelmente, existem v√°rias boas solu√ß√µes de docker ou gurus de HA. Escreva, seria interessante saber! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixarei uma lista desses scripts no artigo, n√£o vamos nos alongar neles. Neste artigo, desejo rastrear apenas a forma√ß√£o da sequ√™ncia de a√ß√µes no Assistente de resid√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso √© colocado no objeto start_stop_motion_rec_timelapse, que ser√° nosso interruptor visual, com o qual controlaremos a grava√ß√£o de fotos quando o sensor de movimento for acionado.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/jb/kz/j4jbkzlnslehtgai7ak93blgqnm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos visualizar esses objetos criados por n√≥s na guia Home Assistant -&gt; Overwiew, alternando a ativa√ß√£o do modo de configura√ß√£o da interface do usu√°rio no canto superior direito. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s5/r8/31/s5r831pi5yqbp6zpph6gy_yen2g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reinicie o HA no navegador na guia "Configuration -&gt; Server Control" para pegar nosso configuration.yaml. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, selecione o sinal de mais amarelo na parte inferior da janela do navegador, clique no cart√£o Entidades e anexe nossos objetos criados aos mapas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/6c/i_/t56ci_fwyo5z_vojj6iywesnwno.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o nosso sensor, selecione a placa do sensor. Ele ficar√° assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hi/h-/9d/hih-9d8acqpf9lxmub8pqpxbm2y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver na figura, no segundo campo da entidade, a op√ß√£o acima √©: switch.start_stop_motion_rec_timelapse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso nos permite ativar e desativar a grava√ß√£o no sensor de movimento, independentemente da inclus√£o da fun√ß√£o "seguran√ßa em casa". E, em geral, j√° deve funcionar depois de todas as a√ß√µes acima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, e consequentemente, o mapa do painel de alarme: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m-/om/ob/m-omobeh7bj-auliurl9abujbhw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° outro ponto interessante. Eu uso o Home Assistant como um cont√™iner de encaixe. Nesse sentido, o caminho para o nosso script ser√° diferente do caminho real para o arquivo de script. Afinal, a estrutura do arquivo dentro do cont√™iner √© virtualizada e conectada √† estrutura real do arquivo atrav√©s dos volumes montados do docker. √â assim: Caminho dentro do cont√™iner: / config / scripts / Caminho dentro do SO: / usr / share / hassio / homeassiatnt / scripts. Portanto, observe as configura√ß√µes do cont√™iner, como esses volumes s√£o configurados no campo Binds. Se voc√™ tem HA.</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo docker inspect homeassistant|less
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o sensor de movimento √© acionado, no momento em que o alarme √© ativado: quero que, al√©m do fato de estarmos iniciando uma fotografia r√°pida (fotos com timelapse), receba um aviso por correio e uma foto. Eu paralelizei os processos. Na primeira foto, o registro (instant√¢neos de timelapse) ocorre alguns segundos ap√≥s o disparo do sensor. Para fazer isso, eu corro mjpg-streamer curl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost / start_mjpgstrm.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , inicio o php: surl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: //localhost/rec-motion-mjpg.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele, por sua vez, executa o script python mov.py. Todos os arquivos e links descritos est√£o no final do artigo por refer√™ncia. E outro script takeSnapshotWebcam.sh tira uma captura instant√¢nea, que eu envio por email. Eu descrevo esses scripts em nosso configuration.yaml assim:</font></font><br>
<br>
<pre><code class="plaintext hljs">shell_command:<font></font>
#      <font></font>
  take_snapshot_webcam: '/config/scripts/takeSnapshotWebcam.sh'<font></font>
#  mjpg-streamer <font></font>
  start_mgpg_streamer: 'curl http://localhost/start_mjpgstrm.php'<font></font>
# mjpg-streamer<font></font>
  stop_mgpg_streamer: 'curl http://localhost/stop_mjpgstrm.php'<font></font>
#      5 <font></font>
  start_motion_rec: 'curl http://localhost/rec-motion-mjpg.php'<font></font>
# <font></font>
  stop_motion_rec: 'curl http://localhost/rec-motion-mjpg-stop.php'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L√°, em configuration.yaml, descrevemos nosso objeto para correspond√™ncia:</font></font><br>
<br>
<pre><code class="plaintext hljs">notify:<font></font>
  - name: ha_sendmail<font></font>
    platform: smtp<font></font>
#    gmail<font></font>
    server: smtp.gmail.com<font></font>
    port: 587<font></font>
    timeout: 15<font></font>
#  <font></font>
    sender: user@gmail.com<font></font>
    encryption: starttls<font></font>
    username: user@gmail.com<font></font>
    password: passwd<font></font>
#  (       ,    )<font></font>
    recipient:<font></font>
      - user@gmail.com<font></font>
    sender_name: My Home Assistant<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ponto importante! </font><font style="vertical-align: inherit;">Para que nosso HA se conecte e envie cartas (campo do remetente), precisamos habilitar o gmail para usar esta caixa em nosso servi√ßo de HA. </font><font style="vertical-align: inherit;">Como fazer isso √© o link aqui: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myaccount.google.com/lesssecureapps</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
E, em seguida, descrevemos o pr√≥prio mecanismo de automa√ß√£o quando o alarme home_alarm √© ativado em automation.yaml:</font></font><br>
<br>
<pre><code class="plaintext hljs">#   (alias) ‚Äú  ,   ‚Äù<font></font>
- alias: 'Trigger alarm while armed away'<font></font>
#alias ,     ‚Äúon‚Äù<font></font>
  trigger: <font></font>
    - platform: state<font></font>
      entity_id: binary_sensor.sensor_hc_sr501<font></font>
      to: 'on'<font></font>
# ,         ‚Äúarmed away‚Äù<font></font>
  condition:<font></font>
    - condition: state<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
      state: armed_away<font></font>
#     <font></font>
  action:<font></font>
# mjpg-streamer ( )<font></font>
    - service: shell_command.start_mgpg_streamer<font></font>
# ,   <font></font>
    - service: shell_command.start_motion_rec<font></font>
#    ‚Äú  ‚Äù   HA   ‚Äú ‚Äù<font></font>
    - service: alarm_control_panel.alarm_trigger<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O seguinte conjunto de condi√ß√µes e a√ß√µes √© enviar uma mensagem do console ao desativar a "seguran√ßa" e desativar nossos scripts de grava√ß√£o de movimento:</font></font><br>
<br>
<pre><code class="plaintext hljs">- alias: 'Send notification when alarm is Disarmed'<font></font>
  trigger:<font></font>
    - platform: state<font></font>
      entity_id: alarm_control_panel.home_alarm<font></font>
      to: 'disarmed'<font></font>
  action:<font></font>
    - service: shell_command.stop_mgpg_streamer<font></font>
    - service: shell_command.stop_motion_rec<font></font>
    - service: persistent_notification.create<font></font>
      data:<font></font>
       message: The alarm is Disarmed at {{ states('sensor.date_time') }}"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E finalmente, o terceiro grupo - enviamos uma carta com uma foto:</font></font><br>
<br>
<pre><code class="plaintext hljs">- alias: 'Send notification when alarm triggered'<font></font>
  trigger: <font></font>
   - platform: state<font></font>
     entity_id: alarm_control_panel.home_alarm<font></font>
     to: 'triggered'<font></font>
  action:<font></font>
    - service: persistent_notification.create<font></font>
      data:<font></font>
       message: Notification when alarm triggered. Motion sensor HC-SR501 detected.<font></font>
    - delay:<font></font>
       seconds: 4<font></font>
#     <font></font>
    - service: script.webcam_snapshot<font></font>
#      configuration.yaml: notify.ha_sendmail<font></font>
    - service: notify.ha_sendmail<font></font>
      data:<font></font>
        title: 'Intruder alert'<font></font>
        message: '{{now().strftime("%H:%M %Y-%m-%d")}}:Notification when alarm triggered. Motion sensor HC-SR501 detected.'<font></font>
        data:<font></font>
           images:<font></font>
#      script.webcam_snapshot  <font></font>
              - /config/camera/snapshot.jpg<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se de que o layout da linha √© importante nos arquivos yaml e os caracteres de espa√ßo antes dos comandos desempenham um papel importante na forma√ß√£o dos blocos de c√≥digo, sua estrutura. </font><font style="vertical-align: inherit;">Verifique todas as altera√ß√µes no yaml atrav√©s da Configura√ß√£o do Assistente Dom√©stico (HA) -&gt; Controles do servidor -&gt; Verifique a configura√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo parece estar, e seu Raspberry pi se torna elegante ... se o raio n√£o travar!) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° - a automa√ß√£o de trabalho HA, Configure com suas pr√≥prias m√£os! </font><font style="vertical-align: inherit;">Certifique-se de escrever para mim o que voc√™ pensa sobre isso! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, se voc√™ ainda ler at√© o fim, ofere√ßo os links prometidos: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://viamybox.com/downloadpage </font></font><br>
</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/viatc/viamybox Os</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
arquivos de configura√ß√£o descritos aqui: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">automation.yaml, configuration.yaml, takeSnapshotWebcam. sh, rec-motion-mjpg.php, mov.py</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt486654/">https://habr.com/ru/post/pt486654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486644/index.html">Antena DIY em 5 minutos</a></li>
<li><a href="../pt486646/index.html">Afaste-se do jQuery para Svelte, sem dor</a></li>
<li><a href="../pt486648/index.html">AWS Lambda em a√ß√£o no Java 11. Indo sem servidor para produ√ß√£o</a></li>
<li><a href="../pt486650/index.html">Mem√≥ria din√¢mica em sistemas r√≠gidos em tempo real</a></li>
<li><a href="../pt486652/index.html">"Cr√≠tica √† raz√£o pura" para programadores</a></li>
<li><a href="../pt486656/index.html">Como adicionar novos personagens ao Unicode: a experi√™ncia do leigo</a></li>
<li><a href="../pt486658/index.html">Moxy Strategy plugin</a></li>
<li><a href="../pt486660/index.html">Ideias da tabela: traje espacial Metro</a></li>
<li><a href="../pt486664/index.html">Corte a caixa. Passagem RE. Metasploit, carregamento no documento do escrit√≥rio, ataque Zip Slip, um pouco sobre o PowerSploit e tokens</a></li>
<li><a href="../pt486666/index.html">Motos de neve, cerveja e derivados do tempo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>