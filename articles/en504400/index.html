<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèæ ‚õ∞Ô∏è üë®üèª‚Äçüè´ Caching. Part 2: 60 days before release üé≠ üèá üë∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I already wrote to you about how to promote initiatives in a corporation. More precisely, how (sometimes) this succeeds, and what difficulties ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Caching. Part 2: 60 days before release</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sportmaster_lab/blog/504400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font><font style="vertical-align: inherit;">I already wrote to you about how to promote initiatives in a corporation. </font><font style="vertical-align: inherit;">More precisely, how (sometimes) this succeeds, and what difficulties may arise: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A rake retrospective. </font><font style="vertical-align: inherit;">How a self-made solution turned out to be cooler than a paid one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How we chose a caching system. </font><font style="vertical-align: inherit;">Part 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today I want to continue and talk about the psychologically most stressful moment in that project, about which the first two articles - when the outcome of the project was determined not so much by the technical skills of the team as confidence in their calculations and willingness to go to the end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have to say - I think that to bring the project to such an intense moment - it's a mistake far used </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">about</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lshaya than any heroism by stretching the project out of this problem ....</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, I do not hide this experience and willingly share it - because I consider:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisely problem areas are growth points</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the biggest problems "arrive" precisely from where you do not expect</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The combination of these points - just obliges you to share the wonderful experience of "how to earn a gutter out of the blue." </font><font style="vertical-align: inherit;">But, it should be noted, a similar situation is exceptional in the Sportmaster company. </font><font style="vertical-align: inherit;">That is, it is possible that this situation will happen again - planning and definition of responsibility now - on a completely different level. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, it seems that introduction is enough, if you are ready - welcome to cat.</font></font><br>
 <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/sa/3o/8k/sa3o8kskmgz_ptdsflpadmiycra.png"></a><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
June 2017 </font><font style="vertical-align: inherit;">We are modifying the admin panel. </font><font style="vertical-align: inherit;">The admin panel is not only a set of forms and tables in the web-interface - the entered values ‚Äã‚Äãneed to be glued with dozens of other data that we get from third-party systems. </font><font style="vertical-align: inherit;">Plus, somehow transform and, ultimately, send it to consumers (the main of which is Sportmaster‚Äôs ElasticSearch site). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main difficulty is just to convert and send. </font><font style="vertical-align: inherit;">Namely:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you need to supply data in the form of json, which weighs 100Kb each, and some pop up for 10MB (scan for the availability and criteria of delivery of goods to stores)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there are json with a structure that has recursive attachments of any level of nesting (for example, a menu inside a menu item, in which there are menu items again, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the final statement is not approved and is constantly changing (for example, work with goods by Models is replaced by an approach when we work by Color Models). </font><font style="vertical-align: inherit;">Constantly - this is several times a week, with a peak rate of 2 times a day for a week.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the first 2 points are purely technical, and are dictated by the task itself, then with the 3rd point, of course, you need to deal with it organizationally. </font><font style="vertical-align: inherit;">But, the real world is far from ideal, so we work with what we have. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namely, they figured out how to quickly rivet web forms and their objects on the server side. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One person from the team was appointed to the role of a professional ‚Äúform slap‚Äù and, using prepared web components, rolled out a demo for ui faster than analysts corrected the drawings of this ui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But in order to change the scheme of transformations, complexity arose here.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we went the usual way - to carry out the transformation in the sql-query to Oracle. There was a DB specialist on the team. It lasted until the moment when the request was 2 pages of continuous sql-text. I could go on and on, but when the changes came from the analysts - objectively, the most difficult thing was to find the place where to make the changes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysts expressed rule in the schemes, which, although they were painted in something detached from the code (something of a visio / draw.io / gliffy), but there were </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">similar to squares and arrows in ETL systems (for example, Pentaho Kettle, which at that time was used to supply data to the Sportmaster website). Now, if we had not an SQL query, but an ETL schema! Then the statement and the solution would be topologically identically expressed, which means that editing the code could take as much time as editing the statement!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But with ETL systems there is another difficulty. The same Pentaho Kettle - is great when you need to create a new index in ElasticSearch, in which to write all the data glued from several sources (remark: in fact, it‚Äôs Pentaho Kettle that doesn‚Äôt work very well, because it doesn‚Äôt use javascript in transformations related to java classes through which the consumer accesses data - because of this, you can write down something that can‚Äôt be turned into the necessary pojo objects, but this is a separate topic, away from the main course of the article). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what to do when in the admin panel the user corrected one field in one document? To deliver this change to Sportmaster‚Äôs ElasticSearch website, do not create a new index into which to fill in all documents of this type, including an updated one!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted that when one object in the input data changed, then send an update </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> site‚Äôs ElasticSearch </font><i><font style="vertical-align: inherit;">only</font></i><font style="vertical-align: inherit;"> for the corresponding output document. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Okay, the input document itself, but after all, according to the transformation scheme, it could be attached to documents of a different type through join! So, you need to analyze the transformation scheme and calculate which output documents will be affected by the change in the data in the sources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The search for boxed products to solve this problem did not lead to anything. Not found. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when they despaired of finding, they figured it out, but how should it work inside, and how can this be done? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea arose right away.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the final ETL can be broken down into its constituent parts, each of which has a certain type from a finite set (for example, filter, join, etc.), then, perhaps, it will be enough to create the same final set of special nodes that correspond to the original ones, but with the difference that they work not with the data itself, but with their change? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In great detail, with examples and key points in the implementation, our solution - I want to cover in a separate article. To deal with supporting positions - this will require serious immersion, the ability to think abstractly and rely on what has not yet been manifested. Indeed, it will be interesting precisely from a mathematical point of view and is interesting only to those Habrovites who are interested in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">technical</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> details.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I will only say that we created a mathematical model in which we described 7 types of nodes and showed that this system is complete - that is, using these 7 types of nodes and the connections between them - any data transformation scheme can be expressed. </font><font style="vertical-align: inherit;">The implementation is based on the active use of obtaining and recording data by key (namely by key, without additional conditions). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, our solution had a strong point regarding all introductory difficulties:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the data must be supplied in the form of json -&gt; we work with pojo objects (plain old java object, if someone did not find the times when such a designation was in use), which are easy to overtake in json</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there are json with a structure that has recursive embeddings of any level of nesting -&gt; again, pojo (the main thing is that there are no loops, but how many levels of nesting is not important, it‚Äôs easy to process in java through recursion)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the final statement is constantly changing -&gt; excellent, since we are changing the transformation scheme faster than analysts draw up (in the diagrams) wishes for experiments</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of the risky moments, only one - we write the solution from scratch, on our own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, the traps were not long in coming.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Special moment N1. </font><font style="vertical-align: inherit;">Trap. </font><font style="vertical-align: inherit;">‚ÄúWell extrapolated‚Äù</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another surprise of an organizational nature was that at the same time as our development, the main master repository was moving to a new version, and the format in which this repository provides data changed. And it would be nice if our system worked immediately with the new storage, and not with the old one. But the new storage is not ready yet. But then, the data structures are known and they can give us a demo stand on which a small amount of related data will be poured. Is going? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here in the product approach, when working with the value supply stream, a warning is unequivocally hammered into all optimists: there is a blocker -&gt; the task doesn‚Äôt work, period.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But then, such a dependence did not even arouse suspicion. Indeed, we were euphoric from the success with the prototype Delta processor - a system for processing data on deltas (implementation of a mathematical model when changes in the output data are calculated using the transformation scheme as a response to a change in the input data). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Among all the transformation schemes, one was the most important. In addition to the fact that the circuit itself was the largest and most complex, there was also a strict requirement for the transformation to be performed according to this circuit - the time limit for execution on the full amount of data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the transformation should be carried out 15 minutes and not a second longer. The main input is a table with 5.5 million records. At the development stage, the table is not yet populated. More precisely, it is filled with a small, test data set in the amount of 10 thousand rows.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, let's get started. In the first implementation, the Delta processor worked on the HashMap as the Key-Value storage (let me remind you, we need to read and write objects a lot by key). Of course, that on production volumes, all intermediate objects will not fit in memory - therefore, instead of HashMap, we switch to Hazelcast. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why exactly Hazelcast - so because this product was familiar, was used in the backend to the site of the Sportmaster. Plus, this is a distributed system and, as it seemed to us - if a friend does something wrong with the performance - we add more instances to a couple of machines and the issue is resolved. In extreme cases - a dozen cars. Horizontal scaling and all things.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, we are launching our Delta processor for a targeted transformation. It works almost instantly. This is understandable - the data is only 10 thousand instead of 5.5 million. Therefore, we multiply the measured time by 550, and we get the result: something about 2 minutes. Fine! In fact - a victory! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This was at the very beginning of the project work - just when you need to decide on the architecture, confirm the hypotheses (conduct tests that confirm them), integrate the pilot solution vertically. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the tests showed an excellent result - that is, we confirmed all the hypotheses, we quickly turned the pilot around - collected a vertically integrated ‚Äúskeleton‚Äù for a small piece of functionality. And they started the main coding - filling the "skeleton with meat."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What successfully and vigorously engaged. Until that beautiful day, when a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set of data </font><font style="vertical-align: inherit;">was uploaded to the master store </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the test on this set. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After 2 minutes did not work. I didn‚Äôt work after 5, 10, 15 minutes either. That is, they did not fit into the necessary framework. But, with whom it does not happen, it will be necessary to tweak something in detail and fit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the test did not work an hour later. And even after 2 hours there was hope that he would work, and we will look for what to tighten up. Remains of hope were even after 5 hours. But, after 10 hours, when they went home, but the test still did not work out - there was no hope anymore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The trouble was that the next day, when they came to the office, the test still diligently continued to work. As a result, it scrolled for 30 hours, did not wait, turned off.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catastrophe! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem was localized quickly enough. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hazelcast - when working on a small amount of data - actually scrolled everything in memory. </font><font style="vertical-align: inherit;">But when it was required to dump data on a disk - performance dipped thousands of times. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Programming would be boring and tasteless occupation, if not for the authorities and the obligation to deliver the finished product. </font><font style="vertical-align: inherit;">So we, literally a day later, after we received a complete set of data - we need to go to the authorities with a report on how the test on production volumes passed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a very serious and difficult choice:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">say ‚Äúas is‚Äù = abandon the project</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">say "as I would like" = to risk, maybe, it is not known whether we can fix the problem</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand what feelings arise in this case, it is only possible to fully invest in the idea, to realize the plan for half a year, to create a product that will help colleagues solve a huge layer of problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, giving up your beloved creation is very difficult. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is characteristic of all people - we love that which we have put a lot of effort into. Therefore, it is hard to hear criticism - you must consciously make efforts to adequately perceive feedback.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, we decided that there are still very, very many different systems that can be used as Key-Value storage, and if Hazelcast does not fit, then something will definitely work. </font><font style="vertical-align: inherit;">That is, they decided to take a chance. </font><font style="vertical-align: inherit;">To our justification, we can say that it was not a ‚Äúbloody deadline‚Äù yet - in general, there was still a margin of time in order to ‚Äúmove‚Äù to a backup solution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At that meeting with the bosses, our manager indicated that ‚Äúthe test showed that the system works stably at production volumes, it does not crash‚Äù. </font><font style="vertical-align: inherit;">Indeed, the system worked stably. </font><u><font style="vertical-align: inherit;">60</font></u><font style="vertical-align: inherit;"> days </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
to release </font><font style="vertical-align: inherit;">.</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Special moment N2. </font><font style="vertical-align: inherit;">Not a trap, but not a discovery. </font><font style="vertical-align: inherit;">‚ÄúLess is more‚Äù</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To find a replacement for Hazelcast with the Key-Value data warehouse role, we compiled a list of all candidates - we got a list of 31 products. This is all that I managed to google and find out from my friends. Further, Google gave out some absolutely obscene options, such as a student's term paper. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To test candidates faster, we prepared a small test that, in a few minutes of launch, showed performance on the right volumes. And they parallelized the work - everyone took the next system from the list, configured, ran the test, took the next. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They worked quickly, snapped several systems a day.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the 18th system, it became clear that this was pointless. Under our load profile - none of these systems is sharpened. They have a lot of ruffles and curtsies to make it convenient to use, many beautiful approaches to horizontal scaling - but this does not give us any profit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We need a system that _fast_ saves the key to an object on disk and quickly reads the key. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If so, we outline the algorithm of how this can be implemented. In general, it seems quite feasible - if at the same time: a) sacrifice the amount of data that will occupy the disk, b) have approximately estimates of the volume and characteristic data sizes in each table. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Something in style, allocate memory (on disk) for objects with a margin, pieces of a fixed maximum volume. Then using the index tables ... and so on ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was lucky that it did not come to this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salvation came in the form of RocksDB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a product from Facebook that is designed for quick reading and saving an array of bytes to disk. At the same time, access to files is provided through an interface that is similar to Key-Value storage. In fact, the key is an array of bytes, the value is an array of bytes. Optimized to do this job quickly and reliably. All. If you need something more beautiful and high-level - screw on top yourself. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exactly what we need!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RocksDB, bolted in the role of Key-Value storage - brought the target test indicator to the level of 5 hours. </font><font style="vertical-align: inherit;">It was far from 15 minutes, but the main thing was done. </font><font style="vertical-align: inherit;">The main thing was to understand what was happening, to understand that writing to disk was as fast as possible, faster than impossible. </font><font style="vertical-align: inherit;">On SSD, in refined tests, RocksDB squeezed 400Mb / s, and that was enough for our task. </font><font style="vertical-align: inherit;">Delays - somewhere in ours, in a binding code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code, which means we can handle it. </font><font style="vertical-align: inherit;">Let's take it apart, but we can handle it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Special moment N3. </font><font style="vertical-align: inherit;">Support. </font><font style="vertical-align: inherit;">"Theoretical calculation"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have an algorithm and input. We take the range of input data, calculate how many actions the system should perform, how these actions are expressed in the JVM run-time costs (assign a value to a variable, enter a method, create an object, copy an array of bytes, etc.), plus how many calls to RocksDB should be held. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to calculations, it turns out that they should meet 2 minutes (approximately, as the test for HashMap showed at the very beginning, but this is just a coincidence - the algorithm has changed since then). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And yet, the test runs for 5 hours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, before the release of </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> days. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a special date - now it will be impossible to collapse - we will not have time to switch to the backup option.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, on this day the project manager is summoned to the authorities. The question is the same - have time, is everything all right? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/ci/ps/ipcipst6tfldoo7vmigaxcmsmta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the best way to describe this situation - an extended cover picture for this article. That is, the bosses are shown that part of the picture that is rendered in the title. But in reality - like that. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although, in reality, of course - we were not at all funny. And say that "Everything is cool!" - this is possible only for a person with a very strong skill in self-mastery. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, huge respect for the manager, for believing, trusting the developers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Really, really available code - shows 5 hours. A theoretical calculation - shows 2 minutes. How can this be believed?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But it‚Äôs possible if: the model is formulated clearly, how to count is understandable, and what values ‚Äã‚Äãto substitute are also understandable. That is, the fact that in reality execution takes more time means that in reality it is not exactly the code that we expect to execute there that is being executed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The central task is to find ‚Äúballast‚Äù in the code. That is, some actions are performed in addition to the main stream of creating the final data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rushed off. Unit tests, functional compositions, fragmentation of functions and localization of places with a disproportionate amount of time spent on execution. A lot of things have been done. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Along the way, we formulated such places where you can seriously tighten up.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, serialization. </font><font style="vertical-align: inherit;">First used the standard java.io. </font><font style="vertical-align: inherit;">But if we fasten Cryo, then in our case we get a 2.5-fold increase in serialization speed and a 3-fold reduction in the amount of serialized data (which means that IO is 3 times smaller, which just eats up the main resources). </font><font style="vertical-align: inherit;">But, in more detail, this is a topic for a separate, technical article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the key point, or ‚Äúwhere the elephant hid‚Äù - I will try to describe in one paragraph.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Special point 4. Reception for finding a solution. </font><font style="vertical-align: inherit;">‚ÄúProblem = Solution‚Äù</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we do get / set by key - in the calculations it went as 1 operation, affects IO in the volume equal to key + object-value (in serialized form, of course). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what if the object itself on which we call get / set is a Map, which we also get by get / set from the disk. How much will the IO be done in this case? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our calculations, this feature was not taken into account. That is, it was considered as 1 IO for key + object-value. But in fact?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in the Key-Value storage, by key-1 there is an obj-1 object with type Map, in which a certain obj-2 object must be stored under the key-2 key. Here we thought that the operation would require an IO for key-2 + obj-2. But in reality, you need to consider obj-1, manipulate it and send it to IO: key-1 + obj-1. And if it is a Map in which there are 1000 objects, then the IO consumption will be about 1000 times more. And if 10,000 objects, then ... That's how they got the "ballast". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a problem is identified, the solution is usually obvious.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, this has become a special structure for manipulations inside nested Map. </font><font style="vertical-align: inherit;">That is, such a Key-Value, which for get / set takes two keys at once, which should be applied sequentially: key-1, key-2 - that is, for the first level and for the nested one. </font><font style="vertical-align: inherit;">How to implement such a structure - I will tell you in detail with pleasure, but again, in a separate, technical article. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, from this episode, I emphasize and promote such a feature: an extremely detailed problem is a good solution.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Completion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I tried to show the organizational points and traps that may arise. </font><font style="vertical-align: inherit;">Such traps are very clearly visible ‚Äúfrom the side‚Äù or over time, but it is very easy to get into them when you first find yourself next to them. </font><font style="vertical-align: inherit;">I hope someone will remember such a description, and at the right moment the reminder will work ‚ÄúI‚Äôve heard something like that somewhere before.‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, most importantly - now that everything is told about the process, about psychological moments, about organizational ones. </font><font style="vertical-align: inherit;">Now that we have an idea of ‚Äã‚Äãwhat tasks and under what conditions the system was created. </font><font style="vertical-align: inherit;">Now - you can and should tell about the system from the technical side - what kind of mathematical model this is, and what tricks in the code we went to, and what innovative solutions we thought of. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About this in the next article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the meantime, Happy New Code!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504374/index.html">Simple graph traversal: depth and breadth-first search using JavaScript as an example</a></li>
<li><a href="../en504382/index.html">How I (PhD Neurobiology) became a Data Scientist in 6 months</a></li>
<li><a href="../en504384/index.html">Gradually introduce TypeScript into your React project</a></li>
<li><a href="../en504386/index.html">Vassbotn H. Class Virtual Variables</a></li>
<li><a href="../en504392/index.html">How many programmers and words do you need to recognize a handwritten passport?</a></li>
<li><a href="../en504402/index.html">May 29th Java Digest</a></li>
<li><a href="../en504408/index.html">Simple and convenient test framework template on selenide for UI autotests</a></li>
<li><a href="../en504412/index.html">Online programming championship "Open Finals of Moscow Training"</a></li>
<li><a href="../en504414/index.html">How Microsoft Killed AppGet</a></li>
<li><a href="../en504420/index.html">Writing a turn-based PvP arena with simultaneous moves</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>