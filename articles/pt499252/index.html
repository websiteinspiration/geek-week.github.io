<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüè´ üßìüèø üôãüèø Criando um jogo de corrida pseudo-tridimensional üë≤üèº üçÑ üì≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quando crian√ßa, raramente ia a sal√µes de fliperama porque n√£o precisava deles, porque tinha jogos incr√≠veis para C64 em casa ... mas h√° tr√™s jogos de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Criando um jogo de corrida pseudo-tridimensional</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499252/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/6e3/cff/d166e3cff9c2a3cefeb68f5c1ddc02d1.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando crian√ßa, raramente ia a sal√µes de fliperama porque n√£o precisava deles, porque tinha jogos incr√≠veis para C64 em casa ... mas h√° tr√™s jogos de arcade para os quais sempre tinha dinheiro - Donkey Kong, Dragons Lair e Outrun ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e eu realmente amei Outrun - velocidade, morros, palmeiras e m√∫sica, mesmo na vers√£o fraca do C64.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48e/aee/56f/48eaee56f43d8a25e840c6ae13268db4.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por isso, decidi tentar escrever um jogo de corrida pseudo-tridimensional da velha escola no estilo da posi√ß√£o Outrun, Pitstop ou Pole. </font><font style="vertical-align: inherit;">N√£o pretendo montar um </font><font style="vertical-align: inherit;">jogo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">completo</font></a><font style="vertical-align: inherit;"> , mas parece-me interessante reexaminar a mec√¢nica com a qual esses jogos realizaram seus truques. </font><font style="vertical-align: inherit;">Curvas, colinas, sprites e uma sensa√ß√£o de velocidade ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, aqui est√° o meu "projeto de fim de semana", que levou cinco ou seis semanas no fim de semana</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ec/27b/d28/7ec27bd28630dbbaf7b81c87233c28ac.png"></div><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jogar um jogo</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo fonte</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vers√£o jog√°vel √© mais uma demonstra√ß√£o t√©cnica do que um jogo real. </font><font style="vertical-align: inherit;">De fato, se voc√™ deseja criar uma verdadeira corrida pseudo-tridimensional, essa ser√° a base mais m√≠nima que voc√™ precisa para gradualmente se transformar em um jogo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© polido, um pouco feio, mas totalmente funcional. </font><font style="vertical-align: inherit;">Vou mostrar como implement√°-lo por conta pr√≥pria em quatro etapas simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m pode jogar</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demonstra√ß√£o de estrada direta</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demo com curvas</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demo com as colinas</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vers√£o finalizada</font></font></a></li>
</ul><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre desempenho</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O desempenho deste jogo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© muito</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dependente da m√°quina / navegador. </font><font style="vertical-align: inherit;">Nos navegadores modernos, funciona bem, especialmente naqueles com acelera√ß√£o de GPU de tela, mas um driver gr√°fico ruim pode congelar. </font><font style="vertical-align: inherit;">No jogo, voc√™ pode alterar a resolu√ß√£o e a dist√¢ncia de renderiza√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre a estrutura do c√≥digo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aconteceu que o projeto foi implementado em Javascript (devido √† simplicidade da prototipagem), mas n√£o se destina a demonstrar as t√©cnicas ou t√©cnicas recomendadas de Javascript. </font><font style="vertical-align: inherit;">De fato, para facilitar a compreens√£o, o Javascript de cada exemplo √© incorporado diretamente na p√°gina HTML (horror!); </font><font style="vertical-align: inherit;">pior, ele usa vari√°veis ‚Äã‚Äãe fun√ß√µes globais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se eu estivesse criando um jogo real, o c√≥digo seria muito mais estruturado e simplificado, mas como essa √© uma demonstra√ß√£o t√©cnica de um jogo de corrida, decidi seguir o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KISS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1. Estradas retas.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, como come√ßamos a criar um jogo de corrida pseudo-tridimensional? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, precisamos</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repita a trigonometria</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembre-se do b√°sico da proje√ß√£o em 3D</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um loop de jogo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixar imagens de sprite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Construir geometria da estrada</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderizar plano de fundo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderize a estrada</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderizar carro</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementar suporte de teclado para controle da m√°quina</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas antes de come√ßarmos, vamos ler </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a Pseudo 3d Page de Lou</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tradu√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Habr√©] - a √∫nica fonte de informa√ß√£o (que eu pude encontrar) sobre como criar o jogo de corrida psevdotrohmernuyu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terminou de ler o artigo de Lou? </font><font style="vertical-align: inherit;">Bem! </font><font style="vertical-align: inherit;">Criaremos uma varia√ß√£o de sua t√©cnica Realistic Hills Using 3d-Projected Segments. </font><font style="vertical-align: inherit;">Faremos isso gradualmente nas pr√≥ximas quatro partes. </font><font style="vertical-align: inherit;">Mas come√ßaremos agora, com a vers√£o v1, e criaremos uma geometria de estrada reta muito simples projetando-a em um elemento de tela HTML5.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A demo pode ser vista </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de trigonometria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßarmos a implementa√ß√£o, vamos usar o b√°sico da trigonometria para lembrar como projetar um ponto no mundo 3D em uma tela 2D. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso mais simples, se voc√™ n√£o tocar em vetores e matrizes, a lei de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tri√¢ngulos semelhantes √©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usada para proje√ß√£o em 3D </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usamos a seguinte nota√ß√£o:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = altura da c√¢mera</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = dist√¢ncia da c√¢mera √† tela</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = dist√¢ncia da c√¢mera ao carro</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = tela </font><strong><font style="vertical-align: inherit;">y</font></strong><font style="vertical-align: inherit;"> coordenada</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o podemos usar a lei de tri√¢ngulos semelhantes para calcular </font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y = h * d / z</font></font></strong></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como mostrado no diagrama:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/949/0ab/47b/9490ab47bb570b61218e46e5913c18bb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m pode desenhar um diagrama semelhante em uma vista superior, em vez de uma vista lateral, e derivar uma equa√ß√£o semelhante para calcular a coordenada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da </font><font style="vertical-align: inherit;">tela:</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x = w * d / z</font></font></strong></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Onde </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">w</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = metade da largura da estrada (da c√¢mera at√© a beira da estrada). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , escalamos por um fator</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d / z</font></font></strong></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistemas coordenados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na forma de um diagrama, parece bonito e simples, mas quando voc√™ come√ßa a codificar, pode ficar um pouco confuso, porque escolhemos nomes arbitr√°rios e n√£o est√° claro o que indicamos as coordenadas do mundo 3D e quais s√£o as coordenadas da tela 2D. </font><font style="vertical-align: inherit;">Tamb√©m assumimos que a c√¢mera est√° no centro da origem do mundo, embora na realidade ela siga a m√°quina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ se aproximar mais formalmente, precisamos executar:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convers√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de coordenadas mundiais em coordenadas de tela</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projetar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as coordenadas da c√¢mera em um plano de proje√ß√£o normalizado</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escalando as</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coordenadas projetadas para as coordenadas da tela f√≠sica (no nosso caso, isso √© tela)</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b59/5d2/30f/b595d230f4f45b9b0c9409266d5804d8.png"></div><br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: no atual sistema 3d </font><font style="vertical-align: inherit;">, o </font><font style="vertical-align: inherit;">est√°gio de </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rota√ß√£o</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© realizado entre os est√°gios 1 e 2 </font><font style="vertical-align: inherit;">, mas, como simularemos as curvas, n√£o precisamos de rota√ß√£o.</font></font></em></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proje√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As equa√ß√µes formais de proje√ß√£o podem ser representadas da seguinte forma:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/edb/246/e18/edb246e187e7fe0eb027b53c58790c34.png"></div><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ponto das equa√ß√µes de convers√£o ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transla√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) √© calculado em rela√ß√£o √† c√¢mara</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As equa√ß√µes de proje√ß√£o ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projeto</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) s√£o varia√ß√µes da ‚Äúlei dos tri√¢ngulos semelhantes‚Äù mostrada acima.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equa√ß√µes de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escala</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><strong><font style="vertical-align: inherit;">escala</font></strong><font style="vertical-align: inherit;"> ) levam em considera√ß√£o a diferen√ßa entre:</font></font><br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matem√°tica</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde 0,0 est√° no centro e o eixo y est√° elevado, e</font></font></li>
<li><em></em>,  0,0     ,   y  :</li>
</ul></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/11f/050/aad/11f050aadea0d1c537baefcb06f7c2f0.png"></div><br>
<blockquote><em>:   3d-         <code>Vector</code>  <code>Matrix</code>     3d-,      ,      WebGL (  )‚Ä¶       .           Outrun.</em></blockquote><br>
<h2>  </h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3b7/27b/1bd/3b727b1bdb285d874bd659c29db13522.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima pe√ßa do quebra-cabe√ßa ser√° uma maneira de calcular </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a dist√¢ncia da c√¢mera ao plano de proje√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de apenas escrever um valor fixo de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , seria mais √∫til calcul√°-lo a partir do campo de vis√£o vertical desejado. </font><font style="vertical-align: inherit;">Gra√ßas a isso, poderemos "ampliar" a c√¢mera, se necess√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se assumirmos que estamos projetando em um plano de proje√ß√£o normalizado, cujas coordenadas est√£o no intervalo de -1 a +1, ent√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser calculado da seguinte forma:</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 1 / tan (fov / 2)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definir fov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como uma (de muitas) vari√°veis, podemos ajustar o escopo para ajustar o algoritmo de renderiza√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura de c√≥digo Javascript</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo do artigo, eu j√° disse que o c√≥digo n√£o est√° de acordo com as diretrizes para escrever Javascript - √© uma demonstra√ß√£o "r√°pida e suja", com vari√°veis ‚Äã‚Äãe fun√ß√µes globais simples. </font><font style="vertical-align: inherit;">No entanto, como vou criar quatro vers√µes separadas (retas, curvas, morros e sprites), armazenarei alguns m√©todos reutiliz√°veis ‚Äã‚Äãdentro </font></font><code>common.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos seguintes m√≥dulos:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dom</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o algumas fun√ß√µes auxiliares menores do DOM.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Util</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - utilit√°rios gerais, principalmente fun√ß√µes matem√°ticas auxiliares.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jogo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fun√ß√µes de suporte de jogos gerais, como downloader imagem e loop do jogo.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fun√ß√µes de renderiza√ß√£o auxiliar na tela.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explicarei em detalhes os m√©todos </font></font><code>common.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas se eles se relacionarem com o jogo em si, e n√£o forem apenas fun√ß√µes matem√°ticas ou DOM auxiliares. </font><font style="vertical-align: inherit;">Felizmente, a partir do nome e do contexto, ficar√° claro o que os m√©todos devem fazer.</font></font><br>
<br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como de costume, o c√≥digo fonte est√° na documenta√ß√£o final.</font></font></em></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loop de jogo simples</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de renderizar algo, precisamos de um loop de jogo. </font><font style="vertical-align: inherit;">Se voc√™ leu algum dos meus artigos anteriores sobre jogos ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pong</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">breakout</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cobras</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boulderdash</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), ent√£o voc√™ j√° viu exemplos do meu ciclo de jogo favorito com um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempo fixo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o vou me aprofundar nos detalhes e simplesmente reutilizar parte do c√≥digo dos jogos anteriores para criar um loop de jogo com uma etapa de tempo fixo usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requestAnimationFrame</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio √© que cada um dos meus quatro exemplos pode chamar </font></font><code>Game.run(...)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e usar suas pr√≥prias vers√µes</font></font><br>
<br>
<ul>
<li><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Atualizando o mundo do jogo com uma etapa de tempo fixo.</font></font></li>
<li><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Atualizando o mundo do jogo quando o navegador permitir.</font></font></li>
</ul><br>
<pre><code class="javascript hljs">run: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{<font></font>
<font></font>
  Game.loadImages(options.images, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">images</span>) </span>{<font></font>
<font></font>
    <span class="hljs-keyword">var</span> update = options.update,    <span class="hljs-comment">// method to update game logic is provided by caller</span>
        render = options.render,    <span class="hljs-comment">// method to render the game is provided by caller</span>
        step   = options.step,      <span class="hljs-comment">// fixed frame step (1/fps) is specified by caller</span>
        now    = <span class="hljs-literal">null</span>,<font></font>
        last   = Util.timestamp(),<font></font>
        dt     = <span class="hljs-number">0</span>,<font></font>
        gdt    = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frame</span>(<span class="hljs-params"></span>) </span>{<font></font>
      now = Util.timestamp();<font></font>
      dt  = <span class="hljs-built_in">Math</span>.min(<span class="hljs-number">1</span>, (now - last) / <span class="hljs-number">1000</span>); <span class="hljs-comment">// using requestAnimationFrame have to be able to handle large delta's caused when it 'hibernates' in a background or non-visible tab</span><font></font>
      gdt = gdt + dt;<font></font>
      <span class="hljs-keyword">while</span> (gdt &gt; step) {<font></font>
        gdt = gdt - step;<font></font>
        update(step);<font></font>
      }<font></font>
      render();<font></font>
      last = now;<font></font>
      requestAnimationFrame(frame);<font></font>
    }<font></font>
    frame(); <span class="hljs-comment">// lets get this party started</span><font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Novamente, este √© um remake de id√©ias dos meus jogos de tela anteriores. Portanto, se voc√™ n√£o entender como o loop do jogo funciona, volte para um dos artigos anteriores.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagens e sprites</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes do in√≠cio do ciclo do jogo, carregamos duas planilhas separadas (planilhas):</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plano de fundo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tr√™s camadas de paralaxe para o c√©u, colinas e √°rvores</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sprites</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><strong><font style="vertical-align: inherit;">sprites de</font></strong><font style="vertical-align: inherit;"> m√°quinas (mais √°rvores e outdoors a serem adicionados √† vers√£o final)</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6f/111/acc/f6f111accbba448459e25c6fe761ff05.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A folha de sprite foi gerada usando uma pequena tarefa Rake and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruby Gem sprite-factory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa tarefa gera as folhas de sprite combinadas, bem como as coordenadas x, y, w, h, que ser√£o armazenadas nas constantes </font></font><code>BACKGROUND</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>SPRITES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: Criei os fundos usando o Inkscape, e a maioria dos sprites s√£o gr√°ficos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retirados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da vers√£o antiga do Outrun para Genesis e usados ‚Äã‚Äãcomo exemplos de treinamento.</font></font></em></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vari√°veis ‚Äã‚Äãdo jogo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m das imagens de planos de fundo e sprites, precisaremos de v√°rias vari√°veis ‚Äã‚Äãde jogo, a saber:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> fps           = <span class="hljs-number">60</span>;                      <span class="hljs-comment">// how many 'update' frames per second</span>
<span class="hljs-keyword">var</span> step          = <span class="hljs-number">1</span>/fps;                   <span class="hljs-comment">// how long is each frame (in seconds)</span>
<span class="hljs-keyword">var</span> width         = <span class="hljs-number">1024</span>;                    <span class="hljs-comment">// logical canvas width</span>
<span class="hljs-keyword">var</span> height        = <span class="hljs-number">768</span>;                     <span class="hljs-comment">// logical canvas height</span>
<span class="hljs-keyword">var</span> segments      = [];                      <span class="hljs-comment">// array of road segments</span>
<span class="hljs-keyword">var</span> canvas        = Dom.get(<span class="hljs-string">'canvas'</span>);       <span class="hljs-comment">// our canvas...</span>
<span class="hljs-keyword">var</span> ctx           = canvas.getContext(<span class="hljs-string">'2d'</span>); <span class="hljs-comment">// ...and its drawing context</span>
<span class="hljs-keyword">var</span> background    = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// our background image (loaded below)</span>
<span class="hljs-keyword">var</span> sprites       = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// our spritesheet (loaded below)</span>
<span class="hljs-keyword">var</span> resolution    = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// scaling factor to provide resolution independence (computed)</span>
<span class="hljs-keyword">var</span> roadWidth     = <span class="hljs-number">2000</span>;                    <span class="hljs-comment">// actually half the roads width, easier math if the road spans from -roadWidth to +roadWidth</span>
<span class="hljs-keyword">var</span> segmentLength = <span class="hljs-number">200</span>;                     <span class="hljs-comment">// length of a single segment</span>
<span class="hljs-keyword">var</span> rumbleLength  = <span class="hljs-number">3</span>;                       <span class="hljs-comment">// number of segments per red/white rumble strip</span>
<span class="hljs-keyword">var</span> trackLength   = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// z length of entire track (computed)</span>
<span class="hljs-keyword">var</span> lanes         = <span class="hljs-number">3</span>;                       <span class="hljs-comment">// number of lanes</span>
<span class="hljs-keyword">var</span> fieldOfView   = <span class="hljs-number">100</span>;                     <span class="hljs-comment">// angle (degrees) for field of view</span>
<span class="hljs-keyword">var</span> cameraHeight  = <span class="hljs-number">1000</span>;                    <span class="hljs-comment">// z height of camera</span>
<span class="hljs-keyword">var</span> cameraDepth   = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// z distance camera is from screen (computed)</span>
<span class="hljs-keyword">var</span> drawDistance  = <span class="hljs-number">300</span>;                     <span class="hljs-comment">// number of segments to draw</span>
<span class="hljs-keyword">var</span> playerX       = <span class="hljs-number">0</span>;                       <span class="hljs-comment">// player x offset from center of road (-1 to 1 to stay independent of roadWidth)</span>
<span class="hljs-keyword">var</span> playerZ       = <span class="hljs-literal">null</span>;                    <span class="hljs-comment">// player relative z distance from camera (computed)</span>
<span class="hljs-keyword">var</span> fogDensity    = <span class="hljs-number">5</span>;                       <span class="hljs-comment">// exponential fog density</span>
<span class="hljs-keyword">var</span> position      = <span class="hljs-number">0</span>;                       <span class="hljs-comment">// current camera Z position (add playerZ to get player's absolute Z position)</span>
<span class="hljs-keyword">var</span> speed         = <span class="hljs-number">0</span>;                       <span class="hljs-comment">// current speed</span>
<span class="hljs-keyword">var</span> maxSpeed      = segmentLength/step;      <span class="hljs-comment">// top speed (ensure we can't move more than 1 segment in a single frame to make collision detection easier)</span>
<span class="hljs-keyword">var</span> accel         =  maxSpeed/<span class="hljs-number">5</span>;             <span class="hljs-comment">// acceleration rate - tuned until it 'felt' right</span>
<span class="hljs-keyword">var</span> breaking      = -maxSpeed;               <span class="hljs-comment">// deceleration rate when braking</span>
<span class="hljs-keyword">var</span> decel         = -maxSpeed/<span class="hljs-number">5</span>;             <span class="hljs-comment">// 'natural' deceleration rate when neither accelerating, nor braking</span>
<span class="hljs-keyword">var</span> offRoadDecel  = -maxSpeed/<span class="hljs-number">2</span>;             <span class="hljs-comment">// off road deceleration is somewhere in between</span>
<span class="hljs-keyword">var</span> offRoadLimit  =  maxSpeed/<span class="hljs-number">4</span>;             <span class="hljs-comment">// limit when off road deceleration no longer applies (e.g. you can always go at least this speed even when off road)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns deles podem ser personalizados usando os controles da interface do usu√°rio para alterar valores cr√≠ticos durante a execu√ß√£o do programa, para que voc√™ possa ver como eles afetam a renderiza√ß√£o da estrada. </font><font style="vertical-align: inherit;">Outros s√£o recalculados dos valores da interface do usu√°rio personalizados no m√©todo </font></font><code>reset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s gerenciamos Ferrari</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizamos combina√ß√µes de teclas </font></font><code>Game.run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que fornece uma entrada simples do teclado que define ou redefine vari√°veis ‚Äã‚Äãque relatam as a√ß√µes atuais do jogador:</font></font><br>
<br>
<pre><code class="javascript hljs">Game.run({<font></font>
  ...<font></font>
  keys: [<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.LEFT,  KEY.A], <span class="hljs-attr">mode</span>: <span class="hljs-string">'down'</span>, <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyLeft   = <span class="hljs-literal">true</span>;  } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.RIGHT, KEY.D], <span class="hljs-attr">mode</span>: <span class="hljs-string">'down'</span>, <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyRight  = <span class="hljs-literal">true</span>;  } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.UP,    KEY.W], <span class="hljs-attr">mode</span>: <span class="hljs-string">'down'</span>, <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyFaster = <span class="hljs-literal">true</span>;  } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.DOWN,  KEY.S], <span class="hljs-attr">mode</span>: <span class="hljs-string">'down'</span>, <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keySlower = <span class="hljs-literal">true</span>;  } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.LEFT,  KEY.A], <span class="hljs-attr">mode</span>: <span class="hljs-string">'up'</span>,   <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyLeft   = <span class="hljs-literal">false</span>; } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.RIGHT, KEY.D], <span class="hljs-attr">mode</span>: <span class="hljs-string">'up'</span>,   <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyRight  = <span class="hljs-literal">false</span>; } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.UP,    KEY.W], <span class="hljs-attr">mode</span>: <span class="hljs-string">'up'</span>,   <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keyFaster = <span class="hljs-literal">false</span>; } },<font></font>
    { <span class="hljs-attr">keys</span>: [KEY.DOWN,  KEY.S], <span class="hljs-attr">mode</span>: <span class="hljs-string">'up'</span>,   <span class="hljs-attr">action</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ keySlower = <span class="hljs-literal">false</span>; } }<font></font>
  ],<font></font>
  ...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O estado do jogador √© controlado pelas seguintes vari√°veis:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">velocidade</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><strong><font style="vertical-align: inherit;">velocidade</font></strong><font style="vertical-align: inherit;"> atual.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">position</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a posi√ß√£o Z atual na pista. </font><font style="vertical-align: inherit;">Note que esta √© uma posi√ß√£o de c√¢mera, n√£o uma Ferrari.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">playerX</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - posi√ß√£o atual do jogador em X na estrada. </font><font style="vertical-align: inherit;">Normalizado no intervalo de -1 a +1, para n√£o depender do valor real </font></font><code>roadWidth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas vari√°veis ‚Äã‚Äãs√£o definidas dentro do m√©todo </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que executa as seguintes a√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atualiza√ß√µes </font></font><code>position</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">baseadas no atual </font></font><code>speed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atualiza√ß√µes </font></font><code>playerX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quando voc√™ pressiona a tecla esquerda ou direita.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumenta </font></font><code>speed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a tecla para cima for pressionada.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diminui </font></font><code>speed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a tecla para baixo for pressionada.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduz </font></font><code>speed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se as teclas para cima e para baixo n√£o forem pressionadas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduz </font></font><code>speed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se </font></font><code>playerX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localizado fora da beira da estrada e na grama.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso de estradas diretas, o m√©todo √© </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bastante claro e simples:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params">dt</span>) </span>{<font></font>
<font></font>
  position = Util.increase(position, dt * speed, trackLength);<font></font>
<font></font>
  <span class="hljs-keyword">var</span> dx = dt * <span class="hljs-number">2</span> * (speed/maxSpeed); <span class="hljs-comment">// at top speed, should be able to cross from left to right (-1 to 1) in 1 second</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (keyLeft)<font></font>
    playerX = playerX - dx;<font></font>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyRight)<font></font>
    playerX = playerX + dx;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (keyFaster)<font></font>
    speed = Util.accelerate(speed, accel, dt);<font></font>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keySlower)<font></font>
    speed = Util.accelerate(speed, breaking, dt);<font></font>
  <span class="hljs-keyword">else</span><font></font>
    speed = Util.accelerate(speed, decel, dt);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (((playerX &lt; <span class="hljs-number">-1</span>) || (playerX &gt; <span class="hljs-number">1</span>)) &amp;&amp; (speed &gt; offRoadLimit))<font></font>
    speed = Util.accelerate(speed, offRoadDecel, dt);<font></font>
<font></font>
  playerX = Util.limit(playerX, <span class="hljs-number">-2</span>, <span class="hljs-number">2</span>);     <span class="hljs-comment">// dont ever let player go too far out of bounds</span>
  speed   = Util.limit(speed, <span class="hljs-number">0</span>, maxSpeed); <span class="hljs-comment">// or exceed maxSpeed</span><font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o se preocupe, isso se tornar√° muito mais dif√≠cil quando, na vers√£o final, adicionarmos sprites e reconhecimento de colis√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geometria da estrada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de n√≥s pode tornar o mundo do jogo, precisamos construir uma matriz de </font></font><code>segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no no m√©todo </font></font><code>resetRoad()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada um desses segmentos da estrada ser√° finalmente projetado a partir de suas coordenadas mundiais, para que se transforme em um pol√≠gono 2D nas coordenadas da tela. </font><font style="vertical-align: inherit;">Para cada segmento, armazenamos dois pontos, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o centro da borda mais pr√≥xima da c√¢mera e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o centro da borda mais distante da c√¢mera.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53a/fa4/076/53afa40768a00b49833703b1457a6941.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A rigor, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2 de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada segmento √© id√™ntico ao </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1 do</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> segmento anterior, mas parece-me que √© mais f√°cil armazen√°-los como pontos separados e converter cada segmento separadamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s nos mantemos separados </font></font><code>rumbleLength</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">porque podemos ter belas curvas e colinas detalhadas, mas ao mesmo tempo listras horizontais. Se cada segmento subsequente tiver uma cor diferente, isso criar√° um efeito estrobosc√≥pico ruim. Portanto, queremos ter muitos segmentos pequenos, mas agrupe-os para formar faixas horizontais separadas.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetRoad</span>(<span class="hljs-params"></span>) </span>{<font></font>
  segments = [];<font></font>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span> ; n &lt; <span class="hljs-number">500</span> ; n++) { <span class="hljs-comment">// arbitrary road length</span><font></font>
    segments.push({<font></font>
       <span class="hljs-attr">index</span>: n,
       <span class="hljs-attr">p1</span>: { <span class="hljs-attr">world</span>: { <span class="hljs-attr">z</span>:  n   *segmentLength }, <span class="hljs-attr">camera</span>: {}, <span class="hljs-attr">screen</span>: {} },
       <span class="hljs-attr">p2</span>: { <span class="hljs-attr">world</span>: { <span class="hljs-attr">z</span>: (n+<span class="hljs-number">1</span>)*segmentLength }, <span class="hljs-attr">camera</span>: {}, <span class="hljs-attr">screen</span>: {} },
       <span class="hljs-attr">color</span>: <span class="hljs-built_in">Math</span>.floor(n/rumbleLength)%<span class="hljs-number">2</span> ? COLORS.DARK : COLORS.LIGHT<font></font>
    });<font></font>
  }<font></font>
<font></font>
  trackLength = segments.length * segmentLength;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicializamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apenas com as coordenadas mundiais </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque precisamos apenas de estradas retas. As coordenadas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sempre ser√£o 0 e as coordenadas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sempre depender√£o do valor escalado </font></font><code>+/- roadWidth</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais tarde, quando adicionarmos curvas e colinas, essa parte mudar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m definiremos objetos vazios para armazenar representa√ß√µes desses pontos na c√¢mera e na tela para n√£o criar um monte de objetos tempor√°rios em cada um </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para minimizar a coleta de lixo, devemos evitar alocar objetos dentro do loop do jogo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o carro chega ao fim da estrada, simplesmente retornamos ao in√≠cio do ciclo. </font><font style="vertical-align: inherit;">Para simplificar isso, criaremos um m√©todo para encontrar um segmento para qualquer valor de Z, mesmo que ultrapasse o comprimento da estrada:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findSegment</span>(<span class="hljs-params">z</span>) </span>{
  <span class="hljs-keyword">return</span> segments[<span class="hljs-built_in">Math</span>.floor(z/segmentLength) % segments.length];<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderiza√ß√£o em segundo plano</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">come√ßa renderizando a imagem de plano de fundo. </font><font style="vertical-align: inherit;">Nas partes a seguir, onde adicionaremos curvas e colinas, precisaremos do plano de fundo para executar a rolagem de paralaxe; portanto, come√ßaremos a avan√ßar nessa dire√ß√£o, renderizando o plano de fundo em tr√™s camadas separadas:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{<font></font>
<font></font>
  ctx.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<font></font>
<font></font>
  Render.background(ctx, background, width, height, BACKGROUND.SKY);<font></font>
  Render.background(ctx, background, width, height, BACKGROUND.HILLS);<font></font>
  Render.background(ctx, background, width, height, BACKGROUND.TREES);<font></font>
<font></font>
  ...</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderiza√ß√£o de estradas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, a fun√ß√£o render itera todos os segmentos e projetos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2 de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada segmento, desde coordenadas mundiais at√© coordenadas de tela, aparando o segmento, se necess√°rio, e renderizando-o:</font></font><br>
<br>
<pre><code class="javascript hljs">  <span class="hljs-keyword">var</span> baseSegment = findSegment(position);
  <span class="hljs-keyword">var</span> maxy        = height;
  <span class="hljs-keyword">var</span> n, segment;
  <span class="hljs-keyword">for</span>(n = <span class="hljs-number">0</span> ; n &lt; drawDistance ; n++) {<font></font>
<font></font>
    segment = segments[(baseSegment.index + n) % segments.length];<font></font>
<font></font>
    Util.project(segment.p1, (playerX * roadWidth), cameraHeight, position, cameraDepth, width, height, roadWidth);<font></font>
    Util.project(segment.p2, (playerX * roadWidth), cameraHeight, position, cameraDepth, width, height, roadWidth);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((segment.p1.camera.z &lt;= cameraDepth) || <span class="hljs-comment">// behind us</span>
        (segment.p2.screen.y &gt;= maxy))          <span class="hljs-comment">// clip by (already rendered) segment</span>
      <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
    Render.segment(ctx, width, lanes,<font></font>
                   segment.p1.screen.x,<font></font>
                   segment.p1.screen.y,<font></font>
                   segment.p1.screen.w,<font></font>
                   segment.p2.screen.x,<font></font>
                   segment.p2.screen.y,<font></font>
                   segment.p2.screen.w,<font></font>
                   segment.color);<font></font>
<font></font>
    maxy = segment.p2.screen.y;<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima, j√° vimos os c√°lculos necess√°rios para projetar um ponto; A vers√£o javascript combina transforma√ß√£o, proje√ß√£o e dimensionamento em um m√©todo:</font></font><br>
<br>
<pre><code class="javascript hljs">project: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p, cameraX, cameraY, cameraZ, cameraDepth, width, height, roadWidth</span>) </span>{<font></font>
  p.camera.x     = (p.world.x || <span class="hljs-number">0</span>) - cameraX;<font></font>
  p.camera.y     = (p.world.y || <span class="hljs-number">0</span>) - cameraY;<font></font>
  p.camera.z     = (p.world.z || <span class="hljs-number">0</span>) - cameraZ;<font></font>
  p.screen.scale = cameraDepth/p.camera.z;<font></font>
  p.screen.x     = <span class="hljs-built_in">Math</span>.round((width/<span class="hljs-number">2</span>)  + (p.screen.scale * p.camera.x  * width/<span class="hljs-number">2</span>));<font></font>
  p.screen.y     = <span class="hljs-built_in">Math</span>.round((height/<span class="hljs-number">2</span>) - (p.screen.scale * p.camera.y  * height/<span class="hljs-number">2</span>));<font></font>
  p.screen.w     = <span class="hljs-built_in">Math</span>.round(             (p.screen.scale * roadWidth   * width/<span class="hljs-number">2</span>));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m de calcular a tela </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para cada ponto </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usamos os mesmos c√°lculos de proje√ß√£o para calcular a largura projetada ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">w</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) do segmento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ter a coordenadas de tela </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pontos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bem como a largura projetada da estrada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">w</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , podemos facilmente calcular com a ajuda de uma fun√ß√£o auxiliar </font></font><code>Render.segment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os pol√≠gonos necess√°rios para a presta√ß√£o de grama, estrada, listras horizontais e linhas de divis√£o, usando a fun√ß√£o de auxiliar geral </font></font><code>Render.polygon</code> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ver . </font></font><code>common.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderiza√ß√£o de carro</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, a √∫ltima coisa que o m√©todo precisa </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© uma renderiza√ß√£o da Ferrari:</font></font><br>
<br>
<pre><code class="javascript hljs">  Render.player(ctx, width, height, resolution, roadWidth, sprites, speed/maxSpeed,<font></font>
                cameraDepth/playerZ,<font></font>
                width/<span class="hljs-number">2</span>,<font></font>
                height);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse m√©todo √© chamado </font></font><code>player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e n√£o </font></font><code>car</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, porque na vers√£o final do jogo haver√° outros carros na estrada, e queremos separar a Ferrari do jogador de outros carros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o auxiliar </font></font><code>Render.player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa o m√©todo de tela chamado </font></font><code>drawImage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para renderizar o sprite, tendo-o escalado anteriormente usando o mesmo dimensionamento de proje√ß√£o usado anteriormente:</font></font><br>
<br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Onde </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , neste caso, √© a dist√¢ncia relativa da m√°quina √† c√¢mera, armazenada na vari√°vel </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">playerZ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, a fun√ß√£o sacode o carro um pouco em alta velocidade, adicionando um pouco de aleatoriedade √† equa√ß√£o da escala, dependendo da </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">velocidade / velocidade m√°xima</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui est√° o que temos:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/845/dfd/3e8/845dfd3e88ef0a22b2c9fd021140ff3b.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fizemos uma quantidade bastante grande de trabalho apenas para criar um sistema com estradas retas. </font><font style="vertical-align: inherit;">N√≥s adicionamos</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulo auxiliar gen√©rico </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dom</font></font></strong></li>
<li><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">Util</font></strong><font style="vertical-align: inherit;"> general math module</font></font><strong><font style="vertical-align: inherit;"></font></strong></li>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderizar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√≥dulo auxiliar de lona geral </font><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... incluindo </font></font><code>Render.segment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Render.polygon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font><code>Render.sprite</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ciclo de jogo com passo fixo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">downloader de imagem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manipulador de teclado</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo de paralaxe</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">folha de sprite com carros, √°rvores e outdoors</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geometria rudimentar da estrada</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para controlar a m√°quina</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para renderizar fundo, estrada e carro do jogador</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tag HTML5 </font></font><code>&lt;audio&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com m√∫sica de corrida (b√¥nus oculto!)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... o que nos deu uma boa base para um maior desenvolvimento.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2. Curvas.</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98f/c3d/6d1/98fc3d6d13cc16f12847d253e112fcb2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta parte, explicaremos mais detalhadamente como as curvas funcionam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na parte anterior, compilamos a geometria da estrada na forma de uma matriz de segmentos, cada um com coordenadas mundiais que s√£o transformadas em rela√ß√£o √† c√¢mera e projetadas na tela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precis√°vamos apenas da coordenada mundial </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para cada ponto, porque nas estradas retas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eram iguais a zero.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c78/551/359/c78551359ef7c11e4af48b4285d61842.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se criarmos um sistema 3D totalmente funcional, poderemos implementar as curvas calculando as </font><font style="vertical-align: inherit;">listras </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dos pol√≠gonos mostrados acima. No entanto, esse tipo de geometria ser√° um pouco dif√≠cil de calcular e, para isso, ser√° necess√°rio adicionar o est√°gio de rota√ß√£o 3d √†s equa√ß√µes de proje√ß√£o ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... se seguimos esse caminho, seria melhor usar o WebGL ou seus an√°logos, mas esse projeto n√£o tem outras tarefas para o nosso projeto. N√≥s apenas queremos usar truques pseudo-tridimensionais da velha escola para simular curvas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, voc√™ provavelmente ficar√° surpreso ao saber que n√£o calcularemos as coordenadas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dos segmentos da estrada ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, usaremos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o conselho de Lu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Para curvar a estrada, basta alterar a posi√ß√£o da linha central da forma da curva ... a partir da parte inferior da tela, a quantidade de deslocamento do centro da estrada para a esquerda ou para a direita aumenta gradualmente</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><em><font style="vertical-align: inherit;">"</font></em></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, a linha central √© o valor </font></font><code>cameraX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">passado para os c√°lculos da proje√ß√£o. </font><font style="vertical-align: inherit;">Isso significa que, quando executamos </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cada segmento da estrada, voc√™ pode simular as curvas deslocando o valor </font></font><code>cameraX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para um valor gradualmente crescente.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c8a/569/19e/c8a56919e67d6f19cc737074ce92fffb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para saber quanto mudar, precisamos armazenar um valor em cada segmento </font></font><code>curve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este valor indica quanto o segmento deve ser deslocado da linha central da c√¢mera. </font><font style="vertical-align: inherit;">Ela vai ser:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">negativo para curvas √† esquerda</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">positivo para curvas virando √† direita</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menos para curvas suaves</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais para curvas n√≠tidas</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os pr√≥prios valores s√£o escolhidos arbitrariamente; </font><font style="vertical-align: inherit;">por tentativa e erro, podemos encontrar bons valores nos quais as curvas parecem estar "corretas":</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> ROAD = {
  <span class="hljs-attr">LENGTH</span>: { <span class="hljs-attr">NONE</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">SHORT</span>:  <span class="hljs-number">25</span>, <span class="hljs-attr">MEDIUM</span>:  <span class="hljs-number">50</span>, <span class="hljs-attr">LONG</span>:  <span class="hljs-number">100</span> }, <span class="hljs-comment">// num segments</span>
  <span class="hljs-attr">CURVE</span>:  { <span class="hljs-attr">NONE</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">EASY</span>:    <span class="hljs-number">2</span>, <span class="hljs-attr">MEDIUM</span>:   <span class="hljs-number">4</span>, <span class="hljs-attr">HARD</span>:    <span class="hljs-number">6</span> }<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m de escolher bons valores para as curvas, precisamos evitar lacunas nas transi√ß√µes quando a linha se transformar em uma curva (ou vice-versa). </font><font style="vertical-align: inherit;">Isso pode ser conseguido </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suavizando-se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao entrar e sair das curvas. </font><font style="vertical-align: inherit;">Faremos isso aumentando gradualmente (ou diminuindo) o valor </font></font><code>curve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de cada segmento usando as fun√ß√µes tradicionais de suaviza√ß√£o at√© atingir o valor desejado:</font></font><br>
<br>
<pre><code class="javascript hljs">easeIn:    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,b,percent</span>) </span>{ <span class="hljs-keyword">return</span> a + (b-a)*<span class="hljs-built_in">Math</span>.pow(percent,<span class="hljs-number">2</span>);                           },
<span class="hljs-attr">easeOut</span>:   <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,b,percent</span>) </span>{ <span class="hljs-keyword">return</span> a + (b-a)*(<span class="hljs-number">1</span>-<span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">1</span>-percent,<span class="hljs-number">2</span>));                     },
<span class="hljs-attr">easeInOut</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,b,percent</span>) </span>{ <span class="hljs-keyword">return</span> a + (b-a)*((-<span class="hljs-built_in">Math</span>.cos(percent*<span class="hljs-built_in">Math</span>.PI)/<span class="hljs-number">2</span>) + <span class="hljs-number">0.5</span>);        },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, agora, considerando a fun√ß√£o de adicionar um segmento √† geometria ...</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addSegment</span>(<span class="hljs-params">curve</span>) </span>{
  <span class="hljs-keyword">var</span> n = segments.length;<font></font>
  segments.push({<font></font>
     <span class="hljs-attr">index</span>: n,
        <span class="hljs-attr">p1</span>: { <span class="hljs-attr">world</span>: { <span class="hljs-attr">z</span>:  n   *segmentLength }, <span class="hljs-attr">camera</span>: {}, <span class="hljs-attr">screen</span>: {} },
        <span class="hljs-attr">p2</span>: { <span class="hljs-attr">world</span>: { <span class="hljs-attr">z</span>: (n+<span class="hljs-number">1</span>)*segmentLength }, <span class="hljs-attr">camera</span>: {}, <span class="hljs-attr">screen</span>: {} },
     <span class="hljs-attr">curve</span>: curve,
     <span class="hljs-attr">color</span>: <span class="hljs-built_in">Math</span>.floor(n/rumbleLength)%<span class="hljs-number">2</span> ? COLORS.DARK : COLORS.LIGHT<font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
podemos criar um m√©todo para entrada suave, localiza√ß√£o e sa√≠da suave de uma estrada curva:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRoad</span>(<span class="hljs-params">enter, hold, leave, curve</span>) </span>{
  <span class="hljs-keyword">var</span> n;
  <span class="hljs-keyword">for</span>(n = <span class="hljs-number">0</span> ; n &lt; enter ; n++)<font></font>
    addSegment(Util.easeIn(<span class="hljs-number">0</span>, curve, n/enter));
  <span class="hljs-keyword">for</span>(n = <span class="hljs-number">0</span> ; n &lt; hold  ; n++)<font></font>
    addSegment(curve);<font></font>
  <span class="hljs-keyword">for</span>(n = <span class="hljs-number">0</span> ; n &lt; leave ; n++)<font></font>
    addSegment(Util.easeInOut(curve, <span class="hljs-number">0</span>, n/leave));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e no topo voc√™ pode impor geometria adicional, por exemplo, curvas em forma de S:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addSCurves</span>(<span class="hljs-params"></span>) </span>{<font></font>
  addRoad(ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM,  -ROAD.CURVE.EASY);<font></font>
  addRoad(ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM,   ROAD.CURVE.MEDIUM);<font></font>
  addRoad(ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM,   ROAD.CURVE.EASY);<font></font>
  addRoad(ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM,  -ROAD.CURVE.EASY);<font></font>
  addRoad(ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM, ROAD.LENGTH.MEDIUM,  -ROAD.CURVE.MEDIUM);<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Altera√ß√µes no m√©todo update ()</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As √∫nicas mudan√ßas que precisam ser feitas no m√©todo </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√£o a aplica√ß√£o de um tipo de for√ßa centr√≠fuga quando a m√°quina se move ao longo de uma curva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definimos um fator arbitr√°rio que pode ser ajustado de acordo com nossas prefer√™ncias.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> centrifugal = <span class="hljs-number">0.3</span>;   <span class="hljs-comment">// centrifugal force multiplier when going around curves</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o apenas atualizaremos a posi√ß√£o com </font></font><code>playerX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base em sua velocidade atual, valor da curva e multiplicador de for√ßa centr√≠fuga:</font></font><br>
<br>
<pre><code class="javascript hljs">playerX = playerX - (dx * speedPercent * playerSegment.curve * centrifugal);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderiza√ß√£o de curva</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dissemos acima que √© poss√≠vel renderizar curvas simuladas alterando o valor </font></font><code>cameraX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado nos c√°lculos de proje√ß√£o durante a execu√ß√£o de </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cada segmento de estrada.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c8a/569/19e/c8a56919e67d6f19cc737074ce92fffb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para isso, armazenaremos a vari√°vel de acionamento </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aumentando para cada segmento por um valor </font></font><code>curve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bem como a vari√°vel </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que ser√° usada como deslocamento do valor </font></font><code>cameraX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado nos c√°lculos de proje√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar as curvas, precisamos do seguinte:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desloque a proje√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p1 de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada segmento por </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desloque a proje√ß√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p2 de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada segmento por </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx</font></font></strong></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o pr√≥ximo segmento em </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx</font></font></strong></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, para evitar transi√ß√µes rasgadas ao cruzar os limites dos segmentos, devemos fazer </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inicializado com o valor interpolado da curva dos segmentos base atuais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Altere o m√©todo da </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seguinte maneira:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> baseSegment = findSegment(position);
<span class="hljs-keyword">var</span> basePercent = Util.percentRemaining(position, segmentLength);
<span class="hljs-keyword">var</span> dx = - (baseSegment.curve * basePercent);
<span class="hljs-keyword">var</span> x  = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span>(n = <span class="hljs-number">0</span> ; n &lt; drawDistance ; n++) {<font></font>
<font></font>
  ...<font></font>
<font></font>
  Util.project(segment.p1, (playerX * roadWidth) - x,      cameraHeight, position - (segment.looped ? trackLength : <span class="hljs-number">0</span>), cameraDepth, width, height, roadWidth);<font></font>
  Util.project(segment.p2, (playerX * roadWidth) - x - dx, cameraHeight, position - (segment.looped ? trackLength : <span class="hljs-number">0</span>), cameraDepth, width, height, roadWidth);<font></font>
<font></font>
  x  = x + dx;<font></font>
  dx = dx + segment.curve;<font></font>
<font></font>
  ...<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fundo de rolagem de paralaxe</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim, precisamos rolar as camadas de fundo de paralaxe, armazenando o deslocamento de cada camada ...</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> skySpeed    = <span class="hljs-number">0.001</span>; <span class="hljs-comment">// background sky layer scroll speed when going around curve (or up hill)</span>
<span class="hljs-keyword">var</span> hillSpeed   = <span class="hljs-number">0.002</span>; <span class="hljs-comment">// background hill layer scroll speed when going around curve (or up hill)</span>
<span class="hljs-keyword">var</span> treeSpeed   = <span class="hljs-number">0.003</span>; <span class="hljs-comment">// background tree layer scroll speed when going around curve (or up hill)</span>
<span class="hljs-keyword">var</span> skyOffset   = <span class="hljs-number">0</span>;     <span class="hljs-comment">// current sky scroll offset</span>
<span class="hljs-keyword">var</span> hillOffset  = <span class="hljs-number">0</span>;     <span class="hljs-comment">// current hill scroll offset</span>
<span class="hljs-keyword">var</span> treeOffset  = <span class="hljs-number">0</span>;     <span class="hljs-comment">// current tree scroll offset</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e aument√°-lo durante o tempo, </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dependendo do valor da curva do segmento de jogador atual e sua velocidade ...</font></font><br>
<br>
<pre><code class="javascript hljs">skyOffset  = Util.increase(skyOffset,  skySpeed  * playerSegment.curve * speedPercent, <span class="hljs-number">1</span>);<font></font>
hillOffset = Util.increase(hillOffset, hillSpeed * playerSegment.curve * speedPercent, <span class="hljs-number">1</span>);<font></font>
treeOffset = Util.increase(treeOffset, treeSpeed * playerSegment.curve * speedPercent, <span class="hljs-number">1</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e use para usar esse deslocamento ao fazer </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camadas de fundo.</font></font><br>
<br>
<pre><code class="javascript hljs">Render.background(ctx, background, width, height, BACKGROUND.SKY,   skyOffset);<font></font>
Render.background(ctx, background, width, height, BACKGROUND.HILLS, hillOffset);<font></font>
Render.background(ctx, background, width, height, BACKGROUND.TREES, treeOffset);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, aqui temos as curvas pseudo-tridimensionais falsas:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98f/c3d/6d1/98fc3d6d13cc16f12847d253e112fcb2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A parte principal do c√≥digo que adicionamos √© construir a geometria da estrada com o valor correspondente </font></font><code>curve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Percebendo isso, adicionar for√ßa centr√≠fuga durante o tempo √© </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito mais f√°cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A renderiza√ß√£o da curva √© realizada em apenas algumas linhas de c√≥digo, mas pode ser dif√≠cil entender (e descrever) o que exatamente est√° acontecendo aqui. Existem muitas maneiras de simular curvas e √© muito f√°cil vagar quando elas s√£o implementadas em um beco sem sa√≠da. √â ainda mais f√°cil se deixar levar por uma tarefa externa e tentar fazer tudo "corretamente"; Antes que voc√™ perceba isso, voc√™ come√ßar√° a criar um sistema 3D totalmente funcional com matrizes, rota√ß√µes e geometria 3D real ... que, como eu disse, n√£o √© nossa tarefa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando escrevi este artigo, eu tinha certeza de que definitivamente havia problemas na minha implementa√ß√£o das curvas. </font><font style="vertical-align: inherit;">Tentando visualizar o algoritmo, n√£o entendi por que precisava de dois valores das unidades </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x em</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vez de um ... e se n√£o consigo explicar completamente algo, algo deu errado em algum lugar ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... mas o tempo do projeto </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"continua o fim de semana ‚Äù</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quase expirou e, francamente, as curvas me parecem bastante bonitas e, no final, √© a mais importante.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499240/index.html">Atrav√©s de espinhos para as estrelas, ou an√°lise de dados nos assuntos do c√©u</a></li>
<li><a href="../pt499242/index.html">Pesquisadores transmitiram dados de um PC de mesa atrav√©s de vibra√ß√µes em uma mesa</a></li>
<li><a href="../pt499244/index.html">Organiza√ß√µes sin√©rgicas. parte II</a></li>
<li><a href="../pt499246/index.html">Investiga√ß√£o da fun√ß√£o log√≠stica como lei do desenvolvimento da ind√∫stria</a></li>
<li><a href="../pt499248/index.html">Como reconhecemos equipamentos de prote√ß√£o individual</a></li>
<li><a href="../pt499254/index.html">Membro do Comit√™ de Programa PyConRu 2020 responde a perguntas sobre Python: uma apar√™ncia atualizada e um pouco de parseltang</a></li>
<li><a href="../pt499262/index.html">Hackathon final online para SMZhack aut√¥nomo: projetos que atingir√£o as pessoas</a></li>
<li><a href="../pt499268/index.html">Consci√™ncia espacial: o que os √≥culos Hololens podem fazer?</a></li>
<li><a href="../pt499272/index.html">–ü–∞–π–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ 0201. –°–ª–∞–±–æ–Ω–µ—Ä–≤–Ω—ã—Ö –ø—Ä–æ—Å—å–±–∞ —É–¥–∞–ª–∏—Ç—å—Å—è –æ—Ç —ç–∫—Ä–∞–Ω–æ–≤</a></li>
<li><a href="../pt499274/index.html">Desmontamos a nova c√°psula. Sabemos quantos microfones e como funciona</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>