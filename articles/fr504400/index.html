<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✋ 😩 🛎️ Mise en cache. Partie 2: 60 jours avant la sortie 😺 🎤 😫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Je vous ai déjà écrit sur la façon de promouvoir les initiatives dans une entreprise. Plus précisément, comment (parfois) cela réussit et quell...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mise en cache. Partie 2: 60 jours avant la sortie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sportmaster_lab/blog/504400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! </font><font style="vertical-align: inherit;">Je vous ai déjà écrit sur la façon de promouvoir les initiatives dans une entreprise. </font><font style="vertical-align: inherit;">Plus précisément, comment (parfois) cela réussit et quelles difficultés peuvent survenir: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une rétrospective de râteau. </font><font style="vertical-align: inherit;">Comment une solution self-made s'est avérée plus cool qu'une solution payante</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment nous avons choisi un système de mise en cache. </font><font style="vertical-align: inherit;">Partie 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, je veux continuer et parler du moment psychologiquement le plus stressant de ce projet, dont les deux premiers articles - lorsque le résultat du projet a été déterminé non pas tant par les compétences techniques de l'équipe que par la confiance dans ses calculs et la volonté d'aller jusqu'au bout. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dois dire - je pense que pour amener le projet à un moment aussi intense - c'est une erreur bien utilisée à </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propos de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lshaya que tout héroïsme en étirant le projet de ce problème ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais, je ne cache pas cette expérience et la partage volontiers - car je considère:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">précisément les zones à problèmes sont des points de croissance</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les plus gros problèmes "arrivent" précisément d'où vous ne vous attendez pas</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La combinaison de ces points - vous oblige simplement à partager la merveilleuse expérience de «comment gagner une gouttière à l'improviste». </font><font style="vertical-align: inherit;">Mais, il faut le noter, une situation similaire est exceptionnelle dans la société Sportmaster. </font><font style="vertical-align: inherit;">Autrement dit, il est possible que cette situation se reproduise - planification et définition de la responsabilité maintenant - à un niveau complètement différent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, il semble que l'introduction soit suffisante, si vous êtes prêt - bienvenue au chat.</font></font><br>
 <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/sa/3o/8k/sa3o8kskmgz_ptdsflpadmiycra.png"></a><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juin 2017 </font><font style="vertical-align: inherit;">Nous modifions le panneau d'administration. </font><font style="vertical-align: inherit;">Le panneau d'administration n'est pas seulement un ensemble de formulaires et de tableaux dans l'interface Web - les valeurs saisies doivent être collées avec des dizaines d'autres données que nous obtenons de systèmes tiers. </font><font style="vertical-align: inherit;">De plus, transformez-le et, finalement, envoyez-le aux consommateurs (dont le principal est le site ElasticSearch de Sportmaster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La principale difficulté est simplement de convertir et d'envoyer. </font><font style="vertical-align: inherit;">À savoir:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez fournir des données sous la forme de json, qui pèse 100 Ko chacune, et certaines apparaissent pour 10 Mo (recherchez la disponibilité et les critères de livraison des marchandises dans les magasins)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a json avec une structure qui a des attachements récursifs de n'importe quel niveau d'imbrication (par exemple, un menu à l'intérieur d'un élément de menu, dans lequel il y a à nouveau des éléments de menu, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la déclaration finale n'est pas approuvée et est en constante évolution (par exemple, le travail avec des marchandises par modèle est remplacé par une approche lorsque nous travaillons par modèle couleur). </font><font style="vertical-align: inherit;">Constamment - c'est plusieurs fois par semaine, avec un taux de pointe de 2 fois par jour pendant une semaine.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les 2 premiers points sont purement techniques et sont dictés par la tâche elle-même, alors avec le 3ème point, bien sûr, vous devez le traiter de manière organisationnelle. </font><font style="vertical-align: inherit;">Mais, le monde réel est loin d'être idéal, alors nous travaillons avec ce que nous avons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À savoir, ils ont compris comment riveter rapidement les formulaires Web et leurs objets côté serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une personne de l'équipe a été nommée «claque de formulaire» professionnelle et, à l'aide de composants Web préparés, a déployé une démo pour l'interface utilisateur plus rapidement que les analystes n'ont corrigé les dessins de cette interface utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pour changer le schéma des transformations, la complexité est apparue ici.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons suivi la voie habituelle - pour effectuer la transformation de la requête sql en Oracle. Il y avait un spécialiste DB dans l'équipe. Cela a duré jusqu'au moment où la demande était de 2 pages de texte sql continu. Je pourrais continuer encore et encore, mais lorsque les changements venaient des analystes - objectivement, la chose la plus difficile était de trouver l'endroit où faire les changements. Les </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
analystes ont </font><font style="vertical-align: inherit;">exprimé leur </font><font style="vertical-align: inherit;">règle dans les régimes, qui, bien qu'ils aient été peints quelque chose détaché du code (quelque chose d'un visio / draw.io / Gliffy), mais il y avait </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">similaire aux carrés et flèches dans les systèmes ETL (par exemple, Pentaho Kettle, qui à l'époque était utilisé pour fournir des données au site Web de Sportmaster). Maintenant, si nous n'avions pas une requête SQL, mais un schéma ETL! Ensuite, l'instruction et la solution seraient exprimées de manière topologique identique, ce qui signifie que la modification du code pourrait prendre autant de temps que la modification de l'instruction!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avec les systèmes ETL, il y a une autre difficulté. La même Pentaho Kettle - est idéale lorsque vous devez créer un nouvel index dans ElasticSearch, dans lequel écrire toutes les données collées à partir de plusieurs sources (remarque: en fait, c'est Pentaho Kettle qui ne fonctionne pas très bien, car il n'utilise pas javascript dans les transformations liés aux classes java par lesquelles le consommateur accède aux données - à cause de cela, vous pouvez écrire quelque chose qui ne peut pas être transformé en objets pojo nécessaires, mais ceci est un sujet séparé, loin du cours principal de l'article). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que faire lorsque dans le panneau d'administration, l'utilisateur a corrigé un champ dans un document? Pour apporter cette modification au site Web ElasticSearch de Sportmaster, ne créez pas un nouvel index dans lequel remplir tous les documents de ce type, y compris un mis à jour!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voulais que lorsqu'un objet des données d'entrée change, puis envoyer une mise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jour </font><i><font style="vertical-align: inherit;">à</font></i><font style="vertical-align: inherit;"> ElasticSearch du site </font><i><font style="vertical-align: inherit;">uniquement</font></i><font style="vertical-align: inherit;"> pour le document de sortie correspondant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, le document d'entrée lui-même, mais après tout, selon le schéma de transformation, il pourrait être attaché à des documents d'un type différent via join! Nous devons donc analyser le schéma de transformation et calculer les documents de sortie qui seront affectés par la modification des données dans les sources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche de produits en boîte pour résoudre ce problème n'a abouti à rien. Pas trouvé. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et quand ils désespéraient de trouver, ils l'ont compris, mais comment cela devrait-il fonctionner à l'intérieur, et comment cela peut-il être fait? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'idée est venue tout de suite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si l'ETL final peut être décomposé en ses parties constituantes, dont chacune a un certain type à partir d'un ensemble fini (par exemple, filtrer, joindre, etc.), alors, il suffira peut-être de créer le même ensemble final de nœuds spéciaux qui correspondent aux nœuds originaux, mais à la différence qu'ils travaillent non pas avec les données elles-mêmes, mais avec leur changement? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les moindres détails, avec des exemples et des points clés dans la mise en œuvre, notre solution - je veux couvrir dans un article séparé. Pour gérer les positions de soutien - cela nécessitera une immersion sérieuse, la capacité de penser de manière abstraite et de s'appuyer sur ce qui ne s'est pas encore manifesté. En effet, il sera intéressant précisément d'un point de vue mathématique et n'intéressera que les Habrovites qui s'intéressent aux </font><font style="vertical-align: inherit;">détails </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">techniques</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, je peux seulement dire que nous avons créé un modèle mathématique dans lequel nous avons décrit 7 types de nœuds et montré que ce système est complet - c'est-à-dire en utilisant ces 7 types de nœuds et les connexions entre eux - tout schéma de transformation de données peut être exprimé. </font><font style="vertical-align: inherit;">La mise en œuvre est basée sur l'utilisation active de l'obtention et de l'enregistrement de données par clé (à savoir par clé, sans conditions supplémentaires). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, notre solution avait un point fort concernant toutes les difficultés d'introduction:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les données doivent être fournies sous forme de json -&gt; nous travaillons avec des objets pojo (simple vieil objet java, si quelqu'un n'a pas trouvé les moments où une telle désignation était utilisée), qui sont faciles à dépasser dans json</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a json avec une structure qui a des incorporations récursives de n'importe quel niveau d'imbrication -&gt; encore une fois, pojo (l'essentiel est qu'il n'y a pas de boucles, mais combien de niveaux d'imbrication n'est pas important, il est facile de traiter en java par récursivité)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'énoncé final est en constante évolution -&gt; excellent, car nous modifions le schéma de transformation plus rapidement que les analystes ne souhaitent (dans les diagrammes) souhaiter des expériences</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi les moments risqués, un seul - nous écrivons la solution à partir de zéro, par nous-mêmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, les pièges ne tardèrent pas à venir.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moment spécial N1. </font><font style="vertical-align: inherit;">Prendre au piège. </font><font style="vertical-align: inherit;">“Bien extrapolé”</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre surprise de nature organisationnelle a été qu'en même temps que notre développement, le référentiel maître principal passait à une nouvelle version, et le format dans lequel ce référentiel fournit les données a changé. Et ce serait bien si notre système fonctionnait immédiatement avec le nouveau stockage, et non avec l'ancien. Mais le nouveau stockage n'est pas encore prêt. Mais alors, les structures de données sont connues et elles peuvent nous donner un stand de démonstration sur lequel une petite quantité de données connexes sera versée. En train d'aller? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, dans l'approche produit, lorsque vous travaillez avec le flux de valeur ajoutée, un avertissement est sans équivoque lancé à tous les optimistes: il y a un bloqueur -&gt; la tâche ne fonctionne pas, point final.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais alors, une telle dépendance n'a même pas éveillé les soupçons. En effet, nous avons été euphoriques du succès avec le prototype du processeur Delta - un système de traitement des données sur les deltas (mise en œuvre d'un modèle mathématique lorsque les changements dans les données de sortie sont calculés en utilisant le schéma de transformation en réponse à un changement dans les données d'entrée). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi tous les schémas de transformation, l'un était le plus important. En plus du fait que le circuit lui-même était le plus grand et le plus complexe, il y avait également une exigence stricte pour que la transformation soit effectuée selon ce circuit - une limite de temps pour l'exécution de la quantité totale de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la transformation doit être effectuée 15 minutes et pas une seconde de plus. L'entrée principale est un tableau avec 5,5 millions d'enregistrements. Au stade du développement, le tableau n'est pas encore rempli. Plus précisément, il est rempli d'un petit ensemble de données de test d'un montant de 10 000 lignes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, commençons. Dans la première implémentation, le processeur Delta a travaillé sur le HashMap comme stockage de valeur-clé (permettez-moi de vous rappeler que nous devons lire et écrire des objets beaucoup par clé). Bien sûr, sur les volumes de production, tous les objets intermédiaires ne tiendront pas en mémoire - par conséquent, au lieu de HashMap, nous passons à Hazelcast. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi exactement Hazelcast - donc parce que ce produit était familier, a été utilisé dans le backend du site du Sportmaster. De plus, il s'agit d'un système distribué et, comme il nous a semblé - si un ami fait quelque chose de mal avec les performances - nous ajoutons plus d'instances à quelques machines et le problème est résolu. Dans les cas extrêmes - une douzaine de voitures. Mise à l'échelle horizontale et tout le reste.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, nous lançons notre processeur Delta pour une transformation ciblée. Cela fonctionne presque instantanément. Cela est compréhensible - les données ne sont que de 10 000 au lieu de 5,5 millions. Par conséquent, nous multiplions le temps mesuré par 550, et nous obtenons le résultat: quelque chose d'environ 2 minutes. Bien! En fait - une victoire! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'était au tout début des travaux du projet - juste au moment où vous devez décider de l'architecture, confirmer les hypothèses (effectuer des tests qui les confirment), intégrer la solution pilote verticalement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que les tests ont montré un excellent résultat - c'est-à-dire que nous avons confirmé toutes les hypothèses, nous avons rapidement retourné le pilote - assemblé un «squelette» verticalement intégré pour un petit morceau de fonctionnalité. Et ils ont commencé le codage principal - en remplissant le «squelette de viande».</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui a réussi et vigoureusement engagé. Jusqu'à ce beau jour, où un </font><font style="vertical-align: inherit;">ensemble </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de données a </font><font style="vertical-align: inherit;">été téléchargé dans le magasin principal </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez le test sur cet ensemble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après 2 minutes n'a pas fonctionné. Je ne travaillais pas non plus après 5, 10, 15 minutes. Autrement dit, ils ne rentrent pas dans le cadre nécessaire. Mais, avec qui cela ne se produit pas, il faudra peaufiner quelque chose en détail et s'adapter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le test n'a pas fonctionné une heure plus tard. Et même après 2 heures, il y avait de l'espoir qu'il travaillerait, et nous chercherons quoi resserrer. Des restes d'espoir étaient même après 5 heures. Mais, après 10 heures, quand ils sont rentrés chez eux, mais le test n'a toujours pas fonctionné - il n'y avait plus d'espoir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème était que le lendemain, quand ils sont arrivés au bureau, le test continuait de fonctionner avec diligence. En conséquence, il a défilé pendant 30 heures, n'a pas attendu, s'est éteint.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catastrophe! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème a été localisé assez rapidement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hazelcast - lorsque vous travaillez sur une petite quantité de données - fait tout défiler en mémoire. </font><font style="vertical-align: inherit;">Mais quand il fallait vider des données sur un disque - les performances diminuaient des milliers de fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La programmation serait une occupation ennuyeuse et insipide, sinon pour les autorités et l'obligation de livrer le produit fini. </font><font style="vertical-align: inherit;">Donc nous, littéralement un jour plus tard, après avoir reçu un ensemble complet de données - nous devons aller aux autorités avec un rapport sur la façon dont le test sur les volumes de production a réussi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est un choix très sérieux et difficile:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dire «tel quel» = abandonner le projet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dire "comme je voudrais" = risquer, peut-être, on ne sait pas si nous pouvons résoudre le problème</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre quels sentiments surgissent dans ce cas, il est seulement possible d'investir pleinement dans l'idée, de réaliser le plan pendant six mois, de créer un produit qui aidera les collègues à résoudre une énorme couche de problèmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, abandonner votre création bien-aimée est très difficile. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est caractéristique de tout le monde - nous aimons ce dans quoi nous avons mis beaucoup d'efforts. Par conséquent, il est difficile d'entendre des critiques - vous devez consciemment faire des efforts pour percevoir correctement les commentaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, nous avons décidé qu'il existe encore de très, très nombreux systèmes différents qui peuvent être utilisés comme stockage de valeur-clé, et si Hazelcast ne convient pas, alors quelque chose fonctionnera certainement. </font><font style="vertical-align: inherit;">Autrement dit, ils ont décidé de tenter leur chance. </font><font style="vertical-align: inherit;">Pour notre justification, nous pouvons dire que ce n'était pas encore un «délai sanglant» - en général, il y avait encore une marge de temps pour «passer» à une solution de sauvegarde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de cette réunion avec les autorités, notre responsable a indiqué que «le test a montré que le système fonctionne de manière stable à des volumes de production, il ne plante pas». </font><font style="vertical-align: inherit;">En effet, le système fonctionnait de manière stable. </font><u><font style="vertical-align: inherit;">60</font></u><font style="vertical-align: inherit;"> jours </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pour libérer </font><font style="vertical-align: inherit;">.</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moment spécial N2. </font><font style="vertical-align: inherit;">Pas un piège, mais pas une découverte. </font><font style="vertical-align: inherit;">"Moins est plus"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour trouver un remplaçant pour Hazelcast avec le rôle d'entrepôt de données clé-valeur, nous avons compilé une liste de tous les candidats - nous avons obtenu une liste de 31 produits. C'est tout ce que j'ai réussi à trouver sur Google et à découvrir auprès de mes amis. En outre, Google a proposé des options absolument obscènes, telles que le mémoire de fin d'études d'un étudiant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester les candidats plus rapidement, nous avons préparé un petit test qui, en quelques minutes de lancement, a montré des performances sur les bons volumes. Et ils ont parallélisé le travail - tout le monde a pris le système suivant de la liste, configuré, exécuté le test, a pris le suivant. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont travaillé rapidement, cassé plusieurs systèmes par jour.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le 18ème système, il est devenu clair que c'était inutile. Sous notre profil de charge - aucun de ces systèmes n'est affûté. Ils ont beaucoup de volants et de révérences pour le rendre pratique à utiliser, de nombreuses belles approches de la mise à l'échelle horizontale - mais cela ne nous donne aucun profit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons besoin d'un système qui _fast_ enregistre la clé dans un objet sur le disque et lit rapidement la clé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si oui, nous décrivons l'algorithme de la façon dont cela peut être mis en œuvre. En général, cela semble tout à fait réalisable - si en même temps: a) sacrifiez la quantité de données qui occupera le disque, b) avez approximativement des estimations de la quantité et de la taille caractéristique des données dans chaque tableau. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque chose de style, allouez de la mémoire (sur disque) pour des objets avec une marge, des morceaux d'un volume maximum fixe. Puis en utilisant les tables d'index ... et ainsi de suite ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a eu de la chance de ne pas en arriver là. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le salut est venu sous la forme de RocksDB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un produit de Facebook conçu pour une lecture rapide et l'enregistrement d'un tableau d'octets sur le disque. Dans le même temps, l'accès aux fichiers est fourni via une interface similaire au stockage de valeurs-clés. En fait, la clé est un tableau d'octets, la valeur est un tableau d'octets. Optimisé pour effectuer ce travail rapidement et de manière fiable. Tout. Si vous avez besoin de quelque chose de plus beau et de haut niveau - vissez-le vous-même. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exactement ce dont nous avons besoin!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RocksDB, boulonné dans le rôle de stockage de valeur-clé, a amené l'indicateur de test cible au niveau de 5 heures. </font><font style="vertical-align: inherit;">C'était loin de 15 minutes, mais l'essentiel était fait. </font><font style="vertical-align: inherit;">L'essentiel était de comprendre ce qui se passait, de comprendre que l'écriture sur le disque était aussi rapide que possible, plus rapide qu'impossible. </font><font style="vertical-align: inherit;">Sur SSD, dans des tests raffinés, RocksDB a comprimé 400Mb / s, et c'était suffisant pour notre tâche. </font><font style="vertical-align: inherit;">Retards - quelque part dans le nôtre, dans un code contraignant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code, ce qui signifie que nous pouvons le gérer. </font><font style="vertical-align: inherit;">Prenons-le à part, mais nous pouvons le gérer.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moment spécial N3. </font><font style="vertical-align: inherit;">Soutien. </font><font style="vertical-align: inherit;">"Calcul théorique"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons un algorithme et une entrée. Nous prenons la plage de données d'entrée, calculons le nombre d'actions que le système doit effectuer, comment ces actions sont exprimées dans les coûts d'exécution JVM (attribuez une valeur à une variable, entrez une méthode, créez un objet, copiez un tableau d'octets, etc.), plus le nombre d'appels à RocksDB devrait être tenu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon les calculs, il s'avère qu'ils devraient se réunir 2 minutes (environ, comme l'a montré le test pour HashMap au tout début, mais ce n'est qu'une coïncidence - l'algorithme a changé depuis lors). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pourtant, le test dure 5 heures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, avant la sortie de </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une date spéciale - il sera désormais impossible de s'effondrer - nous n'aurons pas le temps de passer à l'option de sauvegarde.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, ce jour-là, le chef de projet est convoqué aux autorités. La question est la même - avoir le temps, tout va bien? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/ci/ps/ipcipst6tfldoo7vmigaxcmsmta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici la meilleure façon de décrire cette situation - une image de couverture étendue pour cet article. Autrement dit, les patrons sont montrés cette partie de l'image qui est rendue dans le titre. Mais en réalité - comme ça. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que, en réalité, bien sûr - nous n'étions pas du tout drôles. Et dites que "Tout est cool!" - ceci n'est possible que pour une personne ayant une très forte maîtrise de soi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grand, immense respect pour le manager, pour croire, faire confiance aux développeurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code vraiment, vraiment disponible - montre 5 heures. Un calcul théorique - montre 2 minutes. Comment peut-on croire cela?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais c’est possible si: le modèle est formulé clairement, comment compter est compréhensible et quelles valeurs substituer sont également compréhensibles. Autrement dit, le fait qu'en réalité l'exécution prend plus de temps signifie qu'en réalité ce n'est pas exactement le code que nous nous attendons à y exécuter qui est en cours d'exécution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche centrale est de trouver «ballast» dans le code. Autrement dit, certaines actions sont effectuées en plus du flux principal de création des données finales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se précipita. Tests unitaires, compositions fonctionnelles, fragmentation des fonctions et localisation des lieux avec un temps disproportionné consacré à l'exécution. Beaucoup de choses ont été faites. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cours de route, nous avons formulé de tels endroits où vous pouvez vous resserrer sérieusement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, la sérialisation. </font><font style="vertical-align: inherit;">D'abord utilisé le standard java.io. </font><font style="vertical-align: inherit;">Mais si nous fixons Cryo, dans notre cas, nous obtenons une augmentation de 2,5 fois de la vitesse de sérialisation et une réduction de 3 fois de la quantité de données sérialisées (ce qui signifie que les E / S sont 3 fois plus petites, ce qui ne fait que consommer les principales ressources). </font><font style="vertical-align: inherit;">Mais, plus en détail, il s'agit d'un sujet pour un article technique distinct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le point clé, ou «où l'éléphant s'est caché» - je vais essayer de le décrire dans un paragraphe.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point spécial 4. Accueil pour trouver une solution. </font><font style="vertical-align: inherit;">"Problème = Solution"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous obtenons / définissons par clé - dans les calculs, cela s'est passé comme une opération, affecte les entrées-sorties dans le volume égal à clé + valeur-objet (sous forme sérialisée, bien sûr). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que faire si l'objet lui-même sur lequel nous appelons get / set est une carte, que nous obtenons également par get / set à partir du disque. Quelle quantité d'E / S sera effectuée dans ce cas? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans nos calculs, cette fonctionnalité n'a pas été prise en compte. Autrement dit, il a été considéré comme 1 E / S pour clé + valeur-objet. Mais en fait?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, dans le stockage de valeur-clé, par clé-1, il y a un objet obj-1 de type Carte, dans lequel un certain objet obj-2 doit être stocké sous la clé clé-2. Ici, nous pensions que l'opération nécessiterait un IO pour key-2 + obj-2. Mais en réalité, vous devez considérer obj-1, le manipuler et l'envoyer à IO: key-1 + obj-1. Et s'il s'agit d'une carte dans laquelle il y a 1000 objets, la consommation d'E / S sera environ 1000 fois plus élevée. Et si 10 000 objets, alors ... C'est comme ça qu'ils ont obtenu le "ballast". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un problème est identifié, la solution est généralement évidente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, cela est devenu une structure spéciale pour les manipulations à l'intérieur de Map imbriquée. </font><font style="vertical-align: inherit;">Autrement dit, une telle valeur-clé, qui pour get / set prend deux clés à la fois, qui devrait être appliquée séquentiellement: clé-1, clé-2 - c'est-à-dire pour le premier niveau et pour le niveau imbriqué. </font><font style="vertical-align: inherit;">Comment mettre en œuvre une telle structure - Je vous le dirai en détail avec plaisir, mais encore une fois, dans un article technique distinct. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, à partir de cet épisode, je souligne et promouvais une telle fonctionnalité: un problème extrêmement détaillé est une bonne solution.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Achèvement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, j'ai essayé de montrer les points d'organisation et les pièges qui peuvent survenir. </font><font style="vertical-align: inherit;">De tels pièges sont très clairement visibles «de côté» ou au fil du temps, mais il est très facile d'y pénétrer lorsque vous vous retrouvez à côté d'eux. </font><font style="vertical-align: inherit;">J'espère que quelqu'un se souviendra d'une telle description, et au bon moment le rappel fonctionnera "J'ai déjà entendu quelque chose comme ça quelque part." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et, plus important encore - maintenant que tout est dit sur le processus, sur les moments psychologiques, sur les moments organisationnels. </font><font style="vertical-align: inherit;">Maintenant que nous avons une idée de quelles tâches et dans quelles conditions le système a été créé. </font><font style="vertical-align: inherit;">Maintenant - vous pouvez et devez parler du système du point de vue technique - de quel type de modèle mathématique il s'agit, et quelles astuces dans le code nous avons utilisées et quelles solutions innovantes nous avons pensé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce sujet dans le prochain article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En attendant, Happy New Code!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504374/index.html">Traversée de graphe simple: recherche en profondeur et étendue en utilisant JavaScript comme exemple</a></li>
<li><a href="../fr504382/index.html">Comment je (PhD Neurobiologie) est devenu Data Scientist en 6 mois</a></li>
<li><a href="../fr504384/index.html">Introduisez progressivement TypeScript dans votre projet React</a></li>
<li><a href="../fr504386/index.html">Variables virtuelles Vassbotn H. Class</a></li>
<li><a href="../fr504392/index.html">De combien de programmeurs et de mots avez-vous besoin pour reconnaître un passeport manuscrit?</a></li>
<li><a href="../fr504402/index.html">29 mai Java Digest</a></li>
<li><a href="../fr504408/index.html">Modèle de cadre de test simple et pratique sur séléniure pour les autotests de l'interface utilisateur</a></li>
<li><a href="../fr504412/index.html">Championnat de programmation en ligne "Open Finals of Moscow Training"</a></li>
<li><a href="../fr504414/index.html">Comment Microsoft a tué AppGet</a></li>
<li><a href="../fr504420/index.html">Écrire une arène PvP au tour par tour avec des mouvements simultanés</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>