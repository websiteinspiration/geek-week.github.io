<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóÑÔ∏è üå± üòØ Datenkomprimierung in Apache Ignite. Sberbank Erfahrung üëçüèø üßúüèº ü§öüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der Arbeit mit gro√üen Datenmengen kann das Problem des unzureichenden Speicherplatzes manchmal akut werden. Eine M√∂glichkeit, dieses Problem zu l√∂...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Datenkomprimierung in Apache Ignite. Sberbank Erfahrung</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/502136/"><img src="https://habrastorage.org/webt/cl/nj/sz/clnjsz90dmzkkj3wr4vuusu_-nu.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei der Arbeit mit gro√üen Datenmengen kann das Problem des unzureichenden Speicherplatzes manchmal akut werden. </font><font style="vertical-align: inherit;">Eine M√∂glichkeit, dieses Problem zu l√∂sen, ist die Komprimierung, aufgrund derer Sie es sich auf demselben Ger√§t leisten k√∂nnen, das Speichervolumen zu erh√∂hen. </font><font style="vertical-align: inherit;">In diesem Artikel werden wir uns ansehen, wie die Datenkomprimierung in Apache Ignite funktioniert. </font><font style="vertical-align: inherit;">In diesem Artikel werden nur die im Produkt implementierten Methoden zur Festplattenkomprimierung beschrieben. </font><font style="vertical-align: inherit;">Andere Methoden der Datenkomprimierung (√ºber das Netzwerk, im Speicher), sowohl implementiert als auch nicht, bleiben au√üerhalb des Bereichs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Persistenzmodus aktiviert ist, beginnt Ignite aufgrund der √Ñnderung von Daten in Caches mit dem Schreiben auf die Festplatte:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache-Inhalt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write Ahead Log (im Folgenden als WAL bezeichnet)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Mechanismus namens WAL-Verdichtung existiert seit langem, um WALs zu komprimieren. </font><font style="vertical-align: inherit;">Mit dem k√ºrzlich ver√∂ffentlichten Apache Ignite 2.8 wurden zwei weitere Mechanismen zum Komprimieren von Daten auf der Festplatte eingef√ºhrt: die Komprimierung von Festplattenseiten zum Komprimieren des Inhalts von Caches und die Komprimierung von WAL-Seiten-Snapshots zum Komprimieren einiger WAL-Datens√§tze. </font><font style="vertical-align: inherit;">Mehr zu all diesen drei Mechanismen weiter unten.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Komprimierung der Festplattenseite</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie es funktioniert</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst werden wir kurz darauf eingehen, wie Ignite Daten speichert. F√ºr die Speicherung wird der Seitenspeicher verwendet. Die Seitengr√∂√üe wird am Anfang des Knotens festgelegt und kann zu einem sp√§teren Zeitpunkt nicht mehr ge√§ndert werden. Au√üerdem muss die Seitengr√∂√üe eine Zweierpotenz und ein Vielfaches der Gr√∂√üe des Dateisystemblocks sein. Seiten werden nach Bedarf von der Festplatte in den RAM geladen. Die Datengr√∂√üe auf der Festplatte kann die Menge des zugewiesenen RAM √ºberschreiten. Wenn im RAM nicht gen√ºgend Speicherplatz zum Laden von Seiten von der Festplatte vorhanden ist, werden alte, nicht verwendete Seiten aus dem RAM verdr√§ngt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Daten werden in der folgenden Form auf der Festplatte gespeichert: F√ºr jede Partition jeder Cache-Gruppe wird eine separate Datei erstellt. In dieser Datei werden die Seiten in aufsteigender Reihenfolge des Index nacheinander verschoben. Die vollst√§ndige Seitenkennung enth√§lt die Cache-Gruppenkennung, die Partitionsnummer und den Seitenindex in der Datei. Somit k√∂nnen wir anhand der vollst√§ndigen Seitenkennung die Datei und den Versatz in der Datei f√ºr jede Seite eindeutig identifizieren. Weitere Informationen zum Seitenspeicher finden Sie in einem Artikel im Apache Ignite Wiki: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ignite Persistent Store - unter der Haube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Mechanismus zur Komprimierung von Festplattenseiten funktioniert, wie der Name schon sagt, auf Seitenebene. </font><font style="vertical-align: inherit;">Wenn dieser Mechanismus aktiviert ist, wird die Arbeit mit Daten im RAM unver√§ndert ohne Komprimierung ausgef√ºhrt. Zum Zeitpunkt des Speicherns von Seiten vom RAM auf die Festplatte werden sie jedoch komprimiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Komprimieren jeder Seite einzeln ist jedoch keine L√∂sung f√ºr das Problem. Sie m√ºssen die Gr√∂√üe der resultierenden Datendateien irgendwie reduzieren. </font><font style="vertical-align: inherit;">Wenn die Seitengr√∂√üe nicht mehr festgelegt wird, k√∂nnen wir keine Seiten mehr einzeln in eine Datei schreiben, da dies zu einer Reihe von Problemen f√ºhren kann:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir k√∂nnen den Seitenindex nicht verwenden, um den Versatz zu berechnen, an dem er sich in der Datei befindet.</font></font></li>
<li> ,    ,          .    ,     .    ,         .</li>
<li>           ,      ,        ,      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um diese Probleme nicht auf eigener Ebene zu l√∂sen, verwendet die Komprimierung von Festplattenseiten in Apache Ignite einen Dateisystemmechanismus namens Sparse-Dateien. Eine Sparse-Datei ist eine Datei, in der einige mit Nullen gef√ºllte Bereiche als L√∂cher markiert werden k√∂nnen. In diesem Fall werden Bl√∂cke des Dateisystems zum Speichern dieser L√∂cher nicht zugewiesen, wodurch Speicherplatz gespart wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist logisch, dass zum Freigeben des Dateisystemblocks die Lochgr√∂√üe gr√∂√üer oder gleich dem Dateisystemblock sein muss, wodurch die Seitengr√∂√üe von Apache Ignite zus√§tzlich eingeschr√§nkt wird: Damit die Komprimierung zumindest einen gewissen Effekt erzielt, muss die Seitengr√∂√üe streng gr√∂√üer als die Dateisystemblockgr√∂√üe sein . Wenn die Seitengr√∂√üe der Gr√∂√üe des Blocks entspricht, k√∂nnen wir niemals einen einzelnen Block freigeben, da zum Freigeben eines einzelnen Blocks eine komprimierte Seite erforderlich ist, die 0 Byte belegt. Wenn die Seitengr√∂√üe der Gr√∂√üe von 2 oder 4 Bl√∂cken entspricht, k√∂nnen wir bereits mindestens einen Block freigeben, wenn unsere Seite auf mindestens 50% bzw. 75% komprimiert ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher die endg√ºltige Beschreibung des Mechanismus: Beim Schreiben einer Seite auf die Festplatte wird versucht, die Seite zu komprimieren. Wenn die Gr√∂√üe der komprimierten Seite die Freigabe eines oder mehrerer Bl√∂cke des Dateisystems erm√∂glicht, wird die Seite in komprimierter Form geschrieben und anstelle der freigegebenen Bl√∂cke ein "Loch" gestanzt (ein Systemaufruf </font></font><code>fallocate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit dem Flag "Lochloch" wird ausgef√ºhrt). Wenn die Gr√∂√üe der komprimierten Seite keine Freigabe von Bl√∂cken zul√§sst, wird die Seite unver√§ndert in unkomprimierter Form gespeichert. Alle Seitenvers√§tze werden ebenso ber√ºcksichtigt wie ohne Komprimierung, indem der Seitenindex mit der Seitengr√∂√üe multipliziert wird. Es ist keine Selbstverlagerung von Seiten erforderlich. Seitenvers√§tze sowie ohne Komprimierung fallen an die Grenzen von Dateisystembl√∂cken.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-l/0f/3x/-l0f3xzxozvrxefbiauxdivslv0.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der aktuellen Implementierung kann Ignite nur mit sp√§rlichen Dateien unter Linux arbeiten, sodass die Komprimierung von Festplattenseiten nur aktiviert werden kann, wenn Ignite unter diesem Betriebssystem verwendet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komprimierungsalgorithmen, die f√ºr die Komprimierung von Festplattenseiten verwendet werden k√∂nnen: ZSTD, LZ4, Snappy. </font><font style="vertical-align: inherit;">Dar√ºber hinaus gibt es einen Betriebsmodus (SKIP_GARBAGE), in dem nur eine nicht verwendete Stelle auf der Seite verworfen wird, ohne die verbleibenden Daten zu komprimieren, wodurch die CPU im Vergleich zu den oben aufgef√ºhrten Algorithmen entlastet werden kann.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auswirkungen auf die Leistung </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider habe ich die Leistung an realen St√§nden nicht gemessen, da wir diesen Mechanismus nicht in der Produktion einsetzen wollen, aber theoretisch k√∂nnen wir spekulieren, wo wir verlieren und wo wir gewinnen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu m√ºssen wir uns daran erinnern, wie Seiten beim Zugriff gelesen und geschrieben werden:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn ein Lesevorgang ausgef√ºhrt wird, wird er zuerst im RAM gesucht. Wenn die Suche fehlschl√§gt, wird die Seite mit demselben Stream, der liest, von der Festplatte in den RAM geladen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie einen Schreibvorgang ausf√ºhren, wird die Seite im RAM als fehlerhaft markiert, w√§hrend das physische Speichern der Seite auf der Festplatte unmittelbar im Stream, der die Aufzeichnung durchf√ºhrt, nicht erfolgt. </font><font style="vertical-align: inherit;">Alle verschmutzten Seiten werden sp√§ter im Checkpoint-Prozess in separaten Streams auf der Festplatte gespeichert.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Somit ist die Auswirkung auf Leseoperationen:</font></font><br>
<br>
<ul>
<li> (disk IO),        .</li>
<li> (CPU),           sparse .       IO       sparse  (    sparse  ,  ,  ).</li>
<li> (CPU),     .</li>
<li>    .</li>
<li>    (    ):</li>
<li> (disk IO),        .</li>
<li> (CPU,  disk IO),     sparse .</li>
<li> (CPU),     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche Skala wird √ºberwiegen? </font><font style="vertical-align: inherit;">Es h√§ngt alles stark von der Umgebung ab, aber ich bin geneigt zu glauben, dass die Komprimierung von Festplattenseiten die Leistung auf den meisten Systemen eher beeintr√§chtigt. </font><font style="vertical-align: inherit;">Dar√ºber hinaus zeigen Tests auf anderen DBMS, die einen √§hnlichen Ansatz mit Dateien mit geringer Dichte verwenden, einen Leistungsabfall, wenn die Komprimierung aktiviert ist.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So aktivieren und konfigurieren Sie</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie oben erw√§hnt, die Mindestversion von Apache Ignite, die die Komprimierung von Festplattenseiten unterst√ºtzt: 2.8 und nur das Linux-Betriebssystem. </font><font style="vertical-align: inherit;">Das Einschalten und Einstellen erfolgt wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Klassenpfad muss √ºber ein Z√ºndkomprimierungsmodul verf√ºgen. </font><font style="vertical-align: inherit;">Standardm√§√üig befindet es sich in der Apache Ignite-Distribution im Verzeichnis libs / optional und ist nicht im Klassenpfad enthalten. </font><font style="vertical-align: inherit;">Sie k√∂nnen das Verzeichnis einfach um eine Ebene nach oben in die Bibliothek verschieben. Wenn es dann √ºber ignite.sh gestartet wird, wird es automatisch aktiviert.</font></font></li>
<li>Persistence    (  <code>DataRegionConfiguration.setPersistenceEnabled(true))</code>.</li>
<li>         (    <code>DataStorageConfiguration.setPageSize()</code> ).</li>
<li>  ,            ()   ( <code>CacheConfiguration.setDiskPageCompression() , CacheConfiguration.setDiskPageCompressionLevel()</code>).</li>
</ul><br>
<h3>WAL compaction</h3><br>
<h4>  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist WAL und warum wird es ben√∂tigt? Ganz kurz: Dies ist ein Journal, in das alle Ereignisse fallen, die sich aufgrund des Seitenrepositorys √§ndern. Er wird vor allem f√ºr die M√∂glichkeit einer Genesung im Falle eines Sturzes ben√∂tigt. Vor dem √úbertragen der Kontrolle an einen Benutzer muss jeder Vorgang das Ereignis zuerst in die WAL schreiben, damit er im Falle eines Sturzes das Protokoll durchspielen und alle Vorg√§nge wiederherstellen kann, f√ºr die der Benutzer eine erfolgreiche Antwort erhalten hat, auch wenn diese Vorg√§nge keine Zeit hatten, sich im Seitenspeicher auf der Festplatte wiederzugeben (siehe oben) Es wurde beschrieben, dass das eigentliche Schreiben in den Seitenspeicher in einem Prozess ausgef√ºhrt wird, der als Pr√ºfpunkt bezeichnet wird (mit einer gewissen Verz√∂gerung in separaten Threads).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eintr√§ge in der WAL sind in logische und physische Eintr√§ge unterteilt. Logische sind Schl√ºssel und Werte selbst. Physisch - reflektiert Seiten√§nderungen im Seitenspeicher. Wenn logische Datens√§tze in einigen anderen F√§llen n√ºtzlich sein k√∂nnen, werden physische Datens√§tze nur f√ºr die Wiederherstellung im Falle eines Sturzes ben√∂tigt, und Datens√§tze werden erst ab dem Zeitpunkt des letzten erfolgreichen Pr√ºfpunkts ben√∂tigt. Hier werden wir nicht auf Details eingehen und erkl√§ren, warum dies so funktioniert, aber jeder Interessierte kann auf den bereits erw√§hnten Artikel im Apache Ignite Wiki verweisen: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ignite Persistent Store - unter der Haube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein logischer Datensatz enth√§lt h√§ufig mehrere physische Datens√§tze. Das hei√üt, ein Cache-Put-Vorgang wirkt sich beispielsweise auf mehrere Seiten im Seitenspeicher aus (eine Seite mit den Daten selbst, Seiten mit Indizes, Seiten mit freien Listen). Bei einigen synthetischen Tests stellte sich heraus, dass die physischen Aufzeichnungen bis zu 90% der WAL-Datei ausmachten. Dar√ºber hinaus ben√∂tigen sie eine sehr kurze Zeit (standardm√§√üig betr√§gt das Intervall zwischen den Kontrollpunkten 3 Minuten). Es w√§re logisch, diese Daten zu entfernen, nachdem sie ihre Relevanz verloren haben. Dies ist genau das, was der WAL-Komprimierungsmechanismus ausf√ºhrt, physische Datens√§tze entfernt und die verbleibenden logischen Datens√§tze mit zip komprimiert, w√§hrend die Dateigr√∂√üe sehr stark abnimmt (manchmal zehnmal).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Physikalisch besteht eine WAL aus mehreren Segmenten (Standard 10) mit fester Gr√∂√üe (Standard 64 MB), die in einem Kreis √ºberschrieben werden. </font><font style="vertical-align: inherit;">Sobald das aktuelle Segment gef√ºllt ist, wird das n√§chste Segment dem aktuellen Segment zugewiesen und das gef√ºllte Segment in einem separaten Stream in das Archiv kopiert. </font><font style="vertical-align: inherit;">Die WAL-Komprimierung funktioniert bereits mit Archivsegmenten. </font><font style="vertical-align: inherit;">Au√üerdem √ºberwacht es in einem separaten Stream die Ausf√ºhrung des Pr√ºfpunkts und startet die Komprimierung durch Archivsegmente, f√ºr die keine physischen Datens√§tze mehr ben√∂tigt werden.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zk/95/jo/zk95jo7dnthiox2sv0ezywhrj2a.png"><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auswirkungen auf die Leistung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da die WAL-Komprimierung als separater Thread ausgef√ºhrt wird, sollte kein direkter Einfluss auf die ausgef√ºhrten Vorg√§nge bestehen. </font><font style="vertical-align: inherit;">Die CPU (Komprimierung) und die Festplatte (Lesen jedes WAL-Segments aus dem Archiv und Schreiben komprimierter Segmente) werden jedoch zus√§tzlich im Hintergrund belastet. Wenn das System also an seine Grenzen st√∂√üt, f√ºhrt dies auch zu einer Verschlechterung der Leistung.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So aktivieren und konfigurieren Sie</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen die WAL-Komprimierung mit der Eigenschaft </font></font><code>WalCompactionEnabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code>DataStorageConfiguration (DataStorageConfiguration.setWalCompactionEnabled(true)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">aktivieren </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mithilfe der DataStorageConfiguration.setWalCompactionLevel () -Methode k√∂nnen Sie au√üerdem das Komprimierungsverh√§ltnis festlegen, wenn Sie mit dem Standardwert (BEST_SPEED) nicht zufrieden sind.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-Seiten-Snapshot-Komprimierung</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie es funktioniert</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben bereits herausgefunden, dass Eintr√§ge in WAL in logische und physische Eintr√§ge unterteilt sind. F√ºr jede √Ñnderung jeder Seite im Seitenspeicher wird ein physischer WAL-Datensatz generiert. Physische Datens√§tze sind wiederum in zwei Unterarten unterteilt: Seitenschnappschussdatensatz und Delta-Datensatz. Jedes Mal, wenn wir etwas auf einer Seite √§ndern und es von einem sauberen in einen schmutzigen Zustand √§ndern, wird eine vollst√§ndige Kopie dieser Seite in der WAL (Page Snapshot Record) gespeichert. Selbst wenn wir nur ein Byte in der WAL ge√§ndert haben, wird ein Datensatz mit einer Gr√∂√üe gespeichert, die geringf√ºgig gr√∂√üer als die Seitengr√∂√üe ist. Wenn wir auf einer bereits verschmutzten Seite etwas √§ndern, wird in der WAL ein Delta-Datensatz gebildet, der nur die √Ñnderungen gegen√ºber dem vorherigen Status der Seite widerspiegelt, nicht jedoch die gesamte Seite. Da das Zur√ºcksetzen des Status von Seiten von Dirty auf Clean w√§hrend des Checkpoint-Vorgangs durchgef√ºhrt wird,Unmittelbar nach dem Start des Pr√ºfpunkts bestehen fast alle physischen Datens√§tze nur aus Schnappsch√ºssen von Seiten (da alle Seiten unmittelbar nach dem Start des Pr√ºfpunkts leer sind). Wenn Sie sich dem n√§chsten Pr√ºfpunkt n√§hern, w√§chst der Anteil des Delta-Datensatzes und wird zu Beginn des n√§chsten Pr√ºfpunkts erneut zur√ºckgesetzt. Messungen an einigen synthetischen Tests zeigten, dass der Anteil der Seitenschnappsch√ºsse am Gesamtvolumen der physischen Datens√§tze 90% erreicht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Idee hinter der WAL-Seiten-Snapshot-Komprimierung besteht darin, Seiten-Snapshots mit einem handels√ºblichen Seitenkomprimierungswerkzeug zu komprimieren (siehe Komprimierung von Festplattenseiten). Gleichzeitig werden Datens√§tze in WAL nacheinander im Nur-Anh√§ngen-Modus gespeichert, und es besteht keine Notwendigkeit, Datens√§tze an die Grenzen von Dateisystembl√∂cken zu binden. Daher ben√∂tigen wir hier im Gegensatz zum Komprimierungsmechanismus f√ºr Festplattenseiten absolut keine Dateien mit geringer Dichte, sodass dieser Mechanismus nicht nur auf dem Betriebssystem funktioniert Linux Au√üerdem ist es uns egal, wie stark wir die Seite komprimieren konnten. Selbst wenn wir 1 Byte freigegeben haben, ist dies bereits ein positives Ergebnis und wir k√∂nnen komprimierte Daten in WAL speichern, im Gegensatz zur Komprimierung von Festplattenseiten, bei der eine komprimierte Seite nur gespeichert wird, wenn mehr als 1 Dateisystemblock freigegeben wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seiten sind gut komprimierbare Daten, ihr Anteil am gesamten WAL-Volumen ist sehr hoch. Ohne √Ñnderung des Formats der WAL-Datei k√∂nnen wir die Gr√∂√üe erheblich reduzieren. </font><font style="vertical-align: inherit;">Die Komprimierung logischer Datens√§tze w√ºrde unter anderem eine √Ñnderung des Formats und einen Verlust der Kompatibilit√§t erfordern, beispielsweise f√ºr externe Verbraucher, die an logischen Datens√§tzen interessiert sein k√∂nnten, ohne die Dateigr√∂√üe wesentlich zu verringern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr die Komprimierung von Festplattenseiten f√ºr die Komprimierung von WAL-Seitenschnappsch√ºssen k√∂nnen die Komprimierungsalgorithmen ZSTD, LZ4, Snappy sowie der Modus SKIP_GARBAGE verwendet werden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auswirkungen auf die Leistung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist nicht schwer zu bemerken, dass die direkte Einbeziehung der WAL-Seiten-Snapshot-Komprimierung nur die Streams betrifft, die Daten in den Seitenspeicher schreiben, dh die Streams, die die Daten in den Caches √§ndern. Das Lesen aus physischen WAL-Aufzeichnungen erfolgt nur einmal, zum Zeitpunkt des Anhebens des Knotens nach dem Sturz (und nur im Fall eines Sturzes w√§hrend des Kontrollpunkts). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies wirkt sich wie folgt auf den Datenfluss aus: Wir erhalten einen negativen Effekt (CPU) aufgrund der Notwendigkeit, die Seite jedes Mal vor dem Schreiben auf die Festplatte zu komprimieren, und einen positiven Effekt (Festplatten-E / A), indem wir die Menge der aufgezeichneten Daten reduzieren. Dementsprechend ist hier alles einfach. Wenn die Systemleistung auf der CPU liegt, kommt es zu einer leichten Verschlechterung. Wenn bei der Festplatten-E / A eine Erh√∂hung auftritt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indirekt wirkt sich die Reduzierung der Gr√∂√üe von WALs auch auf (positiv) Streams aus, die WAL-Segmente in das Archiv und die WAL-Komprimierungsstr√∂me ablegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reale Leistungstests in unserer Umgebung mit synthetischen Daten zeigten einen geringen Anstieg (Durchsatz um 10 bis 15% erh√∂ht, Latenz um 10 bis 15% verringert).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So aktivieren und konfigurieren Sie</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Mindestversion von Apache Ignite ist 2.8. </font><font style="vertical-align: inherit;">Das Einschalten und Einstellen erfolgt wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Klassenpfad muss √ºber ein Z√ºndkomprimierungsmodul verf√ºgen. </font><font style="vertical-align: inherit;">Standardm√§√üig befindet es sich in der Apache Ignite-Distribution im Verzeichnis libs / optional und ist nicht im Klassenpfad enthalten. </font><font style="vertical-align: inherit;">Sie k√∂nnen das Verzeichnis einfach um eine Ebene nach oben in die Bibliothek verschieben. Wenn es dann √ºber ignite.sh gestartet wird, wird es automatisch aktiviert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Persistenz muss aktiviert sein (Aktiviert durch </font></font><code>DataRegionConfiguration.setPersistenceEnabled(true)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li>        <code>DataStorageConfiguration.setWalPageCompression()</code>,     ( DISABLED).</li>
<li>        <code>DataStorageConfiguration.setWalPageCompression()</code>,         javadoc  .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die in Apache Ignite beschriebenen Datenkomprimierungsmechanismen k√∂nnen unabh√§ngig voneinander verwendet werden, aber jede Kombination davon ist auch g√ºltig. </font><font style="vertical-align: inherit;">Das Verst√§ndnis der Prinzipien ihrer Arbeit bestimmt, wie sie zu Ihren Aufgaben in Ihrer Umgebung passen und was Sie opfern m√ºssen, wenn Sie sie verwenden. </font><font style="vertical-align: inherit;">Die Komprimierung von Festplattenseiten dient zum Komprimieren des Hauptspeichers und kann eine mittlere Komprimierung erm√∂glichen. </font><font style="vertical-align: inherit;">Die WAL-Seiten-Snapshot-Komprimierung f√ºhrt zu einem durchschnittlichen Komprimierungsgrad bereits vorhandener WAL-Dateien, w√§hrend die Leistung wahrscheinlich sogar verbessert wird. </font><font style="vertical-align: inherit;">Die WAL-Komprimierung wirkt sich nicht positiv auf die Leistung aus, minimiert jedoch die Gr√∂√üe der WAL-Dateien durch L√∂schen physischer Datens√§tze.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502122/index.html">Thanos - Skalierbarer Prometheus</a></li>
<li><a href="../de502124/index.html">2019 Venture-Ergebnisse f√ºr die Ukraine</a></li>
<li><a href="../de502126/index.html">So verbessern Sie Ihren Lebenslauf f√ºr Englischprogrammierer</a></li>
<li><a href="../de502132/index.html">So √ºbertragen Sie den OpenVZ 6-Container ohne Kopfschmerzen auf den KVM-Server</a></li>
<li><a href="../de502134/index.html">Genug, um Angst vor subjektiv sch√∂nen Entscheidungen im Code zu haben - Sie sind keine Roboter</a></li>
<li><a href="../de502146/index.html">Online Roundtable "Ich m√∂chte gamedev"</a></li>
<li><a href="../de502148/index.html">Verwenden von Komponenten von Drittanbietern im Speicher am Beispiel von Qsan</a></li>
<li><a href="../de502150/index.html">Skalieren eines Hochlastnetzwerks mit Nutanix: Funktionen und Herausforderungen anhand eines pers√∂nlichen Falls</a></li>
<li><a href="../de502154/index.html">Effektiv Autotests schreiben - Subkutane Tests</a></li>
<li><a href="../de502156/index.html">Rambler gegen NGINX Fall: Kriminelle Risiken der Digitalisierung Roundtable 16. Mai</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>