<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🔧 👨🏼‍🤝‍👨🏻 🕎 《 Terraform：代码级别的基础架构》一书 🤲 👩🏿‍🤝‍👨🏼 🐙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="您好，habrozhiteli！该书适用于所有已编写代码的负责人。这适用于系统管理员，运营专家，发行版，SR，DevOps工程师，基础架构开发人员，全周期开发人员，工程团队负责人和技术总监。无论您处于什么位置，如果您涉及基础架构，部署代码，配置服务器，扩展集群，备份数据，监控应用程序并在凌晨三点钟接...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>《 Terraform：代码级别的基础架构》一书</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/503858/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/el/eg/lp/eleglpt_bkgjd7cftgp1yrmg_gk.jpeg" align="left" alt="图片"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您好，habrozhiteli！该书适用于所有已编写代码的负责人。这适用于系统管理员，运营专家，发行版，SR，DevOps工程师，基础架构开发人员，全周期开发人员，工程团队负责人和技术总监。无论您处于什么位置，如果您涉及基础架构，部署代码，配置服务器，扩展集群，备份数据，监控应用程序并在凌晨三点钟接听电话，这本书都是适合您的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些责任加在一起通常被称为运营活动（或系统管理）。</font><font style="vertical-align: inherit;">以前，经常会遇到知道如何编写代码但不了解系统管理的开发人员。</font><font style="vertical-align: inherit;">系统管理员经常遇到没有编写代码的能力。</font><font style="vertical-align: inherit;">一旦可以接受这种分离，但是在现代世界中，如果没有云计算和DevOps运动就无法想象这种分离，几乎所有开发人员都需要管理技能，并且任何系统管理员都必须能够编程。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您不仅将学习如何使用Terraform以代码形式管理基础结构，还将学习如何将其适应DevOps的整体概念。</font><font style="vertical-align: inherit;">通过阅读本书，您可以回答以下问题。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么要完全使用IaC？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置管理，业务流程，资源初始化和服务器模板之间有什么区别？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我什么时候应该使用Terraform，Chef，Ansible，Puppet，Salt，CloudFormation，Docker，Packer或Kubernetes？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform系统如何工作以及如何使用它来管理基础结构？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何创建适合重用的Terraform模块？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何为Terraform编写足够可靠的实用代码？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何测试Terraform代码？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何将Terraform纳入您的自动部署过程？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在团队合作中使用Terraform的最佳方法是什么？</font></font></li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二版的新功能</font></font></b>
                        <div class="spoiler_text">    2017 .   2019-         ,      !                 .  ,        .<br>
<br>
        ,  ,     ,    Terraform,    .<br>
<br>
<ul>
<li>   Terraform.    ,   Terraform  0.8.     Terraform   0.12.       ,     .  ,   !</li>
<li>   .           Terraform.    , ,    ,  ,    ,  ,  ,    .</li>
<li>  .      Terraform   .  , ,               — ,      .</li>
<li>   .  8      ,      Terraform    . ,  ,      ,          : ,      .</li>
<li>HCL2.  Terraform 0.12   HCL   HCL2.        (       ${…}!),   ,     ,   null, for_each  for,    .          HCL2,         5  6.</li>
<li>   .  Terraform 0.9    .        Terraform    .  Terraform 0.9     ,       ;     0.10      .       3.</li>
<li>    Terraform.  Terraform 0.10         (    AWS, GCP, Azure  . .).         ,         .          terraform init  ,       .       2  7.</li>
<li>   .  2016   Terraform        (AWS, GCP  Azure).      100,  ,  ,   1.               (,     Alicloud, Oracle Cloud Infrastructure, VMware vSphere  .),       ,     (GitHub, GitLab  BitBucket),   (MySQL, PostreSQL  InfluxDB),     ( DataDog, New Relic  Grafana),   Kubernetes, Helm, Heroku, Rundeck  Rightscale   .  ,       : ,   AWS     ,        ,   CloudFormation!</li>
<li>  Terraform.  2017   HashiCorp    Terraform (registry.terraform.io) —  ,         Terraform,  .  2018          .  Terraform 0.11        .       « »  . 153.</li>
<li>  .  Terraform 0.9    :         ,    ,   errored.tfstate.  Terraform 0.12    .    ,            ,     .</li>
<li>   .      ,     (.  «  »  . 144),  « »         (,  «  Terraform»  . 242),  plan    apply (.  «  »  . 64),     create_before_destroy,    count,           (.  «»  . 160),    ,   provider   .</li>
</ul></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">摘抄。</font><font style="vertical-align: inherit;">如何测试Terraform代码</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（稍后</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将</font><font style="vertical-align: inherit;">在本书中对自动测试的问题给予更多的关注）</font><font style="vertical-align: inherit;">DevOps世界充满了各种恐惧：每个人都害怕让事情正常进行，丢失数据或被黑客入侵。进行任何更改时，您总是问自己将会产生什么后果。它在所有环境中的行为都一样吗？会导致再次中断吗？而且，如果发生这种情况，您这次需要留多少时间来修复它？随着公司的发展，风险越来越大，使部署过程变得更糟，并增加了出错的风险。许多公司试图通过减少部署频率来最大程度地降低这种风险，但是结果是，每个单独的部署都会变得更大并且更容易出错。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果以代码形式管理基础架构，则有更好的方法来最大程度地降低风险：测试。</font><font style="vertical-align: inherit;">他们的目标是给您足够的信心进行更改。</font><font style="vertical-align: inherit;">这里的关键词是信心：没有测试可以保证没有错误，因此您更有可能应对概率。</font><font style="vertical-align: inherit;">如果您可以将所有基础结构和部署过程捕获为代码，则可以在测试环境中测试此代码。</font><font style="vertical-align: inherit;">如果成功，则相同的代码很有可能在工业环境中运行。</font><font style="vertical-align: inherit;">在充满恐惧和不确定性的世界中，高概率和高信心是昂贵的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本章中，我们将介绍测试基础结构代码（手动和自动）的过程，重点是后者。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动测试：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动测试的基础；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试后清洁资源。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动化测试：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单元测试；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整合测试；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">端到端测试；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他测试方法。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动测试</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考虑如何测试Terraform代码时，将测试与使用通用编程语言（例如Ruby）编写的代码进行一些比较是很有用的。</font><font style="vertical-align: inherit;">想象一下，您正在web-server.rb文件中编写一个简单的Ruby Web服务器：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这段代码将返回200 OK响应，URL为正文“ Hello，World”。</font><font style="vertical-align: inherit;">对于其他任何地址，答案将为404。您将如何手动测试此代码？</font><font style="vertical-align: inherit;">通常，添加更多代码以在本地运行Web服务器：</font></font><br>
<br>
<pre><code class="java hljs">#   ,      <font></font>
#  ,       <font></font>
<span class="hljs-keyword">if</span> __FILE__ == $<span class="hljs-number">0</span>
  #      <span class="hljs-number">8000</span>
  server = WEBrick::HTTPServer.new :Port =&gt; <span class="hljs-number">8000</span>
  server.mount <span class="hljs-string">'/'</span>, WebServer<font></font>
<font></font>
  #    Ctrl+C<font></font>
  trap <span class="hljs-string">'INT'</span> <span class="hljs-keyword">do</span> server.shutdown end<font></font>
<font></font>
  #  <font></font>
  server.start<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果在终端中运行此文件，它将在端口8000上加载Web服务器：</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要检查此服务器的运行情况，可以使用浏览器或curl：</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/<font></font>
Hello, World<font></font>
<font></font>
$ curl localhost:<span class="hljs-number">8000</span>/invalid-path<font></font>
Not Found</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，假设我们通过向其添加一个/ api入口点（返回201 Created和一个JSON格式的主体）来更改此代码：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     when <span class="hljs-string">"/api"</span>
         response.status = <span class="hljs-number">201</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>
         response.body = <span class="hljs-string">'{"foo":"bar"}'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要手动测试此更新的代码，请按Ctrl + C，然后再次运行脚本重新启动Web服务器：</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span><font></font>
^C<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO going to shutdown ...<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO WEBrick::HTTPServer#start done.<font></font>
<font></font>
$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要检查新版本，可以再次使用curl命令：</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/api<font></font>
{<span class="hljs-string">"foo"</span>:<span class="hljs-string">"bar"</span>}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动测试基础</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种手动测试在Terraform中会是什么样？</font><font style="vertical-align: inherit;">例如，在前面的章节中，您仍然具有用于部署ALB的代码。</font><font style="vertical-align: inherit;">这是模块/网络/ alb / main.tf文件的片段：</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb"</span> <span class="hljs-string">"example"</span> {<font></font>
   name                     = <span class="hljs-keyword">var</span>.alb_name<font></font>
   load_balancer_type = <span class="hljs-string">"application"</span>
   subnets                  = <span class="hljs-keyword">var</span>.subnet_ids<font></font>
   security_groups      = [aws_security_group.alb.id]<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
        content_type = <span class="hljs-string">"text/plain"</span>
        message_body = <span class="hljs-string">"404: page not found"</span>
        status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
    }<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"alb"</span> {<font></font>
   name = <span class="hljs-keyword">var</span>.alb_name<font></font>
}<font></font>
<font></font>
# (...)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果将此清单与Ruby代码进行比较，您会看到一个明显的不同：AWS ALB，目标组，侦听器，安全组以及任何其他资源都无法部署在您自己的计算机上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于No.1测试的主要结论是：Terraform代码测试不能在本地进行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这不仅适用于Terraform，而且适用于大多数IaC工具。在Terraform中进行手动测试的唯一实用方法是在实际环境中（即在AWS中）部署代码。换句话说，在阅读本书时独立启动的terraform apply和terraform destroy命令是Terraform中的手动测试。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是为什么在每个模块的examples文件夹中拥有易于部署的示例如此重要的原因之一（请参见第6章）。</font><font style="vertical-align: inherit;">要测试alb模块，最简单的方法是使用您在examples / alb中创建的演示代码：</font></font><br>
<br>
<pre><code class="java hljs">provider <span class="hljs-string">"aws"</span> {<font></font>
   region = <span class="hljs-string">"us-east-2"</span><font></font>
<font></font>
   #     AWS  <span class="hljs-number">2</span>.x<font></font>
   version = <span class="hljs-string">"~&gt; 2.0"</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">module</span> <span class="hljs-string">"alb"</span> {<font></font>
    source = <span class="hljs-string">"../../modules/networking/alb"</span><font></font>
<font></font>
    alb_name = <span class="hljs-string">"terraform-up-and-running"</span>
    subnet_ids = data.aws_subnet_ids.<span class="hljs-keyword">default</span>.ids<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要部署此示例，您需要运行terraform apply命令，就像您重复做的那样：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在部署结束时，您可以使用curl等工具来确保默认情况下ALB返回404：</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com<font></font>
<font></font>
<span class="hljs-number">404</span></code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基础设施检查</font></font><br>
<br>
      ,   HTTP, ,     ,   curl  HTTP-.        . ,        MySQL,       MySQL.      VPN-,      VPN.      ,      ,       SSH    - .    .   ,    ,      .       ,    .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我提醒您：由于配置中不存在其他侦听器规则，因此ALB返回404，并且alb模块中的默认操作的响应为404：</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
       content_type = <span class="hljs-string">"text/plain"</span>
       message_body = <span class="hljs-string">"404: page not found"</span>
       status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
   }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，您已经知道如何运行和测试代码。</font><font style="vertical-align: inherit;">现在您可以开始进行更改了。</font><font style="vertical-align: inherit;">每次更改某项（例如，默认操作返回401）时，都需要使用terraform apply命令来部署新代码：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要检查新版本，可以重新启动curl：</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
   hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com
<span class="hljs-number">401</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成后，运行terraform destroy命令以删除资源：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">destroy</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 0 changed, 5 destroyed.</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
换句话说，在使用Terraform时，每个开发人员都需要良好的代码示例进行测试以及真实的开发环境（例如AWS账户），该环境相当于本地计算机并用于运行测试。在手动测试过程中，您很可能必须创建和删除大量基础结构组件，这可能导致许多错误。在这方面，应将环境与用于最终测试，尤其是工业应用的更稳定的环境完全隔离。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鉴于以上所述，我强烈建议每个开发团队准备一个隔离的环境，在其中您可以创建和删除任何基础结构而不会产生任何后果。</font><font style="vertical-align: inherit;">为了最大程度地减少不同开发人员之间发生冲突的可能性（假设两个开发人员试图创建一个具有相同名称的负载平衡器），理想的解决方案是为每个团队成员提供一个单独的，完全隔离的环境。</font><font style="vertical-align: inherit;">例如，如果将Terraform与AWS结合使用，则每个开发人员理想情况下都应该拥有自己的帐户，他们可以在其中测试所需的一切。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试后资源清理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了提高开发人员的生产力，必须存在许多隔离的环境，但是如果您不谨慎操作，则可能会积累许多额外的资源，这些资源会使您的所有环境杂乱无章，并花费大量资金。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了控制成本，请定期清洁隔离的介质。这是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试2号</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><i><font style="vertical-align: inherit;">关键结论</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
至少，在测试后，当开发人员使用terraform destroy命令删除部署的所有内容时，您应该在团队中创建这种文化。可能会找到用于清理可以定期运行的多余或旧资源的工具（例如，使用cron）。以下是针对不同部署环境的一些示例。</font></font><br>
<br>
<ul>
<li>cloud-nuke (http://bit.ly/2OIgM9r).      ,         .        AWS ( Amazon EC2 Instances, ASG, ELB  . .).      (Google Cloud, Azure)   .    —    ,    . , cloud-nuke      cron,           .   ,   ,      ,      :<br>
<br>
<pre><code class="java hljs">$ cloud-nuke aws --older-than <span class="hljs-number">48</span>h</code></pre></li>
<li>Janitor Monkey (http://bit.ly/2M4GoLB).      ,   AWS  ,    (  —   ).    ,  ,    ,            .    Netflix Simian Army,      Chaos Monkey    .   ,    Simian Army    ,       : ,   Janitor Monkey   Swabbie (http://bit.ly/2OLrOLb).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aws-nuke（http://bit.ly/2ZB8lOe）。</font><font style="vertical-align: inherit;">这是一个删除AWS账户所有内容的开源工具。</font><font style="vertical-align: inherit;">在配置文件中以YAML格式指定要删除的帐户和资源：</font></font><br>
<br>
<pre><code class="java hljs">#   <font></font>
regions:<font></font>
- us-east-<span class="hljs-number">2</span><font></font>
<font></font>
#    <font></font>
accounts:<font></font>
   <span class="hljs-string">"111111111111"</span>: {}<font></font>
<font></font>
#    <font></font>
resource-types:<font></font>
   targets:<font></font>
   - S3Object<font></font>
   - S3Bucket<font></font>
   - IAMRole</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aws-nuke开始如下：</font></font><br>
<br>
<pre><code class="java hljs">$ aws-nuke -<span class="hljs-number">5</span>c config.yml</code></pre></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动化测试</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自动测试的概念是编写测试来测试实际代码的行为。</font><font style="vertical-align: inherit;">在第8章中，您将学习使用CI服务器，可以在每次单独提交后运行这些测试。</font><font style="vertical-align: inherit;">如果未完成，则可以立即撤消或更正固定。</font><font style="vertical-align: inherit;">因此，您的代码将始终可操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
共有三种类型的自动化测试。</font></font><br>
<br>
<ul>
<li> .       — .    ,             .   (,  , -    )   mock-.       (, mock-     ,  )    ,        .</li>
<li> .      .          ,          .      mock-: ,     ,     ,      ,   , ,  ,  mock-.</li>
<li> .      (, ,  ,  )       .          : , Selenium        .         - mock-,          (        ,  ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每种类型的测试都有其自己的目的，在它们的帮助下，您可以识别各种错误，因此应将它们一起使用。单元测试速度很快，可让您立即了解所做的更改并检查各种组合。这使您确信代码的基本组件（单个模块）的行为符合预期。但是，模块单独正确工作的事实并不意味着它们可以一起工作，因此，为了确保基本组件兼容，需要进行集成测试。另一方面，系统不同部分的正确行为并不能保证该系统在工业环境中部署后能够正常工作，因此需要通过测试来在接近实际条件下测试您的代码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
»关于这本书的更多信息上可以找到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版商的网站</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">摘录</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
的优惠券Khabrozhiteley 25％的折扣- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在缴付书的纸质版本，电子书是通过电子邮件发送。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503842/index.html">大脑假体：人工和生物神经网络的同步</a></li>
<li><a href="../zh-CN503844/index.html">只需几步即可加快MatTable渲染速度</a></li>
<li><a href="../zh-CN503846/index.html">闪过，“他是否再次死去还不知道，但是花朵消失了……”</a></li>
<li><a href="../zh-CN503848/index.html">我们邀请您免费在Sinterit 26.05和3D扫描仪上使用SLS打印在线研讨会28.05</a></li>
<li><a href="../zh-CN503854/index.html">最大限度地使用SIL</a></li>
<li><a href="../zh-CN503860/index.html">设置神经网络环境Mask R-CNN</a></li>
<li><a href="../zh-CN503862/index.html">心理问题是成功创造突破性产品的回报</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>