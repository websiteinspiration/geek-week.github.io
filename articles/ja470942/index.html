<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚓 😓 🍊 初心者からスタイルアイコンまで：2GISでの賞の作り方 ♑️ 🤜🏻 🚎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2GISユーザーは毎日、データの正確性を維持するのに役立ちます。彼らは新しい会社について知らせ、交通イベントを追加し、写真をアップロードしてレビューを書きます。以前は、言葉で感謝するか、景品を手配するしかありませんでした。しかし、時間の経過とともに、言葉は忘れられ、誰もが贈り物を受け取るわけではあり...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>初心者からスタイルアイコンまで：2GISでの賞の作り方</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/470942/"><img src="https://habrastorage.org/webt/kl/9g/ja/kl9gjaqo9dmcbsimconigs2pnxo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2GISユーザーは毎日、データの正確性を維持するのに役立ちます。彼らは新しい会社について知らせ、交通イベントを追加し、写真をアップロードしてレビューを書きます。以前は、言葉で感謝するか、景品を手配するしかありませんでした。しかし、時間の経過とともに、言葉は忘れられ、誰もが贈り物を受け取るわけではありません。そのため、2GISに関心のあるすべての人に、製品への貢献とこれに対する感謝の気持ちを確認するようにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、賞がありました。カフェカードへの写真のアップロード、劇場に関するレビューの書き込み、組織の労働時間の指定など、さまざまな種類のタスクで発生する仮想メダルです。ユーザーは、個人の2GISプロファイルとモバイルアプリケーションの[My 2GIS]タブで獲得した報酬を確認できます。そこでは、次の達成までにどれだけ残っているかを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能を実装するために、1時間あたり50万レコード（1秒あたり最大5万レコード）のイベントストリームを処理し、いくつかのサービスからのデータを分析する方法を学びました。</font><font style="vertical-align: inherit;">また、-新しい賞を開発するときに構成を簡素化するために、小さなメタプログラミングを追加しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一緒に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラプター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 受賞プロセスの詳細は次のとおりです。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能の複雑さを理解するには、技術的な問題がどのように聞こえたかを理解する必要があります。</font><font style="vertical-align: inherit;">次に、実装のアイデアとシステムコンポーネントの一般的なスキームを検討します。</font><font style="vertical-align: inherit;">これは、このセクションで行うことです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アブストラクトの要件</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要件-かなり退屈なものなので、すべてのニュアンスを描くのではなく、最も重要なことに集中します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アワードは、許可されたユーザーにのみ発行されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報酬の進捗状況の更新は可能な限り迅速にする必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報酬-ユーザーが製品で一連のアクションを実行した結果：写真のアップロード、レビューの書き込み、道順の検索など。多くのデータソースがあります。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">建築アイデア</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装のアイデアはそれほど複雑ではありません。</font><font style="vertical-align: inherit;">理論的には次のように表現できます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">賞はタスクで構成され、その結果は賞を構成するときに指定された式に従って結合されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクは、外部からのユーザーアクションに関するイベントに応答し、それらをフィルター処理して、進行中の変更をカウンターの形式で登録します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「外部イベント」は、マスターシステム（写真、フィードバック、改良サービスなど）または既存のイベントフローを変換またはフィルタリングする補助サービスによって生成されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント処理は非同期で発生し、必要に応じていつでも停止できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーは自分の賞の現在のステータスを確認できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他はすべて詳細です...</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要なエンティティ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の図は、サブジェクトエリアの主要なエンティティとそれらの関係を示しています。この図では、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vi/ya/59/viya59qa7bnnad3hogutbunyds4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのゾーンが区別されています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーム-賞の構造とその発生規則を説明するゾーン。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ-特定のユーザーのアワードエリアと、そのユーザーの現在のステータスに関連するデータ。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図のエンティティ：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">達成-獲得できる報酬に関する情報。</font><font style="vertical-align: inherit;">メタ情報と、タスクの結果を組み合わせる方法の説明-戦略が含まれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目的-報酬の受け取りに進むために条件を完了する必要があるタスク。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserAchieve-特定のユーザーに対する報酬の現在の状態。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserObjective-ユーザーの報酬ジョブの現在の状態。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー-ユーザーに関する情報。通知と彼の現在のステータスの理解に必要です（リモートおよび禁止された報酬は必要ありません）。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProcessingLog-タスクの発生のログ。</font><font style="vertical-align: inherit;">特定のアクションが割り当ての進捗にどのように影響したかに関する情報が含まれています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント-ユーザーのタスクの進行状況に何らかの影響を与えたイベントに関する必要最小限の情報。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス構造</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、サービスの主なコンポーネントとその依存関係を検討します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/dp/k_/qidpk_jo7rqnh2x5dywk0sg0ij4.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントバス-タスクを完了するために使用できるイベントバス。</font><font style="vertical-align: inherit;">Apache Kafkaを使用しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マスターおよびスレーブDBはメインのデータウェアハウスです。</font><font style="vertical-align: inherit;">この場合、PostgreSQLクラスタです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConsumingWorkers-バスイベントハンドラー。</font><font style="vertical-align: inherit;">主なタスクは、特定のソース（写真、レビューなど）からイベントを読み取り、それらをユーザータスクに適用して結果を保存することです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AchievesWorker-タスクのステータスに応じてユーザー報酬の進捗状況を再計算します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NotificationWorkers-賞の受け取り、新しい可能性のある成果の発表などに関する通知をスケジュールして送信するための一連のハンドラー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パブリックAPI-Webおよびモバイルアプリケーション用のパブリックRESTインターフェイス。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プライベートAPI-管理パネルのRESTインターフェース。インシデントの調査とサービスサポートに役立ちます。</font><font style="vertical-align: inherit;">開発者とサポートチームが利用できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各コンポーネントは、ロジックと責任の領域で分離されているため、データを変更するときに不要な統合やデッドロックを回避できます。</font><font style="vertical-align: inherit;">以下では、イベントの処理と報酬への変換に関連するスキームの一部のみを検討します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント処理</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
報酬は主にデータ集約サービスです。</font><font style="vertical-align: inherit;">各マスターシステムは、いくつかのタイプのイベントを生成します。</font><font style="vertical-align: inherit;">原則として、各タイプのイベントは、コンテンツの状態、つまりステータスモデルと密接に関連しています。</font><font style="vertical-align: inherit;">したがって、写真はモデレート、削除、ブロック、非表示、またはアクティブにすることができます。</font><font style="vertical-align: inherit;">これらはすべて異なるイベントであり、特定のソースを専門とする別のワーカーによって処理されます。</font><font style="vertical-align: inherit;">現在、次のソース（マスターシステム）との相互作用があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写真-ユーザーが写真に対して行った操作に関連するさまざまなイベントを生成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レビュー-ユーザーレビューの操作に関連するイベント。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データフィードバック-絞り込み操作に関連するイベント。</font><font style="vertical-align: inherit;">明確化は、地図上のオブジェクトに関する情報の変化であり、それが会社であるか記念碑であるかは関係ありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェック-2GISチェックアプリケーションに関連するイベント。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSSは、2GISアプリケーションを生成する分析イベントです。</font><font style="vertical-align: inherit;">たとえば、特定の会社を開く、ナビゲーターで旅行する、など。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/vg/xy/zb/vgxyzbizbytl_up3fllx5epasue.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マスターシステムによって生成されたイベントは、ステータスの変更順にKafkaトピックに分類されます。これにより、ユーザーのアワードの進行状況を進めるだけでなく、ロールバックすることもできます。</font><font style="vertical-align: inherit;">たとえば、写真が「アクティブ」ステータスで、何らかの理由で「ブロック」のステータスを取得した場合、賞の進行状況は下向きに変化するはずです。</font><font style="vertical-align: inherit;">賞の進行状況は、コンテンツカウンターと呼ばれる内部オブジェクトの解釈です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カウンタはデータによって異なる場合があります。</font><font style="vertical-align: inherit;">たとえば、写真に関するイベントの場合、承認された数、モデレートの数、ブロックされた数、およびカードを開くイベントの場合は、ユーザーが開いたカードの数のみを考慮する必要があります。</font><font style="vertical-align: inherit;">コンテンツカウンターの現在の値に基づいて、特定のアワードの枠組み内で特定のユーザーに対して、次の質問に対する回答が決定されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">賞は始まったのですか？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進歩は何ですか</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報酬は完全に完了していますか？</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィルターとルール</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の賞のジョブカウンターが変更されるのは、目的のタイプのコンテンツと、賞を受け取るために必要な必要なデータがイベントに到着した場合のみです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受賞に適したコンテンツのみをスキップするために、一連のフィルターとルールを使用して各イベントを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィルターは、コンテンツに課される特定の制限です。彼は質問に答えることだけに関心があります：「新しいイベントはこの状態に適しているかどうか？」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルールは特別なフィルターであり、その目的は次のとおりです。「イベントが条件に一致する場合、カウンターはどのように変更する必要がありますか？」このルールには、カウンターを変更するためのアルゴリズムが含まれています。各アワードには1つのルールのみが含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィルターとルールの実装はプロジェクトコードにあり、特定の賞に属するフィルター（ルール）の説明はデータベースにJSON形式で記述されています。</font><font style="vertical-align: inherit;">私たちはすぐにそのような決定に至りませんでした。</font><font style="vertical-align: inherit;">当初、データベースを介して構成を使用してフィルターとルールを設定することはできませんでした。賞はコードに完全に記述されており、その識別子のみがテーブルに保存されていました。</font><font style="vertical-align: inherit;">この決定には、いくつかの重大な欠点がありました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数の環境をサポートする際の問題。</font><font style="vertical-align: inherit;">アワードのリストのある状態をテスト環境にロールアウトし、別の状態をバトルに送りたい場合は、プロジェクトコードで環境を知るか、アワードのリストを含む構成ファイルを用意する必要があります。</font><font style="vertical-align: inherit;">同時に、このタスクに異なるデータベースを使用することはできませんが、環境ごとにすでに存在しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者のみがフィルタリングを構成する機能。</font><font style="vertical-align: inherit;">すべてがコードで記述されているため、プロジェクトとプログラミング言語を知っている人だけが変更を加えることができるので、プライベートAPIまたはデータベースを介して簡単に変更できるようにしたいと思います。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示の欠点。</font><font style="vertical-align: inherit;">多くの報酬があり、時にはそれらが使用するフィルターを確認する必要があります。</font><font style="vertical-align: inherit;">毎回、コードを見ながらこれを行うのはかなり退屈です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションの開始時に、データベースからロードされたフィルターの名前で照合し、それらを特定の報酬に入れます。</font><font style="vertical-align: inherit;">フィルターの説明の例：</font></font><br>
<br>
<pre><code class="json hljs">[<font></font>
   {<font></font>
       <span class="hljs-attr">"name"</span>:<span class="hljs-string">"SourceFilter"</span>,
       <span class="hljs-attr">"config"</span>:{
           <span class="hljs-attr">"sources"</span>:[<span class="hljs-string">"reviews"</span>]<font></font>
       }<font></font>
   },<font></font>
   {<font></font>
       <span class="hljs-attr">"name"</span>: <span class="hljs-string">"ReviewsLengthFilter"</span>,
       <span class="hljs-attr">"config"</span>: {
           <span class="hljs-attr">"allowed_length"</span>: <span class="hljs-number">100</span><font></font>
       }<font></font>
   }<font></font>
]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合は、テキスト（フィルター配列の最初の説明オブジェクトで示されます）のみを取得し、そのテキストには10​​0文字を超えるテキスト（リストの2番目のフィルター）を含めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルールの説明の例：</font></font><br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"name"</span>: <span class="hljs-string">"ReviewUniqueByObjectRule"</span>,<span class="hljs-attr">"config"</span>:{}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このルールでは、ユーザーがオブジェクトのレビューを書き込んだ場合にのみカウンターを変更できますが、1つのオブジェクトに対して考慮されるレビューは1つだけです。 </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BSSイベントのストリームでの作業については別に説明します。</font><font style="vertical-align: inherit;">これには少なくとも3つの理由があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アナリティクスイベントはロールバックできません。ナビゲーターを介した運転やルートの作成はキャンセルできないため、一般的に論理的なステータスモデルはありません。</font><font style="vertical-align: inherit;">アクションがあったかどうか。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボリューム。</font><font style="vertical-align: inherit;">2GISの総オーディエンスは月に5000万人以上のユーザーであることを思い出してください。</font><font style="vertical-align: inherit;">15億を超える検索クエリと、アプリケーションの起動、オブジェクトのカードの表示など、他の多くのアクションを一緒に実行します。ピーク時には、イベントの数は1秒あたり50,000に達することがあります。</font><font style="vertical-align: inherit;">ユーザーに報酬を与えるために、これらすべての情報をフィルターに通さなければなりません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyticsイベントには、いくつかの形式、さまざまなタイプの機能があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべて、BSSトピックからのデータの処理に大きな影響を与えました。リアルタイムが必要な場合は、非常に近い処理時間が必要だからです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の違いを減らすために、そのようなイベントを準備する別のサービスが作成されました。</font><font style="vertical-align: inherit;">このサービスは、分析に由来するさまざまなメッセージ形式で機能します。</font><font style="vertical-align: inherit;">彼の作品の本質は次のとおりです。イベントのBSSストリーム全体が読み取られ、そこからアワードに必要なものだけが取得されます。</font><font style="vertical-align: inherit;">このようなサービスフィルターは、BSSストリームプロセッサリワードからの負荷を大幅に軽減し（フィルター処理後、流量はsecond300イベント/秒です）、イベントを単一の形式で生成し、内部分析の開発の履歴に関連する欠点を平準化します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受賞</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、イベントの処理方法と割り当ての進捗状況を計算する方法を見つけました。</font><font style="vertical-align: inherit;">次に、ユーザーにアワードを発行するプロセスを確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
発生する最初の質問は次のとおりです。なぜ出力を個別のワーカーに割り当てるのですか？各イベントの処理時に出力を再カウントできないのですか？</font><font style="vertical-align: inherit;">回答：可能ですが、価値はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
引き渡しを別のプロセスに割り当てる理由はいくつかあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各ConsumingWorkerに再集計を転送すると、各ハンドラーがタスクの既知の状態に基づいて進行状況を更新しようとし、他のハンドラーがこの状態を積極的に変更するため、報酬によって進行状況を更新する操作の競合状態を取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各ConsumingWorkerバッチは、トランザクションでKafkaからのイベントを処理します。</font><font style="vertical-align: inherit;">ユーザーの報酬テーブルに挿入を追加することにより、データベースレベルで追加のロックを呼び出し、他のハンドラーを禁止します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アワードを発行するプロセスでは、通知を送信するためのロジックがあり、イベントのフローの処理を遅くするだけであり、これは望ましくありません。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のAchievesWorker（アワードを発行するためのハンドラー）の出現の理由を考え出した。</font><font style="vertical-align: inherit;">次に、処理の2つの重要な部分を処理する必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報酬には一連のクエストがあります。</font><font style="vertical-align: inherit;">これらのタスクには一連のカウンターがあります。</font><font style="vertical-align: inherit;">報酬がどれだけ完了したか、およびこのコードをどのように表現するかを理解するにはどうすればよいですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 例：3つのレビューを書くか、3つの写真をアップロードする必要があります。</font><font style="vertical-align: inherit;">ユーザーはレビュー1枚と写真2枚を持っています。</font><font style="vertical-align: inherit;">賞の進捗状況を教えてください。</font><font style="vertical-align: inherit;">回答：3。合計3が必要であることをユーザーが確信しているためです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アワードを発行するための別のプロセッサーがあります。</font><font style="vertical-align: inherit;">毎回、承認されたユーザーごとに数十の賞、つまり数千万を数えると、すぐに成功する可能性は低いです。</font><font style="vertical-align: inherit;">特定のユーザーの進捗状況と、最後の処理以降に変更されたタスクについて、彼はどのようにして知ることができますか？</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各パーツを個別に検討します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進捗の流れ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクの進捗を報酬によって進捗に変換する方法を説明する方法をよりよく理解するために、報酬をカテゴリに分割し、変換を確認します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Xユニットごとに1つのミッションを完了する。」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：ナビゲーターで10 km走行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/qu/x5/vvqux5yb09uehrul3dkd3mux3wm.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Xユニットごとにいくつかのタスクを完了してください。」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：5枚の写真をアップロードし、カードに5件のレビューを書き込みます-コンテンツは10個のみです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/n8/oc/fen8oc0kbm372ozvyvr3a7fj8jo.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「合計Xユニットのいくつかのタスクを完了してください。」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：5件のレビューを書くか、5枚の写真をアップロードします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d-/ld/gd/d-ldgdazj8xt2eysdzqhgauaxgc.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「タイプ別にグループ化されたいくつかのタスクを完了します。」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：5ユニットのコンテンツ（写真またはレビュー）をアップロードし、ナビゲーターを10 km走行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ue/c3/ck/uec3ckf33tcm4pjcfmtkfbmv9eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、より複雑な入れ子の組み合わせがある可能性があります。ただし、実際の状況では、賞を受け取るために実行する必要がある複雑な論理的な組み合わせを2つか3つの文でユーザーに説明することはできません。したがって、ほとんどの場合、これらのオプションで十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変換方法を戦略と呼び、JSONオブジェクトの形式で正式な説明を作成することにより、多かれ少なかれ普遍的なものにしようとしました。</font><font style="vertical-align: inherit;">もちろん、式の形で書くことを考えることもできますが、evalに類似性を使用したり、文法を記述して実装したりする必要があり、これは明らかに複雑すぎます。</font><font style="vertical-align: inherit;">各アワードのソースコードに戦略を保存することは、アワードの説明が壊れる（データベースの一部であり、コードの一部である）ため、あまり便利ではありません。また、開発の参加なしに、既成のコンポーネントからアワードを収集することもできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
戦略はツリーの形で提示され、各ノードは次のようになります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り当ての現在の進行状況を参照するか、他のノードのグループです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上からの制限がある場合があります-実際には、min（）を使用する必要があることを示しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正規化係数がある場合があります。</font><font style="vertical-align: inherit;">結果に数値を乗算することによる単純な変換に必要です。</font><font style="vertical-align: inherit;">メートルをキロメートルに変換するのに便利でした。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の例を説明するには、1つの操作で十分です（合計）。</font><font style="vertical-align: inherit;">合計は、1つの数値で進行状況をユーザーに明確に示すのに最適ですが、必要に応じて他の操作を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、最後のカテゴリの戦略の説明の例です。</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"goal"</span>: <span class="hljs-number">15</span>,
  <span class="hljs-attr">"operation"</span>: <span class="hljs-string">"sum"</span>,
  <span class="hljs-attr">"strategy"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"goal"</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">"operation"</span>: <span class="hljs-string">"sum"</span>,
      <span class="hljs-attr">"strategy"</span>: [<font></font>
        {<font></font>
          <span class="hljs-attr">"objective_id"</span>: <span class="hljs-string">"photo"</span><font></font>
        },<font></font>
        {<font></font>
          <span class="hljs-attr">"objective_id"</span>: <span class="hljs-string">"reviews"</span><font></font>
        }<font></font>
      ]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"goal"</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">"operation"</span>: <span class="hljs-string">"sum"</span>,
      <span class="hljs-attr">"strategy"</span>: [<font></font>
        {<font></font>
          <span class="hljs-attr">"objective_id"</span>: <span class="hljs-string">"navi"</span>,
          <span class="hljs-attr">"normalization_factor"</span>: <span class="hljs-number">0.001</span><font></font>
        }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なアップデート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーによるイベントを容赦なく分析し、タスクの進行状況に変更を適用するハンドラーがいくつかあります。</font><font style="vertical-align: inherit;">各アワードですべてのユーザーを定期的に検索すると、数千万のアワードが分析されます。ただし、実際の更新が数千単位で測定される場合は、あまり期待できません。</font><font style="vertical-align: inherit;">数千のみを学習し、数百万のCPUを無駄にしない方法は？</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際に変更されたアワードでのみ進行状況を再計算する方法のアイデアは、すぐに思い付きました。</font><font style="vertical-align: inherit;">これは、ベクターウォッチの使用に基づいています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明の前にエンティティを思い出します：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserObjective-賞を設定することによるユーザーの進捗状況に関するデータ。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserAchieve-ユーザーの進行状況データに報酬を与えます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装は次のようになります。</font></font><br>
<br>
<ul>
<li>  version  UserObjective  UserAchieve  Sequence  PostgreSQL.</li>
<li>   UserObjective   .     (      ).</li>
<li> version  UserAchieve          UserObjective.</li>
<li>    AchievesWorker   UserObjective,    UserAchieve  UserAchieve.version &lt; UserObjective.version.      . </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐに、ソリューションにはアワードとタスクのテーブルのエントリ数、およびタスクの進行中の変更の頻度に制限があることに注意する必要がありますが、数千万のアワードと1分あたりの更新数が1,000未満の場合、そのようなソリューションを使用することは十分に可能です。</font><font style="vertical-align: inherit;">どういうわけ</font><font style="vertical-align: inherit;">か、コンテスト「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2GISエージェント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」の</font><font style="vertical-align: inherit;">発行をどのように最適化したか</font><font style="vertical-align: inherit;">について個別に</font><font style="vertical-align: inherit;">説明し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事がかなりボリュームがあることが判明したという事実にもかかわらず、それらについて簡単に話すことは不可能であるため、多くのニュアンスが舞台裏に残りました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アワードのおかげでどのような結論に達しましたか：</font></font><br>
<br>
<ul>
<li> «  »       .           .           .           .</li>
<li>        ,   ,   ,    .    BSS-  .</li>
<li>    ,                 .         Photo, Reviews  . .  http-,         .</li>
<li>            .  ,            .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja470928/index.html">コンテナー内でBuildahを実行するためのベストプラクティス</a></li>
<li><a href="../ja470930/index.html">製品のゲーミフィケーション。歴史ラタタイプ</a></li>
<li><a href="../ja470934/index.html">結婚式の前に癒す：クラゲの細胞増殖と再生能力</a></li>
<li><a href="../ja470938/index.html">Pythonでリンクを開く方法。WebBrowserの操作とInternet Explorerの問題の解決</a></li>
<li><a href="../ja470940/index.html">MSK VUE.JSミートアップ＃3（Mail.ruグループ）：mitapの資料</a></li>
<li><a href="../ja470950/index.html">bear_hug：Python3.6のASCIIアートのゲーム+</a></li>
<li><a href="../ja470954/index.html">Zimbra OSE 8.8.15とZextras Suite ProをUbuntu 18.04 LTSにインストールする</a></li>
<li><a href="../ja470958/index.html">Kubernetesの活性プローブは危険な場合があります</a></li>
<li><a href="../ja470962/index.html">JSConfブダペスト2019</a></li>
<li><a href="../ja470964/index.html">木のおもちゃ-碑文</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>