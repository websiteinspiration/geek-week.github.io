<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ç üë®üèø üêÑ It's time to rethink OpenBSD security ü¶ç ü§∑üèæ üïô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OpenBSD is positioned as a secure OS. However, over the past few months, a number of vulnerabilities have been found in the system. Of course, there i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>It's time to rethink OpenBSD security</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/495120/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenBSD is positioned as a secure OS. </font><font style="vertical-align: inherit;">However, over the past few months, a number of vulnerabilities have been found in the system. </font><font style="vertical-align: inherit;">Of course, there is nothing extraordinary about this. </font><font style="vertical-align: inherit;">Although some vulnerabilities are quite unusual. </font><font style="vertical-align: inherit;">You could even say critical. </font><font style="vertical-align: inherit;">OpenBSD developers have several guidelines on how to ensure security. </font><font style="vertical-align: inherit;">Here are two of them:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avoid mistakes;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minimize the risk of errors.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not everyone agrees that these principles are enough to build secure systems. </font><font style="vertical-align: inherit;">It seems to me that it makes sense to study whether the OpenBSD approach works, or if it is initially doomed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For illustration, I did not select all, but only a few interesting bugs that accidentally coincide with the topic of our conversation.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc auth</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> functions </font><font style="vertical-align: inherit;">run helpers without argv checking. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a strikingly simple mistake, but it probably didn't seem too obvious during the code review. It seems to me, partly, the reason in some confusion is who is responsible for checking the input data. You can call each of the three components involved: a program, a library, or login_passwd - and it is reasonable to assume that someone else is checking. In the end, I think the library was found guilty, because it was for her that a patch appeared, but personally to me at first glance its code does not seem to be clearly wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A more interesting part of the story is that even with the libc error mentioned, the </font><b><font style="vertical-align: inherit;">login_passwd</font></b><font style="vertical-align: inherit;"> function</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wouldn‚Äôt be vulnerable this way if not for another bug. In 2001, login_passwd was rewritten to support kerberos, and maybe that's when they introduced what is the real cause of the error. A request-response type authentication offer (as in the s / key system) returns an authenticated state, not silence. Many years later, the kerberos code was deleted, but part of the code to support it remained, as well as the introduced error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the kerberos code were thoroughly cleaned, the authentication bug would still remain (there were some other related problems with argv parsing), but its effect would certainly be greatly reduced. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is not easy to correctly parse argv in a security context. Many logical tips and approaches do not work here. I will only note that this vulnerability popped up after</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">another discussion of the problem with file names on Unix / Linux / POSIX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , although the leading minus (hyphen) does not really refer to the file name.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld.so</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bad environment variables </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not been removed </font><font style="vertical-align: inherit;">
from </font><b><font style="vertical-align: inherit;">ld.so</font></b><font style="vertical-align: inherit;"> code </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Something like a memory error. </font><font style="vertical-align: inherit;">But no. </font><font style="vertical-align: inherit;">The bug here is to link the success of one operation - splitting the environment variable - to deleting that variable. </font><font style="vertical-align: inherit;">Very confident. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, proponents of various typing systems will assure that they will process these operations in the correct order, but not the fact that this will help. </font><font style="vertical-align: inherit;">C code did not crash due to a lack of error handling or because the memory allocation error remained invisible.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ftp</font></font></h1><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ftp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> follows redirects to local files. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The NetBSD ftp redirect bug has long been a typical example of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uncontrolled functions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And here again the same mistake (fortunately, with minor consequences)! </font><font style="vertical-align: inherit;">Guys, well, sit at home. </font><font style="vertical-align: inherit;">Do not add extra features to your programs.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smtpd from</font></font></h1><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smtpd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cannot check some sender addresses. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think that everything is said in the commentary of Gilles, but I recall the background. </font><font style="vertical-align: inherit;">Once upon a time, all mail was stored locally for each user in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ var / mail</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in mbox files. This is not very cool, because there is a chance of damage if mua deletes the email while mda delivers a new one (not to mention other issues like distorting the From field). Therefore, the mbox file needs to be locked. But locking on a network file system does not work reliably. So instead of locking we use lock files. However, you need to come to an agreement on a specific blocking protocol, because the user owns the mbox files, and the root itself owns the directory. Thus, in order to actually modify the mbox file, you need to run the setuid helper function each time. Well, this is the first problem. Another relic of the old days is the mda settings, which can be used not just as a program, but as a shell pipeline. People prescribe something like</font></font><code>spam-assassin | mail.mda</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and you can‚Äôt just pass it on </font></font><code>execve()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are a lot of difficulties that are rooted in the past. And, unfortunately, this problematic code cannot simply be replaced. E-mail is used a long time ago, and very complex systems and workflows are built on its basis, so it is very difficult to simply cut one piece of code and paste a new one. Despite the varying levels of privilege segregation, a root-level parent process still relies heavily on its less privileged child processes. He will execute the commands and arguments that he will receive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avoiding this seems as simple as switching to the maildir storage format, but it requires various changes in many places. Standard mua </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mail</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not understand this format. </font><font style="vertical-align: inherit;">As for me, mbox has long outlived its life, but it still suits many people, and the update procedure may not be completely transparent and will not work automatically.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smtpd read</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reading outside the scope in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smtpd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be used to execute commands. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is really a memory security issue. By sending some funny status bars, the remote smtp server can inject commands into the smtpd queue for execution. When an email is queued for re-delivery, smtpd adds some destination information to the header to know which command to execute (see above). This attack is similar to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúsmuggling‚Äù of http requests</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you can generate a ‚Äúshit‚Äù with unexpected commands in the header, smtpd will execute them when you try to re-deliver.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As above, one of the problems is that the most sensitive parts of smtpd are too close to the attack surface. </font><font style="vertical-align: inherit;">It seems to me that the real problem is that smtpd stores its own metadata inside email data. </font><font style="vertical-align: inherit;">Because of this, a parsing out of sync attack becomes possible. </font><font style="vertical-align: inherit;">If the quoted response from the server was stored completely separate from the file with the delivery instructions, then reading outside the borders would not do much harm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This vulnerability seems indicative to me, because here we see the danger of mixing data with different levels of trust. </font><font style="vertical-align: inherit;">This danger has never been discussed. </font><font style="vertical-align: inherit;">And she definitely is.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the conclusion was clear from the very beginning, but we‚Äôll talk about it anyway. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think some of these errors help to demonstrate how principles such as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">removing obsolete interfaces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reducing code complexity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are vital to security </font><font style="vertical-align: inherit;">. For the most part, the failure occurred due to the fact that these principles were not followed up to the end, and not because the principles themselves are spoiled or untenable. Some things are slipping out of sight, but I don't agree that developers need some kind of superhuman vigilance. It is easy to give useless advice, such as be careful, do not make mistakes and git gud [slang gamer expression means 'get good', that is, ‚Äúget better, get well soon‚Äù - approx. trans.]. But I think OpenBSD has more serious problems.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even OpenBSD can risk security for utilitarian practicality. That is why some outdated projects have not been amended for a long time. So, perhaps the lesson is that effective principles should always be followed, and not only when it is convenient. Although it is often difficult to make the right choice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The three most serious vulnerabilities, auth and two smtpd, are more or less suitable for exploitation only because of architectural problems that go beyond the scope of the original bug. They should have remained just minor flaws that demonstrate that in a well-protected system it is not necessary to strive for the perfect code, that is, minor errors are permissible - and they do not affect security. Alas, it can be difficult to identify design flaws in an abstract form. And all parts of the system individually look protected, but if they are combined, weaknesses may appear.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Separation of privileges is a key component of OpenBSD security, and it is based on interprocess communication. It makes sense to take a closer look at what problems may arise with damaged processes. Protected browsers are increasingly reinforcing protection and hindering attacks. In particular, smtpd must be protected against memory corruption in network tasks. But the ease with which he is able to control the parental process is alarming. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one mistake could be prevented using a more secure language. Yes, probably, there is some kind of program idiom, which in some cases can help if you follow it with religious perseverance. But I'm not sure yet that by default every programmer will correctly encode all the corresponding invariants.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Writing a mail server is a tricky business. </font><font style="vertical-align: inherit;">Especially if legacy frames are tightening you.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/eo/dx/cq/eodxcqr_jt4-i2h7pybvhg_n7gq.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495110/index.html">What happens in Pushkin's Queen of Spades and what do they play?</a></li>
<li><a href="../en495112/index.html">Content-based tagging in the werf collector: why and how does it work?</a></li>
<li><a href="../en495114/index.html">Self-isolation: how likely is it to get coronavirus if you go for a walk</a></li>
<li><a href="../en495116/index.html">How to hide everything from nano to macro: scientists have developed the general principles of the "theory of invisibility"</a></li>
<li><a href="../en495118/index.html">Problems Using Doctrine ODM in Daemon Processes</a></li>
<li><a href="../en495124/index.html">How to steal a Macbook</a></li>
<li><a href="../en495128/index.html">Does a human face VPN exist?</a></li>
<li><a href="../en495130/index.html">Sorting in Scala - an example on cats</a></li>
<li><a href="../en495138/index.html">How will society and technology change after the coronavirus. Expert Opinions</a></li>
<li><a href="../en495140/index.html">Top 10 memes of the past decade</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>