<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏅 ⬆️ 🙏🏼 $ 3 hardware encryption key - is this possible? 🙆🏽 😷 💆🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The final result is a key the size of a USB flash drive.
 
 Widespread encryption and, as a result, an abundance of keys makes you think about their r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>$ 3 hardware encryption key - is this possible?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487748/"><img src="https://habrastorage.org/webt/-q/n7/jn/-qn7jnfoyjqizxzkhujdkdwcwhk.jpeg"><br>
<i><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final result is a key the size of a USB flash drive.</font></font></sup></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Widespread encryption and, as a result, an abundance of keys makes you think about their reliable storage. </font><font style="vertical-align: inherit;">Storing keys on external devices, from where they cannot be copied, has long been considered good practice. </font><font style="vertical-align: inherit;">I will talk about how to make such a device for $ 3 and 2 hours.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does the picture mean?</font></font></b><div class="spoiler_text">   .    .   : « —  ,       …        ,     ...».  ,     ,       ) <br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Briefly about the principles of work</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cryptography gives us the opportunity to hide what we want to send, to make sure that we communicate with the one with whom we think and many other interesting things. </font><font style="vertical-align: inherit;">Usually, in order for all this to work well, they ask us only one thing - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to keep our encryption keys secret</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sounds easy, doesn't it? </font><font style="vertical-align: inherit;">Well, let's see how we can hide our keys:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save to a file on your desktop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an old and proven way to record something over the years. </font><font style="vertical-align: inherit;">The problem is that in addition to the user himself, a bunch of other programs have access to files on your desktop. </font><font style="vertical-align: inherit;">And if you are absolutely sure that they all do what they are intended for, do not collect any data about you and simply do not merge them into the network - this article is not for you.</font></font></li>
<li><b> </b> — -     ,           .  ,        ,       ,     - -  </li>
<li><b>  </b> — ,       .      ,  .  ,           . ,     (  ssh-)    .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>  </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the main problem is that the keys are either directly stored on your computer or entered there using a keyboard, flash drive, etc. </font><font style="vertical-align: inherit;">But, you object, how then will my computer encrypt data if it does not know the key? </font><font style="vertical-align: inherit;">The correct answer is no way. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The solution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> has long been invented. </font><font style="vertical-align: inherit;">The main idea is to connect a special device to the computer, which will itself encrypt the data. </font><font style="vertical-align: inherit;">And the computer will only send data and receive the result. </font><font style="vertical-align: inherit;">So, for example, many smart cards work.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/br/dm/kwbrdm5ra5c6cbzc0thcwnk-cly.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Required Components</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So let's get started. </font><font style="vertical-align: inherit;">We will assemble our device on an inexpensive and fairly popular microcontroller of the STM32 series. </font><font style="vertical-align: inherit;">Of course, you can make a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printed circuit board</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yourself, </font><font style="vertical-align: inherit;">but we want to manage in 2 hours? </font><font style="vertical-align: inherit;">So let's take a ready-made solution - the ST-Link v2 programmer. </font><font style="vertical-align: inherit;">This device looks like this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zs/yk/hg/zsykhgda844yz_1xyr1xxtccwjg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oddly enough, the programmer for STM32 microcontrollers is assembled on the STM32 microcontroller. </font><font style="vertical-align: inherit;">This device looks very much like a flash drive, which is just what we can do. </font><font style="vertical-align: inherit;">Moreover, its body is made of aluminum, so you can not worry that it will be damaged. </font><font style="vertical-align: inherit;">It costs a miracle for aliexpress 1.5-3 dollars. </font><font style="vertical-align: inherit;">We will need two of these things. </font><font style="vertical-align: inherit;">We will remake one of them on a turn-key basis, and we will use the second to upload firmware to the first. </font><font style="vertical-align: inherit;">If you already have an STM32 programmer, you can do one thing.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Total, we need:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmer ST-Link v2 - 2 pieces</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soldering iron</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Few wires - as a rule suitable wires are already included with ST-Link</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux, in order to compile and upload firmware</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile the firmware</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, let's start with the software part - assembling the firmware for our key. </font><font style="vertical-align: inherit;">Firmware source codes can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I would suggest downloading the latest stable version (you can find it in the tags tab). </font><font style="vertical-align: inherit;">You can clone the repository or download as a zip archive. </font><font style="vertical-align: inherit;">Kneading fingers, launch the terminal and go to the project folder. </font><font style="vertical-align: inherit;">Go to the src folder</font></font><br>
<br>
<pre><code class="bash hljs">$ <span class="hljs-built_in">cd</span> src</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to compile and download the firmware, we need to install several packages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arm-none-eabi-gcc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arm-none-eabi-newlib</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openocd</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I use the pacman package manager, in my case it looks like this</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ sudo pacman -S arm-none-eabi-gcc<font></font>
$ sudo pacman -S arm-none-eabi-newlib<font></font>
$ sudo pacman -S openocd<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are sitting on Ubuntu - use apt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me remind you that we are in the src folder of the project. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Run configure script</font></font><br>
<pre><code class="bash hljs"><font></font>
$ ./configure --vidpid=234b:0000<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We run the make utility and observe how our firmware is compiled.</font></font><br>
<br>
<pre><code class="bash hljs">$ make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After compilation, the build folder appears, and in it the gnuk.elf file - we need it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download firmware to device</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we have the finished file with the firmware, we only need to download it to the device. For this, we have to work a little with a soldering iron. Don’t worry, you don’t need any special skills, just solder 4 wires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we take one of the programmers and pull off the case from it. The selected programmer will be our donor. Here's what we find inside. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/va/-p/zz/va-pzzkpf43ql4ecp0gnc2xp2xm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pay attention to the 4 pins on the board. We will need to solder to them. I recommend using the wires that come with ST-Link for this. We clean the wires from one end and solder them to the contacts. If we are lucky, then on the board there will be signs of these contacts. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/9v/7v/gx9v7vndydnn_2lh5rhmibp0pei.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, we connect the second end of the wires to the remaining whole programmer. </font><font style="vertical-align: inherit;">If you are lucky, then just connect the wires in accordance with the inscriptions: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GND to GND </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.3V to 3.3V </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SWDIO to SWDIO </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SWCLK to SWCLK </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there are no labels on the board, you will have to </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poke at random to</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use the tester. </font><font style="vertical-align: inherit;">Using it, you can easily find GND (it is connected to GND at the terminals of the donor programmer), similar to 3.3V. </font><font style="vertical-align: inherit;">The remaining two wires will have to be connected at random. </font><font style="vertical-align: inherit;">Fortunately, there are only 2 options. As a result, we get something similar to this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yz/9r/8e/yz9r8ekaabsxl15xkdmnxq6yyoy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this photo, the blue device is the programmer, which we use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only as the programmer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Do not be confused by the fact that in the photo at the beginning of the article, the final device has a blue body color. </font><font style="vertical-align: inherit;">It's not him. </font><font style="vertical-align: inherit;">The future device is on the right.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download firmware</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are a step away from success, it remains only to download the firmware. </font><font style="vertical-align: inherit;">Open the terminal, go to the folder with our firmware (gnuk.elf). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the command:</font></font><br>
<br>
<pre><code class="bash hljs">$ openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg -c <span class="hljs-string">'program build/gnuk.elf verify reset exit'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, now we have uploaded the firmware to our device. </font><font style="vertical-align: inherit;">There was one step left - to prohibit reading the memory of the microcontroller. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATTENTION! </font><font style="vertical-align: inherit;">This is a very important stage, which will not allow the person who stole your key to extract secret information from it. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, run the command:</font></font><br>
<br>
<pre><code class="bash hljs">openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg -c init -c <span class="hljs-string">"reset halt"</span> -c <span class="hljs-string">"stm32f1x lock 0"</span> -c reset -c <span class="hljs-built_in">exit</span>   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now everything is ready.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putting it all back</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that all the steps are behind, it remains to take care of the appearance of our device. </font><font style="vertical-align: inherit;">We solder the wires. </font><font style="vertical-align: inherit;">We also no longer need the original contact bar, so you can safely unsolder it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pw/wq/et/pwwqetghhzfjmsp95of6thl7700.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Break the mount and solder the contacts one at a time. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/bd/zz/qjbdzzru_bsnvafujtwduu8j2ks.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we put the case back on and seal the back wall with a suitable piece of plastic.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can i use</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What we have assembled is an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenPGP smart card</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> emulator </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Such a card can store GPG, SSH keys. </font><font style="vertical-align: inherit;">The scope is quite large, for example:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signing git commits - a security issue has already been raised </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSH key storage</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S / MIME</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> email encryption and signing </font><font style="vertical-align: inherit;">- did not check, but they write that it works</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entering the OS without a password - a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">good guide is already on the hub</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, you can do a lot of interesting and useful things.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usage example for ssh</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the end, let's see how you can use this key to store ssh keys and connect to a remote server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two ways - to generate a new key or import an existing key into a token. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see both options. </font><font style="vertical-align: inherit;">We insert the token into USB. </font><font style="vertical-align: inherit;">In dmesg you can see information about the connected device.</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ dmesg<font></font>
[11073.599862] usb 1-3: USB disconnect, device number 11<font></font>
[11311.647551] usb 1-3: new full-speed USB device number 12 using xhci_hcd<font></font>
[11311.796881] usb 1-3: New USB device found, idVendor=234b, idProduct=0000, bcdDevice= 2.00<font></font>
[11311.796884] usb 1-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3<font></font>
[11311.796885] usb 1-3: Product: Gnuk Token<font></font>
[11311.796887] usb 1-3: Manufacturer: Free Software Initiative of Japan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New ssh key generation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to understand that the key is generated </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the device itself</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and not on your computer. </font><font style="vertical-align: inherit;">So, such a key never leaves the device at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to gpg:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ gpg --card-edit<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The gpg interactive mode opens, enable admin mode with the admin command:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg/card&gt; admin<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, run the new key generation command:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg/card&gt; generate<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is the standard gpg key generation procedure. </font><font style="vertical-align: inherit;">During which you will be asked to save the backup key to disk. </font><font style="vertical-align: inherit;">Developers recommend making backups, but you decide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only thing is that hardware generation of RSA keys up to 2048 bits is supported. </font><font style="vertical-align: inherit;">If you need 4096, you will have to generate the key on the computer, and then import it to the device itself. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next you will need pin codes. </font><font style="vertical-align: inherit;">By default, the following PIN codes are protected in the firmware: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CARD PIN - 123456 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ADMIN PIN - 12345678 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, they </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be changed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The key can be generated a little longer than if it was generated directly on the computer, so we have some patience.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Import an existing key</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what to do if you already have an ssh key that you would like to use. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, import the key in gpg:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ pem2openpgp temporary_id &lt; id_rsa  | gpg --import<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to find out the id of the key. </font><font style="vertical-align: inherit;">To do this, list all available in gpg:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ gpg -K<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we find the imported key:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
sec&gt;  rsa2048 2020-02-05 [C]<font></font>
      DFEFF02E226560B7F5A5F2CAB19534F88F8FE4EC<font></font>
      Card serial no. = FFFE 87144751<font></font>
uid           [ unknown] temporary_id<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, the key id is DFEFF02E226560B7F5A5F2CAB19534F88F8FE4EC </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the interactive mode for editing the gpg key:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ gpg --edit-key DFEFF02E226560B7F5A5F2CAB19534F88F8FE4EC<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we give the command to copy the key to the smart card:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg&gt; keytocard<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything, the key is recorded.</font></font><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Export public key in ssh format</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get the desired public key from the token in order to put it on the server:</font></font><br>
<br>
<pre><code class="bash hljs">$ pkcs15-tool --list-keys</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, the output looks like this:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
Using reader with a card: Free Software Initiative of Japan Gnuk (FSIJ-1.2.15-87144751) 00 00<font></font>
Private RSA Key [Signature key]<font></font>
	Object Flags   : [0x03], private, modifiable<font></font>
	Usage          : [0x20C], sign, signRecover, nonRepudiation<font></font>
	Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, <span class="hljs-built_in">local</span><font></font>
	ModLength      : 2048<font></font>
	Key ref        : 0 (0x00)<font></font>
	Native         : yes<font></font>
	Auth ID        : 01<font></font>
	ID             : 01<font></font>
	MD:guid        : f3de5f55-d100-4973-d572-40d67e20f033<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we are interested in the ID-key of the key, in my case 01. Now we export the public key:</font></font><br>
<br>
<pre><code class="bash hljs">
$ pkcs15-tool --<span class="hljs-built_in">read</span>-public-key 01
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy the public key into the pub.key file:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
-----BEGIN PUBLIC KEY-----<font></font>
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyzHQIWEApliWYaf0T8jb<font></font>
Vh2nc5+LklKXeuJFTN3BW2VqdrTw1rpKXiANWpi+qbtZhZ2nP3CJX6qoGobXyCOd<font></font>
/iAiygFlyW4BwTQpnAm81IE9lPzfasOK7SBuKJ+ZbB4WpuYJRozgtt/gpWzmnWnW<font></font>
84/CU9Lqbhz95v/C/DImSf6LiwVdmiEj4CUNInl5pY4trguDsSfkw1u8gGqSPEsD<font></font>
ZXtlVRx8iBGi0JR02g9KTL4dDGocUtcTK8W0eY+BDbQSXfTGCy93v8sEyhdQjHs8<font></font>
oDiwkvFQ86gYqwL5DJ7U/rFSO3A5X6zmkFFV8nJZjxB2qfE5aommtXxow4iPml3x<font></font>
YwIDAQAB<font></font>
-----END PUBLIC KEY-----<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And convert it to ssh-rsa format:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ ssh-keygen -f pub.key -i -mPKCS8 <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out the public key in the desired format:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDLMdAhYQCmWJZhp/RPyNtWHadzn4uSUpd64kVM3cFbZWp2tPDWukpeIA1amL6pu1mFnac/cIlfqqgahtfII53+ICLKAWXJbgHBNCmcCbzUgT2U/N9qw4rtIG4on5lsHham5glGjOC23+ClbOadadbzj8JT0upuHP3m/8L8MiZJ/ouLBV2aISPgJQ0ieXmlji2uC4OxJ+TDW7yAapI8SwNle2VVHHyIEaLQlHTaD0pMvh0MahxS1xMrxbR5j4ENtBJd9MYLL3e/ywTKF1CMezygOLCS8VDzqBirAvkMntT+sVI7cDlfrOaQUVXyclmPEHap8Tlqiaa1fGjDiI+aXfFj<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next is the standard procedure for configuring ssh to log on with a given key - you need to add the key to the ~ / .ssh / authorized_keys file on the remote server. </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ssh configuration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, in order to enter the server using our token, you need to call ssh with the -I switch and pass the path to the token driver. </font><font style="vertical-align: inherit;">Our token is compatible with one of the standard drivers, so we will use it</font></font><br>
<pre><code class="bash hljs"><font></font>
$ ssh -I /usr/lib/opensc-pkcs11.so martin@remotehost<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, it will be more convenient to use the config file (~ / .ssh / config). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the following lines to it.</font></font><br>
<pre><code class="bash hljs"><font></font>
Host digitalOceanServer<font></font>
        HostName 192.168.0.1<font></font>
        User root<font></font>
        PKCS11Provider /usr/lib/opensc-pkcs11.so<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ssh call is now even easier:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ ssh digitalOceanServer<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to change standard pin codes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An equally important step will be to install your own pin codes. </font><font style="vertical-align: inherit;">First you need to understand that there are two different pin codes used:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIN-code - this code is used for routine operations with a smart card - to encrypt something, sign, etc.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Admin Pin-code - this code is needed in order to change / delete keys and do all sorts of such “admin” things</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reset code - a code that will allow you to unlock the token after three incorrect attempts to enter the PIN code. </font><font style="vertical-align: inherit;">Its use is optional, so you decide</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You have only 3 attempts for each of the codes. </font><font style="vertical-align: inherit;">After which the token is blocked. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's get started. </font><font style="vertical-align: inherit;">To do this, we again go into the interactive GPG mode:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ gpg --card-edit<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And enter the passwd command:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg/card&gt; passwd<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A window will open where you can change the pin code from the token. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to change the administrator PIN. </font><font style="vertical-align: inherit;">To do this, go to administrator mode:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg/card&gt; admin<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enter the passwd command again:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
gpg/card&gt; passwd<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, now it works in advanced mode and we will be offered several options:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
1 - change PIN<font></font>
2 - unblock PIN<font></font>
3 - change Admin PIN<font></font>
4 - <span class="hljs-built_in">set</span> the Reset Code<font></font>
Q - quit<font></font>
<font></font>
Your selection?<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We select change Admin PIN and set the administrator password according to the standard scheme. </font><font style="vertical-align: inherit;">Let me remind you that the default Admin PIN is 12345678.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About device security</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, for $ 3 you can’t achieve a key level security for 200+ dollars. </font><font style="vertical-align: inherit;">However, the assembled device can be considered as an entry-level key. </font><font style="vertical-align: inherit;">As far as I know, Nitrokey Start factory keys use the same firmware. </font><font style="vertical-align: inherit;">In any case, the use of such a device will raise security by at least a level higher. </font><font style="vertical-align: inherit;">So this is a great way to start using hardware keys. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's talk a little about what will happen if you lose this key. </font><font style="vertical-align: inherit;">The key itself is protected by a pin code. </font><font style="vertical-align: inherit;">After several unsuccessful attempts, the key is locked. </font><font style="vertical-align: inherit;">The memory of the device itself is protected from reading, so it will not work directly to read the keys written into it.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are some types of attacks on the chip itself (for example, the preparation and connection of microelectrodes to it, which will measure the voltage anywhere in the chip, including memory), but they are quite expensive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, I repeat once again, this is a great entry-level option, and even with it, security will reach a whole new level.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Links to useful materials</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the process of using the device, there will certainly be a need for additional information. </font><font style="vertical-align: inherit;">I put together a list of good sources.</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debian </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">page</font></a></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Documentation</font></a></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the Nitrokey Start token - it uses the same firmware, so the tips will suit us too</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The device that we have assembled is being developed by the open source GNUK project (actually, it’s called a token), so more information can be found in Google at the request of “GNUK”. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upd.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The comments suggested that there are firmware that allows you to use the device for two-factor authentication. The firmware code can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here </font></font></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upd. 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 02/15/2020 The comments suggested that for this particular chip there is a vulnerability that could drain the contents of the memory. As I understand it, it has not yet been published, but it has been announced. So for now, everything is not clear. They also suggested a good solution - pour </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">epoxy</font></a><font style="vertical-align: inherit;"> into the device’s body</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mixed with aluminum powder. This method was described in the book of Kevin Mitnick, “The Art of Deception.” Thus, in order to gain access to the chip, it will be necessary to crack the glue, which, if handled carelessly, can permanently damage the chip. Of course, this method can be circumvented, this increases the cost of hacking even more. Of course, if necessary, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mossad will make its Mossad things</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and this will not stop him, but only delay it. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upd. 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many messages came to the PM that people cannot get ST-Link firmware. </font><font style="vertical-align: inherit;">Having figured it out, we found out that now Chinese manufacturers began to actively save on components and use chips with 64Kb of memory on board. </font><font style="vertical-align: inherit;">And this is not enough for firmware, look for a 128Kb chip on board. </font><font style="vertical-align: inherit;">Therefore, I recommend that when buying, check which chip is installed (if possible), or check with the seller / in the reviews. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upd. </font><font style="vertical-align: inherit;">4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It turns out that you can still use Chinese programmers with a 64 KB chip (although you will have to use the latest firmware version) - an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interesting article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about this </font><font style="vertical-align: inherit;">appeared on the hub </font><font style="vertical-align: inherit;">.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487738/index.html">Schema animation in SCADA</a></li>
<li><a href="../en487740/index.html">Assembling a portable magnetometer</a></li>
<li><a href="../en487742/index.html">Arbitrage Trading (Bellman-Ford Algorithm)</a></li>
<li><a href="../en487744/index.html">FARO Introduces FOCUS S 70 Laser 3D Scanner</a></li>
<li><a href="../en487746/index.html">Eternal</a></li>
<li><a href="../en487750/index.html">Some subtleties of injection collections in Spring</a></li>
<li><a href="../en487752/index.html">Optimize storage: a case of unification and lower cost of ownership</a></li>
<li><a href="../en487754/index.html">Organization of the intranet (automation of IT production). Part 1 - Users and Mail</a></li>
<li><a href="../en487756/index.html">RIT, Maxim Lapshin (Erlyvideo): how a programmer to grow a company</a></li>
<li><a href="../en487764/index.html">I am 14 and I combine school with work in IT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>